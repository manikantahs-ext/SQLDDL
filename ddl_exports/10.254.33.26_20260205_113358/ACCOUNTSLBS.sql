-- DDL Export
-- Server: 10.254.33.26
-- Database: ACCOUNTSLBS
-- Exported: 2026-02-05T11:34:01.744013

USE ACCOUNTSLBS;
GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_ACNAME_AM] CHECK ([ACNAME] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_ACNAME_AM] CHECK (ltrim(rtrim([ACNAME])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_LONGNAME_AM] CHECK ([LONGNAME] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_LONGNAME_AM] CHECK (ltrim(rtrim([LONGNAME])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_ACTYP_AM] CHECK ([ACTYP] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_ACTYP_AM] CHECK (ltrim(rtrim([ACTYP])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_ACCAT_AM] CHECK ([ACCAT] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_ACCAT_AM] CHECK (ltrim(rtrim([ACCAT])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_CLTCODE_AM] CHECK ([CLTCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_CLTCODE_AM] CHECK (ltrim(rtrim([CLTCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_GRPCODE_AM] CHECK ([GRPCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_GRPCODE_AM] CHECK (ltrim(rtrim([GRPCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NOT_NULL_BRANCHCODE_AM] CHECK ([BRANCHCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [NON_BLANK_BRANCHCODE_AM] CHECK (ltrim(rtrim([BRANCHCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_ACCAT_AML] CHECK (ltrim(rtrim([ACCAT])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_ACNAME_AML] CHECK (ltrim(rtrim([ACNAME])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_ACTYP_AML] CHECK (ltrim(rtrim([ACTYP])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_BRANCHCODE_AML] CHECK (ltrim(rtrim([BRANCHCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_CLTCODE_AML] CHECK (ltrim(rtrim([CLTCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_GRPCODE_AML] CHECK (ltrim(rtrim([GRPCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NON_BLANK_LONGNAME_AML] CHECK (ltrim(rtrim([LONGNAME])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_ACCAT_AML] CHECK ([ACCAT] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_ACNAME_AML] CHECK ([ACNAME] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_ACTYP_AML] CHECK ([ACTYP] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_BRANCHCODE_AML] CHECK ([BRANCHCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_CLTCODE_AML] CHECK ([CLTCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_GRPCODE_AML] CHECK ([GRPCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [NOT_NULL_LONGNAME_AML] CHECK ([LONGNAME] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.ACMAST_TLOG
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_TLOG] ADD CONSTRAINT [ACMAST_DBACTION] CHECK ([DBACTION]='R' OR ([DBACTION]='D' OR ([DBACTION]='N' OR ([DBACTION]='A' OR ([DBACTION]='I' OR ([DBACTION]='E' OR ([DBACTION]='M' OR [DBACTION]='U')))))))

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_SL] CHECK (ltrim(rtrim([BOOKTYPE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_SL] CHECK ([BOOKTYPE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_CLTCODE_SL] CHECK (ltrim(rtrim([CLTCODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_CLTCODE_SL] CHECK ([CLTCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_VDT_SL] CHECK ([VDT] <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_VDT_SL] CHECK ([VDT] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_DRCR_SL] CHECK (ltrim(rtrim([DRCR])) = 'D' or ltrim(rtrim([DRCR])) = 'C')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_ACNAME_SL] CHECK (ltrim(rtrim([ACNAME])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_ACNAME_SL] CHECK ([ACNAME] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_EDT_SL] CHECK ([EDT] <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_EDT_SL] CHECK ([EDT] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_BLANK_VNO_SL] CHECK (ltrim(rtrim([VNO])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_VTYP_SL] CHECK ([VTYP] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NON_ZERO_VTYP_SL] CHECK ([VTYP] <> 0)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger] ADD CONSTRAINT [NOT_NULL_VNO_SL] CHECK ([VNO] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NOT_NULL_VTYP_L1] CHECK ([VTYP] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_ZERO_VTYP_L1] CHECK ([VTYP] <> 0)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NOT_NULL_VNO_L1] CHECK ([VNO] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_BLANK_VNO_L1] CHECK (ltrim(rtrim([VNO])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_BLANK_DRCR_L1] CHECK (ltrim(rtrim([DRCR])) = 'D' or ltrim(rtrim([DRCR])) = 'C')

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_L1] CHECK ([BOOKTYPE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Ledger1
-- --------------------------------------------------
ALTER TABLE [dbo].[Ledger1] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_L1] CHECK (ltrim(rtrim([BOOKTYPE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_VTYP_ML] CHECK ([VTYP] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_VTYP_ML] CHECK ([VTYP] <> 0)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_VNO_ML] CHECK ([VNO] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_VNO_ML] CHECK (ltrim(rtrim([VNO])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_DRCR_ML] CHECK (ltrim(rtrim([DRCR])) = 'D' or ltrim(rtrim([DRCR])) = 'C')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_VDT_ML] CHECK ([VDT] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_VDT_ML] CHECK ([VDT] <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_PARTYCODE_ML] CHECK ([PARTY_CODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_PARTYCODE_ML] CHECK (ltrim(rtrim([PARTY_CODE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_ML] CHECK ([BOOKTYPE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_ML] CHECK (ltrim(rtrim([BOOKTYPE])) <> '')

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NOT_NULL_MCLTCODE_ML] CHECK ([MCLTCODE] is not null)

GO

-- --------------------------------------------------
-- CHECK dbo.Marginledger
-- --------------------------------------------------
ALTER TABLE [dbo].[Marginledger] ADD CONSTRAINT [NON_BLANK_MCLTCODE_SL] CHECK (ltrim(rtrim([MCLTCODE])) <> '')

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_PIECE
-- --------------------------------------------------




CREATE FUNCTION [dbo].[CLS_PIECE] ( @CharacterExpression VARCHAR(8000), @Delimiter CHAR(1), @Position INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	If @Position<1 return null
	if len(@Delimiter)<>1 return null
	declare @Start integer
	set @Start=1
	while @Position>1
		BEGIN
			Set @Start=ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
			IF @Start=0 return null
			set @position= @position-1
			set @Start=@Start+1
		END
	Declare @End INTEGER
	Set @End= ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
	If @End=0 Set @End=LEN(@CharacterExpression)+1
	RETURN SUBSTRING(@CharacterExpression, @Start, @End-@Start)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_USERRIGHTS
-- --------------------------------------------------
CREATE FUNCTION [dbo].[FN_USERRIGHTS]
(
	@VTYPE SMALLINT, 
	@BOOKTYPE VARCHAR(2),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@UNAME VARCHAR(25),
	@CATEGORY VARCHAR(10)--UDTCATCODE UDTCATEGORY
)
RETURNS @USERRIGHTS TABLE
(
	VTYPE SMALLINT,
	BOOKTYPE VARCHAR(2),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	UNAME VARCHAR(25),
	CATEGORY VARCHAR(10),
	START_DATE_ADD INT,
	END_DATE_ADD  INT,
	START_DATE_EDIT  INT,
	END_DATE_EDIT INT,
	START_DATE_DELETE  INT,
	END_DATE_DELETE INT,
	ADD_DAYS INT,
	EDIT_DAYS INT,
	DEL_DAYS INT,
	MKCKFLAG TINYINT
)
AS
/*
SELECT * FROM .DBO.FN_USERRIGHTS (2, '01', 'NSE', 'CAPITAL', 'yatin', '388')
GO
SELECT * FROM .DBO.FN_USERRIGHTS(2, 'AS', 'ALL', 'ALL', 'megha', '1')
GO
select * from USERRIGHTS where userid= 'megha' and category  = 1
SELECT * FROM .DBO.USERRIGHTS WHERE USERID = 'DEMO' AND VTYPE = 2
*/
BEGIN
	INSERT INTO @USERRIGHTS(VTYPE, BOOKTYPE, EXCHANGE, SEGMENT, UNAME, CATEGORY, START_DATE_ADD, END_DATE_ADD, START_DATE_EDIT, END_DATE_EDIT, START_DATE_DELETE, END_DATE_DELETE, ADD_DAYS, EDIT_DAYS, DEL_DAYS, MKCKFLAG)
	SELECT VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END,
			BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END,
			@EXCHANGE, @SEGMENT, @UNAME, @CATEGORY,
			STRAT_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -ADD_DAYS, GETDATE()), 112))
										END
									END,
			END_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, ADD_DAYS, GETDATE()), 112))
										END
									END,
			STRAT_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -EDIT_DAYS, GETDATE()), 112))
										END
									END,
			END_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, EDIT_DAYS, GETDATE()), 112))
										END
									END,
			STRAT_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -DELETE_DAYS, GETDATE()), 112))
										END
									END,
			END_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, DELETE_DAYS, GETDATE()), 112))
										END
									END,
			ADD_DAYS, EDIT_DAYS, DELETE_DAYS, MKCKFLAG
	FROM 
		VIEW_USERRIGHTS
	WHERE	
		VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END
		AND BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END
		AND EXCHANGE = @EXCHANGE
		AND SEGMENT = @SEGMENT
		AND USERID = @UNAME
		AND CATEGORY = @CATEGORY

IF @@ROWCOUNT = 0
	BEGIN
		INSERT INTO @USERRIGHTS(VTYPE, BOOKTYPE, EXCHANGE, SEGMENT, UNAME, CATEGORY, START_DATE_ADD, END_DATE_ADD, START_DATE_EDIT, END_DATE_EDIT, START_DATE_DELETE, END_DATE_DELETE, ADD_DAYS, EDIT_DAYS, DEL_DAYS, MKCKFLAG)
		SELECT VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END,
			BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END,
			@EXCHANGE, @SEGMENT, @UNAME, @CATEGORY,
			STRAT_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -ADD_DAYS, GETDATE()), 112))
										END
									END,
			END_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, ADD_DAYS, GETDATE()), 112))
										END
									END,
			STRAT_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -EDIT_DAYS, GETDATE()), 112))
										END
									END,
			END_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, EDIT_DAYS, GETDATE()), 112))
										END
									END,
			STRAT_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -DELETE_DAYS, GETDATE()), 112))
										END
									END,
			END_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
									ELSE
										CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
										ELSE
											CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, DELETE_DAYS, GETDATE()), 112))
										END
									END,
			ADD_DAYS, EDIT_DAYS, DELETE_DAYS, MKCKFLAG
		FROM 
			VIEW_USERRIGHTS
		WHERE	
			VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END
			AND BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			AND CATEGORY = @CATEGORY
			AND USERID = ''
	END
RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetGrouplevels
-- --------------------------------------------------

CREATE Function GetGrouplevels(@Group_code varchar(20)) returns integer
as
begin
	declare @@Group_code VARCHAR(20),
	@@lastGroup_code VARCHAR(20),
	@@Level int

	Set @@Group_code = @Group_code 
	Set @@lastGroup_code = @Group_code 

	Set @@Level = 1
	While ltrim(rtrim(@@Group_code))  <> ''
	begin

		select @@Group_code = Main_group from PLgroup_mstr 
		where Group_Code = @@lastGroup_code and group_code <> Main_group
		if ltrim(rtrim(@@Group_code)) <> ''
		begin
			Set @@Level = @@Level + 1
		end
		set @@lastGroup_code = @@Group_code
	end


	return @@Level
	

end

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[PIECE] ( @CharacterExpression VARCHAR(MAX), @Delimiter CHAR(1), @Position INTEGER)  
RETURNS VARCHAR(MAX)  
AS  
BEGIN  
 If @Position<1 return null  
 if len(@Delimiter)<>1 return null  
 declare @Start integer  
 set @Start=1  
 while @Position>1  
  BEGIN  
   Set @Start=ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)  
   IF @Start=0 return null  
   set @position= @position-1  
   set @Start=@Start+1  
  END  
 Declare @End INTEGER  
 Set @End= ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)  
 If @End=0 Set @End=LEN(@CharacterExpression)+1  
 RETURN SUBSTRING(@CharacterExpression, @Start, @End-@Start)  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.REMOVE_ZERO
-- --------------------------------------------------
--SELECT .DBO.REMOVE_ZERO('23423123', '0')  


CREATE FUNCTION DBO.REMOVE_ZERO  
(    
 @STRING NVARCHAR(4000),     
 @DELIMITER CHAR(1)  
)    
    
RETURNS VARCHAR(100)    
    
AS    
    
/*    
 RETURNS SPECIFIC ITEM    
 SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)    
*/    
    
BEGIN    
	DECLARE @INDEX INT    
	DECLARE @COUNTER TINYINT

	SELECT @INDEX = 1
	SELECT @COUNTER = LEN(@STRING) 
   
	IF @STRING IS NULL RETURN '0'    

	WHILE @COUNTER > 2
	BEGIN
		-- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER    
		SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)    
		-- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE    
		IF @INDEX = 1
		BEGIN
			SELECT @STRING = RIGHT(@STRING, LEN(@STRING) - 1)
		END
		ELSE
		BEGIN
			RETURN @STRING    
			BREAK         
		END
		SELECT @COUNTER = @COUNTER - 1
	END
	RETURN '0'	
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.SPLIT
-- --------------------------------------------------



CREATE FUNCTION DBO.SPLIT
(
	@STRING NVARCHAR(4000), 
	@DELIMITER CHAR(1)
)

RETURNS @RESULTS  TABLE (ITEMS NVARCHAR(4000))

AS

/*
	SELECT * FROM SPLIT('A,B,C!', ',')
*/

BEGIN
    DECLARE @INDEX INT
    DECLARE @SLICE NVARCHAR(4000)
    SELECT @INDEX = 1
    IF @STRING IS NULL RETURN
    WHILE @INDEX !=0

        BEGIN	
        	-- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT CHARACTER
        	SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)
        	-- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE
        	IF @INDEX !=0
        		SELECT @SLICE = LEFT(@STRING,@INDEX - 1)
        	ELSE
        		SELECT @SLICE = @STRING
        	-- PUT THE ITEM INTO THE RESULTS SET
        	INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
        	-- CHOP THE ITEM REMOVED OFF THE MAIN STRING
        	SELECT @STRING = RIGHT(@STRING,LEN(@STRING) - @INDEX)
        	-- BREAK OUT IF WE ARE DONE
        	IF LEN(@STRING) = 0 BREAK
    END
    RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.SPLIT_SP
-- --------------------------------------------------



CREATE FUNCTION DBO.SPLIT_SP
(
	@STRING NVARCHAR(4000), 
	@DELIMITER CHAR(1),
	@COUNTER_SP TINYINT
)

RETURNS @RESULTS  TABLE (ITEMS NVARCHAR(4000))

AS

/*
	RETURNS SPECIFIC ITEM
	SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)
*/

BEGIN
    DECLARE @INDEX INT
    DECLARE @SLICE NVARCHAR(4000)
	 DECLARE @COUNTER TINYINT
	 SET @COUNTER = 0
    SELECT @INDEX = 1
    IF @STRING IS NULL RETURN
    WHILE @INDEX !=0

        BEGIN	
        	-- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER
        	SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)
        	-- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE
        	IF @INDEX !=0
				IF @COUNTER = @COUNTER_SP
				BEGIN
        			SELECT @SLICE = LEFT(@STRING,@INDEX - 1)
					-- PUT THE ITEM INTO THE RESULTS SET
		        	INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
					BREAK					
				END
				ELSE
					SELECT @SLICE = @STRING
        	ELSE
				BEGIN
	        		SELECT @SLICE = @STRING
					-- PUT THE ITEM INTO THE RESULTS SET
			      INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
				END
        	
        	-- CHOP THE ITEM REMOVED OFF THE MAIN STRING
        	SELECT @STRING = RIGHT(@STRING,LEN(@STRING) - @INDEX)
        	-- BREAK OUT IF WE ARE DONE
        	IF LEN(@STRING) = 0 BREAK
			SET @COUNTER = @COUNTER + 1
    END
    RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.SPLIT_SP1
-- --------------------------------------------------
CREATE FUNCTION DBO.SPLIT_SP1
(
	@STRING NVARCHAR(4000), 
	@DELIMITER CHAR(1),
	@COUNTER_SP TINYINT
)

RETURNS VARCHAR(100)

AS

/*
	RETURNS SPECIFIC ITEM
	SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)
*/

BEGIN
    DECLARE @INDEX INT
    DECLARE @SLICE NVARCHAR(4000)
	 DECLARE @COUNTER TINYINT
	 SET @COUNTER = 0
    SELECT @INDEX = 1
    IF @STRING IS NULL RETURN '123'
    WHILE @INDEX !=0

        BEGIN	
        	-- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER
        	SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)
        	-- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE
        	IF @INDEX !=0
			IF @COUNTER = @COUNTER_SP
				BEGIN
        			SELECT @SLICE = LEFT(@STRING,@INDEX - 1)
					-- PUT THE ITEM INTO THE RESULTS SET
		        	--INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
				RETURN @SLICE
					BREAK					
				END
				ELSE
				BEGIN
					SELECT @SLICE = @STRING
				END
        	ELSE
				BEGIN
	        		SELECT @SLICE = @STRING
				RETURN @SLICE
					BREAK					
					-- PUT THE ITEM INTO THE RESULTS SET
--			      INSERT INTO @RESULTS(ITEMS) VALUES(@SLICE)
				END
        	
        	-- CHOP THE ITEM REMOVED OFF THE MAIN STRING
        	SELECT @STRING = RIGHT(@STRING,LEN(@STRING) - @INDEX)
        	-- BREAK OUT IF WE ARE DONE
        	IF LEN(@STRING) = 0 BREAK
			SET @COUNTER = @COUNTER + 1
    END
    RETURN ''
END

GO

-- --------------------------------------------------
-- INDEX dbo.accountscategory
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cat_clt] ON [dbo].[accountscategory] ([Cltcode], [Category])

GO

-- --------------------------------------------------
-- INDEX dbo.Acmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Accat] ON [dbo].[Acmast] ([Cltcode], [Accat])

GO

-- --------------------------------------------------
-- INDEX dbo.Acmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cltcode] ON [dbo].[Acmast] ([Cltcode], [Acname], [Accat], [Actyp], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Acmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [CLTCODEIDX] ON [dbo].[Acmast] ([Accat], [Cltcode], [Branchcode], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Acmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Grpclt] ON [dbo].[Acmast] ([Grpcode], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ACMAST_TRG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[ACMAST_TRG] ([Cltcode], [SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.BalConfirm_Print_Setting
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCt] ON [dbo].[BalConfirm_Print_Setting] ([Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Banklocat
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[Banklocat] ([Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Bnkrco] ON [dbo].[Bankreco] ([Amount], [Drcr], [Referenceno], [Micrno])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [RecoIDx] ON [dbo].[Bankreco] ([Cltcode], [Amount], [Drcr], [Micrno], [Referenceno])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Bankreco_Log] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.BILLLOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[BILLLOG] ([SETT_NO], [SETT_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Billmatch
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vnoidx] ON [dbo].[Billmatch] ([Vno], [Vtype], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.BillPosted
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSt] ON [dbo].[BillPosted] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.BILLPROCESS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxPr] ON [dbo].[BILLPROCESS] ([IN_PROCESS])

GO

-- --------------------------------------------------
-- INDEX dbo.BOOKTYPE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxVt] ON [dbo].[BOOKTYPE] ([Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.branchwiseclbal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[branchwiseclbal] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Category
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cat] ON [dbo].[Category] ([Catcode])

GO

-- --------------------------------------------------
-- INDEX dbo.catmast
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[catmast] ([Accat])

GO

-- --------------------------------------------------
-- INDEX dbo.chequeformats
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxChq] ON [dbo].[chequeformats] ([Formatcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableListing] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.CLASSFILEUPD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSESSION] ON [dbo].[CLASSFILEUPD] ([SESSION_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.CLASSFILEUPD_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXUSR] ON [dbo].[CLASSFILEUPD_LOG] ([SESSION_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Clientsmargin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Clientsmargin] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Costmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cstinx] ON [dbo].[Costmast] ([Costname], [Costcode], [Catcode])

GO

-- --------------------------------------------------
-- INDEX dbo.creditors
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[creditors] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.DIAG_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[DIAG_LOG] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.DIAG_RESULT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrNo] ON [dbo].[DIAG_RESULT] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.ERROR_TBL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxErr] ON [dbo].[ERROR_TBL] ([ERR_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Errvouchers
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxUser] ON [dbo].[Errvouchers] ([Cdt], [Username])

GO

-- --------------------------------------------------
-- INDEX dbo.FILE_OUTPUT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrNo] ON [dbo].[FILE_OUTPUT] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_Session] ON [dbo].[FORMULA_CLIENT_MASTER] ([SESSION_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.grpmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Grpcode] ON [dbo].[grpmast] ([Grpcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Lastchequeno
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBank] ON [dbo].[Lastchequeno] ([Bankcode], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Lastvno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [LVNO] ON [dbo].[Lastvno] ([Vdt], [Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Lastvno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Vnoidx] ON [dbo].[Lastvno] ([Vtyp], [Booktype], [Vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [LED2IND] ON [dbo].[Ledger] ([Vdt], [Vno], [Vtyp])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledger3] ON [dbo].[Ledger] ([Vtyp], [Vno], [Lno], [Vdt], [Cltcode], [Booktype], [Drcr], [Acname])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledger5] ON [dbo].[Ledger] ([Vdt], [Vtyp], [Edt], [Drcr], [Vamt], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledind] ON [dbo].[Ledger] ([Vno], [Vtyp], [Vdt], [Cltcode], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyvdt] ON [dbo].[Ledger] ([Vno], [Vtyp], [Booktype], [Vdt], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PK_Ledger] ON [dbo].[Ledger] ([Vtyp], [Vno], [Lno], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVp] ON [dbo].[ledger_log] ([vtyp], [vno], [vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_Report
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Ledger_Report] ([Cltcode], [Vtyp], [Vno], [Vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxldgr] ON [dbo].[Ledger1] ([Vtyp], [Vno], [Booktype], [Lno], [Ddno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ledger1_vnoidx] ON [dbo].[Ledger1] ([Vno], [Vtyp], [Booktype], [Drcr], [Relamt], [Ddno], [Slipno], [Micrno], [Refno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vnoidx] ON [dbo].[Ledger1] ([Vno], [Vtyp], [Booktype], [Drcr], [Relamt], [Ddno], [Slipno], [Micrno], [Refno], [Reldt], [Dddt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Vtypno] ON [dbo].[Ledger1] ([Vno], [Vtyp], [Booktype], [Drcr], [Ddno], [Relamt], [Micrno], [Slipno])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[LEDGER1_BANKRECO_LOG] ([Vtyp], [Booktype], [Vno])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger1_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVtp] ON [dbo].[ledger1_log] ([vtyp], [BookType], [vno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cltcode] ON [dbo].[Ledger2] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Led2] ON [dbo].[Ledger2] ([Vno], [Vtype], [Booktype], [Lno], [Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [typeno] ON [dbo].[Ledger2] ([Vno], [Vtype], [Booktype], [Lno], [Costcode], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vno] ON [dbo].[Ledger2] ([Vno], [Vtype], [Drcr], [Booktype], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger2_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[ledger2_log] ([vtype], [BookType], [vno], [cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ld3] ON [dbo].[ledger3] ([Vno], [Vtyp], [Naratno], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Ledger314] ON [dbo].[ledger3] ([Vtyp])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVtyp] ON [dbo].[ledger3_log] ([vtyp], [BookType], [vno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledgerbalances
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[Ledgerbalances] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Marginledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [KLED] ON [dbo].[Marginledger] ([Vno], [Vtyp], [Vdt], [Party_code], [Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.marginledger_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVTyp] ON [dbo].[marginledger_log] ([vtyp], [BookType], [vno], [vdt], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Matchdetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVTyp] ON [dbo].[Matchdetails] ([Vtype], [Booktype], [Vno], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.matchdetails_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[matchdetails_log] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.MPI_PayIn
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[MPI_PayIn] ([PartyCode])

GO

-- --------------------------------------------------
-- INDEX dbo.multibankid_back
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[multibankid_back] ([Cltcode], [Bankid], [Acctype])

GO

-- --------------------------------------------------
-- INDEX dbo.Offline_RecPay_Table
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Offline_RecPay_Table] ([VTYP], [VNO], [CLIENT_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Owner
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcom] ON [dbo].[Owner] ([Companyname])

GO

-- --------------------------------------------------
-- INDEX dbo.Parameter
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Curyear] ON [dbo].[Parameter] ([Curyear])

GO

-- --------------------------------------------------
-- INDEX dbo.Parameter
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SDTCUR] ON [dbo].[Parameter] ([Sdtcur], [Ldtcur])

GO

-- --------------------------------------------------
-- INDEX dbo.Payadv
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxcl] ON [dbo].[Payadv] ([Vtyp], [Vno], [Booktype], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Paymentmarking
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Paymentmarking] ([Cltcode], [Branchcode])

GO

-- --------------------------------------------------
-- INDEX dbo.PayOut_GlobalParams
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxApp] ON [dbo].[PayOut_GlobalParams] ([AppTime])

GO

-- --------------------------------------------------
-- INDEX dbo.PLDetail
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrNo] ON [dbo].[PLDetail] ([SrNo])

GO

-- --------------------------------------------------
-- INDEX dbo.PLgroup_mstr
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PLGRP_IDX] ON [dbo].[PLgroup_mstr] ([Group_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.PostBillLedger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVTyp] ON [dbo].[PostBillLedger] ([VTYP], [VNO], [SETT_NO], [SETT_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[POSTBILLLEDGER2] ([CLTCODE], [BRANCHCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.RECOPROCESS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxPr] ON [dbo].[RECOPROCESS] ([INPROCESS])

GO

-- --------------------------------------------------
-- INDEX dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxLv] ON [dbo].[Selection_Levels_PartyLedger] ([Level_No])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MASTER_PARTYLEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrNo] ON [dbo].[TBL_MASTER_PARTYLEDGER] ([SrNo])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MASTER_PARTYLEDGER_ALL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrno] ON [dbo].[TBL_MASTER_PARTYLEDGER_ALL] ([SRNO])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxClt] ON [dbo].[Tbl_OppBalance] ([cltCode])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_REPORT_INTEREST_MARGIN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxIntBal_Margin] ON [dbo].[TBL_REPORT_INTEREST_MARGIN] ([CltCode], [BalanceDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [billtypeidx] ON [dbo].[Tempbilldetails] ([Billvtype])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [drcridx] ON [dbo].[Tempbilldetails] ([Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [excidx] ON [dbo].[Tempbilldetails] ([Exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [partycdidx] ON [dbo].[Tempbilldetails] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [sessionidx] ON [dbo].[Tempbilldetails] ([Sessionid], [Vtype], [Booktype], [Billvno])

GO

-- --------------------------------------------------
-- INDEX dbo.Templedger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVType] ON [dbo].[Templedger2] ([Vtype], [Booktype], [Vno])

GO

-- --------------------------------------------------
-- INDEX dbo.THIRDPARTY_COLLECTION
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVVTyp] ON [dbo].[THIRDPARTY_COLLECTION] ([VTYP], [BOOKTYPE], [VNO], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.USERRIGHTS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxvTyp] ON [dbo].[USERRIGHTS] ([vtyp], [Booktype], [UserCategory], [UserStatusId])

GO

-- --------------------------------------------------
-- INDEX dbo.Userwritestable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[Userwritestable] ([Vtyp], [Booktype], [Usercategory], [Userstatusid])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [_dta_index_V2_ACCOUNTBALANCES_5_310292165__K4_K1_K2_K3_6_7] ON [dbo].[V2_ACCOUNTBALANCES] ([VDT], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [_dta_index_V2_ACCOUNTBALANCES_5_310292165__K5_K4_K1_K2_K3_6_7] ON [dbo].[V2_ACCOUNTBALANCES] ([EDT], [VDT], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVType] ON [dbo].[V2_ACCOUNTBALANCES] ([CLTCODE], [SEGMENTCODE], [LEDTYPE], [VDT])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_AGEINGBUCKETS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxAge] ON [dbo].[V2_AGEINGBUCKETS] ([BUCKET_1], [BUCKET_2], [BUCKET_3], [BUCKET_4])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_AGEINGBUCKETS_TMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxAge] ON [dbo].[V2_AGEINGBUCKETS_TMP] ([BUCKET_1], [BUCKET_2], [BUCKET_3], [BUCKET_4])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_AGEINGDATA_TMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxClt] ON [dbo].[V2_AGEINGDATA_TMP] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLIENTPROFILES_FA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[V2_CLIENTPROFILES_FA] ([FROMDATE], [TODATE], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_FOUT_LEDGERBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [FoutIdx] ON [dbo].[V2_FOUT_LEDGERBALANCES] ([Party_Code], [Family_Code], [Branch_Code], [Trader], [Trader_Name], [Area_Code], [Region_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_INTEREST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [_dta_index_V2_INTEREST_5_342292279__K10_1_6_9] ON [dbo].[V2_INTEREST] ([INTDATE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_INTEREST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[V2_INTEREST] ([INTDATE], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_INTEREST_NEW
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[V2_INTEREST_NEW] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LastVno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [VNoIdx] ON [dbo].[V2_LastVno] ([Vtyp], [Booktype], [Vdt], [VnoFlag], [FinYear])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LEDGERBALANCE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[V2_LEDGERBALANCE] ([PARTYCODE], [BRANCHCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_OPENING_BALANCE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVdt] ON [dbo].[V2_OPENING_BALANCE] ([VDT], [VNO], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_payout_temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxcl] ON [dbo].[V2_payout_temp] ([acCode])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_PLEXCHANGE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxExch] ON [dbo].[V2_PLEXCHANGE] ([EXCHANGE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Process_Logs
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxAuto] ON [dbo].[V2_Process_Logs] ([FldAuto])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_PROCESS_MASTER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[V2_PROCESS_MASTER] ([ProcessDate], [Processid])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_RUNNINGBALANCES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[V2_RUNNINGBALANCES] ([BALDATE], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_RUNNINGBALANCES_TMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[V2_RUNNINGBALANCES_TMP] ([BALDATE], [CLTCODE], [SEGMENTCODE], [LEDTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrno] ON [dbo].[V2_UPLOADED_FILES] ([U_FILENAME])

GO

-- --------------------------------------------------
-- INDEX dbo.VMAIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxVtyp] ON [dbo].[VMAIN] ([VTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Vmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Typedesc] ON [dbo].[Vmast] ([Vtype], [Vdesc])

GO

-- --------------------------------------------------
-- INDEX dbo.VMAST_DESC
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxvmst] ON [dbo].[VMAST_DESC] ([Vtype])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [PK_Acmast] PRIMARY KEY ([Cltcode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ACMAST_LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[ACMAST_LEDGER] ADD CONSTRAINT [PK_ACMAST_LEDGER] PRIMARY KEY ([CLTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Branchaccounts
-- --------------------------------------------------
ALTER TABLE [dbo].[Branchaccounts] ADD CONSTRAINT [Pk_branchaccounts] PRIMARY KEY ([Branchname])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CANNED_LEDGERBALANCE
-- --------------------------------------------------
ALTER TABLE [dbo].[CANNED_LEDGERBALANCE] ADD CONSTRAINT [PK_CANNED_LEDGERBALANCE] PRIMARY KEY ([CLTCODE], [ENTRYTYPE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CBO_INT_DATEWISEBALANCES
-- --------------------------------------------------
ALTER TABLE [dbo].[CBO_INT_DATEWISEBALANCES] ADD CONSTRAINT [PK_CBO_INT_DATEWISEBALANCES] PRIMARY KEY ([BALDATE], [CLTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CBO_INT_DATEWISEBALANCES_TMP
-- --------------------------------------------------
ALTER TABLE [dbo].[CBO_INT_DATEWISEBALANCES_TMP] ADD CONSTRAINT [PK_CBO_INT_DATEWISEBALANCES_TMP] PRIMARY KEY ([BALDATE], [CLTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CBO_INT_DATEWISELOG
-- --------------------------------------------------
ALTER TABLE [dbo].[CBO_INT_DATEWISELOG] ADD CONSTRAINT [PK_CBO_INT_DATEWISELOG] PRIMARY KEY ([BALDATE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CBO_INT_POSTINGDETAILS
-- --------------------------------------------------
ALTER TABLE [dbo].[CBO_INT_POSTINGDETAILS] ADD CONSTRAINT [PK_CBO_INT_POSTINGDETAILS] PRIMARY KEY ([BALDATE], [CLTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER_PARENT
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER_PARENT] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER_PARENT] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SettPayout
-- --------------------------------------------------
ALTER TABLE [dbo].[SettPayout] ADD CONSTRAINT [PK_SettPayout] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_AGEINGDATA
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_AGEINGDATA] ADD CONSTRAINT [PK_V2_AGEINGDATA] PRIMARY KEY ([BALDATETYPE], [CLTCODE], [SEGMENTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_AGEINGFINAL
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_AGEINGFINAL] ADD CONSTRAINT [PK_V2_AGEINGFINAL] PRIMARY KEY ([BALDATETYPE], [CLTCODE], [SEGMENTCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_LastVno
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_LastVno] ADD CONSTRAINT [PK_V2_LastVno] PRIMARY KEY ([FldAuto])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_SETTPAYOUT
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_SETTPAYOUT] ADD CONSTRAINT [PK_V2_SETTPAYOUT] PRIMARY KEY ([SRNO])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ABC
-- --------------------------------------------------
CREATE PROC ABC AS

INSERT INTO LEDGER (Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Cltcode,Booktype, BALAMT)
VALUES (6, '1', 'JUL  7 2006', 1, 'YATIN', 'C', 2, 'JUL  7 2006', 'ZZZZZZZZ', '01', 0)

INSERT INTO LEDGER (Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Cltcode,Booktype, BALAMT)
VALUES (6, '1', 'JUL  7 2006', 1, 'YATIN', 'D', 2, 'JUL  7 2006', '0A141', '01', 0)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_acwisereport
-- --------------------------------------------------
Create Proc Acc_acwisereport
@Reptype Varchar(7), 
@Grplen Tinyint, 
@Grpcode Varchar(10), 
@Fdate Varchar(11), 
@Tdate Varchar(11), 
@Faccode Varchar(10), 
@Taccode Varchar(10), 
@Costcode Smallint
As
Declare 
@@Grpchars As Int
Select @@Grpchars = (Select Len(Rtrim(@Grpcode)) )
If Len(Rtrim(@Faccode)) = 0
Begin
   Select @Faccode = ( Select Min(Cltcode) From Acmast )
End
If Len(Rtrim(@Taccode)) = 0
Begin
   Select @Taccode = ( Select Max(Cltcode) From Acmast )
End
If Rtrim(@Reptype) = 'Account'
Begin
   If @Grplen = 0 
      Begin
 Select L2.Cltcode, A.Acname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59' And Accat = 3
        And L2.Cltcode > = @Faccode And L2.Cltcode < = @Taccode
 Group By L2.Cltcode, A.Acname
 Order By L2.Cltcode, A.Acname
      End
   Else
   If @Grplen = 2
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And L2.Cltcode = Rtrim(@Faccode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End
   Else
   If @Grplen = 10
      Begin
 Select L2.Costcode, Costname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Grpcode Like Rtrim(@Grpcode)+'%'
        And L2.Cltcode > = @Faccode And L2.Cltcode < = @Taccode
 Group By L2.Costcode, Costname
 Order By L2.Costcode, Costname
      End
   Else   
      Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)
 And L2.Cltcode = Rtrim(@Faccode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
     End
End
Else
Begin
 Select Vdate = Convert(Varchar, L.Vdt, 103) , Shortdesc, L2.Vtype, L2.Booktype, L2.Vno, L2.Lno, 
 L2.Cltcode, A.Acname, L2.Drcr, L2.Camt, L.Narration, 
 Chqno = Isnull((Select Ddno From Ledger1 L1 Where L1.Vtyp = L2.Vtype And L1.Booktype = L2.Booktype And L1.Vno = L2.Vno And L1.Lno = L2.Lno), '')
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L, Vmast V
 Where L2.Cltcode = Rtrim(@Faccode) And  L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate + ' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = @Costcode And L2.Vtype = V.Vtype
 Order By L2.Cltcode, A.Acname
End
/*
Else
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_addacmast1
-- --------------------------------------------------
Create Procedure Acc_addacmast1 As   
Select Grpname, Grpcode , Grpmain ,   
Maingrpname = (Case   
  When  Left(Grpmain, 2) = 'A0' Then (Select Grpname From Grpmast Where Grpcode = 'A0000000000')   
         Else  
          (Case When  Left(Grpmain, 2) = 'L0' Then (Select Grpname From Grpmast Where Grpcode = 'L0000000000')    
   Else   
    (Case When  Left(Grpmain, 2) = 'N0' Then (Select Grpname From Grpmast Where Grpcode = 'N0000000000')  
    Else   
     (Case When  Left(Grpmain, 2) = 'X0' Then (Select Grpname From Grpmast Where Grpcode = 'X0000000000')  
      End)  
      End)     
    End )   
      End)  
From Grpmast Order By Grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_BankSlipReprint
-- --------------------------------------------------
/*Cahnged by amit to display the acname and accode */       
/****** Object:  Stored Procedure dbo.acc_BankSlipReprint    Script Date: 04/07/2003 12:28:25 PM ******/      
/****** Object:  Stored Procedure dbo.BankSlipReprint    Script Date: 10/16/2002 4:40:54 PM ******/      
CREATE proc acc_BankSlipReprint      
@cltcode  varchar(10),      
@booktype varchar(2),      
@startslip int,      
@endslip int
As      
      
/*      
select  SlipNo, ddno, slipdate, acname, bnkname, brnname, relamt, cltcode, l1.vno, l1.lno      
from ledger l , ledger1 l1       
where l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype = l1.booktype  and l.vtyp in ( '2', '19')      
and l.booktype = @booktype and slipno >= @startslip and slipno <= @endslip and l.cltcode = @cltcode      
order By SlipNo, Slipdate, l1.vno, l1.lno      
*/      
      
select  SlipNo, ddno, slipdate, acname, bnkname, brnname, relamt, cltcode, l1.vno, l1.lno      
from ledger l , ledger1 l1       
where l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype = l1.booktype  and l.vtyp in ( '2', '19')      
and l.booktype = @booktype and slipno >= @startslip and slipno <= @endslip and l.cltcode <> @cltcode      
and l.vno in  (select vno from ledger l2 where  cltcode =@cltcode and l.vtyp=l2.vtyp and l.booktype = l2.booktype )      
order By SlipNo, Slipdate, l1.vno, l1.lno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_CANNEDMONEYPAYOUT_FN
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[ACC_CANNEDMONEYPAYOUT_FN]  
 @SDATE VARCHAR(11),  
 @STATUSNAME VARCHAR(30),  
 @BANKCODE VARCHAR(10),  
 @BOOKTYPE VARCHAR(2),  
 @PAYMODE VARCHAR(1),  
 @LDATE VARCHAR(11),  
 @DISPLAY VARCHAR(1) = 'A',  
 @DISPREC VARCHAR(5) = 'ALL',  
 @FCODE VARCHAR(10) = '0000000000',  
 @TCODE VARCHAR(10) = 'ZZZZZZZZZZ',  
 @FILTER TINYINT = 0,  
 @FORNEXT TINYINT = 0  
AS  
/*  
 EXEC ACC_CANNEDMONEYPAYOUT 'APR  1 2006', 'ARSL', '1111111', '01', '', 'MAR 31 2007', 'A', 'ALL', '0', 'ZZZ', 2  
 EXEC ACC_CANNEDMONEYPAYOUT 'Apr 1 2006', 'ebroking', '1111111', '', '', 'Mar 31 2007', 'A', '100', '0', 'z', 2  
*/  
DECLARE  
 @@LDATE AS VARCHAR(11),  
 @@SQL AS VARCHAR(2000)  
 SET NOCOUNT ON  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  

/*===================================================================================================
	START :: PATCH ADDED FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/
IF UPPER(@STATUSNAME) <> 'BROKER'  
BEGIN  
	SELECT BRANCH_CODE INTO #BRANCH FROM MSAJAG.DBO.BRANCH WHERE 1=2
	
	IF (SELECT COUNT(1) FROM MSAJAG.DBO.BRANCH WHERE BRANCH_CODE = @STATUSNAME) <> 0 
	BEGIN
		INSERT INTO #BRANCH SELECT @STATUSNAME 
	END
	ELSE
	BEGIN
		INSERT INTO #BRANCH SELECT BRANCH_CODE FROM MSAJAG.DBO.AREA WHERE AREACODE = @STATUSNAME
	END
END
/*===================================================================================================
	END :: PATCH ADDED FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/

IF UPPER(@STATUSNAME) = 'BROKER'  
 BEGIN  
  IF CONVERT(DATETIME,@LDATE + ' 23:59:59' ) >= GETDATE()  
   BEGIN  
    SELECT @@SQL = "DELETE FROM HOPAYOUT WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "INSERT INTO HOPAYOUT "  
    SELECT @@SQL = @@SQL + "SELECT    "  
    IF @DISPREC <> 'ALL'  
     BEGIN  
      SELECT @@SQL = @@SQL + " TOP " + @DISPREC + " "  
     END  
    SELECT @@SQL = @@SQL + " L.CLTCODE,    "  
    SELECT @@SQL = @@SQL + " ACNAME = (A.LONGNAME),    "  
    SELECT @@SQL = @@SQL + " CHEQUENAME =A.LONGNAME,    "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,    "  
    SELECT @@SQL = @@SQL + " A.ACCAT,    "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,    "  
    SELECT @@SQL = @@SQL + " EFFECTIVEBALANCE = SUM(CASE WHEN EDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59'  AND    "  
    SELECT @@SQL = @@SQL + "       EDT >='" + @SDATE  + "' THEN  (CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END END) ELSE 0 END ),    "  
    SELECT @@SQL = @@SQL + " LEDGERBALANCE = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END),    "  
    SELECT @@SQL = @@SQL + " BILLAMT = SUM(CASE WHEN (EDT LIKE LEFT(CONVERT(VARCHAR,GETDATE(),109),11) +'%'  AND L.VTYP='15') THEN    "  
    SELECT @@SQL = @@SQL + "    (CASE WHEN DRCR = 'D' THEN 0 ELSE - VAMT END) ELSE 0 END ),    "  
    SELECT @@SQL = @@SQL + " FUTUREPAYOUT =0,    "  
    SELECT @@SQL = @@SQL + " SHORTAGE=0,    "  
    SELECT @@SQL = @@SQL + " AMOUNTTOBEPAID = ISNULL(AMOUNTTOBEPAID,0), "  
    SELECT @@SQL = @@SQL + " SNO = ISNULL(P.SNO, 0),  "  
    SELECT @@SQL = @@SQL + " PAYMODE = ISNULL(A.PAYMODE, ''),  "  
    SELECT @@SQL = @@SQL + " EXPAY = 0, "  
    SELECT @@SQL = @@SQL + " SPID = @@SPID  "  
    SELECT @@SQL = @@SQL + "FROM    "  
    SELECT @@SQL = @@SQL + " PAYMENTMARKING P WITH(INDEX(MONEYPAYOUTIDX)),    "  
    SELECT @@SQL = @@SQL + " LEDGER L (NOLOCK) ,ACMAST A (NOLOCK)    "  
    SELECT @@SQL = @@SQL + "WHERE    "  
    SELECT @@SQL = @@SQL + " A.CLTCODE = P.CLTCODE    "  
    SELECT @@SQL = @@SQL + " AND P.CLTCODE = L.CLTCODE    "  
    SELECT @@SQL = @@SQL + "  AND P.CLTCODE BETWEEN '" + @FCODE + "' AND '" + @TCODE + "' "  
    SELECT @@SQL = @@SQL + " AND HOAPPROVAL = '0'    "  
    SELECT @@SQL = @@SQL + " AND VDT >= '" + @SDATE + "'    "  
    SELECT @@SQL = @@SQL + " AND VDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59'    "  
    SELECT @@SQL = @@SQL + " AND A.PAYMODE LIKE '" + @PAYMODE + "%'    "  
    SELECT @@SQL = @@SQL + " AND A.POBANKCODE = '" + @BANKCODE + "'    "  
    SELECT @@SQL = @@SQL + " AND PAYMENTDATE LIKE LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + '%'    "  
    IF @DISPLAY = 'B'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT = '1'    "  
     END  
    ELSE IF @DISPLAY = 'N'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT <> '1'    "  
     END  
    SELECT @@SQL = @@SQL + "GROUP BY    "  
    SELECT @@SQL = @@SQL + " L.CLTCODE,    "  
    SELECT @@SQL = @@SQL + "A.LONGNAME,    "  
    SELECT @@SQL = @@SQL + " A.LONGNAME,    "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,    "  
    SELECT @@SQL = @@SQL + " A.ACCAT,    "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,    "  
    SELECT @@SQL = @@SQL + " ISNULL(AMOUNTTOBEPAID,0), "  
    SELECT @@SQL = @@SQL + " ISNULL(P.SNO, 0), "  
    SELECT @@SQL = @@SQL + " ISNULL(A.PAYMODE, '')  "  
   END  
  ELSE  
   BEGIN  
    SELECT @@SQL = "DELETE FROM HOPAYOUT WHERE SPID = @@SPID  "  
    SELECT @@SQL = @@SQL + "INSERT INTO HOPAYOUT "  
    SELECT @@SQL = @@SQL + "SELECT     "  
    IF @DISPREC <> 'ALL'  
     BEGIN  
      SELECT @@SQL = @@SQL + " TOP " + @DISPREC + " "  
     END  
    SELECT @@SQL = @@SQL + " L.CLTCODE,     "  
    SELECT @@SQL = @@SQL + " ACNAME = (A.LONGNAME),     "  
    SELECT @@SQL = @@SQL + " CHEQUENAME = A.LONGNAME,     "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,     "  
    SELECT @@SQL = @@SQL + " A.ACCAT,     "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,     "  
    SELECT @@SQL = @@SQL + " EFFECTIVEBALANCE = SUM(CASE WHEN EDT <= '" + @LDATE + "' + ' 23:59'  AND     "  
    SELECT @@SQL = @@SQL + "       EDT >= '" + @SDATE + "'  THEN  (CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END END) ELSE 0 END ),     "  
    SELECT @@SQL = @@SQL + " LEDGERBALANCE = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE - VAMT END),     "  
    SELECT @@SQL = @@SQL + " BILLAMT = SUM(CASE WHEN (EDT LIKE '" + @LDATE + "%'  AND L.VTYP='15') THEN     "  
    SELECT @@SQL = @@SQL + "    (CASE WHEN DRCR = 'D' THEN 0 ELSE - VAMT END) ELSE 0 END),     "  
    SELECT @@SQL = @@SQL + " FUTUREPAYOUT = 0,     "  
    SELECT @@SQL = @@SQL + " SHORTAGE = 0,     "  
    SELECT @@SQL = @@SQL + " AMOUNTTOBEPAID = ISNULL(AMOUNTTOBEPAID,0),     "  
    SELECT @@SQL = @@SQL + " PAYMODE = ISNULL(A.PAYMODE, ''),  "  
    SELECT @@SQL = @@SQL + " EXPAY = 0 "  
    SELECT @@SQL = @@SQL + "FROM     "  
    SELECT @@SQL = @@SQL + " PAYMENTMARKING P WITH(INDEX(MONEYPAYOUTIDX)),     "  
    SELECT @@SQL = @@SQL + " LEDGER L (NOLOCK),     "  
    SELECT @@SQL = @@SQL + " ACMAST A  (NOLOCK)     "  
    SELECT @@SQL = @@SQL + "WHERE     "  
    SELECT @@SQL = @@SQL + " A.CLTCODE = P.CLTCODE     "  
    SELECT @@SQL = @@SQL + " AND P.CLTCODE = L.CLTCODE     "  
    SELECT @@SQL = @@SQL + "  AND P.CLTCODE BETWEEN '" + @FCODE + "' AND '" + @TCODE + "' "  
    SELECT @@SQL = @@SQL + " AND HOAPPROVAL = '0'     "  
    SELECT @@SQL = @@SQL + " AND VDT >='" + @SDATE + "'     "  
    SELECT @@SQL = @@SQL + " AND VDT <='" + @LDATE + " 23:59'     "  
    SELECT @@SQL = @@SQL + " AND A.PAYMODE LIKE '" + @PAYMODE + "%'     "  
    SELECT @@SQL = @@SQL + " AND A.POBANKCODE = '" + @BANKCODE + "'     "  
    SELECT @@SQL = @@SQL + " AND PAYMENTDATE LIKE '" + @LDATE + "%'     "  
    IF @DISPLAY = 'B'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT = '1'    "  
     END  
    ELSE IF @DISPLAY = 'N'  
     BEGIN  
      SELECT @@SQL = @@SQL + " AND A.BTOBPAYMENT <> '1'    "  
     END  
    SELECT @@SQL = @@SQL + "GROUP BY     "  
    SELECT @@SQL = @@SQL + " L.CLTCODE,     "  
    SELECT @@SQL = @@SQL + " L.LONGNAME,     "  
    SELECT @@SQL = @@SQL + " A.LONGNAME,     "  
    SELECT @@SQL = @@SQL + " A.BRANCHCODE,     "  
    SELECT @@SQL = @@SQL + " A.ACCAT,     "  
    SELECT @@SQL = @@SQL + " A.BTOBPAYMENT,     "  
    SELECT @@SQL = @@SQL + " ISNULL(AMOUNTTOBEPAID,0),     "  
    SELECT @@SQL = @@SQL + " ISNULL(A.PAYMODE, '')  "  
   END  
--  PRINT @@SQL  
  EXEC (@@SQL)  
  SELECT  
   L.CLTCODE,  
   EFFECTIVEREV = SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END)  
  INTO  
   #HOPAYOUT  
  FROM  
   HOPAYOUT H,  
   LEDGER L  
  WHERE  
   H.CLTCODE = L.CLTCODE  
   AND L.VDT < @SDATE  
   AND L.EDT >= @SDATE  
   AND L.EDT <= @LDATE + ' 23:59'  
   AND H.SPID = @@SPID  
  GROUP BY  
   L.CLTCODE  
  
  UPDATE H SET EFFECTIVEBALANCE = EFFECTIVEBALANCE - HH.EFFECTIVEREV FROM HOPAYOUT H, #HOPAYOUT HH WHERE H.CLTCODE = HH.CLTCODE AND H.SPID = @@SPID  
  
  SELECT @@SQL = "UPDATE HOPAYOUT SET EXPAY = 1 WHERE AMOUNTTOBEPAID > ABS(EFFECTIVEBALANCE) AND AMOUNTTOBEPAID > ABS(LEDGERBALANCE) AND AMOUNTTOBEPAID > ABS(BILLAMT) AND SPID = @@SPID "  
  EXEC (@@SQL)  
  SELECT @@SQL = "SELECT * FROM HOPAYOUT WHERE SPID = @@SPID ORDER BY EXPAY, CLTCODE, BRANCHCODE"  
  EXEC (@@SQL)  
  SELECT @@SQL = "DELETE FROM HOPAYOUT WHERE SPID = @@SPID "  
  EXEC (@@SQL)  
 END  
ELSE  
 BEGIN  
  IF CONVERT(DATETIME,@LDATE + ' 23:59:59' ) >= GETDATE()  
   BEGIN  
    SELECT @@LDATE = CONVERT(VARCHAR(11), GETDATE(), 109)  
   END  
  ELSE  
   BEGIN  
    SELECT @@LDATE = @LDATE  
   END  
  SELECT @@SQL = "SELECT "  
  IF @DISPREC <> 'ALL'  
   BEGIN  
    SELECT @@SQL = @@SQL + " TOP " + @DISPREC + " "  
   END  
   SELECT @@SQL = @@SQL + "  F.CLTCODE,    "  
   SELECT @@SQL = @@SQL + "  F.ACNAME,    "  
   SELECT @@SQL = @@SQL + "  F.CHEQUENAME,    "  
   SELECT @@SQL = @@SQL + "  F.BRANCHCODE,    "  
   SELECT @@SQL = @@SQL + "  F.ACCAT,    "  
   SELECT @@SQL = @@SQL + "  F.BTOBPAYMENT,    "  
   SELECT @@SQL = @@SQL + "  EFFECTIVEBALANCE = ROUND(F.EFFECTIVEBALANCE, 2),    "  
   SELECT @@SQL = @@SQL + "  LEDGERBALANCE = ROUND(F.LEDGERBALANCE, 2),    "  
   SELECT @@SQL = @@SQL + "  F.BILLAMT,    "  
   SELECT @@SQL = @@SQL + "  F.FUTUREPAYOUT,    "  
   SELECT @@SQL = @@SQL + "  F.SHORTAGE,    "  
   SELECT @@SQL = @@SQL + "  AMOUNTTOBEPAID = ISNULL(P.AMOUNTTOBEPAID, 0), "  
   SELECT @@SQL = @@SQL + "  SNO = ISNULL(P.SNO, 0), "  
   SELECT @@SQL = @@SQL + "  EXPAY = 0 "  
   SELECT @@SQL = @@SQL + " FROM    "  
   SELECT @@SQL = @@SQL + "  FILLED_MONEYPAYOUT F LEFT OUTER JOIN PAYMENTMARKING P WITH(INDEX(MONEYPAYOUTIDX))    "  
   SELECT @@SQL = @@SQL + "  ON ( F.CLTCODE = P.CLTCODE    "  
   SELECT @@SQL = @@SQL + "  AND P.HOAPPROVAL = '0' "  
   SELECT @@SQL = @@SQL + "  AND CONVERT(VARCHAR(11), P.PAYMENTDATE, 109) = '" + @@LDATE + "') "  

/*===================================================================================================
	START :: CHANGES MADE FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/

   SELECT @@SQL = @@SQL + "  , #BRANCH B "  
   SELECT @@SQL = @@SQL + " WHERE    "  
--   SELECT @@SQL = @@SQL + "  F.BRANCHCODE = '" + @STATUSNAME    + "' "  
   SELECT @@SQL = @@SQL + "  F.BRANCHCODE = B.BRANCH_CODE "  

/*===================================================================================================
	START :: CHANGES MADE FOR ENABLING AREA LOGIN REQUEST
===================================================================================================*/

   SELECT @@SQL = @@SQL + "  AND CONVERT(VARCHAR(11), PROC_DATE, 109) = '" + @@LDATE    + "' "  
   SELECT @@SQL = @@SQL + "  AND F.LEDGERBALANCE <> 0    "  
   IF @FORNEXT = 0  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND F.CLTCODE BETWEEN '" + @FCODE + "' AND '" + @TCODE + "' "  
    END  
   ELSE  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND F.CLTCODE > '" + @FCODE + "' AND F.CLTCODE <= '" + @TCODE + "' "  
    END  
   IF @FILTER = 1  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND ISNULL(P.AMOUNTTOBEPAID, 0) = 0 "  
    END  
   ELSE IF @FILTER = 2  
    BEGIN  
     SELECT @@SQL = @@SQL + "  AND ISNULL(P.AMOUNTTOBEPAID, 0) > 0 "  
    END  
   SELECT @@SQL = @@SQL + "  ORDER BY    "  
   SELECT @@SQL = @@SQL + "   F.CLTCODE,    "  
   SELECT @@SQL = @@SQL + "   F.BRANCHCODE    "  
   --PRINT (@@SQL)  
   EXEC (@@SQL)  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costaccodewisedtl
-- --------------------------------------------------
Create Proc Acc_costaccodewisedtl
@Costcode Smallint, 
@Accode   Varchar(10), 
@Fdate Varchar(11), 
@Tdate Varchar(11)
As
Select Vdate = Convert(Varchar, L.Vdt, 103) , Shortdesc, L2.Vtype, L2.Booktype, L2.Vno, L2.Lno, 
L2.Cltcode, A.Acname, L2.Drcr, L2.Camt, L.Narration, 
Chqno = Isnull((Select Ddno From Ledger1 L1 Where L1.Vtyp = L2.Vtype And L1.Booktype = L2.Booktype And L1.Vno = L2.Vno And L1.Lno = L2.Lno), '')
From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L, Vmast V
Where L2.Cltcode = Rtrim(@Accode) And  L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
And L.Vdt > = @Fdate + ' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
And L2.Costcode = @Costcode And L2.Vtype = V.Vtype
Order By L2.Cltcode, A.Acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costaccodewisesum
-- --------------------------------------------------
Create Proc Acc_costaccodewisesum
@Costcode Smallint, 
@Fdate Varchar(11), 
@Tdate Varchar(11)
As
Select L2.Costcode, Costname, L2.Cltcode, A.Acname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
From Ledger2 L2, Ledger L, Costmast C, Acmast A
Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
And L2.Costcode = C.Costcode And L2.Costcode = @Costcode And L2.Cltcode = A.Cltcode
Group By L2.Costcode, Costname, L2.Cltcode, A.Acname
Order By L2.Costcode, Costname, L2.Cltcode, A.Acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costwisereport
-- --------------------------------------------------
Create Proc Acc_costwisereport
@Grplen Tinyint, 
@Grpcode Varchar(10), 
@Fdate Varchar(11), 
@Tdate Varchar(11)
As
Declare 
@@Grpchars As Int
Select @@Grpchars = (Select Len(Rtrim(@Grpcode)) )
If @Grplen = 2
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End
Else
If @Grplen = 10
   Begin
 Select L2.Costcode, Costname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And Left(Grpcode, @@Grpchars) = Rtrim(@Grpcode)
 Group By L2.Costcode, Costname
 Order By L2.Costcode, Costname
   End
Else
   Begin
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)
 From Ledger2 L2, Ledger L, Costmast C, Category Cc
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)
 Group By Category, Left(Grpcode, @Grplen)
 Order By Category, Left(Grpcode, @Grplen)
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DELVOUCHER
-- --------------------------------------------------
CREATE PROCEDURE ACC_DELVOUCHER        
@VNO VARCHAR(12),         
@VTYP  SMALLINT,         
@BOOKTYPE VARCHAR(2),         
@EMODE CHAR(1),         
@STATUS CHAR(6),         
@EDITNAME VARCHAR(15),         
@VDT VARCHAR(11)        
AS        
DECLARE        
@@VDT1 AS DATETIME        
  
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))        
INSERT INTO LEDGER_LOG         
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO LEDGER1_LOG        
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO LEDGER2_LOG         
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO LEDGER3_LOG        
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO MATCHDETAILS_LOG        
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO         
INSERT INTO MARGINLEDGER_LOG        
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
  
DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO         
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO    

IF @VTYP = 8  
 UPDATE THIRDPARTY_COLLECTION SET TPR_FLAG = 'D' WHERE ISNULL(VNO_JV, '') = @VNO       
  
IF @VTYP = 2  
 UPDATE THIRDPARTY_COLLECTION SET TPR_FLAG = 'D' WHERE ISNULL(VNO, '') = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DIAGNOSTICS
-- --------------------------------------------------


CREATE PROCEDURE ACC_DIAGNOSTICS
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@SELECTION VARCHAR(100),
	@UNAME VARCHAR(25),
	@CSV VARCHAR(1) = 'N'
AS

/*
	SP CREATED BY	:	YATIN
	SP CREATED ON	:	AUG 1, 2006
	SP CREATED TO GET VARIOUS MISMATCHES IN ACCOUNT DATABASE.
	MAINLY RELATED TO LEDGER, LEDGER1, LEDGER2, COSTMAST, BRANCHACCOUNTS, ACMAST
	TRUNCATE TABLE DIAG_RESULT
	TRUNCATE TABLE DIAG_LOG
	EXEC ACC_DIAGNOSTICS 'APR  1 2006', 'MAR 31 2007', 'Y,N,N,N,N,N,N,N,N,N', 'SYSTEM', 'Y'
	SELECT * FROM DIAG_LOG
	TABLES REQUIRED DIAG_RESULT AND DIAG_LOG
	DROP TABLE SYSTEM_20060907141734870
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'Y,N,N,N,N,N,N,N,N', 'nirupamah', 'Y'
BEGIN TRAN
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'N,N,N,N,N,N,N,Y,N', 'nirupamah', 'N'
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'N,N,N,N,N,Y,N,N,N', 'jaydeep', 'N'
ROLLBACK


*/

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @@ERROR_COUNT AS INT, @@SQL AS VARCHAR(2000), @@SHAREDB AS VARCHAR(25), @TNAME AS VARCHAR(50)
/*------------------------FIND DUPLICATE VOUCHERS----------------------------------*/
IF SUBSTRING(@SELECTION, 1, 1) = 'Y'
	BEGIN
		SELECT 
			RESULT = 'VNO :' + VNO + ', VTYP :' + CONVERT(VARCHAR, VTYP) + ', BOOKTYPE :' + BOOKTYPE + ', NOS = ' + CONVERT(VARCHAR, COUNT(1))
		INTO
			#LEDGER
		FROM 
			LEDGER 
		WHERE 
			LNO = 2 
		GROUP BY 
			VNO, 
			VTYP, 
			BOOKTYPE 
		HAVING 
			COUNT(1) > 1
		
		SELECT @@ERROR_COUNT = 0
		SELECT @@ERROR_COUNT = COUNT(1) FROM #LEDGER
		IF @@ERROR_COUNT > 0
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'DUPLICATE VOUCHER NOS. FOUND~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT, PROCID = @@SPID FROM #LEDGER
			END
		ELSE
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID) VALUES ('NO VOUCHER FOUND AS DUPLICATED~', @@SPID)
			END
		DROP TABLE #LEDGER
	END
/*------------------------FIND DIFFERENT VOUCHERS WITH SAMEDATA----------------------------------*/

IF SUBSTRING(@SELECTION, 3, 1) = 'Y'
	BEGIN
		SELECT
			RESULT = 'CLTCODE :' + (L.CLTCODE + ', VDT :' + CONVERT(VARCHAR(10), L.VDT, 103) + ', VNO :' + L.VNO + ', VTYP :' + CONVERT(VARCHAR, L.VTYP) + ', BOOKTYPE :' + L.BOOKTYPE + ', DRCR :' + L.DRCR + ', ' + 'Rs.' + CONVERT(VARCHAR, L.VAMT) + ', NARRATION :' + REPLACE(L.NARRATION, '~', '`'))
		INTO #LEDGER1
		FROM LEDGER L (NOLOCK),
			(
				SELECT  LED.VTYP, LED.BOOKTYPE, LED.CLTCODE, VDT = CONVERT(VARCHAR(11), VDT), DDNO, NARRATION, LED.DRCR, LED.VAMT
				FROM LEDGER LED (NOLOCK),
				LEDGER1 LED1 (NOLOCK),
				ACMAST A (NOLOCK)
				WHERE LED.VNO = LED1.VNO AND LED.VTYP = LED1.VTYP AND LED.BOOKTYPE = LED1.BOOKTYPE AND LED.LNO = LED1.LNO
				AND LED.CLTCODE = A.CLTCODE
				AND ACCAT = 4
				AND DDNO <> '0' AND DDNO <> ''
				GROUP BY VAMT, LED.VTYP, LED.BOOKTYPE, LED.CLTCODE, CONVERT(VARCHAR(11), VDT), DDNO, NARRATION, LED.DRCR
				HAVING COUNT(1) > 1
			) DUP
		WHERE
		L.VAMT = DUP.VAMT
		AND L.VTYP = DUP.VTYP
		AND L.BOOKTYPE = DUP.BOOKTYPE
		AND L.DRCR = DUP.DRCR
		AND LEFT(CONVERT(VARCHAR, L.VDT,109),11) =  DUP.VDT
		AND L.CLTCODE = DUP.CLTCODE
		ORDER BY L.CLTCODE, L.VDT, L.DRCR, L.VAMT, L.VNO, L.BOOKTYPE, L.NARRATION
		
		SELECT @@ERROR_COUNT = 0
		SELECT @@ERROR_COUNT = COUNT(1) FROM #LEDGER1
		IF @@ERROR_COUNT > 0
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'VOUCHERS FOUND WITH DIFFERENT VNOs. BUT SAME KIND OF DATA.(USER NEEDS TO VERIFY THIS DATA)~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'COLUMNS SERIES = CLTCODE, VDT, VNO, VTYP, BOOKTYPE, DRCR, AMOUNT, NARRATION~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT, PROCID = @@SPID FROM #LEDGER1
			END
		ELSE
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID) VALUES ('NO VOUCHER FOUND AS DIFFERENT VNOs BUT SAME KIND OF DATA~', @@SPID)
			END
		DROP TABLE #LEDGER1
	END

/*------------------------------------------------TRIAL BALANCE MISMATCH QUERIES------------------------------------------*/
/*------------------------FIND DRCR MISMATCH----------------------------------*/
	IF SUBSTRING(@SELECTION, 5, 1) = 'Y'
		BEGIN
			DECLARE
				@@DIFF AS MONEY,
				@@COUNTER AS INT
			CREATE TABLE #LEDGERMISMATCH
				(
					PARTICULARS VARCHAR(30),
					DIFF MONEY,
					REMARK VARCHAR(100)
				)
			
			INSERT INTO #LEDGERMISMATCH
			SELECT 
				PARTICULARS = 'LEDGER TOTALS', 
				DIFF = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
				REMARK = ''
			FROM
				LEDGER
			WHERE 
				VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
			
			SELECT @@DIFF = DIFF FROM #LEDGERMISMATCH
			
			IF ISNULL(@@DIFF, 0) <> 0
				BEGIN
					CREATE TABLE #MISSVNO
						(
							VNO VARCHAR(12),
							VTYP SMALLINT,
							BOOKTYPE VARCHAR(2)
						)
					INSERT INTO #MISSVNO
					SELECT 
						VNO, 
						VTYP, 
						BOOKTYPE
					FROM
						LEDGER
					WHERE 
						VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
					GROUP BY
						VNO, 
						VTYP, 
						BOOKTYPE
					HAVING
						SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) <> 0
			
					SELECT 
						@@COUNTER = COUNT(1) 
					FROM 
						#MISSVNO
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT 
								RESULT = 'VOUCHERS WITH DEBIT AND CREDIT MISMATCHES~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT 
								RESULT = 'VNO :' + VNO + ', VTYP :' + CONVERT(VARCHAR, VTYP) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
							FROM 
								#MISSVNO
						END
					DROP TABLE #MISSVNO
				END
			
				DROP TABLE #LEDGERMISMATCH
			
			/*------------------------FIND MULTIPLE VDTs----------------------------------*/
				CREATE TABLE #MISSDATES
					(
						VNO VARCHAR(12),
						VTYP SMALLINT,
						BOOKTYPE VARCHAR(2)
					)
				INSERT INTO #MISSDATES
					(	
						VNO,
						VTYP,
						BOOKTYPE
					)
				SELECT
					VNO,
					VTYP,
					BOOKTYPE
				FROM
					(
						SELECT
							VNO,
							VTYP,
							BOOKTYPE
						FROM
							LEDGER
						WHERE
							VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
						GROUP BY
							VNO,
							VTYP,
							BOOKTYPE,
							CONVERT(VARCHAR(11), VDT, 109)
					) A
				GROUP BY
					VNO,
					VTYP,
					BOOKTYPE
				HAVING
					COUNT(1) > 1
			
			
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSDATES
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'VOUCHER(S) FOUND WITH DIFFERENT VOUCHER DATES~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT 
							RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSDATES
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'NO VOUCHER(S) FOUND WITH MULTIPLE VOUCHER DATES~', PROCID = @@SPID
					END
			
			
				TRUNCATE TABLE #MISSDATES
			/*------------------------FIND MULTIPLE EDTs----------------------------------*/
			
				INSERT INTO #MISSDATES
					(	
						VNO,
						VTYP,
						BOOKTYPE
					)
				SELECT
					VNO,
					VTYP,
					BOOKTYPE
				FROM
					(
						SELECT
							VNO,
							VTYP,
							BOOKTYPE
						FROM
							LEDGER
						WHERE
							EDT BETWEEN @FDATE AND @TDATE + ' 23:59'
						GROUP BY
							VNO,
							VTYP,
							BOOKTYPE,
							CONVERT(VARCHAR(11), EDT, 109)
					) A
				GROUP BY
					VNO,
					VTYP,
					BOOKTYPE
				HAVING
					COUNT(1) > 1
			
			
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSDATES
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'VOUCHER(S) FOUND WITH DIFFERENT EFFECTIVE DATES~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT 
							RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSDATES
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'NO VOUCHER(S) FOUND WITH MULTIPLE EFFECTIVE DATES~', PROCID = @@SPID
					END
				DROP TABLE #MISSDATES
			
			/*------------------------FIND MISSING CLIENT CODES FROM ACMAST----------------------------------*/
			
				SELECT @@COUNTER = 0
				CREATE TABLE #MISSCLTS
					(
						CLTCODE VARCHAR(10),
						VNO VARCHAR(12),
						VTYP SMALLINT,
						BOOKTYPE VARCHAR(2)
					)
				INSERT INTO #MISSCLTS (CLTCODE, VNO, VTYP, BOOKTYPE)
				SELECT L.CLTCODE, L.VNO, L.VTYP, L.BOOKTYPE FROM LEDGER L WHERE NOT EXISTS (SELECT CLTCODE FROM ACMAST A WHERE L.CLTCODE = A.CLTCODE)
				
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSCLTS
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'FOLLOWING CLTCODEs DO NOT EXIST IN ACMAST.~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT DISTINCT
							RESULT = 'CLTCODE :' + CLTCODE + ', VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSCLTS
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'CLTCODE MISMATCH NOT FOUND.~', PROCID = @@SPID
					END
				DROP TABLE #MISSCLTS
		END
/*------------------------FIND MISSING ENTRIES FROM LEDGER2----------------------------------*/

	IF SUBSTRING(@SELECTION, 7, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSL2
				(
					VNO VARCHAR(12),
					VTYP SMALLINT,
					BOOKTYPE VARCHAR(2)
				)
		
			INSERT INTO #MISSL2
				(
					VNO,
					VTYP,
					BOOKTYPE
				)
			SELECT
				VNO,
				VTYP,
				BOOKTYPE
			FROM
				LEDGER L
			WHERE
				VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
				AND
				NOT EXISTS
				(
					SELECT
						VNO,
						VTYPE,
						BOOKTYPE
					FROM
						LEDGER2 L2
					WHERE
						L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE
						AND L.BOOKTYPE = L2.BOOKTYPE
				)
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSL2
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING VOUCHERS DO NOT EXIST IN LEDGER2 BUT POSTED IN LEDGER.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT DISTINCT
						RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
					FROM
						#MISSL2
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO VOUCHERS FOUND AS MISSING IN LEDGER2.~', PROCID = @@SPID
				END
			DROP TABLE #MISSL2
		END

/*------------------------FIND BILLS YET TO BE POSTED----------------------------------*/

	IF SUBSTRING(@SELECTION, 9, 1) = 'Y'
		BEGIN
			SELECT TOP 1
				@@SHAREDB = SHAREDB
			FROM
				OWNER
		
			CREATE TABLE #ACCBILL
				(
					SETT_NO VARCHAR(7),
					SETT_TYPE VARCHAR(2)
				)
		
			CREATE TABLE #BILLMATCH
				(
					SETT_NO VARCHAR(7),
					SETT_TYPE VARCHAR(2)
				)
		
			SELECT @@SQL = "INSERT INTO #ACCBILL (SETT_NO, SETT_TYPE) "
			SELECT @@SQL = @@SQL + "SELECT DISTINCT "
			SELECT @@SQL = @@SQL + "	SETT_NO, "
			SELECT @@SQL = @@SQL + "	SETT_TYPE "
			SELECT @@SQL = @@SQL + "FROM "
			SELECT @@SQL = @@SQL + "	" + @@SHAREDB + ".DBO.ACCBILL "
		
			EXEC(@@SQL)
		
			INSERT INTO #BILLMATCH (SETT_NO, SETT_TYPE)
			SELECT DISTINCT
				SETT_NO,
				SETT_TYPE
			FROM
				BILLMATCH
		
			SELECT
				A.SETT_NO,
				A.SETT_TYPE
			INTO
				#MISSBILLS
			FROM
				#ACCBILL A
			WHERE
				NOT EXISTS
				(
					SELECT
						SETT_NO,
						SETT_TYPE
					FROM
						#BILLMATCH B
					WHERE
						A.SETT_NO = B.SETT_NO
						AND A.SETT_TYPE = B.SETT_TYPE
				)
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSBILLS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BILLS FOR THE FOLLOWING SETTLEMENTS ARE NOT YET POSTED IN LEDGER.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'SETT.NO.:-' + SETT_NO + ', SETT. TYPE.:' + SETT_TYPE, PROCID = @@SPID
					FROM
						#MISSBILLS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO BILLS FOUND AS UNPOSTED.~', PROCID = @@SPID
				END
			DROP TABLE #MISSBILLS
		END
	
/*------------------------FIND BRANCH AND COSTMASTER MISMATCHES----------------------------------*/

	IF SUBSTRING(@SELECTION, 11, 1) = 'Y'
		BEGIN
			SELECT TOP 1
				@@SHAREDB=SHAREDB
			FROM
				OWNER
			CREATE TABLE #BRANCHES
			(
				BRANCH_CODE VARCHAR(20)
			)
			SELECT @@SQL = ''
			SELECT @@SQL = "INSERT INTO #BRANCHES (BRANCH_CODE) "
			SELECT @@SQL = @@SQL + "SELECT DISTINCT "
			SELECT @@SQL = @@SQL + "	BRANCH_CODE "
			SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.BRANCH B "
			SELECT @@SQL = @@SQL + "WHERE "
			SELECT @@SQL = @@SQL + "	NOT EXISTS "
			SELECT @@SQL = @@SQL + "	( "
			SELECT @@SQL = @@SQL + "		SELECT DISTINCT COSTNAME FROM COSTMAST C "
			SELECT @@SQL = @@SQL + "		WHERE B.BRANCH_CODE = C.COSTNAME "
			SELECT @@SQL = @@SQL + "	) "
			PRINT @@SQL
			EXEC(@@SQL)
		
			SELECT @@COUNTER = 0
		
			SELECT @@COUNTER = COUNT(1) FROM #BRANCHES
		
			IF @@COUNTER > 0
				BEGIN
					DECLARE @@MAXCOST AS INT
					SELECT @@MAXCOST = ISNULL(MAX(COSTCODE), 0) FROM COSTMAST
					IF ISNULL(@@MAXCOST, 0 ) = 0
						BEGIN
							SELECT @@MAXCOST = 1
						END
					ELSE
						BEGIN
							SELECT @@MAXCOST = @@MAXCOST + 1
						END
					CREATE TABLE #COSTMAST
					(
						COSTNAME VARCHAR(20),
						CATCODE SMALLINT,
						GRPCODE VARCHAR(20)
					)
					SELECT @@SQL = "ALTER TABLE #COSTMAST "
					SELECT @@SQL = @@SQL + "ADD COSTCODE INT IDENTITY (" + CONVERT(VARCHAR, @@MAXCOST) + ", 1) "
					EXEC (@@SQL)
					INSERT INTO #COSTMAST (COSTNAME, CATCODE, GRPCODE)
					SELECT
						BRANCH_CODE,
						CATCODE = 1,
						GRPCODE = 'A0000000000'
					FROM
						#BRANCHES
					INSERT INTO COSTMAST (COSTNAME, COSTCODE, CATCODE, GRPCODE)
					SELECT COSTNAME, COSTCODE, CATCODE, GRPCODE FROM #COSTMAST
		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING COST MAST ENTRIES HAVE BEEN UPDATED...~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BRANCHNAME : ' + COSTNAME + ', COSTCODE : ' + LTRIM(RTRIM(CONVERT(VARCHAR, COSTCODE))), PROCID = @@SPID
					FROM
						#COSTMAST
					DROP TABLE #COSTMAST
				END
		
			TRUNCATE TABLE #BRANCHES


			INSERT INTO #BRANCHES (BRANCH_CODE)
			SELECT DISTINCT
				COSTNAME
			FROM
				COSTMAST C
			WHERE
				NOT EXISTS
				(
					SELECT DISTINCT
						BRANCHNAME
					FROM
						BRANCHACCOUNTS B
					WHERE
						C.COSTNAME = B.BRANCHNAME
				)
		
			SELECT @@COUNTER = 0
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#BRANCHES
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO
						BRANCHACCOUNTS (BRANCHNAME, BRCONTROLAC, MAINCONTROLAC, DEFAULTAC)
					SELECT
						BRANCH_CODE,
						BRCONTROLAC = LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10),
						MAINCONTROLAC = 'HOCTRL',
						DEFAULTAC = 0
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) <= 10
						AND LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') <= 10

		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING BRANCHACCOUNTS ENTRIES HAVE BEEN UPDATED...~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BRANCHNAME : ' + BRANCH_CODE + ', BRCONTROLAC : ' + LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10), PROCID = @@SPID
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) <= 10
					SELECT @@COUNTER = 0
					SELECT
						@@COUNTER = COUNT(1)
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) > 10
						OR LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') > 10
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'FOLLOWING BRANCHACCOUNTS ENTRIES HAVE NOT BEEN UPDATED AS LENGTH OF BRANCH CODE OR BRANCHCONTROL ACCOUNTS IS EXCEEDING ...~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'BRANCHNAME : ' + BRANCH_CODE + ', BRCONTROLAC : ' + LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10), PROCID = @@SPID
							FROM
								#BRANCHES
							WHERE
								LEN(LTRIM(RTRIM(BRANCH_CODE))) > 10
								OR LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') > 10
						END
				END
			DROP TABLE #BRANCHES
		
		/*------------------------FIND BRANCHACCOUNTS AND ACMAST MISMATCHES----------------------------------*/
			CREATE TABLE #BRANCHES1
			(
				BRANCH_CODE VARCHAR(10),
				BRCONTROLAC VARCHAR(10)
			)
		
			INSERT INTO #BRANCHES1 (BRANCH_CODE, BRCONTROLAC)
			SELECT DISTINCT
				BRANCHNAME,
				BRCONTROLAC
			FROM
				BRANCHACCOUNTS B
			WHERE
				NOT EXISTS
				(
					SELECT DISTINCT
						CLTCODE
					FROM
						ACMAST A
					WHERE
						B.BRCONTROLAC = A.CLTCODE
				)
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#BRANCHES1
		
			IF @@COUNTER > 0
				BEGIN
					CREATE TABLE #DUPLICATEBRS
					(
						BRCONTROLAC VARCHAR(10),
						ACNAME VARCHAR(100)
					)
					CREATE TABLE #DUPLICATEBRS1
					(
						BRCONTROLAC VARCHAR(10)
					)

					INSERT INTO
						#DUPLICATEBRS
					SELECT
						CLTCODE,
						LONGNAME
					FROM
						ACMAST A
					WHERE
						EXISTS
							(SELECT DISTINCT
								BRCONTROLAC
							FROM
								#BRANCHES1 B
							WHERE
								B.BRCONTROLAC = A.CLTCODE
							)

					INSERT INTO
						#DUPLICATEBRS
						(BRCONTROLAC)
					SELECT
						BRCONTROLAC
					FROM
						#BRANCHES1
					GROUP BY
						BRCONTROLAC
					HAVING
						COUNT(1) > 1

					DELETE B
					FROM
						#BRANCHES1 B,
						#DUPLICATEBRS D
					WHERE
						B.BRCONTROLAC = D.BRCONTROLAC

					INSERT INTO ACMAST (ACNAME, LONGNAME, ACTYP, ACCAT, FAMILYCD, CLTCODE, ACCDTLS, GRPCODE, BOOKTYPE, MICRNO, BRANCHCODE, BTOBPAYMENT, PAYMODE, POBANKNAME, POBRANCH, POBANKCODE)
					SELECT
						ACNAME = BRANCH_CODE + 'CONTROL A/C',
						LONGNAME = BRANCH_CODE + 'CONTROL A/C',
						ACTYP = 'ASSETS',
						ACCAT = 3,
						FAMILYCD = '',
						CLTCODE = BRCONTROLAC,
						ACCDTLS = '',
						GRPCODE = 'A0000000001',
						BOOKTYPE = '',
						MICRNO = 0,
						BRANCHCODE = BRANCH_CODE,
						BTOBPAYMENT = 0,
						PAYMODE = 'P',
						POBANKNAME = '',
						POBRANCH = '',
						POBANKCODE = ''
					FROM
						#BRANCHES1
		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING CONTROL ACCOUNT ENTRIES HAVE BEEN UPDATED IN ACMAST~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'CLTCODE : ' + BRCONTROLAC + ', BRANCH : ' + BRANCH_CODE, PROCID = @@SPID
					FROM
						#BRANCHES1
					SELECT @@COUNTER = 0
					SELECT
						@@COUNTER = COUNT(1)
					FROM
						#DUPLICATEBRS
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'FOLLOWING CONTROL ACCOUNT ENTRIES HAVE NOT BEEN ADDED IN ACMAST AS FOLLOWING ENTRIES FOUND OR MIGHT BE DUPLICATE ENTRIES WITH SAME CODE~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'CLTCODE : ' + ISNULL(BRCONTROLAC, '') + ', LONG NAME : ' + ISNULL(ACNAME, ''), PROCID = @@SPID
							FROM
								#DUPLICATEBRS
						END
					DROP TABLE #DUPLICATEBRS
				END
			DROP TABLE #BRANCHES1
		END

/*------------------------VALIDATING LEDGER AND LASTVNO CONSISTANCY----------------------------------*/
	IF SUBSTRING(@SELECTION, 13, 1) = 'Y'
		BEGIN
			DECLARE @@PARA AS CURSOR, @@SDTCUR AS VARCHAR(11), @@LDTCUR AS VARCHAR(11), @@VNOFLAG AS SMALLINT
			CREATE TABLE #LDVNO
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				VNO VARCHAR(12)
			)
		
			CREATE TABLE #LTVNO
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				VNO VARCHAR(12)
			)
		
			CREATE TABLE #MISSVNOS
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				LDVNO VARCHAR(12),
				LTVNO VARCHAR(12),
				FINYEAR VARCHAR(30)
			)
		
			SET @@PARA = CURSOR FOR
				SELECT
					SDTCUR	= CONVERT(VARCHAR(11), SDTCUR, 109),
					LDTCUR		= CONVERT(VARCHAR(11), LDTCUR, 109),
					VNOFLAG	= VNOFLAG
				FROM
					PARAMETER
				ORDER BY
					SDTCUR
			OPEN @@PARA
			FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			WHILE @@FETCH_STATUS = 0
				BEGIN
					SELECT @@SQL = "INSERT INTO #LDVNO (VTYP, BOOKTYPE, VNO) "
					SELECT @@SQL = @@SQL + "SELECT VTYP, BOOKTYPE, VNO = MAX(VNO) "
					SELECT @@SQL = @@SQL + "FROM LEDGER "
					SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @@SDTCUR + "' AND '" + @@LDTCUR + " 23:59' "
					SELECT @@SQL = @@SQL + "GROUP BY VTYP, BOOKTYPE"
					IF @@VNOFLAG = 1
						BEGIN
							SELECT @@SQL = @@SQL + ", CONVERT(VARCHAR(11), VDT, 109) "
						END
					ELSE IF @@VNOFLAG = 2
						BEGIN
							SELECT @@SQL = @@SQL + ", MONTH(VDT), YEAR(VDT)"
						END
					EXEC (@@SQL)
		
					SELECT @@SQL = "INSERT INTO #LTVNO (VTYP, BOOKTYPE, VNO) "
					SELECT @@SQL = @@SQL + "SELECT VTYP, BOOKTYPE, VNO = MAX(LASTVNO) "
					SELECT @@SQL = @@SQL + "FROM LASTVNO "
					SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @@SDTCUR + "' AND '" + @@LDTCUR + " 23:59' "
					SELECT @@SQL = @@SQL + "GROUP BY VTYP, BOOKTYPE"
					IF @@VNOFLAG = 1
						BEGIN
							SELECT @@SQL = @@SQL + ", CONVERT(VARCHAR(11), VDT, 109) "
						END
					ELSE IF @@VNOFLAG = 2
						BEGIN
							SELECT @@SQL = @@SQL + ", MONTH(VDT), YEAR(VDT)"
						END
					EXEC (@@SQL)
		
					INSERT INTO #MISSVNOS (VTYP, BOOKTYPE, LTVNO, LDVNO, FINYEAR)
					SELECT LT.VTYP, LT.BOOKTYPE, LT.VNO, LDVNO = ISNULL(LD.VNO, '000000000000'), FINYEAR = @@SDTCUR + ' - ' + @@LDTCUR
					FROM #LTVNO LT LEFT JOIN #LDVNO LD ON LT.VTYP = LD.VTYP AND LT.BOOKTYPE = LD.BOOKTYPE
					WHERE CONVERT(NUMERIC, LT.VNO) < CONVERT(NUMERIC, ISNULL(LD.VNO, '000000000000'))
					TRUNCATE TABLE #LDVNO
					TRUNCATE TABLE #LTVNO
					FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
				END
			CLOSE @@PARA
			DEALLOCATE @@PARA

			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSVNOS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING VTYPEs AND BOOKTYPEs ARE HAVING MISMATCH IN VNO GENERATION INTO LEDGER AND LASTVNO~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE + 'LASTVNO : ' + LTVNO + ', LEDGER VNO : ' + LDVNO + ', FINANCIAL YEAR : ' + FINYEAR,
						PROCID = @@SPID
					FROM
						#MISSVNOS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN VNO GENERATION INTO LEDGER AND LASTVNO.~', PROCID = @@SPID
				END
			DROP TABLE #MISSVNOS
			DROP TABLE #LDVNO
			DROP TABLE #LTVNO
		END

/*------------------------VALIDATING VALID VNO SERIES IN YEARLY VNO GENERATION----------------------------------*/

	IF SUBSTRING(@SELECTION, 15, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSSRS
			(
				FINYEAR VARCHAR(30),
				PROPERSR VARCHAR(4),
				INVALIDSR VARCHAR(4)
			)
			SET @@PARA = CURSOR FOR
				SELECT
					SDTCUR	= CONVERT(VARCHAR(11), SDTCUR, 109),
					LDTCUR		= CONVERT(VARCHAR(11), LDTCUR, 109),
					VNOFLAG	= VNOFLAG
				FROM
					PARAMETER
				ORDER BY
					SDTCUR
			OPEN @@PARA
			FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			WHILE @@FETCH_STATUS = 0
				BEGIN
					IF @@VNOFLAG = 0
						BEGIN
							INSERT INTO #MISSSRS (FINYEAR, PROPERSR, INVALIDSR)
							SELECT DISTINCT
								FINYEAR = @@SDTCUR + ' - ' + @@LDTCUR,
								PROPERSR = CONVERT(VARCHAR(4), YEAR(CONVERT(DATETIME, @@SDTCUR, 109))),
								INVALIDSR = LEFT(VNO, 4)
							FROM
								LEDGER
							WHERE
								VDT BETWEEN @@SDTCUR AND @@LDTCUR + ' 23:59'
								AND LEFT(VNO, 4) <> CONVERT(VARCHAR(4), YEAR(CONVERT(DATETIME, @@SDTCUR, 109)))
						END
					FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
				END
			CLOSE @@PARA
			DEALLOCATE @@PARA
		
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSSRS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'IN FOLLOWING FINANCIAL YEAR(S), THE VNO SERIES IS MISMATCHED.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FINANCIAL YEAR :' + FINYEAR + ', ' + 'PROPER SERIES SHOULD START FROM :' + PROPERSR + ', SERIES STARTING WITH :' + INVALIDSR,
						PROCID = @@SPID
					FROM
						#MISSSRS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN VNO SERIES GENERATION.~', PROCID = @@SPID
				END
		END

/*------------------------VALIDATING EFFECTIVE DATE WITH REALISATION DATE IN RECEIPT VOUCHERS----------------------------------*/

	IF SUBSTRING(@SELECTION, 17, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSEFFDT
			(
				VNO VARCHAR(12),
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				EDT DATETIME,
				RELDT DATETIME
			)
		
			INSERT INTO #MISSEFFDT (VNO, VTYP, BOOKTYPE, EDT, RELDT)
			SELECT
				VNO = L.VNO,
				VTYP = L.VTYP,
				BOOKTYPE = L.BOOKTYPE,
				EDT = CONVERT(VARCHAR(11), L.EDT, 109),
				RELDT = CONVERT(VARCHAR(11), L1.RELDT, 109)
			FROM
				LEDGER L,
				LEDGER1 L1
			WHERE
				L.VNO = L1.VNO
				AND L.VTYP = L1.VTYP
				AND L.BOOKTYPE = L1.BOOKTYPE
				AND L.LNO = L1.LNO
				AND L.VTYP = 2
				AND (L1.RELDT IS NOT NULL AND L1.RELDT <> '')
				AND CONVERT(VARCHAR(11), L.EDT, 109) = 'DEC 31 2049'
		
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSEFFDT
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'THE CHEQUES/DDs ARE REALISED BUT EFFECTIVE DATE IS NOT UPDATED FROM DEC 31 2049 IN FOLLOWING VOUCHERS~',
						PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE + ', REALISED ON :' + CONVERT(VARCHAR(10), RELDT, 103) + ', EFFECTIVE ON :' + CONVERT(VARCHAR(10), EDT, 103),
						PROCID = @@SPID
					FROM
						#MISSEFFDT
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN REALISATION AND EFFECTIVE DATES IN RECEIPT VOUCHERS.~', PROCID = @@SPID
				END
		END

	INSERT INTO DIAG_LOG (ACTIONDATE, COMP_NAME, APPLICATION, USERNAME, OPTIONS, PERIOD, RESULT, PROCID)
	SELECT
		ACTIONDATE = GETDATE(),
		COMP_NAME = HOST_NAME(),
		APPLICATION = APP_NAME(),
		USERNAME = @UNAME,
		OPTIONS = REPLACE(REPLACE(REPLACE(@SELECTION, 'Y', '1'), 'N', '0'), ',', ''),
		PERIOD = @FDATE + ' - ' + @TDATE,
		RESULT,
		PROCID = @@SPID
	FROM
		DIAG_RESULT
	WHERE
		PROCID = @@SPID
	ORDER BY
		SNO
	INSERT INTO DIAG_RESULT (RESULT, PROCID)
	SELECT
		RESULT = '*^*REPORT EXECUTED ON : ' + CONVERT(VARCHAR, GETDATE(), 121) + ' WITH PROCESS ID :' + CONVERT(VARCHAR, @@SPID), PROCID = @@SPID

	IF @CSV = 'N'
		BEGIN
			SELECT RESULT FROM DIAG_RESULT WHERE PROCID = @@SPID ORDER BY SNO
			DELETE FROM DIAG_RESULT WHERE PROCID = @@SPID
		END
	ELSE
		BEGIN
			SELECT @TNAME = @UNAME + '_' + REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, GETDATE(), 121), '-', ''), ':', ''), '.', ''), ' ', '')
			SELECT @@SQL = "CREATE TABLE " + @TNAME
			SELECT @@SQL = @@SQL + "( "
			SELECT @@SQL = @@SQL + "	RESULT VARCHAR(2000), SNO INT IDENTITY(1,1) "
			SELECT @@SQL = @@SQL + ") "
			EXEC (@@SQL)
			SELECT @@SQL = "INSERT INTO " + @TNAME
			SELECT @@SQL = @@SQL + "(RESULT) "
			SELECT @@SQL = @@SQL + "SELECT RESULT FROM DIAG_RESULT WHERE PROCID = " + LTRIM(RTRIM(CONVERT(VARCHAR, @@SPID))) + " ORDER BY SNO"
			EXEC (@@SQL)
			DELETE FROM DIAG_RESULT WHERE PROCID = @@SPID
			SELECT SUCCESS = 1, TABLENAME = @TNAME
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_EDITVOUCHER
-- --------------------------------------------------

CREATE PROCEDURE ACC_EDITVOUCHER  
@VNO VARCHAR(12),   
@VTYP  SMALLINT,   
@BOOKTYPE VARCHAR(2),   
@EMODE CHAR(1),   
@STATUS CHAR(6),   
@EDITNAME VARCHAR(15),   
@VDT VARCHAR(11)  
AS  
DECLARE  
@@VDT1 AS DATETIME  
    
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))  

INSERT INTO LEDGER_LOG   
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER1_LOG  
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER2_LOG   
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER3_LOG  
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO MATCHDETAILS_LOG  
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
INSERT INTO MARGINLEDGER_LOG  
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  

DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/          
          
/*        
-------------------------------------        
New Procedure to Generate VNO        
-------------------------------------        
        
Author            : Uppili Krishnan        
Date               : Sep 30 2005        
Reviewed By   :        
Review Date   :        
Tested By       :           
Tested Date    :        
        
-------------------------------------        
        
                
      Flags:        
            VnoFlag = 0 Yearly        
            VnoFlag = 1 Daily        
            VnoFlag = 2 Monthly        
        
Logic:        
 Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination        
 if for the above combination record is not present in V2_LastVno table then a new record is inserted        
 else existing record is updated        
        
        
                                 
*/          
          
CREATE PROC Acc_GenVno
@vdt      varchar(11),  /* dd/mm/yyyy */                
@vtyp     smallint,                
@booktype varchar(2),                
@sdtcur   varchar(11),                
@ldtcur   varchar(11),      
@noofrecords int = 1      
/* @vnoflag  int */                
as                
                
                
                
Declare @@voudt  as datetime                
Declare @@maxvno as numeric(12,0)                
Declare @@vnoflag as tinyint                
Declare @@vno as varchar(12)                
Declare @@rcnt as int                
Declare @@FldAuto bigint                
Declare @@YearlyVdt varchar(11)              
Declare @@DailyVDt Varchar(11)                
Declare @@MonthlyVdt varchar(11)                
Declare @@UpdtVdt varchar(11)                
Declare @@FinYear smallint              
      
Declare @@ReturnVno as varchar(12)      
                
--SET NOCOUNT ON                
set Xact_abort on                
                
begin transaction                
        
Select         
      @sdtcur = LEFT(SDTCUR,11),         
      @ldtcur = LEFT(LDTCUR,11),         
      @@vnoflag = vnoflag,               
      @@FinYear = FldAuto                
from         
      Parameter         
where          
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur         
        
/*        
Select               
from               
      Parameter               
where                
      sdtcur like @sdtcur + '%'               
      and ldtcur like @ldtcur + '%'              
*/              
              
/*               
Reinitialising the Dates to be posted in the table.                
      For Daily, the Voucher Date is taken              
      For Monthly, the 1st Day of the Month  is Taken              
      For Yearly, the first Day of the year is taken              
*/              
              
select               
      @@voudt = (select convert(datetime,@vdt)),               
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),               
      @@DailyVdt = @Vdt,               
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)              
          
-- Doing Yearly Voucher Gen                
if @@vnoflag = 0                
   begin                
      select               
            @@FldAuto = isnull(FldAuto,0) ,               
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))               
      from               
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)               
      where               
            vtyp = @vtyp               
            and booktype = @booktype               
            and vdt = @@YearlyVdt + ' 00:00:00'               
            and VnoFlag = @@VnoFlag               
            and FinYear = @@FinYear              
              
              
      if @@ROWCOUNT=0              
         begin                
            -- If No Record Present, then Insert              
           select               
                  @@FldAuto=0,               
          @@UpdtVdt = @@YearlyVdt,               
                  @@ReturnVno = Right(@@YearlyVdt,4) + '00000001',                
  @@Vno = Right(@@YearlyVdt,4) + Replicate('0', 8-len(@noofrecords)) + cast(@noofrecords as varchar)                  
 end                
         else                
         begin                
           select               
            -- If record is Present, then Update              
                  @@UpdtVdt = @@YearlyVdt,               
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1))  ,              
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                
         end                
   end                
              
-- Doing Daily Voucher Gen                
else if @@vnoflag = 1                
        begin                
              
          select               
                  @@FldAuto = isnull(FldAuto,0) ,                
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))               
            from           
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)               
            where               
                  vtyp = @vtyp               
                  and booktype = @booktype               
                  and vdt = @@DailyVDt + ' 00:00:00'                
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear              
              
              
          if  @@ROWCOUNT=0              
             begin                
            -- If No Record Present, then Insert              
                select               
                  @@FldAuto=0,               
                  @@UpdtVdt = @@DailyVdt,               
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          ,      
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+ Replicate('0', 4-len(@noofrecords)) + cast(@noofrecords as varchar)      
      
             end                
          else                
             begin                
            -- If record is Present, then Update              
               select               
                  @@UpdtVdt = @@DailyVdt,               
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                
      
             end                
        end                
              
-- Doing Monthly Voucher Gen                
else if @@vnoflag = 2                
        begin                
          select               
                  @@FldAuto = isnull(FldAuto,0) ,               
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))               
            from               
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)               
            where               
                  vtyp = @vtyp               
                  and booktype = @booktype               
                  and vdt = @@MonthlyVDt + ' 00:00:00'                
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear              
              
              
          if  @@ROWCOUNT=0              
             begin                
            -- If No Record Present, then Insert              
                select               
                  @@FldAuto=0,               
                  @@UpdtVdt = @@MonthlyVdt,               
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001',                
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+ Replicate('0', 6-len(@noofrecords)) + cast(@noofrecords as varchar)      
      
             end                
         else                
       begin                
            -- If record is Present, then Update              
               select               
                  @@UpdtVdt = @@MonthlyVdt,               
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                
      
             end                
        end        
              
                
if @@error <> 0                 
begin                
 rollback transaction                
 select vno = ''                
 return                
end                 
else                
begin                
       if isnull(@@vno,'') <> ''                 
       begin                
                  if isnull(@@FldAuto,0) = 0                
                  begin                
                    -- If No Record Present, then Insert              
                        insert into V2_LastVno               
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)              
                        values               
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)                
                  end                
                  else                
                  begin                
                        -- If record is Present, then Update              
                        Update               
                              V2_LastVno               
                        set               
                              Lastvno = @@Vno               
                        where               
                              FldAuto = @@FldAuto                
                  end               
       
                        commit transaction                
      
                        select vno = @@Returnvno                
                        return                
       end                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno_new
-- --------------------------------------------------
        
        
CREATE PROC [dbo].[Acc_GenVno_new]  
@vdt      varchar(11),  /* dd/mm/yyyy */              
@vtyp     smallint,              
@booktype varchar(2),              
@sdtcur   varchar(11),              
@ldtcur   varchar(11),    
@noofrecords int = 1    
/* @vnoflag  int */              
as              
              
              
              
Declare @@voudt  as datetime              
Declare @@maxvno as numeric(12,0)              
Declare @@vnoflag as tinyint              
Declare @@vno as varchar(12)              
Declare @@rcnt as int              
Declare @@FldAuto bigint              
Declare @@YearlyVdt varchar(11)            
Declare @@DailyVDt Varchar(11)              
Declare @@MonthlyVdt varchar(11)              
Declare @@UpdtVdt varchar(11)              
Declare @@FinYear smallint            
    
Declare @@ReturnVno as varchar(12)    
              
--SET NOCOUNT ON              
set Xact_abort on              
              
begin transaction              
      
Select       
      @sdtcur = LEFT(SDTCUR,11),       
      @ldtcur = LEFT(LDTCUR,11),       
      @@vnoflag = vnoflag,             
      @@FinYear = FldAuto              
from       
      Parameter       
where        
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur       
      
/*      
Select             
from             
      Parameter             
where              
      sdtcur like @sdtcur + '%'             
      and ldtcur like @ldtcur + '%'            
*/            
            
/*             
Reinitialising the Dates to be posted in the table.              
      For Daily, the Voucher Date is taken            
      For Monthly, the 1st Day of the Month  is Taken            
      For Yearly, the first Day of the year is taken            
*/            
            
select             
      @@voudt = (select convert(datetime,@vdt)),             
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),             
      @@DailyVdt = @Vdt,             
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)            
        
-- Doing Yearly Voucher Gen              
if @@vnoflag = 0              
   begin              
      select             
            @@FldAuto = isnull(FldAuto,0) ,             
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))             
      from             
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)             
      where             
            vtyp = @vtyp             
            and booktype = @booktype             
            and vdt = @@YearlyVdt + ' 00:00:00'             
            and VnoFlag = @@VnoFlag             
            and FinYear = @@FinYear            
            
            
      if @@ROWCOUNT=0            
         begin              
            -- If No Record Present, then Insert            
           select             
                  @@FldAuto=0,             
                  @@UpdtVdt = @@YearlyVdt,             
                  @@ReturnVno = Right(@@YearlyVdt,4) + '00000001',              
  @@Vno = Right(@@YearlyVdt,4) + Replicate('0', 8-len(@noofrecords)) + cast(@noofrecords as varchar)                
 end              
         else              
         begin              
           select             
            -- If record is Present, then Update            
                  @@UpdtVdt = @@YearlyVdt,             
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1))  ,            
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))              
         end              
   end              
            
-- Doing Daily Voucher Gen              
else if @@vnoflag = 1              
        begin              
            
          select             
                  @@FldAuto = isnull(FldAuto,0) ,              
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))             
            from         
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)             
            where             
                  vtyp = @vtyp             
                  and booktype = @booktype             
                  and vdt = @@DailyVDt + ' 00:00:00'              
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear            
            
            
          if  @@ROWCOUNT=0            
             begin              
            -- If No Record Present, then Insert            
                select             
                  @@FldAuto=0,             
                  @@UpdtVdt = @@DailyVdt,             
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          ,    
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+ Replicate('0', 4-len(@noofrecords)) + cast(@noofrecords as varchar)    
    
             end              
          else              
             begin              
            -- If record is Present, then Update            
               select             
                  @@UpdtVdt = @@DailyVdt,             
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),              
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))              
    
             end              
        end              
            
-- Doing Monthly Voucher Gen              
else if @@vnoflag = 2              
        begin              
          select             
                  @@FldAuto = isnull(FldAuto,0) ,             
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))             
            from             
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)             
            where             
                  vtyp = @vtyp             
                  and booktype = @booktype             
                  and vdt = @@MonthlyVDt + ' 00:00:00'              
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear            
            
            
          if  @@ROWCOUNT=0            
             begin              
            -- If No Record Present, then Insert            
                select             
                  @@FldAuto=0,             
                  @@UpdtVdt = @@MonthlyVdt,             
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001',              
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+ Replicate('0', 6-len(@noofrecords)) + cast(@noofrecords as varchar)    
    
             end              
         else              
             begin              
            -- If record is Present, then Update            
               select             
                  @@UpdtVdt = @@MonthlyVdt,             
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),              
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))              
    
             end              
        end      
            
              
if @@error <> 0               
begin              
 rollback transaction              
 select vno = ''              
 return              
end               
else              
begin              
       if isnull(@@vno,'') <> ''               
       begin              
                  if isnull(@@FldAuto,0) = 0              
                  begin              
                    -- If No Record Present, then Insert            
                        insert into V2_LastVno             
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)            
                        values             
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)              
                  end              
                  else              
                  begin              
                        -- If record is Present, then Update            
                        Update             
                              V2_LastVno             
                        set             
                              Lastvno = @@Vno             
                        where             
                              FldAuto = @@FldAuto              
                  end             
     
                        commit transaction              
    
                        select vno = @@Returnvno              
                        return              
       end               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_GetSlipNo
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 06/24/2004 8:32:35 PM ******/    
    
/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 05/10/2004 5:29:36 PM ******/    
    
/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 04/07/2003 12:28:25 PM ******/    
CREATE PROCEDURE  acc_GetSlipNo    
@cltcode varchar(10),    
@booktype varchar(2),    
@flag integer    
AS    
/*    
select distinct convert(integer,slipno) slipno from slipreceipt order by slipno     
*/    
    
if @flag = 1    
begin    
 select distinct slipno     
 from ledger1 l1, ledger l    
 where l1.vtyp = l.vtyp and l1.booktype= l.booktype and l1.vno = l.vno     
 and l.cltcode = @cltcode and l1.vtyp in (2,19) and l1.booktype = @booktype and slipno <> 0    
 order by slipno    
end    
else    
begin    
 select distinct convert(varchar,slipdate,103)  slipdate from ledger1 l    
 where l.vtyp in (2,19) and l.booktype =@booktype  and slipno <> 0    
 order by convert(varchar,slipdate,103)    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_opbal
-- --------------------------------------------------

CREATE Procedure Acc_opbal
@Sdate Varchar(11),            /* As Mmm Dd Yyyy */
@Edate Varchar(11),            /* As Mmm Dd Yyyy */
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */
@Fcode Varchar(10), 
@Tcode Varchar(10), 
@Statusid Varchar(30), 
@Statusname Varchar(30), 
@Branch Varchar(10), 
@Selectionby Varchar(3), 
@Groupby Varchar(10), 
@Sortby Varchar(50), 
@Reportname Varchar(30), 
@Reportopt Varchar(10), 
@Fld1 Varchar(10), 
@Fld2 Varchar(10), 
@Fld3 Varchar(10)
As
Declare
@@Opendate   As Varchar(11)
/* -------------------------------------------------------------------------- */
If Len(Rtrim(@Fdate)) = 10 
Begin
   Select @Fdate = Left(@Fdate, 3) + ' ' + Substring(@Fdate, 4, 7)
End
If Len(Rtrim(@Sdate)) = 10 
Begin
   Select @Sdate = Left(@Sdate, 3) + ' ' + Substring(@Sdate, 4, 7)
End
If Len(Rtrim(@Tdate)) = 10 
Begin
   Select @Tdate = Left(@Tdate, 3) + ' ' + Substring(@Tdate, 4, 7)
End
If Len(Rtrim(@Edate)) = 10 
Begin
   Select @Edate = Left(@Edate, 3) + ' ' + Substring(@Edate, 4, 7)
End
If @Fdate = ''
Begin
   Select @Fdate = @Sdate
End
If @Tdate = ''
Begin
   Select @Tdate = @Edate
End
If @Reportname <> 'Marginledger'
Begin
/* Get Opendate From Sdate, Fdate Received As Parameter */
   If Upper(@Selectionby) = 'Vdt'
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Ledger Where Vtyp = 18 And Vdt < = @Fdate )
      End
   Else
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) From Ledger Where Vtyp = 18 And Edt < = @Fdate )
   End
/* -------------------------------------------------------------------------- */     
   If Upper(@Selectionby) = 'Vdt'
      Begin
         If @Sdate = @Fdate
            Begin
  If @@Opendate = @Fdate 
  Begin
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
                From Ledger 
                Where Cltcode = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
                Group By Cltcode
  End
  Else
  Begin
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
                From Ledger 
                Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
                Group By Cltcode
  End
            End
         Else
            Begin
               Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
               From Ledger 
               Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
               Group By Cltcode
            End
      End
   Else
      Begin
         If @Sdate = @Fdate And @@Opendate = @Fdate
            Begin
               Select Cltcode, Opbal = Sum(Balamt)
               From Ledger 
               Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18
               Group By Cltcode
            End
         Else
            Begin
               Select Cltcode, Opbal = Sum(Opbal)
               From
               ( Select Cltcode, Opbal = Sum(Balamt)
                 From Ledger 
                 Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18
                 Group By Cltcode
                 Union All
                 Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)
                 From Ledger 
                 Where Cltcode = @Fcode And Edt > = @@Opendate + ' 00:00:00' And Edt < @Fdate And Vtyp <> 18
                 Group By Cltcode ) T
               Group By Cltcode
            End
      End
End
If @Reportname = 'Marginledger'
Begin
/* Get Opendate From Sdate, Fdate Received As Parameter */
   If Upper(@Selectionby) = 'Vdt'
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )
      End
   Else
      Begin
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )
   End
/* -------------------------------------------------------------------------- */     
   If Upper(@Selectionby) = 'Vdt'
      Begin
         If @Sdate = @Fdate
            Begin
  If @@Opendate = @Fdate 
  Begin
                Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
                From Marginledger 
                Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
                Group By Party_code
  End
  Else
  Begin
      Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
                From Marginledger 
                Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
                Group By Party_code
  End
            End
         Else
            Begin
     Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
               From Marginledger 
               Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate 
               Group By Party_code
            End
      End
   Else
      Begin
         If @Sdate = @Fdate And @@Opendate = @Fdate
            Begin
               Select Cltcode = Party_code, Opbal = Sum(Sett_no)
               From Marginledger 
               Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
               Group By Party_code
            End
         Else
            Begin
               Select Cltcode, Opbal = Sum(Opbal)
               From
               ( Select Cltcode = Party_code, Opbal = Sum(Sett_no)
                 From Marginledger 
                 Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18
                 Group By Party_code
                 Union All
                 Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)
                 From Marginledger 
                 Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate And Vtyp <> 18
                 Group By Party_code) T
               Group By Cltcode
            End
      End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_partybalanceTest
-- --------------------------------------------------




/****** Object:  Stored Procedure dbo.acc_partybalanceTest    Script Date: 12/01/2004 18:54:22 ******/

/****** Object:  Stored Procedure dbo.acc_partybalanceTest    Script Date: 07/29/2004 21:15:15 ******/
/****** Object:  Stored Procedure dbo.acc_partybalance    Script Date: 05/13/2003 6:08:54 PM ******/
/* 
Exec acc_partybalance 'May 19 2003', 'vdt','Partywise','Normal','Apr 1 2003', 'Apr 1 2003', 1,'Apr 1 2003', 'BROKER', '%', 'vdt', 'A06075', 'A06075' 
*/
CREATE PROCEDURE [dbo].[acc_partybalanceTest]

/* report : consolidated trial balance        
file : trialbal.asp
displays consolidated trial balance */


@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3),          /* Whether report is based on VDT or EDT */
@fparty varchar(10),
@tparty varchar(10),
@extra varchar(1)

AS

declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@mwherepart1 as varchar(500),
@@mwherepart2 as varchar(500),
@@mwherepart3 as varchar(500),
@@addwhere    as varchar(200),
@@addwhere1   as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3)

if upper(@statusid) = 'BROKER'
begin
	select @@Groupby    = " group by l.Cltcode , a.acname, branchcode"
end
else
begin
	select @@Groupby    = " group by l.Cltcode , a.acname, branchcode"
end

if upper(@statusid) = 'BROKER'
begin
	if @flag = 'codewise'
	begin
	   select @@sortby = " order by  l.Cltcode, a.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  a.acname, l.Cltcode, branchcode"
	end
end
else
begin
	if @flag = 'codewise'
	begin
	   select @@sortby = " order by  l.Cltcode, a.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  a.acname, l.Cltcode, branchcode"
	end
end

if @viewoption = 'Partywise'  /* Only Party accounts to be displayed */
begin
   select @@addwhere  = "  and  a.accat in (4,104) and a.cltcode >= '" + @fparty + "' and a.cltcode <= '" + @tparty + "' "
   select @@addwhere1  = " and a.cltcode=c2.party_code and c1.cl_code=c2.cl_code "
end
else if @viewoption = 'GL'  /* Only Party accounts to be displayed */
     begin
        select @@addwhere  = " and a.accat not in (4,104) " 
     end
     else
     begin
        select @@addwhere  = " " 
     end

if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end

 if @statusid = 'branch'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end 

 if @statusid = 'subbroker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end 


 if @statusid = 'FAMILY'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end 


 if @statusid = 'Client'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end

end

/*  -- FOR BROKER --  */
/* ------------------ */

if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
      select @@wherepart  = @@wherepart1 + @@addwhere + @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart2 + @@addwhere +  @@addwhere1
         end
      else
         begin
	   select @@selectqury = "   select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury + " Amount = sum( case when l.vtyp = 18 then balamt else (case when upper(drcr) = 'D' then vamt else -vamt end) end)," 
	   select @@selectqury = @@selectqury + " unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end),"
	   select @@selectqury = @@selectqury + " margin = isnull(( select sum( case when m.vtyp = 18 then sett_no else (case when upper(m.drcr) = 'D' then amount else -amount end) end) "
	   select @@selectqury = @@selectqury + " from marginledger m, ledger l1  left outer join acmast a on l1.cltcode=  a.cltcode  "
	   select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere
	   select @@selectqury = @@selectqury + " and l1.vtyp = m.vtyp and l1.booktype = m.booktype and l1.vno = m.vno and m.party_code = l1.cltcode and l.cltcode = l1.cltcode),0) "
	   select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 "
           select @@wherepart  = @@wherepart2 + @@addwhere +   @@addwhere1
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3 + @@addwhere + @@addwhere1
         end
      else
         begin
	   select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere + @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
/*             select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
*/
         end
   end
end
end
/*  -- FOR BRANCH SELECTION --  */
/* -------------
--------------- */

if @statusid = 'Branch'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1 + @@addwhere +  @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2 + @@addwhere+  @@addwhere1
         end
      else         
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
           select @@fromtables = " "
           select @@wherepart  = " "
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3 + @@addwhere+ @@addwhere1
         end
      else
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
         end
   end
end
end


if @statusid = 'SubBroker'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1 + @@addwhere +  @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2 + @@addwhere+  @@addwhere1
         end
      else         
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
           select @@fromtables = " "
           select @@wherepart  = " "
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3 + @@addwhere+ @@addwhere1
         end
      else
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
         end
   end
end
end



if @statusid = 'FAMILY'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1 + @@addwhere +  @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2 + @@addwhere+  @@addwhere1
         end
      else         
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, family , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
           select @@fromtables = " "
           select @@wherepart  = " "
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3 + @@addwhere+ @@addwhere1
         end
      else
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
         end
   end
end
end




if @statusid = 'Client'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1 + @@addwhere+ @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2 + @@addwhere  + @@addwhere1
         end
      else         
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
           select @@fromtables = " "
           select @@wherepart  = " "
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3 + @@addwhere  + @@addwhere1  
         end
      else
        begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(a.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt >  CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')   then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , mcdx.dbo.client1 c1  ,mcdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere +  @@addwhere1 
           select @@wherepart  = @@wherepart + " group by l.Cltcode , a.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
         end
   end
end
end


/*Set @@wherepart = @@wherepart + " and region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "*/
Set @@wherepart = @@wherepart + " and branch_cd LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart= @@wherepart + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart = @@wherepart + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart = @@wherepart + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart = @@wherepart + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "


Print (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby) 

exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_PRINTRECONCILE
-- --------------------------------------------------
--EXEC ACC_PRINTRECONCILE '995116', 'STATEMENT', 'MAR 31 2008', 'MAR 31 2008'  
CREATE PROCEDURE  [DBO].[ACC_PRINTRECONCILE]                    
@CODE VARCHAR(10),                  
@REPORTTYPE VARCHAR(10),                  
@TDATE  DATETIME,                  
@FDATE  DATETIME                  
AS                  
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
                
IF UPPER(@REPORTTYPE) = 'STATEMENT'                  
BEGIN                  
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
	SELECT   
	 L.VTYP, L.BOOKTYPE, L.VNO, VDT, TDATE=CONVERT(VARCHAR,L.VDT,103), ISNULL(DDNO,'') DDNO, ISNULL(CLTCODE ,'') CLTCODE ,                   
	 ISNULL( ACNAME ,'') ACNAME, L.DRCR, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN RELAMT  ELSE 0 END ),                  
	 CRAMT= (CASE WHEN UPPER(L.DRCR) = 'C' THEN RELAMT ELSE 0 END ),                   
	 TRELDT=ISNULL(CONVERT(VARCHAR, RELDT , 103),''), L1.REFNO                  
	FROM   
	 LEDGER L,   
	 LEDGER1 L1 ,                  
	 (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CODE AND VDT <= @TDATE ) L2  
	WHERE   
	 L.VTYP = L2.VTYP AND L.VNO= L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE                   
	 AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO      
	 AND CLTCODE <> @CODE  
	 AND NOT EXISTS  
	  (SELECT L3.DDNO FROM LEDGER1 L3, (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CODE AND VDT <= @TDATE AND VTYP = 16) L4  
	  WHERE L1.DDNO = L3.DDNO AND CONVERT(VARCHAR(11),L1.DDDT,109) = CONVERT(VARCHAR(11),L3.DDDT,109) AND L1.RELAMT = L3.RELAMT  
	  AND L3.VNO = L4.VNO AND L3.VTYP = L4.VTYP AND L3.BOOKTYPE = L4.BOOKTYPE AND L1.BOOKTYPE = L3.BOOKTYPE )  
	 AND (RELDT ='1900-01-01 00:00:00.000' OR RELDT >  @TDATE )  
	ORDER BY   
	 L.DRCR, VDT, L.VTYP, L.VNO  
END                  
ELSE                  
BEGIN                  
	SELECT DISTINCT VTYP, BOOKTYPE, VNO, LNO INTO #TBLBANKRECO_TMP FROM LEDGER WHERE CLTCODE = @CODE         
	AND VDT >= @FDATE AND VDT <= @TDATE       
	      
	CREATE CLUSTERED      
	  INDEX [PARTYVDT] ON [DBO].[#TBLBANKRECO_TMP] ([VNO], [VTYP], [BOOKTYPE])      
	WITH      
		FILLFACTOR = 90      
	ON [PRIMARY]      
	      
	SELECT L.* INTO #LEDGER_TMP      
	FROM LEDGER L, #TBLBANKRECO_TMP T      
	WHERE L.VNO = T.VNO       
	AND L.VTYP = T.VTYP      
	AND L.BOOKTYPE = T.BOOKTYPE      
	      
	CREATE CLUSTERED      
	  INDEX [PARTYVDT] ON [DBO].[#LEDGER_TMP] ([VNO], [VTYP], [BOOKTYPE], [LNO])      
	WITH      
		FILLFACTOR = 90      
	ON [PRIMARY]      
	      
	SELECT L.* INTO #LEDGER1_TMP      
	FROM LEDGER1 L, #TBLBANKRECO_TMP T      
	WHERE L.VNO = T.VNO       
	AND L.VTYP = T.VTYP      
	AND L.BOOKTYPE = T.BOOKTYPE      
	      
	CREATE CLUSTERED      
	  INDEX [PARTYVDT] ON [DBO].[#LEDGER1_TMP] ([VNO], [VTYP], [BOOKTYPE], [LNO])      
	WITH      
		FILLFACTOR = 90      
	ON [PRIMARY]      
	      
	 SELECT L.VTYP, L.BOOKTYPE, L.VNO, VDT, TDATE=CONVERT(VARCHAR,L.VDT,103), ISNULL(DDNO,'') DDNO, ISNULL(CLTCODE ,'') CLTCODE ,                   
	 ISNULL( ACNAME ,'') ACNAME, L.DRCR, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN RELAMT  ELSE 0 END ),                  
	 CRAMT= (CASE WHEN UPPER(L.DRCR) = 'C' THEN RELAMT ELSE 0 END ),                   
	 TRELDT=ISNULL(CONVERT(VARCHAR, RELDT , 103),''), L1.REFNO                  
	 FROM #LEDGER_TMP L, #LEDGER1_TMP L1, #TBLBANKRECO_TMP T      
	 WHERE L.VTYP = T.VTYP AND L.VNO= T.VNO AND L.BOOKTYPE = T.BOOKTYPE                   
	 AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO      
	 AND CLTCODE <> @CODE AND VDT >= @FDATE AND VDT <= @TDATE                  
	 ORDER BY L.DRCR, VDT, L.VTYP, L.VNO      
	      
	DROP TABLE #TBLBANKRECO_TMP      
	DROP TABLE #LEDGER_TMP      
	DROP TABLE #LEDGER1_TMP      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_reports
-- --------------------------------------------------

CREATE procedure acc_reports 
@sdate varchar(11),            /* As mmm dd yyyy */
@edate varchar(11),            /* As mmm dd yyyy */
@fdate varchar(11),            /* As mmm dd yyyy */
@tdate varchar(11),            /* As mmm dd yyyy */
@fcode varchar(10),
@tcode varchar(10),
@statusId varchar(30),
@statusname varchar(30),
@branch varchar(10),
@selectionby varchar(3),
@GroupBy varchar(10),
@Sortby varchar(50),
@reportname varchar(30),
@reportopt varchar(10),
@fld1 varchar(50),		/*  To be used for Sharedb in case of Party Ledger */
@fld2 varchar(10),
@fld3 varchar(10)

as
declare
@@opendate   as varchar(11),         
@@selectqury as varchar(8000),
@@fromtables as varchar(2000),
@@wherepart  as varchar(8000),
@@Groupby    as varchar(200),
@@sortby     as varchar(200),
@@uall       as varchar(20),
@@Uselectqury as varchar(8000),
@@Ufromtables as varchar(2000),
@@Uwherepart  as varchar(8000),
@@UGroupby    as varchar(200),
@@Usortby     varchar(200),
@@datefilter as varchar(500),
@@ReportFrom as varchar(1)

/* -------------------------------------------------------------------------- */
if @fdate = " " 
begin
   select @fdate = @sdate
end

if @tdate = " "
begin
   select @tdate = @edate
end

/* Get filter condition on dates based on the value of @selectionby */

if @selectionby = 'vdt'
begin
   select @@datefilter = " Where l.vdt >= '" + @fdate + " 00:00:00' and l.vdt <= '" + @tdate +" 23:59:59'"
end
else if @selectionby = 'edt'
begin
   select @@datefilter = " Where l.edt >= '" + @fdate + " 00:00:00' and l.edt <= '" + @tdate +" 23:59:59'"
end
/* -------------------------------------------------------------------------- */     

if @Reportname = 'Cash Book' 
begin

   if upper(@Sortby) = 'VDT'
         select @@sortby = " order by voudt, l.vtyp, l.vno"
   else if upper(@sortby) = 'EDT'
         select @@sortby = " order by effdt, l.vtyp, l.vno"
	   else if upper(@sortby) = 'VTYPE'
	         select @@sortby = " order by l.vtyp, l.vdt, l.vno"
		else if upper(@sortby) = 'ACCODE'
		     select @@sortby = " order by l.cltcode, l.vdt, l.vtyp, l.vno"
			else if upper(@sortby) = 'ACNAME'
			     select @@sortby = " order by l.acname, l.vdt, l.vtyp, l.vno"
			   else if upper(@sortby) = 'BOOKTYPE'
	        		 select @@sortby = " order by l.booktype, l.vdt, l.vtyp, l.vno"
				   else if upper(@sortby) = 'VNO'
		        		 select @@sortby = " order by l.vno, l.vdt, l.vtyp"
					   else if upper(@sortby) = 'DRCR'
	        				 select @@sortby = " order by l.drcr, l.vdt, l.vtyp, l.vno"
						   else if upper(@sortby) = 'AMOUNT'
	        					 select @@sortby = " order by l.vamt, l.vdt, l.vtyp, l.vno"



   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "Select l.booktype, l.vtyp, l.vno, vdt=convert(varchar,vdt,103), Edt = convert(varchar,l.edt,103), cltcode, Acname=isnull(acname,''), voudt=l.vdt, effdt=l.edt, Debit = (Case When upper(l.DRCR) = 'C' Then  Vamt  Else  0 End), Credit = (Case When upper(l.DRCR) = 'D' Then  Vamt   Else  0 End), l.narration , l.drcr"
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger l "
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype "
         select @@groupby = " "
      end
   else
      begin
         select @@selectqury = "Select l.booktype, l.vtyp, l.vno, vdt=convert(varchar,vdt,103), Edt = convert(varchar,l.edt,103), cltcode=l2.cltcode, Acname=isnull(l.acname,''),voudt=l.vdt, effdt=l.edt, Debit = (Case When upper(l2.DRCR) = 'C' Then  camt Else  0 End), Credit = (Case When upper(l2.DRCR) = 'D' Then  camt   Else  0 End), l.narration, l2.drcr"
	 select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l "
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode =l.cltcode "
         select @@groupby = " "
      end
end

if @Reportname = 'Bank Book' 
begin
   if upper(@Sortby) = 'VDT'
         select @@sortby = " order by voudt, l.vtyp, l.vno"
   else if upper(@sortby) = 'EDT'
         select @@sortby = " order by effdt, l.vtyp, l.vno"
	   else if upper(@sortby) = 'VTYPE'
	         select @@sortby = " order by l.vtyp, l.vdt, l.vno"
		else if upper(@sortby) = 'ACCODE'
		     select @@sortby = " order by l.cltcode, l.vdt, l.vtyp, l.vno"
			else if upper(@sortby) = 'ACNAME'
			     select @@sortby = " order by l.acname, l.vdt, l.vtyp, l.vno"
			   else if upper(@sortby) = 'BOOKTYPE'
	        		 select @@sortby = " order by l.booktype, l.vdt, l.vtyp, l.vno"
				   else if upper(@sortby) = 'VNO'
		        		 select @@sortby = " order by l.vno, l.vdt, l.vtyp"
					   else if upper(@sortby) = 'DRCR'
	        				 select @@sortby = " order by l.drcr, l.vdt, l.vtyp, l.vno"
						   else if upper(@sortby) = 'AMOUNT'
	        					 select @@sortby = " order by l.vamt, l.vdt, l.vtyp, l.vno"

   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l.DRCR) = 'C' Then  Vamt  Else  0 End), Credit = (Case When upper(l.DRCR) ='D' Then  Vamt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where " + @@datefilter + " and cltcode = '" + @fcode + "') t, ledger l "
         select @@wherepart =  " l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype "
         select @@groupby = " "
      end
   else
      begin
/*         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), l2.cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select ddno from ledger1 l1 where l1.vno=l.vno and l1.vty

p=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l2.DRCR) = 'C' Then  camt  Else  0 End), Credit = (Case When upper(l2.DRCR) ='D' Then  camt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtyp, vno, booktype from ledger where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l " */
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode not in ( select brcontrolac from branchaccounts ) " */
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode =l.cltcode " 
         select @@groupby = " " */
         select @@selectqury = "SELECT l.booktype, Vdt = convert(varchar,l.vdt,103), effdt = l.edt, Edt = convert(varchar,l.edt,103), l2.cltcode, acname, L.VNO, l.vtyp, voudt=l.vdt, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), Debit = (Case When upper(l2.DRCR) = 'C' Then  camt  Else  0 End), Credit = (Case When upper(l2.DRCR) ='D' Then  camt   Else  0 End), l.Narration "
         select @@fromtables = " From (select distinct vtype, vno, booktype from ledger2 where cltcode = '" + @fcode + "') t, ledger2 l2, costmast c, ledger l " 
/*         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode <> '" + @fcode + "' and l.vtyp = t.vtyp and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype 

and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode not in ( select brcontrolac from branchaccounts ) " */
         select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode <> '" + @fcode + "' and l.vtyp = t.vtype and l.vno = t.vno and l.booktype = t.booktype and l2.vtype = l.vtyp and l2.vno = l.vno and l2.lno = l.lno and l2.booktype = l.booktype and rtrim(costname) = rtrim('" + @branch + "') and l2.costcode = c.costcode " 
         select @@groupby = " " 
      end
end

if @Reportname = 'GL' 
begin

/* Assign From and To account codes. */
   if @fcode = "" 
      begin
         select @fcode = (select min(cltcode) from acmast where accat <> 4)
      end

   if @tcode = "" 
      begin
         select @tcode = (select max(cltcode) from acmast where accat <> 4)
   end

   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
        select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, l.narration, ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp, l.booktype, vdt = convert(varchar,l.vdt,103), edt = convert(varchar,l.edt,103), accat "
        select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode ,vmast v "
        select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode >= '" + @fcode + "' and l.cltcode <= '" + @tcode + "' And vtyp = vtype and a.cltcode = l.cltcode and a.accat <> '4' "
        select @@groupby = " "
        select @@sortby = " order by l.cltcode, voudt, l.vtyp desc, l.vno"  
      end
   else
      begin
        select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end), l.vno, l.narration, ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp, l.booktype, vdt = convert(varchar,l.vdt,103), edt = convert(varchar,l.edt,103), accat "
        select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c  "
        select @@wherepart = @@datefilter + " and l2.vtype <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat <> '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
        select @@groupby = " "
        select @@sortby = " order by l2.cltcode, voudt, l.vtyp desc, l.vno"  
      end
end

if @Reportname = 'PartyLedger'
begin

 select @@sortby = " voudt, l.vtyp desc, l.vno" 
 if upper(@Sortby) = 'VDT'
    select @@sortby = " voudt, l.vtyp desc, l.vno" 
   else if upper(@sortby) = 'EDT'
           select @@sortby = " effdt, l.vtyp desc, l.vno" 

 if rtrim(@branch) = '' or rtrim(@branch) = '%' 
	select @@sortby = " l.cltcode," + @@sortby
 else
	select @@sortby = " l2.cltcode," + @@sortby

 if upper(rtrim(@groupby)) = 'FAMILY'
    select @@sortby = " order by cm.family, " + @@sortby
 else if upper(rtrim(@groupby)) = 'SUBBROKER'
       select @@sortby = " order by c1.Sub_Broker, " + @@sortby

 if left(@@sortby,6) <> ' order' 
    select @@sortby = " order by " + @@sortby
      
   if upper(rtrim(@groupby)) = 'FAMILY'
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, msajag.dbo.clientmaster cm " 
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype and l.cltcode = cm.party_code"
            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c, msajag.dbo.clientmaster cm   "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode = cm.party_code "
            select @@groupby = " "
         end  
   end
   else if upper(rtrim(@groupby)) = 'SUBBROKER'
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, " + rtrim(@fld1) + ".dbo.client1 c1, " + rtrim(@fld1) + ".dbo.client2 c2 "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype and l.cltcode = c2.party_code and c2.cl_code = c1.cl_code "

            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c,  " + rtrim(@fld1) + ".dbo.client1 c1, " + rtrim(@fld1) + ".dbo.client2 c2 "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode and l2.cltcode = c2.party_code and c2.cl_code = c1.cl_code "
            select @@groupby = " "
         end  
   end
   else
   begin
   if upper(@statusid) = 'BROKER' or upper(@statusid) = 'BRANCH' 
   begin
      if rtrim(@branch) = '' or rtrim(@branch) = '%' 
         begin
         select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l.cltcode = a.cltcode and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype "
            select @@groupby = " "
         end
      else
         begin
            select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
            select @@fromtables = " from ledger l ,vmast v, ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c  "
            select @@wherepart = @@datefilter + " and l.vtyp <> 18 and l2.cltcode >= '" + @fcode + "' and l2.cltcode <= '" + @tcode + "' And l.vtyp = v.vtype and a.cltcode = l2.cltcode and a.accat = '4' and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
            select @@groupby = " "
            select @@sortby = " order by l2.cltcode, voudt, l.vtyp desc, l.vno"
         end
   end
   else
   if upper(@statusid) = 'SUBBROKER'
   begin
      select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast, msajag.dbo.client1 c1, msajag.dbo.client2 c2 "
      select @@wherepart = @@datefilter + " and l.vtyp <> 18 and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.cltcode = c2.party_code and c2.cl_code = c1.cl_code and upper(Sub_Broker) = upper(@statusname) and l.vtyp = vtype "
      select @@groupby = " "
   end
   else
   begin
      select @@selectqury = "select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc, dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno),''), l.Narration, l.cltcode, a.longname, vtyp, l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt, l.Acname, ediff=datediff(d,l.edt,getdate()) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode = a.cltcode , vmast "
      select @@wherepart = @@datefilter + " and l.vtyp <> 18 and accat = '4' and l.cltcode >= '" + @fcode + "' And L.CLTCODE <= '" + @tcode + "' and l.vtyp = vtype "
      select @@groupby = " "
   end
   end
end

if @Reportname = 'MarginLedger'
begin
   if @selectionby = 'vdt'
      begin
         select @@sortby = " order by l.cltcode, voudt, l.vtyp desc, l.vno"
      end
   else
      begin
         select @@sortby = " order by l.cltcode, effdt, l.vtyp desc, l.vno"
      end
   if rtrim(@branch) = '' or rtrim(@branch) = '%' 
      begin
         select @@selectqury = "select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, drMargin = (case when upper(m.drcr) = 'D' then amount else 0 end ), crMargin = (case when upper(m.drcr) = 'C' then amount else 0 end ), m.vno,ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''), l.Narration, m.party_code, a.longname, m.vtyp, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt "


         select @@fromtables = " from marginledger m left outer join ledger l on m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno left outer join acmast a on m.party_code = a.cltcode , vmast v "
         select @@wherepart = @@datefilter + " and m.party_code >= '" + @fcode + "' and m.party_code <= '" + @tcode + "' and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype "
         select @@groupby = " "
         select @@sortby = " order by m.party_code, voudt, m.vtyp desc, m.vno"
      end
   else
      begin
         select @@selectqury = "select m.booktype, voudt=m.vdt, effdt=l.edt, l.Acname, isnull(shortdesc,'') shortdesc, drMargin = (case when upper(m.drcr) = 'D' then amount else 0 end ), crMargin = (case when upper(m.drcr) = 'C' then amount else 0 end ), m.vno, ddno= isnull((select max(ddno) from ledger1 l1 where l1.vno=m.vno and l1.vtyp=m.vtyp and l1.booktype=m.booktype and l1.lno = m.lno),''), l.Narration, m.party_code, a.longname, m.vtyp, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt "

         select @@fromtables = " from ledger l, costmast c, marginledger m left outer join ledger2 l2 on m.vtyp = l2.vtype and m.booktype = l2.booktype and m.vno = l2.vno and m.lno = l2.lno left outer join acmast a on m.party_code = a.cltcode , vmast  v "

         select @@wherepart = @@datefilter + " and m.party_code >= '" + @fcode + "' and m.party_code <= '" + @tcode + "' and m.vtyp <> 18 and accat = '4' and m.vtyp = v.vtype and m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno and costname = rtrim('" + @branch + "') and l2.costcode = c.costcode "
         select @@groupby = " "
         select @@sortby = " order by m.party_code, voudt, l.vtyp desc, l.vno"
      end
end

Print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby 


exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_valansum
-- --------------------------------------------------
CREATE Proc Acc_valansum  
@Branchcd As Varchar(10),   
@Opendate As Varchar(11),   
@Closdate As Varchar(11),   
@Vtyp As Varchar(2),   
@Booktype Varchar(2),   
@Vno  Varchar(12),   
@Reportoption Char(1),   
@Baloption Char(1),   
@Sortby Varchar(10)  
As  
  
Declare   
@@Opbaldt As Varchar(11),   
@@Wherepart As Varchar(200),   
@@Frompart  As Varchar(300),   
@@Selectpart As Varchar(1000),   
@@Clbalpart  As Varchar(1000),   
@@Addwhere   As Varchar(100),   
@@Orderbypart As Varchar(100)  
  
Select @@Opbaldt = (Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Ledger L   
                    Where Vtyp = 18 And Vdt <= @Opendate)  
  
If @Reportoption = 'P'  
   Begin  
      Select @@Addwhere = " And A.Accat In ('4', '104')"  
   End  
Else If @Reportoption = 'O'  
   Begin  
      Select @@Addwhere = " And A.Accat Not In ('4', '104')"  
   End  
Else  
   Begin  
      Select @@Addwhere = " "  
   End  
  
If Rtrim(@Branchcd) = '%'   
   Begin  
 Select @@Selectpart = "Select L.Cltcode, A.Acname, Dramt = Isnull((Case When Upper(Drcr) = 'D' Then Vamt Else 0 End ), 0), Cramt = Isnull((Case When Upper(Drcr) = 'C' Then Vamt Else 0 End ), 0), Left(Convert(Varchar, Vdt, 103), 10) Vdt, "  
 Select @@Clbalpart = " Clbal = 0"  
 Select @@Frompart = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode "  
 Select @@Wherepart = " Where L.Vtyp = " + @Vtyp + " And L.Booktype = '" + @Booktype + "' And L.Vno = '" + @Vno + "'"  
        If Upper(Rtrim(@Sortby)) = 'Accode'  
       Select @@Orderbypart = " Order By L.Cltcode "  
        Else If Upper(Rtrim(@Sortby)) = 'Acname'  
        Select @@Orderbypart = " Order By A.Acname "  
             Else If Upper(Rtrim(@Sortby)) = 'Drcr'  
        Select @@Orderbypart = " Order By L.Drcr "  
   End  
Else  
   Begin  
 Select @@Selectpart = " Select L2.Cltcode, A.Acname, Dramt = Isnull((Case When Upper(Drcr) = 'D' Then Camt Else 0 End ), 0), Cramt = Isnull((Case When Upper(Drcr) = 'C' Then Camt Else 0 End ), 0), "  
 Select @@Clbalpart = " Clbal =  0"  
 Select @@Frompart = " From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C "  
 Select @@Wherepart = " Where L2.Vtype = " + @Vtyp + " And L2.Booktype = '" + @Booktype + "' And L2.Vno = '" + @Vno + "'"  
 Select @@Addwhere = @@Addwhere + " And L2.Costcode = C.Costcode And C.Costname = '" + Rtrim(@Branchcd) + "' "  
        If Upper(Rtrim(@Sortby)) = 'Accode'  
       Select @@Orderbypart = " Order By L2.Cltcode "  
        Else If Upper(Rtrim(@Sortby)) = 'Acname'  
        Select @@Orderbypart = " Order By A.Acname "  
             Else If Upper(Rtrim(@Sortby)) = 'Drcr'  
        Select @@Orderbypart = " Order By L2.Drcr "  
   End  
  
Print @@Selectpart + @@Clbalpart + @@Frompart + @@Wherepart + @@Addwhere + @@Orderbypart  
  
Exec (@@Selectpart + @@Clbalpart + @@Frompart + @@Wherepart + @@Addwhere + @@Orderbypart )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_valansumpartytotal
-- --------------------------------------------------
Create Proc Acc_valansumpartytotal  
@Branchcd As Varchar(10),   
@Opendate As Varchar(11),   
@Closdate As Varchar(11),   
@Vtyp Smallint,   
@Booktype Varchar(2),   
@Vno  Varchar(12),   
@Reportoption Char(1),   
@Baloption Char(1),   
@Sortby Varchar(10)  
As  
If Rtrim(@Branchcd) = '%'   
   Begin  
 Select Dramt = Isnull(Sum((Case When Upper(Drcr) = 'D' Then Vamt Else 0 End )), 0),   
 Cramt = Isnull(Sum((Case When Upper(Drcr) = 'C' Then Vamt Else 0 End )), 0)   
 From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode   
 Where ( A.Accat = '4'  Or A.Accat = '104' )  
 And L.Vtyp = @Vtyp And L.Booktype = @Booktype And L.Vno = @Vno   
   End  
Else  
   Begin  
 Select Dramt = Isnull(Sum((Case When Upper(Drcr) = 'D' Then Camt Else 0 End )), 0),   
 Cramt = Isnull(Sum((Case When Upper(Drcr) = 'C' Then Camt Else 0 End )), 0)   
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C   
 Where A.Accat = '4'   
 And L2.Vtype = @Vtyp And L2.Booktype = @Booktype And L2.Vno = @Vno   
 And L2.Costcode = C.Costcode And C.Costname = Rtrim(@Branchcd)  
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Insert
-- --------------------------------------------------

CREATE Proc Add_Client_Account_Proc_Insert (
@Exchange Varchar(3), 
@Segment Varchar(7), 
@Branch_Cd Varchar(10), 
@FromParty Varchar(10),
@ToParty Varchar(10),
@MainDate Varchar(30),
@DetDate Varchar(30)
) As

Update Owner Set Companyname = companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update
-- --------------------------------------------------
 CREATE Proc [dbo].[Add_Client_Account_Proc_Update] (      
@Exchange Varchar(3),       
@Segment Varchar(7),       
@Branch_Cd Varchar(10),       
@FromParty Varchar(10),      
@ToParty Varchar(10),      
@MainDate Varchar(30),      
@DetDate Varchar(30)      
) As      
      
Delete From AcMast      
Where CltCode In ( Select Party_Code       
                   From NSESLBS.DBO.Client_Details_Tmp C, NSESLBS.DBO.Client_Brok_Details_Tmp D      
                   Where D.Exchange = @Exchange And D.Segment = @Segment        
     And C.Cl_Code = D.Cl_Code)      
      
Insert into AcMast      
Select ACName = Long_Name, LongName = Long_Name, ACTyp = 'ASSET',       
ACCat = '4', FamilyCd = '', CltCode = Party_Code, AccDtls = '', GrpCode = 'A0307000000',       
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,       
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No      
From NSESLBS.DBO.Client_Details_Tmp C, NSESLBS.DBO.Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code  
  
Insert into MultiBankId  
SELECT Party_code,max(P.BankID)as BankID,CltDpId=AC_Num,        
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'         
                        When Ac_Type = 'C' Then 'CURRENT'         
                        Else 'OTHER' End), 'OTHER'),  
Long_Name, DEF=1  
From NSESLBS.DBO.Client_Details_Tmp C, NSESLBS.DBO.Client_Brok_Details_Tmp D, NSESLBS.DBO.POBank P        
Where D.Exchange = @Exchange And D.Segment = @Segment          
And C.Cl_Code = D.Cl_Code        
And Ac_Type <> ''        
And C.Party_Code Not In (Select CltCode From MultiBankId )  
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name
GROUP BY Party_code,AC_NUM,AC_TYPE,Long_Name--added by suresh to add singel record

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_MULTISERVER_MULTIBANK
-- --------------------------------------------------








CREATE         PROCEDURE [dbo].[ADD_MULTISERVER_MULTIBANK]
(
      @cltcode varchar(20),
      @ACCONT_NO varchar(10),
      @ACCONT_TYPE varchar(10),
      @CHEQE_NAME varchar(10),
      @DEFAULT char(10)
)
AS

DECLARE
		@MultiBankCur Cursor,
		--@Exch_nage   varchar(50),
               -- @Segmen_t   varchar(50),
                @Account_db   varchar(50),
                @Account_server  varchar(50),
               -- @share_db   varchar(50),
		--@share_server varchar(50),
		--@SQL Varchar(2000),
               -- @SQLFIRST Varchar(2000),
                @SQLSECOND Varchar(2000)
		--@share_db,@share_server,SHAREDB,SHARESERVER,

Set @MultiBankCur = Cursor for  Select  ACCOUNTDB,ACCOUNTSERVER,DEFAULTDB From Pradnya.dbo.multicompany where primaryserver = 1
Open @MultiBankCur
Fetch Next From @MultiBankCur into @Account_db,@Account_server--,@Exch_nage,@Segmen_t   
While @@Fetch_Status = 0       
	BEGIN
		
		--SELECT @AR_COUNT =  SELECT COUNT(1) FROM "" + @Account_server + "." + @Account_db + ".DBO.ACMAST WHERE Cltcode = '" + @Cltcode + "'
		--IF @AR_COUNT = 0
			--BEGIN
				--SET @SQL = "INSERT INTO " + @Account_server + "." + @Account_db +  "DBO.ACMAST "
				--SET @SQL = @SQL + "(Cltcode) "
				--SET @SQL = @SQL + "VALUES ( '" + @cltcode + "')"
				--PRINT @SQL
				--EXEC(@SQL)
				--IF @@ERROR <> 0
				--BEGIN
					--	RETURN
				---	END
			--END
                     --  BEGIN
				--SET @SQLFIRST  = "INSERT INTO " + @share_server + "." + @share_db +  "dbo.pobank "
				--SET @SQLFIRST = @SQLFIRST  + "(Bank_Name,Branch_Name) "
				--SET @SQLFIRST  = @SQLFIRST + "VALUES ( '" + @BANK  + "','" +@BRANCH_NAME  + "')"
				--PRINT @SQL
				--EXEC( @SQLFIRST)
				--IF @@ERROR <> 0
					--BEGIN
					--	RETURN
					--END
			--END
                       BEGIN
				SET @SQLSECOND = "INSERT INTO " + @Account_server + "." + @Account_db +  "DBO.multibankid "
				SET @SQLSECOND= @SQLSECOND + "(Cltcode, AccNo, AccType, ChequeName, DefaultBank) "
				SET @SQLSECOND =@SQLSECOND + "VALUES ( '" + @cltcode+ "','" + @ACCONT_NO+ "','" +  @ACCONT_TYPE+ "','" + @CHEQE_NAME+ "','" + @DEFAULT+ "')"
				--PRINT @SQL
				EXEC(@SQLSECOND)
				IF @@ERROR <> 0
					BEGIN
						RETURN
					END
			END

                        
		
		Fetch Next From @MultiBankCur into @Account_db,@Account_server--,@Exch_nage,@Segmen_t   
	END     
Close @MultiBankCur  
DeAllocate @MultiBankCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_MULTISERVER_MULTIBANK1
-- --------------------------------------------------







create       PROCEDURE [dbo].[ADD_MULTISERVER_MULTIBANK1]
(
      @cltcode varchar(20),
   
      @ACCONT_NO varchar(10),
      @ACCONT_TYPE varchar(10),
      @CHEQE_NAME varchar(10),
      @DEFAULT char(10)
)
AS
/*
	BEGIN TRAN
	EXEC ADD_MULTISERVER_AREA 'TEST', 'TEST', 'MUMBAI'
	ROLLBACK
*/
DECLARE
		@MultiBankCur Cursor,
		--@Exch_nage   varchar(50),
               -- @Segmen_t   varchar(50),
                @Account_db   varchar(50),
                @Account_server  varchar(50),
                @share_db   varchar(50),
		@share_server varchar(50),
		--@SQL Varchar(2000),
               -- @SQLFIRST Varchar(2000),
                @SQLSECOND Varchar(2000)
		

Set @MultiBankCur = Cursor for  Select  SHAREDB,SHARESERVER,ACCOUNTDB,ACCOUNTSERVER,DEFAULTDB From Pradnya.dbo.multicompany where primaryserver = 1
Open @MultiBankCur
Fetch Next From @MultiBankCur into @share_db,@share_server,@Account_db,@Account_server--,@Exch_nage,@Segmen_t   
While @@Fetch_Status = 0       
	BEGIN
		
		--SELECT @AR_COUNT =  SELECT COUNT(1) FROM "" + @Account_server + "." + @Account_db + ".DBO.ACMAST WHERE Cltcode = '" + @Cltcode + "'
		--IF @AR_COUNT = 0
			--BEGIN
				--SET @SQL = "INSERT INTO " + @Account_server + "." + @Account_db +  "DBO.ACMAST "
				--SET @SQL = @SQL + "(Cltcode) "
				--SET @SQL = @SQL + "VALUES ( '" + @cltcode + "')"
				--PRINT @SQL
				--EXEC(@SQL)
				--IF @@ERROR <> 0
				--BEGIN
					--	RETURN
				---	END
			--END
                     --  BEGIN
				--SET @SQLFIRST  = "INSERT INTO " + @share_server + "." + @share_db +  "dbo.pobank "
				--SET @SQLFIRST = @SQLFIRST  + "(Bank_Name,Branch_Name) "
				--SET @SQLFIRST  = @SQLFIRST + "VALUES ( '" + @BANK  + "','" +@BRANCH_NAME  + "')"
				--PRINT @SQL
				--EXEC( @SQLFIRST)
				--IF @@ERROR <> 0
					--BEGIN
					--	RETURN
					--END
			--END
                       BEGIN
				SET @SQLSECOND = "INSERT INTO " + @Account_server + "." + @Account_db +  "DBO.multibankid "
				SET @SQLSECOND= @SQLSECOND + "(Cltcode, AccNo, AccType, ChequeName, DefaultBank) "
				SET @SQLSECOND =@SQLSECOND + "VALUES ( '" + @cltcode+ "','" + @ACCONT_NO+ "','" +  @ACCONT_TYPE+ "','" + @CHEQE_NAME+ "','" + @DEFAULT+ "')"
				--PRINT @SQL
				EXEC(@SQLSECOND)
				IF @@ERROR <> 0
					BEGIN
						RETURN
					END
			END

                        
		
		Fetch Next From @MultiBankCur into @share_db,@share_server,@Account_db,@Account_server--,@Exch_nage,@Segmen_t   
	END     
Close @MultiBankCur  
DeAllocate @MultiBankCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Ageingcursor_NEW1_SB    Script Date: 02/20/2008 12:48:23 PM ******/
--exec Ageingcursor_NEW1_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'  
CREATE  Procedure Ageingcursor_NEW1_SB
@fromparty varchar(10),      
@toparty varchar(10),       
@opendate varchar(11),      
@todate varchar(11),      
@Reporttype varchar(15),      
@family varchar(10),      
@amoutgtthan money,      
@ageoption varchar(1),      
@dttype varchar(3),  
@statusid varchar(10),  
@statusname varchar(25),  
@Days1 Int = 6,  
@Days2 Int = 29,  
@Days3 Int = 90,  
@Days4 Int = 180,  
@Days5 Int = 181,  
@FrSb Varchar(10) = '0',  
@ToSb Varchar(10) = 'ZZZZ'  
  
  
  
as  
  
declare  
@@balcur as cursor,      
@@baldate as varchar(11),      
@@openbaldt as varchar(11),      
@@balamt as money,      
@@ocltcode as varchar(10),      
@@vtyp as smallint,      
@@vno varchar(12),      
@@EVdt as DATETIME,      
@@vamt as money,      
@@closbal as money,      
@@cltcode as varchar(10),      
@@Branchcode as varchar(25),      
@@area as varchar(25),  
@@drcr    as varchar(1),      
@@startdt as datetime  
    
Print 'Strated '     
Print convert(datetime,getdate(),113)    
    
Set nocount on      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )      
      
      
if upper(@statusid) = 'BROKER'      
begin       
 select @@branchcode = '%'       
 select @@area = '%'       
end      
else if upper(@statusid) = 'BRANCH'      
begin      
 select @@branchcode = rtrim(@statusname)      
 select @@area = '%'       
end   
else if upper(@statusid) = 'AREA'      
begin      
 select @@branchcode = '%'  
 select @@area = rtrim(@statusname)  
end   
      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from Ledger where 1=2    
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from Ledger where 1=2    
  
Select Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration into #Ledger from Ledger where 1=2  
  
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from Ledger where 1=2  
      
if @dttype='vdt'  
begin  
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from Ledger where vtyp = '18' and vdt < = @opendate   
   
 if upper(@Reporttype) = 'PARTY'  
 begin  
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, msajag.dbo.client1 c1, msajag.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
/*    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
*/    
    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode       
 end  
  
 else if upper(@Reporttype) = 'FAMILY'  
 begin  
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l,  msajag.dbo.client1 c1, msajag.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
/*    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l,  nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
   closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode       
  order by cltcode  
    
 end  
  
 else if upper(@Reporttype) = 'FAMILYPARTY'  
 begin  
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, msajag.dbo.client1 c1, msajag.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
/*    
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
    
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
   closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode      
    
 end  
  
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 BEGIN      
  insert into #Ledger   
  select Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration from Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       */
 END      
  
 else      
 BEGIN      
  insert into #Ledger   
  select Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration from Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from msajag.dbo.client2 c2, msajag.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)       
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'  
  and cltcode in (select party_code from nsefo.dbo.client2 c2, nsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */
 END      
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode     
   and vdt <= @todate  + ' 23:59:59'       
   --  
   and vtyp <> '18'      
   order by l.cltcode, vdt desc, vtyp, vno  
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and vdt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'    
   order by l.cltcode, vdt desc, vtyp, vno       
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a  
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and vdt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'   
   order by l.cltcode, vdt desc, vtyp, vno       
  end  
 end  
   
 else      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, msajag.dbo.clientmaster c,  #tempageing a where a.cltcode = family      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal   
   from #Ledger l, msajag.dbo.clientmaster c, #tempageing a where  a.cltcode = family      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, msajag.dbo.clientmaster c, #tempageing a where a.cltcode = family      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
 end  
  
end  
  
else  
begin  
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from Ledger where vtyp = '18' and edt < = @opendate  
  
 if upper(@Reporttype) = 'PARTY'  
 begin  
  insert   into #tempageing1   
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, acmast a, msajag.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
/*       
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, accountbse.dbo.acmast a, bsedb.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, accountfo.dbo.acmast a, nsefo.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
    
 end  
  
 else if upper(@Reporttype) = 'FAMILY'  
 begin  
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l,  msajag.dbo.client1 c --msajag.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
/*    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c--bsedb.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l,  nsefo.dbo.client1 c--nsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
*/    
    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
    
 end  
   
 else if upper(@Reporttype) = 'FAMILYPARTY'  
 begin  
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, msajag.dbo.client1 c--msajag.dbo.clientmaster c    
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'  
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
/*    
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c--bsedb.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode           
    
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c--nsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
   
 end  
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 BEGIN      
  insert into #Ledger   
  select Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration from Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)      
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)      
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)     */
 END  
       
 else      
 BEGIN      
  insert into #Ledger   
  select Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration from Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from msajag.dbo.client2 c2, msajag.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from msajag.dbo.client2 c2, msajag.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from msajag.dbo.client2 c2, msajag.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */
 END      
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 begin      
  if upper(rtrim(@ageoption)) = 'D'  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode     
   and edt <= @todate  + ' 23:59:59'       
   --  
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledgeredt l, #tempageing a      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and edt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno    
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and edt <= @todate  + ' 23:59:59'      
   --   
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno   
  end  
 end  
   
 else      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, msajag.dbo.clientmaster c,  #tempageing a where a.cltcode = family      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal   
   from #Ledger l, msajag.dbo.clientmaster c, #tempageing a where  a.cltcode = family      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, msajag.dbo.clientmaster c, #tempageing a where a.cltcode = family      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
 end  
end  
      
      
Print 'Filled LedgerCursor'     
Print convert(datetime,getdate(),113)    
    
set @@balcur = cursor for      
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno    
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2      
      
print 'opening cursor'      
      
open @@balcur  
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal       
  
while @@fetch_status = 0     
begin       
 select @@ocltcode = @@cltcode       
  select @@balamt = abs(@@closbal)      
 if @@closbal >= 0       
 begin      
  select @@drcr = 'd'      
 end   
     else      
 begin      
       select @@drcr = 'c'      
 end  
  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0      
 begin      
  if @@balamt >= @@vamt       
  begin    
   insert into #fintempageing      
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr       
   select @@balamt = @@balamt - @@vamt     
  end      
  
  else      
  begin      
   insert into #fintempageing      
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr       
   select @@balamt = @@balamt - @@vamt       
  end      
  
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal       
 end      
  
 if @@balamt > 0      
 begin    
   insert into #fintempageing      
   select @@ocltcode, @@balamt, 181, @@drcr       
   select @@balamt = @@balamt - @@vamt      
 end      
  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  
 begin    
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal      
 end      
end  
      
close @@balcur      
deallocate @@balcur      
      
print 'cursor closed'      
Print convert(datetime,getdate(),113)    
      
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist      
from #fintempageing   
where agedays >= 0 and agedays <= @Days1  
group by cltcode, drcr      
order by cltcode, drcr      
      
insert into #ageinglist     
select cltcode, balance=sum(balamt), agedays = @Days2, drcr       
from #fintempageing      
where agedays >= @Days1+1 and agedays <= @Days2  
group by cltcode, drcr       
order by cltcode, drcr      
      
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days3, drcr       
from #fintempageing      
where agedays >= @Days2+1 and agedays <= @Days3  
group by cltcode, drcr       
order by cltcode, drcr       
  
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days4, drcr       
from #fintempageing      
where agedays >= @Days3+1 and agedays <= @Days4  
group by cltcode, drcr       
order by cltcode, drcr       
      
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days5, drcr       
from #fintempageing      
where agedays >= @Days5  
group by cltcode, drcr       
order by cltcode, drcr       
  
print 'done'      
Print convert(datetime,getdate(),113)    
      
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, b.branch, s.name  
from #ageinglist a1, msajag.dbo.client1 a2, msajag.dbo.subbrokers s, msajag.dbo.branch b--msajag.dbo.clientmaster a2--account.dbo.acmast  a2       
where balance >= @amoutgtthan and       
a1.cltcode = a2.cl_code  
and a2.branch_cd = b.branch_code  
and a2.sub_broker = s.sub_broker  
order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name  
      
drop table #tempageing      
drop table #Ledger      
drop table #LedgerCursor       
drop table #ageinglist      
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW10_SB
-- --------------------------------------------------
--exec Ageingcursor_NEW10_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'

CREATE PROCEDURE AGEINGCURSOR_NEW10_SB
                @fromparty   VARCHAR(10),
                @toparty     VARCHAR(10),
                @opendate    VARCHAR(11),
                @todate      VARCHAR(11),
                @Reporttype  VARCHAR(15),
                @family      VARCHAR(10),
                @amoutgtthan MONEY,
                @ageoption   VARCHAR(1),
                @dttype      VARCHAR(3),
                @statusid    VARCHAR(10),
                @statusname  VARCHAR(25),
                @Days1       INT  = 6,
                @Days2       INT  = 29,
                @Days3       INT  = 90,
                @Days4       INT  = 180,
                @Days5       INT  = 181,
                @FrSb        VARCHAR(10)  = '0',
                @ToSb        VARCHAR(10)  = 'ZZZZ'
                                            
AS

  DECLARE  @@balcur      AS CURSOR,
           @@baldate     AS VARCHAR(11),
           @@openbaldt   AS VARCHAR(11),
           @@balamt      AS MONEY,
           @@ocltcode    AS VARCHAR(10),
           @@vtyp        AS SMALLINT,
           @@vno         AS VARCHAR(12),
           @@EVdt        AS DATETIME,
           @@vamt        AS MONEY,
           @@closbal     AS MONEY,
           @@cltcode     AS VARCHAR(10),
           @@Branchcode  AS VARCHAR(25),
           @@area        AS VARCHAR(25),
           @@drcr        AS VARCHAR(1),
           @@startdt     AS DATETIME
                            
  PRINT 'Strated '
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SET NOCOUNT ON
  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SELECT @@startdt = (SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@todate)),
                                          109),11))
                     
  IF UPPER(@statusid) = 'BROKER'
    BEGIN
      SELECT @@branchcode = '%'
      
      SELECT @@area = '%'
    END
  ELSE
    IF UPPER(@statusid) = 'BRANCH'
      BEGIN
        SELECT @@branchcode = RTRIM(@statusname)
        
        SELECT @@area = '%'
      END
    ELSE
      IF UPPER(@statusid) = 'AREA'
        BEGIN
          SELECT @@branchcode = '%'
          
          SELECT @@area = RTRIM(@statusname)
        END
        
  SELECT CLTCODE,
         VDT         AS BALDATE,
         VAMT        CLOSBAL,
         AGEDAYS = 0
  INTO   #TEMPAGEING
  FROM   LEDGER
  WHERE  1 = 2
  
  SELECT CLTCODE,
         VDT         AS BALDATE,
         VAMT        CLOSBAL,
         AGEDAYS = 0
  INTO   #TEMPAGEING1
  FROM   LEDGER
  WHERE  1 = 2
             
  SELECT *
  INTO   #LEDGER
  FROM   LEDGER
  WHERE  1 = 2
             
  SELECT CLTCODE,
         VTYP,
         VNO,
         EDT     AS EVDT,
         VAMT,
         VAMT    CLOSBAL
  INTO   #LEDGERCURSOR
  FROM   LEDGER
  WHERE  1 = 2
             
  IF @dttype = 'vdt'
    BEGIN
      SELECT @@openbaldt = LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11)
      FROM   LEDGER
      WHERE  VTYP = '18'
             AND VDT < = @opendate
                         
      IF UPPER(@Reporttype) = 'PARTY'
        BEGIN
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     LEDGER L,
                   MSAJAG.DBO.CLIENT1 C1,
                   MSAJAG.DBO.CLIENT2 C2
          WHERE    L.CLTCODE = C2.PARTY_CODE
                   AND C1.CL_CODE = C2.CL_CODE
                   AND VDT >= @@openbaldt + ' 00:00:00'
                   AND VDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND C1.BRANCH_CD LIKE @@branchcode + '%'
                   AND AREA LIKE @@area + '%'
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
                   
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     ACCOUNTBSE.DBO.LEDGER L,
                   BSEDB.DBO.CLIENT1 C1,
                   BSEDB.DBO.CLIENT2 C2
          WHERE    L.CLTCODE = C2.PARTY_CODE
                   AND C1.CL_CODE = C2.CL_CODE
                   AND VDT >= @@openbaldt + ' 00:00:00'
                   AND VDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND C1.BRANCH_CD LIKE @@branchcode + '%'
                   AND AREA LIKE @@area + '%'
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
                   
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     ACCOUNTFO.DBO.LEDGER L,
                   NSEFO.DBO.CLIENT1 C1,
                   NSEFO.DBO.CLIENT2 C2
          WHERE    L.CLTCODE = C2.PARTY_CODE
                   AND C1.CL_CODE = C2.CL_CODE
                   AND VDT >= @@openbaldt + ' 00:00:00'
                   AND VDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND C1.BRANCH_CD LIKE @@branchcode + '%'
                   AND AREA LIKE @@area + '%'
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
                   
          INSERT INTO #TEMPAGEING
          SELECT   CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CLOSBAL),
                   AGEDAYS = 0
          FROM     #TEMPAGEING1
          GROUP BY CLTCODE
          ORDER BY CLTCODE
        END
        
      ELSE
        IF UPPER(@Reporttype) = 'FAMILY'
          BEGIN
            INSERT INTO #TEMPAGEING1
            SELECT   FAMILY                                                        AS CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CASE 
                                     WHEN DRCR = 'd' THEN VAMT
                                     ELSE -VAMT
                                   END),
                     AGEDAYS = 0
            FROM     LEDGER L,
                     MSAJAG.DBO.CLIENT1 C1,
                     MSAJAG.DBO.CLIENT2 C2
            WHERE    C1.CL_CODE = C2.CL_CODE
                     AND VDT >= @@openbaldt + ' 00:00:00'
                     AND VDT <= @todate + ' 23:59:59'
                     AND L.CLTCODE = C2.PARTY_CODE
                     AND C1.FAMILY >= @fromparty
                     AND C1.FAMILY <= @toparty
                     AND C1.BRANCH_CD LIKE @@branchcode + '%'
                     AND AREA LIKE @@area + '%'
                     AND C1.SUB_BROKER >= @FrSb
                     AND C1.SUB_BROKER <= @ToSb
            GROUP BY FAMILY
            ORDER BY FAMILY
                     
            INSERT INTO #TEMPAGEING1
            SELECT   FAMILY                                                        AS CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CASE 
                                     WHEN DRCR = 'd' THEN VAMT
                                     ELSE -VAMT
                                   END),
                     AGEDAYS = 0
            FROM     ACCOUNTBSE.DBO.LEDGER L,
                     BSEDB.DBO.CLIENT1 C1,
                     BSEDB.DBO.CLIENT2 C2
            WHERE    C1.CL_CODE = C2.CL_CODE
                     AND VDT >= @@openbaldt + ' 00:00:00'
                     AND VDT <= @todate + ' 23:59:59'
                     AND L.CLTCODE = C2.PARTY_CODE
                     AND C1.FAMILY >= @fromparty
                     AND C1.FAMILY <= @toparty
                     AND C1.BRANCH_CD LIKE @@branchcode + '%'
                     AND AREA LIKE @@area + '%'
                     AND C1.SUB_BROKER >= @FrSb
                     AND C1.SUB_BROKER <= @ToSb
            GROUP BY FAMILY
            ORDER BY FAMILY
                     
            INSERT INTO #TEMPAGEING1
            SELECT   FAMILY                                                        AS CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CASE 
                                     WHEN DRCR = 'd' THEN VAMT
                                     ELSE -VAMT
                                   END),
                     AGEDAYS = 0
            FROM     ACCOUNTFO.DBO.LEDGER L,
                     NSEFO.DBO.CLIENT1 C1,
                     NSEFO.DBO.CLIENT2 C2
            WHERE    C1.CL_CODE = C2.CL_CODE
                     AND VDT >= @@openbaldt + ' 00:00:00'
                     AND VDT <= @todate + ' 23:59:59'
                     AND L.CLTCODE = C2.PARTY_CODE
                     AND C1.FAMILY >= @fromparty
                     AND C1.FAMILY <= @toparty
                     AND C1.BRANCH_CD LIKE @@branchcode + '%'
                     AND AREA LIKE @@area + '%'
                     AND C1.SUB_BROKER >= @FrSb
                     AND C1.SUB_BROKER <= @ToSb
            GROUP BY FAMILY
            ORDER BY FAMILY
                     
            INSERT INTO #TEMPAGEING
            SELECT   CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CLOSBAL),
                     AGEDAYS = 0
            FROM     #TEMPAGEING1
            GROUP BY CLTCODE
            ORDER BY CLTCODE
                     
          END
          
        ELSE
          IF UPPER(@Reporttype) = 'FAMILYPARTY'
            BEGIN
              INSERT INTO #TEMPAGEING1
              SELECT   L.CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CASE 
                                       WHEN DRCR = 'd' THEN VAMT
                                       ELSE -VAMT
                                     END),
                       AGEDAYS = 0
              FROM     LEDGER L,
                       MSAJAG.DBO.CLIENT1 C1,
                       MSAJAG.DBO.CLIENT2 C2
              WHERE    C1.CL_CODE = C2.CL_CODE
                       AND VDT >= @@openbaldt + ' 00:00:00'
                       AND VDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE >= @fromparty
                       AND L.CLTCODE <= @toparty
                       AND C1.BRANCH_CD LIKE @@branchcode + '%'
                       AND AREA LIKE @@area + '%'
                       AND L.CLTCODE = C2.PARTY_CODE
                       AND C1.FAMILY = @family
                       AND C1.SUB_BROKER >= @FrSb
                       AND C1.SUB_BROKER <= @ToSb
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
                       
              INSERT INTO #TEMPAGEING1
              SELECT   L.CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CASE 
                                       WHEN DRCR = 'd' THEN VAMT
                                       ELSE -VAMT
                                     END),
                       AGEDAYS = 0
              FROM     ACCOUNTBSE.DBO.LEDGER L,
                       BSEDB.DBO.CLIENT1 C1,
                       BSEDB.DBO.CLIENT2 C2
              WHERE    C1.CL_CODE = C2.CL_CODE
                       AND VDT >= @@openbaldt + ' 00:00:00'
                       AND VDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE >= @fromparty
                       AND L.CLTCODE <= @toparty
                       AND C1.BRANCH_CD LIKE @@branchcode + '%'
                       AND AREA LIKE @@area + '%'
                       AND L.CLTCODE = C2.PARTY_CODE
                       AND C1.FAMILY = @family
                       AND C1.SUB_BROKER >= @FrSb
                       AND C1.SUB_BROKER <= @ToSb
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
                       
              INSERT INTO #TEMPAGEING1
              SELECT   L.CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CASE 
                                       WHEN DRCR = 'd' THEN VAMT
                                       ELSE -VAMT
                                     END),
                       AGEDAYS = 0
              FROM     ACCOUNTFO.DBO.LEDGER L,
                       NSEFO.DBO.CLIENT1 C1,
                       NSEFO.DBO.CLIENT2 C2
              WHERE    C1.CL_CODE = C2.CL_CODE
                       AND VDT >= @@openbaldt + ' 00:00:00'
                       AND VDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE >= @fromparty
                       AND L.CLTCODE <= @toparty
                       AND C1.BRANCH_CD LIKE @@branchcode + '%'
                       AND AREA LIKE @@area + '%'
                       AND L.CLTCODE = C2.PARTY_CODE
                       AND C1.FAMILY = @family
                       AND C1.SUB_BROKER >= @FrSb
                       AND C1.SUB_BROKER <= @ToSb
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
                       
              INSERT INTO #TEMPAGEING
              SELECT   CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CLOSBAL),
                       AGEDAYS = 0
              FROM     #TEMPAGEING1
              GROUP BY CLTCODE
              ORDER BY CLTCODE
                       
            END
            
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTBSE.DBO.LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTFO.DBO.LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
        END
        
      ELSE
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT PARTY_CODE
                                 FROM   MSAJAG.DBO.CLIENT2 C2,
                                        MSAJAG.DBO.CLIENT1 C1
                                 WHERE  C1.CL_CODE = C2.CL_CODE
                                        AND FAMILY >= @fromparty
                                        AND FAMILY <= @toparty
                                        AND C1.SUB_BROKER >= @FrSb
                                        AND C1.SUB_BROKER <= @ToSb)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTBSE.DBO.LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT PARTY_CODE
                                 FROM   BSEDB.DBO.CLIENT2 C2,
                                        BSEDB.DBO.CLIENT1 C1
                                 WHERE  C1.CL_CODE = C2.CL_CODE
                                        AND FAMILY >= @fromparty
                                        AND FAMILY <= @toparty
                                        AND C1.SUB_BROKER >= @FrSb
                                        AND C1.SUB_BROKER <= @ToSb)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTFO.DBO.LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT PARTY_CODE
                                 FROM   NSEFO.DBO.CLIENT2 C2,
                                        NSEFO.DBO.CLIENT1 C1
                                 WHERE  C1.CL_CODE = C2.CL_CODE
                                        AND FAMILY >= @fromparty
                                        AND FAMILY <= @toparty
                                        AND C1.SUB_BROKER >= @FrSb
                                        AND C1.SUB_BROKER <= @ToSb)
        END
        
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   L.CLTCODE,
                       VTYP,
                       VNO,
                       VDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       #TEMPAGEING A
              WHERE    CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND L.CLTCODE = A.CLTCODE
                       AND VDT <= @todate + ' 23:59:59'
                       --
                       AND VTYP <> '18'
              ORDER BY L.CLTCODE,
                       VDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND L.CLTCODE = A.CLTCODE
                         AND VDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    DRCR = (CASE 
                                   WHEN CLOSBAL >= 0 THEN 'd'
                                   ELSE 'c'
                                 END)
                         AND L.CLTCODE = A.CLTCODE
                         AND VDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
        END
        
      ELSE
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   CLTCODE = FAMILY,
                       VTYP,
                       VNO,
                       VDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       MSAJAG.DBO.CLIENTMASTER C,
                       #TEMPAGEING A
              WHERE    A.CLTCODE = FAMILY
                       AND CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND VDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE = C.PARTY_CODE
                       AND FAMILY >= @fromparty
                       AND FAMILY <= @toparty
                       --
                       AND VTYP <> '18'
              ORDER BY CLTCODE,
                       VDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   CLTCODE = FAMILY,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         MSAJAG.DBO.CLIENTMASTER C,
                         #TEMPAGEING A
                WHERE    A.CLTCODE = FAMILY
                         AND CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND VDT <= @todate + ' 23:59:59'
                         AND L.CLTCODE = C.PARTY_CODE
                         AND FAMILY >= @fromparty
                         AND FAMILY <= @toparty
                         --
                         AND VTYP <> '18'
                ORDER BY CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   CLTCODE = FAMILY,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         MSAJAG.DBO.CLIENTMASTER C,
                         #TEMPAGEING A
                WHERE    A.CLTCODE = FAMILY
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND VDT <= @todate + ' 23:59:59'
                         AND L.CLTCODE = C.PARTY_CODE
                         AND FAMILY >= @fromparty
                         AND FAMILY <= @toparty
                         --
                         AND VTYP <> '18'
                ORDER BY CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
        END
        
    END
    
  ELSE
    BEGIN
      SELECT @@openbaldt = LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDT),0),109),11)
      FROM   LEDGER
      WHERE  VTYP = '18'
             AND EDT < = @opendate
                         
      IF UPPER(@Reporttype) = 'PARTY'
        BEGIN
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     LEDGER L,
                   ACMAST A,
                   MSAJAG.DBO.CLIENT1 C1
          WHERE    L.CLTCODE = A.CLTCODE
                   AND L.CLTCODE = C1.CL_CODE
                   AND EDT >= @@openbaldt + ' 00:00:00'
                   AND EDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND A.BRANCHCODE LIKE @@branchcode + '%'
                   AND A.ACCAT = 4
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
                   
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     ACCOUNTBSE.DBO.LEDGER L,
                   ACCOUNTBSE.DBO.ACMAST A,
                   BSEDB.DBO.CLIENT1 C1
          WHERE    L.CLTCODE = A.CLTCODE
                   AND L.CLTCODE = C1.CL_CODE
                   AND EDT >= @@openbaldt + ' 00:00:00'
                   AND EDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND A.BRANCHCODE LIKE @@branchcode + '%'
                   AND A.ACCAT = 4
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
                   
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     ACCOUNTFO.DBO.LEDGER L,
                   ACCOUNTFO.DBO.ACMAST A,
                   NSEFO.DBO.CLIENT1 C1
          WHERE    L.CLTCODE = A.CLTCODE
                   AND L.CLTCODE = C1.CL_CODE
                   AND EDT >= @@openbaldt + ' 00:00:00'
                   AND EDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND A.BRANCHCODE LIKE @@branchcode + '%'
                   AND A.ACCAT = 4
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
                   
          INSERT INTO #TEMPAGEING
          SELECT   CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CLOSBAL),
                   AGEDAYS = 0
          FROM     #TEMPAGEING1
          GROUP BY CLTCODE
          ORDER BY CLTCODE
                   
        END
        
      ELSE
        IF UPPER(@Reporttype) = 'FAMILY'
          BEGIN
            INSERT INTO #TEMPAGEING1
            SELECT   FAMILY                                                        AS CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CASE 
                                     WHEN DRCR = 'd' THEN VAMT
                                     ELSE -VAMT
                                   END),
                     AGEDAYS = 0
            FROM     LEDGER L,
                     MSAJAG.DBO.CLIENT1 C --msajag.dbo.clientmaster c            
            WHERE    EDT >= @@openbaldt + ' 00:00:00'
                     AND EDT <= @todate + ' 23:59:59'
                     AND L.CLTCODE = C.CL_CODE
                     AND C.FAMILY >= @fromparty
                     AND C.FAMILY <= @toparty
                     AND C.BRANCH_CD LIKE @@branchcode + '%'
                     AND C.SUB_BROKER >= @FrSb
                     AND C.SUB_BROKER <= @ToSb
            GROUP BY FAMILY
            ORDER BY FAMILY
                     
            INSERT INTO #TEMPAGEING1
            SELECT   FAMILY                                                        AS CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CASE 
                                     WHEN DRCR = 'd' THEN VAMT
                                     ELSE -VAMT
                                   END),
                     AGEDAYS = 0
            FROM     ACCOUNTBSE.DBO.LEDGER L,
                     BSEDB.DBO.CLIENT1 C--bsedb.dbo.clientmaster c            
            WHERE    EDT >= @@openbaldt + ' 00:00:00'
                     AND EDT <= @todate + ' 23:59:59'
                     AND L.CLTCODE = C.CL_CODE
                     AND C.FAMILY >= @fromparty
                     AND C.FAMILY <= @toparty
                     AND C.BRANCH_CD LIKE @@branchcode + '%'
                     AND C.SUB_BROKER >= @FrSb
                     AND C.SUB_BROKER <= @ToSb
            GROUP BY FAMILY
            ORDER BY FAMILY
                     
            INSERT INTO #TEMPAGEING1
            SELECT   FAMILY                                                        AS CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CASE 
                                     WHEN DRCR = 'd' THEN VAMT
                                     ELSE -VAMT
                                   END),
                     AGEDAYS = 0
            FROM     ACCOUNTFO.DBO.LEDGER L,
                     NSEFO.DBO.CLIENT1 C--nsefo.dbo.clientmaster c            
            WHERE    EDT >= @@openbaldt + ' 00:00:00'
                     AND EDT <= @todate + ' 23:59:59'
                     AND L.CLTCODE = C.CL_CODE
                     AND C.FAMILY >= @fromparty
                     AND C.FAMILY <= @toparty
                     AND C.BRANCH_CD LIKE @@branchcode + '%'
                     AND C.SUB_BROKER >= @FrSb
                     AND C.SUB_BROKER <= @ToSb
            GROUP BY FAMILY
            ORDER BY FAMILY
                     
            INSERT INTO #TEMPAGEING
            SELECT   CLTCODE,
                     BALDATE = @todate,
                     CLOSBAL = SUM(CLOSBAL),
                     AGEDAYS = 0
            FROM     #TEMPAGEING1
            GROUP BY CLTCODE
            ORDER BY CLTCODE
                     
          END
          
        ELSE
          IF UPPER(@Reporttype) = 'FAMILYPARTY'
            BEGIN
              INSERT INTO #TEMPAGEING1
              SELECT   L.CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CASE 
                                       WHEN DRCR = 'd' THEN VAMT
                                       ELSE -VAMT
                                     END),
                       AGEDAYS = 0
              FROM     LEDGER L,
                       MSAJAG.DBO.CLIENT1 C--msajag.dbo.clientmaster c          
              WHERE    EDT >= @@openbaldt + ' 00:00:00'
                       AND EDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE >= @fromparty
                       AND L.CLTCODE <= @toparty
                       AND C.BRANCH_CD LIKE @@branchcode + '%'
                       AND L.CLTCODE = C.CL_CODE
                       AND C.FAMILY = @family
                       AND C.SUB_BROKER >= @FrSb
                       AND C.SUB_BROKER <= @ToSb
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
                       
              INSERT INTO #TEMPAGEING1
              SELECT   L.CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CASE 
                                       WHEN DRCR = 'd' THEN VAMT
                                       ELSE -VAMT
                                     END),
                       AGEDAYS = 0
              FROM     ACCOUNTBSE.DBO.LEDGER L,
                       BSEDB.DBO.CLIENT1 C--bsedb.dbo.clientmaster c            
              WHERE    EDT >= @@openbaldt + ' 00:00:00'
                       AND EDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE >= @fromparty
                       AND L.CLTCODE <= @toparty
                       AND C.BRANCH_CD LIKE @@branchcode + '%'
                       AND L.CLTCODE = C.CL_CODE
                       AND C.FAMILY = @family
                       AND C.SUB_BROKER >= @FrSb
                       AND C.SUB_BROKER <= @ToSb
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
                       
              INSERT INTO #TEMPAGEING1
              SELECT   L.CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CASE 
                                       WHEN DRCR = 'd' THEN VAMT
                                       ELSE -VAMT
                                     END),
                       AGEDAYS = 0
              FROM     ACCOUNTFO.DBO.LEDGER L,
                       NSEFO.DBO.CLIENT1 C--nsefo.dbo.clientmaster c            
              WHERE    EDT >= @@openbaldt + ' 00:00:00'
                       AND EDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE >= @fromparty
                       AND L.CLTCODE <= @toparty
                       AND C.BRANCH_CD LIKE @@branchcode + '%'
                       AND L.CLTCODE = C.CL_CODE
                       AND C.FAMILY = @family
                       AND C.SUB_BROKER >= @FrSb
                       AND C.SUB_BROKER <= @ToSb
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
                       
              INSERT INTO #TEMPAGEING
              SELECT   CLTCODE,
                       BALDATE = @todate,
                       CLOSBAL = SUM(CLOSBAL),
                       AGEDAYS = 0
              FROM     #TEMPAGEING1
              GROUP BY CLTCODE
              ORDER BY CLTCODE
                       
            END
            
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTBSE.DBO.LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTFO.DBO.LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
        END
        
      ELSE
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT PARTY_CODE
                                 FROM   MSAJAG.DBO.CLIENT2 C2,
                                        MSAJAG.DBO.CLIENT1 C1
                                 WHERE  C1.CL_CODE = C2.CL_CODE
                                        AND FAMILY >= @fromparty
                                        AND FAMILY <= @toparty
                                        AND C1.SUB_BROKER >= @FrSb
                                        AND C1.SUB_BROKER <= @ToSb)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTBSE.DBO.LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT PARTY_CODE
                                 FROM   MSAJAG.DBO.CLIENT2 C2,
                                        MSAJAG.DBO.CLIENT1 C1
                                 WHERE  C1.CL_CODE = C2.CL_CODE
                                        AND FAMILY >= @fromparty
                                        AND FAMILY <= @toparty
                                        AND C1.SUB_BROKER >= @FrSb
                                        AND C1.SUB_BROKER <= @ToSb)
                                
          INSERT INTO #LEDGER
          SELECT *
          FROM   ACCOUNTFO.DBO.LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT PARTY_CODE
                                 FROM   MSAJAG.DBO.CLIENT2 C2,
                                        MSAJAG.DBO.CLIENT1 C1
                                 WHERE  C1.CL_CODE = C2.CL_CODE
                                        AND FAMILY >= @fromparty
                                        AND FAMILY <= @toparty
                                        AND C1.SUB_BROKER >= @FrSb
                                        AND C1.SUB_BROKER <= @ToSb)
        END
        
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   L.CLTCODE,
                       VTYP,
                       VNO,
                       EDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       #TEMPAGEING A
              WHERE    CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND L.CLTCODE = A.CLTCODE
                       AND EDT <= @todate + ' 23:59:59'
                       --
                       AND VTYP <> '18'
              ORDER BY L.CLTCODE,
                       EDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGEREDT L,
                         #TEMPAGEING A
                WHERE    CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND L.CLTCODE = A.CLTCODE
                         AND EDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    DRCR = (CASE 
                                   WHEN CLOSBAL >= 0 THEN 'd'
                                   ELSE 'c'
                                 END)
                         AND L.CLTCODE = A.CLTCODE
                         AND EDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
        END
        
      ELSE
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   CLTCODE = FAMILY,
                       VTYP,
                       VNO,
                       EDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       MSAJAG.DBO.CLIENTMASTER C,
                       #TEMPAGEING A
              WHERE    A.CLTCODE = FAMILY
                       AND CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND EDT <= @todate + ' 23:59:59'
                       AND L.CLTCODE = C.PARTY_CODE
                       AND FAMILY >= @fromparty
                       AND FAMILY <= @toparty
                       --
                       AND VTYP <> '18'
              ORDER BY CLTCODE,
                       EDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   CLTCODE = FAMILY,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         MSAJAG.DBO.CLIENTMASTER C,
                         #TEMPAGEING A
                WHERE    A.CLTCODE = FAMILY
                         AND CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND EDT <= @todate + ' 23:59:59'
                         AND L.CLTCODE = C.PARTY_CODE
                         AND FAMILY >= @fromparty
                         AND FAMILY <= @toparty
                         --
                         AND VTYP <> '18'
                ORDER BY CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   CLTCODE = FAMILY,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         MSAJAG.DBO.CLIENTMASTER C,
                         #TEMPAGEING A
                WHERE    A.CLTCODE = FAMILY
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND EDT <= @todate + ' 23:59:59'
                         AND L.CLTCODE = C.PARTY_CODE
                         AND FAMILY >= @fromparty
                         AND FAMILY <= @toparty
                         --
                         AND VTYP <> '18'
                ORDER BY CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
        END
    END
    
  PRINT 'Filled LedgerCursor'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SET @@balcur = CURSOR FOR SELECT   CLTCODE,
                                     VTYP,
                                     VNO,
                                     EVDT,
                                     VAMT,
                                     CLOSBAL
                            FROM     #LEDGERCURSOR
                            ORDER BY CLTCODE,
                                     EVDT DESC,
                                     VTYP,
                                     VNO
  
  SELECT CLTCODE,
         VAMT    BALAMT,
         0       AGEDAYS,
         DRCR
  INTO   #FINTEMPAGEING
  FROM   #LEDGER
  WHERE  1 = 2
             
  PRINT 'opening cursor'
  
  OPEN @@balcur
  
  FETCH NEXT FROM @@balcur
  INTO @@cltcode,
       @@vtyp,
       @@vno,
       @@EVdt,
       @@vamt,
       @@closbal
       
  WHILE @@FETCH_STATUS = 0
    BEGIN
      SELECT @@ocltcode = @@cltcode
      
      SELECT @@balamt = ABS(@@closbal)
      
      IF @@closbal >= 0
        BEGIN
          SELECT @@drcr = 'd'
        END
      ELSE
        BEGIN
          SELECT @@drcr = 'c'
        END
        
      WHILE @@FETCH_STATUS = 0
            AND @@ocltcode = @@cltcode
            AND @@balamt > 0
        BEGIN
          IF @@balamt >= @@vamt
            BEGIN
              INSERT INTO #FINTEMPAGEING
              SELECT @@cltcode,
                     @@vamt,
                     DATEDIFF(DAY,@@EVdt,@todate),
                     @@drcr
              
              SELECT @@balamt = @@balamt - @@vamt
            END
            
          ELSE
            BEGIN
              INSERT INTO #FINTEMPAGEING
              SELECT @@cltcode,
                     @@balamt,
                     DATEDIFF(DAY,@@EVdt,@todate),
                     @@drcr
              
              SELECT @@balamt = @@balamt - @@vamt
            END
            
          FETCH NEXT FROM @@balcur
          INTO @@cltcode,
               @@vtyp,
               @@vno,
               @@EVdt,
               @@vamt,
               @@closbal
        END
        
      IF @@balamt > 0
        BEGIN
          INSERT INTO #FINTEMPAGEING
          SELECT @@ocltcode,
                 @@balamt,
                 181,
                 @@drcr
          
          SELECT @@balamt = @@balamt - @@vamt
        END
        
      WHILE @@FETCH_STATUS = 0
            AND @@ocltcode = @@cltcode
        BEGIN
          FETCH NEXT FROM @@balcur
          INTO @@cltcode,
               @@vtyp,
               @@vno,
               @@EVdt,
               @@vamt,
               @@closbal
        END
    END
    
  CLOSE @@balcur
  
  DEALLOCATE @@balcur
  
  PRINT 'cursor closed'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days1,
           DRCR
  INTO     #AGEINGLIST
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= 0
           AND AGEDAYS <= @Days1
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days2,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days1 + 1
           AND AGEDAYS <= @Days2
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days3,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days2 + 1
           AND AGEDAYS <= @Days3
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days4,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days3 + 1
           AND AGEDAYS <= @Days4
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days5,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days5
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  PRINT 'done'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SELECT   A1.CLTCODE,
           SHORT_NAME = A2.SHORT_NAME,
           BALANCE,
           AGEDAYS,
           DRCR,
           A2.BRANCH_CD,
           A2.SUB_BROKER,
           B.BRANCH,
           S.NAME
  FROM     #AGEINGLIST A1,
           MSAJAG.DBO.CLIENT1 A2,
           MSAJAG.DBO.SUBBROKERS S,
           MSAJAG.DBO.BRANCH B--msajag.dbo.clientmaster a2--account.dbo.acmast  a2             
  WHERE    BALANCE >= @amoutgtthan
           AND A1.CLTCODE = A2.CL_CODE
           AND A2.BRANCH_CD = B.BRANCH_CODE
           AND A2.SUB_BROKER = S.SUB_BROKER
  ORDER BY A2.BRANCH_CD,
           A2.SUB_BROKER,
           A1.CLTCODE,
           A2.SHORT_NAME
           
  DROP TABLE #TEMPAGEING
  
  DROP TABLE #LEDGER
  
  DROP TABLE #LEDGERCURSOR
  
  DROP TABLE #AGEINGLIST
  
  DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTOJV_BULK
-- --------------------------------------------------
-- select  convert(varchar,getdate(),103), convert(varchar,getdate(),12)+right(replace(convert(varchar,getdate(),114),':',''),6) From Owner  
CREATE PROC [dbo].[AUTOJV_BULK]    
(    
 @PROCESS_ID VARCHAR(25),    
 @UNAME VARCHAR(25),    
 @VTYP SMALLINT,    
 @BOOKTYPE VARCHAR(2),    
 @USERCAT INT    
)    
    
AS    
 /*    
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV'    
 EXEC DRCRNOTEUPLOAD_BULK 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV', 'TEST', 6, '01'    
 EXEC DRCRNOTEUPLOAD_BULK 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV', 'TEST', 6, '01'    
 */    
 SET NOCOUNT ON    
    
 DECLARE    
  @@ERROR_COUNT AS INT,    
  @@SQL AS VARCHAR(2000),    
  @@BACKDAYS INT,    
  @@BACKDATE DATETIME    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE_TMP]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_RECPAY_TABLE_TMP]    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_RECPAY_TABLE]    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE_LNO]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_RECPAY_TABLE_LNO]    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_VNO]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_VNO]    
      
 CREATE TABLE TMP_RECPAY_TABLE_TMP    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  GL_CODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(500),    
  BRANCHCODE VARCHAR(10)    
 )    
    
 CREATE TABLE [TMP_RECPAY_TABLE]    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(500),    
  BRANCHCODE VARCHAR(10),    
  SNO INT IDENTITY (1, 1) NOT NULL ,    
  VDT DATETIME NULL ,    
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),    
  EDT DATETIME NULL ,    
  VNO VARCHAR (12)  NULL ,    
  ACNAME VARCHAR (100)  NULL ,    
  FYSTART DATETIME NULL,    
  FYEND DATETIME NULL,    
  COSTCODE SMALLINT NULL,    
  LNO SMALLINT NOT NULL DEFAULT(0)    
 ) ON [PRIMARY]    
    
 CREATE TABLE [TMP_RECPAY_TABLE_LNO]    
 (    
  SNO INT,    
  LNO INT IDENTITY (1, 1) NOT NULL    
 ) ON [PRIMARY]    
     
 INSERT INTO     
  TMP_RECPAY_TABLE_TMP    
 SELECT  
  FLDAUTO,     
  VVDT = CONVERT(VARCHAR(10), GETDATE(), 103),    
  EEDT = CONVERT(VARCHAR(10), GETDATE(), 103),    
  CLTCODE = PARTYCODE,    
  GL_CODE = CASE WHEN EXCHANGEFR = ACCOUNTDB THEN GLCODEFR ELSE GLCODETO END,    
  DRCR = CASE WHEN EXCHANGEFR = ACCOUNTDB THEN 'D' ELSE 'C' END ,    
  AMOUNT = JVAMT,    
  NARRATION /*= 'FUND TRNASFER'*/,    
  BRANCHCODE = 'ALL'    
 FROM     
  AngelBSECM.ACCOUNT_AB.DBO.OFFLINE_JV_ENTRIES J WITH (NOLOCK), OWNER O WITH (NOLOCK)    
 WHERE     
  (J.EXCHANGEFR = O.ACCOUNTDB OR EXCHANGETO = O.ACCOUNTDB) AND PROCESS_ID = @PROCESS_ID  
  AND (VCHNOFR IS NULL OR VCHNOTO IS NULL)  
      
 INSERT INTO     
  TMP_RECPAY_TABLE    
 (    
  SRNO,    
  VVDT,    
  EEDT,    
  CLTCODE,    
  DRCR,    
  AMOUNT,    
  NARRATION,    
  BRANCHCODE    
 )    
 SELECT    
  SRNO,    
  VVDT,    
  EEDT,    
  UPPER(CLTCODE),    
  DRCR,    
  AMOUNT,    
  LEFT(NARRATION, 234),    
  BRANCHCODE    
 FROM     
  TMP_RECPAY_TABLE_TMP    
    
 INSERT INTO     
  TMP_RECPAY_TABLE    
 (    
  SRNO,    
  VVDT,    
  EEDT,    
  CLTCODE,    
  DRCR,    
  AMOUNT,    
  NARRATION,    
  BRANCHCODE    
 )    
 SELECT    
  SRNO,    
  VVDT,    
  EEDT,    
  GL_CODE,    
  DRCR = CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END,    
  AMOUNT,    
  LEFT(NARRATION, 234),    
  BRANCHCODE    
 FROM     
  TMP_RECPAY_TABLE_TMP    
    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET    
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
  FYSTART = P.SDTCUR,    
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,    
  TMP_RECPAY_TABLE.COSTCODE = C.COSTCODE    
 FROM     
  ACMAST A,     
  PARAMETER P,     
  COSTMAST C    
 WHERE     
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE    
  AND P.CURYEAR = 1    
  AND A.ACCAT IN ('3','4','104')    
  AND A.BRANCHCODE = C.COSTNAME    
  AND A.BRANCHCODE <> 'ALL'    
    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET    
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
  FYSTART = P.SDTCUR,    
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,    
  TMP_RECPAY_TABLE.COSTCODE = C.COSTCODE    
 FROM     
  ACMAST A,     
  PARAMETER P,     
  COSTMAST C    
 WHERE     
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE    
  AND P.CURYEAR = 1    
  AND A.ACCAT IN ('3','4','104')    
  AND TMP_RECPAY_TABLE.BRANCHCODE = C.COSTNAME    
  AND A.BRANCHCODE = 'ALL'    
  AND TMP_RECPAY_TABLE.BRANCHCODE <> 'ALL'    
  AND TMP_RECPAY_TABLE.COSTCODE IS NULL    
    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET    
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
  FYSTART = P.SDTCUR,    
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,    
  TMP_RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
 FROM     
  ACMAST A,     
  PARAMETER P    
 WHERE     
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE    
  AND P.CURYEAR = 1    
  AND A.ACCAT IN ('3','4','104')    
  AND A.BRANCHCODE = 'ALL'    
  AND TMP_RECPAY_TABLE.BRANCHCODE = 'ALL'    
  AND TMP_RECPAY_TABLE.COSTCODE IS NULL    
    
 ---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET     
  UPDFLAG = 'N'    
 FROM    
 (    
 SELECT    
  PARTY_CODE,    
  INACTIVEFROM    
 FROM     
  MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK),    
  MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)    
 WHERE     
  C2.CL_CODE = C5.CL_CODE    
  AND C2.PARTY_CODE IN (SELECT CLTCODE FROM TMP_RECPAY_TABLE)    
  AND INACTIVEFROM <= GETDATE()    
 ) C    
 WHERE     
  CLTCODE = C.PARTY_CODE    
    
 /* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/    
    
 DECLARE    
  @@STD_DATE VARCHAR(11),    
  @@LST_DATE VARCHAR(11),    
  @@VNOMETHOD INT,    
  @@ACNAME CHAR(100),    
  @@MICRNO VARCHAR(10),    
  @@DRCR VARCHAR(1)    
    
 /* '--------------------------UPDATE OF COST CODE ------------------------*/    
    
 UPDATE     
  TMP_RECPAY_TABLE    
 SET     
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
 WHERE     
  COSTCODE IS NULL    
    
 DECLARE    
  @@NEWVNO AS VARCHAR(12),    
  @@VDT AS VARCHAR(11),    
  @@LNOCUR AS CURSOR,    
  @@LNOVNO AS INT,    
  @@NOREC AS INT    
    
 /* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/    
 DECLARE    
  @@MAXVNO AS VARCHAR(12),    
  @@VNO AS VARCHAR(12),    
  @@RCOUNT AS INT    
      
 SELECT TOP 1    
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)    
 FROM    
  TMP_RECPAY_TABLE    
    
 SELECT TOP 1    
  @@VNOMETHOD = VNOFLAG,    
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),    
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)    
 FROM    
  PARAMETER    
 WHERE    
  @@VDT BETWEEN SDTCUR AND LDTCUR    
    
 SELECT    
  @@NOREC = COUNT(DISTINCT SRNO)    
 FROM    
  TMP_RECPAY_TABLE    
    
 CREATE TABLE TMP_VNO    
 (    
  LASTVNO VARCHAR(12)    
 )    
    
 INSERT INTO TMP_VNO    
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC    
    
 SELECT @@VNO = LASTVNO FROM TMP_VNO    
   
 CREATE TABLE #VNO_GEN  
 (  
 SNO INT IDENTITY(1, 1),  
 SRNO INT  
)  
  
INSERT INTO #VNO_GEN  
SELECT SRNO  FROM TMP_RECPAY_TABLE ORDER BY SRNO  
  
  
 UPDATE    
  TMP_RECPAY_TABLE    
 SET     
  VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + V.SNO - 1)    
  FROM #VNO_GEN V  
  WHERE V.SRNO  = TMP_RECPAY_TABLE.SRNO  
    
 /* '--------------------------AUTO GENERATION OF LNO ------------------------*/    
    
 SET @@LNOCUR = CURSOR FOR    
  SELECT DISTINCT SRNO FROM TMP_RECPAY_TABLE    
  OPEN @@LNOCUR    
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
  WHILE @@FETCH_STATUS = 0    
  BEGIN    
   INSERT INTO TMP_RECPAY_TABLE_LNO    
   (SNO)    
   SELECT SNO FROM TMP_RECPAY_TABLE WHERE SRNO = @@LNOVNO    
   UPDATE RP    
   SET LNO = RL.LNO    
   FROM TMP_RECPAY_TABLE RP, TMP_RECPAY_TABLE_LNO RL    
   WHERE RP.SNO = RL.SNO    
   TRUNCATE TABLE TMP_RECPAY_TABLE_LNO    
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
  END    
 CLOSE @@LNOCUR    
 DEALLOCATE @@LNOCUR    
     
 DROP TABLE TMP_RECPAY_TABLE_LNO    
 --SELECT * FROM TMP_RECPAY_TABLE    
 --RETURN    
    
 /* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/    
 /*==============================    
 LEDGER RECORD    
 ==============================*/    
    
 INSERT INTO    
  LEDGER    
 SELECT    
  VTYP = @VTYP,    
  VNO,    
  EDT,    
  LNO,    
  ACNAME,    
  DRCR,    
  VAMT = SUM(AMOUNT),    
  VDT,    
  VNO1 = VNO,    
  REFNO = 0,    
  BALAMT = SUM(AMOUNT),    
  NODAYS = 0,    
  CDT = GETDATE(),    
  CLTCODE,    
  BOOKTYPE = @BOOKTYPE,    
  ENTEREDBY = @UNAME,    
  PDT = GETDATE(),    
  CHECKEDBY = @UNAME,    
  ACTNODAYS = 0,    
  NARRATION    
 FROM    
  TMP_RECPAY_TABLE    
 GROUP BY    
  VNO,    
  EDT,    
  LNO,    
  ACNAME,    
  DRCR,    
  VDT,    
  CLTCODE,    
  NARRATION    
    
 /*==============================    
 LEDGER3 RECORD    
 ==============================*/    
 INSERT INTO    
  LEDGER3    
 SELECT    
  NARATNO = LNO,    
  NARRATION,    
  REFNO = 0,    
  VTYP = @VTYP,    
  VNO,    
  BOOKTYPE = @BOOKTYPE    
 FROM    
  TMP_RECPAY_TABLE    
    
 DELETE    
  TEMPLEDGER2    
 WHERE     
  SESSIONID = '9999999999'    
    
 INSERT INTO     
  TEMPLEDGER2    
 SELECT    
  'BRANCH',    
  C.COSTNAME,    
  AMOUNT,    
  VTYP = @VTYP,    
  VNO,    
  LNO,    
  DRCR,    
  '0',    
  BOOKTYPE = @BOOKTYPE,    
  SESSIONID = '9999999999',    
  CLIENT_CODE = CLTCODE,    
  'A',    
  '0'    
 FROM    
  TMP_RECPAY_TABLE RP,    
  COSTMAST C    
 WHERE    
  RP.COSTCODE = C.COSTCODE    
    
 DECLARE @@L2CUR AS CURSOR,    
  @@L2VNO AS VARCHAR(12)    
  SET @@L2CUR = CURSOR FOR    
  SELECT DISTINCT VNO FROM TMP_RECPAY_TABLE ORDER BY VNO    
  OPEN @@L2CUR    
  FETCH NEXT FROM @@L2CUR INTO @@L2VNO    
  WHILE @@FETCH_STATUS = 0    
  BEGIN    
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'    
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO    
  END    
  DELETE FROM TEMPLEDGER2    
  WHERE SESSIONID = '9999999999'    
 CLOSE @@L2CUR    
 DEALLOCATE @@L2CUR    
    
 SELECT     
  RESULT = 'DATA UPLOADED SUCCESSFULLY'    
 UNION ALL    
 SELECT     
  RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO     
 FROM     
  TMP_RECPAY_TABLE    
    
 --UPDATE     
 -- J     
 --SET    
 -- VCHNOFR = CASE WHEN O.ACCOUNTDB = J.EXCHANGEFR THEN R.VNO ELSE VCHNOFR END,    
 -- VCHNOTO = CASE WHEN O.ACCOUNTDB = J.EXCHANGETO THEN R.VNO ELSE VCHNOTO END    
 --FROM     
 -- AngelBSECM.ACCOUNT_AB.DBO.OFFLINE_JV_ENTRIES J, OWNER O,    
 -- TMP_RECPAY_TABLE R    
 --WHERE     
 -- SRNO = FLDAUTO     
 -- AND (O.ACCOUNTDB = EXCHANGEFR OR O.ACCOUNTDB = EXCHANGETO)    
    
 DROP TABLE TMP_RECPAY_TABLE_TMP    
 DROP TABLE TMP_RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ALLBANKS
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_ALLBANKS](              
           @FILENAME       VARCHAR(100),              
           @UNAME          VARCHAR(100),              
           @BANKCODE       VARCHAR(10),              
           @STATUSID       VARCHAR(10),              
           @STATUSNAME     VARCHAR(100),              
           @BANK_TYPE      VARCHAR(10),              
           @STAT_TYPE      VARCHAR(10),              
           @LOGIN          VARCHAR(10),              
           @PWD            VARCHAR(15),              
           @PROCESS_STATUS BIT  = 0)              
              
AS              
              
  DECLARE  @@SQL_QUERY         AS VARCHAR(1000),              
           @@CROSSREFERENCENO INT,              
           @@TABLE_EXIST      VARCHAR(20),              
           @@RECORD_COUNT     TINYINT,              
           @@RECO_STATUS      CHAR(1),              
           @@FILE_EXIST       INT,              
           @@CLTCODE_EXIST    INT,              
           @@MICRNO           VARCHAR(20)              
                                          
  SET NOCOUNT ON              
                
  SELECT @@CLTCODE_EXIST = COUNT(1)              
  FROM   ACMAST WITH(NOLOCK)               
  WHERE  CLTCODE = @BANKCODE              
         AND ACCAT = 2              
                                   
  IF @@CLTCODE_EXIST = 0              
    BEGIN              
      SELECT 'BANK CODE DOSE NOT EXIST.'              
                    
      RETURN              
    END              
          
                 
  SELECT @@MICRNO = ISNULL(MICRNO,0)              
  FROM   ACMAST WITH(NOLOCK)               
  WHERE  CLTCODE = @BANKCODE              
         AND ACCAT = 2              
                                   
  /*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/              
  DECLARE  @@ERROR_COUNT        SMALLINT,              
           @@EXIST_COUNT_BEFORE SMALLINT,              
           @@EXIST_COUNT_AFTER  SMALLINT              
                
  SELECT @@ERROR_COUNT = COUNT(1)              
  FROM   (SELECT U_FILENAME              
          FROM   V2_UPLOADED_FILES WITH(NOLOCK)               
          WHERE  U_FILENAME = @FILENAME              
                 AND U_MODULE = 'HDFC_RECO UPLOAD') A              
                
  SELECT @@CROSSREFERENCENO = ISNULL(MAX(CONVERT(NUMERIC,CROSSREFERENCENO)),0)              
  FROM   BANKRECO WITH(NOLOCK)               
                       
  CREATE TABLE #HDFCRECO (              
    BOOKDATE VARCHAR(11))              
                
  CREATE TABLE #PNBRECO (              
    TXN_ID   VARCHAR(25),              
    BOOKDATE VARCHAR(11))              
                
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'           
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"              
  END              
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20),"                
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"              
  END              
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'              
 BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
  END              
  /*ELSE IF @BANK_TYPE = 'PNBRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
               
  END              */
                
  EXEC (@@SQL_QUERY)                 
                
  IF @BANK_TYPE = 'PNBRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #PNBRECO ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
                
   EXEC (@@SQL_QUERY)              
  END              
                
  CREATE TABLE [#BANKRECOSAVE_TEMP]                    
   (                    
    CLTCODE VARCHAR(10),                    
    BOOKDATE DATETIME,                    
    [DESCRIPTION] VARCHAR(50),                    
    AMOUNT VARCHAR(20),                    
    DRCR VARCHAR(1),                    
    VALUEDATE DATETIME,                    
    REFERENCENO VARCHAR(30),                    
    STATUSID VARCHAR(15),                    
    STATUSNAME VARCHAR(25),                    
    LOGINNAME VARCHAR(25),                    
    STATUS VARCHAR(9),                    
    MICRNO INT,                    
    DUMMY1 VARCHAR(15) ,                    
    DUMMY2 VARCHAR(15),                    
    AMOUNTLEDGR1 VARCHAR(20),                    
    CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL                    
   )                    
  ON [PRIMARY]                    
                      
  CREATE TABLE [#BANKRECOSAVE]                    
   (                    
    CLTCODE VARCHAR(10),                    
    BOOKDATE DATETIME,                    
    [DESCRIPTION] VARCHAR(50),                    
    AMOUNT MONEY,                    
    DRCR VARCHAR(1),                    
    VALUEDATE DATETIME,                    
    REFERENCENO VARCHAR(30),                    
    STATUSID VARCHAR(15),                    
    STATUSNAME VARCHAR(25),                    
    LOGINNAME VARCHAR(25),                    
    CROSSREFERENCENO [INT],                    
    STATUS VARCHAR(9),                    
    MICRNO INT,                    
    DUMMY1 VARCHAR(15) ,                    
    DUMMY2 VARCHAR(15),                    
    AMOUNTLEDGR1 MONEY,               
    L1_SNO INT,               
    VTYP SMALLINT,               
    BOOKTYPE CHAR(2),               
    VNO VARCHAR(12),               
    SLIPNO INT               
   )                    
  ON [PRIMARY]                   
                
  CREATE TABLE #TESTIMPORT                              
  (                              
   OneRow Varchar(2000),                            
   SNO INT IDENTITY(1,1)                            
  )                 
                
  IF @BANK_TYPE = 'PNBRECO'              
  BEGIN              
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#PNBRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"              
                 
  END              
  ELSE IF @BANK_TYPE <> 'CANARARECO'              
  BEGIN              
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"              
  END          
                
  --PRINT @@SQL_QUERY              
  EXEC (@@SQL_QUERY) 

                 
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'             
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"              
  END              
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "              
  END              
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"              
  END              
  ELSE IF @BANK_TYPE = 'PNBRECO'              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #PNBRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "              
  END              
  ELSE              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "              
  END              
                
                
  EXEC (@@SQL_QUERY)   

IF @BANK_TYPE = 'PNBRECO'
BEGIN              
  SELECT * INTO   HDFCRECO  FROM   #PNBRECO              
END
ELSE 
BEGIN
	SELECT * INTO   HDFCRECO  FROM   #HDFCRECO              
END

                  
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'            
    BEGIN              
      UPDATE HDFCRECO              
      SET    [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE',              
             VALUEDATE = BOOKDATE              
    END              
  ELSE              
    IF (@BANK_TYPE = 'HDFCRECO'              
        AND @STAT_TYPE = 'TAB')              
        OR @BANK_TYPE = 'UTIRECO'              
      BEGIN              
        UPDATE HDFCRECO              
        SET    AMOUNT = CASE               
                          WHEN (DEBIT IS NULL               
                                 OR CONVERT(MONEY,DEBIT) = 0) THEN CREDIT              
                          ELSE DEBIT              
                        END,              
               DRCR = CASE               
                        WHEN (DEBIT IS NULL               
                               OR CONVERT(MONEY,DEBIT) = 0) THEN 'C'              
                        ELSE 'D'              
                      END              
      END              
    ELSE              
      IF @BANK_TYPE = 'PNBRECO'              
 BEGIN              
          UPDATE HDFCRECO              
          SET    VALUEDATE = BOOKDATE,              
                 DRCR = (CASE               
                           WHEN DRCR = 'DR' THEN 'D'              
                           ELSE 'C'              
                         END)              
        END              
                
  IF @BANK_TYPE = 'CANARARECO'              
    BEGIN              
   SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"              
     EXEC(@@SQL_QUERY)                              
                
      DELETE FROM #TESTIMPORT              
      WHERE       ONEROW IS NULL              
                                
      DELETE FROM #TESTIMPORT              
      WHERE       ONEROW LIKE '****%'              
                                            
      INSERT INTO #BANKRECOSAVE_TEMP              
      SELECT @BANKCODE,              
             BOOKDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),              
                                103),              
             [DESCRIPTION] = SUBSTRING(ONEROW,18,23),              
             AMOUNT = SUBSTRING(ONEROW,41,14),              
             DRCR = SUBSTRING(ONEROW,17,1),              
             VALUEDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),              
                                 103),              
             REFERENCE_NO = SUBSTRING(ONEROW,9,8),              
             @STATUSID,              
             @STATUSNAME,              
             @UNAME,              
             'UNMATCHED',              
             @@MICRNO,              
             '',              
             '',              
             ''                           
      FROM   #TESTIMPORT              
                           
    END              
  ELSE              
    IF @BANK_TYPE = 'PNBRECO'              
      BEGIN              
        INSERT INTO #BANKRECOSAVE_TEMP              
        SELECT @BANKCODE,              
               BOOKDATE = CONVERT(DATETIME,(SUBSTRING(BOOKDATE,4,2) + '/' + LEFT(BOOKDATE,2) + '/' + RIGHT(BOOKDATE,4)), 101),              
               [DESCRIPTION],              
               AMOUNT,              
               DRCR,              
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE,4,2) + '-' + LEFT(VALUEDATE,2)),              
               REFERENCE_NO,              
               @STATUSID,              
               @STATUSNAME,              
               @UNAME,              
               'UNMATCHED',              
               @@MICRNO,              
               '',              
               '',              
               ''              
        FROM   HDFCRECO              
                             
      END              
    ELSE
      BEGIN              
		  INSERT INTO #BANKRECOSAVE_TEMP              
			SELECT @BANKCODE,              
				   BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),              
									  103),              
				   [DESCRIPTION],              
				   CASE WHEN ([DESCRIPTION] LIKE '%OPENING BALANCE%' OR [DESCRIPTION] LIKE '%CLOSING BALANCE%') THEN RUNNING_BAL ELSE AMOUNT END,  
				   DRCR,              
				   VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE,4,2) + '-' + LEFT(VALUEDATE,2)),              
				   REFERENCE_NO,              
				   @STATUSID,              
				   @STATUSNAME,              
				   @UNAME,              
				   'UNMATCHED',              
				   @@MICRNO,              
				   '',              
				   '',              
				   ''              
			FROM   HDFCRECO              
		  END     
          


  DROP TABLE HDFCRECO              
    
INSERT INTO #BANKRECOSAVE              
SELECT @BANKCODE,              
 BOOKDATE,              
 [DESCRIPTION],              
 AMOUNT = CASE               
            WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))              
            ELSE CONVERT(MONEY,AMOUNT)              
          END,              
 DRCR,              
 VALUEDATE,              
 REFERENCENO = CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),              
 @STATUSID,              
 @STATUSNAME,             
 @UNAME,              
 CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),              
 'UNMATCHED',              
 @@MICRNO,              
 '',              
 '',              
 0,               
 0,               
 0,               
 '',               
 '',               
 0               
  FROM   #BANKRECOSAVE_TEMP              
  WHERE  REFERENCENO NOT LIKE '%[A-Z]%'              
                                            
  INSERT INTO #BANKRECOSAVE              
  SELECT @BANKCODE,              
         BOOKDATE,              
         [DESCRIPTION],              
         AMOUNT = CASE               
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))              
                    ELSE CONVERT(MONEY,AMOUNT)              
                  END,              
         DRCR,              
         VALUEDATE,              
         REFERENCENO,              
         @STATUSID,              
         @STATUSNAME,              
         @UNAME,              
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),              
         'UNMATCHED',              
         @@MICRNO,              
         '',              
         '',              
         0,               
         0,               
         0,               
         '',               
         '',               
         0               
  FROM   #BANKRECOSAVE_TEMP              
  WHERE  REFERENCENO LIKE '%[A-Z]%'              
                                        
  INSERT INTO #BANKRECOSAVE              
  SELECT @BANKCODE,              
         BOOKDATE,              
         [DESCRIPTION],              
         AMOUNT = CASE               
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))              
                    ELSE CONVERT(MONEY,AMOUNT)              
                  END,              
         DRCR,              
         VALUEDATE,              
         REFERENCENO = ISNULL(CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),              
                              0),              
         @STATUSID,              
         @STATUSNAME,              
         @UNAME,              
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),              
         'UNMATCHED',              
         @@MICRNO,              
         '',              
         '',              
         0,               
         0,               
         0,               
         '',               
         '',               
         0               
  FROM   #BANKRECOSAVE_TEMP              
  WHERE  REFERENCENO IS NULL              
                       
  IF @BANK_TYPE = 'CANARARECO'              
    BEGIN              
      UPDATE #BANKRECOSAVE              
      SET    AMOUNT = CONVERT(MONEY,AMOUNT / 100)              
    END              
                  
  /*CREATE TABLE #BANKRECOSAVE_DELETE                    
  (                    
   [DESCRIPTION] VARCHAR(250),                    
   AMOUNT MONEY,                    
   DRCR CHAR(1),                    
   REFERENCENO VARCHAR(25),                    
  CROSSREFERENCENO INT                    
  ) */              
  DECLARE  @@AMOUNTDIFF   MONEY,              
           @@STAMOUNTDIFF MONEY,              
           @@BOOKDATE_MIN DATETIME,              
           @@BOOKDATE_MAX DATETIME              
       
  SELECT @@BOOKDATE_MIN = MIN(BOOKDATE)              
  FROM   #BANKRECOSAVE              
                       
  SELECT @@BOOKDATE_MAX = MAX(BOOKDATE)              
  FROM   #BANKRECOSAVE

  CREATE TABLE #RECODUPS (              
    BOOKDATE         VARCHAR(11),              
    REFERENCENO      VARCHAR(25),              
    AMOUNT           MONEY,              
    DESCRIPTION      VARCHAR(200),              
    STATUS           VARCHAR(10),              
    CROSSREFERENCENO INT)              
                
  SET @@EXIST_COUNT_BEFORE = 0              
                                           
  SET @@EXIST_COUNT_AFTER = 0              
                                          
  DECLARE  @CLTCODE VARCHAR(10),              
           @BOOKDATE    DATETIME,              
           @AMOUNT      MONEY,              
           @DRCR        CHAR(1),              
           @VALUEDATE   DATETIME,              
           @REFERENCENO VARCHAR(20),              
           @DESCRIPTION VARCHAR(200)              
                                      
  DECLARE CUR_CHECCK CURSOR  FOR              
  SELECT CLTCODE,              
         BOOKDATE,              
         AMOUNT,              
         DRCR,              
         VALUEDATE,              
         REFERENCENO,              
         [DESCRIPTION]              
  FROM   #BANKRECOSAVE              
  WHERE  AMOUNT < 0              
                                
  OPEN CUR_CHECCK              
                
  FETCH NEXT FROM CUR_CHECCK              
  INTO @CLTCODE,              
       @BOOKDATE,              
       @AMOUNT,              
       @DRCR,              
       @VALUEDATE,              
       @REFERENCENO,              
       @DESCRIPTION              
                     
  WHILE @@FETCH_STATUS = 0              
    BEGIN              
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
      IF @PROCESS_STATUS = 0              
        BEGIN              
          SELECT @@ERROR_COUNT = 0              
                                               
          SELECT @@EXIST_COUNT_BEFORE = COUNT(1)              
          FROM   BANKRECO WITH(NOLOCK)              
          WHERE  CLTCODE = @CLTCODE              
                 AND BOOKDATE = @BOOKDATE              
                 AND AMOUNT = ABS(@AMOUNT)              
                 AND DRCR = @DRCR              
                 AND VALUEDATE = @VALUEDATE              
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
        END              
                      
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
      SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)              
      FROM   #BANKRECOSAVE              
      WHERE  [DESCRIPTION] = @DESCRIPTION              
             AND AMOUNT = ABS(@AMOUNT)              
             AND DRCR = @DRCR              
             AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
             AND AMOUNT > 0              
                                        
      DELETE BR              
      FROM   #BANKRECOSAVE BR              
      WHERE  BR.CROSSREFERENCENO = @@CROSSREFERENCENO              
                                                 
      IF @PROCESS_STATUS = 0              
        BEGIN              
          SELECT @@EXIST_COUNT_AFTER = COUNT(1)              
          FROM   #BANKRECOSAVE              
          WHERE  [DESCRIPTION] = @DESCRIPTION              
                 AND AMOUNT = ABS(@AMOUNT)              
                 AND DRCR = @DRCR              
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
                 AND AMOUNT > 0              
                                            
          IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER              
            BEGIN              
              INSERT INTO #RECODUPS              
               SELECT BOOKDATE = CONVERT(VARCHAR(11),BR.BOOKDATE,103),              
                     BR.REFERENCENO,            
                     BR.AMOUNT,              
                     BR.[DESCRIPTION],              
                     BR.STATUS,              
                     BR.CROSSREFERENCENO              
              FROM   (SELECT *              
                      FROM   BANKRECO WITH(NOLOCK)              
                      WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'              
                             AND CLTCODE = @BANKCODE) BR              
              WHERE  CLTCODE = @CLTCODE              
                     AND BOOKDATE = @BOOKDATE              
                     AND AMOUNT = ABS(@AMOUNT)              
                     AND DRCR = @DRCR              
                     AND VALUEDATE = @VALUEDATE              
                     AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
            END              
                          
          SET @@EXIST_COUNT_BEFORE = 0              
                                                   
          SET @@EXIST_COUNT_AFTER = 0              
        END              
                      
      FETCH NEXT FROM CUR_CHECCK              
      INTO @CLTCODE,              
           @BOOKDATE,              
           @AMOUNT,              
           @DRCR,              
           @VALUEDATE,              
           @REFERENCENO,              
           @DESCRIPTION              
    END              

                    
  DELETE FROM #BANKRECOSAVE              
  WHERE       AMOUNT < 0              

 
                                     
  SELECT @@ERROR_COUNT = COUNT(1)              
  FROM   #RECODUPS              
                       
  IF @@ERROR_COUNT > 0              
    BEGIN              
      SELECT *              
      FROM   #RECODUPS              
                           
      RETURN              
    END              
                  
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
  DELETE BR              
  FROM   BANKRECO B WITH(ROWLOCK),              
         #BANKRECOSAVE BR              
  WHERE  LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE))              
         AND CONVERT(VARCHAR(11),B.BOOKDATE,109) = CONVERT(VARCHAR(11),BR.BOOKDATE,109)              
         AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))              
         AND B.AMOUNT = BR.AMOUNT              
         AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR))              
         AND CONVERT(VARCHAR(11),B.VALUEDATE,109) = CONVERT(VARCHAR(11),BR.VALUEDATE,109)              
         AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)),'') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)),'')              
                                                                    
  SELECT @@ERROR_COUNT = COUNT(1)              
  FROM   #BANKRECOSAVE              
  WHERE  VALUEDATE IS NOT NULL              
                       
  IF @@ERROR_COUNT = 0              
    BEGIN              
      SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'              
                  
      RETURN              
    END              


                  
  SELECT @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)              
  FROM   (SELECT AMOUNT              
          FROM   #BANKRECOSAVE              
          WHERE  [DESCRIPTION] LIKE '%OPENING BALANCE%') BR,          
        (SELECT AMOUNT              
          FROM   #BANKRECOSAVE              
          WHERE  [DESCRIPTION] LIKE '%CLOSING BALANCE%') BR1              
                       
  IF @PROCESS_STATUS = 1              
    BEGIN              
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))              
      FROM   (SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
   END)              
              FROM   BANKRECO B WITH (NOLOCK)              
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX              
                     AND CLTCODE = @BANKCODE              
                     AND NOT EXISTS (SELECT CROSSNO              
                                                  FROM   RECODUPS1 R WHERE R.CROSSNO = B.CROSSREFERENCENO)              
              GROUP BY DRCR               
              UNION ALL              
              SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
                                  END)              
              FROM   #BANKRECOSAVE              
              WHERE  VALUEDATE IS NOT NULL              
              GROUP BY DRCR) B              
 END              
  ELSE              
    BEGIN              
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))              
      FROM   (SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
                                  END)              
              FROM   BANKRECO B WITH (NOLOCK)              
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX              
                     AND CLTCODE = @BANKCODE              
              GROUP BY DRCR               
              UNION ALL              
              SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
                                  END)              
              FROM   #BANKRECOSAVE              
              WHERE  VALUEDATE IS NOT NULL              
              GROUP BY DRCR) B              
    END          

  IF @@AMOUNTDIFF <> @@STAMOUNTDIFF              
    BEGIN              
      SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'              
                           
      RETURN              
    END              
                  
  DELETE FROM #BANKRECOSAVE              
  WHERE       VALUEDATE IS NULL              
                            
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
  SET @@TABLE_EXIST = ''              
                                  
  SELECT @@TABLE_EXIST = NAME              
  FROM   SYSOBJECTS              
  WHERE  NAME = 'RECOPROCESS'              
                              
  IF @@TABLE_EXIST = ''              
    BEGIN              
      CREATE TABLE RECOPROCESS (              
        INPROCESS VARCHAR(1))              
                    
      INSERT INTO RECOPROCESS              
                 (INPROCESS)              
      VALUES     ('N')              
    END              
                  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED              
                
    SELECT @@RECORD_COUNT = COUNT(* )              
  FROM   RECOPROCESS              
                       
  IF @@RECORD_COUNT = 0              
    BEGIN              
      INSERT INTO RECOPROCESS              
                 (INPROCESS)              
      VALUES     ('N')              
    END              
                  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED              
                
  SELECT TOP 1 @@RECO_STATUS = INPROCESS              
  FROM   RECOPROCESS WITH (NOLOCK)              
                       
  IF @@RECO_STATUS = 'N'              
    BEGIN              
      BEGIN TRAN              
                    
      UPDATE RECOPROCESS              
      SET    INPROCESS = 'Y'              
    END              
  ELSE              
    BEGIN              
      SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'         
                           
      RETURN              
    END              
                  
  INSERT INTO V2_UPLOADED_FILES              
  SELECT @FILENAME,              
         @FILENAME,              
         COUNT(1),              
         'B',              
         GETDATE(),              
         @UNAME,              
         'HDFC_RECO UPLOAD'              
                       
  UPDATE #BANKRECOSAVE              
  SET    STATUS = 'MATCHED',               
         L1_SNO = LEDGER1.L1_SNO,               
         VTYP = LEDGER1.VTYP,               
         BOOKTYPE = LEDGER1.BOOKTYPE,               
         VNO = LEDGER1.VNO               
  FROM   LEDGER1 WITH (NOLOCK)              
  WHERE  (LEDGER1.VTYP = 2              
           OR LEDGER1.VTYP = 3              
           OR LEDGER1.VTYP = 5              
           OR LEDGER1.VTYP = 17              
           OR LEDGER1.VTYP = 19              
           OR LEDGER1.VTYP = 20)              
         AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)              
         AND RTRIM(DDNO) = RTRIM(REFERENCENO)              
         AND CLTCODE = @BANKCODE              
         AND #BANKRECOSAVE.MICRNO = @@MICRNO            
         AND LEDGER1.RELDT = ''          
   AND #BANKRECOSAVE.AMOUNT = LEDGER1.RELAMT        
         AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT)              
                                     FROM   LEDGER1 L1 WITH(NOLOCK),              
                                            LEDGER L2 WITH(NOLOCK)              
                                     WHERE  L2.VNO = L1.VNO              
                                            AND L2.VTYP = L1.VTYP              
                                            AND L2.BOOKTYPE = L1.BOOKTYPE              
                                            AND RELDT = ''              
                                            AND CLTCODE = @BANKCODE              
                                            AND #BANKRECOSAVE.REFERENCENO = DDNO              
                                            AND #BANKRECOSAVE.DRCR = L1.DRCR              
                                            AND CONVERT(DATETIME, CONVERT(VARCHAR(11),#BANKRECOSAVE.VALUEDATE,101)) >= CONVERT(DATETIME, CONVERT(VARCHAR(11),VDT,101)))              
         AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO,0)              
         AND REFERENCENO <> '0'              
                                          
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'              
                           
      ROLLBACK TRAN              
             
      RETURN              
    END              
              
  UPDATE LEDGER1 WITH (ROWLOCK)              
  SET    RELDT = VALUEDATE,              
         REFNO = #BANKRECOSAVE.CROSSREFERENCENO              
  FROM   #BANKRECOSAVE                
  WHERE  #BANKRECOSAVE.L1_SNO <> 0               
         AND LEDGER1.L1_SNO = #BANKRECOSAVE.L1_SNO               
              
                                                                  
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  UPDATE #BANKRECOSAVE              
  SET    AMOUNTLEDGR1 = BANKRECOCOMP.AMOUNT,              
         STATUS = 'MATCHED',               
         SLIPNO = BANKRECOCOMP.SLIPNO               
  FROM   (SELECT   SUM(RELAMT)   AS AMOUNT,              
                   SLIPNO        AS SLIPNO,              
                   UPPER(DRCR)   AS DRCR,              
 MICRNO              
          FROM     LEDGER1 WITH(NOLOCK)              
          WHERE    MICRNO = @@MICRNO              
                   AND (VTYP = 2              
                         OR VTYP = 19              
                         OR VTYP = 5)              
                   AND SLIPNO <> ''              
                   AND RELDT = ''               
          GROUP BY SLIPNO,DRCR,MICRNO) BANKRECOCOMP              
  WHERE  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)              
         AND RTRIM(BANKRECOCOMP.SLIPNO) = RTRIM(REFERENCENO)              
         AND #BANKRECOSAVE.MICRNO = @@MICRNO              
         AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT              
   AND #BANKRECOSAVE.MICRNO = BANKRECOCOMP.MICRNO              
         AND REFERENCENO <> '0'              
                                          
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
              
  SELECT L1.VTYP,               
         L1.BOOKTYPE,               
         L1.VNO,               
         L1.L1_SNO,               
         #BANKRECOSAVE.VALUEDATE,               
         #BANKRECOSAVE.CROSSREFERENCENO               
  INTO   #LEDGER_UPDATES_FOR_SLIPS               
  FROM   #BANKRECOSAVE,               
         LEDGER1 L1 WITH(NOLOCK)           
  WHERE  L1.MICRNO = @@MICRNO                 
         AND L1.SLIPNO = #BANKRECOSAVE.SLIPNO               
         AND #BANKRECOSAVE.SLIPNO <> 0               
              
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  UPDATE LEDGER1 WITH (ROWLOCK)              
  SET    RELDT = VALUEDATE,              
         REFNO = #LEDGER_UPDATES_FOR_SLIPS.CROSSREFERENCENO              
  FROM   #LEDGER_UPDATES_FOR_SLIPS              
  WHERE  #LEDGER_UPDATES_FOR_SLIPS.L1_SNO <> 0               
         AND LEDGER1.L1_SNO = #LEDGER_UPDATES_FOR_SLIPS.L1_SNO               
                                            
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  UPDATE L              
  SET    EDT = (CASE               
                  WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),VDT,109))) THEN VDT              
                  ELSE (CASE WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),GETDATE(),109))) THEN
                CONVERT(VARCHAR(11), GETDATE(), 109) ELSE VALUEDATE END) END)             
  FROM   LEDGER L WITH (ROWLOCK),              
         (SELECT VTYP,              
                 BOOKTYPE,              
                 VNO,              
                 VALUEDATE              
          FROM   #BANKRECOSAVE              
          WHERE  VNO <> ''              
          UNION               
          SELECT VTYP,              
                 BOOKTYPE,              
                 VNO,              
                 VALUEDATE              
          FROM   #LEDGER_UPDATES_FOR_SLIPS              
          WHERE  VNO <> '') LU              
  WHERE  LU.VNO = L.VNO              
         AND LU.VTYP = L.VTYP              
         AND LU.BOOKTYPE = L.BOOKTYPE              
         AND EDT LIKE 'DEC 31 2049%'              
                                    
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  IF @PROCESS_STATUS = 1              
    BEGIN              
      DELETE FROM BANKRECO WITH (ROWLOCK)              
      WHERE       CLTCODE = @BANKCODE              
                  AND CROSSREFERENCENO IN (SELECT CROSSNO              
                                           FROM   RECODUPS1)              
    END              
                  
  INSERT INTO BANKRECO              
             (CLTCODE,              
              BOOKDATE,              
              DESCRIPTION,              
              AMOUNT,              
              DRCR,              
              VALUEDATE,              
              REFERENCENO,              
              STATUSID,              
              STATUSNAME,              
              LOGINNAME,              
              CROSSREFERENCENO,              
              STATUS,              
              MICRNO,              
              DUMMY1,              
              DUMMY2)              
  SELECT B.CLTCODE,              
         B.BOOKDATE,              
         B.DESCRIPTION,              
         B.AMOUNT,              
         B.DRCR,              
         B.VALUEDATE,              
         B.REFERENCENO,              
         B.STATUSID,         
         B.STATUSNAME,           
         B.LOGINNAME,              
         B.CROSSREFERENCENO,              
         B.STATUS,              
         @@MICRNO,              
         '0',              
         '0'              
  FROM   #BANKRECOSAVE B              
                       
 INSERT INTO BANKRECO_LOG              
  SELECT B.CLTCODE,              
         B.BOOKDATE,              
         B.DESCRIPTION,              
         B.AMOUNT,              
         B.DRCR,              
         B.VALUEDATE,              
         B.REFERENCENO,              
         B.STATUSID,              
         B.STATUSNAME,              
         B.LOGINNAME,              
         B.CROSSREFERENCENO,              
         B.STATUS,              
         @@MICRNO,              
         '0',              
         '0',              
         0,              
         'AUTO',              
         GETDATE(),              
         'MATCHED'              
  FROM   #BANKRECOSAVE B              
  WHERE  B.STATUS = 'MATCHED'              
                                  
  INSERT INTO LEDGER1_BANKRECO_LOG              
  SELECT L1.*,              
         'AUTO',              
         GETDATE(),              
         'MATCHED'              
  FROM   LEDGER1 L1 WITH (NOLOCK),              
         (SELECT VTYP,              
                 BOOKTYPE,              
                 VNO              
          FROM   #BANKRECOSAVE              
          WHERE  VNO <> ''              
          UNION               
          SELECT VTYP,              
                 BOOKTYPE,              
                 VNO              
          FROM   #LEDGER_UPDATES_FOR_SLIPS              
          WHERE  VNO <> '') LU              
  WHERE  L1.VNO = LU.VNO              
         AND L1.VTYP = LU.VTYP              
         AND L1.BOOKTYPE = LU.BOOKTYPE              
                                         
  UPDATE RECOPROCESS              
  SET    INPROCESS = 'N'              
                                   
  COMMIT TRAN              
                
  SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ICICI_ALLBANKS
-- --------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_ICICI_ALLBANKS]
 @FILENAME VARCHAR(100),                        
 @UNAME VARCHAR(100),                        
 @BANKCODE VARCHAR(10),                        
 @STATUSID VARCHAR(10),                        
 @STATUSNAME VARCHAR(100),                  
 @BANK_TYPE VARCHAR(10),                  
 @STAT_TYPE VARCHAR(10),                  
 @LOGIN VARCHAR(10),                  
 @PWD VARCHAR(15),                  
 @PROCESS_STATUS BIT = 0                    
                    
                        
AS                        
                        
/*                      
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'                        
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'                        
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'                    
SELECT TOP 1 * FROM BANKRECO                    
*/                      
DECLARE                        
 @@SQL_QUERY AS VARCHAR(1000),                        
 @@CROSSREFERENCENO INT,                        
 @@TABLE_EXIST VARCHAR(20),                        
 @@RECORD_COUNT TINYINT,                        
 @@RECO_STATUS CHAR(1),                        
 @@FILE_EXIST INT,                        
 @@CLTCODE_EXIST INT,                        
 @@MICRNO VARCHAR(20)                        
                        
SET NOCOUNT ON                        
                        
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2                        
                        
IF @@CLTCODE_EXIST = 0                        
 BEGIN                        
  SELECT 'BANK CODE DOSE NOT EXIST.'                        
  RETURN                        
 END                        
                        
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2                        
                        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                        
DECLARE                        
 @@ERROR_COUNT SMALLINT,                    
 @@EXIST_COUNT_BEFORE SMALLINT,                    
 @@EXIST_COUNT_AFTER SMALLINT                    
SELECT                        
 @@ERROR_COUNT = COUNT(1)                        
FROM                        
 (                        
  SELECT                        
   U_FILENAME                        
  FROM                        
   V2_UPLOADED_FILES                        
  WHERE                        
   U_FILENAME = @FILENAME                        
   AND U_MODULE = 'HDFC_RECO UPLOAD'                        
 ) A                        
/*IF @@ERROR_COUNT > 0                        
BEGIN                        
 SELECT                        
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'                        
 RETURN                        
END       */                        
                        
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO                        
                  
CREATE TABLE #HDFCRECO                    
(                  
 BOOKDATE VARCHAR(11)                  
)                  
                  
CREATE TABLE #ICICIRECO                    
(                  
 SR_NO INT,                  
 TXN_ID VARCHAR(25),            
 VALUE_DATE VARCHAR(11),                  
 BOOKDATE VARCHAR(11)                  
)  

CREATE TABLE #BOIRECO      
(    
  TXN_ID VARCHAR(500)  
)    

                
                  
IF @BANK_TYPE = 'CITYRECO'                  
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"                  
END                  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'                   
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"                    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"          
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"                  
END                  
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'                  
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"                  
END                  
ELSE IF @BANK_TYPE = 'BOIRECO'     
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(4),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"    
    
END  
ELSE IF @BANK_TYPE = 'ICICIRECO'                   
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"                  
                  
END                  
                  
EXEC (@@SQL_QUERY)                  
                  
IF @BANK_TYPE = 'ICICIRECO' OR @BANK_TYPE = 'BOIRECO' 
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD REFERENCE_NO VARCHAR(20), [DESCRIPTION] VARCHAR(100), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"                  
                  
 EXEC (@@SQL_QUERY)                  
END                  
                  
CREATE TABLE [#BANKRECOSAVE_TEMP]                        
 (                        
  CLTCODE VARCHAR(10),                        
  BOOKDATE DATETIME,                        
  [DESCRIPTION] VARCHAR(50),                        
  AMOUNT VARCHAR(20),                        
  DRCR VARCHAR(1),                        
  VALUEDATE DATETIME,                        
  REFERENCENO VARCHAR(30),                        
  STATUSID VARCHAR(15),                        
  STATUSNAME VARCHAR(25),                        
  LOGINNAME VARCHAR(25),                        
  STATUS VARCHAR(9),                        
  MICRNO INT,                        
  DUMMY1 VARCHAR(15) ,                        
  DUMMY2 VARCHAR(15),                        
  AMOUNTLEDGR1 VARCHAR(20),                        
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL                        
 )                        
ON [PRIMARY]                        
                        
CREATE TABLE [#BANKRECOSAVE]                        
 (                        
	CLTCODE VARCHAR(10),                        
	BOOKDATE DATETIME,                        
	[DESCRIPTION] VARCHAR(50),                        
	AMOUNT MONEY,                        
	DRCR VARCHAR(1),                        
	VALUEDATE DATETIME,                        
	REFERENCENO VARCHAR(30),                        
	STATUSID VARCHAR(15),                        
	STATUSNAME VARCHAR(25),                        
	LOGINNAME VARCHAR(25),                        
	CROSSREFERENCENO [INT],                        
	STATUS VARCHAR(9),                        
	MICRNO INT,                        
	DUMMY1 VARCHAR(15) ,                        
	DUMMY2 VARCHAR(15),                        
	AMOUNTLEDGR1 MONEY,
    L1_SNO INT,               
    VTYP SMALLINT,               
    BOOKTYPE CHAR(2),               
    VNO VARCHAR(12),               
    SLIPNO INT                        
 )                        
ON [PRIMARY]                       
                  
CREATE TABLE #TESTIMPORT                                  
(                          
 OneRow Varchar(2000),                                
 SNO INT IDENTITY(1,1)                                
)                     

IF @BANK_TYPE = 'BOIRECO'    
BEGIN    
 SELECT @@SQL_QUERY = "BULK INSERT #BOIRECO FROM '" + @FILENAME + "' WITH (FIRSTROW = 2, ROWTERMINATOR = '\n', KEEPNULLS)"    
END                 
ELSE IF @BANK_TYPE = 'ICICIRECO'                  
BEGIN                  
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"                  
          
                   
END                  
ELSE IF @BANK_TYPE <> 'CANARARECO'                  
BEGIN                  
 SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"                  
          
END                  
                  
--PRINT @@SQL_QUERY          
EXEC (@@SQL_QUERY)                   
                  
                  
                  
                  
IF @BANK_TYPE = 'CITYRECO'                  
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"                  
END                  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'                   
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "                  
END                  
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'                  
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"                  
END            
ELSE IF @BANK_TYPE = 'BOIRECO'    
BEGIN    
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"    
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "    
END         
ELSE IF @BANK_TYPE = 'ICICIRECO'                  
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "                  
END                  
ELSE                  
BEGIN                  
 SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "                  
 SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "                  
END                  
                  
                  
EXEC (@@SQL_QUERY)                  
              
                  
IF @BANK_TYPE = 'ICICIRECO'                  
BEGIN                  
 INSERT INTO #HDFCRECO (BOOKDATE,[DESCRIPTION],REFERENCE_NO,DRCR,AMOUNT,RUNNING_BAL,VALUEDATE) SELECT BOOKDATE,[DESCRIPTION],REFERENCE_NO,DRCR,REPLACE(AMOUNT, ',', ''),RUNNING_BAL,VALUE_DATE FROM #ICICIRECO                  
          
END     

IF @BANK_TYPE = 'BOIRECO'    
BEGIN  
 INSERT INTO #HDFCRECO(BOOKDATE, [DESCRIPTION], REFERENCE_NO, DRCR, AMOUNT, RUNNING_BAL)   
 SELECT   
  SUBSTRING(TXN_ID, 1, 10),  
  SUBSTRING(TXN_ID, 11, 30),  
  LTRIM(RTRIM(SUBSTRING(TXN_ID, 42, 8))),  
  LEFT(LTRIM(SUBSTRING(TXN_ID, 50, 4)), 1),  
  REPLACE(SUBSTRING(TXN_ID, 55, 11), ',', ''),  
  SUBSTRING(TXN_ID, 67, 15)  
  FROM #BOIRECO  
END               
                  
SELECT * INTO HDFCRECO FROM #HDFCRECO                  
      
                  
IF @BANK_TYPE = 'CITYRECO'                  
BEGIN                  
 UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE                  
END                  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'                   
BEGIN                  
 UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END                  
          
END                  
ELSE IF @BANK_TYPE = 'ICICIRECO'                   
BEGIN                  
 UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END                  
END                  
              
ELSE IF @BANK_TYPE = 'BOIRECO'     
BEGIN    
 UPDATE HDFCRECO SET VALUEDATE = BOOKDATE
END    
 
                  
IF @BANK_TYPE = 'ICICIRECO'                  
BEGIN                  
 INSERT INTO #BANKRECOSAVE_TEMP                        
 SELECT                        
  @BANKCODE,                        
  BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),                        
          
  [DESCRIPTION],                        
  AMOUNT,                        
  DRCR,                        
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),                        
          
  REFERENCE_NO,                        
  @STATUSID,                  
  @STATUSNAME,                        
  @UNAME,                        
  'UNMATCHED',                        
  @@MICRNO,                        
  '',                        
  '',                        
  ''                        
 FROM                        
  HDFCRECO                    
                  
END 
ELSE IF @BANK_TYPE = 'BOIRECO'    
BEGIN    
 INSERT INTO #BANKRECOSAVE_TEMP          
 SELECT          
  @BANKCODE,          
  BOOKDATE = CONVERT(DATETIME,  (SUBSTRING(BOOKDATE, 4, 2) + '/' + LEFT(BOOKDATE, 2) + '/' + RIGHT(BOOKDATE,4)), 101),          
  [DESCRIPTION],          
  AMOUNT,          
  DRCR,          
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)) ,          
  REFERENCE_NO,          
  @STATUSID,          
  @STATUSNAME,          
  @UNAME,          
  'UNMATCHED',          
  @@MICRNO,          
  '',          
  '',          
  ''          
 FROM          
  HDFCRECO      
    
END                     
ELSE                  
BEGIN                  
 INSERT INTO #BANKRECOSAVE_TEMP                        
 SELECT                        
  @BANKCODE,                        
  BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),                        
          
  [DESCRIPTION],                        
  AMOUNT,                        
  DRCR,                        
  VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),                        
          
  REFERENCE_NO,                        
  @STATUSID,                 
  @STATUSNAME,                        
  @UNAME,                        
  'UNMATCHED',                        
  @@MICRNO,                        
  '',                        
  '',                        
  ''                        
 FROM                        
  HDFCRECO                    
END                  
                  
              
DROP TABLE HDFCRECO      

INSERT INTO #BANKRECOSAVE                        
SELECT                        
 @BANKCODE,                        
 BOOKDATE,                      
 [DESCRIPTION],                        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,                        
 DRCR,                        
 VALUEDATE,                        
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),                           
 @STATUSID,                        
 @STATUSNAME,                        
 @UNAME,                        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),                        
 'UNMATCHED',                        
 @@MICRNO,                        
 '',                        
 '',                        
 0, 0, 0, '', '', 0                        
FROM                        
 #BANKRECOSAVE_TEMP                        
WHERE                   
 REFERENCENO NOT LIKE '%[A-Z]%'                  
                  
INSERT INTO #BANKRECOSAVE                        
SELECT              
 @BANKCODE,                        
 BOOKDATE,                      
 [DESCRIPTION],                        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,                        
 DRCR,                        
 VALUEDATE,                        
 ISNULL(REFERENCENO, 0),                        
 @STATUSID,                        
 @STATUSNAME,                        
 @UNAME,                        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),                        
 'UNMATCHED',                        
 @@MICRNO,                        
 '',                        
 '',                        
 0, 0, 0, '', '', 0                        
FROM                        
 #BANKRECOSAVE_TEMP                        
WHERE                   
 REFERENCENO LIKE '%[A-Z]%'                  
           
INSERT INTO #BANKRECOSAVE                        
SELECT                        
 @BANKCODE,                        
 BOOKDATE,                      
 [DESCRIPTION],                        
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,                        
 DRCR,                        
 VALUEDATE,                        
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),                        
 @STATUSID,                        
 @STATUSNAME,                        
 @UNAME,                        
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),                        
 'UNMATCHED',                        
 @@MICRNO,                        
 '',                        
 '',                        
 0, 0, 0, '', '', 0                        
FROM                        
 #BANKRECOSAVE_TEMP                        
WHERE                   
 REFERENCENO IS NULL                  
          
                  
IF @BANK_TYPE = 'CANARARECO'                  
BEGIN                  
 UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)                   
END                  
              
/*********************** New code added to check the referenceno from description column *****************/              
              
SELECT VTYPE              
INTO   #VMAST              
FROM   VMAST WITH(NOLOCK)               
WHERE  VTYPE IN ('2','3','5','19',              
                 '20','17')   

SELECT 
	DDNO = PRADNYA.DBO.REMOVE_ZERO(DDNO,'0'),
	RELDT,
	RELAMT,
	REFNO,
	VTYP,
	VNO,
	LNO,
	DRCR,
	BOOKTYPE,
	MICRNO,
	SLIPNO,
	CLEAR_MODE,
	L1_SNO
INTO #LEDGER1_UP
FROM LEDGER1 L1
WHERE EXISTS (SELECT VTYPE              
               FROM   #VMAST              
               WHERE  L1.VTYP = VTYPE)  
	AND RELDT = ''
	AND LEN(DDNO) > 4 

           
                              
UPDATE #BANKRECOSAVE              
SET    STATUS = 'MATCHED',               
         L1_SNO = L11.L1_SNO,               
         VTYP = L11.VTYP,               
         BOOKTYPE = L11.BOOKTYPE,               
         VNO = L11.VNO                            
FROM   #LEDGER1_UP L11    
WHERE  UPPER(#BANKRECOSAVE.DRCR) = UPPER(L11.DRCR)              
       AND CHARINDEX(L11.DDNO,[DESCRIPTION]) > 0              
       AND CLTCODE = @BANKCODE              
       AND #BANKRECOSAVE.MICRNO = @@MICRNO              
       AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT)              
                                   FROM   #LEDGER1_UP L1 WITH (NOLOCK),              
                                          LEDGER L2 WITH (NOLOCK)              
                                   WHERE  L2.VNO = L1.VNO              
                                          AND L2.VTYP = L1.VTYP              
                                          AND L2.BOOKTYPE = L1.BOOKTYPE              
										  AND RELDT = ''              
                                          AND CLTCODE = @BANKCODE              
                                          AND CHARINDEX(L1.DDNO,#BANKRECOSAVE.[DESCRIPTION]) > 0              
                                          AND #BANKRECOSAVE.DRCR = L1.DRCR)              
       AND #BANKRECOSAVE.MICRNO = ISNULL(L11.MICRNO,0)              
       AND REFERENCENO = '0'      
       
        
              
/*********************** New code added to check the referenceno from description column *****************/              
                  
                  
/*CREATE TABLE #BANKRECOSAVE_DELETE                        
(                        
 [DESCRIPTION] VARCHAR(250),                        
 AMOUNT MONEY,                        
 DRCR CHAR(1),                        
 REFERENCENO VARCHAR(25),                        
CROSSREFERENCENO INT                     
) */                       
                    
DECLARE                     
@@AMOUNTDIFF MONEY,                    
@@STAMOUNTDIFF MONEY,                    
@@BOOKDATE_MIN DATETIME,                    
@@BOOKDATE_MAX DATETIME                    
                    
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE                     
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE                     
                    
                    
CREATE TABLE #RECODUPS                     
(                    
 BOOKDATE VARCHAR(11),                     
 REFERENCENO VARCHAR(25),                     
 AMOUNT MONEY,                     
 DESCRIPTION VARCHAR(200),                     
 STATUS VARCHAR(10),                     
 CROSSREFERENCENO INT                    
)                    
                    
SET @@EXIST_COUNT_BEFORE = 0                    
SET @@EXIST_COUNT_AFTER = 0                    
                    
DECLARE                     
@CLTCODE VARCHAR(10),                     
@BOOKDATE DATETIME,                     
@AMOUNT MONEY,           @DRCR CHAR(1),                     
@VALUEDATE DATETIME,                     
@REFERENCENO VARCHAR(20),                    
@DESCRIPTION VARCHAR(200)                    
                    
DECLARE CUR_CHECCK CURSOR FOR                    
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0                    
          
                    
OPEN CUR_CHECCK                    
                    
FETCH NEXT FROM CUR_CHECCK                    
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION                    
                    
WHILE @@FETCH_STATUS = 0                    
BEGIN                    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */                    
 IF @PROCESS_STATUS = 0                     
 BEGIN                    
  SELECT @@ERROR_COUNT = 0                    
                      
  SELECT                      
   @@EXIST_COUNT_BEFORE = COUNT(1)                    
  FROM                     
   BANKRECO                    
  WHERE    
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)                    
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')                    
                    
                    
                      
 /* IF @@ERROR_COUNT > 0                    
   BEGIN                    
    SELECT                      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS                    
          
    FROM                     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,                     
          
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B                    
    WHERE                    
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)                    
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO                    
                      
    RETURN                    
   END */                    
 END                    
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */                    
                    
                     
                         
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)                    
 FROM #BANKRECOSAVE                    
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0                        
          
                     
 DELETE BR FROM #BANKRECOSAVE BR                    
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO                    
                     
                     
 IF @PROCESS_STATUS = 0                     
 BEGIN                    
  SELECT                     
   @@EXIST_COUNT_AFTER = COUNT(1)                    
  FROM                     
   #BANKRECOSAVE                    
  WHERE                     
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR                     
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0                        
                      
                      
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER                    
   BEGIN                    
    INSERT INTO #RECODUPS                    
    SELECT                      
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO                    
          
    FROM                     
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR                    
          
    WHERE                    
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)                    
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')                    
                      
   END                     
  SET @@EXIST_COUNT_BEFORE = 0                    
  SET @@EXIST_COUNT_AFTER = 0                    
 END                     
 FETCH NEXT FROM CUR_CHECCK                    
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION                    
END                    
                    
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0                        
                    
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS                    
                    
IF @@ERROR_COUNT > 0                    
BEGIN                    
 SELECT * FROM #RECODUPS                    
 RETURN                    
END                    
                    
                    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */                    
DELETE BR FROM                      
 BANKRECO B, #BANKRECOSAVE BR                      
WHERE               
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))                      
          
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')        
           
                    
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL                    
                  
                    
IF @@ERROR_COUNT = 0                    
BEGIN                     
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'                     
 RETURN                    
END                    
                      
SELECT                     
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)                     
FROM                    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,                    
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1                    
                    
                    
IF @PROCESS_STATUS = 1                    
BEGIN                    
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))                    
 FROM                     
 (                    
  SELECT                     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)                    
  FROM                     
   BANKRECO                    
  WHERE                     
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE                    
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)                    
  UNION ALL                    
  SELECT                     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)                    
  FROM                     
   #BANKRECOSAVE                    
  WHERE                     
   VALUEDATE IS NOT NULL                    
                      
                      
 )B                    
END                     
ELSE                    
BEGIN                     
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))                    
 FROM                     
 (                    
  SELECT                     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)                    
  FROM                     
   BANKRECO                    
  WHERE                
  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE                    
  UNION ALL                    
  SELECT                     
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)                    
  FROM                     
   #BANKRECOSAVE                    
  WHERE                     
   VALUEDATE IS NOT NULL                    
                      
                      
 )B                    
END                    
                    
                    
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF                    
BEGIN                    
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'                    
 RETURN                    
END                    
                    
 DELETE FROM                     
  #BANKRECOSAVE                    
 WHERE                     
  VALUEDATE IS NULL                    
                    
                    
                    
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */                    
                        
SET @@TABLE_EXIST = ''                        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'                        
                        
IF @@TABLE_EXIST = ''                        
BEGIN                        
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))                     
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')                        
END                        
            SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS                        
                        
IF @@RECORD_COUNT = 0                        
BEGIN                        
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')                        
END                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS                        
                        
IF @@RECO_STATUS = 'N'                        
BEGIN                        
 BEGIN TRAN                        
 UPDATE RECOPROCESS SET INPROCESS = 'Y'                        
END                        
ELSE                        
BEGIN                        
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'                        
 RETURN                        
END                        
                        
SET @@TABLE_EXIST = ''                        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'                        
IF @@TABLE_EXIST <> ''                        
BEGIN                        
 DROP TABLE LEDGER_UPDATES                        
END                
                        
SET @@TABLE_EXIST = ''                        
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'                        
IF @@TABLE_EXIST <> ''                        
BEGIN                        
 DROP TABLE BANKRECOCOMP                        
END                        
                        
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)                        
                        
INSERT                        
INTO                        
 V2_UPLOADED_FILES                        
SELECT                        
 @FILENAME,                        
 @FILENAME,                        
 COUNT(1),                        
 'B',                        
 GETDATE(),                        
 @UNAME,                        
 'HDFC_RECO UPLOAD'                 
              
                     
  UPDATE LEDGER1 WITH (ROWLOCK)              
  SET    RELDT = VALUEDATE,              
         REFNO = #BANKRECOSAVE.CROSSREFERENCENO              
  FROM   #BANKRECOSAVE                
  WHERE  #BANKRECOSAVE.L1_SNO <> 0               
         AND LEDGER1.L1_SNO = #BANKRECOSAVE.L1_SNO                       
                        
IF @@ERROR <> 0                        
BEGIN                        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'                        
 ROLLBACK TRAN                        
 RETURN                        
END                        
                        
                        
SELECT                        
 SUM(RELAMT) AS AMOUNT,                        
 SLIPNO AS SLIPNO,                        
 UPPER(DRCR) AS DRCR,                        
 MICRNO                        
INTO                        
 BANKRECOCOMP                        
FROM                        
 LEDGER1                        
WHERE                        
 MICRNO = @@MICRNO                        
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )                        
 AND SLIPNO <>''                        
GROUP BY                        
 SLIPNO,                        
 DRCR,                        
 MICRNO                        
                        
                        
UPDATE                 
 #BANKRECOSAVE                        
SET                        
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'                        
FROM                        
 BANKRECOCOMP                        
WHERE                        
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)                        
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)                        
  AND #BANKRECOSAVE.MICRNO = @@MICRNO                        
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT                        
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO                        
  AND REFERENCENO  <> '0'                        
                        
IF @@ERROR <> 0                        
BEGIN                        
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'                        
 ROLLBACK TRAN                        
 RETURN                        
END                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO LEDGER_UPDATES                        
SELECT                        
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE                        
FROM                        
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)    WHERE                        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )                        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)                        
 AND RELDT = ''                        
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE                        
 AND LEDGER1.VNO = LEDGER.VNO                        
 AND LEDGER1.VTYP = LEDGER.VTYP                  
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE                        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE                        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)                  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'                        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)                        
          
                        
IF @@ERROR <> 0                        
BEGIN                        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'                        
 ROLLBACK TRAN                        
 RETURN                        
END                        
                        
                        
UPDATE                        
 LEDGER1                        
SET                        
 RELDT = VALUEDATE ,                        
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO            FROM                        
 #BANKRECOSAVE, LEDGER  (NOLOCK)                        
WHERE                        
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )                        
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)                        
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)                        
 AND RELDT = ''                        
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE                        
 AND #BANKRECOSAVE.MICRNO = @@MICRNO                        
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)                  
 AND #BANKRECOSAVE.REFERENCENO  <> '0'                        
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)                        
 AND LEDGER.VNO = LEDGER1.VNO                        
 AND LEDGER.VTYP = LEDGER1.VTYP                        
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE                        
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE                        
                        
IF @@ERROR <> 0           
BEGIN                        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'                        
 ROLLBACK TRAN                        
 RETURN                        
END                        
                        
UPDATE L              
  SET    EDT = (CASE               
                  WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),VDT,109))) THEN VDT              
                  ELSE VALUEDATE              
                END)              
  FROM   LEDGER L WITH (ROWLOCK),              
         (SELECT VTYP,              
                 BOOKTYPE,              
                 VNO,              
                 VALUEDATE              
          FROM   #BANKRECOSAVE              
          WHERE  VNO <> '') LU              
  WHERE  LU.VNO = L.VNO              
         AND LU.VTYP = L.VTYP              
         AND LU.BOOKTYPE = L.BOOKTYPE              
         AND EDT LIKE 'DEC 31 2049%'                      
                        
IF @@ERROR <> 0                        
BEGIN                        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'                        
 ROLLBACK TRAN                        
 RETURN                        
END                        
                        
                        
IF @@ERROR <> 0                        
BEGIN                        
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'                        
 ROLLBACK TRAN                        
 RETURN               
END                        
                        
IF @PROCESS_STATUS = 1                    
BEGIN                    
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)                    
END                                          
INSERT INTO                        
 BANKRECO (Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)                       
SELECT                        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,                        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'                        
FROM                        
 #BANKRECOSAVE B                      
                  
INSERT INTO                        
 BANKRECO_LOG (Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2,BR_SNo,Updated_by,Update_Dt,Reco_Status)                       
SELECT                        
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,                        
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0',0,'AUTO', GETDATE(), 'MATCHED'                   
FROM                        
 #BANKRECOSAVE B                      
WHERE                  
 B.STATUS = 'MATCHED'                  
                  
INSERT INTO LEDGER1_BANKRECO_LOG                  
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED'                   
FROM LEDGER1 L1, LEDGER_UPDATES LU                  
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE                  
                  
DROP TABLE BANKRECOCOMP                        
DROP TABLE LEDGER_UPDATES                      
                  
UPDATE RECOPROCESS SET INPROCESS = 'N'                        
                        
COMMIT TRAN                        
                        
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANK_FUNDS_REPORTING
-- --------------------------------------------------


--EXEC BANK_FUNDS_REPORTING 'APR  1 2018', 'NOV 27 2019'
CREATE PROCEDURE [dbo].[BANK_FUNDS_REPORTING]
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@BANK_CODE VARCHAR(10) = ''
AS

CREATE TABLE #LEDGER_PL
(
	VDT DATETIME,
	EDT DATETIME,
	LONG_NAME VARCHAR(100),
	BANK_ACC_NO VARCHAR(30),
	UCC_CODE VARCHAR(12),
	CLTCODE VARCHAR(10),
	CLIENT_PAN VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	PDT DATETIME,
	OPBAL MONEY,
	BANK_CODE VARCHAR(10)
)
CREATE INDEX [CLTCODE] ON [DBO].[#LEDGER_PL]([CLTCODE]) ON [PRIMARY]

CREATE CLUSTERED INDEX [LEDGER_PL] ON [DBO].[#LEDGER_PL]           
(          
 [CLTCODE] ASC, 
 [UCC_CODE],
 [LONG_NAME],   
 [VNO],
 [VTYP],
 [SETT_NO],
 [VDT],   
 [EDT],   
 [NARRATION]    
) 
CREATE TABLE #CLIENT_DETAILS
(
	UCC_CODE VARCHAR(30), 
	CL_CODE VARCHAR(10) PRIMARY KEY, 
	LONG_NAME VARCHAR(150), 
	PAN_GIR_NO VARCHAR(50)
)


-- CREATE CLIENT_DETAILS VIEW 

INSERT INTO #CLIENT_DETAILS
SELECT cltcode , cltcode , Longname, ''
FROM ACMAST WITH (NOLOCK) 
WHERE ACCAT IN (3,2)
AND cltcode NOT IN (SELECT CL_CODE FROM #CLIENT_DETAILS)

INSERT INTO #CLIENT_DETAILS
SELECT UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
FROM MSAJAG.dbo.VW_CLIENT_DETAILS_REPORTING 
WHERE CL_CODE NOT IN (SELECT CL_CODE FROM #CLIENT_DETAILS)

--INSERT INTO #CLIENT_DETAILS
--SELECT CL_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
--FROM MSAJAG..CLIENT1 WITH (NOLOCK)  
--WHERE CL_CODE NOT IN (SELECT CL_CODE FROM #CLIENT_DETAILS)

CREATE TABLE #LED_DATA
(
	VDT DATETIME, 
	EDT DATETIME, 
	CLTCODE VARCHAR(10), 
	NARRATION VARCHAR(500), 
	VNO VARCHAR(12), 
	DRCR CHAR(1), 
	VAMT MONEY, 
	VTYP INT, 
	BOOKTYPE VARCHAR(3),
	PDT DATETIME
)

INSERT INTO #LED_DATA
SELECT VDT, EDT, CLTCODE, NARRATION, VNO, DRCR, VAMT, VTYP, BOOKTYPE, PDT FROM LEDGER (NOLOCK) WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND VTYP <> 18



INSERT INTO #LEDGER_PL
SELECT
	VDT, EDT, LONG_NAME, ACCNO = '', UCC_CODE , CL_CODE, PAN_GIR_NO, NARRATION = L.NARRATION, L.VNO, SETT_NO = '', CHQ_NO = '',  
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN -VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, @EXCHANGE, @SEGMENT, L.VTYP, L.BOOKTYPE, PDT, OPBAL = 0, BANK_CODE = LL.CLTCODE
FROM
	#CLIENT_DETAILS C, (SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM #LED_DATA ) L, VMAST V, 
	--(SELECT CLTCODE = A.CLTCODE, VNO, VTYP, L2.BOOKTYPE FROM #LED_DATA L2 INNER JOIN ACMAST A WITH (NOLOCK) ON L2.CLTCODE = A.CLTCODE AND ACCAT = 2  WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59'  AND VTYP <> 18 AND A.CLTCODE = CASE WHEN @BANK_CODE <> '' THEN @BANK_CODE ELSE A.CLTCODE END) LL
	(SELECT CLTCODE, VNO, VTYP, BOOKTYPE FROM #LED_DATA L2  WHERE VTYP <> 18 AND CLTCODE = @BANK_CODE) LL
WHERE
	C.CL_CODE = L.CLTCODE
	AND L.VTYP = V.VTYPE
	AND L.VNO = LL.VNO AND L.VTYP = LL.VTYP AND L.BOOKTYPE = LL.BOOKTYPE
	AND L.CLTCODE <> LL.CLTCODE
ORDER BY L.CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT


INSERT INTO #LEDGER_PL
SELECT
	VDT, EDT, LONG_NAME, ACCNO = '', UCC_CODE , CL_CODE, PAN_GIR_NO, NARRATION = L.NARRATION, L.VNO, SETT_NO = '', CHQ_NO = '',  
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN -VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, @EXCHANGE, @SEGMENT, L.VTYP, L.BOOKTYPE, PDT, OPBAL = 0, BANK_CODE = LL.CLTCODE
FROM
	#CLIENT_DETAILS C, (SELECT CLTCODE = Party_code, VAMT = Amount, B.DRCR, NARRATION, B.VDT, EDT, PDT, B.VTYP, B.VNO, B.BOOKTYPE 
							FROM #LED_DATA A (NOLOCK)
								INNER JOIN MARGINLEDGER B WITH (NOLOCK)
								ON A.vno = B.vno  AND A.BookType= B.BookType AND A.vtyp = B.vtyp   AND B.VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' 
										AND B.VTYP <> 18 
								INNER JOIN ACMAST C WITH (NOLOCK)
								ON A.Cltcode = C.Cltcode AND accat = 2 ) L, VMAST V, 
	--(SELECT CLTCODE = A.CLTCODE, VNO, VTYP, L2.BOOKTYPE FROM #LED_DATA L2 WITH (NOLOCK), ACMAST A WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59'  AND VTYP <> 18 AND L2.CLTCODE = A.CLTCODE AND ACCAT = 2 AND A.CLTCODE = CASE WHEN @BANK_CODE <> '' THEN @BANK_CODE ELSE A.CLTCODE END) LL
	(SELECT CLTCODE, VNO, VTYP, BOOKTYPE FROM #LED_DATA L2  WHERE VTYP <> 18 AND CLTCODE = @BANK_CODE) LL
WHERE
	C.CL_CODE = L.CLTCODE
	AND L.VTYP = V.VTYPE
	AND L.VNO = LL.VNO AND L.VTYP = LL.VTYP AND L.BOOKTYPE = LL.BOOKTYPE
	AND L.CLTCODE <> LL.CLTCODE
ORDER BY L.CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT


UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1 
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

--UPDATE L SET L.BANK_ACC_NO = L1.ACCOUNT_NO FROM #LEDGER_PL L, Thirdparty_collection L1
--WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET BANK_ACC_NO = ACCNO FROM #LEDGER_PL L, MULTIBANKID L1
WHERE L.CLTCODE = L1.CLTCODE AND DEFAULTBANK = 1 
AND ISNULL(BANK_ACC_NO,'') = ''

DECLARE
	@SDTCUR  VARCHAR(11),  @LDTCUR  VARCHAR(11)
	
SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109) FROM PARAMETER WHERE @FR_DATE BETWEEN SDTCUR AND LDTCUR  
  
CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

CREATE CLUSTERED INDEX [OPBAL] ON [DBO].[#OPBAL]           
(          
 [CLTCODE] ASC 
   
) 
INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L WITH (NOLOCK)
	WHERE L.CLTCODE = @BANK_CODE AND L.VDT >= @SDTCUR AND VDT < @FR_DATE AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L WITH (NOLOCK)
	WHERE  L.CLTCODE = @BANK_CODE AND VDT >= @SDTCUR AND VDT <= @LDTCUR AND VTYP = 18  
	GROUP BY L.CLTCODE
) L
GROUP BY CLTCODE
/*
SELECT * FROM #OPBAL
WHERE CLTCODE = 'GB072'
*/
--UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O WHERE L.BANK_CODE = O.CLTCODE

INSERT INTO #LEDGER_PL
SELECT @FR_DATE, @FR_DATE, '', '', '', A.CLTCODE, '', NARRATION = 'Opening Balance', '', SETT_NO = '', CHQ_NO = '',  
		CASE WHEN A.OPBAL < 0 THEN A.OPBAL ELSE 0 END , -- DRAMOUNT
		CASE WHEN A.OPBAL >= 0 THEN A.OPBAL ELSE 0 END , -- CRAMOUNT, 
		 0, @EXCHANGE, @SEGMENT, 18, '', @FR_DATE, OPBAL = 0, A.CLTCODE
FROM #OPBAL A
		--INNER JOIN #CLIENT_DETAILS B
		--ON A.CLTCODE = B.CL_CODE

SELECT VDT,
	EDT,
	LONG_NAME,
	BANK_ACC_NO,
	UCC_CODE=CLTCODE,
	CLTCODE,
	CLIENT_PAN,
	NARRATION,
	VNO,
	VTYP,
	SETT_NO,
	CHQ_NO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT,
	BANK_CODE,
	EXCHANGE,
	SEGMENT
FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANK_FUNDS_REPORTING_MULTI_ACC
-- --------------------------------------------------




--EXEC BANK_FUNDS_REPORTING 'JUN  1 2022', 'JUN 30 2022','NSE','CAPITAL','04040'
CREATE PROCEDURE [dbo].[BANK_FUNDS_REPORTING_MULTI_ACC]
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@BANK_CODE VARCHAR(10) = '',
	@BANK_CODE_TO VARCHAR(10) = ''
AS

CREATE TABLE #LEDGER_PL
(
	VDT DATETIME,
	EDT DATETIME,
	LONG_NAME VARCHAR(100),
	BANK_ACC_NO VARCHAR(30),
	UCC_CODE VARCHAR(12),
	CLTCODE VARCHAR(10),
	CLIENT_PAN VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	PDT DATETIME,
	OPBAL MONEY,
	BANK_CODE VARCHAR(10)
)
CREATE INDEX [CLTCODE] ON [DBO].[#LEDGER_PL]([CLTCODE]) ON [PRIMARY]

CREATE CLUSTERED INDEX [LEDGER_PL] ON [DBO].[#LEDGER_PL]           
(          
 [CLTCODE] ASC, 
 [UCC_CODE],
 [LONG_NAME],   
 [VNO],
 [VTYP],
 [SETT_NO],
 [VDT],   
 [EDT],   
 [NARRATION]    
) 
CREATE TABLE #CLIENT_DETAILS
(
	UCC_CODE VARCHAR(30), 
	CL_CODE VARCHAR(10) PRIMARY KEY, 
	LONG_NAME VARCHAR(150), 
	PAN_GIR_NO VARCHAR(50)
)


-- CREATE CLIENT_DETAILS VIEW 



--INSERT INTO #CLIENT_DETAILS
--SELECT CL_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
--FROM MSAJAG..CLIENT1 WITH (NOLOCK)  
--WHERE CL_CODE NOT IN (SELECT CL_CODE FROM #CLIENT_DETAILS)

CREATE TABLE #LED_DATA
(
	VDT DATETIME, 
	EDT DATETIME, 
	CLTCODE VARCHAR(10), 
	NARRATION VARCHAR(500), 
	VNO VARCHAR(12), 
	DRCR CHAR(1), 
	VAMT MONEY, 
	VTYP INT, 
	BOOKTYPE VARCHAR(3),
	PDT DATETIME,
	BANK_CODE VARCHAR(10)
)

INSERT INTO #LED_DATA
SELECT VDT, EDT, L.CLTCODE, NARRATION, VNO, DRCR, VAMT, VTYP, L.BOOKTYPE, PDT FROM LEDGER (NOLOCK) L INNER JOIN ACMAST A ON  L.CLTCODE = A.CLTCODE AND ACCAT = 2
WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND VTYP NOT  IN (18,15,8,35,21) AND L.CLTCODE BETWEEN @BANK_CODE AND @BANK_CODE_TO


CREATE INDEX CLTCODE ON #LED_DATA(CLTCODE,VTYP,VNO,BOOKTYPE)
CREATE INDEX CLTCODE1 ON #LED_DATA(VNO,VTYP,BOOKTYPE)



SELECT l.VDT, l.EDT, l.CLTCODE, l.NARRATION, l.VNO, l.DRCR, l.VAMT, l.VTYP, l.BOOKTYPE, l.PDT into #TEMP FROM #LED_DATA S(NOLOCK),LEDGER  L (NOLOCK)
WHERE 
l.VDT >= @FR_DATE AND l.vdt<=@TO_DATE + ' 23:59' AND 
S.VNO=l.VNo
and S.vtyp =l.vtyp
and s.booktype=l.booktype
and L.CLTCODE <> BANK_CODE

INSERT INTO #LED_DATA
SELECT * FROM #TEMP


INSERT INTO #CLIENT_DETAILS
SELECT cltcode , cltcode , Longname, ''
FROM ACMAST WITH (NOLOCK) 
WHERE ACCAT IN (3,2) AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #LED_DATA (NOLOCK))
AND cltcode NOT IN (SELECT CL_CODE FROM #CLIENT_DETAILS)

INSERT INTO #CLIENT_DETAILS
SELECT UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
FROM MSAJAG.dbo.VW_CLIENT_DETAILS_REPORTING (NOLOCK)
WHERE CL_CODE NOT IN (SELECT CL_CODE FROM #CLIENT_DETAILS)
AND CL_CODE IN (SELECT DISTINCT CLTCODE FROM #LED_DATA (NOLOCK))



INSERT INTO #LEDGER_PL
SELECT
	VDT, EDT, LONG_NAME, ACCNO = '', UCC_CODE , CL_CODE, PAN_GIR_NO, NARRATION = L.NARRATION, L.VNO, SETT_NO = '', CHQ_NO = '',  
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN -VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, @EXCHANGE, @SEGMENT, L.VTYP, L.BOOKTYPE, PDT, OPBAL = 0, BANK_CODE = LL.CLTCODE
FROM
	#CLIENT_DETAILS C (NOLOCK), (SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM #LED_DATA (NOLOCK) ) L, VMAST V, 
	--(SELECT CLTCODE = A.CLTCODE, VNO, VTYP, L2.BOOKTYPE FROM #LED_DATA L2 INNER JOIN ACMAST A WITH (NOLOCK) ON L2.CLTCODE = A.CLTCODE AND ACCAT = 2  WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59'  AND VTYP <> 18 AND A.CLTCODE = CASE WHEN @BANK_CODE <> '' THEN @BANK_CODE ELSE A.CLTCODE END) LL
	(SELECT CLTCODE, VNO, VTYP, BOOKTYPE FROM #LED_DATA L2 (NOLOCK)  WHERE VTYP <> 18 /*AND CLTCODE = @BANK_CODE*/) LL
WHERE
	C.CL_CODE = L.CLTCODE
	AND L.VTYP = V.VTYPE
	AND L.VNO = LL.VNO AND L.VTYP = LL.VTYP AND L.BOOKTYPE = LL.BOOKTYPE
	AND L.CLTCODE <> LL.CLTCODE
ORDER BY L.CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT


INSERT INTO #LEDGER_PL
SELECT
	VDT, EDT, LONG_NAME, ACCNO = '', UCC_CODE , CL_CODE, PAN_GIR_NO, NARRATION = L.NARRATION, L.VNO, SETT_NO = '', CHQ_NO = '',  
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN -VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, @EXCHANGE, @SEGMENT, L.VTYP, L.BOOKTYPE, PDT, OPBAL = 0, BANK_CODE = LL.CLTCODE
FROM
	#CLIENT_DETAILS C (NOLOCK), (SELECT CLTCODE = Party_code, VAMT = Amount, B.DRCR, NARRATION, B.VDT, EDT, PDT, B.VTYP, B.VNO, B.BOOKTYPE 
							FROM #LED_DATA A (NOLOCK)
								INNER JOIN MARGINLEDGER B WITH (NOLOCK)
								ON A.vno = B.vno  AND A.vtyp = B.vtyp AND A.BookType= B.BookType   AND B.VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' 
										AND B.VTYP <> 18 
								INNER JOIN ACMAST C WITH (NOLOCK)
								ON A.Cltcode = C.Cltcode AND accat = 2 ) L, VMAST V, 
	--(SELECT CLTCODE = A.CLTCODE, VNO, VTYP, L2.BOOKTYPE FROM #LED_DATA L2 WITH (NOLOCK), ACMAST A WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59'  AND VTYP <> 18 AND L2.CLTCODE = A.CLTCODE AND ACCAT = 2 AND A.CLTCODE = CASE WHEN @BANK_CODE <> '' THEN @BANK_CODE ELSE A.CLTCODE END) LL
	(SELECT CLTCODE, VNO, VTYP, BOOKTYPE FROM #LED_DATA L2  WHERE VTYP <> 18 /*AND CLTCODE = @BANK_CODE*/) LL
WHERE
	C.CL_CODE = L.CLTCODE
	AND L.VTYP = V.VTYPE
	AND L.VNO = LL.VNO AND L.VTYP = LL.VTYP AND L.BOOKTYPE = LL.BOOKTYPE
	AND L.CLTCODE <> LL.CLTCODE
ORDER BY L.CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT


CREATE INDEX CLTCODE2 ON #LEDGER_PL(VNO,VTYP,BOOKTYPE)

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L (NOLOCK), LEDGER1 L1  (NOLOCK)
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L (NOLOCK), BILLPOSTED L1 (NOLOCK)
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

--UPDATE L SET L.BANK_ACC_NO = L1.ACCOUNT_NO FROM #LEDGER_PL L, Thirdparty_collection L1
--WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET BANK_ACC_NO = ACCNO FROM #LEDGER_PL L (NOLOCK), MULTIBANKID L1 (NOLOCK)
WHERE L.CLTCODE = L1.CLTCODE AND DEFAULTBANK = 1 
AND ISNULL(BANK_ACC_NO,'') = ''

UPDATE L SET BANK_ACC_NO = ACCOUNTNO FROM #LEDGER_PL L (NOLOCK), BANK_ACCOUNT_DETAILS L1 (NOLOCK)
WHERE L.CLTCODE = L1.BANKCODE
AND ISNULL(BANK_ACC_NO,'') = ''

DECLARE
	@SDTCUR  VARCHAR(11),  @LDTCUR  VARCHAR(11)

--SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @FR_DATE BETWEEN SDTCUR AND LDTCUR

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109) FROM PARAMETER WHERE @FR_DATE BETWEEN SDTCUR AND LDTCUR  
  
CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

CREATE CLUSTERED INDEX [OPBAL] ON [DBO].[#OPBAL]           
(          
 [CLTCODE] ASC 
   
) 
INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L WITH (NOLOCK)
	WHERE L.CLTCODE BETWEEN @BANK_CODE AND @BANK_CODE_TO AND L.VDT >= @SDTCUR AND VDT < @FR_DATE AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L WITH (NOLOCK)
	--WHERE  L.CLTCODE = @BANK_CODE AND VDT >= @SDTCUR AND VTYP = 18
	WHERE  L.CLTCODE BETWEEN @BANK_CODE AND @BANK_CODE_TO AND VDT >= @SDTCUR AND VDT <= @LDTCUR AND VTYP = 18  
	GROUP BY L.CLTCODE
) L
GROUP BY CLTCODE
/*
SELECT * FROM #OPBAL
WHERE CLTCODE = 'GB072'
*/
--UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O WHERE L.BANK_CODE = O.CLTCODE

INSERT INTO #LEDGER_PL
SELECT @FR_DATE, @FR_DATE, '', '', '', A.CLTCODE, '', NARRATION = 'Opening Balance', '', SETT_NO = '', CHQ_NO = '',  
		CASE WHEN A.OPBAL < 0 THEN A.OPBAL ELSE 0 END , -- DRAMOUNT
		CASE WHEN A.OPBAL >= 0 THEN A.OPBAL ELSE 0 END , -- CRAMOUNT, 
		 0, @EXCHANGE, @SEGMENT, 18, '', @FR_DATE, OPBAL = 0, A.CLTCODE
FROM #OPBAL A
		--INNER JOIN #CLIENT_DETAILS B
		--ON A.CLTCODE = B.CL_CODE

SELECT VDT,
	EDT,
	LONG_NAME,
	BANK_ACC_NO,
	UCC_CODE=CLTCODE,
	CLTCODE,
	CLIENT_PAN,
	NARRATION,
	VNO,
	VTYP,
	SETT_NO,
	CHQ_NO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT,
	BANK_CODE,
	EXCHANGE,
	SEGMENT
FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_YEAREND
-- --------------------------------------------------
CREATE PROCEDURE BR_YEAREND
 @SDTCUR VARCHAR(11),      
 @LDTCUR VARCHAR(11),      
 @VTYP   SMALLINT,      
 @VNO VARCHAR(12),      
 @BOOKTYPE CHAR(2),      
 @VDT    DATETIME,
 @PNLCODE VARCHAR(10)      
      
AS      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
      
DECLARE      
 @@MAINCTRLAC AS VARCHAR(10),      
 @@MAINACNAME AS VARCHAR(100),      
 @@MAINCOSTCODE AS INT,      
 @@LNO AS INT,      
 @@COSTCODE AS SMALLINT,      
 @@AMT AS MONEY,      
 @@RCURSOR AS CURSOR
  
    
      
SELECT       
 @@LNO =       
 (       
 SELECT       
  LNO       
 FROM LEDGER       
 WHERE VTYP = @VTYP       
  AND BOOKTYPE = @BOOKTYPE       
  AND VNO = @VNO       
  AND CLTCODE = @PNLCODE       
 )      
      
SELECT       
 @@MAINCTRLAC =       
 (       
 SELECT       
  MAINCONTROLAC       
 FROM BRANCHACCOUNTS       
 WHERE DEFAULTAC = 1      
 )      
      
SELECT @@MAINCOSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME IN(SELECT BRANCHNAME FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)      
      
SELECT       
 @@MAINACNAME =       
 (       
 SELECT       
  ACNAME       
 FROM ACMAST       
 WHERE CLTCODE = @@MAINCTRLAC       
 )    

TRUNCATE TABLE LEDGER_BRANCHBREAKUP

INSERT INTO LEDGER_BRANCHBREAKUP
SELECT VNO, VTYPE, BOOKTYPE, LNO, CLTCODE, CAMT, COSTCODE, DRCR 
FROM LEDGER2 L2 WITH (NOLOCK) WHERE CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE) 
AND EXISTS(SELECT VNO FROM LEDGER L WITH (NOLOCK) WHERE VDT > = @SDTCUR + ' 00:00:00'           
 AND VDT <= @LDTCUR + ' 23:59:59' AND L2.VTYPE = L.VTYP           
AND L2.BOOKTYPE = L.BOOKTYPE           
 AND L2.VNO = L.VNO           
 AND L2.LNO = L.LNO   )  
      
TRUNCATE TABLE BRANCHWISECLBAL 

INSERT INTO BRANCHWISECLBAL
SELECT   
 L2.CLTCODE,           
 A.ACNAME ,           
 COSTCODE,           
 BALANCE=SUM(           
 CASE           
  WHEN UPPER(L2.DRCR) = 'D'           
  THEN CAMT           
  ELSE -CAMT           
 END          
 )           
FROM LEDGER_BRANCHBREAKUP L2,           
 ACMAST A           
  
WHERE 
L2.CLTCODE = A.CLTCODE
 AND           
 (          
  A.ACTYP LIKE 'ASS%'           
  OR A.ACTYP LIKE 'LIAB%'          
 )           
          
GROUP BY COSTCODE,           
 L2.CLTCODE,           
 A.ACNAME        
      
/*
INSERT       
INTO BRANCHWISECLBAL       
SELECT       
 L2.CLTCODE,       
 A.ACNAME ,       
 COSTCODE,       
 BALANCE=SUM(       
 CASE       
  WHEN UPPER(L2.DRCR) = 'D'       
  THEN CAMT       
  ELSE -CAMT       
 END      
 )       
FROM LEDGER2 L2       
LEFT OUTER JOIN       
 ACMAST A       
 ON L2.CLTCODE = A.CLTCODE,       
 LEDGER L       
WHERE L2.VTYPE = L.VTYP       
 AND L2.BOOKTYPE = L.BOOKTYPE       
 AND L2.VNO = L.VNO       
 AND L2.LNO = L.LNO       
 AND L.VDT > = @SDTCUR + ' 00:00:00'       
 AND L.VDT <= @LDTCUR + ' 23:59:59'       
 AND       
 (      
  A.ACTYP LIKE 'ASS%'       
  OR A.ACTYP LIKE 'LIAB%'      
 )       
 AND L2.CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)       
GROUP BY COSTCODE,       
 L2.CLTCODE,       
 A.ACNAME
*/
INSERT       
  INTO BRANCHWISECLBAL       
	SELECT      
	  @@MAINCTRLAC,       
	  @@MAINACNAME,       
	  COSTCODE,      
	  -(SUM(BALANCE))
	 FROM      
	  BRANCHWISECLBAL      
	 GROUP BY      
	  COSTCODE 

    

/*      
SET @@RCURSOR = CURSOR FOR      
 SELECT      
  COSTCODE,      
  SUM(BALANCE)      
 FROM      
  BRANCHWISECLBAL      
 GROUP BY      
  COSTCODE      
      
OPEN @@RCURSOR      
 FETCH NEXT FROM      
  @@RCURSOR       
 INTO      
  @@COSTCODE,      
  @@AMT      
      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  INSERT       
  INTO BRANCHWISECLBAL VALUES      
   (       
    @@MAINCTRLAC,       
    @@MAINACNAME,       
    @@COSTCODE,       
    -(@@AMT)       
   )      
      
  FETCH NEXT FROM      
   @@RCURSOR       
  INTO      
   @@COSTCODE,      
   @@AMT      
 END      
      
CLOSE @@RCURSOR      
DEALLOCATE @@RCURSOR     
*/ 
      
INSERT       
INTO LEDGER2       
SELECT       
 L.VTYP,       
 L.VNO,       
 L.LNO,       
 (      
 CASE       
  WHEN (CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END) >= 0       
  THEN 'D'       
  ELSE 'C'       
 END      
 ),       
 ABS(CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END),       
 COSTCODE,       
 L.BOOKTYPE,       
 B.CLTCODE       
FROM LEDGER L,       
 BRANCHWISECLBAL B       
WHERE L.VTYP = @VTYP       
 AND L.BOOKTYPE = @BOOKTYPE       
 AND L.VNO = @VNO       
 AND L.CLTCODE = B.CLTCODE      
 AND L.CLTCODE NOT IN       
 (       
 SELECT       
  BRCONTROLAC       
 FROM BRANCHACCOUNTS       
 )      
      
INSERT       
INTO LEDGER2       
SELECT       
 @VTYP,       
 @VNO,       
 @@LNO,       
 (      
 CASE       
  WHEN BALANCE >= 0       
  THEN 'D'       
  ELSE 'C'       
 END      
 ),       
 ABS(BALANCE),       
 COSTCODE,       
 @BOOKTYPE,       
 CLTCODE       
FROM BRANCHWISECLBAL B       
WHERE CLTCODE IN       
 (       
 SELECT       
  BRCONTROLAC       
 FROM BRANCHACCOUNTS       
 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClosingBalance
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 05/10/2004 5:10:46 PM ******/  
  
/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 12/03/2002 4:11:29 PM ******/  
  
/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 06/05/2002 12:03:46 PM ******/  
/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 05/04/2002 12:57:05 PM ******/  
  
/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 05/02/2002 2:28:13 PM ******/  
/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 01/28/2002 3:46:43 PM ******/  
  
/****** Object:  Stored Procedure dbo.BrClosingBalance    Script Date: 01/24/2002 12:11:47 PM ******/  
/**************************************************************************************************************************************************************************************************  
THIS SP  IS USED TO FIND THE CLOSING BALANCE OF A PARTICULAR A/C CODE   
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
Copy of BrOpeningbalance with change in condition.  
  
Added two new parameters viz: @flag and @costcode.   
These are used to display the bank transactions either for all the branches or for a particular branch   
Depending on the @flag value   
If @flag = 0  then show bank transaction for all the branches  
If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )  
  
***************************************************************************************************************************************************************************************************/  
  
CREATE  Procedure BrClosingBalance  
@cltcode  varchar(10),  
@sdtcur  varchar(11),  
@fromdate varchar(11),  
@vdtedtflag tinyint,  
@flag   smallint,  
@costcode  smallint  
  
AS  
  
Declare  
@@openbaldt   varchar(11),  
@@openentry   money,  
@@openingbal   money,  
@@dramt   money,  
@@cramt   money,  
  
@@opendt    cursor,  
@@openbalcursor cursor  
  
  
  
If @vdtedtflag = 0  
begin  
 /*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */  
  
 if @flag = 0   
 begin  
  set @@opendt = cursor for  
  select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l  
  where vtyp = 18 and cltcode = @cltcode  
  and vdt < = @sdtcur    
  open @@opendt  
   fetch next from @@opendt into  @@openbaldt  
  while @@fetch_status = 0  
  begin  
     
   /*Find the amount of the opening entry for the client if present else set to 0 */  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openentry =0  
  
   set @@openbalcursor = cursor  for   
   select dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),  
   cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)  
   from ledger where vtyp = 18 and vdt like @@openbaldt + '%'  
       and cltcode = @cltcode group by drcr  
       open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
   while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openentry = @@dramt  
    end  
    if @@cramt <> 0   
    begin  
     select @@openentry = 0 - @@cramt  
    end     
     
    fetch next from @@openbalcursor into @@dramt,@@cramt   
   end  
     
   close @@openbalcursor  
   deallocate @@openbalcursor  
  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openingbal = 0  
     
     
   set @@openbalcursor = cursor for   
   select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0),   
   crtotal=isnull((case drcr when 'c' then sum(vamt) end),0)   
   from ledger where vdt > = @@openbaldt   
       and vdt < @fromdate+' 23:59:59'  and vtyp <> 18 and cltcode = @cltcode  
       group by drcr   
   open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
     
   while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openingbal = @@openingbal + @@dramt  
    end  
    if @@cramt <> 0   
    begin  
     select @@openingbal = @@openingbal - @@cramt  
    end  
     
    fetch next from @@openbalcursor into @@dramt,@@cramt       
   end  
     
   select @@openingbal = @@openingbal + @@openentry  
                                        Select @@Openingbal   
   close @@openbalcursor  
   deallocate @@openbalcursor  
  
   fetch next from @@opendt into  @@openbaldt  
  end   
  
  close @@opendt  
  deallocate @@opendt  
 end  
 /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/  
 else if @flag = 1    
 begin   
  set @@opendt = cursor for  
  select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l , ledger2 l2   
  where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno  and vtyp = 18  
   and l.cltcode = @cltcode and vdt < = @sdtcur   and costcode = @costcode  
  open @@opendt  
   fetch next from @@opendt into  @@openbaldt  
   
  while @@fetch_status = 0  
  begin  
   /*Find the amount of the opening entry for the client if present else set to 0 */  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openentry =0  
  
   set @@openbalcursor = cursor  for   
   select dramt = isnull((case when l.drcr = 'd' then sum(vamt) else 0 end),0),  
   cramt = isnull((case when l.drcr = 'c' then sum(vamt) else 0 end),0)  
   from ledger  l , ledger2 l2  
   where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno  and vtyp = 18   
   and vdt like @@openbaldt + '%'  and l.cltcode = @cltcode  and costcode = @costcode  
   group by l.drcr  
       open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
    
   while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openentry = @@dramt  
    end  
    if @@cramt <> 0   
    begin  
     select @@openentry = 0 - @@cramt  
    end     
     
    fetch next from @@openbalcursor into @@dramt,@@cramt   
   end  
   close @@openbalcursor  
   deallocate @@openbalcursor  
  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openingbal = 0  
  
   set @@openbalcursor = cursor for   
   select drtotal=isnull((case l.drcr when 'd' then sum(vamt) end),0),   
   crtotal=isnull((case l.drcr when 'c' then sum(vamt) end),0)   
   from ledger l,ledger2 l2  
   where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp <> 18   
   and vdt > = @@openbaldt   and vdt < @fromdate+' 23:59:59'  and l.cltcode = @cltcode and costcode = @costcode  
       group by l.drcr   
   open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
  
     while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openingbal = @@openingbal + @@dramt  
    end  
    if @@cramt <> 0   
    begin  
     select @@openingbal = @@openingbal - @@cramt  
    end  
     
    fetch next from @@openbalcursor into @@dramt,@@cramt       
   end  
  
   select @@openingbal = @@openingbal + @@openentry  
  
   close @@openbalcursor  
   deallocate @@openbalcursor  
  
   select @@openingbal  
   fetch next from @@opendt into  @@openbaldt  
  end   
  
  close @@opendt  
  deallocate @@opendt  
 end  
  
end  
else if @vdtedtflag = 1  
begin  
 /*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */  
  
 if @flag = 0   
 begin  
  set @@opendt = cursor for  
  select left(convert(varchar,isnull(min(vdt),0),109),11) from ledger  
  where cltcode = @cltcode and edt <= @sdtcur    
  open @@opendt  
   fetch next from @@opendt into  @@openbaldt  
    
  while @@fetch_status = 0  
  begin   
  
   /*Find the amount of the opening entry for the client if present else set to 0 */  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openentry =0  
     
   set @@openbalcursor = cursor  for   
   select  dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),  
   cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)  
   from ledger where vtyp = 18 and edt like @@openbaldt + '%'  
       and cltcode = @cltcode group by drcr  
       open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
     
   while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openentry = @@dramt  
    end  
    if @@cramt <> 0   
    begin  
     select @@openentry = 0 - @@cramt  
    end  
     
    fetch next from @@openbalcursor into @@dramt,@@cramt    
   end  
    
   close @@openbalcursor  
   deallocate @@openbalcursor  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openingbal = 0  
  
   set @@openbalcursor = cursor for   
   select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0),   
   crtotal=isnull((case drcr when 'c' then sum(vamt) end),0)   
   from ledger where vtyp <> '18' and edt < @fromdate +' 23:59:59'  
   and cltcode = @cltcode group by drcr   
  
   open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
     while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openingbal = @@openingbal + @@dramt  
    end  
    if @@cramt <> 0   
    begin   
     select @@openingbal = @@openingbal - @@cramt  
    end  
      
    fetch next from @@openbalcursor into @@dramt,@@cramt       
   end  
   select @@openingbal = @@openingbal + @@openentry  
  
   close @@openbalcursor  
   deallocate @@openbalcursor  
  
   select @@openingbal  
   fetch next from @@opendt into  @@openbaldt  
  end   
  close @@opendt  
  deallocate @@opendt  
  
 end   
 /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/  
 else if @flag = 1    
 begin   
  set @@opendt = cursor for  
  select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l ,ledger2 l2  
  where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp = 18   
  and l.cltcode = @cltcode and edt < = @sdtcur  and costcode = @costcode  
  open @@opendt  
   fetch next from @@opendt into  @@openbaldt  
    
  while @@fetch_status = 0  
  begin  
   /*Find the amount of the opening entry for the client if present else set to 0 */  
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openentry =0  
     
   set @@openbalcursor = cursor  for   
   select dramt = isnull((case when l.drcr = 'd' then sum(vamt) else 0 end),0),  
                cramt  = isnull((case when l.drcr = 'c' then sum(vamt) else 0 end),0)  
   from ledger l ,ledger2 l2  
    where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp = 18    
   and edt like @@openbaldt + '%' and l.cltcode = @cltcode and costcode = @costcode  
   group by l.drcr  
       open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
     
   while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openentry = @@dramt  
    end  
    if @@cramt <> 0   
    begin  
     select @@openentry = 0 - @@cramt  
    end  
     
    fetch next from @@openbalcursor into @@dramt,@@cramt    
   end  
    
   close @@openbalcursor  
   deallocate @@openbalcursor  
   
   select @@dramt = 0  
   select @@cramt = 0  
   select @@openingbal = 0  
  
   set @@openbalcursor = cursor for   
   select drtotal=isnull((case l.drcr when 'd' then sum(vamt) end),0),   
                crtotal=isnull((case l.drcr when 'c' then sum(vamt) end),0)   
   from ledger l,ledger2 l2  
   where  l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp <> 18  
   and edt > = @@openbaldt  and edt < @fromdate+' 23:59:59' and l.cltcode = @cltcode and costcode = @costcode  
   group by l.drcr   
   open @@openbalcursor  
    fetch next from @@openbalcursor into @@dramt,@@cramt  
     while @@fetch_status = 0  
   begin  
    if @@dramt <> 0    
    begin  
     select @@openingbal = @@openingbal + @@dramt  
    end  
    if @@cramt <> 0   
    begin   
     select @@openingbal = @@openingbal - @@cramt  
    end  
      
    fetch next from @@openbalcursor into @@dramt,@@cramt       
   end  
   select @@openingbal = @@openingbal + @@openentry  
  
   close @@openbalcursor  
   deallocate @@openbalcursor  
  
   select @@openingbal  
   fetch next from @@opendt into  @@openbaldt  
  end   
  close @@opendt  
  deallocate @@opendt  
 end   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bryearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 05/10/2004 5:29:30 PM ******/
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 03/27/2003 11:33:03 AM ******/
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 02/18/2003 10:26:56 AM ******/
CREATE Procedure Bryearend
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime

AS

set transaction isolation level read uncommitted


declare
@@mainctrlac as varchar(10),
@@mainacname as varchar(100),
@@lno        as int,
@@costcode   as tinyint,
@@amt        as money,
@@rcursor    as cursor


select @@lno = ( select lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '999999' )
select @@mainctrlac = ( select MainControlAc from branchaccounts where defaultac = 1)
select @@mainacname = ( select acname from acmast where cltcode = @@mainctrlac )

truncate table branchwiseclbal

insert into branchwiseclbal
select l2.cltcode, a.acname , costcode, balance=sum( case when upper(l2.drcr) = 'D' then camt else -camt end)
from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
and l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l2.cltcode not in (@@mainctrlac, '999999')
group by costcode, l2.cltcode, a.acname

set @@rcursor = cursor for
select costcode, sum(balance)
from branchwiseclbal
group by costcode

open @@rcursor
fetch next from @@rcursor 
into @@costcode, @@amt

while @@fetch_status = 0
begin
  insert into branchwiseclbal values( @@mainctrlac, @@mainacname, @@costcode, -(@@amt) )

  fetch next from @@rcursor 
  into @@costcode, @@amt
end

close @@rcursor
deallocate @@rcursor

insert into ledger2 
select l.vtyp, l.vno, l.lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, l.booktype, b.cltcode
from ledger l, branchwiseclbal b
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and l.cltcode = b.cltcode 

insert into ledger2 
select @vtyp, @vno, @@lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, @booktype, cltcode
from branchwiseclbal b
where cltcode in ( select brcontrolac from branchaccounts )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK
-- --------------------------------------------------
CREATE PROC [dbo].[BULKCOPYRECO_ALLBANK]  
 @FILENAME VARCHAR(200),                  
 @TABLE VARCHAR(50),  
 @BANK_TYPE VARCHAR(10),  
 @STAT_TYPE VARCHAR(10),  
 @LOGIN VARCHAR(10),  
 @PWD VARCHAR(15)  
    
AS                  
 DECLARE @@SQL AS VARCHAR(4000)                  
 DECLARE @@FNAME AS VARCHAR(200)                  
    
 SELECT @@FNAME = 'C:\TESTIMPORT.TXT'                  
 CREATE TABLE #TESTIMPORT                  
 (                  
 OneRow Varchar(2000),                
 SNO INT IDENTITY(1,1)                
 )                  
    
SET NOCOUNT ON                  
    
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"                
EXEC(@@SQL)       
  
IF @BANK_TYPE = 'ICICIRECO'   
BEGIN  
 DELETE FROM #TESTIMPORT WHERE SNO <= (SELECT SNO FROM #TESTIMPORT WHERE LEFT(ONEROW, 8) = 'TXN_DATE')  
END  
  
DELETE FROM #TESTIMPORT WHERE SNO = 1                
    
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL                  
    
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)                  
    
SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT                  
  
DROP TABLE #TESTIMPORT                  
    
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1    
  
DROP TABLE #TESTIMPORT1                  
  
SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "', no_output"  
EXEC (@@SQL)  
  
DROP TABLE TESTIMPORT  
  
IF @BANK_TYPE = 'CITYRECO'  
BEGIN  
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ';', KEEPNULLS)"  
END  
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB'  
BEGIN  
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"  
 SELECT @@SQL = @@SQL + "DELETE FROM " + @TABLE + " WHERE (CREDIT IS NULL AND DEBIT IS NULL AND RUNNING_BAL IS NULL)"  
END  
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV') OR @BANK_TYPE = 'UTIRECO'   
BEGIN  
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"  
END  
ELSE IF @BANK_TYPE = 'ICICIRECO'   
BEGIN  
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"  
END  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATEBS
-- --------------------------------------------------
/*-----------------------------
sp_helptext calculatebs
-----------------------------*/
--Text
CREATE  PROC CALCULATEBS  
@FROMDATE VARCHAR(11),      
@TODATE VARCHAR(11),      
@BRANCHCD VARCHAR(20),      
@SHOWZERO VARCHAR(1) = 'N'      
    
AS      
    
BEGIN      
    
SET NOCOUNT ON      
    
DELETE FROM PLGROUP_MSTR       
    
/*FOR GROUP DETAILS*/      
INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)       
SELECT GROUP_CODE=LTRIM(RTRIM(GRPCODE)),GROUP_NAME=LTRIM(RTRIM(GRPNAME)),      
MAIN_GROUP=CASE WHEN LTRIM(RTRIM(GRPCODE)) = GRPMAIN THEN '' ELSE LTRIM(RTRIM(GRPMAIN)) END,AMOUNT=0,TYPE='G'      
FROM GRPMAST WHERE (GRPMAIN LIKE 'L%' OR GRPMAIN LIKE 'A%')      
/*FOR GROUP DETAILS*/      
    
/*FOR ACCOUNT DETAILS*/      
IF LTRIM(RTRIM(@BRANCHCD)) = ''      
BEGIN      
 -- FOR HO      
 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)       
 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(L.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(GRPCODE)),      
 AMOUNT= SUM(CASE WHEN DRCR = 'C' THEN VAMT * -1 ELSE VAMT END),TYPE='A'      
 FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE      
 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)       
 AND L.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')      
 GROUP BY L.CLTCODE,L.ACNAME,GRPCODE      
END      
    
ELSE      
BEGIN      
 -- FOR BRANCHES      
 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)       
 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(A.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(A.GRPCODE)),      
 AMOUNT= SUM(CASE WHEN L.DRCR = 'C' THEN CAMT * -1 ELSE CAMT END),TYPE='A'      
 FROM LEDGER2 L       
 LEFT OUTER JOIN LEDGER L1 ON L1.VTYP = L.VTYPE AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L1.LNO = L.LNO AND L1.CLTCODE = L.CLTCODE      
 LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE      
 LEFT OUTER JOIN COSTMAST M ON L.COSTCODE = M.COSTCODE      
 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)       
 AND L1.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L1.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')      
 AND M.COSTNAME = @BRANCHCD      
 GROUP BY L.CLTCODE,A.ACNAME,A.GRPCODE      
END      
    
SELECT *,RECLEVEL = DBO.GETGROUPLEVELS(GROUP_CODE)       
INTO #TMPPL       
FROM PLGROUP_MSTR      
ORDER BY RECLEVEL,GROUP_CODE      

DECLARE @@GROUPCODE VARCHAR(20),      
@@RECLEVEL INT      
    
DECLARE RSCURSOR  CURSOR FOR      
SELECT DISTINCT GROUP_CODE,RECLEVEL      
FROM #TMPPL       
WHERE TYPE = 'G'      
ORDER BY RECLEVEL DESC      
OPEN RSCURSOR        
FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL       
WHILE @@FETCH_STATUS = 0      
BEGIN      
 UPDATE #TMPPL SET AMOUNT = ISNULL((SELECT SUM(AMOUNT) FROM #TMPPL T1 WHERE  T1.MAIN_GROUP = @@GROUPCODE),0)      
 FROM #TMPPL T WHERE TYPE = 'G' AND GROUP_CODE = @@GROUPCODE      
 FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL       
END      
    
CLOSE RSCURSOR      
DEALLOCATE RSCURSOR      
    
IF @SHOWZERO = 'Y'      
BEGIN      
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,      
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL       
 FROM #TMPPL ORDER BY RECLEVEL ASC       
END      
    
ELSE      
BEGIN      
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,      
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL       
 FROM #TMPPL TM WHERE 
 AMOUNT <> 0 AND NOT EXISTS (SELECT * FROM ACMAST AC WHERE ACCAT=4 AND TM.GROUP_CODE=AC.CLTCODE)
ORDER BY RECLEVEL ASC       
END      


    
DROP TABLE #TMPPL       
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalculateBS_all
-- --------------------------------------------------
--Exec CalculateBS_all  'Apr  1 2007','Aug  6 2007','', 'Y'  
  
CREATE PROC [dbo].[CalculateBS_all]     
@FROMDATE VARCHAR(11),    
@TODATE VARCHAR(11),    
@BRANCHCD VARCHAR(20),    
@SHOWZERO VARCHAR(1) = 'N'    
  
AS    
  
BEGIN    
  
CREATE TABLE [dbo].[#tmpBS] (    
 [Group_Code] [varchar] (13) NULL ,   
 [Group_NAME] [varchar] (60) NULL ,  
 [MAIN_GROUP] [varchar] (13) NULL ,  
 [AMOUNT] [Numeric] (18,4) NULL ,    
 [TYPE] [char] (1),  
 [RECLEVEl] [bigint] NULL ,  
 [Segment] [varchar] (4) NULL,    
   [Entity] [varchar] (50) NULL,    
   [orderSeg][bigint] NULL   
)   
  
  
INSERT INTO #tmpBS(Group_Code,Group_Name,Main_group,amount,Type,Reclevel)    
Exec ACCOUNT.DBO.CalculateBS @FROMDATE,  @TODATE,@BRANCHCD ,  @SHOWZERO   
    
UPDATE #tmpBS set Segment='NSE',Entity='CAPITAL - NSE', orderSeg = 1 where Segment is NULL    
  
INSERT INTO #tmpBS(Group_Code,Group_Name,Main_group,amount,Type,Reclevel)    
Exec ACCOUNTBSE.DBO.CalculateBS @FROMDATE,  @TODATE,@BRANCHCD ,  @SHOWZERO   
    
UPDATE #tmpBS set Segment='BSE',Entity='CAPITAL - BSE', orderSeg = 2 where Segment is NULL    
  
INSERT INTO #tmpBS(Group_Code,Group_Name,Main_group,amount,Type,Reclevel)    
Exec ACCOUNTFO.DBO.CalculateBS @FROMDATE,  @TODATE,@BRANCHCD ,  @SHOWZERO   
    
UPDATE #tmpBS set Segment='NFO',Entity='DERIVATIVES - NSE', orderSeg = 3 where Segment is NULL    
  
  
--Select * from #tmpBS order by reclevel,orderseg,group_code  
  
--Select group_code,group_name,sum(Amount) from #tmpBS where main_group = ' ' and reclevel = 1 and type = 'G' group by group_code,group_name  
  
  
CREATE TABLE [dbo].[#tmpBS1] (    
 [Group_Code] [varchar] (13) NULL ,   
 [Group_NAME] [varchar] (60) NULL ,  
 [MAIN_GROUP] [varchar] (13) NULL ,  
 [AMOUNT] [Numeric] (18,4) NULL ,    
 [TYPE] [char] (1),  
 [RECLEVEl] [bigint] NULL ,  
 [Segment] [varchar] (4) NULL,    
   [Entity] [varchar] (50) NULL,    
   [orderSeg][bigint] NULL   
)   
  
Insert  into #tmpBS1 (group_code,group_name,Amount)  Select group_code,group_name,sum(Amount) from #tmpBS where main_group = ' ' and reclevel = 1 and type = 'G' group by group_code,group_name  
Update  #tmpBS1 set type = 'G',main_group = ' ',orderseg = 0 ,reclevel = 1  
Insert into #tmpBS1  Select * from #tmpBS where main_group <> ''  
--Select * from #tmpBS1 order by reclevel,group_code  
--update  #tmpBS1 set segment='',entity='' where segment is null  
Select * from #tmpBS1 order by reclevel,group_code  
  
  
  
Drop table #tmpBS  
  
Drop table #tmpBS1  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalculatePL
-- --------------------------------------------------
--Exec CalculatePL 'apr  1 2007','mar 28 2008','', 'Y'

CREATE PROC CALCULATEPL     
@FROMDATE VARCHAR(11),    
@TODATE VARCHAR(11),    
@BRANCHCD VARCHAR(20),    
@SHOWZERO VARCHAR(1) = 'N'    
  
AS    
  
BEGIN    
  
SET NOCOUNT ON    
BEGIN TRANSACTION    
  
DELETE FROM PLGROUP_MSTR     
  
/*FOR GROUP DETAILS*/    
INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
SELECT GROUP_CODE=LTRIM(RTRIM(GRPCODE)),GROUP_NAME=LTRIM(RTRIM(GRPNAME)),    
MAIN_GROUP=CASE WHEN LTRIM(RTRIM(GRPCODE)) = GRPMAIN THEN '' ELSE LTRIM(RTRIM(GRPMAIN)) END,AMOUNT=0,TYPE='G'    
FROM GRPMAST WHERE (GRPMAIN LIKE 'X%' OR GRPMAIN LIKE 'N%')    
/*FOR GROUP DETAILS*/    
  
/*FOR ACCOUNT DETAILS*/    
IF LTRIM(RTRIM(@BRANCHCD)) = ''    
BEGIN    
	 -- FOR HO    
	 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
	 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(A.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(GRPCODE)),    
	 AMOUNT= SUM(CASE WHEN DRCR = 'C' THEN VAMT * -1 ELSE VAMT END),TYPE='A'    
	 FROM LEDGER L /*LEFT OUTER*/ INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
	 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)     
	 AND L.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')    
	 GROUP BY L.CLTCODE,A.ACNAME,GRPCODE    
END    
  
ELSE    
BEGIN    
	 -- FOR BRANCHES    
	 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
	 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(A.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(A.GRPCODE)),    
	 AMOUNT= SUM(CASE WHEN L.DRCR = 'C' THEN CAMT * -1 ELSE CAMT END),TYPE='A'    
	 FROM LEDGER2 L     
	 LEFT OUTER JOIN LEDGER L1 ON L1.VTYP = L.VTYPE AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L1.LNO = L.LNO AND L1.CLTCODE = L.CLTCODE    
	 LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
	 LEFT OUTER JOIN COSTMAST M ON L.COSTCODE = M.COSTCODE    
	 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)     
	 AND L1.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L1.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')    
	 AND M.COSTNAME = @BRANCHCD    
	 GROUP BY L.CLTCODE,A.ACNAME,A.GRPCODE    
END    
  

SELECT *,RECLEVEL = DBO.GETGROUPLEVELS(GROUP_CODE)     
INTO #TMPPL     
FROM PLGROUP_MSTR    
ORDER BY RECLEVEL,GROUP_CODE    
  
COMMIT TRANSACTION    
DECLARE @@GROUPCODE VARCHAR(20),    
@@RECLEVEL INT    
  
DECLARE RSCURSOR  CURSOR FOR    
SELECT DISTINCT GROUP_CODE,RECLEVEL    
FROM #TMPPL     
WHERE TYPE = 'G'    
ORDER BY RECLEVEL DESC    
OPEN RSCURSOR      
FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL     
WHILE @@FETCH_STATUS = 0    
BEGIN    
 UPDATE #TMPPL SET AMOUNT = ISNULL((SELECT SUM(AMOUNT) FROM #TMPPL T1 WHERE  T1.MAIN_GROUP = @@GROUPCODE),0)    
 FROM #TMPPL T WHERE TYPE = 'G' AND GROUP_CODE = @@GROUPCODE    
 FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL     
END    
  
CLOSE RSCURSOR    
DEALLOCATE RSCURSOR    
  


IF @SHOWZERO = 'Y'    
BEGIN    
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,    
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL     
 FROM #TMPPL ORDER BY RECLEVEL ASC     
END    
  
ELSE    
BEGIN    
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,    
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL     
 FROM #TMPPL WHERE AMOUNT <> 0 ORDER BY RECLEVEL ASC     
END    
  
DROP TABLE #TMPPL     
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalculatePL_all
-- --------------------------------------------------
--Exec CalculatePL_all  'Apr  1 2007','Aug  6 2007','', 'Y'


CREATE PROC [dbo].[CalculatePL_all]   
@FROMDATE VARCHAR(11),  
@TODATE VARCHAR(11),  
@BRANCHCD VARCHAR(20),  
@SHOWZERO VARCHAR(1) = 'N'  

AS  

BEGIN  

CREATE TABLE [dbo].[#tmpPnL] (  
	[Group_Code] [varchar] (13) NULL , 
	[Group_NAME] [varchar] (60) NULL ,
	[MAIN_GROUP] [varchar] (13) NULL ,
	[AMOUNT] [Numeric] (18,4) NULL ,  
	[TYPE] [char] (1),
	[RECLEVEl] [bigint] NULL ,
	[Segment] [varchar] (4) NULL,  
  	[Entity] [varchar] (50) NULL,  
  	[orderSeg][bigint] NULL 
) 


INSERT INTO #tmpPnL(Group_Code,Group_Name,Main_group,amount,Type,Reclevel)  
Exec ACCOUNT.DBO.CalculatePL @FROMDATE,  @TODATE,@BRANCHCD ,  @SHOWZERO 
  
UPDATE #tmpPnL set Segment='NSE',Entity='CAPITAL - NSE', orderSeg = 1 where Segment is NULL  

INSERT INTO #tmpPnL(Group_Code,Group_Name,Main_group,amount,Type,Reclevel)  
Exec ACCOUNTBSE.DBO.CalculatePL @FROMDATE,  @TODATE,@BRANCHCD ,  @SHOWZERO 
  
UPDATE #tmpPnL set Segment='BSE',Entity='CAPITAL - BSE', orderSeg = 2 where Segment is NULL  

INSERT INTO #tmpPnL(Group_Code,Group_Name,Main_group,amount,Type,Reclevel)  
Exec ACCOUNTFO.DBO.CalculatePL @FROMDATE,  @TODATE,@BRANCHCD ,  @SHOWZERO 
  
UPDATE #tmpPnL set Segment='NFO',Entity='DERIVATIVES - NSE', orderSeg = 3 where Segment is NULL  


--Select * from #tmpPnl order by reclevel,orderseg,group_code

--Select group_code,group_name,sum(Amount) from #tmpPnl where main_group = ' ' and reclevel = 1 and type = 'G' group by group_code,group_name


CREATE TABLE [dbo].[#tmpPnL1] (  
	[Group_Code] [varchar] (13) NULL , 
	[Group_NAME] [varchar] (60) NULL ,
	[MAIN_GROUP] [varchar] (13) NULL ,
	[AMOUNT] [Numeric] (18,4) NULL ,  
	[TYPE] [char] (1),
	[RECLEVEl] [bigint] NULL ,
	[Segment] [varchar] (4) NULL,  
  	[Entity] [varchar] (50) NULL,  
  	[orderSeg][bigint] NULL 
) 

Insert  into #tmpPnl1 (group_code,group_name,Amount)  Select group_code,group_name,sum(Amount) from #tmpPnl where main_group = ' ' and reclevel = 1 and type = 'G' group by group_code,group_name
Update  #tmpPnl1 set type = 'G',main_group = ' ',orderseg = 0 ,reclevel = 1
Insert into #tmpPnl1  Select * from #tmpPnl where main_group <> ''
Select * from #tmpPnl1 order by reclevel,orderseg,group_code




Drop table #tmppnl

Drop table #tmppnl1

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CASHUPLOAD
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CASHUPLOAD]
 @CASHCODE VARCHAR(10),
 @FNAME VARCHAR(100),          
 @UNAME VARCHAR(25),          
 @USERCAT INT  
AS
--EXEC CASHUPLOAD 'CASH01', 'E:\BACKOFFICE\CASHFILES\Test12.CSV', 'SYSTEM', 388
SET NOCOUNT ON 

DECLARE  
	@@ERROR_COUNT INT,
	@@SQL AS VARCHAR(2000)          

/*SELECT @@ERROR_COUNT = COUNT(1)
FROM   (SELECT U_FILENAME
        FROM   V2_UPLOADED_FILES
        WHERE  U_FILENAME = @FNAME
               AND U_MODULE = 'CASH UPLOAD') A

IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.',
           @FNAME,
           'NA'
    
    RETURN
  END
*/
BEGIN TRAN

CREATE TABLE #RECPAY_TABLE_TMP (
  EDATE        VARCHAR(20),
  VOUCHER_DATE VARCHAR(20),
  CLIENT_CODE  VARCHAR(50),
  AMOUNT       MONEY,
  DRCR         VARCHAR(1),
  NARRATION    VARCHAR(234),
  SERIAL_NO    INT)

CREATE TABLE [#RECPAY_TABLE] (
  EDATE        VARCHAR(20),
  VOUCHER_DATE VARCHAR(20),
  CLIENT_CODE  VARCHAR(50),
  AMOUNT       MONEY,
  DRCR         VARCHAR(1),
  NARRATION    VARCHAR(234),
  SERIAL_NO    INT,
  SNO          INT   IDENTITY ( 1,1 )   NOT NULL,
  BRANCHCODE   VARCHAR(10)   NULL,
  VDT          DATETIME   NULL,
  FYSTART      DATETIME   NULL,
  FYEND        DATETIME   NULL,
  UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),
  EDT          DATETIME   NULL,
  VNO          VARCHAR(12)   NULL,
  VTYP         SMALLINT   NULL,
  ACNAME       VARCHAR(100)   NULL,
  COSTCODE     SMALLINT   NULL,
  CASHBRANCH   VARCHAR(100)   NULL,
  CASHCOST     SMALLINT   NULL,
  LNO          SMALLINT   NOT NULL   DEFAULT (0))
ON [PRIMARY]

SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH ( FIELDTERMINATOR = ',', FIRSTROW = 2 )"
EXEC(@@SQL)          
 
INSERT INTO V2_UPLOADED_FILES
SELECT @FNAME,
       @FNAME,
       COUNT(1),
       'B',
       GETDATE(),
       @UNAME,
       'CASH UPLOAD'

INSERT INTO #RECPAY_TABLE
           (EDATE,
            VOUCHER_DATE,
            CLIENT_CODE,
            AMOUNT,
            DRCR,
            NARRATION,
            SERIAL_NO)
SELECT EDATE,
       VOUCHER_DATE,
       UPPER(CLIENT_CODE),
       AMOUNT,
       UPPER(DRCR),
       NARRATION,
       SERIAL_NO
FROM   #RECPAY_TABLE_TMP

UPDATE #RECPAY_TABLE
SET    BRANCHCODE = A.BRANCHCODE,
       VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
       EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
       FYSTART = P.SDTCUR,
       FYEND = P.LDTCUR,
       UPDFLAG = 'Y',
       ACNAME = LONGNAME,
       COSTCODE = C.COSTCODE
FROM   ACMAST A,
       PARAMETER P,
       COSTMAST C
WHERE  A.CLTCODE = CLIENT_CODE
       AND P.CURYEAR = 1
       AND ACCAT IN ('3','4')
       AND A.BRANCHCODE = COSTNAME
       AND A.BRANCHCODE <> 'ALL'

UPDATE #RECPAY_TABLE
SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
       EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
       FYSTART = P.SDTCUR,
       FYEND = P.LDTCUR,
       UPDFLAG = 'Y',
       ACNAME = LONGNAME,
       COSTCODE = (SELECT TOP 1 COSTCODE
                   FROM   COSTMAST
                   WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE)
FROM   ACMAST A,
       PARAMETER P
WHERE  A.CLTCODE = CLIENT_CODE
       AND P.CURYEAR = 1
       AND ACCAT IN ('3','4')
       AND A.BRANCHCODE = 'ALL'
       AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'

UPDATE #RECPAY_TABLE
SET    BRANCHCODE = 'HO',
       VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
       EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
       FYSTART = P.SDTCUR,
       FYEND = P.LDTCUR,
       UPDFLAG = 'Y',
       ACNAME = LONGNAME,
       COSTCODE = (SELECT TOP 1 COSTCODE
                   FROM   COSTMAST
                   WHERE  COSTNAME = 'HO')
FROM   ACMAST A,
       PARAMETER P
WHERE  A.CLTCODE = CLIENT_CODE
       AND P.CURYEAR = 1
       AND ACCAT IN ('3','4')
       AND A.BRANCHCODE = 'ALL'
       AND #RECPAY_TABLE.BRANCHCODE = 'ALL' 

/*--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/

DECLARE  @@STD_DATE        VARCHAR(11),
         @@LST_DATE        VARCHAR(11),
         @@VNOMETHOD       INT,
         @@ACNAME          CHAR(100),
         @@BOOKTYPE        CHAR(2),
         @@MICRNO          VARCHAR(10),
         @@DRCR            VARCHAR(1),
         @@CASHBRNCOUNT    TINYINT,
         @@BACKDATE        DATETIME,
         @@BACKDAYS        SMALLINT,
         @@MonthlyVdt      VARCHAR(11),
         @@VTYP            SMALLINT,
         @@SERIAL_NO       INT,
         @@COSTCODECOUNT   TINYINT,
         @@COSTCODEUPDATES CURSOR 

/*--------------------------VALIDATION FOR EXISTANCE AND TYPE OF CASH ACCOUNT ------------------------*/

SELECT @@ERROR_COUNT = COUNT(1)
FROM   ACMAST
WHERE  CLTCODE = @CASHCODE
       AND ACCAT = 1

IF @@ERROR_COUNT = 0
  BEGIN
    SELECT 'INVALID CASH ACCOUNT SELECTED',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END 

/*--------------------------GET BANK CODE DETAILS ------------------------*/

SELECT @@ACNAME = ACNAME,
       @@BOOKTYPE = ISNULL(BOOKTYPE,'01')
FROM   ACMAST
WHERE  CLTCODE = @CASHCODE
       AND ACCAT = '1' 

/*--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/

SELECT @@ERROR_COUNT = COUNT(1)
FROM   (SELECT DISTINCT DRCR
        FROM   #RECPAY_TABLE) A

IF @@ERROR_COUNT > 1
  BEGIN
    SELECT 'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END
ELSE
  BEGIN
    SELECT TOP 1 @@DRCR = DRCR,
                 @@VTYP = (CASE 
                             WHEN DRCR = 'D' THEN 4
                             ELSE 1
                           END)
    FROM   #RECPAY_TABLE
    
    UPDATE #RECPAY_TABLE
    SET    VTYP = (CASE 
                     WHEN DRCR = 'D' THEN 4
                     ELSE 1
                   END)
  END 

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

SELECT @@ERROR_COUNT = COUNT(1)
FROM   #RECPAY_TABLE
WHERE  (VDT NOT BETWEEN FYSTART AND FYEND
         OR EDT NOT BETWEEN FYSTART AND FYEND)

IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'Vouher Date Or Effective Date in some of the Vouchers is not falling in the default financial year.',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END 

/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/

SELECT @@ERROR_COUNT = COUNT(1)
FROM   #RECPAY_TABLE
WHERE  VDT > EDT

IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END 

/*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/

SELECT @@ERROR_COUNT = COUNT(1)
FROM   #RECPAY_TABLE
WHERE  AMOUNT <= 0

IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END 

/* --------------- VALIDATION FOR MULTIPLE VOUCHER DATES IN CASE OF NON-YEARLY VNO METHOD-------------------------- */

SELECT @@ERROR_COUNT = VNOFLAG
FROM   PARAMETER
WHERE  CURYEAR = 1



IF @@ERROR_COUNT <> 0
  BEGIN
    SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)
    FROM   #RECPAY_TABLE
    
    IF @@ERROR_COUNT > 1
      BEGIN
        SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES',
               'NA',
               ' NA'
        
        DROP TABLE #RECPAY_TABLE_TMP
        
        DROP TABLE #RECPAY_TABLE
        
        ROLLBACK TRAN
        
        DELETE FROM V2_UPLOADED_FILES
        WHERE       U_FILENAME = @FNAME
                    AND U_MODULE = 'CASH UPLOAD'
        
        RETURN
      END
  END 

/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/

SET @@ERROR_COUNT = 0

SELECT   @@ERROR_COUNT = COUNT(DISTINCT VDT)
FROM     #RECPAY_TABLE
WHERE    SERIAL_NO IN (SELECT DISTINCT SERIAL_NO
                       FROM   #RECPAY_TABLE)
GROUP BY SERIAL_NO
HAVING   COUNT(DISTINCT VDT) > 1


IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END 

/*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/

SELECT @@BACKDAYS = ISNULL(MAX(NODAYS),0)
FROM   USERWRITESTABLE
WHERE  USERCATEGORY = @USERCAT
       AND VTYP = @@VTYP
       AND BOOKTYPE = @@BOOKTYPE

SELECT @@BACKDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),109)) - @@BACKDAYS

SELECT @@ERROR_COUNT = ISNULL(COUNT(VDT),0)
FROM   #RECPAY_TABLE
WHERE  VDT < @@BACKDATE

IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET',
           'NA',
           ' NA'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END 

/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

SELECT @@ERROR_COUNT = COUNT(1)
FROM   (SELECT DISTINCT CLIENT_CODE
        FROM   #RECPAY_TABLE
        WHERE  UPDFLAG = 'N') A

IF @@ERROR_COUNT > 0
  BEGIN
    SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST',
           'NA',
           ' NA'
    UNION ALL
    SELECT DISTINCT CLIENT_CODE,
                    'NA',
                    ' NA'
    FROM   #RECPAY_TABLE
    WHERE  UPDFLAG = 'N'
    
    DROP TABLE #RECPAY_TABLE_TMP
    
    DROP TABLE #RECPAY_TABLE
    
    ROLLBACK TRAN
    
    DELETE FROM V2_UPLOADED_FILES
    WHERE       U_FILENAME = @FNAME
                AND U_MODULE = 'CASH UPLOAD'
    
    RETURN
  END

DECLARE  @@NEWVNO      AS VARCHAR(12),
         @@MAXCOUNT    AS INT,
         @@VDT         AS VARCHAR(11),
         @@CASHBRANCH  AS VARCHAR(10),
         @@CASHCOST    AS NUMERIC,
         @@LNOCUR      AS CURSOR,
         @@LNOVNO      AS VARCHAR(12) 

/*--------------------------UPDATE OF COST CODE ------------------------*/

SELECT @@CASHBRANCH = BRANCHCODE,
       @@CASHCOST = ISNULL(C.COSTCODE,-1)
FROM   ACMAST A
       LEFT OUTER JOIN COSTMAST C
         ON (A.BRANCHCODE = C.COSTNAME)
WHERE  A.CLTCODE = @CASHCODE

IF @@CASHBRANCH <> 'ALL'
  BEGIN
    UPDATE RP
    SET    CASHBRANCH = @@CASHBRANCH,
           COSTCODE = @@CASHCOST
    FROM   #RECPAY_TABLE RP,
           ACMAST A
    WHERE  A.CLTCODE = RP.CLIENT_CODE
           AND A.BRANCHCODE = 'ALL'
    
    UPDATE #RECPAY_TABLE
    SET    CASHCOST = @@CASHCOST,
           CASHBRANCH = @@CASHBRANCH
  END
ELSE
  BEGIN
    UPDATE #RECPAY_TABLE
    SET    COSTCODE = (SELECT TOP 1 COSTCODE
                       FROM   COSTMAST
                       WHERE  COSTNAME = 'HO')
    WHERE  COSTCODE = ''
  END

SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SERIAL_NO,
                                            COUNT(DISTINCT COSTCODE)
                                   FROM     #RECPAY_TABLE WITH (NOLOCK)
                                   GROUP BY SERIAL_NO
                                   HAVING   COUNT(DISTINCT COSTCODE) > 1

OPEN @@COSTCODEUPDATES

FETCH NEXT FROM @@COSTCODEUPDATES
INTO @@SERIAL_NO,
     @@COSTCODECOUNT

WHILE @@FETCH_STATUS = 0
  BEGIN
    UPDATE #RECPAY_TABLE
    SET    CASHBRANCH = 'HO',
           CASHCOST = (SELECT TOP 1 COSTCODE
                       FROM   COSTMAST
                       WHERE  COSTNAME = 'HO')
    WHERE  SERIAL_NO = @@SERIAL_NO
    
    FETCH NEXT FROM @@COSTCODEUPDATES
    INTO @@SERIAL_NO,
         @@COSTCODECOUNT
  END

UPDATE #RECPAY_TABLE
SET    CASHBRANCH = BRANCHCODE,
       CASHCOST = COSTCODE
WHERE  (CASHCOST = ''
         OR CASHCOST IS NULL) 

/*--------------------------AUTO GENERATION OF VNO ------------------------*/

SELECT @@STD_DATE = LEFT(SDTCUR,11),
       @@LST_DATE = LEFT(LDTCUR,11),
       @@VNOMETHOD = VNOFLAG
FROM   PARAMETER
WHERE  CURYEAR = 1

SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)
FROM   #RECPAY_TABLE

SELECT TOP 1 @@VDT = VDT
FROM   #RECPAY_TABLE

CREATE TABLE #VNO
(
	LASTVNO VARCHAR(12)
)

INSERT INTO #VNO
EXEC ACC_GENVNO_NEW
  @@VDT ,
  @@VTYP ,
  @@BOOKTYPE ,
  @@STD_DATE ,
  @@LST_DATE

SELECT @@NEWVNO = LASTVNO
FROM   #VNO

UPDATE #RECPAY_TABLE
SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + SERIAL_NO - 1)

SELECT @@NEWVNO = MAX(VNO)
FROM   #RECPAY_TABLE 

/*----------------------------- UPDATE V2_LASTVNO BY CHECKING THE VNOFLAG FROM PARAMETER -------------------------------- */

/*SELECT @@ERROR_COUNT = VNOFLAG
FROM   PARAMETER
WHERE  CURYEAR = 1

SELECT @@MonthlyVdt = LEFT(@@Vdt,4) + ' 1 ' + RIGHT(@@Vdt,4)

IF @@ERROR_COUNT = 1
  BEGIN
    UPDATE V2_LASTVNO
    SET    LASTVNO = (SELECT MAX(VNO)
                      FROM   #RECPAY_TABLE
                      WHERE  VTYP = @@VTYP
                             AND BOOKTYPE = @@BOOKTYPE)
    WHERE  VTYP = @@VTYP
           AND BOOKTYPE = @@BOOKTYPE
           AND VDT LIKE @@VDT + '%'
  END
ELSE
  IF @@ERROR_COUNT = 2
    BEGIN
      UPDATE V2_LASTVNO
      SET    LASTVNO = (SELECT MAX(VNO)
                        FROM   #RECPAY_TABLE
                        WHERE  VTYP = @@VTYP
                               AND BOOKTYPE = @@BOOKTYPE)
      WHERE  VTYP = @@VTYP
             AND BOOKTYPE = @@BOOKTYPE
             AND VDT LIKE @@MonthlyVdt + '%'
    END
  ELSE
    BEGIN
      UPDATE V2_LASTVNO
      SET    LASTVNO = (SELECT MAX(VNO)
                        FROM   #RECPAY_TABLE
                        WHERE  VTYP = @@VTYP
                               AND BOOKTYPE = @@BOOKTYPE)
      WHERE  VTYP = @@VTYP
             AND BOOKTYPE = @@BOOKTYPE
             AND VDT BETWEEN @@STD_DATE AND @@LST_DATE
    END*/

DROP TABLE #VNO 

/*--------------------------AUTO GENERATION OF LNO ------------------------*/

UPDATE #RECPAY_TABLE
SET    LNO = 2
WHERE  VNO IN (SELECT   VNO
               FROM     #RECPAY_TABLE WITH (NOLOCK)
               GROUP BY VNO
               HAVING   COUNT(*) = 1)

SET @@LNOCUR = CURSOR FOR SELECT   VNO
                          FROM     #RECPAY_TABLE WITH (NOLOCK)
                          GROUP BY VNO
                          HAVING   COUNT(*) > 1

OPEN @@LNOCUR

FETCH NEXT FROM @@LNOCUR
INTO @@LNOVNO

WHILE @@FETCH_STATUS = 0
  BEGIN
    CREATE TABLE [#LNOGEN] (
      VNO VARCHAR(12),
      SNO INT,
      LNO INT   IDENTITY ( 1,1 ))
    
    INSERT INTO #LNOGEN
    SELECT   VNO,
             SNO
    FROM     #RECPAY_TABLE WITH (NoLock)
    WHERE    VNO = @@LNOVNO
    ORDER BY SNO
    
    UPDATE #RECPAY_TABLE
    SET    LNO = L.LNO + 1
    FROM   #LNOGEN L
    WHERE  #RECPAY_TABLE.VNO = L.VNO
           AND #RECPAY_TABLE.SNO = L.SNO
           AND #RECPAY_TABLE.LNO = 0
    
    DROP TABLE #LNOGEN
    
    FETCH NEXT FROM @@LNOCUR
    INTO @@LNOVNO
  END

CLOSE @@LNOCUR

DEALLOCATE @@LNOCUR 

/*--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/ /*============================== CLIENT SIDE RECORD ==============================*/

INSERT INTO LEDGER
SELECT VTYP,
       VNO,
       EDT,
       LNO,
       ACNAME,
       DRCR,
       VAMT = AMOUNT,
       VDT,
       VNO1 = VNO,
       REFNO = 0,
       BALAMT = AMOUNT,
       NODAYS = 0,
       CDT = GETDATE(),
       CLTCODE = CLIENT_CODE,
       BOOKTYPE = @@BOOKTYPE,
       ENTEREDBY = @UNAME,
       PDT = GETDATE(),
       CHECKEDBY = @UNAME,
       ACTNODAYS = 0,
       NARRATION
FROM   #RECPAY_TABLE 

/*============================== BANK SIDE RECORD ==============================*/

INSERT INTO LEDGER
SELECT   VTYP,
         VNO,
         EDT,
         LNO = 1,
         @@acname,
         DRCR = (CASE 
                   WHEN DRCR = 'D' THEN 'C'
                   ELSE 'D'
                 END),
         VAMT = SUM(AMOUNT),
         VDT,
         VNO1 = VNO,
         REFNO = 0,
         BALAMT = SUM(AMOUNT),
         NODAYS = 0,
         CDT = GETDATE(),
         CLTCODE = @CASHCODE,
         BOOKTYPE = @@BOOKTYPE,
         ENTEREDBY = @UNAME,
         PDT = GETDATE(),
         CHECKEDBY = @UNAME,
         ACTNODAYS = 0,
         NARRATION = MAX(NARRATION)
FROM     #RECPAY_TABLE
GROUP BY VTYP,VNO,EDT,DRCR,
         VDT 

/*============================== CASH SIDE RECORD ==============================*/

INSERT INTO LEDGER3
SELECT   NARATNO = 1,
         NARRATION = MAX(NARRATION),
         REFNO = 0,
         VTYP,
         VNO,
         @@BookType
FROM     #RECPAY_TABLE
GROUP BY VTYP,VNO 
/*============================== CLIENT SIDE RECORD ==============================*/

INSERT INTO LEDGER3
SELECT NARATNO = LNO,
       NARR = NARRATION,
       REFNO = 0,
       VTYP,
       VNO,
       @@BookType
FROM   #RECPAY_TABLE

DECLARE  @@L2CUR  AS CURSOR,
         @@L2VNO  AS VARCHAR(12)

SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO
                         FROM     #RECPAY_TABLE
                         ORDER BY VNO

OPEN @@L2CUR

FETCH NEXT FROM @@L2CUR
INTO @@L2VNO

WHILE @@FETCH_STATUS = 0
  BEGIN
    DELETE FROM TEMPLEDGER2
    WHERE       SESSIONID = '9999999999' 
/*============================== CLIENT SIDE RECORD ==============================*/
    
    INSERT INTO TEMPLEDGER2
    SELECT 'BRANCH',
           C.COSTNAME,
           AMOUNT,
           VTYP,
           VNO,
           LNO,
           DRCR,
           '0',
           @@BOOKTYPE,
           '9999999999',
           CLIENT_CODE,
           'A',
           '0'
    FROM   #RECPAY_TABLE RP,
           COSTMAST C
    WHERE  RP.COSTCODE = C.COSTCODE
           AND VNO = @@L2VNO 
/*============================== BANK SIDE RECORD ==============================*/
    
    INSERT INTO TEMPLEDGER2
    SELECT   'BRANCH',
             CASHBRANCH,
             SUM(AMOUNT),
             VTYP,
             VNO,
             LNO = 1,
             DRCR = (CASE 
                       WHEN DRCR = 'D' THEN 'C'
                       ELSE 'D'
                     END),
             '0',
             @@BOOKTYPE,
             '9999999999',
             @CASHCODE,
             'A',
             '0'
    FROM     #RECPAY_TABLE
    WHERE    VNO = @@L2VNO
    GROUP BY CASHBRANCH,VTYP,VNO,(CASE 
                WHEN DRCR = 'D' THEN 'C'
                ELSE 'D'
              END)
    
    EXEC INSERTTOLEDGER2
      '9999999999' ,
      @@L2VNO ,
      '1' ,
      '1' ,
      '1' ,
      'BROKER' ,
      'BROKER'
    
    FETCH NEXT FROM @@L2CUR
    INTO @@L2VNO
  END

DELETE FROM TEMPLEDGER2
WHERE       SESSIONID = '9999999999'

COMMIT TRAN

SELECT 'CLTCODE',
       'AMOUNT',
       'VNO'
UNION ALL
SELECT CLIENT_CODE,
       CONVERT(VARCHAR,AMOUNT),
       VNO                      AS RESULT
FROM   #RECPAY_TABLE

DROP TABLE #RECPAY_TABLE_TMP

DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CASHUPLOAD_BULK
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CASHUPLOAD_BULK]  
 @FNAME VARCHAR(100),            
 @UNAME VARCHAR(25),            
 @USERCAT INT    
AS  
--EXEC CASHUPLOAD_BULK 'E:\BACKOFFICE\CASHFILES\CASH_TEST.CSV', 'SYSTEM', 388  
  
  
SET NOCOUNT ON   
  
  
DECLARE    
 @@ERROR_COUNT INT,  
 @@SQL AS VARCHAR(2000)            
  
/*SELECT @@ERROR_COUNT = COUNT(1)  
FROM   (SELECT U_FILENAME  
        FROM   V2_UPLOADED_FILES  
        WHERE  U_FILENAME = @FNAME  
               AND U_MODULE = 'CASH UPLOAD') A  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.',  
           @FNAME,  
           'NA'  
      
    RETURN  
  END  
*/  
BEGIN TRAN  
  
CREATE TABLE #RECPAY_TABLE_TMP (  
  EDATE        VARCHAR(20),  
  VOUCHER_DATE VARCHAR(20),  
  CLIENT_CODE  VARCHAR(50),  
  CASHCODE VARCHAR(10),  
  AMOUNT       MONEY,  
  DRCR         VARCHAR(1),  
  NARRATION    VARCHAR(234),
  BRANCHCODE  VARCHAR(10),  
  SERIAL_NO    INT)  
  
CREATE TABLE [#RECPAY_TABLE] (  
  EDATE        VARCHAR(20),  
  VOUCHER_DATE VARCHAR(20),  
  CLIENT_CODE  VARCHAR(50),  
  CASHCODE VARCHAR(10),  
  AMOUNT       MONEY,  
  DRCR         VARCHAR(1),  
  NARRATION    VARCHAR(234),  
  SERIAL_NO    INT,  
  SNO          INT   IDENTITY ( 1,1 )   NOT NULL,  
  BRANCHCODE   VARCHAR(10)   NULL,  
  VDT          DATETIME   NULL,  
  FYSTART      DATETIME   NULL,  
  FYEND        DATETIME   NULL,  
  UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),  
  EDT          DATETIME   NULL,  
  VNO          VARCHAR(12)   NULL,  
  VTYP         SMALLINT   NULL,  
  ACNAME       VARCHAR(100)   NULL,  
  COSTCODE     SMALLINT   NULL,  
  CASHBRANCH   VARCHAR(100)   NULL,  
  CASHCOST     SMALLINT   NULL,  
  LNO          SMALLINT   NOT NULL   DEFAULT (0),  
  CASHNAME VARCHAR(100),  
  BOOKTYPE VARCHAR(2))  
ON [PRIMARY]  
  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', FIRSTROW = 2 )"  
EXEC(@@SQL)    
  
   
INSERT INTO V2_UPLOADED_FILES  
SELECT @FNAME,  
       @FNAME,  
       COUNT(1),  
       'B',  
       GETDATE(),  
       @UNAME,  
       'CASH UPLOAD'  
  
INSERT INTO #RECPAY_TABLE  
           (EDATE,  
            VOUCHER_DATE,  
            CLIENT_CODE,  
			CASHCODE,  
            AMOUNT,  
            DRCR,  
            NARRATION,  
            SERIAL_NO,  
   BRANCHCODE)  
SELECT EDATE,  
       VOUCHER_DATE,  
       UPPER(CLIENT_CODE),  
    UPPER(CASHCODE),  
       AMOUNT,  
       UPPER(DRCR),  
       NARRATION,  
       SERIAL_NO,  
       BRANCHCODE  
FROM   #RECPAY_TABLE_TMP  
  
UPDATE #RECPAY_TABLE  
SET    BRANCHCODE = A.BRANCHCODE,  
       VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
       EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
       FYSTART = P.SDTCUR,  
       FYEND = P.LDTCUR,  
       UPDFLAG = 'Y',  
       ACNAME = LONGNAME,  
       COSTCODE = C.COSTCODE  
FROM   ACMAST A,  
       PARAMETER P,  
       COSTMAST C  
WHERE  A.CLTCODE = CLIENT_CODE  
       AND P.CURYEAR = 1  
       AND ACCAT IN ('3','4')  
       AND A.BRANCHCODE = COSTNAME  
       AND A.BRANCHCODE <> 'ALL'  
  
UPDATE #RECPAY_TABLE  
SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
       EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
       FYSTART = P.SDTCUR,  
       FYEND = P.LDTCUR,  
       UPDFLAG = 'Y',  
       ACNAME = LONGNAME,  
       COSTCODE = (SELECT TOP 1 COSTCODE  
                   FROM   COSTMAST  
                   WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE)  
FROM   ACMAST A,  
       PARAMETER P  
WHERE  A.CLTCODE = CLIENT_CODE  
       AND P.CURYEAR = 1  
       AND ACCAT IN ('3','4')  
       AND A.BRANCHCODE = 'ALL'  
       AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'  
  
UPDATE #RECPAY_TABLE  
SET    BRANCHCODE = 'HO',  
       VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),         EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
       FYSTART = P.SDTCUR,  
       FYEND = P.LDTCUR,  
       UPDFLAG = 'Y',  
       ACNAME = LONGNAME,  
       COSTCODE = (SELECT TOP 1 COSTCODE  
                   FROM   COSTMAST  
                   WHERE  COSTNAME = 'HO')  
FROM   ACMAST A,  
       PARAMETER P  
WHERE  A.CLTCODE = CLIENT_CODE  
       AND P.CURYEAR = 1  
       AND ACCAT IN ('3','4')  
       AND A.BRANCHCODE = 'ALL'  
       AND #RECPAY_TABLE.BRANCHCODE = 'ALL'   
  
/*--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/  
  
DECLARE  @@STD_DATE        VARCHAR(11),  
         @@LST_DATE        VARCHAR(11),  
         @@VNOMETHOD       INT,  
         @@ACNAME          CHAR(100),  
         @@BOOKTYPE        CHAR(2),  
         @@MICRNO          VARCHAR(10),  
         @@DRCR            VARCHAR(1),  
         @@CASHBRNCOUNT    TINYINT,  
         @@BACKDATE        DATETIME,  
         @@BACKDAYS        SMALLINT,  
         @@MonthlyVdt      VARCHAR(11),  
         @@VTYP            SMALLINT,  
         @@SERIAL_NO       INT,  
         @@COSTCODECOUNT   TINYINT,  
         @@COSTCODEUPDATES CURSOR,  
   @@VNOCUR AS CURSOR,  
   @@CASH_CODE VARCHAR(10)  
  
/*--------------------------VALIDATION FOR EXISTANCE AND TYPE OF CASH ACCOUNT ------------------------*/  
  
/*SELECT @@ERROR_COUNT = COUNT(1)  
FROM   ACMAST  
WHERE  CLTCODE = @CASHCODE  
       AND ACCAT = 1  
  
IF @@ERROR_COUNT = 0  
  BEGIN  
    SELECT 'INVALID CASH ACCOUNT SELECTED',  
           'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END   
*/  
/*--------------------------GET BANK CODE DETAILS ------------------------*/  
  
UPDATE R SET CASHNAME = LONGNAME, R.BOOKTYPE = A.BOOKTYPE  
FROM   #RECPAY_TABLE R, ACMAST A  
WHERE  A.CLTCODE = R.CASHCODE  
       AND ACCAT = '1'   
  
/*------------------------- VALIDATION FOR CASH CODE MISSING ----------------------------------------*/  
SELECT @@ERROR_COUNT = COUNT(1)  
FROM   #RECPAY_TABLE WHERE CASHNAME IS NULL  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'INVALID CASH CODE IS SPECIFIED.',  
           'NA',  
     'NA',  
           ' NA'  
 UNION ALL  
 SELECT CASHCODE, 'NA', 'NA', 'NA'  
 FROM   #RECPAY_TABLE WHERE CASHNAME IS NULL  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END  
  
/*--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/  
  
SELECT @@ERROR_COUNT = COUNT(1)  
FROM   (SELECT DISTINCT DRCR  
        FROM   #RECPAY_TABLE) A  
  
IF @@ERROR_COUNT > 1  
  BEGIN  
    SELECT 'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.',  
           'NA',  
     'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END  
ELSE  
  BEGIN  
    SELECT TOP 1 @@DRCR = DRCR,  
                 @@VTYP = (CASE   
                             WHEN DRCR = 'D' THEN 4  
                             ELSE 1  
                           END)  
    FROM   #RECPAY_TABLE  
      
    UPDATE #RECPAY_TABLE  
    SET    VTYP = (CASE   
                     WHEN DRCR = 'D' THEN 4  
                     ELSE 1  
                   END)  
  END   
  
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/  
  
SELECT @@ERROR_COUNT = COUNT(1)  
FROM   #RECPAY_TABLE  
WHERE  (VDT NOT BETWEEN FYSTART AND FYEND  
   OR EDT NOT BETWEEN FYSTART AND FYEND)  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'Vouher Date Or Effective Date in some of the Vouchers is not falling in the default financial year.',  
           'NA',  
           'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END   
  
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/  
  
SELECT @@ERROR_COUNT = COUNT(1)  
FROM   #RECPAY_TABLE  
WHERE  VDT > EDT  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.',  
           'NA',  
           'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END   
  
/*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/  
  
SELECT @@ERROR_COUNT = COUNT(1)  
FROM   #RECPAY_TABLE  
WHERE  AMOUNT <= 0  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0',  
           'NA',  
           'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END   
  
/* --------------- VALIDATION FOR MULTIPLE VOUCHER DATES IN CASE OF NON-YEARLY VNO METHOD-------------------------- */  
  
SELECT @@ERROR_COUNT = VNOFLAG  
FROM   PARAMETER  
WHERE  CURYEAR = 1  
  
  
  
IF @@ERROR_COUNT <> 0  
  BEGIN  
    SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)  
    FROM   #RECPAY_TABLE  
      
    IF @@ERROR_COUNT > 1  
      BEGIN  
        SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES',  
               'NA',  
               'NA',  
               ' NA'  
          
        DROP TABLE #RECPAY_TABLE_TMP  
          
        DROP TABLE #RECPAY_TABLE  
          
        ROLLBACK TRAN  
          
        DELETE FROM V2_UPLOADED_FILES  
        WHERE       U_FILENAME = @FNAME  
                    AND U_MODULE = 'CASH UPLOAD'  
          
        RETURN  
      END  
  END   
  
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/  
  
SET @@ERROR_COUNT = 0  
  
SELECT   @@ERROR_COUNT = COUNT(DISTINCT VDT)  
FROM     #RECPAY_TABLE  
WHERE    SERIAL_NO IN (SELECT DISTINCT SERIAL_NO  
                       FROM   #RECPAY_TABLE)  
GROUP BY SERIAL_NO  
HAVING   COUNT(DISTINCT VDT) > 1  
  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES',  
           'NA',  
           'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END   
  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/  
  
SELECT @@ERROR_COUNT = COUNT(1)  
FROM   (SELECT DISTINCT CLIENT_CODE  
        FROM   #RECPAY_TABLE  
        WHERE  UPDFLAG = 'N') A  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST',  
           'NA',  
           'NA',  
           ' NA'  
    UNION ALL  
    SELECT DISTINCT CLIENT_CODE,  
                    'NA',  
           'NA',  
                    ' NA'  
    FROM   #RECPAY_TABLE  
    WHERE  UPDFLAG = 'N'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
     
    RETURN  
  END  
  
DECLARE  @@NEWVNO      AS VARCHAR(12),  
         @@MAXCOUNT    AS INT,  
         @@VDT         AS VARCHAR(11),  
         @@CASHBRANCH  AS VARCHAR(10),  
         @@CASHCOST    AS NUMERIC,  
         @@LNOCUR      AS CURSOR,  
         @@LNOVNO      AS VARCHAR(12)   
  
CREATE TABLE #CASHVNO  
(  
 SNO INT,  
 SRNO INT IDENTITY(1, 1)  
)  
  
  
/*    --------------------------AUTO GENERATION OF VNO ------------------------ */                    
  SET @@VNOCUR = CURSOR FOR                    
   SELECT DISTINCT                    
    CASHCODE,                    
    BOOKTYPE                    
   FROM                    
    #RECPAY_TABLE WITH(NOLOCK)                    
  OPEN @@VNOCUR                    
  FETCH NEXT                    
   FROM                    
    @@VNOCUR                    
   INTO                    
    @@CASH_CODE,                    
    @@BOOKTYPE                    
  WHILE @@FETCH_STATUS = 0                    
   BEGIN                    
  
/*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/  
  
SELECT @@BACKDAYS = ISNULL(MAX(NODAYS),0)  
FROM   USERWRITESTABLE  
WHERE  USERCATEGORY = @USERCAT  
       AND VTYP = @@VTYP  
       AND BOOKTYPE = @@BOOKTYPE  
  
SELECT @@BACKDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),109)) - @@BACKDAYS  
  
SELECT @@ERROR_COUNT = ISNULL(COUNT(VDT),0)  
FROM   #RECPAY_TABLE  
WHERE  VDT < @@BACKDATE  
  
IF @@ERROR_COUNT > 0  
  BEGIN  
    SELECT 'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET',  
           'NA',  
           'NA',  
           ' NA'  
      
    DROP TABLE #RECPAY_TABLE_TMP  
      
    DROP TABLE #RECPAY_TABLE  
      
    ROLLBACK TRAN  
      
    DELETE FROM V2_UPLOADED_FILES  
    WHERE       U_FILENAME = @FNAME  
                AND U_MODULE = 'CASH UPLOAD'  
      
    RETURN  
  END   
  
/*--------------------------UPDATE OF COST CODE ------------------------*/  
  
SELECT @@CASHBRANCH = BRANCHCODE,  
       @@CASHCOST = ISNULL(C.COSTCODE,-1)  
FROM   ACMAST A  
       LEFT OUTER JOIN COSTMAST C  
         ON (A.BRANCHCODE = C.COSTNAME)  
WHERE  A.CLTCODE = @@CASH_CODE  
  
IF @@CASHBRANCH <> 'ALL'  
  BEGIN  
    UPDATE RP  
    SET    CASHBRANCH = @@CASHBRANCH,  
           COSTCODE = @@CASHCOST  
    FROM   #RECPAY_TABLE RP,  
           ACMAST A  
    WHERE  A.CLTCODE = RP.CLIENT_CODE  
           AND A.BRANCHCODE = 'ALL'  
      
    UPDATE #RECPAY_TABLE  
    SET    CASHCOST = @@CASHCOST,  
           CASHBRANCH = @@CASHBRANCH  
  END  
ELSE  
  BEGIN  
    UPDATE #RECPAY_TABLE  
    SET    COSTCODE = (SELECT TOP 1 COSTCODE  
                       FROM   COSTMAST  
                       WHERE  COSTNAME = 'HO')  
    WHERE  COSTCODE = ''  
  END  
  
SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SERIAL_NO,  
                                            COUNT(DISTINCT COSTCODE)  
                                   FROM     #RECPAY_TABLE WITH (NOLOCK)  
                                   GROUP BY SERIAL_NO  
                                   HAVING   COUNT(DISTINCT COSTCODE) > 1  
  
OPEN @@COSTCODEUPDATES  
  
FETCH NEXT FROM @@COSTCODEUPDATES  
INTO @@SERIAL_NO,  
     @@COSTCODECOUNT  
  
WHILE @@FETCH_STATUS = 0  
  BEGIN  
    UPDATE #RECPAY_TABLE  
    SET    CASHBRANCH = 'HO',  
           CASHCOST = (SELECT TOP 1 COSTCODE  
                       FROM   COSTMAST  
                       WHERE  COSTNAME = 'HO')  
    WHERE  SERIAL_NO = @@SERIAL_NO  
      
    FETCH NEXT FROM @@COSTCODEUPDATES  
    INTO @@SERIAL_NO,  
         @@COSTCODECOUNT  
  END  
  
UPDATE #RECPAY_TABLE  
SET    CASHBRANCH = BRANCHCODE,  
       CASHCOST = COSTCODE  
WHERE  (CASHCOST = ''  
         OR CASHCOST IS NULL)   
  
SELECT @@STD_DATE = LEFT(SDTCUR,11),  
       @@LST_DATE = LEFT(LDTCUR,11),  
       @@VNOMETHOD = VNOFLAG  
FROM   PARAMETER  
WHERE  CURYEAR = 1  
  
SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)  
FROM   #RECPAY_TABLE  
WHERE BOOKTYPE = @@BOOKTYPE  
  
TRUNCATE TABLE #CASHVNO  
  
INSERT INTO #CASHVNO  
SELECT SERIAL_NO FROM #RECPAY_TABLE   
WHERE BOOKTYPE = @@BOOKTYPE  
  
SELECT TOP 1 @@VDT = VDT  
FROM   #RECPAY_TABLE  
  
CREATE TABLE #VNO  
(  
 LASTVNO VARCHAR(12)  
)  
  
INSERT INTO #VNO  
EXEC ACC_GENVNO_NEW  
  @@VDT ,  
  @@VTYP ,  
  @@BOOKTYPE ,  
  @@STD_DATE ,  
  @@LST_DATE,  
  @@MAXCOUNT  
  
SELECT @@NEWVNO = LASTVNO  
FROM   #VNO  
  
UPDATE R  
SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + C.SRNO - 1)  
FROM #RECPAY_TABLE R, #CASHVNO C  
WHERE SERIAL_NO = C.SNO   
AND BOOKTYPE = @@BOOKTYPE  
  
SELECT @@NEWVNO = MAX(VNO)  
FROM   #RECPAY_TABLE   
  
  
  
DROP TABLE #VNO   
  
FETCH NEXT                    
   FROM @@VNOCUR                    
   INTO                    
    @@CASH_CODE,                    
    @@BOOKTYPE                    
 END     
  
  
  
/*--------------------------AUTO GENERATION OF LNO ------------------------*/  
  
UPDATE #RECPAY_TABLE  
SET    LNO = 2  
WHERE  VNO IN (SELECT   VNO  
               FROM     #RECPAY_TABLE WITH (NOLOCK)  
               GROUP BY VNO  
               HAVING   COUNT(*) = 1)  
  
SET @@LNOCUR = CURSOR FOR SELECT   VNO  
                          FROM     #RECPAY_TABLE WITH (NOLOCK)  
                          GROUP BY VNO  
                          HAVING   COUNT(*) > 1  
  
OPEN @@LNOCUR  
  
FETCH NEXT FROM @@LNOCUR  
INTO @@LNOVNO  
  
WHILE @@FETCH_STATUS = 0  
  BEGIN  
    CREATE TABLE [#LNOGEN] (  
      VNO VARCHAR(12),  
      SNO INT,  
      LNO INT   IDENTITY ( 1,1 ))  
      
    INSERT INTO #LNOGEN  
    SELECT   VNO,  
             SNO  
    FROM     #RECPAY_TABLE WITH (NoLock)  
    WHERE    VNO = @@LNOVNO  
    ORDER BY SNO  
      
    UPDATE #RECPAY_TABLE  
    SET    LNO = L.LNO + 1  
    FROM   #LNOGEN L  
    WHERE  #RECPAY_TABLE.VNO = L.VNO  
           AND #RECPAY_TABLE.SNO = L.SNO  
           AND #RECPAY_TABLE.LNO = 0  
      
    DROP TABLE #LNOGEN  
      
    FETCH NEXT FROM @@LNOCUR  
    INTO @@LNOVNO  
  END  
  
CLOSE @@LNOCUR  
  
DEALLOCATE @@LNOCUR   
  
/*--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/ /*============================== CLIENT SIDE RECORD ==============================*/  
  
INSERT INTO LEDGER  
SELECT VTYP,  
       VNO,  
       EDT,  
       LNO,  
       ACNAME,  
       DRCR,  
       VAMT = AMOUNT,  
       VDT,  
       VNO1 = VNO,  
       REFNO = 0,  
       BALAMT = AMOUNT,  
       NODAYS = 0,  
       CDT = GETDATE(),  
       CLTCODE = CLIENT_CODE,  
       BOOKTYPE,  
       ENTEREDBY = @UNAME,  
       PDT = GETDATE(),  
       CHECKEDBY = @UNAME,  
       ACTNODAYS = 0,  
       NARRATION  
FROM   #RECPAY_TABLE   
  
/*============================== BANK SIDE RECORD ==============================*/  
  
INSERT INTO LEDGER  
SELECT   VTYP,  
         VNO,  
         EDT,  
         LNO = 1,  
         CASHNAME,  
         DRCR = (CASE   
                   WHEN DRCR = 'D' THEN 'C'  
                   ELSE 'D'  
                 END),  
         VAMT = SUM(AMOUNT),  
         VDT,  
         VNO1 = VNO,  
         REFNO = 0,  
         BALAMT = SUM(AMOUNT),  
         NODAYS = 0,  
         CDT = GETDATE(),  
         CLTCODE = CASHCODE,  
         BOOKTYPE,  
         ENTEREDBY = @UNAME,  
         PDT = GETDATE(),  
         CHECKEDBY = @UNAME,  
         ACTNODAYS = 0,  
         NARRATION = MAX(NARRATION)  
FROM     #RECPAY_TABLE  
GROUP BY VTYP,VNO,EDT,DRCR,CASHNAME, CASHCODE,  
         VDT, BOOKTYPE   
  
/*============================== CASH SIDE RECORD ==============================*/  
  
INSERT INTO LEDGER3  
SELECT   NARATNO = 1,  
         NARRATION = MAX(NARRATION),  
         REFNO = 0,  
         VTYP,  
         VNO,  
         BOOKTYPE  
FROM     #RECPAY_TABLE  
GROUP BY VTYP,VNO, BOOKTYPE   
/*============================== CLIENT SIDE RECORD ==============================*/  
  
INSERT INTO LEDGER3  
SELECT NARATNO = LNO,  
       NARR = NARRATION,  
       REFNO = 0,  
       VTYP,  
       VNO,  
       BOOKTYPE  
FROM   #RECPAY_TABLE  
  
DECLARE  @@L2CUR  AS CURSOR,  
         @@L2VNO  AS VARCHAR(12)  
  
SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO  
                         FROM     #RECPAY_TABLE  
   ORDER BY VNO  
  
OPEN @@L2CUR  
  
FETCH NEXT FROM @@L2CUR  
INTO @@L2VNO  
  
WHILE @@FETCH_STATUS = 0  
  BEGIN  
    DELETE FROM TEMPLEDGER2  
    WHERE       SESSIONID = '9999999999'   
/*============================== CLIENT SIDE RECORD ==============================*/  
      
    INSERT INTO TEMPLEDGER2  
    SELECT 'BRANCH',  
           C.COSTNAME,  
           AMOUNT,  
           VTYP,  
           VNO,  
           LNO,  
           DRCR,  
           '0',  
           BOOKTYPE,  
           '9999999999',  
           CLIENT_CODE,  
           'A',  
           '0'  
    FROM   #RECPAY_TABLE RP,  
           COSTMAST C  
    WHERE  RP.COSTCODE = C.COSTCODE  
           AND VNO = @@L2VNO   
/*============================== BANK SIDE RECORD ==============================*/  
      
    INSERT INTO TEMPLEDGER2  
    SELECT   'BRANCH',  
             CASHBRANCH,  
             SUM(AMOUNT),  
             VTYP,  
             VNO,  
             LNO = 1,  
             DRCR = (CASE   
                       WHEN DRCR = 'D' THEN 'C'  
                       ELSE 'D'  
                     END),  
             '0',  
             BOOKTYPE,  
             '9999999999',  
             CASHCODE,  
             'A',  
             '0'  
    FROM     #RECPAY_TABLE  
    WHERE    VNO = @@L2VNO  
    GROUP BY CASHBRANCH,VTYP,VNO,CASHCODE,BOOKTYPE,(CASE   
                WHEN DRCR = 'D' THEN 'C'  
                ELSE 'D'  
              END)  
      
    EXEC INSERTTOLEDGER2  
      '9999999999' ,  
      @@L2VNO ,  
      '1' ,  
      '1' ,  
      '1' ,  
      'BROKER' ,  
      'BROKER'  
      
    FETCH NEXT FROM @@L2CUR  
    INTO @@L2VNO  
  END  
  
DELETE FROM TEMPLEDGER2  
WHERE       SESSIONID = '9999999999'  
  
COMMIT TRAN  
  
SELECT 'CLTCODE',  
    'CASHCODE',  
       'AMOUNT',  
       'VNO'  
UNION ALL  
SELECT CLIENT_CODE, CASHCODE,  
       CONVERT(VARCHAR,AMOUNT),  
       VNO                      AS RESULT  
FROM   #RECPAY_TABLE  
  
  
DROP TABLE #RECPAY_TABLE_TMP  
  
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CheckMarginopbal
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 05/10/2004 5:29:30 PM ******/
/****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 03/28/2003 4:33:12 PM ******/
CREATE Procedure CheckMarginopbal
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime

as
set transaction isolation level read uncommitted


select l.lno, l.cltcode, amt=(case when upper(drcr) = 'D' then vamt else -vamt end), t.bal
from ledger l left outer join acmast a on l.cltcode = a.cltcode,
(select mcltcode, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)
from marginledger where vdt >= @sdtcur + ' 00:00:00'  and vdt <= @ldtcur + ' 23:59:59'
group by mcltcode) t
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno
and a.accat = 14 and t.mcltcode = l.cltcode and 
(case when upper(drcr) = 'D' then vamt else -vamt end) <> bal

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Chequedetailssp
-- --------------------------------------------------


Create Proc Chequedetailssp  
@Cltcode Varchar(10),   
@Option Varchar(2),   
@Vdt Varchar(11),   
@Statusname Varchar(25)  
As  
 /*  
 Select Acname , Bnkname, Brnname, Vamt, Ddno, L.Vtyp, L.Vno, L.Lno, L.Drcr, L.Vdt , L.Booktype  
 From Ledger L, Ledger1 L1   
 Where  L1.Vtyp = L.Vtyp And L1.Vno = L.Vno And L.Lno = L1.Lno  
 And L.Vtyp In (Select Vtyp From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19) And Cltcode = @Cltcode)   
 And L.Vno In (Select Vno From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19)  And Cltcode = @Cltcode)   
 And Ddno Like @Option And L.Cltcode <> @Cltcode And L.Vdt Like @Vdt + '%'  
 */  
   
 Select Distinct Acname , Cltcode, Bnkname, Brnname, Vamt, Ddno, L.Vtyp, L.Vno, L.Lno, L.Drcr, L.Vdt , L.Booktype, City = ''  
 From Ledger L, Ledger1 L1 /*, Msajag.Dbo.Client4 C4, Msajag.Dbo.Pobank P*/, Msajag.Dbo.Tblpradnyausers U, Msajag.Dbo.Tbladmin A  
 Where  L1.Vtyp = L.Vtyp And L1.Vno = L.Vno And L.Lno = L1.Lno  
 And L.Vtyp In (Select Vtyp From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19) And Cltcode = @Cltcode)   
 And L.Vno In (Select Vno From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19)  And Cltcode = @Cltcode)   
 And Clear_mode = @Option And L.Cltcode <> @Cltcode And L.Vdt Like @Vdt + '%'  
        /*and C4.Party_code = L.Cltcode And Depository Not In ('Cdsl', 'Nsdl') And C4.Bankid = P.Bankid*/  
 And Enteredby = Fldusername And A.Fldstname = U.Fldstname And Fldadminauto = Fldauto_admin  
 And U.Fldstname = @Statusname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Chequedetailssp_New
-- --------------------------------------------------
CREATE Proc Chequedetailssp_New 
@Cltcode Varchar(10),             
@Option Varchar(2),             
@Vdt Varchar(11),             
@Statusname Varchar(25)            
As            
       
if @Option = ''      
BEGIN      
 Select Distinct Acname, Cltcode, Bnkname, Brnname, Vamt, Ddno, L.Vtyp, L.Vno, L.Lno, L.Drcr, L.Vdt , L.Booktype, City = ''            
 From Ledger L, Ledger1 L1 /*, Msajag.Dbo.Client4 C4, Msajag.Dbo.Pobank P*/, Msajag.Dbo.Tblpradnyausers U, Msajag.Dbo.Tbladmin A            
 Where  L1.Vtyp = L.Vtyp And L1.Vno = L.Vno --And L.Lno = L1.Lno            
 And L.Vtyp In (Select Vtyp From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19) And Cltcode = @Cltcode)             
 And L.Vno In (Select Vno From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19)  And Cltcode = @Cltcode)             
 And Clear_mode in ('X','O','N','S','H') And L.Vdt Like @Vdt + '%' And L.Cltcode <> @Cltcode       
 --And Enteredby = Fldusername And A.Fldstname = U.Fldstname And Fldadminauto = Fldauto_admin            
 And U.Fldstname = @Statusname         
END      
      
ELSE      
BEGIN      
 Select Distinct Acname, Cltcode, Bnkname, Brnname, Vamt, Ddno, L.Vtyp, L.Vno, L.Lno, L.Drcr, L.Vdt , L.Booktype, City = ''            
 From Ledger L, Ledger1 L1 /*, Msajag.Dbo.Client4 C4, Msajag.Dbo.Pobank P*/, Msajag.Dbo.Tblpradnyausers U, Msajag.Dbo.Tbladmin A            
 Where  L1.Vtyp = L.Vtyp And L1.Vno = L.Vno --And L.Lno = L1.Lno            
 And L.Vtyp In (Select Vtyp From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19) And Cltcode = @Cltcode)             
 And L.Vno In (Select Vno From Ledger Where L.Vtyp = Vtyp And L.Vno = Vno And L.Booktype = Booktype And Vtyp In (2, 19)  And Cltcode = @Cltcode)             
 And Clear_mode in (@Option) And L.Vdt Like @Vdt + '%' And L.Cltcode <> @Cltcode       
 --And Enteredby = Fldusername And A.Fldstname = U.Fldstname And Fldadminauto = Fldauto_admin            
 And U.Fldstname = @Statusname            
END          
        
--exec ChequeDetailsSP_New '995116','','Jun  2 2005','broker'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQ_COVERING_LETTER
-- --------------------------------------------------




/****** OBJECT:  STORED PROCEDURE DBO.CHEQUE_COVERING_LETTER    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.CHEQUE_COVERING_LETTER    SCRIPT DATE: 08/29/2005 5:57:26 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC CHQ_COVERING_LETTER

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12)
	
	
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)


	IF @VNOFROM <> '' AND @VNOTO <> ''
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END
	ELSE
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		 SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END

	IF @VTYP = '2' OR @VTYP = '3' OR @VTYP = '5' OR @VTYP = '16' OR @VTYP = '17' OR @VTYP = '20' OR @VTYP = '19' OR @VTYP = '1' OR @VTYP = '4' OR @VTYP = '22' OR  @VTYP = '23'
	   BEGIN
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "
		
		IF @VTYP = '20'
			SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' ) ML "

		SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
	   END
	ELSE
	   BEGIN
		SELECT @@WHEREPART = @@WHEREPART + " AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
	   END

	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END

	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0),L1.BNKNAME, L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQDETAILS_WCF_FP
-- --------------------------------------------------

CREATE PROC [dbo].[CHQDETAILS_WCF_FP]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM 	VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12)
	
	/*
		EXEC CHQDETAILS_WCF_FP '3', '', 'Apr  1 2006', 'Aug 16 2006', '000000000000', '999999999999', 'BANK01', 'BANK01 (ANIMESH)', '3', '%' 
	*/
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)


	IF @VNOFROM <> '' AND @VNOTO <> ''
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE AND L.VTYP = ML.VTYP AND L.VNO = ML.VNO "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "
			
			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END
	ELSE
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE AND L.VTYP = ML.VTYP AND L.VNO = ML.VNO"
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "%' AND L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END
	
	IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'
		BEGIN
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO /*AND L1.DDNO='0' */AND L1.CHQPRINTED=0 AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "
			
			IF @VTYP = '20'
				SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT DISTINCT VNO, VTYP, PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE +" 23:59:59' ) ML "
	
			SELECT @@WHEREPART = @@WHEREPART + " /*AND L1.DDNO='0'*/ AND L1.CHQPRINTED=0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
		END
	
	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END
	
	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END), 0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME, L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQDETAILS_WCF_RP
-- --------------------------------------------------

CREATE PROC [dbo].[CHQDETAILS_WCF_RP]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12)
	
	/*
		Exec CHQDETAILS_WCF_RP '3', '', 'Aug  1 2006', 'Aug 21 2006', '000000000000', '999999999999', 'BANK01', 'BANK01 (ANIMESH)', '3', '%' 
	*/
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)


	IF @VNOFROM <> '' AND @VNOTO <> ''
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE AND L.VTYP = ML.VTYP AND L.VNO = ML.VNO "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END
	ELSE
	   BEGIN
		IF @VTYP = '20'
			SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE AND L.VTYP = ML.VTYP AND L.VNO = ML.VNO "
		ELSE	
			SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

		 SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "' AND L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
	   END

	IF @VTYP = '2' OR @VTYP = '3' OR @VTYP = '5' OR @VTYP = '16' OR @VTYP = '17' OR @VTYP = '20' OR @VTYP = '19' OR @VTYP = '1' OR @VTYP = '4' OR @VTYP = '22' OR  @VTYP = '23'
	   BEGIN
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "
		
		IF @VTYP = '20'
			SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT DISTINCT VNO, VTYP, PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE +" 23:59:59' ) ML "

		SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
	   END
	ELSE
	   BEGIN
		SELECT @@WHEREPART = @@WHEREPART + " AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
		SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
	   END

	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END

	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME, L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHQDETAILS_WCF_UPD
-- --------------------------------------------------

CREATE PROC [dbo].[CHQDETAILS_WCF_UPD]

	@VTYP VARCHAR(2),
	@BOOKTYPE VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12) ,
	@BANKNAME VARCHAR(50),
	@VTYPE1 VARCHAR(2),
	@BRANCHCODE VARCHAR(12),
	@NEWPRINTFLAG VARCHAR(2)
	
	/*
		Exec CHQDETAILS_WCF_UPD '3', '01', 'Apr  1 2006', 'Aug 17 2006', '000000000000', '999999999999', 'BANK01', 'BANK01 (ANIMESH)', '3', '%', 'FP' 
	*/
AS

	DECLARE
		@@SELECTQURY AS VARCHAR(8000),
		@@FROMTABLES AS VARCHAR(2000),
		@@WHEREPART AS VARCHAR(8000),
		@@SORTBY AS VARCHAR(200)

	IF @VNOFROM <> '' AND @VNOTO <> ''
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE AND L.VTYP = ML.VTYP AND L.VNO = ML.VNO "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "' AND L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END
	ELSE
		BEGIN
			IF @VTYP = '20'
				SELECT @@WHEREPART = " WHERE ML.PARTY_CODE = A.CLTCODE AND L.VTYP = ML.VTYP AND L.VNO = ML.VNO "
			ELSE	
				SELECT @@WHEREPART = " WHERE L.CLTCODE = A.CLTCODE "

			SELECT @@WHEREPART = @@WHEREPART + " AND A.BRANCHCODE LIKE '" + @BRANCHCODE + "' AND L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
		END

	IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'
		BEGIN
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO /*AND L1.DDNO>'0'*/ AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T, ACMAST A "

			IF @VTYP = '20'
				SELECT @@FROMTABLES = @@FROMTABLES + " , (SELECT DISTINCT VNO, VTYP, PARTY_CODE FROM MARGINLEDGER WHERE VTYP = '" + @VTYP + "' AND VNO >= '" + @VNOFROM + "' AND VNO <= '" + @VNOTO + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE +" 23:59:59' ) ML "

			IF @NEWPRINTFLAG = 'FP'
				SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED = 0 "
			IF @NEWPRINTFLAG = 'RP'
				SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED > 0 "
				SELECT @@WHEREPART = @@WHEREPART + " /*AND L1.DDNO>'0'*/ AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
			SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO /*AND L1.DDNO>'0'*/ "
		END

	IF @VTYPE1 = '98'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
		END
	ELSE IF @VTYPE1 = '90'
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
		END
	ELSE
		BEGIN
			SELECT @@WHEREPART = @@WHEREPART
		END

	SELECT @@SELECTQURY = " SELECT DISTINCT VDT = CONVERT(VARCHAR, L.VDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), DDDT = CONVERT(VARCHAR, L1.DDDT, 103), L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT A.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME, L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0) , L1.MICRNO, L.BOOKTYPE, "
	SELECT @@SELECTQURY = @@SELECTQURY + " BRANCHCODE = (CASE BRANCHCODE WHEN 'ALL' THEN '' ELSE BRANCHCODE END) "
	
	SELECT @@SORTBY = " ORDER BY L.VNO "
	
	PRINT (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )
	EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENT_FUNDS_REPORTING
-- --------------------------------------------------

--EXEC CLIENT_FUNDS_REPORTING 'APR  1 2018', 'NOV 27 2018'
CREATE PROCEDURE [dbo].[CLIENT_FUNDS_REPORTING]
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@FR_CODE VARCHAR(10) = '0',
	@TO_CODE VARCHAR(10) = 'ZZZZZ'
AS

CREATE TABLE #CLIENT_DETAILS
(
	UCC_CODE VARCHAR(30), 
	CL_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(150), 
	PAN_GIR_NO VARCHAR(50)
)


-- CREATE CLIENT_DETAILS VIEW 
INSERT INTO #CLIENT_DETAILS
SELECT UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
FROM AngelNSECM.MSAJAG.DBO.VW_CLIENT_DETAILS_REPORTING WHERE CL_CODE BETWEEN @FR_CODE AND @TO_CODE



CREATE TABLE #LEDGER_PL
(
	UCC_CODE VARCHAR(12),
	CLTCODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	CLIENT_PAN VARCHAR(30),
	VDT DATETIME,
	EDT DATETIME,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	VTYPE VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	OPBAL MONEY,
	PDT DATETIME,
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #LEDGER_PL
SELECT
	UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO, VDT, EDT, @EXCHANGE, @SEGMENT, SETT_NO = '', CHQ_NO = '', VDESC, NARRATION = L.NARRATION, VNO, 
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, L.VTYP, L.BOOKTYPE, 0, PDT
FROM
	#CLIENT_DETAILS C, 
	(SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND CLTCODE BETWEEN @FR_CODE AND @TO_CODE  AND VTYP <> 18 ) L, 
	VMAST_DESC V
WHERE
	C.CL_CODE = CLTCODE
	AND L.VTYP = V.VTYPE
ORDER BY CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE


CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CL_CODE FROM #CLIENT_DETAILS) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CL_CODE AND L.VDT >= SDTCUR AND VDT < @FR_DATE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CL_CODE FROM #CLIENT_DETAILS) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CL_CODE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR
	AND VDT BETWEEN SDTCUR AND LDTCUR AND VTYP = 18
	GROUP BY L.CLTCODE
	
) L
GROUP BY CLTCODE

--UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O WHERE L.CLTCODE = O.CLTCODE

INSERT INTO #LEDGER_PL
SELECT UCC_CODE = '', A.CLTCODE, LONG_NAME = '' , PAN_GIR_NO = '', @FR_DATE, @FR_DATE, @EXCHANGE, @SEGMENT, SETT_NO = '', CHQ_NO = '', 'Opening Balance', NARRATION = 'Opening Balance', '', -- VNO
		CASE WHEN A.OPBAL < 0 THEN A.OPBAL*-1 ELSE 0 END , -- DRAMOUNT
		CASE WHEN A.OPBAL >= 0 THEN A.OPBAL ELSE 0 END , -- CRAMOUNT, 
		0, 18, '', 0, @FR_DATE
FROM #OPBAL A
		--INNER JOIN #CLIENT_DETAILS B
		--ON A.CLTCODE = B.CL_CODE


--UPDATE L SET RUNNING_BALANCE = (SELECT SUM(CRAMOUNT - DRAMOUNT) FROM #LEDGER_PL L1 WHERE O.CLTCODE = L1.CLTCODE AND L.CLTCODE = L1.CLTCODE AND L1.SNO < L.SNO) FROM #LEDGER_PL L, #OPBAL O
--WHERE L.CLTCODE = O.CLTCODE

SELECT 
	UCC_CODE, 
	CLTCODE, 
	LONG_NAME, 
	CLIENT_PAN, 
	VDT,
	EDT,
	EXCHANGE,
	SEGMENT,
	SETT_NO,
	CHQ_NO,
	VTYPE,
	NARRATION,
	VNO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT 
FROM #LEDGER_PL ORDER BY UCC_CODE,VDT,EXCHANGE,SEGMENT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENT_FUNDS_REPORTING_24122020
-- --------------------------------------------------
--EXEC CLIENT_FUNDS_REPORTING 'APR  1 2018', 'NOV 27 2018'
create PROCEDURE [dbo].[CLIENT_FUNDS_REPORTING]
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@FR_CODE VARCHAR(10) = '0',
	@TO_CODE VARCHAR(10) = 'ZZZZZ'
AS

CREATE TABLE #CLIENT_DETAILS
(
	UCC_CODE VARCHAR(30), 
	CL_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(150), 
	PAN_GIR_NO VARCHAR(50)
)


-- CREATE CLIENT_DETAILS VIEW 
INSERT INTO #CLIENT_DETAILS
SELECT UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
FROM ANAND1.MSAJAG.DBO.VW_CLIENT_DETAILS_REPORTING WHERE CL_CODE BETWEEN @FR_CODE AND @TO_CODE



CREATE TABLE #LEDGER_PL
(
	UCC_CODE VARCHAR(12),
	CLTCODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	CLIENT_PAN VARCHAR(30),
	VDT DATETIME,
	EDT DATETIME,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	VTYPE VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	OPBAL MONEY,
	PDT DATETIME,
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #LEDGER_PL
SELECT
	UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO, VDT, EDT, @EXCHANGE, @SEGMENT, SETT_NO = '', CHQ_NO = '', VDESC, NARRATION = L.NARRATION, VNO, 
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, L.VTYP, L.BOOKTYPE, 0, PDT
FROM
	#CLIENT_DETAILS C, 
	(SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND CLTCODE BETWEEN @FR_CODE AND @TO_CODE  AND VTYP <> 18 ) L, 
	VMAST V
WHERE
	C.CL_CODE = CLTCODE
	AND L.VTYP = V.VTYPE
ORDER BY CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE


CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CL_CODE FROM #CLIENT_DETAILS) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CL_CODE AND L.VDT >= SDTCUR AND VDT < @FR_DATE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CL_CODE FROM #CLIENT_DETAILS) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CL_CODE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR
	AND VDT BETWEEN SDTCUR AND LDTCUR AND VTYP = 18
	GROUP BY L.CLTCODE
	
) L
GROUP BY CLTCODE

--UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O WHERE L.CLTCODE = O.CLTCODE

INSERT INTO #LEDGER_PL
SELECT UCC_CODE = '', A.CLTCODE, LONG_NAME = '' , PAN_GIR_NO = '', @FR_DATE, @FR_DATE, @EXCHANGE, @SEGMENT, SETT_NO = '', CHQ_NO = '', 'Opening Balance', NARRATION = 'Opening Balance', '', -- VNO
		CASE WHEN A.OPBAL < 0 THEN A.OPBAL ELSE 0 END , -- DRAMOUNT
		CASE WHEN A.OPBAL >= 0 THEN A.OPBAL ELSE 0 END , -- CRAMOUNT, 
		0, 18, '', 0, @FR_DATE
FROM #OPBAL A
		--INNER JOIN #CLIENT_DETAILS B
		--ON A.CLTCODE = B.CL_CODE


--UPDATE L SET RUNNING_BALANCE = (SELECT SUM(CRAMOUNT - DRAMOUNT) FROM #LEDGER_PL L1 WHERE O.CLTCODE = L1.CLTCODE AND L.CLTCODE = L1.CLTCODE AND L1.SNO < L.SNO) FROM #LEDGER_PL L, #OPBAL O
--WHERE L.CLTCODE = O.CLTCODE

SELECT 
	UCC_CODE, 
	CLTCODE, 
	LONG_NAME, 
	CLIENT_PAN, 
	VDT,
	EDT,
	EXCHANGE,
	SEGMENT,
	SETT_NO,
	CHQ_NO,
	VTYPE,
	NARRATION,
	VNO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT 
FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_DETAILS
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_DETAILS]        
                @FDATE      VARCHAR(11),                 
                @TDATE      VARCHAR(11),             
                @FCODE      VARCHAR(10),        
                @TCODE      VARCHAR(10),        
                @STRORDER   VARCHAR(6),        
                @SELECTBY   VARCHAR(3),         
                @STATUSID   VARCHAR(15),        
                @STATUSNAME VARCHAR(15),        
                @STATUSNAME_TO VARCHAR(15),      
                @ORDERFLG   VARCHAR(1)  = 'N',        
                @EXCSEGMENT VARCHAR(1000) ,        
                @ENTITY_TYPE VARCHAR(20) = 'ENTITY',        
                @SINGLE     VARCHAR(1)  = 'N',        
                @FORPDF  VARCHAR(1) = 'N',      
                @CSV   VARCHAR(1) = 'N',        
				@VTYPE   VARCHAR(2) = '',
				@ENTITY VARCHAR(25) ='',
				@ENTITY_LIST VARCHAR(8000) = '',
				@SHOWMARGIN INT = 0,
				@SESSIONID VARCHAR(500),
				@PARENTCHILD_FLAG CHAR(1) = 'C',
				@DASHBOARD CHAR(1) = 'N',
				@CHARGES_LEDGER INT = 2
                        
        
AS  
      
/*        
SELECT * FROM CLS_COMPANY_MASTER_SETTING        
 EXEC [CLS_RPT_ACC_PARTYLEDGER_ALL] 'APR 1 2008','MAR 2 2009','0','0A143','ACCODE','VDT','BROKER','BROKER','','','','','ACCOUNT~ACCOUNTBSE~ACCOUNTFO'        
COMMIT        
EXEC RPT_ACC_PARTYLEDGER_ALL 'APR  1 2008','MAR  2 2009','0','0A143','ACCODE','VDT','BROKER','BROKER','',''        
    
DROP PROC CLS_RPT_ACC_PARTYLEDGER_ALL_TEST    
COMMIT        
*/        
       
	  /* select  cl_Code as CLTCODE from msajag..Client_Details
	   return;*/


	   
--SELECT * FROM LEDGER_RMONEY  ORDER BY ORDERSEG ASC

--update LEDGER_RMONEY
--set BOOKTYPE = 01
--WHERE ORDERSEG = 18 

DECLARE 
	@ECNFLAG VARCHAR(2),
	@MARGINREQ VARCHAR(1)

SELECT @ECNFLAG = ISNULL(PVALUE, '') FROM CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlEcn'
SELECT @MARGINREQ = ISNULL(PVALUE, '') FROM CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'margreq'
--SELECT @MARGINREQ 


SET NOCOUNT ON        
        
  BEGIN        
 IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
  BEGIN        
   SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
  END        
 IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
  BEGIN        
   SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
  END 

  IF @CHARGES_LEDGER IS NULL
	SET @CHARGES_LEDGER=2
	   
 DECLARE @YEAR_START VARCHAR(11),    
  @YEAR_END VARCHAR(20)      
  SELECT @YEAR_START = CONVERT(VARCHAR(11), SDTCUR, 109), @YEAR_END = CONVERT(VARCHAR(11), LDTCUR, 109) + ' 23:59:59' FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR    
    
	DECLARE @WHERECLAUS VARCHAR(30)
	  
  CREATE TABLE [DBO].[#TMPLEDGERNEW] (        
  [BOOKTYPE]   [CHAR](2)   NULL,        
  [VOUDT]      [DATETIME]   NULL,        
  [EFFDT]      [DATETIME]   NULL,        
  [SHORTDESC]  [CHAR](6)   NULL,        
  [DRAMT]      [MONEY]   NULL,        
  [CRAMT]      [MONEY]   NULL,        
  [VNO]        [VARCHAR](12)   NULL,        
  [DDNO]       [VARCHAR](20)   NULL,        
  [NARRATION]  [VARCHAR](500)   NULL,        
  [CLTCODE]    [VARCHAR](10)   NOT NULL,        
  [VTYP]       [SMALLINT]   NULL,        
  [VDT]        [VARCHAR](30)   NULL,        
  [EDT]        [VARCHAR](30)   NULL,        
  [ACNAME]     [VARCHAR](100)   NULL,        
  [OPBAL]      [MONEY]   NULL,        
  [L_ADDRESS1] [VARCHAR](100)   NULL,        
  [L_ADDRESS2] [VARCHAR](100)   NULL,        
  [L_ADDRESS3] [VARCHAR](100)   NULL,        
  [L_CITY]     [VARCHAR](50)   NULL,        
  [L_ZIP]      [VARCHAR](25)   NULL,        
  [RES_PHONE1] [VARCHAR](15)   NULL,        
  [BRANCH_CD]  [VARCHAR](10)   NULL,        
  [CROSAC]     [VARCHAR](10)   NULL,        
  [EDIFF]      [INT]   NULL,        
  [FAMILY]     [VARCHAR](10)   NULL,        
  [SUB_BROKER] [VARCHAR](10)   NULL,        
  [TRADER]     [VARCHAR](20)   NULL,        
  [CL_TYPE]    [VARCHAR](3)   NULL,        
  [BANK_NAME]  [VARCHAR](100)   NULL,        
  [CLTDPID]    [VARCHAR](16)   NULL,        
  [LNO]        [INT]    NULL,        
  [PDT]        [DATETIME]   NULL,
  [EMAIL] VARCHAR(500),
  [MOBILE_PAGER] VARCHAR(50),    
  [PAN] VARCHAR(50),    
  [EXCHANGE] [VARCHAR] (15) NULL,        
  [SEGMENT]    [VARCHAR](10)   NULL,        
  [ENTITY]     [VARCHAR](50)   NULL,        
  [ORDERSEG]   [BIGINT]   NULL,        
  [ACTIVE_SEG] [VARCHAR] (8000),        
  [PARTYROWCOUNT] [INT] NULL,        
  [TOTALPAGES] [INT] NULL
    
      )        
    ON [PRIMARY]        
       
 CREATE TABLE [DBO].[#DBNAME]            
 (            
  ACCOUNTDB VARCHAR(20),             
  EXCHANGE VARCHAR(6),             
  SEGMENT VARCHAR(10),            
  ACCOUNTSERVER VARCHAR(20),          
  SHAREDB VARCHAR(20),        
  GROUPID VARCHAR(20),        
  ORDER_SEGMENT INT          
 ) ON [PRIMARY]          
DECLARE  @@DB VARCHAR(1000)        
        
IF @EXCSEGMENT = ''        
 SELECT @EXCSEGMENT = EXCHANGE + '~' + SEGMENT FROM OWNER        
   
IF @ENTITY_TYPE = 'ENTITY'         
 SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM CLS_COMPANY_MASTER_SETTING (NOLOCK) WHERE EXCHANGE + '~' + SEGMENT IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY EXCHANGE "            
ELSE        
 SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM CLS_COMPANY_MASTER_SETTING (NOLOCK) WHERE GROUPID IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY GROUPID "            
  
EXEC(@@DB)
	    
DECLARE @@MAINREC AS CURSOR,        
  @@ACCOUNTDB VARCHAR(20),          
  @@SHAREDB VARCHAR(20),             
  @@ACCOUNTSVR VARCHAR(20),            
  @@EXCHANGE VARCHAR(15),            
  @@SEGMENT VARCHAR(15),        
  @@GROUPID VARCHAR(20),        
  @@ORDERSEG VARCHAR(3),        
  @@ORDERSECOUNT INT        
SET @@ORDERSECOUNT = (SELECT COUNT(1) FROM CLS_COMPANY_MASTER_SETTING)     

--SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB,GROUPID,ORDER_SEGMENT FROM #DBNAME       
        
DECLARE @@SQL VARCHAR(8000)        
--SET @@SQL = ""        
SET @@MAINREC = CURSOR FOR            
     SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB,GROUPID,ORDER_SEGMENT FROM #DBNAME           
             
OPEN @@MAINREC            
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB,@@GROUPID,@@ORDERSEG            
  WHILE @@FETCH_STATUS = 0            
  BEGIN           

 IF (@@ACCOUNTDB <> 'BBO_FA'  AND (@CHARGES_LEDGER  = 0 OR @CHARGES_LEDGER  = 2))
 BEGIN
 IF (@@ACCOUNTDB <> 'ACCOUNT'  AND (@CHARGES_LEDGER  = 0 OR @CHARGES_LEDGER  = 2))
 BEGIN
	SET @@SQL = " DELETE FROM "+@@ACCOUNTSVR+"."+@@ACCOUNTDB+".DBO.FORMULA_CLIENT_MASTER_PARENT  WHERE SESSION_ID = '" + @SESSIONID + "'"
	SET @@SQL = @@SQL + " INSERT INTO "+@@ACCOUNTSVR+"."+@@ACCOUNTDB+".DBO.FORMULA_CLIENT_MASTER_PARENT SELECT * FROM FORMULA_CLIENT_MASTER_PARENT WHERE SESSION_ID = '" + @SESSIONID + "'"
	EXEC (@@SQL)
 END

 SET @@SQL = " INSERT INTO #TMPLEDGERNEW "        
 SET @@SQL = @@SQL + " (BOOKTYPE, "        
 SET @@SQL = @@SQL +" VOUDT, "        
 SET @@SQL = @@SQL +" EFFDT, "        
 SET @@SQL = @@SQL +" SHORTDESC, "        
 SET @@SQL = @@SQL +" DRAMT, "        
 SET @@SQL = @@SQL +" CRAMT, "        
 SET @@SQL = @@SQL +" VNO, "        
 SET @@SQL = @@SQL +" DDNO, "        
 SET @@SQL = @@SQL +" NARRATION, "        
 SET @@SQL = @@SQL +" CLTCODE, "        
 SET @@SQL = @@SQL +" VTYP, "        
 SET @@SQL = @@SQL +" VDT, "        
 SET @@SQL = @@SQL +" EDT, "        
 SET @@SQL = @@SQL +" ACNAME, "        
 SET @@SQL = @@SQL +" OPBAL, "        
 SET @@SQL = @@SQL +" L_ADDRESS1, "        
 SET @@SQL = @@SQL +" L_ADDRESS2, "        
 SET @@SQL = @@SQL +" L_ADDRESS3, "        
 SET @@SQL = @@SQL +" L_CITY, "        
 SET @@SQL = @@SQL +" L_ZIP, "        
 SET @@SQL = @@SQL +" RES_PHONE1, "        
 SET @@SQL = @@SQL +" BRANCH_CD, "        
 SET @@SQL = @@SQL +" CROSAC, "        
 SET @@SQL = @@SQL +" EDIFF, "        
 SET @@SQL = @@SQL +" FAMILY, "        
 SET @@SQL = @@SQL +" SUB_BROKER, "        
 SET @@SQL = @@SQL +" TRADER, "        
 SET @@SQL = @@SQL +" CL_TYPE, "        
 SET @@SQL = @@SQL +" BANK_NAME, "        
 SET @@SQL = @@SQL +" CLTDPID, "        
 SET @@SQL = @@SQL +" LNO, "        
 SET @@SQL = @@SQL +" PDT, "        
 SET @@SQL = @@SQL +" EMAIL, "        
SET @@SQL = @@SQL +" MOBILE_PAGER, "        
 SET @@SQL = @@SQL +" PAN) "    
 IF @@SERVERNAME <> @@ACCOUNTSVR        
 SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTSVR+"."+@@ACCOUNTDB+"..CLS_CLIENTLEDGER_SEG_DETAILS "        
 ELSE        
 SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTDB+"..CLS_CLIENTLEDGER_SEG_DETAILS "        
 SET @@SQL = @@SQL +"'" +@FDATE +"', "        
 SET @@SQL = @@SQL +"'" +@TDATE +"', "        
 SET @@SQL = @@SQL +"'" +@FCODE +"', "        
 SET @@SQL = @@SQL +"'" +@TCODE +"', "        
 SET @@SQL = @@SQL +"'" +@STRORDER +"', "        
 SET @@SQL = @@SQL +"'" +@SELECTBY +"', "        
 SET @@SQL = @@SQL +"'" +@SESSIONID+"' "        
   
   print @@SQL     
EXEC (@@SQL)

  IF @ORDERFLG = 'N'        
    BEGIN        
    UPDATE #TMPLEDGERNEW         
    SET EXCHANGE = @@EXCHANGE,         
     SEGMENT = @@SEGMENT,        
      ENTITY = 'SETTLEMENT LEDGER',        
     ORDERSEG = 1         
    WHERE  SEGMENT IS NULL         
  END         
  ELSE         
   BEGIN        
   UPDATE #TMPLEDGERNEW         
      SET  EXCHANGE = @@EXCHANGE,        
       SEGMENT =@@SEGMENT,        
       ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN @@SEGMENT  +"-"+  @@EXCHANGE ELSE @@GROUPID + ' - SETTLEMENT LEDGER' END,        
       ORDERSEG = @@ORDERSEG         
    WHERE  SEGMENT IS NULL         
 END         
        
SET @@SQL = "  INSERT INTO #TMPLEDGERNEW "        
SET @@SQL = @@SQL + " (BOOKTYPE, "        
SET @@SQL = @@SQL + "  VOUDT, "        
SET @@SQL = @@SQL + "  EFFDT, "        
SET @@SQL = @@SQL + "  SHORTDESC, "        
SET @@SQL = @@SQL + "  DRAMT, "        
SET @@SQL = @@SQL + "  CRAMT, "        
SET @@SQL = @@SQL + "  VNO, "        
SET @@SQL = @@SQL + "  DDNO, "        
SET @@SQL = @@SQL + "  NARRATION, "        
SET @@SQL = @@SQL + "  CLTCODE, "        
SET @@SQL = @@SQL + "  VTYP, "        
SET @@SQL = @@SQL + "  VDT, "        
SET @@SQL = @@SQL + "  EDT, "        
SET @@SQL = @@SQL + "  ACNAME, "        
SET @@SQL = @@SQL + "  OPBAL, "        
SET @@SQL = @@SQL + "  L_ADDRESS1, "        
SET @@SQL = @@SQL + "  L_ADDRESS2, "        
SET @@SQL = @@SQL + "  L_ADDRESS3, "        
SET @@SQL = @@SQL + "  L_CITY, "        
SET @@SQL = @@SQL + "  L_ZIP, "        
SET @@SQL = @@SQL + "  RES_PHONE1, "        
SET @@SQL = @@SQL + "  BRANCH_CD, "        
SET @@SQL = @@SQL + "  CROSAC, "        
SET @@SQL = @@SQL + "  EDIFF, "        
SET @@SQL = @@SQL + "  FAMILY, "        
SET @@SQL = @@SQL + "  SUB_BROKER, "        
SET @@SQL = @@SQL + "  TRADER, "        
SET @@SQL = @@SQL + "  CL_TYPE, "        
SET @@SQL = @@SQL + "  BANK_NAME, "        
SET @@SQL = @@SQL + "  CLTDPID, "        
SET @@SQL = @@SQL + "  LNO, "        
SET @@SQL = @@SQL + "  PDT, "
SET @@SQL = @@SQL +" PAN) "            

IF @@SERVERNAME <> @@ACCOUNTSVR        
SET @@SQL = @@SQL + "    EXEC "+ @@ACCOUNTSVR +"."+@@ACCOUNTDB+"..CLS_RPT_ACC_MARGINLEDGER "        
ELSE        
SET @@SQL = @@SQL + "    EXEC "+@@ACCOUNTDB+"..CLS_RPT_ACC_MARGINLEDGER "        
SET @@SQL = @@SQL +"'" + @FDATE +"', "        
SET @@SQL = @@SQL +"'" + @TDATE +"', "        
SET @@SQL = @@SQL +"'" + @FCODE +"', "        
SET @@SQL = @@SQL +"'" + @TCODE +"', "        
SET @@SQL = @@SQL +"'" + @STRORDER +"', "        
SET @@SQL = @@SQL +"'" + @SELECTBY +"', "        
SET @@SQL = @@SQL +"'" + @STATUSID +"', "        
SET @@SQL = @@SQL +"'" + @STATUSNAME +"', "        
SET @@SQL = @@SQL +"'" +@STATUSNAME_TO+"', "        
SET @@SQL = @@SQL +"'" +@ENTITY+"', "        
SET @@SQL = @@SQL +"'" +@ENTITY_LIST+"' "                




IF @SHOWMARGIN = 1 
BEGIN
print @@SQL
	EXEC (@@SQL)
END
  IF @ORDERFLG = 'N'        
  BEGIN        
  UPDATE #TMPLEDGERNEW         
   SET   EXCHANGE =@@EXCHANGE,        
   SEGMENT = @@SEGMENT ,        
   ENTITY = 'MARGIN  LEDGER',         
   ORDERSEG = 2         
  WHERE SEGMENT IS NULL         
      END        
    ELSE        
      BEGIN        
  UPDATE #TMPLEDGERNEW         
   SET    EXCHANGE = @@EXCHANGE,        
   SEGMENT = @@SEGMENT,        
   ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN 'MARGIN-' + @@EXCHANGE ELSE @@GROUPID + ' - MARGIN LEDGER' END,        
   --IF @@ACCOUNTDB = 'ACCOUNT'        
   -- SET @@SQL = @@SQL + "        ORDERSEG = 4"        
   --ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'        
   -- SET @@SQL = @@SQL + "        ORDERSEG = 5"        
   --ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'        
   -- SET @@SQL = @@SQL + "        ORDERSEG = 6"        
            
   ORDERSEG = @@ORDERSEG+ @@ORDERSECOUNT        
  WHERE  SEGMENT IS NULL         
 END 
END  

IF (@@ACCOUNTDB = 'BBO_FA'   AND (@CHARGES_LEDGER  = 0 OR @CHARGES_LEDGER  = 2))
BEGIN
	 
SET @@SQL = " INSERT INTO #TMPLEDGERNEW "            
	 SET @@SQL = @@SQL + " (BOOKTYPE, "            
	 SET @@SQL = @@SQL +" VOUDT, "            
	 SET @@SQL = @@SQL +" EFFDT, "            
	 SET @@SQL = @@SQL +" SHORTDESC, "            
	 SET @@SQL = @@SQL +" DRAMT, "            
	 SET @@SQL = @@SQL +" CRAMT, "            
	 SET @@SQL = @@SQL +" VNO, "            
	 SET @@SQL = @@SQL +" DDNO, "            
	 SET @@SQL = @@SQL +" NARRATION, "            
	 SET @@SQL = @@SQL +" CLTCODE, "            
	 SET @@SQL = @@SQL +" VTYP, "            
	 SET @@SQL = @@SQL +" VDT, "            
	 SET @@SQL = @@SQL +" EDT, "            
	 SET @@SQL = @@SQL +" ACNAME, "            
	 SET @@SQL = @@SQL +" OPBAL, "            
	 SET @@SQL = @@SQL +" L_ADDRESS1, "            
	 SET @@SQL = @@SQL +" L_ADDRESS2, "            
	 SET @@SQL = @@SQL +" L_ADDRESS3, "            
	 SET @@SQL = @@SQL +" L_CITY, "            
	 SET @@SQL = @@SQL +" L_ZIP, "            
	 SET @@SQL = @@SQL +" RES_PHONE1, "            
	 SET @@SQL = @@SQL +" BRANCH_CD, "            
	 SET @@SQL = @@SQL +" CROSAC, "            
	 SET @@SQL = @@SQL +" EDIFF, "            
	 SET @@SQL = @@SQL +" FAMILY, "            
	 SET @@SQL = @@SQL +" SUB_BROKER, "            
	 SET @@SQL = @@SQL +" TRADER, "            
	 SET @@SQL = @@SQL +" CL_TYPE, "            
	 SET @@SQL = @@SQL +" BANK_NAME, "            
	 SET @@SQL = @@SQL +" CLTDPID, "            
	 SET @@SQL = @@SQL +" LNO, "            
	 SET @@SQL = @@SQL +" PDT) "  
	 
	 SET @@SQL = @@SQL +" EXEC BBO_FA..CLS_BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT " 
	 SET @@SQL = @@SQL +"'" +@FDATE +"', "     
	 SET @@SQL = @@SQL +"'" +@TDATE +"', "            
	 SET @@SQL = @@SQL +"'" +@FCODE +"', "            
	 SET @@SQL = @@SQL +"'" +@TCODE +"', "            
	 SET @@SQL = @@SQL +"'" +@STRORDER +"', "            
	 SET @@SQL = @@SQL +"'" +@SELECTBY +"', '' , 0 , '' ,'', 0, '' ,"  
	 SET @@SQL = @@SQL +"'" +@STATUSID +"', "            
	 SET @@SQL = @@SQL +"'" +@STATUSNAME+"', '',"            
	 SET @@SQL = @@SQL +"'" +@@EXCHANGE + "-" + @@SEGMENT+"', " 
	 SET @@SQL = @@SQL +"'" +@SESSIONID+"' "                
	      
--RETURN        

PRINT (@@SQL)  
EXEC (@@SQL)

IF @ORDERFLG = 'N'        
BEGIN        
	UPDATE #TMPLEDGERNEW         
	SET EXCHANGE = @@EXCHANGE,         
		SEGMENT = @@SEGMENT,        
		ENTITY = 'SETTLEMENT LEDGER',        
		ORDERSEG = 1         
	WHERE  SEGMENT IS NULL         
END         
ELSE         
BEGIN        
	UPDATE #TMPLEDGERNEW         
		SET  EXCHANGE = @@EXCHANGE,        
		SEGMENT =@@SEGMENT,        
		ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN @@EXCHANGE  +"-"+ @@SEGMENT ELSE @@GROUPID + ' - SETTLEMENT LEDGER' END,        
		ORDERSEG = @@ORDERSEG         
	WHERE  SEGMENT IS NULL         
END         
        
SET @@SQL = "  INSERT INTO #TMPLEDGERNEW "        
SET @@SQL = @@SQL + " (BOOKTYPE, "        
SET @@SQL = @@SQL + "  VOUDT, "        
SET @@SQL = @@SQL + "  EFFDT, "        
SET @@SQL = @@SQL + "  SHORTDESC, "        
SET @@SQL = @@SQL + "  DRAMT, "        
SET @@SQL = @@SQL + "  CRAMT, "        
SET @@SQL = @@SQL + "  VNO, "        
SET @@SQL = @@SQL + "  DDNO, "        
SET @@SQL = @@SQL + "  NARRATION, "        
SET @@SQL = @@SQL + "  CLTCODE, "        
SET @@SQL = @@SQL + "  VTYP, "        
SET @@SQL = @@SQL + "  VDT, "        
SET @@SQL = @@SQL + "  EDT, "        
SET @@SQL = @@SQL + "  ACNAME, "        
SET @@SQL = @@SQL + "  OPBAL, "        
SET @@SQL = @@SQL + "  L_ADDRESS1, "        
SET @@SQL = @@SQL + "  L_ADDRESS2, "        
SET @@SQL = @@SQL + "  L_ADDRESS3, "        
SET @@SQL = @@SQL + "  L_CITY, "        
SET @@SQL = @@SQL + "  L_ZIP, "        
SET @@SQL = @@SQL + "  RES_PHONE1, "        
SET @@SQL = @@SQL + "  BRANCH_CD, "        
SET @@SQL = @@SQL + "  CROSAC, "        
SET @@SQL = @@SQL + "  EDIFF, "        
SET @@SQL = @@SQL + "  FAMILY, "        
SET @@SQL = @@SQL + "  SUB_BROKER, "        
SET @@SQL = @@SQL + "  TRADER, "        
SET @@SQL = @@SQL + "  CL_TYPE, "        
SET @@SQL = @@SQL + "  BANK_NAME, "        
SET @@SQL = @@SQL + "  CLTDPID, "        
SET @@SQL = @@SQL + "  LNO, "        
SET @@SQL = @@SQL + "  PDT, "
SET @@SQL = @@SQL +" PAN) "            

	IF @@SERVERNAME <> @@ACCOUNTSVR      
	BEGIN  
		SET @@SQL = @@SQL + "    EXEC "+ @@ACCOUNTSVR +"."+@@ACCOUNTDB+"..CLS_RPT_ACC_MARGINLEDGER "        
	END
	ELSE        
		BEGIN
	SET @@SQL = @@SQL + "    EXEC "+@@ACCOUNTDB+"..CLS_RPT_ACC_MARGINLEDGER "        
	END
	SET @@SQL = @@SQL +"'" + @FDATE +"', "        
	SET @@SQL = @@SQL +"'" + @TDATE +"', "        
	SET @@SQL = @@SQL +"'" + @FCODE +"', "        
	SET @@SQL = @@SQL +"'" + @TCODE +"', "        
	SET @@SQL = @@SQL +"'" + @STRORDER +"', "        
	SET @@SQL = @@SQL +"'" + @SELECTBY +"', "        
	SET @@SQL = @@SQL +"'" + @STATUSID +"', "        
	SET @@SQL = @@SQL +"'" + @STATUSNAME +"', "        
	SET @@SQL = @@SQL +"'" +@STATUSNAME_TO+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY_LIST+"' "     
		           
IF @SHOWMARGIN = 1 
BEGIN
	PRINT(@@SQL)      
	EXEC (@@SQL)	
END

	IF @ORDERFLG = 'N'        
	BEGIN        
		UPDATE #TMPLEDGERNEW         
		SET   EXCHANGE =@@EXCHANGE,        
		SEGMENT = @@SEGMENT ,        
		ENTITY = 'MARGIN  LEDGER',         
		ORDERSEG = 2         
		WHERE SEGMENT IS NULL         
	END        
	ELSE        
	BEGIN        
		UPDATE #TMPLEDGERNEW         
		SET    EXCHANGE = @@EXCHANGE,        
		SEGMENT = @@SEGMENT,        
		ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN 'MARGIN-' + @@EXCHANGE ELSE @@GROUPID + ' - MARGIN LEDGER' END,        
		--IF @@ACCOUNTDB = 'ACCOUNT'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 4"        
		--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 5"        
		--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 6"        
            
		ORDERSEG = @@ORDERSEG+ @@ORDERSECOUNT        
		WHERE  SEGMENT IS NULL         
	END  
END  

IF @MARGINREQ = '1' AND @@SEGMENT = 'FUTURES' AND @@EXCHANGE = 'NSE'
BEGIN
	SET @@SQL = "  INSERT INTO #TMPLEDGERNEW( "        
	--SET @@SQL = @@SQL + " (BOOKTYPE, "        
	SET @@SQL = @@SQL + "  VOUDT, "        
	SET @@SQL = @@SQL + "  EFFDT, "        
	SET @@SQL = @@SQL + "  SHORTDESC, "        
	SET @@SQL = @@SQL + "  DRAMT, "        
	SET @@SQL = @@SQL + "  CRAMT, "        
	SET @@SQL = @@SQL + "  VNO, "        
	SET @@SQL = @@SQL + "  DDNO, "        
	SET @@SQL = @@SQL + "  NARRATION, "        
	SET @@SQL = @@SQL + "  CLTCODE, "        
	SET @@SQL = @@SQL + "  VTYP, "        
	SET @@SQL = @@SQL + "  VDT, "        
	SET @@SQL = @@SQL + "  EDT) "        
	/*SET @@SQL = @@SQL + "  ACNAME, "        
	SET @@SQL = @@SQL + "  OPBAL, "        
	SET @@SQL = @@SQL + "  L_ADDRESS1, "        
	SET @@SQL = @@SQL + "  L_ADDRESS2, "        
	SET @@SQL = @@SQL + "  L_ADDRESS3, "        
	SET @@SQL = @@SQL + "  L_CITY, "        
	SET @@SQL = @@SQL + "  L_ZIP, "        
	SET @@SQL = @@SQL + "  RES_PHONE1, "        
	SET @@SQL = @@SQL + "  BRANCH_CD, "        
	SET @@SQL = @@SQL + "  CROSAC, "        
	SET @@SQL = @@SQL + "  EDIFF, "        
	SET @@SQL = @@SQL + "  FAMILY, "        
	SET @@SQL = @@SQL + "  SUB_BROKER, "        
	SET @@SQL = @@SQL + "  TRADER, "        
	SET @@SQL = @@SQL + "  CL_TYPE, "        
	SET @@SQL = @@SQL + "  BANK_NAME, "        
	SET @@SQL = @@SQL + "  CLTDPID, "        
	SET @@SQL = @@SQL + "  LNO, "        
	SET @@SQL = @@SQL + "  PDT, "
	SET @@SQL = @@SQL +" PAN) "    */        

	SET @@SQL = @@SQL +"EXEC " + @@SHAREDB + "..CLS_V2_GETMARGINREQ "
	SET @@SQL = @@SQL +"'" + @TDATE + "',"
	SET @@SQL = @@SQL +"'" + @TDATE + "',"
	SET @@SQL = @@SQL +"'" + @FCODE + "',"
	SET @@SQL = @@SQL +"'" + @TCODE + "',"
	SET @@SQL = @@SQL +"'" + @STATUSID + "',"
	SET @@SQL = @@SQL +"'" + @STATUSNAME + "',"
	SET @@SQL = @@SQL +"'ho'"

	print 'MARGIN  REQ '+@@SQL
	EXEC (@@SQL)

	IF @ORDERFLG = 'N'        
	BEGIN        
		UPDATE #TMPLEDGERNEW         
		SET   EXCHANGE =@@EXCHANGE,        
		SEGMENT = @@SEGMENT ,        
		ENTITY = 'MARGIN  REQ',         
		ORDERSEG = 3         
		WHERE SEGMENT IS NULL         
	END        
	ELSE        
	BEGIN        
		UPDATE #TMPLEDGERNEW         
		SET    EXCHANGE = @@EXCHANGE,        
		SEGMENT = @@SEGMENT,        
		ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN 'MARGREQ-' + @@EXCHANGE ELSE @@GROUPID + ' - MARGIN REQ' END,        
		--IF @@ACCOUNTDB = 'ACCOUNT'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 4"        
		--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 5"        
		--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 6"        
            
		ORDERSEG = @@ORDERSEG+ @@ORDERSECOUNT        
		WHERE  SEGMENT IS NULL         
	END 
END    
         
        
FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB ,@@GROUPID, @@ORDERSEG           
END        
CLOSE @@MAINREC        
DEALLOCATE @@MAINREC     


IF @CHARGES_LEDGER <> '0'
BEGIN
	SET @@SQL = " INSERT INTO #TMPLEDGERNEW "        
	SET @@SQL = @@SQL + " (BOOKTYPE, "        
	SET @@SQL = @@SQL +" VOUDT, "        
	SET @@SQL = @@SQL +" EFFDT, "        
	SET @@SQL = @@SQL +" SHORTDESC, "        
	SET @@SQL = @@SQL +" DRAMT, "        
	SET @@SQL = @@SQL +" CRAMT, "        
	SET @@SQL = @@SQL +" VNO, "        
	SET @@SQL = @@SQL +" DDNO, "        
	SET @@SQL = @@SQL +" NARRATION, "        
	SET @@SQL = @@SQL +" CLTCODE, "        
	SET @@SQL = @@SQL +" VTYP, "        
	SET @@SQL = @@SQL +" VDT, "        
	SET @@SQL = @@SQL +" EDT, "        
	SET @@SQL = @@SQL +" ACNAME, "        
	SET @@SQL = @@SQL +" OPBAL, "        
	SET @@SQL = @@SQL +" L_ADDRESS1, "        
	SET @@SQL = @@SQL +" L_ADDRESS2, "        
	SET @@SQL = @@SQL +" L_ADDRESS3, "        
	SET @@SQL = @@SQL +" L_CITY, "        
	SET @@SQL = @@SQL +" L_ZIP, "        
	SET @@SQL = @@SQL +" RES_PHONE1, "        
	SET @@SQL = @@SQL +" BRANCH_CD, "        
	SET @@SQL = @@SQL +" CROSAC, "        
	SET @@SQL = @@SQL +" EDIFF, "        
	SET @@SQL = @@SQL +" FAMILY, "        
	SET @@SQL = @@SQL +" SUB_BROKER, "        
	SET @@SQL = @@SQL +" TRADER, "        
	SET @@SQL = @@SQL +" CL_TYPE, "        
	SET @@SQL = @@SQL +" BANK_NAME, "        
	SET @@SQL = @@SQL +" CLTDPID, "        
	SET @@SQL = @@SQL +" LNO, "        
	SET @@SQL = @@SQL +" PDT, "        
	SET @@SQL = @@SQL +" EMAIL, "        
	SET @@SQL = @@SQL +" MOBILE_PAGER, "        
	SET @@SQL = @@SQL +" PAN) "    
	IF @@SERVERNAME <> @@ACCOUNTSVR        
	SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTSVR+".ACCOUNT..CLS_RPT_ACC_CHARGELEDGER_WPARENT "        
	ELSE        
	SET @@SQL = @@SQL +" EXEC ACCOUNT..CLS_RPT_ACC_CHARGELEDGER_WPARENT "        
	SET @@SQL = @@SQL +"'" +@FDATE +"', "        
	SET @@SQL = @@SQL +"'" +@TDATE +"', "        
	SET @@SQL = @@SQL +"'" +@FCODE +"', "        
	SET @@SQL = @@SQL +"'" +@TCODE +"', "        
	SET @@SQL = @@SQL +"'" +@STRORDER +"', "        
	SET @@SQL = @@SQL +"'" +@SELECTBY +"', "        
	SET @@SQL = @@SQL +"'" +@STATUSID +"', "        
	SET @@SQL = @@SQL +"'" +@STATUSNAME+"', "        
	SET @@SQL = @@SQL +"'" +@STATUSNAME_TO+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY_LIST+"' ,"    
	SET @@SQL = @@SQL +"'" +@SESSIONID+"' "      
    
        
	--PRINT (@@SQL)  
        
	EXEC (@@SQL)   



	IF @ORDERFLG = 'N'        
	BEGIN        
		UPDATE #TMPLEDGERNEW         
		SET   EXCHANGE =@@EXCHANGE,        
		SEGMENT = @@SEGMENT ,        
		ENTITY = 'CHARGES  LEDGER',         
		ORDERSEG = 3         
		WHERE SEGMENT IS NULL         
	END        
	ELSE        
	BEGIN        
		UPDATE #TMPLEDGERNEW         
		SET    EXCHANGE = 'CHARGES',        
		SEGMENT = 'CHARGES',        
		ENTITY = 'CHARGES LEDGER',        
		--IF @@ACCOUNTDB = 'ACCOUNT'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 4"        
		--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 5"        
		--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'        
		-- SET @@SQL = @@SQL + "        ORDERSEG = 6"        
            
		ORDERSEG = 99        
		WHERE  SEGMENT IS NULL         
	END  
END
        
/* UPDATE CITY STATE */
	UPDATE A
	SET A.[L_CITY] = ISNULL(B.l_city,'') + ', ' + ISNULL(B.l_state,'')
--			[RES_PHONE1]= B.MOBILE_PAGER
	from #TMPLEDGERNEW A
			inner join msajag..CLIENT_DETAILS B
			ON A.CLTCODE = b.CL_CODE
	
/* UPDATE CITY STATE */

--SELECT TOP 1 * FROM msajag..CLIENT_DETAILS B

--IF ((SELECT COUNT(1) FROM [#DBNAME] WHERE ACCOUNTDB = 'ACCOUNTFO') = 1)        
--BEGIN        
--    INSERT INTO #TMPLEDGERNEW        
--              (VOUDT,        
--               EFFDT,        
--               SHORTDESC,        
--               DRAMT,        
--               CRAMT,        
--               VNO,        
--               DDNO,        
--               NARRATION,        
--               CLTCODE,        
--               VTYP,        
--               VDT,        
--             EDT)        
--    EXEC BSEFO.DBO.V2_GETMARGINREQ        
--      @TDATE ,        
--      @FCODE ,        
--      @TCODE ,        
--  @STATUSID ,        
--      @STATUSNAME ,        
--      @STRBRANCH        
         
              
--        UPDATE #TMPLEDGERNEW        
--        SET    EXCHANGE = 'NSE',        
--          SEGMENT = 'FUTURES',        
--               ENTITY = 'MARGIN REQ - NFO',        
--               ORDERSEG = (@@ORDERSECOUNT * 2)+ 1        
--        WHERE  SEGMENT IS NULL        
              
--END  

--IF @FORPDF = 'Y'        
--  BEGIN        

--  --SET @WHERECLAUS  = "WHERE  NARRATION = 'TOTAL BALANCE' AND DRAMT <> 0 AND CRAMT <> 0"
-- -- DELETE FROM #TMPLEDGERNEW WHERE (CRAMT = 0 AND DRAMT = 0 AND OPBAL = 0)
--  end

        
    IF @ORDERFLG = 'N'        
      BEGIN        
        SELECT   CLTCODE,        
				 EXCHANGE,        
				 SEGMENT,        
                 ORDERSEG,        
                 OPBAL = MAX(OPBAL)        
        INTO     #OPBAL        
        FROM     #TMPLEDGERNEW        
        GROUP BY CLTCODE,EXCHANGE,SEGMENT,ORDERSEG        
        
        
        SELECT   CLTCODE,        
                 ORDERSEG,        
                 OPBAL = SUM(OPBAL),
				 EXCHANGE = MAX(EXCHANGE),
				 SEGMENT = MAX(SEGMENT)        
        INTO     #FINOPBAL        
        FROM     #OPBAL        
        GROUP BY CLTCODE,ORDERSEG        
        
        UPDATE #TMPLEDGERNEW        
        SET    OPBAL = 0        
        
        UPDATE #TMPLEDGERNEW        
        SET    OPBAL = ISNULL(T.OPBAL,0)        
        FROM   #TMPLEDGERNEW L WITH (NOLOCK),        
               #FINOPBAL T WITH (NOLOCK)        
        WHERE          
			L.CLTCODE = T.CLTCODE                             
			AND L.ORDERSEG = T.ORDERSEG

--		DELETE T
--		FROM #TMPLEDGERNEW T WHERE NARRATION = 'OPENING BALANCE' AND NOT EXISTS(SELECT CLTCODE FROM  #FINOPBAL O WHERE T.CLTCODE = O.CLTCODE AND T.EXCHANGE = O.EXCHANGE AND T.SEGMENT = O.SEGMENT)
      END        
      UPDATE #TMPLEDGERNEW SET ACTIVE_SEG = EXCHLIST FROM MSAJAG..CLS_GET_CLIENT_FAM_EXCH_LIST C WHERE #TMPLEDGERNEW.CLTCODE = CL_CODE
	  UPDATE #TMPLEDGERNEW SET L_ADDRESS3= REPLACE(L_ADDRESS3,'\','/') 

	  
IF @ORDERFLG = 'Y'        
BEGIN                
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP,EMAIL,MOBILE_PAGER,PAN,BRANCH_CD)    
	SELECT 'OPBAL', DRAMT = CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END, CRAMT = CASE WHEN MAX(OPBAL) < 0 THEN MAX(ABS(OPBAL)) ELSE 0 END, 'OPENING BALANCE', CLTCODE, 18, convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_START), 103), convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_START), 103), ACNAME, MAX(OPBAL), @YEAR_START, EXCHANGE, SEGMENT, ENTITY,  
	ORDERSEG, ACTIVE_SEG,    
	VOUDT = CONVERT(DATETIME, @YEAR_START), EFFDT = CONVERT(DATETIME, @YEAR_START), CLTCODE, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP,EMAIL,MOBILE_PAGER ,PAN,BRANCH_CD   
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP,EMAIL,MOBILE_PAGER,PAN,BRANCH_CD
	--HAVING CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END <> 0 OR CASE WHEN MAX(OPBAL) < 0 THEN MAX(OPBAL) ELSE 0 END <> 0    
END 
ELSE
BEGIN
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP,EMAIL,MOBILE_PAGER,PAN,BRANCH_CD)    
	SELECT 'OPBAL', DRAMT = CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END, CRAMT = CASE WHEN MAX(OPBAL) < 0 THEN MAX(ABS(OPBAL)) ELSE 0 END, 'OPENING BALANCE', CLTCODE, 18, convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_START), 103), convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_START), 103), ACNAME, MAX(OPBAL), @YEAR_START, MAX(EXCHANGE), MAX(SEGMENT), ENTITY,  
	ORDERSEG, ACTIVE_SEG,    
	VOUDT = CONVERT(DATETIME, @YEAR_START), EFFDT = CONVERT(DATETIME, @YEAR_START), CLTCODE, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, max(L_ZIP),max(EMAIL),max(MOBILE_PAGER),max(PAN),max(BRANCH_CD)
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, ENTITY, ORDERSEG, ACTIVE_SEG, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY/*, L_ZIP,EMAIL,MOBILE_PAGER,PAN,BRANCH_CD   */  
	--HAVING CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END <> 0 OR CASE WHEN MAX(OPBAL) < 0 THEN MAX(OPBAL) ELSE 0 END <> 0    
END
    
-- SELECT * FROM #TMPLEDGERNEW      
--RETURN      
 DELETE FROM #TMPLEDGERNEW WHERE VTYP = 18 /*AND ISNULL(NARRATION, '') <> 'OPENING BALANCE'*/ AND ISNULL(SHORTDESC, '') <> 'OPBAL'    
    
/*SELECT * FROM #TMPLEDGERNEW T,    
(SELECT CLTCODE, COUNT(1) #TMPLEDGERNEW    
GROUP BY CLTCODE    
HAVING COUNT(1) = 1)    
WHERE T.CLTCODE = T1.CLTCODE AND T.DRAMT = 0 AND T.CRAMT = 0*/    
--select @YEAR_END,DATEADD(DAY,1,CONVERT(DATETIME, @YEAR_END))
IF @ORDERFLG = 'Y'        
BEGIN                    
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
	SELECT 'TBAL', DRAMT = SUM(DRAMT), CRAMT = CASE WHEN SUM(CRAMT) < 0 THEN -SUM(CRAMT) ELSE SUM(CRAMT) END,     
	'TOTAL BALANCE', CLTCODE, 98, convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_END), 103), convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_END), 103), ACNAME, MAX(OPBAL), @YEAR_END, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG,    
	VOUDT = DATEADD(DAY,1,CONVERT(DATETIME, @YEAR_END)), EFFDT = CONVERT(DATETIME, @YEAR_END), CLTCODE    
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG     
END
ELSE
BEGIN
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
	SELECT 'TBAL', DRAMT = SUM(DRAMT), CRAMT = CASE WHEN SUM(CRAMT) < 0 THEN -SUM(CRAMT) ELSE SUM(CRAMT) END,     
	'TOTAL BALANCE', CLTCODE, 98, convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_END), 103), convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_END), 103), ACNAME, MAX(OPBAL), @YEAR_END, EXCHANGE = MAX(EXCHANGE), SEGMENT = MAX(SEGMENT), ENTITY, ORDERSEG, ACTIVE_SEG,    
	VOUDT = DATEADD(DAY,1,CONVERT(DATETIME, @YEAR_END)), EFFDT = CONVERT(DATETIME, @YEAR_END), CLTCODE
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, ENTITY, ORDERSEG, ACTIVE_SEG     
END

INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
SELECT SHORTDESC = 'NTBAL', DRAMT = SUM(DRAMT), CRAMT = CASE WHEN SUM(CRAMT) < 0 THEN -SUM(CRAMT) ELSE SUM(CRAMT) END,     
'NET BALANCE', CLTCODE, 99, convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_END), 103), convert(VARCHAR(10), CONVERT(DATETIME, @YEAR_END), 103), ACNAME, MAX(OPBAL), @YEAR_END, EXCHANGE = MAX(EXCHANGE), SEGMENT = MAX(SEGMENT), ENTITY = MAX(ENTITY), ORDERSEG = MAX(ORDERSEG), ACTIVE_SEG = MAX(ACTIVE_SEG),    
VOUDT = DATEADD(DAY,1,CONVERT(DATETIME, @YEAR_END)), EFFDT = CONVERT(DATETIME, @YEAR_END), CLTCODE
FROM #TMPLEDGERNEW
WHERE SHORTDESC = 'TBAL'
GROUP BY CLTCODE, ACNAME --, ENTITY, ORDERSEG, ACTIVE_SEG


/* NEW PATCH ADDED TO UPDATE THE PARENT_CODE IN CASE OF PARENT SELECTION */
IF @PARENTCHILD_FLAG = 'P'
BEGIN
	UPDATE U SET CLTCODE = PARENT_CODE, ACNAME = PARENT_NAME FROM #TMPLEDGERNEW U, MSAJAG..CLS_CLIENT_PARTY_LEDGER C
	WHERE U.CLTCODE = C.PARTY_CODE
END
/* NEW PATCH ADDED TO UPDATE THE PARENT_CODE IN CASE OF PARENT SELECTION */     
         
 IF @FORPDF = 'Y'        
  BEGIN        

  --SET @WHERECLAUS  = "WHERE  NARRATION = 'TOTAL BALANCE' AND DRAMT <> 0 AND CRAMT <> 0"
 -- DELETE FROM #TMPLEDGERNEW WHERE (CRAMT <>0 AND DRAMT <> 0 OR OPBAL <> 0)

   ALTER TABLE #TMPLEDGERNEW ADD PDFLINES INT        
   UPDATE #TMPLEDGERNEW SET PDFLINES = LEN(LTRIM(RTRIM(ISNULL(NARRATION, '')))) / 35 + 1 WHERE VTYP <> '18'        
   UPDATE #TMPLEDGERNEW SET PDFLINES = (I.LNO + 1) FROM (SELECT CLTCODE, LNO = SUM(PDFLINES) FROM #TMPLEDGERNEW GROUP BY CLTCODE) I        
     WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE        
        
        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = CEILING(CONVERT(NUMERIC(10,2), LEN(ISNULL(NARRATION, ''))) / 35)        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = 1 WHERE LEN(ISNULL(NARRATION, '')) = 0        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = (SELECT SUM(PARTYROWCOUNT) /*+ COUNT(DISTINCT ORDERSEG)*/ FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = PARTYROWCOUNT + (SELECT (COUNT(DISTINCT ORDERSEG) * 1) + 1 FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)        
   UPDATE #TMPLEDGERNEW SET TOTALPAGES = .DBO.PARTYLEDGERPAGES(PARTYROWCOUNT)        
        
        
  END        
        
        
--  BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
      
IF @CSV = 'Y'      
BEGIN  
  
CREATE TABLE #PARTYLEDGERCSV      
(      
 CLTCODE VARCHAR(10),      
 VOUCHER_DATE VARCHAR(10),       
 EFFECTIVE_DATE VARCHAR(10),     
 VTYPE VARCHAR(15),       
 VNO VARCHAR(15),       
 AC_CODE VARCHAR(10),       
 PERTIULARS VARCHAR(500),       
 DDNO VARCHAR(20),       
 DRAMT MONEY,       
 CRAMT MONEY,      
 ENTITY     VARCHAR(50),        
 ORDERSEG   BIGINT,        
 BALANCE MONEY,      
 SNO INT IDENTITY(1, 1)      
)   

    
 INSERT INTO #PARTYLEDGERCSV      
 (      
  CLTCODE, VOUCHER_DATE, EFFECTIVE_DATE, VTYPE, VNO, AC_CODE,       
  PERTIULARS, DDNO, DRAMT, CRAMT, ENTITY, ORDERSEG      
 ) 
 SELECT       
  CLTCODE, VOUCHER_DATE = '', EFFECTIVE_DATE = '', VTYPE = 'OPENING', VNO = '', AC_CODE = CLTCODE,       
  PERTIULARS = 'OPENING ENTRY', DDNO = '', DRAMT = CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END,       
  CRAMT = CASE WHEN MAX(OPBAL) <= 0 THEN MAX(ABS(OPBAL)) ELSE 0 END, ENTITY, ORDERSEG      
 FROM   #TMPLEDGERNEW
 GROUP BY CLTCODE, ENTITY, ORDERSEG      
 ORDER BY       
  CLTCODE,        
  ORDERSEG      
  
 INSERT INTO #PARTYLEDGERCSV      
 (      
  CLTCODE, VOUCHER_DATE, EFFECTIVE_DATE, VTYPE, VNO, AC_CODE,       
  PERTIULARS, DDNO, DRAMT, CRAMT, ENTITY, ORDERSEG      
 )      
 SELECT   CLTCODE, VOUCHER_DATE = CONVERT(VARCHAR(10),VDT,103), EFFECTIVE_DATE = CONVERT(VARCHAR(10),EDT,103) , VTYPE = SHORTDESC, isnull(VNO,''), AC_CODE = CASE WHEN SHORTDESC = 'OPBAL ' THEN CLTCODE ELSE CROSAC END,   PERTIULARS = NARRATION, isnull(DDNO,''), DRAMT, CRAMT, ENTITY, ORDERSEG      
 FROM  #TMPLEDGERNEW      
 WHERE     VOUDT IS NOT NULL  AND VTYP <> 18    
 ORDER BY       
  CLTCODE,        
  ORDERSEG,        
  VOUDT        
        
 UPDATE P      
 SET BALANCE = (SELECT SUM( CRAMT-DRAMT) FROM #PARTYLEDGERCSV P1 WHERE P.CLTCODE = P1.CLTCODE AND P.ENTITY = P1.ENTITY AND P.ORDERSEG = P1.ORDERSEG AND P1.SNO <= P.SNO)      
 FROM #PARTYLEDGERCSV P      

 UPDATE #PARTYLEDGERCSV SET BALANCE = DRAMT - CRAMT WHERE PERTIULARS IN('TOTAL BALANCE', 'NET BALANCE')
       
 SELECT  *       FROM #PARTYLEDGERCSV ORDER BY CLTCODE, ORDERSEG, SNO      

RETURN
       
END      
    
	IF @VTYPE <> ''
	BEGIN
		DELETE FROM #TMPLEDGERNEW WHERE  VTYP <> @VTYPE
	END


DECLARE @SHOWQuartely INT
DECLARE @BOUNCE INT
DECLARE @CHKDISPATH VARCHAR(2)

SELECT @SHOWQuartely = PVALUE FROM CLS_CLIENT_LEDGER_PARAMETERS WHERE PKEY = 'CHK_QUARTELY' AND SESSIONID = @SESSIONID
SELECT @BOUNCE = PVALUE FROM CLS_CLIENT_LEDGER_PARAMETERS WHERE PKEY = 'CHK_BOUNCE' AND SESSIONID = @SESSIONID
SELECT @CHKDISPATH = PVALUE FROM CLS_CLIENT_LEDGER_PARAMETERS WHERE PKEY = 'chkDispath' AND SESSIONID = @SESSIONID

SET @SHOWQUARTELY = @SHOWQUARTELY + @BOUNCE


   /* CHANGES FOR ECN FLAG */
  
   IF(@ECNFLAG IN ('0','2') AND @SHOWQUARTELY <> 1 )
   BEGIN
   		--DELETE ALL JV ENTRY
		SELECT DISTINCT CLTCODE 
		INTO #QTR_CLIENTS
		FROM #TMPLEDGERNEW 
		WHERE VTYP NOT IN (8,18,98,99)
		--ISNULL(VTYP, '8') <> '8' 
				
		SELECT DISTINCT CLTCODE 
		INTO #QTR_CLIENTS1
		FROM #TMPLEDGERNEW 
		WHERE CRAMT - DRAMT >= 1000 
		AND NARRATION = 'NET BALANCE'
		
		DELETE  T FROM #TMPLEDGERNEW T
		WHERE NOT EXISTS (SELECT CLTCODE FROM #QTR_CLIENTS Q WHERE T.CLTCODE = Q.CLTCODE)
		  
		DELETE  T FROM #TMPLEDGERNEW T
		WHERE NOT EXISTS (SELECT CLTCODE FROM #QTR_CLIENTS1 Q WHERE T.CLTCODE = Q.CLTCODE)
		  
   END 
  

--IF(@CHKDISPATH = '1')
--BEGIN

--INSERT INTO ACCOUNT.DBO.TBL_DISPATCH_CLIENT_LEDGER 
--SELECT DISTINCT CLTCODE , [ACNAME],@SESSIONID
--FROM #TMPLEDGERNEW

--RETURN 

--END 

--select * from #TMPLEDGERNEW


  -- UPDATE B SET B.BRANCH_CD = A.BRANCH_CD, b.cltcode = ltrim(rtrim(cltcode)), b.crosac = ltrim(rtrim(crosac)) FROM MSAJAG..CLIENT_DETAILS A, #TMPLEDGERNEW B  WHERE A.PARTY_CODE = B.CLTCODE
   

 -- select distinct cltcode ,[ACNAME] into QLedger from  #TMPLEDGERNEW return 
   /* CHANGES FOR ECN FLAG */


   UPDATE #TMPLEDGERNEW SET VTYP = 0 WHERE SHORTDESC = 'OPBAL'

	IF @DASHBOARD = 'Y'
	  BEGIN
	  PRINT 'DASHBOARD'
	  /*
	  ALTER TABLE #TMPLEDGERNEW
	  ADD RBalance MONEY
	  */
	 

	  SELECT 'VOUDT' as VOUDT,'EFFDT' as EFFDT,'SHORTDESC' as SHORTDESC,'DRAMT' as DRAMT,'CRAMT' as CRAMT,'VNO' as VNO,
		'DDNO' as DDNO,'NARRATION' as NARRATION,'CLTCODE' as CLTCODE,'ACNAME' as ACNAME,'VTYP' as VTYP,'VDT' as VDT,'EDT' as EDT,'BRANCH_CD' as BRANCH_CD,'CROSAC' as CROSAC,'EDIFF' as EDIFF,'ENTITY' as ENTITY,'EXCSEG' as EXCSEG,
			 '0' AS ORDERSEG, 
			'VOUDT'+'$'+'EFFDT'+'$'+'SHORTDESC'+'$'+'DRAMT'+'$'+'CRAMT'+'$'+'VNO'+'$'+'DDNO'+'$'+'NARRATION'+'$'+'VTYP'+'$'+'VDT'+'$'+'EDT'+'$'+'EDIFF' AS CENTERBODY
			
	 UNION ALL 
	
	SELECT 	CONVERT(VARCHAR,  VOUDT)as VOUDT,CONVERT(VARCHAR,  EFFDT) as EFFDT, SHORTDESC as SHORTDESC,CONVERT(VARCHAR,DRAMT) as DRAMT,CONVERT(VARCHAR, CRAMT)  as CRAMT
			, CASE  WHEN  VNO IS NULL THEN '0' ELSE  VNO END  as VNO
			, CASE WHEN  DDNO  IS NULL THEN '0' ELSE  DDNO END  as DDNO
			, NARRATION as NARRATION , CLTCODE, ACNAME,CONVERT(VARCHAR, VTYP) as VTYP
			,CONVERT(VARCHAR, CONVERT(DATETIME, VDT,103),103) as VDT
			,CONVERT(VARCHAR, EDT)  as EDT
			, CASE WHEN  BRANCH_CD  IS NULL THEN '0' ELSE  BRANCH_CD END  as BRANCH_CD
			, CROSAC as CROSAC
			,CASE WHEN CONVERT(VARCHAR, EDIFF)  IS NULL THEN '0' ELSE CONVERT(VARCHAR, EDIFF) END  as EDIFF
			, ENTITY as ENTITY
			,EXCSEG= EXCHANGE+'-'+ SEGMENT ,-- RUNNINGBAL = SUM(T2.DRAMT - T2.CRAMT),
			 CONVERT(VARCHAR,  ORDERSEG) ORDERSEG,  
			CONVERT(VARCHAR,  VOUDT)+'$'+
			CONVERT(VARCHAR,  EFFDT)+'$'+
			 SHORTDESC+'$'+  
			CONVERT(VARCHAR, DRAMT)+'$'+  
			CONVERT(VARCHAR, CRAMT)+'$'+  
			ISNULL(  VNO  ,'0')+'$'+  
			ISNULL(  DDNO ,'0')+'$'+ 
			 NARRATION+'$'+  
			CONVERT(VARCHAR, VTYP)+'$'+
			CONVERT(VARCHAR, CONVERT(DATETIME, VDT,103),103)+'$'+  
			CONVERT(VARCHAR, EDT)+'$'+  
			ISNULL( CONVERT(VARCHAR, EDIFF) ,'0')  AS CENTERBODY
FROM #TMPLEDGERNEW 
ORDER BY ORDERSEG  , CLTCODE, VDT ,VNO 

--		INNER JOIN #TMPLEDGERNEW  AS t2
--	ON T1.CLTCODE >= T2.CLTCODE
--GROUP BY T1.VOUDT, T1.EFFDT , T1.SHORTDESC, T1.DRAMT ,T1.CRAMT , T1.VNO,T1.DDNO ,T1.NARRATION , T1.ENTITY ,
--	T1.CLTCODE, T1.ACNAME, T1.VTYP, T1.VDT, T1.EDT, T1.BRANCH_CD, T1.CROSAC, T1.EDIFF, T1.EXCHANGE, T1.SEGMENT

	  /*
	    INSERT INTO #TEMPDASHBOARD
		SELECT * FROM #TMPLEDGERNEW
		ORDER BY CLTCODE,ORDERSEG,  CONVERT(VARCHAR, CONVERT(DATETIME,VDT,103),103) ,VNO
	 */
	  END
	  ELSE
	  BEGIN	  
	  CREATE TABLE #LEDGER_RUNNING_DATA
	  (
		SNO INT IDENTITY(1, 1),
		BOOKTYPE VARCHAR(3),
		VOUDT DATETIME,
		EFFDT DATETIME,
		VDT VARCHAR(11),
		EDT VARCHAR(11), 
		SHORTDESC VARCHAR(100),
		VNO VARCHAR(12),
		CROSAC VARCHAR(10),
		DDNO VARCHAR(30),
		NARRATION VARCHAR(500),
		DRAMT MONEY,
		CRAMT MONEY,
		CLTCODE VARCHAR(10),
		VTYP INT,
		ACNAME VARCHAR(100),
		OPBAL MONEY,
		L_ADDRESS1 VARCHAR(100),
		L_ADDRESS2 VARCHAR(100),
		L_ADDRESS3 VARCHAR(100),
		L_CITY VARCHAR(50),
		L_ZIP VARCHAR(30),
		RES_PHONE1 VARCHAR(30),
		BRANCH_CD VARCHAR(20),
		EDIFF INT,
		FAMILY VARCHAR(10),
		SUB_BROKER VARCHAR(30),
		TRADER VARCHAR(30),
		CL_TYPE VARCHAR(10),
		BANK_NAME VARCHAR(100),
		CLTDPID VARCHAR(100),
		LNO INT,
		PDT DATETIME,
		EMAIL VARCHAR(100),
		MOBILE_PAGER VARCHAR(30),
		PAN VARCHAR(30),
		EXCHANGE VARCHAR(10),
		SEGMENT  VARCHAR(10),
		ENTITY  VARCHAR(20),
		ORDERSEG INT,
		ACTIVE_SEG  VARCHAR(100),
		PARTYROWCOUNT INT,
		TOTALPAGES INT, 
		CLTCODE_TODISPLAY VARCHAR(50), 
		CHECKSTATUS VARCHAR(20) , 
		COLORFLAG VARCHAR(10), 
		ENTITY_DESC VARCHAR(500), 
		REPORT_DATE VARCHAR(20),
		RUNNING_BAL MONEY
	)
	  IF @STRORDER = 'ACCODE'        
      BEGIN    
		
        IF @SELECTBY = 'VDT'        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN
				INSERT INTO #LEDGER_RUNNING_DATA        
			    SELECT  BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END, SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO = ISNULL(CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END ,''),NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = T.EXCHANGE,SEGMENT = T.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END  , CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END , COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END, ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), RUNNING_BAL = 0
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT				     
				--WHERE T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT        
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                        CONVERT(DATETIME,CONVERT(VARCHAR(10),VOUDT,101)),PDT, VNO,VTYP 
						
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (sELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO        
              END        
            ELSE        
              BEGIN  

			  INSERT INTO #LEDGER_RUNNING_DATA        
			     SELECT    BOOKTYPE=ISNULL(BOOKTYPE,''),VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO=ISNULL(VNO,''),CROSAC,DDNO = ISNULL(CASE WHEN DDNO = '0' THEN '' ELSE DDNO END,''),NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1=ISNULL(L_ADDRESS1,''),L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = t.EXCHANGE,SEGMENT = t.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES , CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END , COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END , ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), running_bal = 0
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT	        
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         CONVERT(DATETIME,CONVERT(VARCHAR(10),VOUDT,101)),PDT, VNO,VTYP
						
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (sELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO   
			  
                       
              END        
          END        
        ELSE        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN  
			        
			  INSERT INTO #LEDGER_RUNNING_DATA     
			    SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO
                SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = T.EXCHANGE,SEGMENT = T.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END , COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END ,ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), RUNNING_BAL = 0
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT	        
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         CONVERT(DATETIME,CONVERT(VARCHAR(10),EFFDT,101)),PDT,VTYP          
						  
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (SELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				
              END        
            ELSE        
              BEGIN
			  
				INSERT INTO #LEDGER_RUNNING_DATA     
			    SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = T.EXCHANGE,SEGMENT = T.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END  ,COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END, ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), RUNNING_BAL = 0
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT	       
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         CONVERT(DATETIME,CONVERT(VARCHAR(10),EFFDT,101)),PDT ,VTYP 
						  
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (SELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)    
			      
                      
              END        
          END        
      END        
  ELSE        
 BEGIN        
 IF @SELECTBY = 'VDT' 
	      BEGIN        
		    IF @ORDERFLG = 'N'        
              BEGIN
				INSERT INTO #LEDGER_RUNNING_DATA     
			    SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = t.EXCHANGE,SEGMENT = t.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END, ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103),
				RUNNING_BAL = 0
				FROM     #TMPLEDGERNEW T left outer join CLS_COMPANY_MASTER_SETTING C        
				on T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT
                ORDER BY ACNAME,        
                         ORDERSEG,        
                          CONVERT(DATETIME,CONVERT(VARCHAR(10),VOUDT,101)),PDT, VNO  
						  
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (SELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO
              END        
            ELSE        
              BEGIN   
			  
			  INSERT INTO #LEDGER_RUNNING_DATA     
			    SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL'  THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = T.EXCHANGE,SEGMENT = T.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END , ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), RUNNING_BAL = 0         
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT	       
                ORDER BY ACNAME,        
                         ORDERSEG,        
                         CONVERT(DATETIME,CONVERT(VARCHAR(10),VOUDT,101)),PDT, VNO,VTYP    
						  
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (SELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO     
			
                     
              END        
          END        
        ELSE        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN 
			  
				INSERT INTO #LEDGER_RUNNING_DATA     
			    SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL'  THEN '' ELSE SHORTDESC END,CROSAC,VNO,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = t.EXCHANGE,SEGMENT = t.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES , CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END, ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), RUNNING_BAL = 0          
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT	         
                ORDER BY cltcode,        
                         ORDERSEG,        
                         CONVERT(DATETIME,CONVERT(VARCHAR(10),EFFDT,101)),PDT ,VTYP        
						  
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (SELECT SUM(CRAMT - DRAMT) FROM #LEDGER_RUNNING_DATA L WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO    
			
                
              END        
            ELSE        
              BEGIN
			  
				INSERT INTO #LEDGER_RUNNING_DATA     
			    SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,CROSAC,VNO,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE = t.EXCHANGE,SEGMENT = t.SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END, ENTITY_DESC = ISNULL(C.SEGMENT_DESCRIPTION,'CHARGES ENTRIES'), REPORT_DATE = CONVERT(VARCHAR(10), GETDATE(), 103), RUNNING_BAL = 0       
                FROM     #TMPLEDGERNEW T LEFT OUTER JOIN CLS_COMPANY_MASTER_SETTING C
				ON    T.EXCHANGE = C.EXCHANGE AND T.SEGMENT = C.SEGMENT	          
                ORDER BY cltcode,        
                         ORDERSEG,        
                         CONVERT(DATETIME,CONVERT(VARCHAR(10),EFFDT,101)) ,PDT,VTYP        
						  
				UPDATE #LEDGER_RUNNING_DATA SET RUNNING_BAL = (SELECT SUM(CRAMT - DRAMT) 
				FROM #LEDGER_RUNNING_DATA L 
				WHERE #LEDGER_RUNNING_DATA.CLTCODE = L.CLTCODE AND #LEDGER_RUNNING_DATA.ENTITY = L.ENTITY AND L.SNO <= #LEDGER_RUNNING_DATA.SNO)

				SELECT * FROM #LEDGER_RUNNING_DATA ORDER BY SNO    
			
                
              END        
          END        
      END 
  END   
END    

--    IF @STRORDER = 'ACCODE' 
	
--      BEGIN        
--        IF @SELECTBY = 'VDT'        
--          BEGIN        
--            IF @ORDERFLG = 'N'        
--              BEGIN   
--			    SELECT  BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END, SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO = ISNULL(CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END ,''),NARRATION,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END  , CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END , COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END  
--                FROM     #TMPLEDGERNEW        
            
--                ORDER BY CLTCODE,   ACNAME,     
--                         ORDERSEG,        
--                         VOUDT, VNO        
--              END        
--            ELSE        
--              BEGIN  
--                SELECT    BOOKTYPE=ISNULL(BOOKTYPE,''),VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO=ISNULL(VNO,''),CROSAC,DDNO = ISNULL(CASE WHEN DDNO = '0' THEN '' ELSE DDNO END,''),NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1=ISNULL(L_ADDRESS1,''),L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES , CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END , COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END   
--                FROM     #TMPLEDGERNEW        
--                ORDER BY CLTCODE,   ACNAME,     
--                         ORDERSEG,        
--                         VOUDT, VNO,VTYP        
--              END        
--          END        
--        ELSE        
--          BEGIN        
--            IF @ORDERFLG = 'N'        
--              BEGIN        
--                SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END , COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END  
--                FROM     #TMPLEDGERNEW        
--                ORDER BY CLTCODE,  ACNAME,      
--                         ORDERSEG,        
--                         EFFDT        
--              END        
--            ELSE        
--              BEGIN        
--                SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END  ,COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END  
--                FROM     #TMPLEDGERNEW        
--                ORDER BY CLTCODE,  ACNAME,      
--                         ORDERSEG,        
--                         EFFDT ,VTYP       
--              END        
--          END        
--      END        
--  ELSE        
-- BEGIN        
-- IF @SELECTBY = 'VDT'        
--          BEGIN        
--            IF @ORDERFLG = 'N'        
--              BEGIN   
			    
--			    SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END            
--                FROM     #TMPLEDGERNEW T        
--                ORDER BY ACNAME,   CLTCODE,     
--                         ORDERSEG,        
--                         VOUDT, VNO, VTYP        
--              END        
--            ELSE        
--              BEGIN        
--                SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL'  THEN '' ELSE SHORTDESC END,VNO,CROSAC,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END            
--                FROM     #TMPLEDGERNEW        
--                ORDER BY ACNAME,    CLTCODE,    
--                         ORDERSEG,        
--                         VOUDT, VNO, VTYP        
--              END        
--          END        
--        ELSE        
--          BEGIN        
--            IF @ORDERFLG = 'N'        
--              BEGIN        
--                SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL'  THEN '' ELSE SHORTDESC END,CROSAC,VNO,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES , CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END            
--                FROM     #TMPLEDGERNEW        
--                ORDER BY ACNAME,   CLTCODE,     
--                         ORDERSEG,        
--                         EFFDT , VTYP       
--              END        
--            ELSE        
--              BEGIN        
--                SELECT    BOOKTYPE,VOUDT,EFFDT,VDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),VDT,103) END,EDT = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CONVERT(VARCHAR(11),EDT,103) END,SHORTDESC = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE SHORTDESC END,CROSAC,VNO,DDNO  = CASE WHEN DDNO = '0' THEN NULL ELSE DDNO END,NARRATION,DRAMT,CRAMT,CLTCODE,VTYP,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,EDIFF=ISNULL(EDIFF,0),FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EMAIL,MOBILE_PAGER,PAN,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES, CLTCODE_TODISPLAY =  CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE CLTCODE END, CHECKSTATUS = CASE WHEN SHORTDESC = 'NTBAL' OR SHORTDESC = 'TBAL' THEN '' ELSE (CASE WHEN EFFDT > @TDATE THEN 'U' ELSE '' END) END, COLORFLAG = CASE WHEN EFFDT > CONVERT(VARCHAR(11),GETDATE(),109)+' 23:59' THEN '0' ELSE '1' END          
--                FROM     #TMPLEDGERNEW        
--                ORDER BY ACNAME,     CLTCODE,   
--                         ORDERSEG,        
--                         EFFDT, VTYP        
--              END        
--          END        
--      END 
--  END   
--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS
-- --------------------------------------------------


--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS]--- take backup --done
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM AngelNSECM.account.dbo.CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
  
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(40),           
	L_ADDRESS2  VARCHAR(40),           
	L_ADDRESS3 VARCHAR(40),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)




--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C1.CL_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM NSESLBS.DBO.CLIENT1 C1 WITH(NOLOCK)/*,           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE */
      WHERE C1.CL_CODE BETWEEN @FCODE AND @TCODE AND EXISTS(SELECT CLTCODE FROM FORMULA_CLIENT_MASTER_PARENT C WHERE C1.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT LIKE @FDATE + '%'
                        AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18) B
						INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
				  --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                  GROUP BY CLTCODE

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT > = @@OPENDATE + ' 00:00:00'  AND VDT < @FDATE          
                        AND CLTCODE BETWEEN @FCODE AND @TCODE ) B                          
						INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
				  --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                  
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK)  WHERE EDT LIKE @@OPENDATE + '%'           
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18)   B   
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                                
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT < @@OPENDATE          
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND EDT >= @@OPENDATE) B
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                               
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
							FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE EDT LIKE @@OPENDATE + '%'           
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18) B     
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE     
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                              
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE
									AND CLTCODE BETWEEN @FCODE AND @TCODE          
                                    AND VTYP <> 18) B  
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE         
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                        
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER B WITH(NOLOCK) WHERE VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE AND CLTCODE BETWEEN @FCODE AND @TCODE  ) B 
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE         
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                            
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK) inner join           
                  VMAST V WITH(NOLOCK)   on L.VTYP = V.VTYPE
				  inner join #LEDGERCLIENTS on PARTY_CODE = CLTCODE        
            WHERE VDT between @FDATE + ' 00:00:00' 
				  AND @TDATE +' 23:59:59' 
				  --AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                             
				  --AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK) inner join           
                  VMAST V WITH(NOLOCK)   on L.VTYP = V.VTYPE
				  inner join #LEDGERCLIENTS on PARTY_CODE = CLTCODE        
            WHERE EDT between @FDATE + ' 00:00:00' 
				  AND @TDATE +' 23:59:59'   
				--  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)        
                  --AND L.VTYP = V.VTYPE           
                  --AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                           
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       [EMAIL] VARCHAR(500),
       [MOBILE_PAGER] VARCHAR(50)
       ,PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			EMAIL,
			MOBILE_PAGER
			,C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
         --select * from #TMPLEDGER 
         
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM LEDGER B WITH(NOLOCK),           
            (SELECT CLTCODE FROM ACMAST WITH(NOLOCK) WHERE ACCAT = 2) V            
      WHERE B.CLTCODE = V.CLTCODE           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS_18102022
-- --------------------------------------------------

--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS_18102022]--- take backup --done
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM ANAND1.account.dbo.CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
  
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(40),           
	L_ADDRESS2  VARCHAR(40),           
	L_ADDRESS3 VARCHAR(40),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)




--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C1.CL_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK)/*,           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE */
      WHERE C1.CL_CODE BETWEEN @FCODE AND @TCODE AND EXISTS(SELECT CLTCODE FROM FORMULA_CLIENT_MASTER_PARENT C WHERE C1.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT LIKE @FDATE + '%'
                        AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18) B
						INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
				  --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                  GROUP BY CLTCODE

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT > = @@OPENDATE + ' 00:00:00'  AND VDT < @FDATE          
                        AND CLTCODE BETWEEN @FCODE AND @TCODE ) B                          
						INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
				  --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                  
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK)  WHERE EDT LIKE @@OPENDATE + '%'           
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18)   B   
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                                
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT < @@OPENDATE          
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND EDT >= @@OPENDATE) B
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                               
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
							FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE EDT LIKE @@OPENDATE + '%'           
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18) B     
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE     
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                              
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE
									AND CLTCODE BETWEEN @FCODE AND @TCODE          
                                    AND VTYP <> 18) B  
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE         
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                        
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER B WITH(NOLOCK) WHERE VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE AND CLTCODE BETWEEN @FCODE AND @TCODE  ) B 
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE         
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                            
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK) inner join           
                  VMAST V WITH(NOLOCK)   on L.VTYP = V.VTYPE
				  inner join #LEDGERCLIENTS on PARTY_CODE = CLTCODE        
            WHERE VDT between @FDATE + ' 00:00:00' 
				  AND @TDATE +' 23:59:59' 
				  --AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                             
				  --AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK) inner join           
                  VMAST V WITH(NOLOCK)   on L.VTYP = V.VTYPE
				  inner join #LEDGERCLIENTS on PARTY_CODE = CLTCODE        
            WHERE EDT between @FDATE + ' 00:00:00' 
				  AND @TDATE +' 23:59:59'   
				--  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)        
                  --AND L.VTYP = V.VTYPE           
                  --AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                           
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       [EMAIL] VARCHAR(500),
       [MOBILE_PAGER] VARCHAR(50)
       ,PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			EMAIL,
			MOBILE_PAGER
			,C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
         --select * from #TMPLEDGER 
         
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM LEDGER B WITH(NOLOCK),           
            (SELECT CLTCODE FROM ACMAST WITH(NOLOCK) WHERE ACCAT = 2) V            
      WHERE B.CLTCODE = V.CLTCODE           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_ACC_LEDGER_FORMULA_BALANCES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_GET_ACC_LEDGER_FORMULA_BALANCES] 
	@FR_DATE VARCHAR(11),-- FROM DATE OF THE PERIOD 
	@EFFDATE VARCHAR(11),-- DATE FOR WHICH THE BALANCE IS REQUIRED  
	@PROCESS_CODE VARCHAR(10),-- PROCESS CODE FROM THE FORMULA MASTER  
	@REPORT_FORMULA VARCHAR(MAX),-- IN CASE NOT TO SET THE FORMULA AND GET THE SPECIFIEC FIELDS
	@EXCHANGE VARCHAR(10) = '',-- EXCHANGE
	@SEGMENT VARCHAR(50) = '',-- SEGMENT
	@REPORT_COLUMN VARCHAR(1000) = '', 
	@REPORT_GROUPING VARCHAR(1000) = '',
	@TABLE_NAME  VARCHAR(1000) = '' 
	
AS
SELECT @REPORT_FORMULA = FORMULANAME
FROM FORMULA_MASTER
WHERE PROCESSCODE = @PROCESS_CODE


IF @EXCHANGE = ''
BEGIN
	SELECT @EXCHANGE = EXCHANGE
		,@SEGMENT = SEGMENT
	FROM OWNER
END

DECLARE @START_DATE VARCHAR(11)

IF LEN(@FR_DATE) = 10
	SELECT @FR_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FR_DATE, 103), 109)

IF LEN(@EFFDATE) = 10
BEGIN
	SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)
END

SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)
FROM PARAMETER
WHERE @EFFDATE BETWEEN SDTCUR
		AND LDTCUR

DECLARE @MIN_BILL_DATE VARCHAR(11)
	,@MAX_BILL_DATE VARCHAR(11)

SELECT @MIN_BILL_DATE = CONVERT(VARCHAR(11), MIN(VDT), 109)
	,@MAX_BILL_DATE = CONVERT(VARCHAR(11), MAX(VDT), 109)
FROM (
	SELECT TOP 2 *
	FROM BILLPOSTED
	WHERE VDT <= @EFFDATE
	ORDER BY VDT DESC
	) A

CREATE TABLE #REPORT_DATA (
	CLTCODE VARCHAR(10)
	,VDTBAL_OPBAL MONEY
	,EDTBAL_OPBAL MONEY
	,VDTBAL_DATES MONEY
	,EDTBAL_DATES MONEY
	,VDTBAL_DATES_CREDIT MONEY
	,VDTBAL_DATES_DEBIT MONEY
	,EDTBAL_DATES_CREDIT MONEY
	,EDTBAL_DATES_DEBIT MONEY
	,VDTBAL MONEY
	,EDTBAL MONEY
	,VDTBAL_RECEIPT MONEY
	,T_DAY_BILL MONEY
	,T1_DAY_BILL MONEY
	,VDTBAL_BILL_DR MONEY
	,VDTBAL_BILL_CR MONEY
	,VDTBAL_NONBILL MONEY
	,EDTBAL_RECEIPT MONEY
	,EDTBAL_BILL_DR MONEY
	,EDTBAL_BILL_CR MONEY
	,EDTBAL_NONBILL MONEY
	,FDT_RECEIPT MONEY
	,FDT_CREDIT_BILLS MONEY
	,FDT_DEBIT_BILLS MONEY
	,FDT_CR MONEY
	,FDT_DR MONEY
	,FDT_BAL MONEY
	,MARGIN_BAL MONEY
	)

DECLARE @@SQL VARCHAR(MAX)

SELECT L.* INTO #LEDGER
FROM LEDGER L(NOLOCK)
		,#FORMULA_CLIENT_MASTER A
	WHERE A.CLTCODE = L.CLTCODE --AND SESSION_ID = @SESSIONID
		AND (
			VDT >= @START_DATE
			OR EDT >= @START_DATE
			)
		AND VDT <= @EFFDATE + ' 23:59'
		AND CDT <= DATEADD(MI, -5, GETDATE() )

INSERT INTO #REPORT_DATA
SELECT CLTCODE
	,VDTBAL_OPBAL = SUM(VDTBAL_OPBAL)
	,EDTBAL_OPBAL = SUM(EDTBAL_OPBAL)
	,VDTBAL_DATES = SUM(VDTBAL_DATES)
	,EDTBAL_DATES = SUM(EDTBAL_DATES)
	,VDTBAL_DATES_CREDIT = SUM(VDTBAL_DATES_CREDIT)
	,VDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
	,EDTBAL_DATES_CREDIT = SUM(EDTBAL_DATES_CREDIT)
	,EDTBAL_DATES_DEBIT = SUM(EDTBAL_DATES_DEBIT)
	,VDTBAL = SUM(VDTBAL)
	,EDTBAL = SUM(EDTBAL)
	,VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT)
	,T_DAY_BILL = SUM(T_DAY_BILL)
	,T1_DAY_BILL = SUM(T1_DAY_BILL)
	,VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR)
	,VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR)
	,VDTBAL_NONBILL = SUM(VDTBAL_NONBILL)
	,EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT)
	,EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR)
	,EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR)
	,EDTBAL_NONBILL = SUM(EDTBAL_NONBILL)
	,FDT_RECEIPT = SUM(FDT_RECEIPT)
	,FDT_CREDIT_BILLS = SUM(FDT_CREDIT_BILLS)
	,FDT_DEBIT_BILLS = SUM(FDT_DEBIT_BILLS)
	,FDT_CR = SUM(FDT_CR)
	,FDT_DR = SUM(FDT_DR)
	,FDT_BAL = SUM(FDT_BAL)
	,MARGIN_BAL = 0
FROM (
	SELECT CLTCODE = L.CLTCODE
		,VDTBAL_OPBAL = CASE WHEN CHARINDEX('VDTBAL_OPBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN (VDT >= @START_DATE
				AND VDT < @FR_DATE) OR VTYP = 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_OPBAL = CASE WHEN CHARINDEX('EDTBAL_OPBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN (EDT >= @START_DATE
				AND EDT < @FR_DATE) OR VTYP = 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_DATES = CASE WHEN CHARINDEX('VDTBAL_DATES', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @FR_DATE AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_DATES = CASE WHEN CHARINDEX('EDTBAL_DATES', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @FR_DATE AND VTYP <> 18
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_DATES_CREDIT = CASE WHEN CHARINDEX('VDTBAL_DATES_CREDIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @FR_DATE AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_DATES_DEBIT = CASE WHEN CHARINDEX('VDTBAL_DATES_DEBIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @FR_DATE AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_DATES_CREDIT = CASE WHEN CHARINDEX('EDTBAL_DATES_CREDIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @FR_DATE 
				AND EDT <= @EFFDATE + ' 23:59' AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_DATES_DEBIT = CASE WHEN CHARINDEX('EDTBAL_DATES_DEBIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @FR_DATE
				AND EDT <= @EFFDATE + ' 23:59' AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL = CASE WHEN CHARINDEX('VDTBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL = CASE WHEN CHARINDEX('EDTBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_RECEIPT = CASE WHEN CHARINDEX('VDTBAL_RECEIPT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,T_DAY_BILL = CASE WHEN CHARINDEX('T_DAY_BILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT LIKE @MAX_BILL_DATE + '%'
				AND VTYP = 15
				THEN SUM(CASE 
							WHEN L.DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,T1_DAY_BILL = CASE WHEN CHARINDEX('T1_DAY_BILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT LIKE @MIN_BILL_DATE + '%'
				AND VTYP = 15
				THEN SUM(CASE 
							WHEN L.DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_BILL_DR = CASE WHEN CHARINDEX('VDTBAL_BILL_DR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_BILL_CR = CASE WHEN CHARINDEX('VDTBAL_BILL_CR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_NONBILL = CASE WHEN CHARINDEX('VDTBAL_NONBILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP NOT IN (
					15
					,2
					)
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_RECEIPT = CASE WHEN CHARINDEX('EDTBAL_RECEIPT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 2
				THEN SUM(- VAMT)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_BILL_DR = CASE WHEN CHARINDEX('EDTBAL_BILL_DR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(- VAMT)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_BILL_CR = CASE WHEN CHARINDEX('EDTBAL_BILL_CR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(- VAMT)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_NONBILL = CASE WHEN CHARINDEX('EDTBAL_NONBILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP NOT IN (
					15
					,2
					)
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,FDT_RECEIPT = CASE WHEN CHARINDEX('FDT_RECEIPT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_CREDIT_BILLS = CASE WHEN CHARINDEX('FDT_CREDIT_BILLS', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_DEBIT_BILLS = CASE WHEN CHARINDEX('FDT_DEBIT_BILLS', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_CR = CASE WHEN CHARINDEX('FDT_CR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND L.DRCR = 'C'
				AND VTYP <> 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_DR = CASE WHEN CHARINDEX('FDT_DR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND L.DRCR = 'D'
				AND VTYP <> 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_BAL = CASE WHEN CHARINDEX('FDT_BAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)
			ELSE 0
			END ELSE 0 END
	FROM #LEDGER L
	GROUP BY L.CLTCODE
		,VDT
		,EDT
		,VTYP
		,L.DRCR
	) A
GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0
DECLARE @ML_BAL_REQ TINYINT

SELECT @ML_BAL_REQ = CHARINDEX('MARGIN_BAL', @REPORT_FORMULA)

IF @ML_BAL_REQ > 0
BEGIN
	UPDATE RD
	SET MARGIN_BAL = ML.AMOUNT
	FROM #REPORT_DATA RD
		,(
			SELECT PARTY_CODE
				,AMOUNT = SUM(CASE DRCR
						WHEN 'C'
							THEN AMOUNT
						ELSE - AMOUNT
						END)
			FROM MARGINLEDGER ML
			WHERE VDT >= @START_DATE
				AND VDT <= @EFFDATE + ' 23:59'
			GROUP BY PARTY_CODE
			) ML
	WHERE RD.CLTCODE = PARTY_CODE
END

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/



IF @TABLE_NAME <> ''
	SET @@SQL = "INSERT INTO " + @TABLE_NAME + " SELECT "
ELSE	
	SET @@SQL = " SELECT "

IF @REPORT_COLUMN <> ''
	SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
SET @@SQL = @@SQL + @REPORT_FORMULA
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " #REPORT_DATA R, #FORMULA_CLIENT_MASTER M"
SET @@SQL = @@SQL + " WHERE M.CLTCODE = R.CLTCODE "

IF @REPORT_GROUPING <> ''
	SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING

--END

PRINT @@SQL

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_ACC_LEDGER2_FORMULA_BALANCES
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_GET_ACC_LEDGER2_FORMULA_BALANCES] 
	@FR_DATE VARCHAR(11),-- FROM DATE OF THE PERIOD 
	@EFFDATE VARCHAR(11),-- DATE FOR WHICH THE BALANCE IS REQUIRED  
	@PROCESS_CODE VARCHAR(10),-- PROCESS CODE FROM THE FORMULA MASTER  
	@REPORT_FORMULA VARCHAR(MAX),-- IN CASE NOT TO SET THE FORMULA AND GET THE SPECIFIEC FIELDS
	@EXCHANGE VARCHAR(10) = '',-- EXCHANGE
	@SEGMENT VARCHAR(50) = '',-- SEGMENT
	@REPORT_COLUMN VARCHAR(1000) = '', 
	@REPORT_GROUPING VARCHAR(1000) = '',
	@COSTCODE INT = 0,
	@TABLE_NAME  VARCHAR(1000) = '' 
	
AS
SELECT
	@REPORT_FORMULA = FORMULANAME
FROM FORMULA_MASTER
WHERE PROCESSCODE = @PROCESS_CODE

IF @EXCHANGE = '' BEGIN
SELECT
	@EXCHANGE = EXCHANGE
	,@SEGMENT = SEGMENT
FROM OWNER
END

DECLARE @START_DATE VARCHAR(11)

IF LEN(@FR_DATE) = 10 SELECT
	@FR_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FR_DATE, 103), 109)

IF LEN(@EFFDATE) = 10 BEGIN
SELECT
	@EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)
END

SELECT
	@START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)
FROM PARAMETER
WHERE @EFFDATE BETWEEN SDTCUR
AND LDTCUR

DECLARE @MIN_BILL_DATE VARCHAR(11)
, @MAX_BILL_DATE VARCHAR(11)

DECLARE @servername varchar(20)='AngelNSECM.ACCOUNT.DBO'

SELECT
	@MIN_BILL_DATE = CONVERT(VARCHAR(11), MIN(VDT), 109)
	,@MAX_BILL_DATE = CONVERT(VARCHAR(11), MAX(VDT), 109)
FROM (SELECT TOP 2
		*
	FROM BILLPOSTED
	WHERE VDT <= @EFFDATE
	ORDER BY VDT DESC) A

CREATE TABLE #REPORT_DATA(CLTCODE VARCHAR(10)
, VDTBAL_OPBAL MONEY
, EDTBAL_OPBAL MONEY
, VDTBAL_DATES MONEY
, EDTBAL_DATES MONEY
, VDTBAL_DATES_CREDIT MONEY
, VDTBAL_DATES_DEBIT MONEY
, EDTBAL_DATES_CREDIT MONEY
, EDTBAL_DATES_DEBIT MONEY
, VDTBAL MONEY
, EDTBAL MONEY
, VDTBAL_RECEIPT MONEY
, T_DAY_BILL MONEY
, T1_DAY_BILL MONEY
, VDTBAL_BILL_DR MONEY
, VDTBAL_BILL_CR MONEY
, VDTBAL_NONBILL MONEY
, EDTBAL_RECEIPT MONEY
, EDTBAL_BILL_DR MONEY
, EDTBAL_BILL_CR MONEY
, EDTBAL_NONBILL MONEY
, FDT_RECEIPT MONEY
, FDT_CREDIT_BILLS MONEY
, FDT_DEBIT_BILLS MONEY
, FDT_CR MONEY
, FDT_DR MONEY
, MARGIN_BAL MONEY)

DECLARE @@SQL VARCHAR(MAX)

INSERT INTO #REPORT_DATA
	SELECT
		CLTCODE
		,VDTBAL_OPBAL = SUM(VDTBAL_OPBAL)
		,EDTBAL_OPBAL = SUM(EDTBAL_OPBAL)
		,VDTBAL_DATES = SUM(VDTBAL_DATES)
		,EDTBAL_DATES = SUM(EDTBAL_DATES)
		,VDTBAL_DATES_CREDIT = SUM(VDTBAL_DATES_CREDIT)
		,VDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
		,EDTBAL_DATES_CREDIT = SUM(EDTBAL_DATES_CREDIT)
		,EDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
		,VDTBAL = SUM(VDTBAL)
		,EDTBAL = SUM(EDTBAL)
		,VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT)
		,T_DAY_BILL = SUM(T_DAY_BILL)
		,T1_DAY_BILL = SUM(T1_DAY_BILL)
		,VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR)
		,VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR)
		,VDTBAL_NONBILL = SUM(VDTBAL_NONBILL)
		,EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT)
		,EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR)
		,EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR)
		,EDTBAL_NONBILL = SUM(EDTBAL_NONBILL)
		,FDT_RECEIPT = SUM(FDT_RECEIPT)
		,FDT_CREDIT_BILLS = SUM(FDT_CREDIT_BILLS)
		,FDT_DEBIT_BILLS = SUM(FDT_DEBIT_BILLS)
		,FDT_CR = SUM(FDT_CR)
		,FDT_DR = SUM(FDT_DR)
		,MARGIN_BAL = 0
	FROM (SELECT
			CLTCODE = L.CLTCODE
			,VDTBAL_OPBAL =
							CASE
								WHEN (VDT >= @START_DATE AND
									VDT < @FR_DATE) OR
									VTYP = 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,EDTBAL_OPBAL =
							CASE
								WHEN (EDT >= @START_DATE AND
									EDT < @FR_DATE) OR
									VTYP = 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,VDTBAL_DATES =
							CASE
								WHEN VDT >= @FR_DATE AND
									VTYP <> 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,EDTBAL_DATES =
							CASE
								WHEN EDT >= @FR_DATE AND
									VTYP <> 18 AND
									EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,VDTBAL_DATES_CREDIT =
									CASE
										WHEN VDT >= @FR_DATE AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'C' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,VDTBAL_DATES_DEBIT =
									CASE
										WHEN VDT >= @FR_DATE AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'D' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,EDTBAL_DATES_CREDIT =
									CASE
										WHEN EDT >= @FR_DATE AND
											EDT <= @EFFDATE + ' 23:59' AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'C' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,EDTBAL_DATES_DEBIT =
									CASE
										WHEN EDT >= @FR_DATE AND
											EDT <= @EFFDATE + ' 23:59' AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'D' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,VDTBAL =
						CASE
							WHEN VDT >= @START_DATE THEN SUM(CASE L.DRCR
									WHEN 'D' THEN VAMT
									ELSE -VAMT
								END)
							ELSE 0
						END
			,EDTBAL =
						CASE
							WHEN EDT >= @START_DATE AND
								EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L.DRCR
									WHEN 'D' THEN VAMT
									ELSE -VAMT
								END)
							ELSE 0
						END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,VDTBAL_RECEIPT =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 2 THEN SUM(VAMT)
									ELSE 0
								END
			,T_DAY_BILL =
							CASE
								WHEN VDT LIKE @MAX_BILL_DATE + '%' AND
									VTYP = 15 THEN SUM(CASE
										WHEN L.DRCR = 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,T1_DAY_BILL =
							CASE
								WHEN VDT LIKE @MIN_BILL_DATE + '%' AND
									VTYP = 15 THEN SUM(CASE
										WHEN L.DRCR = 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,VDTBAL_BILL_DR =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END
			,VDTBAL_BILL_CR =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END
			,VDTBAL_NONBILL =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP NOT IN (
										15
										, 2
										) THEN SUM(CASE L.DRCR
											WHEN 'D' THEN VAMT
											ELSE -VAMT
										END)
									ELSE 0
								END
			,EDTBAL_RECEIPT =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 2 THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 2 THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_BILL_DR =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 15 AND
					L.DRCR = 'D' THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_BILL_CR =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 15 AND
					L.DRCR = 'C' THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_NONBILL =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP NOT IN (
										15
										, 2
										) THEN SUM(CASE L.DRCR
											WHEN 'D' THEN VAMT
											ELSE -VAMT
										END)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,FDT_RECEIPT =
							CASE
								WHEN EDT > @EFFDATE + ' 23:59' AND
									VDT <= @EFFDATE + ' 23:59' AND
									VTYP = 2 THEN SUM(VAMT)
								ELSE 0
							END
			,FDT_CREDIT_BILLS =
								CASE
									WHEN EDT > @EFFDATE + ' 23:59' AND
										VDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END
			,FDT_DEBIT_BILLS =
								CASE
									WHEN EDT > @EFFDATE + ' 23:59' AND
										VDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END
			,FDT_CR =
						CASE
							WHEN EDT > @EFFDATE + ' 23:59' AND
								VDT <= @EFFDATE + ' 23:59' AND
								L.DRCR = 'C' AND
								VTYP <> 2 THEN SUM(VAMT)
							ELSE 0
						END
			,FDT_DR =
						CASE
							WHEN EDT > @EFFDATE + ' 23:59' AND
								VDT <= @EFFDATE + ' 23:59' AND
								L.DRCR = 'D' AND
								VTYP <> 2 THEN SUM(VAMT)
							ELSE 0
						END
		FROM	LEDGER L (NOLOCK)
				,LEDGER2 L2 (NOLOCK)
				,#FORMULA_CLIENT_MASTER A
		WHERE A.CLTCODE = L.CLTCODE --AND SESSION_ID = @SESSIONID
		AND L.VNO = L2.VNO
		AND L.VTYP = L2.VTYPE
		AND L.BOOKTYPE = L2.BOOKTYPE
		AND L.LNO = L2.LNO
		AND L.CLTCODE = L2.CLTCODE
		AND COSTCODE = @COSTCODE
		AND (
		VDT >= @START_DATE
		OR EDT >= @START_DATE
		)
		AND VDT <= @EFFDATE + ' 23:59'
		GROUP BY	L.CLTCODE
					,VDT
					,EDT
					,VTYP
					,L.DRCR) A
	GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0
DECLARE @ML_BAL_REQ TINYINT

SELECT
	@ML_BAL_REQ = CHARINDEX('MARGIN_BAL', @REPORT_FORMULA)

IF @ML_BAL_REQ > 0 BEGIN
UPDATE RD
SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD
, (SELECT
		PARTY_CODE
		,AMOUNT = SUM(CASE DRCR
			WHEN 'C' THEN AMOUNT
			ELSE -AMOUNT
		END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE
	AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE) ML
WHERE RD.CLTCODE = PARTY_CODE
END

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/


IF @TABLE_NAME <> '' SET @@SQL = "INSERT INTO "+ @servername +'.'+@TABLE_NAME +" SELECT " ELSE SET @@SQL = " SELECT "

IF @REPORT_COLUMN <> '' SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
SET @@SQL = @@SQL + @REPORT_FORMULA
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " #REPORT_DATA R, #FORMULA_CLIENT_MASTER M"
SET @@SQL = @@SQL + " WHERE M.CLTCODE = R.CLTCODE "

IF @REPORT_GROUPING <> '' SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING

--END

PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_LEDGER_FORMULA_BALANCES_WPARENT
-- --------------------------------------------------
--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[CLS_GET_LEDGER_FORMULA_BALANCES_WPARENT]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50),
 @PARENTCHILD_FLAG CHAR(1) = 'C'
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL_OPBAL MONEY,  
 EDTBAL_OPBAL MONEY,    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 VDTBAL_RECEIPT MONEY,     
 T_DAY_BILL MONEY,     
 VDTBAL_BILL_DR MONEY,     
 VDTBAL_BILL_CR MONEY,    
 VDTBAL_NONBILL MONEY,     
 EDTBAL_RECEIPT MONEY,    
 EDTBAL_BILL_DR MONEY,    
 EDTBAL_BILL_CR MONEY,    
 EDTBAL_NONBILL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_CR MONEY,     
 FDT_DR MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = SUM(VDTBAL_OPBAL),    
 EDTBAL_OPBAL = SUM(EDTBAL_OPBAL),    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT),     
 T_DAY_BILL = SUM(T_DAY_BILL),     
 VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR),     
 VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR),    
 VDTBAL_NONBILL = SUM(VDTBAL_NONBILL),     
 EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT),    
 EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR),    
 EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR),    
 EDTBAL_NONBILL = SUM(EDTBAL_NONBILL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_CR = SUM(FDT_CR),     
 FDT_DR = SUM(FDT_DR),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_CODE ELSE L.CLTCODE END,  
 PARTY_NAME = CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_NAME ELSE PARTY_NAME END,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = CASE WHEN VDT >= @START_DATE AND VDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL_OPBAL = CASE WHEN EDT >= @START_DATE AND EDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL_RECEIPT = CASE WHEN VDT >= @START_DATE AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,     
 T_DAY_BILL = CASE WHEN VDT LIKE @EFFDATE + '%' AND VTYP = 15 THEN SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 VDTBAL_BILL_DR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END,     
 VDTBAL_BILL_CR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END ,    
 VDTBAL_NONBILL = CASE WHEN VDT >= @START_DATE AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 EDTBAL_RECEIPT = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 2 THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_DR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_CR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_NONBILL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_CR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'C' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END,     
 FDT_DR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'D' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END
FROM     
 LEDGER L,  
 FORMULA_CLIENT_MASTER_PARENT A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 AND (VDT >= @START_DATE OR EDT >= @START_DATE)    
 AND VDT <= @EFFDATE + ' 23:59'    
 GROUP BY     
 CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_CODE ELSE L.CLTCODE END, CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_NAME ELSE PARTY_NAME END, ENTITY_LEVEL, ENTITY_CODE,  VDT, EDT, VTYP, DRCR    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    


UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, FORMULA_CLIENT_MASTER_PARENT C,(
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE C.CLTCODE = PARTY_CODE AND CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_CODE ELSE C.CLTCODE END = RD.CLTCODE


/*  
DECLARE  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(10)  
   
SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER   
*/
 
SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GETTABLEINFO
-- --------------------------------------------------
CREATE PROC CLS_GETTABLEINFO
	@TABLENAME VARCHAR(500),
	@FORINIT BIT = 1
AS
/*
	EXEC CLS_GETTABLEINFO 'CustomerDetailsType'
*/
IF @FORINIT = 1
	BEGIN
		SELECT
			TABLE_NAME = UPPER(@TABLENAME),
			FIELD_NAME = UPPER(C.NAME),
			FIELD_ALIAS = UPPER(CONVERT(VARCHAR(500), ISNULL(P.VALUE, ''))),
			FIELD_TYPE = UPPER(T.NAME),
			FIELD_LENGTH = C.PREC,
			FIELD_SCALE = CASE WHEN
											T.NAME = 'NUMERIC'
											OR T.NAME = 'FLOAT'
											OR T.NAME = 'REAL'
											OR T.NAME = 'MONEY'
											OR T.NAME = 'SMALLMONEY'
											OR T.NAME = 'DECIMAL'
									THEN C.SCALE
									ELSE 0
									END,
			ALLOW_NULL = C.ISNULLABLE,
			ISDEFAULT = CONVERT(BIT, 1),
			ISPRIMARY = CONVERT(BIT, 0),
			KEY_SEQ = CONVERT(SMALLINT, 0),
			ISIDENTITY = C.COLSTAT,
			IDENTITY_START = CONVERT(INT, 0),
			IDENTITY_INCRT = CONVERT(INT, 0),
			ISREQUIRED = CONVERT(BIT, 0),
			DEFAULT_VALUE = CONVERT(VARCHAR(500), ''),
			MODIFIEDBY = 'SYSTEM',
			MODIFIEDAT = GETDATE()
		INTO
			#TABLEINFO
		FROM
			SYSCOLUMNS C
				LEFT OUTER JOIN SYSPROPERTIES P ON (C.ID = P.ID AND C.COLID = P.SMALLID)
				INNER JOIN SYSTYPES T ON (C.XTYPE = T.XTYPE)
		WHERE
			C.ID = OBJECT_ID(@TABLENAME)
		ORDER BY
			C.COLORDER

		CREATE TABLE #PKEYS
		(
			TABLE_QUALIFIER SYSNAME,
			TABLE_OWNER SYSNAME,
			TABLE_NAME SYSNAME,
			COLUMN_NAME SYSNAME,
			KEY_SEQ SMALLINT,
			PK_NAME SYSNAME
		)

		INSERT INTO #PKEYS EXEC SP_PKEYS @TABLENAME

		UPDATE
			I
		SET
			ISPRIMARY = 1,
			KEY_SEQ = K.KEY_SEQ
		FROM
			#TABLEINFO I,
			#PKEYS K
		WHERE
			I.FIELD_NAME = K.COLUMN_NAME

		UPDATE
			#TABLEINFO
		SET
			IDENTITY_START = ident_seed(@TABLENAME),
			IDENTITY_INCRT = ident_incr(@TABLENAME)
		WHERE
			ISIDENTITY = 1

		SELECT * FROM #TABLEINFO
		DROP TABLE #TABLEINFO
		DROP TABLE #PKEYS
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GL_REPORT
-- --------------------------------------------------

/*
EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
EXEC RPT_ACC_BANKBOOK_NEW 'DEC  1 2010', 'DEC 22 2010', '01/04/2010', 'BANK01', 'BROKER', 'BROKER', '%', 'VDT'
*/

--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'      
CREATE PROC [dbo].[CLS_GL_REPORT]
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @FCODE VARCHAR(10),                          
      @TCODE VARCHAR(10),                          
      @STATUSID VARCHAR(30),                          
      @STATUSNAME VARCHAR(30),                          
      @BRANCH VARCHAR(10),      
      @SELECTIONBY VARCHAR(3) = 'VDT',
      @REPORT_TYPE VARCHAR(5) = 'GL'                           
                          
AS                          
                          
DECLARE                          
 @@OPENDATE AS VARCHAR(11),                          
 @@REPDATE AS VARCHAR(8),                          
 @@STARTDATE AS VARCHAR(11),       
 @@COSTCODE AS SMALLINT
      


CREATE TABLE #GL_OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

CREATE TABLE [DBO].[#TBL_GLREPORT]([SRNO] [INT] IDENTITY (1, 1) NOT NULL,
[BOOKTYPE] [CHAR](2) NULL,
[VOUDT] [VARCHAR](10) NULL,
[EFFDT] [VARCHAR](10) NULL,
[SHORTDESC] [CHAR](6) NOT NULL DEFAULT (' '),
[DRAMT] [MONEY] NULL,
[CRAMT] [MONEY] NULL,
[VNO] [VARCHAR](15) NULL,
[NARRATION] [VARCHAR](500) NULL,
[DDNO] [VARCHAR](32) NULL,
[CLTCODE] [VARCHAR](10) NOT NULL,
[LONGNAME] [VARCHAR](100) NULL,
[VDT] [DATETIME] NULL,
[VTYP] [SMALLINT] NOT NULL,
[ACCAT] [CHAR](2) NULL,
[OPBAL] [MONEY] NOT NULL,
[CROSAC] [VARCHAR](10) NOT NULL,
[ACNAME] [VARCHAR](100) NULL,
[BRANCHCODE] [VARCHAR](35) NULL,
[LNO] [INT] NULL,
[REPDATE] [VARCHAR](8) NULL,
[MAINCODE] [VARCHAR](10) NULL,
[VCHDT] [DATETIME] NULL,
[EDIFF] INT NULL)


--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                        

SELECT
	@@COSTCODE = -1

IF @STATUSID <> 'BROKER' BEGIN
SELECT TOP 1
	@@COSTCODE = COSTCODE
FROM COSTMAST
WHERE COSTNAME = @STATUSNAME
END ELSE IF @STATUSID = 'BROKER' BEGIN
IF @BRANCH <> '' OR @BRANCH <> '%' BEGIN
SELECT TOP 1
	@@COSTCODE = COSTCODE
FROM COSTMAST
WHERE COSTNAME = @BRANCH
END
END


SELECT
	@@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE, 103), 109), 11)


CREATE TABLE #FORMULA_CLIENT_MASTER(CLTCODE VARCHAR(10))


IF @REPORT_TYPE <> 'GL'
BEGIN
	INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT
			CLTCODE
		FROM ACMAST
		WHERE CLTCODE BETWEEN @FCODE AND @TCODE
		AND ACCAT =
					CASE
						WHEN @REPORT_TYPE = 'BANK' THEN 2
						ELSE CASE
								WHEN @REPORT_TYPE = 'CASH' THEN 1
								ELSE 3
							END
					END
		--AND (BRANCHCODE =
		--					CASE
		--						WHEN @BRANCH <> '' OR
		--							@BRANCH <> '%' THEN @BRANCH
		--						ELSE BRANCHCODE
		--					END
		--OR BRANCHCODE = 'ALL')
END
ELSE
BEGIN
	INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT
			CLTCODE
		FROM ACMAST
		WHERE CLTCODE BETWEEN @FCODE AND @TCODE
		AND ACCAT IN(3, 14)
END


	
/* GET OPNING BALANCE */
IF @SELECTIONBY = 'VDT' BEGIN
IF @STATUSID = 'BROKER' AND @@COSTCODE = -1 BEGIN
--INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'VDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,'#GL_OPBAL'

END ELSE BEGIN
--		INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'VDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,@@COSTCODE
											,'#GL_OPBAL'
END
END ELSE BEGIN
IF @STATUSID = 'BROKER' AND @@COSTCODE = -1 BEGIN
--INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'EDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,'#GL_OPBAL'
END ELSE BEGIN
--INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'EDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,@@COSTCODE
											,'#GL_OPBAL'
END
END
/* GET OPNING BALANCE */



/* GET THE RECORDS FROM LEDGER TABLE */
IF @REPORT_TYPE <> 'GL' BEGIN
INSERT INTO #TBL_GLREPORT
	SELECT
		L.BOOKTYPE
		,VOUDT = CONVERT(VARCHAR, L.VDT, 103)
		,EFFDT = CONVERT(VARCHAR, L.EDT, 103)
		,ISNULL(SHORTDESC, '') SHORTDESC
		,DRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'D' THEN VAMT
			ELSE 0
		END)
		,CRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'C' THEN VAMT
			ELSE 0
		END)
		,L.VNO
		,REPLACE(L.NARRATION, '"', '') NARRATION
		,DDNO = (CASE
			WHEN ISNULL(L1.DDNO, '') = '0' THEN ''
			ELSE ISNULL(L1.DDNO, '')
		END)
		,L.CLTCODE
		,A.LONGNAME
		,VDT
		,L.VTYP
		,ACCAT
		,OPBAL = 0
		,CROSAC = ''
		,A.ACNAME
		,A.BRANCHCODE
		,L.LNO
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,L.VDT
		,EDIFF = DATEDIFF(D, L.EDT, GETDATE())
	FROM	LEDGER L
			LEFT JOIN (SELECT
					VTYP
					,BOOKTYPE
					,VNO
					,DDNO = MAX(DDNO)
				FROM LEDGER1
				GROUP BY	VTYP
							,BOOKTYPE
							,VNO) L1
				ON (L1.VTYP = L.VTYP
				AND L1.BOOKTYPE = L.BOOKTYPE
				AND L1.VNO = L.VNO)
			,
			--(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
			(SELECT
					VNO
					,VTYP
					,BOOKTYPE
				FROM LEDGER
				WHERE @FDATE <=
								CASE
									WHEN @SELECTIONBY = 'VDT' THEN VDT
									ELSE EDT
								END
				AND @TDATE + ' 23:59:59' >=
											CASE
												WHEN @SELECTIONBY = 'VDT' THEN VDT
												ELSE EDT
											END
				AND CLTCODE BETWEEN @FCODE AND @TCODE) LL
			,VMAST V
			,ACMAST A
	WHERE L.VNO = LL.VNO
	AND L.VTYP = LL.VTYP
	AND L.BOOKTYPE = LL.BOOKTYPE
	AND L.CLTCODE = A.CLTCODE
	AND L.VTYP = V.VTYPE
	AND NOT EXISTS (SELECT
			CLTCODE
		FROM #FORMULA_CLIENT_MASTER F
		WHERE L.CLTCODE = F.CLTCODE)
	AND L.VTYP <> 18
	
END ELSE BEGIN
IF @@COSTCODE = -1 BEGIN
INSERT INTO #TBL_GLREPORT
	SELECT
		L.BOOKTYPE
		,VOUDT = CONVERT(VARCHAR, L.VDT, 103)
		,EFFDT = CONVERT(VARCHAR, L.EDT, 103)
		,ISNULL(SHORTDESC, '') SHORTDESC
		,DRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'D' THEN VAMT
			ELSE 0
		END)
		,CRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'C' THEN VAMT
			ELSE 0
		END)
		,L.VNO
		,REPLACE(L.NARRATION, '"', '') NARRATION
		,DDNO = ISNULL((SELECT TOP 1
				DDNO
			FROM LEDGER1
			WHERE VTYP = L.VTYP
			AND VNO = L.VNO
			AND BOOKTYPE = L.BOOKTYPE
			AND LNO = L.LNO)
		, '')
		,L.CLTCODE
		,A.LONGNAME
		,VDT
		,L.VTYP
		,ACCAT
		,OPBAL = 0
		,CROSAC = ''
		,A.ACNAME
		,A.BRANCHCODE
		,L.LNO
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,L.VDT
		,EDIFF = DATEDIFF(D, L.EDT, GETDATE())
	FROM	LEDGER L
			,(SELECT
					CLTCODE
					,LONGNAME
					,ACCAT
					,BRANCHCODE
					,ACNAME
				FROM ACMAST
				WHERE CLTCODE BETWEEN @FCODE AND @TCODE
				AND (ACCAT LIKE '3%'
				OR ACCAT LIKE '14%'
				OR ACCAT LIKE '103%')) A
			,VMAST V
	WHERE L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'
	AND VTYP = VTYPE
	AND L.CLTCODE = A.CLTCODE
	AND L.VTYP <> 18
/*ORDER BY                    
   L.CLTCODE,                    
   VOUDT1,                    
   L.VTYP DESC,                    
   L.VNO  */
END ELSE BEGIN
INSERT INTO #TBL_GLREPORT
	SELECT
		L.BOOKTYPE
		,VOUDT = CONVERT(VARCHAR, L.VDT, 103)
		,EFFDT = CONVERT(VARCHAR, L.EDT, 103)
		,ISNULL(SHORTDESC, '') SHORTDESC
		,DRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'D' THEN VAMT
			ELSE 0
		END)
		,CRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'C' THEN VAMT
			ELSE 0
		END)
		,L.VNO
		,REPLACE(L.NARRATION, '"', '') NARRATION
		,DDNO = ISNULL((SELECT TOP 1
				DDNO
			FROM LEDGER1
			WHERE VTYP = L.VTYP
			AND VNO = L.VNO
			AND BOOKTYPE = L.BOOKTYPE
			AND LNO = L.LNO)
		, '')
		,L.CLTCODE
		,A.LONGNAME
		,VDT
		,L.VTYP
		,ACCAT
		,OPBAL = 0
		,CROSAC = ''
		,A.ACNAME
		,A.BRANCHCODE
		,L.LNO
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,L.VDT
		,EDIFF = DATEDIFF(D, L.EDT, GETDATE())
	FROM	LEDGER L
			,LEDGER2 L2
			,(SELECT
					CLTCODE
					,LONGNAME
					,ACCAT
					,BRANCHCODE
					,ACNAME
				FROM ACMAST
				WHERE CLTCODE BETWEEN @FCODE AND @TCODE
				AND (ACCAT LIKE '3%'
				OR ACCAT LIKE '14%'
				OR ACCAT LIKE '103%')) A
			,VMAST V
	WHERE L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'
	AND VTYP = V.VTYPE
	AND L.CLTCODE = A.CLTCODE
	AND L.VTYP <> 18
	AND L.VNO = L2.VNO
	AND L.VTYP = L2.VTYPE
	AND L.BOOKTYPE = L2.BOOKTYPE
	AND L.LNO = L2.LNO
	AND L.CLTCODE = L2.CLTCODE
	AND COSTCODE = @@COSTCODE
/*ORDER BY                    
   L.CLTCODE,                    
   VOUDT1,                    
   L.VTYP DESC,                    
   L.VNO  */
END
END
/* GET THE RECORDS FROM LEDGER TABLE */
--SELECT * FROM #TBL_GLREPORT

/* GET THE RECORDS FROM LEDGER2 TABLE */
/*     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L2.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT,
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE @FDATE <= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND @TDATE + ' 23:59:59' >= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND CLTCODE = @FCODE) LL,
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L1.VNO                        
      AND L.VTYP = L1.VTYP                        
      AND L.BOOKTYPE = L1.BOOKTYPE                        
      AND L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
 --     AND L.DRCR = L2.DRCR      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L2.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L2.CLTCODE <> @FCODE                        
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        */
/* GET THE RECORDS FROM LEDGER2 TABLE */




--UPDATE #TBL_GLREPORT
--SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION)



IF @REPORT_TYPE <> 'GL' 
BEGIN
UPDATE #TBL_GLREPORT
SET	OPBAL = O.OPBAL
	,CROSAC = ''
FROM #GL_OPBAL O
WHERE O.CLTCODE = @FCODE

UPDATE #TBL_GLREPORT
SET CROSAC = CLTCODE
UPDATE #TBL_GLREPORT
SET CLTCODE = @FCODE
END 
ELSE 
BEGIN
UPDATE #TBL_GLREPORT
SET	OPBAL = -O.OPBAL
	,CROSAC = ''
FROM #GL_OPBAL O
WHERE O.CLTCODE = #TBL_GLREPORT.CLTCODE

UPDATE #TBL_GLREPORT
SET CROSAC = L.CLTCODE FROM (SELECT VNO, VTYP, BOOKTYPE, CLTCODE FROM LEDGER(NOLOCK) WHERE VTYP IN(2, 3,8))  L
WHERE #TBL_GLREPORT.VNO = L.VNO AND #TBL_GLREPORT.VTYP = L.VTYP AND #TBL_GLREPORT.BOOKTYPE = L.BOOKTYPE AND #TBL_GLREPORT.CLTCODE <> L.CLTCODE

--UPDATE #TBL_GLREPORT
--SET CROSAC = L.CLTCODE FROM (SELECT VNO, VTYP, BOOKTYPE, CLTCODE,LNO FROM LEDGER(NOLOCK) WHERE VTYP IN(8))  L
--WHERE #TBL_GLREPORT.VNO = L.VNO AND #TBL_GLREPORT.VTYP = L.VTYP AND #TBL_GLREPORT.BOOKTYPE = L.BOOKTYPE AND #TBL_GLREPORT.LNO <> L.LNO


INSERT INTO #TBL_GLREPORT
	SELECT
		''
		,''
		,''
		,'OPBAL'
		,CASE
			WHEN OPBAL > 0 THEN OPBAL
			ELSE 0
		END
		,CASE
			WHEN OPBAL <= 0 THEN ABS(OPBAL)
			ELSE 0
		END
		,''
		,'OPENING BALANCE'
		,''
		,CLTCODE
		,''
		,''
		,0
		,''
		,-OPBAL
		,CLTCODE
		,''
		,''
		,''
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,''
		,0
	FROM #GL_OPBAL
END

UPDATE #TBL_GLREPORT
SET ACNAME = A.ACNAME
FROM ACMAST A
WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE

INSERT INTO #TBL_GLREPORT
	SELECT
		''
		,''
		,''
		,'OPBAL'
		,0
		,0
		,''
		,'OPENING BALANCE'
		,''
		,CLTCODE
		,''
		,''
		,0
		,''
		,OPBAL
		,CLTCODE
		,''
		,''
		,''
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,''
		,0
	FROM #GL_OPBAL
	WHERE CLTCODE NOT IN (SELECT
			CLTCODE
		FROM #TBL_GLREPORT
		WHERE NARRATION = 'OPENING BALANCE')
	AND OPBAL <> 0


DELETE FROM #TBL_GLREPORT
WHERE DRAMT = 0
	AND CRAMT = 0
	AND OPBAL = 0
	AND NARRATION <> 'OPENING BALANCE'

UPDATE #TBL_GLREPORT
SET BRANCHCODE = COSTNAME
FROM LEDGER2 L2, COSTMAST C
WHERE #TBL_GLREPORT.VNO = L2.VNO
AND #TBL_GLREPORT.VTYP = L2.VTYPE
AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE
AND #TBL_GLREPORT.LNO = L2.LNO
AND #TBL_GLREPORT.CROSAC = L2.CLTCODE
AND L2.COSTCODE = C.COSTCODE

--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                        
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID  

SELECT
	BOOKTYPE
	,VOUDT VDT
	,EFFDT EDT
	,SHORTDESC
	,DRAMT DEBIT
	,CRAMT CREDIT
	,VNO
	,NARRATION
	,DDNO
	,CLTCODE
	,LONGNAME
	,VTYP
	,ACCAT
	,OPBAL
	,CROSAC
	,ACNAME
	,BRANCHCODE
	,VCHDT
	,EDIFF
FROM #TBL_GLREPORT

ORDER BY CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109), 11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GLLEDGER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_GLLEDGER]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@FROM_GL_CODE VARCHAR(10),
	@TO_GL_CODE VARCHAR(10),
	@VIEWOPTION VARCHAR(10),
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
	
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)
	
DECLARE @servername as varchar(20) = 'ANAND1.ACCOUNT.DBO'


CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


SET @@COSTCODE = -1

IF @BRANCHCODE <> '' OR @BRANCHCODE <> '%'
BEGIN
	SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCHCODE
END

CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL,VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = ' -AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL, EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = '-AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
SET @@SQL = @@SQL + "WHERE CLTCODE >= '" + @FROM_GL_CODE + "' AND CLTCODE <= '" + @TO_GL_CODE + "'"
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + " AND ACCAT = 3 "
ELSE IF UPPER(@VIEWOPTION) = 'BANK'
	SET @@SQL = @@SQL + " AND ACCAT = 2 "	
ELSE IF UPPER(@VIEWOPTION) = 'CASH'
	SET @@SQL = @@SQL + " AND ACCAT = 1 "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
print'sss'
PRINT @@SQL
EXEC(@@SQL)	
print 'dd'


IF UPPER(@STATUSID) = 'BROKER' AND @@COSTCODE = -1
BEGIN

	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', '',''
END
ELSE
BEGIN
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE','',@@COSTCODE, ''
	
END

DROP TABLE #FORMULA_CLIENT_MASTER


SET @@SQL = "INSERT INTO " + @servername +'.'+@TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_LEDGER_EOD
-- --------------------------------------------------


CREATE PROC CLS_LEDGER_EOD
	@PROCESS_TYPE TINYINT
AS

/*SELECT * FROM  CLS_LEDGER_REPORTS
EXEC  CLS_LEDGER_EOD 1*/

DECLARE
	@@EOD_STATUS BIT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT @@EOD_STATUS = EOD_STATUS FROM CLS_LEDGER_EOD_STATUS

IF @@EOD_STATUS = 0
	BEGIN

		BEGIN TRAN

		 UPDATE CLS_LEDGER_EOD_STATUS
		 SET EOD_STATUS = 1

		CREATE TABLE #CLS_ACMAST_EOD
		(
			CLTCODE VARCHAR(10),
			LONGNAME VARCHAR(100)
		)

		INSERT INTO
			#CLS_ACMAST_EOD
		SELECT
			CLTCODE, LONGNAME
		FROM
			ACMAST
		WHERE
			ACCAT IN (4, 104)

		IF @PROCESS_TYPE = 0
			BEGIN

				TRUNCATE TABLE CLS_LEDGER_REPORTS

				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					ACCOUNT.DBO.LEDGER L LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1
				ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A
				WHERE
					A.CLTCODE = L.CLTCODE AND L.VTYP NOT IN(15, 21)


				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					ACCOUNT.DBO.LEDGER L LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1
					ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO,
					#CLS_ACMAST_EOD A
				WHERE
					A.CLTCODE = L.CLTCODE AND L.VTYP IN(15, 21)


				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					ML.VNO,
					ML.Vtyp,
					ML.BookType,
					(CASE ML.DRCR WHEN 'D' THEN AMOUNT ELSE 0 END),
					(CASE ML.DRCR WHEN 'C' THEN AMOUNT ELSE 0 END),
					ML.PARTY_CODE,
					LONGNAME,
					ML.VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					'',
					'',
					MCLTCODE,
					2,
					DATEDIFF(MINUTE , 'JAN  1 1998', ML.VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					ACCOUNT.DBO.MARGINLEDGER ML LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1
					ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND ML.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A, (SELECT VNO, VTYP, BOOKTYPE, LNO, NARRATION FROM ACCOUNT.DBO.LEDGER WHERE VTYP IN(19, 20, 23, 24)) LL
				WHERE
					A.CLTCODE = ML.PARTY_CODE
					AND ML.VNO = LL.VNO AND ML.VTYP = LL.VTYP AND ML.BOOKTYPE = LL.BOOKTYPE AND ML.LNO = LL.LNO

				TRUNCATE TABLE CLS_LEDGER_TRIG

				UPDATE CLS_LEDGER_EOD_STATUS
				SET EOD_STATUS = 0


			END
		ELSE IF @PROCESS_TYPE = 1
			BEGIN
				DELETE
					L
				FROM
					CLS_LEDGER_REPORTS L, CLS_LEDGER_TRIG LT
				WHERE
					L.VNO = LT.VNO
					AND L.VTYP = LT.VTYP
					AND L.BOOKTYPE = LT.BOOKTYPE

				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					EDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					ACCOUNT.DBO.LEDGER L LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1
					ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A, (SELECT DISTINCT VNO, VTYP, BOOKTYPE FROM CLS_LEDGER_TRIG WHERE ENTRY IN(1, 2)) LT
				WHERE
					A.CLTCODE = L.CLTCODE
					AND L.VNO = LT.VNO
					AND L.VTYP = LT.VTYP
					AND L.BOOKTYPE = LT.BOOKTYPE
					AND L.VTYP NOT IN(15, 21)


				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					L.VNO,
					L.Vtyp,
					L.BookType,
					(CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),
					(CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),
					L.CLTCODE,
					LONGNAME,
					VDT,
					EDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),
					(CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),
					'',
					1,
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', EDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					ACCOUNT.DBO.LEDGER L LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1
					ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO,
					#CLS_ACMAST_EOD A, (SELECT DISTINCT VNO, VTYP, BOOKTYPE FROM CLS_LEDGER_TRIG WHERE ENTRY IN(1, 2)) LT
				WHERE
					A.CLTCODE = L.CLTCODE
					AND L.VNO = LT.VNO
					AND L.VTYP = LT.VTYP
					AND L.BOOKTYPE = LT.BOOKTYPE
					AND L.VTYP IN(15, 21)



				INSERT INTO CLS_LEDGER_REPORTS
				SELECT
					ML.VNO,
					ML.Vtyp,
					ML.BookType,
					(CASE ML.DRCR WHEN 'D' THEN AMOUNT ELSE 0 END),
					(CASE ML.DRCR WHEN 'C' THEN AMOUNT ELSE 0 END),
					ML.PARTY_CODE,
					LONGNAME,
					ML.VDT,
					VDT,
					Narration,
					DDNO,
					'NSE',
					'CAPITAL',
					'',
					'',
					MCLTCODE,
					2,
					DATEDIFF(MINUTE , 'JAN  1 1998', ML.VDT),
					DATEDIFF(MINUTE , 'JAN  1 1998', VDT),
					ChequeInName,
					ChqPrinted,
					DD,
					BNKNAME,
					''
				FROM
					ACCOUNT.DBO.MARGINLEDGER ML LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1
					ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND ML.BOOKTYPE = L1.BOOKTYPE,
					#CLS_ACMAST_EOD A,
					(SELECT VNO, VTYP, BOOKTYPE, LNO, NARRATION FROM ACCOUNT.DBO.LEDGER WHERE VTYP IN(19, 20, 23, 24)) LL,
					(SELECT DISTINCT VNO, VTYP, BOOKTYPE FROM CLS_LEDGER_TRIG WHERE ENTRY IN(1, 2)) LT
				WHERE
					A.CLTCODE = ML.PARTY_CODE
					AND ML.VNO = LL.VNO
					AND ML.VTYP = LL.VTYP
					AND ML.BOOKTYPE = LL.BOOKTYPE
					AND ML.LNO = LL.LNO
					AND LL.VNO = LT.VNO
					AND LL.VTYP = LT.VTYP
					AND LL.BOOKTYPE = LT.BOOKTYPE

				TRUNCATE TABLE CLS_LEDGER_TRIG

				UPDATE CLS_LEDGER_EOD_STATUS
				SET EOD_STATUS = 0
			END
			COMMIT TRAN
	END
ELSE
	BEGIN
		SELECT 'THE EOD PROCESS IS ALREADY IN USE, PLEASE TRY AFTER SOME TIME.'
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_LEDGER_JOB
-- --------------------------------------------------
CREATE PROC CLS_LEDGER_JOB
AS

DECLARE 
@@DATEDIFFERENCE DATETIME

BEGIN TRAN
CREATE TABLE #CLS_LED_JOB
(
	VNO VARCHAR(12),
	VTYP SMALLINT,
	BOOKTYPE VARCHAR(3)
)


SELECT @@DATEDIFFERENCE = DATEADD(MI, -15, GETDATE())

INSERT INTO #CLS_LED_JOB
SELECT 
	DISTINCT VNO, VTYP, BOOKTYPE 
FROM 
	CLS_LEDGER_TRIG
WHERE 
	UPDATED_DATE <= @@DATEDIFFERENCE
	

CREATE TABLE #CLS_ACMAST_EOD  
(  
 CLTCODE VARCHAR(10),  
 LONGNAME VARCHAR(100)  
)  
  
INSERT INTO   
 #CLS_ACMAST_EOD   
SELECT   
 CLTCODE, LONGNAME   
FROM   
 ACMAST   
WHERE  
 ACCAT IN (4, 104)  

 DELETE   
  L   
 FROM   
  CLS_LEDGER_REPORTS L, (SELECT VNO, VTYP, BOOKTYPE FROM #CLS_LED_JOB WHERE ENTRY IN(1, 2)) LT   
 WHERE  
  L.VNO = LT.VNO   
  AND L.VTYP = LT.VTYP  
  AND L.BOOKTYPE = LT.BOOKTYPE  

 INSERT INTO CLS_LEDGER_REPORTS  
 SELECT   
  L.VNO,  
  L.Vtyp,  
  L.BookType,  
  (CASE L.DRCR WHEN 'D' THEN VAMT ELSE 0 END),  
  (CASE L.DRCR WHEN 'C' THEN VAMT ELSE 0 END),  
  L.CLTCODE,  
  LONGNAME,  
  VDT,  
  EDT,  
  Narration,  
  DDNO,  
  'NSE',  
  'CAPITAL',  
  (CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 8, 7) ELSE '' END),  
  (CASE WHEN L.VTYP = 15 THEN SUBSTRING(NARRATION, 20, 1)ELSE '' END),  
  '',  
  1,  
  DATEDIFF(MINUTE , 'JAN  1 1998', VDT),  
  DATEDIFF(MINUTE , 'JAN  1 1998', EDT),  
  ChequeInName,  
  ChqPrinted,  
  DD,  
  BNKNAME,  
  ''  
 FROM  
  ACCOUNT.DBO.LEDGER L LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1  
  ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE,  
  #CLS_ACMAST_EOD A, (SELECT VNO, VTYP, BOOKTYPE FROM #CLS_LED_JOB WHERE ENTRY IN(1, 2)) LT  
 WHERE  
  A.CLTCODE = L.CLTCODE   
  AND L.VNO = LT.VNO   
  AND L.VTYP = LT.VTYP   
  AND L.BOOKTYPE = LT.BOOKTYPE  
  
  
    
 INSERT INTO CLS_LEDGER_REPORTS  
 SELECT   
  ML.VNO,  
  ML.Vtyp,  
  ML.BookType,  
  (CASE ML.DRCR WHEN 'D' THEN AMOUNT ELSE 0 END),  
  (CASE ML.DRCR WHEN 'C' THEN AMOUNT ELSE 0 END),  
  ML.PARTY_CODE,  
  LONGNAME,  
  ML.VDT,  
  EDT,  
  Narration,  
  DDNO,  
  'NSE',  
  'CAPITAL',  
  '',  
  '',  
  MCLTCODE,  
  2,  
  DATEDIFF(MINUTE , 'JAN  1 1998', ML.VDT),  
  DATEDIFF(MINUTE , 'JAN  1 1998', EDT),  
  ChequeInName,  
  ChqPrinted,  
  DD,  
  BNKNAME,  
  ''  
 FROM  
  ACCOUNT.DBO.MARGINLEDGER ML LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1  
   ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND ML.BOOKTYPE = L1.BOOKTYPE,  
  #CLS_ACMAST_EOD A,   
  (SELECT VNO, VTYP, BOOKTYPE, LNO FROM ACCOUNT.DBO.LEDGER WHERE VTYP IN(19, 20, 23, 24)) LL,  
  (SELECT VNO, VTYP, BOOKTYPE FROM #CLS_LED_JOB WHERE ENTRY IN(1, 2)) LT  
 WHERE  
  A.CLTCODE = ML.PARTY_CODE  
  AND ML.VNO = LL.VNO   
  AND ML.VTYP = LL.VTYP   
  AND ML.BOOKTYPE = LL.BOOKTYPE   
  AND ML.LNO = LL.LNO  
  AND LL.VNO = LT.VNO   
  AND LL.VTYP = LT.VTYP  
  AND LL.BOOKTYPE = LT.BOOKTYPE  
  



 DELETE   
  LT   
 FROM   
  #CLS_LED_JOB L, CLS_LEDGER_TRIG LT   
 WHERE  
  L.VNO = LT.VNO   
  AND L.VTYP = LT.VTYP  
  AND L.BOOKTYPE = LT.BOOKTYPE  
  AND UPDATED_DATE <= @@DATEDIFFERENCE

COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RPT_ACCALLPARTYLEDVOUCHERDISP]            
 @VTYP SMALLINT ,            
 @VNO VARCHAR (12),            
 @VDT VARCHAR(12) ,            
 @BOOKTYPE VARCHAR(2),            
 @BRANCH VARCHAR(10),            
 @CLTCODE VARCHAR(10)            
            
AS   

 IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0  
  BEGIN  
   SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)  
  END  
 
      
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'            
BEGIN            
 SELECT    
  VAMT, L.VTYP, L.VNO, L.VDT, L.DRCR, CLTCODE, ACNAME,  L.LNO,   
  DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103), PARTY_CODE
 FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO LEFT OUTER JOIN MARGINLEDGER ML ON ML.VTYP = L.VTYP AND ML.BOOKTYPE = L.BOOKTYPE AND ML.VNO = L.VNO         
  AND L.LNO = ML.LNO 
 WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(L.VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
 ORDER BY   
  L.DRCR DESC , L.LNO             
END            
ELSE            
BEGIN            
  SELECT    
  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,             
  DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103)              
  FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO,            
  LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE            
  WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
  AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO            
  AND COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))            
  ORDER BY   
  L2.DRCR DESC , L2.LNO             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TRIALBALANCE_WITHOUTEXCHANGE
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_TRIALBALANCE_WITHOUTEXCHANGE]
	@FR_DATE VARCHAR(25), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(25), /* AS ON DATE ENTERED BY USER */
	@VIEWOPTION VARCHAR(10), /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

--ALTER TABLE #FORMULA_CLIENT_MASTER
-- ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)

CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BROKER' AND @BRANCHCODE <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @BRANCHCODE
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


CREATE TABLE #TB
(
	CLTCODE VARCHAR(10)
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

	ALTER TABLE #TB
	ADD
		AMOUNT MONEY

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300),
	@DISPLAY_CLIENT_TOTAL VARCHAR(300)
	
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = 'AMOUNT'
		SET @DISPLAY_CLIENT_TOTAL = 'AMOUNT'
		SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(AMOUNT)'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT,VDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
		
		SET @NET_AMOUNT_PARAMETER = 'VDTBAL_OPBAL = SUM(OPENING_AMOUNT), VDTBAL_DATES_CREDIT = SUM(PERIOD_CREDIT), VDTBAL_DATES_DEBIT = SUM(PERIOD_DEBIT), VDTBAL = SUM(AMOUNT)'
	END
END
ELSE
BEGIN
	--SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL_OPBAL = SUM(OPENING_AMOUNT), EDTBAL_DATES_CREDIT = SUM(PERIOD_CREDIT), EDTBAL_DATES_DEBIT = SUM(PERIOD_DEBIT), EDTBAL = SUM(AMOUNT)'

	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = 'AMOUNT'
		SET @DISPLAY_CLIENT_TOTAL = 'AMOUNT'
		SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(AMOUNT)'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT, EDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
		SET @DISPLAY_CLIENT_TOTAL = '0, 0, 0, -AMOUNT'
	END
END


IF UPPER(@VIEWOPTION) = 'GL'
BEGIN
	IF UPPER(@STATUSID) = 'BROKER'
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
	
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
	ELSE
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
		AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE)
		
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
END	


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + "WHERE ACCAT <> 4 "
ELSE IF UPPER(@VIEWOPTION) = 'PARTY'
	SET @@SQL = @@SQL + "WHERE ACCAT = 4 "	
ELSE IF UPPER(@VIEWOPTION) = 'ALL'
	SET @@SQL = @@SQL + "WHERE ACCAT = ACCAT "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
	
EXEC(@@SQL)	




IF UPPER(@STATUSID) = 'BROKER'
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', ''
END
ELSE
BEGIN
	--SELECT @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT 
	INSERT INTO #TB
	--EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE', ''
	EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', ''
	
END



SET @@SQL = "INSERT INTO [ANAND1].ACCOUNT.DBO." + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + " SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', '" + @EXCHANGE + "','" +  @SEGMENT + "', " + @NET_AMOUNT_PARAMETER + ", ACCAT = 0, GRPCODE = '', GRPNAME = '' "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB WHERE CLTCODE = ''  "
IF @SHOWZEROBAL = 'Y'
	SET @@SQL = @@SQL + "	AND ISNULL(AMOUNT, 0) <> 0 "
SET @@SQL = @@SQL + "	GROUP BY CLTCODE "
IF @SORT_BY = 'ACNAME'
SET @@SQL = @@SQL + "		ORDER BY ACNAME "
ELSE
SET @@SQL = @@SQL + "		ORDER BY TB.CLTCODE "




EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TRIALBALANCE_WRAPPER_WITHOUTEXCHANGE
-- --------------------------------------------------



create PROCEDURE [DBO].[CLS_TRIALBALANCE_WRAPPER_WITHOUTEXCHANGE]
	@FR_DATE VARCHAR(25), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(25), /* AS ON DATE ENTERED BY USER */
	@VIEWOPTION VARCHAR(10), /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@EXCSEGMENT VARCHAR(1000) = '',
	@SESSIONID VARCHAR(100) = '1234567890',
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N',
	@OPTTYPE CHAR(3) = '',
	@BULKMODE CHAR(3) = ''
AS

DECLARE
	@@SQL VARCHAR(MAX),
	@TABLE_NAME VARCHAR(100),
	@TABLE_EXISTS TINYINT

--IF(CHARINDEX (',',@EXCSEGMENT)=0)
--SELECT @EXCSEGMENT=','+@EXCSEGMENT
--ELSE
--SELECT	@EXCSEGMENT=SUBSTRING(@EXCSEGMENT, 1, LEN(@EXCSEGMENT) )


--SELECT @EXCSEGMENT
SET @TABLE_NAME = "TB_ALL_" + @SESSIONID
/*
SET @TABLE_EXISTS = 0

SET @@SQL = "SELECT COUNT(1) FROM SYS.TABLES WHERE NAME = '" + @TABLE_NAME + "'"

EXEC(@@SQL)

SELECT @@ROWCOUNT

IF @@ROWCOUNT > 0
BEGIN
	SET @@SQL = "DROP TABLE " + @TABLE_NAME 
	EXEC (@@SQL)
END
*/

SET @@SQL = "CREATE TABLE " + @TABLE_NAME
SET @@SQL = @@SQL + "("
SET @@SQL = @@SQL + "	CLTCODE VARCHAR(10),"
SET @@SQL = @@SQL + "	ACNAME VARCHAR(100),"
SET @@SQL = @@SQL + "	BRANCHCODE VARCHAR(10),"
SET @@SQL = @@SQL + "	EXCHANGE VARCHAR(10),"
SET @@SQL = @@SQL + "	SEGMENT VARCHAR(15),"
IF @WITHOPENING = 1 BEGIN
SET @@SQL = @@SQL + "	OPENING_AMOUNT MONEY,"
--SET @@SQL = @@SQL + "	PERIOD_AMOUNT MONEY,"
SET @@SQL = @@SQL + "	PERIOD_CREDIT MONEY,"
SET @@SQL = @@SQL + "	PERIOD_DEBIT MONEY,"
END
SET @@SQL = @@SQL + "	AMOUNT MONEY,"
SET @@SQL = @@SQL + "	ACCAT SMALLINT,"
SET @@SQL = @@SQL + "	GRPCODE VARCHAR(15),"
SET @@SQL = @@SQL + "	GRPNAME VARCHAR(100)"
SET @@SQL = @@SQL + ")"

PRINT @@SQL
EXEC (@@SQL)


CREATE TABLE [DBO].[#DBNAME](ACCOUNTDB VARCHAR(20),
EXCHANGE VARCHAR(6),
SEGMENT VARCHAR(10),
ACCOUNTSERVER VARCHAR(30),
SHAREDB VARCHAR(20),
GROUPID VARCHAR(20),
ORDER_SEGMENT INT) ON [PRIMARY]
DECLARE @@DB VARCHAR(1000)

--SET @EXCSEGMENT = REPLACE(LEFT(@EXCSEGMENT,LEN(@EXCSEGMENT)),'|',',')          
--PRINT @EXCSEGMENT    

IF @EXCSEGMENT = '' 
SELECT	@EXCSEGMENT = EXCHANGE + '~' + SEGMENT FROM OWNER

SET @EXCSEGMENT = REPLACE(@EXCSEGMENT, '|', ',')

SELECT
	@@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM CLS_COMPANY_MASTER_SETTING (NOLOCK) WHERE DISPLAY_EXCHANGE + '~' + DISPLAY_SEGMENT IN ('" + REPLACE(@EXCSEGMENT, ',', ''',''') + "') ORDER BY EXCHANGE "


EXEC (@@DB)




DECLARE @@MAINREC AS CURSOR,
@@ACCOUNTDB VARCHAR(20),
@@SHAREDB VARCHAR(20),
@@ACCOUNTSVR VARCHAR(20),
@@EXCHANGE VARCHAR(15),
@@SEGMENT VARCHAR(15),
@@GROUPID VARCHAR(20),
@@ORDERSEG VARCHAR(3),
@@ORDERSECOUNT INT
SET @@ORDERSECOUNT = (SELECT
		COUNT(1)
	FROM CLS_COMPANY_MASTER_SETTING)

--SET @@SQL = ""          
SET @@MAINREC = CURSOR FOR SELECT
	ACCOUNTDB
	,EXCHANGE
	,SEGMENT
	,ACCOUNTSERVER
	,SHAREDB
	,GROUPID
	,ORDER_SEGMENT
FROM #DBNAME


OPEN @@MAINREC
FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB, @@GROUPID, @@ORDERSEG
WHILE @@FETCH_STATUS = 0 
BEGIN
SET @@SQL = "EXEC " + @@ACCOUNTDB + "..CLS_TRIALBALANCE_WITHOUTEXCHANGE '" + @FR_DATE + "','" + @VDT + "','" + @VIEWOPTION + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE + "','" + @SHOWZEROBAL + "','" + @GRPCODE + "','" + @@SHAREDB + "','" + @@EXCHANGE + "','" + @@SEGMENT + "','" + @TABLE_NAME + "','" + @BRANCHCODE + "'," + CONVERT(VARCHAR, @WITHOPENING) + ",'" + @SORT_BY + "'"
PRINT @@SQL
EXEC (@@SQL)


FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB, @@GROUPID, @@ORDERSEG
END

SET @@SQL = "INSERT INTO " + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT CLTCODE,ACNAME,BRANCHCODE,EXCHANGE = '',SEGMENT = '', "
IF @WITHOPENING = 1 
BEGIN
SET @@SQL = @@SQL + "OPENING_AMOUNT = SUM(OPENING_AMOUNT), PERIOD_CREDIT = SUM(PERIOD_CREDIT), PERIOD_DEBIT = SUM(PERIOD_DEBIT),"
END
SET @@SQL = @@SQL + "AMOUNT = SUM(AMOUNT),"
SET @@SQL = @@SQL + "ACCAT,GRPCODE = '',GRPNAME = '' "
SET @@SQL = @@SQL + "FROM " + @TABLE_NAME
SET @@SQL = @@SQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE,ACCAT"

PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = "INSERT INTO " + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT CLTCODE = 'ZZZZ',ACNAME = 'TOTAL BALANCE',BRANCHCODE = '',EXCHANGE,SEGMENT, "
IF @WITHOPENING = 1 
BEGIN
SET @@SQL = @@SQL + "OPENING_AMOUNT = SUM(OPENING_AMOUNT), PERIOD_CREDIT = SUM(PERIOD_CREDIT), PERIOD_DEBIT = SUM(PERIOD_DEBIT),"
END
SET @@SQL = @@SQL + "AMOUNT = SUM(AMOUNT),"
SET @@SQL = @@SQL + "ACCAT = 0,GRPCODE = '',GRPNAME = '' "
SET @@SQL = @@SQL + "FROM " + @TABLE_NAME
SET @@SQL = @@SQL + " GROUP BY EXCHANGE,SEGMENT"

SET @@SQL = @@SQL + " delete from " + @TABLE_NAME + " where EXCHANGE <> '' "

PRINT @@SQL
EXEC (@@SQL)


/* START CHANGES FOR DYNAMIC PIVOT BY BADRISH 23112018 */

DECLARE @EXCHSEG VARCHAR(1000),
@EXCHSEG1 VARCHAR(1000),
@COLUMNSTRING VARCHAR(1000),
@TOTALCOLUMNSTRING VARCHAR(1000),
@PIVOTSTRING VARCHAR(1000),
@PIVOTSTRING1 VARCHAR(1000),
@CHKZEROSTRING VARCHAR(1000)
SET @EXCHSEG = REPLACE(@EXCSEGMENT, '~', '')

DECLARE @MIN INT, @MAX INT
SELECT
	@MAX = LEN(@EXCHSEG) - LEN(REPLACE(@EXCHSEG, ',', '')) + 1
SET @MIN = 1
SET @COLUMNSTRING = ''
SET @PIVOTSTRING = ''
SET @PIVOTSTRING1 = ''
SET @CHKZEROSTRING = ''
SET @TOTALCOLUMNSTRING = ''


WHILE (@MIN <= @MAX) BEGIN
IF @COLUMNSTRING = '' BEGIN
SET @EXCHSEG1 = "ISNULL(SUM(" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + "),'') AS " +.DBO.PIECE(@EXCHSEG, ',', @MIN)
END ELSE BEGIN
SET @EXCHSEG1 = " , ISNULL(SUM(" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + "),'') AS " +.DBO.PIECE(@EXCHSEG, ',', @MIN)
END

SET @COLUMNSTRING = @COLUMNSTRING + @EXCHSEG1


IF @TOTALCOLUMNSTRING = '' BEGIN
SET @EXCHSEG1 = "ISNULL(" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + ",'') " 
END ELSE BEGIN
SET @EXCHSEG1 = " + ISNULL(" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + ",'') "
END

SET @TOTALCOLUMNSTRING = @TOTALCOLUMNSTRING + @EXCHSEG1
 
IF @CHKZEROSTRING = '' BEGIN
SET @EXCHSEG1 = "ISNULL(SUM(" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + "),'')  "  /*+ .DBO.PIECE(@EXCHSEG, ',',@MIN) */
END ELSE BEGIN
SET @EXCHSEG1 = " + ISNULL(SUM(" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + "),'')  "  /*+ .DBO.PIECE(@EXCHSEG, ',',@MIN) */
END

SET @CHKZEROSTRING = @CHKZEROSTRING + @EXCHSEG1

IF @PIVOTSTRING = '' BEGIN
SET @PIVOTSTRING = "[" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + "]"
END ELSE BEGIN
SET @PIVOTSTRING = " , [" +.DBO.PIECE(@EXCHSEG, ',', @MIN) + "]"
END



SET @PIVOTSTRING1 = @PIVOTSTRING1 + @PIVOTSTRING
SET @MIN = @MIN + 1


END

/* END CHANGES FOR DYNAMIC PIVOT BY BADRISH 23112018 */



IF @OPTTYPE = 'C' 
BEGIN
	IF(@WITHOPENING = 1)
	BEGIN 
		IF @SHOWZEROBAL = 'T' 
			SET @@SQL = "SELECT * FROM " + @TABLE_NAME + " T WHERE EXISTS(SELECT CLTCODE FROM " + @TABLE_NAME + " T1 WHERE T.CLTCODE = T1.CLTCODE AND GRPCODE = '" + @GRPCODE + "'  ) AND EXCHANGE='' AND SEGMENT=''  ORDER BY CLTCODE, EXCHANGE " 
		ELSE 
			SET @@SQL = "SELECT * FROM " + @TABLE_NAME + " T WHERE (AMOUNT <> 0 )   AND EXISTS(SELECT CLTCODE FROM " + @TABLE_NAME + " T1 WHERE T.CLTCODE = T1.CLTCODE AND GRPCODE = '" + @GRPCODE + "') AND EXCHANGE='' AND SEGMENT='' ORDER BY CLTCODE, EXCHANGE "
	
	END
	ELSE
		BEGIN
		SET @@SQL = " ALTER TABLE " + @TABLE_NAME + " ADD EXCHANGE1 VARCHAR(100) "
		EXEC (@@SQL)
		SET @@SQL = " UPDATE   " + @TABLE_NAME + " SET EXCHANGE1 =  EXCHANGE+SEGMENT "
		EXEC (@@SQL)
		SET @@SQL = " SELECT CLTCODE,ACNAME,BRANCHCODE,ACCAT,MAX(GRPCODE) AS GRPCODE ,MAX(GRPNAME) AS GRPNAME, " + @COLUMNSTRING + ", SUM(" + @TOTALCOLUMNSTRING +") AS GRANDTOTAL FROM ("
		SET @@SQL = @@SQL + " SELECT * FROM " + @TABLE_NAME
		SET @@SQL = @@SQL + " PIVOT ( SUM(AMOUNT) FOR EXCHANGE1  IN (" + @PIVOTSTRING1 + ") ) AS D) AS F GROUP BY  CLTCODE,ACNAME,BRANCHCODE,ACCAT"
		
		IF @SHOWZEROBAL <> 'T' 
		BEGIN
		
			SET @@SQL = @@SQL + " HAVING " + @CHKZEROSTRING + " <> 0"
		END
	END
END 
ELSE 
BEGIN
	IF @SHOWZEROBAL = 'T' 
		SET @@SQL = "SELECT * FROM " + @TABLE_NAME + " T WHERE EXISTS(SELECT CLTCODE FROM " + @TABLE_NAME + " T1 WHERE T.CLTCODE = T1.CLTCODE AND GRPCODE = '" + @GRPCODE + "') ORDER BY CLTCODE, EXCHANGE " 
	ELSE 
		SET @@SQL = "SELECT * FROM " + @TABLE_NAME + " T WHERE (AMOUNT <> 0 )   AND EXISTS(SELECT CLTCODE FROM " + @TABLE_NAME + " T1 WHERE T.CLTCODE = T1.CLTCODE AND GRPCODE = '" + @GRPCODE + "') ORDER BY CLTCODE, EXCHANGE "
END

IF(@BULKMODE = 'DB') -- FOR USING GENERIC REPOR 
BEGIN

SET @@SQL = " TRUNCATE TABLE  CLS_TB_TEMP " 
SET @@SQL = @@SQL + " INSERT INTO CLS_TB_TEMP " 
SET @@SQL = @@SQL + " SELECT CLTCODE,ACNAME,BRANCHCODE,ACCAT,MAX(GRPCODE) AS GRPCODE ,MAX(GRPNAME) AS GRPNAME, " + @COLUMNSTRING + ", SUM(" + @TOTALCOLUMNSTRING +") AS GRANDTOTAL FROM ("
SET @@SQL = @@SQL + " SELECT * FROM " + @TABLE_NAME
SET @@SQL = @@SQL + " PIVOT ( SUM(AMOUNT) FOR EXCHANGE1  IN (" + @PIVOTSTRING1 + ") ) AS D) AS F GROUP BY  CLTCODE,ACNAME,BRANCHCODE,ACCAT"
SET @@SQL = @@SQL + " HAVING " + @CHKZEROSTRING + " <> 0"

END

EXEC (@@SQL)
SET @@SQL = "DROP TABLE " + @TABLE_NAME
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CMSRECO_BULK
-- --------------------------------------------------

--EXEC CMSRECO_BULK 'BANK01', 'E:\BACKOFFICE\CMSRECO\TEST.CSV', 'NIKHIL'
CREATE   PROC CMSRECO_BULK
	@BANKCODE VARCHAR(10),
	@FNAME VARCHAR(500),
	@UNAME VARCHAR(100)

AS

SET NOCOUNT ON 
/*--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/

DECLARE  
	@@ERROR_COUNT INT, 
	@@CMSRECOCOUNT AS INT, 
	@@MICRNO AS VARCHAR(10),
	@@FROMDATE AS DATETIME,
	@@SQL VARCHAR(8000)


/*	       SELECT @@ERROR_COUNT = COUNT(1) FROM (SELECT U_FILENAME FROM V2_UPLOADED_FILES  
WHERE U_FILENAME = '" & UCASE(FNAME) &' AND U_MODULE = 'CMS AUTO-RECONCILIATION') A 

IF @@ERROR_COUNT > 0 
BEGIN 
SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + '" & UCASE(FNAME) &' 
RETURN 
END */

--BEGIN TRAN 

/*--	       DROP TABLE #CMS_TABLE  
--	       DROP TABLE #CMS_TABLE_TMP  */
CREATE TABLE #CMS_TABLE_TMP 
( 
	STRLINETEXT VARCHAR(8000) 
) 

CREATE TABLE [DBO].[#CMS_TABLE_TEST] ( 
	[STRROWTYPE] [VARCHAR] (1) NULL , 
	[STRENTRYID] [VARCHAR] (12) NULL, 
	[STRENTRYTYPE] [VARCHAR] (1) NULL , 
	[STRDC] [VARCHAR] (1) NULL , 
	[STRENTRYAMOUNT] [VARCHAR] (15) NULL , 
	[STRVALUEDATE] [VARCHAR] (8) NULL , 
	[STRPOSTDATE] [VARCHAR] (8) NULL , 
	[STRPRDCODE] [VARCHAR] (10) NULL , 
	[STRPKLOCATION] [VARCHAR] (50) NULL , 
	[STRPKDESCRIPTION] [VARCHAR] (50) NULL , 
	[STRPKDATE] [VARCHAR](8) NULL , 
	[STRDEPOSITSLIP] [VARCHAR] (10) NULL , 
	[STRDEPOSITDATE] [VARCHAR](8) NULL , 
	[STRDEPOSITAMOUNT] [VARCHAR](15) NULL , 
	[STRNOOFINST] [VARCHAR] (5) NULL , 
	[STRDEPOSITREMARK] [VARCHAR] (500) NULL , 
	[STRINSTNO] [VARCHAR] (15) NULL , 
	[STRDRAWEEBANK] [VARCHAR] (500) NULL , 
	[STRCLEARLOCATION] [VARCHAR] (500) NULL , 
	[STRINSTAMOUNT] [VARCHAR](15) NULL , 
	[STRINSTDATE] [VARCHAR](8) NULL , 
	[STRDRAWERNAME] [VARCHAR] (500) NULL , 
	[STRENRICHMENTNO] [VARCHAR] (100) NULL , 
	[STRENRICHMENTDATE] [VARCHAR] (100) NULL , 
	[STRENRICHMENTREMARK] [VARCHAR] (4000) NULL 
) ON [PRIMARY] 

CREATE TABLE [DBO].[#CMS_TABLE] ( 
	[SNO] [INT] NOT NULL IDENTITY(1,1), 
	[STRROWTYPE] [VARCHAR] (1) NULL , 
	[STRENTRYID] [VARCHAR] (12) NULL, 
	[STRENTRYTYPE] [VARCHAR] (1) NULL , 
	[STRDC] [VARCHAR] (1) NULL , 
	[STRENTRYAMOUNT] [MONEY] NULL , 
	[STRVALUEDATE] [DATETIME] NULL , 
	[STRPOSTDATE] [DATETIME] NULL , 
	[STRPRDCODE] [VARCHAR] (10) NULL , 
	[STRPKLOCATION] [VARCHAR] (500) NULL , 
	[STRPKDESCRIPTION] [VARCHAR] (500) NULL , 
	[STRPKDATE] [DATETIME] NULL , 
	[STRDEPOSITSLIP] [VARCHAR] (10) NULL , 
	[STRDEPOSITDATE] [DATETIME] NULL , 
	[STRDEPOSITAMOUNT] [MONEY] NULL , 
	[STRNOOFINST] [VARCHAR] (5) NULL , 
	[STRDEPOSITREMARK] [VARCHAR] (500) NULL , 
	[STRINSTNO] [VARCHAR] (15) NULL , 
	[STRDRAWEEBANK] [VARCHAR] (500) NULL , 
	[STRCLEARLOCATION] [VARCHAR] (500) NULL , 
	[STRINSTAMOUNT] [MONEY] NULL , 
	[STRINSTDATE] [DATETIME] NULL , 
	[STRDRAWERNAME] [VARCHAR] (500) NULL , 
	[STRENRICHMENTNO] [VARCHAR] (100) NULL , 
	[STRENRICHMENTDATE] [VARCHAR] (100) NULL , 
      [STRENRICHMENTREMARK] VARCHAR(100) NULL,
      [STRFILLER] VARCHAR(10) NULL,
	[STRBANKCODE] [VARCHAR] (10) NOT NULL, 
	[STRSTATUS] [VARCHAR] (8) NOT NULL
) ON [PRIMARY] 



/*SELECT @@SQL = "BULK INSERT #CMS_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 1, LASTROW = 1, KEEPNULLS)"
EXEC (@@SQL)  */

SELECT @@SQL = "BULK INSERT #CMS_TABLE_TEST FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 2, KEEPNULLS)"            
EXEC (@@SQL)  

SELECT * FROM #CMS_TABLE_TEST
RETURN
/*
INSERT INTO V2_UPLOADED_FILES 
SELECT 
	@FNAME, 
	@FNAME, 
	COUNT(1), 
	'B', 
	GETDATE(), 
	@UNAME, 
	'CMS AUTO-RECONCILIATION' 
*/

DECLARE 
	@@STRHEADER AS VARCHAR(50), 
	@@FILEHEADERDATE AS DATETIME 

SELECT 
	TOP 1 @@STRHEADER = LTRIM(RTRIM(STRLINETEXT)) FROM #CMS_TABLE_TMP 

SELECT @@FILEHEADERDATE = CONVERT(DATETIME, RIGHT(SUBSTRING(@@STRHEADER,2,8), 4) + '-' + SUBSTRING(SUBSTRING(@@STRHEADER,2,8), 3, 2) + '-' + LEFT(SUBSTRING(@@STRHEADER,2,8), 2)) 

SELECT 
@@ERROR_COUNT = COUNT(1) 
FROM 
( 
	SELECT 
		TOP 1 FILEHEADER_DATE 
	FROM 
		CMSRECODETAILS 
	WHERE 
		BANK_CODE = @BANKCODE
		AND FILEHEADER_DATE = @@FILEHEADERDATE 
		AND STATUS <> 'CORRECT' 
) A 

SELECT 
	@@CMSRECOCOUNT = COUNT(1) 
FROM 
	CMSRECO 
WHERE 
	BANK_CODE = @BANKCODE
	AND FILEHEADER_DATE = @@FILEHEADERDATE 


INSERT INTO 
	#CMS_TABLE
	(STRDC, STRENTRYAMOUNT, STRVALUEDATE, STRPOSTDATE, STRDEPOSITDATE, STRDEPOSITAMOUNT, STRINSTNO, STRINSTAMOUNT, STRINSTDATE, STRBANKCODE, STRSTATUS)
	SELECT 
		STRDC = STRDC, 
		STRENTRYAMOUNT = CONVERT(MONEY, STRENTRYAMOUNT), 
		STRVALUEDATE = CONVERT(DATETIME, RIGHT(STRVALUEDATE, 4) + '-' + SUBSTRING(STRVALUEDATE, 3, 2) + '-' + LEFT(STRVALUEDATE, 2)), 
		STRPOSTDATE = CONVERT(DATETIME, RIGHT(STRPOSTDATE, 4) + '-' + SUBSTRING(STRPOSTDATE, 3, 2) + '-' + LEFT(STRPOSTDATE, 2)), 
		STRDEPOSITDATE = CONVERT(DATETIME, RIGHT(STRDEPOSITDATE, 4) + '-' + SUBSTRING(STRDEPOSITDATE, 3, 2) + '-' + LEFT(STRDEPOSITDATE, 2)), 
		STRDEPOSITAMOUNT = CONVERT(MONEY,STRDEPOSITAMOUNT), 
		STRINSTNO = CONVERT(VARCHAR, CONVERT(INT, STRINSTNO)), 
		STRINSTAMOUNT = CONVERT(MONEY, STRINSTAMOUNT), 
		STRINSTDATE = CONVERT(DATETIME, RIGHT(STRINSTDATE, 4) + '-' + SUBSTRING(STRINSTDATE, 3, 2) + '-' + LEFT(STRINSTDATE, 2)), 
		STRBANKCODE = @BANKCODE,  
		STRSTATUS = 'MISMATCH' 
	FROM 
		#CMS_TABLE_TEST 




DELETE 
FROM 
	#CMS_TABLE 
WHERE 
	STRVALUEDATE <> @@FILEHEADERDATE 


SELECT @@FROMDATE = DATEADD ( DD , -90, @@FILEHEADERDATE) 

SELECT 
	VNO, 
	VTYP,
	BOOKTYPE, 
	LNO 
INTO 
	#FIRST_HASH_LEDGER 
FROM 
	LEDGER WITH (NOLOCK)
WHERE 
	VTYP IN (2, 3, 5, 19, 20, 17) 
	AND CLTCODE = @BANKCODE
	AND VDT >= @@FROMDATE 


SELECT 
	L1.VNO, 
	L1.VTYP, 
	L1.BOOKTYPE, 
	L1.RELAMT, 
	L1.DDNO, 
	L1.DRCR, 
	STATUS = 'MISMATCH', 
	SNO = 0 
INTO 
	#FIRST_HASH_LEDGER1 
FROM 
	LEDGER1 L1 WITH (NOLOCK), 
	#FIRST_HASH_LEDGER F WITH (NOLOCK) 
WHERE 
	F.VNO = L1.VNO 
	AND F.VTYP = L1.VTYP 
	AND F.BOOKTYPE = L1.BOOKTYPE 
	AND F.LNO <> L1.LNO 
	AND L1.RELDT = '' 
	AND L1.DDNO <> '' 
	AND L1.DDNO <> '0' 

DROP TABLE #FIRST_HASH_LEDGER

UPDATE 
	L1 
SET 
	STATUS = 'CORRECT', 
	SNO = C.SNO 
FROM 
	#FIRST_HASH_LEDGER1 L1, 
	#CMS_TABLE C WITH (NOLOCK) 
WHERE 
	L1.RELAMT = C.STRENTRYAMOUNT 
	AND L1.DDNO = C.STRINSTNO 
	AND L1.DRCR = C.STRDC 
	AND L1.VNO IN
	(SELECT MIN(VNO) FROM #FIRST_HASH_LEDGER1 L2
			WHERE L2.RELAMT = C.STRENTRYAMOUNT 
			AND L2.DDNO = C.STRINSTNO 
			AND L2.DRCR = C.STRDC) 

UPDATE 
	C 
SET 
	STRSTATUS = 'CORRECT' 
FROM 
	#CMS_TABLE C, 
	#FIRST_HASH_LEDGER1 L1 WITH (NOLOCK) 
WHERE 
	C.SNO = L1.SNO 

DELETE 
FROM 
	#FIRST_HASH_LEDGER1 
WHERE 
	STATUS <> 'CORRECT' 

SELECT 
	@@ERROR_COUNT = COUNT(1) 
FROM 
	#CMS_TABLE 
WHERE 
	STRSTATUS <> 'CORRECT' 

SELECT 
	@@MICRNO = MICRNO 
FROM 
	ACMAST 
WHERE 
	CLTCODE = @BANKCODE


/*DELETE FROM CMSRECO WHERE BANK_CODE = @BANKCODEAND FILEHEADER_DATE = @@FILEHEADERDATE 
DELETE FROM CMSRECODETAILS WHERE BANK_CODE = @BANKCODEAND FILEHEADER_DATE = @@FILEHEADERDATE  */

IF @@ERROR_COUNT = 0 
BEGIN 
/*-----------------------INSERTING INTO CMSRECO, CMSRECODETAILS AND UPDATING LEDGER1 WHEN ALL ARE MATCHED---------*/ 


	INSERT  
	INTO CMSRECO  
	( 
		FILEHEADER_DATE,  
		BANK_CODE,  
		MICR_NO,  
		ENTRY_AMOUNT,  
		DEPOSIT_AMOUNT,  
		INST_AMOUNT,  
		STATUS_ID,  
		STATUS_NAME,  
		UPLOAD_BY,  
		UPLOAD_DATE,  
		AMOUNTMISMATCH,  
		MANUALUPDATE,  
		LEDGERAMOUNT 
	)  
	SELECT  
		@@FILEHEADERDATE,  
		BANK_CODE = @BANKCODE,  
		@@MICRNO,  
		ENTRY_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END,  
		DEPOSIT_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRDEPOSITAMOUNT)  ELSE SUM(STRDEPOSITAMOUNT)  END,  
		INST_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRINSTAMOUNT)  ELSE SUM(STRINSTAMOUNT)  END,  
		STATUS_ID = @UNAME,  
		STATUS_NAME = @UNAME,  
		UPLOAD_BY = @UNAME,  
		UPLOAD_DATE = GETDATE(),  
		AMOUNTMISMATCH = 'NO',  
		MANUALUPDATE = 'NO',  
		LEDGERAMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END  
	FROM 
		#CMS_TABLE WITH(NOLOCK)  
	GROUP BY 
		STRDC  
	
	
	
	UPDATE  
		LEDGER1  
	SET 
		RELDT = @@FILEHEADERDATE  
	FROM 
		#FIRST_HASH_LEDGER1 L1  
	WHERE 
		LEDGER1.VNO = L1.VNO  
		AND LEDGER1.VTYP = L1.VTYP  
		AND LEDGER1.BOOKTYPE = L1.BOOKTYPE  
		AND LEDGER1.RELAMT = L1.RELAMT  
		AND LEDGER1.DRCR = L1.DRCR  
		AND LEDGER1.RELDT = ''  
		AND STATUS = 'CORRECT'
	
	
	
	UPDATE 
		LEDGER 
	SET
		EDT =  @@FILEHEADERDATE
	FROM 
		#FIRST_HASH_LEDGER1 L1  
	WHERE 
		LEDGER.VNO = L1.VNO  
		AND LEDGER.VTYP = L1.VTYP  
		AND LEDGER.BOOKTYPE = L1.BOOKTYPE  					
		AND EDT LIKE 'DEC 31 2049%'
	/*----------------- CHANGES ---------------------*/
END 
ELSE 
/*----------INSERTING INTO CMSRECO, CMSRECODETAILS AND NOT UPDATING LEDGER1 WHEN ALL ARE NOT MATCHED---------*/ 
BEGIN 
	INSERT  
	INTO CMSRECO  
	( 
		FILEHEADER_DATE,  
		BANK_CODE,  
		MICR_NO,  
		ENTRY_AMOUNT,  
		DEPOSIT_AMOUNT,  
		INST_AMOUNT,  
		STATUS_ID,  
		STATUS_NAME,  
		UPLOAD_BY,  
		UPLOAD_DATE,  
		AMOUNTMISMATCH,  
		MANUALUPDATE,  
		LEDGERAMOUNT 
	)  
	SELECT  
		@@FILEHEADERDATE,  
		@BANKCODE,  
		@@MICRNO,  
		ENTRY_AMOUNT =  
		CASE WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END,  
		DEPOSIT_AMOUNT =  
		CASE  WHEN STRDC = 'D'  THEN -SUM(STRDEPOSITAMOUNT)  ELSE SUM(STRDEPOSITAMOUNT)  END,  
		INST_AMOUNT =  
		CASE  WHEN STRDC = 'D'  THEN -SUM(STRINSTAMOUNT)  ELSE SUM(STRINSTAMOUNT)  END,  
		STATUS_ID = @UNAME,  
		STATUS_NAME = @UNAME,  
		UPLOAD_BY = @UNAME,  
		UPLOAD_DATE = GETDATE(),  
		AMOUNTMISMATCH = 'YES',  
		MANUALUPDATE = 'NO',  
		LEDGERAMOUNT =  
		CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END 
	FROM 
		#CMS_TABLE WITH(NOLOCK)  
	GROUP BY 
		STRDC  
	
	UPDATE  
		CMSRECO  
	SET 
		LEDGERAMOUNT =  
		( 
			SELECT  
			ISNULL(-SUM(RELAMT), 0)  
			FROM #FIRST_HASH_LEDGER1  
			WHERE DRCR = 'D' 
		)  
	WHERE 
		ENTRY_AMOUNT < 0  
	
	UPDATE  
		CMSRECO  
	SET 
		LEDGERAMOUNT =  
		( 
			SELECT  
			ISNULL(SUM(RELAMT), 0)  
			FROM #FIRST_HASH_LEDGER1  
			WHERE DRCR = 'C' 
		)  
	WHERE 
		ENTRY_AMOUNT >= 0  
END 

INSERT  
INTO CMSRECODETAILS  
(  
	FILEHEADER_DATE,  
	ROW_TYPE,  
	ENTRY_ID,  
	ENTRY_TYPE,  
	DEBIT_CREDIT,  
	ENTRY_AMOUNT,  
	VALUE_DATE,  
	POST_DATE,  
	PROD_CODE,  
	PICKUP_LOCATION,  
	PICKUP_DISC,  
	PICKUP_DATE,  
	DEPOSIT_SLIP,  
	DEPOSIT_DATE,  
	DEPOSIT_AMOUNT,  
	NO_OF_INST,  
	DEPOSIT_REMARK,  
	INST_NO,  
	DRAWEE_BANK,  
	CLEAR_LOC,  
	INST_AMOUNT,  
	INST_DATE,  
	DRAWER_NAME,  
	ENRICHMENT_NO,  
	ENRICHMENT_DATE,  
	ENRICHMENT_REMARKS,  
	FILLER,  
	BANK_CODE,  
	MICR_NO,  
	STATUS_ID,  
	STATUS_NAME,  
	UPLOAD_BY,  
	UPLOAD_DATE,  
	STATUS,  
	LEDGERAMOUNT  
)  
SELECT  
	@@FILEHEADERDATE,  
	STRROWTYPE,  
	STRENTRYID,  
	STRENTRYTYPE,  
	STRDC,  
	STRENTRYAMOUNT,  
	STRVALUEDATE,  
	STRPOSTDATE,  
	STRPRDCODE,  
	STRPKLOCATION,  
	STRPKDESCRIPTION,  
	STRPKDATE,  
	STRDEPOSITSLIP,  
	STRDEPOSITDATE,  
	STRDEPOSITAMOUNT,  
	STRNOOFINST,  
	STRDEPOSITREMARK,  
	STRINSTNO,  
	STRDRAWEEBANK,  
	STRCLEARLOCATION,  
	STRINSTAMOUNT,  
	STRINSTDATE,  
	STRDRAWERNAME,  
	STRENRICHMENTNO,  
	STRENRICHMENTDATE,  
	STRENRICHMENTREMARK,  
	STRFILLER,  
	STRBANKCODE,  
	@@MICRNO,  
	STATUS_ID = @UNAME,  
	STATUS_NAME = @UNAME,  
	UPLOAD_BY = @UNAME,  
	UPLOAD_DATE = GETDATE(),  
	STRSTATUS,  
	LEDGERAMOUNT = 0 
FROM 
	#CMS_TABLE WITH(NOLOCK) 

IF @@ERROR_COUNT = 0 
BEGIN 
	SELECT 'DATA UPLOADED SUCCESSFULLY' AS RESULT 
END 
ELSE 
BEGIN 
	SELECT 'FILE UPLOADED SUCCESSFULLY WITH FOLLOWING MISMATCHES' 
	UNION ALL 
	select 'INST_NO, INST_AMT, INST_DATE, VALUE_DATE, STATUS '
	UNION ALL 
	SELECT 
		STRINSTNO + ', ' + CONVERT(VARCHAR, STRINSTAMOUNT) + ', ' + CONVERT(VARCHAR(10), STRINSTDATE, 103) + ', ' + CONVERT(VARCHAR(10), STRVALUEDATE, 103) + ', AMOUNTMISMATCH' AS RESULT 
	FROM 
		#CMS_TABLE 
	WHERE 
		STRSTATUS <> 'CORRECT' 
END  
DROP TABLE #CMS_TABLE  
DROP TABLE #CMS_TABLE_TMP 
DROP TABLE #FIRST_HASH_LEDGER1 

COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATELASTVNO
-- --------------------------------------------------
CREATE PROC CREATELASTVNO
AS
DECLARE
	@@SDTCUR AS DATETIME,
	@@LDTCUR AS DATETIME,
	@@VNOFLAG AS INT,
	@@BOOKTYPE AS VARCHAR(2),
	@@VCUR AS CURSOR,
	@@VNOCUR AS CURSOR


DELETE FROM LASTVNO WHERE VTYP = 8

SET @@VCUR = CURSOR FOR
	SELECT DISTINCT BOOKTYPE FROM BOOKTYPE WHERE VTYP = 8

OPEN @@VCUR
FETCH NEXT FROM @@VCUR INTO @@BOOKTYPE

WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @@VNOCUR = CURSOR FOR
			SELECT SDTCUR, LDTCUR, VNOFLAG FROM PARAMETER
		OPEN @@VNOCUR
		FETCH NEXT FROM @@VNOCUR INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
		WHILE @@FETCH_STATUS = 0
			BEGIN
				IF @@VNOFLAG = 0
					BEGIN
						INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO)
						SELECT VTYP = 8, BOOKTYPE = @@BOOKTYPE, VDT = CONVERT(VARCHAR(11), @@SDTCUR, 109), MAX(VNO)
						FROM LEDGER WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR AND VTYP = 8 AND BOOKTYPE = @@BOOKTYPE
					END
				ELSE IF @@VNOFLAG = 1
					BEGIN
						INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO)
						SELECT VTYP = 8, BOOKTYPE = @@BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
						FROM LEDGER WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR AND VTYP = 8 AND BOOKTYPE = @@BOOKTYPE
						GROUP BY CONVERT(VARCHAR(11), VDT, 109)
					END
				ELSE IF @@VNOFLAG = 2
					BEGIN
						INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO)
						SELECT VTYP = 8, BOOKTYPE = @@BOOKTYPE, 
							VDT = CONVERT(VARCHAR(4), YEAR(VDT)) + '-' + CASE WHEN LEN(CONVERT(VARCHAR, MONTH(VDT))) = 1 THEN '0' + CONVERT(VARCHAR, MONTH(VDT)) ELSE CONVERT(VARCHAR, MONTH(VDT)) END + '-01', 
							MAX(VNO)
						FROM LEDGER WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR AND VTYP = 8 AND BOOKTYPE = @@BOOKTYPE
						GROUP BY CONVERT(VARCHAR(4), YEAR(VDT)) + '-' + CASE WHEN LEN(CONVERT(VARCHAR, MONTH(VDT))) = 1 THEN '0' + CONVERT(VARCHAR, MONTH(VDT)) ELSE CONVERT(VARCHAR, MONTH(VDT)) END + '-01'
					END
				FETCH NEXT FROM @@VNOCUR INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			END
		FETCH NEXT FROM @@VCUR INTO @@BOOKTYPE
	END
DELETE FROM LASTVNO WHERE VTYP = 8 AND LASTVNO IS NULL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEPARTYLEDGER
-- --------------------------------------------------


CREATE  PROC CREATEPARTYLEDGER
AS
CREATE TABLE NEWPARTYLEDGER
	(
		BRANCH_CODE VARCHAR(11),
		BRANCH VARCHAR(40),
		CLTCODE VARCHAR(11),
		ACNAME VARCHAR(50),
		VDT DATETIME,
		EDT DATETIME,
		BRANCH_CD VARCHAR(10),
		SUB_BROKER VARCHAR(10),
		TRADER VARCHAR(20),
		FAMILY VARCHAR(10),
		AREA VARCHAR(10),
		REGION VARCHAR(50),
		PARTY VARCHAR(10),
		VAMT MONEY DEFAULT(0) NOT NULL,
		MAMT MONEY DEFAULT(0) NOT NULL,
		UNREALISED MONEY DEFAULT(0) NOT NULL,
		SPID SMALLINT
	)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEPARTYLEDGER_new
-- --------------------------------------------------


CREATE  PROC [dbo].[CREATEPARTYLEDGER_new]
AS
CREATE TABLE NEWPARTYLEDGER1
	(
		BRANCH_CODE VARCHAR(11),
		BRANCH VARCHAR(40),
		CLTCODE VARCHAR(11),
		ACNAME VARCHAR(50),
		VDT DATETIME,
		EDT DATETIME,
		BRANCH_CD VARCHAR(10),
		SUB_BROKER VARCHAR(10),
		TRADER VARCHAR(20),
		FAMILY VARCHAR(10),
		AREA VARCHAR(10),
		REGION VARCHAR(50),
		PARTY VARCHAR(10),
		NSEVAMT MONEY DEFAULT(0) NOT NULL, 
		BSEVAMT MONEY DEFAULT(0) NOT NULL,
		NFOVAMT MONEY DEFAULT(0) NOT NULL,
		NSEMAMT MONEY DEFAULT(0) NOT NULL, 
		BSEMAMT MONEY DEFAULT(0) NOT NULL,
		NFOMAMT MONEY DEFAULT(0) NOT NULL,
		NSEUNREALISED MONEY DEFAULT(0) NOT NULL,
		BSEUNREALISED MONEY DEFAULT(0) NOT NULL,
		NFOUNREALISED MONEY DEFAULT(0) NOT NULL,
		NSEHTOTAL MONEY DEFAULT(0) NOT NULL, 
		BSEHTOTAL MONEY DEFAULT(0) NOT NULL,
		NFOHTOTAL MONEY DEFAULT(0) NOT NULL,
		VAMT MONEY DEFAULT(0) NOT NULL,
		MAMT MONEY DEFAULT(0) NOT NULL,
		UNREALISED MONEY DEFAULT(0) NOT NULL,
		HTOTAL MONEY DEFAULT(0) NOT NULL,
		SPID SMALLINT
		
	)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Data4BillPosted
-- --------------------------------------------------


CREATE PROC Data4BillPosted

AS

DECLARE @@COUNTER AS NUMERIC
SELECT @@COUNTER = COUNT(*) FROM BILLPOSTED

IF @@COUNTER = 0
	BEGIN
		BEGIN TRAN
			INSERT 
			INTO BILLPOSTED 
				(
					VNO, 
					VTYP, 
					BOOKTYPE, 
					VDT, 
					BILLDATE, 
					SETT_NO, 
					SETT_TYPE, 
					NARRATION, 
					USERNAME, 
					POSTDATE, 
					EDTDR, 
					EDTCR
				) 
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				SUBSTRING(NARRATION, 20, 1), 
				--CASE WHEN SUBSTRING(NARRATION, 20, 1) = 'A' THEN SUBSTRING(NARRATION, 20, 2) ELSE SUBSTRING(NARRATION, 20, 1) END, 
				NARRATION, 
				'FROM SYSTEM', 
				GETDATE(), 
				CONVERT(VARCHAR(11), MIN(EDT), 109), 
				CONVERT(VARCHAR(11), MAX(EDT), 109) 
			FROM LEDGER 
			WHERE VDT >= 'APR  1 2005' 
				AND VTYP IN (15, 21) 
			GROUP BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				CASE 
					WHEN SUBSTRING(NARRATION, 20, 1) = 'A' 
					THEN SUBSTRING(NARRATION, 20, 2) 
					ELSE SUBSTRING(NARRATION, 20, 1) 
				END
				, 
				NARRATION 
			ORDER BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109) 
		COMMIT
	END
ELSE
	BEGIN
		PRINT 'Data Already Found in Table BillPosted. Cannot Continue...'
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delete_Ledger
-- --------------------------------------------------

CREATE Procedure Delete_Ledger
@vno varchar(12)
as
delete from ledger where vtyp = '18' and booktype = '01' and vno= @vno

delete from ledger2 where vtype = '18' and booktype = '01' and vno= @vno

delete from ledger3 where vtyp = '18' and booktype = '01' and vno= @vno

delete from marginledger where vtyp = '18' and booktype = '01' and vno= @vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DPRESPONSEFILE_BULK
-- --------------------------------------------------

create PROC [dbo].[DPRESPONSEFILE_BULK]
	@FNAME VARCHAR(100)
AS
/*
	Exec DPRESPONSEFILE_BULK 'D:\BackOffice\JvDrCrDpFiles\id20070228.txt'
*/
	SET NOCOUNT ON

	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000)

	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)

	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	DECLARE @@FILENAME AS VARCHAR(100)
	SELECT @@FILENAME = REPLACE(@FNAME, '.', 'Rf.')

	CREATE TABLE #TESTIMPORT
	(
		OneRow Varchar(2000)
	)

	SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FNAME + "' "
	EXEC(@@SQL)
		
	DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL

	UPDATE #TESTIMPORT SET ONEROW = ONEROW + 'Y~'

	SELECT * INTO TESTIMPORT FROM #TESTIMPORT
	DROP TABLE #TESTIMPORT
	
	SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FILENAME + CHAR(34) + " -c -q -U " + CHAR(34) + "sa" + CHAR(34) + " -P " + CHAR(34) + "ms" + CHAR(34) + "', no_output "
  	EXEC(@@SQL)

	DROP TABLE TESTIMPORT

	SELECT '<BR><BR><BR>RESPONSE FILE GENERATED AS "' + @@FILENAME + '"<BR><BR><BR><BR>'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRCRNOTEUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[DRCRNOTEUPLOAD_BULK]        
 @FNAME VARCHAR(100),          
 @UNAME VARCHAR(25),          
 @VTYP SMALLINT,          
 @BOOKTYPE VARCHAR(2),          
 @USERCAT INT          
AS          
/*          
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'          
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'          
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'          
*/          
 SET NOCOUNT ON          
          
 DECLARE          
  @@ERROR_COUNT AS INT,          
  @@SQL AS VARCHAR(2000),          
  @@BACKDAYS INT,          
  @@BACKDATE DATETIME,
  @@BRANCHFLAG TINYINT

       
          
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/          
 IF LTRIM(RTRIM(@FNAME)) = ''          
  BEGIN          
   SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'          
   RETURN          
  END          
          
 CREATE TABLE #FEXIST          
  (F1 INT, F2 INT, F3 INT)          
           
 SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "          
 EXEC (@@SQL)          
          
 SELECT @@ERROR_COUNT = F1 FROM #FEXIST          
 IF @@ERROR_COUNT = 0          
  BEGIN          
   SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'          
   DROP TABLE #FEXIST          
   RETURN          
  END          
          
 BEGIN TRAN          
          
 SELECT           
  @@ERROR_COUNT = COUNT(1)           
 FROM          
  (SELECT           
   U_FILENAME           
  FROM           
   V2_UPLOADED_FILES          
  WHERE           
   U_FILENAME = @FNAME           
   AND U_MODULE = 'DRCR NOTE UPLOAD') A          
          
/* IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME          
   ROLLBACK TRAN          
   RETURN          
  END          
*/          
          
 CREATE TABLE #RECPAY_TABLE_TMP          
 (          
  SRNO INT,          
  VVDT VARCHAR(10),          
  EEDT VARCHAR(10),          
  CLTCODE VARCHAR(10),          
  DRCR VARCHAR(1),          
  AMOUNT MONEY,          
  NARRATION VARCHAR(500),          
  BRANCHCODE VARCHAR(10),        
  L1_SRNO VARCHAR(5)            
 )          
          
 CREATE TABLE [#RECPAY_TABLE]          
 (          
  SRNO INT,          
  VVDT VARCHAR(10),          
  EEDT VARCHAR(10),          
  CLTCODE VARCHAR(10),          
  DRCR VARCHAR(1),          
  AMOUNT MONEY,          
  NARRATION VARCHAR(500),          
  BRANCHCODE VARCHAR(10),          
  L1_SRNO VARCHAR(5),        
  SNO INT IDENTITY (1, 1) NOT NULL ,          
  VDT DATETIME NULL ,          
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),          
  EDT DATETIME NULL ,          
  VNO VARCHAR (12)  NULL ,          
  ACNAME VARCHAR (100)  NULL ,          
  FYSTART DATETIME NULL,          
  FYEND DATETIME NULL,          
  COSTCODE SMALLINT NULL,          
  LNO SMALLINT NOT NULL DEFAULT(0)          
 ) ON [PRIMARY]          
          
 CREATE TABLE [#RECPAY_TABLE_LNO]          
 (          
  SNO INT ,          
  LNO INT IDENTITY (1, 1) NOT NULL          
 ) ON [PRIMARY]          
          
 SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "          
 EXEC(@@SQL)          
        
--NEW        
SELECT @@ERROR_COUNT = COUNT(1) FROM        
(        
        
SELECT R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT        
FROM         
#RECPAY_TABLE_TMP R,         
(SELECT SRNO, L1_SRNO, R1_COUNT = COUNT(1) FROM #RECPAY_TABLE_TMP GROUP BY SRNO, L1_SRNO HAVING COUNT(1) > 1) R1        
WHERE R.SRNO = R1.SRNO     
AND R.L1_SRNO = R1.L1_SRNO        
GROUP BY R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT        
HAVING COUNT(1) <> R1_COUNT        
) A        
        
    
IF  @@ERROR_COUNT > 0         
BEGIN        
   SELECT RESULT = 'CLIENT CODE SHOULD NOT DIFFERENCE WHETHER COST CENTER BREAK UP! '           
   ROLLBACK TRAN           RETURN        
END         
        
        
--NEW        
        
     
  INSERT INTO V2_UPLOADED_FILES          
  SELECT          
  @FNAME,          
  @FNAME,          
  COUNT(1),          
  'B',          
  GETDATE(),          
  @UNAME,          
  'DRCR NOTE UPLOAD'      
          
 INSERT INTO #RECPAY_TABLE          
  (SRNO,          
  VVDT,          
  EEDT,          
  CLTCODE,          
  DRCR,          
  AMOUNT,          
  NARRATION,          
  BRANCHCODE,        
  L1_SRNO)          
 SELECT          
  SRNO,          
  VVDT,          
  EEDT,          
  UPPER(CLTCODE),          
  DRCR,          
  AMOUNT,          
  LEFT(NARRATION, 234),          
  BRANCHCODE,        
  L1_SRNO          
 FROM #RECPAY_TABLE_TMP 

SELECT @@BRANCHFLAG = BRANCHFLAG FROM PARAMETER WHERE CURYEAR = 1
          

IF @@BRANCHFLAG = 1
BEGIN
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
   FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = C.COSTCODE          
      FROM ACMAST A, PARAMETER P, COSTMAST C          
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
      AND A.BRANCHCODE = C.COSTNAME          
      AND A.BRANCHCODE <> 'ALL'          
          
          
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
   FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = C.COSTCODE          
      FROM ACMAST A, PARAMETER P, COSTMAST C          
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
      AND #RECPAY_TABLE.BRANCHCODE = C.COSTNAME          
      AND A.BRANCHCODE = 'ALL'          
      AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'          
      AND #RECPAY_TABLE.COSTCODE IS NULL          
          
          
          
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
   FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')          
      FROM ACMAST A, PARAMETER P          
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
      AND A.BRANCHCODE = 'ALL'          
      AND #RECPAY_TABLE.BRANCHCODE = 'ALL'          
      AND #RECPAY_TABLE.COSTCODE IS NULL
END

IF @@BRANCHFLAG = 0
BEGIN
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
   FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = 0
      FROM ACMAST A, PARAMETER P
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
END
          
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/          
          
 DECLARE          
  @@STD_DATE VARCHAR(11),          
  @@LST_DATE VARCHAR(11),          
  @@VNOMETHOD INT,          
  @@ACNAME CHAR(100),          
  @@MICRNO VARCHAR(10),          
  @@DRCR VARCHAR(1)          
          
          
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND          
          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'DATE MISMATCH'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
/* '--------------------------UPDATE OF COST CODE ------------------------*/          
IF @@BRANCHFLAG = 1
BEGIN
 UPDATE #RECPAY_TABLE          
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')          
 WHERE COSTCODE IS NULL          
END
          
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)          
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(1) FROM          
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)          
  FROM #RECPAY_TABLE          
  GROUP BY SRNO          
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(1) FROM          
 (          
  SELECT DISTINCT          
   CLTCODE          
  FROM #RECPAY_TABLE          
  WHERE UPDFLAG = 'N'          
 ) A          
          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL          
   SELECT DISTINCT          
    CLTCODE          
   FROM #RECPAY_TABLE          
   WHERE UPDFLAG = 'N'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
          
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------          
 SELECT            
  @@BACKDAYS = ISNULL(MAX(NODAYS), 0)            
 FROM            
  USERWRITESTABLE            
 WHERE            
  USERCATEGORY = @USERCAT            
  AND VTYP = @VTYP            
  AND BOOKTYPE = @BOOKTYPE            
          
 SELECT            
  @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS            
          
 SELECT            
  @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)            
 FROM            
  #RECPAY_TABLE            
 WHERE            
  VDT < @@BACKDATE            
          
 IF @@ERROR_COUNT > 0            
 BEGIN            
  SELECT            
   'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'            
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  DELETE FROM V2_UPLOADED_FILES            
  WHERE            
   U_FILENAME = @FNAME            
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
  RETURN            
 END          
          
          
          
 DECLARE          
  @@NEWVNO AS VARCHAR(12),          
  @@VDT AS VARCHAR(11),          
  @@LNOCUR AS CURSOR,          
  @@LNOVNO AS INT,          
  @@NOREC AS INT          
          
          
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/          
 DECLARE          
  @@MAXVNO AS VARCHAR(12),          
  @@VNO AS VARCHAR(12),          
  @@RCOUNT AS INT          
 SELECT TOP 1          
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)          
 FROM          
  #RECPAY_TABLE          
          
 SELECT TOP 1          
  @@VNOMETHOD = VNOFLAG,          
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),          
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)          
 FROM          
  PARAMETER          
 WHERE          
  @@VDT BETWEEN SDTCUR AND LDTCUR          
          
 SELECT          
  @@NOREC = COUNT(DISTINCT SRNO)          
 FROM          
  #RECPAY_TABLE 

 CREATE TABLE #VNO
 (
	LASTVNO VARCHAR(12)
 )         

 INSERT INTO #VNO 
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

 SELECT @@VNO = LASTVNO FROM #VNO
          
 UPDATE          
  #RECPAY_TABLE          
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)          
          
          
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/          
          
 SET @@LNOCUR = CURSOR FOR          
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE          
 OPEN @@LNOCUR          
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO          
 WHILE @@FETCH_STATUS = 0          
  BEGIN          
   INSERT INTO #RECPAY_TABLE_LNO          
    (SNO)          
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO          
   UPDATE RP          
    SET LNO = RL.LNO          
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL          
   WHERE RP.SNO = RL.SNO          
  TRUNCATE TABLE #RECPAY_TABLE_LNO          
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO          
  END          
 CLOSE @@LNOCUR          
 DEALLOCATE @@LNOCUR          
 DROP TABLE #RECPAY_TABLE_LNO          
--select * from #RECPAY_TABLE        
--return        
          
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/          
/*==============================          
      LEDGER RECORD          
==============================*/          
          
 INSERT          
 INTO LEDGER          
 SELECT          
  VTYP = @VTYP,          
  VNO,          
  EDT,          
  L1_SRNO,          
  ACNAME,          
  DRCR,          
  VAMT = SUM(AMOUNT),          
  VDT,          
  VNO1 = VNO,          
  REFNO = 0,          
  BALAMT = SUM(AMOUNT),          
  NODAYS = 0,          
  CDT = GETDATE(),          
  CLTCODE,          
  BOOKTYPE = @BOOKTYPE,          
  ENTEREDBY = @UNAME,          
  PDT = GETDATE(),          
  CHECKEDBY = @UNAME,          
  ACTNODAYS = 0,          
  NARRATION          
 FROM          
  #RECPAY_TABLE          
 GROUP BY         
  VNO,          
  EDT,          
  L1_SRNO,          
  ACNAME,          
  DRCR,        
  VDT,          
  CLTCODE,        
  NARRATION        
        
        
/*==============================          
 LEDGER3 RECORD          
==============================*/          
 INSERT          
 INTO LEDGER3          
 SELECT          
  NARATNO = LNO,          
  NARRATION,          
  REFNO = 0,          
  VTYP = @VTYP,          
  VNO,          
  BOOKTYPE = @BOOKTYPE          
      FROM          
  #RECPAY_TABLE          
          
          
          
IF @@BRANCHFLAG = 1
BEGIN
 DELETE FROM TEMPLEDGER2          
  WHERE SESSIONID = '9999999999'          
 INSERT INTO TEMPLEDGER2          
 SELECT          
  'BRANCH',          
  C.COSTNAME,          
  AMOUNT,          
  VTYP = @VTYP,          
  VNO,          
  L1_SRNO,          
  DRCR,          
 '0',          
  BOOKTYPE = @BOOKTYPE,          
  SESSIONID = '9999999999',          
  CLIENT_CODE = CLTCODE,          
  'A',          
  '0'          
 FROM          
  #RECPAY_TABLE RP,          
  COSTMAST C          
 WHERE          
  RP.COSTCODE = C.COSTCODE          
          
 DECLARE @@L2CUR AS CURSOR,          
  @@L2VNO AS VARCHAR(12)          
 SET @@L2CUR = CURSOR FOR          
  SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO          
 OPEN @@L2CUR          
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO          
 WHILE @@FETCH_STATUS = 0          
  BEGIN          
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'          
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO          
  END          
  DELETE FROM TEMPLEDGER2          
   WHERE SESSIONID = '9999999999'          
  CLOSE @@L2CUR          
  DEALLOCATE @@L2CUR
END          
 COMMIT TRAN          
          
 SELECT RESULT = 'Data Uploaded Successfully'          
 UNION ALL          
 SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRCRNOTEUPLOAD_BULK_L1SRNO
-- --------------------------------------------------

create PROC [dbo].[DRCRNOTEUPLOAD_BULK_L1SRNO]        
 @FNAME VARCHAR(100),          
 @UNAME VARCHAR(25),          
 @VTYP SMALLINT,          
 @BOOKTYPE VARCHAR(2),          
 @USERCAT INT          
AS          
/*          
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'          
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'          
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'          
*/          
 SET NOCOUNT ON          
          
 DECLARE          
  @@ERROR_COUNT AS INT,          
  @@SQL AS VARCHAR(2000),          
  @@BACKDAYS INT,          
  @@BACKDATE DATETIME          
          
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/          
 IF LTRIM(RTRIM(@FNAME)) = ''          
  BEGIN          
   SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'          
   RETURN          
  END          
          
 CREATE TABLE #FEXIST          
  (F1 INT, F2 INT, F3 INT)          
           
 SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "          
 EXEC (@@SQL)          
          
 SELECT @@ERROR_COUNT = F1 FROM #FEXIST          
 IF @@ERROR_COUNT = 0          
  BEGIN          
   SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'          
   DROP TABLE #FEXIST          
   RETURN          
  END          
          
 BEGIN TRAN          
          
 SELECT           
  @@ERROR_COUNT = COUNT(1)           
 FROM          
  (SELECT           
   U_FILENAME           
  FROM           
   V2_UPLOADED_FILES          
  WHERE           
   U_FILENAME = @FNAME           
   AND U_MODULE = 'DRCR NOTE UPLOAD') A          
          
/* IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME          
   ROLLBACK TRAN          
   RETURN          
  END          
*/          
          
 CREATE TABLE #RECPAY_TABLE_TMP          
 (          
  SRNO INT,          
  VVDT VARCHAR(10),          
  EEDT VARCHAR(10),          
  CLTCODE VARCHAR(10),          
  DRCR VARCHAR(1),          
  AMOUNT MONEY,          
  NARRATION VARCHAR(500),          
  BRANCHCODE VARCHAR(10)          
 )          
          
 CREATE TABLE [#RECPAY_TABLE]          
 (          
  SRNO INT,          
  VVDT VARCHAR(10),          
  EEDT VARCHAR(10),          
  CLTCODE VARCHAR(10),          
  DRCR VARCHAR(1),          
  AMOUNT MONEY,          
  NARRATION VARCHAR(500),          
  BRANCHCODE VARCHAR(10),          
  SNO INT IDENTITY (1, 1) NOT NULL ,          
  VDT DATETIME NULL ,          
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),          
  EDT DATETIME NULL ,          
  VNO VARCHAR (12)  NULL ,          
  ACNAME VARCHAR (100)  NULL ,          
  FYSTART DATETIME NULL,          
  FYEND DATETIME NULL,          
  COSTCODE SMALLINT NULL,          
  LNO SMALLINT NOT NULL DEFAULT(0)          
 ) ON [PRIMARY]          
          
 CREATE TABLE [#RECPAY_TABLE_LNO]          
 (          
  SNO INT ,          
  LNO INT IDENTITY (1, 1) NOT NULL          
 ) ON [PRIMARY]          
          
 SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "          
 EXEC(@@SQL)          
        
--NEW     
/*   
SELECT @@ERROR_COUNT = COUNT(1) FROM        
(        
        
SELECT R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT        
FROM         
#RECPAY_TABLE_TMP R,         
(SELECT SRNO, L1_SRNO, R1_COUNT = COUNT(1) FROM #RECPAY_TABLE_TMP GROUP BY SRNO, L1_SRNO HAVING COUNT(1) > 1) R1        
WHERE R.SRNO = R1.SRNO     
AND R.L1_SRNO = R1.L1_SRNO        
GROUP BY R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT        
HAVING COUNT(1) <> R1_COUNT        
) A        
        
    
IF  @@ERROR_COUNT > 0         
BEGIN        
   SELECT RESULT = 'CLIENT CODE SHOULD NOT DIFFERENCE WHETHER COST CENTER BREAK UP! '           
   ROLLBACK TRAN           RETURN        
END         
        
        
--NEW        
*/        
     
  INSERT INTO V2_UPLOADED_FILES          
  SELECT          
  @FNAME,          
  @FNAME,          
  COUNT(1),          
  'B',          
  GETDATE(),          
  @UNAME,          
  'DRCR NOTE UPLOAD'      
          
 INSERT INTO #RECPAY_TABLE          
  (SRNO,          
  VVDT,          
  EEDT,          
  CLTCODE,          
  DRCR,          
  AMOUNT,          
  NARRATION,          
  BRANCHCODE)          
 SELECT          
  SRNO,          
  VVDT,          
  EEDT,          
  UPPER(CLTCODE),          
  DRCR,          
  AMOUNT,          
  LEFT(NARRATION, 234),          
  BRANCHCODE
 FROM #RECPAY_TABLE_TMP          
          
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = C.COSTCODE          
      FROM ACMAST A, PARAMETER P, COSTMAST C          
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
      AND A.BRANCHCODE = C.COSTNAME          
      AND A.BRANCHCODE <> 'ALL'          
          
          
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
   FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = C.COSTCODE          
      FROM ACMAST A, PARAMETER P, COSTMAST C          
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
      AND #RECPAY_TABLE.BRANCHCODE = C.COSTNAME          
      AND A.BRANCHCODE = 'ALL'          
      AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'          
      AND #RECPAY_TABLE.COSTCODE IS NULL          
          
          
          
 UPDATE          
  #RECPAY_TABLE          
  SET          
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),          
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),          
   FYSTART = P.SDTCUR,          
   FYEND = P.LDTCUR,          
   UPDFLAG = 'Y',          
   ACNAME = LONGNAME,          
   #RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')          
      FROM ACMAST A, PARAMETER P          
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE          
      AND P.CURYEAR = 1          
      AND A.ACCAT IN ('3','4','104')          
      AND A.BRANCHCODE = 'ALL'          
      AND #RECPAY_TABLE.BRANCHCODE = 'ALL'          
      AND #RECPAY_TABLE.COSTCODE IS NULL
          
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/          
          
 DECLARE          
  @@STD_DATE VARCHAR(11),          
  @@LST_DATE VARCHAR(11),          
  @@VNOMETHOD INT,          
  @@ACNAME CHAR(100),          
  @@MICRNO VARCHAR(10),          
  @@DRCR VARCHAR(1)          
          
          
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND          
          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'DATE MISMATCH'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
/* '--------------------------UPDATE OF COST CODE ------------------------*/          
          
 UPDATE #RECPAY_TABLE          
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')          
 WHERE COSTCODE IS NULL          
          
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)          
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(1) FROM          
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)          
  FROM #RECPAY_TABLE          
  GROUP BY SRNO          
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/          
          
 SELECT @@ERROR_COUNT = COUNT(1) FROM          
 (          
  SELECT DISTINCT          
   CLTCODE          
  FROM #RECPAY_TABLE          
  WHERE UPDFLAG = 'N'          
 ) A          
          
 IF @@ERROR_COUNT > 0          
  BEGIN          
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL          
   SELECT DISTINCT          
    CLTCODE          
   FROM #RECPAY_TABLE          
   WHERE UPDFLAG = 'N'          
   DROP TABLE #RECPAY_TABLE_TMP          
   DROP TABLE #RECPAY_TABLE          
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES          
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'          
   RETURN          
  END          
          
          
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------          
 SELECT            
  @@BACKDAYS = ISNULL(MAX(NODAYS), 0)            
 FROM            
  USERWRITESTABLE            
 WHERE            
  USERCATEGORY = @USERCAT            
  AND VTYP = @VTYP            
  AND BOOKTYPE = @BOOKTYPE            
          
 SELECT            
  @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS            
          
 SELECT            
  @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)            
 FROM            
  #RECPAY_TABLE            
 WHERE            
  VDT < @@BACKDATE            
          
 IF @@ERROR_COUNT > 0            
 BEGIN            
  SELECT            
   'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'            
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  DELETE FROM V2_UPLOADED_FILES            
  WHERE            
   U_FILENAME = @FNAME            
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
  RETURN            
 END          
          
          
          
 DECLARE          
  @@NEWVNO AS VARCHAR(12),          
  @@VDT AS VARCHAR(11),          
  @@LNOCUR AS CURSOR,          
  @@LNOVNO AS INT,          
  @@NOREC AS INT          
          
          
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/          
 DECLARE          
  @@MAXVNO AS VARCHAR(12),          
  @@VNO AS VARCHAR(12),          
  @@RCOUNT AS INT          
 SELECT TOP 1          
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)          
 FROM          
  #RECPAY_TABLE          
          
 SELECT TOP 1          
  @@VNOMETHOD = VNOFLAG,          
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),          
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)          
 FROM          
  PARAMETER          
 WHERE          
  @@VDT BETWEEN SDTCUR AND LDTCUR          
          
 SELECT          
  @@NOREC = COUNT(DISTINCT SRNO)          
 FROM          
  #RECPAY_TABLE 

 CREATE TABLE #VNO
 (
	LASTVNO VARCHAR(12)
 )         

 INSERT INTO #VNO 
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

 SELECT @@VNO = LASTVNO FROM #VNO
          
 UPDATE          
  #RECPAY_TABLE          
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)          
          
          
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/          
          
 SET @@LNOCUR = CURSOR FOR          
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE          
 OPEN @@LNOCUR          
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO          
 WHILE @@FETCH_STATUS = 0          
  BEGIN          
   INSERT INTO #RECPAY_TABLE_LNO          
    (SNO)          
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO          
   UPDATE RP          
    SET LNO = RL.LNO          
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL          
   WHERE RP.SNO = RL.SNO          
  TRUNCATE TABLE #RECPAY_TABLE_LNO          
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO          
  END          
 CLOSE @@LNOCUR          
 DEALLOCATE @@LNOCUR          
 DROP TABLE #RECPAY_TABLE_LNO          
--select * from #RECPAY_TABLE        
--return        
          
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/          
/*==============================          
      LEDGER RECORD          
==============================*/          
          
 INSERT          
 INTO LEDGER          
 SELECT          
  VTYP = @VTYP,          
  VNO,          
  EDT,          
  ACNAME,          
  DRCR,          
  VAMT = SUM(AMOUNT),          
  VDT,          
  VNO1 = VNO,          
  REFNO = 0,          
  BALAMT = SUM(AMOUNT),          
  NODAYS = 0,          
  CDT = GETDATE(),          
  CLTCODE,          
  BOOKTYPE = @BOOKTYPE,          
  ENTEREDBY = @UNAME,          
  PDT = GETDATE(),          
  CHECKEDBY = @UNAME,          
  ACTNODAYS = 0,          
  NARRATION          
 FROM          
  #RECPAY_TABLE          
 GROUP BY         
  VNO,          
  EDT,          
  ACNAME,          
  DRCR,        
  VDT,          
  CLTCODE,        
  NARRATION        
        
        
/*==============================          
 LEDGER3 RECORD          
==============================*/          
 INSERT          
 INTO LEDGER3          
 SELECT          
  NARATNO = LNO,          
  NARRATION,          
  REFNO = 0,          
  VTYP = @VTYP,          
  VNO,          
  BOOKTYPE = @BOOKTYPE          
      FROM          
  #RECPAY_TABLE          
          
          
          
          
 DELETE FROM TEMPLEDGER2          
  WHERE SESSIONID = '9999999999'          
 INSERT INTO TEMPLEDGER2          
 SELECT          
  'BRANCH',          
  C.COSTNAME,          
  AMOUNT,          
  VTYP = @VTYP,          
  VNO,          
  DRCR,          
 '0',          
  BOOKTYPE = @BOOKTYPE,          
  SESSIONID = '9999999999',          
  CLIENT_CODE = CLTCODE,          
  'A',          
  '0'          
 FROM          
  #RECPAY_TABLE RP,          
  COSTMAST C          
 WHERE          
  RP.COSTCODE = C.COSTCODE          
          
 DECLARE @@L2CUR AS CURSOR,          
  @@L2VNO AS VARCHAR(12)          
 SET @@L2CUR = CURSOR FOR          
  SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO          
 OPEN @@L2CUR          
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO          
 WHILE @@FETCH_STATUS = 0          
  BEGIN          
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'          
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO          
  END          
  DELETE FROM TEMPLEDGER2          
   WHERE SESSIONID = '9999999999'          
  CLOSE @@L2CUR          
  DEALLOCATE @@L2CUR          
 COMMIT TRAN          
          
 SELECT RESULT = 'Data Uploaded Successfully'          
 UNION ALL          
 SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EDITBANKLOCATE
-- --------------------------------------------------
CREATE procedure EDITBANKLOCATE
(
      @type            varchar(2),
      @cheque          varchar(10),
      @flag	           varchar(1),
      @STATUSID        VARCHAR(25),
      @STATUSNAME      VARCHAR(25)
 )
 AS
	IF @STATUSID <> 'BROKER'
	BEGIN
		RAISERROR ('This Procedure is accessible to Broker', 16, 1)
		RETURN
	END
	--IF @FLAG <> 'A' AND @FLAG <> 'E'
             IF @FLAG <> 'E' 
	BEGIN
		RAISERROR ('Add/Edit Flags Not Set Properly', 16, 1)
		RETURN
	END
  DECLARE
   @SQL Varchar(2000)
		BEGIN
		    SET  @SQL = "UPDATE banklocat"
                               SET @SQL = @SQL + " SET CHEQUE='" + @cheque + "'WHERE TYPE='"+ @type  + "'"
                              --print @SQL
                              EXEC(@SQL)
      
	            END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EditReconcile
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 04/15/2004 11:47:27 AM ******/  
  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 05/10/2004 5:29:32 PM ******/  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 04/11/2002 7:26:31 PM ******/  
  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 01/04/1980 1:40:37 AM ******/  
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 12/21/2001 12:40:04 PM ******/  
/*** Modified by VNS on 28/12/2001 to add book type ***/  
  
/* Created By VNS & Sandeep From Store Procedure Reconcile */  
  
CREATE PROCEDURE EditReconcile    
@code varchar(10),  
@frmdate varchar(11),  
@gdate varchar(11),  
@gdrcr  varchar(1),  
@flag varchar(1),  
@tVamt numeric(17,2)  
AS  
 if @flag=1   
 begin  
  select  isnull(sum(vamt) ,0) ,drcr from ledger   
  where cltcode =    @code    and   vdt <= @gdate     
  group by drcr  
  order  by drcr  
 end  
   
 if @flag=2  
 begin  
  if @tvamt =  0    
  begin  
   select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),  
   vno=l.vno, drcr=l.drcr ,lno=l.lno, vtyp=l.vtyp,chequeno=isnull(ddno,''), /*refno= l.refno ,*/amt= l.vamt,reldt=convert(varchar,ll1.reldt,103),booktype=l.booktype  
   From ledger l  ,LEDGER1 ll1   
   WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code  
   /*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */  
   and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.booktype= l.booktype and ll1.lno = l.lno and ll1.drcr=l.drcr and  
   l.vno in  
    (select vno from ledger l1 where cltcode =@code   and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.vno = l.vno)  
    and ll1.reldt <>'1900-01-01 00:00:00.000' and vdt >= @frmdate and vdt < =  @gdate    and   l.drcr like  @gdrcr  
   order by  convert(varchar,l.vdt,101) ,l.vtyp,l.vno,l.drcr  
  end  
  
  if  @tvamt <>0  
  begin  
   select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),  
   vno=l.vno, drcr=l.drcr ,lno=l.lno,vtyp=l.vtyp, chequeno=isnull(ddno,''),/* refno= l.refno ,*/amt= l.vamt,reldt=convert(varchar,ll1.reldt,103)  
   From ledger l  ,LEDGER1 LL1   
   WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code  
   and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno = l.lno and ll1.drcr=l.drcr and  
   /*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */  
   l.vno in  
    (select vno from ledger l1 where cltcode =@code   and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.vno = l.vno)  
    and ll1.reldt <>'1900-01-01 00:00:00.000'  and vdt >= @frmdate and vdt < =  @gdate    and   l.drcr like  @gdrcr  
    and  vamt = @tVamt  
    order by   convert(varchar,l.vdt,101)  ,l.vtyp,l.vno,l.drcr  
  end  
 end  
 if @flag = 3  
 begin  
  select L.drcr, sum(vamt) from ledger L, ledger1 l1 where l.vtyp = l1.vtyp and l.booktype=l1.booktype and l.vno = l1.vno  
  and l1.reldt = '1900-01-01 00:00:00.000' AND CLTCODE =@CODE  
  GROUP BY L.DRCR   
 end  
  
/*SUBSTRING(LL1.REFNO,1, 12)=SUBSTRING(L.REFNO,1, 12) */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Edtyearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 05/10/2004 5:29:33 PM ******/
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 02/18/2003 10:26:56 AM ******/
CREATE Procedure  Edtyearend
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime,
@msg1   varchar(234)
AS

set transaction isolation level read uncommitted

declare
@@netdiff as money


truncate table edtclbal

insert into edtclbal
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)
from ledger l left outer join acmast a on l.cltcode = a.cltcode
where l.edt > = @sdtcur + ' 00:00:00' and l.edt <= @ldtcur + ' 23:59:59'
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> '999999'
group by l.cltcode,l.acname
order by l.cltcode,l.acname

update ledger set balamt = e.balance from edtclbal e
where ledger.vtyp = @vtyp and ledger.booktype = @booktype and ledger.vno = @vno and ledger.cltcode = e.cltcode

select @@netdiff = ( select sum(balance) from edtclbal )

update ledger set balamt = isnull( case when @@netdiff > = 0 then -(@@netdiff) else abs(@@netdiff) end,0)
where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '999999'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fill_PartyBalances
-- --------------------------------------------------
CREATE Procedure  [dbo].[Fill_PartyBalances]          
@fromparty varchar(10),                      
@toparty varchar(10),                       
@opendate varchar(11),                      
@fromdt varchar(11),                      
@todate varchar(11),             
@IntRateCr money,          
@IntRateDr money          
          
                      
as                      
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                 
                
declare                       
@balcur as cursor,                      
@baldate as datetime,                      
@enddateNew as datetime,                      
@enddate as datetime,   
@enddateN as datetime,   
@Newdate as Varchar(11)            
                     
Declare @CltcodeTmp as Varchar(11),            
    @VAmtTmp as money,            
    @VAmtTmp1 as money,            
    @intSrno Int,             
    @CltcodeTmp1 as varchar(11),            
    @IntrestCursorTmp as Cursor            
            
set nocount on                      
            
            
Delete TBL_REPORT_INTEREST_MARGIN Where BalanceDate between @fromdt  and @todate  + ' 23:59:59'           
  and CltCode Between @fromparty and @toparty          
Truncate Table  TBl_RptDate           
            
select @baldate = @fromdt --+ ' 23:59'                      
select @enddate = @todate --+ ' 23:59:59'                      
select @enddateN = @todate + ' 23:59:59'                      
select @enddateNew = dateadd(day,1,@baldate)                       
                      
insert into TBL_REPORT_INTEREST_MARGIN            
Select  CltCode,BalanceDate,sum(VAmt) VAmt, 0,0,SUM(MAMT) MAMT, 0, 0,@IntRateDr,@IntRateDr          
      From             
   (            
                      
    Select l.cltcode, left(convert(Varchar,VDT,109),11) BalanceDate ,sum( case when upper(drcr) = 'D' then vamt else -vamt end) Vamt, 0 MAMT              
    from ledger l, acmast a where vdt >= @fromDt and vdt <= @enddateN            
    and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty and vtyp in ('2','3')              
    AND NOT ( VTYP = '8' AND L.BOOKTYPE = '02' )                       
    group by l.cltcode, left(convert(Varchar,VDT,109),11)                  
            
    union all                
            
    select l.cltcode,left(convert(Varchar,EDT,109),11) BalanceDate,sum( case when upper(drcr) = 'D' then vamt else -vamt end) VAmt , 0 MAMT              
    from ledger l, acmast a where edt >= @fromDt and edt <= @enddateN                 
    and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty and vtyp not in ('2','3','18')                
    AND NOT ( VTYP = '8' AND L.BOOKTYPE = '02' )                       
    group by l.cltcode , left(convert(Varchar,EDT,109),11)             
            
    union all                  
            
    select l.cltcode,@fromdt BalanceDate,sum( case when upper(drcr) = 'D' then vamt else -vamt end) VAmt , 0 MAMT             
    from ledger l, acmast a where vdt >= @opendate and vdt < @fromDt            
    and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty and vtyp in ('2','3')             
    AND NOT ( VTYP = '8' AND L.BOOKTYPE = '02' )                 
    group by l.cltcode             
            
            
    union all                  
            
    select l.cltcode,@fromdt BalanceDate,sum( case when upper(drcr) = 'D' then vamt else -vamt end) VAmt, 0 MAMT              
    from ledger l, acmast a where edt >= @opendate and edt < @fromDt            
    and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty and vtyp not in ('2','3','18')              
    AND NOT ( VTYP = '8' AND L.BOOKTYPE = '02' )                 
    group by l.cltcode             
            
            
    union all              
            
    select l.cltcode,@fromdt BalanceDate,sum( case when upper(drcr) = 'D' then vamt else -vamt end) VAmt  , 0 MAMT                       
    from ledger l, acmast a where Edt >= @opendate and Edt <= @fromDt            
    and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty and vtyp = '18'            
    AND NOT ( VTYP = '8' AND L.BOOKTYPE = '02' )                 
    group by l.cltcode             
        
union all              
            
    select l.cltcode,@fromdt BalanceDate,sum( case when upper(drcr) = 'C' then vamt else -vamt end) VAmt , 0 MAMT                         
    from ledger l, acmast a where Edt >= @opendate and vdt < @opendate        
    and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty         
 /*BELOW MENTIONED CONDITION ADDED LATER*/      
 AND VTYP NOT IN (2, 3)      
 /*-------------------------------------*/      
    AND NOT ( VTYP = '8' AND L.BOOKTYPE = '02' )                 
    group by l.cltcode  

/* MARGIN LEDGER LOGIC INCLUDED */
  UNION ALL            
    
  SELECT L.PARTY_CODE CLTCODE,           
  (CASE WHEN CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,VDT,109),11)) <  CONVERT(DATETIME,@FROMDT) THEN @FROMDT ELSE LEFT(CONVERT(VARCHAR,VDT,109),11) END) BALANCEDATE ,              
  0 VAMT, SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) MAMT              
  FROM MARGINLEDGER L, ACMAST A WHERE VDT >= @fromDt AND VDT <= @enddateN              
  AND L.PARTY_CODE = A.CLTCODE AND A.ACCAT = 4 AND A.CLTCODE >= @FROMPARTY AND A.CLTCODE <= @TOPARTY              
  GROUP BY L.PARTY_CODE, (CASE WHEN CONVERT(DATETIME,LEFT(CONVERT(VARCHAR,VDT,109),11)) <  CONVERT(DATETIME,@FROMDT) THEN @FROMDT ELSE LEFT(CONVERT(VARCHAR,VDT,109),11) END)            
/* MARGIN LEDGER LOGIC INCLUDED */
            
   ) Ldgr            
   group by cltcode,  BalanceDate            
            
while @baldate <= @enddate            
 begin            
   Insert Into TBl_RptDate values (@baldate,@@spid)            
    select @baldate = dateadd(day,1,@baldate)                       
 end            
            
Insert into TBL_REPORT_INTEREST_MARGIN            
 Select          
-- CltCode, Rpt_Date + ' 00:00', 0, 0, 0,@IntRateCr, @IntRateDr          
   CLTCODE, RPT_DATE + ' 00:00', 0, 0, 0,0, 0, 0, @INTRATECR, @INTRATEDR
 From           
  AcMast A, TBl_RptDate            
 Where          
   A.AcCat = 4 And ProgId = @@spid             
  And CltCode Not In (            
      Select           
       CltCode           
      From           
       TBL_REPORT_INTEREST_MARGIN T            
      Where           
       T.CltCode = A.CltCode            
       And CltCode Between @FromParty And @toParty            
       And BalanceDate between @fromdt  and @todate            
       And Left(Convert(VarChar,BalanceDate,109),11) = Left(Convert(VarChar,Rpt_Date,109),11) )            
  And A.CltCode Between @FromParty And @toParty            
            
Set @CltcodeTmp1 =  ''            
Set @VAmtTmp1 = 0            
            
 Update           
  TBL_REPORT_INTEREST_MARGIN           
 Set           
  Balance = IsNull(T.Bal,0)           
 From             
  (Select           
   t.CltCode,           
   Bal=IsNull(Sum(t.Vamt),0),           
   T1.BalanceDate          
   From           
   TBL_REPORT_INTEREST_MARGIN t,           
   TBL_REPORT_INTEREST_MARGIN t1            
  Where           
   T.BalanceDate <= t1.BalanceDate            
   and t.cltcode = t1.cltcode           
   And t.CltCode Between @FromParty And @toParty            
   And T.BalanceDate between @fromdt  and @todate            
  Group By           
   t.cltCode,          
   T1.BalanceDate ) T            
 Where           
 TBL_REPORT_INTEREST_MARGIN.CltCode = T.Cltcode            
 and TBL_REPORT_INTEREST_MARGIN.BalanceDate = T.BalanceDate            
 And T.CltCode Between @FromParty And @toParty            
 And T.BalanceDate between @fromdt  and @todate            
            
          
              
              
Update             
 TBL_REPORT_INTEREST_MARGIN          
Set            
 Interest = Round((Balance * @IntRateDr / 100)/ 365,2)          
where          
 Balance > 0            
 And CltCode Between @FromParty And @toParty            
 And BalanceDate between @fromdt  and @todate            
          
          
Update             
 TBL_REPORT_INTEREST_MARGIN          
Set            
 Interest = Round((Balance * @IntRateCr / 100)/ 365,2)          
where          
 Balance < 0            
 And CltCode Between @FromParty And @toParty            
 And BalanceDate between @fromdt  and @todate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.filldata
-- --------------------------------------------------
CREATE proc filldata 
as
declare @@sql varchar(200)
set @@sql = 'select * from abc '
exec (@@sql)
set @@sql = 'select * from ledger'
exec (@@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FINDTBMISMATCH
-- --------------------------------------------------
CREATE PROCEDURE FINDTBMISMATCH
	@FDATE VARCHAR(11) = '',
	@TDATE VARCHAR(11) = ''
AS
SET NOCOUNT ON
DECLARE
	@@DIFF AS MONEY,
	@@COUNTER AS INT

IF @FDATE = ''
	BEGIN
		SELECT @FDATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE CURYEAR = 1
	END
IF @TDATE = ''
	BEGIN
		SELECT @TDATE = CONVERT(VARCHAR(11), LDTCUR, 109) + ' 23:59' FROM PARAMETER WHERE CURYEAR = 1
	END

CREATE TABLE #LEDGERMISMATCH
	(
		PARTICULARS VARCHAR(30),
		DIFF MONEY,
		REMARK VARCHAR(100)
	)

INSERT INTO #LEDGERMISMATCH
SELECT 
	PARTICULARS = 'LEDGER TOTALS', 
	DIFF = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
	REMARK = ''
FROM
	LEDGER
WHERE 
	VDT BETWEEN @FDATE AND @TDATE

SELECT 
	@@DIFF = DIFF
FROM
	#LEDGERMISMATCH

IF @@DIFF <> 0
	BEGIN
		SELECT 
			PARTICULARS,
			DIFF,
			REMARK = CASE WHEN DIFF > 0 THEN 'DEBIT SIDE HEAVY' ELSE 'CREDIT SIDE HEAVY' END
		FROM
			#LEDGERMISMATCH
		CREATE TABLE #MISSVNO
			(
				VNO VARCHAR(12),
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2)
			)
		INSERT INTO #MISSVNO
		SELECT 
			VNO, 
			VTYP, 
			BOOKTYPE
		FROM
			LEDGER
		WHERE 
			VDT BETWEEN @FDATE AND @TDATE
		GROUP BY
			VNO, 
			VTYP, 
			BOOKTYPE
		HAVING
			SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) <> 0
		SELECT 
			@@COUNTER = COUNT(1) 
		FROM 
			#MISSVNO
		IF @@COUNTER > 0
			BEGIN
				SELECT 
					PARTICULARES = 'VOUCHERS WITH DEBIT AND CREDIT MISMATCHES'
				UNION ALL
				SELECT 
					PARTICULARS = VNO + ', ' + CONVERT(VARCHAR, VTYP) + ', ' + BOOKTYPE 
				FROM 
					#MISSVNO
			END
	END

	CREATE TABLE #MISSCLTS
		(
			CLTCODE VARCHAR(10)
		)
	INSERT INTO #MISSCLTS
	SELECT 
		CLTCODE
	FROM
		LEDGER L
	WHERE
		NOT EXISTS
		(
			SELECT 
				CLTCODE
			FROM 
				ACMAST A
			WHERE
				L.CLTCODE = A.CLTCODE
		)
		AND L.VDT BETWEEN @FDATE AND @TDATE
	SELECT 
		@@COUNTER = COUNT(1) 
	FROM
		#MISSCLTS
	IF @@COUNTER > 0
		BEGIN
			SELECT 
				PARTICULARS = 'FOLLOWING CLIENTS DO NOT EXIST IN ACMAST BUT IN LEDGER'
			UNION ALL
			SELECT 
				PARTICULARS = CLTCODE
			FROM 
				#MISSCLTS
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Formula_client_master_DATA
-- --------------------------------------------------

--EXEC Formula_client_master_DATA

CREATE PROCEDURE [dbo].[Formula_client_master_DATA]

as
begin
CREATE TABLE #CL_LIST    
(    
 PARTY_CODE VARCHAR(10),    
 PARTY_NAME VARCHAR(100),    
 CLIENT_PAN VARCHAR(50),
 CL_TYPE VARCHAR(10),
 PARENT_CODE VARCHAR(10)   
)    
     

INSERT INTO #CL_LIST    
SELECT CL_CODE, LONG_NAME, PAN_GIR_NO, CL_TYPE, PARENTCODE = CASE WHEN 0 = 1 THEN PARENTCODE ELSE CL_CODE END
FROM MSAJAG.dbo.VW_CLIENT_DETAILS_DATA   
WHERE CL_CODE BETWEEN '0000' AND 'zzzz'    

 
/* QUERY TO UPDATE THE PARENT DETAILS FOR THE DETAILS */
--IF @@PARENT_FLAG = 1
BEGIN
	UPDATE C SET C.PARTY_NAME =C1.PARTY_NAME, C.CLIENT_PAN = C1.CLIENT_PAN
	FROM #CL_LIST C, (SELECT * FROM #CL_LIST WHERE PARTY_CODE = PARENT_CODE) C1
	WHERE C.PARTY_CODE = C1.PARENT_CODE
END
 
DELETE FROM FORMULA_CLIENT_MASTER WHERE SESSION_ID = '8888888888'
 
INSERT INTO FORMULA_CLIENT_MASTER 
SELECT PARTY_CODE, PARTY_NAME, 'PARTY', '', '8888888888', GETDATE() FROM #CL_LIST 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fun
-- --------------------------------------------------

CREATE PROC Fun @fun VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @fun + '%' and xtype='FN' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FUNDS_FLOW
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[FUNDS_FLOW]     
 @FROMDATE VARCHAR(11),              
 @TODATE VARCHAR(11),        
 @BRANCHCODE VARCHAR(10)              
AS              
              
DECLARE @@STARTDATE VARCHAR(11)              
              
SELECT @@STARTDATE = SDTCUR FROM PARAMETER WHERE @FROMDATE BETWEEN SDTCUR AND LDTCUR              
              
SET TRANSACTION ISOLATION LEVEL READ COMMITTED                
SELECT BRANCH_CD = RTRIM(BRANCH_CD), VDT, NARRATION, AMOUNT = SUM(AMOUNT), SORTBY  FROM              
(              
 SELECT                           
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103), NARRATION = 'NSE OPENING BALANCE', SORTBY = 1,                       
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                            
 FROM LEDGER L JOIN                            
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  MSAJAG.DBO.CLIENT2 C2 JOIN MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                            
 WHERE                           
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                            
  AND L.EDT < CONVERT(DATETIME, @FROMDATE,109)                      
  AND L.VAMT <> 0                          
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'        
  AND X.BRANCH_CD LIKE @BRANCHCODE        
 GROUP BY                          
  X.BRANCH_CD      
             
UNION ALL              
          
 SELECT                           
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103),NARRATION = 'NSE OPENING BALANCE', SORTBY = 1,                  
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END),0)                            
 FROM LEDGER L JOIN                            
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  MSAJAG.DBO.CLIENT2 C2 JOIN MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                            
 WHERE                           
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                            
  AND L.VDT < CONVERT(DATETIME, @@STARTDATE,109)                            
  AND L.VAMT <> 0                          
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'           
  AND X.BRANCH_CD LIKE @BRANCHCODE                       
 GROUP BY                          
  X.BRANCH_CD     
                 
UNION ALL             
                       
 SELECT                           
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), EDT, 103),NARRATION = 'NSE ' + L.NARRATION, SORTBY = 2,                       
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                            
 FROM LEDGER L JOIN                            
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  MSAJAG.DBO.CLIENT2 C2 JOIN MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                            
 WHERE                           
  L.VTYP <> 18           
  AND L.EDT >= CONVERT(DATETIME, @FROMDATE,109)                            
  AND L.EDT <= CONVERT(DATETIME, @TODATE + ' 23:59',109)                            
  AND L.VAMT <> 0                          
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'          
  AND X.BRANCH_CD LIKE @BRANCHCODE                   
 GROUP BY            
  X.BRANCH_CD, L.NARRATION, CONVERT(VARCHAR(11), EDT, 103)       
          
UNION ALL              
          
 SELECT                           
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103),NARRATION = 'BSE OPENING BALANCE', SORTBY = 3,                        
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                            
 FROM ACCOUNTBSE.DBO.LEDGER L JOIN                            
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  BSEDB.DBO.CLIENT2 C2 JOIN BSEDB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                            
 WHERE                    
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                    
  AND L.EDT < CONVERT(DATETIME, @FROMDATE,109)                      
  AND L.VAMT <> 0                          
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'           
  AND X.BRANCH_CD LIKE @BRANCHCODE                       
 GROUP BY                          
  X.BRANCH_CD       
          
UNION ALL              
          
 SELECT                           
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103),NARRATION = 'BSE OPENING BALANCE', SORTBY = 3 ,                   
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END),0)                            
 FROM ACCOUNTBSE.DBO.LEDGER L JOIN                            
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  BSEDB.DBO.CLIENT2 C2 JOIN BSEDB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                            
 WHERE                           
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                            
  AND L.VDT < CONVERT(DATETIME, @@STARTDATE,109)                            
  AND L.VAMT <> 0                          
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'          
  AND X.BRANCH_CD LIKE @BRANCHCODE                        
 GROUP BY                          
  X.BRANCH_CD , L.EDT            
                 
UNION ALL           
                         
 SELECT                           
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), EDT, 103),NARRATION = 'BSE ' + L.NARRATION, SORTBY = 4,                       
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                            
 FROM ACCOUNTBSE.DBO.LEDGER L JOIN                            
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  BSEDB.DBO.CLIENT2 C2 JOIN BSEDB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                            
 WHERE                           
  L.VTYP <> 18           
  AND L.EDT >= CONVERT(DATETIME, @FROMDATE,109)                            
  AND L.EDT <= CONVERT(DATETIME, @TODATE + ' 23:59',109)                            
  AND L.VAMT <> 0                          
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'                   
  AND X.BRANCH_CD LIKE @BRANCHCODE          
 GROUP BY            
  X.BRANCH_CD, L.NARRATION, CONVERT(VARCHAR(11), EDT, 103)       
             
) A              
GROUP BY              
 RTRIM(BRANCH_CD), NARRATION, SORTBY, VDT              
ORDER BY               
 BRANCH_CD,CONVERT(DATETIME, VDT, 103) , SORTBY, NARRATION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FUNDS_FLOW_NEW
-- --------------------------------------------------
CREATE PROCEDURE FUNDS_FLOW_NEW       
 @FROMDATE VARCHAR(11),                
 @TODATE VARCHAR(11),          
 @BRANCHCODE VARCHAR(10)                
AS                
                
DECLARE @@STARTDATE VARCHAR(11)                
                
SELECT @@STARTDATE = SDTCUR FROM PARAMETER WHERE @FROMDATE BETWEEN SDTCUR AND LDTCUR                
                
SET TRANSACTION ISOLATION LEVEL READ COMMITTED                  
SELECT BRANCH_CD = RTRIM(BRANCH_CD), VDT, NARRATION, AMOUNT = SUM(AMOUNT), SORTBY  FROM                
(                
 SELECT                             
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103), NARRATION = 'NSE OPENING BALANCE', SORTBY = 1,                         
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                              
 FROM LEDGER L JOIN                              
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  MSAJAG.DBO.CLIENT2 C2 JOIN MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                              
 WHERE                             
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                              
  AND L.EDT < CONVERT(DATETIME, @FROMDATE,109)                        
  AND L.VAMT <> 0                            
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'          
  AND X.BRANCH_CD LIKE @BRANCHCODE          
 GROUP BY                            
  X.BRANCH_CD        
               
UNION ALL                
            
 SELECT                             
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103),NARRATION = 'NSE OPENING BALANCE', SORTBY = 1,                    
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END),0)                              
 FROM LEDGER L JOIN                              
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  MSAJAG.DBO.CLIENT2 C2 JOIN MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                              
 WHERE                             
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                              
  AND L.VDT < CONVERT(DATETIME, @@STARTDATE,109)                              
  AND L.VAMT <> 0                            
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'             
  AND X.BRANCH_CD LIKE @BRANCHCODE                         
 GROUP BY                            
  X.BRANCH_CD       
                   
UNION ALL               
                         
 SELECT                             
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), EDT, 103),NARRATION = 'NSE ' + L.NARRATION, SORTBY = 2,                         
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                              
 FROM LEDGER L JOIN                              
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  MSAJAG.DBO.CLIENT2 C2 JOIN MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                              
 WHERE                             
  L.VTYP <> 18             
  AND L.EDT >= CONVERT(DATETIME, @FROMDATE,109)                              
  AND L.EDT <= CONVERT(DATETIME, @TODATE + ' 23:59',109)                              
  AND L.VAMT <> 0                            
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'            
  AND X.BRANCH_CD LIKE @BRANCHCODE                     
 GROUP BY              
  X.BRANCH_CD, L.NARRATION, CONVERT(VARCHAR(11), EDT, 103)         
            
UNION ALL                
            
 SELECT                             
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103),NARRATION = 'BSE OPENING BALANCE', SORTBY = 3,                          
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                              
 FROM ACCOUNTBSE.DBO.LEDGER L JOIN                              
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  BSEDB.DBO.CLIENT2 C2 JOIN BSEDB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                              
 WHERE                      
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                      
  AND L.EDT < CONVERT(DATETIME, @FROMDATE,109)                        
  AND L.VAMT <> 0                            
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'             
  AND X.BRANCH_CD LIKE @BRANCHCODE                         
 GROUP BY                            
  X.BRANCH_CD         
            
UNION ALL                
            
 SELECT                             
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE), 103),NARRATION = 'BSE OPENING BALANCE', SORTBY = 3 ,                     
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END),0)                              
 FROM ACCOUNTBSE.DBO.LEDGER L JOIN                              
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  BSEDB.DBO.CLIENT2 C2 JOIN BSEDB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                              
 WHERE                             
  L.EDT >= CONVERT(DATETIME, @@STARTDATE,109)                              
  AND L.VDT < CONVERT(DATETIME, @@STARTDATE,109)                              
  AND L.VAMT <> 0                            
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'            
  AND X.BRANCH_CD LIKE @BRANCHCODE                          
 GROUP BY                            
  X.BRANCH_CD , L.EDT              
                   
UNION ALL             
                           
 SELECT                             
  X.BRANCH_CD, VDT = CONVERT(VARCHAR(11), EDT, 103),NARRATION = 'BSE ' + L.NARRATION, SORTBY = 4,                         
  AMOUNT = ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN -L.VAMT ELSE L.VAMT END),0)                              
 FROM ACCOUNTBSE.DBO.LEDGER L JOIN                              
  (SELECT C2.PARTY_CODE, C1.BRANCH_CD, C1.CL_CODE FROM  BSEDB.DBO.CLIENT2 C2 JOIN BSEDB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE ) ) X  ON (L.CLTCODE = X.PARTY_CODE)                              
 WHERE                             
  L.VTYP <> 18             
  AND L.EDT >= CONVERT(DATETIME, @FROMDATE,109)                              
  AND L.EDT <= CONVERT(DATETIME, @TODATE + ' 23:59',109)                              
  AND L.VAMT <> 0                            
  AND L.NARRATION NOT LIKE 'FUNDS TRANSFER%'                     
  AND X.BRANCH_CD LIKE @BRANCHCODE            
 GROUP BY              
  X.BRANCH_CD, L.NARRATION, CONVERT(VARCHAR(11), EDT, 103)         
               
) A                
GROUP BY                
 RTRIM(BRANCH_CD), NARRATION, SORTBY, VDT                
ORDER BY                 
 BRANCH_CD,CONVERT(DATETIME, VDT, 103) , SORTBY, NARRATION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Generate_Vno
-- --------------------------------------------------
CREATE PROC Generate_Vno

	@vdt      varchar(11),  /* dd/mm/yyyy */                
	@vtyp     smallint,                
	@booktype varchar(2),                
	@sdtcur   varchar(11),                
	@ldtcur   varchar(11),      
	@acc_serevr1 varchar(15),
	@acc_db1 varchar(15),
	@exchange1 varchar(10),
	@acc_serevr2 varchar(15),
	@acc_db2 varchar(15),
	@exchange2 varchar(10),
	@acc_serevr3 varchar(15),
	@acc_db3 varchar(15),
	@exchange3 varchar(10),
	@noofrecords int = 1      

as

declare
@@sql varchar(1000)

create table #vno_table 
(
	NSEVNO VARCHAR(12),
	BSEVNO VARCHAR(12),
	FOVNO VARCHAR(12)
)

insert into #vno_table values('', '', '')


create table #vno
(
	vno varchar(12)
)



	set @@sql = "insert into #vno exec " + @acc_serevr1 + "." + @acc_db1 + ".dbo.Acc_GenVno_New '" + @vdt + "'," + convert(varchar,@vtyp) + ",'" + @booktype + "','" + @sdtcur + "','" + @ldtcur + "'"
	print @@sql
	exec (@@sql)

	if @exchange1 = "NSE" 
	BEGIN
		update #vno_table set NSEVNO = vno from #vno
	END	
	Else if @exchange1 = "BSE" 
	BEGIN
		update #vno_table set BSEVNO = vno from #vno
	END	
	Else If @exchange1 = "FO" 
	BEGIN
		update #vno_table set FOVNO = vno from #vno
	END	

	truncate table #vno

	set @@sql = "insert into #vno exec " + @acc_serevr2 + "." + @acc_db2 + ".dbo.Acc_GenVno_New '" + @vdt + "'," + convert(varchar,@vtyp) + ",'" + @booktype + "','" + @sdtcur + "','" + @ldtcur + "'"
	print @@sql
	exec (@@sql)

	if @exchange2 = "NSE" 
	BEGIN
		update #vno_table set NSEVNO = vno from #vno
	END	
	Else if @exchange2 = "BSE" 
	BEGIN
		update #vno_table set BSEVNO = vno from #vno
	END	
	Else If @exchange2 = "FO" 
	BEGIN
		update #vno_table set FOVNO = vno from #vno
	END	

	truncate table #vno

	set @@sql = "insert into #vno exec " + @acc_serevr3 + "." + @acc_db3 + ".dbo.Acc_GenVno_New '" + @vdt + "'," + convert(varchar,@vtyp) + ",'" + @booktype + "','" + @sdtcur + "','" + @ldtcur + "'"
	print @@sql
	exec (@@sql)

	if @exchange3 = "NSE" 
	BEGIN
		update #vno_table set NSEVNO = vno from #vno
	END	
	Else if @exchange3 = "BSE" 
	BEGIN
		update #vno_table set BSEVNO = vno from #vno
	END	
	Else If @exchange3 = "FO" 
	BEGIN
		update #vno_table set FOVNO = vno from #vno
	END	


	select * from #vno_table

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_currentopentry
-- --------------------------------------------------
Create Proc get_currentopentry 
(@Sdtcur Datetime) AS

Select SdtCur = Left(Convert(Varchar, SdtCur, 109), 11) from parameter
where @Sdtcur between sdtcur and ldtcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_FT_GL_DETAILS
-- --------------------------------------------------
        
CREATE PROCEDURE [dbo].[GET_FT_GL_DETAILS]        
 @EXCH VARCHAR(10),        
 @FROM_DATE VARCHAR(11),        
 @TO_DATE VARCHAR(11),
 @CTRLCODE_FROM VARCHAR(10) = '00',
 @CTRLCODE_TO VARCHAR(10) = '99'
AS        
        
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
 IF LEN(@FROM_DATE) = 10        
 BEGIN        
  SELECT @FROM_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROM_DATE, 103), 109)        
  SELECT @TO_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TO_DATE, 103), 109)        
 END        
        
 CREATE TABLE #FT_GL_DETAILS        
 (        
  JV_CODE VARCHAR(10)        
  --JV_NAME VARCHAR(100) 
 )
        
 INSERT INTO #FT_GL_DETAILS        
 SELECT         
  JV_CODE         
  --JV_NAME         
 FROM         
  FT_GL         
 WHERE         
  EXCH_FR = @EXCH
  AND JV_CODE BETWEEN @CTRLCODE_FROM AND @CTRLCODE_TO
         
 UNION       
         
 SELECT         
  JV_CODE         
  --JV_NAME         
 FROM         
  FT_GL         
 WHERE         
  EXCH_TO = @EXCH
  AND JV_CODE BETWEEN @CTRLCODE_FROM AND @CTRLCODE_TO       
        
-- SELECT * FROM #FT_GL_DETAILS      
        
 SELECT         
  CTRL_CODE = JV_CODE,         
  --CTRL_NAME = JV_NAME,        
  EXCHANGE = @EXCH,        
  AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)        
 FROM        
  LEDGER L WITH (NOLOCK),         
  #FT_GL_DETAILS F        
 WHERE         
  CLTCODE = JV_CODE        
  AND VDT BETWEEN @FROM_DATE AND @TO_DATE        
  AND VTYP = 88        
 GROUP BY        
  JV_CODE        
  --JV_NAME        
 ORDER BY        
  1        
        
           
 DROP TABLE #FT_GL_DETAILS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     

 --(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 --AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE 
 --(VDT >= @START_DATE OR 
 EDT >= @START_DATE
 --)      
 AND VDT <= @EFFDATE + ' 23:59')    L,/*     
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO, */
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR--, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_BKUP_06FEB21
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_BKUP_06FEB21]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L/*  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO*/,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR--, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_BKUP_21JAN2021
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_BKUP_21JAN2021]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT
-- --------------------------------------------------


--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''    
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'    


create PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT]      
 @EFFDATE VARCHAR(11), 
  @CLTCODE VARCHAR(12),
 @SESSIONID VARCHAR(500),    
 @PROCESS_CODE VARCHAR(10),    
 @REPORT_FORMULA VARCHAR(MAX),  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(50),
 @TABLE_NAME VARCHAR(20) = '' 
AS      
    
DECLARE      
 @START_DATE VARCHAR(11)      
      
IF LEN(@EFFDATE) = 10      
BEGIN      
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)      
END      
      
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)      
FROM PARAMETER      
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR      
    
    
--CREATE TABLE #REPORT_DATA    
--(    
-- CLTCODE VARCHAR(10),    
-- PARTY_NAME VARCHAR(100),       
-- ENTITY_LEVEL VARCHAR(20),    
-- ENTITY_CODE VARCHAR(25),      
-- VDTBAL MONEY,      
-- EDTBAL MONEY,      
-- FDT_RECEIPT MONEY,      
-- FDT_PAYMENTS MONEY,  
-- MARGIN_BAL MONEY    
--)    
    
DECLARE    
 @@SQL VARCHAR(MAX)    
    
SELECT       
 CLTCODE = L.CLTCODE,    
 VDTBAL = SUM(CASE WHEN VDT >= @START_DATE THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),      
 EDTBAL = SUM(CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END       
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN (CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),      
 FDT_RECEIPT = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN (VAMT) ELSE 0 END) ,      
 FDT_PAYMENTS = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN (VAMT) ELSE 0 END ) INTO #LEDGER
FROM       
 --(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 --AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 (SELECT  CLTCODE,VDT,VTYP,EDT,DRCR,VAMT  FROM LEDGER (NOLOCK) WHERE 
 --(VDT >= @START_DATE OR 
 CLTCODE =@CLTCODE AND
 EDT >= @START_DATE
  AND CDT <= DATEADD(MI, -15, GETDATE())
 --)      
 AND VDT <= @EFFDATE + ' 23:59' --AND CDT <= DATEADD(MI, -15, GETDATE())
 )    L 
 GROUP BY CLTCODE /*    
 LEFT OUTER JOIN (SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1  
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,  */
 
 
 
 --INSERT INTO #REPORT_DATA      
SELECT       
 L.CLTCODE,    
 PARTY_NAME,       
 ENTITY_LEVEL,    
 ENTITY_CODE,      
 VDTBAL = SUM(VDTBAL),      
 EDTBAL = SUM(EDTBAL),      
 FDT_RECEIPT = SUM(FDT_RECEIPT),      
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),  
 MARGIN_BAL = 0  INTO #REPORT_DATA      
FROM      
 #LEDGER L (Nolock)  ,
 FORMULA_CLIENT_MASTER A    (Nolock)  
WHERE      
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID    
 GROUP BY       
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE --, L1.RELDT      
      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0 
/*
UPDATE R SET R.FDT_RECEIPT = A.FDT_RECEIPT, R.FDT_PAYMENTS = A.FDT_PAYMENTS
FROM #REPORT_DATA R, (SELECT CLTCODE, FDT_RECEIPT = SUM(CASE WHEN L1.VTYP = 2 THEN VAMT ELSE 0 END),
FDT_PAYMENTS = SUM(CASE WHEN L1.VTYP = 3 THEN VAMT ELSE 0 END) FROM
(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE VDT <= @EFFDATE + ' 23:59')    L,    
(SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '') and CLEAR_MODE <> 'C') L1  
 WHERE L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO
AND L1.VTYP IN(2, 3)  
GROUP BY CLTCODE ) A
WHERE R.CLTCODE = A.CLTCODE
 */ 
/*  
UPDATE RD SET MARGIN_BAL = ML.AMOUNT  
FROM #REPORT_DATA RD, (  
 SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)  
 FROM MARGINLEDGER ML  
 WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'  
 GROUP BY PARTY_CODE  
)ML  
WHERE RD.CLTCODE = PARTY_CODE  
*/  
--IF @TABLE_NAME <> ''
--BEGIN
--	SET @@SQL = " TRUNCATE TABLE " + @TABLE_NAME  
--	EXEC (@@SQL)
--END

--IF @TABLE_NAME <> ''
--   SET @@SQL = " INSERT INTO " + @TABLE_NAME + " SELECT "    
--ELSE
SET @@SQL = " SELECT "   
 
SET @@SQL = @@SQL + " CLTCODE, "    
SET @@SQL = @@SQL + " PARTY_NAME, "    
SET @@SQL = @@SQL + " ENTITY_LEVEL,"    
SET @@SQL = @@SQL + " ENTITY_CODE, "    
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "    
SET @@SQL = @@SQL + " FROM "    
SET @@SQL = @@SQL + " #REPORT_DATA"    

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_SUBBROKERS
-- --------------------------------------------------

CREATE PROC GET_SUBBROKERS
AS
DECLARE 
	@@SQL AS VARCHAR(2000),
	@@NSE AS INT,
	@@BSE AS INT,
	@@NSEFO AS INT,
	@@MCX AS INT,
	@@NCDX AS INT

SET NOCOUNT ON

SELECT @@NSE = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'MSAJAG'
SELECT @@BSE = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'BSEDB'
SELECT @@NSEFO = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'NSEFO'
SELECT @@MCX = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'MCDX'
SELECT @@NCDX = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'NCDX'

SELECT @@SQL = " "

IF @@NSE > 0
	BEGIN
		SELECT @@SQL = @@SQL + "SELECT SUB_BROKER, SBNAME = NAME FROM MSAJAG.DBO.SUBBROKERS UNION "
	END
IF @@BSE > 0
	BEGIN
		SELECT @@SQL = @@SQL + "SELECT SUB_BROKER, SBNAME = NAME FROM BSEDB.DBO.SUBBROKERS UNION "
	END
IF @@NSEFO > 0
	BEGIN
		SELECT @@SQL = @@SQL + "SELECT SUB_BROKER, SBNAME = NAME FROM NSEFO.DBO.SUBBROKERS UNION "
	END
IF @@MCX > 0
	BEGIN
		SELECT @@SQL = @@SQL + "SELECT SUB_BROKER, SBNAME = NAME FROM MCDX.DBO.SUBBROKERS UNION "
	END
IF @@NCDX > 0
	BEGIN
		SELECT @@SQL = @@SQL + "SELECT SUB_BROKER, SBNAME = NAME FROM NCDX.DBO.SUBBROKERS"
	END

SELECT @@SQL = RTRIM(LTRIM(@@SQL))
IF RIGHT(@@SQL, 5) = 'UNION'
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 5)
	END

SELECT @@SQL = "SELECT SUB_BROKER, SBNAME FROM (" + @@SQL + ") A ORDER BY SUB_BROKER, SBNAME"

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_TB_DATA
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[GET_TB_DATA]
	@FROM_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@DATE_TYPE VARCHAR(3),
	@REPORT_TYPE VARCHAR(10),
	@WITH_OPEN BIT
AS

DECLARE
	@OPEN_DATE VARCHAR(11)
	
SELECT @OPEN_DATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @TO_DATE BETWEEN SDTCUR AND LDTCUR

DECLARE
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10)

SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER

CREATE TABLE #CL_LIST
(
	CL_CODE VARCHAR(10),
	PARENT_CODE VARCHAR(10),
	PARENT_NAME VARCHAR(100)
)

INSERT INTO #CL_LIST
SELECT CL_CODE, PARENTCODE, LONG_NAME
FROM MSAJAG..CLIENT_DETAILS where cl_code not like '05%' and PAN_GIR_NO not LIKE '%[^0-9A-Za-z]%' OR LEN(PAN_GIR_NO) <> '10'


UPDATE C SET C.PARENT_NAME = CL.LONG_NAME
FROM #CL_LIST C, MSAJAG..CLIENT_DETAILS CL
WHERE CL.CL_CODE = PARENT_CODE

CREATE TABLE #LED_BALANCE
(
	CLTCODE VARCHAR(10),
	ACNAME VARCHAR(100),
	OPEN_BAL MONEY,
	PERIOD_CR MONEY,
	PERIOD_DR MONEY,
	CL_BAL MONEY,
	ACCAT INT
)

IF @DATE_TYPE = 'VDT'
BEGIN
	INSERT INTO #LED_BALANCE
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN (VDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18) THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT = 4
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND VDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY PARENT_CODE, PARENT_NAME

	INSERT INTO #LED_BALANCE
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.ACNAME, OPEN_BAL = SUM(CASE WHEN (VDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18)  THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.CLTCODE
	AND VDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	AND ACCAT <> 4
	GROUP BY L.CLTCODE, A.Acname, ACCAT
END

IF @DATE_TYPE = 'EDT'
BEGIN
	INSERT INTO #LED_BALANCE
	SELECT CLTCODE, PARENT_NAME, OPEN_BAL = SUM(OPEN_BAL), PERIOD_CR = SUM(PERIOD_CR), PERIOD_DR = SUM(PERIOD_DR), CL_BAL = SUM(CL_BAL), ACCAT = 4 FROM
	(
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN (EDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18)  THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND EDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY PARENT_CODE, PARENT_NAME
	UNION ALL
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), 
	PERIOD_CR = 0,
	PERIOD_DR = 0,
	CL_BAL =  SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND EDT >= @OPEN_DATE AND VDT < @OPEN_DATE
	GROUP BY PARENT_CODE, PARENT_NAME
	) A
	GROUP BY CLTCODE, PARENT_NAME

	INSERT INTO #LED_BALANCE
	SELECT CLTCODE, PARENT_NAME, OPEN_BAL = SUM(OPEN_BAL), PERIOD_CR = SUM(PERIOD_CR), PERIOD_DR = SUM(PERIOD_DR), CL_BAL = SUM(CL_BAL), ACCAT FROM
	(
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.Acname, OPEN_BAL = SUM(CASE WHEN (EDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18) THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.Cltcode
	AND EDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	AND ACCAT <> 4
	GROUP BY L.CLTCODE, A.ACNAME, ACCAT
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.Acname, OPEN_BAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), 
	PERIOD_CR = 0,
	PERIOD_DR = 0,
	CL_BAL =  SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.Cltcode
	AND EDT >= @OPEN_DATE AND VDT < @OPEN_DATE
	AND ACCAT <> 4
	GROUP BY L.CLTCODE, A.ACNAME, ACCAT
	) A
	GROUP BY CLTCODE, PARENT_NAME, ACCAT
END

IF @WITH_OPEN = 0
BEGIN
	SELECT 
		--CLTCODE = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, 		
		CLTCODE = replace(CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END,' ',''), 
		ACNAME = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END, 
		CL_BAL = SUM(CL_BAL), EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT 
	FROM #LED_BALANCE 
		WHERE ACCAT = CASE WHEN @REPORT_TYPE = 'PARTY' THEN 4 ELSE ACCAT END 
	GROUP BY CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END
	HAVING SUM(CL_BAL) <> 0
END
ELSE
BEGIN
	SELECT 
		--CLTCODE = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END,
		CLTCODE = replace(CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END,' ',''),  
		ACNAME = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END, 
		OPEN_BAL = SUM(OPEN_BAL),
		PERIOD_CR = SUM(PERIOD_CR),
		PERIOD_DR = SUM(PERIOD_DR),
		CL_BAL = SUM(CL_BAL), EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT 
	FROM #LED_BALANCE 
		WHERE ACCAT = CASE WHEN @REPORT_TYPE = 'PARTY' THEN 4 ELSE ACCAT END 
	GROUP BY CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END
	HAVING (SUM(OPEN_BAL) <>  0 OR SUM(PERIOD_CR) <> 0 OR SUM(PERIOD_DR) <> 0 OR SUM(CL_BAL) <> 0)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_VOUCHER_APPR_EDIT_DATA
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GET_VOUCHER_APPR_EDIT_DATA]
	@VDATEFR VARCHAR(11),
	@VDATETO VARCHAR(11),
	@VTYPE VARCHAR(100),
	@USERCATEGORY VARCHAR(10),--@MKCKFLAG TINYINT,
	@EXCSEGMENT VARCHAR(40),
	@FVNO VARCHAR(12),
	@TVNO VARCHAR(12),
	@UA VARCHAR(2),
	@VAMT MONEY,
	@THIRDPARTY VARCHAR(10),
	@CLTCODE VARCHAR(10),
	@OPPCODE VARCHAR(10),
	@FILTERON VARCHAR(30),
	@ADDBY VARCHAR(30),
	@UNAME VARCHAR(30),
	@STATUSID VARCHAR(30),
	@STATUSNAME VARCHAR(30)
AS
/*
EXEC GET_VOUCHER_APPR_EDIT_DATA '02/10/2004', '21/11/2009', '', '388', 'NSE-CAPITAL', '0', '99999', 'UA', '', 'ALL', '', '', '', '', 'MEGHA', 'broker', 'broker'
GET_VOUCHER_APPR_EDIT_DATA @VDATEFR = '01/10/2007', @VDATETO = '31/03/2010', @VTYPE='', @UNAME='MEGHA', @STATUSID='BROKER', @STATUSNAME='BROKER',
	@USERCATEGORY = 388, @EXCSEGMENT = 'NSE-CAPITAL', @FVNO = '', @TVNO = '', @UA = 'UA', @VAMT = '', @THIRDPARTY = 'ALL', @CLTCODE = '', @OPPCODE = '',
	@FILTERON = '', @ADDBY = ''
-- SELECT * FROM OFFLINE_VOUCHER_SETTING
UPDATE OFFLINE_VOUCHER_SETTING SET OPFLAG = 15
UPDATE V2_OFFLINE_LEDGER_ENTRIES SET  VOUCHERTYPE = 2 WHERE FLDAUTO = 8 -- 2
UPDATE V2_OFFLINE_LEDGER_ENTRIES SET  approvalflag = 0 WHERE FLDAUTO = 8 
*/
BEGIN	
	SET NOCOUNT ON;

	DECLARE @EXCHANGE VARCHAR(20),
			@SEGMENT VARCHAR(20),
			@SHAREDB VARCHAR(20),
			@SQL VARCHAR(8000)

	SET @EXCHANGE = .DBO.PIECE(@EXCSEGMENT, '-', 1)
	SET @SEGMENT = .DBO.PIECE(@EXCSEGMENT, '-', 2)

	CREATE TABLE #VTYPES
	(VTYPE SMALLINT,
	MKCKFLAG TINYINT,
	END_DATE_ADD INT)

	IF @VDATEFR <> '' AND LEN(@VDATEFR) = 10 AND CHARINDEX('/', @VDATEFR) > 0
	BEGIN
		SET @VDATEFR = CONVERT(VARCHAR, CONVERT(DATETIME, @VDATEFR, 103), 109)
	END

	IF @VDATETO <> '' AND LEN(@VDATETO) = 10 AND CHARINDEX('/', @VDATETO) > 0
	BEGIN
		SET @VDATETO = CONVERT(VARCHAR, CONVERT(DATETIME, @VDATETO, 103), 109)
	END

	SELECT @SHAREDB = ACCOUNTDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT

	SET @SQL = "SELECT DISTINCT VTYPE , MKCKFLAG, END_DATE_ADD " +
				"FROM " + @SHAREDB + ".DBO.FN_USERRIGHTS('" + @VTYPE + "', '', '" + @EXCHANGE + "', '" + @SEGMENT + "', '" + @UNAME + "', '" + @USERCATEGORY + "')"
	
	INSERT INTO #VTYPES(VTYPE, MKCKFLAG, END_DATE_ADD)
	EXEC(@SQL)


DECLARE @VOUHCERSETTING INT,
		@LOOKUPARRAY VARCHAR(50),
		@LOOPID INT,
		@LOOPCOUNT INT,
		@BEFORE_EDIT INT,--BIT,
		@BEFORE_DELETE INT,--BIT,
		@AFTER_EDIT INT,--BIT,
		@AFTER_DELETE INT--BIT

SET @BEFORE_EDIT = 0
SET @BEFORE_DELETE = 0
SET @AFTER_EDIT = 0
SET @AFTER_DELETE = 0

SET @LOOKUPARRAY = '1,2,4,8'

SELECT @LOOPCOUNT = COUNT(1) FROM .DBO.SPLIT(@LookUpArray, ',')
SELECT @VOUHCERSETTING = OPFLAG FROM OFFLINE_VOUCHER_SETTING
SET @LOOPID = @LOOPCOUNT
print @VOUHCERSETTING
WHILE 1=1
	BEGIN
		IF @LOOPID < 0
			BEGIN
				BREAK
			END
		IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT
			BEGIN
				SET @AFTER_DELETE = 1
				SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))
			END
		ELSE IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT - 1
			BEGIN
				SET @AFTER_EDIT = 1
				SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))
			END
		ELSE IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT - 2
			BEGIN
				SET @BEFORE_DELETE = 1
				SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))
			END
		ELSE IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT - 3
			BEGIN
				SET @BEFORE_EDIT = 1
				SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))
			END		
		SET @LOOPID = @LOOPID - 1		
	END

--	SELECT @BEFORE_EDIT BE, @BEFORE_DELETE BD, @AFTER_EDIT AE, @AFTER_DELETE AD
--	SELECT * FROM #VTYPES
    SELECT FLDAUTO, A.EXCHANGE + '-' + A.SEGMENT AS EXCSEGMENT, A.VOUCHERNO, A.VOUCHERTYPE, A.BOOKTYPE,
			CLTCODE = CLTCODE,
			OPPCODE = OPPCODE, 
			MARGINCODE = MARGINCODE,
			CONVERT(VARCHAR,A.VDATE,103) AS VDATE, VDATE1 = CONVERT(VARCHAR,A.VDATE,111),
			A.DDNO, SNO=A.SNO, V.VDESC, ISNULL(A.LEDGERVNO,'') AS LEDGERVNO,
			DEBITAMT,
			CREDITAMT,
			ISNULL(A.TPFLAG,0) AS THIRDPARTY, TPAccountNumber,BankName,
			CONVERT(varchar,A.ADDDT,103) AS ADDDT, --A.ADDDT add1,
			END_DATE_ADD = DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)),
			DISPLAY_FLAG,
			VT.MKCKFLAG,
			A.ROWSTATE, A.APPROVALFLAG,
			EDIT = CASE WHEN VT.MKCKFLAG <> 1 AND (A.VOUCHERTYPE <> 16 OR A.VOUCHERTYPE <> 17) --AND ((A.VOUCHERTYPE <> 2 OR A.VOUCHERTYPE <> 3) AND A.REVCODE = '' AND A.ROWSTATE <> 99)
							AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN
						CASE WHEN ROWSTATE = 1 AND APPROVALFLAG = 3 THEN 0
						ELSE
							CASE  WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0
							ELSE					
								CASE WHEN ROWSTATE = 1 THEN @AFTER_EDIT
								ELSE @BEFORE_EDIT END
							END
						END
					ELSE 0
					END,
			
			APPROVE = CASE WHEN VT.MKCKFLAG <> 1 AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN 
							CASE WHEN A.VOUCHERTYPE IN (16, 17) AND ROWSTATE = 0 AND APPROVALFLAG = 0 AND @UA = 'UA' THEN 1
								 WHEN @UA = 'UA' AND ROWSTATE = 0 and A.VOUCHERTYPE NOT IN (16, 17)THEN 1 ELSE 0 END
						ELSE 0
						END,
			DELET = CASE WHEN  VT.MKCKFLAG <> 1 AND APPROVALFLAG <> 3  and  (ROWSTATE <> 0 or ROWSTATE <> 1)--ROWSTATE NOT IN (0,1) 
							AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN
						CASE WHEN  A.VOUCHERTYPE IN (16, 17) AND ROWSTATE = 0 AND APPROVALFLAG = 0 THEN							
								
							(CASE WHEN ROWSTATE = 1 THEN @AFTER_DELETE
								ELSE @BEFORE_DELETE END)
						
							 WHEN  A.VOUCHERTYPE NOT IN (16, 17) THEN
							(CASE WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0 
							 WHEN ROWSTATE = 1 THEN @AFTER_DELETE
								ELSE @BEFORE_DELETE END) ELSE 0 END
					ELSE 0 
					END,
			REJECT = CASE WHEN  VT.MKCKFLAG <> 1 AND  ROWSTATE <> 1 AND APPROVALFLAG <> 3
							AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN
							CASE WHEN  A.VOUCHERTYPE IN (16, 17) AND APPROVALFLAG = 1 OR APPROVALFLAG = 0 THEN 1
								 WHEN A.VOUCHERTYPE NOT IN (16, 17) THEN 
									CASE WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0 
									ELSE 1 END
								 ELSE 0 END
					ELSE 0
					END
				
			FROM V2_OFFLINE_LEDGER_ENTRIES A, #VTYPES VT, VMAST V 
			WHERE
				V.VTYPE = VT.VTYPE
				AND A.VOUCHERTYPE = V.VTYPE
				AND A.ADDBY = CASE WHEN VT.MKCKFLAG =  1 THEN @UNAME ELSE A.ADDBY END
				AND A.BRANCHCODE = CASE WHEN @STATUSID = 'BROKER' THEN A.BRANCHCODE ELSE RTRIM(LTRIM(@STATUSNAME)) END				
				AND (A.APPROVALFLAG = CASE WHEN @UA = 'UA' THEN 0 ELSE 1 END OR					
					A.APPROVALFLAG = CASE WHEN @UA = 'UA' THEN 2 ELSE 1 END OR
					A.APPROVALFLAG = 3) -- UNAPPROVED SELECTED
				--AND A.APPROVALFLAG <> CASE WHEN A.ROWSTATE = 1 THEN 3  END-- SHOULD NOT DISPLAY POSTED-DELETED
				--AND A.ROWSTATE <> 99-- = 0
				AND A.ROWSTATE = CASE WHEN @UA = 'UA' THEN 0 ELSE A.ROWSTATE END--1
				AND A.CREDITAMT + A.DEBITAMT  = CASE WHEN @VAMT = '' THEN A.CREDITAMT + A.DEBITAMT ELSE @VAMT END				
				AND A.EXCHANGE+'-'+A.SEGMENT = @EXCSEGMENT
				AND A.VOUCHERNO >= CASE WHEN @FVNO = '' OR @FVNO = 'ALL' OR @FVNO = '%' THEN '0' ELSE @FVNO END
				AND A.VOUCHERNO <= CASE WHEN @TVNO = '' OR @TVNO = 'ALL' OR @TVNO ='%' THEN 'ZZZZZZZZZZZZ' ELSE @TVNO END
				AND	A.ADDDT BETWEEN @VDATEFR AND @VDATETO + ' 23:59'
				AND ISNULL(A.TPFLAG,0) = CASE WHEN @THIRDPARTY = 'ALL' THEN ISNULL(A.TPFLAG,0) ELSE @THIRDPARTY END
				AND A.CLTCODE = CASE WHEN @CLTCODE = '' OR @CLTCODE = 'ALL' OR @CLTCODE = '%' THEN A.CLTCODE ELSE @CLTCODE END
				AND A.OPPCODE = CASE WHEN @OPPCODE = '' OR @OPPCODE = 'ALL' OR @OPPCODE = '%' THEN A.OPPCODE ELSE @OPPCODE END
				AND A.STATUSNAME = CASE WHEN @FILTERON = '' OR @FILTERON = 'ALL' OR @FILTERON = '%' THEN A.STATUSNAME ELSE @FILTERON END
				AND A.ADDBY = CASE WHEN @ADDBY = '' OR @ADDBY = 'ALL' OR @ADDBY = '%' THEN A.ADDBY ELSE @ADDBY END
			ORDER BY VOUCHERNO, FLDAUTO			
	DROP TABLE #VTYPES

END
/*GET_VOUCHER_APPR_EDIT_DATA @VDATEFR = '01/10/2007', @VDATETO = '31/03/2010', @VTYPE='', @UNAME='MEGHA', @STATUSID='BROKER', @STATUSNAME='BROKER',
	@USERCATEGORY = 388, @EXCSEGMENT = 'NSE-CAPITAL', @FVNO = '', @TVNO = '', @UA = '', @VAMT = '', @THIRDPARTY = 'ALL', @CLTCODE = '', @OPPCODE = '',
	@FILTERON = '', @ADDBY = ''
-- SELECT * FROM OFFLINE_VOUCHER_SETTING
UPDATE OFFLINE_VOUCHER_SETTING SET OPFLAG = 15
UPDATE V2_OFFLINE_LEDGER_ENTRIES SET  VOUCHERTYPE = 2 WHERE FLDAUTO = 8 -- 2
UPDATE V2_OFFLINE_LEDGER_ENTRIES SET  approvalflag = 0 WHERE FLDAUTO = 8 
SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES 
ORDER BY FLDAUTO DESC
UPDATE V2_OFFLINE_LEDGER_ENTRIES 
SET ROWSTATE = 99, REVCODE = '2', APPROVALFLAG = 1
WHERE FLDAUTO = 224
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetBillDataSum
-- --------------------------------------------------
CREATE Proc GetBillDataSum      
@Sett_No As Varchar(7),      
@Sett_Type As Varchar(2),      
@ShareDb As Varchar(15),      
@DispOpt As Varchar(7) = 'Summary',      
@Disp123 As Varchar(2) = 'N'      
      
--exec GetBillDataSum '2004042', 'N', 'MSAJAG', 'Details'      
--Exec GetBillDataSum '2013117', 'L ', 'NSESLBS'      
      
As      
      
Declare      
@@SQLQry As Varchar(2000)      
      
Set @@SQLQry = "Select Party_Code, M.Acname, Round(Amount,2) As Amount, Sell_Buy, Bill_No From " + @ShareDb + " "      
Set @@SQLQry = @@SQLQry + ".Dbo.Accbill a, Acmast m  WITH(NOLOCK)"      
Set @@SQLQry = @@SQLQry + " Where Sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"      
Set @@SQLQry = @@SQLQry + " And A.party_code = M.Cltcode and branchcd = 'ZZZ' "      
--Set @@SQLQry = @@SQLQry + " And Round(Amount,2) <> 0 "      
--Set @@SQLQry = @@SQLQry + " Order By Party_Code "  
Set @@SQLQry = @@SQLQry + " union all "      
      
If @DispOpt = 'Summary'      
 Begin      
  Set @@SQLQry = @@SQLQry + " Select 'Party Dr', 'Party Amount Receivables', Round(sum(Amount),2) As Amount, Sell_buy, bill_no "      
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.accbill a, "      
  Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"      
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "      
  Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "      
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "      
  Set @@SQLQry = @@SQLQry + " union all "      
 End      
Else      
 Begin      
  Set @@SQLQry = @@SQLQry + " Select Party_Code ,M.AcName, Round(sum(Amount),2) As Amount, Sell_buy, bill_no "      
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.accbill a, "      
  Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"      
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "      
  Set @@SQLQry = @@SQLQry + " group by Party_Code ,M.AcName, bill_no, Sell_Buy "      
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "      
  Set @@SQLQry = @@SQLQry + " union all "      
 End      
If @DispOpt = 'Summary'      
 Begin      
  Set @@SQLQry = @@SQLQry + " Select 'Party CR', 'Party Amount Payables', Round(sum(Amount),2) As Amount,Sell_buy, bill_no "      
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.Accbill a, acmast m "      
  Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"      
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "      
  Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "      
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "      
 End      
Else      
 Begin      
  Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount,Sell_buy, bill_no "      
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.Accbill a, acmast m "      
  Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"      
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "      
  Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "      
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "      
 End      
      
Print @@SQLQry      
Exec(@@SQLQry)      
      
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetBillDataSum_NEW
-- --------------------------------------------------
CREATE PROC [dbo].[GetBillDataSum_NEW]    
@SETT_NO AS VARCHAR(7),    
@SETT_TYPE AS VARCHAR(2),    
@SHAREDB AS VARCHAR(15),    
@DISPOPT AS VARCHAR(7) = 'SUMMARY',    
@DISP123 AS VARCHAR(2) = 'N'    
    
--EXEC GETBILLDATASUM '2004042', 'N', 'MSAJAG', 'DETAILS'    
--EXEC GETBILLDATASUM '2004059', 'A ', 'MSAJAG'    
    
AS    
    
DECLARE    
@@SQLQRY AS VARCHAR(2000)

    
SET @@SQLQRY = "SELECT PARTY_CODE, M.ACNAME, ROUND(AMOUNT,2) AS AMOUNT, SELL_BUY, BILL_NO, NARRATION FROM " + @SHAREDB + " "    
SET @@SQLQRY = @@SQLQRY + ".DBO.ACCBILL A, ACMAST M  WITH(NOLOCK)"    
SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"    
SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND BRANCHCD = 'ZZZ' "    
--SET @@SQLQRY = @@SQLQRY + " AND ROUND(AMOUNT,2) <> 0 "    
SET @@SQLQRY = @@SQLQRY + " UNION ALL "    
    
IF @DISPOPT = 'SUMMARY'    
 BEGIN    
  SET @@SQLQRY = @@SQLQRY + " SELECT 'PARTY DR', 'PARTY AMOUNT RECEIVABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO, NARRATION "    
  SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.ACCBILL A, "    
  SET @@SQLQRY = @@SQLQRY + " ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"    
  SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' "    
  SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY, NARRATION "    
--  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "    
  SET @@SQLQRY = @@SQLQRY + " UNION ALL "    
 END    
ELSE    
 BEGIN    
  SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE ,M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO, NARRATION "    
  SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.ACCBILL A, "    
  SET @@SQLQRY = @@SQLQRY + " ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"    
  SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' "    
  SET @@SQLQRY = @@SQLQRY + " GROUP BY PARTY_CODE ,M.ACNAME, BILL_NO, SELL_BUY, NARRATION "    
--  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "    
  SET @@SQLQRY = @@SQLQRY + " UNION ALL "    
 END    
IF @DISPOPT = 'SUMMARY'    
 BEGIN    
  SET @@SQLQRY = @@SQLQRY + " SELECT 'PARTY CR', 'PARTY AMOUNT PAYABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO, NARRATION "    
  SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.ACCBILL A, ACMAST M "    
  SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"    
  SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' "    
  SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY, NARRATION "    
--  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "    
 END    
ELSE    
 BEGIN    
  SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO, NARRATION "    
  SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.ACCBILL A, ACMAST M "    
  SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"    
  SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' "    
  SET @@SQLQRY = @@SQLQRY + " GROUP BY PARTY_CODE, M.ACNAME, BILL_NO, SELL_BUY, NARRATION "    
--  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "    
 END    
    
PRINT @@SQLQRY    
EXEC(@@SQLQRY)    
    
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETBILLDATASUM_REM
-- --------------------------------------------------
CREATE PROC GETBILLDATASUM_REM          
 @SETT_NO AS VARCHAR(7),          
 @SETT_TYPE AS VARCHAR(2),          
 @SHAREDB AS VARCHAR(15),          
 @DISPOPT AS VARCHAR(7) = 'SUMMARY'          
          
--EXEC GETBILLDATASUM '2004042', 'N', 'MSAJAG', 'DETAILS'          
--EXEC GETBILLDATASUM '2004059', 'A ', 'MSAJAG'          
          
AS          
          
DECLARE          
@@SQLQRY AS VARCHAR(4000)          
          
SET @@SQLQRY = "SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, ROUND(AMOUNT,2) AS AMOUNT, SELL_BUY, BILL_NO FROM "          
SET @@SQLQRY = @@SQLQRY + "MSAJAG.DBO.REM_ACCBILL A, ACCOUNT.DBO.ACMAST M  WITH(NOLOCK)"          
SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND BRANCHCD = 'ZZZ' AND EXCHANGE = 'NSECM' AND SEGMENT = 'CAPITAL' "          
--SET @@SQLQRY = @@SQLQRY + " AND ROUND(AMOUNT,2) <> 0 "          
SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
SET @@SQLQRY = @@SQLQRY + "SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, ROUND(AMOUNT,2) AS AMOUNT, SELL_BUY, BILL_NO FROM "          
SET @@SQLQRY = @@SQLQRY + "MSAJAG.DBO.REM_ACCBILL A, ACCOUNTBSE.DBO.ACMAST M  WITH(NOLOCK)"          
SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND BRANCHCD = 'ZZZ' AND EXCHANGE = 'BSECM' AND SEGMENT = 'CAPITAL'"          
--SET @@SQLQRY = @@SQLQRY + " AND ROUND(AMOUNT,2) <> 0 "          
SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
SET @@SQLQRY = @@SQLQRY + "SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, ROUND(AMOUNT,2) AS AMOUNT, SELL_BUY, BILL_NO FROM "          
SET @@SQLQRY = @@SQLQRY + "MSAJAG.DBO.REM_ACCBILL A, ACCOUNTFO.DBO.ACMAST M  WITH(NOLOCK)"          
SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND BRANCHCD = 'ZZZ' AND EXCHANGE = 'NSEFO' AND SEGMENT = 'FUTURES'"          
--SET @@SQLQRY = @@SQLQRY + " AND ROUND(AMOUNT,2) <> 0 "          
SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
          
IF @DISPOPT = 'SUMMARY'          
BEGIN          
 SET @@SQLQRY = @@SQLQRY + " SELECT 'NSECM PARTY DR', 'PARTY AMOUNT RECEIVABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, "          
 SET @@SQLQRY = @@SQLQRY + " ACCOUNT.DBO.ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' AND EXCHANGE = 'NSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT 'BSECM PARTY DR', 'PARTY AMOUNT RECEIVABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, "          
 SET @@SQLQRY = @@SQLQRY + " ACCOUNTBSE.DBO.ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' AND EXCHANGE = 'BSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT 'NSEFO PARTY DR', 'PARTY AMOUNT RECEIVABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, "          
 SET @@SQLQRY = @@SQLQRY + " ACCOUNTFO.DBO.ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' AND EXCHANGE = 'NSEFO' AND SEGMENT = 'FUTURES'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
END          
ELSE          
BEGIN          
 SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE ,M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, "          
 SET @@SQLQRY = @@SQLQRY + " ACCOUNT.DBO.ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' AND EXCHANGE = 'NSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY EXCHANGE + ' ' + PARTY_CODE ,M.ACNAME, BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE ,M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, "          
 SET @@SQLQRY = @@SQLQRY + " ACCOUNTBSE.DBO.ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' AND EXCHANGE = 'BSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY EXCHANGE + ' ' + PARTY_CODE ,M.ACNAME, BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE ,M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, "          
 SET @@SQLQRY = @@SQLQRY + " ACCOUNTFO.DBO.ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' AND EXCHANGE = 'NSEFO' AND SEGMENT = 'FUTURES'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY EXCHANGE + ' ' + PARTY_CODE ,M.ACNAME, BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
END          
IF @DISPOPT = 'SUMMARY'          
BEGIN          
 SET @@SQLQRY = @@SQLQRY + " SELECT 'NSECM PARTY CR', 'PARTY AMOUNT PAYABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, ACCOUNT.DBO.ACMAST M "          
 SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' AND EXCHANGE = 'NSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT 'BSECM PARTY CR', 'PARTY AMOUNT PAYABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, ACCOUNTBSE.DBO.ACMAST M "          
 SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' AND EXCHANGE = 'BSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT 'NSEFO PARTY CR', 'PARTY AMOUNT PAYABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, ACCOUNTFO.DBO.ACMAST M "          
 SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' AND EXCHANGE = 'NSEFO' AND SEGMENT = 'FUTURES'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
END          
ELSE          
BEGIN          
 SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, ACCOUNT.DBO.ACMAST M "          
 SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' AND EXCHANGE = 'NSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "         
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "           
      
 SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, ACCOUNTBSE.DBO.ACMAST M "          
 SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' AND EXCHANGE = 'BSECM' AND SEGMENT = 'CAPITAL'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
 SET @@SQLQRY = @@SQLQRY + " UNION ALL "          
      
 SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE = EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "          
 SET @@SQLQRY = @@SQLQRY + " FROM MSAJAG.DBO.REM_ACCBILL A, ACCOUNTFO.DBO.ACMAST M "          
 SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"          
 SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' AND EXCHANGE = 'NSEFO' AND SEGMENT = 'FUTURES'"          
 SET @@SQLQRY = @@SQLQRY + " GROUP BY EXCHANGE + ' ' + PARTY_CODE, M.ACNAME, BILL_NO, SELL_BUY "          
 --  SET @@SQLQRY = @@SQLQRY + " HAVING ROUND(SUM(AMOUNT),2) <> 0 "          
END          
          
PRINT @@SQLQRY          
EXEC(@@SQLQRY)          
          
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetCltcode
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[GetCltcode]
(
	@LETTERS VARCHAR(100),
	@TXTTEXTBOX VARCHAR(1000),
	@EXCSEGMENT VARCHAR(30),
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25)
)
AS
/*
	CALLAJAX :: TXTOPPCODE, TXTMARGINCODE, TXTACCOUNT, TXTTPACNUM, TXTCHARGEACCOUNT
	callajaxCC :: CATEGORY, COSTCENTER
*/
/* 
@TXTTEXTBOX = FIELD TYPE TO FIND ~ BOOKTYPE ~ CODE AS PE VTYPE( E.G. BANKCLTCODE FOR VTYPE 3) ~ TXTACCOUNT VALUE
IN CASE OF COST CENTER
@TXTTEXTBOX = FIELD TYPE TO FIND ~ BOOKTYPE ~ BRANCHCODE ~ CAREGORY VALUE ~
@LETTERS = VALUE TO FIND
 EXEC GetCltcode '', 'COSTCENTER~01~ALL~BRANCH', 'NSE-CAPITAL', 'broker', 'broker'

GetCltcode 'H', 'COSTCENTER~01~ALL~BRANCH', '', 'BROKER', 'MEGHA'
GetCltcode '%', 'TXTOPPCODE~01~CASHCLTCODE~~', '', 'BROKER', 'MEGHA'
GetCltcode 'i', 'TXTOPPCODE~01~BANKCLTCODE~~', '', 'BRANCH', 'BRANCH'
GetCltcode '%', 'TXTTPACNUM~01~CASHCLTCODE~CLI00003~', '', 'BROKER', 'BROKER'
GetCltcode '%', 'TXTBRANCHCODE~01~CASHCLTCODE~CLI00003~', '', 'BROKER', 'BROKER'
GetCltcode '', 'TXTADDBY~01~CASHCLTCODE~CLI00003~', 'NSE-CAPITAL', 'BROKER', 'BROKER'


USE MSAJAG
SELECT TOP 2 * FROM CLIENT5
SELECT TOP 2 * FROM CLIENT2
SELECT TOP 2 * FROM POBANK
SELECT TOP 2 * BRANCH
*/
BEGIN
	SET NOCOUNT ON;
	DECLARE @ACTIVEDAYS INT,
	@CONTROLSRC VARCHAR(20),
	@BOOKTYPE VARCHAR(2),
	@CLTFILTER VARCHAR(100),
	@TXTPARTYCODE VARCHAR(10),
	@CATSRC VARCHAR(50),
	@BRCODE VARCHAR(15),
	@CATTEXT VARCHAR(100),
	@BRANCHCODE VARCHAR(20),
	@CODEFLAG INT,
	@GSHAREDBNAME VARCHAR(20),
	@EXCHANGE VARCHAR(20),
	@SEGMENT VARCHAR(20),
	@SQL VARCHAR(MAX)

	SET @EXCHANGE = LTRIM(RTRIM(.DBO.PIECE(@EXCSEGMENT, '-', 1)))
	SET @SEGMENT = LTRIM(RTRIM(.DBO.PIECE(@EXCSEGMENT, '-', 2)))

	SET @CONTROLSRC	= .DBO.PIECE(@TXTTEXTBOX, '~', 1)
	SET @BOOKTYPE = .DBO.PIECE(@TXTTEXTBOX, '~', 2)
	SET @CLTFILTER	= .DBO.PIECE(@TXTTEXTBOX, '~', 3)
	SET @TXTPARTYCODE = .DBO.PIECE(@TXTTEXTBOX, '~', 4)
--	SET @CATSRC	= .DBO.PIECE(@TXTTEXTBOX, '~', 1)
--	SET @BRCODE	= .DBO.PIECE(@TXTTEXTBOX, '~', 3)
--	SET @CATTEXT = .DBO.PIECE(@TXTTEXTBOX, '~', 4)

	SELECT @ACTIVEDAYS = ACTIVEDAYS FROM OWNER
	SELECT @CODEFLAG = CASE ACCAT WHEN  '3' THEN 1 WHEN '4' THEN 2 ELSE 0 END FROM ACMAST WHERE CLTCODE = @TXTPARTYCODE
	
	IF UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTACCOUNT'
		BEGIN
			IF @CLTFILTER = 'JVCODES'
				BEGIN
					SELECT TOP 5 LTRIM(RTRIM(CLTCODE)) + '~' + LTRIM(RTRIM(BRANCHCODE)) + '~' + LTRIM(RTRIM(LONGNAME)),
						'(' + CLTCODE + ') -' + ACNAME 
					FROM ACMAST (NOLOCK)
					WHERE ACCAT NOT IN  ('1','2','18')
						AND (LEFT(ACNAME,LEN(@LETTERS)) = @LETTERS OR LEFT(CLTCODE, LEN(@LETTERS)) = @LETTERS)
						AND BRANCHCODE = CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE BRANCHCODE END
					ORDER BY 2,1
				END
			ELSE
				BEGIN
				SELECT TOP 5 LTRIM(RTRIM(CLTCODE)) + '~' + LTRIM(RTRIM(BRANCHCODE)) + '~' + LTRIM(RTRIM(LONGNAME)),
							'(' + CLTCODE + ') -' + ACNAME
				FROM ACMAST A (NOLOCK)
				WHERE ACCAT IN  ('3','4','18')
					AND (LEFT(ACNAME,LEN(@LETTERS)) = @LETTERS OR LEFT(CLTCODE,LEN(@LETTERS)) = @LETTERS)
					AND NOT EXISTS ( SELECT PARTY_CODE, INACTIVEFROM 
									FROM MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)
									WHERE LTRIM(RTRIM(C2.CL_CODE)) = C5.CL_CODE 
											AND DATEADD(DAY,@ACTIVEDAYS,INACTIVEFROM) <= GETDATE() 
											AND A.CLTCODE = PARTY_CODE
									)		
					AND (BRANCHCODE =  CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE BRANCHCODE END
						OR BRANCHCODE = CASE WHEN @STATUSID = 'BRANCH' THEN 'ALL' ELSE BRANCHCODE END)
				ORDER BY 2,1
			END
		END
	ELSE IF  UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTCHARGEACCOUNT'
		BEGIN
			SELECT LTRIM(RTRIM(CLTCODE)) + '~' + LTRIM(RTRIM(BRANCHCODE)) + '~' + LTRIM(RTRIM(LONGNAME)),
				'(' + cltcode + ') -' + acname
			from AcMast (NoLock)
			WHERE ACCAT  IN  ('3','18')
				AND (LEFT(ACNAME,LEN(@LETTERS)) = @LETTERS OR LEFT(CLTCODE,LEN(@LETTERS)) = @LETTERS)
				AND BRANCHCODE LIKE CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END
			ORDER BY 2,1
		END
	ELSE IF  UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTOPPCODE'
		BEGIN
			IF @CLTFILTER = 'BANKCLTCODE' OR @CLTFILTER = 'CASHCLTCODE'
				BEGIN					
					SELECT TOP 5 CLTCODE + '~' + LONGNAME + '~' + BRANCHCODE, '(' + CLTCODE + ') -' + LONGNAME
					FROM ACMAST
					WHERE ACCAT  = CASE WHEN @CLTFILTER = 'BANKCLTCODE' THEN '2' ELSE '1' END
						AND BOOKTYPE LIKE @BOOKTYPE
						AND (LEFT(ACNAME,LEN(@LETTERS)) = @LETTERS OR LEFT(CLTCODE,LEN(@LETTERS)) = @LETTERS)
						AND (BRANCHCODE LIKE CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END
						OR  LTRIM(RTRIM(BRANCHCODE)) LIKE 'ALL')
					ORDER BY 2,1
				END
		ELSE
			BEGIN
				SELECT TOP 10 LTRIM(RTRIM(CLTCODE))+'~'+LTRIM(RTRIM(BRANCHCODE))+'~'+LTRIM(RTRIM(LONGNAME)),
					'(' + CLTCODE + ') -' +ACNAME
				FROM ACMAST(NOLOCK)
				WHERE ACCAT = '4'
					AND (ACCAT = CASE WHEN @CLTFILTER <> 'MJVCODES' THEN '3' ELSE ACCAT END
					OR ACCAT = CASE WHEN @CLTFILTER <> 'MJVCODES' THEN '18' ELSE ACCAT END)
					AND ((LEFT(ACNAME,LEN(@LETTERS)) = @LETTERS)  OR (LEFT(CLTCODE,LEN(@LETTERS)) = @LETTERS))
					AND BRANCHCODE LIKE CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END
				ORDER BY 2,1
			END
	END
	ELSE IF  UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTMARGINCODE'
		BEGIN
			SELECT TOP 5 CLTCODE+'~'+LONGNAME+'~'+BRANCHCODE,'(' + CLTCODE + ') -' +LONGNAME
				FROM ACMAST(NOLOCK)
				WHERE ACCAT  IN ('3', '4', '14')
					AND ((LEFT(ACNAME,LEN(@LETTERS)) = @LETTERS) OR (LEFT(CLTCODE,LEN(@LETTERS)) = @LETTERS))
					AND (BRANCHCODE LIKE CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END
						OR  LTRIM(RTRIM(BRANCHCODE)) LIKE 'ALL')
				ORDER BY 2,1
		END
	ELSE IF UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTTPACNUM' AND @CODEFLAG = 2
		BEGIN
			SELECT TOP 10 A.ACCNO + '~' + A.CHEQUENAME + '~' + ISNULL(B.BANK_NAME,'') + '~' + ISNULL(B.BRANCH_NAME,''),
				A.DEFAULTBANK + '~' + '('+A.ACCNO+') - '+ ISNULL(B.BANK_NAME,'')+'~'+ISNULL(B.BRANCH_NAME,'')
			FROM MULTIBANKID A LEFT OUTER JOIN MSAJAG.DBO.POBANK B ON (A.BANKID = B.BANKID)
			WHERE 1=1
				AND A.CLTCODE = @TXTPARTYCODE
			ORDER BY 2,1
		END
	ELSE IF UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTBRANCHCODE'
		BEGIN
			SELECT TOP 5 LTRIM(RTRIM(C.COSTNAME)) + '~' + LTRIM(RTRIM(S.LONG_NAME)), '('+LTRIM(RTRIM(C.COSTNAME))+') - '+LTRIM(RTRIM(S.LONG_NAME)), B.DEFAULTAC
			FROM BRANCHACCOUNTS B inner join costmast c on (c.costName = b.branchname)
				INNER JOIN MSAJAG.DBO.BRANCHES S ON (S.BRANCH_CD = B.BRANCHNAME)
			WHERE ((LEFT(C.COSTNAME,LEN(@LETTERS)) = @LETTERS) OR (LEFT(S.LONG_NAME,LEN(@LETTERS)) = @LETTERS))				
				AND C.COSTNAME LIKE  CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE C.COSTNAME END
			ORDER BY 3 DESC,2
		END
	ELSE IF UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'CATEGORY' OR  UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'COSTCENTER'
		BEGIN
			SET @CATSRC	= .DBO.PIECE(@TXTTEXTBOX, '~', 1)
			SET @BRCODE	= UPPER(LTRIM(RTRIM(.DBO.PIECE(@TXTTEXTBOX, '~', 3))))
			SET @CATTEXT = .DBO.PIECE(@TXTTEXTBOX, '~', 4)
			
			IF @CATSRC = 'CATEGORY'
				BEGIN
					SELECT RTRIM(LTRIM(CATCODE)), RTRIM(LTRIM(UPPER(CATEGORY)))
					FROM CATEGORY
					WHERE (category LIKE @LETTERS + '%' or catcode LIKE @LETTERS + '%')
							AND CATEGORY <> 'BRANCH'--CASE WHEN @BRCODE <> 'ALL' THEN 'BRANCH' ELSE '' END
				END
			ELSE -- COSTCENTER --
				 -- GetCltcode 'H', 'COSTCENTER~01~ALL~BRANCH', '', 'BROKER', 'MEGHA'
				BEGIN
					SELECT COSTCODE = RTRIM(LTRIM(CC.COSTCODE)), COSTNAME = RTRIM(LTRIM(UPPER(CC.COSTNAME)))
					FROM CATEGORY C, COSTMAST CC
					WHERE C.CATCODE=CC.CATCODE 
						AND C.CATEGORY= @CATTEXT
						AND CC.COSTNAME = CASE WHEN @STATUSID = 'BRANCH' AND @CATTEXT = 'BRANCH' THEN @STATUSNAME ELSE CC.COSTNAME END
						AND CC.COSTNAME  LIKE CASE WHEN @STATUSID = 'BRANCH' AND @CATTEXT = 'BRANCH' THEN @STATUSNAME ELSE @LETTERS + '%' END
					ORDER BY RTRIM(LTRIM(CC.COSTCODE)), CC.COSTNAME
				
				END			
		END
	ELSE IF UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTADDBY' OR  UPPER(LTRIM(RTRIM(@CONTROLSRC))) = 'TXTFILTERON'
		BEGIN --
			SELECT @GSHAREDBNAME = UPPER(LTRIM(RTRIM(SHAREDB)))  FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT
			IF @GSHAREDBNAME <> ''
				BEGIN
					SET @SQL = "SELECT TOP 10 UPPER(FLDUSERNAME), UPPER(FLDFIRSTNAME) FROM " + @GSHAREDBNAME + ".DBO.TBLPRADNYAUSERS  "
					SET @SQL = @SQL + "WHERE ((LEFT(FLDUSERNAME," + CONVERT(VARCHAR, LEN(@LETTERS)) + ") = '" + @LETTERS + "') OR (LEFT(FLDFIRSTNAME," + CONVERT(VARCHAR, LEN(@LETTERS)) + ") = '" + @LETTERS + "')) "
					SET @SQL = @SQL + "ORDER BY 1"
					EXEC(@SQL)
				END
		END

END

/*
EXEC GetCltcode 'hO', 'COSTCENTER~01~ALL~BRANCH', 'NSE-CAPITAL', 'broker', 'broker'

SELECT RTRIM(LTRIM(CC.COSTCODE)), COSTNAME = RTRIM(LTRIM(UPPER(CC.COSTNAME)))
					FROM CATEGORY C, COSTMAST CC
					WHERE C.CATCODE=CC.CATCODE 
						AND C.CATEGORY= @CATTEXT
						AND CC.COSTNAME = CASE WHEN @STATUSID = 'BRANCH' AND @CATTEXT = 'BRANCH' THEN @STATUSNAME ELSE CC.COSTNAME END
						AND CATEGORY LIKE CASE WHEN @STATUSID = 'BRANCH' AND @CATTEXT = 'BRANCH' THEN @LETTERS + '%' ELSE CATEGORY END
						--AND (COSTCODE LIKE @LETTERS + '%' OR COSTCODE LIKE @LETTERS + '%')
						AND COSTCODE LIKE CASE WHEN @STATUSID = 'BRANCH' AND @CATTEXT = 'BRANCH' THEN COSTCODE ELSE @LETTERS + '%' END
					ORDER BY CC.COSTNAME					
				
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetIBillDataSum
-- --------------------------------------------------







CREATE     Proc GetIBillDataSum
@Sett_No As Varchar(7),
@Sett_Type As Varchar(2),
@ShareDb As Varchar(15),
@DispOpt As Varchar(7) = 'Summary'

--exec GetBillDataSum '2004042', 'N', 'MSAJAG'
--Exec GetBillDataSum '2004059', 'A ', 'MSAJAG'

As

Declare
@@SQLQry As Varchar(2000)

Set @@SQLQry = "Select Party_Code, M.Acname, Round(Amount,2) As Amount, Sell_Buy, Bill_No From " + @ShareDb + " "
Set @@SQLQry = @@SQLQry + ".Dbo.IAccbill a, Acmast m  WITH(NOLOCK)"
Set @@SQLQry = @@SQLQry + " Where Sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
Set @@SQLQry = @@SQLQry + " And A.party_code = M.Cltcode and branchcd = 'ZZZ' "
--Set @@SQLQry = @@SQLQry + " And Round(Amount,2) <> 0 "
Set @@SQLQry = @@SQLQry + " union all "

If @DispOpt = 'Summary'
	Begin
		Set @@SQLQry = @@SQLQry + " Select 'Party DR', 'Party Amount Receivables', Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, "
		Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
		Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
		Set @@SQLQry = @@SQLQry + " union all "
	End
Else
	Begin
		Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, "
		Set @@SQLQry = @@SQLQry + " Acmast m  where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
		Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
		Set @@SQLQry = @@SQLQry + " union all "
	End
	
If @DispOpt = 'Summary'
	Begin
		Set @@SQLQry = @@SQLQry + " Select 'Party CR', 'Party Amount Payables', Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, acmast m "
		Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
		Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
	End
Else
	Begin
		Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.IAccbill a, acmast m "
		Set @@SQLQry = @@SQLQry + " where sett_no ='" + @Sett_No + "' and sett_type='" + @Sett_Type + "'"
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
		Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
	End

Print @@SQLQry
Exec(@@SQLQry)

SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetManualBankReco
-- --------------------------------------------------


CREATE  Proc GetManualBankReco
	@BankCode Varchar(10),
	@FDate Varchar(11),
	@TDate Varchar(11),
	@Edit SmallInt,
	@SVtyp Varchar(5),
	@OrderBy Varchar(15),
      @DDno Varchar(15),
	@SelectRl Varchar(20) = ''
As
Declare @@SelectQury As Varchar(2000)
	Select @@SelectQury = "Select L.AcName, L1.DrCr, L.CltCode, L1.DDNO, Convert(Varchar(10), dddt, 103) as Dddt, CONVERT(VARCHAR(10),reldt,103) AS  reldt1, "
	Select @@SelectQury = @@SelectQury + "L.Vamt as RelAmt, Convert(Varchar(10), L.Vdt, 103) As Vdt, "
	Select @@SelectQury = @@SelectQury + "CONVERT(VARCHAR(10),vdt,101) AS   vdt1,l1.vno,l1.vtyp,l1.booktype,l1.lno,reldt ,ShortDesc "
	Select @@SelectQury = @@SelectQury + "From Ledger L, Ledger1 L1, VMast V, (Select Vno, Vtyp, BookType From Ledger Where CltCode = '" + @BankCode + "' "
	If @SVtyp = 'All'
		Begin
			Select @@SelectQury = @@SelectQury + "And Vtyp In (2,3,5,19,20,17) "
		End
	Else
		Begin
			If @SVtyp = '2'
				Begin
					Select @@SelectQury = @@SelectQury + "And Vtyp = 2 "
				End
			Else
				Begin
					If @SVtyp = '3'
						Begin
							Select @@SelectQury = @@SelectQury + "And Vtyp = 3 "
						End
				End
		End
      If @FDate <> ''
        Begin
	    Select @@SelectQury = @@SelectQury + "And Vdt Between '" + @FDate + "' And '" + @TDate + " 23:59:59') L2 "
        End
      Else
        Begin
            Select @@SelectQury = @@SelectQury + ") L2 "
        End
	Select @@SelectQury = @@SelectQury + "Where L.Vno = L2.Vno and L.Vtyp = L2.Vtyp And L.BookType = L2.Booktype And L.CLtcode <> '" + @BankCode + "' "
	Select @@SelectQury = @@SelectQury + "And L.Vno = L1.Vno and L.Vtyp = L1.Vtyp ANd L.BookType = L1.Booktype ANd L.Lno = L1.Lno "
      If @Ddno <> ''
        Begin
	     Select @@SelectQury = @@SelectQury + "And L1.Ddno = '" + @Ddno + "'"
        End
/*
	If @SelectRl = 'chkRelDt'
		Begin
			Select @@SelectQury = @@SelectQury + "And L1.RelDt Between '" + @FDate + "' And '" + @TDate + " 23:59:59' "
		End
	Else
		Begin
			Select @@SelectQury = @@SelectQury + "And L.Vdt Between '" + @FDate + "' And '" + @TDate + " 23:59:59' "
		End
*/
	If @Edit = 1
		Begin
			Select @@SelectQury = @@SelectQury + "And reldt Not Like 'Jan  1 1900%' "
		End
	Else
		Begin
			Select @@SelectQury = @@SelectQury + "And reldt Like 'Jan  1 1900%' "
		End
	Select @@SelectQury = @@SelectQury + "And v.Vtype = l.vtyp and (upper(clear_mode) <> 'C') "
	If @OrderBy = 'relamt'
		Begin
			Select @@SelectQury = @@SelectQury + "Order By relamt ,vdt1 ,l1.vtyp,l1.vno "
		End
	Else
		Begin
			If @OrderBy = 'vdt'
				Begin
					Select @@SelectQury = @@SelectQury + "Order By vdt1, relamt, l1.vtyp, l1.vno "
				End
			Else
				Begin
					If @OrderBy = 'ddno'
						Begin
							Select @@SelectQury = @@SelectQury + "Order By ddno, relamt, l1.vtyp, l1.vno "
						End
					Else
						Begin
							If @OrderBy = 'reldt'
								Begin
									Select @@SelectQury = @@SelectQury + "Order By reldt, relamt, l1.vtyp, l1.vno "
								End
						End
				End
		End
Print @@SelectQury
Exec (@@SelectQury)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETPARADATE
-- --------------------------------------------------
CREATE PROC GETPARADATE
/*
	EXEC GETPARADATE 'DEC  1 2006', 'DEC 15 2006'
	EXEC GETPARADATE '01/12/2006', '15/12/2006'
Exec GETPARADATE '01/04/2006', '09/05/2006' 
*/
	@@FROMDT AS VARCHAR(11),
	@@TODT AS VARCHAR(11)
AS
DECLARE
	@@DIFF AS INT,
	@@ISBRIT AS TINYINT

SELECT @@ISBRIT = 0
IF LEN(LTRIM(RTRIM(@@FROMDT))) = 10
	BEGIN
		SELECT @@FROMDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@FROMDT, 103),109)
		SELECT @@ISBRIT = 1
	END
IF LEN(LTRIM(RTRIM(@@TODT))) = 10
	BEGIN
		SELECT @@TODT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 103),109)
	END


SELECT @@DIFF = 0
SELECT @@DIFF = ISNULL(REPORTDAYS, 0) FROM PARAMETER WHERE @@TODT BETWEEN SDTCUR AND LDTCUR
IF @@DIFF = 0
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT @@FROMDT
			END
		ELSE
			BEGIN
				SELECT CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103)
			END
	END
ELSE
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 109) 
					ELSE CONVERT(VARCHAR(11), @@FROMDT, 109) 
				END 
				)
			END
		ELSE
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(10), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 103) 
					ELSE CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103) 
				END 
				)
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETUSERCATEGORY
-- --------------------------------------------------
CREATE PROC [dbo].[GETUSERCATEGORY]
(
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20),
	@USERID VARCHAR(25)
)
AS
/*
	EXEC sp_helptext GETUSERCATEGORY 'BSE', 'CAPITAL', 'MEGHA'
*/
DECLARE
	@SQL VARCHAR(2000),
	@SHAREDB VARCHAR(30)
CREATE TABLE #SHAREDB
(
	SHAREDB VARCHAR(30)
)
SET @SQL = "INSERT INTO #SHAREDB (SHAREDB) SELECT SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = '" + @EXCHANGE + "' AND SEGMENT = '" + @SEGMENT + "' AND PRIMARYSERVER = 1"
EXEC(@SQL)
SELECT @SHAREDB = SHAREDB FROM #SHAREDB
SET @SQL = "SELECT * FROM " + @SHAREDB + ".dbo.TBLPRADNYAUSERS WHERE FLDUSERNAME = '" + @USERID + "'"
EXEC(@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETVOUDATA
-- --------------------------------------------------
CREATE PROC [dbo].[GETVOUDATA]          
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */                  
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */              
@BANKCODE VARCHAR(10),   
@VAMT MONEY = 0,  
@DDNO VARCHAR(20) = '',   
@CLTCODE VARCHAR(10) = '',          
@PageSize varchar(3) = '25'          
AS          
  
          
CREATE TABLE #GETDATA_EDIT          
(          
 VNO VARCHAR(12),  
 BOOKTYPE VARCHAR(3),  
 VTYPE INT,           
 CLTCODE VARCHAR(10),           
 ACNAME VARCHAR(100),           
 VAMT MONEY,           
 NARRATION VARCHAR(250),           
 DDNO VARCHAR(20),   
 DDDT VARCHAR(10),          
 BNKNAME VARCHAR(35),  
 BRNNAME VARCHAR(20),   
 MICRNO INT,  
 RELDT VARCHAR(10),      
 VDT VARCHAR(10),  
 LNO INT   
         
)          
          
DECLARE          
@@SQL VARCHAR(2000)          
          
SET @@SQL = " INSERT INTO #GETDATA_EDIT "          
SET @@SQL = @@SQL + " SELECT "     
SET @@SQL = @@SQL + " L.VNO,L.BOOKTYPE,L.VTYP, CLTCODE, ACNAME, VAMT = CASE L.DRCR WHEN 'D' THEN -VAMT ELSE VAMT END, NARRATION, DDNO,CONVERT(VARCHAR(10), DDDT, 111), BNKNAME,L1.Brnname,L1.micrno , CONVERT(VARCHAR(10), RELDT, 103),CONVERT(VARCHAR(10), VDT
, 103), L.LNO "          
SET @@SQL = @@SQL + " FROM "          
SET @@SQL = @@SQL + " LEDGER L, LEDGER1 L1 "          
SET @@SQL = @@SQL + " WHERE "          
SET @@SQL = @@SQL + " L.VNO = L1.VNO "          
SET @@SQL = @@SQL + " AND L.VTYP = L1.VTYP and L.VTYP = 3 "          
SET @@SQL = @@SQL + " AND L.BOOKTYPE = L1.BOOKTYPE "   
SET @@SQL = @@SQL + " AND L1.RELDT = '1900-01-01 00:00:00.000' AND "   
SET @@SQL = @@SQL + "   not exists ( "  
SET @@SQL = @@SQL + " Select b.bpvno from stalecheque_vlog b  where l.vno = b.bpvno and l.vtyp =b.bpvtype and  l.booktype = b.bpbooktype) "  
  
SET @@SQL = @@SQL + " AND vdt between '" + @Fdate + "' and  '"  +  @Tdate  + "'"  
SET @@SQL = @@SQL +   " and CLTCODE = '" + @BANKCODE + "' "  
SET @@SQL = @@SQL +   " and clear_mode <> 'C' "  
  
SET @@SQL = @@SQL + " select  TOP " + @PageSize + " A.VNO,A.BOOKTYPE,A.VTYP ,A.CLTCODE,A.ACNAME,A.VAMT,A.NARRATION,B.DDNO,B.DDDT,B.BNKNAME,B.RELDT,CONVERT(VARCHAR(10), A.VDT, 103) as VDT ,B.BRNNAME,B.MICRNO from ledger A,#GETDATA_EDIT B "  
SET @@SQL = @@SQL + " where A.VNO = B.VNO and A.VTYP = B.Vtype and A.BOOKTYPE = B.BOOKTYPE "  
  
If @VAMT <> 0  
BEGIN  
 SET @@SQL = @@SQL + " and  A.VAMT = " + CONVERT(VARCHAR, @VAMT)  
END  
  
If @DDNO <> ""   
BEGIN  
 SET @@SQL = @@SQL + " and DDNO = '" + @DDNO + "' "  
END  
  
If @CLTCODE <> ""   
BEGIN  
 SET @@SQL = @@SQL + " and A.CLTCODE =  '" + @CLTCODE + "' "  
END  
  SET @@SQL = @@SQL +  " and A.CLTCODE  <> B.CLTCODE "   
  
print @@SQL      
EXEC (@@SQL)   
  
DROP TABLE  #GETDATA_EDIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IMPORTOPENINGBAL
-- --------------------------------------------------

--EXEC IMPORTOPENINGBAL 'D:\BackOffice\OPENINGBALANE\OPENING.csv', 'ASHOKS'
CREATE PROC IMPORTOPENINGBAL
(  
      @FILENAME VARCHAR(500),  
      @UPLOADBY VARCHAR(100)  
)  
AS  
  
DECLARE     
      @@ERROR_COUNT INT  
  
BEGIN TRAN  
  
CREATE TABLE [#OPENING_BALANCE_LNO]    
(    
SNO INT ,    
LNO INT IDENTITY (1, 1) NOT NULL    
) ON [PRIMARY]    
  
UPDATE     
 V2_OPENING_BALANCE     
 SET    
                  BRANCHCODE = A.BRANCHCODE,  
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,     
  COSTCODE = C.COSTCODE    
      FROM ACMAST A, PARAMETER P, COSTMAST C        
      WHERE A.CLTCODE = V2_OPENING_BALANCE.CLTCODE     
      AND P.CURYEAR = 1     
      AND A.BRANCHCODE = C.COSTNAME    
  
UPDATE     
 V2_OPENING_BALANCE     
 SET    
                  BRANCHCODE = 'HO',  
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,     
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
      FROM ACMAST A, PARAMETER P  
      WHERE A.CLTCODE = V2_OPENING_BALANCE.CLTCODE     
      AND P.CURYEAR = 1     
      AND A.BRANCHCODE = 'ALL'  
  
  
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/   
  
      DECLARE     
            @@STD_DATE VARCHAR(11),    
            @@LST_DATE VARCHAR(11),    
            @@VNOMETHOD INT,     
            @@ACNAME CHAR(100),     
            @@BOOKTYPE CHAR(2),     
            @@MICRNO VARCHAR(10),    
            @@DRCR VARCHAR(1),    
            @@VTYP SMALLINT,  
            @@MONTHLYVDT  VARCHAR(11),  
            @@BACKDAYS SMALLINT,  
            @@BACKDATE VARCHAR(11)  
  
  
/* '--------------------------UPDATE OF COST CODE ------------------------*/   
  
UPDATE V2_OPENING_BALANCE   
 SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')   
WHERE COSTCODE IS NULL   
  
/*--------------------------VALIDATION FOR AMOUNT SHOLD NOT BE ZERO OR NEGATIVE------------------------*/    
  
SELECT @@ERROR_COUNT = COUNT(1) FROM  
         (SELECT AMOUNT   
 FROM V2_OPENING_BALANCE    
         WHERE AMOUNT <= 0) A  
  
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT 'VOUCHER AMOUNT CANNOT BE ZERO OR NEGATIVE.', 'NA', 'NA'     
  ROLLBACK TRAN     
  DELETE FROM V2_UPLOADED_FILES     
  WHERE U_FILENAME = @FILENAME AND U_MODULE = 'OPENING UPLOAD'     
  RETURN     
 END     
  
  
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/    
  
SELECT @@ERROR_COUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)    
 FROM V2_OPENING_BALANCE    
  
IF @@ERROR_COUNT <> 0      
 BEGIN      
  SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.', 'NA', 'NA'     
  ROLLBACK TRAN     
  DELETE FROM V2_UPLOADED_FILES     
  WHERE U_FILENAME = @FILENAME AND U_MODULE = 'OPENING UPLOAD'     
  RETURN     
 END     
  
/*-------------------------- VALIDATION FOR DUPLICATE CLIENT_CODES EXISTS IN FILE ---------------------*/  
SELECT @@ERROR_COUNT = COUNT(1) FROM  
(  
      SELECT CLTCODE   
      FROM V2_OPENING_BALANCE    
      GROUP BY CLTCODE  
      HAVING COUNT(CLTCODE) > 1  
) A  
  
IF @@ERROR_COUNT > 0     
 BEGIN     
  SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE DULICATED IN EXISTING FILE', 'NA', 'NA'    UNION ALL    
                  SELECT CLTCODE, 'NA', 'NA'      
                  FROM V2_OPENING_BALANCE    
                  GROUP BY CLTCODE  
                  HAVING COUNT(CLTCODE) > 1  
  ROLLBACK TRAN    
  DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FILENAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'    
  RETURN    
 END    
  
  
  
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/   
  
SELECT @@ERROR_COUNT = COUNT(1) FROM    
(    
 SELECT DISTINCT    
  CLTCODE    
 FROM V2_OPENING_BALANCE    
 WHERE UPDFLAG = 'N'    
) A    
  
  
        
IF @@ERROR_COUNT > 0     
 BEGIN     
  SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA', 'NA'    UNION ALL    
  SELECT DISTINCT   
   CLTCODE, 'NA', 'NA'       
  FROM V2_OPENING_BALANCE    
  WHERE UPDFLAG = 'N'    
  ROLLBACK TRAN    
  DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FILENAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'    
  RETURN    
 END    
  
DECLARE     
 @@NEWVNO AS VARCHAR(12),  
 @@VDT AS VARCHAR(11),     
 @@LNOCUR AS CURSOR,     
 @@LNOVNO AS INT     
  
  
/* '--------------------------AUTO GENERATION OF VNO ------------------------*/   
  
SELECT     
 @@STD_DATE = LEFT(SDTCUR, 11),     
 @@LST_DATE = LEFT(LDTCUR, 11),     
 @@VNOMETHOD = VNOFLAG     
FROM PARAMETER     
WHERE CURYEAR = 1     
  
SET @@NEWVNO = (SELECT CONVERT(VARCHAR,YEAR(@@STD_DATE)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@STD_DATE))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@STD_DATE))),2))+'0001'  
  
UPDATE    
 V2_OPENING_BALANCE     
 SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO))     
  
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/   
  
  INSERT INTO #OPENING_BALANCE_LNO    
   (SNO)    
  SELECT SNO FROM V2_OPENING_BALANCE   
  UPDATE RP    
   SET LNO = RL.LNO    
  FROM V2_OPENING_BALANCE RP, #OPENING_BALANCE_LNO RL    
  WHERE RP.SNO = RL.SNO    
DROP TABLE #OPENING_BALANCE_LNO    
  
/*---------------- DELETE EXISTING OPENING BALANCE ENTRY ---------------------------*/  
  
      DELETE FROM LEDGER WHERE VNO = @@NEWVNO AND VTYP = '18' AND BOOKTYPE = '01'  
      DELETE FROM LEDGER2 WHERE VNO = @@NEWVNO AND VTYPE = '18' AND BOOKTYPE = '01'  
  
  
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/    
/*==============================    
      LEDGER RECORD    
==============================*/    
INSERT     
INTO LEDGER     
SELECT     
 VTYP = '18',     
 VNO,     
 EDT,     
 LNO,    
 ACNAME,     
 DRCR,    
 VAMT = AMOUNT,     
 VDT,     
 VNO1 = VNO,     
 REFNO = 0,     
 BALAMT = (CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END),     
 NODAYS = 0,     
 CDT = GETDATE(),     
 CLTCODE,     
 BOOKTYPE = '01',     
 ENTEREDBY = @UPLOADBY,     
 PDT = GETDATE(),     
 CHECKEDBY = @UPLOADBY,     
 ACTNODAYS = 0,     
 NARRATION    
FROM     
 V2_OPENING_BALANCE     
  
INSERT INTO LEDGER2  
      SELECT   
            VTYP = '18',  
            VNO,  
            LNO,  
            DRCR,  
            AMOUNT,  
            COSTCODE,  
            BOOKTYPE = '01',  
            CLTCODE  
      FROM  
            V2_OPENING_BALANCE  
  
COMMIT TRAN   
SELECT 'DATA UPLOADED SUCCESSFULLY', 'NA','NA' AS RESULT UNION ALL   
SELECT CLTCODE, CONVERT(VARCHAR, AMOUNT) , VNO AS RESULT FROM V2_OPENING_BALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Index_GetIndexName
-- --------------------------------------------------
CREATE Proc Index_GetIndexName As  
Declare @TableName Varchar(100),  
@CurTbl Cursor,  
@Sql Varchar(150)  
  
Create Table #Tbl_Index  
(Sno Int IDENTITY (1, 1) NOT NULL,  
 IndexName Varchar(100) NOT NULL,  
 TableName Varchar(100) NOT NULL)  
  
Set @CurTbl = Cursor For  
Select Name From Sysobjects   
Where xType = 'U'  
Order By Name   
Open @CurTbl  
Fetch Next from  @CurTbl into @TableName  
While @@Fetch_Status = 0   
Begin  
 Insert Into #Tbl_Index  

      Select i.name, TableName=@TableName
      from (dbo.sysindexes i inner join
         dbo.sysfilegroups s on
         i.groupid = s.groupid )
      where id = object_id(@TableName) and i.indid > 0 and i.indid < 255 and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsStatistics') <> 1) and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsAutoStatistics') <> 1) and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsHypothetical') <> 1) 

   
 Fetch Next from  @CurTbl into @TableName  
End  
Close @CurTbl  
DeAllocate @CurTbl  
  
Select * From #Tbl_Index  
Order By TableName, IndexName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2
-- --------------------------------------------------

CREATE proc INSERTTOLEDGER2                         
(                      
      @SESSIONID VARCHAR(15),                        
      @VNO VARCHAR(12),                        
      @BRANCHFLAG TINYINT,                        
      @COSTCENTERFLAG TINYINT,                        
      @COSTENABLE CHAR(1),                        
      @STATUSID AS VARCHAR(30),                        
      @STATUSNAME AS VARCHAR(30)                        
)                       
                      
AS                        
                      
SET NOCOUNT ON                      
                      
DECLARE                        
      @@ONLYALL TINYINT,                        
      @@ONEBRANCH TINYINT,                        
      @@MULTIBRANCH TINYINT,                        
      @@ONEBRANCHALL TINYINT,                        
      @@MULTIBRANCHALL TINYINT,                        
      @@ALLCOUNT SMALLINT,                        
      @@BRANCHCOUNT SMALLINT,                        
      @@OLDBRANCH VARCHAR(10),                        
      @@VTYPE VARCHAR(2),                        
      @@PARTY2 VARCHAR(10),                        
      @@COSTBREAKUP TINYINT,                        
      @@COSTCODE1 INT,                        
                        
/*=======================================================================================                      
      FIELDS RETRIVED FROM TEMPLEDGER2                       
=======================================================================================*/                      
      @@CATEGORY VARCHAR(20),                        
      @@BRANCH VARCHAR(25),                        
      @@AMT    MONEY,                        
      @@VTYP VARCHAR(2),                        
      @@VNO  VARCHAR(12),                        
      @@LNO  INT,                        
      @@DRCR CHAR(1),                        
      @@COSTCODE SMALLINT,                        
      @@BOOKTYPE VARCHAR(2),                        
      @@SESSIONID VARCHAR(25),                        
      @@PARTY_CODE VARCHAR(10),                        
      @@MAINBR AS VARCHAR(10),                           
      @@RCURSOR AS CURSOR                        
                        
IF @BRANCHFLAG = 1 AND @COSTCENTERFLAG  = 1                        
BEGIN                        
/*=======================================================================================                      
      0 = TRUE   1 = FALSE                          
=======================================================================================*/                      
      SELECT @@ONLYALL = 0               /* TRUE */                        
      SELECT @@ONEBRANCH = 1             /* TRUE */                        
      SELECT @@MULTIBRANCH = 1           /* FALSE */                        
      SELECT @@ONEBRANCHALL = 1          /* FALSE */                        
      SELECT @@MULTIBRANCHALL = 1        /* FALSE */                        
                              
      SELECT @@ALLCOUNT = 0                        
      SELECT @@BRANCHCOUNT = 0                        
      SELECT @@OLDBRANCH = ''                        
                        
      SELECT @@MAINBR =                       
                  (                      
                        SELECT                       
                              BRANCHNAME                       
                        FROM BRANCHACCOUNTS                       
                        WHERE DEFAULTAC = 1                      
                  )                       
                        
      SELECT @@VTYPE =                       
                  (                      
                        SELECT DISTINCT                       
                              VTYPE                       
                        FROM TEMPLEDGER2                       
                        WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                              AND VNO = @VNO                      
                  )                       
                           
      SELECT @@COSTBREAKUP =                       
                  (                                            SELECT                       
                              COUNT(*)                       
                        FROM TEMPLEDGER2                 
                        WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                              AND CATEGORY = 'BRANCH'                       
                           AND VNO = @VNO                       
                              AND COSTFLAG = 'C'                      
                  )                       
                        
/*=======================================================================================                      
            IF @@VTYPE = 8 AND @@COSTBREAKUP > 0                        
      =======================================================================================*/                      
      IF @@COSTBREAKUP > 0                        
      BEGIN                        
            DELETE                       
   T1              
            FROM TEMPLEDGER2 T1                       
            WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
--                  AND UPPER(RTRIM(BRANCH)) = 'ALL'                       
                  AND VNO = @VNO                       
                  AND COSTFLAG = 'A'                       
                  AND EXISTS                       
                        (                       
                              SELECT DISTINCT                       
                    PARTY_CODE                       
                              FROM TEMPLEDGER2 T2              
                              WHERE COSTFLAG = 'C'                       
    AND T1.PARTY_CODE = T2.PARTY_CODE              
    AND T1.LNO = T2.LNO            
                        )                       
    --IF @@VTYPE <> 3 AND @@VTYPE <> 8                        
            UPDATE                       
     TEMPLEDGER2                       
                  SET COSTFLAG = 'A'             
          
    /*IF @@VTYPE = 8                 
    BEGIN          
   UPDATE TEMPLEDGER2 SET COSTFLAG = 'C', COSTCODE = C.COSTCODE          
   FROM COSTMAST C, ACMAST A          
   WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID) AND VNO = @VNO AND COSTFLAG = 'A' AND UPPER(RTRIM(BRANCH)) <> 'ALL'  
   AND TEMPLEDGER2.PARTY_CODE = A.CLTCODE AND BRANCHCODE <> 'ALL'  
   AND UPPER(RTRIM(TEMPLEDGER2.BRANCH)) = UPPER(RTRIM(COSTNAME))          
    END        */  
                  
     IF @@VTYPE = 5 OR @@VTYPE = 6 OR @@VTYPE = 7 OR @@VTYPE = 8 OR @@VTYPE = 24                        
     BEGIN                        
           UPDATE                       
                 TEMPLEDGER2                       
                 SET BRANCH = 'HO'                       
           WHERE UPPER(RTRIM(BRANCH)) = 'ALL'                       
                 AND COSTFLAG = 'A'                      
   AND VNO = @VNO                     
     END                        
      END                        
                        
      SET @@RCURSOR = CURSOR FOR                        
            SELECT                       
                  CATEGORY,                      
                  BRANCH,                      
                  PAIDAMT,                      
                  VTYPE,                      
                  VNO,                      
                  LNO,                      
                  DRCR,                      
                  COSTCODE,                      
                  BOOKTYPE,                      
                  SESSIONID,                      
                  PARTY_CODE                       
            FROM TEMPLEDGER2                       
            WHERE CATEGORY = 'BRANCH'                       
                  AND RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND VNO =@VNO               
                  AND COSTFLAG = 'A'                       
      OPEN @@RCURSOR                        
      FETCH NEXT FROM @@RCURSOR                         
      INTO @@CATEGORY, @@BRANCH, @@AMT, @@VTYP, @@VNO, @@LNO, @@DRCR, @@COSTCODE, @@BOOKTYPE, @@SESSIONID , @@PARTY_CODE                         
                        
      WHILE @@FETCH_STATUS = 0                        
      BEGIN                        
            IF RTRIM(@@BRANCH) = 'ALL'                        
            BEGIN                        
                  SELECT @@ALLCOUNT = @@ALLCOUNT + 1                        
            END                        
            ELSE                    
            IF RTRIM(@@BRANCH) = @@OLDBRANCH                        
            BEGIN                        
                  SELECT @@ONLYALL = 1                        
            END                        
            ELSE                        
            IF @@OLDBRANCH = ''                        
            BEGIN                        
            SELECT @@ONLYALL = 1                        
                  SELECT @@OLDBRANCH = RTRIM(@@BRANCH)                        
                  SELECT @@BRANCHCOUNT = @@BRANCHCOUNT + 1                        
            END                        
            ELSE                         
            BEGIN                        
                  SELECT @@ONLYALL = 1                        
    SELECT @@BRANCHCOUNT = @@BRANCHCOUNT + 1                        
                  SELECT @@MULTIBRANCH = 0                        
                  SELECT @@ONEBRANCH = 1                                   
            END                        
                                  
            FETCH NEXT FROM @@RCURSOR                   
         INTO @@CATEGORY, @@BRANCH, @@AMT, @@VTYP, @@VNO, @@LNO, @@DRCR, @@COSTCODE, @@BOOKTYPE, @@SESSIONID , @@PARTY_CODE                         
      END                        
      CLOSE @@RCURSOR                        
      DEALLOCATE @@RCURSOR                        
                        
/*      SELECT "ALLCOUNT = " + CONVERT(VARCHAR,@@ALLCOUNT)                        
      SELECT "BRANCHCOUNT = " + CONVERT(VARCHAR,@@BRANCHCOUNT)  */                      
                        
      IF @@ONLYALL = 1                        
      BEGIN                        
            IF @@ALLCOUNT = 0                        
            BEGIN                        
                  IF @@BRANCHCOUNT = 1                        
                  BEGIN                        
                        SELECT @@ONEBRANCH = 0                        
                        SELECT @@MULTIBRANCH = 1                        
                        SELECT @@ONEBRANCHALL = 1                        
                        SELECT @@MULTIBRANCHALL = 1                        
                  END                        
                  ELSE                        
                  BEGIN                        
                        SELECT @@MULTIBRANCH = 0                        
                        SELECT @@ONEBRANCH = 1                        
                        SELECT @@ONEBRANCHALL = 1                        
                        SELECT @@MULTIBRANCHALL = 1                        
                  END                        
            END                        
            ELSE                        
            BEGIN                        
                  IF @@BRANCHCOUNT = 1                        
                  BEGIN                        
                        SELECT @@ONEBRANCHALL = 0                        
                        SELECT @@ONEBRANCH = 1                        
                        SELECT @@MULTIBRANCH = 1                        
           SELECT @@MULTIBRANCHALL = 1                        
                  END                        
                  ELSE                        
                  BEGIN                        
                        SELECT @@MULTIBRANCHALL = 0                        
                        SELECT @@ONEBRANCH = 1                        
                        SELECT @@MULTIBRANCH = 1                        
                        SELECT @@ONEBRANCHALL = 1                        
                  END                        
            END                        
      END                       
                        
      IF @@ONLYALL = 0                         
      BEGIN                        
            SELECT      
                  @@VTYPE =                       
                        (                      
                              SELECT DISTINCT                       
                                    VTYPE                       
                              FROM TEMPLEDGER2                       
                              WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                                    AND VNO = @VNO                      
                     )                       
SELECT                       
                  @@PARTY2 =                       
                        (                      
                              SELECT DISTINCT                       
                                    PARTY_CODE                       
                              FROM TEMPLEDGER2                       
                              WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                                    AND UPPER(RTRIM(BRANCH)) = 'ALL'                       
                                    AND VNO = @VNO                       
                                    AND COSTFLAG = 'A'                       
                                    AND LNO = 1                      
                        )                       
            SELECT                       
                  @@COSTBREAKUP =                       
                        (                      
                              SELECT                       
                                    COUNT(*)           
                              FROM TEMPLEDGER2                       
                              WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                                    AND CATEGORY = 'BRANCH'                       
                                    AND VNO = @VNO            
                           AND COSTFLAG = 'C'                      
                        )                       
                            
            IF @@COSTBREAKUP > 0 AND (@@VTYPE = '3' OR @@VTYPE = '4')                         
            BEGIN                        
                  DELETE                       
                  FROM TEMPLEDGER2                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND CATEGORY = 'BRANCH'                       
                        AND UPPER(BRANCH) = 'ALL'                       
                  AND VNO = @VNO                       
                        AND COSTFLAG = 'A'                       
                            
              /*    DELETE                       
                  FROM TEMPLEDGER2                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND CATEGORY = 'BRANCH'                       
                        AND UPPER(DRCR) = 'C'                       
                        AND VNO = @VNO                       
                        AND COSTFLAG = 'C'             */          
                            
                  INSERT                   
                  INTO TEMPLEDGER2                       
                  SELECT                       
                        CATEGORY,                       
                        BRANCH,                       
                        PAIDAMT,                       
                        VTYPE,                       
                        VNO,      
                        1,                       
                        (                       
                              CASE                       
                                    WHEN DRCR = 'D'                       
                                    THEN 'C'                       
                                    ELSE 'D'                       
                              END                      
                ),                       
                        COSTCODE,                       
                        BOOKTYPE,                       
                        SESSIONID,           
                        @@PARTY2,                       
                        COSTFLAG,                       
                        1                       
                  FROM TEMPLEDGER2                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND CATEGORY = 'BRANCH'                       
                        AND VNO = @VNO                       
            END                        
            IF @@COSTBREAKUP > 0 AND (@@VTYPE = '1' OR @@VTYPE = '2' )                        
            BEGIN                        
             DELETE                       
                  FROM TEMPLEDGER2                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND CATEGORY = 'BRANCH'                       
                        AND UPPER(BRANCH) = 'ALL'                       
                        AND VNO = @VNO                       
                        AND COSTFLAG = 'A'                       
                            
                  DELETE                       
                  FROM TEMPLEDGER2                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
        AND CATEGORY = 'BRANCH'                       
              AND UPPER(DRCR) = 'D'                       
                        AND VNO = @VNO                       
                        AND COSTFLAG = 'C'                       
                            
                  INSERT                       
                  INTO TEMPLEDGER2                       
                  SELECT                       
                        CATEGORY,                       
                        BRANCH,                       
                        PAIDAMT,                       
                        VTYPE,                       
                        VNO,                       
                        1,                       
   (                       
                              CASE                       
                                    WHEN DRCR = 'D'                       
                                    THEN 'C'                       
                                    ELSE 'D'                       
  END                      
                        ),                       
                        COSTCODE,                       
                        BOOKTYPE,                       
                        SESSIONID,                       
                        @@PARTY2,                       
                        COSTFLAG,                       
                        1                       
                  FROM TEMPLEDGER2                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND CATEGORY = 'BRANCH'                       
                        AND VNO = @VNO                       
            END                        
      END                        
                        
                        
      IF @@ONLYALL = 0                     
      BEGIN                         
            IF @STATUSID = 'BRANCH'                         
            BEGIN                        
                  INSERT                       
                  INTO LEDGER2                       
           SELECT                       
                        VTYPE,                       
                        VNO,                       
                        LNO,                       
                        DRCR,                       
                        PAIDAMT,                       
                        C.COSTCODE,                       
                        BOOKTYPE,                      
                        UPPER(PARTY_CODE)                       
                  FROM TEMPLEDGER2 T,                       
                        COSTMAST C                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND RTRIM(COSTNAME) = RTRIM(@STATUSNAME)       
                        AND CATEGORY = 'BRANCH'                       
                        AND VNO =@VNO                       
                        AND COSTFLAG = 'A'                       
            END                        
            ELSE                        
            BEGIN                        
                  INSERT                       
                  INTO LEDGER2                       
                  SELECT                       
                        VTYPE,                       
                        VNO,                       
                        LNO,                       
                        DRCR,                       
                        PAIDAMT,                       
                        C.COSTCODE,        
                        BOOKTYPE,                      
                        UPPER(PARTY_CODE)                       
     FROM TEMPLEDGER2 T,                       
                        BRANCHACCOUNTS B,                       
                        COSTMAST C                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND DEFAULTAC = 1                       
                        AND RTRIM(BRANCHNAME) = RTRIM(COSTNAME)                       
                        AND CATEGORY = 'BRANCH'                       
                        AND VNO =@VNO                       
                        AND COSTFLAG = 'A'                       
            END                        
      END                        
      ELSE                        
      IF @@ONEBRANCH = 0                        
      BEGIN                        
            INSERT                       
            INTO LEDGER2                       
            SELECT                       
                  VTYPE,                       
                  VNO,                       
                  LNO,                       
            DRCR,                       
                  PAIDAMT,                       
                  C.COSTCODE,                       
                  BOOKTYPE,                       
                  UPPER(PARTY_CODE )                       
            FROM TEMPLEDGER2 T,                       
                  COSTMAST C                       
            WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND RTRIM(BRANCH) = RTRIM(COSTNAME)                       
                  AND CATEGORY = 'BRANCH'                       
  AND VNO =@VNO                       
                 AND COSTFLAG = 'A'                       
      END                        
      ELSE                        
      IF @@MULTIBRANCH = 0                        
      BEGIN                        
            INSERT                       
       INTO LEDGER2                       
            SELECT                       
                  VTYPE,                       
                  VNO,                       
                  LNO,                       
                  DRCR,                       
                  PAIDAMT,                       
          C.COSTCODE,                       
              BOOKTYPE,                       
                  UPPER(PARTY_CODE)            
            FROM TEMPLEDGER2 T,                       
                  COSTMAST C                       
            WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND RTRIM(BRANCH) = RTRIM(COSTNAME)                       
                  AND CATEGORY = 'BRANCH'                       
                  AND VNO =@VNO                       
                  AND COSTFLAG = 'A'                       
                            
            INSERT                       
            INTO LEDGER2                       
            SELECT                       
                  VTYPE,                       
                  VNO,                       
                  LNO,                       
                  DRCR,                       
                  PAIDAMT,                       
                  COSTCODE=                       
 (                       
                              SELECT                       
                                    COSTCODE                       
                              FROM COSTMAST C,                       
                                    BRANCHACCOUNTS B                       
                    WHERE DEFAULTAC = 1                       
                                    AND RTRIM(BRANCHNAME) = RTRIM(COSTNAME)                      
                        ),                       
                  BOOKTYPE,                       
                  UPPER(BRCONTROLAC)                       
            FROM TEMPLEDGER2 T,                       
                  BRANCHACCOUNTS B                       
            WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND RTRIM(BRANCH) = RTRIM(BRANCHNAME)                       
                  AND CATEGORY = 'BRANCH'                 
                  AND VNO =@VNO                       
                  AND COSTFLAG = 'A'                       
                  AND RTRIM(BRANCH) <> RTRIM(@@MAINBR)                       
                            
            INSERT                       
            INTO LEDGER2                       
            SELECT                       
                  VTYPE,                       
                  VNO,                       
                  LNO,                       
                  (                       
                        CASE                       
                              WHEN DRCR= 'D'                       
                              OR DRCR = 'D'                       
                              THEN 'C'                       
                              ELSE 'D'                       
                        END                      
                  ),                       
                  PAIDAMT,                       
                  C.COSTCODE,                       
              BOOKTYPE,                       
                  UPPER(MAINCONTROLAC)                       
            FROM TEMPLEDGER2 T,                       
                COSTMAST C,                       
                  BRANCHACCOUNTS B                       
            WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND RTRIM(BRANCH) = RTRIM(COSTNAME)                       
                  AND RTRIM(BRANCHNAME) = RTRIM(BRANCH)                       
                  AND CATEGORY = 'BRANCH'                       
                  AND VNO =@VNO                       
                  AND COSTFLAG = 'A'                       
                  AND RTRIM(BRANCH) <> RTRIM(@@MAINBR)                       
      END                        
      ELSE                        
      IF @@ONEBRANCHALL = 0                         
      BEGIN                        
      SET @@RCURSOR = CURSOR FOR                        
            SELECT                       
                  BRANCH                       
            FROM TEMPLEDGER2                    
            WHERE CATEGORY = 'BRANCH'      
                  AND RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND VNO = @VNO                       
                  AND BRANCH <> 'ALL'                       
      AND COSTFLAG = 'A'                
            ORDER BY BRANCH                    
            OPEN @@RCURSOR                        
            FETCH NEXT FROM @@RCURSOR INTO @@BRANCH                         
            WHILE @@FETCH_STATUS = 0                        
            BEGIN                        
            SELECT @@COSTCODE1 =                       
                        (                       
                              SELECT                       
                                    COSTCODE                       
                              FROM COSTMAST                       
                              WHERE RTRIM(@@BRANCH) = RTRIM(COSTNAME)                      
                        )                       
                  FETCH NEXT FROM @@RCURSOR INTO @@BRANCH                         
                  END                        
                  CLOSE @@RCURSOR                        
                  DEALLOCATE @@RCURSOR                        
                                  
                  INSERT                       
                  INTO LEDGER2                       
                  SELECT                       
                        VTYPE,                       
               VNO,                       
                        LNO,                       
                        DRCR,                       
                        PAIDAMT,                       
                        C.COSTCODE,                       
             BOOKTYPE,                       
          UPPER(PARTY_CODE)                       
                  FROM TEMPLEDGER2 T,                       
                        COSTMAST C                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND RTRIM(BRANCH) = RTRIM(COSTNAME)                       
                        AND CATEGORY = 'BRANCH'                  
                        AND VNO =@VNO                       
                        AND COSTFLAG = 'A'                       
                                  
                  INSERT                       
                  INTO LEDGER2                       
                  SELECT                       
                        VTYPE,                       
                        VNO,                       
                        LNO,                       
                        DRCR,                       
                        PAIDAMT,                       
                        @@COSTCODE1,                       
              BOOKTYPE,                       
                        UPPER(PARTY_CODE)                       
                  FROM TEMPLEDGER2 T                       
                  WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                        AND RTRIM(BRANCH) = 'ALL'                       
                        AND CATEGORY = 'BRANCH'                       
                        AND VNO =@VNO                       
AND COSTFLAG = 'A'                       
            END                        
      END         
                        
      IF @COSTCENTERFLAG  = 1                        
      BEGIN                        
            INSERT                       
            INTO LEDGER2                       
            SELECT                       
                  VTYPE,                       
                  @VNO,                       
                  LNO,                       
                  DRCR,                       
                  PAIDAMT,                       
                  COSTCODE,                       
                  BOOKTYPE,                      
                  UPPER(PARTY_CODE )                       
            FROM TEMPLEDGER2 T                       
     WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)                       
                  AND VNO = @VNO                       
                  AND COSTFLAG = 'C'                       
      END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IPO_CHECKLEDBAL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[IPO_CHECKLEDBAL]      
(      
      @DTBAL VARCHAR (3),        
      @FPARTY VARCHAR (10),         
      @USER VARCHAR (25),  
      @BALAMT money output,  
      @ERRORCODE int output  
)      
      
AS          
        
CREATE TABLE [#MPO_LEDGERBALANCE_UP] (    
 [MPO_PARTYCODE] [VARCHAR] (10) NOT NULL ,    
 [MPO_PARTYNAME] [VARCHAR] (100) NULL ,    
 [MPO_EXCHANGE] [VARCHAR] (3) NOT NULL ,    
 [MPO_SEGMENT] [VARCHAR] (20) NOT NULL ,    
 [MPO_LEDGERBAL] [MONEY] NOT NULL ,    
 [MPO_RUNBY] [VARCHAR] (25) NOT NULL ,    
 [MPO_RUNDATE] [DATETIME] NOT NULL ,    
 [MPO_STATUS] [CHAR] (1) NOT NULL ,    
 [MPO_CALCBY] [CHAR] (3) NOT NULL ,    
 [MPO_BRANCHCODE] [VARCHAR] (20) NULL     
) ON [PRIMARY]    
      
IF @DTBAL = 'VDT'        
BEGIN        
      ------------------------------------------------------------------------------------------      
      --POPULATING NSE CASH SEGMENT LEDGER BALANCES      
      ------------------------------------------------------------------------------------------      
      INSERT INTO       
            #MPO_LEDGERBALANCE_UP        
      SELECT       
            MPO_PARTYCODE = L.CLTCODE,      
            MPO_PARTYNAME = A.LONGNAME,      
            MPO_EXCHANGE = 'NSE',      
            MPO_SEGMENT = 'CAPITAL',      
            MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
            MPO_RUNBY = @USER,      
            MPO_RUNDATE = GETDATE(),      
            MPO_STATUS = 'I',      
            MPO_CALCBY = @DTBAL,      
            MPO_BRANCHCODE = A.BRANCHCODE       
      FROM       
            ACCOUNT..LEDGER L,      
            ACCOUNT..ACMAST A,       
            ACCOUNT..PARAMETER P      
      WHERE       
            L.VDT >= SDTCUR       
            AND L.VDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:00'      
            AND L.CLTCODE = @FPARTY     
            AND L.CLTCODE = A.CLTCODE      
            AND A.ACCAT = 4      
            AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
      GROUP BY       
            L.CLTCODE, A.LONGNAME, A.BRANCHCODE      
            
      ------------------------------------------------------------------------------------------      
      --POPULATING BSE CASH SEGMENT LEDGER BALANCES      
      ------------------------------------------------------------------------------------------      
      INSERT INTO       
            #MPO_LEDGERBALANCE_UP        
      SELECT       
            MPO_PARTYCODE = L.CLTCODE,      
            MPO_PARTYNAME = A.LONGNAME,      
            MPO_EXCHANGE = 'BSE',      
            MPO_SEGMENT = 'CAPITAL',      
            MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
            MPO_RUNBY = @USER,      
            MPO_RUNDATE = GETDATE(),      
            MPO_STATUS = 'I',      
            MPO_CALCBY = @DTBAL,      
            MPO_BRANCHCODE = A.BRANCHCODE       
      FROM       
            ACCOUNTBSE..LEDGER  L,      
            ACCOUNTBSE..ACMAST A,       
            ACCOUNTBSE..PARAMETER P      
      WHERE       
            L.VDT >= SDTCUR       
            AND L.VDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:00'      
            AND L.CLTCODE = @FPARTY     
            AND L.CLTCODE = A.CLTCODE      
            AND A.ACCAT = 4      
            AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
      GROUP BY       
            L.CLTCODE, A.LONGNAME, A.BRANCHCODE      
            
      ------------------------------------------------------------------------------------------      
      --POPULATING NSE DERIVATIVES SEGMENT LEDGER BALANCES      
      ------------------------------------------------------------------------------------------      
 /*
     INSERT INTO       
            #MPO_LEDGERBALANCE_UP        
      SELECT       
            MPO_PARTYCODE = L.CLTCODE,      
            MPO_PARTYNAME = A.LONGNAME,      
            MPO_EXCHANGE = 'NSE',      
            MPO_SEGMENT = 'FUTURES',      
            MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
            MPO_RUNBY = @USER,      
            MPO_RUNDATE = GETDATE(),      
            MPO_STATUS = 'I',      
            MPO_CALCBY = @DTBAL,      
            MPO_BRANCHCODE = A.BRANCHCODE       
      FROM       
            ACCOUNTFO..LEDGER  L,      
            ACCOUNTFO..ACMAST A,       
            ACCOUNTFO..PARAMETER P      
      WHERE       
            L.VDT >= SDTCUR       
            AND L.VDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:00'      
            AND L.CLTCODE = @FPARTY     
            AND L.CLTCODE = A.CLTCODE      
            AND A.ACCAT = 4      
            AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
      GROUP BY       
            L.CLTCODE, A.LONGNAME, A.BRANCHCODE      
*/
END  --FOR VDT WISE COMPUTATION      
ELSE       
BEGIN  --FOR EDT WISE COMPUTATION      
      ------------------------------------------------------------------------------------------      
      --POPULATING NSE CASH SEGMENT LEDGER BALANCES @EDT      
      ------------------------------------------------------------------------------------------      
      INSERT INTO       
            #MPO_LEDGERBALANCE_UP        
      SELECT       
            MPO_PARTYCODE = L.CLTCODE,      
            MPO_PARTYNAME = A.LONGNAME,      
            MPO_EXCHANGE = 'NSE',      
            MPO_SEGMENT = 'CAPITAL',      
            MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
            MPO_RUNBY = @USER,      
            MPO_RUNDATE = GETDATE(),      
            MPO_STATUS = 'I',      
            MPO_CALCBY = @DTBAL,      
            MPO_BRANCHCODE = A.BRANCHCODE       
      FROM       
            ACCOUNT..LEDGER  L,      
            ACCOUNT..ACMAST A,       
            ACCOUNT..PARAMETER P      
      WHERE       
            L.VDT >= SDTCUR       
            AND L.EDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:00'      
            AND L.CLTCODE = @FPARTY     
            AND L.CLTCODE = A.CLTCODE      
            AND A.ACCAT = 4      
            AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
      GROUP BY       
            L.CLTCODE, A.LONGNAME, A.BRANCHCODE      
            
      ------------------------------------------------------------------------------------------      
      --POPULATING BSE CASH SEGMENT LEDGER BALANCES @EDT      
      ------------------------------------------------------------------------------------------      
      INSERT INTO       
            #MPO_LEDGERBALANCE_UP        
      SELECT       
            MPO_PARTYCODE = L.CLTCODE,      
            MPO_PARTYNAME = A.LONGNAME,      
            MPO_EXCHANGE = 'BSE',      
            MPO_SEGMENT = 'CAPITAL',      
            MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
            MPO_RUNBY = @USER,      
            MPO_RUNDATE = GETDATE(),      
            MPO_STATUS = 'I',      
            MPO_CALCBY = @DTBAL,      
            MPO_BRANCHCODE = A.BRANCHCODE       
      FROM       
            ACCOUNTBSE..LEDGER  L,      
            ACCOUNTBSE..ACMAST A,       
            ACCOUNTBSE..PARAMETER P      
      WHERE       
            L.VDT >= SDTCUR       
            AND L.EDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:00'      
            AND L.CLTCODE = @FPARTY     
            AND L.CLTCODE = A.CLTCODE      
            AND A.ACCAT = 4      
            AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
      GROUP BY       
            L.CLTCODE, A.LONGNAME, A.BRANCHCODE      
            
      ------------------------------------------------------------------------------------------      
      --POPULATING NSE DERIVATIVES SEGMENT LEDGER BALANCES @EDT      
      ------------------------------------------------------------------------------------------      
/*   
   INSERT INTO       
            #MPO_LEDGERBALANCE_UP        
      SELECT       
            MPO_PARTYCODE = L.CLTCODE,      
            MPO_PARTYNAME = A.LONGNAME,      
            MPO_EXCHANGE = 'NSE',      
            MPO_SEGMENT = 'FUTURES',      
            MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
            MPO_RUNBY = @USER,      
            MPO_RUNDATE = GETDATE(),      
            MPO_STATUS = 'I',      
            MPO_CALCBY = @DTBAL,      
            MPO_BRANCHCODE = A.BRANCHCODE       
      FROM       
            ACCOUNTFO..LEDGER  L,      
            ACCOUNTFO..ACMAST A,       
            ACCOUNTFO..PARAMETER P      
      WHERE       
            L.VDT >= SDTCUR       
            AND L.EDT <= LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:00'      
            AND L.CLTCODE = @FPARTY     
            AND L.CLTCODE = A.CLTCODE      
            AND A.ACCAT = 4      
            AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
      GROUP BY       
            L.CLTCODE, A.LONGNAME, A.BRANCHCODE      
 */     
      
      IF @DTBAL = 'FDT'  --FOR FUTURE DATED DEBIT AFTER NETTING INTRA-DAY      
      BEGIN      
            ---------------------------------------------------------------------------------------------------------------------      
            --POPULATING NSE CASH SEGMENT LEDGER BALANCES FOR FUTURE DATE DEBITS AFTER NETTING INTRA-DAY      
            ---------------------------------------------------------------------------------------------------------------------      
            INSERT INTO       
                  #MPO_LEDGERBALANCE_UP        
            SELECT       
                  MPO_PARTYCODE = L.CLTCODE,      
                  MPO_PARTYNAME = A.LONGNAME,      
                  MPO_EXCHANGE = 'NSE',      
                  MPO_SEGMENT = 'CAPITAL',      
                  MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
                  MPO_RUNBY = @USER,      
                  MPO_RUNDATE = LEFT(CONVERT(VARCHAR,L.EDT,109),11),      
                  MPO_STATUS = 'I',      
                  MPO_CALCBY = @DTBAL,      
                  MPO_BRANCHCODE = A.BRANCHCODE       
            FROM       
                  ACCOUNT..LEDGER  L,      
                  ACCOUNT..ACMAST A,       
                  ACCOUNT..PARAMETER P      
            WHERE       
                  L.EDT > LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:59'       
                  AND L.VDT <= LDTCUR      
                  AND L.CLTCODE = @FPARTY     
                  AND L.CLTCODE = A.CLTCODE      
                  AND A.ACCAT = 4      
                  AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
            GROUP BY       
                  L.CLTCODE, A.LONGNAME, A.BRANCHCODE, LEFT(CONVERT(VARCHAR,L.EDT,109),11)      
            HAVING SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END) < 0      
   
            ---------------------------------------------------------------------------------------------------------------------      
            --POPULATING BSE CASH SEGMENT LEDGER BALANCES FOR FUTURE DATE DEBITS AFTER NETTING INTRA-DAY      
            ---------------------------------------------------------------------------------------------------------------------      
            INSERT INTO       
                  #MPO_LEDGERBALANCE_UP        
            SELECT       
                  MPO_PARTYCODE = L.CLTCODE,      
                  MPO_PARTYNAME = A.LONGNAME,      
                  MPO_EXCHANGE = 'BSE',      
                  MPO_SEGMENT = 'CAPITAL',      
                  MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
                  MPO_RUNBY = @USER,      
                  MPO_RUNDATE = LEFT(CONVERT(VARCHAR,L.EDT,109),11),      
                  MPO_STATUS = 'I',      
                  MPO_CALCBY = @DTBAL,      
                  MPO_BRANCHCODE = A.BRANCHCODE       
            FROM       
                  ACCOUNTBSE..LEDGER  L,      
                  ACCOUNTBSE..ACMAST A,       
                  ACCOUNTBSE..PARAMETER P      
            WHERE       
                  L.EDT > LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:59'       
                  AND L.VDT <= LDTCUR      
                  AND L.CLTCODE = @FPARTY     
                  AND L.CLTCODE = A.CLTCODE      
                  AND A.ACCAT = 4      
                  AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
            GROUP BY       
                  L.CLTCODE, A.LONGNAME, A.BRANCHCODE, LEFT(CONVERT(VARCHAR,L.EDT,109),11)      
            HAVING SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END) < 0      
      
            ---------------------------------------------------------------------------------------------------------------------      
            --POPULATING NSE DERIVATIVE SEGMENT LEDGER BALANCES FOR FUTURE DATE DEBITS AFTER NETTING INTRA-DAY      
            ---------------------------------------------------------------------------------------------------------------------      
/*  
          INSERT INTO       
                  #MPO_LEDGERBALANCE_UP        
            SELECT       
                  MPO_PARTYCODE = L.CLTCODE,      
                  MPO_PARTYNAME = A.LONGNAME,      
                  MPO_EXCHANGE = 'NSE',      
                  MPO_SEGMENT = 'FUTURES',      
                  MPO_LEDGERBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END),      
                  MPO_RUNBY = @USER,      
                  MPO_RUNDATE = LEFT(CONVERT(VARCHAR,L.EDT,109),11),      
                  MPO_STATUS = 'I',      
                  MPO_CALCBY = @DTBAL,      
                  MPO_BRANCHCODE = A.BRANCHCODE       
            FROM       
                  ACCOUNTFO..LEDGER  L,      
                  ACCOUNTFO..ACMAST A,       
                  ACCOUNTFO..PARAMETER P      
            WHERE       
                  L.EDT > LEFT(CONVERT(VARCHAR,GETDATE(),109),11) + ' 23:59:59'       
                  AND L.VDT <= LDTCUR      
                  AND L.CLTCODE = @FPARTY     
                  AND L.CLTCODE = A.CLTCODE      
                  AND A.ACCAT = 4      
                  AND GETDATE() BETWEEN SDTCUR AND LDTCUR      
            GROUP BY       
                  L.CLTCODE, A.LONGNAME, A.BRANCHCODE, LEFT(CONVERT(VARCHAR,L.EDT,109),11)      
            HAVING SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE - VAMT END) < 0      
*/ 
     END --FOR FUTURE DATED DEBIT AFTER NETTING INTRA-DAY      
END    --FOR EDT WISE COMPUTATION      
      
-----------------------------------------------------------------------------------------------------------------------      
--POPULATING DATA IN THE MAIN MONEY PAYOUT LEDGER BALANCE TABLE FOR GIVEN PARTY RANGE AFTER DELETING      
-----------------------------------------------------------------------------------------------------------------------      
      
SELECT       
      --MPO_PARTYCODE,      
      --MPO_PARTYNAME = MAX(MPO_PARTYNAME),      
      --MPO_LEDGERBAL = SUM(MPO_LEDGERBAL),      
      --MPO_RUNDATE = GETDATE(),     
      --MPO_RUNBY = @USER     
 @BALAMT = isnull(SUM(MPO_LEDGERBAL),0)  
FROM       
      #MPO_LEDGERBALANCE_UP      
GROUP BY       
      MPO_PARTYCODE    
  
  
SET @BALAMT = ISNULL(@balamt,0)  
set @errorcode = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IPO_POSTBIDDINGAMOUNT
-- --------------------------------------------------
CREATE PROC [dbo].[IPO_POSTBIDDINGAMOUNT](
           @Cltcode       VARCHAR(10),
           @Vamt          MONEY,
           @Enteredby     VARCHAR(20),
           @Acname        VARCHAR(100),
           @Narration     VARCHAR(234),
           @Sessionid     VARCHAR(100),
           @Branchname    CHAR(10),
           @Costflag      VARCHAR(1),
           @Costrowid     INT,
           @IpoCtrlCode   VARCHAR(10),
           @IpoCtrlAcname VARCHAR(100))

AS

  SET NOCOUNT ON
  
  DECLARE  @VDT       VARCHAR(11),
           @SDTCUR    VARCHAR(11),
           @LDTCUR    VARCHAR(11),
           @VNO       VARCHAR(12),
           @ENTEREDAT DATETIME
                      
  SELECT @ENTEREDAT = GETDATE()
                      
  SELECT @VDT = LEFT(GETDATE(),11),
         @SDTCUR = LEFT(SDTCUR,11),
         @LDTCUR = LEFT(LDTCUR,11)
  FROM   PARAMETER
  WHERE  GETDATE() BETWEEN SDTCUR AND LDTCUR
                                      
  CREATE TABLE #VNO (
    VNO VARCHAR(12))
  
  INSERT INTO #VNO
  EXEC ACC_GENVNO_NEW
    @VDT ,
    '55' ,
    '01' ,
    @SDTCUR ,
    @LDTCUR
    
  SELECT TOP 1 @VNO = VNO
  FROM   #VNO
         
  BEGIN TRAN
  
  EXEC NEWACMULTIINSERT
    @Vtyp = 55 ,
    @Booktype = '01' ,
    @VNO = @VNO,
    @Lno = 1 ,
    @Vdt = @VDT ,
    @Edt = @VDT ,
    @Cltcode = @Cltcode ,
    @Drcr = 'D' ,
    @Vamt = @Vamt ,
    @Enteredby = @Enteredby ,
    @Cdt = @ENTEREDAT ,
    @Checkedby = @Enteredby ,
    @Pdt = @ENTEREDAT ,
    @Acname = @Acname ,
    @Narration = @Narration ,
    @Chequeinname = '' ,
    @Chqprinted = 0 ,
    @Accat = '4' ,
    @Bnkname = '' ,
    @Brnname = '' ,
    @Dd = '' ,
    @Ddno = '' ,
    @Dddt = '' ,
    @Reldt = '' ,
    @Relamt = @Vamt ,
    @Micrno = '' ,
    @Sessionid = @Sessionid ,
    @Branchname = @Branchname ,
    @Costflag = @Costflag ,
    @Costrowid = @Costrowid ,
    @Clearingmode = '' ,
    @Emode = 'A'
             
  EXEC NEWACMULTIINSERT
    @Vtyp = 55 ,
    @Booktype = '01' ,
    @VNO = @VNO ,
    @Lno = 2 ,
    @VDT = @VDT ,
    @EDT = @VDT ,
    @Cltcode = @IpoCtrlCode ,
    @Drcr = 'C' ,
    @Vamt = @Vamt ,
    @Enteredby = @Enteredby ,
    @Cdt = @ENTEREDAT ,
    @Checkedby = @Enteredby ,
    @Pdt = @ENTEREDAT ,
    @Acname = @IpoCtrlAcname ,
    @Narration = @Narration ,
    @Chequeinname = '' ,
    @Chqprinted = 0 ,
    @Accat = '3' ,
    @Bnkname = '' ,
    @Brnname = '' ,
    @Dd = '' ,
    @Ddno = '' ,
    @Dddt = '' ,
    @Reldt = '' ,
    @Relamt = @Vamt ,
    @Micrno = '' ,
    @Sessionid = @Sessionid ,
    @Branchname = 'ALL' ,
    @Costflag = @Costflag ,
    @Costrowid = @Costrowid ,
    @Clearingmode = '' ,
    @Emode = 'A'
             
  EXEC INSERTTOLEDGER2
    @Sessionid = @Sessionid ,
    @VNO = @VNO ,
    @branchflag = '1' ,
    @costcenterflag = '1' ,
    @costenable = 'A' ,
    @statusid = 'broker' ,
    @statusname = 'broker'
                  
  DELETE FROM TEMPLEDGER2
  WHERE       SESSIONID = @Sessionid
              AND VTYPE = '55'
              AND BOOKTYPE = '01'
                             
  DELETE FROM TEMPBILLDETAILS
  WHERE       SESSIONID =@Sessionid
              AND VTYPE = '55'
              AND BOOKTYPE = '01'
                             
  COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.JRG_Ledger_Report_fout_New1
-- --------------------------------------------------
--exec Ledger_Report_fout_New2 'Jan 25 2007','00','zz','TRADER','trader','chn001','939850806','S'  
--select * from msajag..client  
  
--exec Ledger_Report_fout_New1 'Apr 10 2006','2305','23241','CLIENT','broker','broker','399150763','D'    
    
--exec Ledger_Report_fout_New1 'Apr  7 2006','0','01','CLIENT','broker','broker','484857046','S'      
 --insert into Owner select * from gunavatta.account.dbo.Owner        
/****** Object:  Stored Procedure dbo.Ledger_Report_fout_New1    Script Date: 10/06/2004 5:29:07 PM ******/            
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 09/14/2004 5:39:20 PM ******/                      
                      
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 07/26/2004 5:48:37 PM ******/                      
                      
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 07/24/2004 7:58:51 PM ******/                      
                      
                      
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 4/4/2004 3:47:46 PM ******/                      
--exec Ledger_Report_fout 'MAR 1 2004','000501','A F PAREKH ','000501'                      
--exec Ledger_Report_fout 'MAR 1 2004','000502','A H NAVSARIWALA '                       
                      
CREATE PROCEDURE JRG_Ledger_Report_fout_New1
(@FromDate as Varchar(11),                      
@FromCltcode as varchar(10),                      
@ToCltcode as varchar(10),                      
@Opt                 as Varchar(10),                      
@statusid as varchar(25),                      
@statusname as varchar(50),                      
@session as varchar(25),                
@reportopt as varchar(1))                      
AS                      
                      
DECLARE @FAACTUAL1 Money                      
DECLARE @FAACTUAL2 Money                      
DECLARE @FAACTUAL3 Money                      
DECLARE @FAACTUAL4 Money                      
DECLARE @FAACTUAL5 Money                      
DECLARE @FAACTUAL6 Money                      
                      
--lete from LedgerBalances where sessionid = @session                      
/*                      
if upper(@statusid) = 'BRANCH'                      
begin                      
 if @Opt = 'FAMILY'                       
 Begin                      
  insert Into LedgerBalances                      
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.ClientMaster Where Family >= @FromCltCode                       
  And Family <= @ToCltCode and Branch_cd = @statusname                      
 End                      
 Else                      
 Begin                      
  insert Into LedgerBalances                      
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.ClientMaster Where Party_Code >= @FromCltCode                       
  And Party_Code <= @ToCltCode and Branch_cd = @statusname                      
 End                      
end                      
else                      
begin                      
 if @Opt = 'FAMILY'                       
 Begin                      
  insert Into LedgerBalances                      
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.ClientMaster Where Family >= @FromCltCode                       
  And Family <= @ToCltCode                       
 End                      
 Else                      
 Begin                      
  insert Into LedgerBalances                      
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.ClientMaster Where Party_Code >= @FromCltCode                       
  And Party_Code <= @ToCltCode                       
 End                      
end                      
*/                      
                    
Create table #LedgerBalances                    
(          
FamilyCode  varchar(50),                    
CLTCODE     varchar(50),                    
ACNAME       varchar(100),                    
NSEBALANCE money,                    
BSEBALANCE money,                    
NSEFOBALANCE money,                    
NSEESTIMATED1 money,          
NSEESTIMATED2 money,                    
BSEESTIMATED1 money,                    
BSEESTIMATED2 money,                    
FAActual money,                    
NonCash  money,                    
Cash  money,                    
IMMargin money,                    
VarMargin money,       
sessionid varchar(25)                    
)                    
  
if upper(@statusid) = 'TRADER'                      
begin                      
if @Opt = 'FAMILY'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode                       
  And Family <= @ToCltCode and trader = @statusname                      
 End                       
 else if @Opt = 'TRADER'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select trader,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where trader >= @FromCltCode                       
  And trader <= @ToCltCode and trader = @statusname                      
 End                      
 Else                      
 Begin                      
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode                       
  And Cl_Code <= @ToCltCode and trader = @statusname                      
 End                      
End                      
else if upper(@statusid) = 'BRANCH'                      
begin                      
 if @Opt = 'BRANCH'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select Branch_cd,Cl_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Branch_cd >= @FromCltCode                       
  And Branch_cd <= @ToCltCode and Branch_cd = @statusname                      
 End                      
 else if @Opt = 'FAMILY'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode                       
  And Family <= @ToCltCode and Branch_cd = @statusname                      
 End                       
 else if @Opt = 'SUBBROKER'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select sub_broker,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where sub_broker >= @FromCltCode                       
  And sub_broker <= @ToCltCode and Branch_cd = @statusname                      
 End                       
 else if @Opt = 'TRADER'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select trader,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where trader >= @FromCltCode                       
  And trader <= @ToCltCode and Branch_cd = @statusname                      
 End                      
 else if @Opt = 'AREA'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select area,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where area >= @FromCltCode                       
  And area <= @ToCltCode and Branch_cd = @statusname                      
 End                      
 Else                      
 Begin               
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode                       
  And Cl_Code <= @ToCltCode and Branch_cd = @statusname                      
 End                      
end                      
else if upper(@statusid) = 'BROKER'                    
begin                      
 if @Opt = 'BRANCH'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select branch_cd,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where branch_cd >= @FromCltCode                       
  And branch_cd <= @ToCltCode                       
 end                      
 else if @Opt = 'FAMILY'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode                       
  And Family <= @ToCltCode                       
 End                      
 else if @Opt = 'SUBBROKER'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select sub_broker,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where sub_broker >= @FromCltCode                       
  And sub_broker <= @ToCltCode                      
 End                       
 else if @Opt = 'TRADER'                       
 Begin                      
  insert Into #LedgerBalances          
  Select trader,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where trader >= @FromCltCode                       
  And trader <= @ToCltCode                      
 End                      
 else if @Opt = 'AREA'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select area,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                
  From MSAJAG.DBO.Client1 Where area >= @FromCltCode                       
  And area <= @ToCltCode                      
 End              
 Else                      
 Begin                      
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode                       
  And Cl_Code <= @ToCltCode            
 End                
end                    
 Else                      
begin                      
 if @Opt = 'FAMILY'                       
 Begin                      
  insert Into #LedgerBalances                      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode                       
  And Family <= @ToCltCode and Sub_Broker = @statusname            
 End                      
 else if @Opt = 'SUBBROKER'                   
 Begin                      
  insert Into #LedgerBalances                      
  Select sub_broker,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where sub_broker >= @FromCltCode                       
  And sub_broker <= @ToCltCode and Sub_Broker = @statusname            
 End                       
 Else                      
 Begin                      
  insert Into #LedgerBalances              
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session                      
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode                       
  And Cl_Code <= @ToCltCode and Sub_Broker = @statusname            
 End                      
end             
                  
                  
select * into #EDTNSELedger from ACCOUNT.DBO.LEDGER where 1=2                  
select * into #VDTNSELedger from ACCOUNT.DBO.LEDGER where 1=2      
select * into #EDTBSELedger from ACCOUNTBSE.DBO.LEDGER where 1=2                  
select * into #VDTBSELedger from ACCOUNTBSE.DBO.LEDGER where 1=2                  
-- Nsefo start    
select * into #EDTFOLedger from ACCOUNTFO.DBO.LEDGER where 1=2                  
select * into #VDTFOLedger from ACCOUNTFO.DBO.LEDGER where 1=2              
-- Nsefo end    
              
              
                  
if @Opt = 'BRANCH'                  
begin                  
--NSE Ledger                  
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Branch_cd >= @FromCltCode                       
 and Branch_cd <= @ToCltCode                   
                  
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Branch_cd >= @FromCltCode                       
 and Branch_cd <= @ToCltCode                   
--BSE Ledger                  
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Branch_cd >= @FromCltCode                       
 and Branch_cd <= @ToCltCode                   
                  
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Branch_cd >= @FromCltCode                       
 and Branch_cd <= @ToCltCode                   
    
-- Nsefo start                  
--FO Ledger                  
 insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Branch_cd >= @FromCltCode                       
 and Branch_cd <= @ToCltCode                   
                  
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Branch_cd >= @FromCltCode                       
 and Branch_cd <= @ToCltCode               
    
-- Nsefo end    
                  
end                  
else if @Opt = 'FAMILY'                  
begin                  
--NSE Ledger                  
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Family >= @FromCltCode                       
 And Family <= @ToCltCode                   
                  
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Family >= @FromCltCode                       
 And Family <= @ToCltCode                   
                  
--BSE Ledger                  
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Family >= @FromCltCode                       
 And Family <= @ToCltCode                   
                  
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code            
 and Family >= @FromCltCode                       
 And Family <= @ToCltCode                   
    
-- Nsefo start             
--FO Ledger                 
 insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and Family >= @FromCltCode                       
 And Family <= @ToCltCode                   
                  
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
and Family >= @FromCltCode                       
 And Family <= @ToCltCode              
-- Nsefo end    
end                  
else if @Opt = 'SUBBROKER'                  
begin                   
--NSE Ledger                  
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and sub_broker >= @FromCltCode                       
 And sub_broker <= @ToCltCode                   
                  
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and sub_broker >= @FromCltCode                       
 And sub_broker <= @ToCltCode                   
--BSE Ledger                  
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and sub_broker >= @FromCltCode                       
 And sub_broker <= @ToCltCode                   
                  
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code          
 and sub_broker >= @FromCltCode                       
 And sub_broker <= @ToCltCode                   
                
-- Nsefo start      
--FO Ledger                  
 insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and sub_broker >= @FromCltCode                       
 And sub_broker <= @ToCltCode                   
                  
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
and sub_broker >= @FromCltCode                       
 And sub_broker <= @ToCltCode               
-- Nsefo end    
end                  
else if @Opt = 'TRADER'        
begin                   
--NSE Ledger                  
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and trader >= @FromCltCode                       
 And trader <= @ToCltCode                       
                  
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and trader >= @FromCltCode                       
 And trader <= @ToCltCode                 
                  
--BSE Ledger                  
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1         
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and trader >= @FromCltCode                       
 And trader <= @ToCltCode                       
                  
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and trader >= @FromCltCode                       
 And trader <= @ToCltCode                       
                
-- Nsefo start      
--FO Ledger                  
 insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and trader >= @FromCltCode                       
 And trader <= @ToCltCode                       
                  
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and trader >= @FromCltCode                       
 And trader <= @ToCltCode                   
-- Nsefo end    
                  
end                  
else if @Opt = 'AREA'                       
begin                   
--NSE Ledger                  
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and area >= @FromCltCode                       
 And area <= @ToCltCode                       
                  
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'               
 and cltcode=cl_code                  
 and area >= @FromCltCode                       
 And area <= @ToCltCode                       
                  
--BSE Ledger                  
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and area >= @FromCltCode                       
 And area <= @ToCltCode                       
                  
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and area >= @FromCltCode                       
 And area <= @ToCltCode                       
                
-- Nsefo start      
--FO Ledger                  
 insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and area >= @FromCltCode                       
 And area <= @ToCltCode                       
                  
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1                  
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode=cl_code                  
 and area >= @FromCltCode                       
 And area <= @ToCltCode                   
-- Nsefo end    
                  
end                  
else                  
begin                   
--NSE Ledger                  
 insert into #EDTNSELedger select * from ACCOUNT.DBO.LEDGER               
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode >= @FromCltCode                  
 And cltcode <= @ToCltCode                  
                  
 insert into #VDTNSELedger select * from ACCOUNT.DBO.LEDGER                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode >= @FromCltCode                  
 And cltcode <= @ToCltCode                  
                  
--BSE Ledger                  
 insert into #EDTBSELedger select * from ACCOUNTBSE.DBO.LEDGER                   
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode >= @FromCltCode                  
 And cltcode <= @ToCltCode                  
                  
 insert into #VDTBSELedger select * from ACCOUNTBSE.DBO.LEDGER       where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode >= @FromCltCode                  
 And cltcode <= @ToCltCode                  
    
-- Nsefo start                  
--FO Ledger                  
 insert into #EDTFOLedger select * from ACCOUNTFO.DBO.LEDGER                   
 where EDT <= @FromDate + ' 23:59:59'                  
 and cltcode >= @FromCltCode                  
 And cltcode <= @ToCltCode                  
                  
 insert into #VDTFOLedger select * from ACCOUNTFO.DBO.LEDGER                  
 where VDT <= @FromDate + ' 23:59:59'                  
 and cltcode >= @FromCltCode                  
 And cltcode <= @ToCltCode              
-- Nsefo end    
                  
end                  
              
              
                  
/*                  
update #LedgerBalances set NSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21)  Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
update #LedgerBalances set NSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #EDTNSELedger L, ACCOUNT.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21)  Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                  
                  
/*                    
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #VDTNSELedger L, ACCOUNT.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                  
/*                     
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #EDTNSELedger L, ACCOUNT.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                  
/*                   
update #LedgerBalances set BSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
update #LedgerBalances set BSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #EDTBSELedger L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                  
/*                      
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A               
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #VDTBSELedger L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                  
/*                      
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A                   
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #EDTBSELedger L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                        
                  
/*             
update #LedgerBalances set NSEFOBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P            
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                 
*/                  
              
-- Nsefo start        
update #LedgerBalances set NSEFOBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #EDTFOLedger L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                   
-- Nsefo end    
                  
/*                      
update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                
-- Nsefo start      
update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #VDTFOLedger L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                   
-- Nsefo end    
                  
/*                      
update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
*/                  
                  
-- Nsefo start    
update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM #EDTFOLedger L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                   
-- Nsefo end    
                  
drop table #EDTNSELedger                  
drop table #VDTNSELedger                  
drop table #EDTBSELedger                  
drop table #VDTBSELedger                  
-- Nsefo start    
drop table #EDTFOLedger                  
drop table #VDTFOLedger                  
-- Nsefo end    
                  
                      
Select Exc='NSE', Vdt, CltCode,Amount=CONVERT(NUMERIC(18,4),isnull(Sum(Case When DrCr = 'D' Then Vamt Else -Vamt End),0) )                      
Into #LdegerEstimate From ACCOUNT.DBO.LEDGER L, MSAJAG.DBO.Sett_Mst S                       
Where L.narration Like '%' + RTrim(Sett_No) + 'NSECM' + RTrim(Sett_Type) + '%'   
And Vdt >= S.Start_Date And Vdt <= S.Sec_PayIn And Vdt <= @FromDate + ' 23:59:59'                   
And Vtyp in (15,21) AND Edt >= @FromDate + ' 23:59:59' and L.cltcode >= @FromCltcode and L.cltcode <= @ToCltcode                       
Group By VDT,CltCode                      
                      
Insert Into #LdegerEstimate                       
Select Exc='BSE', Vdt,CltCode,Amount=CONVERT(NUMERIC(18,4),isnull(Sum(Case When DrCr = 'D' Then Vamt Else -Vamt End),0) )                      
From ACCOUNTBSE.DBO.LEDGER L, BSEDB.DBO.Sett_Mst S                       
Where L.narration Like '%' + RTrim(Sett_No) + 'BSECM' + RTrim(Sett_Type) + '%'                       
And Vdt >= S.Start_Date And Vdt <= S.Sec_PayIn And Vdt <= @FromDate + ' 23:59:59'                      
And Vtyp in (15,21) AND Edt >= @FromDate + ' 23:59:59' and L.cltcode >= @FromCltcode and L.cltcode <= @ToCltcode                       
Group By VDT,CltCode                       
                      
update #LedgerBalances set NSEESTIMATED1 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L                      
Where Vdt Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'NSE' ) Group By CltCode ) A                      
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session                       
                      
update #LedgerBalances set NSEESTIMATED2 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L                      
Where Vdt Not Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'NSE' ) Group By CltCode ) A                      
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session                       
                      
update #LedgerBalances set BSEESTIMATED1 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L                      
Where Vdt Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'BSE' ) Group By CltCode ) A                      
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session                       
                      
update #LedgerBalances set BSEESTIMATED2 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L                      
Where Vdt Not Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'BSE') Group By CltCode ) A                      
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session      
                      
update #LedgerBalances set FAACTUAL = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp <> 2 Group By CltCode) A                       
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                      
update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                      
update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P               
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp <> 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                      
update #LedgerBalances set FAACTUAL =  FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                       
                
-- Nsefo start          
update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp <> 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                   
-- Nsefo end    
    
-- Nsefo start                      
update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))                      
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P                      
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur                      
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A                      
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session                   
-- Nsefo end    
                      
Update #LedgerBalances Set NonCash = C.NonCash, Cash = C.Cash                      
From MSAJAG.DBO.Collateral C                       
Where Trans_Date Like @FromDate +'%'                       
And #LedgerBalances.cltcode=C.Party_Code and sessionid = @session                       
                
-- Nsefo start          
Update #LedgerBalances Set IMMargin = IsNull(Margin,0) From (Select Party_Code, Margin = Sum(PspanMargin)                        
From NSEFO.DBO.FoMarginNew F Where Mdate = (Select Max(MDate) From NSEFO.DBO.FoMarginNew Where MDate <= @FromDate +' 23:59:59' )                 
Group By Party_Code ) A                      
Where #LedgerBalances.cltcode=A.Party_Code and sessionid = @session                   
-- Nsefo end    
-- Nsefo start                      
Update #LedgerBalances Set VarMargin = IsNull(VMargin,0) From (Select Party_Code, VMargin = Sum(MtoM)                        
From NSEFO.DBO.FoMarginNew F Where Mdate = (Select Max(MDate) From NSEFO.DBO.FoMarginNew Where MDate <= @FromDate +' 23:59:59' )                 
Group By Party_Code ) A                      
Where #LedgerBalances.cltcode=A.Party_Code and sessionid = @session            
-- Nsefo end    
    
-- nsefo last                      
Update #LedgerBalances Set NonCash = (Case When (IMMargin + VarMargin) / 2 < NonCash Then  (IMMargin + VarMargin) / 2 Else nonCash End)                 
where sessionid = @session                       
                      
Delete From #LedgerBalances                       
Where NSEBALANCE   = 0                       
And BSEBALANCE      = 0                       
And NSEFOBALANCE  = 0                       
And NSEESTIMATED1 = 0                       
And NSEESTIMATED2 = 0                       
And BSEESTIMATED1 = 0                       
And BSEESTIMATED2 = 0                       
And FAActual           = 0                       
And NonCash           = 0                       
And Cash                = 0              
And IMMargin           = 0                       And VarMargin         = 0                      
and sessionid = @session                       
                  
--insert into LedgerBalances select * from #LedgerBalances                      
--select * from #LedgerBalances  order by FamilyCode,CltCode                  
/*                  
if @Opt <> 'CLIENT'                  
begin                  
 if @Opt = 'BRANCH'                  
 select FamilyCode,CLTCODE,ACNAME=C.Long_Name,                  
 NSEBALANCE=Sum(NSEBALANCE),BSEBALANCE=Sum(BSEBALANCE),                  
 NSEFOBALANCE=Sum(NSEFOBALANCE),NSEESTIMATED1=Sum(NSEESTIMATED1),                   
 NSEESTIMATED2=Sum(NSEESTIMATED2),                  
 BSEESTIMATED1=Sum(BSEESTIMATED1),BSEESTIMATED2=Sum(BSEESTIMATED2),                  
 FAActual=Sum(FAActual),Res_Phone1,Cash=Sum(Cash),NonCash=Sum(NonCash),                  
 IMMargin=Sum(IMMargin),VarMargin=Sum(VarMargin)                   
 from LedgerBalances L, MSAJAG.DBO.Client1 C                   
 Where C.Cl_Code = L.CltCode and sessionid=@session                  
 Group By FamilyCode,c.branch_cd,C.Long_Name,Res_Phone1                   
 Order By FamilyCode,CLTCODE,C.Long_Name,Res_Phone1                  
                  
end                  
Else                  
begin                  
 select FamilyCode,CLTCODE,ACNAME,NSEBALANCE,BSEBALANCE,NSEFOBALANCE,NSEESTIMATED1,NSEESTIMATED2,                   
 BSEESTIMATED1,BSEESTIMATED2,FAActual,Res_Phone1,Cash,NonCash,IMMargin,VarMargin                   
 from LedgerBalances L,MSAJAG.DBO.ClientMaster C                   
 Where C.Party_Code = L.CltCode and sessionid=@session                  
 Order By FamilyCode,CLTCODE,C.Long_Name,Res_Phone1                   
end                  
*/                    
if @reportopt='D'                
begin                
 select FamilyCode,CLTCODE,ACNAME,NSEBALANCE,BSEBALANCE,NSEFOBALANCE,NSEESTIMATED1,NSEESTIMATED2,                   
 BSEESTIMATED1,BSEESTIMATED2,FAActual,Res_Phone1,Cash,NonCash,IMMargin,VarMargin                   
 from #LedgerBalances L,MSAJAG.DBO.ClientMaster C                   
 Where C.Party_Code = L.CltCode and sessionid=@session                  
 Order By FamilyCode,CLTCODE,C.Long_Name,Res_Phone1                   
end                
else                
begin                
-- select FamilyCode,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
-- sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
-- sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
-- sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
-- sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
-- sum(FAActual) as TotFAACTUAL,                
-- sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
-- sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
-- sum(FAActual -                 
-- (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)                 
-- + IMMargin + VarMargin - NONCASH - CASH) as TotFinTotalParty                   
-- from #LedgerBalances L,MSAJAG.DBO.ClientMaster C                   
-- Where C.Party_Code = L.CltCode and sessionid=@session                  
-- group By FamilyCode                
-- Order By FamilyCode                
              
 if @Opt = 'BRANCH'              
 begin              
/*            
   select c.branch_cd as FamilyCode,b.branch as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
   sum(FAActual) as TotFAACTUAL,                
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
   sum(FAActual -                 
   (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)                 
   + IMMargin + VarMargin - NONCASH - CASH) as TotFinTotalParty                   
   from #LedgerBalances L,MSAJAG.DBO.Client1 C , MSAJAG.DBO.Branch B                  
   Where C.Cl_Code = L.CltCode and c.branch_cd=b.branch_code and sessionid=@session                  
   group By c.branch_cd,b.branch              
   Order By c.branch_cd              
*/            
   select c.branch_cd as FamilyCode,b.branch as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
   sum(FAActual) as TotFAACTUAL,                
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty                      
   from #LedgerBalances L,MSAJAG.DBO.Client1 C , MSAJAG.DBO.Branch B                  
   Where C.Cl_Code = L.CltCode and c.branch_cd=b.branch_code and sessionid=@session                  
   group By c.branch_cd,b.branch              
   Order By c.branch_cd              
            
 end              
 else if @Opt = 'FAMILY'              
 begin              
   select FamilyCode,FamilyCode as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
  sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
  sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,       
  sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
  sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
  sum(FAActual) as TotFAACTUAL,                
  sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
  sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
  sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty                     
  from #LedgerBalances L,MSAJAG.DBO.ClientMaster C                   
  Where C.Party_Code = L.CltCode and sessionid=@session                  
  group By FamilyCode                
  Order By FamilyCode                
 end              
 else if @Opt = 'SUBBROKER'              
 begin              
   select c.sub_broker as FamilyCode,b.Name as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
   sum(FAActual) as TotFAACTUAL,                
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty                      
   from #LedgerBalances L,MSAJAG.DBO.Client1 C,MSAJAG.DBO.SubBrokers B                   
   Where C.Cl_Code = L.CltCode and c.sub_broker=b.sub_broker and sessionid=@session                  
   group By c.sub_broker,b.Name              
   Order By c.sub_broker              
 end              
 else if @Opt = 'TRADER'              
 begin              
   select c.trader as FamilyCode,b.Long_name as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
   sum(FAActual) as TotFAACTUAL,                
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty                      
   from #LedgerBalances L,MSAJAG.DBO.Client1 C , MSAJAG.DBO.Branches B                  
   Where C.Cl_Code = L.CltCode and c.trader=b.short_name and sessionid=@session                  
   group By c.trader,b.Long_name              
   Order By c.trader              
 end              
 else if @Opt = 'AREA'              
 begin              
   select c.area as FamilyCode,b.description as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,              
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
   sum(FAActual) as TotFAACTUAL,                
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty                      
   from #LedgerBalances L,MSAJAG.DBO.Client1 C,MSAJAG.DBO.Area B                   
   Where C.Cl_Code = L.CltCode and c.area=b.areacode and sessionid=@session                  
   group By c.area,b.description              
   Order By c.area               
 end              
 else         
 begin              
   select c.cl_code as FamilyCode,c.short_name as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,                   
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,                
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                
   sum(FAActual) as TotFAACTUAL,                
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,                
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty                   
   from #LedgerBalances L,MSAJAG.DBO.Client1 C                   
   Where C.Cl_Code = L.CltCode and sessionid=@session                  
   group By c.cl_code,c.Short_Name              
   Order By cl_code                
 end              
end                   
                  
drop table #LedgerBalances

GO

-- --------------------------------------------------
-- PROCEDURE dbo.JVDRCRDPUPLOAD_BULK
-- --------------------------------------------------

CREATE PROC [dbo].[JVDRCRDPUPLOAD_BULK]
	@FNAME VARCHAR(100) = '',
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@FDESC VARCHAR(25),
	@GLCODE VARCHAR(10) = ''
AS
/*
	DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'C:\BulkUploads\JvDrCrDpFiles\indorebse27062007.txt'
	Exec JVDRCRDPUPLOAD_BULK 'C:\BulkUploads\JvDrCrDpFiles\indorebse27062007.txt', 'DEMO', 6, '01', 'DP FILE', '125025' 
*/
	SET NOCOUNT ON

	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000)

/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LEFT(@FDESC, 11) <> 'THIRD PARTY'
	BEGIN
		IF LTRIM(RTRIM(@FNAME)) = ''
			BEGIN
				SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
				RETURN
			END

		CREATE TABLE #FEXIST
			(F1 INT, F2 INT, F3 INT)
		
		SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
		EXEC (@@SQL)

		SELECT @@ERROR_COUNT = F1 FROM #FEXIST
		IF @@ERROR_COUNT = 0
			BEGIN
				SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
				DROP TABLE #FEXIST
				RETURN
			END
	END
	
	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		COSTCODE SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]

	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO INT ,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	IF @FDESC = 'DP FILE'
	BEGIN
		DECLARE @@FILENAME AS VARCHAR(100)
		SELECT @@FILENAME = 'C:\TESTIMPORT.TXT'

		CREATE TABLE #TESTIMPORT                
		(                
			OneRow Varchar(2000),              
			SNO INT IDENTITY(1,1)              
		) 

		SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FNAME + "' "              
		EXEC(@@SQL)                
  
		DELETE FROM #TESTIMPORT WHERE SNO = 1
		DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL   
		
		DECLARE 
		@@FILEDATA VARCHAR(500),		
		@@INDEX INT
	
		SELECT TOP 1
			@@FILEDATA = ONEROW 
		FROM 
			#TESTIMPORT
		
		SELECT @@INDEX = CHARINDEX('~', @@FILEDATA)
		
		IF @@INDEX = 0 
		BEGIN	
			SELECT 'THE FILE WHICH YOU ARE TRYING UPLOAD IS OF WRONG FORMAT'
			DROP TABLE #TESTIMPORT
			RETURN
		END

		SELECT * INTO TESTIMPORT FROM #TESTIMPORT
		DROP TABLE #TESTIMPORT

		SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FILENAME + CHAR(34) + " -c -q -U " + CHAR(34) + "sa" + CHAR(34) + " -P " + CHAR(34) + "ms" + CHAR(34) + "', no_output "               
  		EXEC(@@SQL)                
  
		DROP TABLE TESTIMPORT

		CREATE TABLE #DP_TABLE_TMP
		(
			BATCHNO INT,
			CLIENTTCODE VARCHAR(16),
			DPID VARCHAR(10),			
			CLTCODE VARCHAR(10),			
			DRCR VARCHAR(1),
			AMOUNT MONEY,
			VVDT VARCHAR(10),
			NARRATION VARCHAR(234),
			SRNO INT IDENTITY (1, 1) NOT NULL
		)

		SELECT @@SQL = "BULK INSERT #DP_TABLE_TMP FROM '" + @@FILENAME + "' WITH (FIELDTERMINATOR = '~', ROWTERMINATOR = '\n', FIRSTROW = 1) "
		EXEC(@@SQL)

		INSERT INTO #RECPAY_TABLE
			(SRNO,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION)
		SELECT
			SRNO,
			VVDT,
			VVDT,
			UPPER(CLTCODE),
			DRCR,
			AMOUNT,
			NARRATION
		FROM #DP_TABLE_TMP

		INSERT INTO #RECPAY_TABLE
			(SRNO,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION)
		SELECT
			SRNO,
			VVDT,
			VVDT,
			@GLCODE,
			CASE DRCR WHEN 'D' THEN 'C' ELSE 'D' END,
			AMOUNT,
			NARRATION
		FROM #DP_TABLE_TMP

		UPDATE
			#RECPAY_TABLE
			SET
				VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),
				EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),
				FYSTART = P.SDTCUR,
				FYEND = P.LDTCUR,
				UPDFLAG = 'Y',
				ACNAME = LONGNAME,
				COSTCODE = C.COSTCODE
		  FROM ACMAST A, PARAMETER P, COSTMAST C
		  WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		  AND P.CURYEAR = 1
		  AND A.ACCAT IN ('3','4','104')
		  AND A.BRANCHCODE = C.COSTNAME
		  AND A.BRANCHCODE <> 'ALL'
		
		  UPDATE
			#RECPAY_TABLE
			SET
				VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),
				EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),
				FYSTART = P.SDTCUR,
				FYEND = P.LDTCUR,
				UPDFLAG = 'Y',
				ACNAME = LONGNAME,
				COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
		  FROM ACMAST A, PARAMETER P
		  WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		  AND P.CURYEAR = 1
		  AND A.ACCAT IN ('3','4','104')
		  AND A.BRANCHCODE = 'ALL'
	END

	IF LEFT(@FDESC, 11) = 'THIRD PARTY'
	BEGIN		
		INSERT INTO #RECPAY_TABLE
			(SRNO,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION)
		SELECT
			SRNO,
			VVDT,
			VVDT,
			UPPER(CLTCODE),
			DRCR,
			AMOUNT,
			NARRATION
		FROM ##TPR_TMP

		INSERT INTO #RECPAY_TABLE
			(SRNO,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION)
		SELECT
			SRNO,
			VVDT,
			VVDT,
			@GLCODE,
			CASE DRCR WHEN 'D' THEN 'C' ELSE 'D' END,
			AMOUNT,
			NARRATION
		FROM ##TPR_TMP

		UPDATE
			#RECPAY_TABLE
		SET
			VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),
			EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),
			FYSTART = P.SDTCUR,
			FYEND = P.LDTCUR,
			UPDFLAG = 'Y',
			ACNAME = LONGNAME,
			COSTCODE = C.COSTCODE
		FROM ACMAST A, PARAMETER P, COSTMAST C
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND P.CURYEAR = 1
			AND A.ACCAT IN ('3','4','104')
			AND A.BRANCHCODE = C.COSTNAME
			AND A.BRANCHCODE <> 'ALL'
		
		UPDATE
			#RECPAY_TABLE
		SET
			VDT = CONVERT(DATETIME, LEFT(VVDT,4) + '-' + SUBSTRING(VVDT,5,2) + '-' + RIGHT(VVDT,2)),
			EDT = CONVERT(DATETIME, LEFT(EEDT,4) + '-' + SUBSTRING(EEDT,5,2) + '-' + RIGHT(EEDT,2)),
			FYSTART = P.SDTCUR,
			FYEND = P.LDTCUR,
			UPDFLAG = 'Y',
			ACNAME = LONGNAME,
			COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
		FROM ACMAST A, PARAMETER P
		WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND P.CURYEAR = 1
			AND A.ACCAT IN ('3','4','104')
			AND A.BRANCHCODE = 'ALL'
	END

	ELSE
	BEGIN
		CREATE TABLE #JVTESTIMPORT                
		(
			OneRow Varchar(2000),              
			SNO INT IDENTITY(1,1)              
		)

		SELECT @@SQL = "INSERT INTO #JVTESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FNAME + "' "              
		EXEC(@@SQL)                
  
		DELETE FROM #JVTESTIMPORT WHERE SNO = 1
		DELETE FROM #JVTESTIMPORT WHERE ONEROW IS NULL   
		
		DECLARE 
		@@JVFILEDATA VARCHAR(500),		
		@@JVINDEX INT
	
		SELECT TOP 1
			@@JVFILEDATA = ONEROW 
		FROM 
			#JVTESTIMPORT
		
		SELECT @@JVINDEX = CHARINDEX(',', @@JVFILEDATA)
		
		IF @@JVINDEX = 0 
		BEGIN	
			SELECT 'THE FILE WHICH YOU ARE TRYING UPLOAD IS OF WRONG FORMAT'
			DROP TABLE #JVTESTIMPORT
			RETURN
		END

		DROP TABLE #JVTESTIMPORT

		CREATE TABLE #RECPAY_TABLE_TMP
		(
			SRNO INT,
			VVDT VARCHAR(10),
			EEDT VARCHAR(10),
			CLTCODE VARCHAR(10),
			DRCR VARCHAR(1),
			AMOUNT MONEY,
			NARRATION VARCHAR(500)
		)

		SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
		EXEC(@@SQL)

		INSERT INTO #RECPAY_TABLE
			(SRNO,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION)
		SELECT
			SRNO,
			VVDT,
			EEDT,
			UPPER(CLTCODE),
			DRCR,
			AMOUNT,
			LEFT(NARRATION, 234)
		FROM #RECPAY_TABLE_TMP

		UPDATE
			#RECPAY_TABLE
			SET
				VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
				EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),
				FYSTART = P.SDTCUR,
				FYEND = P.LDTCUR,
				UPDFLAG = 'Y',
				ACNAME = LONGNAME,
				COSTCODE = C.COSTCODE
		  FROM ACMAST A, PARAMETER P, COSTMAST C
		  WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		  AND P.CURYEAR = 1
		  AND A.ACCAT IN ('3','4','104')
		  AND A.BRANCHCODE = C.COSTNAME
		  AND A.BRANCHCODE <> 'ALL'

		  UPDATE
			#RECPAY_TABLE
			SET
				VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
				EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),
				FYSTART = P.SDTCUR,
				FYEND = P.LDTCUR,
				UPDFLAG = 'Y',
				ACNAME = LONGNAME,
				COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
		  FROM ACMAST A, PARAMETER P
		  WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		  AND P.CURYEAR = 1
		  AND A.ACCAT IN ('3','4','104')
		  AND A.BRANCHCODE = 'ALL'
	END 
		
	BEGIN TRAN

	IF LEFT(@FDESC, 11) <> 'THIRD PARTY'
	BEGIN
		SELECT 
			@@ERROR_COUNT = COUNT(1) 
		FROM
			(SELECT 
				U_FILENAME 
			FROM 
				V2_UPLOADED_FILES
			WHERE 
				U_FILENAME = @FNAME 
				AND U_MODULE = 'DRCR NOTE UPLOAD') A

		IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END
	END

	INSERT INTO V2_UPLOADED_FILES
	SELECT
		@FNAME,
		@FNAME,
		COUNT(1),
		'B',
		GETDATE(),
		@UNAME,
		'DRCR NOTE UPLOAD'

/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/

	DECLARE
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1)


/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DATE MISMATCH'
			IF @FDESC = 'DP FILE'
				DROP TABLE #DP_TABLE_TMP
			ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'
				DROP TABLE ##TPR_TMP
			ELSE
				DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/

	UPDATE #RECPAY_TABLE
		SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
	WHERE COSTCODE IS NULL

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			IF @FDESC = 'DP FILE'
				DROP TABLE #DP_TABLE_TMP
			ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'
				DROP TABLE ##TPR_TMP
			ELSE
				DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
			WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
			IF @FDESC = 'DP FILE'
				DROP TABLE #DP_TABLE_TMP
			ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'
				DROP TABLE ##TPR_TMP
			ELSE
				DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
			WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL
			SELECT DISTINCT
				CLTCODE
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			IF @FDESC = 'DP FILE'
				DROP TABLE #DP_TABLE_TMP
			ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'
				DROP TABLE ##TPR_TMP
			ELSE
				DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
			RETURN
		END

	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT


/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/
	DECLARE
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT
	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	/*DP FILE SINGLE VNO GENERATION LOGIC*/
	IF @FDESC = 'DP FILE'
	BEGIN
		SELECT 
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT = SUM(AMOUNT),
			NARRATION = MAX(NARRATION),
			VDT,
			UPDFLAG,
			EDT,
			ACNAME,
			FYSTART,
			FYEND,
			COSTCODE,
			LNO 
		INTO 
			#GLDETAIL
		FROM 
			#RECPAY_TABLE
		WHERE 
			DRCR = 'C'
		GROUP BY 
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			VDT,
			UPDFLAG,
			EDT,
			ACNAME,
			FYSTART,
			FYEND,
			COSTCODE,
			LNO
	
		DELETE FROM 
			#RECPAY_TABLE
		WHERE 
			DRCR = 'C'
	
		INSERT INTO #RECPAY_TABLE
		(
			SRNO,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION,
			VDT,
			UPDFLAG,
			EDT,
			ACNAME,
			FYSTART,
			FYEND,
			COSTCODE,
			LNO
		)
		SELECT
			1,
			VVDT,
			EEDT,
			CLTCODE,
			DRCR,
			AMOUNT,
			NARRATION,
			VDT,
			UPDFLAG,
			EDT,
			ACNAME,
			FYSTART,
			FYEND,
			COSTCODE,
			LNO
		FROM 
		#GLDETAIL
	
		UPDATE
			#RECPAY_TABLE
		SET
			SRNO = 1
	END
	/*DP FILE SINGLE VNO GENERATION LOGIC*/

	SELECT
		@@NOREC = COUNT(DISTINCT SRNO)
	FROM
		#RECPAY_TABLE

	IF @@VNOMETHOD = 0
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, RIGHT(@@STD_DATE, 4) + '00000000') + @@NOREC)
					SELECT @@VNO = RIGHT(@@STD_DATE, 4) + '00000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@STD_DATE, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 1
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 2
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND MONTH(VDT) = MONTH(@@VDT)
				AND YEAR(VDT) = YEAR(@@VDT)
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND MONTH(VDT) = MONTH(@@VDT)
						AND YEAR(VDT) = YEAR(@@VDT)
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END

	UPDATE
		#RECPAY_TABLE
	SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)


/* '--------------------------AUTO GENERATION OF LNO ------------------------*/

	SET @@LNOCUR = CURSOR FOR
		SELECT DISTINCT SRNO FROM #RECPAY_TABLE
	OPEN @@LNOCUR
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO #RECPAY_TABLE_LNO
				(SNO)
			SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO
			UPDATE RP
				SET LNO = RL.LNO
			FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
			WHERE RP.SNO = RL.SNO
			TRUNCATE TABLE #RECPAY_TABLE_LNO
			FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
		END
	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR
	DROP TABLE #RECPAY_TABLE_LNO

/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/
/*==============================
      LEDGER RECORD
==============================*/
	INSERT
	INTO LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMOUNT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMOUNT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE

/*==============================
	LEDGER3 RECORD
==============================*/
	INSERT
	INTO LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE




	DELETE FROM TEMPLEDGER2
		WHERE SESSIONID = '9999999999'
	INSERT INTO TEMPLEDGER2
	SELECT
		'BRANCH',
		C.COSTNAME,
		AMOUNT,
		VTYP = @VTYP,
		VNO,
		LNO,
		DRCR,
		'0',
		BOOKTYPE = @BOOKTYPE,
		SESSIONID = '9999999999',
		CLIENT_CODE = CLTCODE,
		'A',
		'0'
	FROM
		#RECPAY_TABLE RP,
		COSTMAST C
	WHERE
		RP.COSTCODE = C.COSTCODE

	DECLARE @@L2CUR AS CURSOR,
		@@L2VNO AS VARCHAR(12)
	SET @@L2CUR = CURSOR FOR
		SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0
		BEGIN
			EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
			FETCH NEXT FROM @@L2CUR INTO @@L2VNO
		END
		DELETE FROM TEMPLEDGER2
			WHERE SESSIONID = '9999999999'
		CLOSE @@L2CUR
		DEALLOCATE @@L2CUR

	IF @FDESC = 'THIRD PARTY'
	BEGIN
		UPDATE 
			T 
		SET 
			VNO_JV = R.VNO 
		FROM 
			THIRDPARTY_COLLECTION T, #RECPAY_TABLE R
		WHERE
			T.CLTCODE = R.CLTCODE
			AND T.AMOUNT = R.AMOUNT
			AND TPR_FLAG = 'J'
			AND VNO_JV IS NULL
	END

	ELSE IF @FDESC = 'THIRD PARTY REVERSAL'
	BEGIN
		UPDATE 
			T 
		SET 
			VNO_RJV = R.VNO 
		FROM 
			THIRDPARTY_COLLECTION T, #RECPAY_TABLE R
		WHERE
			T.CLTCODE = R.CLTCODE
			AND T.AMOUNT = R.AMOUNT
			AND TPR_FLAG = 'R'
			AND VNO_RJV IS NULL
	END

	COMMIT TRAN

	SELECT RESULT = '0~<HR><B>.:: Data Posted Successfully ::.</B><HR>'	
	UNION ALL
	SELECT RESULT = VNO + ', ' + DRCR + ', ' + CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) FROM #RECPAY_TABLE ORDER BY 1
	IF @FDESC = 'DP FILE'
		DROP TABLE #DP_TABLE_TMP
	ELSE IF LEFT(@FDESC, 11) = 'THIRD PARTY'
		DROP TABLE ##TPR_TMP
	ELSE
		DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LED_BALANCES
-- --------------------------------------------------
--EXEC LED_BALANCES 'JUN 25 2007', '99988', '99988'
CREATE PROC LED_BALANCES
@REPORT_DATE VARCHAR(11),
@FR_PARTY VARCHAR(10) = '0000000000',
@TO_PARTY VARCHAR(10) = 'ZZZZZZZZZZ'
AS

DECLARE 
@@START_DATE VARCHAR(11)

SELECT @@START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @REPORT_DATE BETWEEN SDTCUR AND LDTCUR

SELECT 
	L.CLTCODE, LONGNAME, BRANCHCODE, BALANCE = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)
FROM 
	LEDGER L, ACMAST A
WHERE 
	L.CLTCODE = A.CLTCODE
	AND L.CLTCODE BETWEEN @FR_PARTY AND @TO_PARTY
	AND VDT BETWEEN @@START_DATE AND @REPORT_DATE + ' 23:59:59'
	AND ACCAT = 4
GROUP BY 
	L.CLTCODE, LONGNAME, BRANCHCODE
ORDER BY 
	L.CLTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ledger_Report_fout_New1
-- --------------------------------------------------


--insert into Owner select * from gunavatta.account.dbo.Owner
/****** Object:  Stored Procedure dbo.Ledger_Report_fout_New1    Script Date: 10/06/2004 5:29:07 PM ******/    
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 09/14/2004 5:39:20 PM ******/              
              
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 07/26/2004 5:48:37 PM ******/              
              
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 07/24/2004 7:58:51 PM ******/              
              
              
/****** Object:  Stored Procedure dbo.Ledger_Report_fout    Script Date: 4/4/2004 3:47:46 PM ******/              
--exec Ledger_Report_fout 'MAR 1 2004','000501','A F PAREKH ','000501'              
--exec Ledger_Report_fout 'MAR 1 2004','000502','A H NAVSARIWALA '               
              
CREATE  PROCEDURE Ledger_Report_fout_New1              
(@FromDate as Varchar(11),              
@FromCltcode as varchar(10),              
@ToCltcode as varchar(10),              
@Opt                 as Varchar(10),              
@statusid as varchar(25),              
@statusname as varchar(50),              
@session as varchar(25),        
@reportopt as varchar(1))              
AS              
              
DECLARE @FAACTUAL1 Money              
DECLARE @FAACTUAL2 Money              
DECLARE @FAACTUAL3 Money              
DECLARE @FAACTUAL4 Money              
DECLARE @FAACTUAL5 Money              
DECLARE @FAACTUAL6 Money              
              
--lete from LedgerBalances where sessionid = @session              
/*              
if upper(@statusid) = 'BRANCH'              
begin              
 if @Opt = 'FAMILY'               
 Begin              
  insert Into LedgerBalances              
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.ClientMaster Where Family >= @FromCltCode               
  And Family <= @ToCltCode and Branch_cd = @statusname              
 End              
 Else              
 Begin              
  insert Into LedgerBalances              
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.ClientMaster Where Party_Code >= @FromCltCode               
  And Party_Code <= @ToCltCode and Branch_cd = @statusname              
 End              
end              
else              
begin              
 if @Opt = 'FAMILY'               
 Begin              
  insert Into LedgerBalances              
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.ClientMaster Where Family >= @FromCltCode               
  And Family <= @ToCltCode               
 End              
 Else              
 Begin              
  insert Into LedgerBalances              
  Select Family,Party_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.ClientMaster Where Party_Code >= @FromCltCode               
  And Party_Code <= @ToCltCode               
 End              
end              
*/              
            
Create table #LedgerBalances            
(            
FamilyCode  varchar(50),            
CLTCODE     varchar(50),            
ACNAME       varchar(100),            
NSEBALANCE money,            
BSEBALANCE money,            
NSEFOBALANCE money,            
NSEESTIMATED1 money,            
NSEESTIMATED2 money,            
BSEESTIMATED1 money,            
BSEESTIMATED2 money,            
FAActual money,            
NonCash  money,            
Cash  money,            
IMMargin money,            
VarMargin money,            
sessionid varchar(25)            
)            
              
if upper(@statusid) = 'BRANCH'              
begin              
 if @Opt = 'BRANCH'               
 Begin              
  insert Into #LedgerBalances              
  Select Branch_cd,Cl_code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Branch_cd >= @FromCltCode               
  And Branch_cd <= @ToCltCode and Branch_cd = @statusname              
 End              
 else if @Opt = 'FAMILY'               
 Begin              
  insert Into #LedgerBalances              
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode               
  And Family <= @ToCltCode and Branch_cd = @statusname              
 End               
 else if @Opt = 'SUBBROKER'               
 Begin              
  insert Into #LedgerBalances              
  Select sub_broker,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where sub_broker >= @FromCltCode               
  And sub_broker <= @ToCltCode and Branch_cd = @statusname              
 End               
 else if @Opt = 'TRADER'               
 Begin              
  insert Into #LedgerBalances              
  Select trader,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where trader >= @FromCltCode               
  And trader <= @ToCltCode and Branch_cd = @statusname              
 End              
 else if @Opt = 'AREA'               
 Begin              
  insert Into #LedgerBalances              
  Select area,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where area >= @FromCltCode               
  And area <= @ToCltCode and Branch_cd = @statusname              
 End              
 Else              
 Begin              
  insert Into #LedgerBalances              
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode               
  And Cl_Code <= @ToCltCode and Branch_cd = @statusname              
 End              
end              
else if upper(@statusid) = 'BROKER'            
begin              
 if @Opt = 'BRANCH'               
 Begin              
  insert Into #LedgerBalances              
  Select branch_cd,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where branch_cd >= @FromCltCode               
  And branch_cd <= @ToCltCode               
 end              
 else if @Opt = 'FAMILY'               
 Begin              
  insert Into #LedgerBalances              
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode               
  And Family <= @ToCltCode               
 End              
 else if @Opt = 'SUBBROKER'               
 Begin              
  insert Into #LedgerBalances              
  Select sub_broker,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where sub_broker >= @FromCltCode               
  And sub_broker <= @ToCltCode              
 End               
 else if @Opt = 'TRADER'               
 Begin              
  insert Into #LedgerBalances              
  Select trader,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where trader >= @FromCltCode               
  And trader <= @ToCltCode              
 End              
 else if @Opt = 'AREA'               
 Begin              
  insert Into #LedgerBalances              
  Select area,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where area >= @FromCltCode               
  And area <= @ToCltCode              
 End      
 Else              
 Begin              
  insert Into #LedgerBalances              
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode               
  And Cl_Code <= @ToCltCode    
 End              
end            
 Else              
begin              
 if @Opt = 'FAMILY'               
 Begin              
  insert Into #LedgerBalances              
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Family >= @FromCltCode               
  And Family <= @ToCltCode and Sub_Broker = @statusname    
 End              
 else if @Opt = 'SUBBROKER'           
 Begin              
  insert Into #LedgerBalances              
  Select sub_broker,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where sub_broker >= @FromCltCode               
  And sub_broker <= @ToCltCode and Sub_Broker = @statusname    
 End               
 Else              
 Begin              
  insert Into #LedgerBalances      
  Select Family,Cl_Code, Long_Name, 0,0,0,0,0,0,0,0,0,0,0,0,@session              
  From MSAJAG.DBO.Client1 Where Cl_Code >= @FromCltCode               
  And Cl_Code <= @ToCltCode and Sub_Broker = @statusname    
 End              
end     
          
          
select * into #EDTNSELedger from ACCOUNT.DBO.LEDGER where 1=2          
select * into #VDTNSELedger from ACCOUNT.DBO.LEDGER where 1=2          
select * into #EDTBSELedger from ACCOUNTBSE.DBO.LEDGER where 1=2          
select * into #VDTBSELedger from ACCOUNTBSE.DBO.LEDGER where 1=2          
/*select * into #EDTFOLedger from ACCOUNTFO.DBO.LEDGER where 1=2          
select * into #VDTFOLedger from ACCOUNTFO.DBO.LEDGER where 1=2          */
      
      
          
if @Opt = 'BRANCH'          
begin          
--NSE Ledger          
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Branch_cd >= @FromCltCode               
 and Branch_cd <= @ToCltCode           
          
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Branch_cd >= @FromCltCode               
 and Branch_cd <= @ToCltCode           
--BSE Ledger          
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Branch_cd >= @FromCltCode               
 and Branch_cd <= @ToCltCode           
          
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Branch_cd >= @FromCltCode               
 and Branch_cd <= @ToCltCode           
          
--FO Ledger          
/* insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Branch_cd >= @FromCltCode               
 and Branch_cd <= @ToCltCode           
          
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Branch_cd >= @FromCltCode               
 and Branch_cd <= @ToCltCode           */
          
end          
else if @Opt = 'FAMILY'          
begin          
--NSE Ledger          
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Family >= @FromCltCode               
 And Family <= @ToCltCode           
          
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Family >= @FromCltCode               
 And Family <= @ToCltCode           
          
--BSE Ledger          
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Family >= @FromCltCode               
 And Family <= @ToCltCode           
          
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code    
 and Family >= @FromCltCode               
 And Family <= @ToCltCode           
          
--FO Ledger          
/* insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and Family >= @FromCltCode               
 And Family <= @ToCltCode           
          
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
and Family >= @FromCltCode               
 And Family <= @ToCltCode          */
end          
else if @Opt = 'SUBBROKER'          
begin           
--NSE Ledger          
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and sub_broker >= @FromCltCode               
 And sub_broker <= @ToCltCode           
          
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and sub_broker >= @FromCltCode               
 And sub_broker <= @ToCltCode           
--BSE Ledger          
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and sub_broker >= @FromCltCode               
 And sub_broker <= @ToCltCode           
          
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and sub_broker >= @FromCltCode               
 And sub_broker <= @ToCltCode           
          
--FO Ledger          
/* insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and sub_broker >= @FromCltCode               
 And sub_broker <= @ToCltCode           
          
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
and sub_broker >= @FromCltCode               
 And sub_broker <= @ToCltCode           */
end          
else if @Opt = 'TRADER'               
begin           
--NSE Ledger          
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and trader >= @FromCltCode               
 And trader <= @ToCltCode               
          
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and trader >= @FromCltCode               
 And trader <= @ToCltCode         
          
--BSE Ledger          
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and trader >= @FromCltCode               
 And trader <= @ToCltCode               
          
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and trader >= @FromCltCode               
 And trader <= @ToCltCode               
          
--FO Ledger          
/* insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and trader >= @FromCltCode               
 And trader <= @ToCltCode               
          
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and trader >= @FromCltCode               
 And trader <= @ToCltCode               */
          
end          
else if @Opt = 'AREA'               
begin           
--NSE Ledger          
 insert into #EDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and area >= @FromCltCode               
 And area <= @ToCltCode               
          
 insert into #VDTNSELedger select ACCOUNT.DBO.LEDGER.* from ACCOUNT.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'       
 and cltcode=cl_code          
 and area >= @FromCltCode               
 And area <= @ToCltCode               
          
--BSE Ledger          
 insert into #EDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and area >= @FromCltCode               
 And area <= @ToCltCode               
          
 insert into #VDTBSELedger select ACCOUNTBSE.DBO.LEDGER.* from ACCOUNTBSE.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and area >= @FromCltCode               
 And area <= @ToCltCode               
          
--FO Ledger          
/* insert into #EDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and area >= @FromCltCode               
 And area <= @ToCltCode               
          
 insert into #VDTFOLedger select ACCOUNTFO.DBO.LEDGER.* from ACCOUNTFO.DBO.LEDGER,MSAJAG.DBO.Client1          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode=cl_code          
 and area >= @FromCltCode               
 And area <= @ToCltCode               */
          
end          
else          
begin           
--NSE Ledger          
 insert into #EDTNSELedger select * from ACCOUNT.DBO.LEDGER          
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode >= @FromCltCode          
 And cltcode <= @ToCltCode          
          
 insert into #VDTNSELedger select * from ACCOUNT.DBO.LEDGER          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode >= @FromCltCode          
 And cltcode <= @ToCltCode          
          
--BSE Ledger          
 insert into #EDTBSELedger select * from ACCOUNTBSE.DBO.LEDGER           
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode >= @FromCltCode          
 And cltcode <= @ToCltCode          
          
 insert into #VDTBSELedger select * from ACCOUNTBSE.DBO.LEDGER        where VDT <= @FromDate + ' 23:59:59'          
 and cltcode >= @FromCltCode          
 And cltcode <= @ToCltCode          
          
--FO Ledger          
/* insert into #EDTFOLedger select * from ACCOUNTFO.DBO.LEDGER           
 where EDT <= @FromDate + ' 23:59:59'          
 and cltcode >= @FromCltCode          
 And cltcode <= @ToCltCode          
          
 insert into #VDTFOLedger select * from ACCOUNTFO.DBO.LEDGER          
 where VDT <= @FromDate + ' 23:59:59'          
 and cltcode >= @FromCltCode          
 And cltcode <= @ToCltCode          */
          
end          
      
      
          
/*          
update #LedgerBalances set NSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21)  Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
update #LedgerBalances set NSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTNSELedger L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21)  Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
          
          
/*            
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #VDTNSELedger L, ACCOUNT.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
          
/*             
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
update #LedgerBalances set NSEBALANCE = NSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTNSELedger L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
          
/*           
update #LedgerBalances set BSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
update #LedgerBalances set BSEBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTBSELedger L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
          
/*              
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A       
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #VDTBSELedger L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
          
/*              
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A           
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
update #LedgerBalances set BSEBALANCE = BSEBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTBSELedger L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
          
/*              
update #LedgerBalances set NSEFOBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session         
*/          
          
/*update #LedgerBalances set NSEFOBALANCE = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTFOLedger L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp not in (2,15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               */
          
/*              
update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
/*update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #VDTFOLedger L, ACCOUNTFO.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               */
          
/*              
update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
*/          
          
/*update #LedgerBalances set NSEFOBALANCE = NSEFOBALANCE + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTFOLedger L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp in (15,21) Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               */
          
drop table #EDTNSELedger          
drop table #VDTNSELedger          
drop table #EDTBSELedger          
drop table #VDTBSELedger          
--drop table #EDTFOLedger          
--drop table #VDTFOLedger          
          
              
Select Exc='NSE', Vdt, CltCode,Amount=CONVERT(NUMERIC(18,4),isnull(Sum(Case When DrCr = 'D' Then Vamt Else -Vamt End),0) )              
Into #LdegerEstimate From ACCOUNT.DBO.LEDGER L, MSAJAG.DBO.Sett_Mst S               
Where L.narration Like '%' + RTrim(Sett_No) + 'NSECM' + RTrim(Sett_Type) + '%'               
And Vdt >= S.Start_Date And Vdt <= S.Sec_PayIn And Vdt <= @FromDate + ' 23:59:59'              
And Vtyp in (15,21) AND Edt >= @FromDate + ' 23:59:59' and L.cltcode >= @FromCltcode and L.cltcode <= @ToCltcode               
Group By VDT,CltCode              
              
Insert Into #LdegerEstimate               
Select Exc='BSE', Vdt,CltCode,Amount=CONVERT(NUMERIC(18,4),isnull(Sum(Case When DrCr = 'D' Then Vamt Else -Vamt End),0) )              
From ACCOUNTBSE.DBO.LEDGER L, BSEDB.DBO.Sett_Mst S               
Where L.narration Like '%' + RTrim(Sett_No) + 'BSECM' + RTrim(Sett_Type) + '%'               
And Vdt >= S.Start_Date And Vdt <= S.Sec_PayIn And Vdt <= @FromDate + ' 23:59:59'              
And Vtyp in (15,21) AND Edt >= @FromDate + ' 23:59:59' and L.cltcode >= @FromCltcode and L.cltcode <= @ToCltcode               
Group By VDT,CltCode               
              
update #LedgerBalances set NSEESTIMATED1 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L              
Where Vdt Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'NSE' ) Group By CltCode ) A              
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session               
              
update #LedgerBalances set NSEESTIMATED2 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L              
Where Vdt Not Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'NSE' ) Group By CltCode ) A              
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session               
              
update #LedgerBalances set BSEESTIMATED1 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L              
Where Vdt Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'BSE' ) Group By CltCode ) A              
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session               
              
update #LedgerBalances set BSEESTIMATED2 = Amount From (Select CltCode, Amount=IsNull(Sum(Amount),0) From #LdegerEstimate L              
Where Vdt Not Like (Select Left(Convert(Varchar,Min(Vdt),109),11) + '%' From #LdegerEstimate Where L.Exc = Exc And Exc = 'BSE') Group By CltCode ) A              
Where #LedgerBalances.cltcode=A.Cltcode and sessionid = @session               
              
update #LedgerBalances set FAACTUAL = Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp <> 2 Group By CltCode) A               
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
              
update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
              
update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp <> 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
              
update #LedgerBalances set FAACTUAL =  FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               
              
/*update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE VDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp <> 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               */
              
/*update #LedgerBalances set FAACTUAL = FAACTUAL + Amt From (SELECT CltCode, Amt = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FromDate + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= ldtcur              
And @FromDate BetWeen SDTCUR And ldtcur And Vtyp = 2 Group By CltCode) A              
where #LedgerBalances.cltcode=A.cltcode and sessionid = @session               */
              
Update #LedgerBalances Set NonCash = C.NonCash, Cash = C.Cash              
From MSAJAG.DBO.Collateral C               
Where Trans_Date Like @FromDate +'%'               
And #LedgerBalances.cltcode=C.Party_Code and sessionid = @session               
              
/*Update #LedgerBalances Set IMMargin = IsNull(Margin,0) From (Select Party_Code, Margin = Sum(PspanMargin)                
From NSEFO.DBO.FoMarginNew F Where Mdate = (Select Max(MDate) From NSEFO.DBO.FoMarginNew Where MDate <= @FromDate +' 23:59:59' )         
Group By Party_Code ) A              
Where #LedgerBalances.cltcode=A.Party_Code and sessionid = @session               */
              
/*Update #LedgerBalances Set VarMargin = IsNull(VMargin,0) From (Select Party_Code, VMargin = Sum(MtoM)                
From NSEFO.DBO.FoMarginNew F Where Mdate = (Select Max(MDate) From NSEFO.DBO.FoMarginNew Where MDate <= @FromDate +' 23:59:59' )         
Group By Party_Code ) A              
Where #LedgerBalances.cltcode=A.Party_Code and sessionid = @session        */
              
Update #LedgerBalances Set NonCash = (Case When (IMMargin + VarMargin) / 2 < NonCash Then  (IMMargin + VarMargin) / 2 Else nonCash End)         
where sessionid = @session               
              
Delete From #LedgerBalances               
Where NSEBALANCE   = 0               
And BSEBALANCE      = 0               
And NSEFOBALANCE  = 0               
And NSEESTIMATED1 = 0               
And NSEESTIMATED2 = 0               
And BSEESTIMATED1 = 0               
And BSEESTIMATED2 = 0               
And FAActual           = 0               
And NonCash           = 0               
And Cash                = 0               
And IMMargin           = 0               
And VarMargin         = 0              
and sessionid = @session               
          
--insert into LedgerBalances select * from #LedgerBalances              
--select * from #LedgerBalances  order by FamilyCode,CltCode          
/*          
if @Opt <> 'CLIENT'          
begin          
 if @Opt = 'BRANCH'          
 select FamilyCode,CLTCODE,ACNAME=C.Long_Name,          
 NSEBALANCE=Sum(NSEBALANCE),BSEBALANCE=Sum(BSEBALANCE),          
 NSEFOBALANCE=Sum(NSEFOBALANCE),NSEESTIMATED1=Sum(NSEESTIMATED1),           
 NSEESTIMATED2=Sum(NSEESTIMATED2),          
 BSEESTIMATED1=Sum(BSEESTIMATED1),BSEESTIMATED2=Sum(BSEESTIMATED2),          
 FAActual=Sum(FAActual),Res_Phone1,Cash=Sum(Cash),NonCash=Sum(NonCash),          
 IMMargin=Sum(IMMargin),VarMargin=Sum(VarMargin)           
 from LedgerBalances L, MSAJAG.DBO.Client1 C           
 Where C.Cl_Code = L.CltCode and sessionid=@session          
 Group By FamilyCode,c.branch_cd,C.Long_Name,Res_Phone1           
 Order By FamilyCode,CLTCODE,C.Long_Name,Res_Phone1          
          
end          
Else          
begin          
 select FamilyCode,CLTCODE,ACNAME,NSEBALANCE,BSEBALANCE,NSEFOBALANCE,NSEESTIMATED1,NSEESTIMATED2,           
 BSEESTIMATED1,BSEESTIMATED2,FAActual,Res_Phone1,Cash,NonCash,IMMargin,VarMargin           
 from LedgerBalances L,MSAJAG.DBO.ClientMaster C           
 Where C.Party_Code = L.CltCode and sessionid=@session          
 Order By FamilyCode,CLTCODE,C.Long_Name,Res_Phone1           
end          
*/            
if @reportopt='D'        
begin        
 select FamilyCode,CLTCODE,ACNAME,NSEBALANCE,BSEBALANCE,NSEFOBALANCE,NSEESTIMATED1,NSEESTIMATED2,           
 BSEESTIMATED1,BSEESTIMATED2,FAActual,Res_Phone1,Cash,NonCash,IMMargin,VarMargin           
 from #LedgerBalances L,MSAJAG.DBO.ClientMaster C           
 Where C.Party_Code = L.CltCode and sessionid=@session          
 Order By FamilyCode,CLTCODE,C.Long_Name,Res_Phone1           
end        
else        
begin        
-- select FamilyCode,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
-- sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
-- sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
-- sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
-- sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
-- sum(FAActual) as TotFAACTUAL,        
-- sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
-- sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
-- sum(FAActual -         
-- (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)         
-- + IMMargin + VarMargin - NONCASH - CASH) as TotFinTotalParty           
-- from #LedgerBalances L,MSAJAG.DBO.ClientMaster C           
-- Where C.Party_Code = L.CltCode and sessionid=@session          
-- group By FamilyCode        
-- Order By FamilyCode        
      
 if @Opt = 'BRANCH'      
 begin      
/*    
   select c.branch_cd as FamilyCode,b.branch as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
   sum(FAActual) as TotFAACTUAL,        
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
   sum(FAActual -         
   (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)         
   + IMMargin + VarMargin - NONCASH - CASH) as TotFinTotalParty           
   from #LedgerBalances L,MSAJAG.DBO.Client1 C , MSAJAG.DBO.Branch B          
   Where C.Cl_Code = L.CltCode and c.branch_cd=b.branch_code and sessionid=@session          
   group By c.branch_cd,b.branch      
   Order By c.branch_cd      
*/    
   select c.branch_cd as FamilyCode,b.branch as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
   sum(FAActual) as TotFAACTUAL,        
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty              
   from #LedgerBalances L,MSAJAG.DBO.Client1 C , MSAJAG.DBO.Branch B          
   Where C.Cl_Code = L.CltCode and c.branch_cd=b.branch_code and sessionid=@session          
   group By c.branch_cd,b.branch      
   Order By c.branch_cd      
    
 end      
 else if @Opt = 'FAMILY'      
 begin      
   select FamilyCode,FamilyCode as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
  sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
  sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
  sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
  sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
  sum(FAActual) as TotFAACTUAL,        
  sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
  sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
  sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty             
  from #LedgerBalances L,MSAJAG.DBO.ClientMaster C           
  Where C.Party_Code = L.CltCode and sessionid=@session          
  group By FamilyCode        
  Order By FamilyCode        
 end      
 else if @Opt = 'SUBBROKER'      
 begin      
   select c.sub_broker as FamilyCode,b.Name as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
   sum(FAActual) as TotFAACTUAL,        
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty              
   from #LedgerBalances L,MSAJAG.DBO.Client1 C,MSAJAG.DBO.SubBrokers B           
   Where C.Cl_Code = L.CltCode and c.sub_broker=b.sub_broker and sessionid=@session          
   group By c.sub_broker,b.Name      
   Order By c.sub_broker      
 end      
 else if @Opt = 'TRADER'      
 begin      
   select c.trader as FamilyCode,b.short_name as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
   sum(FAActual) as TotFAACTUAL,        
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty              
   from #LedgerBalances L,MSAJAG.DBO.Client1 C , MSAJAG.DBO.Branches B          
   Where C.Cl_Code = L.CltCode and c.branch_cd=b.branch_cd and sessionid=@session          
   group By c.trader,b.short_name      
   Order By c.trader      
 end      
 else if @Opt = 'AREA'      
 begin      
   select c.area as FamilyCode,b.description as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
   sum(FAActual) as TotFAACTUAL,        
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty              
   from #LedgerBalances L,MSAJAG.DBO.Client1 C,MSAJAG.DBO.Area B           
   Where C.Cl_Code = L.CltCode and c.area=b.areacode and sessionid=@session          
   group By c.area,b.description      
   Order By c.area       
 end      
 else      
 begin      
   select c.cl_code as FamilyCode,c.short_name as AcName,sum(NSEBALANCE) as TotNSEBALANCE,sum(BSEBALANCE) as TotBSEBALANCE,sum(NSEFOBALANCE) as TotNSEFOBALANCE,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,        
   sum(NSEESTIMATED1) as TotNSEESTIMATED1,sum(NSEESTIMATED2) as TotNSEESTIMATED2,           
   sum(BSEESTIMATED1) as TotBSEESTIMATED1,sum(BSEESTIMATED2) as TotBSEESTIMATED2,        
   sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,        
   sum(FAActual) as TotFAACTUAL,        
   sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,        
   sum(Cash) as TotCASH,sum(NonCash) as TotNonCash, sum(IMMargin) as TotIMMargin,sum(VarMargin) as TotVarMargin,        
   sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty           
   from #LedgerBalances L,MSAJAG.DBO.Client1 C           
   Where C.Cl_Code = L.CltCode and sessionid=@session          
   group By c.cl_code,c.Short_Name      
   Order By cl_code        
 end      
end           
          
drop table #LedgerBalances

GO

-- --------------------------------------------------
-- PROCEDURE dbo.login
-- --------------------------------------------------
create Procedure login
@fldusername varchar (25)
as
select Fldusername ,fldpassword from tblpradnyausers 
where Fldusername like '%'+@fldusername+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MAP_MULTIPLE_RECO
-- --------------------------------------------------
CREATE PROCEDURE MAP_MULTIPLE_RECO
	@CLTCODE VARCHAR(10),
	@REFERENCENO VARCHAR(25),
	@VDT VARCHAR(11),
	@VALUEDATE VARCHAR(11),
	@ACTION BIT
AS


CREATE TABLE #RECO_MAPPING
(
	L1_VNO VARCHAR(12),
	L_VDT DATETIME,
	L1_DDNO VARCHAR(25),
	BR_REFERENCENO VARCHAR(25),
	L1_RELAMT MONEY,
	BR_AMOUNT MONEY,
	BR_CROSSREFERENCENO BIGINT,
	BR_VALUEDATE DATETIME,
	L1_SNO BIGINT,
	BR_SNO BIGINT
)

INSERT INTO
	#RECO_MAPPING
SELECT 
	L1.VNO,
	L.VDT,
	L1.DDNO, 
	BR.REFERENCENO,
	L1.RELAMT,
	BR.AMOUNT,
	MAX(CROSSREFERENCENO),
	VALUEDATE,
	MAX(L1_SNO),
	MAX(BR_SNO)
FROM 
	LEDGER1 L1, 
	(
		SELECT 
			VNO, 
			VTYP, 
			BOOKTYPE, 
			VDT 
		FROM
			LEDGER 
		WHERE 
			CLTCODE = @CLTCODE
			AND VDT LIKE @VDT + '%'
			AND VTYP = 3
	) L,
	(
		SELECT 
			REFERENCENO, 
			AMOUNT, 
			CLTCODE,
			CROSSREFERENCENO,
			VALUEDATE
			BR_SNO 
		FROM 
			BANKRECO 
		WHERE 
			CLTCODE = @CLTCODE 
			AND REFERENCENO = @REFERENCENO 
			AND STATUS = 'UNMATCHED' 
			AND VALUEDATE LIKE @VALUEDATE + '%'
	)BR
WHERE 
	L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND BR.REFERENCENO = L1.DDNO 
	AND BR.AMOUNT = L1.RELAMT 
	AND BR.CLTCODE = @CLTCODE
	AND L1.RELDT = ''
GROUP BY 
	L1.VNO,
	L.VDT,
	L1.DDNO, 
	BR.REFERENCENO,
	L1.RELAMT,
	BR.AMOUNT,
	VALUEDATE
HAVING COUNT(1) = 1

IF @ACTION = 0
BEGIN
	SELECT 	
		L1_VNO,
		CONVERT(VARCHAR(11), L_VDT, 103),
		L1_DDNO,
		BR_REFERENCENO,
		L1_RELAMT,
		BR_AMOUNT,
		BR_CROSSREFERENCENO,
		CONVERT(VARCHAR(11), BR_VALUEDATE, 103)
	FROM 
		#RECO_MAPPING
END
ELSE
BEGIN
	UPDATE 
		L1
	SET
		RELDT = BR_VALUEDATE,
		REFNO = BR_CROSSREFERENCENO
	FROM
		LEDGER1 L1,
		#RECO_MAPPING R
	WHERE
		L1.L1_SNO = R.L1_SNO

	UPDATE
		BR
	SET
		STATUS = 'MATCHED'
	FROM
		BANKRECO BR,
		#RECO_MAPPING R		
	WHERE
		BR.BR_SNO = R.BR_SNO
		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MARGINJVUPLOAD_BULK
-- --------------------------------------------------

CREATE PROC [dbo].[MARGINJVUPLOAD_BULK]
	@FNAME VARCHAR(100),
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@MULTI BIT,
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20)

AS
/*
	DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\marginjvs\Sample.Csv' And 
	EXEC MARGINJVUPLOAD_BULK 'D:\Backoffice\marginjvs\Sample.Csv', 'TEST', 24, '01', 0, 'NSE', 'CAPITAL'
	Exec MARGINJVUPLOAD_BULK 'D:\BackOffice\MarginJVs\', 'JAYDEEP', 24, '01', 1, 'NSE', 'CAPITAL'
	SELECT * FROM #RECPAY_TABLE
	SELECT @@TRANCOUNT
	SELECT * FROM #RECPAY_TABLE
	ROLLBACK
	SP CREATED BY		-	YATIN
	SP CREATED ON		-	JUL, 24 2006
*/
	SET NOCOUNT ON
	SELECT @UNAME = 'B_' + LTRIM(RTRIM(@UNAME))
	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000),
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@MARGINCODE VARCHAR(10),
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT,
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT,
		@@L2CUR AS CURSOR,
		@@BRANCHFLAG AS SMALLINT,
		@@L2VNO AS VARCHAR(12)

/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)
	
	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	BEGIN TRAN
/*
		SELECT 
			@@ERROR_COUNT = COUNT(1) 
		FROM
			(SELECT 
				U_FILENAME 
			FROM 
				V2_UPLOADED_FILES
			WHERE 
				U_FILENAME = @FNAME 
				AND U_MODULE = 'MARGIN JV UPLOAD') A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END

*/
	CREATE TABLE #RECPAY_TABLE_TMP
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		MARGINCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500)
	)

	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		MARGINCODE VARCHAR(10),
		MARGINNAME VARCHAR(100),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		CLTCOST SMALLINT NULL,
		MARGINCOST SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]
	IF @MULTI = 0
		BEGIN
			CREATE TABLE [#RECPAY_TABLE_LNO]
			(
				SNO INT ,
				LNO INT IDENTITY (1, 1) NOT NULL
			) ON [PRIMARY]
		END
	ELSE
		BEGIN
			CREATE TABLE [#RECPAY_TABLE_LNO_M]
			(
				DRCR VARCHAR(1),
				LNO INT IDENTITY (1, 1) NOT NULL
			) ON [PRIMARY]
			CREATE TABLE [#RECPAY_TABLE_LNO_M1]
			(
				SRNO INT,
				MARGINCODE VARCHAR(10),
				DRCR VARCHAR(1)
			) ON [PRIMARY]
		END

	SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
	EXEC(@@SQL)

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SOME ERROR IN BULK UPLOAD, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

/*	      INSERT INTO V2_UPLOADED_FILES
	      SELECT
			@FNAME,
			@FNAME,
			COUNT(1),
			'B',
			GETDATE(),
			@UNAME,
			'MARGIN JV UPLOAD'
*/
	INSERT INTO #RECPAY_TABLE
		(SRNO,
		VVDT,
		EEDT,
		CLTCODE,
		MARGINCODE,
		DRCR,
		AMOUNT,
		NARRATION)
	SELECT
		SRNO,
		VVDT,
		EEDT,
		UPPER(CLTCODE),
		UPPER(MARGINCODE),
		DRCR,
		AMOUNT,
		LEFT(NARRATION, 234)
	FROM #RECPAY_TABLE_TMP

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SYSTEM ERROR, FILE COULD NOT BE UPLOADED.'
			RETURN
		END


	UPDATE
		#RECPAY_TABLE
	SET
		VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
		EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2))

	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
		@@BRANCHFLAG = BRANCHFLAG
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = A.LONGNAME,
					CLTCOST = C.COSTCODE
		      FROM ACMAST A, PARAMETER P, COSTMAST C
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
			AND A.ACCAT IN (4, 104)
			AND A.BRANCHCODE = C.COSTNAME
			AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = A.LONGNAME,
					CLTCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			FROM ACMAST A, PARAMETER P
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
			AND A.ACCAT IN (4, 104)
			AND A.BRANCHCODE = 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					MARGINNAME = A.LONGNAME,
					MARGINCOST = C.COSTCODE
			FROM ACMAST A, COSTMAST C
			WHERE A.CLTCODE = #RECPAY_TABLE.MARGINCODE
			AND A.BRANCHCODE = C.COSTNAME
			AND A.ACCAT = 14
			AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					MARGINNAME = A.LONGNAME,
					MARGINCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			FROM ACMAST A
			WHERE A.CLTCODE = #RECPAY_TABLE.MARGINCODE
			AND A.ACCAT = 14
			AND A.BRANCHCODE = 'ALL'

		END
	ELSE
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = A.LONGNAME
			FROM ACMAST A, PARAMETER P
			WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
			AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
			AND A.ACCAT IN (4, 104)

			UPDATE
				#RECPAY_TABLE
				SET
					MARGINNAME = A.LONGNAME
			FROM ACMAST A
			WHERE A.CLTCODE = #RECPAY_TABLE.MARGINCODE
			AND A.ACCAT = 14
		END


/* '--------------------------VALIDATION FOR MISSING CLIENT CODES------------------------*/

	SELECT
		CLTCODE
	INTO
		#MISS_CLTS
	FROM
		#RECPAY_TABLE R
	WHERE
		NOT EXISTS
				(SELECT
					CLTCODE
				FROM
					ACMAST A
				WHERE
					R.CLTCODE = A.CLTCODE
					AND ACCAT IN (4, 104)
				)

	SELECT @@ERROR_COUNT = COUNT(1) FROM #MISS_CLTS

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FOLLOWING CLIENTS DO NOT EXISTS IN MASTER, PLEASE CHECK.'
			SELECT
				CLTCODE
			FROM
				#MISS_CLTS

			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #MISS_CLTS
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END


/* '--------------------------VALIDATION FOR MISSING MARGIN CODES------------------------*/

	SELECT
		MARGINCODE
	INTO
		#MISS_MARGINS
	FROM
		#RECPAY_TABLE R
	WHERE
		MARGINCODE IS NOT NULL
		AND NOT EXISTS
				(SELECT
					CLTCODE
				FROM
					ACMAST A
				WHERE
					R.MARGINCODE = A.CLTCODE
					AND ACCAT = 14
				)

	SELECT @@ERROR_COUNT = COUNT(1) FROM #MISS_MARGINS

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FOLLOWING MARGIN CODE(S) DO NOT EXISTS IN MASTER, PLEASE CHECK.'
			SELECT
				MARGINCODE
			FROM
				#MISS_MARGINS
			
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #MISS_MARGINS
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/* '--------------------------VALIDATION FOR AVAILABLE MARGIN BALANCE------------------------*/
	IF @MULTI = 0
		BEGIN
			SELECT
				CLTCODE,
				MARGINCODE,
				AMOUNT = SUM(AMOUNT)
			INTO
				#MARGIN_AMOUNT
			FROM
				#RECPAY_TABLE
			WHERE
				DRCR = 'D'
				AND MARGINCODE IS NOT NULL
				AND MARGINCODE <> ''
			GROUP BY
				CLTCODE,
				MARGINCODE
		
			SELECT
				CLTCODE = M.PARTY_CODE,
				MARGINCODE = M.MCLTCODE,
				AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)
			INTO
				#TRANSACTIONS
			FROM
				MARGINLEDGER M
			WHERE
				VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
				AND EXISTS
				(
				SELECT
					CLTCODE, MARGINCODE
				FROM
					#MARGIN_AMOUNT A
				WHERE
					A.CLTCODE = M.PARTY_CODE
					AND A.MARGINCODE = M.MCLTCODE
				)
			GROUP BY
				PARTY_CODE,
				MCLTCODE
		
			SELECT
				@@ERROR_COUNT = COUNT(1)
			FROM
				#TRANSACTIONS
			WHERE
				AMOUNT > 0
		
			IF @@ERROR_COUNT > 0
				BEGIN
					SELECT RESULT = 'FOLLOWING CLIENTS ARE ALREADY HAVING DEBIT MARGIN BALANCE. PLEASE CHECK THE TRANSACTIONS...'
					UNION ALL
					SELECT
						RESULT = 'CLIENT CODE: ' + CLTCODE + ', CURRENT MARGIN BALANCE: ' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ', MARGINCODE: ' + MARGINCODE
					FROM
						#TRANSACTIONS
					DROP TABLE #RECPAY_TABLE_TMP
					DROP TABLE #RECPAY_TABLE
					DROP TABLE #TRANSACTIONS
					DROP TABLE #MARGIN_AMOUNT
					ROLLBACK TRAN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
					RETURN
				END
		
			SELECT
				CLTCODE = A.CLTCODE,
				MARGINCODE = A.MARGINCODE,
				JVAMOUNT = A.AMOUNT,
				BALANCE = ISNULL(ABS(T.AMOUNT), 0)
			INTO
				#TRANSACTIONS_1
			FROM
				#MARGIN_AMOUNT A
				LEFT OUTER JOIN #TRANSACTIONS T
				ON A.CLTCODE = T.CLTCODE AND A.MARGINCODE = T.MARGINCODE AND T.AMOUNT < 0
		
			SELECT
				@@ERROR_COUNT = COUNT(1)
			FROM
				#TRANSACTIONS_1
			WHERE
				BALANCE < JVAMOUNT
		
			IF @@ERROR_COUNT > 0
				BEGIN
					SELECT RESULT = 'FOLLOWING CLIENTS ARE NOT HAVING ENOUGH CREDIT BALANCE AGAINST WHICH YOU ARE GIVING DEBIT.'
					UNION ALL
					SELECT
						RESULT = 'CLTCODE: ' + CLTCODE + ', AVAILABLE BALANCE: ' + LTRIM(RTRIM(CONVERT(VARCHAR, BALANCE))) + ', ENTRY AMOUNT: ' + LTRIM(RTRIM(CONVERT(VARCHAR, JVAMOUNT)))
					FROM
						#TRANSACTIONS_1
					WHERE
						BALANCE < JVAMOUNT
		
					DROP TABLE #RECPAY_TABLE_TMP
					DROP TABLE #RECPAY_TABLE
					DROP TABLE #TRANSACTIONS
					DROP TABLE #TRANSACTIONS_1
					DROP TABLE #MARGIN_AMOUNT
					ROLLBACK TRAN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
					RETURN
				END
		END
/*	SELECT
		CLTCODE = M.PARTY_CODE,
		AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)
	FROM
		MARGINLEDGER M
	WHERE
		VDT BETWEEN 'APR  1 2006' AND 'MAR 31 2007 23:59'
--		AND PARTY_CODE IN ('HOC0000001', 'TRI0000001')
	GROUP BY PARTY_CODE*/

/* '--------------------------VALIDATION FOR MULTIPLE MARGIN CODES------------------------*/
	IF @MULTI = 0
		BEGIN
			CREATE TABLE #MULTI_MARGIN
			(
				SRNO INT,
				MARGINCODE VARCHAR(10)
			)
			INSERT INTO
				#MULTI_MARGIN
			SELECT
				R.SRNO,
				R.MARGINCODE
			FROM
				#RECPAY_TABLE R,
				(
					SELECT
						SRNO,
						COUNTER = COUNT(1)
					FROM
						#RECPAY_TABLE
					WHERE
						MARGINCODE IS NOT NULL
						AND MARGINCODE <> ''
					GROUP BY
						SRNO
					HAVING
						COUNT(1) > 1
				) A
			WHERE
				R.SRNO = A.SRNO

			SELECT
				@@ERROR_COUNT = COUNT(1)
			FROM
				#MULTI_MARGIN

			IF @@ERROR_COUNT > 0
				BEGIN
					SELECT RESULT = 'MULTIPLE MARGIN CODES ON BOTH THE SIDES ARE NOT ALLOWED. PLEASE CHECK THE FOLLOWING ROWS...'
					UNION ALL
					SELECT
						RESULT = LTRIM(RTRIM(CONVERT(VARCHAR, SRNO))) + ', ' + MARGINCODE
					FROM
						#MULTI_MARGIN
					DROP TABLE #RECPAY_TABLE_TMP
					DROP TABLE #RECPAY_TABLE
					DROP TABLE #MULTI_MARGIN
					ROLLBACK TRAN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
					RETURN
				END
		END

/*--------------------------VALIDATION FOR NO MARGIN CODES IN ENTIRE VOUCHER------------------------*/
		CREATE TABLE #ZERO_MARGIN
		(
			SRNO INT
		)
		INSERT INTO
			#ZERO_MARGIN
		SELECT
			R.SRNO
		FROM
			#RECPAY_TABLE R
		WHERE
			(	R.MARGINCODE IS NULL
				OR R.MARGINCODE = ''
			)
			AND NOT EXISTS
				(
					SELECT DISTINCT
						SRNO
					FROM
						#RECPAY_TABLE R1
					WHERE
						MARGINCODE IS NOT NULL
						AND MARGINCODE <> ''
						AND R.SRNO = R1.SRNO
				)
		GROUP BY
			R.SRNO

		SELECT
			@@ERROR_COUNT = COUNT(1)
		FROM
			#ZERO_MARGIN

		IF @@ERROR_COUNT > 0
			BEGIN
				SELECT RESULT = 'PLEASE CHECK THE FOLLOWING ROWS AS NO MARGIN CODES FOUND IN IT.'
				UNION ALL
				SELECT
					RESULT = 'SRNO :-' + LTRIM(RTRIM(CONVERT(VARCHAR, M.SRNO))) + ', CLIENT CODE :-' + M.CLTCODE + ', MARGIN CODE : NULL'
				FROM
					#RECPAY_TABLE M,
					#ZERO_MARGIN T
				WHERE
					M.SRNO = T.SRNO

				DROP TABLE #RECPAY_TABLE_TMP
				DROP TABLE #RECPAY_TABLE
				ROLLBACK TRAN
				DELETE FROM V2_UPLOADED_FILES
					WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
				RETURN
			END

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE NOT FALLING IN THE RESPECTIVE FINANCIAL YEAR.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/
	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE #RECPAY_TABLE
				SET CLTCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE CLTCODE IS NULL
			UPDATE #RECPAY_TABLE
				SET MARGINCOST = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE MARGINCOST IS NULL
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE
	IF @@ERROR_COUNT > 1
		BEGIN
			SELECT 'MULTIPLE VOUCHER DATES ARE NOT ALLOWED TO UPLOAD'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR VDTS LESS THAN EDTS------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM  #RECPAY_TABLE WHERE VDT > EDT
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'VOUCHER DATES IN SOME OF THE VOUCHERS FOUND GREATER THAN EFFECTIVE DATE.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/
	SELECT @@ERROR_COUNT = 0
	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT RESULTS = 'FILE CANNOT BE UPLOADED AS SOME MISMATCH FOUND IN FOLLOWING ROWS' UNION ALL
			SELECT DISTINCT
				RESULTS = LTRIM(RTRIM(CONVERT(VARCHAR, SRNO))) + ',' + CLTCODE + ',' + MARGINCODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT)))
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			RETURN
		END


/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/

	SELECT
		@@NOREC = COUNT(DISTINCT SRNO)
	FROM
		#RECPAY_TABLE

	 CREATE TABLE #VNO
	 (
		LASTVNO VARCHAR(12)
	 )         

	 INSERT INTO #VNO 
	 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

	 SELECT @@VNO = LASTVNO FROM #VNO

	UPDATE
		#RECPAY_TABLE
	SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)

/* '--------------------------AUTO GENERATION OF LNO ------------------------*/
	IF @MULTI = 0
		BEGIN
			SET @@LNOCUR = CURSOR FOR
				SELECT DISTINCT SRNO FROM #RECPAY_TABLE
			OPEN @@LNOCUR
				FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
			WHILE @@FETCH_STATUS = 0
				BEGIN
					INSERT INTO #RECPAY_TABLE_LNO
						(SNO)
					SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO ORDER BY MARGINCODE DESC
					UPDATE RP
						SET LNO = RL.LNO
					FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
					WHERE RP.SNO = RL.SNO
					TRUNCATE TABLE #RECPAY_TABLE_LNO
					FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
				END
			CLOSE @@LNOCUR
			DEALLOCATE @@LNOCUR
			DROP TABLE #RECPAY_TABLE_LNO
		END
	ELSE
		BEGIN
			INSERT INTO #RECPAY_TABLE_LNO_M1
			SELECT
				SRNO,
				MARGINCODE,
				DRCR
			FROM
				#RECPAY_TABLE
			GROUP BY
				SRNO,
				MARGINCODE,
				DRCR
			ORDER BY
				SRNO,
				DRCR,
				MARGINCODE
			SET @@LNOCUR = CURSOR FOR
				SELECT SRNO, MARGINCODE, DRCR FROM #RECPAY_TABLE_LNO_M1 ORDER BY SRNO, DRCR, MARGINCODE
			OPEN @@LNOCUR
				FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@MARGINCODE, @@DRCR
			WHILE @@FETCH_STATUS = 0
				BEGIN
					INSERT INTO #RECPAY_TABLE_LNO_M (DRCR) SELECT DRCR FROM #RECPAY_TABLE_LNO_M1 WHERE SRNO = @@LNOVNO ORDER BY DRCR
					UPDATE RP
						SET LNO = M.LNO
					FROM
						#RECPAY_TABLE RP,
						#RECPAY_TABLE_LNO_M M
					WHERE
						RP.SRNO = @@LNOVNO
						AND RP.MARGINCODE = @@MARGINCODE
						AND RP.DRCR = M.DRCR
					TRUNCATE TABLE #RECPAY_TABLE_LNO_M
					FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@MARGINCODE, @@DRCR
				END
			CLOSE @@LNOCUR
			DEALLOCATE @@LNOCUR
			DROP TABLE #RECPAY_TABLE_LNO_M
		END
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/
/*===========================================
	CREATING FULL LEDGER RECORD AND INSERTING IN ONE SHOT
===========================================*/
	SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0
	INSERT INTO
		#LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		MARGINNAME,
		DRCR,
		VAMT = SUM(AMOUNT),
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = SUM(AMOUNT),
		NODAYS = 0,
		CDT = GETDATE(),
		MARGINCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE <> ''
		AND MARGINCODE IS NOT NULL
	GROUP BY
		VNO,
		EDT,
		LNO,
		MARGINNAME,
		DRCR,
		VDT,
		MARGINCODE,
		NARRATION


	INSERT INTO
		#LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMOUNT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMOUNT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE = ''
		OR MARGINCODE IS NULL

	INSERT INTO
		LEDGER
	SELECT
		*
	FROM
		#LEDGER

	IF @@ERROR <> 0
		BEGIN
			DROP TABLE #LEDGER
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #RECPAY_TABLE_TMP
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			SELECT 'DUE TO SOME ERROR IN LEDGER POSTING, FILE COULD NOT BE UPLOADED.'
			RETURN
		END
	DROP TABLE #LEDGER
/*==========================
	INSERTING MARGINLEDGER RECORD
===========================*/
	SELECT * INTO #MARGINLEDGER FROM MARGINLEDGER WHERE 1 = 0
	INSERT INTO
		#MARGINLEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		LNO,
		DRCR,
		VDT,
		AMOUNT,
		CLTCODE,
		EXCHANGE = @EXCHANGE,
		SEGMENT = @SEGMENT,
		SETT_NO = 0,
		SETT_TYPE = '',
		BOOKTYPE = @BOOKTYPE,
		MARGINCODE
	FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE IS NOT NULL
		AND MARGINCODE <> ''

	INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER

	IF @@ERROR <> 0
		BEGIN
			DROP TABLE #RECPAY_TABLE
			DROP TABLE #RECPAY_TABLE_TMP
			ROLLBACK TRAN
			DELETE FROM V2_UPLOADED_FILES
				WHERE U_FILENAME = @FNAME AND U_MODULE = 'MARGIN JV UPLOAD'
			SELECT 'DUE TO SOME ERROR IN MARGINLEDGER POSTING, FILE COULD NOT BE UPLOADED.'
			RETURN
		END
	DROP TABLE #MARGINLEDGER

/*==============================
	LEDGER3 RECORD
==============================*/
	SELECT Naratno,Narr,Refno,Vtyp,Vno,Booktype INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0
	INSERT
	INTO #LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE <> ''
		AND MARGINCODE IS NOT NULL
	GROUP BY
		LNO,
		NARRATION,
		VNO


	INSERT
	INTO #LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE
	WHERE
		MARGINCODE = ''
		OR MARGINCODE IS NULL
	INSERT INTO LEDGER3 SELECT * FROM #LEDGER3
	DROP TABLE #LEDGER3

/*==============================
	LEDGER2 POSTING
==============================*/
	IF @@BRANCHFLAG = 1
		BEGIN
			DELETE FROM TEMPLEDGER2
				WHERE SESSIONID = '9999999999'
			INSERT INTO TEMPLEDGER2
			SELECT
				'BRANCH',
				C.COSTNAME,
				AMOUNT,
				VTYP = @VTYP,
				VNO,
				LNO,
				DRCR,
				'0',
				BOOKTYPE = @BOOKTYPE,
				SESSIONID = '9999999999',
				CLIENT_CODE = CLTCODE,
				'A',
				'0'
			FROM
				#RECPAY_TABLE RP,
				COSTMAST C
			WHERE
				RP.CLTCOST = C.COSTCODE
				AND (MARGINCODE = '' OR MARGINCODE IS NULL)
		
			INSERT INTO TEMPLEDGER2
			SELECT
				'BRANCH',
				C.COSTNAME,
				AMOUNT = SUM(AMOUNT),
				VTYP = @VTYP,
				VNO,
				LNO,
				DRCR,
				'0',
				BOOKTYPE = @BOOKTYPE,
				SESSIONID = '9999999999',
				CLIENT_CODE = MARGINCODE,
				'A',
				'0'
			FROM
				#RECPAY_TABLE RP,
				COSTMAST C
			WHERE
				RP.MARGINCOST = C.COSTCODE
				AND (MARGINCODE <> '' AND MARGINCODE IS NOT NULL)
			GROUP BY
				C.COSTNAME,
				VNO,
				LNO,
				DRCR,
				MARGINCODE


			SET @@L2CUR = CURSOR FOR
				SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
			OPEN @@L2CUR
			FETCH NEXT FROM @@L2CUR INTO @@L2VNO
			WHILE @@FETCH_STATUS = 0
				BEGIN
					EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
					IF @@ERROR <> 0
						BEGIN
							ROLLBACK TRAN
							IF @VTYP = 8
								BEGIN
									DELETE FROM V2_UPLOADED_FILES
										WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
								END
							ELSE
								BEGIN
									DELETE FROM V2_UPLOADED_FILES
										WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
								END
							SELECT 'DUE TO SOME ERROR IN LEDGER2 POSTING, FILE COULD NOT BE UPLOADED.'
							RETURN
						END
					FETCH NEXT FROM @@L2CUR INTO @@L2VNO
				END
				DELETE FROM TEMPLEDGER2
					WHERE SESSIONID = '9999999999'
				CLOSE @@L2CUR
				DEALLOCATE @@L2CUR
		END
	COMMIT TRAN
	SELECT RESULT = 'DATE UPLOADED SUCCESSFULLY'
	UNION ALL
	SELECT RESULT = 'CLTCODE:' + CLTCODE + ', MARGINCODE:' + ISNULL(MARGINCODE, '') + ', AMOUNT:' + CONVERT(VARCHAR, AMOUNT) + ', VNO:' + VNO FROM #RECPAY_TABLE
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MARGINRECPAYUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[MARGINRECPAYUPLOAD_BULK]    
 @FNAME VARCHAR(100),                      
 @UNAME VARCHAR(25),                      
 @USERCAT SMALLINT                      

AS                      
/*                      
begin tran                      
SP_HELPTRIGGER LEDGER                      
LEDGER_TRG_BILL                      
LEDGER_TRG                      
Exec MARGINRECPAYUPLOAD_BULK 'E:\BackOffice\RecPayFiles\MARGINRecpay_TEST1.csv', 'JAYDEEP', 388                      
ROLLBACK
SELECT TOP 1 * FROM LEDGER3                      
SELECT TOP 1 * FROM LEDGER_TRG                      
ROLLBACK                      
*/                      
SET NOCOUNT ON                      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                      
DECLARE                      
 @@STD_DATE VARCHAR(11),                      
 @@LST_DATE VARCHAR(11),                      
 @@BRANCHFLAG AS TINYINT,                      
 @@VNOFLAG AS TINYINT,                      
 @@VNOMETHOD INT,                      
 @@ACNAME CHAR(100),                      
 @@BOOKTYPE CHAR(2),                      
 @@MICRNO VARCHAR(10),                      
 @@DRCR VARCHAR(1),                      
 @@VTYP SMALLINT,                      
 @@BANK_CODE VARCHAR(100),                      
 @@BACKDAYS INT,                      
 @@BACKDATE VARCHAR(11),                      
 @@BRNCOUNT   TINYINT,                      
 @@MonthlyVdt VARCHAR(11),                      
 @@SERIAL_NO INT,                      
 @@COSTCODECOUNT TINYINT,                      
 @@COSTCODEUPDATES CURSOR,                      
 @@NEWVNO AS VARCHAR(12),                      
 @@MAXCOUNT AS INT,                      
 @@VDT AS VARCHAR(11),                      
 @@BANKBRANCH AS VARCHAR(10),                      
 @@BANKCOST AS NUMERIC,                      
 @@LNOCUR AS CURSOR,                      
 @@VNOCUR AS CURSOR,                      
 @@LNOVNO AS VARCHAR(12),                      
 @@MAXVNO AS INT,                      
 @@L2CUR AS CURSOR,                      
 @@L2VNO AS VARCHAR(12),                      
 @@ERROR_COUNT AS INT,                      
 @@FILEEXISTS AS INT,                      
 @@SQL AS VARCHAR(2000)                      
                      
/*SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT                      
   U_FILENAME                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                      
  RETURN                      
 END      */                
CREATE TABLE #FEXIST                      
(                      
 F1 SMALLINT,                      
 F2 SMALLINT,                      
 F3 SMALLINT                      
)                      
SELECT @@SQL = "INSERT INTO "                      
SELECT @@SQL = @@SQL + " #FEXIST "                      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                      
                      
EXEC(@@SQL)                      
                      
SELECT                      
 @@FILEEXISTS = F1                      
FROM                      
 #FEXIST                      
                      
IF @@FILEEXISTS = 0                      
 BEGIN                      
  DROP TABLE #FEXIST                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                      
  RETURN                      
 END                      
DROP TABLE #FEXIST                      
              
BEGIN TRAN                      
CREATE TABLE #RECPAY_TABLE_TMP                      
(                      
 SERIAL_NO INT,                      
 EDATE VARCHAR(20),                      
 VOUCHER_DATE VARCHAR(20),                      
 CLIENT_CODE VARCHAR(50),  
 MARGIN_CODE VARCHAR(50),          
 AMOUNT MONEY,                      
 DRCR VARCHAR(1),                      
 NARRATION VARCHAR(234),                      
 BANK_CODE VARCHAR(10),                      
 BANK_NAME VARCHAR(100),                      
 REF_NO VARCHAR(15),                      
 BRANCHCODE VARCHAR(20),                      
 BRANCH_NAME VARCHAR(50),                      
 CHQ_MODE VARCHAR(1),             
 CHQ_DATE VARCHAR(20),                      
 CHQ_NAME VARCHAR(100),                      
 CL_MODE VARCHAR(1)                      
)                      
CREATE TABLE [#RECPAY_TABLE]                      
 (                      
  SERIAL_NO INT,                      
  EDATE VARCHAR(20),                      
  VOUCHER_DATE VARCHAR(20),                      
  CLIENT_CODE VARCHAR(50),   
  MARGIN_CODE VARCHAR(50),   
  AMOUNT MONEY,                      
  DRCR VARCHAR(1),                      
  NARRATION VARCHAR(234),                      
  BANK_CODE VARCHAR(10),                      
  BANK_NAME VARCHAR(100),                      
  REF_NO VARCHAR(15),                      
  BRANCHCODE VARCHAR(20),                      
  BRANCH_NAME VARCHAR(50),                      
  CHQ_MODE VARCHAR(1),                      
  CHQ_DATE VARCHAR(20),                      
  CHQ_NAME VARCHAR(100),                      
  CL_MODE VARCHAR(1),                      
  SNO INT IDENTITY (1, 1) NOT NULL ,                      
  VDT DATETIME NULL ,                      
  FYSTART DATETIME NULL ,                      
  FYEND DATETIME NULL ,                      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                      
  EDT DATETIME NULL ,                      
  DDDT DATETIME NULL ,                      
  VNO VARCHAR (12) NULL ,                  
  VTYP SMALLINT NULL ,                      
  ACNAME VARCHAR (100) NULL ,                      
  COSTCODE SMALLINT NULL,                      
  BANKCOST SMALLINT NULL,                      
  LNO SMALLINT NOT NULL DEFAULT(0),                      
  BANKNAME VARCHAR(100) NULL,                      
  MICRNO INT NULL,                      
  BOOKTYPE VARCHAR(2) NULL,                      
 ) ON [PRIMARY]                      
                      
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n',FIRSTROW = 2, KEEPNULLS) "                      
EXEC (@@SQL)    

IF @@ERROR <> 0                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                      
  RETURN                      
 END                      
INSERT INTO                      
 V2_UPLOADED_FILES                      
SELECT                      
 @FNAME,                      
 @FNAME,                      
 CNT = COUNT(1),                      
 'B',                      
 GETDATE(),                      
 @UNAME,                      
 'RECEIPT/PAYMENT UPLOAD'                      
                      
INSERT INTO                      
 #RECPAY_TABLE                      
 (                      
  SERIAL_NO,                      
  EDATE,                      
  VOUCHER_DATE,                      
  CLIENT_CODE,   
  MARGIN_CODE,                     
  AMOUNT,                      
  DRCR,                      
  NARRATION,                      
  BANK_CODE,                      
  BANK_NAME,                      
  REF_NO,                      
  BRANCHCODE,                      
  BRANCH_NAME,                      
  CHQ_MODE,                      
  CHQ_DATE,                      
  CHQ_NAME,     
  CL_MODE                      
 )                      
SELECT                      
 SERIAL_NO,                      
 EDATE,                      
 VOUCHER_DATE,                      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                      
 UPPER(LTRIM(RTRIM(MARGIN_CODE))),  
 AMOUNT,                      
 UPPER(LTRIM(RTRIM(DRCR))),                      
 NARRATION,                      
 UPPER(LTRIM(RTRIM(BANK_CODE))),                      
 UPPER(LTRIM(RTRIM(BANK_NAME))),                      
 REF_NO,                  
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                      
 CHQ_DATE,                      
 CHQ_NAME,                      
 CL_MODE                      
FROM                      
 #RECPAY_TABLE_TMP                      
                      
UPDATE                      
 #RECPAY_TABLE                      
SET                
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                      
                
                
SELECT TOP 1                      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                      
FROM                      
 #RECPAY_TABLE                      
                
                
SELECT                      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                      
 @@BRANCHFLAG = BRANCHFLAG,                      
 @@VNOFLAG = VNOFLAG                      
FROM                      
 PARAMETER                      
WHERE                      
 @@VDT BETWEEN SDTCUR AND LDTCUR                   
                      
IF @@VNOFLAG <> 0                 
BEGIN                     
 SELECT                      
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
 FROM                      
  #RECPAY_TABLE                      
                       
 IF @@ERROR_COUNT > 1                      
  BEGIN                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRANSACTION                      
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                      
   RETURN                      
  END                    
END                  
                      
                      
IF @@BRANCHFLAG = 1                  
 BEGIN                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = A.BRANCHCODE,                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = C.COSTCODE,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   (SELECT * FROM ACMAST WHERE ACCAT = 14) A, PARAMETER P, COSTMAST C, (SELECT * FROM ACMAST WHERE ACCAT = 2) B, (SELECT * FROM ACMAST WHERE ACCAT = 4) A1
  WHERE                      
   A.CLTCODE = MARGIN_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND A1.CLTCODE = CLIENT_CODE
   AND P.CURYEAR = 1                      
   AND A.BRANCHCODE = COSTNAME                      
                        
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   (SELECT * FROM ACMAST WHERE ACCAT = 14) A, PARAMETER P, COSTMAST C, (SELECT * FROM ACMAST WHERE ACCAT = 2) B, (SELECT * FROM ACMAST WHERE ACCAT = 4) A1
  WHERE                      
   A.CLTCODE = MARGIN_CODE              
   AND B.CLTCODE = BANK_CODE                      
   AND P.CURYEAR = 1                      
   AND A1.CLTCODE = CLIENT_CODE
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                      
                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = 'HO',                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   (SELECT * FROM ACMAST WHERE ACCAT = 14) A, PARAMETER P, COSTMAST C, (SELECT * FROM ACMAST WHERE ACCAT = 2) B, (SELECT * FROM ACMAST WHERE ACCAT = 4) A1
  WHERE                      
   A.CLTCODE = MARGIN_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND P.CURYEAR = 1                      
   AND A1.CLTCODE = CLIENT_CODE
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                      
 END                      
ELSE                      
 BEGIN                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   FYSTART = @@STD_DATE,                      
   FYEND = @@LST_DATE + ' 23:59:59',                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,             
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   (SELECT * FROM ACMAST WHERE ACCAT = 14) A, (SELECT * FROM ACMAST WHERE ACCAT = 2) B, (SELECT * FROM ACMAST WHERE ACCAT = 4) A1
  WHERE                      
   A.CLTCODE = MARGIN_CODE                      
   AND B.CLTCODE = BANK_CODE
   AND A1.CLTCODE = CLIENT_CODE                      
 END                      
                
                     
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                      
                      
SELECT                
 SERIAL_NO, VOUCHER_DATE                
INTO #DUP_VDTS                
FROM                
 #RECPAY_TABLE                
GROUP BY SERIAL_NO, VOUCHER_DATE                
                
SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS                
GROUP BY SERIAL_NO                
HAVING COUNT(1) > 1                
                
 IF @@ERROR_COUNT > 1                      
  BEGIN                      
   SELECT                      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO', 'NA', 'NA'                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END                      
                
                
SELECT                 
 @@ERROR_COUNT = COUNT(SERIAL_NO)                 
FROM                 
 #RECPAY_TABLE                
WHERE VDT NOT BETWEEN FYSTART AND FYEND                
            
 IF @@ERROR_COUNT > 0                
  BEGIN                      
   SELECT               
    'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.', 'NA', 'NA'       
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END                      
                
SET @@ERROR_COUNT = 0                
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/                      
/*                      
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)                      
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'                      
   DROP TABLE #RecPay_Table_Tmp                      
   DROP TABLE #RecPay_Table                      
   ROLLBACK TRAN                      
   DELETE FROM V2_Uploaded_Files                      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END*/                      
                      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                      
 SELECT                      
  @@ERROR_COUNT = COUNT(1)                      
 FROM                      
  (                      
   SELECT                      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),            
    SERIAL_NO                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                      
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
  ) A                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT                      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                      
   UNION ALL                      
   SELECT                      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                      
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END                
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
 SELECT                      
   DISTINCT DRCR = (CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'D' ELSE 'C' END)          
 FROM                      
  #RECPAY_TABLE      
 GROUP BY SERIAL_NO      
 ) A                  
              
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  SELECT                      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE                      
  FROM                      
   V2_UPLOADED_FILES          
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
ELSE                      
 BEGIN                      
  SELECT TOP 1                      
   @@DRCR = DRCR,                      
   @@VTYP =                      
    (                      
    CASE                      
     WHEN DRCR = 'D'                      
     THEN 20                      
     ELSE 19                     
    END                      
    )                      
  FROM                      
   #RECPAY_TABLE           
          
  UPDATE R           
  SET VTYP =           
 CASE WHEN AMOUNT1 > 0 THEN 20 ELSE 19 END          
 FROM (SELECT AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), SERIAL_NO FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1, #RECPAY_TABLE R          
 WHERE R.SERIAL_NO = R1.SERIAL_NO          
                  
  /*UPDATE                      
   #RECPAY_TABLE                      
  SET VTYP =       
   (                      
   CASE                      
     WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) > 0                    
     THEN 3                      
     ELSE 2                      
    END                      
   )       */               
 END                
          
                
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE VDT > EDT                      
            IF @@ERROR_COUNT > 0                      
             BEGIN                      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
      END                      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE AMOUNT <= 0                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
  END            
               
SELECT          
@@ERROR_COUNT = COUNT(1)          
FROM          
(          
 SELECT DISTINCT          
  DDNO  = RP.REF_NO          
 FROM          
  #RECPAY_TABLE RP,          
  LEDGER1 L1  WITH(NOLOCK)          
 WHERE          
  L1.DDNO = RP.REF_NO          
  AND L1.BNKNAME = RP.BANK_NAME          
  AND L1.DD = RP.CHQ_MODE          
  AND L1.DRCR = @@DRCR          
  AND L1.VTYP = @@VTYP          
  AND RP.REF_NO <> '0'          
  AND ISNUMERIC(RP.REF_NO) = 1          
) A          
             
                  
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   RP.REF_NO, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE RP, LEDGER L,             
   LEDGER1 L1                      
    WITH(NOLOCK)                      
  WHERE                      
   L1.DDNO = RP.REF_NO                      
   AND L1.DD = RP.CHQ_MODE                      
   AND L1.DRCR = @@DRCR                      
   AND L1.VTYP = @@VTYP                      
   AND RP.CHQ_MODE <> 'N'             
   AND L.VTYP=@@VTYP            
   AND L.VNO=L1.VNO            
   AND L.BOOKTYPE=L1.BOOKTYPE            
   AND L.DRCR=@@DRCR             
   AND L.CLTCODE=RP.MARGIN_CODE            
                
                 
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   CLIENT_CODE, MARGIN_CODE, BANK_CODE                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS/MARGIN/BANK DO NOT EXIST', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   CLIENT_CODE + '/' + MARGIN_CODE + '/' + BANK_CODE, 'NA', 'NA'                  
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */                      
  SET @@VNOCUR = CURSOR FOR                      
   SELECT DISTINCT                      
    BANK_CODE,                      
    BOOKTYPE                      
   FROM                      
    #RECPAY_TABLE WITH(NOLOCK)                      
  OPEN @@VNOCUR                      
  FETCH NEXT                      
   FROM                      
    @@VNOCUR                      
   INTO                      
    @@BANK_CODE,                      
    @@BOOKTYPE                      
  WHILE @@FETCH_STATUS = 0                      
   BEGIN                      
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                
    SELECT                      
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)                      
    FROM                      
     USERWRITESTABLE                      
    WHERE                      
     USERCATEGORY = @USERCAT                      
     AND VTYP = @@VTYP                      
     AND BOOKTYPE = @@BOOKTYPE                      
    SELECT                      
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                      
    SELECT                      
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                      
    FROM                      
     #RECPAY_TABLE                      
    WHERE                      
     VDT < @@BACKDATE                      
    IF @@ERROR_COUNT > 0                      
     BEGIN                      
      SELECT                      
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                      
      DROP TABLE #RECPAY_TABLE_TMP                      
      DROP TABLE #RECPAY_TABLE                      
      ROLLBACK TRAN                      
      DELETE FROM V2_UPLOADED_FILES                      
      WHERE                      
       U_FILENAME = @FNAME                      
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
      RETURN                      
     END     
                
    IF @@BRANCHFLAG = 1                      
     BEGIN                      
      SELECT                      
       @@BANKBRANCH = BRANCHCODE,                      
       @@BANKCOST = ISNULL(C.COSTCODE, -1)                      
      FROM                      
       ACMAST A                      
        LEFT OUTER JOIN                      
        COSTMAST C                      
        ON                      
         (                      
          A.BRANCHCODE = C.COSTNAME                      
         )                      
      WHERE                      
    A.CLTCODE = @@BANK_CODE                      
      IF @@BANKBRANCH <> 'ALL'                      
       BEGIN                    
        UPDATE                      
         RP                      
          SET COSTCODE = @@BANKCOST                      
        FROM                      
         #RECPAY_TABLE RP,                      
         ACMAST A                      
        WHERE                      
         A.CLTCODE = RP.CLIENT_CODE                      
         AND A.BRANCHCODE = 'ALL'                      
        UPDATE                      
         #RECPAY_TABLE                      
          SET BANKCOST = @@BANKCOST                      
        WHERE                      
         BANK_CODE = @@BANK_CODE                      
       END                      
      ELSE                      
       BEGIN                      
        UPDATE                      
         #RECPAY_TABLE                      
          SET COSTCODE =                      
           (                      
            SELECT TOP 1                      
             COSTCODE                      
            FROM                      
             COSTMAST                      
            WHERE                      
             COSTNAME = 'HO'                      
           )                      
        WHERE                      
         COSTCODE = ''                      
         AND BANK_CODE = @@BANK_CODE                      
                            SET @@COSTCODEUPDATES = CURSOR FOR                      
                                       SELECT                      
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)                      
                                       FROM                      
                                             #RECPAY_TABLE WITH(NOLOCK)                      
                                       WHERE                      
          BANK_CODE = @@BANK_CODE                      
  GROUP BY                      
                                             SERIAL_NO                      
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1                      
                            OPEN @@COSTCODEUPDATES                      
                            FETCH NEXT                      
 FROM                      
                              @@COSTCODEUPDATES                      
                             INTO                      
              @@SERIAL_NO,                      
                              @@COSTCODECOUNT                      
   WHILE @@FETCH_STATUS = 0                      
                             BEGIN                      
          UPDATE                      
           #RECPAY_TABLE                      
            SET BANKCOST =                      
             (                      
              SELECT TOP 1                      
               COSTCODE                      
              FROM                      
               COSTMAST                      
              WHERE                      
               COSTNAME = 'HO'                      
             )                      
          WHERE                      
           (BANKCOST = ''   OR BANKCOST IS NULL)                      
           AND BANK_CODE = @@BANK_CODE                      
                                           AND SERIAL_NO = @@SERIAL_NO                      
                              FETCH NEXT                      
                               FROM                      
                     @@COSTCODEUPDATES                      
                               INTO                      
                                @@SERIAL_NO,                      
                                @@COSTCODECOUNT                      
                             END                      
                            CLOSE @@COSTCODEUPDATES                      
                            DEALLOCATE @@COSTCODEUPDATES                      
                  UPDATE                      
                   #RECPAY_TABLE                      
                    SET BANKCOST = COSTCODE                      
            WHERE                      
                   BANK_CODE = @@BANK_CODE                      
  AND (BANKCOST = ''   OR BANKCOST IS NULL)                      
       END                      
     END                      
    CREATE TABLE                      
     #BANK_VNO                      
     (                      
      SRNO INT,                      
      NEWSRNO INT IDENTITY (1, 1)                      
     )                      
    INSERT INTO                      
     #BANK_VNO                      
    SELECT                      
     DISTINCT SERIAL_NO                      
    FROM                      
     #RECPAY_TABLE                      
    WHERE                      
     BANK_CODE = @@BANK_CODE                      
     AND BOOKTYPE = @@BOOKTYPE                      
                      
   SELECT                      
     @@MAXCOUNT = COUNT(DISTINCT SNO)                      
    FROM                      
     #RECPAY_TABLE                      
                      
    SELECT TOP 1            
     @@VDT = VDT                      
    FROM                      
     #RECPAY_TABLE                      
    SELECT                      
     LASTVNO                      
    INTO #VNO                      
    FROM                      
     LASTVNO                      
    WHERE                      
     1 = 2                      
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                      
    INSERT                      
    INTO #VNO                      
     EXEC ACC_GENVNO_NEW                      
      @@VDT,                      
      @@VTYP,                      
      @@BOOKTYPE,                      
      @@STD_DATE,                      
      @@LST_DATE,                      
      @@MAXVNO                      
    SELECT                      
     @@NEWVNO = LASTVNO                      
    FROM                      
     #VNO                      
    UPDATE                      
     RP                      
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                      
    FROM                      
     #RECPAY_TABLE RP,                      
     #BANK_VNO BV                      
    WHERE                      
     RP.SERIAL_NO = BV.SRNO                      
   DROP TABLE #VNO                      
   DROP TABLE #BANK_VNO                      
  FETCH NEXT                      
   FROM @@VNOCUR                      
   INTO                      
    @@BANK_CODE,                      
    @@BOOKTYPE                      
 END                      
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */                      
UPDATE                      
 #RECPAY_TABLE                      
  SET LNO = 2                      
WHERE                      
 VNO IN                      
  (                      
   SELECT                      
    VNO                      
   FROM                      
 #RECPAY_TABLE                      
     WITH(NOLOCK)                      
   GROUP BY                      
    VNO                      
   HAVING                      
    COUNT(*) = 1                      
  )                      
SET @@LNOCUR = CURSOR FOR                      
 SELECT                      
  VNO                      
 FROM                      
  #RECPAY_TABLE                      
   WITH(NOLOCK)                      
 GROUP BY                      
  VNO                      
 HAVING                      
  COUNT(*) > 1                      
OPEN @@LNOCUR                      
FETCH NEXT                      
 FROM                      
  @@LNOCUR                      
 INTO                      
  @@LNOVNO                      
WHILE @@FETCH_STATUS = 0                      
 BEGIN                      
  CREATE TABLE                      
   [#LNOGEN]                      
    (                      
     VNO VARCHAR(12),                      
     SNO INT,                      
     LNO INT IDENTITY(1,1)                      
    )                      
  INSERT INTO                      
   #LNOGEN                      
    SELECT                      
     VNO,                      
     SNO                      
    FROM                      
     #RECPAY_TABLE                      
      WITH(NOLOCK)                      
    WHERE                      
     VNO = @@LNOVNO                      
    ORDER BY                      
     SNO                      
  UPDATE                      
   #RECPAY_TABLE                      
    SET LNO = L.LNO + 1                      
  FROM                      
   #LNOGEN L                      
  WHERE                      
   #RECPAY_TABLE.VNO = L.VNO                      
   AND #RECPAY_TABLE.SNO = L.SNO                      
   AND #RECPAY_TABLE.LNO = 0                      
  DROP TABLE #LNOGEN                      
  FETCH NEXT                      
   FROM                      
    @@LNOCUR                      
   INTO                      
    @@LNOVNO                      
 END                      
CLOSE @@LNOCUR                      
DEALLOCATE @@LNOCUR                      
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */                      
INSERT INTO                      
 LEDGER1                      
  (                      
   BNKNAME,                      
   BRNNAME,                      
   DD,                      
   DDNO,                      
   DDDT,                      
   RELDT,                      
   RELAMT,                      
   REFNO,                      
   RECEIPTNO,                      
   VTYP,                      
   VNO,                      
   LNO,                      
   DRCR,                      
   BOOKTYPE,                      
   MICRNO,                      
   SLIPNO,                      
   SLIPDATE,                      
   CHEQUEINNAME,                      
   CHQPRINTED,                      
   CLEAR_MODE                      
  )                      
SELECT                      
 BNKNAME = MAX(BANK_NAME),                      
 BRNNAME = MAX(BRANCH_NAME),                      
 DD = MAX(CHQ_MODE),                      
 DDNO = MAX(REF_NO),                      
 DDDT = MAX(DDDT),                      
 RELDT = '',                      
 RELAMT = ABS(SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)),                      
 REFNO = 0,                      
 RECEIPTNO = 0,                      
 VTYP,                      
 VNO,                      
 LNO = 2,                      
 @@DRCR,                    
 BOOKTYPE = BOOKTYPE,                      
 MICRNO = MICRNO,                      
 SLIPNO = 0,                      
 SLIPDATE = '',                      
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                      
 CHQPRINTED = 0,                      
 CLEAR_MODE = MAX(CL_MODE)                      
FROM                      
 #RECPAY_TABLE                      
GROUP BY                      
 VTYP,                      
 VNO,                      
 BOOKTYPE,                    
 MICRNO                    
                      
IF @@ERROR <> 0                      
 BEGIN                      
  SELECT                      
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
                      
/*================================                      
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK                      
=================================*/                      
CREATE TABLE #LEDGER                      
(                      
 VTYP SMALLINT,                      
 VNO VARCHAR(12),                      
 EDT DATETIME,                      
 LNO SMALLINT,                      
 ACNAME VARCHAR(100),                      
 DRCR VARCHAR(1),                      
 VAMT MONEY,                      
 VDT DATETIME,                      
 VNO1 VARCHAR(12),                      
 REFNO CHAR(12),                      
 BALAMT MONEY,                      
 NODAYS INT,                      
 CDT DATETIME,                      
 CLTCODE VARCHAR(10),                      
 BOOKTYPE VARCHAR(2),                      
 ENTEREDBY VARCHAR(25),                      
 PDT DATETIME,                      
 CHECKEDBY VARCHAR(25),                      
 ACTNODAYS INT,                      
 NARRATION VARCHAR(234)                      
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0                      
CREATE TABLE #LEDGER3                      
(                      
 NARATNO INT,                      
 NARR VARCHAR(234),                      
 REFNO CHAR(12),                      
 VTYP SMALLINT,                      
 VNO VARCHAR(12),                      
 BOOKTYPE VARCHAR(2)                      
)                      
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0                      
/*==============================                      
CLIENT SIDE RECORD                      
==============================*/                      
INSERT INTO                      
 #LEDGER                      
 (                      
  VTYP,                      
  VNO,                    
  EDT,                      
  LNO,                      
  ACNAME,                      
  DRCR,                      
  VAMT,                      
  VDT,                      
  VNO1,                      
  REFNO,                      
  BALAMT,                      
  NODAYS,                      
  CDT,                      
  CLTCODE,                      
  BOOKTYPE,                      
  ENTEREDBY,                      
  PDT,                 
  CHECKEDBY,                      
  ACTNODAYS,                      
  NARRATION                      
 )                      
SELECT                      
 VTYP,                      
 VNO,                      
 EDT = EDT,  
 LNO,                      
 ACNAME,                      
 DRCR,                      
 VAMT = AMOUNT,                      
 VDT,                      
 VNO1 = VNO,                      
 REFNO = 0,                      
 BALAMT = AMOUNT,                      
 NODAYS = 0,                      
 CDT = GETDATE(),                      
 CLTCODE = MARGIN_CODE,                      
 BOOKTYPE = BOOKTYPE,                      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                      
 PDT = GETDATE(),                      
 CHECKEDBY = @UNAME,                      
 ACTNODAYS = 0,                      
 NARRATION                    
FROM                      
 #RECPAY_TABLE                      
/*==============================                      
BANK SIDE RECORD                      
==============================*/                      
INSERT INTO                      
 #LEDGER                      
SELECT  DISTINCT                    
 VTYP,                      
 VNO,                      
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                      
 LNO = 1,                      
 BANKNAME,                      
 MAX(DRCR1),                      
 VAMT = ABS(MAX(AMOUNT1)),                      
 VDT,                      
 VNO1 = VNO,                      
 REFNO = 0,                      
 BALAMT = ABS(MAX(AMOUNT1)),                      
 NODAYS = 0,                      
 CDT = GETDATE(),                      
 CLTCODE = BANK_CODE,                      
 BOOKTYPE = BOOKTYPE,                      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                      
 PDT = GETDATE(),                      
 CHECKEDBY = @UNAME,                      
 ACTNODAYS = 0,                      
 NARRATION = NARRATION_FIN    
FROM      
 #RECPAY_TABLE R, (SELECT SERIAL_NO, AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), DRCR1 = CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'C' ELSE 'D' END, NARRATION_FIN = MAX(NARRATION) FROM #RECPAY_TABLE GROUP
  
 BY SERIAL_NO) R1          
WHERE R.SERIAL_NO = R1.SERIAL_NO                  
GROUP BY                      
 VTYP,                      
 VNO,                      
 EDT,                      
 VDT,                      
 BANK_CODE,                      
 BOOKTYPE,                      
 BANKNAME,           
 LNO,    
 NARRATION_FIN                      
/*==============================                      
INSERTING ALL LEDGER RECORDS AT ONE TIME                      
==============================*/                      
                
INSERT INTO LEDGER  SELECT                      
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration                      
FROM                      
 #LEDGER                      
ORDER BY                      
 BOOKTYPE,                      
 VTYP,                      
 VNO,                      
 LNO     
  
INSERT INTO MARGINLEDGER    
 SELECT                        
  VTYP,                        
  VNO,                        
  LNO,                        
  DRCR,          
  VDT,       
  AMOUNT,                        
  CLIENT_CODE,                        
  'NSE',    
  'CAPITAL',    
  0,    
  '',               
  BOOKTYPE = BOOKTYPE,                        
  MCLTCODE = MARGIN_CODE    
 FROM                        
  #RECPAY_TABLE                     
                      
IF @@ERROR <> 0                      
 BEGIN                      
  SELECT                      
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                      
  DROP TABLE #RECPAY_TABLE_TMP          
  DROP TABLE #RECPAY_TABLE                      
  DROP TABLE #LEDGER                      
  DROP TABLE #LEDGER3                      
  ROLLBACK TRAN                      
  DELETE FROM V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
DROP TABLE #LEDGER                      
/*==============================                      
BANK SIDE RECORD                      
==============================*/                      
INSERT INTO                      
 #LEDGER3                      
SELECT                      
 NARATNO = 1,                      
 NARRATION = MAX(NARRATION),                      
 REFNO = 0,                 
 VTYP,                      
 VNO,                      
 BOOKTYPE                      
FROM                      
 #RECPAY_TABLE                      
GROUP BY                      
 VTYP,                      
 VNO,                      
 BOOKTYPE                      
/*==============================                      
CLIENT SIDE RECORD                      
==============================*/                      
INSERT INTO                      
 #LEDGER3                      
SELECT                      
 NARATNO = LNO,                      
 NARR = NARRATION,                      
 REFNO = 0,                      
 VTYP,                      
 VNO,                      
 BOOKTYPE                      
FROM                      
 #RECPAY_TABLE                      
                      
                      
/*==============================                      
INSERTING ALL LEDGER3 RECORDS AT ONE TIME                      
==============================*/                      
INSERT INTO LEDGER3                      
SELECT                      
 *                      
FROM                      
 #LEDGER3                      
ORDER BY                      
 BOOKTYPE,                      
 VTYP,                      
 VNO,                      
 NARATNO                      
                      
IF @@ERROR <> 0                      
 BEGIN                      
  SELECT                      
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  DROP TABLE #LEDGER3                      
  ROLLBACK TRAN                      
  DELETE FROM V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
DROP TABLE #LEDGER3                      
              
                      
IF @@BRANCHFLAG = 1                      
 BEGIN                      
  SET @@L2CUR = CURSOR FOR                      
   SELECT DISTINCT                      
    VNO                      
   FROM                      
    #RECPAY_TABLE                      
   ORDER BY                      
    VNO                      
  OPEN @@L2CUR                      
   FETCH NEXT                      
   FROM                      
    @@L2CUR                      
   INTO                      
    @@L2VNO                      
  WHILE @@FETCH_STATUS = 0                      
   BEGIN                      
    DELETE FROM                      
     TEMPLEDGER2                      
    WHERE                      
     SESSIONID = '9999999999'                      
/*==============================                      
CLIENT SIDE RECORD                      
==============================*/                      
    INSERT INTO                      
     TEMPLEDGER2                      
    SELECT                      
     'BRANCH',                      
     C.COSTNAME,                      
    AMOUNT,                      
     VTYP,                      
     VNO,                      
     LNO,    
     DRCR,                      
     '0',                      
     BOOKTYPE,                      
     '9999999999',                      
     MARGIN_CODE,                      
     'A',                      
     '0'                      
    FROM                      
     #RECPAY_TABLE RP,                      
     COSTMAST C                      
    WHERE                      
     RP.COSTCODE = C.COSTCODE                      
     AND VNO = @@L2VNO                      
/*==============================                      
BANK SIDE RECORD                      
==============================*/                      
    INSERT INTO                      
     TEMPLEDGER2                      
    SELECT                      
     'BRANCH',                      
     C.COSTNAME,                      
     SUM(AMOUNT),                      
     VTYP,                      
     VNO,                      
     LNO = 1,                      
     DRCR =                      
      (                      
       CASE                      
       WHEN DRCR = 'D'                      
    THEN 'C'                      
       ELSE 'D'                      
       END                      
      ),                      
     '0',                      
     BOOKTYPE,                      
     '9999999999',                      
     BANK_CODE,                      
     'A',                      
     '0'                      
    FROM                      
     #RECPAY_TABLE RP,                      
     COSTMAST C                      
    WHERE                      
     RP.BANKCOST = C.COSTCODE                      
     AND VNO = @@L2VNO                      
    GROUP BY                      
     C.COSTNAME,                      
     VTYP,                  
     VNO,                      
      (                      
       CASE                      
       WHEN DRCR = 'D'                      
       THEN 'C'                      
       ELSE 'D'                      
       END                      
      ),                      
     BANK_CODE,                      
     BOOKTYPE                      
    EXEC INSERTTOLEDGER2                      
     '9999999999',                      
     @@L2VNO,                      
     '1',                      
     '1',                      
     '1',                      
     'BROKER',                      
     'BROKER'                      
    FETCH NEXT                      
     FROM                      
      @@L2CUR                      
     INTO                      
      @@L2VNO                      
   END                      
  DELETE FROM                      
   TEMPLEDGER2                      
  WHERE                      
   SESSIONID = '9999999999'                      
                        
 END             
COMMIT TRAN                   
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL                      
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE                      
DROP TABLE #RECPAY_TABLE_TMP                      
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Marginyearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 05/10/2004 5:29:33 PM ******/
/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 03/28/2003 4:34:58 PM ******/
CREATE Procedure Marginyearend
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime

as
set transaction isolation level read uncommitted

declare
@@cltcode  as varchar(10),
@@lno      as int,
@@rcursor  as cursor

insert into marginledger
select @vtyp, @vno, 0, (case when t.bal >= 0 then 'D' else 'C' end), @vdt, abs(t.bal), t.party_code,
t.exchange, rtrim(t.segment), 0, '', @booktype, t.mcltcode
from
(select mcltcode, exchange, segment, party_code, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)
from marginledger where vdt >= @sdtcur + ' 00:00:00' and vdt <= @ldtcur + ' 23:59:59'
group by mcltcode, exchange, segment, party_code) t


set @@rcursor = cursor for
select cltcode, lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno
order by cltcode

open @@rcursor
fetch next from @@rcursor 
into @@cltcode, @@lno

while @@fetch_status = 0
begin
   update marginledger set lno = @@lno where vtyp = @vtyp and booktype = @booktype and vno = @vno and mcltcode = @@cltcode

   fetch next from @@rcursor 
   into @@cltcode, @@lno
end

close @@rcursor
deallocate @@rcursor

/* For effective datewise Margin O/p Balances */

update marginledger set sett_no = t.bal
from
(
select mcltcode, exchange, segment, party_code, bal=sum( case when upper(m.drcr) = 'D' then amount else -amount end)
from marginledger m, ledger l
where m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno
and l.edt >= @sdtcur + ' 00:00:00' and l.edt <= @ldtcur +' 23:59:59'
group by mcltcode, exchange, segment, party_code) t
where marginledger.mcltcode = t.mcltcode and marginledger.exchange = t.exchange and marginledger.segment=t.segment
and marginledger.party_code = t.party_code and marginledger.vtyp = 18

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MOB_LEDGERBAL
-- --------------------------------------------------
CREATE PROC MOB_LEDGERBAL 
(@STATUSID VARCHAR(25), @STATUSNAME VARCHAR(25), @CLTCODE VARCHAR(10))
AS
SELECT BALAMT = SUM(CASE WHEN DRCR = 'C' 
						 THEN VAMT 
						 ELSE -VAMT 
					END)
FROM LEDGER L, PARAMETER P
WHERE VDT >= SDTCUR
AND VDT <= LDTCUR
AND VDT <= LEFT(GETDATE(), 11) + ' 23:59:59'
AND CURYEAR = 1
AND CLTCODE = @CLTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MOB_LEDGERDETAIL
-- --------------------------------------------------
CREATE PROC MOB_LEDGERDETAIL
(@STATUSID VARCHAR(25), @STATUSNAME VARCHAR(25), @CLTCODE VARCHAR(10))
AS
SELECT TOP 7 VDT1=CONVERT(VARCHAR,VDT,103), SHORTDESC, 
DRAMT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),
CRAMT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
VDT
FROM LEDGER L, VMAST V, PARAMETER P
WHERE VDT >= SDTCUR
AND VDT <= LDTCUR
AND VDT <= LEFT(GETDATE(), 11) + ' 23:59:59'
AND CURYEAR = 1
AND CLTCODE = @CLTCODE
AND L.VTYP = V.VTYPE
ORDER BY VDT DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MONEYPAYINUPLOAD_BULK
-- --------------------------------------------------
CREATE  PROC [dbo].[MONEYPAYINUPLOAD_BULK]                          
 @FNAME VARCHAR(100),                          
 @UNAME VARCHAR(25),                          
 @USERCAT SMALLINT,
 @FRDATE VARCHAR(11),
 @TODATE VARCHAR(11)

AS                          
                     
SET NOCOUNT ON                          
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE  ------------------------*/                          
DECLARE                          
 @@STD_DATE VARCHAR(11),                          
 @@LST_DATE VARCHAR(11),                          
 @@BRANCHFLAG AS TINYINT,                          
 @@VNOFLAG AS TINYINT,                          
 @@VNOMETHOD INT,                          
 @@ACNAME CHAR(100),                          
 @@BOOKTYPE CHAR(2),                          
 @@MICRNO VARCHAR(10),                          
 @@DRCR VARCHAR(1),                          
 @@VTYP SMALLINT,                          
 @@BANK_CODE VARCHAR(100),                          
 @@BACKDAYS INT,                          
 @@BACKDATE VARCHAR(11),                          
 @@BRNCOUNT   TINYINT,                          
 @@MonthlyVdt VARCHAR(11),                          
 @@SERIAL_NO INT,                          
 @@COSTCODECOUNT TINYINT,                          
 @@COSTCODEUPDATES CURSOR,                          
 @@NEWVNO AS VARCHAR(12),                          
 @@MAXCOUNT AS INT,                          
 @@VDT AS VARCHAR(11),                          
 @@BANKBRANCH AS VARCHAR(10),                          
 @@BANKCOST AS NUMERIC,                          
 @@LNOCUR AS CURSOR,                          
 @@VNOCUR AS CURSOR,                          
 @@LNOVNO AS VARCHAR(12),                          
 @@MAXVNO AS INT,                          
 @@L2CUR AS CURSOR,                          
 @@L2VNO AS VARCHAR(12),                          
 @@ERROR_COUNT AS INT,                          
 @@FILEEXISTS AS INT,                          
 @@SQL AS VARCHAR(2000)                          
                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT                          
   U_FILENAME                          
  FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
 ) A                          
/*IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                          
  RETURN                          
 END                */          
CREATE TABLE #FEXIST                          
(                          
 F1 SMALLINT,                          
 F2 SMALLINT,                          
 F3 SMALLINT                          
)                          
SELECT @@SQL = "INSERT INTO "                          
SELECT @@SQL = @@SQL + " #FEXIST "                          
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                          
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                          
                          
EXEC(@@SQL)                          
                          
SELECT                          
 @@FILEEXISTS = F1                          
FROM                          
 #FEXIST                          
                          
IF @@FILEEXISTS = 0                          
 BEGIN                          
  DROP TABLE #FEXIST                          
  SELECT                          
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                          
  RETURN                          
 END                          
DROP TABLE #FEXIST                          
                          
BEGIN TRAN                          
CREATE TABLE #RECPAY_TABLE_TMP                          
(                          
 CONSTANT VARCHAR(1),              
 BANK_CODE VARCHAR(10),                          
 CLIENT_CODE VARCHAR(50),            
 NARRATION VARCHAR(234),                          
 AMOUNT MONEY,                          
 Nnull VARCHAR(4),               
 VOUCHER_DATE VARCHAR(20),                          
 SERIAL_NO INT,                    
 REF_NO VARCHAR(15),                          
 DEFAULT_VAL INT,              
 BANK_NAME VARCHAR(100),                          
 BRANCH_NAME VARCHAR(50),                          
 DEPOSIT_SLIP_NO VARCHAR(7),              
)                          
              
CREATE TABLE [#RECPAY_TABLE]                          
 (                          
  CONSTANT VARCHAR(1),              
  BANK_CODE VARCHAR(10),                          
  CLIENT_CODE VARCHAR(50),             
  NARRATION VARCHAR(234),                          
  AMOUNT MONEY,                          
  Nnull VARCHAR(4),               
  VOUCHER_DATE VARCHAR(20),                          
  SERIAL_NO INT,                          
  REF_NO VARCHAR(15),                          
  DEFAULT_VAL INT,              
  BANK_NAME VARCHAR(100),                          
  BRANCH_NAME VARCHAR(50),                          
  DEPOSIT_SLIP_NO VARCHAR(7),              
  DRCR VARCHAR(1),                          
  BRANCHCODE VARCHAR(20),                          
  CHQ_MODE VARCHAR(1),                          
  CHQ_DATE VARCHAR(20),                          
  CHQ_NAME VARCHAR(100),                          
  CL_MODE VARCHAR(1),                          
  SNO INT IDENTITY (1, 1) NOT NULL ,                          
  VDT DATETIME NULL ,                          
  FYSTART DATETIME NULL ,                          
  FYEND DATETIME NULL ,                          
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                          
  EDT DATETIME NULL ,                          
  DDDT DATETIME NULL ,                          
  VNO VARCHAR (12) NULL ,                      
  VTYP SMALLINT NULL ,                          
  ACNAME VARCHAR (100) NULL ,                          
  COSTCODE SMALLINT NULL,                          
  BANKCOST SMALLINT NULL,                          
  LNO SMALLINT NOT NULL DEFAULT(0),                          
  BANKNAME VARCHAR(100) NULL,                          
  MICRNO INT NULL,                          
  BOOKTYPE VARCHAR(2) NULL,                          
 ) ON [PRIMARY]                          
                          
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                          
EXEC (@@SQL)                          
                          
IF @@ERROR <> 0                          
 BEGIN                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRANSACTION                          
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                          
  RETURN                          
 END                          
INSERT INTO                          
 V2_UPLOADED_FILES                          
SELECT                          
 @FNAME,                          
 @FNAME,                          
 CNT = COUNT(1),                          
 'B',                          
 GETDATE(),                          
 @UNAME,                          
 'MONEYPAYIN UPLOAD'                          
    
INSERT INTO                          
 #RECPAY_TABLE                          
 (                          
 CONSTANT ,              
 BANK_CODE ,                          
 CLIENT_CODE ,                          
 NARRATION ,                          
 AMOUNT ,                          
 Nnull ,               
 VOUCHER_DATE ,                          
 SERIAL_NO ,                          
 REF_NO ,                          
 DEFAULT_VAL ,              
 BANK_NAME ,                          
 BRANCH_NAME ,           
 DEPOSIT_SLIP_NO                 
 )                          
SELECT                          
 CONSTANT,                          
 UPPER(LTRIM(RTRIM(BANK_CODE))),                          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                          
 NARRATION,                          
 AMOUNT,                          
 Nnull ,               
 VOUCHER_DATE,                         
 SERIAL_NO ,                          
 REF_NO,               
 DEFAULT_VAL ,                         
 UPPER(LTRIM(RTRIM(BANK_NAME))),                          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                          
 DEPOSIT_SLIP_NO               
FROM                          
 #RECPAY_TABLE_TMP                          
      
UPDATE                          
 #RECPAY_TABLE                      SET                          
 VDT = CONVERT(DATETIME, SUBSTRING(VOUCHER_DATE,5,2)+'/'+RIGHT(VOUCHER_DATE,2)+'/'+ LEFT(VOUCHER_DATE,4)),              
 DDDT = CONVERT(DATETIME, SUBSTRING(CHQ_DATE,5,2)+'/'+RIGHT(CHQ_DATE,2)+'/'+ LEFT(CHQ_DATE,4)),              
 EDT = CONVERT(DATETIME, SUBSTRING(VOUCHER_DATE,5,2)+'/'+RIGHT(VOUCHER_DATE,2)+'/'+ LEFT(VOUCHER_DATE,4))                          
                
                    
SELECT TOP 1                          
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                          
FROM                          
 #RECPAY_TABLE                          
                    
                    
SELECT                          
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                          
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                          
 @@BRANCHFLAG = BRANCHFLAG,                          
 @@VNOFLAG = VNOFLAG                          
FROM                          
 PARAMETER                          
WHERE                          
 @@VDT BETWEEN SDTCUR AND LDTCUR                       
                          
IF @@VNOFLAG <> 0                     
BEGIN                         
 SELECT                          
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                          
 FROM                          
  #RECPAY_TABLE                          
                           
 IF @@ERROR_COUNT > 1                          
  BEGIN                          
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRANSACTION                          
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                          
   RETURN                          
  END                        
END                      
                          
                          
IF @@BRANCHFLAG = 1                          
 BEGIN                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   BRANCHCODE = A.BRANCHCODE,                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = C.COSTCODE,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')                          
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = COSTNAME                          
                            
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
   EDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')                          
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = 'ALL'                         AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                          
                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   BRANCHCODE = 'HO',                          
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
   EDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')                          
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = 'ALL'                          
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                          
 END                          
ELSE                          
 BEGIN                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   FYSTART = @@STD_DATE,                          
   FYEND = @@LST_DATE + ' 23:59:59',                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   BANKNAME = B.LONGNAME,                   
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND A.ACCAT IN ('3','4','18')                          
   AND B.ACCAT = '2'                          
 END                          
                    
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                          
/*                         
SELECT                    
 SERIAL_NO, VOUCHER_DATE                    
INTO #DUP_VDTS                    
FROM                    
 #RECPAY_TABLE                    
GROUP BY SERIAL_NO, VOUCHER_DATE                    
                    
SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS                    
GROUP BY SERIAL_NO                    
HAVING COUNT(1) > 1                    
                    
 IF @@ERROR_COUNT > 1                          
  BEGIN                          
   SELECT                          
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO', 'NA', 'NA'                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE                          
   FROM                          
    V2_UPLOADED_FILES            
   WHERE                          
    U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
   RETURN                          
  END                          
 */   
                 
                    
SELECT                     
 @@ERROR_COUNT = COUNT(SERIAL_NO)                     
FROM                     
 #RECPAY_TABLE                    
WHERE VDT NOT BETWEEN FYSTART AND FYEND                    
                
 IF @@ERROR_COUNT > 0                    
  BEGIN                          
   SELECT                   
    'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.', 'NA', 'NA'                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                         
   ROLLBACK TRAN                          
   DELETE                          
   FROM                          
    V2_UPLOADED_FILES                          
   WHERE                          
    U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
   RETURN                          
  END                          
                    
SET @@ERROR_COUNT = 0                    
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                          
 SELECT                          
  @@ERROR_COUNT = COUNT(1)                          
 FROM                          
  (                          
   SELECT                          
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),                          
    SERIAL_NO                          
   FROM                          
    #RECPAY_TABLE                          
   GROUP BY                          
    SERIAL_NO                          
   HAVING                          
    COUNT(DISTINCT BANK_CODE) > 1                          
  ) A                          
 IF @@ERROR_COUNT > 0                          
  BEGIN                          
   SELECT                          
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                          
   UNION ALL                          
   SELECT                          
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                          
   FROM                          
    #RECPAY_TABLE                       
   GROUP BY                          
    SERIAL_NO                          
   HAVING                          
    COUNT(DISTINCT BANK_CODE) > 1                          
                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE                          
   FROM                          
    V2_UPLOADED_FILES                          
   WHERE                          
    U_FILENAME = @FNAME                          
    AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
   RETURN                          
  END                          
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */               
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
 SELECT DISTINCT                          
  DRCR                          
 FROM              
  #RECPAY_TABLE                          
 ) A                          
IF @@ERROR_COUNT > 1                          
 BEGIN                          
  SELECT                          
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE                          
  FROM                          
   V2_UPLOADED_FILES                          
  WHERE       
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN                          
 END                          
ELSE                          
 BEGIN                          
  SELECT TOP 1                          
   @@DRCR = DRCR,                          
   @@VTYP =                          
    (                          
    CASE                          
     WHEN DRCR = 'D'                          
     THEN 3                          
     ELSE 2                          
    END                          
    )                        
  FROM                          
   #RECPAY_TABLE                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET VTYP =                          
   (                          
   CASE                          
     WHEN DRCR = 'D'                          
     THEN 3                          
     ELSE 2                          
    END                  
   )                          
 END                          
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                          
 SELECT @@ERROR_COUNT = COUNT(1)                          
 FROM #RECPAY_TABLE                          
 WHERE VDT > EDT                          
            IF @@ERROR_COUNT > 0                          
             BEGIN                          
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                          
     DROP TABLE #RECPAY_TABLE_TMP                          
     DROP TABLE #RECPAY_TABLE                          
     ROLLBACK TRAN                          
     DELETE FROM                          
      V2_UPLOADED_FILES                          
     WHERE                          
      U_FILENAME = @FNAME                          
     AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
     RETURN                
             END                          
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                          
 SELECT @@ERROR_COUNT = COUNT(1)                          
 FROM #RECPAY_TABLE                          
 WHERE AMOUNT <= 0                          
 IF @@ERROR_COUNT > 0                          
  BEGIN                          
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                          
     DROP TABLE #RECPAY_TABLE_TMP                          
     DROP TABLE #RECPAY_TABLE                          
     ROLLBACK TRAN                          
     DELETE FROM                          
      V2_UPLOADED_FILES                          
     WHERE                          
      U_FILENAME = @FNAME                          
     AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
     RETURN                          
  END                       
PRINT  @@DRCR                 
PRINT  @@VTYP                 
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                   
 (                          
  SELECT DISTINCT                
   DDNO  = RP.REF_NO ,                 
   CLTCODE=RP.CLIENT_CODE                         
  FROM                          
   #RECPAY_TABLE RP,Ledger l ,                  
   LEDGER1 L1                          
    WITH(NOLOCK)                          
  WHERE                          
   L1.DDNO = RP.REF_NO                        
   AND L1.DD = RP.CHQ_MODE                        
   AND L1.DRCR = @@DRCR                        
   AND L1.VTYP = @@VTYP                        
   AND RP.REF_NO <> 0                        
   AND L.VTYP=@@VTYP                
   AND L.VNO=L1.VNO                
   AND L.BOOKTYPE=L1.BOOKTYPE                
   AND L.DRCR=@@DRCR                 
   AND L.CLTCODE=RP.CLIENT_CODE                
 ) A                       
----------------                       
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                          
  UNION ALL               
  SELECT DISTINCT                          
   RP.REF_NO, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE RP, LEDGER L,                 
   LEDGER1 L1                          
    WITH(NOLOCK)                          
  WHERE                          
   L1.DDNO = RP.REF_NO                          
   AND L1.DD = RP.CHQ_MODE                          
   AND L1.DRCR = @@DRCR                          
   AND L1.VTYP = @@VTYP                          
   AND RP.CHQ_MODE <> 'N'                 
   AND L.VTYP=@@VTYP                
   AND L.VNO=L1.VNO                
   AND L.BOOKTYPE=L1.BOOKTYPE                
   AND L.DRCR=@@DRCR                 
   AND L.CLTCODE=RP.CLIENT_CODE                
                    
                     
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN                          
 END            
                
    
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/       
       
/*IF @@ERROR_COUNT > 1           
  BEGIN          
   SELECT 'FOLLOWING CLIENTS CODE CHEQUE NO IS NOT MATCH', 'NA','NA'      
--  UNION ALL           
   SELECT DISTINCT CLIENT_CODE,AMOUNT,REF_NO           
   FROM MONEYPAYIN_MISMATCH           
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE FROM V2_UPLOADED_FILES                          
   WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN      
 END       */    
    
    
    
    
    
/*-----------------------------*/    
/*                       
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   CLIENT_CODE                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'N'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   CLIENT_CODE, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'N'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          
  WHERE                       
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN                          
 END                        */  
  /**    --------------------------Cheque No, Amount, Client Code Validation ------------------------ **/         
                
    
    
  /**    --------------------------Cheque No, Amount, Client Code Validation ------------------------ **/                          
          
          
          
          
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */                          
  SET @@VNOCUR = CURSOR FOR                          
   SELECT DISTINCT                          
    BANK_CODE,                          
    BOOKTYPE                          
   FROM                          
    #RECPAY_TABLE WITH(NOLOCK)                          
  OPEN @@VNOCUR                          
  FETCH NEXT                          
   FROM                          
    @@VNOCUR                          
   INTO                         
    @@BANK_CODE,                          
    @@BOOKTYPE                          
  WHILE @@FETCH_STATUS = 0                          
   BEGIN                          
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                    
/*    SELECT                          
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)                          
    FROM                          
     USERWRITESTABLE                          
    WHERE                          
     USERCATEGORY = @USERCAT                          
     AND VTYP = @@VTYP                          
     AND BOOKTYPE = @@BOOKTYPE                          
    SELECT                          
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                          
    SELECT                     
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                          
    FROM                          
     #RECPAY_TABLE                          
    WHERE                          
     VDT < @@BACKDATE                          
    IF @@ERROR_COUNT > 0                          
     BEGIN                          
      SELECT                          
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                          
      DROP TABLE #RECPAY_TABLE_TMP                          
      DROP TABLE #RECPAY_TABLE                          
      ROLLBACK TRAN                          
      DELETE FROM V2_UPLOADED_FILES                          
      WHERE                          
       U_FILENAME = @FNAME                          
       AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
      RETURN                          
     END                  */  
  
                    
    IF @@BRANCHFLAG = 1                          
     BEGIN                          
      SELECT                          
       @@BANKBRANCH = BRANCHCODE,                          
       @@BANKCOST = ISNULL(C.COSTCODE, -1)                          
      FROM                          
       ACMAST A                          
        LEFT OUTER JOIN                          
        COSTMAST C                          
        ON                          
         (                          
          A.BRANCHCODE = C.COSTNAME                          
         )                          
      WHERE                          
    A.CLTCODE = @@BANK_CODE                          
      IF @@BANKBRANCH <> 'ALL'                          
       BEGIN                          
        UPDATE                          
     RP                          
          SET COSTCODE = @@BANKCOST                          
 FROM                          
        #RECPAY_TABLE RP,                          
         ACMAST A                          
        WHERE                          
         A.CLTCODE = RP.CLIENT_CODE                          
         AND A.BRANCHCODE = 'ALL'                          
        UPDATE                          
         #RECPAY_TABLE                          
          SET BANKCOST = @@BANKCOST                          
        WHERE                          
         BANK_CODE = @@BANK_CODE                          
       END                          
      ELSE                          
       BEGIN                          
        UPDATE                          
         #RECPAY_TABLE                          
          SET COSTCODE =                          
           (                          
            SELECT TOP 1                          
             COSTCODE                          
            FROM                          
             COSTMAST                          
            WHERE                          
             COSTNAME = 'HO'                          
           )                          
        WHERE                          
         COSTCODE = ''                          
         AND BANK_CODE = @@BANK_CODE                          
                            SET @@COSTCODEUPDATES = CURSOR FOR                          
       SELECT                          
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)                          
                                       FROM                          
                                             #RECPAY_TABLE WITH(NOLOCK)                          
                                       WHERE                          
          BANK_CODE = @@BANK_CODE                          
                                       GROUP BY                          
                                             SERIAL_NO                          
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1                          
                            OPEN @@COSTCODEUPDATES                          
                            FETCH NEXT                          
 FROM                          
                              @@COSTCODEUPDATES                          
                             INTO                          
                              @@SERIAL_NO,                          
                              @@COSTCODECOUNT                          
                            WHILE @@FETCH_STATUS = 0                          
                             BEGIN                          
          UPDATE                          
           #RECPAY_TABLE                          
            SET BANKCOST =                          
             (                          
              SELECT TOP 1                          
               COSTCODE                          
              FROM                          
               COSTMAST                          
          WHERE                          
               COSTNAME = 'HO'                          
             )                          
          WHERE                          
           (BANKCOST = ''   OR BANKCOST IS NULL)                          
           AND BANK_CODE = @@BANK_CODE                          
                                           AND SERIAL_NO = @@SERIAL_NO                          
                              FETCH NEXT                          
                               FROM                          
                                @@COSTCODEUPDATES                        
                               INTO                          
                                @@SERIAL_NO,                          
                                @@COSTCODECOUNT                          
                             END                          
                            CLOSE @@COSTCODEUPDATES                          
                            DEALLOCATE @@COSTCODEUPDATES                          
                  UPDATE                          
                   #RECPAY_TABLE                          
                    SET BANKCOST = COSTCODE                          
            WHERE                          
                   BANK_CODE = @@BANK_CODE                          
  AND (BANKCOST = ''   OR BANKCOST IS NULL)                          
       END                          
     END                          
    CREATE TABLE                          
     #BANK_VNO                          
     (                          
      SRNO INT,                     
      NEWSRNO INT IDENTITY (1, 1)                          
     )                          
    INSERT INTO                          
     #BANK_VNO                          
    SELECT                          
     DISTINCT SERIAL_NO                          
    FROM                          
     #RECPAY_TABLE                          
    WHERE                          
     BANK_CODE = @@BANK_CODE                          
     AND BOOKTYPE = @@BOOKTYPE                          
                          
   SELECT                          
     @@MAXCOUNT = COUNT(DISTINCT SNO)                          
    FROM                          
     #RECPAY_TABLE                          
                          
    SELECT TOP 1                          
     @@VDT = VDT                          
    FROM                          
     #RECPAY_TABLE                          
    SELECT                          
     LASTVNO                          
    INTO #VNO      
    FROM                          
     LASTVNO                          
    WHERE                          
     1 = 2                          
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                          
    INSERT                          
 INTO #VNO                          
     EXEC ACC_GENVNO_NEW                          
      @@VDT,                          
      @@VTYP,                          
      @@BOOKTYPE,                          
      @@STD_DATE,                          
      @@LST_DATE,                          
      @@MAXVNO                          
    SELECT                          
     @@NEWVNO = LASTVNO                          
    FROM                          
     #VNO                          
    UPDATE                          
     RP                          
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                          
    FROM                          
     #RECPAY_TABLE RP,                          
     #BANK_VNO BV                          
    WHERE                          
     RP.SERIAL_NO = BV.SRNO                          
   DROP TABLE #VNO                          
   DROP TABLE #BANK_VNO                          
  FETCH NEXT                          
   FROM @@VNOCUR                          
   INTO                          
    @@BANK_CODE,                          
    @@BOOKTYPE                          
 END                          
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */                          
UPDATE                          
 #RECPAY_TABLE                          
  SET LNO = 2                          
WHERE                          
 VNO IN                          
  (                          
   SELECT                          
    VNO                          
   FROM                          
    #RECPAY_TABLE                          
     WITH(NOLOCK)                          
   GROUP BY                          
    VNO                          
   HAVING                          
    COUNT(*) = 1                          
  )                          
SET @@LNOCUR = CURSOR FOR                          
 SELECT                          
  VNO                          
 FROM                          
  #RECPAY_TABLE                          
   WITH(NOLOCK)                          
 GROUP BY                          
  VNO             
 HAVING                          
  COUNT(*) > 1                          
OPEN @@LNOCUR                          
FETCH NEXT                        
 FROM                          
  @@LNOCUR                          
 INTO                          
  @@LNOVNO                          
WHILE @@FETCH_STATUS = 0                          
 BEGIN                          
  CREATE TABLE                          
   [#LNOGEN]                          
    (                          
     VNO VARCHAR(12),                          
     SNO INT,                          
     LNO INT IDENTITY(1,1)                          
    )                          
  INSERT INTO                          
   #LNOGEN                          
    SELECT                          
     VNO,                          
     SNO                          
    FROM                          
     #RECPAY_TABLE                          
      WITH(NOLOCK)                          
    WHERE                          
     VNO = @@LNOVNO                          
    ORDER BY                          
     SNO                          
  UPDATE                          
   #RECPAY_TABLE                          
    SET LNO = L.LNO + 1                          
  FROM                          
   #LNOGEN L                          
  WHERE                          
   #RECPAY_TABLE.VNO = L.VNO                          
   AND #RECPAY_TABLE.SNO = L.SNO                          
   AND #RECPAY_TABLE.LNO = 0                          
  DROP TABLE #LNOGEN                          
  FETCH NEXT                          
 FROM                          
    @@LNOCUR                          
   INTO                          
    @@LNOVNO                          
 END                          
CLOSE @@LNOCUR                          
DEALLOCATE @@LNOCUR                    
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */                          
/*----MONEY PAYIN CHEQUE NO MISMATCH------*/    
  
INSERT INTO MONEYPAYIN_MISMATCH                          
 (                          
 CONSTANT ,              
 BANK_CODE ,                          
 CLIENT_CODE ,                          
 NARRATION ,                          
 AMOUNT ,                          
 Nnull ,               
 VOUCHER_DATE ,                          
 SERIAL_NO ,                          
 REF_NO ,                          
 DEFAULT_VAL ,              
 BANK_NAME ,                          
 BRANCH_NAME ,                          
 DEPOSIT_SLIP_NO,        
 DRCR,        
 BRANCHCODE,        
 CHQ_MODE,        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE,        
 VDT,        
 FYSTART,        
 FYEND,        
 UPDFLAG,        
 EDT,        
 DDDT,        
 VNO,        
 VTYP,        
 ACNAME,        
 COSTCODE,        
 BANKCOST,        
 LNO,        
 BANKNAME,        
 MICRNO,        
 BOOKTYPE,        
 STATUS_FLAG        
 )                          
SELECT          
 #RECPAY_TABLE.CONSTANT,                          
 UPPER(LTRIM(RTRIM( #RECPAY_TABLE.BANK_CODE))),                          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                          
 #RECPAY_TABLE.NARRATION,                          
 AMOUNT,                          
 Nnull ,               
 VOUCHER_DATE,                          
 SERIAL_NO ,                          
 REF_NO,               
 DEFAULT_VAL ,                         
 UPPER(LTRIM(RTRIM(BANK_NAME))),                          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                          
 DEPOSIT_SLIP_NO,         
 #RECPAY_TABLE.DRCR,        
 BRANCHCODE,        
 CHQ_MODE,        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE,        
 #RECPAY_TABLE.VDT,        
 FYSTART,        
 FYEND,        
 UPDFLAG,        
 #RECPAY_TABLE.EDT,        
 #RECPAY_TABLE.DDDT,        
 #RECPAY_TABLE.VNO,        
 #RECPAY_TABLE.VTYP,        
 #RECPAY_TABLE.ACNAME,        
 COSTCODE,        
 BANKCOST,        
 #RECPAY_TABLE.LNO,        
 BANKNAME,        
 #RECPAY_TABLE.MICRNO,        
 #RECPAY_TABLE.BOOKTYPE,        
 'CH'        
FROM #RECPAY_TABLE INNER JOIN CHEQUE_DETAILS ON (CHEQUE_DETAILS.AMT = #RECPAY_TABLE.AMOUNT)    
AND (CHEQUE_DETAILS.PARTY_CODE = #RECPAY_TABLE.CLIENT_CODE)    
And [CHEQUE_DETAILS].[CH_DATE] between  @FRDATE and @TODATE
AND[CHEQUE_DETAILS].[DDNO] <> [#RECPAY_TABLE].[REF_NO]          
/*----MONEY PAYIN CHEQUE NO MISMATCH------*/    

--select * from MONEYPAYIN_MISMATCH
--return
  
/*----MONEY PAYIN PARTY CODE MISMATCH------*/    
INSERT INTO MONEYPAYIN_MISMATCH                          
 (                          
 CONSTANT ,              
 BANK_CODE ,                          
 CLIENT_CODE ,                          
 NARRATION ,                          
 AMOUNT ,                          
 Nnull ,               
 VOUCHER_DATE ,                          
 SERIAL_NO ,                          
 REF_NO ,                          
 DEFAULT_VAL ,              
 BANK_NAME ,                          
 BRANCH_NAME ,                          
 DEPOSIT_SLIP_NO,        
 DRCR,        
 BRANCHCODE,        
 CHQ_MODE,        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE,        
 VDT,        
 FYSTART,        
 FYEND,        
 UPDFLAG,        
 EDT,        
 DDDT,        
 VNO,        
 VTYP,        
 ACNAME,        
 COSTCODE,        
 BANKCOST,        
 LNO,        
 BANKNAME,        
 MICRNO,        
 BOOKTYPE,        
 STATUS_FLAG        
 )                          
SELECT          
 #RECPAY_TABLE.CONSTANT,                          
 UPPER(LTRIM(RTRIM( #RECPAY_TABLE.BANK_CODE))),                          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                          
 #RECPAY_TABLE.NARRATION,                          
 AMOUNT,                          
 Nnull ,               
 VOUCHER_DATE,                          
 SERIAL_NO ,                          
 REF_NO,               
 DEFAULT_VAL ,                         
 UPPER(LTRIM(RTRIM(BANK_NAME))),                          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                          
 DEPOSIT_SLIP_NO,         
 #RECPAY_TABLE.DRCR,        
 BRANCHCODE,        
 CHQ_MODE,        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE,        
 #RECPAY_TABLE.VDT,        
 FYSTART,        
 FYEND,        
 UPDFLAG,        
 #RECPAY_TABLE.EDT,        
 #RECPAY_TABLE.DDDT,        
 #RECPAY_TABLE.VNO,        
 #RECPAY_TABLE.VTYP,        
 #RECPAY_TABLE.ACNAME,        
 COSTCODE,        
 BANKCOST,        
 #RECPAY_TABLE.LNO,        
 BANKNAME,        
 #RECPAY_TABLE.MICRNO,        
 #RECPAY_TABLE.BOOKTYPE,        
 'CD'        
FROM CHEQUE_DETAILS INNER  
JOIN #RECPAY_TABLE ON (CHEQUE_DETAILS.AMT= #RECPAY_TABLE.AMOUNT)   
AND (CHEQUE_DETAILS.ddno = #RECPAY_TABLE.REF_NO)   
And [CHEQUE_DETAILS].[CH_DATE] between @FRDATE and @FRDATE  
AND [CHEQUE_DETAILS].[PARTY_CODE] <> [#RECPAY_TABLE].[client_code]   
/*----MONEY PAYIN PARTY CODE MISMATCH------*/    
  
  
/*----MONEY PAYIN PARTY AMOUNT MISMATCH------*/    
INSERT INTO MONEYPAYIN_MISMATCH                          
 (                          
 CONSTANT ,              
 BANK_CODE ,                          
 CLIENT_CODE ,                          
 NARRATION ,                          
 AMOUNT ,                          
 Nnull ,               
 VOUCHER_DATE ,                          
 SERIAL_NO ,                          
 REF_NO ,                          
 DEFAULT_VAL ,              
 BANK_NAME ,                          
 BRANCH_NAME ,                          
 DEPOSIT_SLIP_NO,        
 DRCR,        
 BRANCHCODE,        
 CHQ_MODE,        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE,        
 VDT,        
 FYSTART,        
 FYEND,        
 UPDFLAG,        
 EDT,        
 DDDT,        
 VNO,        
 VTYP,        
 ACNAME,        
 COSTCODE,        
 BANKCOST,        
 LNO,        
 BANKNAME,        
 MICRNO,        
 BOOKTYPE,        
 STATUS_FLAG        
 )                          
SELECT          
 #RECPAY_TABLE.CONSTANT,                          
 UPPER(LTRIM(RTRIM( #RECPAY_TABLE.BANK_CODE))),                          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                          
 #RECPAY_TABLE.NARRATION,                          
 AMOUNT,                          
 Nnull ,               
 VOUCHER_DATE,                         
 SERIAL_NO ,                          
 REF_NO,               
 DEFAULT_VAL ,                         
 UPPER(LTRIM(RTRIM(BANK_NAME))),                          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                          
 DEPOSIT_SLIP_NO,         
 #RECPAY_TABLE.DRCR,        
 BRANCHCODE,        
 CHQ_MODE,        
 CHQ_DATE,        
 CHQ_NAME,        
 CL_MODE,        
 #RECPAY_TABLE.VDT,        
 FYSTART,        
 FYEND,        
 UPDFLAG,        
 #RECPAY_TABLE.EDT,        
 #RECPAY_TABLE.DDDT,        
 #RECPAY_TABLE.VNO,        
 #RECPAY_TABLE.VTYP,        
 #RECPAY_TABLE.ACNAME,        
 COSTCODE,        
 BANKCOST,        
 #RECPAY_TABLE.LNO,        
 BANKNAME,        
 #RECPAY_TABLE.MICRNO,        
 #RECPAY_TABLE.BOOKTYPE,        
 'AM'        
FROM CHEQUE_DETAILS INNER  
JOIN #RECPAY_TABLE ON (CHEQUE_DETAILS.DDNO = #RECPAY_TABLE.REF_NO)   
AND [CHEQUE_DETAILS].[CH_DATE] between @FRDATE and @FRDATE  
AND (CHEQUE_DETAILS.PARTY_CODE = #RECPAY_TABLE.CLIENT_CODE)   
AND [CHEQUE_DETAILS].[AMT] <> [#RECPAY_TABLE].[AMOUNT]  
/*----MONEY PAYIN AMOUNT MISMATCH------*/    

DELETE R FROM 
#RECPAY_TABLE R, MoneyPayin_Mismatch MM
WHERE R.REF_NO    = MM.REF_NO
AND R.CLIENT_CODE = MM.CLIENT_CODE
AND R.AMOUNT      = MM.AMOUNT
AND MM.STATUS_FLAG IN ('AM','CD','CH')

   
INSERT INTO                          
 LEDGER1                          
  (                          
   BNKNAME,                          
   BRNNAME,                          
   DD,                          
   DDNO,                          
   DDDT,                          
   RELDT,                          
   RELAMT,                          
   REFNO,                          
   RECEIPTNO,                          
   VTYP,                          
   VNO,                          
   LNO,                          
   DRCR,                          
   BOOKTYPE,                          
   MICRNO,                       
   SLIPNO,                          
   SLIPDATE,                          
CHEQUEINNAME,                          
   CHQPRINTED,                          
   CLEAR_MODE                          
  )                          
SELECT                          
 BNKNAME = MAX(BANK_NAME),                          
 BRNNAME = MAX(BRANCH_NAME),                          
 DD = MAX(CHQ_MODE),                          
 DDNO = MAX(REF_NO),                          
 DDDT = MAX(DDDT),                          
 RELDT = '',                          
 RELAMT = SUM(AMOUNT),                          
 REFNO = 0,                          
 RECEIPTNO = 0,                          
 VTYP,                          
 VNO,                          
 LNO = 2,                          
 DRCR,                        
 BOOKTYPE = BOOKTYPE,                          
 MICRNO = MICRNO,                          
 SLIPNO = 0,                          
 SLIPDATE = '',                          
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                          
 CHQPRINTED = 0,                          
 CLEAR_MODE = MAX(CL_MODE)                          
FROM                          
 #RECPAY_TABLE                          
GROUP BY                          
 VTYP,                          
 VNO,                          
 DRCR,                          
 BOOKTYPE,                        
 MICRNO                        
                          
IF @@ERROR <> 0                          
 BEGIN                          
  SELECT                          
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN                          
 END                          
                          
/*================================                          
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK                          
=================================*/                          
CREATE TABLE #LEDGER                          
(                          
 VTYP SMALLINT,                          
 VNO VARCHAR(12),                          
 EDT DATETIME,                          
 LNO SMALLINT,                          
 ACNAME VARCHAR(100),                          
 DRCR VARCHAR(1),                          
 VAMT MONEY,                          
 VDT DATETIME,                          
 VNO1 VARCHAR(12),                          
 REFNO CHAR(12),                          
 BALAMT MONEY,                          
 NODAYS INT,                          
 CDT DATETIME,                 CLTCODE VARCHAR(10),                          
 BOOKTYPE VARCHAR(2),                          
 ENTEREDBY VARCHAR(25),                          
 PDT DATETIME,                          
 CHECKEDBY VARCHAR(25),                          
 ACTNODAYS INT,                          
 NARRATION VARCHAR(234)                          
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0                          
CREATE TABLE #LEDGER3                          
(                          
 NARATNO INT,                          
 NARR VARCHAR(234),                          
 REFNO CHAR(12),                          
 VTYP SMALLINT,                          
 VNO VARCHAR(12),                          
 BOOKTYPE VARCHAR(2)                          
)                          
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0                          
/*==============================                          
CLIENT SIDE RECORD                          
==============================*/                          
INSERT INTO                          
 #LEDGER                          
 (                          
  VTYP,                          
  VNO,                        
  EDT,                          
  LNO,                          
  ACNAME,                          
  DRCR,                          
  VAMT,                          
  VDT,                          
  VNO1,                          
  REFNO,                          
  BALAMT,                          
  NODAYS,                          
  CDT,                          
  CLTCODE,                          
  BOOKTYPE,                          
  ENTEREDBY,                      PDT,                          
  CHECKEDBY,                          
  ACTNODAYS,                          
  NARRATION                          
 )                          
SELECT                          
 VTYP,                          
 VNO,                          
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                          
 LNO,                          
 ACNAME,                          
 DRCR,                          
 VAMT = AMOUNT,                          
 VDT,                          
 VNO1 = VNO,                          
 REFNO = 0,                          
 BALAMT = AMOUNT,                          
 NODAYS = 0,                          
 CDT = GETDATE(),        
 CLTCODE = CLIENT_CODE,                          
 BOOKTYPE = BOOKTYPE,                          
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                          
 PDT = GETDATE(),                          
 CHECKEDBY = @UNAME,                          
 ACTNODAYS = 0,                     
 NARRATION                          
FROM                          
 #RECPAY_TABLE                          
/*==============================                          
BANK SIDE RECORD                          
==============================*/                          
INSERT INTO                          
 #LEDGER                          
SELECT                          
 VTYP,                          
 VNO,                          
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                          
 LNO = 1,                          
 BANKNAME,                          
 DRCR =                          
  (                   
   CASE                          
    WHEN DRCR = 'D'                          
    THEN 'C'                          
    ELSE 'D'                          
   END                          
  ),                          
 VAMT = SUM(AMOUNT),                          
 VDT,                          
 VNO1 = VNO,                          
 REFNO = 0,                          
 BALAMT = SUM(AMOUNT),                          
 NODAYS = 0,                          
 CDT = GETDATE(),                          
 CLTCODE = BANK_CODE,                          
 BOOKTYPE = BOOKTYPE,                          
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                          
 PDT = GETDATE(),                          
 CHECKEDBY = @UNAME,                          
 ACTNODAYS = 0,                          
 NARRATION = MAX(NARRATION)                          
FROM                          
 #RECPAY_TABLE                          
GROUP BY                          
 VTYP,                          
 VNO,                          
 EDT,                          
 DRCR,                          
 VDT,                          
 BANK_CODE,                          
 BOOKTYPE,                          
 BANKNAME                          
/*==============================                          
INSERTING ALL LEDGER RECORDS AT ONE TIME                          
==============================*/                          
                    
INSERT INTO LEDGER  SELECT                          
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration                          
FROM                          
 #LEDGER                          
ORDER BY                          
 BOOKTYPE,                          
 VTYP,                          
 VNO,                          
 LNO                          
                          
IF @@ERROR <> 0                          
 BEGIN                          
  SELECT                          
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  DROP TABLE #LEDGER                          
  DROP TABLE #LEDGER3                          
  ROLLBACK TRAN                          
  DELETE FROM V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN                          
 END                          
DROP TABLE #LEDGER                          
/*==============================                          
BANK SIDE RECORD                          
==============================*/                          
INSERT INTO                          
 #LEDGER3                          
SELECT                          
 NARATNO = 1,                          
 NARRATION = MAX(NARRATION),                          
 REFNO = 0,                
 VTYP,                          
 VNO,                          
 BOOKTYPE                          
FROM                          
 #RECPAY_TABLE                          
GROUP BY                          
 VTYP,                          
 VNO,       
 BOOKTYPE                          
/*==============================                          
CLIENT SIDE RECORD                          
==============================*/                          
INSERT INTO                          
 #LEDGER3                          
SELECT                          
 NARATNO = LNO,                          
 NARR = NARRATION,                          
 REFNO = 0,                          
 VTYP,                          
 VNO,                          
 BOOKTYPE                          
FROM                          
 #RECPAY_TABLE                          
                          
                          
/*==============================                          
INSERTING ALL LEDGER3 RECORDS AT ONE TIME       
==============================*/                          
INSERT INTO LEDGER3                          
SELECT                          
 *                          
FROM                          
 #LEDGER3                          
ORDER BY                          
 BOOKTYPE,                          
 VTYP,                          
 VNO,                          
 NARATNO              
                          
IF @@ERROR <> 0                          
 BEGIN                          
  SELECT                          
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  DROP TABLE #LEDGER3                          
  ROLLBACK TRAN                          
  DELETE FROM V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'MONEYPAYIN UPLOAD'                          
  RETURN                          
 END                          
DROP TABLE #LEDGER3                          
                          
                          
IF @@BRANCHFLAG = 1                          
 BEGIN                          
  SET @@L2CUR = CURSOR FOR                          
   SELECT DISTINCT                          
    VNO                          
   FROM                          
    #RECPAY_TABLE                          
   ORDER BY                          
    VNO                          
  OPEN @@L2CUR                          
   FETCH NEXT                          
   FROM                          
    @@L2CUR                          
   INTO                          
    @@L2VNO                          
  WHILE @@FETCH_STATUS = 0                          
   BEGIN                          
    DELETE FROM                          
     TEMPLEDGER2                          
    WHERE                          
     SESSIONID = '9999999999'                          
/*==============================                          
CLIENT SIDE RECORD                          
==============================*/                          
    INSERT INTO                          
     TEMPLEDGER2                          
    SELECT                          
     'BRANCH',                          
     C.COSTNAME,                   
     AMOUNT,                          
     VTYP,                          
     VNO,                          
     LNO,                          
     DRCR,                          
     '0',                          
     BOOKTYPE,                          
     '9999999999',                          
     CLIENT_CODE,                          
     'A',                          
     '0'                          
    FROM                          
     #RECPAY_TABLE RP,                          
     COSTMAST C                          
    WHERE                          
     RP.COSTCODE = C.COSTCODE                          
     AND VNO = @@L2VNO                          
/*==============================                          
BANK SIDE RECORD                          
==============================*/                          
    INSERT INTO                          
     TEMPLEDGER2                          
    SELECT                          
     'BRANCH',                          
     C.COSTNAME,                          
     SUM(AMOUNT),                          
     VTYP,                          
     VNO,                          
     LNO = 1,                          
     DRCR =                          
      (                          
       CASE                          
 WHEN DRCR = 'D'                          
       THEN 'C'                          
       ELSE 'D'                          
       END                          
      ),                          
     '0',                          
     BOOKTYPE,                          
     '9999999999',                          
     BANK_CODE,     
     'A',                          
     '0'                          
    FROM                          
     #RECPAY_TABLE RP,                          
     COSTMAST C                          
    WHERE                          
     RP.BANKCOST = C.COSTCODE                          
     AND VNO = @@L2VNO                          
    GROUP BY                          
     C.COSTNAME,                          
     VTYP,                      
     VNO,                          
      (                          
       CASE                          
       WHEN DRCR = 'D'                          
       THEN 'C'                          
       ELSE 'D'                          
       END                          
      ),                          
     BANK_CODE,                          
     BOOKTYPE                    
    EXEC INSERTTOLEDGER2                          
     '9999999999',                          
     @@L2VNO,                          
     '1',                          
     '1',                          
     '1',                          
     'BROKER',                          
     'BROKER'                          
    FETCH NEXT                          
     FROM                          
      @@L2CUR                          
     INTO                          
      @@L2VNO                          
   END                          
  DELETE FROM                          
   TEMPLEDGER2                          
  WHERE                          
   SESSIONID = '9999999999'                          
  COMMIT TRAN                          
 END                          
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL                          
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE                          
    
    
DROP TABLE #RECPAY_TABLE_TMP                          
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.multi1
-- --------------------------------------------------
--multi1 '0','z','1'

create proc multi1  
@partyfrom varchar(20),  
@partyto varchar(20),  
@sortby varchar(20)  
  
as  

if @partyfrom = '' or @partyto = ''
begin
        
	
        if @sortby = '1'
	begin 
		select   
		 m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 account..multibankid m,msajag..pobank p  
		where   
		 m.Bankid=p.Bankid and cltcode between '' and 'zzzzz' 
		order by m.cltcode	
	end
	
	if @sortby = '2'
	begin
		select   
		 m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 account..multibankid m,msajag..pobank p  
		where   
		 m.Bankid=p.Bankid and cltcode between '' and 'zzzzz' 
		order by m.Chequename
	
        end
        
        if @sortby = '3'
        begin
                select   
		 m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 account..multibankid m,msajag..pobank p  
		where   
		 m.Bankid=p.Bankid and cltcode between '' and 'zzzzz' 
		order by p.Bank_Name
	end
        
        if @sortby = '4'
        begin
                select   
		 m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 account..multibankid m,msajag..pobank p  
		where   
		 m.Bankid=p.Bankid and cltcode between '' and 'zzzzz' 
		order by p.Branch_Name
	end
end 
else
begin
        if @sortby = '1'
	begin
	        select   
		 	m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 	account..multibankid m,msajag..pobank p  
		where   
			m.Bankid=p.Bankid and cltcode between @partyfrom and @partyto
                order by m.cltcode
        end
   
        if @sortby = '2'
	begin
                select   
		 	m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 	account..multibankid m,msajag..pobank p  
		where   
			m.Bankid=p.Bankid and cltcode between @partyfrom and @partyto 
	        order by m.Chequename
        end
     
        if @sortby = '3'
	begin
                select   
		 	m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 	account..multibankid m,msajag..pobank p  
		where   
			m.Bankid=p.Bankid and cltcode between @partyfrom and @partyto 
	        order by p.Bank_Name
        end

        if @sortby = '4'
	begin
                select   
		 	m.Cltcode,m.Chequename,m.Acctype,m.Accno,m.Defaultbank,p.Bank_Name,p.Branch_Name  
		from   
		 	account..multibankid m,msajag..pobank p  
		where   
			m.Bankid=p.Bankid and cltcode between @partyfrom and @partyto 
	        order by p.Branch_Name
        end

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacc_Trialbalance
-- --------------------------------------------------

CREATE Procedure  Newacc_Trialbalance

/* Report : Trial Balance        
Prints Trial Balance */

@Vdt Varchar(11),               /* As On Date Entered By User */
@Flag Varchar(15),              /* Sort Order For Report - Codewise Or Namewise */
@Viewoption Varchar(10),        /* Options For Accounts Selection - All, Gl, Party */
@Balance Varchar(10),           /* Normal Or Withopbal */
@Stdate Varchar(11),            /* Start Date Entered By User */
@Curryrstdate Varchar(11), 	/* Start Date Of Financial Year */
@Openentryflag Int, 
@Openingentrydate Varchar(11),  /* O/p Entry Date ( Vtyp = 18 ) Fround From Ledger For Vdt <= Last Date Entered By User */
@Statusid Varchar(20),          /* As Broker/branch/client Etc. */
@Statusname Varchar(20),        /* In Case Of Branch Login Branchcode */
@Sortbydate Varchar(3),         /* Whether Report Is Based On Vdt Or Edt */
@Fromamt    Money,              /* From Amount Entered By User */
@Toamt      Money,              /* To Amount Entered By User */
@Fromac     Varchar(35),        /* From Account/name Entered By User */
@Toac       Varchar(35)         /* To Account/name Entered By User */
As

Declare
@@Selectqury  As Varchar(8000), 
@@Fromtables  As Varchar(2000), 
@@Wherepart   As Varchar(1000), 
@@Wherepart1  As Varchar(500), 
@@Wherepart2  As Varchar(500), 
@@Wherepart3  As Varchar(500), 
@@Addwhere    As Varchar(200), 
@@Groupby     As Varchar(200), 
@@Sortby      As Varchar(200), 
@@Costcode    As Varchar(3), 
@@Whereac     As Varchar(500)

If @Statusid = 'Broker'
Begin
	Select @@Groupby    = " Group By L.Cltcode , A.Acname, Branchcode"
End
Else
Begin
	Select @@Groupby    = " Group By L2.Cltcode , A.Acname, Branchcode"
End

If @Statusid = 'Broker'
Begin
   If @Flag = 'Codewise'
      Begin
	   Select @@Sortby = " Order By  L.Cltcode , A.Acname, Branchcode"
      End
   Else
      Begin
	   Select @@Sortby = " Order By  A.Acname, L.Cltcode, Branchcode"
   End
End
Else
Begin
   If @Flag = 'Codewise'
      Begin
	   Select @@Sortby = " Order By  L2.Cltcode , A.Acname, Branchcode"
      End
   Else
      Begin
	   Select @@Sortby = " Order By  A.Acname, L2.Cltcode, Branchcode"
   End

End



If @Viewoption = 'Partywise'  /* Only Party Accounts To Be Displayed */
Begin
   Select @@Addwhere  = " And A.Accat = 4 " 
End
Else If @Viewoption = 'Gl'  /* Only Party Accounts To Be Displayed */
     Begin
        Select @@Addwhere  = " And A.Accat <> 4 " 
     End
     Else
     Begin
        Select @@Addwhere  = " " 
     End

If @Statusid = 'Broker'
Begin
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where Vdt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Vdt >= '" + @Curryrstdate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Vdt >= '" + @Openingentrydate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where Edt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Edt >= '" + @Curryrstdate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Edt >= '" + @Openingentrydate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
   End
End
Else If @Statusid = 'Branch'
Begin
   Select @@Costcode = (Select Costcode From Costmast C, Category C2 Where C2.Category = 'Branch' And C.Catcode = C2.Catcode And Costname = @Statusname )
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt >= '" + @Curryrstdate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt >= '" + @Openingentrydate + " 00:00:00' And Vdt <= '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt <= '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt >= '" + @Curryrstdate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
    Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt >= '" + @Openingentrydate + " 00:00:00' And Edt <= '" + @Vdt + " 23:59:59'" 
   End
End

If Len(Rtrim(@Fromac)) <> 0 
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode >= '" + @Fromac + "' And L.Cltcode <= '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And A.Acname >= '" + @Fromac + "' And A.Acname <= '" + @Toac + "' "
       End
    Else
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode >= '" + @Fromac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And A.Acname >= '" + @Fromac + "' "
       End
End
Else
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode <= '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And A.Acname <= '" + @Toac + "' "
       End
End


/*  -- For Broker --  */
/* ------------------ */

If @Statusid = 'Broker'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance='Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Isnull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), 0)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Isnull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), 0)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Insull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), 0)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
/*--- If User Wants To See Trial Balance With Opening Balances ---*/
Else If @Balance='Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Isnull(Sum(Case When Upper(Drcr) = 'D' Then Vamt Else 0 End), 0), Crtot = Sum(Case When Upper(Drcr) = 'C' Then Vamt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
       Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vtyp = 18 Then ( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End) Else 0 End)"
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "Select L.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >= '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End) Else 0 End) "
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode=  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End    /* End Og Statusid = 'Broker'  */


/*  -- For Branch Selection --  */
/* ---------------------------- */

If @Statusid = 'Branch'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance='Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = " Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = " Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = " Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Amount = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
Else If @Balance='Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End), Crtot = Sum(Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vtyp = 18 Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End)"
            Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "Select L2.Cltcode , Acname=isnull(A.Acname, ''), Branchcode, Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 And L.Vdt >= '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End) Else 0 End) "
      Select @@Fromtables = " From Ledger L, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode=  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End /* End Of Branch Login Or Branch Selection From Broker Login */

Print @@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby  

Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacc_trialbalancepartytotal
-- --------------------------------------------------

CREATE Procedure  Newacc_trialbalancepartytotal
/* Report : Trial Balance        
Prints Trial Balance */
@Vdt Varchar(11),               /* As On Date Entered By User */
@Flag Varchar(15),              /* Sort Order For Report - Codewise Or Namewise */
@Viewoption Varchar(10),        /* Options For Accounts Selection - All, Gl, Party */
@Balance Varchar(10),           /* Normal Or Withopbal */
@Stdate Varchar(11),            /* Start Date Entered By User */
@Curryrstdate Varchar(11), /* Start Date Of Financial Year */
@Openentryflag Int, 
@Openingentrydate Varchar(11),  /* O/p Entry Date ( Vtyp = 18 ) Fround From Ledger For Vdt < = Last Date Entered By User */
@Statusid Varchar(20),          /* As Broker/branch/client Etc. */
@Statusname Varchar(20),        /* In Case Of Branch Login Branchcode */
@Sortbydate Varchar(3),         /* Whether Report Is Based On Vdt Or Edt */
@Fromamt    Money,              /* From Amount Entered By User */
@Toamt      Money,              /* To Amount Entered By User */
@Fromac     Varchar(35),        /* From Account/name Entered By User */
@Toac       Varchar(35)         /* To Account/name Entered By User */
As
Declare
@@Selectqury  As Varchar(8000), 
@@Fromtables  As Varchar(2000), 
@@Wherepart   As Varchar(1000), 
@@Wherepart1  As Varchar(500), 
@@Wherepart2  As Varchar(500), 
@@Wherepart3  As Varchar(500), 
@@Addwhere    As Varchar(200), 
@@Groupby     As Varchar(200), 
@@Sortby      As Varchar(200), 
@@Costcode    As Varchar(3), 
@@Whereac     As Varchar(500)
Select @@Groupby = " "
Select @@Sortby  = " "
Select @@Addwhere  = " And A.Accat = 4 " 
If @Statusid = 'Broker'
Begin
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where Vdt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Vdt > = '" + @Curryrstdate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Vdt > = '" + @Openingentrydate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where Edt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where Edt > = '" + @Curryrstdate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where Edt > = '" + @Openingentrydate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
   End
End
Else If @Statusid = 'Branch'
Begin
   Select @@Costcode = (Select Costcode From Costmast C, Category C2 Where C2.Category = 'Branch' And C.Catcode = C2.Catcode And Costname = @Statusname )
   If @Sortbydate = 'Vdt'
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt > = '" + @Curryrstdate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
      Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Vdt > = '" + @Openingentrydate + " 00:00:00' And Vdt < = '" + @Vdt + " 23:59:59'" 
   End
   Else
   Begin
      Select @@Wherepart1 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt < = '" + @Vdt + " 23:59:59' " 
      Select @@Wherepart2 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt > = '" + @Curryrstdate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
    Select @@Wherepart3 = " Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno And Costcode = '" + @@Costcode + "' And Edt > = '" + @Openingentrydate + " 00:00:00' And Edt < = '" + @Vdt + " 23:59:59'" 
   End
End
If Len(Rtrim(@Fromac)) <> 0 
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode > = '" + @Fromac + "' And L.Cltcode < = '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And L.Acname > = '" + @Fromac + "' And L.Acname < = '" + @Toac + "' "
       End
    Else
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode > = '" + @Fromac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And L.Acname > = '" + @Fromac + "' "
       End
End
Else
Begin
   If Len(Rtrim(@Toac)) <> 0  
       Begin
          If @Flag = 'Codewise' 
             Select @@Addwhere = @@Addwhere + " And L.Cltcode < = '" + @Toac + "' "
          Else
             Select @@Addwhere = @@Addwhere + " And L.Acname < = '" + @Toac + "' "
       End
End
/*  -- For Broker --  */
/* ------------------ */
If @Statusid = 'Broker'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance = 'Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = "select Amount = Sum(Case When Drcr = 'D' Then Vamt Else -vamt End)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = "select Amount = Sum(Case When Drcr = 'D' Then Vamt Else -vamt End)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "select Amount = Sum(Case When Drcr = 'D' Then Vamt Else -vamt End)"
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
/*--- If User Wants To See Trial Balance With Opening Balances ---*/
Else If @Balance = 'Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When Drcr = 'D' Then Vamt Else 0 End), Crtot = Sum(Case When Drcr = 'C' Then Vamt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
            Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And
 
 Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And
 Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vtyp = 18 Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End)"
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And 
Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
           Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "select Drtot = Sum(Case When Vtyp <> 18 And Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else 0 End) Else 0 End), Crtot = Sum(Case When Vtyp <> 18 And Vdt >
 = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Vamt Else 0 End) Else 0 End), Opbal = Sum(Case When Vdt < '" + @Stdate + "' Then ( Case When Drcr = 'D' Then Vamt Else -vamt End) Else 0 End) "
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End    /* End Og Statusid = 'Broker'  */
/*  -- For Branch Selection --  */
/* ---------------------------- */
If @Statusid = 'Branch'
Begin
/*---- If User Wants To See Normal Trial Balance ---*/
If @Balance = 'Normal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      Select @@Selectqury = " Select Amount = Sum(Case When L2.Drcr = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart1 + @@Addwhere
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      Select @@Selectqury = " Select Amount = Sum(Case When L2.Drcr = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart2 + @@Addwhere
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = " Select Amount = Sum(Case When L2.Drcr = 'D' Then Camt Else -camt End)"
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
Else If @Balance = 'Withopbal'
Begin
   If @Openentryflag = 0   /* Opening Entry ( Vtyp = 18 ) Not Found In Ledger */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When L2.Drcr = 'D' Then Camt Else 0 End), Crtot = Sum(Case When L2.Drcr = 'C' Then Camt Else 0 End), Opbal = 0 "
            Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <
> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart1 + @@Addwhere
         End
   End
   Else If @Openentryflag = 1  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Selected Year */
   Begin
      If @Curryrstdate = @Stdate 
         Begin
            Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp 
 <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vtyp = 18 Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End)"
            Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
            Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
      Else
         Begin
           Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <
> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End) "
           Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
           Select @@Wherepart  = @@Wherepart2 + @@Addwhere
         End
   End
   Else If @Openentryflag = 2  /* Opening Entry ( Vtyp = 18 ) Found In Ledger For Earlier Year */
   Begin
      Select @@Selectqury = "select Drtot = Sum(Case When L.Vtyp <> 18 And L.Vdt > = '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else 0 End) Else 0 End), Crtot = Sum(Case When L.Vtyp <> 18 
And L.Vdt > = '" + @Stdate + "' Then ( Case When Drcr = 'C' Then Camt Else 0 End) Else 0 End), Opbal = Sum(Case When L.Vdt < '" + @Stdate + "' Then ( Case When L2.Drcr = 'D' Then Camt Else -camt End) Else 0 End) "
      Select @@Fromtables = " From Ledger2 L2, Ledger L Left Outer Join Acmast A On L.Cltcode =  A.Cltcode  " 
      Select @@Wherepart  = @@Wherepart3 + @@Addwhere
   End
End
End /* End Of Branch Login Or Branch Selection From Broker Login */
Print @@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby  
Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacmultiinsert
-- --------------------------------------------------
CREATE Procedure Newacmultiinsert          
@Vtyp Smallint,               
@Booktype Char(2),               
@Vno Varchar(12),               
@Lno Int,               
@Vdt Varchar(11),               
@Edt Varchar(11),               
@Cltcode Varchar(10),               
@Drcr Char(1),                
@Vamt Money,               
@Enteredby Varchar(25),               
@Cdt Datetime, /*varchar(30), */              
@Checkedby Varchar(25),               
@Pdt Datetime, /*varchar(30), */              
@Acname Varchar(50),               
@Narration Varchar(234),               
@Chequeinname Varchar(50),               
@Chqprinted Tinyint,               
@Accat Int,               
@Bnkname Varchar(50),               
@Brnname Varchar(30),               
@Dd Char(1),               
@Ddno Varchar(15),               
@Dddt Datetime,               
@Reldt Datetime,               
@Relamt Money,               
@Micrno Int,               
@Sessionid Int,               
@Branchname Char(10),               
@Costflag Varchar(1),               
@Costrowid Int,               
@Clearingmode Char(1),               
@Emode Char(1)              
/*slipno, , Chequeinname, Chqprinted*/              
As              
Declare              
@@Vno1 As Varchar(12),               
@@Refno Char(12),               
@@Nodays Int,               
@@Actnodays Int,               
@@Balamt Money,               
@@Slipno Smallint,               
@@Slipdate Datetime,               
@@Clearingmode Char(2),               
@@Receiptno Int,               
@@Branch As Char(15),               
@@Exchange As Varchar(3),               
@@Segment As Varchar(10),               
@@Sett_no As Varchar(7),               
@@Sett_type As Varchar(3),               
@@Party_code As Varchar(10),               
@@Vdt1 As Datetime,               
@@Edt1 As Datetime,               
@@Dddt1 As Datetime,               
@@Reldt1 As Datetime,               
@@Recordcount As Int              
Select @@Vdt1 = Convert(Datetime, @Vdt+' '+convert(Varchar, Getdate(), 114))              
Select @@Edt1 = Convert(Datetime, @Edt+' '+convert(Varchar, Getdate(), 114))              
Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))              
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */              
Select @@Reldt1 = @Reldt              
Select @@Vno1 = @Vno              
Select @@Refno = ''              
Select @@Nodays = 0              
Select @@Actnodays  = 0              
Select @@Balamt = 0              
Select @@Slipno = 0              
Select @@Slipdate = ''              
/*select @@Clearingmode = ' ' */              
Select @@Receiptno = 0              
Select @@Branch =  'Branch'              
/* Inserting Record In Ledger */              
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,               
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)               
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, @@Refno, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,               
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger3 */              
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
/* Inserting Common Narration In Ledger3 */              
If @Lno = 2               
Begin              
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
End               
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/              
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20               
Begin            
  
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)              
      Begin              
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2              
      Begin    
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
     End               
      End               
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)              
        Begin              
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2              
               
   Begin              
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
                  End               
     End              
    Else If @Vtyp = 5              
        Begin              
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
   If @Accat = 2 And @Drcr = 'C'              
   Begin              
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
   End              
        End              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Records In Matchdetails And Updating Billmatch */              
If @Lno = 2               
Begin              
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)              
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T              
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)               
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype               
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno              
        Insert Into Matchdetails              
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype              
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)               
End              
/* Insertting Records In Margin Ledger */              
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)              
Begin              
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)              
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'                
Begin              
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)                 
 Declare Cur_ledger_insert Cursor For                 
        Select Count(Party_code), Party_code From Templedger2 Where                 
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And               
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code              
                
        Open Cur_ledger_insert                
                
        Fetch Next From Cur_ledger_insert               
        Into @Recordcounter, @Partycode              
While @@Fetch_status = 0                
Begin               
--if  @Partycode <> @Cltcode              
If @Recordcounter = 1              
 Begin              
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                
End              
/* Else              
 Begin              
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 End*/              
Fetch Next From Cur_ledger_insert                 
                 
End                
                
Close Cur_ledger_insert                
Deallocate Cur_ledger_insert                
End               
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/              
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'              
/*select @@Recordcount = Count(Party_code) From Templedger2 Where               
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt              
If @@Recordcount = 0              
Begin*/              
Begin              
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )              
End              
--end              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_MARGINTRIALBALANCE
-- --------------------------------------------------

--NEWASP_MARGINTRIALBALANCE 'Mar 31 2006', 'codewise','partywise','normal','Apr 1 2005', 'Apr 1 2005', 1,'Apr 1 2005', 'BRANCH', 'TEST', 'vdt', '11212','','BSE'

CREATE PROCEDURE  [dbo].[NEWASP_MARGINTRIALBALANCE]  
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */  
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */  
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */  
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */  
@OPENENTRYFLAG INT,  
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */  
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */  
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
@SHOWZEROBAL VARCHAR(1) = 'N',  /* SHOW ZERO BAL   */ 
@GRPCODE VARCHAR(20),
@SHAREDB VARCHAR(20),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(9)  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(2000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(1000),  
@@SQL		  AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),  
@@WHEREPART2  AS VARCHAR(500),  
@@WHEREPART3  AS VARCHAR(500),  
@@ADDWHERE    AS VARCHAR(200),  
@@GROUPBY     AS VARCHAR(200),  
@@SORTBY      AS VARCHAR(200),  
@@HAVING      AS VARCHAR(200),
@@COSTCODE    AS VARCHAR(3)  
 

CREATE TABLE #COSTMAST
(
	COSTCODE INT
)

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.REGION R WHERE REGIONCODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.AREA A WHERE AREACODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('"+@STATUSNAME+"') "
END
PRINT(@@SQL)  
EXEC(@@SQL) 

IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY L.PARTY_CODE , A.ACNAME, BRANCHCODE, ACCAT"  
END  
ELSE  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY ML.PARTY_CODE , A.ACNAME, BRANCHCODE, ACCAT"
END  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  L.PARTY_CODE, A.ACNAME, BRANCHCODE"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, L.PARTY_CODE, BRANCHCODE"  
 END  
END  
ELSE  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  ML.PARTY_CODE, A.ACNAME"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, ML.PARTY_CODE"  
 END  
END  
  
IF @VIEWOPTION = 'PARTYWISE'  
BEGIN  
   SELECT @@ADDWHERE  = " AND A.ACCAT = 4 "   
END  
ELSE IF @VIEWOPTION = 'GL'  
BEGIN  
	SELECT @@ADDWHERE  = " AND A.ACCAT <> 4 "   
END  
ELSE  
BEGIN  
	SELECT @@ADDWHERE  = " "   
END  
  
IF @STATUSID = 'BROKER'  
BEGIN  
      	SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
END  
ELSE
BEGIN  
      	SELECT @@WHEREPART1 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
END  

IF @STATUSID = 'BROKER'  
BEGIN  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   
   BEGIN  
      SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
        SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
        SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
ELSE IF @BALANCE='WITHOPBAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0 
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
            SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END),OPBAL = 0 "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 1 
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
                SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END)"  
                SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
                SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
      	SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'     THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
      	SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END    
  
  
IF @STATUSID = 'BRANCH'  
BEGIN  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      	SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
      	SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      	SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
      	SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      	SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END 

	SELECT @@HAVING = " HAVING	CASE WHEN '" + @SHOWZEROBAL + "' <> 'Y' THEN SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 1 END <> 0  "
  
PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@HAVING + @@SORTBY   
  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY +  @@HAVING + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_MARGINTRIALBALANCEPARTYTOTAL
-- --------------------------------------------------

CREATE  PROCEDURE  [dbo].[NEWASP_MARGINTRIALBALANCEPARTYTOTAL]   
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */  
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */  
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */  
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */  
@OPENENTRYFLAG INT,  
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */  
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */  
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
@GRPCODE VARCHAR(20),
@SHAREDB VARCHAR(20),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(9)
  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(8000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(1000),  
@@SQL		  AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),  
@@WHEREPART2  AS VARCHAR(500),  
@@WHEREPART3  AS VARCHAR(500),  
@@ADDWHERE    AS VARCHAR(200),  
@@GROUPBY     AS VARCHAR(200),  
@@SORTBY      AS VARCHAR(200),  
@@COSTCODE    AS VARCHAR(3)  
  
SELECT @@GROUPBY = " "  
SELECT @@SORTBY  = " "  
  
SELECT @@ADDWHERE  = " AND A.ACCAT = 4 "  
 
CREATE TABLE #COSTMAST
(
	COSTCODE INT
)

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.REGION R WHERE REGIONCODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.AREA A WHERE AREACODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('"+@STATUSNAME+"') "
END
PRINT(@@SQL)  
EXEC(@@SQL) 
  
IF @STATUSID = 'BROKER'  
BEGIN  
      SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE " 
      SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE " 
      SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE " 
END  
ELSE --IF UPPER(@STATUSID) = 'BRANCH'  
BEGIN        
      --SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
      SELECT @@WHEREPART1 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE" 
      SELECT @@WHEREPART2 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE" 
      SELECT @@WHEREPART3 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
END  
  
/*  -- FOR BROKER --  */  
/* ------------------ */  
  
IF @STATUSID = 'BROKER'  
BEGIN  
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0),'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0),'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0),'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/  
ELSE IF @BALANCE='WITHOPBAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END),0),CRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END),0),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND  VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
                  SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0)"  
                  SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
                  SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0) "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  "    
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END    /* END OG STATUSID = 'BROKER'  */  
  
  
/*  -- FOR BRANCH SELECTION --  */  
/* ---------------------------- */  
  
IF UPPER(@STATUSID) = 'BRANCH'  
BEGIN  
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/  
IF @BALANCE='NORMAL'  
BEGIN     
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0),'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0),'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A "   
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0),'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"' "  
      SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A "   
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END

END  
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */  


PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY    
  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_TRIALBALANCE
-- --------------------------------------------------

--EXEC account.DBO.NEWASP_TRIALBALANCE 'Mar 31 2006','codewise','GL','normal','Apr  1 2005','Apr  1 2005',1,'Apr  1 2005','broker','HO','vdt','Y','','MSAJAG','NSE','CAPITAL'    
CREATE PROCEDURE  [dbo].[NEWASP_TRIALBALANCE]    
      
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
@SHOWZEROBAL VARCHAR(1) = 'N',  /* SHOW ZERO BAL   */        
@GRPCODE VARCHAR(20),
@SHAREDB VARCHAR(20),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(9)
      
AS      
      
DECLARE       
@@COSTCODE AS INT,      
@@SQL AS VARCHAR(1000)  

CREATE TABLE #COSTMAST
(
	COSTCODE INT
)

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.REGION R WHERE REGIONCODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.AREA A WHERE AREACODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('"+@STATUSNAME+"') "
END
PRINT(@@SQL)  
EXEC(@@SQL) 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       

IF UPPER(@STATUSID) = 'BROKER'      
BEGIN      
      IF UPPER(@VIEWOPTION) = 'GL'       
      BEGIN      
            IF UPPER(@SORTBYDATE) = 'VDT'      
			BEGIN      
				  SELECT       
						L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT
				  FROM       
						LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
				  WHERE  
						L.CLTCODE=  A.CLTCODE     
						AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT <> 4     
				  GROUP BY       
						L.CLTCODE , A.ACNAME, BRANCHCODE , ACCAT      
				  HAVING  
  						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 1 END <> 0   
			END      
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'      
            BEGIN      
				SELECT       
					 CLTCODE, ACNAME, BRANCHCODE, AMOUNT=ISNULL(SUM(AMOUNT),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
				FROM       
                    (
						SELECT       
							  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END), ACCAT
						FROM       
							  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
						WHERE       
							  L.CLTCODE=  A.CLTCODE	
							  AND EDT LIKE @CURRYRSTDATE + '%' AND A.ACCAT <> 4  AND L.VTYP = 18        
						GROUP BY       
							  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT   
    
						UNION ALL     
  
						SELECT       
							  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END), ACCAT              
						FROM       
							  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
						WHERE 
							  L.CLTCODE=  A.CLTCODE		      
							  AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT <> 4  
						GROUP BY       
							  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT  

						UNION ALL       

						SELECT       
							  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END), ACCAT              
						FROM       
							  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
						WHERE 
							  L.CLTCODE=  A.CLTCODE			 
							  AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT <> 4  AND L.VTYP <> 18       
						GROUP BY       
							  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT
					) L         
              GROUP BY       
                    L.CLTCODE , ACNAME, BRANCHCODE, ACCAT  
			 HAVING  
					CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(AMOUNT) ELSE 1 END <> 0  
			END      
	  END      
      ELSE IF UPPER(@VIEWOPTION) = 'PARTYWISE'       
      BEGIN      
            IF UPPER(@SORTBYDATE) = 'VDT'      
			BEGIN      
				  SELECT       
						L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                       
				  FROM       
						LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
				  WHERE 
						L.CLTCODE=  A.CLTCODE	      
						AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT = 4        
				  GROUP BY       
						L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT   
				  HAVING  
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 1 END <> 0  
			END      
      		ELSE IF UPPER(@SORTBYDATE) = 'EDT'      
			BEGIN      
				  SELECT       
						CLTCODE, ACNAME, BRANCHCODE, AMOUNT=ISNULL(SUM(AMOUNT),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT         
				  FROM       
						(
							SELECT       
								  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END), ACCAT       
							FROM  
								  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE       
								  L.CLTCODE=  A.CLTCODE        	
								  AND EDT LIKE @CURRYRSTDATE + '%' AND A.ACCAT = 4  AND L.VTYP = 18    
						    GROUP BY   
								  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT  
 
							UNION ALL       

							SELECT       
								   L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END), ACCAT  
							FROM       
								  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE 
								  L.CLTCODE=  A.CLTCODE        	
								  AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT = 4    
						    GROUP BY   
								  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT       

							UNION ALL    

							SELECT       
								  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) , ACCAT      
							FROM       
								  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE 
								  L.CLTCODE=  A.CLTCODE        	
								  AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT = 4  AND L.VTYP <> 18       
							GROUP BY       
								  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT
						) L         
				  GROUP BY       
						L.CLTCODE , ACNAME, BRANCHCODE, ACCAT  
				  HAVING   
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(AMOUNT) ELSE 1 END <> 0  
			END      
		END      
		ELSE IF UPPER(@VIEWOPTION) = 'ALL'       
		BEGIN      
            IF UPPER(@SORTBYDATE) = 'VDT'      
			BEGIN      
				  SELECT       
						L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
				  FROM       
						LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A     
				  WHERE 
						L.CLTCODE=  A.CLTCODE      
						AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59'        
				  GROUP BY       
						L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT       
				  HAVING  
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 1 END <> 0  
			END      
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'      
  			BEGIN      
				  SELECT       
						CLTCODE, ACNAME, BRANCHCODE, AMOUNT=ISNULL(SUM(AMOUNT),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
				  FROM       
						(
							SELECT       
								  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END), ACCAT  
							FROM       
								  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE       
								  L.CLTCODE=  A.CLTCODE
								  AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59'  AND L.VTYP = 18        
							GROUP BY       
								  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT 
  
							UNION ALL       

							SELECT       
								  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END), ACCAT       
							FROM       
								  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE 
								  L.CLTCODE=  A.CLTCODE		      
								  AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE  
							GROUP BY       
								  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT  

							UNION ALL       

							SELECT       
								  L.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) , ACCAT      
							FROM       
								  LEDGER L WITH(NOLOCK), (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE 
								  L.CLTCODE=  A.CLTCODE      
								  AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59'  AND L.VTYP <> 18       
							GROUP BY       
								  L.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT
						) L         
				  GROUP BY       
						L.CLTCODE , ACNAME, BRANCHCODE, ACCAT  
				  HAVING   
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(AMOUNT) ELSE 1 END <> 0  
			END      
		END      
END      
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN      
      IF UPPER(@VIEWOPTION) = 'GL'       
      BEGIN      
            IF UPPER(@SORTBYDATE) = 'VDT'      
            BEGIN      
                  SELECT       
                        L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
                  FROM       
						LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),       
						(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
                  WHERE 
						L2.CLTCODE = A.CLTCODE
                        AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)
                        AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT <> 4        
                  GROUP BY       
                        L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT  
				  HAVING  
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 1 END <> 0  
            END      
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'      
            BEGIN      
                  SELECT       
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=ISNULL(SUM(AMOUNT),0), ACCAT,@EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
                  FROM       
                        (
							SELECT       
								  L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''),                   
								  BRANCHCODE,AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END), ACCAT             
							FROM       
								  LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
								  (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE 
								  L2.CLTCODE=  A.CLTCODE		      
								  AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO                   
								  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT <> 4              
							GROUP BY       
								  L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT   
    
							UNION ALL        

							SELECT       
								  L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END), ACCAT       
							FROM       
								  LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
								  (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE  
								   L2.CLTCODE=  A.CLTCODE	     
								   AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)       
								  AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT <> 4        
							GROUP BY       
								  L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT
						) L       
                  GROUP BY       
                        L.CLTCODE , ACNAME, BRANCHCODE, ACCAT    
				  HAVING   
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(AMOUNT) ELSE 1 END <> 0  
            END      
      END      
      ELSE IF UPPER(@VIEWOPTION) = 'PARTYWISE'       
      BEGIN      
            IF UPPER(@SORTBYDATE) = 'VDT'      
            BEGIN      
                  SELECT       
                        L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
                  FROM       
                        LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
						(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
				 WHERE 
					    L2.CLTCODE = A.CLTCODE		      
					    AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)   
                        AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59' AND A.ACCAT = 4        
                  GROUP BY       
                        L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT  
				HAVING   
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 1 END <> 0  
            END      
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'      
            BEGIN      
                   SELECT       
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=ISNULL(SUM(AMOUNT),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT FROM      
                        (
							SELECT       
								  L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,                   
								  AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END), ACCAT             
							FROM       
								  LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
								 (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE       
								  L2.CLTCODE=  A.CLTCODE               
								  AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO                   
								  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE AND A.ACCAT = 4              
							GROUP BY       
								  L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT       

							UNION ALL        
		
							SELECT       
								  L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END), ACCAT       
							FROM       
								  LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
								  (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE       
								  L2.CLTCODE=  A.CLTCODE     
								  AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO       
								  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT >= @CURRYRSTDATE AND EDT <= @VDT + ' 23:59' AND A.ACCAT = 4        
							GROUP BY       
								  L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT
						) L       
                  GROUP BY       
                        L.CLTCODE , ACNAME, BRANCHCODE, ACCAT   
				  HAVING   
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(AMOUNT) ELSE 1 END <> 0  
            END      
      END      
      ELSE IF UPPER(@VIEWOPTION) = 'ALL'       
      BEGIN      
            IF UPPER(@SORTBYDATE) = 'VDT'      
            BEGIN      
                  SELECT       
                        L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END),0), ACCAT, @EXCHANGE , @EXCHANGE + ' - ' + @SEGMENT                
                  FROM       
                        LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
						(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
				 WHERE       
						L2.CLTCODE=  A.CLTCODE    
                        AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)       
                        AND VDT >= @CURRYRSTDATE AND VDT <= @VDT + ' 23:59'        
                  GROUP BY       
                        L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT       
				 HAVING   
					  CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 1 END <> 0   
            END      
            ELSE IF UPPER(@SORTBYDATE) = 'EDT'      
            BEGIN      
                  SELECT       
                        CLTCODE, ACNAME, BRANCHCODE, AMOUNT=ISNULL(SUM(AMOUNT),0), ACCAT, @EXCHANGE, @EXCHANGE + ' - ' + @SEGMENT       
                  FROM       
                        (
							SELECT       
								  L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,                   
								  AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END), ACCAT             
							FROM       
								  LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
								  (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE       
							      L2.CLTCODE=  A.CLTCODE      
								  AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO                   
								  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE       
							GROUP BY       
								  L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT 
      
							UNION ALL        
							SELECT       
								  L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END), ACCAT       
							FROM       
								  LEDGER L WITH(NOLOCK), LEDGER2 L2 WITH(NOLOCK),
							      (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE @GRPCODE + '%') A
							WHERE       
							 	  L2.CLTCODE=  A.CLTCODE           
								  AND L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)       
								  AND EDT >= @CURRYRSTDATE AND EDT <= @VDT  + ' 23:59'       
							GROUP BY       
								  L2.CLTCODE , A.ACNAME, BRANCHCODE, ACCAT
						) L       
                  GROUP BY       
                        L.CLTCODE , ACNAME, BRANCHCODE, ACCAT  
				  HAVING   
						CASE WHEN @SHOWZEROBAL <> 'Y' THEN SUM(AMOUNT) ELSE 1 END <> 0  
            END      
      END      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_TRIALBALANCEPARTYTOTAL
-- --------------------------------------------------

CREATE  PROCEDURE  [dbo].[NEWASP_TRIALBALANCEPARTYTOTAL] 

/* REPORT : CONSOLIDATED TRIAL BALANCE        
FILE : TRIALBAL.ASP
DISPLAYS CONSOLIDATED TRIAL BALANCE */


@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */
@CURRYRSTDATE VARCHAR(11),	/* START DATE OF FINANCIAL YEAR */
@OPENENTRYFLAG INT,
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */
@GRPCODE VARCHAR(20),
@SHAREDB VARCHAR(20),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(9)
AS

DECLARE
@@SELECTQURY  AS VARCHAR(8000),
@@FROMTABLES  AS VARCHAR(2000),
@@WHEREPART   AS VARCHAR(1000),
@@SQL		  AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),
@@WHEREPART2  AS VARCHAR(500),
@@WHEREPART3  AS VARCHAR(500),
@@ADDWHERE    AS VARCHAR(200),
@@GROUPBY     AS VARCHAR(200),
@@SORTBY      AS VARCHAR(200),
@@COSTCODE    AS VARCHAR(3)

/*
SELECT @@GROUPBY = " GROUP BY L.DRCR "
SELECT @@SORTBY  = " ORDER BY  L.DRCR "
*/

SELECT @@GROUPBY = " "
SELECT @@SORTBY  = " "

SELECT @@ADDWHERE  = " AND A.ACCAT = 4 " 
CREATE TABLE #COSTMAST
(
	COSTCODE INT
)

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.REGION R WHERE REGIONCODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, "+ @SHAREDB +".DBO.AREA A WHERE AREACODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('"+@STATUSNAME+"') "
END
PRINT(@@SQL)  
EXEC(@@SQL) 

IF @STATUSID = 'BROKER'
BEGIN
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE" 
      SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE EDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE" 
      SELECT @@WHEREPART2 = " WHERE EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE" 
      SELECT @@WHEREPART3 = " WHERE EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE" 
   END
END
ELSE --IF @STATUSID = 'BRANCH'
BEGIN
	--SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND VDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE"
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE"
      SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE"
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE"
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE"
    SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE) AND EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59' AND L.CLTCODE=  A.CLTCODE"
   END
END

/*  -- FOR BROKER --  */
/* ------------------ */

IF @STATUSID = 'BROKER'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE -VAMT END),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"' "
      SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"' "
            SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
	 END
      ELSE
         BEGIN
            SELECT @@SELECTQURY = " SELECT AMOUNT=ISNULL(SUM(AMOUNT),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"'  FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) "            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + " AND L.VTYP <> 18 "
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + " AND L.VTYP = 18 ) T"
            SELECT @@FROMTABLES = " "
            SELECT @@WHEREPART  = " "
	 END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"' "
            SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
	 END
      ELSE
         BEGIN
            SELECT @@SELECTQURY = " SELECT AMOUNT=ISNULL(SUM(AMOUNT),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"'  FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END)"            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART3 + @@ADDWHERE + " AND L.VTYP <> 18 "
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + ") T"
            SELECT @@FROMTABLES = " "
            SELECT @@WHEREPART  = " "
	 END
   END
END
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END),0),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND  VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            IF @SORTBYDATE = 'VDT'
               BEGIN
                  SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 0 END),0)"
                  SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
                  SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
               END
	    ELSE
	       BEGIN
                  SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VTYP = 18 THEN BALAMT ELSE 0 END),0)"
                  SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
                  SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
	       END
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END) ELSE 0 END),0) "
            SELECT @@FROMTABLES = " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
	 END
      ELSE
	 BEGIN
            SELECT @@SELECTQURY = " SELECT AMOUNT=ISNULL(SUM(AMOUNT),0) FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -VAMT ELSE VAMT END)"            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART3 + @@ADDWHERE + " AND L.VTYP <> 18 "
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE FROM ACMAST WITH(NOLOCK) WHERE  GRPCODE LIKE '" + @GRPCODE + "' + '%') A  " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + ") T"
            SELECT @@FROMTABLES = " "
    SELECT @@WHEREPART  = " "
	 END
   END
END
END    /* END OG STATUSID = 'BROKER'  */


/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */

IF @STATUSID = 'BRANCH'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"' "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"' "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END),0),'" + @EXCHANGE + "','" + @EXCHANGE + " - " + @SEGMENT +"' "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),0),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISUNLL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VTYP = 18 THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 0 END),0)"
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN -CAMT ELSE CAMT END) ELSE 0 END),0) "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */

PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY  

EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPARTYBALANCES1_CSV
-- --------------------------------------------------

--EXEC NEWPARTYBALANCES1_CSV '0A141', '0A141','99555', 'APR 1 2008','APR 1 2008', 'DEC 30 2008','12/26/2008','PARTY', '30', '30', '', 'BROKER', 'BROKER'
CREATE PROCEDURE [dbo].[NEWPARTYBALANCES1_CSV]
                @FROMPARTY  VARCHAR(10),
                @TOPARTY    VARCHAR(10),
                @GLCODE     VARCHAR(10),
                @OPENDATE   VARCHAR(11),
                @FROMDT     VARCHAR(11),
                @TODATE     VARCHAR(11),
                @VDT        VARCHAR(11),
                @REPORTTYPE VARCHAR(30),
                @INTRATEDR  INT,
                @INTRATECR  INT,
                @BRANCHCODE VARCHAR(10),
                @STATUSID   VARCHAR(15),
                @STATUSNAME VARCHAR(25)
                
AS

  DECLARE  @@BALCUR      AS CURSOR,
           @@BALDATE     AS DATETIME,
           @@ENDDATENEW  AS DATETIME,
           @@ENDDATE     AS DATETIME,
           @@NARRATION   AS VARCHAR(100)
                            
  SET NOCOUNT ON
  
  SELECT @@NARRATION = 'INTEREST CALCULATION FROM ' + @FROMDT + ' TO ' + @TODATE
  
  SELECT @@BALDATE = @FROMDT + ' 23:59'
  
  SELECT @@ENDDATE = @TODATE + ' 23:59'
  
  SELECT @@ENDDATENEW = DATEADD(DAY,1,@@BALDATE)
  
  CREATE TABLE #TEMP_PARTYBAL (
    CLTCODE     VARCHAR(12),
    BALANCEDATE DATETIME,
    BALANCE     MONEY,
    INT_BAL     MONEY,
    FLAG        VARCHAR(5))
  
  CREATE TABLE #TEMP_CSV (
    SNO     INT   IDENTITY ( 1,1 ),
    VDT     varchar(10),
    EDT     varchar(10),
    CLTCODE VARCHAR(12),
    DRCR    CHAR(1),
    INT_BAL MONEY,
    NARR    VARCHAR(60),
    BRANCH  VARCHAR(12))
  
  CREATE TABLE #TEMP_CSV_FINAL (
    SNO     INT,
    VDT     varchar(10),
    EDT     varchar(10),
    CLTCODE VARCHAR(12),
    DRCR    CHAR(1),
    INT_BAL MONEY,
    NARR    VARCHAR(60),
    BRANCH  VARCHAR(12))
  
  IF UPPER(RTRIM(@REPORTTYPE)) = 'PARTY'
    BEGIN
      WHILE @@BALDATE < = @@ENDDATE
        BEGIN
          INSERT INTO #TEMP_PARTYBAL
                     (CLTCODE,
                      BALANCEDATE,
                      BALANCE)
          SELECT   L.CLTCODE,
                   @@BALDATE,
                   SUM(CASE 
                         WHEN UPPER(DRCR) = 'D' THEN VAMT
                         ELSE -VAMT
                       END)
          FROM     LEDGER L,
                   ACMAST A,
                   MSAJAG..CLIENT1 C1,
                   MSAJAG..CLIENT2 C2
          WHERE    EDT > = 'APR  1 2003' + ' 00:00'
                   AND EDT < = @@BALDATE
                   AND L.CLTCODE = A.CLTCODE
                   AND A.ACCAT = 4
                   AND A.CLTCODE > = @FROMPARTY
                   AND A.CLTCODE < = @TOPARTY
                   AND C1.CL_CODE = C2.PARTY_CODE
                   AND A.CLTCODE = C1.CL_CODE
                   AND A.BRANCHCODE LIKE RTRIM(@BRANCHCODE) + '%'
                   AND @STATUSNAME = (CASE 
                                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                        ELSE 'BROKER'
                                      END)
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
          
          SELECT @@BALDATE = DATEADD(DAY,1,@@BALDATE)
        END
    END
  ELSE
    IF UPPER(RTRIM(@REPORTTYPE)) = 'FAMILY'
      BEGIN
        WHILE @@BALDATE < = @@ENDDATE
          BEGIN
            INSERT INTO #TEMP_PARTYBAL
                       (CLTCODE,
                        BALANCEDATE,
                        BALANCE)
            SELECT   C.FAMILY,
                     @@BALDATE,
                     SUM(CASE 
                           WHEN UPPER(DRCR) = 'D' THEN VAMT
                           ELSE -VAMT
                         END)
            FROM     LEDGER L,
                     MSAJAG.DBO.CLIENTMASTER C,
                     MSAJAG..CLIENT1 C1,
                     MSAJAG..CLIENT2 C2
            WHERE    EDT > = @OPENDATE + ' 00:00:00'
                     AND EDT < = @@BALDATE
                     AND L.CLTCODE = C.PARTY_CODE
                     AND C.FAMILY > = @FROMPARTY
                     AND C.FAMILY < = @TOPARTY
                     AND C1.CL_CODE = C2.PARTY_CODE
                     AND C.PARTY_CODE = C1.CL_CODE
                     AND C.BRANCH_CD LIKE RTRIM(@BRANCHCODE) + '%'
                     AND @STATUSNAME = (CASE 
                                          WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                          WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                          WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                          WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                          WHEN @STATUSID = 'AREA' THEN C1.AREA
                                          WHEN @STATUSID = 'REGION' THEN C1.REGION
                                          WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                          ELSE 'BROKER'
                                        END)
            GROUP BY C.FAMILY
            ORDER BY C.FAMILY
            
            SELECT @@BALDATE = DATEADD(DAY,1,@@BALDATE)
          END
      END
    ELSE
      IF UPPER(RTRIM(@REPORTTYPE)) = 'FAMILYPARTY'
        BEGIN
          WHILE @@BALDATE < = @@ENDDATE
            BEGIN
              INSERT INTO #TEMP_PARTYBAL
                         (CLTCODE,
                          BALANCEDATE,
                          BALANCE)
              SELECT   L.CLTCODE,
                       @@BALDATE,
                       SUM(CASE 
                             WHEN UPPER(DRCR) = 'D' THEN VAMT
                             ELSE -VAMT
                           END)
              FROM     LEDGER L,
                       MSAJAG.DBO.CLIENTMASTER C,
                       MSAJAG..CLIENT1 C1,
                       MSAJAG..CLIENT2 C2
              WHERE    EDT > = @OPENDATE + ' 00:00'
                       AND EDT < = @@BALDATE
                       AND L.CLTCODE = C.PARTY_CODE
                       AND C.FAMILY > = 'S06786'
                       AND C.FAMILY < = @TOPARTY
                       AND C1.CL_CODE = C2.PARTY_CODE
                       AND C.PARTY_CODE = C1.CL_CODE
                       AND C.BRANCH_CD LIKE RTRIM(@BRANCHCODE) + '%'
                       AND @STATUSNAME = (CASE 
                                            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                            WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                            WHEN @STATUSID = 'AREA' THEN C1.AREA
                                            WHEN @STATUSID = 'REGION' THEN C1.REGION
                                            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                            ELSE 'BROKER'
                                          END)
              GROUP BY L.CLTCODE
              ORDER BY L.CLTCODE
              
              SELECT @@BALDATE = DATEADD(DAY,1,@@BALDATE)
            END
        END
  
  --CALCULATE INTEREST AMOUNT AND UPDATE TO INT_BAL
  UPDATE #TEMP_PARTYBAL
  SET    INT_BAL = CASE 
                     WHEN BALANCE > 0 THEN ROUND((BALANCE * @INTRATEDR / 100) / 365,2)
                     ELSE ROUND((BALANCE * @INTRATECR / 100) / 365,2)
                   END
  
  --GENERATE CLIENT SIDE RECORD FOR CSV FILE
  INSERT INTO #TEMP_CSV
  SELECT   @VDT,
           @VDT,
           CLTCODE,
           CASE 
             WHEN SUM(INT_BAL) > 0 THEN 'D'
             ELSE 'C'
           END,
           round(SUM(INT_BAL),2),
           @@NARRATION,
           'ALL'
  FROM     #TEMP_PARTYBAL
  GROUP BY CLTCODE
  ORDER BY CLTCODE
  
  INSERT INTO #TEMP_CSV_FINAL
  SELECT *
  FROM   #TEMP_CSV
 
  
  --GENERATE REVERSE SIDE RECORD FOR CSV FILE
  INSERT INTO #TEMP_CSV_FINAL
  SELECT SNO,
         VDT,
         EDT,
         @GLCODE,
         CASE DRCR 
           WHEN 'D' THEN 'C'
           ELSE DRCR
         END,
         INT_BAL,
         NARR,
         BRANCH
  FROM   #TEMP_CSV

  
  SELECT   
		SNO, CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT),103) AS VDT, CONVERT(VARCHAR(11),CONVERT(DATETIME,EDT),103) AS EDT,CLTCODE,DRCR,INT_BAL,NARR,BRANCH
  FROM     
		#TEMP_CSV_FINAL
  WHERE 
		INT_BAL >0	
  ORDER BY SNO,
           CLTCODE
  
  DROP TABLE #TEMP_PARTYBAL
  
  DROP TABLE #TEMP_CSV
  
  DROP TABLE #TEMP_CSV_FINAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL
-- --------------------------------------------------
CREATE PROCEDURE NEWPOSTBILL      
(    
      @VTYP SMALLINT,      
      @BOOKTYPE VARCHAR(2),      
      @VNO VARCHAR(12),      
      @VDT VARCHAR(11),      
      @EDTDR VARCHAR(11),      
      @EDTCR VARCHAR(11),      
      @CDT VARCHAR(11),      
      @PDT VARCHAR(11),      
      @ENTEREDBY VARCHAR(25),      
      @CHECKEDBY VARCHAR(25),      
      @SETT_NO VARCHAR(7),      
      @SETT_TYPE VARCHAR(3),      
      @UNAME VARCHAR(25),       
      @EXCHANGE VARCHAR(10),     
      @OVNO VARCHAR(12) = ''    
)    
    
AS      
      
/*=================================================================================================    
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'      
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'      
=================================================================================================*/    
    
SET NOCOUNT ON      
    
DECLARE      
 @@OBJID AS INT,      
 @@EDTDR AS VARCHAR(11),      
 @@EDTCR AS VARCHAR(11),      
 @@LEDCNT AS INT    
      
BEGIN TRANSACTION    
    
 SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)    
    
/*=================================================================================================    
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE    
=================================================================================================*/    
      IF @OVNO <> ''    
      BEGIN    
           SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
           IF @@LEDCNT > 0     
           BEGIN     
                DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
--                DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
--                DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
                DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
                IF @@OBJID <> 0      
                BEGIN      
                     DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
                END      
           END    
      END    
    
      TRUNCATE TABLE POSTBILLLEDGER      
      TRUNCATE TABLE POSTBILLLEDGER2    
    
    
/*=========================================================================================================    
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING    
=========================================================================================================*/    
      IF @VTYP = 15      
      BEGIN      
            INSERT     
            INTO POSTBILLLEDGER     
                  (     
                        VTYP,     
                        VNO,     
                        EDT,     
                        ACNAME,     
                        DRCR,     
                        VAMT,     
                        VDT,     
                        VNO1,     
                        REFNO,     
                        BALAMT,     
                        NODAYS,     
                        CDT,     
                        CLTCODE,     
                        BOOKTYPE,     
                        ENTEREDBY,     
                        PDT,     
                        CHECKEDBY,     
                        ACTNODAYS,     
                        NARRATION,     
                        SETT_NO,     
                        SETT_TYPE,     
                        BILL_NO,     
  ACCAT,     
                        BRANCHCODE    
                  )     
            SELECT     
                  @VTYP,     
                  @VNO,     
                  (    
   CASE     
                              WHEN SELL_BUY = 1     
                              THEN @EDTDR     
                              ELSE @EDTCR     
    END    
                        ),     
                  ACNAME,     
                        (    
                        CASE     
                              WHEN SELL_BUY = 1     
                              THEN 'D'     
                              ELSE 'C'     
                        END    
                        ),     
                  AMOUNT,     
                  @VDT,     
                  @VNO,     
                  '',     
                  0,     
                  0,     
                  CONVERT(VARCHAR(11), GETDATE(), 109),     
                  PARTY_CODE,     
                  @BOOKTYPE,     
                  @ENTEREDBY,     
                  CONVERT(VARCHAR(11), GETDATE(), 109),     
                  @CHECKEDBY,     
                  0,     
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)),     
                  @SETT_NO,     
                  @SETT_TYPE,     
                  BILL_NO,     
                  A.ACCAT,     
                  A.BRANCHCODE      
            FROM NSESLBS.DBO.ACCBILL B WITH(NOLOCK),     
                  ACMAST A WITH(NOLOCK)     
            WHERE B.PARTY_CODE = A.CLTCODE     
                  AND B.SETT_NO = @SETT_NO     
                  AND B.SETT_TYPE = @SETT_TYPE     
                  AND B.AMOUNT <> 0    
                  AND     
                        (    
                              A.ACCAT = 4     
                              OR B.BRANCHCD = 'ZZZ'    
                        )     
           
    
            INSERT     
                  INTO POSTBILLLEDGER2     
            SELECT     
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),     
                  AMOUNT,     
                  BRANCHCD,     
                  PARTY_CODE    
            FROM     
                  NSESLBS.DBO.ACCBILL    
            WHERE    
                  SETT_NO = @SETT_NO     
                  AND SETT_TYPE = @SETT_TYPE     
                  AND BRANCHCD <> 'ZZZ'    
                  AND AMOUNT <> 0    
    
      END      
      ELSE      
      IF @VTYP = 21      
      BEGIN      
            INSERT     
            INTO POSTBILLLEDGER     
                  (     
                        VTYP,     
                        VNO,     
                        EDT,     
                        ACNAME,     
                        DRCR,     
                        VAMT,     
                        VDT,     
                        VNO1,     
                        REFNO,     
                        BALAMT,     
                        NODAYS,     
                        CDT,     
                        CLTCODE,     
                        BOOKTYPE,     
                        ENTEREDBY,     
                        PDT,     
                        CHECKEDBY,     
                        ACTNODAYS,     
                        NARRATION,     
                        SETT_NO,     
                        SETT_TYPE,     
                        BILL_NO,     
                        ACCAT,     
                        BRANCHCODE    
                  )     
            SELECT     
                  @VTYP,     
                  @VNO,     
                  (    
                        CASE     
                              WHEN SELL_BUY = 1     
                              THEN @EDTDR     
                              ELSE @EDTCR     
                        END    
                  ),     
                  ACNAME,     
                        (    
                        CASE     
                              WHEN SELL_BUY = 1     
                              THEN 'D'     
                              ELSE 'C'     
        END    
                        ),     
                  AMOUNT,     
                  @VDT,     
                  @VNO,     
                  '',     
                  0,     
                  0,     
                  CONVERT(VARCHAR(11), GETDATE(), 109),     
                  PARTY_CODE,     
                  @BOOKTYPE,     
                  @ENTEREDBY,     
                  CONVERT(VARCHAR(11), GETDATE(), 109),     
                  @CHECKEDBY,     
                  0,     
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)),     
                  @SETT_NO,     
                  @SETT_TYPE,     
                  BILL_NO,     
                  A.ACCAT,     
                  A.BRANCHCODE      
            FROM NSESLBS.DBO.IACCBILL B WITH(NOLOCK),     
                  ACMAST A WITH(NOLOCK)     
            WHERE B.PARTY_CODE = A.CLTCODE     
                  AND B.SETT_NO = @SETT_NO     
                  AND B.SETT_TYPE = @SETT_TYPE     
                  AND B.AMOUNT <> 0    
                  AND     
                        (    
                              A.ACCAT = 4     
                       OR B.BRANCHCD = 'ZZZ'    
                        )     
    
            INSERT     
                  INTO POSTBILLLEDGER2     
            SELECT     
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),     
                  AMOUNT,     
                  BRANCHCD,     
                  PARTY_CODE    
            FROM     
                  NSESLBS.DBO.IACCBILL    
            WHERE    
                  SETT_NO = @SETT_NO     
                  AND SETT_TYPE = @SETT_TYPE     
                  AND AMOUNT <> 0    
                  AND BRANCHCD <> 'ZZZ'    
    
      END      
      
    
/*=================================================================================================    
      POST DATA INTO LEDGER    
=================================================================================================*/    
      INSERT     
      INTO LEDGER     
            (    
                  VTYP,     
                  VNO,     
                  EDT,     
                  LNO,     
                  ACNAME,     
                  DRCR,     
                  VAMT,     
                  VDT,     
                  VNO1,     
                  REFNO,     
                  BALAMT,     
                  NODAYS,     
                  CDT,     
                  CLTCODE,     
                  BOOKTYPE,     
                  ENTEREDBY,     
                  PDT,     
                  CHECKEDBY,     
                  ACTNODAYS,     
                  NARRATION    
            )     
      SELECT     
            VTYP,     
            VNO,     
            EDT,     
            LNO,     
            ACNAME,     
            DRCR,     
            VAMT,     
            VDT,     
            VNO1,     
            REFNO,     
            BALAMT,     
            NODAYS,     
            CDT,     
            CLTCODE,     
            BOOKTYPE,     
            ENTEREDBY,     
            PDT,     
            CHECKEDBY,     
            ACTNODAYS,     
            NARRATION     
      FROM POSTBILLLEDGER WITH(NOLOCK)     
    
       
/*=================================================================================================    
      POST DATA INTO LEDGER1    
=================================================================================================*/    
/*      INSERT     
      INTO LEDGER1     
            (    
                  BNKNAME,     
                  BRNNAME,     
                  DD,     
                  DDNO,     
                  DDDT,     
                  RELDT,     
                  RELAMT,     
                  REFNO,     
                  RECEIPTNO,     
                  VTYP,     
                  VNO,     
                  LNO,     
                  DRCR,     
                  BOOKTYPE,     
                  MICRNO,     
                  SLIPNO,     
                  SLIPDATE,     
             CHEQUEINNAME,     
                  CHQPRINTED,     
                  CLEAR_MODE    
            )     
      SELECT     
            RTRIM(LTRIM(SETT_NO)) + @EXCHANGE + RTRIM(LTRIM(SETT_TYPE)) + CONVERT(VARCHAR(10), BILL_NO),     
            '',     
            'B',     
            '0',     
            '',     
            '',     
            VAMT,     
            '0',     
            '',     
            VTYP,     
            VNO,     
            LNO,     
            DRCR,     
            BOOKTYPE,     
            '0',     
            '',     
            '',     
            '',     
            1,     
            'C'     
      FROM POSTBILLLEDGER WITH(NOLOCK)  */  
    
      
/*=================================================================================================    
      POST DATA INTO LEDGER2    
=================================================================================================*/    
      INSERT     
      INTO LEDGER2     
            (    
                  VTYPE,     
                  VNO,     
                  LNO,     
                  DRCR,     
                  CAMT,     
                  COSTCODE,     
                  BOOKTYPE,     
                  CLTCODE    
            )     
      SELECT     
            B.VTYP,     
            B.VNO,     
            B.LNO,     
            B2.DRCR,     
            B2.AMOUNT,     
            C.COSTCODE,     
            B.BOOKTYPE,     
            B.CLTCODE     
      FROM POSTBILLLEDGER B WITH(NOLOCK),     
            COSTMAST C WITH(NOLOCK),    
            POSTBILLLEDGER2 B2     
      WHERE     
            B.CLTCODE = B2.CLTCODE    
            AND B2.BRANCHCODE = C.COSTNAME     
      
    
/*=================================================================================================    
      POST DATA INTO LEDGER3    
=================================================================================================*/    
      /*INSERT     
      INTO LEDGER3     
            (    
                  NARATNO,    
                  NARR,    
         REFNO,    
                  VTYP,    
                  VNO,    
                  BOOKTYPE    
            )     
      SELECT     
            LNO,     
            NARRATION,     
            '',     
            VTYP,     
            VNO,     
            BOOKTYPE     
      FROM POSTBILLLEDGER   */  
      
    
/*=================================================================================================    
      POST DATA INTO BILLMATCH    
=================================================================================================*/    
      INSERT     
      INTO BILLMATCH     
            (    
                  EXCHANGE,     
                  SEGMENT,     
                  SETT_TYPE,     
                  SETT_NO,     
                  BILLNO,     
                  DATE,     
                  PARTY_CODE,     
                  AMOUNT,     
                  DRCR,     
                  BALAMT,     
                  VTYPE,     
                  VNO,     
                  LNO,     
                  BRANCH,     
                  BOOKTYPE    
            )     
      SELECT     
            LEFT(@EXCHANGE, 3),     
            'CAPITAL',     
            SETT_TYPE,     
            SETT_NO,     
            BILL_NO,     
            VDT,     
            CLTCODE,     
            VAMT,     
            DRCR,     
            0,     
            VTYP,     
            VNO,     
            LNO,     
            BRANCHCODE,     
            BOOKTYPE     
      FROM POSTBILLLEDGER WITH(NOLOCK)      
      WHERE ACCAT = '4'     
      
/*=================================================================================================    
      POST DATA INTO BFBILLMATCH    
=================================================================================================*/    
      IF @@OBJID <> 0      
      BEGIN      
            INSERT     
            INTO BFBILLMATCH     
                  (    
                        EXCHANGE,     
              SEGMENT,     
                        SETT_TYPE,     
                        SETT_NO,     
                        BILLNO,     
                        DATE,     
                        PARTY_CODE,     
                        AMOUNT,     
                        DRCR,     
                        BALAMT,     
                        VTYPE,     
                        VNO,     
                        LNO,     
                        BRANCH,     
                        BOOKTYPE,     
                        BANKPOSTDATE,     
                        BANKPOSTAMOUNT,     
                        BANKSTATUS,     
                        BANKREASON    
                  )     
            SELECT     
                  LEFT(@EXCHANGE, 3),     
                  'CAPITAL',     
                  SETT_TYPE,     
                  SETT_NO,     
                  BILL_NO,     
                  VDT,     
                  CLTCODE,     
                  VAMT,     
   DRCR,     
                  0,     
                  VTYP,     
                  VNO,     
                  LNO,     
                  BRANCHCODE,     
                  BOOKTYPE,     
                  '',     
                  0,     
                  '',     
                  ''     
            FROM POSTBILLLEDGER WITH(NOLOCK)     
            WHERE ACCAT = '4'     
      END      
       
/*=================================================================================================    
      POST DATA INTO POSTBILLLEDGER    
=================================================================================================*/    
      SELECT     
            @@EDTDR = MIN(EDT),     
            @@EDTCR = MAX(EDT)     
      FROM POSTBILLLEDGER     
    
      INSERT     
      INTO BILLPOSTED     
            (    
                  VNO,     
                  VTYP,     
                  BOOKTYPE,     
                  VDT,     
                  BILLDATE,     
                  SETT_NO,     
                  SETT_TYPE,     
                  NARRATION,     
                  USERNAME,     
                  POSTDATE,     
                  EDTDR,     
                  EDTCR    
            )     
      SELECT     
            TOP 1 VNO,     
            VTYP,     
            BOOKTYPE,     
            CONVERT(VARCHAR(11), VDT, 109),     
         CONVERT(VARCHAR(11), VDT, 109),     
            SETT_NO,     
            SETT_TYPE,     
            NARRATION,     
            @UNAME,     
            CONVERT(VARCHAR(11), GETDATE(), 109),     
            @@EDTDR,     
            @@EDTCR     
      FROM POSTBILLLEDGER WITH(NOLOCK)     
    
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL_26062013
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[NEWPOSTBILL_26062013]              
(            
      @VTYP SMALLINT,              
      @BOOKTYPE VARCHAR(2),              
      @VNO VARCHAR(12),              
      @VDT VARCHAR(11),              
      @EDTDR VARCHAR(11),              
      @EDTCR VARCHAR(11),              
      @CDT VARCHAR(11),              
      @PDT VARCHAR(11),              
      @ENTEREDBY VARCHAR(25),              
      @CHECKEDBY VARCHAR(25),              
      @SETT_NO VARCHAR(7),              
      @SETT_TYPE VARCHAR(3),              
      @UNAME VARCHAR(25),               
      @EXCHANGE VARCHAR(10),             
      @OVNO VARCHAR(12) = '',        
   @NARR VARCHAR(20)           
)            
            
AS              
              
/*=================================================================================================            
--exec NEWPOSTBILL 15,'01','200700000005', 'May 29 2007', 'May 31 2007 12:00:00:000AM', 'May 31 2007 12:00:00:000AM', 'Oct 14 2008 1:48:33:833PM', 'Oct 14 2008 1:48:33:833PM', '','', '2007096', 'A', 'ashoks', 'NSECM', '','PROVISIONAL BILL'        
--exec NEWPOSTBILL 15,'01','200700000008', 'May 29 2007', 'May 31 2007 12:00:00:000AM', 'May 31 2007 12:00:00:000AM', 'Oct 14 2008 3:25:16:033PM', 'Oct 14 2008 3:25:16:033PM', '','', '2007096', 'A', 'ashoks', 'NSECM', '200700000008','FINAL BILL'        
=================================================================================================*/            
            
SET NOCOUNT ON              
            
DECLARE              
      @@OBJID AS INT,              
      @@EDTDR AS VARCHAR(11),              
      @@EDTCR AS VARCHAR(11),              
   @@LEDCNT AS INT,        
   @@VNO_PROV VARCHAR(12)        
              
BEGIN TRANSACTION            
            
 SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)            
            
/*=================================================================================================            
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE            
=================================================================================================*/            
      IF @OVNO <> ''            
      BEGIN            
           SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
           IF @@LEDCNT > 0             
           BEGIN             
                DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE              
                DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE              
                DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE              
                DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE              
                IF @@OBJID <> 0              
                BEGIN              
                     DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE              
                END              
           END            
      END            
            
      TRUNCATE TABLE POSTBILLLEDGER              
      TRUNCATE TABLE POSTBILLLEDGER2            
            
            
/*=========================================================================================================            
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING            
=========================================================================================================*/            
      IF @VTYP = 15              
      BEGIN              
        
  INSERT             
            INTO POSTBILLLEDGER             
                  (             
                        VTYP,             
                        VNO,             
                        EDT,             
                        ACNAME,             
                        DRCR,             
             VAMT,     
                        VDT,             
                        VNO1,             
                        REFNO,             
               BALAMT,             
                        NODAYS,             
                        CDT,             
                        CLTCODE,             
       BOOKTYPE,             
                        ENTEREDBY,             
                        PDT,             
                        CHECKEDBY,             
                        ACTNODAYS,             
                        NARRATION,             
                        SETT_NO,             
                        SETT_TYPE,             
                        BILL_NO,             
  ACCAT,             
                        BRANCHCODE            
                  )             
            SELECT             
                  @VTYP,             
                  @VNO,             
                  (            
                 CASE             
                     WHEN SELL_BUY = 1             
                              THEN @EDTDR             
                              ELSE @EDTCR             
     END            
                        ),             
                  ACNAME,             
                        (            
                        CASE             
                              WHEN SELL_BUY = 1             
                              THEN 'D'             
                              ELSE 'C'             
                        END            
                        ),             
                  AMOUNT,             
                  @VDT,             
                  @VNO,             
                  '',             
                  0,             
                  0,             
                  CONVERT(VARCHAR(11), GETDATE(), 109),             
                  PARTY_CODE,             
                  @BOOKTYPE,             
                  @ENTEREDBY,             
                  CONVERT(VARCHAR(11), GETDATE(), 109),             
                  @CHECKEDBY,             
                  0,             
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)),             
                  @SETT_NO,             
                  @SETT_TYPE,             
                  BILL_NO,             
                  A.ACCAT,             
                  A.BRANCHCODE              
            FROM NSESLBS.DBO.ACCBILL B WITH(NOLOCK),             
                  ACMAST A WITH(NOLOCK)             
            WHERE B.PARTY_CODE = A.CLTCODE             
                  AND B.SETT_NO = @SETT_NO             
                  AND B.SETT_TYPE = @SETT_TYPE             
--                  AND B.AMOUNT <> 0            
                  AND             
                        (            
                              A.ACCAT = 4             
                              OR B.BRANCHCD = 'ZZZ'            
                        )             
     AND CLTCODE IN(SELECT PARTY_CODE FROM               
                    NSESLBS.DBO.ACCBILL              
              WHERE              
                    SETT_NO = @SETT_NO               
                    AND SETT_TYPE = @SETT_TYPE               
                    AND BRANCHCD <> 'ZZZ'              
                    AND AMOUNT <> 0)            
                   
            
            INSERT             
                  INTO POSTBILLLEDGER2             
            SELECT             
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),             
                  AMOUNT,             
                  BRANCHCD,             
                  PARTY_CODE            
            FROM             
                  NSESLBS.DBO.ACCBILL            
            WHERE            
                  SETT_NO = @SETT_NO             
                  AND SETT_TYPE = @SETT_TYPE             
                  AND BRANCHCD <> 'ZZZ'            
                  AND AMOUNT <> 0          
        
 IF (@SETT_TYPE = 'A' OR @SETT_TYPE = 'X') AND @NARR = 'FINAL BILL'        
  BEGIN        
    SELECT @@VNO_PROV = VNO FROM BILLPOSTED WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND VTYP = @VTYP AND NARRATION LIKE '%PROVISIONAL BILL'        
        
    INSERT             
     INTO POSTBILLLEDGER             
        (             
VTYP,             
        VNO,             
        EDT,             
        ACNAME,             
        DRCR,             
        VAMT,             
        VDT,             
        VNO1,             
        REFNO,             
        BALAMT,             
        NODAYS,             
        CDT,             
        CLTCODE,             
        BOOKTYPE,             
        ENTEREDBY,             
      PDT,             
        CHECKEDBY,             
        ACTNODAYS,             
        NARRATION,             
        SETT_NO,             
        SETT_TYPE,             
        BILL_NO,             
        ACCAT,             
        BRANCHCODE            
        )             
     SELECT             
        @VTYP,             
        @VNO,             
        @VDT, -- edt will be same as vdt for reversal             
        L.ACNAME,             
        (            
        CASE             
           WHEN DRCR = 'C'          
           THEN 'D'             
           ELSE 'C'             
        END            
        ),             
        VAMT,             
        @VDT,             
        @VNO,             
        '',             
        0,             
        0,             
        CONVERT(VARCHAR(11), GETDATE(), 109),             
        L.CLTCODE,             
        @BOOKTYPE,             
        @ENTEREDBY,             
        CONVERT(VARCHAR(11), GETDATE(), 109),             
        @CHECKEDBY,             
        0,             
        'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + 'PROVISIONAL BILL REVERSAL',             
        @SETT_NO,             
        @SETT_TYPE,             
        '0',             
        A.ACCAT,             
        A.BRANCHCODE              
     FROM LEDGER L WITH(NOLOCK),             
        ACMAST A WITH(NOLOCK)             
     WHERE L.CLTCODE = A.CLTCODE             
        AND VNO = @@VNO_PROV        
        AND VTYP = @VTYP        
        AND L.BOOKTYPE = @BOOKTYPE        
        
    INSERT             
       INTO POSTBILLLEDGER2             
    SELECT             
       (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END),             
       CAMT,             
       COSTNAME,             
       CLTCODE        
    FROM             
       LEDGER2 L2, COSTMAST C        
    WHERE            
     VNO = @@VNO_PROV        
     AND VTYPE = @VTYP        
     AND BOOKTYPE = @BOOKTYPE        
     AND C.COSTCODE = L2.COSTCODE        
   END        
            
      END              
      ELSE              
      IF @VTYP = 21              
      BEGIN              
            INSERT             
            INTO POSTBILLLEDGER             
                  (             
                        VTYP,             
                        VNO,             
                        EDT,             
                        ACNAME,             
                        DRCR,             
                        VAMT,             
                        VDT,             
                        VNO1,             
                        REFNO,             
                        BALAMT,             
                        NODAYS,             
                        CDT,             
                        CLTCODE,             
                        BOOKTYPE,             
                        ENTEREDBY,             
                        PDT,             
                        CHECKEDBY,             
                        ACTNODAYS,             
                        NARRATION,             
                        SETT_NO,             
                        SETT_TYPE,             
                        BILL_NO,             
                        ACCAT,             
                     BRANCHCODE            
                  )             
            SELECT             
                  @VTYP,             
                  @VNO,             
                  (            
                        CASE             
                              WHEN SELL_BUY = 1             
                              THEN @EDTDR             
            ELSE @EDTCR             
                       END            
                  ),             
                  ACNAME,             
                        (            
                        CASE                                         WHEN SELL_BUY = 1             
               THEN 'D'             
                              ELSE 'C'             
                        END            
                        ),             
                  AMOUNT,             
                  @VDT,             
                  @VNO,             
                  '',             
                  0,             
                  0,             
                  CONVERT(VARCHAR(11), GETDATE(), 109),             
                  PARTY_CODE,             
                  @BOOKTYPE,             
                  @ENTEREDBY,             
                  CONVERT(VARCHAR(11), GETDATE(), 109),             
                  @CHECKEDBY,             
                  0,             
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)),             
                  @SETT_NO,             
                  @SETT_TYPE,             
                  BILL_NO,             
                  A.ACCAT,             
                  A.BRANCHCODE              
            FROM NSESLBS.DBO.IACCBILL B WITH(NOLOCK),             
                  ACMAST A WITH(NOLOCK)             
            WHERE B.PARTY_CODE = A.CLTCODE             
             AND B.SETT_NO = @SETT_NO             
                  AND B.SETT_TYPE = @SETT_TYPE             
                  AND B.AMOUNT <> 0            
                  AND             
                        (            
                              A.ACCAT = 4             
                       OR B.BRANCHCD = 'ZZZ'            
                        )             
            
            INSERT             
                  INTO POSTBILLLEDGER2             
            SELECT             
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),             
                  AMOUNT,             
                  BRANCHCD,             
                  PARTY_CODE            
            FROM             
                  NSESLBS.DBO.IACCBILL            
            WHERE            
                  SETT_NO = @SETT_NO             
                  AND SETT_TYPE = @SETT_TYPE             
                  AND AMOUNT <> 0            
                  AND BRANCHCD <> 'ZZZ'          
        
  IF (@SETT_TYPE = 'A' OR @SETT_TYPE = 'X') AND @NARR = 'FINAL BILL'        
  BEGIN        
    SELECT @@VNO_PROV = VNO FROM BILLPOSTED WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND VTYP = @VTYP AND NARRATION LIKE '%PROVISIONAL BILL'        
        
    INSERT             
     INTO POSTBILLLEDGER             
        (             
        VTYP,             
        VNO,             
        EDT,             
        ACNAME,             
        DRCR,             
        VAMT,             
        VDT,             
        VNO1,             
        REFNO,             
        BALAMT,             
        NODAYS,             
        CDT,             
        CLTCODE,             
        BOOKTYPE,             
        ENTEREDBY,             
        PDT,             
        CHECKEDBY,             
        ACTNODAYS,             
        NARRATION,             
        SETT_NO,             
        SETT_TYPE,             
        BILL_NO,             
        ACCAT,             
        BRANCHCODE            
        )             
     SELECT             
        @VTYP,             
        @VNO,             
        @VDT, -- edt will be same as vdt for reversal          
        L.ACNAME,             
        (            
        CASE             
           WHEN DRCR = 'C'          
           THEN 'D'             
           ELSE 'C'             
        END            
        ),             
        VAMT,             
        @VDT,             
        @VNO,             
        '',             
        0,             
        0,             
        CONVERT(VARCHAR(11), GETDATE(), 109),             
        L.CLTCODE,             
        @BOOKTYPE,             
        @ENTEREDBY,             
        CONVERT(VARCHAR(11), GETDATE(), 109),             
        @CHECKEDBY,             
        0,             
        'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + 'PROVISIONAL BILL REVERSAL',             
        @SETT_NO,         
        @SETT_TYPE,             
        '0',             
        A.ACCAT,             
        A.BRANCHCODE              
     FROM LEDGER L WITH(NOLOCK),             
        ACMAST A WITH(NOLOCK)             
     WHERE L.CLTCODE = A.CLTCODE             
        AND VNO = @@VNO_PROV        
        AND VTYP = @VTYP        
        AND L.BOOKTYPE = @BOOKTYPE        
        
    INSERT             
       INTO POSTBILLLEDGER2             
    SELECT             
       (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END),             
       CAMT,             
       COSTNAME,             
       CLTCODE        
    FROM             
       LEDGER2 L2, COSTMAST C        
    WHERE            
 VNO = @@VNO_PROV        
     AND VTYPE = @VTYP        
     AND BOOKTYPE = @BOOKTYPE        
     AND C.COSTCODE = L2.COSTCODE        
   END          
            
      END              
              
            
/*=================================================================================================            
      POST DATA INTO LEDGER            
=================================================================================================*/            
      INSERT             
      INTO LEDGER             
            (            
                  VTYP,             
                  VNO,             
                  EDT,             
                  LNO,             
                  ACNAME,             
                  DRCR,             
                  VAMT,             
                  VDT,             
                  VNO1,             
                  REFNO,             
                  BALAMT,             
                  NODAYS,             
                  CDT,             
                  CLTCODE,             
  BOOKTYPE,             
                  ENTEREDBY,             
                  PDT,             
                  CHECKEDBY,             
                  ACTNODAYS,             
                  NARRATION            
            )             
      SELECT             
            VTYP,             
            VNO,             
            EDT,             
            LNO,             
            ACNAME,             
            DRCR,             
            VAMT,             
            VDT,             
            VNO1,             
            REFNO,             
            BALAMT,             
            NODAYS,             
            CDT,             
            CLTCODE,             
            BOOKTYPE,             
            ENTEREDBY,             
            PDT,             
            CHECKEDBY,             
            ACTNODAYS,             
            NARRATION             
      FROM POSTBILLLEDGER WITH(NOLOCK)             
            
               
/*=================================================================================================            
      POST DATA INTO LEDGER2            
=================================================================================================*/            
      INSERT             
      INTO LEDGER2             
            (            
                  VTYPE,             
                  VNO,             
                  LNO,             
                  DRCR,       
                  CAMT,           
                  COSTCODE,             
                  BOOKTYPE,             
                  CLTCODE            
            )             
      SELECT             
            B.VTYP,             
            B.VNO,             
            B.LNO,             
            B2.DRCR,             
            B2.AMOUNT,             
            C.COSTCODE,             
          B.BOOKTYPE,             
            B.CLTCODE             
      FROM POSTBILLLEDGER B WITH(NOLOCK),             
            COSTMAST C WITH(NOLOCK),            
            POSTBILLLEDGER2 B2             
      WHERE             
            B.CLTCODE = B2.CLTCODE            
            AND B2.BRANCHCODE = C.COSTNAME             
              
            
/*=================================================================================================            
      POST DATA INTO BILLMATCH            
=================================================================================================*/      
      INSERT             
      INTO BILLMATCH             
            (            
                  EXCHANGE,             
                  SEGMENT,             
                  SETT_TYPE,             
                  SETT_NO,             
                  BILLNO,             
                  DATE,             
                  PARTY_CODE,             
                  AMOUNT,             
                  DRCR,             
                  BALAMT,             
                  VTYPE,             
                  VNO,             
                  LNO,             
                  BRANCH,             
                  BOOKTYPE            
            )             
      SELECT             
            LEFT(@EXCHANGE, 3),             
            'CAPITAL',             
            SETT_TYPE,             
            SETT_NO,             
            BILL_NO,             
            VDT,             
            CLTCODE,             
            VAMT,             
            DRCR,             
            0,             
            VTYP,             
            VNO,             
            LNO,             
            BRANCHCODE,             
            BOOKTYPE             
      FROM POSTBILLLEDGER WITH(NOLOCK)              
      WHERE ACCAT = '4'             
              
/*=================================================================================================            
      POST DATA INTO BFBILLMATCH            
=================================================================================================*/            
      IF @@OBJID <> 0              
      BEGIN              
            INSERT             
            INTO BFBILLMATCH             
                  (            
                        EXCHANGE,             
                        SEGMENT,             
                        SETT_TYPE,             
                        SETT_NO,             
                        BILLNO,             
                        DATE,             
                        PARTY_CODE,             
                        AMOUNT,             
                        DRCR,             
                        BALAMT,             
                        VTYPE,             
                        VNO,                               LNO,             
                        BRANCH,             
                        BOOKTYPE,             
                        BANKPOSTDATE,             
                        BANKPOSTAMOUNT,             
                        BANKSTATUS,             
                        BANKREASON            
                  )             
            SELECT             
                  LEFT(@EXCHANGE, 3),             
                  'CAPITAL',             
                  SETT_TYPE,             
                  SETT_NO,             
                  BILL_NO,             
                  VDT,             
                  CLTCODE,             
                  VAMT,             
   DRCR,             
                  0,         
                  VTYP,             
                  VNO,             
                  LNO,             
                  BRANCHCODE,             
                  BOOKTYPE,             
                  '',             
                  0,             
                  '',             
                  ''             
            FROM POSTBILLLEDGER WITH(NOLOCK)             
            WHERE ACCAT = '4'             
      END              
               
/*=================================================================================================            
      POST DATA INTO POSTBILLLEDGER            
=================================================================================================*/            
      SELECT             
            @@EDTDR = MIN(EDT),             
            @@EDTCR = MAX(EDT)             
      FROM POSTBILLLEDGER             
            
      INSERT             
      INTO BILLPOSTED             
            (            
                  VNO,             
                  VTYP,             
                  BOOKTYPE,             
                  VDT,             
                  BILLDATE,             
                  SETT_NO,             
                  SETT_TYPE,             
                  NARRATION,             
                  USERNAME,             
      POSTDATE,             
                  EDTDR,             
                  EDTCR            
            )             
      SELECT             
            TOP 1 VNO,             
            VTYP,             
            BOOKTYPE,             
            CONVERT(VARCHAR(11), VDT, 109),             
         CONVERT(VARCHAR(11), VDT, 109),             
            SETT_NO,             
            SETT_TYPE,             
            NARRATION,             
            @UNAME,             
            CONVERT(VARCHAR(11), GETDATE(), 109),             
            @@EDTDR,             
            @@EDTCR             
      FROM POSTBILLLEDGER WITH(NOLOCK)             
            
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL_REM
-- --------------------------------------------------

CREATE PROCEDURE NEWPOSTBILL_REM      
(        
      @VTYP SMALLINT,          
      @BOOKTYPE VARCHAR(2),          
      @VNO VARCHAR(12),          
      @VDT VARCHAR(11),          
      @EDTDR VARCHAR(11),          
      @EDTCR VARCHAR(11),          
      @CDT VARCHAR(11),          
      @PDT VARCHAR(11),          
      @ENTEREDBY VARCHAR(25),          
      @CHECKEDBY VARCHAR(25),          
      @SETT_NO VARCHAR(7),          
      @SETT_TYPE VARCHAR(3),          
      @UNAME VARCHAR(25),           
      @EXCHANGE VARCHAR(10),
	  @SEGMENT VARCHAR(10),         
      @OVNO VARCHAR(12) = ''        
)        
        
AS          
          
/*=================================================================================================        
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'          
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'          
=================================================================================================*/        
        
SET NOCOUNT ON          
        
DECLARE          
 @@OBJID AS INT,          
 @@EDTDR AS VARCHAR(11),          
 @@EDTCR AS VARCHAR(11),          
 @@LEDCNT AS INT        
          
--BEGIN TRANSACTION        
        
 SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)        
        
/*=================================================================================================        
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE        
=================================================================================================*/        
      IF @OVNO <> ''        
      BEGIN        
           SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
           IF @@LEDCNT > 0         
           BEGIN         
                DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE          
                DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE          
                DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE          
                DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE          
                DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE          
                DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE          
                IF @@OBJID <> 0          
                BEGIN          
                     DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE          
                END          
           END        
      END        
        
      TRUNCATE TABLE POSTBILLLEDGER          
      TRUNCATE TABLE POSTBILLLEDGER2        
        
        
/*=========================================================================================================        
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING        
=========================================================================================================*/        
      
            INSERT         
            INTO POSTBILLLEDGER         
                  (         
                        VTYP,         
                        VNO,         
                        EDT,         
                        ACNAME,         
                        DRCR,         
                        VAMT,         
                        VDT,         
                        VNO1,         
                        REFNO,         
                        BALAMT,         
                        NODAYS,         
                        CDT,         
                        CLTCODE,         
           BOOKTYPE,         
                        ENTEREDBY,         
                        PDT,         
                        CHECKEDBY,         
                        ACTNODAYS,         
                        NARRATION,         
                        SETT_NO,         
                        SETT_TYPE,         
                        BILL_NO,         
                        ACCAT,         
                        BRANCHCODE        
                  )         
            SELECT         
                  @VTYP,         
                  @VNO,         
                  (        
   CASE         
                              WHEN SELL_BUY = 1         
                              THEN @EDTDR         
                              ELSE @EDTCR         
    END        
                        ),         
                  ACNAME,         
                        (        
                        CASE         
                              WHEN SELL_BUY = 1         
                              THEN 'D'         
                              ELSE 'C'         
                        END        
                        ),         
                  AMOUNT,         
                  @VDT,         
                  @VNO,         
                  '',         
                  0,         
                  0,         
                  GETDATE(),         
                  PARTY_CODE,         
                  @BOOKTYPE,         
                  @ENTEREDBY,         
                  GETDATE(),         
                  @CHECKEDBY,         
                  0,         
                  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(NARRATION)),         
                  @SETT_NO,         
                  @SETT_TYPE,         
                  BILL_NO,         
                  A.ACCAT,         
                  A.BRANCHCODE          
            FROM MSAJAG.DBO.REM_ACCBILL B WITH(NOLOCK),         
                  ACMAST A WITH(NOLOCK)         
            WHERE B.PARTY_CODE = A.CLTCODE         
                  AND B.SETT_NO = @SETT_NO         
                  AND B.SETT_TYPE = @SETT_TYPE         
                  AND B.AMOUNT <> 0        
                  AND         
                        (        
                              A.ACCAT = 4         
                              OR B.BRANCHCD = 'ZZZ'        
                        )         
  AND EXCHANGE = @EXCHANGE      
--  AND SEGMENT = 'CAPITAL'      
       
        
            INSERT         
                  INTO POSTBILLLEDGER2         
            SELECT         
                  (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),         
                  AMOUNT,         
                  BRANCHCD,         
                  PARTY_CODE        
            FROM         
                  MSAJAG.DBO.REM_ACCBILL        
            WHERE        
                  SETT_NO = @SETT_NO         
                  AND SETT_TYPE = @SETT_TYPE         
                  AND BRANCHCD <> 'ZZZ'        
                  AND AMOUNT <> 0  
				  AND EXCHANGE = @EXCHANGE      
        
      
          
          
        
/*=================================================================================================        
      POST DATA INTO LEDGER        
=================================================================================================*/        
      INSERT         
      INTO LEDGER         
            (        
                  VTYP,         
                  VNO,         
                  EDT,         
                  LNO,         
                  ACNAME,         
                  DRCR,         
                  VAMT,         
                  VDT,         
                  VNO1,         
                  REFNO,         
                  BALAMT,         
                  NODAYS,         
                  CDT,         
                  CLTCODE,         
                  BOOKTYPE,         
                  ENTEREDBY,         
                  PDT,         
                  CHECKEDBY,         
                  ACTNODAYS,         
                  NARRATION        
            )       
      SELECT         
            VTYP,         
            VNO,         
            EDT,                   LNO,         
            ACNAME,         
            DRCR,         
            VAMT,         
            VDT,         
            VNO1,         
            REFNO,         
            BALAMT,         
            NODAYS,         
            CDT,         
            CLTCODE,         
            BOOKTYPE,         
            ENTEREDBY,         
            PDT,         
            CHECKEDBY,         
            ACTNODAYS,         
            NARRATION         
      FROM POSTBILLLEDGER WITH(NOLOCK)         
        
           
/*=================================================================================================        
      POST DATA INTO LEDGER1        
=================================================================================================*/        
      INSERT         
      INTO LEDGER1         
            (        
                  BNKNAME,         
                  BRNNAME,         
                  DD,         
                  DDNO,         
                  DDDT,         
                  RELDT,         
                  RELAMT,         
                  REFNO,         
                  RECEIPTNO,         
                  VTYP,         
                  VNO,         
                  LNO,         
                  DRCR,         
                  BOOKTYPE,         
                  MICRNO,         
                  SLIPNO,         
                  SLIPDATE,         
                  CHEQUEINNAME,         
                  CHQPRINTED,         
                  CLEAR_MODE        
            )         
      SELECT         
            RTRIM(LTRIM(SETT_NO)) + @EXCHANGE + RTRIM(LTRIM(SETT_TYPE)) + CONVERT(VARCHAR(10), BILL_NO),         
            '',         
            'B',         
            '0',         
            '',         
            '',         
            VAMT,         
            '0',         
            '',         
            VTYP,         
            VNO,         
            LNO,         
            DRCR,         
            BOOKTYPE,         
            '0',         
            '',         
            '',         
            '',         
            1,         
            'C'         
      FROM POSTBILLLEDGER WITH(NOLOCK)        
        
          
/*=================================================================================================        
      POST DATA INTO LEDGER2        
=================================================================================================*/        
      INSERT         
      INTO LEDGER2         
            (        
                  VTYPE,         
                  VNO,         
                  LNO,         
                  DRCR,         
                  CAMT,         
                  COSTCODE,         
                  BOOKTYPE,         
                  CLTCODE        
            )         
      SELECT         
            B.VTYP,         
            B.VNO,         
            B.LNO,         
            B2.DRCR,         
            B2.AMOUNT,         
            C.COSTCODE,         
            B.BOOKTYPE,         
            B.CLTCODE         
      FROM POSTBILLLEDGER B WITH(NOLOCK),         
            COSTMAST C WITH(NOLOCK),        
            POSTBILLLEDGER2 B2         
      WHERE         
            B.CLTCODE = B2.CLTCODE        
            AND B2.BRANCHCODE = C.COSTNAME         
          
        
/*=================================================================================================        
      POST DATA INTO LEDGER3        
=================================================================================================*/        
      INSERT         
      INTO LEDGER3         
            (        
                  NARATNO,        
                  NARR,        
         REFNO,        
                  VTYP,        
                  VNO,        
                  BOOKTYPE        
            )         
      SELECT   
            LNO,         
            NARRATION,         
            '',         
            VTYP,         
            VNO,         
            BOOKTYPE         
      FROM POSTBILLLEDGER         
          
        
/*=================================================================================================        
      POST DATA INTO BILLMATCH      
=================================================================================================*/        
      INSERT         
      INTO BILLMATCH         
            (        
                  EXCHANGE,         
                  SEGMENT,         
                  SETT_TYPE,         
                  SETT_NO,         
                  BILLNO,         
                  DATE,         
                  PARTY_CODE,         
                  AMOUNT,         
                  DRCR,         
                  BALAMT,         
                  VTYPE,         
                  VNO,         
                  LNO,         
                  BRANCH,         
                  BOOKTYPE        
            )         
      SELECT         
            LEFT(@EXCHANGE, 3),         
            @SEGMENT,         
            SETT_TYPE,         
            SETT_NO,         
            BILL_NO,         
            VDT,         
            CLTCODE,         
            VAMT,         
  DRCR,        
            0,         
            VTYP,         
            VNO,         
            LNO,         
            BRANCHCODE,         
            BOOKTYPE         
      FROM POSTBILLLEDGER WITH(NOLOCK)          
      WHERE ACCAT = '4'         
          
/*=================================================================================================        
      POST DATA INTO BFBILLMATCH        
=================================================================================================*/        
      IF @@OBJID <> 0          
      BEGIN          
            INSERT         
            INTO BFBILLMATCH         
                  (        
                        EXCHANGE,         
                        SEGMENT,         
                        SETT_TYPE,         
                        SETT_NO,         
                        BILLNO,         
                        DATE,         
                        PARTY_CODE,         
                        AMOUNT,         
                        DRCR,         
                        BALAMT,         
                        VTYPE,         
                        VNO,         
                        LNO,         
                        BRANCH,         
                        BOOKTYPE,         
                        BANKPOSTDATE,         
                        BANKPOSTAMOUNT,         
                        BANKSTATUS,         
                        BANKREASON        
                  )         
            SELECT         
                  LEFT(@EXCHANGE, 3),         
                  @SEGMENT,         
                  SETT_TYPE,         
                  SETT_NO,         
                  BILL_NO,         
                  VDT,         
                  CLTCODE,         
                  VAMT,         
   DRCR,         
                  0,         
                  VTYP,         
                  VNO,         
                  LNO,         
                  BRANCHCODE,         
                  BOOKTYPE,         
                  '',         
                  0,         
                  '',         
                  ''         
            FROM POSTBILLLEDGER WITH(NOLOCK)         
            WHERE ACCAT = '4'         
      END          
           
/*=================================================================================================        
      POST DATA INTO POSTBILLLEDGER        
=================================================================================================*/        
      SELECT         
            @@EDTDR = MIN(EDT),         
            @@EDTCR = MAX(EDT)         
      FROM POSTBILLLEDGER         
        
      INSERT         
      INTO BILLPOSTED         
            (        
                  VNO,         
                  VTYP,         
                  BOOKTYPE,         
                  VDT,         
                  BILLDATE,         
                  SETT_NO,         
                  SETT_TYPE,         
                  NARRATION,         
                  USERNAME,         
                  POSTDATE,         
                  EDTDR,         
                  EDTCR        
            )         
      SELECT         
            TOP 1 VNO,         
            VTYP,         
            BOOKTYPE,         
CONVERT(VARCHAR(11), VDT, 109),         
         CONVERT(VARCHAR(11), VDT, 109),         
            SETT_NO,         
            SETT_TYPE,         
            NARRATION,         
            @UNAME,         
            GETDATE(),         
            @@EDTDR,         
            @@EDTCR         
      FROM POSTBILLLEDGER WITH(NOLOCK)         
        
--COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_DRCRNOTEUPLOAD_BULK
-- --------------------------------------------------

 CREATE PROC OFFLINE_DRCRNOTEUPLOAD_BULK    
 @FNAME VARCHAR(100),    
 @UNAME VARCHAR(25),    
 @VTYP SMALLINT,    
 @BOOKTYPE VARCHAR(2),  
 @STRUPLOADBY VARCHAR(25),   
 @STATUSID VARCHAR(25),   
 @STATUSNAME  VARCHAR(25)  
AS    
/*    
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'    
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'    
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'    
*/    
 SET NOCOUNT ON    
    
 DECLARE    
  @@ERROR_COUNT AS INT,    
  @@SQL AS VARCHAR(2000)    
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/    
 IF LTRIM(RTRIM(@FNAME)) = ''    
  BEGIN    
   SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'    
   RETURN    
  END    
    
 CREATE TABLE #FEXIST    
  (F1 INT, F2 INT, F3 INT)    
     
 SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "    
 EXEC (@@SQL)    
    
 SELECT @@ERROR_COUNT = F1 FROM #FEXIST    
 IF @@ERROR_COUNT = 0    
  BEGIN    
   SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'    
   DROP TABLE #FEXIST    
   RETURN    
  END    
    
 BEGIN TRAN    
    
 SELECT     
  @@ERROR_COUNT = COUNT(1)     
 FROM    
  (SELECT     
   U_FILENAME     
  FROM     
   V2_UPLOADED_FILES    
  WHERE     
   U_FILENAME = @FNAME     
   AND U_MODULE = 'DRCR NOTE UPLOAD') A    
    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME    
   ROLLBACK TRAN    
   RETURN    
  END    
    
    
 CREATE TABLE #RECPAY_TABLE_TMP    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(500)    
 )    
    
 CREATE TABLE [#RECPAY_TABLE]    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(255),    
  SNO INT IDENTITY (1, 1) NOT NULL ,    
  VDT DATETIME NULL ,    
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),    
  EDT DATETIME NULL ,    
  VNO VARCHAR (12)  NULL ,    
  ACNAME VARCHAR (100)  NULL ,    
  FYSTART DATETIME NULL,    
  FYEND DATETIME NULL,    
  COSTCODE SMALLINT NULL,    
  LNO SMALLINT NOT NULL DEFAULT(0),  
  BRANCHCODE VARCHAR(10)    
 ) ON [PRIMARY]    
    
 CREATE TABLE [#RECPAY_TABLE_LNO]    
 (    
  SNO INT ,    
  LNO INT IDENTITY (1, 1) NOT NULL    
 ) ON [PRIMARY]    
    
 SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "    
 EXEC(@@SQL)    
    
SELECT * FROM #RECPAY_TABLE_TMP  
  
INSERT INTO V2_UPLOADED_FILES    
SELECT    
  @FNAME,    
  @FNAME,    
  COUNT(1),    
  'B',    
  GETDATE(),    
  @UNAME,    
  'DRCR NOTE UPLOAD'    
    
 INSERT INTO #RECPAY_TABLE    
  (SRNO,    
  VVDT,    
  EEDT,    
  CLTCODE,    
  DRCR,    
  AMOUNT,    
  NARRATION)    
 SELECT    
  SRNO,    
  VVDT,    
  EEDT,    
  UPPER(CLTCODE),    
  DRCR,    
  AMOUNT,    
  LEFT(NARRATION, 234)    
 FROM #RECPAY_TABLE_TMP    
    
 UPDATE    
  #RECPAY_TABLE    
  SET    
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
   FYSTART = P.SDTCUR,    
   FYEND = P.LDTCUR,    
   UPDFLAG = 'Y',    
   ACNAME = LONGNAME,    
   BRANCHCODE = A.BRANCHCODE  
      FROM ACMAST A, PARAMETER P  
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE    
      AND P.CURYEAR = 1    
      AND A.ACCAT IN ('3','4','104')    
    
/*  
 UPDATE    
  #RECPAY_TABLE    
  SET    
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
   FYSTART = P.SDTCUR,    
   FYEND = P.LDTCUR,    
   UPDFLAG = 'Y',    
   ACNAME = LONGNAME,    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
      FROM ACMAST A, PARAMETER P    
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE    
      AND P.CURYEAR = 1    
      AND A.ACCAT IN ('3','4','104')    
      AND A.BRANCHCODE = 'ALL'    
*/    
    
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/    
    
 DECLARE    
  @@STD_DATE VARCHAR(11),    
  @@LST_DATE VARCHAR(11),    
  @@VNOMETHOD INT,    
  @@ACNAME CHAR(100),    
  @@MICRNO VARCHAR(10),    
  @@DRCR VARCHAR(1),  
  @@BRANCHCODE VARCHAR(10),  
  @@MySessionID VARCHAR(12)  
    
Select @@MySessionID = convert(varchar,getdate(),12)+right(replace(convert(varchar,getdate(),114),':',''),6)   
    
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND    
    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'DATE MISMATCH'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
/* '--------------------------UPDATE OF COST CODE ------------------------*/    
    
 UPDATE #RECPAY_TABLE    
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
 WHERE COSTCODE IS NULL    
    
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)    
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(1) FROM    
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)    
  FROM #RECPAY_TABLE    
  GROUP BY SRNO    
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/    
    
 SELECT @@ERROR_COUNT = COUNT(1) FROM    
 (    
  SELECT DISTINCT    
   CLTCODE    
  FROM #RECPAY_TABLE    
  WHERE UPDFLAG = 'N'    
 ) A    
    
 IF @@ERROR_COUNT > 0    
  BEGIN    
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL    
   SELECT DISTINCT    
    CLTCODE    
   FROM #RECPAY_TABLE    
   WHERE UPDFLAG = 'N'    
   DROP TABLE #RECPAY_TABLE_TMP    
   DROP TABLE #RECPAY_TABLE    
   ROLLBACK TRAN    
   DELETE FROM V2_UPLOADED_FILES    
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'    
   RETURN    
  END    
    
 DECLARE    
  @@NEWVNO AS VARCHAR(12),    
  @@VDT AS VARCHAR(11),    
  @@LNOCUR AS CURSOR,    
  @@LNOVNO AS INT,    
  @@NOREC AS INT    
    
    
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/    
/*    
 SET @@LNOCUR = CURSOR FOR    
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE    
 OPEN @@LNOCUR    
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
 WHILE @@FETCH_STATUS = 0    
  BEGIN    
   INSERT INTO #RECPAY_TABLE_LNO    
    (SNO)    
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO    
   UPDATE RP    
    SET LNO = RL.LNO    
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL    
   WHERE RP.SNO = RL.SNO    
   TRUNCATE TABLE #RECPAY_TABLE_LNO    
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
  END    
 CLOSE @@LNOCUR    
 DEALLOCATE @@LNOCUR    
 DROP TABLE #RECPAY_TABLE_LNO    
  */
    
Insert into V2_Offline_Ledger_Entries   
(   
VoucherType, BookType, SNo, VDate, EDate,   
CltCode, CreditAmt, DebitAmt, Narration,   
OppCode, BranchCode, Exchange, Segment, TPFlag,   
AddDt, AddBy, StatusID, StatusName, RowState,   
ApprovalFlag, VoucherNo, ClientName,   
OppCodeName   
)   
Select @VTYP, @BOOKTYPE, LNO, convert(datetime,VVDt,105), convert(datetime,EEDT,105), CLTCODE,   
CreditAmt = (Case when drcr = 'C' then Amount else 0 end),   
DebitAmt = (Case when drcr = 'D' then Amount else 0 end),   
Narration,'', BranchCode, 'NSE','CAPITAL',   
TPFlag = 0, getdate(), @STRUPLOADBY, @STATUSID, @STATUSNAME,  
RowState = 0, ApprovalFlag = 0, @@MySessionID, AcName, ''   
from #RecPay_Table   
  

  
COMMIT  
    
 SELECT RESULT = 'Data Uploaded Successfully'    
 UNION ALL    
 SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE    
 DROP TABLE #RECPAY_TABLE_TMP    
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OfflineLedger_Acc_GenVno
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/              
              
/*            
-------------------------------------            
New Procedure to Generate VNO            
-------------------------------------            
            
Author            : Uppili Krishnan            
Date               : Sep 30 2005            
Reviewed By   :            
Review Date   :            
Tested By       :               
Tested Date    :            
            
-------------------------------------            
            
                    
      Flags:            
            VnoFlag = 0 Yearly            
            VnoFlag = 1 Daily            
            VnoFlag = 2 Monthly            
            
Logic:            
 Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination            
 if for the above combination record is not present in V2_LastVno table then a new record is inserted            
 else existing record is updated            
            
            
                                     
*/              
              
CREATE PROC OfflineLedger_Acc_GenVno    
@vdt      varchar(11),  /* dd/mm/yyyy */                    
@vtyp     smallint,                    
@booktype varchar(2),                    
@sdtcur   varchar(11),                    
@ldtcur   varchar(11),          
@noofrecords int = 1          
/* @vnoflag  int */                    
as                    
                    
                    
                    
Declare @@voudt  as datetime                    
Declare @@maxvno as numeric(12,0)                    
Declare @@vnoflag as tinyint                    
Declare @@vno as varchar(12)                    
Declare @@rcnt as int                    
Declare @@FldAuto bigint                    
Declare @@YearlyVdt varchar(11)                  
Declare @@DailyVDt Varchar(11)                    
Declare @@MonthlyVdt varchar(11)                    
Declare @@UpdtVdt varchar(11)                    
Declare @@FinYear smallint                  
          
Declare @@ReturnVno as varchar(12)          
                    
--SET NOCOUNT ON                    
set Xact_abort on                    
                    
begin transaction                    
            
Select             
      @sdtcur = LEFT(SDTCUR,11),             
      @ldtcur = LEFT(LDTCUR,11),             
      @@vnoflag = isnull(vnoflag,0),                   
      @@FinYear = isnull(FldAuto,0)                    
from             
      Parameter             
where              
      convert(datetime,@vdt) BETWEEN sdtcur and ldtcur             

if isnull(@sdtcur,'') = ''
begin                    
 rollback transaction                    
 select vno = ''                    
 return                    
end                     

            
/*            
Select                   
from                   
      Parameter                   
where                    
      sdtcur like @sdtcur + '%'                   
      and ldtcur like @ldtcur + '%'                  
*/                  
                  
/*                   
Reinitialising the Dates to be posted in the table.                    
      For Daily, the Voucher Date is taken                  
      For Monthly, the 1st Day of the Month  is Taken                  
      For Yearly, the first Day of the year is taken                  
*/                  
                  
select                   
      @@voudt = (select convert(datetime,@vdt)),                   
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),                   
      @@DailyVdt = @Vdt,                   
      @@YearlyVdt = LEFT(@SDTCUR,4) + ' 1 '+ right(@SDTCUR,4)                  
              
-- Doing Yearly Voucher Gen                    
if @@vnoflag = 0                    
   begin                    
      select                   
            @@FldAuto = isnull(FldAuto,0) ,                   
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))                   
      from                   
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)                   
      where                   
            vtyp = @vtyp                   
            and booktype = @booktype                   
            and vdt = @@YearlyVdt + ' 00:00:00'                   
            and VnoFlag = @@VnoFlag                   
            and FinYear = @@FinYear                  
                  
                  
      if @@ROWCOUNT=0                  
         begin                    
            -- If No Record Present, then Insert                  
           select                   
                  @@FldAuto=0,                   
          @@UpdtVdt = @@YearlyVdt,                   
                  @@ReturnVno = Right(@@YearlyVdt,4) + '00000001',                    
  @@Vno = Right(@@YearlyVdt,4) + Replicate('0', 8-len(@noofrecords)) + cast(@noofrecords as varchar)                      
 end                    
         else                    
         begin                    
           select                   
            -- If record is Present, then Update                  
                  @@UpdtVdt = @@YearlyVdt,                   
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1))  ,                  
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                    
         end                    
   end                    
                  
-- Doing Daily Voucher Gen                    
else if @@vnoflag = 1                    
        begin                    
                  
          select                   
                  @@FldAuto = isnull(FldAuto,0) ,                    
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))                   
            from               
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)                   
            where                   
                  vtyp = @vtyp                   
                  and booktype = @booktype                   
                  and vdt = @@DailyVDt + ' 00:00:00'                    
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear                  
                  
                  
          if  @@ROWCOUNT=0                  
             begin                    
            -- If No Record Present, then Insert                  
                select                   
                  @@FldAuto=0,                   
                  @@UpdtVdt = @@DailyVdt,                   
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'          ,          
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+ Replicate('0', 4-len(@noofrecords)) + cast(@noofrecords as varchar)          
          
             end                    
          else                    
             begin                    
            -- If record is Present, then Update                  
               select                   
                  @@UpdtVdt = @@DailyVdt,                   
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                    
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                    
          
             end                    
        end                    
                  
-- Doing Monthly Voucher Gen                    
else if @@vnoflag = 2                    
        begin                    
          select                   
                  @@FldAuto = isnull(FldAuto,0) ,                   
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))                   
            from                   
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)                   
            where                   
                  vtyp = @vtyp                   
                  and booktype = @booktype                   
                  and vdt = @@MonthlyVDt + ' 00:00:00'                    
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear         
                  
                  
          if  @@ROWCOUNT=0                  
             begin                    
            -- If No Record Present, then Insert                  
                select                   
                  @@FldAuto=0,                   
                  @@UpdtVdt = @@MonthlyVdt,                   
                  @@Returnvno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001',                    
  @@Vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+ Replicate('0', 6-len(@noofrecords)) + cast(@noofrecords as varchar)          
          
             end                    
         else                    
       begin                    
            -- If record is Present, then Update                  
               select                   
                  @@UpdtVdt = @@MonthlyVdt,                   
                  @@Returnvno = rtrim(convert(varchar,@@maxvno + 1)),                    
  @@Vno = rtrim(convert(varchar,@@maxvno + @noofrecords))                    
          
             end                    
        end            
                  
                    
if @@error <> 0                     
begin                    
 rollback transaction                    
 select vno = ''                    
 return                    
end                     
else                    
begin                    
       if isnull(@@vno,'') <> ''                     
       begin                    
                  if isnull(@@FldAuto,0) = 0                    
                  begin                    
                    -- If No Record Present, then Insert                  
                        insert into V2_LastVno                   
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)                  
                        values                   
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)                    
                  end                    
                  else                    
                  begin                    
                        -- If record is Present, then Update                  
                        Update                   
                              V2_LastVno                   
                        set                   
                              Lastvno = @@Vno                   
                        where                   
                              FldAuto = @@FldAuto                    
                  end                   
           
                        commit transaction                    
          
                        select vno = @@Returnvno                    
                        return                    
       end                     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OfflineLedger_Newacmultiinsert
-- --------------------------------------------------
CREATE Procedure OfflineLedger_Newacmultiinsert          
@Vtyp Smallint,               
@Booktype Char(2),               
@Vno Varchar(12),               
@Lno Int,               
@Vdt Varchar(11),               
@Edt Varchar(11),               
@Cltcode Varchar(10),               
@Drcr Char(1),                
@Vamt Money,               
@Enteredby Varchar(25),               
@Cdt varchar(30),              
@Checkedby Varchar(25),               
@Pdt varchar(30),             
@Acname Varchar(50),               
@Narration Varchar(234),               
@Chequeinname Varchar(50),               
@Chqprinted Tinyint,               
@Accat Int,               
@Bnkname Varchar(50),               
@Brnname Varchar(30),               
@Dd Char(1),               
@Ddno Varchar(15),               
@Dddt varchar(11),                
@Reldt varchar(11),            
@Relamt Money,               
@Micrno Int,               
@Sessionid Int,               
@Branchname Char(10),               
@Costflag Varchar(1),               
@Costrowid Int,               
@Clearingmode Char(1),               
@Emode Char(1),
@RefLedgerNo varchar(12)
/*slipno, , Chequeinname, Chqprinted*/              
As              
Declare              
@@Vno1 As Varchar(12),               
@@Refno Char(12),               
@@Nodays Int,               
@@Actnodays Int,               
@@Balamt Money,               
@@Slipno Smallint,               
@@Slipdate Datetime,               
@@Clearingmode Char(2),               
@@Receiptno Int,               
@@Branch As Char(15),               
@@Exchange As Varchar(3),               
@@Segment As Varchar(10),               
@@Sett_no As Varchar(7),               
@@Sett_type As Varchar(3),               
@@Party_code As Varchar(10),               
@@Vdt1 As Datetime,               
@@Edt1 As Datetime,               
@@Dddt1 As Datetime,               
@@Reldt1 As Datetime,               
@@Recordcount As Int              
Select @@Vdt1 = Convert(Datetime, @Vdt)              
Select @@Edt1 = Convert(Datetime, @Edt)              
--Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))       
Select @@Dddt1 = Convert(Datetime,@Dddt)                     
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */              
Select @@Reldt1 = convert(datetime,@Reldt,109)              
Select @@Vno1 = @Vno              
Select @@Refno = ''              
Select @@Nodays = 0              
Select @@Actnodays  = 0              
Select @@Balamt = 0              
Select @@Slipno = 0              
Select @@Slipdate = ''              
/*select @@Clearingmode = ' ' */              
Select @@Receiptno = 0              
Select @@Branch =  'Branch'              
/* Inserting Record In Ledger */              
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,               
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)               
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, /*@@Refno*/ @RefLedgerNo, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,               
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger3 */              
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
/* Inserting Common Narration In Ledger3 */              
If @Lno = 2               
Begin              
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
End               
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/              
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20               
Begin              
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)              
      Begin              
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2              
      Begin                 
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
     End               
      End               
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)              
        Begin              
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2              
               
   Begin              
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
                  End               
     End              
    Else If @Vtyp = 5              
        Begin              
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
   If @Accat = 2 And @Drcr = 'C'              
   Begin              
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
   End              
        End              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Records In Matchdetails And Updating Billmatch */              
If @Lno = 2               
Begin              
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)              
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T              
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)               
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype               
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno              
        Insert Into Matchdetails              
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype              
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)               
End              
/* Insertting Records In Margin Ledger */              
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)              
Begin              
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)              
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'                
Begin              
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)                 
 Declare Cur_ledger_insert Cursor For                 
        Select Count(Party_code), Party_code From Templedger2 Where                 
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And               
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code              
                
        Open Cur_ledger_insert                
                
        Fetch Next From Cur_ledger_insert               
        Into @Recordcounter, @Partycode              
While @@Fetch_status = 0                
Begin               
--if  @Partycode <> @Cltcode              
If @Recordcounter = 1              
 Begin              
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                
End              
/* Else              
 Begin              
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 End*/              
Fetch Next From Cur_ledger_insert                 
                 
End                
                
Close Cur_ledger_insert                
Deallocate Cur_ledger_insert                
End               
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/              
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'              
/*select @@Recordcount = Count(Party_code) From Templedger2 Where               
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt              
If @@Recordcount = 0              
Begin*/              
Begin              
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )              
End              
--end              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PARTYLEDGER_SUMMARY
-- --------------------------------------------------
CREATE PROC PARTYLEDGER_SUMMARY
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */    
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */    
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */    
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */    
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */    
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */    
@OPENENTRYFLAG INT,    
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */    
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */    
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */    
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */    
@FPARTY VARCHAR(10),    
@TPARTY VARCHAR(10),    
@SORTACNAMECODE VARCHAR(10)
AS
DECLARE 
@OPENDATE VARCHAR(11)

SELECT @OPENDATE = CONVERT(VARCHAR(11), MAX(VDT), 109) FROM LEDGER WHERE VTYP = 18

IF @STATUSID = 'BROKER'
BEGIN
	SET @STATUSNAME = 'BROKER'
END

CREATE TABLE #NEWPARTYLEDGER
(
	CLTCODE VARCHAR(10),
	ACNAME VARCHAR(100),
	BRANCHCODE VARCHAR(10),
	AMOUNT MONEY,
	UNRELAMT MONEY,
	MARGIN MONEY
)

IF @SORTBYDATE = 'VDT'
BEGIN 
	INSERT INTO #NEWPARTYLEDGER
	SELECT 
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD, 
		AMOUNT = ISNULL(SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END), 0),
		UNRELAMT = ISNULL(SUM(CASE WHEN EDT > CONVERT(DATETIME,CONVERT(VARCHAR(11), GETDATE(),109) + ' 23:59:59') THEN CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END END), 0),
		MARGIN = 0
	FROM 
		LEDGER L, MSAJAG.DBO.CLIENT1 C1, MSAJAG.DBO.CLIENT2 C2
	WHERE 
		L.CLTCODE = C2.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		AND VDT BETWEEN @OPENDATE AND @VDT + ' 23:59:59'
		AND @STATUSNAME = 
                        (CASE 
                                    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                    WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                    WHEN @STATUSID = 'AREA' THEN C1.AREA
                                    WHEN @STATUSID = 'REGION' THEN C1.REGION
                                    WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                    ELSE 
	                        'BROKER'
                        END)     
	GROUP BY
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD

	
	INSERT INTO #NEWPARTYLEDGER
	SELECT 
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD, 
		AMOUNT = 0,
		UNRELAMT = 0,
		MARGIN = ISNULL(SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), 0)
	FROM 
		MARGINLEDGER L, MSAJAG.DBO.CLIENT1 C1, MSAJAG.DBO.CLIENT2 C2
	WHERE 
		C2.PARTY_CODE = L.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		AND VDT BETWEEN @OPENDATE AND @VDT + ' 23:59:59'
		AND @STATUSNAME = 
                        (CASE 
                                    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                    WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                    WHEN @STATUSID = 'AREA' THEN C1.AREA
                                    WHEN @STATUSID = 'REGION' THEN C1.REGION
                                    WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                    ELSE 
	                        'BROKER'
                        END)  
	GROUP BY
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD   
END
ELSE
BEGIN
	INSERT INTO #NEWPARTYLEDGER
	SELECT 
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD, 
		AMOUNT = ISNULL(SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END), 0),
		UNRELAMT = 0,
		MARGIN = 0
	FROM 
		LEDGER L, MSAJAG.DBO.CLIENT1 C1, MSAJAG.DBO.CLIENT2 C2
	WHERE 
		L.CLTCODE = C2.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		AND EDT BETWEEN @OPENDATE AND @VDT + ' 23:59:59'
		AND @STATUSNAME = 
                        (CASE 
                                    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                    WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                    WHEN @STATUSID = 'AREA' THEN C1.AREA
                                    WHEN @STATUSID = 'REGION' THEN C1.REGION
                                    WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                    ELSE 
	                        'BROKER'
                        END)   
	GROUP BY
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD  

	INSERT INTO #NEWPARTYLEDGER
	SELECT 
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD, 
		AMOUNT = ISNULL(SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END), 0),
		UNRELAMT = 0,
		MARGIN = 0
	FROM 
		LEDGER L, MSAJAG.DBO.CLIENT1 C1, MSAJAG.DBO.CLIENT2 C2
	WHERE 
		L.CLTCODE = C2.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		AND EDT >= @OPENDATE AND VDT < @OPENDATE
		AND @STATUSNAME = 
                        (CASE 
                                    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                    WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                    WHEN @STATUSID = 'AREA' THEN C1.AREA
                                    WHEN @STATUSID = 'REGION' THEN C1.REGION
                                    WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                    ELSE 
	                        'BROKER'
                        END)    
	GROUP BY
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD 
	
	INSERT INTO #NEWPARTYLEDGER
	SELECT 
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD, 
		AMOUNT = 0,
		UNRELAMT = 0,
		MARGIN = ISNULL(SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), 0)
	FROM 
		MARGINLEDGER L, MSAJAG.DBO.CLIENT1 C1, MSAJAG.DBO.CLIENT2 C2
	WHERE 
		C2.PARTY_CODE = L.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		AND VDT BETWEEN @OPENDATE AND @VDT + ' 23:59:59'
		AND @STATUSNAME = 
                        (CASE 
                                    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                                    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                                    WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                                    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                                    WHEN @STATUSID = 'AREA' THEN C1.AREA
                                    WHEN @STATUSID = 'REGION' THEN C1.REGION
                                    WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                                    ELSE 
	                        'BROKER'
                        END)    
	GROUP BY
		C2.PARTY_CODE, 
		C1.LONG_NAME, 
		C1.BRANCH_CD
END


SELECT 
	CLTCODE,
	ACNAME,
	BRANCHCODE,
	AMOUNT = SUM(AMOUNT),
	UNRELAMT = SUM(UNRELAMT),
	MARGIN = SUM(MARGIN)
FROM
	#NEWPARTYLEDGER
GROUP BY 
	CLTCODE,
	ACNAME,
	BRANCHCODE
ORDER BY 
	CLTCODE,
	ACNAME,
	BRANCHCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PaymentCalAmt
-- --------------------------------------------------
CREATE PROCEDURE PaymentCalAmt   @advicedate   datetime ,  
@tvdt datetime ,
@effdate datetime,
@LimitAmt    money
As
select  l.cltcode, acname=a.longname, EffCrAmt  =  abs(sum(CVamt) - Sum(DVamt)),
        	creditAmt= isNULL( (SELECT ISNULL(SUM(VAMT),0)    
                                                       FROM LEDGER L1
                           		WHERE  L.CLTCODE=L1.CLTCODE  AND DRCR='C'   
                            		AND  EDT Like @EFFDATE + '%'
                            		and  VDT <= LEFT(CONVERT(VARCHAR,@ADVICEDATE,109),11) + ' ' + '23:59:59'),0),              	shortage = 0  into temppayadv
	from PartyBalAmt l ,acmast a	where l.cltcode=a.cltcode and a.accat= '4' 
	group by l.cltcode, a.longname	having abs(sum(DVamt) - Sum(CVamt)) >= @LimitAmt and (sum(DVamt) - Sum(CVamt)) < 0 	order by l.cltcode 
	insert into payadv   select cltcode ,acname, @tvdt   ,effcramt - creditamt ,'',acname,'',0,effcramt,shortage,	'3','','01'
	from temppayadv where abs(effcramt - creditamt) > 0	GROUP BY cltcode ,acname, effcramt,shortage ,effcramt , creditamt	HAVING  effcramt - creditamt   > =  @limitamt
 	drop  table temppayadv

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PopulateLastVno
-- --------------------------------------------------

CREATE PROC PopulateLastVno

AS

DECLARE
	@@PARA AS SMALLINT,
	@@STD_DATE AS VARCHAR(11),
	@@LST_DATE AS VARCHAR(11)

BEGIN TRAN

SELECT @@PARA = VNOFLAG, @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109), @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109) FROM PARAMETER WHERE CURYEAR = 1
IF @@PARA = 0		--FOR YEARLY SERIES
	BEGIN
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
	END
ELSE
	IF @@PARA = 2
		BEGIN
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
		END
	ELSE
		IF @@PARA = 1
			BEGIN
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
			END
COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CLASSFILEUPD
-- --------------------------------------------------
CREATE PROC [dbo].[PR_CLASSFILEUPD]
(
	@USERNAME VARCHAR(20),
	@SESSION_ID VARCHAR(30),
	@FILE_TYPE VARCHAR(100)
)
AS

  SET NOCOUNT ON 

  DECLARE @RETMESSAGE VARCHAR(1000) 

  SET @RETMESSAGE = @FILE_TYPE + ' - FILE UPLOADED SUCCESSFULLY' 

  IF @FILE_TYPE = 'APP SECURITIES(NSECM)' OR @FILE_TYPE = 'APP SECURITIES(NSEFO)'   
    BEGIN   
      EXEC MSAJAG.DBO.V2_APPROVEDSECURITIES_NSE @USERNAME,@SESSION_ID,@FILE_TYPE  
    END  
  
  IF @FILE_TYPE = 'APP SECURITIES'   
    BEGIN   
      EXEC MSAJAG.DBO.V2_APPROVEDSECURITIES_BROKER @USERNAME,@SESSION_ID,@FILE_TYPE  
    END  
  
  IF @FILE_TYPE = 'FNO EXPOSURE(PMS)'   
    BEGIN   
      EXEC NSEFO.DBO.V2_FNOEXPOSUREPMS_UP @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END  
  
  IF @FILE_TYPE = 'JV FILE(PMS)'   
    BEGIN   
      EXEC ACCOUNTFO.DBO.JVUPLOAD_PMS @USERNAME,@SESSION_ID,@FILE_TYPE ,8,'02',@RETMESSAGE OUTPUT   
    END  
  
  IF @FILE_TYPE = 'BANK RECEIPT(PMS)'   
    BEGIN   
      EXEC RECPAYUPLOAD_PMS @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END  
  
  IF @FILE_TYPE = 'BANK PAYMENT(PMS)'   
    BEGIN   
      EXEC RECPAYUPLOAD_PMS @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END  

  IF @FILE_TYPE = 'BANK RECEIPT FO(PMS)'   
    BEGIN   
      EXEC ACCOUNTFO.DBO.RECPAYUPLOAD_PMS @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END  
  
  IF @FILE_TYPE = 'BANK PAYMENT FO(PMS)'   
    BEGIN   
      EXEC ACCOUNTFO.DBO.RECPAYUPLOAD_PMS @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END 
  
  IF @FILE_TYPE = 'ADDITIONAL TRADE DETAILS'   
    BEGIN   
      EXEC MSAJAG.DBO.PMS_TRADEDETAILS_UP @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END  

  IF @FILE_TYPE = 'POA HOLDING(PMS)'   
    BEGIN   
      EXEC MSAJAG.DBO.PMS_POABALANCES_UP @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT  
    END  

  IF @FILE_TYPE = 'BANK ENTRIES'     
    BEGIN     
      EXEC RECPAYUPLOAD @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT    
    END   

  IF @FILE_TYPE = 'JOURNAL VOUCHER'     
    BEGIN     
      EXEC DRCRNOTEUPLOAD @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT    
    END 

  IF @FILE_TYPE = 'DEBIT NOTE'     
    BEGIN     
      EXEC DRCRNOTEUPLOAD @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT    
    END 

  IF @FILE_TYPE = 'CREDIT NOTE'     
    BEGIN     
      EXEC DRCRNOTEUPLOAD @USERNAME,@SESSION_ID,@FILE_TYPE,@RETMESSAGE OUTPUT    
    END 



  DELETE CLASSFILEUPD   
  WHERE  SESSION_ID = @SESSION_ID   
  
  SELECT @RETMESSAGE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_SQLTABLEREINDEX
-- --------------------------------------------------

CREATE  Proc PR_SQLTABLEREINDEX (@TABLE_NAME AS VARCHAR(254) = '') AS
/*--------------------------------------------------------------------------------------------------------------------
Program Name 	: PR_SQLTABLEREINDEX
Desc 		: SQL Scripts to 
				1. Re Index all the Transaction Oriented Tables
				2. Checking Index Key Duplication 
Tables Using 	: 1. SQLTableIndex  - Keeping the following Details
			a. TableName
			b. IndexName
			c. IndexColumn
		  2.  SQLTableReIndex_Log - Keeping Re Index Log 
					    and Index Duplication Record
Logic 		: 
			Checking the Availability of the Required Index 
				If Found  --  Re Index & Log to SQLTableReIndex_Log with a remark as 'REINDEX'
				Else   - Create & Log to SQLTableReIndex_Log with a remark as 'NEWINDEX'
				
			Checking the Index Key Duplication
				If Found  -- Log to SQLTableReIndex_Log with a remark as 'DUPLICATE'
Program Benefit : 
			1. Standard Table Index to Maintain
			2. Re Creation Of Index for performance

----------------------------------------------------------------------------------------------------------------------*/



Declare 
	@TableCur Cursor,
	@TableName Varchar(20),
	@IndexName Varchar(10),
	@IndexColumn Varchar(100),
	@IndexColumnChk Varchar(100)
Declare 
	@TIndexName Varchar(20),
	@TIndexColum Varchar(100),
	@strSQL Varchar(200),
	@IndexCurSor Cursor,
	@IndexFlag int,
	@IndexPrv Varchar(20),
	@IndexColumnPrv Varchar(100),
 	@IndexType varchar(20)

SET NOCOUNT ON

Set @TableCur = Cursor For
Select
	TableName,
	IndexName,
	IndexColumn,
	IndexColumnChk = Ltrim(RTrim(Upper(Replace(IndexColumn,',',''))))
From
	SQLTableIndex
Where
	1 = 1
	and TableName = (case when isnull(@TABLE_NAME,'') <> '' then @TABLE_NAME else TableName end) 


Open @TableCur
Fetch Next From @TableCur Into 	@TableName,@IndexName,@IndexColumn,@IndexColumnChk
While @@Fetch_Status = 0       
Begin      
	Set @IndexFlag  = 0
	Set @IndexColumnPrv = ''
	Set @IndexPrv = ''
	Set @IndexCurSor = Cursor for Select * From 
	(
		Select 
			i.name as IndexName,
			case when (i.status & 16)<> 0 then 'CLUSTERED' 
			else 'NONCLUSTERED' end as IndexType,
			upper(isnull(index_col(@TableName, i.indid,1 ),'')+isnull(index_col(@TableName, i.indid,2 ),'')
			+isnull(index_col(@TableName, i.indid,3 ),'')+isnull(index_col(@TableName, i.indid,4 ),'')
			+isnull(index_col(@TableName, i.indid,5 ),'')+isnull(index_col(@TableName, i.indid,6),'')
			+isnull(index_col(@TableName, i.indid,7 ),'')+isnull(index_col(@TableName, i.indid,8),'') ) as IndexColumns
		from 
			(dbo.sysindexes i inner join dbo.sysfilegroups s on i.groupid = s.groupid )
		where 
			id = object_id(@TableName) and i.indid > 0 and i.indid < 255 and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsStatistics') <> 1) and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsAutoStatistics') <> 1) and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsHypothetical') <> 1)
		 
	)TblIdx  Order By IndexColumns
	Open @IndexCurSor
	Fetch Next From @IndexCurSor into @TIndexName,@IndexType,@TIndexColum
	While @@Fetch_Status = 0       
	Begin     
		if @IndexColumnPrv = @TIndexColum
			Begin
				Insert Into SQLTableReIndex_Log Values 
				(@TableName,@IndexPrv,@TIndexColum,'DUPLICATE',@@SPId,GetDate())	
			End 
		If (@TIndexColum = @IndexColumnChk OR @IndexName = @TIndexName) AND @IndexFlag =0
			Begin
				Set @IndexFlag  = 1
				Set @strSQL = 'CREATE ' + @IndexType + ' INDEX ['+ @TIndexName +'] ON [dbo].['+@TableName+']('
				Set @strSQL = @strSQL + @IndexColumn + ')'
				Set @strSQL = @strSQL + ' WITH  DROP_EXISTING ON [PRIMARY]'
				Exec (@strSQL)
				Insert Into SQLTableReIndex_Log Values 
				(@TableName,@TIndexName,@IndexColumn,'REINDEX',@@SPId,GetDate())
			End
		Set @IndexPrv = @TIndexName
		Set @IndexColumnPrv = @TIndexColum
		Fetch Next From @IndexCurSor into @TIndexName,@IndexType,@TIndexColum
	End      
	Close @IndexCurSor      
	DeAllocate @IndexCurSor
	if @IndexFlag =0
		Begin
			Set @strSQL = 'CREATE INDEX ['+ @IndexName +'] ON [dbo].['+@TableName+']('
			Set @strSQL = @strSQL + @IndexColumn + ')'
			Exec (@strSQL)
			Insert Into SQLTableReIndex_Log Values 
			(@TableName,@IndexName,@IndexColumn,'NEWINDEX',@@SPId,GetDate())
		End
	Fetch Next From @TableCur Into 	@TableName,@IndexName,@IndexColumn,@IndexColumnChk
End
Close @TableCur      
DeAllocate @TableCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PREPAIDCARD_CHARGES_UPLOAD
-- --------------------------------------------------

CREATE PROC [DBO].[PREPAIDCARD_CHARGES_UPLOAD]  
 @UNAME VARCHAR(25),  
 @VTYP SMALLINT,  
 @BOOKTYPE VARCHAR(2),
 @TRADEDATE VARCHAR(11),
 @GLCODE VARCHAR(10)
AS  
 
 SET NOCOUNT ON  
  
 DECLARE  
  @@ERROR_COUNT AS INT,  
  @@SQL AS VARCHAR(2000),  
  @TRDATE  VARCHAR(10),
  @SERGLCODE VARCHAR(10),
  @EDUCESSTAXCODE VARCHAR(10),
  @CESS_TAXCODE VARCHAR(10),
  @BROKGLCODE VARCHAR(10)

SELECT @SERGLCODE=ACCODE FROM MSAJAG.DBO.VALANACCOUNT WHERE ACNAME = 'SERVICE TAX'
SELECT @CESS_TAXCODE=ACCODE FROM MSAJAG.DBO.VALANACCOUNT WHERE ACNAME = 'CESS TAX'
SELECT @EDUCESSTAXCODE=ACCODE FROM MSAJAG.DBO.VALANACCOUNT WHERE ACNAME = 'EDU CESS TAX'
SELECT @BROKGLCODE=ACCODE FROM MSAJAG.DBO.VALANACCOUNT WHERE ACNAME = 'BROKERAGE REALISED'

SELECT @TRDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TRADEDATE),103)

 CREATE TABLE [#RECPAY_TABLE]  
 (  
  SRNO INT,  
  VVDT VARCHAR(10),  
  EEDT VARCHAR(10),  
  CLTCODE VARCHAR(10),  
  DRCR VARCHAR(1),  
  AMOUNT MONEY,  
  NARRATION VARCHAR(500),  
  SNO INT IDENTITY (1, 1) NOT NULL ,  
  VDT DATETIME NULL ,  
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),  
  EDT DATETIME NULL ,  
  VNO VARCHAR (12)  NULL ,  
  ACNAME VARCHAR (100)  NULL ,  
  FYSTART DATETIME NULL,  
  FYEND DATETIME NULL,  
  COSTCODE SMALLINT NULL,  
  LNO SMALLINT NOT NULL DEFAULT(0)  
 ) ON [PRIMARY]  
  
 CREATE TABLE [#RECPAY_TABLE_LNO]  
 (  
  SNO INT ,  
  LNO INT IDENTITY (1, 1) NOT NULL  
 ) ON [PRIMARY]  
  

  CREATE TABLE #RECPAY_TABLE_TMP  
  (  
   SRNO INT  IDENTITY (1, 1) NOT NULL,  
   CLTCODE VARCHAR(10),  
   DRCR VARCHAR(1),  
   AMOUNT MONEY,  
   NARRATION VARCHAR(500),
   SERTAXFLAG INT,
   BROKAMT MONEY,
   SERTAXAMT MONEY,
   CESS_TAX MONEY,
   EDUCESSTAX MONEY,
   FLAG INT
  )  
  
--------------- WRITE YOUR SELECT QUERY TO INSERT THE DATA IN #RECPAY_TABLE_TMP TABLE ----------------
	INSERT INTO #RECPAY_TABLE_TMP (CLTCODE,DRCR,AMOUNT,NARRATION,SERTAXFLAG, BROKAMT, SERTAXAMT, CESS_TAX, EDUCESSTAX, FLAG)
	SELECT PARTY_CODE,'D',PP_SCHEME_AMT=(CASE WHEN PP_SERVICE_TAX = 1 THEN PP_SCHEME_AMT ELSE PP_SCHEME_AMT + ROUND(PP_SCHEME_AMT * SERVICE_TAX / 100,2) END),
    NARRATION='PRE PAID BROKERAGE', PP_SERVICE_TAX,
	PP_BROK_AMT = ROUND((CASE WHEN PP_SERVICE_TAX = 1 THEN PP_SCHEME_AMT * 100 / (100 + SERVICE_TAX) ELSE PP_SCHEME_AMT END),2),
	PP_SER_AMT = (CASE WHEN PP_SERVICE_TAX = 1 
					   THEN PP_SCHEME_AMT - ROUND(PP_SCHEME_AMT * 100 / (100 + SERVICE_TAX),2) 
					   ELSE ROUND(PP_SCHEME_AMT * SERVICE_TAX / 100,2)
				  END),
    CESS_TAX, EDUCESSTAX, 1
	FROM MSAJAG.DBO.TBL_PREPAID_MAPPING PM,MSAJAG.DBO.TBL_PREPAID_SCHEME PS, MSAJAG.DBO.GLOBALS G WHERE
	PM.PP_SCHEME_NO = PS.PP_SCHEME_NO
	AND @TRADEDATE  BETWEEN PP_FROM_DATE AND PP_TO_DATE 
	AND AMT_POSTED = 0 
	AND PP_FROM_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

	INSERT INTO #RECPAY_TABLE_TMP (CLTCODE,DRCR,AMOUNT,NARRATION,SERTAXFLAG, BROKAMT, SERTAXAMT, CESS_TAX, EDUCESSTAX, FLAG)
    SELECT @GLCODE, 'D', SUM(REL_AMT), 
	NARRATION = 'REL PRE PAID BROKERAGE', 0, 0, 0, 0, 0, 2 FROM MSAJAG.DBO.TBL_PREPAID_TRANS
    WHERE PP_TRANS_DATE LIKE @TRADEDATE + '%'
    AND POSTFLAG = 0 AND PP_AMTTYPE IN ('C', 'T')

	INSERT INTO #RECPAY_TABLE_TMP (CLTCODE,DRCR,AMOUNT,NARRATION,SERTAXFLAG, BROKAMT, SERTAXAMT, CESS_TAX, EDUCESSTAX, FLAG)
    SELECT PARTY_CODE, 'D', REL_AMT, 
	NARRATION = 'PRE PAID BROKERAGE', 0, 
	PP_BROK_AMT = ROUND(REL_AMT * 100 / (100 + SERVICE_TAX), 2), 
    PP_SER_AMT = REL_AMT - ROUND(REL_AMT * 100 / (100 + SERVICE_TAX), 2), 
    CESS_TAX, EDUCESSTAX, 3 FROM MSAJAG.DBO.TBL_PREPAID_TRANS, MSAJAG.DBO.GLOBALS G
    WHERE PP_TRANS_DATE LIKE @TRADEDATE + '%'
    AND POSTFLAG = 0 AND PP_AMTTYPE = 'A'
	AND @TRADEDATE BETWEEN YEAR_START_DT AND YEAR_END_DT

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   UPPER(CLTCODE),  
   DRCR,  
   AMOUNT,  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP  
  WHERE AMOUNT > 0 AND FLAG IN (2, 3)

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   UPPER(@BROKGLCODE),  
   DRCR='C',  
   AMOUNT=(CASE WHEN FLAG = 2 THEN AMOUNT ELSE BROKAMT END),  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP  
  WHERE AMOUNT > 0 AND FLAG IN (2 ,3)

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   UPPER(CLTCODE),  
   DRCR,  
   AMOUNT,  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP  
  WHERE AMOUNT > 0 AND FLAG = 1

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   @GLCODE,  
   'C',  
   BROKAMT,  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP 
  WHERE BROKAMT > 0 AND FLAG = 1

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   @SERGLCODE,  
   'C',  
   SERTAXAMT = SERTAXAMT - ROUND((SERTAXAMT * CESS_TAX) / (100 + EDUCESSTAX + CESS_TAX),2) - ROUND((SERTAXAMT * EDUCESSTAX) / (100 + EDUCESSTAX + CESS_TAX),2),  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP
  WHERE SERTAXAMT > 0 AND FLAG IN (1, 3)

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   @CESS_TAXCODE,  
   'C',  
   CESSTAXAMT = ROUND((SERTAXAMT * CESS_TAX) / (100 + CESS_TAX + EDUCESSTAX),2),  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP
  WHERE ROUND((SERTAXAMT * CESS_TAX) / (100 + CESS_TAX + EDUCESSTAX),2) > 0 AND FLAG IN (1, 3)

  INSERT INTO #RECPAY_TABLE  
   (SRNO,  
   VVDT,  
   EEDT,
   CLTCODE,  
   DRCR,  
   AMOUNT,  
   NARRATION)  
  SELECT  
   SRNO,  
   @TRDATE AS VVDT,  
   @TRDATE AS EEDT,  
   @EDUCESSTAXCODE,  
   'C',  
   EDUCESSTAXAMT = ROUND((SERTAXAMT * EDUCESSTAX) / (100 + EDUCESSTAX + CESS_TAX),2),  
   LEFT(NARRATION, 234)  
  FROM #RECPAY_TABLE_TMP
  WHERE ROUND((SERTAXAMT * EDUCESSTAX) / (100 + EDUCESSTAX + CESS_TAX),2) > 0 AND FLAG IN (1, 3)

  UPDATE  
   #RECPAY_TABLE  
   SET  
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),  
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),  
    FYSTART = P.SDTCUR,  
    FYEND = P.LDTCUR,  
    UPDFLAG = 'Y',  
    ACNAME = LONGNAME,  
    COSTCODE = C.COSTCODE  
    FROM ACMAST A, PARAMETER P, COSTMAST C  
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
    AND P.CURYEAR = 1  
    AND A.ACCAT IN ('3','4','104')  
    AND A.BRANCHCODE = C.COSTNAME  
    AND A.BRANCHCODE <> 'ALL'  
  
    UPDATE  
   #RECPAY_TABLE  
   SET  
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),  
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),  
    FYSTART = P.SDTCUR,  
    FYEND = P.LDTCUR,  
    UPDFLAG = 'Y',  
    ACNAME = LONGNAME,  
    COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
    FROM ACMAST A, PARAMETER P  
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE  
    AND P.CURYEAR = 1  
    AND A.ACCAT IN ('3','4','104')  
    AND A.BRANCHCODE = 'ALL'  
 
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/  
  
 DECLARE  
  @@STD_DATE VARCHAR(11),  
  @@LST_DATE VARCHAR(11),  
  @@VNOMETHOD INT,  
  @@ACNAME CHAR(100),  
  @@MICRNO VARCHAR(10),  
  @@DRCR VARCHAR(1)  
  
  
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND  
  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'DATE MISMATCH'  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
     
   RETURN  
  END  
  
/* '--------------------------UPDATE OF COST CODE ------------------------*/  
  
 UPDATE #RECPAY_TABLE  
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
 WHERE COSTCODE IS NULL  

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)  
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
     
   RETURN  
  END  
  
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM #RECPAY_TABLE  
  GROUP BY SRNO  
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
     
   RETURN  
  END  
  
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/  
  
 SELECT @@ERROR_COUNT = COUNT(1) FROM  
 (  
  SELECT DISTINCT  
   CLTCODE  
  FROM #RECPAY_TABLE  
  WHERE UPDFLAG = 'N'  
 ) A  
  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL  
   SELECT DISTINCT  
    CLTCODE  
   FROM #RECPAY_TABLE  
   WHERE UPDFLAG = 'N'  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
     
   RETURN  
  END  
  
 DECLARE  
  @@NEWVNO AS VARCHAR(12),  
  @@VDT AS VARCHAR(11),  
  @@LNOCUR AS CURSOR,  
  @@LNOVNO AS INT,  
  @@NOREC AS INT  
  
  
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/  
 DECLARE  
  @@MAXVNO AS VARCHAR(12),  
  @@VNO AS VARCHAR(12),  
  @@RCOUNT AS INT  
 SELECT TOP 1  
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)  
 FROM  
  #RECPAY_TABLE  
  
 SELECT TOP 1  
  @@VNOMETHOD = VNOFLAG,  
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),  
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)  
 FROM  
  PARAMETER  
 WHERE  
  @@VDT BETWEEN SDTCUR AND LDTCUR  
  
   
 SELECT  
  @@NOREC = COUNT(DISTINCT SRNO)  
 FROM  
  #RECPAY_TABLE  
  
 IF @@VNOMETHOD = 0  
  BEGIN  
   SELECT  
    @@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))  
   FROM  
    V2_LASTVNO WITH (TABLOCKX,HOLDLOCK)  
   WHERE  
    VTYP = @VTYP  
    AND BOOKTYPE = @BOOKTYPE  
    AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'  
   IF @@MAXVNO = '0'  
    BEGIN  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, RIGHT(@@STD_DATE, 4) + '00000000') + @@NOREC)  
     SELECT @@VNO = RIGHT(@@STD_DATE, 4) + '00000001', @@RCOUNT = 0  
    END  
   ELSE  
    BEGIN  
     SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)  
    END  
   IF @@RCOUNT = 1  
    BEGIN  
     UPDATE  
      V2_LASTVNO  
     SET  
      LASTVNO = @@MAXVNO  
     WHERE  
      VTYP = @VTYP  
      AND BOOKTYPE = @BOOKTYPE  
      AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'  
    END  
   ELSE  
    BEGIN  
     INSERT INTO  
      V2_LASTVNO  
      (VTYP, BOOKTYPE, VDT, LASTVNO)  
     VALUES  
      (@VTYP, @BOOKTYPE, @@STD_DATE, @@MAXVNO)  
    END  
  END  
 ELSE IF @@VNOMETHOD = 1  
  BEGIN  
   SELECT  
    @@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))  
   FROM  
    V2_LASTVNO WITH (TABLOCKX,HOLDLOCK)  
   WHERE  
    VTYP = @VTYP  
    AND BOOKTYPE = @BOOKTYPE  
    AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'  
   IF @@MAXVNO = '0'  
    BEGIN  
     SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0000'  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)  
     SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0001', @@RCOUNT = 0  
    END  
   ELSE  
    BEGIN  
     SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)  
    END  
   IF @@RCOUNT = 1  
    BEGIN  
     UPDATE  
      V2_LASTVNO  
     SET  
      LASTVNO = @@MAXVNO  
     WHERE  
      VTYP = @VTYP  
      AND BOOKTYPE = @BOOKTYPE  
      AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'  
    END  
   ELSE  
    BEGIN  
     INSERT INTO  
      V2_LASTVNO  
      (VTYP, BOOKTYPE, VDT, LASTVNO)  
     VALUES  
      (@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)  
    END  
  END  
 ELSE IF @@VNOMETHOD = 2  
  BEGIN  
   SELECT  
    @@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))  
   FROM  
    V2_LASTVNO WITH (TABLOCKX,HOLDLOCK)  
   WHERE  
    VTYP = @VTYP  
    AND BOOKTYPE = @BOOKTYPE  
    AND MONTH(VDT) = MONTH(@@VDT)  
    AND YEAR(VDT) = YEAR(@@VDT)  
   IF @@MAXVNO = '0'  
    BEGIN  
     SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000000'  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)  
     SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000001', @@RCOUNT = 0  
    END  
   ELSE  
    BEGIN  
     SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1  
     SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)  
    END  
   IF @@RCOUNT = 1  
    BEGIN  
     UPDATE  
      V2_LASTVNO  
     SET  
      LASTVNO = @@MAXVNO  
     WHERE  
      VTYP = @VTYP  
      AND BOOKTYPE = @BOOKTYPE  
      AND MONTH(VDT) = MONTH(@@VDT)  
      AND YEAR(VDT) = YEAR(@@VDT)  
    END  
   ELSE  
    BEGIN  
     INSERT INTO  
      V2_LASTVNO  
      (VTYP, BOOKTYPE, VDT, LASTVNO)  
     VALUES  
      (@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)  
    END  
  END  
  
 UPDATE  
  #RECPAY_TABLE  
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)  
  
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/  
  
 SET @@LNOCUR = CURSOR FOR  
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE  
 OPEN @@LNOCUR  
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO  
 WHILE @@FETCH_STATUS = 0  
  BEGIN  
   INSERT INTO #RECPAY_TABLE_LNO  
    (SNO)  
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO  
   UPDATE RP  
    SET LNO = RL.LNO  
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL  
   WHERE RP.SNO = RL.SNO  
   TRUNCATE TABLE #RECPAY_TABLE_LNO  
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO  
  END  
 CLOSE @@LNOCUR  
 DEALLOCATE @@LNOCUR  
 DROP TABLE #RECPAY_TABLE_LNO  
  
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/  
/*==============================  
      LEDGER RECORD  
==============================*/  
 INSERT  
 INTO LEDGER  
 SELECT  
  VTYP = @VTYP,  
  VNO,  
  EDT,  
  LNO,  
  ACNAME,  
  DRCR,  
  VAMT = AMOUNT,  
  VDT,  
  VNO1 = VNO,  
  REFNO = 0,  
  BALAMT = AMOUNT,  
  NODAYS = 0,  
  CDT = GETDATE(),  
  CLTCODE,  
  BOOKTYPE = @BOOKTYPE,  
  ENTEREDBY = @UNAME,  
  PDT = GETDATE(),  
  CHECKEDBY = @UNAME,  
  ACTNODAYS = 0,  
  NARRATION  
 FROM  
  #RECPAY_TABLE  
  
/*==============================  
 LEDGER3 RECORD  
==============================*/  
 INSERT  
 INTO LEDGER3  
 SELECT  
  NARATNO = LNO,  
  NARRATION,  
  REFNO = 0,  
  VTYP = @VTYP,  
  VNO,  
  BOOKTYPE = @BOOKTYPE  
      FROM  
  #RECPAY_TABLE 
  
 DELETE FROM TEMPLEDGER2  
  WHERE SESSIONID = '9999999999'  
 INSERT INTO TEMPLEDGER2  
 SELECT  
  'BRANCH',  
  C.COSTNAME,  
  AMOUNT,  
  VTYP = @VTYP,  
  VNO,  
  LNO,  
  DRCR,  
  '0',  
  BOOKTYPE = @BOOKTYPE,  
  SESSIONID = '9999999999',  
  CLIENT_CODE = CLTCODE,  
  'A',  
  '0'  
 FROM  
  #RECPAY_TABLE RP,  
  COSTMAST C  
 WHERE  
  RP.COSTCODE = C.COSTCODE  
  
 DECLARE @@L2CUR AS CURSOR,  
  @@L2VNO AS VARCHAR(12)  
 SET @@L2CUR = CURSOR FOR  
  SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO  
 OPEN @@L2CUR  
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO  
 WHILE @@FETCH_STATUS = 0  
  BEGIN  
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'  
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO  
  END  
  DELETE FROM TEMPLEDGER2  
   WHERE SESSIONID = '9999999999'  
  CLOSE @@L2CUR  
  DEALLOCATE @@L2CUR  
  
 UPDATE MSAJAG.DBO.TBL_PREPAID_MAPPING
 SET AMT_POSTED=1 
 WHERE @TRADEDATE BETWEEN PP_FROM_DATE AND PP_TO_DATE  
 AND AMT_POSTED=0

 UPDATE MSAJAG.DBO.TBL_PREPAID_TRANS SET POSTFLAG = 1
 WHERE PP_TRANS_DATE LIKE @TRADEDATE + '%'
 AND POSTFLAG = 0

 SELECT RESULT = '0~<HR><B>.:: DATA POSTED SUCCESSFULLY ::.</B><HR>'   
 UNION ALL  
 SELECT RESULT = VNO + ', ' + DRCR + ', ' + CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) FROM #RECPAY_TABLE ORDER BY 1  
 DROP TABLE #RECPAY_TABLE_TMP  
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_acc_getcompanyname
-- --------------------------------------------------
--EXEC proc_acc_GetCompanyName 'ACCCOMMON'

/****** Object:  Stored Procedure dbo.proc_acc_GetCompanyName    Script Date: 5/18/04 1:04:54 PM ******/  
  
CREATE PROCEDURE proc_acc_GetCompanyName  
 @AccoundDBName VarChar (50)  
AS  
  
SELECT * FROM  
 pradnya.dbo.multicompany  
  
WHERE  
 accountdb = @AccoundDBName 
AND   primaryserver = 1  
  
ORDER BY  
 companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.procGetTutorialCats
-- --------------------------------------------------
CREATE PROCEDURE procGetTutorialCats
AS
select 
	companyname,Exchange 
from 
	msajag..multicompany 
where 
	Exchange = 'NSE' and Segment = 'Capital'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.procGetTutorialCats1
-- --------------------------------------------------

CREATE PROCEDURE procGetTutorialCats1
AS
select 
	Defaultclient
from 
	msajag..multicompany 
where 
	Exchange = 'NSE' and Segment = 'Capital'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD
-- --------------------------------------------------
  
CREATE PROC [dbo].[RECPAYUPLOAD]  
 @UNAME VARCHAR(25),  
 @SESSION_ID VARCHAR(15),  
 @FILE_TYPE VARCHAR(100),
 @RETMESSAGE VARCHAR(1000) OUTPUT                 
                    
AS                    
/*                    
begin tran                    
ROLLBACK
SP_HELPTRIGGER LEDGER                    
LEDGER_TRG_BILL                    
LEDGER_TRG                    
EXEC RECPAYUPLOAD 'SYSTEM', '999999999', 'BANK RECEIPT'
SELECT TOP 1 * FROM LEDGER3                    
SELECT TOP 1 * FROM LEDGER_TRG                    
ROLLBACK                    
*/                    
SET NOCOUNT ON                    
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                    
DECLARE                    
 @@STD_DATE VARCHAR(11),                    
 @@LST_DATE VARCHAR(11),                    
 @@BRANCHFLAG AS TINYINT,                    
 @@VNOFLAG AS TINYINT,                    
 @@VNOMETHOD INT,                    
 @@ACNAME CHAR(100),                    
 @@BOOKTYPE CHAR(2),                    
 @@MICRNO VARCHAR(10),                    
 @@DRCR VARCHAR(1),                    
 @@VTYP SMALLINT,                    
 @@BANK_CODE VARCHAR(100),                    
 @@BACKDAYS INT,                    
 @@BACKDATE VARCHAR(11),                    
 @@BRNCOUNT   TINYINT,                    
 @@MonthlyVdt VARCHAR(11),                    
 @@SERIAL_NO INT,                    
 @@COSTCODECOUNT TINYINT,                    
 @@COSTCODEUPDATES CURSOR,                    
 @@NEWVNO AS VARCHAR(12),                    
 @@MAXCOUNT AS INT,                    
 @@VDT AS VARCHAR(11),                    
 @@BANKBRANCH AS VARCHAR(10),                    
 @@BANKCOST AS NUMERIC,                    
 @@LNOCUR AS CURSOR,                    
 @@VNOCUR AS CURSOR,                    
 @@LNOVNO AS VARCHAR(12),                    
 @@MAXVNO AS INT,                    
 @@L2CUR AS CURSOR,                    
 @@L2VNO AS VARCHAR(12),                    
 @@ERROR_COUNT AS INT,                    
 @@FILEEXISTS AS INT,                    
 @@SQL AS VARCHAR(2000),
 @USERCAT INT                      
                    
/*SELECT                    
 @@ERROR_COUNT = COUNT(1)                    
FROM                    
 (                    
  SELECT                    
   U_FILENAME                    
  FROM                    
   V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
 ) A                    
IF @@ERROR_COUNT > 0                    
 BEGIN                    
  SELECT                    
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                    
  RETURN                    
 END      */              
/*CREATE TABLE #FEXIST                    
(                    
 F1 SMALLINT,                    
 F2 SMALLINT,                    
 F3 SMALLINT                    
)                    
SELECT @@SQL = "INSERT INTO "                    
SELECT @@SQL = @@SQL + " #FEXIST "                    
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                    
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                    
                    
EXEC(@@SQL)                    
                    
SELECT                    
 @@FILEEXISTS = F1                    
FROM                    
 #FEXIST                    
                    
IF @@FILEEXISTS = 0                    
 BEGIN                    
  DROP TABLE #FEXIST                    
  SELECT                    
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                    
  RETURN                    
 END                    
DROP TABLE #FEXIST  */                  
                    
BEGIN TRAN 

CREATE TABLE #FILELOG
 (
	FIELD1 VARCHAR(25),
	FIELD2 VARCHAR(25),
	FIELD3 VARCHAR(25),
	FIELD4 VARCHAR(25),
	FIELD5 VARCHAR(25),
	FIELD6 VARCHAR(200),
	FIELD7 VARCHAR(100),
	FIELD8 VARCHAR(25),
	FIELD9 VARCHAR(25)
  )
                   
CREATE TABLE #RECPAY_TABLE_TMP                    
(                    
 SERIAL_NO INT,                    
 EDATE VARCHAR(20),                    
 VOUCHER_DATE VARCHAR(20),                    
 CLIENT_CODE VARCHAR(50),                    
 AMOUNT VARCHAR(20),                    
 DRCR VARCHAR(1),                    
 NARRATION VARCHAR(234),                    
 BANK_CODE VARCHAR(10),                    
 BANK_NAME VARCHAR(100),                    
 REF_NO VARCHAR(15),                    
 BRANCHCODE VARCHAR(20),                    
 BRANCH_NAME VARCHAR(50),                    
 CHQ_MODE VARCHAR(1),           
 CHQ_DATE VARCHAR(20),                    
 CHQ_NAME VARCHAR(100),                    
 CL_MODE VARCHAR(1)                    
)                    
CREATE TABLE [#RECPAY_TABLE]                    
 (                    
  SERIAL_NO INT,                    
  EDATE VARCHAR(20),                    
  VOUCHER_DATE VARCHAR(20),                    
  CLIENT_CODE VARCHAR(50),                    
  AMOUNT MONEY,                    
  DRCR VARCHAR(1),                    
  NARRATION VARCHAR(234),                    
  BANK_CODE VARCHAR(10),                    
  BANK_NAME VARCHAR(100),                    
  REF_NO VARCHAR(15),                    
  BRANCHCODE VARCHAR(20),                    
  BRANCH_NAME VARCHAR(50),                    
  CHQ_MODE VARCHAR(1),                    
  CHQ_DATE VARCHAR(20),                    
  CHQ_NAME VARCHAR(100),                    
  CL_MODE VARCHAR(1),                    
  SNO INT IDENTITY (1, 1) NOT NULL ,                    
  VDT DATETIME NULL ,                    
  FYSTART DATETIME NULL ,                    
  FYEND DATETIME NULL ,                    
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                    
  EDT DATETIME NULL ,                    
  DDDT DATETIME NULL ,                    
  VNO VARCHAR (12) NULL ,                
  VTYP SMALLINT NULL ,                    
  ACNAME VARCHAR (100) NULL ,                    
  COSTCODE SMALLINT NULL,                    
  BANKCOST SMALLINT NULL,                    
  LNO SMALLINT NOT NULL DEFAULT(0),                    
  BANKNAME VARCHAR(100) NULL,                    
  MICRNO INT NULL,                    
  BOOKTYPE VARCHAR(2) NULL,                    
 ) ON [PRIMARY]                    
                    
/*SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                    
EXEC (@@SQL)                    */

DECLARE @FILEDATA CURSOR    
 DECLARE @ROWDATA VARCHAR(2000),    
 @SQL VARCHAR(2000)    
   
  
 SET @FILEDATA = CURSOR FOR  SELECT  ''''+REPLACE(FILE_DATA,',',''',''')+ '''' FROM CLASSFILEUPD (NOLOCK) WHERE SESSION_ID = @SESSION_ID   
 OPEN @FILEDATA      
   
  FETCH NEXT FROM @FILEDATA INTO @ROWDATA    
  WHILE @@FETCH_STATUS = 0           
   BEGIN          
    SELECT @SQL =  'INSERT INTO #RECPAY_TABLE_TMP VALUES ('+@ROWDATA+')'    
    EXEC (@SQL)     
  FETCH NEXT FROM @FILEDATA INTO @ROWDATA    
 END          
 CLOSE @FILEDATA          
 DEALLOCATE @FILEDATA

SET @FILEDATA = CURSOR FOR SELECT  ''''+REPLACE(FILE_PARAM,',',''',''')+ '''' FROM CLASSFILEUPD_LOG (NOLOCK) WHERE SESSION_ID = @SESSION_ID     
 OPEN @FILEDATA        
     
  FETCH NEXT FROM @FILEDATA INTO @ROWDATA      
  WHILE @@FETCH_STATUS = 0             
   BEGIN            
    SELECT @SQL =  'INSERT INTO #FILELOG VALUES ('+@ROWDATA+')'      
    EXEC (@SQL)       
  FETCH NEXT FROM @FILEDATA INTO @ROWDATA      
 END            
 CLOSE @FILEDATA            
 DEALLOCATE @FILEDATA 

 SELECT TOP 1 @USERCAT = FIELD9 FROM #FILELOG 


IF @@ERROR <> 0                    
 BEGIN                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRANSACTION                    
  SET @RETMESSAGE = @FILE_TYPE + '  DUE TO SOME ERROR IN UPLOAD, THE FILE COULD NOT BE UPLOADED...'                    
  RETURN                    
 END                    
/*INSERT INTO                    
 V2_UPLOADED_FILES                    
SELECT                    
 @FNAME,                    
 @FNAME,                    
 CNT = COUNT(1),                    
 'B',                    
 GETDATE(),                    
 @UNAME,                    
 'RECEIPT/PAYMENT UPLOAD'  */                  
                    
INSERT INTO                    
 #RECPAY_TABLE                    
 (                    
  SERIAL_NO,                    
  EDATE,                    
  VOUCHER_DATE,                    
  CLIENT_CODE,                    
  AMOUNT,                    
  DRCR,                    
  NARRATION,                    
  BANK_CODE,                    
  BANK_NAME,                    
  REF_NO,                    
  BRANCHCODE,                    
  BRANCH_NAME,                    
  CHQ_MODE,                    
  CHQ_DATE,                    
  CHQ_NAME,                    
  CL_MODE                    
 )                    
SELECT                    
 SERIAL_NO,                    
 EDATE,                    
 VOUCHER_DATE,                    
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                    
 CONVERT(MONEY, AMOUNT),
 UPPER(LTRIM(RTRIM(DRCR))),                    
 NARRATION,                    
 UPPER(LTRIM(RTRIM(BANK_CODE))),                    
 UPPER(LTRIM(RTRIM(BANK_NAME))),                    
 REF_NO,                
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                    
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                    
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                    
 CHQ_DATE,                    
 CHQ_NAME,                    
 CL_MODE                    
FROM                    
 #RECPAY_TABLE_TMP                    
                    
UPDATE                    
 #RECPAY_TABLE                    
SET              
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                    
              
              
SELECT TOP 1                    
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                    
FROM                    
 #RECPAY_TABLE                    
              
              
SELECT                    
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                    
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                    
 @@BRANCHFLAG = BRANCHFLAG,                    
 @@VNOFLAG = VNOFLAG                    
FROM                    
 PARAMETER                    
WHERE                    
 @@VDT BETWEEN SDTCUR AND LDTCUR                 
                    
IF @@VNOFLAG <> 0               
BEGIN                   
 SELECT                    
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                    
 FROM                    
  #RECPAY_TABLE                    
                     
 IF @@ERROR_COUNT > 1                    
  BEGIN                    
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRANSACTION                    
   SET @RETMESSAGE = @FILE_TYPE + ' FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                    
   RETURN                    
  END                  
END                
                    
                    
IF @@BRANCHFLAG = 1                
 BEGIN                    
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   BRANCHCODE = A.BRANCHCODE,                    
   FYSTART = P.SDTCUR,                    
   FYEND = P.LDTCUR,                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,                    
   COSTCODE = C.COSTCODE,                    
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE                    
AND B.CLTCODE = BANK_CODE                    
   AND P.CURYEAR = 1                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
   AND A.BRANCHCODE = COSTNAME                    
                      
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                    
   FYSTART = P.SDTCUR,                    
   FYEND = P.LDTCUR,                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                    
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE            
   AND B.CLTCODE = BANK_CODE                    
   AND P.CURYEAR = 1                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
   AND A.BRANCHCODE = 'ALL'                    
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                    
                    
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   BRANCHCODE = 'HO',                    
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                    
   FYSTART = P.SDTCUR,                    
   FYEND = P.LDTCUR,                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                    
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE                    
   AND B.CLTCODE = BANK_CODE                    
   AND P.CURYEAR = 1                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
   AND A.BRANCHCODE = 'ALL'                    
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                    
 END                    
ELSE                    
 BEGIN                    
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   FYSTART = @@STD_DATE,                    
   FYEND = @@LST_DATE + ' 23:59:59',                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,           
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE                    
   AND B.CLTCODE = BANK_CODE                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
 END                    
              
              
              
                   
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                    
                    
SELECT              
 SERIAL_NO, VOUCHER_DATE              
INTO #DUP_VDTS              
FROM              
 #RECPAY_TABLE              
GROUP BY SERIAL_NO, VOUCHER_DATE              
              
SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS              
GROUP BY SERIAL_NO              
HAVING COUNT(1) > 1              
              
 IF @@ERROR_COUNT > 1                    
  BEGIN                    
   SET @RETMESSAGE = @FILE_TYPE + '  SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO'
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
                   
   RETURN                    
  END                    
              
              
SELECT               
 @@ERROR_COUNT = COUNT(SERIAL_NO)               
FROM               
 #RECPAY_TABLE              
WHERE VDT NOT BETWEEN FYSTART AND FYEND              
          
 IF @@ERROR_COUNT > 0              
  BEGIN                    
   SET @RETMESSAGE = @FILE_TYPE + '  SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'    
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
   
   RETURN                    
  END                    
              
SET @@ERROR_COUNT = 0              
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/                    
/*                    
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)                    
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1                    
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES '                   
   DROP TABLE #RecPay_Table_Tmp                    
   DROP TABLE #RecPay_Table                    
   ROLLBACK TRAN                    
   DELETE FROM V2_Uploaded_Files                    
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
   RETURN                    
  END*/                    
                    
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                    
 SELECT                    
  @@ERROR_COUNT = COUNT(1)                    
 FROM                    
  (                    
   SELECT                    
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),          
    SERIAL_NO                    
   FROM                    
    #RECPAY_TABLE                    
   GROUP BY                    
    SERIAL_NO                    
   HAVING                    
    COUNT(DISTINCT BANK_CODE) > 1                    
  ) A                    
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
   SET @RETMESSAGE = @FILE_TYPE + '  MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                    
                    
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
   
   RETURN                    
  END                    
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                    
SELECT                    
 @@ERROR_COUNT = COUNT(1)                    
FROM                    
 (                    
 SELECT                    
   DISTINCT DRCR = (CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'D' ELSE 'C' END)        
 FROM                    
  #RECPAY_TABLE    
 GROUP BY SERIAL_NO    
 ) A                
            
IF @@ERROR_COUNT > 1                    
 BEGIN                    
  SET @RETMESSAGE = @FILE_TYPE + ' PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.'                   
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
  
  RETURN                    
 END                    
ELSE                    
 BEGIN                    
  SELECT TOP 1                    
   @@DRCR = DRCR,                    
   @@VTYP =                    
    (                    
    CASE                    
     WHEN DRCR = 'D'                    
     THEN 3                    
     ELSE 2                    
    END                    
    )                    
  FROM                    
   #RECPAY_TABLE         
        
  UPDATE R         
  SET VTYP =         
 CASE WHEN AMOUNT1 > 0 THEN 3 ELSE 2 END        
 FROM (SELECT AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), SERIAL_NO FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1, #RECPAY_TABLE R        
 WHERE R.SERIAL_NO = R1.SERIAL_NO        
                
  /*UPDATE                    
   #RECPAY_TABLE                    
  SET VTYP =     
   (                    
   CASE                    
     WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) > 0                  
     THEN 3                    
     ELSE 2                    
    END                    
   )       */             
 END              
        
              
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                    
 SELECT @@ERROR_COUNT = COUNT(1)                    
 FROM #RECPAY_TABLE                    
 WHERE VDT > EDT                    
            IF @@ERROR_COUNT > 0                    
             BEGIN                    
				SET @RETMESSAGE = @FILE_TYPE + ' VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                    
				DROP TABLE #RECPAY_TABLE_TMP                    
				DROP TABLE #RECPAY_TABLE                    
     ROLLBACK TRAN                    
     
     RETURN                    
      END                    
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                    
 SELECT @@ERROR_COUNT = COUNT(1)                    
 FROM #RECPAY_TABLE                    
 WHERE AMOUNT <= 0                    
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
              SET @RETMESSAGE = @FILE_TYPE + ' VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                    
     DROP TABLE #RECPAY_TABLE_TMP                    
     DROP TABLE #RECPAY_TABLE                    
     ROLLBACK TRAN                    

     RETURN                    
  END          
             
SELECT        
@@ERROR_COUNT = COUNT(1)        
FROM        
(        
 SELECT DISTINCT        
  DDNO  = RP.REF_NO        
 FROM        
  #RECPAY_TABLE RP,        
  LEDGER1 L1  WITH(NOLOCK)        
 WHERE        
  L1.DDNO = RP.REF_NO        
  AND L1.BNKNAME = RP.BANK_NAME        
  AND L1.DD = RP.CHQ_MODE        
  AND L1.DRCR = @@DRCR        
  AND L1.VTYP = @@VTYP        
  AND RP.REF_NO <> '0'        
  AND ISNUMERIC(RP.REF_NO) = 1        
) A        
           
                
IF @@ERROR_COUNT > 0                    
 BEGIN                    
  SET @RETMESSAGE = @FILE_TYPE + ' FILE CANNOT BE UPLOADED AS THE SOME OF THE CHEQUE NUMBER ALREADY EXISTS'                  
               
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
                  
  RETURN                    
 END                    
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                    
SELECT                    
 @@ERROR_COUNT = COUNT(1)                    
FROM                    
 (                    
  SELECT DISTINCT                    
   CLIENT_CODE                    
  FROM                    
   #RECPAY_TABLE                    
  WHERE                    
   UPDFLAG = 'N'                    
 ) A                    
IF @@ERROR_COUNT > 0                    
 BEGIN                    
  SET @RETMESSAGE = @FILE_TYPE + '  FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST'        
                   
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
                    
  RETURN                    
 END                    
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */                    
  SET @@VNOCUR = CURSOR FOR                    
   SELECT DISTINCT                    
    BANK_CODE,                    
    BOOKTYPE                    
   FROM                    
    #RECPAY_TABLE WITH(NOLOCK)                    
  OPEN @@VNOCUR                    
  FETCH NEXT                    
   FROM                    
    @@VNOCUR                    
   INTO                    
    @@BANK_CODE,                    
    @@BOOKTYPE                    
  WHILE @@FETCH_STATUS = 0                    
   BEGIN                    
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------              
    SELECT                    
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)                    
    FROM                    
     USERWRITESTABLE                    
    WHERE                    
     USERCATEGORY = @USERCAT                    
     AND VTYP = @@VTYP                    
     AND BOOKTYPE = @@BOOKTYPE                    
    SELECT                    
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                    
    SELECT                    
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                    
    FROM                    
     #RECPAY_TABLE                    
    WHERE                    
     VDT < @@BACKDATE                    
    IF @@ERROR_COUNT > 0                    
     BEGIN                    
      SELECT                    
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                    
      DROP TABLE #RECPAY_TABLE_TMP                    
      DROP TABLE #RECPAY_TABLE                    
      ROLLBACK TRAN                    
                       
      RETURN                    
     END   
              
    IF @@BRANCHFLAG = 1                    
     BEGIN                    
      SELECT                    
       @@BANKBRANCH = BRANCHCODE,                    
       @@BANKCOST = ISNULL(C.COSTCODE, -1)                    
      FROM                    
       ACMAST A                    
        LEFT OUTER JOIN                    
        COSTMAST C                    
        ON                    
         (                    
          A.BRANCHCODE = C.COSTNAME                    
         )                    
      WHERE                    
    A.CLTCODE = @@BANK_CODE                    
      IF @@BANKBRANCH <> 'ALL'                    
       BEGIN                  
        UPDATE                    
         RP                    
          SET COSTCODE = @@BANKCOST                    
        FROM                    
         #RECPAY_TABLE RP,                    
         ACMAST A                    
        WHERE                    
         A.CLTCODE = RP.CLIENT_CODE                    
         AND A.BRANCHCODE = 'ALL'                    
        UPDATE                    
         #RECPAY_TABLE                    
          SET BANKCOST = @@BANKCOST                    
        WHERE                    
         BANK_CODE = @@BANK_CODE                    
       END                    
      ELSE                    
       BEGIN                    
        UPDATE                    
         #RECPAY_TABLE                    
          SET COSTCODE =                    
           (                    
            SELECT TOP 1                    
             COSTCODE                    
            FROM                    
             COSTMAST                    
            WHERE                    
             COSTNAME = 'HO'                    
           )                    
        WHERE                    
         COSTCODE = ''                    
         AND BANK_CODE = @@BANK_CODE                    
                            SET @@COSTCODEUPDATES = CURSOR FOR                    
                                       SELECT                    
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)                    
                                       FROM                    
                                             #RECPAY_TABLE WITH(NOLOCK)                    
                                       WHERE                    
          BANK_CODE = @@BANK_CODE                    
                                       GROUP BY                    
                                             SERIAL_NO                    
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1                    
                            OPEN @@COSTCODEUPDATES                    
                            FETCH NEXT                    
 FROM                    
                              @@COSTCODEUPDATES                    
                             INTO                    
              @@SERIAL_NO,                    
                              @@COSTCODECOUNT                    
   WHILE @@FETCH_STATUS = 0                    
                             BEGIN                    
          UPDATE                    
           #RECPAY_TABLE                    
            SET BANKCOST =                    
             (                    
              SELECT TOP 1                    
               COSTCODE                    
              FROM                    
               COSTMAST                    
              WHERE                    
               COSTNAME = 'HO'                    
             )                    
          WHERE                    
           (BANKCOST = ''   OR BANKCOST IS NULL)                    
           AND BANK_CODE = @@BANK_CODE                    
                                           AND SERIAL_NO = @@SERIAL_NO                    
                              FETCH NEXT                    
                               FROM                    
                     @@COSTCODEUPDATES                    
                               INTO                    
                                @@SERIAL_NO,                    
                                @@COSTCODECOUNT                    
                             END                    
                            CLOSE @@COSTCODEUPDATES                    
                            DEALLOCATE @@COSTCODEUPDATES                    
                  UPDATE                    
                   #RECPAY_TABLE                    
                    SET BANKCOST = COSTCODE                    
            WHERE                    
                   BANK_CODE = @@BANK_CODE                    
  AND (BANKCOST = ''   OR BANKCOST IS NULL)                    
       END                    
     END                    
    CREATE TABLE                    
     #BANK_VNO                    
     (                    
      SRNO INT,                    
      NEWSRNO INT IDENTITY (1, 1)                    
     )                    
    INSERT INTO                    
     #BANK_VNO                    
    SELECT                    
     DISTINCT SERIAL_NO                    
    FROM                    
     #RECPAY_TABLE                    
    WHERE                    
     BANK_CODE = @@BANK_CODE                    
     AND BOOKTYPE = @@BOOKTYPE                    
                    
   SELECT                    
     @@MAXCOUNT = COUNT(DISTINCT SNO)                    
    FROM                    
     #RECPAY_TABLE                    
                    
    SELECT TOP 1          
     @@VDT = VDT                    
    FROM                    
     #RECPAY_TABLE  

	CREATE TABLE #VNO
	(
		LASTVNO VARCHAR(12)
	)
                  
                  
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                    
    INSERT                    
    INTO #VNO                    
     EXEC ACC_GENVNO_NEW                    
      @@VDT,                    
      @@VTYP,                    
      @@BOOKTYPE,                    
      @@STD_DATE,                    
      @@LST_DATE,                    
      @@MAXVNO                    
    SELECT                    
     @@NEWVNO = LASTVNO                    
    FROM                    
     #VNO                    
    UPDATE                    
     RP                    
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                    
    FROM                    
     #RECPAY_TABLE RP,                    
     #BANK_VNO BV                    
    WHERE                    
     RP.SERIAL_NO = BV.SRNO                    
   DROP TABLE #VNO                    
   DROP TABLE #BANK_VNO                    
  FETCH NEXT                    
   FROM @@VNOCUR                    
   INTO                    
    @@BANK_CODE,                    
    @@BOOKTYPE                    
 END                    
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */                    
UPDATE                    
 #RECPAY_TABLE                    
  SET LNO = 2                    
WHERE                    
 VNO IN                    
  (                    
   SELECT                    
    VNO                    
   FROM                    
 #RECPAY_TABLE                    
     WITH(NOLOCK)                    
   GROUP BY                    
    VNO                    
   HAVING                    
    COUNT(*) = 1                    
  )                    
SET @@LNOCUR = CURSOR FOR                    
 SELECT                    
  VNO                    
 FROM                    
  #RECPAY_TABLE                    
   WITH(NOLOCK)                    
 GROUP BY                    
  VNO                    
 HAVING                    
  COUNT(*) > 1                    
OPEN @@LNOCUR                    
FETCH NEXT                    
 FROM                    
  @@LNOCUR                    
 INTO                    
  @@LNOVNO                    
WHILE @@FETCH_STATUS = 0                    
 BEGIN                    
  CREATE TABLE                    
   [#LNOGEN]                    
    (                    
     VNO VARCHAR(12),                    
     SNO INT,                    
     LNO INT IDENTITY(1,1)                    
    )                    
  INSERT INTO                    
   #LNOGEN                    
    SELECT                    
     VNO,                    
     SNO                    
    FROM                    
     #RECPAY_TABLE                    
      WITH(NOLOCK)                    
    WHERE                    
     VNO = @@LNOVNO                    
    ORDER BY                    
     SNO                    
  UPDATE                    
   #RECPAY_TABLE                    
    SET LNO = L.LNO + 1                    
  FROM                    
   #LNOGEN L                    
  WHERE                    
   #RECPAY_TABLE.VNO = L.VNO                    
   AND #RECPAY_TABLE.SNO = L.SNO                    
   AND #RECPAY_TABLE.LNO = 0                    
  DROP TABLE #LNOGEN                    
  FETCH NEXT                    
   FROM                    
    @@LNOCUR                    
   INTO                    
    @@LNOVNO                    
 END                    
CLOSE @@LNOCUR                    
DEALLOCATE @@LNOCUR                    
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */                    
INSERT INTO                    
 LEDGER1                    
  (                    
   BNKNAME,                    
   BRNNAME,                    
   DD,                    
   DDNO,                    
   DDDT,                    
   RELDT,                    
   RELAMT,                    
   REFNO,                    
   RECEIPTNO,                    
   VTYP,                    
   VNO,                    
   LNO,                    
   DRCR,                    
   BOOKTYPE,                    
   MICRNO,                    
   SLIPNO,                    
   SLIPDATE,                    
   CHEQUEINNAME,                    
   CHQPRINTED,                    
   CLEAR_MODE                    
  )                    
SELECT                    
 BNKNAME = MAX(BANK_NAME),                    
 BRNNAME = MAX(BRANCH_NAME),                    
 DD = MAX(CHQ_MODE),                    
 DDNO = MAX(REF_NO),                    
 DDDT = MAX(DDDT),                    
 RELDT = '',                    
 RELAMT = ABS(SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)),                    
 REFNO = 0,                    
 RECEIPTNO = 0,                    
 VTYP,                    
 VNO,                    
 LNO = 2,                    
 @@DRCR,                  
 BOOKTYPE = BOOKTYPE,                    
 MICRNO = MICRNO,                    
 SLIPNO = 0,                    
 SLIPDATE = '',                    
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                    
 CHQPRINTED = 0,                    
 CLEAR_MODE = MAX(CL_MODE)                    
FROM                    
 #RECPAY_TABLE                    
GROUP BY                    
 VTYP,                    
 VNO,                    
 BOOKTYPE,                  
 MICRNO                  
                    
IF @@ERROR <> 0                    
 BEGIN                    
  SELECT                    
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
                   
  RETURN                    
 END                    
                    
/*================================                    
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK                    
=================================*/                    
CREATE TABLE #LEDGER                    
(                    
 VTYP SMALLINT,                    
 VNO VARCHAR(12),                    
 EDT DATETIME,                    
 LNO SMALLINT,                    
 ACNAME VARCHAR(100),                    
 DRCR VARCHAR(1),                    
 VAMT MONEY,                    
 VDT DATETIME,                    
 VNO1 VARCHAR(12),                    
 REFNO CHAR(12),                    
 BALAMT MONEY,                    
 NODAYS INT,                    
 CDT DATETIME,                    
 CLTCODE VARCHAR(10),                    
 BOOKTYPE VARCHAR(2),                    
 ENTEREDBY VARCHAR(25),                    
 PDT DATETIME,                    
 CHECKEDBY VARCHAR(25),                    
 ACTNODAYS INT,                    
 NARRATION VARCHAR(234)                    
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0                    
CREATE TABLE #LEDGER3                    
(                    
 NARATNO INT,                    
 NARR VARCHAR(234),                    
 REFNO CHAR(12),                    
 VTYP SMALLINT,                    
 VNO VARCHAR(12),                    
 BOOKTYPE VARCHAR(2)                    
)                    
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0                    
/*==============================                    
CLIENT SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER                    
 (                    
  VTYP,                    
  VNO,                  
  EDT,                    
  LNO,                    
  ACNAME,                    
  DRCR,                    
  VAMT,                    
  VDT,                    
  VNO1,                    
  REFNO,                    
  BALAMT,                    
  NODAYS,                    
  CDT,                    
  CLTCODE,                    
  BOOKTYPE,                    
  ENTEREDBY,                    
  PDT,               
  CHECKEDBY,                    
  ACTNODAYS,                    
  NARRATION                    
 )                    
SELECT                    
 VTYP,                    
 VNO,                    
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                    
 LNO,                    
 ACNAME,                    
 DRCR,                    
 VAMT = AMOUNT,                    
 VDT,                    
 VNO1 = VNO,                    
 REFNO = 0,                    
 BALAMT = AMOUNT,                    
 NODAYS = 0,                    
 CDT = GETDATE(),                    
 CLTCODE = CLIENT_CODE,                    
 BOOKTYPE = BOOKTYPE,                    
 ENTEREDBY = '*' + LEFT(@UNAME, 23),
 PDT = GETDATE(),                    
 CHECKEDBY = '*' + LEFT(@UNAME, 23),                    
 ACTNODAYS = 0,                    
 NARRATION                  
FROM                    
 #RECPAY_TABLE                    
/*==============================                    
BANK SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER                    
SELECT  DISTINCT                  
 VTYP,                    
 VNO,                    
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                    
 LNO = 1,                    
 BANKNAME,                    
 MAX(DRCR1),                    
 VAMT = ABS(MAX(AMOUNT1)),                    
 VDT,                    
 VNO1 = VNO,                    
 REFNO = 0,                    
 BALAMT = ABS(MAX(AMOUNT1)),                    
 NODAYS = 0,                    
 CDT = GETDATE(),                    
 CLTCODE = BANK_CODE,                    
 BOOKTYPE = BOOKTYPE,                    
 ENTEREDBY = '*' + LEFT(@UNAME, 23),                    
 PDT = GETDATE(),                    
 CHECKEDBY = '*' + LEFT(@UNAME, 23),                    
 ACTNODAYS = 0,                    
 NARRATION = NARRATION_FIN  
FROM    
 #RECPAY_TABLE R, (SELECT SERIAL_NO, AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), DRCR1 = CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'C' ELSE 'D' END, NARRATION_FIN = MAX(NARRATION) FROM #RECPAY_TABLE GROUP
 BY SERIAL_NO) R1        
WHERE R.SERIAL_NO = R1.SERIAL_NO                
GROUP BY                    
 VTYP,                    
 VNO,                    
 EDT,                    
 VDT,                    
 BANK_CODE,                    
 BOOKTYPE,                    
 BANKNAME,         
 LNO,  
 NARRATION_FIN                    
/*==============================                    
INSERTING ALL LEDGER RECORDS AT ONE TIME                    
==============================*/                    
              
INSERT INTO LEDGER  SELECT                    
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration                    
FROM                    
 #LEDGER                    
ORDER BY                    
 BOOKTYPE,                    
 VTYP,                    
 VNO,                    
 LNO                    
                    
IF @@ERROR <> 0                    
 BEGIN                    
  SELECT                    
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  DROP TABLE #LEDGER                    
  DROP TABLE #LEDGER3                    
  ROLLBACK TRAN                    
                   
  RETURN                    
 END                    
DROP TABLE #LEDGER                    
/*==============================                    
BANK SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER3                    
SELECT                    
 NARATNO = 1,                    
 NARRATION = MAX(NARRATION),                    
 REFNO = 0,               
 VTYP,                    
 VNO,                    
 BOOKTYPE                    
FROM                    
 #RECPAY_TABLE                    
GROUP BY                    
 VTYP,                    
 VNO,                    
 BOOKTYPE                    
/*==============================                    
CLIENT SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER3                    
SELECT                    
 NARATNO = LNO,                    
 NARR = NARRATION,                    
 REFNO = 0,                    
 VTYP,                    
 VNO,                    
 BOOKTYPE                    
FROM                    
 #RECPAY_TABLE                    
                    
                    
/*==============================                    
INSERTING ALL LEDGER3 RECORDS AT ONE TIME                    
==============================*/                    
INSERT INTO LEDGER3                    
SELECT                    
 *                    
FROM                    
 #LEDGER3                    
ORDER BY                    
 BOOKTYPE,                    
 VTYP,                    
 VNO,                    
 NARATNO                    
                    
IF @@ERROR <> 0                    
 BEGIN                    
  SELECT                    
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  DROP TABLE #LEDGER3                    
  ROLLBACK TRAN                    
                  
  RETURN                    
 END                    
DROP TABLE #LEDGER3                    
            
                    
IF @@BRANCHFLAG = 1                    
 BEGIN                    
  SET @@L2CUR = CURSOR FOR                    
   SELECT DISTINCT                    
    VNO                    
   FROM                    
    #RECPAY_TABLE                    
   ORDER BY                    
    VNO                    
  OPEN @@L2CUR                    
   FETCH NEXT                    
   FROM                    
    @@L2CUR                    
   INTO                    
    @@L2VNO                    
  WHILE @@FETCH_STATUS = 0                    
   BEGIN                    
    DELETE FROM                    
     TEMPLEDGER2                    
    WHERE                    
     SESSIONID = '9999999999'                    
/*==============================                    
CLIENT SIDE RECORD                    
==============================*/                    
    INSERT INTO                    
     TEMPLEDGER2                    
    SELECT                    
     'BRANCH',                    
     C.COSTNAME,                    
    AMOUNT,                    
     VTYP,                    
     VNO,                    
     LNO,                    
     DRCR,                    
     '0',                    
     BOOKTYPE,                    
     '9999999999',                    
     CLIENT_CODE,                    
     'A',                    
     '0'                    
    FROM                    
     #RECPAY_TABLE RP,                    
     COSTMAST C                    
    WHERE                    
     RP.COSTCODE = C.COSTCODE                    
     AND VNO = @@L2VNO                    
/*==============================                    
BANK SIDE RECORD                    
==============================*/                    
    INSERT INTO                    
     TEMPLEDGER2                    
    SELECT                    
     'BRANCH',                    
     C.COSTNAME,                    
     SUM(AMOUNT),                    
     VTYP,                    
     VNO,                    
     LNO = 1,                    
     DRCR =                    
      (                    
       CASE                    
       WHEN DRCR = 'D'                    
    THEN 'C'                    
       ELSE 'D'                    
       END                    
      ),                    
     '0',                    
     BOOKTYPE,                    
     '9999999999',                    
     BANK_CODE,                    
     'A',                    
     '0'                    
    FROM                    
     #RECPAY_TABLE RP,                    
     COSTMAST C                    
    WHERE                    
     RP.BANKCOST = C.COSTCODE                    
     AND VNO = @@L2VNO                    
    GROUP BY                    
     C.COSTNAME,                    
     VTYP,                
     VNO,                    
      (                    
       CASE                    
       WHEN DRCR = 'D'                    
       THEN 'C'                    
       ELSE 'D'                    
       END                    
      ),                    
     BANK_CODE,                    
     BOOKTYPE                    
    EXEC INSERTTOLEDGER2                    
     '9999999999',                    
     @@L2VNO,                    
     '1',                    
     '1',                    
     '1',                    
     'BROKER',                    
     'BROKER'                    
    FETCH NEXT                    
     FROM                    
      @@L2CUR                    
     INTO                    
      @@L2VNO                    
   END                    
  DELETE FROM                    
   TEMPLEDGER2                    
  WHERE                    
   SESSIONID = '9999999999'                    
                      
 END           
COMMIT TRAN                 
SET @RETMESSAGE = @FILE_TYPE + ' RECORDS UPLOADED SUCCESSFULLY'                    
DROP TABLE #RECPAY_TABLE_TMP                    
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK]  
 @FNAME VARCHAR(100),                    
 @UNAME VARCHAR(25),                    
 @USERCAT SMALLINT                    
                    
AS                    
/*                    
begin tran                    
SP_HELPTRIGGER LEDGER                    
LEDGER_TRG_BILL                    
LEDGER_TRG                    
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388                    
SELECT TOP 1 * FROM LEDGER3                    
SELECT TOP 1 * FROM LEDGER_TRG                    
ROLLBACK                    
*/                    
SET NOCOUNT ON                    
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                    
DECLARE                    
 @@STD_DATE VARCHAR(11),                    
 @@LST_DATE VARCHAR(11),                    
 @@BRANCHFLAG AS TINYINT,                    
 @@VNOFLAG AS TINYINT,                    
 @@VNOMETHOD INT,                    
 @@ACNAME CHAR(100),                    
 @@BOOKTYPE CHAR(2),                    
 @@MICRNO VARCHAR(10),                    
 @@DRCR VARCHAR(1),                    
 @@VTYP SMALLINT,                    
 @@BANK_CODE VARCHAR(100),                    
 @@BACKDAYS INT,                    
 @@BACKDATE VARCHAR(11),                    
 @@BRNCOUNT   TINYINT,                    
 @@MonthlyVdt VARCHAR(11),                    
 @@SERIAL_NO INT,                    
 @@COSTCODECOUNT TINYINT,                    
 @@COSTCODEUPDATES CURSOR,                    
 @@NEWVNO AS VARCHAR(12),                    
 @@MAXCOUNT AS INT,                    
 @@VDT AS VARCHAR(11),                    
 @@BANKBRANCH AS VARCHAR(10),                    
 @@BANKCOST AS NUMERIC,                    
 @@LNOCUR AS CURSOR,                    
 @@VNOCUR AS CURSOR,                    
 @@LNOVNO AS VARCHAR(12),                    
 @@MAXVNO AS INT,                    
 @@L2CUR AS CURSOR,                    
 @@L2VNO AS VARCHAR(12),                    
 @@ERROR_COUNT AS INT,                    
 @@FILEEXISTS AS INT,                    
 @@SQL AS VARCHAR(2000)                    
                    
/*SELECT                    
 @@ERROR_COUNT = COUNT(1)                    
FROM                    
 (                    
  SELECT                    
   U_FILENAME                    
  FROM                    
   V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
 ) A                    
IF @@ERROR_COUNT > 0                    
 BEGIN                    
  SELECT                    
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                    
  RETURN                    
 END      */              
CREATE TABLE #FEXIST                    
(                    
 F1 SMALLINT,                    
 F2 SMALLINT,                    
 F3 SMALLINT                    
)                    
SELECT @@SQL = "INSERT INTO "                    
SELECT @@SQL = @@SQL + " #FEXIST "                    
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                    
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                    
                    
EXEC(@@SQL)                    
                    
SELECT                    
 @@FILEEXISTS = F1                    
FROM                    
 #FEXIST                    
                    
IF @@FILEEXISTS = 0                    
 BEGIN                    
  DROP TABLE #FEXIST                    
  SELECT                    
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                    
  RETURN                    
 END                    
DROP TABLE #FEXIST                    
                    
BEGIN TRAN                    
CREATE TABLE #RECPAY_TABLE_TMP                    
(                    
 SERIAL_NO INT,                    
 EDATE VARCHAR(20),                    
 VOUCHER_DATE VARCHAR(20),                    
 CLIENT_CODE VARCHAR(50),                    
 AMOUNT MONEY,                    
 DRCR VARCHAR(1),                    
 NARRATION VARCHAR(234),                    
 BANK_CODE VARCHAR(10),                    
 BANK_NAME VARCHAR(100),                    
 REF_NO VARCHAR(15),                    
 BRANCHCODE VARCHAR(20),                    
 BRANCH_NAME VARCHAR(50),                    
 CHQ_MODE VARCHAR(1),           
 CHQ_DATE VARCHAR(20),                    
 CHQ_NAME VARCHAR(100),                    
 CL_MODE VARCHAR(1)                    
)                    
CREATE TABLE [#RECPAY_TABLE]                    
 (                    
  SERIAL_NO INT,                    
  EDATE VARCHAR(20),                    
  VOUCHER_DATE VARCHAR(20),                    
  CLIENT_CODE VARCHAR(50),                    
  AMOUNT MONEY,                    
  DRCR VARCHAR(1),                    
  NARRATION VARCHAR(234),                    
  BANK_CODE VARCHAR(10),                    
  BANK_NAME VARCHAR(100),                    
  REF_NO VARCHAR(15),                    
  BRANCHCODE VARCHAR(20),                    
  BRANCH_NAME VARCHAR(50),                    
  CHQ_MODE VARCHAR(1),                    
  CHQ_DATE VARCHAR(20),                    
  CHQ_NAME VARCHAR(100),                    
  CL_MODE VARCHAR(1),                    
  SNO INT IDENTITY (1, 1) NOT NULL ,                    
  VDT DATETIME NULL ,                    
  FYSTART DATETIME NULL ,                    
  FYEND DATETIME NULL ,                    
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                    
  EDT DATETIME NULL ,                    
  DDDT DATETIME NULL ,                    
  VNO VARCHAR (12) NULL ,                
VTYP SMALLINT NULL ,                    
  ACNAME VARCHAR (100) NULL ,                    
  COSTCODE SMALLINT NULL,                    
  BANKCOST SMALLINT NULL,                    
  LNO SMALLINT NOT NULL DEFAULT(0),                    
  BANKNAME VARCHAR(100) NULL,                    
  MICRNO INT NULL,                    
  BOOKTYPE VARCHAR(2) NULL,                    
 ) ON [PRIMARY]                    
                    
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                    
EXEC (@@SQL)                    
                    
IF @@ERROR <> 0                    
 BEGIN                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRANSACTION                    
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                    
  RETURN                    
 END                    
INSERT INTO                    
 V2_UPLOADED_FILES                    
SELECT                    
 @FNAME,                    
 @FNAME,                    
 CNT = COUNT(1),                    
 'B',                    
 GETDATE(),                    
 @UNAME,                    
 'RECEIPT/PAYMENT UPLOAD'                    
                    
INSERT INTO                    
 #RECPAY_TABLE                    
 (                    
  SERIAL_NO,                    
  EDATE,                    
  VOUCHER_DATE,                    
  CLIENT_CODE,                    
  AMOUNT,                    
  DRCR,                    
  NARRATION,                    
  BANK_CODE,                    
  BANK_NAME,                    
  REF_NO,                    
  BRANCHCODE,                    
  BRANCH_NAME,                    
  CHQ_MODE,                    
  CHQ_DATE,                    
  CHQ_NAME,                    
  CL_MODE                    
 )                    
SELECT                    
 SERIAL_NO,                    
 EDATE,                    
 VOUCHER_DATE,                    
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                    
 AMOUNT,                    
 UPPER(LTRIM(RTRIM(DRCR))),                    
 NARRATION,                    
 UPPER(LTRIM(RTRIM(BANK_CODE))),                    
 UPPER(LTRIM(RTRIM(BANK_NAME))),                    
 REF_NO,                
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                    
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                    
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                    
 CHQ_DATE,                    
 CHQ_NAME,                    
 CL_MODE                    
FROM                    
 #RECPAY_TABLE_TMP                    
                    
UPDATE                    
 #RECPAY_TABLE                    
SET              
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                    
              
              
SELECT TOP 1                    
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                    
FROM                    
 #RECPAY_TABLE                    
              
              
SELECT                    
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                    
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                    
 @@BRANCHFLAG = BRANCHFLAG,                    
 @@VNOFLAG = VNOFLAG                    
FROM                    
 PARAMETER                    
WHERE                    
 @@VDT BETWEEN SDTCUR AND LDTCUR                 
                    
IF @@VNOFLAG <> 0               
BEGIN                   
 SELECT                    
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                    
 FROM                    
  #RECPAY_TABLE                    
                     
 IF @@ERROR_COUNT > 1                    
  BEGIN                    
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRANSACTION                    
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                    
   RETURN                    
  END                  
END                
                    
                    
IF @@BRANCHFLAG = 1                
 BEGIN                    
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   BRANCHCODE = A.BRANCHCODE,                    
   FYSTART = P.SDTCUR,                    
   FYEND = P.LDTCUR,                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,                    
   COSTCODE = C.COSTCODE,                    
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE                    
AND B.CLTCODE = BANK_CODE                    
   AND P.CURYEAR = 1                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
   AND A.BRANCHCODE = COSTNAME                    
                      
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                    
   FYSTART = P.SDTCUR,                    
   FYEND = P.LDTCUR,                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                    
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE            
   AND B.CLTCODE = BANK_CODE                    
   AND P.CURYEAR = 1                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
   AND A.BRANCHCODE = 'ALL'                    
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                    
                    
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   BRANCHCODE = 'HO',                    
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                    
   FYSTART = P.SDTCUR,                    
   FYEND = P.LDTCUR,                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                    
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE                    
   AND B.CLTCODE = BANK_CODE                    
   AND P.CURYEAR = 1                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
   AND A.BRANCHCODE = 'ALL'                    
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                    
 END                    
ELSE                    
 BEGIN                    
  UPDATE                    
   #RECPAY_TABLE                    
  SET                    
   FYSTART = @@STD_DATE,                    
   FYEND = @@LST_DATE + ' 23:59:59',                    
   UPDFLAG = 'Y',                    
   ACNAME = A.LONGNAME,           
   BANKNAME = B.LONGNAME,                    
   BOOKTYPE = B.BOOKTYPE,                    
   MICRNO = ISNULL(B.MICRNO, 0)                    
  FROM                    
   ACMAST A, ACMAST B                    
  WHERE                    
   A.CLTCODE = CLIENT_CODE                    
   AND B.CLTCODE = BANK_CODE                    
   AND A.ACCAT IN ('3','4','18')                    
   AND B.ACCAT = '2'                    
 END                    
              
              
              
                   
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                    
                    
SELECT              
 SERIAL_NO, VOUCHER_DATE              
INTO #DUP_VDTS              
FROM              
 #RECPAY_TABLE              
GROUP BY SERIAL_NO, VOUCHER_DATE              
              
SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS              
GROUP BY SERIAL_NO              
HAVING COUNT(1) > 1              
              
 IF @@ERROR_COUNT > 1                    
  BEGIN                    
   SELECT                    
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO', 'NA', 'NA'                    
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
   DELETE                    
   FROM                    
    V2_UPLOADED_FILES                    
   WHERE                    
    U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
   RETURN                    
  END                    
              
              
SELECT               
 @@ERROR_COUNT = COUNT(SERIAL_NO)               
FROM               
 #RECPAY_TABLE              
WHERE VDT NOT BETWEEN FYSTART AND FYEND              
          
 IF @@ERROR_COUNT > 0              
  BEGIN                    
   SELECT             
    'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.', 'NA', 'NA'     
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
   DELETE                    
   FROM                    
    V2_UPLOADED_FILES                    
   WHERE                    
    U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
   RETURN                    
  END                    
              
SET @@ERROR_COUNT = 0              
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/                    
/*                    
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)                    
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1                    
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'                    
   DROP TABLE #RecPay_Table_Tmp                    
   DROP TABLE #RecPay_Table                    
   ROLLBACK TRAN                    
   DELETE FROM V2_Uploaded_Files                    
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
   RETURN                    
  END*/                    
                    
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                    
 SELECT                    
  @@ERROR_COUNT = COUNT(1)                    
 FROM                    
  (                    
   SELECT                    
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),          
    SERIAL_NO                    
   FROM                    
    #RECPAY_TABLE                    
   GROUP BY                    
    SERIAL_NO                    
   HAVING                    
    COUNT(DISTINCT BANK_CODE) > 1                    
  ) A                    
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
   SELECT                    
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                    
   UNION ALL                    
   SELECT                    
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                    
   FROM                    
    #RECPAY_TABLE                    
   GROUP BY                    
    SERIAL_NO                    
   HAVING                    
    COUNT(DISTINCT BANK_CODE) > 1                    
                    
   DROP TABLE #RECPAY_TABLE_TMP                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
   DELETE                    
   FROM                    
    V2_UPLOADED_FILES                    
   WHERE                    
    U_FILENAME = @FNAME                    
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
   RETURN                    
  END                    
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                    
SELECT                    
 @@ERROR_COUNT = COUNT(1)                    
FROM                    
 (                    
 SELECT                    
   DISTINCT DRCR = (CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'D' ELSE 'C' END)        
 FROM                    
  #RECPAY_TABLE    
 GROUP BY SERIAL_NO    
 ) A                
            
IF @@ERROR_COUNT > 1                    
 BEGIN                    
  SELECT                    
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
  DELETE                    
  FROM                    
   V2_UPLOADED_FILES        
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
  RETURN                    
 END                    
ELSE                    
 BEGIN                    
  SELECT TOP 1                    
   @@DRCR = DRCR,                    
   @@VTYP =                    
    (                    
    CASE                    
     WHEN DRCR = 'D'                    
     THEN 3                    
     ELSE 2                    
    END                    
    )                    
  FROM                    
   #RECPAY_TABLE         
        
  UPDATE R         
  SET VTYP =         
 CASE WHEN AMOUNT1 > 0 THEN 3 ELSE 2 END        
 FROM (SELECT AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), SERIAL_NO FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1, #RECPAY_TABLE R        
 WHERE R.SERIAL_NO = R1.SERIAL_NO        
                
  /*UPDATE                    
   #RECPAY_TABLE                    
  SET VTYP =     
   (                    
   CASE                    
     WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) > 0                  
     THEN 3                    
     ELSE 2                    
    END                    
   )       */             
 END              
        
              
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                    
 SELECT @@ERROR_COUNT = COUNT(1)                    
 FROM #RECPAY_TABLE                    
 WHERE VDT > EDT                    
            IF @@ERROR_COUNT > 0                    
             BEGIN                    
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                    
     DROP TABLE #RECPAY_TABLE_TMP                    
     DROP TABLE #RECPAY_TABLE                    
     ROLLBACK TRAN                    
     DELETE FROM                    
      V2_UPLOADED_FILES                    
     WHERE                    
      U_FILENAME = @FNAME                    
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
     RETURN                    
      END                    
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                    
 SELECT @@ERROR_COUNT = COUNT(1)                    
 FROM #RECPAY_TABLE                    
 WHERE AMOUNT <= 0                    
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                    
     DROP TABLE #RECPAY_TABLE_TMP                    
     DROP TABLE #RECPAY_TABLE                    
     ROLLBACK TRAN                    
     DELETE FROM                    
      V2_UPLOADED_FILES                    
     WHERE                    
      U_FILENAME = @FNAME                    
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
     RETURN                    
  END          
             
SELECT        
@@ERROR_COUNT = COUNT(1)        
FROM        
(        
 SELECT DISTINCT        
  DDNO  = RP.REF_NO        
 FROM        
  #RECPAY_TABLE RP,        
  LEDGER1 L1  WITH(NOLOCK)        
 WHERE        
  L1.DDNO = RP.REF_NO        
  AND L1.BNKNAME = RP.BANK_NAME        
  AND L1.DD = RP.CHQ_MODE        
  AND L1.DRCR = @@DRCR        
  AND L1.VTYP = @@VTYP        
  AND RP.REF_NO <> '0'        
  AND ISNUMERIC(RP.REF_NO) = 1        
) A        
           
                
IF @@ERROR_COUNT > 0                    
 BEGIN                    
  SELECT                    
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                    
  UNION ALL                    
  SELECT DISTINCT                    
   RP.REF_NO, 'NA','NA'                    
  FROM                    
   #RECPAY_TABLE RP, LEDGER L,           
   LEDGER1 L1                    
    WITH(NOLOCK)                    
  WHERE                    
   L1.DDNO = RP.REF_NO                    
   AND L1.DD = RP.CHQ_MODE                    
   AND L1.DRCR = @@DRCR                    
   AND L1.VTYP = @@VTYP                    
   AND RP.CHQ_MODE <> 'N'           
   AND L.VTYP=@@VTYP          
   AND L.VNO=L1.VNO          
   AND L.BOOKTYPE=L1.BOOKTYPE          
   AND L.DRCR=@@DRCR           
   AND L.CLTCODE=RP.CLIENT_CODE          
              
               
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
  DELETE FROM                    
   V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
  RETURN                    
 END                    
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                    
SELECT                    
 @@ERROR_COUNT = COUNT(1)                    
FROM                    
 (                    
  SELECT DISTINCT                    
   CLIENT_CODE                    
  FROM                    
   #RECPAY_TABLE                    
  WHERE                    
   UPDFLAG = 'N'                    
 ) A                    
IF @@ERROR_COUNT > 0                    
 BEGIN                    
  SELECT                    
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                    
  UNION ALL                    
  SELECT DISTINCT                    
   CLIENT_CODE, 'NA','NA'                    
  FROM                    
   #RECPAY_TABLE                    
  WHERE                    
   UPDFLAG = 'N'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
  DELETE FROM                    
   V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
  RETURN                    
 END                    
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */                    
  SET @@VNOCUR = CURSOR FOR                    
   SELECT DISTINCT                    
    BANK_CODE,                    
    BOOKTYPE                    
   FROM                    
    #RECPAY_TABLE WITH(NOLOCK)                    
  OPEN @@VNOCUR                    
  FETCH NEXT                    
   FROM                    
    @@VNOCUR                    
   INTO                    
    @@BANK_CODE,                    
    @@BOOKTYPE                    
  WHILE @@FETCH_STATUS = 0                    
   BEGIN                    
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------              
    SELECT                    
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)                    
    FROM                    
     USERWRITESTABLE                    
    WHERE                    
     USERCATEGORY = @USERCAT                    
     AND VTYP = @@VTYP                    
     AND BOOKTYPE = @@BOOKTYPE                    
    SELECT                    
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                    
    SELECT                    
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                    
    FROM                    
     #RECPAY_TABLE                    
    WHERE                    
     VDT < @@BACKDATE                    
    IF @@ERROR_COUNT > 0                    
     BEGIN                    
      SELECT                    
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                    
      DROP TABLE #RECPAY_TABLE_TMP                    
      DROP TABLE #RECPAY_TABLE                    
      ROLLBACK TRAN                    
      DELETE FROM V2_UPLOADED_FILES                    
      WHERE                    
       U_FILENAME = @FNAME                    
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
      RETURN                    
     END   
              
    IF @@BRANCHFLAG = 1                    
     BEGIN                    
      SELECT                    
       @@BANKBRANCH = BRANCHCODE,                    
       @@BANKCOST = ISNULL(C.COSTCODE, -1)                    
      FROM                    
       ACMAST A                    
        LEFT OUTER JOIN                    
        COSTMAST C                    
        ON                    
         (                    
          A.BRANCHCODE = C.COSTNAME                    
         )                    
      WHERE                    
    A.CLTCODE = @@BANK_CODE                    
      IF @@BANKBRANCH <> 'ALL'                    
       BEGIN                  
        UPDATE                    
         RP                    
          SET COSTCODE = @@BANKCOST                    
        FROM                    
         #RECPAY_TABLE RP,                    
         ACMAST A                    
        WHERE                    
         A.CLTCODE = RP.CLIENT_CODE                    
         AND A.BRANCHCODE = 'ALL'                    
        UPDATE                    
         #RECPAY_TABLE                    
          SET BANKCOST = @@BANKCOST                    
        WHERE                    
         BANK_CODE = @@BANK_CODE                    
       END                    
      ELSE                    
       BEGIN                    
        UPDATE                    
         #RECPAY_TABLE                    
          SET COSTCODE =                    
           (                    
            SELECT TOP 1                    
             COSTCODE                    
            FROM                    
             COSTMAST                    
            WHERE                    
             COSTNAME = 'HO'                    
           )                    
        WHERE                    
         COSTCODE = ''                    
         AND BANK_CODE = @@BANK_CODE                    
                            SET @@COSTCODEUPDATES = CURSOR FOR                    
                                       SELECT                    
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)                    
                                       FROM                    
                                             #RECPAY_TABLE WITH(NOLOCK)                    
                                       WHERE                    
          BANK_CODE = @@BANK_CODE                    
                                       GROUP BY                    
                                             SERIAL_NO                    
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1                    
                            OPEN @@COSTCODEUPDATES                    
                            FETCH NEXT                    
 FROM                    
                              @@COSTCODEUPDATES                    
                             INTO                    
              @@SERIAL_NO,                    
                              @@COSTCODECOUNT                    
   WHILE @@FETCH_STATUS = 0                    
                             BEGIN                    
          UPDATE                    
           #RECPAY_TABLE                    
            SET BANKCOST =                    
             (                    
              SELECT TOP 1                    
               COSTCODE                    
              FROM                    
               COSTMAST                    
              WHERE                    
               COSTNAME = 'HO'                    
             )                    
          WHERE                    
           (BANKCOST = ''   OR BANKCOST IS NULL)                    
           AND BANK_CODE = @@BANK_CODE                    
                                           AND SERIAL_NO = @@SERIAL_NO                    
                              FETCH NEXT                    
                               FROM                    
                     @@COSTCODEUPDATES                    
                               INTO                    
                                @@SERIAL_NO,                    
                                @@COSTCODECOUNT                    
                             END                    
                            CLOSE @@COSTCODEUPDATES                    
                            DEALLOCATE @@COSTCODEUPDATES                    
                  UPDATE                    
                   #RECPAY_TABLE                    
                    SET BANKCOST = COSTCODE                    
            WHERE                    
                   BANK_CODE = @@BANK_CODE                    
  AND (BANKCOST = ''   OR BANKCOST IS NULL)                    
       END                    
     END                    
    CREATE TABLE                    
     #BANK_VNO                    
     (                    
      SRNO INT,                    
      NEWSRNO INT IDENTITY (1, 1)                    
     )                    
    INSERT INTO                    
     #BANK_VNO                    
    SELECT                    
     DISTINCT SERIAL_NO                    
    FROM                    
     #RECPAY_TABLE                    
    WHERE                    
     BANK_CODE = @@BANK_CODE                    
     AND BOOKTYPE = @@BOOKTYPE                    
                    
   SELECT                    
     @@MAXCOUNT = COUNT(DISTINCT SNO)                    
    FROM                    
     #RECPAY_TABLE                    
                    
    SELECT TOP 1          
     @@VDT = VDT                    
    FROM                    
     #RECPAY_TABLE                    

    CREATE TABLE #VNO                    
	(
		LASTVNO VARCHAR(12)
	)
    
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                    
    INSERT                    
    INTO #VNO                    
     EXEC ACC_GENVNO_NEW                    
      @@VDT,                    
      @@VTYP,                    
      @@BOOKTYPE,                    
      @@STD_DATE,                    
      @@LST_DATE,                    
      @@MAXVNO                    
    SELECT                    
     @@NEWVNO = LASTVNO                    
    FROM                    
     #VNO                    
    UPDATE                    
     RP                    
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                    
    FROM                    
     #RECPAY_TABLE RP,                    
     #BANK_VNO BV                    
    WHERE                    
     RP.SERIAL_NO = BV.SRNO                    
   DROP TABLE #VNO                    
   DROP TABLE #BANK_VNO                    
  FETCH NEXT                    
   FROM @@VNOCUR                    
   INTO                    
    @@BANK_CODE,                    
    @@BOOKTYPE                    
 END                    
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */                    
UPDATE                    
 #RECPAY_TABLE                    
  SET LNO = 2                    
WHERE                    
 VNO IN                    
  (                    
   SELECT                    
    VNO                    
   FROM                    
 #RECPAY_TABLE                    
     WITH(NOLOCK)                    
   GROUP BY                    
    VNO                    
   HAVING                    
    COUNT(*) = 1                    
  )                    
SET @@LNOCUR = CURSOR FOR                    
 SELECT                    
  VNO                    
 FROM                    
  #RECPAY_TABLE                    
   WITH(NOLOCK)                    
 GROUP BY                    
  VNO                    
 HAVING                    
  COUNT(*) > 1                    
OPEN @@LNOCUR                    
FETCH NEXT                    
 FROM                    
  @@LNOCUR                    
 INTO                    
  @@LNOVNO                    
WHILE @@FETCH_STATUS = 0                    
 BEGIN                    
  CREATE TABLE                    
   [#LNOGEN]                    
    (                    
     VNO VARCHAR(12),                    
     SNO INT,                    
     LNO INT IDENTITY(1,1)                    
    )                    
  INSERT INTO                    
   #LNOGEN                    
    SELECT                    
     VNO,                    
     SNO                    
    FROM                    
     #RECPAY_TABLE                    
      WITH(NOLOCK)                    
    WHERE                    
     VNO = @@LNOVNO                    
    ORDER BY                    
     SNO                    
  UPDATE                    
   #RECPAY_TABLE                    
    SET LNO = L.LNO + 1                    
  FROM                    
   #LNOGEN L                    
  WHERE                    
   #RECPAY_TABLE.VNO = L.VNO                    
   AND #RECPAY_TABLE.SNO = L.SNO                    
   AND #RECPAY_TABLE.LNO = 0                    
  DROP TABLE #LNOGEN                    
  FETCH NEXT                    
   FROM                    
    @@LNOCUR                    
   INTO                    
    @@LNOVNO                    
 END                    
CLOSE @@LNOCUR                    
DEALLOCATE @@LNOCUR                    
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */                    
INSERT INTO                    
 LEDGER1                    
  (                    
   BNKNAME,                    
   BRNNAME,                    
   DD,                    
   DDNO,                    
   DDDT,                    
   RELDT,                    
   RELAMT,                    
   REFNO,                    
   RECEIPTNO,                    
   VTYP,                    
   VNO,                    
   LNO,                    
   DRCR,                    
   BOOKTYPE,                    
   MICRNO,                    
   SLIPNO,                    
   SLIPDATE,                    
   CHEQUEINNAME,                    
   CHQPRINTED,                    
   CLEAR_MODE                    
  )                    
SELECT                    
 BNKNAME = MAX(BANK_NAME),                    
 BRNNAME = MAX(BRANCH_NAME),                    
 DD = MAX(CHQ_MODE),                    
 DDNO = MAX(REF_NO),                    
 DDDT = MAX(DDDT),                    
 RELDT = '',                    
 RELAMT = ABS(SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)),                    
 REFNO = 0,                    
 RECEIPTNO = 0,                    
 VTYP,                    
 VNO,                    
 LNO = 2,                    
 @@DRCR,                  
 BOOKTYPE = BOOKTYPE,                    
 MICRNO = MICRNO,                    
 SLIPNO = 0,                    
 SLIPDATE = '',                    
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                    
 CHQPRINTED = 0,                    
 CLEAR_MODE = MAX(CL_MODE)                    
FROM                    
 #RECPAY_TABLE                    
GROUP BY                    
 VTYP,                    
 VNO,                    
 BOOKTYPE,                  
 MICRNO                  
                    
IF @@ERROR <> 0                    
 BEGIN                    
  SELECT                    
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  ROLLBACK TRAN                    
  DELETE FROM V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
  RETURN                    
 END                    
                    
/*================================                    
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK                    
=================================*/                    
CREATE TABLE #LEDGER                    
(                    
 VTYP SMALLINT,                    
 VNO VARCHAR(12),                    
 EDT DATETIME,                    
 LNO SMALLINT,                    
 ACNAME VARCHAR(100),                    
 DRCR VARCHAR(1),                    
 VAMT MONEY,                    
 VDT DATETIME,                    
 VNO1 VARCHAR(12),                    
 REFNO CHAR(12),                    
 BALAMT MONEY,                    
 NODAYS INT,                    
 CDT DATETIME,                    
 CLTCODE VARCHAR(10),                    
 BOOKTYPE VARCHAR(2),                    
 ENTEREDBY VARCHAR(25),                    
 PDT DATETIME,                    
 CHECKEDBY VARCHAR(25),                    
 ACTNODAYS INT,                    
 NARRATION VARCHAR(234)                    
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0                    
CREATE TABLE #LEDGER3                    
(                    
 NARATNO INT,                    
 NARR VARCHAR(234),                    
 REFNO CHAR(12),                    
 VTYP SMALLINT,                    
 VNO VARCHAR(12),                    
 BOOKTYPE VARCHAR(2)                    
)                    
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0                    
/*==============================                    
CLIENT SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER                    
 (                    
  VTYP,                    
  VNO,                  
  EDT,                    
  LNO,                    
  ACNAME,                    
  DRCR,                    
  VAMT,                    
  VDT,                    
  VNO1,                    
  REFNO,                    
  BALAMT,                    
  NODAYS,                    
  CDT,                    
  CLTCODE,                    
  BOOKTYPE,                    
  ENTEREDBY,                    
  PDT,               
  CHECKEDBY,                    
  ACTNODAYS,                    
  NARRATION                    
 )                    
SELECT                    
 VTYP,                    
 VNO,                    
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                    
 LNO,                    
 ACNAME,                    
 DRCR,                    
 VAMT = AMOUNT,                    
 VDT,                    
 VNO1 = VNO,                    
 REFNO = 0,                    
 BALAMT = AMOUNT,                    
 NODAYS = 0,                    
 CDT = GETDATE(),                    
 CLTCODE = CLIENT_CODE,                    
 BOOKTYPE = BOOKTYPE,                    
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                    
 PDT = GETDATE(),                    
 CHECKEDBY = @UNAME,                    
 ACTNODAYS = 0,                    
 NARRATION                  
FROM                    
 #RECPAY_TABLE                    
/*==============================                    
BANK SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER                    
SELECT  DISTINCT                  
 VTYP,                    
 VNO,                    
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                    
 LNO = 1,                    
 BANKNAME,                    
 MAX(DRCR1),                    
 VAMT = ABS(MAX(AMOUNT1)),                    
 VDT,                    
 VNO1 = VNO,                    
 REFNO = 0,                    
 BALAMT = ABS(MAX(AMOUNT1)),                    
 NODAYS = 0,                    
 CDT = GETDATE(),                    
 CLTCODE = BANK_CODE,                    
 BOOKTYPE = BOOKTYPE,                    
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                    
 PDT = GETDATE(),                    
 CHECKEDBY = @UNAME,                    
 ACTNODAYS = 0,                    
 NARRATION = NARRATION_FIN  
FROM    
 #RECPAY_TABLE R, (SELECT SERIAL_NO, AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), DRCR1 = CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'C' ELSE 'D' END, NARRATION_FIN = MAX(NARRATION) FROM #RECPAY_TABLE GROUP
 BY SERIAL_NO) R1        
WHERE R.SERIAL_NO = R1.SERIAL_NO                
GROUP BY                    
 VTYP,                    
 VNO,                    
 EDT,                    
 VDT,                    
 BANK_CODE,                    
 BOOKTYPE,                    
 BANKNAME,         
 LNO,  
 NARRATION_FIN                    
/*==============================                    
INSERTING ALL LEDGER RECORDS AT ONE TIME                    
==============================*/                    
              
INSERT INTO LEDGER  SELECT                    
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration                    
FROM                    
 #LEDGER                    
ORDER BY                    
 BOOKTYPE,                    
 VTYP,                    
 VNO,                    
 LNO                    
                    
IF @@ERROR <> 0                    
 BEGIN                    
  SELECT                    
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  DROP TABLE #LEDGER                    
  DROP TABLE #LEDGER3                    
  ROLLBACK TRAN                    
  DELETE FROM V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
  RETURN                    
 END                    
DROP TABLE #LEDGER                    
/*==============================                    
BANK SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER3                    
SELECT                    
 NARATNO = 1,                    
 NARRATION = MAX(NARRATION),                    
 REFNO = 0,               
 VTYP,                    
 VNO,                    
 BOOKTYPE                    
FROM                    
 #RECPAY_TABLE                    
GROUP BY                    
 VTYP,                    
 VNO,                    
 BOOKTYPE                    
/*==============================                    
CLIENT SIDE RECORD                    
==============================*/                    
INSERT INTO                    
 #LEDGER3                    
SELECT                    
 NARATNO = LNO,                    
 NARR = NARRATION,                    
 REFNO = 0,                    
 VTYP,                    
 VNO,                    
 BOOKTYPE                    
FROM                    
 #RECPAY_TABLE                    
                    
                    
/*==============================                    
INSERTING ALL LEDGER3 RECORDS AT ONE TIME                    
==============================*/                    
INSERT INTO LEDGER3                    
SELECT                    
 *                    
FROM                    
 #LEDGER3                    
ORDER BY                    
 BOOKTYPE,                    
 VTYP,                    
 VNO,                    
 NARATNO                    
                    
IF @@ERROR <> 0                    
 BEGIN                    
  SELECT                    
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                    
  DROP TABLE #RECPAY_TABLE_TMP                    
  DROP TABLE #RECPAY_TABLE                    
  DROP TABLE #LEDGER3                    
  ROLLBACK TRAN                    
  DELETE FROM V2_UPLOADED_FILES                    
  WHERE                    
   U_FILENAME = @FNAME                    
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                    
  RETURN                    
 END                    
DROP TABLE #LEDGER3                    
            
                    
IF @@BRANCHFLAG = 1                    
 BEGIN                    
  SET @@L2CUR = CURSOR FOR                    
   SELECT DISTINCT                    
    VNO                    
   FROM                    
    #RECPAY_TABLE                    
   ORDER BY                    
    VNO                    
  OPEN @@L2CUR                    
   FETCH NEXT                    
   FROM                    
    @@L2CUR                    
   INTO                    
    @@L2VNO                    
  WHILE @@FETCH_STATUS = 0                    
   BEGIN                    
    DELETE FROM                    
     TEMPLEDGER2                    
    WHERE                    
     SESSIONID = '9999999999'                    
/*==============================                    
CLIENT SIDE RECORD                    
==============================*/                    
    INSERT INTO                    
     TEMPLEDGER2                    
    SELECT                    
     'BRANCH',                    
     C.COSTNAME,                    
    AMOUNT,                    
     VTYP,                    
     VNO,                    
     LNO,                    
     DRCR,                    
     '0',                    
     BOOKTYPE,                    
     '9999999999',                    
     CLIENT_CODE,                    
     'A',                    
     '0'                    
    FROM                    
     #RECPAY_TABLE RP,                    
     COSTMAST C                    
    WHERE                    
     RP.COSTCODE = C.COSTCODE                    
     AND VNO = @@L2VNO                    
/*==============================                    
BANK SIDE RECORD                    
==============================*/                    
    INSERT INTO                    
     TEMPLEDGER2                    
    SELECT                    
     'BRANCH',                    
     C.COSTNAME,                    
     SUM(AMOUNT),                    
     VTYP,                    
     VNO,                    
     LNO = 1,                    
     DRCR =                    
      (                    
       CASE                    
       WHEN DRCR = 'D'                    
    THEN 'C'                    
       ELSE 'D'                    
       END                    
      ),                    
     '0',                    
     BOOKTYPE,                    
     '9999999999',                    
     BANK_CODE,                    
     'A',                    
     '0'                    
    FROM                    
     #RECPAY_TABLE RP,                    
     COSTMAST C                    
    WHERE                    
     RP.BANKCOST = C.COSTCODE                    
     AND VNO = @@L2VNO                    
    GROUP BY                    
     C.COSTNAME,                    
     VTYP,                
     VNO,                    
      (                    
       CASE                    
       WHEN DRCR = 'D'                    
       THEN 'C'                    
       ELSE 'D'                    
       END                    
      ),                    
     BANK_CODE,                    
     BOOKTYPE                    
    EXEC INSERTTOLEDGER2                    
     '9999999999',                    
     @@L2VNO,                    
     '1',                    
     '1',                    
     '1',                    
     'BROKER',                    
     'BROKER'                    
    FETCH NEXT                    
     FROM                    
      @@L2CUR                    
     INTO                    
      @@L2VNO                    
   END                    
  DELETE FROM                    
   TEMPLEDGER2                    
  WHERE                    
   SESSIONID = '9999999999'                    
                      
 END           
COMMIT TRAN                 
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL                    
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE                    
DROP TABLE #RECPAY_TABLE_TMP                    
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK_WACCNO
-- --------------------------------------------------

CREATE PROC [dbo].[RECPAYUPLOAD_BULK_WACCNO]
 @FNAME VARCHAR(100),                  
 @UNAME VARCHAR(25),                  
 @USERCAT SMALLINT      
                  
AS                  
/*                  
begin tran                  
SP_HELPTRIGGER LEDGER                  
LEDGER_TRG_BILL                  
LEDGER_TRG                  
Exec RECPAYUPLOAD_BULK_WACCNO 'E:\BackOffice\RecPayFiles\Recpay_TEST1121_WACCNO', 'JAYDEEP', 388                  
SELECT TOP 1 * FROM LEDGER3                  
SELECT TOP 1 * FROM LEDGER_TRG                  
ROLLBACK                  
*/                  
SET NOCOUNT ON                  
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                  
DECLARE                  
 @@STD_DATE VARCHAR(11),                  
 @@LST_DATE VARCHAR(11),                  
 @@BRANCHFLAG AS TINYINT,                  
 @@VNOFLAG AS TINYINT,                  
 @@VNOMETHOD INT,                  
 @@ACNAME CHAR(100),                  
 @@BOOKTYPE CHAR(2),                  
 @@MICRNO VARCHAR(10),                  
 @@DRCR VARCHAR(1),                  
 @@VTYP SMALLINT,                  
 @@BANK_CODE VARCHAR(100),                  
 @@BACKDAYS INT,                  
 @@BACKDATE VARCHAR(11),                  
 @@BRNCOUNT   TINYINT,                  
 @@MonthlyVdt VARCHAR(11),                  
 @@SERIAL_NO INT,                  
 @@COSTCODECOUNT TINYINT,                  
 @@COSTCODEUPDATES CURSOR,                  
 @@NEWVNO AS VARCHAR(12),                  
 @@MAXCOUNT AS INT,                  
 @@VDT AS VARCHAR(11),                  
 @@BANKBRANCH AS VARCHAR(10),                  
 @@BANKCOST AS NUMERIC,                  
 @@LNOCUR AS CURSOR,                  
 @@VNOCUR AS CURSOR,                  
 @@LNOVNO AS VARCHAR(12),                  
 @@MAXVNO AS INT,                  
 @@L2CUR AS CURSOR,                  
 @@L2VNO AS VARCHAR(12),                  
 @@ERROR_COUNT AS INT,                  
 @@FILEEXISTS AS INT,                  
 @@SQL AS VARCHAR(2000)                  
                  
/*SELECT                  
 @@ERROR_COUNT = COUNT(1)                  
FROM                  
 (                  
  SELECT                  
   U_FILENAME                  
  FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
 ) A                  
IF @@ERROR_COUNT > 0                  
 BEGIN                  
  SELECT                  
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                  
  RETURN                  
 END      */            
CREATE TABLE #FEXIST                  
(                  
 F1 SMALLINT,                  
 F2 SMALLINT,                  
 F3 SMALLINT                  
)                  
SELECT @@SQL = "INSERT INTO "                  
SELECT @@SQL = @@SQL + " #FEXIST "                  
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                  
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                  
                  
EXEC(@@SQL)                  
                  
SELECT                  
 @@FILEEXISTS = F1                  
FROM                  
 #FEXIST                  
                  
IF @@FILEEXISTS = 0                  
 BEGIN                  
  DROP TABLE #FEXIST                  
  SELECT                  
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                  
  RETURN                  
 END                  
DROP TABLE #FEXIST                  
                  
BEGIN TRAN                  
CREATE TABLE #RECPAY_TABLE_TMP                  
(                  
 SERIAL_NO INT,                  
 EDATE VARCHAR(20),                  
 VOUCHER_DATE VARCHAR(20),                  
 CLIENT_CODE VARCHAR(50),                  
 AMOUNT MONEY,                  
 DRCR VARCHAR(1),                  
 NARRATION VARCHAR(234),                  
 BANK_CODE VARCHAR(10),                  
 BANK_NAME VARCHAR(100),                  
 REF_NO VARCHAR(15),                  
 BRANCHCODE VARCHAR(20),                  
 BRANCH_NAME VARCHAR(50),                  
 CHQ_MODE VARCHAR(1),         
 CHQ_DATE VARCHAR(20),                  
 CHQ_NAME VARCHAR(100),                  
 CL_MODE VARCHAR(1),  
 ACC_NO VARCHAR(20)                   
)                  
CREATE TABLE [#RECPAY_TABLE]                  
 (                  
  SERIAL_NO INT,                  
  EDATE VARCHAR(20),                  
  VOUCHER_DATE VARCHAR(20),                  
  CLIENT_CODE VARCHAR(50),                  
  AMOUNT MONEY,                  
  DRCR VARCHAR(1),                  
  NARRATION VARCHAR(234),                  
  BANK_CODE VARCHAR(10),                  
  BANK_NAME VARCHAR(100),                  
  REF_NO VARCHAR(15),                  
  BRANCHCODE VARCHAR(20),                  
  BRANCH_NAME VARCHAR(50),                  
  CHQ_MODE VARCHAR(1),                  
  CHQ_DATE VARCHAR(20),                  
  CHQ_NAME VARCHAR(100),                  
  CL_MODE VARCHAR(1),
  ACC_NO VARCHAR(20),                  
  SNO INT IDENTITY (1, 1) NOT NULL ,                  
  VDT DATETIME NULL ,                  
  FYSTART DATETIME NULL ,                  
  FYEND DATETIME NULL ,                  
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                  
  EDT DATETIME NULL ,                  
  DDDT DATETIME NULL ,                  
  VNO VARCHAR (12) NULL ,              
VTYP SMALLINT NULL ,                  
  ACNAME VARCHAR (100) NULL ,                  
  COSTCODE SMALLINT NULL,                  
  BANKCOST SMALLINT NULL,                  
  LNO SMALLINT NOT NULL DEFAULT(0),                  
  BANKNAME VARCHAR(100) NULL,                  
  MICRNO INT NULL,                  
  BOOKTYPE VARCHAR(2) NULL,                  
 ) ON [PRIMARY]                  
                  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                  
EXEC (@@SQL)                  
                  
IF @@ERROR <> 0                  
 BEGIN                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRANSACTION                  
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                  
  RETURN                  
 END                  
INSERT INTO                  
 V2_UPLOADED_FILES                  
SELECT                  
 @FNAME,                  
 @FNAME,                  
 CNT = COUNT(1),                  
 'B',                  
 GETDATE(),                  
 @UNAME,                  
 'RECEIPT/PAYMENT UPLOAD'                  
                  
INSERT INTO                  
 #RECPAY_TABLE                  
 (                  
  SERIAL_NO,                  
  EDATE,                  
  VOUCHER_DATE,                  
  CLIENT_CODE,                  
  AMOUNT,                  
  DRCR,                  
  NARRATION,                  
  BANK_CODE,                  
  BANK_NAME,                  
  REF_NO,                  
  BRANCHCODE,                  
  BRANCH_NAME,                  
  CHQ_MODE,                  
  CHQ_DATE,                  
  CHQ_NAME,                  
  CL_MODE,
  ACC_NO
 )                  
SELECT                  
 SERIAL_NO,                  
 EDATE,                  
 VOUCHER_DATE,                  
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                  
 AMOUNT,                  
 UPPER(LTRIM(RTRIM(DRCR))),                  
 NARRATION,                  
 UPPER(LTRIM(RTRIM(BANK_CODE))),                  
 UPPER(LTRIM(RTRIM(BANK_NAME))),                  
 REF_NO,                  
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                  
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                  
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                  
 CHQ_DATE,                  
 CHQ_NAME,                  
 CL_MODE,
 ACC_NO
FROM                  
 #RECPAY_TABLE_TMP                  
                  
UPDATE                  
 #RECPAY_TABLE                  
SET            
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                  
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                  
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                  
            
            
SELECT TOP 1                  
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                  
FROM                  
 #RECPAY_TABLE                  
            
            
SELECT                  
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                  
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                  
 @@BRANCHFLAG = BRANCHFLAG,                  
 @@VNOFLAG = VNOFLAG                  
FROM                  
 PARAMETER                  
WHERE                  
 @@VDT BETWEEN SDTCUR AND LDTCUR               
                  
IF @@VNOFLAG <> 0             
BEGIN                 
 SELECT                  
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                  
 FROM                  
  #RECPAY_TABLE                  
                   
 IF @@ERROR_COUNT > 1                  
  BEGIN                  
   DROP TABLE #RECPAY_TABLE_TMP                  
   DROP TABLE #RECPAY_TABLE                  
   ROLLBACK TRANSACTION                  
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                  
   RETURN                  
  END                
END              
                  
                  
IF @@BRANCHFLAG = 1              
 BEGIN                  
  UPDATE                  
   #RECPAY_TABLE                  
  SET                  
   BRANCHCODE = A.BRANCHCODE,                  
   FYSTART = P.SDTCUR,                  
   FYEND = P.LDTCUR,                  
   UPDFLAG = 'Y',                  
   ACNAME = A.LONGNAME,                  
   COSTCODE = C.COSTCODE,                  
   BANKNAME = B.LONGNAME,                  
   BOOKTYPE = B.BOOKTYPE,                  
   MICRNO = ISNULL(B.MICRNO, 0)                  
  FROM                  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                  
  WHERE                  
   A.CLTCODE = CLIENT_CODE                  
AND B.CLTCODE = BANK_CODE                  
   AND P.CURYEAR = 1                  
   AND A.ACCAT IN ('3','4','18')                  
   AND B.ACCAT = '2'                  
   AND A.BRANCHCODE = COSTNAME                  
                    
  UPDATE                  
   #RECPAY_TABLE                  
  SET                  
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                  
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                  
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                  
   FYSTART = P.SDTCUR,                  
   FYEND = P.LDTCUR,                  
   UPDFLAG = 'Y',                  
   ACNAME = A.LONGNAME,                  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                  
   BANKNAME = B.LONGNAME,                  
   BOOKTYPE = B.BOOKTYPE,                  
   MICRNO = ISNULL(B.MICRNO, 0)                  
  FROM                  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                  
  WHERE                  
   A.CLTCODE = CLIENT_CODE                  
   AND B.CLTCODE = BANK_CODE                  
   AND P.CURYEAR = 1                  
   AND A.ACCAT IN ('3','4','18')                  
   AND B.ACCAT = '2'                  
   AND A.BRANCHCODE = 'ALL'                  
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                  
                  
  UPDATE                  
   #RECPAY_TABLE                  
  SET                  
   BRANCHCODE = 'HO',                  
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                  
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                  
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                  
   FYSTART = P.SDTCUR,                  
   FYEND = P.LDTCUR,                  
   UPDFLAG = 'Y',                  
   ACNAME = A.LONGNAME,                  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                  
   BANKNAME = B.LONGNAME,                  
   BOOKTYPE = B.BOOKTYPE,                  
   MICRNO = ISNULL(B.MICRNO, 0)                  
  FROM                  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                  
  WHERE                  
   A.CLTCODE = CLIENT_CODE                  
   AND B.CLTCODE = BANK_CODE                  
   AND P.CURYEAR = 1                  
   AND A.ACCAT IN ('3','4','18')                  
   AND B.ACCAT = '2'                  
   AND A.BRANCHCODE = 'ALL'                  
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                  
 END                  
ELSE                  
 BEGIN                  
  UPDATE                  
   #RECPAY_TABLE                  
  SET                  
   FYSTART = @@STD_DATE,                  
   FYEND = @@LST_DATE + ' 23:59:59',                  
   UPDFLAG = 'Y',                  
   ACNAME = A.LONGNAME,         
   BANKNAME = B.LONGNAME,                  
   BOOKTYPE = B.BOOKTYPE,                  
   MICRNO = ISNULL(B.MICRNO, 0)                  
  FROM                  
   ACMAST A, ACMAST B                  
  WHERE                  
   A.CLTCODE = CLIENT_CODE                  
   AND B.CLTCODE = BANK_CODE                  
   AND A.ACCAT IN ('3','4','18')                  
   AND B.ACCAT = '2'                  
 END                  
            
            
            
                 
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                  
                  
SELECT            
 SERIAL_NO, VOUCHER_DATE            
INTO #DUP_VDTS            
FROM            
 #RECPAY_TABLE            
GROUP BY SERIAL_NO, VOUCHER_DATE            
            
SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS            
GROUP BY SERIAL_NO            
HAVING COUNT(1) > 1            
            
 IF @@ERROR_COUNT > 1                  
  BEGIN                  
   SELECT                  
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO', 'NA', 'NA'                  
   DROP TABLE #RECPAY_TABLE_TMP                  
   DROP TABLE #RECPAY_TABLE                  
   ROLLBACK TRAN                  
   DELETE                  
   FROM                  
    V2_UPLOADED_FILES                  
   WHERE                  
    U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
   RETURN                  
  END                  
            
            
SELECT             
 @@ERROR_COUNT = COUNT(SERIAL_NO)             
FROM             
 #RECPAY_TABLE            
WHERE VDT NOT BETWEEN FYSTART AND FYEND            
        
 IF @@ERROR_COUNT > 0            
  BEGIN                  
   SELECT           
    'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.', 'NA', 'NA'                  
   DROP TABLE #RECPAY_TABLE_TMP                  
   DROP TABLE #RECPAY_TABLE                  
   ROLLBACK TRAN                  
   DELETE                  
   FROM                  
    V2_UPLOADED_FILES                  
   WHERE                  
    U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
   RETURN                  
  END                  
            
SET @@ERROR_COUNT = 0            
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/                  
/*                  
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)                  
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1                  
 IF @@ERROR_COUNT > 0                  
  BEGIN                  
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'                  
   DROP TABLE #RecPay_Table_Tmp                  
   DROP TABLE #RecPay_Table                  
   ROLLBACK TRAN                  
   DELETE FROM V2_Uploaded_Files                  
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
   RETURN                  
  END*/                  
                  
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                  
 SELECT                  
  @@ERROR_COUNT = COUNT(1)                  
 FROM                  
  (                  
   SELECT                  
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),        
    SERIAL_NO                  
   FROM                  
    #RECPAY_TABLE                  
   GROUP BY                  
    SERIAL_NO                  
   HAVING                  
    COUNT(DISTINCT BANK_CODE) > 1                  
  ) A                  
 IF @@ERROR_COUNT > 0                  
  BEGIN                  
   SELECT                  
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                  
   UNION ALL                  
   SELECT                  
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                  
   FROM                  
    #RECPAY_TABLE                  
   GROUP BY                  
    SERIAL_NO                  
   HAVING                  
    COUNT(DISTINCT BANK_CODE) > 1                  
                  
   DROP TABLE #RECPAY_TABLE_TMP                  
   DROP TABLE #RECPAY_TABLE                  
   ROLLBACK TRAN                  
   DELETE                  
   FROM                  
    V2_UPLOADED_FILES                  
   WHERE                  
    U_FILENAME = @FNAME                  
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
   RETURN                  
  END                  
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                  
SELECT                  
 @@ERROR_COUNT = COUNT(1)                  
FROM                  
 (                  
 SELECT                  
   DISTINCT DRCR = (CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'D' ELSE 'C' END)      
 FROM                  
  #RECPAY_TABLE  
 GROUP BY SERIAL_NO  
 ) A              
          
IF @@ERROR_COUNT > 1                  
 BEGIN                  
  SELECT                  
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRAN                  
  DELETE                  
  FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END                  
ELSE                  
 BEGIN                  
  SELECT TOP 1                  
   @@DRCR = DRCR,                  
   @@VTYP =                  
    (                  
    CASE                  
     WHEN DRCR = 'D'                  
     THEN 3                  
     ELSE 2                  
    END                  
    )                  
  FROM                  
   #RECPAY_TABLE       
      
  UPDATE R       
  SET VTYP =       
 CASE WHEN AMOUNT1 > 0 THEN 3 ELSE 2 END      
 FROM (SELECT AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), SERIAL_NO FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1, #RECPAY_TABLE R      
 WHERE R.SERIAL_NO = R1.SERIAL_NO      
              
  /*UPDATE                  
   #RECPAY_TABLE                  
  SET VTYP =   
   (                  
   CASE                  
     WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) > 0                
     THEN 3                  
     ELSE 2                  
    END                  
   )       */           
 END            
      
            
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                  
 SELECT @@ERROR_COUNT = COUNT(1)                  
 FROM #RECPAY_TABLE                  
 WHERE VDT > EDT                  
            IF @@ERROR_COUNT > 0                  
             BEGIN                  
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                  
     DROP TABLE #RECPAY_TABLE_TMP                  
     DROP TABLE #RECPAY_TABLE                  
     ROLLBACK TRAN                  
     DELETE FROM                  
      V2_UPLOADED_FILES                  
     WHERE                  
      U_FILENAME = @FNAME                  
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
     RETURN                  
      END                  
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                  
 SELECT @@ERROR_COUNT = COUNT(1)                  
 FROM #RECPAY_TABLE                  
 WHERE AMOUNT <= 0                  
 IF @@ERROR_COUNT > 0                  
  BEGIN                  
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                  
     DROP TABLE #RECPAY_TABLE_TMP                  
     DROP TABLE #RECPAY_TABLE                  
     ROLLBACK TRAN                  
     DELETE FROM                  
      V2_UPLOADED_FILES                  
     WHERE                  
      U_FILENAME = @FNAME                  
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
     RETURN                  
  END        
           
SELECT      
@@ERROR_COUNT = COUNT(1)      
FROM      
(      
 SELECT DISTINCT      
  DDNO  = RP.REF_NO      
 FROM      
  #RECPAY_TABLE RP,      
  LEDGER1 L1  WITH(NOLOCK)      
 WHERE      
  L1.DDNO = RP.REF_NO      
  AND L1.BNKNAME = RP.BANK_NAME      
  AND L1.DD = RP.CHQ_MODE      
  AND L1.DRCR = @@DRCR      
  AND L1.VTYP = @@VTYP      
  AND RP.REF_NO <> '0'      
  AND ISNUMERIC(RP.REF_NO) = 1      
) A      
         
              
IF @@ERROR_COUNT > 0                  
 BEGIN                  
  SELECT                  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                  
  UNION ALL                  
  SELECT DISTINCT                  
   RP.REF_NO, 'NA','NA'                  
  FROM                  
   #RECPAY_TABLE RP, LEDGER L,         
   LEDGER1 L1                  
    WITH(NOLOCK)                  
  WHERE                  
   L1.DDNO = RP.REF_NO                  
   AND L1.DD = RP.CHQ_MODE                  
   AND L1.DRCR = @@DRCR                  
   AND L1.VTYP = @@VTYP                  
   AND RP.CHQ_MODE <> 'N'         
   AND L.VTYP=@@VTYP        
   AND L.VNO=L1.VNO        
   AND L.BOOKTYPE=L1.BOOKTYPE        
   AND L.DRCR=@@DRCR         
   AND L.CLTCODE=RP.CLIENT_CODE        
            
             
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRAN                  
  DELETE FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END                  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                  
SELECT                  
 @@ERROR_COUNT = COUNT(1)                  
FROM                  
 (                  
  SELECT DISTINCT                  
   CLIENT_CODE                  
  FROM                  
   #RECPAY_TABLE                  
  WHERE                  
   UPDFLAG = 'N'                  
 ) A                  
IF @@ERROR_COUNT > 0                  
 BEGIN                  
  SELECT                  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                  
  UNION ALL                  
  SELECT DISTINCT                  
   CLIENT_CODE, 'NA','NA'                  
  FROM                  
   #RECPAY_TABLE                  
  WHERE                  
   UPDFLAG = 'N'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRAN                  
  DELETE FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END                  
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */                  
  SET @@VNOCUR = CURSOR FOR                  
   SELECT DISTINCT                  
    BANK_CODE,                  
    BOOKTYPE                  
   FROM                  
    #RECPAY_TABLE WITH(NOLOCK)                  
  OPEN @@VNOCUR                  
  FETCH NEXT                  
   FROM                  
    @@VNOCUR                  
   INTO                  
    @@BANK_CODE,                  
    @@BOOKTYPE                  
  WHILE @@FETCH_STATUS = 0                  
   BEGIN                  
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------            
    SELECT                  
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)                  
    FROM                  
     USERWRITESTABLE                  
    WHERE                  
     USERCATEGORY = @USERCAT                  
     AND VTYP = @@VTYP                  
     AND BOOKTYPE = @@BOOKTYPE                  
    SELECT                  
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                  
    SELECT                  
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                  
    FROM                  
     #RECPAY_TABLE                  
    WHERE                  
     VDT < @@BACKDATE                  
    IF @@ERROR_COUNT > 0                  
     BEGIN                  
      SELECT                  
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                  
      DROP TABLE #RECPAY_TABLE_TMP                  
      DROP TABLE #RECPAY_TABLE                  
      ROLLBACK TRAN                  
      DELETE FROM V2_UPLOADED_FILES                  
      WHERE                  
       U_FILENAME = @FNAME                  
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
      RETURN                  
     END            
            
    IF @@BRANCHFLAG = 1                  
     BEGIN                  
      SELECT                  
       @@BANKBRANCH = BRANCHCODE,                  
       @@BANKCOST = ISNULL(C.COSTCODE, -1)                  
      FROM                  
       ACMAST A                  
        LEFT OUTER JOIN                  
        COSTMAST C                  
        ON                  
         (                  
          A.BRANCHCODE = C.COSTNAME                  
         )                  
      WHERE                  
    A.CLTCODE = @@BANK_CODE                  
      IF @@BANKBRANCH <> 'ALL'                  
       BEGIN                
        UPDATE                  
         RP                  
          SET COSTCODE = @@BANKCOST                  
        FROM                  
         #RECPAY_TABLE RP,                  
         ACMAST A                  
        WHERE                  
         A.CLTCODE = RP.CLIENT_CODE                  
         AND A.BRANCHCODE = 'ALL'                  
        UPDATE                  
         #RECPAY_TABLE                  
          SET BANKCOST = @@BANKCOST                  
        WHERE                  
         BANK_CODE = @@BANK_CODE                  
       END                  
      ELSE                  
       BEGIN                  
        UPDATE                  
         #RECPAY_TABLE                  
          SET COSTCODE =                  
           (                  
            SELECT TOP 1                  
             COSTCODE                  
            FROM                  
             COSTMAST                  
            WHERE                  
             COSTNAME = 'HO'                  
           )                  
        WHERE                  
         COSTCODE = ''                  
         AND BANK_CODE = @@BANK_CODE                  
                            SET @@COSTCODEUPDATES = CURSOR FOR                  
                                       SELECT                  
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)                  
                                       FROM                  
                                             #RECPAY_TABLE WITH(NOLOCK)                  
                                       WHERE                  
          BANK_CODE = @@BANK_CODE                  
                                       GROUP BY                  
                                             SERIAL_NO                  
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1                  
                            OPEN @@COSTCODEUPDATES                  
                            FETCH NEXT                  
 FROM                  
                              @@COSTCODEUPDATES                  
                             INTO                  
              @@SERIAL_NO,                  
                              @@COSTCODECOUNT                  
   WHILE @@FETCH_STATUS = 0                  
                             BEGIN                  
          UPDATE                  
           #RECPAY_TABLE                  
            SET BANKCOST =                  
             (                  
              SELECT TOP 1                  
               COSTCODE                  
              FROM                  
               COSTMAST                  
              WHERE                  
               COSTNAME = 'HO'                  
             )                  
          WHERE                  
           (BANKCOST = ''   OR BANKCOST IS NULL)                  
           AND BANK_CODE = @@BANK_CODE                  
                                           AND SERIAL_NO = @@SERIAL_NO                  
                              FETCH NEXT                  
                               FROM                  
                                @@COSTCODEUPDATES                  
                               INTO                  
                                @@SERIAL_NO,                  
                                @@COSTCODECOUNT                  
                             END                  
                            CLOSE @@COSTCODEUPDATES                  
                            DEALLOCATE @@COSTCODEUPDATES                  
                  UPDATE                  
                   #RECPAY_TABLE                  
                    SET BANKCOST = COSTCODE                  
            WHERE                  
                   BANK_CODE = @@BANK_CODE                  
  AND (BANKCOST = ''   OR BANKCOST IS NULL)                  
       END                  
     END                  
    CREATE TABLE                  
     #BANK_VNO                  
     (                  
      SRNO INT,                  
      NEWSRNO INT IDENTITY (1, 1)                  
     )                  
    INSERT INTO                  
     #BANK_VNO                  
    SELECT                  
     DISTINCT SERIAL_NO                  
    FROM                  
     #RECPAY_TABLE                  
    WHERE                  
     BANK_CODE = @@BANK_CODE                  
     AND BOOKTYPE = @@BOOKTYPE                  
                  
   SELECT                  
     @@MAXCOUNT = COUNT(DISTINCT SNO)                  
    FROM                  
     #RECPAY_TABLE                  
                  
    SELECT TOP 1        
     @@VDT = VDT                  
    FROM                  
     #RECPAY_TABLE                  
    SELECT                  
     LASTVNO                  
    INTO #VNO                  
    FROM                  
     LASTVNO                  
    WHERE                  
     1 = 2                  
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                  
    INSERT                  
    INTO #VNO                  
     EXEC ACC_GENVNO_NEW                  
      @@VDT,                  
      @@VTYP,                  
      @@BOOKTYPE,                  
      @@STD_DATE,                  
      @@LST_DATE,                  
      @@MAXVNO                  
    SELECT                  
     @@NEWVNO = LASTVNO                  
    FROM                  
     #VNO                  
    UPDATE                  
     RP                  
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                  
    FROM                  
     #RECPAY_TABLE RP,                  
     #BANK_VNO BV                  
    WHERE                  
     RP.SERIAL_NO = BV.SRNO                  
   DROP TABLE #VNO                  
   DROP TABLE #BANK_VNO                  
  FETCH NEXT                  
   FROM @@VNOCUR                  
   INTO                  
    @@BANK_CODE,                  
    @@BOOKTYPE                  
 END                  
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */                  
UPDATE                  
 #RECPAY_TABLE                  
  SET LNO = 2                  
WHERE                  
 VNO IN                  
  (                  
   SELECT                  
    VNO                  
   FROM                  
 #RECPAY_TABLE                  
     WITH(NOLOCK)                  
   GROUP BY                  
    VNO                  
   HAVING                  
    COUNT(*) = 1                  
  )                  
SET @@LNOCUR = CURSOR FOR                  
 SELECT                  
  VNO                  
 FROM                  
  #RECPAY_TABLE                  
   WITH(NOLOCK)                  
 GROUP BY                  
  VNO                  
 HAVING                  
  COUNT(*) > 1                  
OPEN @@LNOCUR                  
FETCH NEXT                  
 FROM                  
  @@LNOCUR                  
 INTO                  
  @@LNOVNO                  
WHILE @@FETCH_STATUS = 0                  
 BEGIN                  
  CREATE TABLE                  
   [#LNOGEN]                  
    (                  
     VNO VARCHAR(12),                  
     SNO INT,                  
     LNO INT IDENTITY(1,1)                  
    )                  
  INSERT INTO                  
   #LNOGEN                  
    SELECT                  
     VNO,                  
     SNO                  
    FROM                  
     #RECPAY_TABLE                  
      WITH(NOLOCK)                  
    WHERE                  
     VNO = @@LNOVNO                  
    ORDER BY                  
     SNO                  
  UPDATE                  
   #RECPAY_TABLE                  
    SET LNO = L.LNO + 1                  
  FROM                  
   #LNOGEN L                  
  WHERE                  
   #RECPAY_TABLE.VNO = L.VNO                  
   AND #RECPAY_TABLE.SNO = L.SNO                  
   AND #RECPAY_TABLE.LNO = 0                  
  DROP TABLE #LNOGEN                  
  FETCH NEXT                  
   FROM                  
    @@LNOCUR                  
   INTO                  
    @@LNOVNO                  
 END                  
CLOSE @@LNOCUR                  
DEALLOCATE @@LNOCUR                  
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */                  
INSERT INTO                  
 LEDGER1                  
  (                  
   BNKNAME,                  
   BRNNAME,                  
   DD,                  
   DDNO,                  
   DDDT,                  
   RELDT,                  
   RELAMT,                  
   REFNO,                  
   RECEIPTNO,                  
   VTYP,                  
   VNO,                  
   LNO,                  
   DRCR,                  
   BOOKTYPE,                  
   MICRNO,                  
   SLIPNO,                  
   SLIPDATE,                  
   CHEQUEINNAME,                  
   CHQPRINTED,                  
   CLEAR_MODE                  
  )                  
SELECT                  
 BNKNAME = MAX(BANK_NAME),                  
 BRNNAME = MAX(BRANCH_NAME),                  
 DD = MAX(CHQ_MODE),                  
 DDNO = MAX(REF_NO),                  
 DDDT = MAX(DDDT),                  
 RELDT = '',                  
 RELAMT = ABS(SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)),                  
 REFNO = 0,                  
 RECEIPTNO = 0,                  
 VTYP,                  
 VNO,                  
 LNO = 2,                  
 @@DRCR,                
 BOOKTYPE = BOOKTYPE,                  
 MICRNO = MICRNO,                  
 SLIPNO = 0,                  
 SLIPDATE = '',                  
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                  
 CHQPRINTED = 0,                  
 CLEAR_MODE = MAX(CL_MODE)                  
FROM                  
 #RECPAY_TABLE                  
GROUP BY                  
 VTYP,                  
 VNO,                  
 BOOKTYPE,                
 MICRNO                
                  
IF @@ERROR <> 0                  
 BEGIN                  
  SELECT                  
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRAN                  
  DELETE FROM V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END                  
                  
/*================================                  
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK                  
=================================*/                  
CREATE TABLE #LEDGER                  
(                  
 VTYP SMALLINT,                  
 VNO VARCHAR(12),                  
 EDT DATETIME,                  
 LNO SMALLINT,                  
 ACNAME VARCHAR(100),                  
 DRCR VARCHAR(1),                  
 VAMT MONEY,                  
 VDT DATETIME,                  
 VNO1 VARCHAR(12),                  
 REFNO CHAR(12),                  
 BALAMT MONEY,                  
 NODAYS INT,                  
 CDT DATETIME,                  
 CLTCODE VARCHAR(10),                  
 BOOKTYPE VARCHAR(2),                  
 ENTEREDBY VARCHAR(25),                  
 PDT DATETIME,                  
 CHECKEDBY VARCHAR(25),                  
 ACTNODAYS INT,                  
 NARRATION VARCHAR(234)                  
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0                  
CREATE TABLE #LEDGER3                  
(                  
 NARATNO INT,                  
 NARR VARCHAR(234),                  
 REFNO CHAR(12),                  
 VTYP SMALLINT,                  
 VNO VARCHAR(12),                  
 BOOKTYPE VARCHAR(2)                  
)                  
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0                  
/*==============================                  
CLIENT SIDE RECORD                  
==============================*/                  
INSERT INTO                  
 #LEDGER                  
 (                  
  VTYP,                  
  VNO,                
  EDT,                  
  LNO,                  
  ACNAME,                  
  DRCR,                  
  VAMT,                  
  VDT,                  
  VNO1,                  
  REFNO,                  
  BALAMT,                  
  NODAYS,                  
  CDT,                  
  CLTCODE,                  
  BOOKTYPE,                  
  ENTEREDBY,                  
  PDT,             
  CHECKEDBY,                  
  ACTNODAYS,                  
  NARRATION                  
 )                  
SELECT                  
 VTYP,                  
 VNO,                  
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                  
 LNO,                  
 ACNAME,                  
 DRCR,                  
 VAMT = AMOUNT,                  
 VDT,                  
 VNO1 = VNO,                  
 REFNO = 0,                  
 BALAMT = AMOUNT,                  
 NODAYS = 0,                  
 CDT = GETDATE(),                  
 CLTCODE = CLIENT_CODE,                  
 BOOKTYPE = BOOKTYPE,                  
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                  
 PDT = GETDATE(),                  
 CHECKEDBY = @UNAME,                  
 ACTNODAYS = 0,                  
 NARRATION                
FROM                  
 #RECPAY_TABLE                  
/*==============================                  
BANK SIDE RECORD                  
==============================*/                  
INSERT INTO                  
 #LEDGER                  
SELECT  DISTINCT                
 VTYP,                  
 VNO,                  
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),                  
 LNO = 1,                  
 BANKNAME,                  
 MAX(DRCR1),                  
 VAMT = ABS(MAX(AMOUNT1)),                  
 VDT,                  
 VNO1 = VNO,                  
 REFNO = 0,                  
 BALAMT = ABS(MAX(AMOUNT1)),                  
 NODAYS = 0,                  
 CDT = GETDATE(),                  
 CLTCODE = BANK_CODE,                  
 BOOKTYPE = BOOKTYPE,                  
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),                  
 PDT = GETDATE(),                  
 CHECKEDBY = @UNAME,                  
 ACTNODAYS = 0,                  
 NARRATION = NARRATION_FIN
FROM                  
 #RECPAY_TABLE R, (SELECT SERIAL_NO, AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), DRCR1 = CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'C' ELSE 'D' END, NARRATION_FIN = MAX(NARRATION) FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1      
WHERE R.SERIAL_NO = R1.SERIAL_NO              
GROUP BY                  
 VTYP,                  
 VNO,                  
 EDT,                  
 VDT,                  
 BANK_CODE,                  
 BOOKTYPE,                  
 BANKNAME,       
 LNO,
 NARRATION_FIN                  
/*==============================                  
INSERTING ALL LEDGER RECORDS AT ONE TIME                  
==============================*/                  
            
INSERT INTO LEDGER  SELECT                  
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration                  
FROM                  
 #LEDGER                  
ORDER BY                  
 BOOKTYPE,                  
 VTYP,                  
 VNO,                  
 LNO                  
                  
IF @@ERROR <> 0                  
 BEGIN                  
  SELECT                  
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  DROP TABLE #LEDGER                  
  DROP TABLE #LEDGER3                  
  ROLLBACK TRAN                  
  DELETE FROM V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END                  
DROP TABLE #LEDGER                  
/*==============================                  
BANK SIDE RECORD                  
==============================*/                  
INSERT INTO                  
 #LEDGER3                  
SELECT                  
 NARATNO = 1,                  
 NARRATION = MAX(NARRATION),                  
 REFNO = 0,             
 VTYP,                  
 VNO,                  
 BOOKTYPE                  
FROM                  
 #RECPAY_TABLE                  
GROUP BY                  
 VTYP,                  
 VNO,                  
 BOOKTYPE                  
/*==============================                  
CLIENT SIDE RECORD                  
==============================*/                  
INSERT INTO                  
 #LEDGER3                  
SELECT                  
 NARATNO = LNO,                  
 NARR = NARRATION,                  
 REFNO = 0,                  
 VTYP,                  
 VNO,                  
 BOOKTYPE                  
FROM                  
 #RECPAY_TABLE                  
                  
                  
/*==============================                  
INSERTING ALL LEDGER3 RECORDS AT ONE TIME                  
==============================*/                  
INSERT INTO LEDGER3                  
SELECT                  
 *                  
FROM                  
 #LEDGER3                  
ORDER BY                  
 BOOKTYPE,                  
 VTYP,                  
 VNO,                  
 NARATNO                  
                  
IF @@ERROR <> 0                  
 BEGIN                  
  SELECT                  
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  DROP TABLE #LEDGER3                  
  ROLLBACK TRAN                  
  DELETE FROM V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END                  
DROP TABLE #LEDGER3                  
                  
                  
IF @@BRANCHFLAG = 1                  
 BEGIN                  
  SET @@L2CUR = CURSOR FOR                  
   SELECT DISTINCT                  
    VNO                  
   FROM                  
    #RECPAY_TABLE                  
   ORDER BY                  
    VNO                  
  OPEN @@L2CUR                  
   FETCH NEXT                  
   FROM                  
    @@L2CUR                  
   INTO                  
    @@L2VNO                  
  WHILE @@FETCH_STATUS = 0                  
   BEGIN                  
    DELETE FROM                  
     TEMPLEDGER2                  
    WHERE                  
     SESSIONID = '9999999999'                  
/*==============================                  
CLIENT SIDE RECORD                  
==============================*/                  
    INSERT INTO                  
     TEMPLEDGER2                  
    SELECT                  
     'BRANCH',                  
     C.COSTNAME,                  
    AMOUNT,                  
     VTYP,                  
     VNO,                  
     LNO,                  
     DRCR,                  
     '0',                  
     BOOKTYPE,                  
     '9999999999',                  
     CLIENT_CODE,                  
     'A',                  
     '0'                  
    FROM                  
     #RECPAY_TABLE RP,                  
     COSTMAST C                  
    WHERE                  
     RP.COSTCODE = C.COSTCODE                  
     AND VNO = @@L2VNO                  
/*==============================                  
BANK SIDE RECORD                  
==============================*/                  
    INSERT INTO                  
     TEMPLEDGER2                  
    SELECT                  
     'BRANCH',                  
     C.COSTNAME,                  
     SUM(AMOUNT),                  
     VTYP,                  
     VNO,                  
     LNO = 1,                  
     DRCR =                  
      (                  
       CASE                  
       WHEN DRCR = 'D'                  
    THEN 'C'                  
       ELSE 'D'                  
       END                  
      ),                  
     '0',                  
     BOOKTYPE,                  
     '9999999999',                  
     BANK_CODE,                  
     'A',                  
     '0'                  
    FROM                  
     #RECPAY_TABLE RP,                  
     COSTMAST C                  
    WHERE                  
     RP.BANKCOST = C.COSTCODE                  
     AND VNO = @@L2VNO                  
    GROUP BY                  
     C.COSTNAME,                  
     VTYP,              
     VNO,                  
      (                  
       CASE                  
       WHEN DRCR = 'D'                  
       THEN 'C'                  
       ELSE 'D'                  
       END                  
      ),                  
     BANK_CODE,                  
     BOOKTYPE                  
    EXEC INSERTTOLEDGER2                  
     '9999999999',                  
     @@L2VNO,                  
     '1',                  
     '1',                  
     '1',                  
     'BROKER',                  
     'BROKER'                  
    FETCH NEXT                  
     FROM                  
      @@L2CUR                  
     INTO                  
      @@L2VNO                  
   END                  
  DELETE FROM                  
   TEMPLEDGER2                  
  WHERE                  
   SESSIONID = '9999999999'                  
                    
 END  

IF @@VTYP = 2          
BEGIN          
 INSERT INTO THIRDPARTY_COLLECTION          
  (VNO, VTYP, BOOKTYPE, CLTCODE, AMOUNT, VDT, DDNO, ACCOUNT_NO, TPR_FLAG)          
 SELECT          
  VNO,          
  VTYP,          
  BOOKTYPE,          
  CLIENT_CODE,          
  AMOUNT,          
  VDT,       MAX(REF_NO),          
  ACC_NO,          
  TPR_FLAG = 'S'          
 FROM          
  #RECPAY_TABLE          
 GROUP BY          
  VNO,          
  VTYP,          
  BOOKTYPE,          
  CLIENT_CODE,          
  AMOUNT,          
  VDT,          
  ACC_NO          
         
 UPDATE T          
 SET TPR_FLAG = 'C'          
 FROM THIRDPARTY_COLLECTION T, MULTIBANKID M, #RecPay_Table R          
 WHERE          
  T.CLTCODE = M.CLTCODE          
  AND CONVERT(NUMERIC(16), M.ACCNO) = CONVERT(NUMERIC(16), T.ACCOUNT_NO)
  AND T.VNO = R.VNO AND T.VTYP = R.VTYP AND T.BOOKTYPE = R.BOOKTYPE          
END  
       
COMMIT TRAN               
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL                  
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE                  
DROP TABLE #RECPAY_TABLE_TMP                  
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.REMISSSOR_BILLPOSTING
-- --------------------------------------------------
CREATE PROC REMISSSOR_BILLPOSTING  
  
 @VTYPE SMALLINT,  
 @BOOKTYPE VARCHAR(2),  
 @VDT VARCHAR(11),  
 @EDTDR VARCHAR(11),  
 @EDTCR VARCHAR(11),  
 @CDT VARCHAR(11),      
 @PDT VARCHAR(11),      
 @ENTEREDBY VARCHAR(25),      
 @CHECKEDBY VARCHAR(25),      
 @SETT_NO VARCHAR(7),      
 @SETT_TYPE VARCHAR(3),      
 @UNAME VARCHAR(25),  
 @ACC_SERVER1 VARCHAR(15),  
 @ACC_DB1 VARCHAR(15),  
 @VNO1 VARCHAR(12),  
 @EXCHANGE1 VARCHAR(10),  
 @SEGMENT1 VARCHAR(10),
 @OVNO1 VARCHAR(12) = '',    
 @ACC_SERVER2 VARCHAR(15),  
 @ACC_DB2 VARCHAR(15),  
 @VNO2 VARCHAR(12),  
 @EXCHANGE2 VARCHAR(10),  
 @SEGMENT2 VARCHAR(10),
 @OVNO2 VARCHAR(12) = '',    
 @ACC_SERVER3 VARCHAR(15),  
 @ACC_DB3 VARCHAR(15),  
 @VNO3 VARCHAR(12),  
 @EXCHANGE3 VARCHAR(10),  
 @SEGMENT3 VARCHAR(10),
 @OVNO3 VARCHAR(12) = ''    
AS  
  
DECLARE   
 @@SQL VARCHAR(1000)  
  
BEGIN TRANSACTION  
  
  
 SET @@SQL = "EXEC " + @ACC_SERVER1 + "." + @ACC_DB1 + ".DBO.NEWPOSTBILL_REM " + CONVERT(VARCHAR, @VTYPE) + ",'" + @BOOKTYPE + "','" + @VNO1 + "','" + @VDT + "','" + @EDTDR + "','" + @EDTCR + "','" + @CDT + "','" + @PDT + "','" + @ENTEREDBY + "','" + @CHECKEDBY + "','" + @SETT_NO + "','" + @SETT_TYPE + "','" + @UNAME + "','" + @EXCHANGE1 + "','" + @SEGMENT1 + "','" + @OVNO1 + "'"  
  
  
 EXEC (@@SQL)  
  
 IF @@ERROR <> 0  
 BEGIN  
  ROLLBACK TRAN  
 END  
  
 SET @@SQL = "EXEC " + @ACC_SERVER2 + "." + @ACC_DB2 + ".DBO.NEWPOSTBILL_REM " + CONVERT(VARCHAR, @VTYPE) + ",'" + @BOOKTYPE + "','" + @VNO2 + "','" + @VDT + "','" + @EDTDR + "','" + @EDTCR + "','" + @CDT + "','" + @PDT + "','" + @ENTEREDBY + "','" + @CHECKEDBY + "','" + @SETT_NO + "','" + @SETT_TYPE + "','" + @UNAME + "','" + @EXCHANGE2 + "','" + @SEGMENT2 + "','" + @OVNO2 + "'"  
  
 EXEC (@@SQL)  
  
 IF @@ERROR <> 0  
 BEGIN  
  ROLLBACK TRAN  
 END  
  
 SET @@SQL = "EXEC " + @ACC_SERVER3 + "." + @ACC_DB3 + ".DBO.NEWPOSTBILL_REM " + CONVERT(VARCHAR, @VTYPE) + ",'" + @BOOKTYPE + "','" + @VNO3 + "','" + @VDT + "','" + @EDTDR + "','" + @EDTCR + "','" + @CDT + "','" + @PDT + "','" + @ENTEREDBY + "','" + @CHECKEDBY + "','" + @SETT_NO + "','" + @SETT_TYPE + "','" + @UNAME + "','" + @EXCHANGE3 + "','" + @SEGMENT3 + "','" + @OVNO3 + "'"  
  
 EXEC (@@SQL)  
  
 IF @@ERROR <> 0  
 BEGIN  
  ROLLBACK TRAN  
 END  
  
  
  
  
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Report_Access_CodeList1
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------
--  Proc To List Clients Acc To Login For The Db - Account
---------------------------------------------------------------------------------------------------------
CREATE   Procedure Report_Access_CodeList1
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3),  -- Account Category
 @Lookforname Varchar(25) -- Partial/complete/null String - Forms The Basis For The Search
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
Set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  lower(@Statusid) = "broker"
Begin
 Set @Strsql = "select "
 --Set @Strsql = @Strsql + "distinct Cltcode, Acname, Branchcode "
 Set @Strsql = @Strsql + "distinct Cltcode=Cltcode+' - '+Acname, Branchcode "
 Set @Strsql = @Strsql + "from Acmast "
 Set @Strsql = @Strsql + "where "
        If Len(Rtrim(@Whattolookfor)) <> 0 And Len(Rtrim(@Lookforname)) <> 0 
           Begin
    Set @Strsql = @Strsql + " ( Cltcode Like '" + @Whattolookfor + "' And Acname Like '" + @Lookforname + "%') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
    End
        Else
           If Len(Rtrim(@Lookforname)) <> 0 
               Begin
                  Set @Strsql = @Strsql + " ( Cltcode Like '" + @Whattolookfor + "' Or Acname Like '" + @Lookforname + "%') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
               End
           Else
               Begin
                  Set @Strsql = @Strsql + " ( Cltcode Like '" + @Whattolookfor + "' Or Acname Like '" + @Whattolookfor + "') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
               End
        If Rtrim(@Accat) = '3'
           Begin
  Select @Strsql = @Strsql + " Or Accat In ( '14', '18', '114', '118'))" 
           End
        Else
           Begin
  Select @Strsql = @Strsql + " )" 
           End
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections 
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By Cltcode, Branchcode "
End
--branch Login
If lower(@Statusid) = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = Cltcode+' - '+Acname, "
-- Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode Like '" + @Statusname + "' Or Branchcode = 'All') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%' " 
        If Rtrim(@Accat) = '3'
           Begin
  Select @Strsql = @Strsql + " Or Accat In ( '14', '18', '114', '118'))" 
           End
        Else
           Begin
  Select @Strsql = @Strsql + " )" 
           End
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If lower(@Statusid) = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If lower(@Statusid) = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 /*set @Strsql = @Strsql + " C1.Trader = S.Branch_cd And "*/
             Set @Strsql = @Strsql + " C1.Branch_cd = S.Branch_cd And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If lower(@Statusid) = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If lower(@Statusid) = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If lower(@Statusid) = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If lower(@Statusid) = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode = A.Cltcode+' - '+A.Acname, "
-- Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Area Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RepostLedger2
-- --------------------------------------------------
CREATE Proc RepostLedger2      
@vtyp smallint      
      
As      
Declare      
 @@Vno As Varchar(12),      
 @@Data As Cursor      
      
Set @@Data = Cursor For      
select distinct vno from ledger where vno not in(select vno from ledger2 where vtype = @vtyp)    
and vtyp = @vtyp    
    
Open @@Data      
Fetch Next From @@Data Into @@VNO      
Set NoCount ON      
While @@Fetch_Status = 0      
 Begin      
  Delete From TempLedger2 Where SessionId = '9999999999'      
  Insert Into TempLedger2      
  Select 'BRANCH', Case When A.BranchCode <> 'ALL' Then A.BranchCode Else 'HO' End,      
    L.VAmt, L.Vtyp, L.Vno, L.Lno, L.DrCr, '0', L.BookType, '9999999999',      
    L.CltCode, 'A', 0      
   From      
    Ledger L, AcMast A      
   Where      
    L.Cltcode = A.CltCode      
    And L.Vno = @@Vno And L.Vtyp = @vtyp And L.BookType = '01'      
    
  Exec InsertToLedger2 '9999999999', @@VNO, 1, 1, '', 'BROKER', 'BROKER'      
    
  Print 'Updated Voucher No. ' + @@VNO      
  Fetch Next From @@Data Into @@VNO      
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.REPROCESS_RECO
-- --------------------------------------------------
/*-----------------------------
sp_helptext REPROCESS_RECO
-----------------------------*/
--Text
CREATE PROC [dbo].[REPROCESS_RECO](
           @BANKCODE        VARCHAR(10),
           @PROCESS_DATE    VARCHAR(10),
           @PROCESS_DATE_TO VARCHAR(10))
           
AS

  SET NOCOUNT ON 

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED

--  IF @PROCESS_DATE_TO = '' SET @PROCESS_DATE_TO = @PROCESS_DATE 

  DECLARE  @@MICRNO        VARCHAR(20),
           @@PROC_DATE     VARCHAR(11),
           @@PROC_DATE_TO  VARCHAR(11)
                           
  CREATE TABLE #BANKRECOSAVE (
    CLTCODE          VARCHAR(10),
    BOOKDATE         DATETIME,
    [DESCRIPTION]    VARCHAR(200),
    AMOUNT           MONEY,
    DRCR             CHAR(1),
    VALUEDATE        DATETIME,
    REFERENCENO      VARCHAR(30),
    CROSSREFERENCENO BIGINT,
    STATUS           VARCHAR(15),
    BR_SNO           BIGINT,
    MICRNO           VARCHAR(10),
    AMOUNTLEDGR1     MONEY,
    L1_SNO           INT,
    VTYP             SMALLINT,
    BOOKTYPE         CHAR(2),
    VNO              VARCHAR(12),
    SLIPNO           INT)
  
  IF NOT EXISTS (SELECT 1
                 FROM   SYSOBJECTS
                 WHERE  TYPE = 'U' 
                        AND NAME = 'RECOPROCESS')
    CREATE TABLE RECOPROCESS (
             INPROCESS VARCHAR(1))
      
  IF (SELECT COUNT(1) 
      FROM   RECOPROCESS) = 0 
    INSERT INTO RECOPROCESS
               (INPROCESS)
    VALUES     ('N')
    
  IF (SELECT COUNT(1) 
      FROM   RECOPROCESS
      WHERE  INPROCESS = 'N') > 0 
    BEGIN
      BEGIN TRAN
      
      UPDATE RECOPROCESS
      SET    INPROCESS = 'Y'
    END
  ELSE
    BEGIN
      SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'
      
      RETURN
    END
    
  TRUNCATE TABLE LEDGER_UPDATES 

  IF NOT EXISTS (SELECT 1
                 FROM   ACMAST
                 WHERE  CLTCODE = @BANKCODE
                        AND ACCAT = 2)
    BEGIN
      SELECT 'BANK CODE DOSE NOT EXIST.'
      
      ROLLBACK TRAN
      
      RETURN
    END
    
  SELECT @@MICRNO = MICRNO
  FROM   ACMAST
  WHERE  CLTCODE = @BANKCODE
         AND ACCAT = 2
                     
  SELECT @@PROC_DATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@PROCESS_DATE,103),
                               109)
  
  SELECT @@PROC_DATE_TO = CONVERT(VARCHAR(11),CONVERT(DATETIME,@PROCESS_DATE_TO,103),
                                  109)
                          
  IF NOT EXISTS (SELECT 1
                 FROM   BANKRECO
                 WHERE  CLTCODE = @BANKCODE
                        AND BOOKDATE BETWEEN @@PROC_DATE AND @@PROC_DATE_TO + ' 23:59') 
    BEGIN
      SELECT 'THE STATEMENT FOR SELECTED DATE RANGE FROM ' + @@PROC_DATE + ' TO ' + @@PROC_DATE_TO + ' FOR ' + @BANKCODE + ' IS NOT UPLOADED.'
      
      ROLLBACK TRAN
      
      RETURN
    END
    
  IF NOT EXISTS (SELECT 1 
                 FROM   BANKRECO 
                 WHERE  CLTCODE = @BANKCODE 
                        AND BOOKDATE BETWEEN @@PROC_DATE AND @@PROC_DATE_TO + ' 23:59' 
                        AND STATUS = 'UNMATCHED')
    BEGIN
      PRINT 'ALL THE RECORDS FOR SELECTED DATE RANGE FROM ' + @@PROC_DATE + ' TO ' + @@PROC_DATE_TO + ' FOR ' + @BANKCODE + ' IS ALREADY MATCHED.'
      
      ROLLBACK TRAN
      
      RETURN
    END
    
  INSERT INTO #BANKRECOSAVE
  SELECT CLTCODE,
         BOOKDATE,
         [DESCRIPTION],
         AMOUNT,
         UPPER(DRCR),
         VALUEDATE,
         LTRIM(RTRIM(REFERENCENO)),
         CROSSREFERENCENO,
         STATUS,
         BR_SNO,
         MICRNO,
         0,
         0,
         0,
         '',
         '',
         0
  FROM   BANKRECO
  WHERE  CLTCODE = @BANKCODE
         AND BOOKDATE BETWEEN @@PROC_DATE AND @@PROC_DATE_TO + ' 23:59'
         AND STATUS = 'UNMATCHED'

  SELECT   L2.CLTCODE, 
           RELAMT = SUM(L1.RELAMT), 
           DDNO = LTRIM(RTRIM(L1.DDNO)),  
  DRCR = UPPER(L1.DRCR), 
           VDT = LEFT(L2.VDT,11) 
  INTO     #CHECKSUM 
  FROM     LEDGER1 L1 WITH (NOLOCK),
           LEDGER L2 WITH (NOLOCK)
  WHERE    L2.VNO = L1.VNO
           AND L2.VTYP = L1.VTYP
           AND L2.BOOKTYPE = L1.BOOKTYPE
           AND RELDT = ''
           AND CLTCODE = @BANKCODE
  GROUP BY L2.CLTCODE,LTRIM(RTRIM(L1.DDNO)),UPPER(L1.DRCR),LEFT(L2.VDT,11)

  UPDATE #BANKRECOSAVE
  SET    STATUS = 'MATCHED',
         L1_SNO = LEDGER1.L1_SNO,
         VTYP = LEDGER1.VTYP,
         BOOKTYPE = LEDGER1.BOOKTYPE,
         VNO = LEDGER1.VNO
  FROM   (SELECT DDNO = LTRIM(RTRIM(DDNO)),
                 RELDT,
                 RELAMT,
                 VTYP,
                 VNO,
                 LNO,
                 DRCR = UPPER(DRCR),
                 BOOKTYPE,
                 MICRNO = ISNULL(MICRNO,0),
                 L1_SNO
          FROM   LEDGER1 L1 WITH (NOLOCK)
          WHERE  RELDT = ''
                 AND EXISTS (SELECT 1
                             FROM   LEDGER L
                             WHERE  L.VNO = L1.VNO
                                    AND L.VTYP = L1.VTYP
                                    AND L.BOOKTYPE = L1.BOOKTYPE
                                    AND L.CLTCODE = @BANKCODE)) LEDGER1 
  WHERE  (LEDGER1.VTYP = 2
           OR LEDGER1.VTYP = 3
           OR LEDGER1.VTYP = 5
           OR LEDGER1.VTYP = 17
           OR LEDGER1.VTYP = 19
           OR LEDGER1.VTYP = 20)
         AND #BANKRECOSAVE.DRCR = LEDGER1.DRCR
         AND #BANKRECOSAVE.REFERENCENO = LEDGER1.DDNO 
         AND #BANKRECOSAVE.MICRNO = @@MICRNO
         AND #BANKRECOSAVE.AMOUNT = LEDGER1.RELAMT
         AND #BANKRECOSAVE.MICRNO = LEDGER1.MICRNO 
         AND #BANKRECOSAVE.REFERENCENO <> '0'
         AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(C.RELAMT) 
                     FROM   #CHECKSUM C
                     WHERE  #BANKRECOSAVE.REFERENCENO = C.DDNO
                            AND #BANKRECOSAVE.DRCR = C.DRCR
                            AND #BANKRECOSAVE.VALUEDATE >= C.VDT) 
                            
  IF @@ERROR <> 0
    BEGIN
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'
             
      ROLLBACK TRAN
      
      RETURN
    END
    
  UPDATE LEDGER1 WITH (ROWLOCK)
  SET    RELDT = VALUEDATE,
         REFNO = #BANKRECOSAVE.CROSSREFERENCENO
  FROM   #BANKRECOSAVE
  WHERE  #BANKRECOSAVE.L1_SNO <> 0
         AND LEDGER1.L1_SNO = #BANKRECOSAVE.L1_SNO
                              
  IF @@ERROR <> 0
    BEGIN
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'
             
      ROLLBACK TRAN
      
      RETURN
    END
    
  UPDATE #BANKRECOSAVE
  SET    AMOUNTLEDGR1 = BANKRECOCOMP.AMOUNT,
         STATUS = 'MATCHED',
         SLIPNO = BANKRECOCOMP.SLIPNO
  FROM   (SELECT   SUM(RELAMT)          AS AMOUNT,
                   LTRIM(RTRIM(SLIPNO)) AS SLIPNO,
                   UPPER(DRCR)          AS DRCR,
                   MICRNO
          FROM     LEDGER1 WITH (NOLOCK)
          WHERE    MICRNO = @@MICRNO
                   AND (VTYP = 2
                         OR VTYP = 19
                         OR VTYP = 5)
                   AND SLIPNO <> ''
                   AND RELDT = ''
          GROUP BY SLIPNO,DRCR,MICRNO) BANKRECOCOMP
  WHERE  #BANKRECOSAVE.DRCR = BANKRECOCOMP.DRCR
         AND BANKRECOCOMP.SLIPNO = REFERENCENO
         AND #BANKRECOSAVE.MICRNO = @@MICRNO
         AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT
         AND #BANKRECOSAVE.MICRNO = BANKRECOCOMP.MICRNO
         AND REFERENCENO <> '0'
                            
  IF @@ERROR <> 0
    BEGIN
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'
             
      ROLLBACK TRAN
      
      RETURN
    END
    
  SELECT L1.VTYP,
         L1.BOOKTYPE,
         L1.VNO,
         L1.L1_SNO,
         #BANKRECOSAVE.VALUEDATE,
         #BANKRECOSAVE.CROSSREFERENCENO
  INTO   #LEDGER_UPDATES_FOR_SLIPS
  FROM   #BANKRECOSAVE,
         LEDGER1 L1 WITH (NOLOCK)
  WHERE  L1.MICRNO = @@MICRNO
         AND L1.SLIPNO = #BANKRECOSAVE.SLIPNO
         AND #BANKRECOSAVE.SLIPNO <> 0
                                     
  UPDATE LEDGER1 WITH (ROWLOCK)
  SET    RELDT = VALUEDATE,
         REFNO = #LEDGER_UPDATES_FOR_SLIPS.CROSSREFERENCENO
  FROM   #LEDGER_UPDATES_FOR_SLIPS
  WHERE  #LEDGER_UPDATES_FOR_SLIPS.L1_SNO <> 0
         AND LEDGER1.L1_SNO = #LEDGER_UPDATES_FOR_SLIPS.L1_SNO
                              
  IF @@ERROR <> 0
    BEGIN
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 3'
             
      ROLLBACK TRAN
      
      RETURN
    END
    
  UPDATE L
  SET    EDT = VALUEDATE  
/*=====================================================================================================
REMOVED THE CASE CONDITION AS THE DATE CONDITION IS ALREADY MENTIONED IN ABOVE QUERY
=====================================================================================================*/
/*  SET    EDT = (CASE 
                  WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),VDT,109))) THEN VDT
                  ELSE (CASE 
                          WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),GETDATE(),109))) THEN CONVERT(VARCHAR(11),GETDATE(),109)
                          ELSE VALUEDATE
                        END)
                END)*/ 
  FROM   LEDGER L WITH (ROWLOCK), 
         (SELECT VTYP, 
                 BOOKTYPE, 
                 VNO, 
                 VALUEDATE 
          FROM   #BANKRECOSAVE 
          WHERE  VNO <> '' 
          UNION  
          SELECT VTYP, 
                 BOOKTYPE, 
                 VNO, 
                 VALUEDATE 
          FROM   #LEDGER_UPDATES_FOR_SLIPS 
          WHERE  VNO <> '') LU 
  WHERE  LU.VNO = L.VNO 
         AND LU.VTYP = L.VTYP 
         AND LU.BOOKTYPE = L.BOOKTYPE 
         AND EDT LIKE 'DEC 31 2049%' 
                      
  IF @@ERROR <> 0
    BEGIN
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'
             
      ROLLBACK TRAN
      
      RETURN
    END
    
  UPDATE BR
  SET    STATUS = 'MATCHED'
  FROM   BANKRECO BR,
         #BANKRECOSAVE BR1
  WHERE  BR.BR_SNO = BR1.BR_SNO
         AND BR1.STATUS = 'MATCHED'
                          
  INSERT INTO BANKRECO_LOG
  SELECT B.CLTCODE,
         B.BOOKDATE,
         B.DESCRIPTION,
         B.AMOUNT,
         B.DRCR,
         B.VALUEDATE,
         B.REFERENCENO,
         '',
         '',
         '',
         B.CROSSREFERENCENO,
         B.STATUS,
         @@MICRNO,
         '0',
         '0',
         0,
         'AUTO',
         GETDATE(),
         'MATCHED'
  FROM   #BANKRECOSAVE B
  WHERE  B.STATUS = 'MATCHED'
                    
  INSERT INTO LEDGER1_BANKRECO_LOG
  SELECT L1.*,
         'AUTO',
         GETDATE(),
         'MATCHED'
  FROM   LEDGER1 L1 WITH (NOLOCK),
         (SELECT VTYP,
                 BOOKTYPE,
                 VNO
          FROM   #BANKRECOSAVE
          WHERE  VNO <> ''
          UNION 
          SELECT VTYP,
                 BOOKTYPE,
                 VNO
          FROM   #LEDGER_UPDATES_FOR_SLIPS
          WHERE  VNO <> '') LU
  WHERE  L1.VNO = LU.VNO
         AND L1.VTYP = LU.VTYP
         AND L1.BOOKTYPE = LU.BOOKTYPE
                           
  UPDATE RECOPROCESS
  SET    INPROCESS = 'N'
                     
  COMMIT TRAN
  
  SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rname
-- --------------------------------------------------
create procedure rname
@fldreportname nvarchar (100)
as
select * from tblreports where fldreportname like '%'+@fldreportname+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpath
-- --------------------------------------------------
create procedure rpath
@fldpath nvarchar (200)
as
select * from tblreports where fldpath like '%'+@fldpath+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_bankbook_All
-- --------------------------------------------------



  
Create     PROCEDURE [dbo].[rpt_acc_bankbook_All]    


	@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @FCODE VARCHAR(10),                      
      @STATUSID VARCHAR(30),                      
      @STATUSNAME VARCHAR(30),                      
      @BRANCH VARCHAR(10),  
      @SELECTIONBY VARCHAR(3) = 'VDT',
	  @orderflg varchar(1) = 'N'     

    
AS

BEGIN 


   
CREATE TABLE [dbo].[#tmpLedgerNew] (    
  [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                    
 [BOOKTYPE] [CHAR] (2) NULL ,                    
 [VOUDT] [VARCHAR] (10) NULL ,        
 [EFFDT] [VARCHAR] (10) NULL ,                    
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                    
 [DRAMT] [MONEY] NULL ,                    
 [CRAMT] [MONEY] NULL ,                    
 [VNO] [VARCHAR] (12) NULL ,                    
 [NARRATION] [VARCHAR] (500) NULL ,                    
 [DDNO] [VARCHAR] (15) NULL ,                    
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                    
 [LONGNAME] [VARCHAR] (100) NULL ,                    
 [VTYP] [SMALLINT] NOT NULL ,                    
 [ACCAT] [CHAR] (2) NULL ,                    
 [OPBAL] [MONEY] NOT NULL ,                    
 [CROSAC] [VARCHAR] (10) NOT NULL ,                    
 [ACNAME] [VARCHAR] (100) NULL ,                    
 [BRANCHCODE] [VARCHAR] (35) NULL ,                    
 [VCHDT] [DATETIME] NULL,                    
 [Segment] [varchar] (4) NULL,    
 [Entity] [varchar] (50) NULL,    
 [orderSeg][bigint] NULL  

 ) ON [PRIMARY]    
    
   --Exec rpt_Acc_GlBook_New 'Apr 26 2005', 'Apr 26 2005', '01/04/2005', '771630', '771630', 'broker', 'broker', '%'  
    
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
Longname,vtyp,accat,opbal,crosac,Acname,Branchcode,vchdt)    
Exec ACCOUNT.DBO.RPT_ACC_BANKBOOK_NEW @FDATE, @TDATE ,@SDATE, @FCODE, @STATUSID,@STATUSNAME, @BRANCH,@SELECTIONBY

    
If @orderflg = 'N'
begin
UPDATE #tmpLedgerNew set Segment='1NSE',Entity='-', orderSeg = 1 where Segment is NULL
end
else
begin
UPDATE #tmpLedgerNew set Segment='1NSE',Entity='CAPITAL - NSE', orderSeg = 1 where Segment is NULL
end    

PRINT 'CAPITAL - NSE'  
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
Longname,vtyp,accat,opbal,crosac,Acname,Branchcode,vchdt)  
Exec ACCOUNTBSE.DBO.RPT_ACC_BANKBOOK_NEW @FDATE, @TDATE ,@SDATE, @FCODE, @STATUSID,@STATUSNAME, @BRANCH,@SELECTIONBY
    
If @orderflg = 'N'
begin  

UPDATE #tmpLedgerNew set Segment='2BSE',Entity='-', orderSeg = 1 where Segment is NULL 
end   
else
begin
UPDATE #tmpLedgerNew set Segment='2BSE',Entity='CAPITAL - BSE', orderSeg = 2 where Segment is NULL    
end



-----------Nsefo start 
   
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
Longname,vtyp,accat,opbal,crosac,Acname,Branchcode,vchdt)    
Exec ACCOUNTFO.DBO.RPT_ACC_BANKBOOK_NEW @FDATE, @TDATE ,@SDATE, @FCODE, @STATUSID,@STATUSNAME, @BRANCH,@SELECTIONBY
    
----Nsefo end    
   
If @orderflg = 'N'
begin  
UPDATE #tmpLedgerNew set Segment='3NFO',Entity='-', orderSeg = 1 where Segment is NULL    
end 
else
begin 
UPDATE #tmpLedgerNew set Segment='3NFO',Entity='DERIVATIVES - NSE', orderSeg = 3 where Segment is NULL    
end
  


If @orderflg = 'N'
 begin 
select cltcode, segment, orderSeg, opbal = max(opbal) into #opbal from #tmpLedgerNew   
group by cltcode, segment, orderSeg  
  
select cltcode, orderseg, opbal = sum(opbal) into #finopbal from #opbal   
group by cltcode, orderseg  
  
  
UPDATE           
            #tmpLedgerNew         
            SET Opbal = 0           
          
      UPDATE           
            #tmpLedgerNew          
            SET Opbal = T.Opbal           
      FROM #tmpledgerNew L WITH(NoLock),           
            #finopbal T WITH(NoLock)           
      WHERE L.Cltcode = T.Cltcode  and L.orderSeg = T.orderseg       
end


  
    
--if @strorder = 'ACCODE'    
 --begin    
  --if @selectby = 'vdt'    
  -- begin    
    --if @Single = 'Y'    
     --Begin    
    --  select * from #tmpLedgerNew order by orderSeg,cltcode,voudt    
    -- End    
   -- else    
    -- Begin    
    --  select * from #tmpLedgerNew order by cltcode,orderSeg,voudt    
    --  End    
   --end    
  --else    
  -- begin    
   -- if @Single = 'Y'    
    -- Begin    
    --  select * from #tmpLedgerNew order by orderSeg,cltcode,effdt    
    -- End    
    --Else    
    -- Begin    
    --  select * from #tmpLedgerNew order by cltcode,orderSeg,effdt    
    -- End    
   --end    
 --end    
--else    
-- begin    
 -- if @selectby = 'vdt'    
 --  begin    
 --   if @Single = 'Y'    
  --   Begin    
  --    select * from #tmpLedgerNew order by orderSeg,Acname,voudt    
  --   End    
  --  Else    
  --   Begin    
  --    select * from #tmpLedgerNew order by Acname,orderSeg,voudt    
  --   End    
  -- end    
  --else    
  -- begin    
  --  if @Single = 'Y'    
  --   Begin    
  --    select * from #tmpLedgerNew order by orderSeg,Acname,effdt    
  --  End    
 --   Else    
 --    Begin    
 --     select * from #tmpLedgerNew order by Acname,orderSeg,effdt    
 --    End    
 --  end    
 --end    
 If @orderflg = 'N'
begin
Select
	booktype,
	voudt VDT,
	effdt EDT,
	shortdesc,
	dramt debit,
	cramt credit,
	vno,
	Narration,
	ddno,
	cltcode,    
	Longname,
	vtyp,
	accat,
	opbal,
	crosac,
	Acname,
	Branchcode,
	Segment,    
	Entity,    
	orderSeg,
	VCHDT
	
from
#tmpLedgerNew order by CltCode, VCHDT,orderSeg
end
else 
begin    
Select
	booktype,
	voudt VDT,
	effdt EDT,
	shortdesc,
	dramt debit,
	cramt credit,
	vno,
	Narration,
	ddno,
	cltcode,    
	Longname,
	vtyp,
	accat,
	opbal,
	crosac,
	Acname,
	Branchcode,
	Segment,    
	Entity,    
	orderSeg,
	VCHDT

from
#tmpLedgerNew order by CltCode,orderSeg,VCHDT
end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_bankbook_All_new
-- --------------------------------------------------



  
create     PROCEDURE [dbo].[rpt_acc_bankbook_All_new]    


	@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @FCODE VARCHAR(10),                      
      @STATUSID VARCHAR(30),                      
      @STATUSNAME VARCHAR(30),                      
      @BRANCH VARCHAR(10),  
      @SELECTIONBY VARCHAR(3) = 'VDT',
	  @orderflg varchar(1) = 'N', 
	  @nseflg varchar(1)  ,    
	  @bseflg varchar(1)  ,    
      @foflg varchar(1)       		    

    
AS

BEGIN 


   
CREATE TABLE [dbo].[#tmpLedgerNew] (    
  [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                    
 [BOOKTYPE] [CHAR] (2) NULL ,                    
 [VOUDT] [VARCHAR] (10) NULL ,        
 [EFFDT] [VARCHAR] (10) NULL ,                    
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                    
 [DRAMT] [MONEY] NULL ,                    
 [CRAMT] [MONEY] NULL ,                    
 [VNO] [VARCHAR] (12) NULL ,                    
 [NARRATION] [VARCHAR] (500) NULL ,                    
 [DDNO] [VARCHAR] (15) NULL ,                    
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                    
 [LONGNAME] [VARCHAR] (100) NULL ,                    
 [VTYP] [SMALLINT] NOT NULL ,                    
 [ACCAT] [CHAR] (2) NULL ,                    
 [OPBAL] [MONEY] NOT NULL ,                    
 [CROSAC] [VARCHAR] (10) NOT NULL ,                    
 [ACNAME] [VARCHAR] (100) NULL ,                    
 [BRANCHCODE] [VARCHAR] (35) NULL ,                    
 [VCHDT] [DATETIME] NULL,                    
 [Segment] [varchar] (4) NULL,    
 [Entity] [varchar] (50) NULL,    
 [orderSeg][bigint] NULL  

 ) ON [PRIMARY]    
    
   --Exec rpt_Acc_GlBook_New 'Apr 26 2005', 'Apr 26 2005', '01/04/2005', '771630', '771630', 'broker', 'broker', '%'  
 If @nseflg = 'Y'
begin     
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
Longname,vtyp,accat,opbal,crosac,Acname,Branchcode,vchdt)    
Exec ACCOUNT.DBO.RPT_ACC_BANKBOOK_NEW @FDATE, @TDATE ,@SDATE, @FCODE, @STATUSID,@STATUSNAME, @BRANCH,@SELECTIONBY

    
If @orderflg = 'N'
begin
UPDATE #tmpLedgerNew set Segment='1NSE',Entity='-', orderSeg = 1 where Segment is NULL
end
else
begin
UPDATE #tmpLedgerNew set Segment='1NSE',Entity='CAPITAL - NSE', orderSeg = 1 where Segment is NULL
end    

PRINT 'CAPITAL - NSE'  
end
--------------------------------
If @bseflg = 'Y'
begin

INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
Longname,vtyp,accat,opbal,crosac,Acname,Branchcode,vchdt)  
Exec ACCOUNTBSE.DBO.RPT_ACC_BANKBOOK_NEW @FDATE, @TDATE ,@SDATE, @FCODE, @STATUSID,@STATUSNAME, @BRANCH,@SELECTIONBY
    
If @orderflg = 'N'
begin  

UPDATE #tmpLedgerNew set Segment='2BSE',Entity='-', orderSeg = 1 where Segment is NULL 
end   
else
begin
UPDATE #tmpLedgerNew set Segment='2BSE',Entity='CAPITAL - BSE', orderSeg = 2 where Segment is NULL    
end


end
----------------------------Nsefo start 
if @foflg = 'Y'
begin

   
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
Longname,vtyp,accat,opbal,crosac,Acname,Branchcode,vchdt)    
Exec ACCOUNTFO.DBO.RPT_ACC_BANKBOOK_NEW @FDATE, @TDATE ,@SDATE, @FCODE, @STATUSID,@STATUSNAME, @BRANCH,@SELECTIONBY
    

   
If @orderflg = 'N'
begin  
UPDATE #tmpLedgerNew set Segment='3NFO',Entity='-', orderSeg = 1 where Segment is NULL    
end 
else
begin 
UPDATE #tmpLedgerNew set Segment='3NFO',Entity='DERIVATIVES - NSE', orderSeg = 3 where Segment is NULL    
end
  
end

---------------------------------------
If @orderflg = 'N'
 begin 
select cltcode, segment, orderSeg, opbal = max(opbal) into #opbal from #tmpLedgerNew   
group by cltcode, segment, orderSeg  
  
select cltcode, orderseg, opbal = sum(opbal) into #finopbal from #opbal   
group by cltcode, orderseg  
  
  
UPDATE           
            #tmpLedgerNew         
            SET Opbal = 0           
          
      UPDATE           
            #tmpLedgerNew          
            SET Opbal = T.Opbal           
      FROM #tmpledgerNew L WITH(NoLock),           
            #finopbal T WITH(NoLock)           
      WHERE L.Cltcode = T.Cltcode  and L.orderSeg = T.orderseg       
end


  
    
--if @strorder = 'ACCODE'    
 --begin    
  --if @selectby = 'vdt'    
  -- begin    
    --if @Single = 'Y'    
     --Begin    
    --  select * from #tmpLedgerNew order by orderSeg,cltcode,voudt    
    -- End    
   -- else    
    -- Begin    
    --  select * from #tmpLedgerNew order by cltcode,orderSeg,voudt    
    --  End    
   --end    
  --else    
  -- begin    
   -- if @Single = 'Y'    
    -- Begin    
    --  select * from #tmpLedgerNew order by orderSeg,cltcode,effdt    
    -- End    
    --Else    
    -- Begin    
    --  select * from #tmpLedgerNew order by cltcode,orderSeg,effdt    
    -- End    
   --end    
 --end    
--else    
-- begin    
 -- if @selectby = 'vdt'    
 --  begin    
 --   if @Single = 'Y'    
  --   Begin    
  --    select * from #tmpLedgerNew order by orderSeg,Acname,voudt    
  --   End    
  --  Else    
  --   Begin    
  --    select * from #tmpLedgerNew order by Acname,orderSeg,voudt    
  --   End    
  -- end    
  --else    
  -- begin    
  --  if @Single = 'Y'    
  --   Begin    
  --    select * from #tmpLedgerNew order by orderSeg,Acname,effdt    
  --  End    
 --   Else    
 --    Begin    
 --     select * from #tmpLedgerNew order by Acname,orderSeg,effdt    
 --    End    
 --  end    
 --end    
 If @orderflg = 'N'
begin
Select
	booktype,
	voudt VDT,
	effdt EDT,
	shortdesc,
	dramt debit,
	cramt credit,
	vno,
	Narration,
	ddno,
	cltcode,    
	Longname,
	vtyp,
	accat,
	opbal,
	crosac,
	Acname,
	Branchcode,
	Segment,    
	Entity,    
	orderSeg,
	VCHDT
	
from
#tmpLedgerNew order by CltCode, VCHDT,orderSeg
end
else 
begin    
Select
	booktype,
	voudt VDT,
	effdt EDT,
	shortdesc,
	dramt debit,
	cramt credit,
	vno,
	Narration,
	ddno,
	cltcode,    
	Longname,
	vtyp,
	accat,
	opbal,
	crosac,
	Acname,
	Branchcode,
	Segment,    
	Entity,    
	orderSeg,
	VCHDT

from
#tmpLedgerNew order by CltCode,orderSeg,VCHDT
end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW
-- --------------------------------------------------
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'    
CREATE  PROC [dbo].[RPT_ACC_BANKBOOK_NEW]    
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
      @FCODE VARCHAR(10),                        
      @STATUSID VARCHAR(30),                        
      @STATUSNAME VARCHAR(30),                        
      @BRANCH VARCHAR(10),    
      @SELECTIONBY VARCHAR(3) = 'VDT'                         
                        
AS                        
                        
DECLARE                        
 @@OPENDATE AS VARCHAR(11),                        
 @@REPDATE AS VARCHAR(8),                        
 @@STARTDATE AS VARCHAR(11),     
 @@COSTCODE AS SMALLINT    
    
    
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                      
CREATE TABLE [DBO].[#TBL_GLREPORT] (                      
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                      
 [BOOKTYPE] [CHAR] (2) NULL ,                      
 [VOUDT] [VARCHAR] (10) NULL ,                      
 [EFFDT] [VARCHAR] (10) NULL ,                      
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                      
 [DRAMT] [MONEY] NULL ,                      
 [CRAMT] [MONEY] NULL ,                      
 [VNO] [VARCHAR] (12) NULL ,                      
 [NARRATION] [VARCHAR] (500) NULL ,                      
 [DDNO] [VARCHAR] (15) NULL ,                      
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                      
 [LONGNAME] [VARCHAR] (100) NULL ,                      
 [VDT] [DATETIME] NULL ,                      
 [VTYP] [SMALLINT] NOT NULL ,                      
 [ACCAT] [CHAR] (2) NULL ,                      
 [OPBAL] [MONEY] NOT NULL ,                      
 [CROSAC] [VARCHAR] (10) NOT NULL ,                      
 [ACNAME] [VARCHAR] (100) NULL ,                      
 [BRANCHCODE] [VARCHAR] (35) NULL ,                      
 [LNO] [INT] NULL,  
 [PROCID] [BIGINT] NULL ,                      
 [REPDATE] [VARCHAR] (8) NULL ,                      
 [MAINCODE] [VARCHAR] (10) NULL ,                      
 [VCHDT] [DATETIME] NULL                      
)                      
                      
                        
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                      
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID    
    
SELECT @@COSTCODE = -1    
    
IF @STATUSID <> 'BROKER'    
 BEGIN    
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME     
 END    
ELSE IF @STATUSID = 'BROKER'    
 BEGIN    
  IF @BRANCH <> '' OR @BRANCH <> '%'    
   BEGIN    
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH     
   END    
 END    
  
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                        
    
IF @SELECTIONBY = 'VDT'     
BEGIN    
 IF @STATUSID = 'BROKER'    
  BEGIN                        
   IF @BRANCH = '' OR @BRANCH = '%'    
    BEGIN    
     PRINT 'CAME HERE - I'    
     INSERT INTO TBL_OPPBALANCE     
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                             
      FROM     
       LEDGER                            
      WHERE     
       CLTCODE = @FCODE     
       AND VTYP = 18     
       AND VDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       CLTCODE    
      UNION ALL                        
      SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER                              
      WHERE     
       CLTCODE = @FCODE     
       AND VDT >= @@STARTDATE     
       AND VDT <  @FDATE                        
       AND VTYP <> 18                        
      GROUP BY     
       CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE    
     
                         
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,  
      L.LNO,    
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A                      
     WHERE     
      L.VNO = L1.VNO                      
      AND L.VTYP = L1.VTYP                      
      AND L.BOOKTYPE = L1.BOOKTYPE                      
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L.VTYP <> 18                      
    END    
   ELSE    
    BEGIN    
     PRINT 'CAME HERE - II'    
     INSERT INTO TBL_OPPBALANCE                              
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.VTYP = 18     
       AND L.VDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       L2.CLTCODE     
       
      UNION ALL    
       
      SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.VDT >= @@STARTDATE     
       AND L.VDT <  @FDATE     
       AND L2.VTYPE <> 18                        
      GROUP BY     
       L2.CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L2.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,  
      L.LNO,    
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L1.VNO                      
      AND L.VTYP = L1.VTYP                      
      AND L.BOOKTYPE = L1.BOOKTYPE                      
      AND L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
 --     AND L.DRCR = L2.DRCR    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L2.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
     
    END    
  END    
 ELSE    
  BEGIN    
   INSERT INTO TBL_OPPBALANCE                              
   SELECT     
    CLTCODE,     
    SUM(OPBAL) AS OPBAL,    
    SPID ,     
    CURDATE     
   FROM                        
    (SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
    AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.VTYP = 18     
     AND L.VDT LIKE @@STARTDATE + '%'    
    GROUP BY     
     L2.CLTCODE     
     
    UNION ALL    
     
    SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.VDT >= @@STARTDATE     
     AND L.VDT <  @FDATE     
     AND L2.VTYPE <> 18                        
    GROUP BY     
     L2.CLTCODE) A    
   GROUP BY     
    CLTCODE,     
    SPID,     
    CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,  
      L.LNO,    
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L1.VNO                      
      AND L.VTYP = L1.VTYP                      
      AND L.BOOKTYPE = L1.BOOKTYPE                      
      AND L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
 --     AND L.DRCR = L2.DRCR    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
  END    
END    
ELSE    
BEGIN    
 IF @STATUSID = 'BROKER'    
  BEGIN                        
   IF @BRANCH = '' OR @BRANCH = '%'    
    BEGIN    
     PRINT 'CAME HERE - I'    
     INSERT INTO TBL_OPPBALANCE                              
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                             
      FROM     
       LEDGER                            
      WHERE     
       CLTCODE = @FCODE     
       AND VTYP = 18     
       AND EDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       CLTCODE    
      UNION ALL                        
      SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER                              
      WHERE     
       CLTCODE = @FCODE     
       AND EDT >= @@STARTDATE     
       AND EDT <  @FDATE                        
       AND VTYP <> 18                        
      GROUP BY     
       CLTCODE    
      UNION ALL                        
      SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER                              
      WHERE     
       CLTCODE = @FCODE     
       AND VDT < @@STARTDATE     
       AND EDT >= @@STARTDATE     
       AND VTYP <> 18                        
      GROUP BY     
       CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE     
     
                         
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,   
      L.LNO,   
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A                      
     WHERE     
      L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L.VTYP <> 18                      
    END    
   ELSE    
    BEGIN    
     PRINT 'CAME HERE - II'    
     INSERT INTO TBL_OPPBALANCE                              
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.VTYP = 18     
       AND L.EDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       L2.CLTCODE     
       
      UNION ALL    
        
      SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.EDT >= @@STARTDATE     
       AND L.EDT <  @FDATE     
       AND L2.VTYPE <> 18                        
      GROUP BY     
       L2.CLTCODE    
    
      UNION ALL    
       
      SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.EDT >= @@STARTDATE     
       AND L.VDT <  @@STARTDATE     
       AND L2.VTYPE <> 18                        
      GROUP BY     
       L2.CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,   
      L.LNO,   
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
     
    END    
  END    
 ELSE    
  BEGIN    
   INSERT INTO TBL_OPPBALANCE                              
   SELECT     
    CLTCODE,     
    SUM(OPBAL) AS OPBAL,    
    SPID ,     
    CURDATE     
   FROM                        
    (SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.VTYP = 18     
     AND L.EDT LIKE @@STARTDATE + '%'    
    GROUP BY     
     L2.CLTCODE     
     
    UNION ALL    
     
    SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.EDT >= @@STARTDATE     
     AND L.EDT <  @FDATE                        
     AND L2.VTYPE <> 18                        
    GROUP BY     
     L2.CLTCODE    
     
    UNION ALL    
     
    SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.EDT >= @@STARTDATE     
     AND L.VDT <  @@STARTDATE             
     AND L2.VTYPE <> 18                        
    GROUP BY     
     L2.CLTCODE) A    
   GROUP BY     
    CLTCODE,     
    SPID,     
    CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,    
      L.LNO,  
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
  END    
END    
    
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                      
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                      
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                      
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                      
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                      
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                      
                  
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', ''                      
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                          
              
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0              
  
UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C  
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE  
AND L2.COSTCODE = C.COSTCODE  
                      
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                      
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                      
SELECT     
      BOOKTYPE,    
      VOUDT VDT ,    
      EFFDT EDT ,    
      SHORTDESC,    
      DRAMT DEBIT,    
      CRAMT CREDIT,    
      VNO,    
      NARRATION,    
      DDNO,    
      CLTCODE,     
      LONGNAME,    
      VTYP,    
      ACCAT,    
      OPBAL,    
      CROSAC,    
      ACNAME,    
      BRANCHCODE,  
   VCHDT                      
FROM     
      #TBL_GLREPORT      
WHERE     
      PROCID = @@SPID                      
ORDER BY     
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW_COST
-- --------------------------------------------------
--Exec rpt_Acc_BankBook_New_COST 'Jan  1 2007', 'Feb  2 2007', '01/04/2006', 'BA0095', 'broker', 'broker', '10', 'vdt'
/*SELECT * FROM LEDGER WHERE VNO = '200600007245' AND VTYP = 5
SELECT * FROM LEDGER2 WHERE VNO = '200600007245' AND VTYPE = 5

Exec rpt_Acc_BankBook_New 'Jan 23 2007', 'Jan 23 2007', '01/04/2006', 'BA0095', 'broker', 'broker', '22', 'vdt'*/


 --SELECT DISTINCT L.CLTCODE, A.BRANCHCODE FROM LEDGER L, ACMAST A WHERE L.CLTCODE = A.CLTCODE AND L.VDT >= 'APR  1 2005' AND A.ACCAT = 2  
  
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'MAR 11 2006', '01/04/2005', 'BANK01', 'BROKER', 'GOG', '%'  
  
 /****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_BANKBOOK_NEW    SCRIPT DATE: 07/08/2005 3:55:36 PM ******/          
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'JUL  5 2005', '01/04/2005', '33117', 'BROKER', 'BROKER', '%'             
--EXEC RPT_ACC_BANKBOOK_NEW '01/04/2005', '31/03/2006', 'JUN  1 2005', 'JUN 29 2005', '33117', '33117', 'BROKER', 'BROKER', '%','VOUCHERDATE', 'ACCOUNT', 'VDT', 'BANK BOOK',''                  
--EXEC RPT_ACC_BANKBOOK_NEW 'JUN  1 2005', 'JUN  1 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'                    
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'  
CREATE PROC RPT_ACC_BANKBOOK_NEW_COST  
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                    
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
      @FCODE VARCHAR(10),                      
      @STATUSID VARCHAR(30),                      
      @STATUSNAME VARCHAR(30),                      
      @BRANCH VARCHAR(10),  
      @SELECTIONBY VARCHAR(3) = 'VDT'                       
                      
AS                      
                      
DECLARE                      
 @@OPENDATE AS VARCHAR(11),                      
 @@REPDATE AS VARCHAR(8),                      
 @@STARTDATE AS VARCHAR(11),   
 @@COSTCODE AS SMALLINT  
  
  
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                    
CREATE TABLE [DBO].[#TBL_GLREPORT] (                    
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                    
 [BOOKTYPE] [CHAR] (2) NULL ,                    
 [VOUDT] [VARCHAR] (10) NULL ,                    
 [EFFDT] [VARCHAR] (10) NULL ,                    
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                    
 [DRAMT] [MONEY] NULL ,                    
 [CRAMT] [MONEY] NULL ,                    
 [VNO] [VARCHAR] (12) NULL ,                    
 [NARRATION] [VARCHAR] (500) NULL ,                    
 [DDNO] [VARCHAR] (15) NULL ,                    
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                    
 [LONGNAME] [VARCHAR] (100) NULL ,                    
 [VDT] [DATETIME] NULL ,                    
 [VTYP] [SMALLINT] NOT NULL ,                    
 [ACCAT] [CHAR] (2) NULL ,                    
 [OPBAL] [MONEY] NOT NULL ,                    
 [CROSAC] [VARCHAR] (10) NOT NULL ,                    
 [ACNAME] [VARCHAR] (100) NULL ,                    
 [BRANCHCODE] [VARCHAR] (10) NULL , 
 [LNO] [INT] NULL,                   
 [PROCID] [BIGINT] NULL ,                    
 [REPDATE] [VARCHAR] (8) NULL ,                    
 [MAINCODE] [VARCHAR] (10) NULL ,                    
 [VCHDT] [DATETIME] NULL                    
)                    
                    
                      
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                    
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID  
  
SELECT @@COSTCODE = -1  
  
IF @STATUSID <> 'BROKER'  
 BEGIN  
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME   
 END  
ELSE IF @STATUSID = 'BROKER'  
 BEGIN  
  IF @BRANCH <> '' OR @BRANCH <> '%'  
   BEGIN  
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH   
   END  
 END  
  
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                      
  
IF @SELECTIONBY = 'VDT'   
BEGIN  
 IF @STATUSID = 'BROKER'  
  BEGIN                      
   IF @BRANCH = '' OR @BRANCH = '%'  
    BEGIN  
     PRINT 'CAME HERE - I'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                           
      FROM   
       LEDGER                          
      WHERE   
       CLTCODE = @FCODE   
       AND VTYP = 18   
       AND VDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND VDT >= @@STARTDATE   
       AND VDT <  @FDATE                      
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
                       
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A                    
     WHERE   
      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE                    
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L.VTYP <> 18                    
    END  
   ELSE  
    BEGIN  
     PRINT 'CAME HERE - II'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
  FROM                      
      (SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VTYP = 18   
       AND L.VDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       L2.CLTCODE   
     
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VDT >= @@STARTDATE   
       AND L.VDT <  @FDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L2.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
/*      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE      */              
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
 --     AND L.DRCR = L2.DRCR  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L2.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
   
    END  
  END  
 ELSE  
  BEGIN  
   INSERT INTO TBL_OPPBALANCE                            
   SELECT   
    CLTCODE,   
    SUM(OPBAL) AS OPBAL,  
    SPID ,   
    CURDATE   
   FROM                      
    (SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VTYP = 18   
     AND L.VDT LIKE @@STARTDATE + '%'  
    GROUP BY   
     L2.CLTCODE   
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VDT >= @@STARTDATE   
     AND L.VDT <  @FDATE   
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE) A  
   GROUP BY   
    CLTCODE,   
    SPID,   
    CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
/*      L.VNO = L1.VNO                    
      AND L.VTYP = L1.VTYP                    
      AND L.BOOKTYPE = L1.BOOKTYPE       */             
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
 --     AND L.DRCR = L2.DRCR  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L2.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
  END  
END  
ELSE  
BEGIN  
 IF @STATUSID = 'BROKER'  
  BEGIN                      
   IF @BRANCH = '' OR @BRANCH = '%'  
    BEGIN  
     PRINT 'CAME HERE - I'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                           
      FROM   
       LEDGER                          
      WHERE   
       CLTCODE = @FCODE   
       AND VTYP = 18   
       AND EDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND EDT >= @@STARTDATE   
       AND EDT <  @FDATE                      
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE  
      UNION ALL                      
      SELECT   
       CLTCODE,  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER                            
      WHERE   
       CLTCODE = @FCODE   
       AND VDT < @@STARTDATE   
       AND EDT >= @@STARTDATE   
       AND VTYP <> 18                      
      GROUP BY   
       CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
                       
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,
      L.LNO,  
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A                    
     WHERE   
      L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L.VTYP <> 18                    
    END  
   ELSE  
    BEGIN  
     PRINT 'CAME HERE - II'  
     INSERT INTO TBL_OPPBALANCE                            
     SELECT   
      CLTCODE,   
      SUM(OPBAL) AS OPBAL,  
      SPID ,   
      CURDATE   
     FROM                      
      (SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.VTYP = 18   
       AND L.EDT LIKE @@STARTDATE + '%'  
      GROUP BY   
       L2.CLTCODE   
     
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.EDT >= @@STARTDATE   
       AND L.EDT <  @FDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE  
  
      UNION ALL  
     
      SELECT   
       L2.CLTCODE,  
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
       @@SPID AS SPID,   
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
      FROM   
       LEDGER L, LEDGER2 L2  
      WHERE   
       L.VNO = L2.VNO  
       AND L.VTYP = L2.VTYPE  
       AND L.BOOKTYPE = L2.BOOKTYPE  
       AND L.LNO = L2.LNO  
       AND L.CLTCODE = L2.CLTCODE  
       AND L2.CLTCODE = @FCODE   
       AND L2.COSTCODE = @@COSTCODE  
       AND L.EDT >= @@STARTDATE   
       AND L.VDT <  @@STARTDATE   
       AND L2.VTYPE <> 18                      
      GROUP BY   
       L2.CLTCODE) A  
     GROUP BY   
      CLTCODE,   
      SPID,   
      CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
   
    END  
  END  
 ELSE  
  BEGIN  
   INSERT INTO TBL_OPPBALANCE                            
   SELECT   
    CLTCODE,   
    SUM(OPBAL) AS OPBAL,  
    SPID ,   
    CURDATE   
   FROM                      
    (SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE  
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
 AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.VTYP = 18   
     AND L.EDT LIKE @@STARTDATE + '%'  
    GROUP BY   
     L2.CLTCODE   
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.EDT >= @@STARTDATE   
     AND L.EDT <  @FDATE                      
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE  
   
    UNION ALL  
   
    SELECT   
     L2.CLTCODE,  
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,  
     @@SPID AS SPID,   
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                      
    FROM   
     LEDGER L, LEDGER2 L2  
    WHERE   
     L.VNO = L2.VNO  
     AND L.VTYP = L2.VTYPE  
     AND L.BOOKTYPE = L2.BOOKTYPE  
     AND L.LNO = L2.LNO  
     AND L.CLTCODE = L2.CLTCODE  
     AND L2.CLTCODE = @FCODE   
     AND L2.COSTCODE = @@COSTCODE  
     AND L.EDT >= @@STARTDATE   
     AND L.VDT <  @@STARTDATE           
     AND L2.VTYPE <> 18                      
    GROUP BY   
     L2.CLTCODE) A  
   GROUP BY   
    CLTCODE,   
    SPID,   
    CURDATE  
   
     INSERT INTO #TBL_GLREPORT                    
     SELECT   
      L.BOOKTYPE,                       
      VOUDT=CONVERT(VARCHAR,L.VDT,103),   
      EFFDT=CONVERT(VARCHAR,L.EDT,103),   
   
      ISNULL(SHORTDESC,'') SHORTDESC,                                                               
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
      L.VNO,   
      REPLACE( L.NARRATION,'"','') NARRATION,                                                 
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                     
      L.CLTCODE ,  
      A.LONGNAME,  
      VDT,   
      L.VTYP,                                                                
      ACCAT,   
      OPBAL=0,  
      CROSAC='',  
      A.ACNAME,  
      A.BRANCHCODE,  
      L.LNO,
      @@SPID,   
      CONVERT(VARCHAR,GETDATE(),112), '',   
      L.VDT                    
     FROM   
      LEDGER L     
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                      
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                    
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                    
      VMAST V, ACMAST A, LEDGER2 L2                    
     WHERE   
      L.VNO = L2.VNO  
      AND L.VTYP = L2.VTYPE   
      AND L.BOOKTYPE = L2.BOOKTYPE  
      AND L.LNO = L2.LNO  
      AND L.VNO = LL.VNO                    
      AND L.VTYP = LL.VTYP                    
      AND L.BOOKTYPE = LL.BOOKTYPE                    
      AND L.CLTCODE = A.CLTCODE                    
      AND L.VTYP = V.VTYPE                    
      AND L2.CLTCODE <> @FCODE                    
      AND L2.COSTCODE = @@COSTCODE  
      AND L.VTYP <> 18    
  END  
END  
  
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE 
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                    
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                    
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                    
                
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', ''                    
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                        
            
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0 

UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C  
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE  
AND L2.COSTCODE = C.COSTCODE             
                    
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                    
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                    
SELECT   
      BOOKTYPE,  
      VOUDT VDT ,  
      EFFDT EDT ,  
      SHORTDESC,  
      DRAMT DEBIT,  
      CRAMT CREDIT,  
      VNO,  
      NARRATION,  
      DDNO,  
      CLTCODE,  
      LONGNAME,  
      VTYP,  
      ACCAT,  
      OPBAL,  
      CROSAC,  
      ACNAME,  
      BRANCHCODE                    
FROM   
      #TBL_GLREPORT    
WHERE   
      PROCID = @@SPID
      AND CLTCODE NOT IN(SELECT BRCONTROLAC FROM BRANCHACCOUNTS)
ORDER BY   
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_CashBook
-- --------------------------------------------------
CREATE  Proc rpt_Acc_CashBook        
@sdate varchar(11),            /* As mmm dd yyyy */                                  
@edate varchar(11),            /* As mmm dd yyyy */                                  
@fdate varchar(11),            /* As mmm dd yyyy */                                  
@tdate varchar(11),            /* As mmm dd yyyy */                                  
@fcode varchar(10),                                  
@tcode varchar(10),                                  
@statusId varchar(30),                                  
@statusname varchar(30),                                  
@branch varchar(10),                                  
@selectionby varchar(3),                                  
@GroupBy varchar(10),                                  
@Sortby varchar(50),                                  
@reportname varchar(30),                                  
@reportopt varchar(10)                                  
                                  
AS                                  
                                  
declare                                   
@@opendate as varchar(11),                
@@RepDate as varchar(8)                                  
                
                             
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
/*        
Exec rpt_Acc_GlReport_uk '01/04/2005', '31/03/2006', 'Apr  1 2005', 'Apr  5 2005', '99985', '99985', 'broker', 'broker', '%','vdt', 'Account', 'VDT', 'GL',''               
	
        
*/        
                
              
                
Select @@RepDate= convert(varchar,getdate(),112)                                  
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18'  and vdt <= @fdate                                               
              
Delete Tbl_GLReport where procid = @@SPID        
Delete Tbl_OppBalance where procid = @@SPID         
                
                         
if @selectionby = 'vdt'                                  
BEGIN                                  
 if rtrim(@branch) = '' or rtrim(@branch) = '%'                                   
  BEGIN                                      
     Insert into Tbl_OppBalance                              
     Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal,@@SPID,@@RepDate                                  
     from ledger    with(index(lededtind))                                    
     where cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                                 
     Group by cltcode                             
                                     
     Insert into Tbl_GLReport                                  
      Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                  
      dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                    
      cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),                                   
       l.vno, Replace( l.narration,'"','') narration,                                  
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
      l.cltcode , a.longname,vdt, l.vtyp,                                  
      accat,opbal=0,crosac='',   a.acname,a.branchcode,@@SPID,@@RepDate                                  
      from Ledger l with(index(lededtind))    
      left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
      on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
       Acmast a with(index(acmastind)) ,Vmast v                                                        
      Where l.cltcode between @fcode and @tcode        
      and l.cltcode = a.cltcode          
      and l.vdt between @fdate and @tdate + ' 23:59:59'             
      and l.vtyp <> '18'           
      And l.vtyp = v.vtype         
      and a.accat =  '1'    
                         
  END                                  
ELSE                                  
  BEGIN                                  
        
       insert into Tbl_OppBalance                           
     Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal,@@SPID,@@RepDate         
     from ledger2 l2, ledger l with(index(PartyVdt)), costmast c with(index(cstinx))                                  
     where vdt between @@opendate and @fdate                   
     and l.vno=l2.vno and l.lno=l2.lno                                  
     and l.vtyp=l2.vtype         
     and l.booktype=l2.booktype         
     and costname = rtrim(@branch)                                   
     and l2.costcode = c.costcode                                  
     and l2.cltcode between @fcode and @tcode         
     Group by l2.cltcode                                  
                               
   insert into Tbl_GLReport                                  
     Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                   
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                                   
     l.vno, Replace( l.narration,'"','') narration,                     
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
     l2.cltcode , a.longname,vdt, l.vtyp,                                  
     accat,  opbal=0,crosac='',a.acname,a.branchcode ,@@SPID,@@RepDate                
     from ledger l with(index(PartyVdt))     
  left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
     on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
  vmast v, ledger2 l2 with(index(TypeNo)), acmast a with(index(acmastind)),  costmast c with(index(cstinx))                                     
      Where  l.vdt between @fdate and @tdate + ' 23:59:59'        
   and  l.vno = l2.vno          
   and l.vtyp = l2.vtype         
   and l.vtyp = v.vtype         
   and l.booktype = l2.booktype         
   and l.lno = l2.lno         
      and l2.cltcode between @fcode and  @tcode          
   and l2.cltcode=a.cltcode          
   and a.accat <> '4'                                   
      and costname = rtrim(@branch)                                   
      and l2.costcode = c.costcode          
   and  l2.vtype <> 18                              
   END                                  
END                                  
ELSE                                  
BEGIN                                  
  if rtrim(@branch) = '' or rtrim(@branch) = '%'                                   
   BEGIN                                      
     insert into Tbl_OppBalance                               
     Select cltcode, sum(opbal) opbal,@@SPID,@@RepDate  from                                  
      (                              
       Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger  with(index(lededtind))                                 
       where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                                  
       Group by Cltcode                                  
       union                                  
      Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger   with(index(lededtind))                                 
      Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate                                  
      Group by cltcode) t                                
      Group by cltcode                
        
        
        
    insert into Tbl_GLReport                                  
      Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                  
      dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                    
      cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                                   
      Replace( l.narration,'"','') narration,                                  
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
       l.cltcode , a.longname,vdt, l.vtyp,                                  
      accat,opbal=0,crosac='',  a.acname,a.branchcode,@@SPID,@@RepDate                
      from Ledger l with(index(lededtind))    
  left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
     on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
    Acmast a with(index(acmastind)) ,Vmast v                                                        
      Where l.cltcode between @fcode and @tcode        
      and l.cltcode = a.cltcode          
      and l.edt between @fdate and @tdate + ' 23:59:59'             
      and l.vtyp <> '18'           
      And l.vtyp = v.vtype         
      and a.accat =  '1'    
        
   END                                  
  ELSE                                  
   BEGIN                                      
     insert into Tbl_OppBalance                               
     Select cltcode, sum(opbal) opbal,@@SPID,@@RepDate  from                                  
      (                              
      Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal         
       from ledger2 l2, ledger l with(index(PartyVdt)), costmast c with(index(cstinx))                                  
       where vdt between @@opendate and @fdate                   
       and l.vno=l2.vno and l.lno=l2.lno                                  
       and l.vtyp=l2.vtype         
       and l.booktype=l2.booktype         
       and costname = rtrim(@branch)                                   
       and l2.costcode = c.costcode                                  
       and l2.cltcode between @fcode and @tcode         
       Group by l2.cltcode                                  
       union                                  
                                  
       Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal         
       from ledger2 l2, ledger l with(index(PartyVdt)), costmast c with(index(cstinx))                                  
       where vdt < @@opendate and edt >= @@opendate         
       and l.vno=l2.vno         
       and l.vtyp=l2.vtype         
       and l.booktype=l2.booktype         
       and l.lno=l2.lno                   
       and costname = rtrim(@branch)                                   
       and l2.costcode = c.costcode                                  
       and l2.cltcode between @fcode and @tcode         
       Group by l2.cltcode) t        
       Group by cltcode                                  
        
        
        
    insert into Tbl_GLReport                                  
     Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                   
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                                   
     l.vno, Replace( l.narration,'"','') narration,                     
      ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),         
     l2.cltcode , a.longname,vdt, l.vtyp,                                    
     accat,   opbal=0,crosac='',a.acname,a.branchcode,@@SPID,@@RepDate                
      from ledger l with(index(PartyVdt))    
  left outer join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1    
     on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),     
  vmast v, ledger2 l2 with(index(TypeNo)), acmast a with(index(acmastind)),  costmast c with(index(cstinx))                                     
       Where  l.edt between @fdate and @tdate + ' 23:59:59'        
    and  l.vno = l2.vno          
    and l.vtyp = l2.vtype         
    and l.vtyp = v.vtype         
    and l.booktype = l2.booktype         
    and l.lno = l2.lno         
       and l2.cltcode between @fcode and  @tcode          
    and l2.cltcode=a.cltcode          
    and a.accat <> '4'                                   
       and costname = rtrim(@branch)                                   
       and l2.costcode = c.costcode          
    and  l2.vtype <> '18'        
   END                                  
END                                  
          
                              
Update Tbl_GLReport set opbal = Tbl_OppBalance.oppbal,crosac=''  from Tbl_OppBalance             
where Tbl_GLReport.cltcode = Tbl_OppBalance.cltcode  and Tbl_OppBalance.procid = @@SPID and Tbl_OppBalance.ProcId =Tbl_GLReport.Procid            
            
                                  
Update Tbl_GLReport         
set crosac = l.cltcode          
from ledger l  with(index(partyvdt))                        
where         
Tbl_GLReport.vno = l.vno                         
and Tbl_GLReport.vtyp = l.vtyp                         
and Tbl_GLReport.vtyp  in ('3','2')                         
and Tbl_GLReport.booktype = l.booktype                         
and Tbl_GLReport.cltcode <> l.cltcode                                   
and procid = @@SPID                      
                           
          
                
Select booktype,voudt vdt ,effdt edt ,shortdesc,dramt Debit,cramt Credit,vno,narration,ddno,cltcode,longname,vtyp,accat,opbal,crosac,acname,branchcode      
from Tbl_GLReport  where procid = @@SPID        
Order By CltCode , year(vdt),month(vdt),day(vdt), vtyp desc, vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_CASHBOOK_NEW
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_ACC_CASHBOOK_NEW]        
  @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
  @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
  @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
  @FCODE VARCHAR(10),                            
  @STATUSID VARCHAR(30),                            
  @STATUSNAME VARCHAR(30),                            
  @BRANCH VARCHAR(10)                            
                            
AS                            
                            
DECLARE                            
 @@OPENDATE AS VARCHAR(11),                            
 @@REPDATE AS VARCHAR(8),                            
 @@STARTDATE AS VARCHAR(11),         
 @@COSTCODE AS SMALLINT        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
                          
CREATE TABLE [DBO].[#TBL_GLREPORT] (                          
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                          
 [BOOKTYPE] [CHAR] (2) NULL ,                          
 [VOUDT] [VARCHAR] (10) NULL ,                          
 [EFFDT] [VARCHAR] (10) NULL ,                          
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                          
 [DRAMT] [MONEY] NULL ,                          
 [CRAMT] [MONEY] NULL ,                          
 [VNO] [VARCHAR] (12) NULL ,                          
 [NARRATION] [VARCHAR] (500) NULL ,                          
 [DDNO] [VARCHAR] (15) NULL ,                          
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                          
 [LONGNAME] [VARCHAR] (100) NULL ,                          
 [VDT] [DATETIME] NULL ,                          
 [VTYP] [SMALLINT] NOT NULL ,                          
 [ACCAT] [CHAR] (2) NULL ,                          
 [OPBAL] [MONEY] NOT NULL ,                          
 [CROSAC] [VARCHAR] (10) NOT NULL ,                          
 [ACNAME] [VARCHAR] (100) NULL ,                          
 [BRANCHCODE] [VARCHAR] (10) NULL ,                          
 [PROCID] [BIGINT] NULL ,                          
 [REPDATE] [VARCHAR] (8) NULL ,                          
 [MAINCODE] [VARCHAR] (10) NULL ,                          
 [VCHDT] [DATETIME] NULL                          
)                          
                          
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID        
        
SELECT @@COSTCODE = -1        
        
IF @STATUSID <> 'BROKER'        
 BEGIN        
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME         
 END        
ELSE IF @STATUSID = 'BROKER'        
 BEGIN        
  IF @BRANCH <> '' OR @BRANCH <> '%'        
   BEGIN        
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH         
   END        
 END        
        
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                            
        
IF @STATUSID = 'BROKER'        
 BEGIN                            
  IF @BRANCH = '' OR @BRANCH = '%'        
   BEGIN        
    INSERT INTO TBL_OPPBALANCE                                  
    SELECT         
     CLTCODE,         
     SUM(OPBAL) AS OPBAL,        
     SPID ,         
     CURDATE         
    FROM                         
     (SELECT         
      CLTCODE,        
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
      @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
     FROM         
      LEDGER                                
     WHERE         
      CLTCODE = @FCODE         
      AND VTYP = 18         
      AND VDT LIKE @@STARTDATE + '%'        
     GROUP BY         
      CLTCODE        
     UNION ALL                            
     SELECT         
      CLTCODE,        
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
  @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
     FROM         
      LEDGER                                  
     WHERE         
      CLTCODE = @FCODE         
      AND VDT >= @@STARTDATE         
      AND VDT <  @FDATE                            
      AND VTYP <> 18                            
     GROUP BY         
      CLTCODE) A        
    GROUP BY         
     CLTCODE,         
     SPID,         
     CURDATE        
        
                            
    INSERT INTO #TBL_GLREPORT                          
    SELECT         
     L.BOOKTYPE,                             
     VOUDT=CONVERT(VARCHAR,L.VDT,103),         
     EFFDT=CONVERT(VARCHAR,L.EDT,103),         
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                      
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                    
     L.VNO,         
     REPLACE( L.NARRATION,'"','') NARRATION,                                                       
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
     L.CLTCODE ,        
     A.LONGNAME,        
     VDT,         
     L.VTYP,                                                                      
     ACCAT,         
     OPBAL=0,        
     CROSAC='',        
     A.ACNAME,        
     A.BRANCHCODE,        
     @@SPID,         
     CONVERT(VARCHAR,GETDATE(),112), '',         
     L.VDT                          
    FROM         
     LEDGER L           
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
     VMAST V, ACMAST A                          
    WHERE         
     L.VNO = LL.VNO                          
     AND L.VTYP = LL.VTYP                          
     AND L.BOOKTYPE = LL.BOOKTYPE                          
     AND L.CLTCODE = A.CLTCODE                          
     AND L.VTYP = V.VTYPE                          
     AND L.CLTCODE <> @FCODE                          
     AND L.VTYP <> 18                          
   END        
  ELSE        
   BEGIN        
    INSERT INTO TBL_OPPBALANCE                                  
    SELECT         
     CLTCODE,         
     SUM(OPBAL) AS OPBAL,        
     SPID ,         
     CURDATE         
    FROM                            
     (SELECT         
      L2.CLTCODE,        
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
      @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
     FROM         
      LEDGER L, LEDGER2 L2        
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE        
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.DRCR = L2.DRCR        
      AND L.CLTCODE = L2.CLTCODE        
      AND L2.CLTCODE = @FCODE         
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP = 18         
      AND L.VDT LIKE @@STARTDATE + '%'        
     GROUP BY         
      L2.CLTCODE         
          
     UNION ALL        
    
     SELECT         
      L2.CLTCODE,        
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
      @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
     FROM         
      LEDGER L, LEDGER2 L2        
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE        
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.DRCR = L2.DRCR        
      AND L.CLTCODE = L2.CLTCODE        
      AND L2.CLTCODE = @FCODE         
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VDT >= @@STARTDATE         
      AND L.VDT <  @FDATE         
      AND L2.VTYPE <> 18                            
 GROUP BY         
      L2.CLTCODE) A        
    GROUP BY         
     CLTCODE,         
     SPID,         
     CURDATE        
    
    INSERT INTO #TBL_GLREPORT                          
    SELECT         
     L.BOOKTYPE,                             
     VOUDT=CONVERT(VARCHAR,L.VDT,103),         
     EFFDT=CONVERT(VARCHAR,L.EDT,103),         
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
     L.VNO,         
     REPLACE( L.NARRATION,'"','') NARRATION,                                                       
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
     L.CLTCODE ,        
     A.LONGNAME,        
     VDT,         
     L.VTYP,                                                                      
     ACCAT,         
     OPBAL=0,        
     CROSAC='',        
     A.ACNAME,        
     A.BRANCHCODE,        
     @@SPID,         
     CONVERT(VARCHAR,GETDATE(),112), '',         
     L.VDT                          
    FROM         
     LEDGER L           
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
     VMAST V, ACMAST A, LEDGER2 L2                          
    WHERE         
      L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE         
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.DRCR = L2.DRCR        
     AND L.VNO = LL.VNO                          
     AND L.VTYP = LL.VTYP                          
     AND L.BOOKTYPE = LL.BOOKTYPE                          
     AND L.CLTCODE = A.CLTCODE                          
     AND L.VTYP = V.VTYPE                          
     AND L.CLTCODE <> @FCODE                          
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP <> 18        
        
   END        
 END        
ELSE        
 BEGIN        
  INSERT INTO TBL_OPPBALANCE                                  
  SELECT         
   CLTCODE,         
   SUM(OPBAL) AS OPBAL,        
   SPID ,         
   CURDATE         
  FROM                            
   (SELECT         
    L2.CLTCODE,        
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
    @@SPID AS SPID,         
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
   FROM         
    LEDGER L, LEDGER2 L2        
   WHERE         
    L.VNO = L2.VNO        
    AND L.VTYP = L2.VTYPE        
    AND L.BOOKTYPE = L2.BOOKTYPE        
    AND L.DRCR = L2.DRCR        
    AND L.CLTCODE = L2.CLTCODE        
    AND L2.CLTCODE = @FCODE         
    AND L2.COSTCODE = @@COSTCODE        
    AND L.VTYP = 18         
    AND L.VDT LIKE @@STARTDATE + '%'        
   GROUP BY         
    L2.CLTCODE         
        
   UNION ALL        
        
   SELECT         
    L2.CLTCODE,        
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
    @@SPID AS SPID,         
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
   FROM         
    LEDGER L, LEDGER2 L2        
   WHERE         
    L.VNO = L2.VNO        
    AND L.VTYP = L2.VTYPE        
    AND L.BOOKTYPE = L2.BOOKTYPE        
    AND L.DRCR = L2.DRCR        
    AND L.CLTCODE = L2.CLTCODE        
    AND L2.CLTCODE = @FCODE         
    AND L2.COSTCODE = @@COSTCODE        
    AND L.VDT >= @@STARTDATE         
    AND L.VDT <  @FDATE                            
    AND L2.VTYPE <> 18                            
   GROUP BY         
    L2.CLTCODE) A        
  GROUP BY         
   CLTCODE,         
   SPID,         
   CURDATE        
        
    INSERT INTO #TBL_GLREPORT                          
    SELECT         
     L.BOOKTYPE,                             
     VOUDT=CONVERT(VARCHAR,L.VDT,103),         
     EFFDT=CONVERT(VARCHAR,L.EDT,103),        ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
     L.VNO,         
     REPLACE( L.NARRATION,'"','') NARRATION,                                                       
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
     L.CLTCODE ,        
     A.LONGNAME,        
     VDT,         
     L.VTYP,                                                                      
     ACCAT,         
     OPBAL=0,        
     CROSAC='',        
     A.ACNAME,        
     A.BRANCHCODE,        
     @@SPID,         
     CONVERT(VARCHAR,GETDATE(),112), '',         
     L.VDT                          
    FROM         
     LEDGER L           
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
     VMAST V, ACMAST A, LEDGER2 L2                          
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE         
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.DRCR = L2.DRCR        
     AND L.VNO = LL.VNO                          
     AND L.VTYP = LL.VTYP                          
     AND L.BOOKTYPE = LL.BOOKTYPE                          
     AND L.CLTCODE = A.CLTCODE                          
     AND L.VTYP = V.VTYPE                          
     AND L.CLTCODE <> @FCODE                          
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP <> 18          
 END        
        
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                          
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                          
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                          
                      
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','',PROCID,REPDATE, '', ''                          
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                              
                  
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                  
                          
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                          
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                          
SELECT         
      BOOKTYPE,        
      VOUDT VDT ,        
      EFFDT EDT ,        
      SHORTDESC,        
      DRAMT DEBIT,        
      CRAMT CREDIT,        
      VNO,        
      NARRATION,        
      DDNO,        
      CLTCODE,         
      LONGNAME,        
      VTYP,        
      ACCAT,        
      OPBAL,        
    CROSAC,        
      ACNAME,        
      BRANCHCODE
FROM         
      #TBL_GLREPORT          
WHERE         
      PROCID = @@SPID                          
ORDER BY         
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GLBook_New
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.rpt_Acc_GLBook_New    Script Date: 01/12/2006 16:12:07 ******/
Create Proc rpt_Acc_GLBook_New        
--Exec rpt_Acc_GlBook_New 'Apr 26 2005', 'Apr 26 2005', '01/04/2005', '771630', '771630', 'broker', 'broker', '%'      
@fdate varchar(11),            /* As mmm dd yyyy */        
@tdate varchar(11),            /* As mmm dd yyyy */        
@sdate varchar(10),            /* As mmm dd yyyy */        
@fcode varchar(10),        
@tcode varchar(10),      
@statusId varchar(30),        
@statusname varchar(30),        
@branch varchar(10)        
        
AS        
        
declare        
@@opendate as varchar(11),        
@@RepDate as varchar(8),        
@@StartDate As Varchar(11)        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
Delete Tbl_GLReport_New where procid = @@SPID                      
Delete Tbl_OppBalance where procid = @@SPID                       
        
Select @@StartDate = Left(Convert(Varchar, Convert(DateTime, '01/04/2005',103), 109), 11)        
        
Insert Into Tbl_OppBalance        
Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal,@@SPID, convert(varchar,getdate(),112)        
 from ledger 
 where cltcode between @fcode and @tcode and vdt >= @@StartDate and vdt <  @fdate        
 Group by cltcode        
        
        
Insert Into Tbl_GLReport_New      
select l.booktype,         
  voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,                                                 
  dramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),                                                  
  cramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                
  l.vno, Replace( l.narration,'"','') narration,                                   
  ddno = (case when isnull(l1.ddno,'')='0' then '' else isnull(l1.ddno,'') end),                       
  l.cltcode, a.longname,vdt, l.vtyp,                                                  
  accat, opbal=0,crosac='',a.acname,a.branchcode,@@SPID, convert(varchar,getdate(),112), LL.CltCode As MainCode      
 from ledger l 
  left join (select vtyp, booktype, vno, ddno= max(ddno) from ledger1 group by vtyp, booktype, vno) l1        
  on (l1.vtyp=l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno),      
  (select vno, vtyp, booktype, cltcode,drcr from ledger where vdt between @fdate and @tdate + ' 23:59:59' and cltcode between @fcode and @tcode) LL,      
vmast v, acmast a        
where       
l.vno = ll.vno        
and l.vtyp = ll.vtyp        
and l.booktype = ll.booktype       
and l.cltcode = a.cltcode        
and l.drcr=ll.drcr      
and l.vtyp = v.vtype        
and l.vtyp <> 18      
update Tbl_GLReport_New set narration = rtrim(longname) + ' - ' + rtrim(narration) where procid = @@spid        
Update Tbl_GLReport_New set opbal = Tbl_OppBalance.oppbal,crosac=''  from Tbl_OppBalance        
where Tbl_OppBalance.cltcode = Tbl_GlReport_New.MainCode and Tbl_OppBalance.procid = @@SPID and Tbl_OppBalance.ProcId =Tbl_GLReport_New.Procid        
Delete From Tbl_GLReport_New Where cltcode Between @fcode and @tcode and procid = @@spid      
update Tbl_GLReport_New set crosac = cltcode where procid = @@spid      
update Tbl_GLReport_New set cltcode = MainCode where procid = @@spid        
update Tbl_GLReport_New set acname = a.acname from acmast a where Tbl_GLReport_New.cltcode = a.cltcode and Tbl_GLReport_New.procid = @@spid        
update Tbl_GLReport_New set DRAMT = CRAMT, CRAMT = DRAMT      
      
--select * from Tbl_OppBalance where procid = @@spid        
--select * from Tbl_GLReport where procid = @@spid        
Select booktype,voudt ,effdt ,shortdesc,dramt ,cramt ,vno,narration,ddno,cltcode,longname,vtyp,accat,opbal,crosac,acname,branchcode                    
from Tbl_GLReport_New  where procid = @@SPID                      
Order By CltCode , vdt, vtyp desc, vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_glledger_All
-- --------------------------------------------------
CREATE     PROCEDURE [dbo].[rpt_acc_glledger_All]      
  
  
@sdate varchar(11),            /* As mmm dd yyyy */  
 @edate varchar(11),            /* As mmm dd yyyy */  
 @fdate varchar(11),            /* As mmm dd yyyy */  
 @tdate varchar(11),            /* As mmm dd yyyy */  
 @fcode varchar(10),  
 @tcode varchar(10),  
 @statusId varchar(30),  
 @statusname varchar(30),  
 @branch varchar(10),  
 @selectionby varchar(3),  
 @GroupBy varchar(10),  
 @Sortby varchar(50),  
 @reportname varchar(30),  
 @reportopt varchar(10)   
      
AS  
BEGIN   
  
     
CREATE TABLE [dbo].[#tmpLedgerNew] (      
  [booktype] [char] (2)  NULL ,      
  [voudt] [varchar] (20) NULL ,      
  [effdt] [varchar] (20) NULL ,      
  [shortdesc] [char] (6) NULL ,      
  [dramt] [money] NULL ,      
  [cramt] [money] NULL ,      
  [vno] [varchar] (12) NULL ,      
  [Narration] [varchar] (234) NULL ,  
  [ddno] [varchar] (15) NULL ,      
  [cltcode] [varchar] (10) NOT NULL ,  
  [Longname] [varchar] (100) NULL ,  
  [vdt] [datetime] NULL ,        
  [vtyp] [smallint] NULL ,      
  [accat] [varchar] (30) NULL ,      
  [opbal] [money] NULL ,      
  [crosac] [varchar] (10) NULL ,      
  [Acname] [varchar] (100) NULL ,   
  [Branchcode] [varchar] (10) NULL ,  
  [LNO][smallint] NULL,  
  [Segment] [varchar] (4) NULL,      
  [Entity] [varchar] (50) NULL,      
  [orderSeg][bigint] NULL    
  
 ) ON [PRIMARY]      
      
   --Exec rpt_Acc_GlBook_New 'Apr 26 2005', 'Apr 26 2005', '01/04/2005', '771630', '771630', 'broker', 'broker', '%'    
      
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,      
Longname,vdt,vtyp,accat,opbal,crosac,Acname,Branchcode,LNO)      
Exec ACCOUNT.DBO.rpt_Acc_GLREPORT @sdate,@edate,@fdate,@tdate,@fcode,@tcode,@statusId,@statusname,@branch,@selectionby,@GroupBy,@Sortby,@reportname,@reportopt  
  
      
UPDATE #tmpLedgerNew set Segment='1NSE',Entity='CAPITAL - NSE', orderSeg = 1 where Segment is NULL      
      
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,      
Longname,vdt,vtyp,accat,opbal,crosac,Acname,Branchcode,LNO)      
Exec ACCOUNTBSE.DBO.rpt_Acc_GLREPORT @sdate,@edate,@fdate,@tdate,@fcode,@tcode,@statusId,@statusname,@branch,@selectionby,@GroupBy,@Sortby,@reportname,@reportopt  
      
UPDATE #tmpLedgerNew set Segment='2BSE',Entity='CAPITAL - BSE', orderSeg = 2 where Segment is NULL      
--Nsefo start   
     
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,      
Longname,vdt,vtyp,accat,opbal,crosac,Acname,Branchcode,LNO)      
Exec ACCOUNTFO.DBO.rpt_Acc_GLREPORT @sdate,@edate,@fdate,@tdate,@fcode,@tcode,@statusId,@statusname,@branch,@selectionby,@GroupBy,@Sortby,@reportname,@reportopt  
      
--Nsefo end      
      
UPDATE #tmpLedgerNew set Segment='3NFO',Entity='DERIVATIVES - NSE', orderSeg = 3 where Segment is NULL      
    
      
--if @strorder = 'ACCODE'      
 --begin      
  --if @selectby = 'vdt'      
  -- begin      
    --if @Single = 'Y'      
     --Begin      
    --  select * from #tmpLedgerNew order by orderSeg,cltcode,voudt      
    -- End      
   -- else      
    -- Begin      
    --  select * from #tmpLedgerNew order by cltcode,orderSeg,voudt      
    --  End      
   --end      
  --else      
  -- begin      
   -- if @Single = 'Y'      
    -- Begin      
    --  select * from #tmpLedgerNew order by orderSeg,cltcode,effdt      
    -- End      
    --Else      
    -- Begin      
    --  select * from #tmpLedgerNew order by cltcode,orderSeg,effdt      
    -- End      
   --end      
 --end      
--else      
-- begin      
 -- if @selectby = 'vdt'      
 --  begin    
 --   if @Single = 'Y'      
  --   Begin      
  --    select * from #tmpLedgerNew order by orderSeg,Acname,voudt      
  --   End      
  --  Else      
  --   Begin      
  --    select * from #tmpLedgerNew order by Acname,orderSeg,voudt      
  --   End      
  -- end      
  --else      
  -- begin      
  --  if @Single = 'Y'      
  --   Begin      
  --    select * from #tmpLedgerNew order by orderSeg,Acname,effdt      
  --  End      
 --   Else      
 --    Begin      
 --     select * from #tmpLedgerNew order by Acname,orderSeg,effdt      
 --    End      
 --  end      
 --end      
      
Select  
 booktype,  
 voudt,  
 effdt,   
 shortdesc,  
 dramt,  
 cramt,  
 vno,  
 narration,  
 ddno,  
 cltcode,  
 longname,  
 vdt,  
 vtyp,  
 accat,  
 opbal,  
 crosac,  
 acname,  
 branchcode,  
 lno,  
 Segment,      
 Entity,      
 orderSeg  
from  
#tmpLedgerNew order by CltCode,orderSeg,  
 vdt  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_glledger_All_new
-- --------------------------------------------------


--Exec rpt_acc_glledger_All '01/04/2006', '31/03/2007', 'Jan  1 2007', 'Feb  1 2007', '0', '9', 'broker', 'gog', 'HO','vdt', 'Account', 'VDT', 'GL',''  
  
CREATE     PROCEDURE [dbo].[rpt_acc_glledger_All_new]    


	@sdate varchar(11),            /* As mmm dd yyyy */
	@edate varchar(11),            /* As mmm dd yyyy */
	@fdate varchar(11),            /* As mmm dd yyyy */
	@tdate varchar(11),            /* As mmm dd yyyy */
	@fcode varchar(10),
	@tcode varchar(10),
	@statusId varchar(30),
	@statusname varchar(30),
	@branch varchar(10),
	@selectionby varchar(3),
	@GroupBy varchar(10),
	@Sortby varchar(50),
	@reportname varchar(30),
	@reportopt varchar(10), 
	@orderflg varchar(1) = 'N',
	@nseflg varchar(1)  ,    
	@bseflg varchar(1)  ,    
	@foflg varchar(1)       
    
 
AS
BEGIN 

   
CREATE TABLE [dbo].[#tmpLedgerNew] (    
  [booktype] [char] (2)  NULL ,    
  [voudt] [varchar] (20) NULL ,    
  [effdt] [varchar] (20) NULL ,    
  [shortdesc] [char] (6) NULL ,    
  [dramt] [money] NULL ,    
  [cramt] [money] NULL ,    
  [vno] [varchar] (12) NULL ,    
  [Narration] [varchar] (234) NULL ,
  [ddno] [varchar] (15) NULL ,    
  [cltcode] [varchar] (10) NOT NULL ,
  [Longname] [varchar] (100) NULL ,
  [vdt] [datetime] NULL ,      
  [vtyp] [smallint] NULL ,    
  [accat] [varchar] (30) NULL ,    
  [opbal] [money] NULL ,    
  [crosac] [varchar] (10) NULL ,    
  [Acname] [varchar] (150) NULL , 
  [Branchcode] [varchar] (20) NULL ,
  [LNO][smallint] NULL,
  [Segment] [varchar] (4) NULL,    
  [Entity] [varchar] (50) NULL,    
  [orderSeg][bigint] NULL  

 ) ON [PRIMARY]    
  

If @nseflg = 'Y'
begin    
print 'nse 1' 
   --Exec rpt_Acc_GlBook_New 'Apr 26 2005', 'Apr 26 2005', '01/04/2005', '771630', '771630', 'broker', 'broker', '%'  
		INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
		Longname,vdt,vtyp,accat,opbal,crosac,Acname,Branchcode,LNO)    
		Exec ACCOUNT.DBO.rpt_Acc_GLREPORT @sdate,@edate,@fdate,@tdate,@fcode,@tcode,@statusId,@statusname,@branch,@selectionby,@GroupBy,@Sortby,@reportname,@reportopt

print 'Exec ACCOUNT.DBO.rpt_Acc_GLREPORT' + @sdate +',' +@edate + ',' + @fdate +',' + @tdate + ',' + @fcode + ',' + @tcode + ',' + @statusId + ',' + @statusname + ',' + @branch + ',' + @selectionby + ',' + @GroupBy +',' + @Sortby + ',' + @reportname + ',' + @reportopt     

		If @orderflg = 'N'
			begin
				UPDATE #tmpLedgerNew set Segment='1NSE',Entity='SETTELMENT  LEDGER', orderSeg = 1 where Segment is NULL
			end
		else
			begin
				UPDATE #tmpLedgerNew set Segment='1NSE',Entity='CAPITAL - NSE', orderSeg = 1 where Segment is NULL
			end 
print 'nse 2' 
   
end

If @bseflg = 'Y'
begin
  print 'bse 1' 

	INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
	Longname,vdt,vtyp,accat,opbal,crosac,Acname,Branchcode,LNO)    
	Exec ACCOUNTBSE.DBO.rpt_Acc_GLREPORT @sdate,@edate,@fdate,@tdate,@fcode,@tcode,@statusId,@statusname,@branch,@selectionby,@GroupBy,@Sortby,@reportname,@reportopt
	If @orderflg = 'N'
		begin  

			UPDATE #tmpLedgerNew set Segment='2BSE',Entity='SETTELMENT  LEDGER', orderSeg = 1 where Segment is NULL 
		end   
	else
		begin
			UPDATE #tmpLedgerNew set Segment='2BSE',Entity='CAPITAL - BSE', orderSeg = 2 where Segment is NULL    
		end
  print 'bse 2'
end

--Nsefo start 

if @foflg = 'Y'
begin
    print 'fo 1' 
	INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,Narration,ddno,cltcode,    
	Longname,vdt,vtyp,accat,opbal,crosac,Acname,Branchcode,LNO)    
	Exec ACCOUNTFO.DBO.rpt_Acc_GLREPORT @sdate,@edate,@fdate,@tdate,@fcode,@tcode,@statusId,@statusname,@branch,@selectionby,@GroupBy,@Sortby,@reportname,@reportopt
    
	--Nsefo end    
	If @orderflg = 'N'
		begin  
			UPDATE #tmpLedgerNew set Segment='3NFO',Entity='SETTELMENT  LEDGER', orderSeg = 1 where Segment is NULL    
		end 
	else
		begin 
			UPDATE #tmpLedgerNew set Segment='3NFO',Entity='DERIVATIVES - NSE', orderSeg = 3 where Segment is NULL    
	end
 print 'fo 2'  
end
 


If @orderflg = 'N'
 begin 
select cltcode, segment, orderSeg, opbal = max(opbal) into #opbal from #tmpLedgerNew   
group by cltcode, segment, orderSeg  
  
select cltcode, orderseg, opbal = sum(opbal) into #finopbal from #opbal   
group by cltcode, orderseg  
  
  
UPDATE           
            #tmpLedgerNew         
            SET Opbal = 0           
          
      UPDATE           
            #tmpLedgerNew          
            SET Opbal = T.Opbal           
      FROM #tmpledgerNew L WITH(NoLock),           
            #finopbal T WITH(NoLock)           
      WHERE L.Cltcode = T.Cltcode  and L.orderSeg = T.orderseg       
end
    

If @orderflg = 'N'
begin  
Select
	booktype,
	voudt,
	effdt, 
	shortdesc,
	dramt,
	cramt,
	vno,
	narration,
	ddno,
	cltcode,
	longname,
	vdt,
	vtyp,
	accat,
	opbal,
	crosac,
	acname,
	branchcode,
	lno,
	Segment,    
	Entity,    
	orderSeg
from
#tmpLedgerNew order by CltCode,	vdt,orderSeg

end
else
begin
Select
	booktype,
	voudt,
	effdt, 
	shortdesc,
	dramt,
	cramt,
	vno,
	narration,
	ddno,
	cltcode,
	longname,
	vdt,
	vtyp,
	accat,
	opbal,
	crosac,
	acname,
	branchcode,
	lno,
	Segment,    
	Entity,    
	orderSeg
from
#tmpLedgerNew order by CltCode,orderSeg,
	vdt
end

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_GLREPORT
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_ACC_GLREPORT]          
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */          
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */          
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */          
 @FCODE VARCHAR(10),          
 @TCODE VARCHAR(10),          
 @STATUSID VARCHAR(30),          
 @STATUSNAME VARCHAR(30),          
 @BRANCH VARCHAR(10),          
 @SELECTIONBY VARCHAR(3),          
 @GROUPBY VARCHAR(10),          
 @SORTBY VARCHAR(50),          
 @REPORTNAME VARCHAR(30),          
 @REPORTOPT VARCHAR(10)          
          
AS          
          
DECLARE          
 @@OPENDATE AS VARCHAR(11)          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
          
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR       
          
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM LEDGER  WHERE 1 =2          
    
CREATE TABLE [DBO].[#TEMPTABLE_GL] (        
  [BOOKTYPE] [CHAR] (2)  NULL ,        
  [VOUDT1] [VARCHAR] (20) NULL ,        
  [EFFDT1] [VARCHAR] (20) NULL ,        
  [SHORTDESC] [CHAR] (6) NULL ,        
  [DRAMT] [MONEY] NULL ,        
  [CRAMT] [MONEY] NULL ,        
  [VNO] [VARCHAR] (12) NULL ,        
  [NARRATION] [VARCHAR] (234) NULL ,    
  [DDNO] [VARCHAR] (15) NULL ,        
  [CLTCODE] [VARCHAR] (10) NOT NULL ,    
  [LONGNAME] [VARCHAR] (100) NULL ,    
  [VDT] [DATETIME] NULL ,          
  [VTYP] [SMALLINT] NULL ,        
  [ACCAT] [VARCHAR] (30) NULL ,        
  [OPBAL] [MONEY] NULL ,        
  [CROSAC] [VARCHAR] (10) NULL ,        
  [ACNAME] [VARCHAR] (150) NULL ,     
  [BRANCHCODE] [VARCHAR] (20) NULL ,    
  [LNO][SMALLINT] NULL,    
      
    
 ) ON [PRIMARY]      
          
IF @SELECTIONBY = 'VDT'          
 BEGIN          
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'          
   BEGIN   
  INSERT INTO #OPBAL          
     SELECT          
      CLTCODE,          
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL          
     FROM          
      LEDGER          
     WHERE          
      CLTCODE BETWEEN @FCODE AND @TCODE          
      AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18      
     GROUP BY CLTCODE          
     ORDER BY CLTCODE  
         
     INSERT INTO #OPBAL          
     SELECT          
      CLTCODE,          
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL          
     FROM          
      LEDGER          
     WHERE          
      CLTCODE BETWEEN @FCODE AND @TCODE          
      AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18      
     GROUP BY CLTCODE          
     ORDER BY CLTCODE          
       
          
    INSERT INTO #TEMPTABLE_GL          
    SELECT          
     L.BOOKTYPE,          
     VOUDT1=L.VDT,          
     EFFDT1=L.EDT,          
     ISNULL(SHORTDESC,'') SHORTDESC,          
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),          
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),          
     L.VNO,          
     REPLACE( L.NARRATION,'"','') NARRATION,          
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),          
     L.CLTCODE,          
     A.LONGNAME,          
     VDT,          
     L.VTYP,          
     ACCAT,          
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     L.LNO          
    FROM          
     LEDGER L,          
     ACMAST A,          
     VMAST V          
    WHERE          
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'          
     AND VTYP = VTYPE          
     AND L.CLTCODE = A.CLTCODE          
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE          
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')          
    ORDER BY          
     L.CLTCODE,          
     VOUDT1,          
     L.VTYP DESC,          
     L.VNO          
   END          
  ELSE          
   BEGIN          
    INSERT INTO #OPBAL          
    SELECT          
     L2.CLTCODE,          
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL          
    FROM          
     LEDGER2 L2,          
     LEDGER L          
    WHERE          
     L2.CLTCODE BETWEEN @FCODE AND @TCODE          
     AND L.VTYP=L2.VTYPE          
     AND L.BOOKTYPE=L2.BOOKTYPE          
  AND L.VNO=L2.VNO          
     AND L.LNO=L2.LNO          
     AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18  
    GROUP BY L2.CLTCODE          
    ORDER BY L2.CLTCODE          
  
 INSERT INTO #OPBAL          
    SELECT          
     L2.CLTCODE,          
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL          
    FROM          
     LEDGER2 L2,          
     LEDGER L          
    WHERE          
     L2.CLTCODE BETWEEN @FCODE AND @TCODE          
     AND L.VTYP=L2.VTYPE          
     AND L.BOOKTYPE=L2.BOOKTYPE          
  AND L.VNO=L2.VNO          
     AND L.LNO=L2.LNO          
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18          
    GROUP BY L2.CLTCODE          
    ORDER BY L2.CLTCODE   
          
    INSERT INTO #TEMPTABLE_GL          
    SELECT          
     L.BOOKTYPE,          
     VOUDT1=L.VDT,          
     EFFDT1=L.EDT,          
     ISNULL(SHORTDESC,'') SHORTDESC,          
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),          
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),          
     L.VNO,          
     REPLACE( L.NARRATION,'"','') NARRATION,          
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),          
     L2.CLTCODE,          
     A.LONGNAME,          
     VDT,          
     L.VTYP,          
     ACCAT,          
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     L.LNO          
    FROM          
     LEDGER L,          
     VMAST V,          
     LEDGER2 L2,          
     ACMAST A,          
     COSTMAST C          
    WHERE          
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'          
     AND L.VTYP = L2.VTYPE          
     AND  L.VNO = L2.VNO          
     AND L.LNO = L2.LNO          
     AND L.BOOKTYPE = L2.BOOKTYPE          
     AND L2.CLTCODE=A.CLTCODE          
     AND L.VTYP = V.VTYPE          
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE          
     AND A.ACCAT <> '4'          
     AND COSTNAME = RTRIM(@BRANCH)          
     AND L2.COSTCODE = C.COSTCODE          
     AND  L2.VTYPE <> 18          
    ORDER BY          
     L2.CLTCODE,          
     VOUDT1,          
     L.VTYP DESC,          
     L.VNO          
   END          
 END          
ELSE          
 BEGIN          
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'          
   BEGIN          
    INSERT INTO #OPBAL          
    SELECT          
     CLTCODE,          
     SUM(OPBAL) OPBAL          
    FROM          
     (          
      SELECT          
       CLTCODE,          
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL          
      FROM          
       LEDGER          
      WHERE          
       CLTCODE BETWEEN @FCODE AND @TCODE          
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18          
      GROUP BY          
       CLTCODE          
  UNION ALL  
  SELECT          
       CLTCODE,          
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL          
      FROM          
       LEDGER          
      WHERE          
       CLTCODE BETWEEN @FCODE AND @TCODE          
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18          
      GROUP BY          
       CLTCODE     
     UNION ALL          
      SELECT          
       CLTCODE,          
       SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL          
      FROM          
       LEDGER          
      WHERE          
       CLTCODE BETWEEN  @FCODE AND  @TCODE          
       AND VDT < @@OPENDATE          
       AND EDT >= @@OPENDATE          
       GROUP BY CLTCODE          
     ) T          
    GROUP BY CLTCODE          
    ORDER BY CLTCODE          
          
    INSERT INTO #TEMPTABLE_GL          
    SELECT          
     L.BOOKTYPE,          
     VOUDT1=L.VDT,          
     EFFDT1=L.EDT,          
     ISNULL(SHORTDESC,'') SHORTDESC,          
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),          
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),          
     L.VNO,          
     REPLACE( L.NARRATION,'"','') NARRATION,          
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),       
     L.CLTCODE,          
     A.LONGNAME,          
     VDT,          
     L.VTYP,          
     ACCAT,          
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     L.LNO          
    FROM          
     LEDGER L,          
     ACMAST A,          
     VMAST V          
    WHERE          
     VTYP = VTYPE          
     AND A.CLTCODE = L.CLTCODE          
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE          
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'          
     AND L.VTYP <> 18          
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')          
    ORDER BY          
     L.CLTCODE,          
     VOUDT1,          
     L.VTYP DESC,          
     L.VNO          
   END          
  ELSE          
   BEGIN          
    INSERT INTO #OPBAL          
    SELECT          
     CLTCODE,          
     SUM(OPBAL) OPBAL          
    FROM          
     (          
      SELECT          
       L2.CLTCODE,          
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL          
      FROM          
       LEDGER2 L2,          
       LEDGER L          
      WHERE          
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18  
       AND L.VNO=L2.VNO          
       AND L.VTYP=L2.VTYPE          
       AND L.BOOKTYPE=L2.BOOKTYPE          
       AND L.LNO=L2.LNO          
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE          
      GROUP BY          
       L2.CLTCODE          
      UNION ALL          
   SELECT          
       L2.CLTCODE,          
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL          
      FROM          
       LEDGER2 L2,          
       LEDGER L          
      WHERE          
       VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18  
       AND L.VNO=L2.VNO          
       AND L.VTYP=L2.VTYPE          
       AND L.BOOKTYPE=L2.BOOKTYPE          
       AND L.LNO=L2.LNO          
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE          
      GROUP BY          
       L2.CLTCODE          
      UNION ALL  
       SELECT          
        L2.CLTCODE,          
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL          
       FROM          
        LEDGER2 L2,          
        LEDGER L          
       WHERE          
        L.VNO=L2.VNO          
        AND L.VTYP=L2.VTYPE          
        AND L.BOOKTYPE=L2.BOOKTYPE          
        AND L.LNO=L2.LNO          
        AND VDT < @@OPENDATE          
        AND EDT >= @@OPENDATE          
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE          
       GROUP BY          
        L2.CLTCODE          
     ) T          
    GROUP BY          
     CLTCODE          
    ORDER BY          
     CLTCODE          
    INSERT INTO #TEMPTABLE_GL          
    SELECT          
     L.BOOKTYPE,          
     VOUDT1=L.VDT,          
     EFFDT1=L.EDT,          
     ISNULL(SHORTDESC,'') SHORTDESC,          
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),          
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),          
     L.VNO,          
     REPLACE(L.NARRATION,'"','') NARRATION,          
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),          
     L2.CLTCODE,          
     A.LONGNAME,          
     VDT,          
     L.VTYP,          
     ACCAT,       
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     L.LNO          
    FROM          
     LEDGER L,          
     VMAST V,          
     LEDGER2 L2,          
     ACMAST A,          
     COSTMAST C          
    WHERE          
     L.VNO = L2.VNO          
     AND L.VTYP = L2.VTYPE          
     AND L.BOOKTYPE = L2.BOOKTYPE          
     AND L.LNO = L2.LNO          
     AND A.CLTCODE = L2.CLTCODE          
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE          
     AND L.VTYP = V.VTYPE          
     AND A.ACCAT <> '4'          
     AND L2.CLTCODE=A.CLTCODE          
     AND COSTNAME = RTRIM(@BRANCH)          
     AND L2.VTYPE <> 18          
     AND L2.COSTCODE = C.COSTCODE          
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'          
    ORDER BY          
     L2.CLTCODE,          
     VOUDT1,          
     L.VTYP DESC,          
     L.VNO          
   END          
 END          
          
UPDATE          
 #TEMPTABLE_GL          
SET          
 OPBAL = L.OPBAL          
FROM          
 #OPBAL L          
WHERE          
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE          
          
UPDATE          
 #TEMPTABLE_GL          
SET          
 CROSAC = L.CLTCODE          
FROM          
 LEDGER L          
WHERE          
 L.VTYP IN('2','3')          
 AND #TEMPTABLE_GL.VTYP = L.VTYP          
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE          
 AND #TEMPTABLE_GL.VNO = L.VNO          
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE          
          
UPDATE          
 #TEMPTABLE_GL          
SET          
 BRANCHCODE = COSTNAME          
FROM          
 LEDGER2 L2,          
 COSTMAST C          
WHERE          
 #TEMPTABLE_GL.VNO = L2.VNO          
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE          
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE       
 AND #TEMPTABLE_GL.LNO = L2.LNO          
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE          
 AND L2.COSTCODE = C.COSTCODE      

DELETE #TEMPTABLE_GL WHERE  VTYP=18

INSERT INTO #TEMPTABLE_GL
 SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''            
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)     
       
SELECT          
 BOOKTYPE,          
 VOUDT = CONVERT(VARCHAR(11), VOUDT1, 103),          
 EFFDT = CONVERT(VARCHAR(11), EFFDT1, 103),          
 SHORTDESC,          
 DRAMT,          
 CRAMT,          
 VNO,          
 NARRATION,          
 DDNO,          
 CLTCODE,          
 LONGNAME,          
 VDT,          
 VTYP,          
 ACCAT,          
 OPBAL,          
 CROSAC,          
 ACNAME,          
 BRANCHCODE,          
 LNO          
FROM          
 #TEMPTABLE_GL          
ORDER BY          
 CLTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GLREPORT_OG
-- --------------------------------------------------

CREATE Proc [dbo].[rpt_Acc_GLREPORT_OG]    
 @sdate varchar(11),            /* As mmm dd yyyy */    
 @edate varchar(11),            /* As mmm dd yyyy */    
 @fdate varchar(11),            /* As mmm dd yyyy */    
 @tdate varchar(11),            /* As mmm dd yyyy */    
 @fcode varchar(10),    
 @tcode varchar(10),    
 @statusId varchar(30),    
 @statusname varchar(30),    
 @branch varchar(10),    
 @selectionby varchar(3),    
 @GroupBy varchar(10),    
 @Sortby varchar(50),    
 @reportname varchar(30),    
 @reportopt varchar(10)    
    
AS    
    
declare    
 @@opendate as varchar(11)    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18' and vdt <= @fdate     
    
    
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2    
    
Select    
 l.booktype,    
 voudt1=l.vdt,    
 effdt1=l.edt,    
 isnull(shortdesc,'') shortdesc,    
 dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),    
 cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),    
 l.vno,    
 Replace( l.narration,'"','') narration,    
 ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
 l.cltcode,    
 a.longname,    
 vdt,    
 l.vtyp,    
 accat,    
 Vamt as opbal,    
 crosac=l.cltcode,    
 isnull(a.acname,'') acname,    
 isnull(a.branchcode,'') branchcode,    
 lno    
into    
 #temptable_gl    
From    
 Ledger l,    
 Acmast a,    
 Vmast v    
where    
 1 = 2    
    
    
if @selectionby = 'vdt'    
 BEGIN    
  if rtrim(@branch) = '' or rtrim(@branch) = '%'    
   BEGIN    
    If @@opendate = @fdate    
    begin    
     Insert into #opbal    
     Select    
      cltcode,    
      sum(case drcr when 'D' then vamt else -vamt end) as opbal    
     from    
      ledger    
     where    
      cltcode between @fcode and @tcode    
      and vdt like @@opendate + '%' and vtyp = 18    
     Group by cltcode    
     Order by cltcode    
    end    
    else    
    begin    
     Insert into #opbal    
     Select    
      cltcode,    
      sum(case drcr when 'D' then vamt else -vamt end) as opbal    
     from    
      ledger    
     where    
      cltcode between @fcode and @tcode    
      and vdt >= @@opendate and vdt < @fdate    
     Group by cltcode    
     Order by cltcode    
    end    
    
    Insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=l.vdt,    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),    
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),    
     l.vno,    
     Replace( l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     Ledger l,    
     Acmast a,    
     Vmast v    
    Where    
     l.vdt between @fdate and @tdate + ' 23:59:59'    
     And vtyp = vtype    
     and l.cltcode = a.cltcode    
     and l.cltcode between @fcode and @tcode    
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')    
    Order by    
     l.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
  ELSE    
   BEGIN    
    insert into #opbal    
    Select    
     l2.cltcode,    
     sum(case l2.drcr when 'D' then camt else -camt end) as opbal    
    from    
     ledger2 l2,    
     ledger l    
    where    
     l2.cltcode between @fcode and @tcode    
     and l.vtyp=l2.vtype    
     and l.booktype=l2.booktype    
  and l.vno=l2.vno    
     and l.lno=l2.lno    
     and vdt between @@opendate and @fdate    
    Group by l2.cltcode    
    Order by l2.cltcode    
    
    insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=l.vdt,    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),    
     l.vno,    
     Replace( l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l2.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     ledger l,    
     vmast v,    
     ledger2 l2,    
     acmast a,    
     costmast c    
    Where    
     l.vdt between @fdate and @tdate + ' 23:59:59'    
     and l.vtyp = l2.vtype    
     and  l.vno = l2.vno    
     and l.lno = l2.lno    
     and l.booktype = l2.booktype    
     and l2.cltcode=a.cltcode    
     and l.vtyp = v.vtype    
     and l2.cltcode between @fcode and  @tcode    
     and a.accat <> '4'    
     and costname = rtrim(@branch)    
     and l2.costcode = c.costcode    
     and  l2.vtype <> 18    
    order by    
     l2.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
 END    
ELSE    
 BEGIN    
  if rtrim(@branch) = '' or rtrim(@branch) = '%'    
   BEGIN    
   If @@opendate = @fdate    
   begin    
    insert into #opbal    
    Select    
     cltcode,    
     sum(opbal) opbal    
    from    
     (    
      Select    
       Cltcode,    
       sum(case drcr when 'D' then vamt else -vamt end) as opbal    
      from    
       ledger    
      where    
       Cltcode between @fcode and @tcode    
       and vdt like @@opendate + '%' and vtyp = 18    
      Group by    
       Cltcode    
     union ALL    
      Select    
       cltcode,    
       sum(case drcr when 'C' then vamt else -vamt end) as opbal    
      from    
       ledger    
      Where    
       cltcode between  @fcode and  @tcode    
       and vdt < @@opendate    
       and edt >= @@opendate    
       Group by cltcode    
     ) t    
    Group by cltcode    
    Order by cltcode    
   end    
   else    
   begin    
    insert into #opbal    
    Select    
     cltcode,    
     sum(opbal) opbal    
    from    
     (    
      Select    
       Cltcode,    
       sum(case drcr when 'D' then vamt else -vamt end) as opbal    
      from    
       ledger    
      where    
       Cltcode between @fcode and @tcode    
       and edt >= @@opendate and edt < @fdate    
      Group by    
       Cltcode    
     union ALL    
      Select    
       cltcode,    
       sum(case drcr when 'C' then vamt else -vamt end) as opbal    
      from    
       ledger    
      Where    
       cltcode between  @fcode and  @tcode    
       and vdt < @@opendate    
       and edt >= @@opendate    
       Group by cltcode    
     ) t    
    Group by cltcode    
    Order by cltcode    
   end    
    
    insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=l.vdt,    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),    
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),    
     l.vno,    
     Replace( l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     Ledger l,    
     acmast a,    
     vmast v    
    Where    
     vtyp = vtype    
     and a.cltcode = l.cltcode    
     and l.cltcode between @fcode and @tcode    
     and  l.edt between @fdate and @tdate + ' 23:59:59'    
     and l.vtyp <> 18    
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')    
    order by    
     l.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
  ELSE    
   BEGIN    
    insert into #opbal    
    Select    
     cltcode,    
     sum(opbal) opbal    
    from    
     (    
      Select    
       l2.cltcode,    
       sum(case l2.drcr when 'D' then camt else -camt end) as opbal    
      from    
       ledger2 l2,    
       ledger l    
      where    
       vdt between @@opendate and @fdate    
       and l.vno=l2.vno    
       and l.vtyp=l2.vtype    
       and l.booktype=l2.booktype    
       and l.lno=l2.lno    
       and l2.cltcode between @fcode and @tcode    
      Group by    
       l2.cltcode    
      union ALL    
       Select    
        l2.cltcode,    
        sum(case l2.drcr when 'C' then camt else -camt end) as opbal    
       from    
        ledger2 l2,    
        ledger l    
       where    
        l.vno=l2.vno    
        and l.vtyp=l2.vtype    
        and l.booktype=l2.booktype    
        and l.lno=l2.lno    
        and vdt < @@opendate    
        and edt >= @@opendate    
        and l2.cltcode between @fcode and @tcode    
       Group by    
        l2.cltcode    
     ) t    
    Group by    
     cltcode    
    Order by    
     cltcode    
    insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=l.vdt,    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),    
     l.vno,    
     Replace(l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l2.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     ledger l,    
     vmast v,    
     ledger2 l2,    
     acmast a,    
     costmast c    
    Where    
     l.vno = l2.vno    
     and l.vtyp = l2.vtype    
     and l.booktype = l2.booktype    
     and l.lno = l2.lno    
     and a.cltcode = l2.cltcode    
     and l2.cltcode between @fcode and @tcode    
     And l.vtyp = v.vtype    
     and a.accat <> '4'    
     and l2.cltcode=a.cltcode    
     and costname = rtrim(@branch)    
     and l2.vtype <> 18    
     and l2.costcode = c.costcode    
     and  l.edt between @fdate and @tdate + ' 23:59:59'    
    order by    
     l2.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
 END    
    
Update    
 #temptable_gl    
set    
 opbal = l.opbal    
from    
 #opbal l    
where    
 #temptable_gl.cltcode = l.cltcode    
    
Update    
 #temptable_gl    
set    
 crosac = l.cltcode    
from    
 ledger l    
where    
 l.vtyp not in('15','21')    
 and #temptable_gl.vtyp = l.vtyp    
 and #temptable_gl.booktype = l.booktype    
 and #temptable_gl.vno = l.vno    
 and #temptable_gl.cltcode <> l.cltcode    
    
update    
 #temptable_gl    
set    
 branchcode = costname    
from    
 ledger2 l2,    
 costmast c    
where    
 #temptable_gl.vno = l2.vno    
 and #temptable_gl.vtyp = l2.vtype    
 and #temptable_gl.booktype = l2.booktype    
 and #temptable_gl.lno = l2.lno    
 and #temptable_gl.cltcode = l2.cltcode    
 and l2.costcode = c.costcode    
 
Select    
 booktype,    
 voudt = convert(varchar(11), voudt1, 103),    
 effdt = convert(varchar(11), effdt1, 103),    
 shortdesc,    
 dramt,    
 cramt,    
 vno,    
 narration,    
 ddno,    
 cltcode,    
 longname,    
 vdt,    
 vtyp,    
 accat,    
 opbal,    
 crosac,    
 acname,    
 branchcode,    
 lno    
from    
 #temptable_gl    
where     
 vtyp <> 18    
Order By    
 CltCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------
--  Proc To List Clients Acc To Login For The Db - Account
---------------------------------------------------------------------------------------------------------
--written By    :   Sgk
--date     :   Feb 05 2003
---------------------------------------------------------------------------------------------------------
--    Modification History
---------------------------------------------------------------------------------------------------------
-- .1 By : Sgk   On : Feb 05 2003
---------------------------------------------------------------------------------------------------------
Create Procedure Rpt_acc_listclient
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3)  -- Account Category
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
Set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  @Statusid = "broker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')" 
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections 
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--branch Login
If @Statusid = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode Like '" + @Statusname + "' Or Branchcode = 'All') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')" 
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If @Statusid = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If @Statusid = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Trader = S.Short_name  And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If @Statusid = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If @Statusid = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient_report
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------  
--  Proc To List Clients Acc To Login For The Db - Account  
---------------------------------------------------------------------------------------------------------  
--written By    :   Sgk  
--date     :   Feb 05 2003  
---------------------------------------------------------------------------------------------------------  
--    Modification History  
---------------------------------------------------------------------------------------------------------  
-- .1 By : Sgk   On : Feb 05 2003  
---------------------------------------------------------------------------------------------------------  
CREATE  Procedure Rpt_acc_listclient_report  
 @Statusid Varchar(15),   
 @Statusname Varchar(25),   
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search  
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.  
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.  
 @Accat Varchar(3)   -- Account Category  
As  
Declare  
@Strsql Varchar(2500),   
@@Inaccat Varchar(3)  
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))  
--set Default Values  
--set @Whattolookfor = @Whattolookfor + "%"  
/* Set @Booktype = @Booktype + "%" */  
--broker Login  
If  @Statusid = "broker"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " Cltcode, "  
 Set @Strsql = @Strsql + " Acname, "  
 Set @Strsql = @Strsql + " Branchcode "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "  
 If @Accat = 3    
  Set @Strsql = @Strsql + " (Accat In (3, 14, 18) )"    
 Else  
  Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"    
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " Cltcode, "  
 Set @Strsql = @Strsql + " Branchcode "  
End  
--branch Login  
If @Statusid = "branch"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " Cltcode, "  
 Set @Strsql = @Strsql + " Acname, "  
 Set @Strsql = @Strsql + " Branchcode "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " (Branchcode = '" + @Statusname + "' Or Branchcode = 'All') And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "  
 If @Accat = 3    
  Set @Strsql = @Strsql + " (Accat In (3, 14) )"    
 Else  
  Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"    
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " Cltcode, "  
 Set @Strsql = @Strsql + " Branchcode "  
End  
--sub-broker Login  
If @Statusid = "subbroker"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " A.Acname, "  
 Set @Strsql = @Strsql + " C1.Sub_broker "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast A, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Subbrokers S "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "  
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "  
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "  
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "  
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " C1.Sub_broker "  
End  
--trader Login  
If @Statusid = "trader"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " A.Acname, "  
 Set @Strsql = @Strsql + " C1.Trader "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast A, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Branches S "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "  
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "  
 Set @Strsql = @Strsql + " C1.Trader = S.Branch_cd And "  
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "  
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " C1.Trader "  
End  
--family Login  
If @Statusid = "family"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " A.Acname, "  
 Set @Strsql = @Strsql + " C1.Family "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast A, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "  
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "  
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "  
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " C1.Family "  
End  
If @Statusid = "client"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " A.Acname "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast A, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "  
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "  
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "  
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " A.Cltcode "  
End  
If @Statusid = "region"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " A.Acname "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast A, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "  
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "  
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "  
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " A.Cltcode "  
End  
If @Statusid = "area"  
Begin  
 Set @Strsql = "select "  
 Set @Strsql = @Strsql + "distinct "  
 Set @Strsql = @Strsql + " A.Cltcode, "  
 Set @Strsql = @Strsql + " A.Acname "  
 Set @Strsql = @Strsql + "from "  
 Set @Strsql = @Strsql + " Acmast A, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "  
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "  
 Set @Strsql = @Strsql + "where "  
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "  
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "  
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "  
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "  
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "  
 Set @Strsql = @Strsql + "order By "  
 Set @Strsql = @Strsql + " A.Cltcode "  
End  
 Set @Strsql = @Strsql + " Option  (Fast 10)"  
Print @Strsql  
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient_report_new
-- --------------------------------------------------

---------------------------------------------------------------------------------------------------------
--  Proc To List Clients Acc To Login For The Db - Account
---------------------------------------------------------------------------------------------------------
--written By    :   Sgk
--date     :   Feb 05 2003
---------------------------------------------------------------------------------------------------------
--    Modification History
---------------------------------------------------------------------------------------------------------
-- .1 By : Sgk   On : Feb 05 2003
---------------------------------------------------------------------------------------------------------
CREATE Procedure Rpt_acc_listclient_report_new
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3)  , -- Account Category
               @Rptorder Varchar(6)  -- Account Category
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
--set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  @Statusid = "broker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "
 Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"  
            If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " Cltcode, "
  Set @Strsql = @Strsql + " Branchcode "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " Acname, "
  Set @Strsql = @Strsql + " Branchcode "
              End 
End
--branch Login
If @Statusid = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode = '" + @Statusname + "' Or Branchcode = 'All') And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "
 Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"
 /*set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "*/
   If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " Cltcode, "
  Set @Strsql = @Strsql + " Branchcode "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " Acname, "
  Set @Strsql = @Strsql + " Branchcode "
              End 
End
--sub-broker Login
If @Statusid = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 /*set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "*/
   If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Cltcode, "
  Set @Strsql = @Strsql + " C1.Sub_broker "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Acname, "
  Set @Strsql = @Strsql + " C1.Sub_broker "
              End 
End
--trader Login
If @Statusid = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Branch_cd = S.Branch_cd And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
          
 /*set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "*/
   If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Cltcode, "
  Set @Strsql = @Strsql + " C1.Trader "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Acname, "
  Set @Strsql = @Strsql + " C1.Trader  "
              End 
             
End
--family Login
If @Statusid = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 /*set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "*/
  If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Cltcode, "
  Set @Strsql = @Strsql + " C1.Family   "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Acname, "
  Set @Strsql = @Strsql + " C1.Family   "
              End 
End
If @Statusid = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And"
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 /*set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "*/
  If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Cltcode "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Acname "
              End 
End
If @Statusid = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " Msajag.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Area Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 /*set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "*/
  If @Rptorder =  "accode"
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Cltcode "
              End
           Else
              Begin
  Set @Strsql = @Strsql + "order By "
  Set @Strsql = @Strsql + " A.Acname "
              End 
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_LISTCLIENT_REPORT_ONLYBAL
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[RPT_ACC_LISTCLIENT_REPORT_ONLYBAL]    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),    
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH    
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.    
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.    
 @ACCAT VARCHAR(3),   -- ACCOUNT CATEGORY    
 @FRDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @SDTDATE VARCHAR(11)  
    
AS  
  
CREATE TABLE #CLIENTS  
(  
 CLTCODE VARCHAR(10)  
)  
  
INSERT INTO #CLIENTS  
SELECT DISTINCT CLTCODE FROM   
(  
 SELECT   
  CLTCODE   
 FROM   
  LEDGER  
 WHERE   
  VDT >= @SDTDATE AND VDT < @FRDATE  
  AND CLTCODE BETWEEN @WHATTOLOOKFOR AND @COMPARETOWHAT  
 GROUP BY   
  CLTCODE  
 HAVING   
  SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) <> 0  
  
 UNION ALL  
  
 SELECT   
  CLTCODE   
 FROM   
  LEDGER  
 WHERE   
  VDT >= @FRDATE AND VDT <= @TODATE  
  AND CLTCODE BETWEEN @WHATTOLOOKFOR AND @COMPARETOWHAT  
 GROUP BY   
  CLTCODE  
 HAVING   
  COUNT(1) > 0  
) L    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
DECLARE    
@STRSQL VARCHAR(2500),    
@@INACCAT VARCHAR(3)    
    
SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR,CONVERT(INT,@ACCAT)+100,3))    
    
--SET DEFAULT VALUES    
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"    
/* SET @BOOKTYPE = @BOOKTYPE + "%" */    
    
--BROKER LOGIN    
IF  @STATUSID="BROKER"    
BEGIN    
 SET @STRSQL = "SELECT "    
 SET @STRSQL = @STRSQL + "DISTINCT "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " ACNAME, "    
 SET @STRSQL = @STRSQL + " BRANCHCODE "    
 SET @STRSQL = @STRSQL + "FROM "    
 SET @STRSQL = @STRSQL + " ACMAST A, #CLIENTS C "    
 SET @STRSQL = @STRSQL + "WHERE "    
 SET @STRSQL = @STRSQL + " A.CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "    
 SET @STRSQL = @STRSQL + " A.CLTCODE <= '" + @COMPARETOWHAT + "' AND "    
 SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')"      
 SET @STRSQL = @STRSQL + " AND A.CLTCODE = C.CLTCODE "  
 SET @STRSQL = @STRSQL + "ORDER BY "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " BRANCHCODE "    
END    
    
--BRANCH LOGIN    
IF @STATUSID="BRANCH"    
BEGIN    
 SET @STRSQL = "SELECT "    
 SET @STRSQL = @STRSQL + "DISTINCT "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " ACNAME, "    
 SET @STRSQL = @STRSQL + " BRANCHCODE "    
 SET @STRSQL = @STRSQL + "FROM "    
 SET @STRSQL = @STRSQL + " ACMAST A, #CLIENTS C "    
 SET @STRSQL = @STRSQL + "WHERE "    
    
 SET @STRSQL = @STRSQL + " A.CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "    
 SET @STRSQL = @STRSQL + " (BRANCHCODE = '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND "    
 SET @STRSQL = @STRSQL + " A.CLTCODE <= '" + @COMPARETOWHAT + "' AND "    
 SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')"    
 SET @STRSQL = @STRSQL + " AND A.CLTCODE = C.CLTCODE "    
    
 SET @STRSQL = @STRSQL + "ORDER BY "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " BRANCHCODE "    
END    
    
--SUB-BROKER LOGIN    
IF @STATUSID="SUBBROKER"    
BEGIN    
 SET @STRSQL = "SELECT "    
 SET @STRSQL = @STRSQL + "DISTINCT "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " A.ACNAME, "    
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "    
 SET @STRSQL = @STRSQL + "FROM "    
 SET @STRSQL = @STRSQL + " ACMAST A, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT1 C1, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT2 C2, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.SUBBROKERS S, #CLIENTS C "    
 SET @STRSQL = @STRSQL + "WHERE "    
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "    
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "    
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER = S.SUB_BROKER AND "    
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "    
 SET @STRSQL = @STRSQL + " CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "    
 SET @STRSQL = @STRSQL + " CLTCODE <= '" + @COMPARETOWHAT + "' "    
 SET @STRSQL = @STRSQL + " AND C2.PARTY_CODE = C.CLTCODE "  
 SET @STRSQL = @STRSQL + "ORDER BY "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "    
END    
    
--REGION     
    
IF @STATUSID="REGION"      
BEGIN      
 SET @STRSQL = "SELECT "      
 SET @STRSQL = @STRSQL + "DISTINCT "      
 SET @STRSQL = @STRSQL + " A.CLTCODE, "      
 SET @STRSQL = @STRSQL + " A.ACNAME, "      
 SET @STRSQL = @STRSQL + " C1.REGION "      
 SET @STRSQL = @STRSQL + "FROM "      
 SET @STRSQL = @STRSQL + " ACMAST A, "      
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT1 C1, "      
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT2 C2, "      
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.REGION S, #CLIENTS C "      
 SET @STRSQL = @STRSQL + "WHERE "      
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "      
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "      
 SET @STRSQL = @STRSQL + " C1.REGION = S.REGIONCODE AND "      
 SET @STRSQL = @STRSQL + " C1.REGION LIKE '" + @STATUSNAME + "' AND "      
 SET @STRSQL = @STRSQL + " CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "      
 SET @STRSQL = @STRSQL + " CLTCODE <= '" + @COMPARETOWHAT + "' "      
 SET @STRSQL = @STRSQL + " AND C2.PARTY_CODE = C.CLTCODE "  
 SET @STRSQL = @STRSQL + "ORDER BY "      
 SET @STRSQL = @STRSQL + " A.CLTCODE, "      
 SET @STRSQL = @STRSQL + " C1.REGION "      
END      
     
    
    
--TRADER LOGIN    
IF @STATUSID="TRADER"    
BEGIN    
 SET @STRSQL = "SELECT "    
 SET @STRSQL = @STRSQL + "DISTINCT "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " A.ACNAME, "    
 SET @STRSQL = @STRSQL + " C1.TRADER "    
 SET @STRSQL = @STRSQL + "FROM "    
 SET @STRSQL = @STRSQL + " ACMAST A, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT1 C1, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT2 C2, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.BRANCHES S, #CLIENTS C "    
 SET @STRSQL = @STRSQL + "WHERE "    
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "    
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "    
 SET @STRSQL = @STRSQL + " C1.TRADER = S.SHORT_NAME AND "    
 SET @STRSQL = @STRSQL + " C1.TRADER LIKE '" + @STATUSNAME + "' AND "    
 SET @STRSQL = @STRSQL + " CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "    
 SET @STRSQL = @STRSQL + " CLTCODE <= '" + @COMPARETOWHAT + "' "    
 SET @STRSQL = @STRSQL + " AND C2.PARTY_CODE = C.CLTCODE "  
 SET @STRSQL = @STRSQL + "ORDER BY "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " C1.TRADER "    
END    
    
--FAMILY LOGIN    
IF @STATUSID="FAMILY"    
BEGIN    
 SET @STRSQL = "SELECT "    
 SET @STRSQL = @STRSQL + "DISTINCT "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " A.ACNAME, "    
 SET @STRSQL = @STRSQL + " C1.FAMILY "    
 SET @STRSQL = @STRSQL + "FROM "    
 SET @STRSQL = @STRSQL + " ACMAST A, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT1 C1, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT2 C2, #CLIENTS C "    
 SET @STRSQL = @STRSQL + "WHERE "    
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "    
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "    
 SET @STRSQL = @STRSQL + " C1.FAMILY LIKE '" + @STATUSNAME + "' AND "    
 SET @STRSQL = @STRSQL + " CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "    
 SET @STRSQL = @STRSQL + " CLTCODE <= '" + @COMPARETOWHAT + "' "    
 SET @STRSQL = @STRSQL + " AND C2.PARTY_CODE = C.CLTCODE "  
 SET @STRSQL = @STRSQL + "ORDER BY "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " C1.FAMILY "    
END    
    
IF @STATUSID="CLIENT"    
BEGIN    
 SET @STRSQL = "SELECT "    
 SET @STRSQL = @STRSQL + "DISTINCT "    
 SET @STRSQL = @STRSQL + " A.CLTCODE, "    
 SET @STRSQL = @STRSQL + " A.ACNAME "    
 SET @STRSQL = @STRSQL + "FROM "    
 SET @STRSQL = @STRSQL + " ACMAST A, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT1 C1, "    
 SET @STRSQL = @STRSQL + " MSAJAG.DBO.CLIENT2 C2, #CLIENTS C "    
 SET @STRSQL = @STRSQL + "WHERE "    
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "    
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "    
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @STATUSNAME + "' "    
 SET @STRSQL = @STRSQL + " AND C2.PARTY_CODE = C.CLTCODE "  
 SET @STRSQL = @STRSQL + "ORDER BY "    
 SET @STRSQL = @STRSQL + " A.CLTCODE "    
END    
    
 SET @STRSQL = @STRSQL + " OPTION  (FAST 10)"    
    
PRINT @STRSQL    
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_Marginledger
-- --------------------------------------------------
/*USE ACCOUNT    
EXEC RPT_ACC_PARTYLEDGER_ALL 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'    
EXEC RPT_ACC_MARGINLEDGER 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'*/    
 --EXEC RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''          
          
--EXEC RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''            
 /*                          
 PROC NAME RPT_ACC_PARTYLEDGER                          
 PARAMETERS FDATE - FROM DATE                          
            TDATE - DATE TO                          
            FCODE - AC CODE FROM                          
            TCODE - AC CODE TO                          
            STRORDER - PRINTING ORDER, POSSIBLE VAUES  ACCODE , ACNAME                          
            SELECTBY - REPORT SELECTION BY , POSSIBLE VALUES VDT, EDT                          
            STATUSID - POSSIBLEVALUES 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'                          
*/                          
               
CREATE PROCEDURE [DBO].[RPT_ACC_MARGINLEDGER]                          
                           
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@FCODE VARCHAR(10),                          
@TCODE VARCHAR(10),                          
@STRORDER VARCHAR(6),                          
@SELECTBY VARCHAR(3),                          
@STATUSID VARCHAR(15),                          
@STATUSNAME VARCHAR(15),                          
@STRBRANCH VARCHAR(10)                          
AS                          
                          
DECLARE @@OPENDATE   AS VARCHAR(11)                          
                    
CREATE TABLE [DBO].[#MARGINLEDGERDATA] (                            
  [BOOKTYPE] [CHAR] (2) NULL ,                            
  [VOUDT] [DATETIME] NULL ,                            
  [EFFDT] [DATETIME] NULL ,                            
  [ACNAME] [VARCHAR] (100) NULL ,                  
  [SHORTDESC] [CHAR] (6) NULL ,                              
  [DRCR] [CHAR] (1) NULL ,                            
  [AMOUNT] [MONEY] NULL ,                            
  [VNO] [VARCHAR] (12) NULL ,                            
  [DDNO] [VARCHAR] (12) NULL ,                            
  [NARRATION] [VARCHAR] (234) NULL ,                            
  [PARTY_CODE] [VARCHAR] (10) NOT NULL ,                            
  [VTYP] [SMALLINT] NULL ,                            
  [VDT] [VARCHAR] (30) NULL ,                            
  [EDT] [VARCHAR] (30) NULL ,                                        
  [LNO] [DECIMAL](5, 0) NULL,        
  [PDT] [DATETIME] NULL        
 ) ON [PRIMARY]                            
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
                  
        
                  
                  
                  
SELECT @@OPENDATE = SDTCUR FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR          
                          
/*GETTING LAST OPENING DATE */                          
/*IF UPPER(@SELECTBY) = 'VDT'                          
 BEGIN                          
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                          
 END                          
ELSE                          
 BEGIN                          
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                          
 END                */          
                          
/*CREATING BLANK TABLE FOR OPENING BALANCE*/                          
SELECT CLTCODE=PARTY_CODE,OPPBAL=AMOUNT INTO #OPPBALANCE FROM MARGINLEDGER WHERE 1=2                          
                          
/*GETTING OPENING BALANCE*/                          
IF @SELECTBY = 'VDT'                          
BEGIN                          
 IF @@OPENDATE = @FDATE      
 BEGIN                          
  INSERT INTO  #OPPBALANCE                           
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                          
  FROM MARGINLEDGER                           
  WHERE PARTY_CODE >= @FCODE AND PARTY_CODE <=@TCODE AND  VDT LIKE @FDATE + '%' AND VTYP = 18                           
  GROUP BY PARTY_CODE                          
 END                          
 ELSE                          
 BEGIN                          
  INSERT INTO  #OPPBALANCE                           
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                            
  FROM MARGINLEDGER                           
  WHERE PARTY_CODE >=@FCODE AND PARTY_CODE <= @TCODE  AND  VDT >=  @@OPENDATE + ' 00:00:00' AND VDT < @FDATE                           
  GROUP BY PARTY_CODE                          
 END                          
END                           
ELSE                          
BEGIN                           
 IF @@OPENDATE = @FDATE                           
 BEGIN        INSERT INTO  #OPPBALANCE                        
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                      
  FROM MARGINLEDGER                       
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                      
  GROUP BY PARTY_CODE                      
 END                        
 ELSE                        
 BEGIN                        
  INSERT INTO  #OPPBALANCE                           
  SELECT CLTCODE, OPBAL=SUM(OPBAL)                      
  FROM                      
  (                     
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                      
  FROM MARGINLEDGER                       
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                      
  GROUP BY PARTY_CODE                      
  UNION ALL                      
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)                      
  FROM MARGINLEDGER                       
  WHERE PARTY_CODE = @FCODE AND VDT >= @@OPENDATE + ' 00:00:00' AND VDT < @FDATE AND VTYP <> 18                      
  GROUP BY PARTY_CODE) T                      
  GROUP BY CLTCODE                      
 END                        
END                          
                    
          
                    
IF @SELECTBY = 'VDT'                    
BEGIN                    
 INSERT INTO #MARGINLEDGERDATA                    
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                     
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                     
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                     
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                   
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                     
  WHERE L.VDT >= @FDATE + ' 00:00:00' AND L.VDT <= @TDATE + ' 23:59:59'                    
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                     
END                    
ELSE                    
BEGIN                    
  INSERT INTO #MARGINLEDGERDATA                    
  SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                     
  M.VNO,DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                   
 L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT        
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                   
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                     
  WHERE L.EDT >= @FDATE + ' 00:00:00' AND L.EDT <= @TDATE + ' 23:59:59'                    
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                     
END                    
                    
                          
/*GETTING CLIENT LIST*/                          
SELECT C2.PARTY_CODE,BANK_NAME =ISNULL(C4.BANKID,''),                          
L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,C1.BRANCH_CD,                  
FAMILY,C1.SUB_BROKER,TRADER,CL_TYPE,CLTDPID =ISNULL(CLTDPID,'')                          
                          
INTO #LEDGERCLIENTS                          
                          
FROM MSAJAG.DBO.CLIENT1 C1 ,MSAJAG.DBO.CLIENT2 C2 LEFT OUTER JOIN MSAJAG.DBO.CLIENT4  C4 ON                          
(C2.PARTY_CODE=C4.PARTY_CODE  AND  DEPOSITORY NOT IN ('NSDL','CDSL')  AND  DEFDP=1)                          
WHERE C1.CL_CODE=C2.CL_CODE                          
AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)                          
AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUB_BROKER' THEN @STATUSNAME ELSE  '%' END)                          
AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)                          
AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE  '%' END)                          
AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE  '%' END)                          
AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                          
AND C2.PARTY_CODE >= @FCODE AND C2.PARTY_CODE <= @TCODE               
                     
                          
/*GETTING LDDGER ENTRIES*/                          
SELECT M.BOOKTYPE, M.VOUDT, M.EFFDT, M.SHORTDESC,                           
DRAMT=(CASE WHEN UPPER(M.DRCR) = 'D' THEN M.AMOUNT ELSE 0 END),                            
CRAMT=(CASE WHEN UPPER(M.DRCR) = 'C' THEN M.AMOUNT ELSE 0 END),                          
M.VNO, M.DDNO, M.NARRATION, C.PARTY_CODE CLTCODE,M.VTYP, M.VDT,                           
M.EDT, M.ACNAME , OPBAL = AMOUNT,                           
C.L_ADDRESS1,C.L_ADDRESS2,C.L_ADDRESS3,C.L_CITY,C.L_ZIP,C.RES_PHONE1,C.BRANCH_CD, M.PARTY_CODE CROSAC ,                       
EDIFF=DATEDIFF(D,M.EFFDT,GETDATE()), C.FAMILY,C.SUB_BROKER,C.TRADER,C.CL_TYPE,                          
C.BANK_NAME,C.CLTDPID, M.LNO, M.PDT                                 
INTO  #TMPMLEDGER                                 
FROM  #MARGINLEDGERDATA M RIGHT OUTER JOIN #LEDGERCLIENTS C ON (M.PARTY_CODE=C.PARTY_CODE)                          
            
/*UPDATING OPENING BLANACE*/                          
UPDATE #TMPMLEDGER SET OPBAL = 0                          
UPDATE #TMPMLEDGER SET OPBAL = T.OPPBAL FROM #TMPMLEDGER M,#OPPBALANCE T WHERE M.CLTCODE = T.CLTCODE                          
                    
                          
/*UPDATING BANK NAME*/                                         
UPDATE  #TMPMLEDGER SET #TMPMLEDGER.BANK_NAME= B.BANK_NAME  FROM                          
MSAJAG.DBO.POBANK  B WHERE LTRIM(RTRIM(CAST(B.BANKID  AS CHAR))) = LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                          
                      
UPDATE  #TMPMLEDGER SET #TMPMLEDGER.ACNAME= A.ACNAME  FROM                          
ACMAST A WHERE LTRIM(RTRIM(A.CLTCODE)) = LTRIM(RTRIM(#TMPMLEDGER.CLTCODE))                          
            
          
                      
IF @STRORDER = 'ACCODE'                          
 BEGIN                          
  IF @SELECTBY = 'VDT'                          
   BEGIN                           
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.CLTCODE,VOUDT                          
   END                          
  ELSE                          
   BEGIN                          
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A   WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.CLTCODE,EFFDT                          
   END                          
 END     
ELSE                          
  BEGIN                          
   IF @SELECTBY = 'VDT'                          
    BEGIN                           
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A   WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.ACNAME,VOUDT                          
    END                          
   ELSE                          
    BEGIN                          
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.ACNAME,EFFDT                          
    END                          
  END                          
                          
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_MARGINLEDGER_COMM
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[RPT_ACC_MARGINLEDGER_COMM]                              
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
@FCODE VARCHAR(10),                              
@TCODE VARCHAR(10),                              
@STRORDER VARCHAR(6),                              
@SELECTBY VARCHAR(3),                              
@STATUSID VARCHAR(15),                              
@STATUSNAME VARCHAR(15),                              
@STRBRANCH VARCHAR(10)                              
AS                              
                              
DECLARE @@OPENDATE   AS VARCHAR(11)                              
    
-------------------------------------------------      
-- CREATING TEMPORARY TABLE      
-------------------------------------------------      
CREATE TABLE #OPPBALANCE      
(      
 CLTCODE VARCHAR(10),      
 OPPBAL MONEY      
)      
      
CREATE TABLE #LEDGERCLIENTS (      
	 [PARTY_CODE] [CHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
	 [BANK_NAME] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
	 [L_ADDRESS1] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
	 [L_ADDRESS2] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [L_ADDRESS3] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [L_CITY] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [L_ZIP] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [RES_PHONE1] [VARCHAR](15) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [BRANCH_CD] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [FAMILY] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
	 [SUB_BROKER] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
	 [TRADER] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
	 [CL_TYPE] [VARCHAR](3) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
	 [CLTDPID] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL    
)      
      
CREATE TABLE #LEDGERDATA (      
	 [VTYP] [SMALLINT] NOT NULL,      
	 [VNO] [VARCHAR](12) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,      
	 [EDT] [DATETIME] NULL,      
	 [LNO] [INT] NOT NULL,      
	 [ACNAME] [VARCHAR](100) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,      
	 [DRCR] [CHAR](1) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,      
	 [VAMT] [MONEY] NULL,      
	 [VDT] [DATETIME] NULL,      
	 [VNO1] [VARCHAR](12) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,      
	 [REFNO] [CHAR](12) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,      
	 [BALAMT] [MONEY] NOT NULL,      
	 [NODAYS] [INT] NULL,      
	 [CDT] [DATETIME] NULL,      
	 [CLTCODE] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,   
	 [BOOKTYPE] [CHAR](2) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,      
	 [ENTEREDBY] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,      
	 [PDT] [DATETIME] NULL,      
	 [CHECKEDBY] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,      
	 [ACTNODAYS] [INT] NULL,      
	 [NARRATION] [VARCHAR](234) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,      
	 [SHORTDESC] [VARCHAR](35) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL      
)      
    
                        
CREATE TABLE [DBO].[#MARGINLEDGERDATA] (                                
  [BOOKTYPE] [CHAR] (2) NULL ,                                
  [VOUDT] [DATETIME] NULL ,                                
  [EFFDT] [DATETIME] NULL ,                                
  [ACNAME] [VARCHAR] (100) NULL ,                      
  [SHORTDESC] [CHAR] (6) NULL ,                                  
  [DRCR] [CHAR] (1) NULL ,                                
  [AMOUNT] [MONEY] NULL ,                                
  [VNO] [VARCHAR] (12) NULL ,                                
  [DDNO] [VARCHAR] (12) NULL ,                                
  [NARRATION] [VARCHAR] (234) NULL ,                                
  [PARTY_CODE] [VARCHAR] (10) NOT NULL ,                                
  [VTYP] [SMALLINT] NULL ,                                
  [VDT] [VARCHAR] (30) NULL ,                                
  [EDT] [VARCHAR] (30) NULL ,                                            
  [LNO] [DECIMAL](5, 0) NULL,            
  [PDT] [DATETIME] NULL            
 )    
    
CREATE TABLE #TMPMLEDGER (    
 [BOOKTYPE] [CHAR](2) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [VOUDT] [DATETIME] NULL,    
 [EFFDT] [DATETIME] NULL,    
 [SHORTDESC] [CHAR](6) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [DRAMT] [MONEY] NULL,    
 [CRAMT] [MONEY] NULL,    
 [VNO] [VARCHAR](12) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [DDNO] [VARCHAR](12) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [NARRATION] [VARCHAR](234) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [CLTCODE] [CHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [VTYP] [SMALLINT] NULL,    
 [VDT] [VARCHAR](30) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [EDT] [VARCHAR](30) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [ACNAME] [VARCHAR](100) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [OPBAL] [MONEY] NULL,    
 [L_ADDRESS1] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [L_ADDRESS2] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [L_ADDRESS3] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [L_CITY] [VARCHAR](40) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [L_ZIP] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [RES_PHONE1] [VARCHAR](15) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [BRANCH_CD] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [CROSAC] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [EDIFF] [INT] NULL,    
 [FAMILY] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [SUB_BROKER] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [TRADER] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,    
 [CL_TYPE] [VARCHAR](3) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [BANK_NAME] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [CLTDPID] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NOT NULL,    
 [LNO] [DECIMAL](5, 0) NULL,    
 [PDT] [DATETIME] NULL    
)     
-------------------------------------------------      
-- CREATING TEMPORARY TABLES      
-------------------------------------------------      
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                      
SELECT @@OPENDATE = SDTCUR FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR              
                              
/*GETTING OPENING BALANCE*/                              
IF @SELECTBY = 'VDT'                
BEGIN                              
 IF @@OPENDATE = @FDATE          
 BEGIN                              
  INSERT INTO  #OPPBALANCE                               
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)       
  FROM MARGINLEDGER                               
  WHERE PARTY_CODE >= @FCODE AND PARTY_CODE <=@TCODE AND  VDT LIKE @FDATE + '%' AND VTYP = 18                               
  GROUP BY PARTY_CODE                              
 END                              
 ELSE                              
 BEGIN                              
  INSERT INTO  #OPPBALANCE                               
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                                
  FROM MARGINLEDGER                               
  WHERE PARTY_CODE >=@FCODE AND PARTY_CODE <= @TCODE  AND  VDT >=  @@OPENDATE + ' 00:00:00' AND VDT < @FDATE                               
  GROUP BY PARTY_CODE                              
 END                              
END                               
ELSE                              
BEGIN                               
 IF @@OPENDATE = @FDATE                               
 BEGIN        INSERT INTO  #OPPBALANCE                            
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                          
  FROM MARGINLEDGER                           
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                          
  GROUP BY PARTY_CODE                          
 END                            
 ELSE                            
 BEGIN                            
  INSERT INTO  #OPPBALANCE                               
  SELECT CLTCODE, OPBAL=SUM(OPBAL)                          
  FROM                          
  (                         
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                          
  FROM MARGINLEDGER                           
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                          
  GROUP BY PARTY_CODE                          
  UNION ALL                          
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)                          
  FROM MARGINLEDGER                           
  WHERE PARTY_CODE = @FCODE AND VDT >= @@OPENDATE + ' 00:00:00' AND VDT < @FDATE AND VTYP <> 18                          
  GROUP BY PARTY_CODE) T                          
  GROUP BY CLTCODE                          
 END                            
END                              
                        
              
                        
IF @SELECTBY = 'VDT'                        
BEGIN                        
 INSERT INTO #MARGINLEDGERDATA                        
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                         
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                         
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                         
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                       
  AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                         
  WHERE L.VDT >= @FDATE + ' 00:00:00' AND L.VDT <= @TDATE + ' 23:59:59'                        
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                         
END                        
ELSE                        
BEGIN                        
  INSERT INTO #MARGINLEDGERDATA                        
  SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                         
  M.VNO,DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                       
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT            
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                       
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                         
  WHERE L.EDT >= @FDATE + ' 00:00:00' AND L.EDT <= @TDATE + ' 23:59:59'                        
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                         
END                        
                        
                              
/*GETTING CLIENT LIST*/                              
INSERT INTO #LEDGERCLIENTS     
SELECT C2.PARTY_CODE,BANK_NAME =ISNULL(C4.BANKID,''),                              
L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,C1.BRANCH_CD,                      
FAMILY,C1.SUB_BROKER,TRADER,CL_TYPE,CLTDPID =ISNULL(CLTDPID,'')                              
FROM MSAJAG.DBO.CLIENT1 C1 ,MSAJAG.DBO.CLIENT2 C2 LEFT OUTER JOIN MSAJAG.DBO.CLIENT4  C4 ON                              
(C2.PARTY_CODE=C4.PARTY_CODE  AND  DEPOSITORY NOT IN ('NSDL','CDSL')  AND  DEFDP=1)                              
WHERE C1.CL_CODE=C2.CL_CODE                              
AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)                              
AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUB_BROKER' THEN @STATUSNAME ELSE  '%' END)                              
AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)                              
AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE  '%' END)                              
AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE  '%' END)                              
AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                              
AND C2.PARTY_CODE >= @FCODE AND C2.PARTY_CODE <= @TCODE                   
                         
     
/*GETTING LDDGER ENTRIES*/                              
INSERT INTO #TMPMLEDGER    
SELECT M.BOOKTYPE, M.VOUDT, M.EFFDT, M.SHORTDESC,                               
DRAMT=(CASE WHEN UPPER(M.DRCR) = 'D' THEN M.AMOUNT ELSE 0 END),                                
CRAMT=(CASE WHEN UPPER(M.DRCR) = 'C' THEN M.AMOUNT ELSE 0 END),                              
M.VNO, M.DDNO, M.NARRATION, C.PARTY_CODE CLTCODE,M.VTYP, M.VDT,                               
M.EDT, M.ACNAME , OPBAL = AMOUNT,                               
C.L_ADDRESS1,C.L_ADDRESS2,C.L_ADDRESS3,C.L_CITY,C.L_ZIP,C.RES_PHONE1,C.BRANCH_CD, M.PARTY_CODE CROSAC ,                           
EDIFF=DATEDIFF(D,M.EFFDT,GETDATE()), C.FAMILY,C.SUB_BROKER,C.TRADER,C.CL_TYPE,                              
C.BANK_NAME,C.CLTDPID, M.LNO, M.PDT                                     
FROM  #MARGINLEDGERDATA M RIGHT OUTER JOIN #LEDGERCLIENTS C ON (M.PARTY_CODE=C.PARTY_CODE)                              
            
    
/*UPDATING OPENING BLANACE*/                              
UPDATE #TMPMLEDGER SET OPBAL = 0                              
UPDATE #TMPMLEDGER SET OPBAL = T.OPPBAL FROM #TMPMLEDGER M,#OPPBALANCE T WHERE M.CLTCODE = T.CLTCODE                              
                        
                              
/*UPDATING BANK NAME*/                                             
/*UPDATE  #TMPMLEDGER SET #TMPMLEDGER.BANK_NAME= B.BANK_NAME  FROM                              
MSAJAG.DBO.POBANK  B WHERE LTRIM(RTRIM(CAST(B.BANKID  AS CHAR))) = LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                        */      
                          
UPDATE  #TMPMLEDGER SET #TMPMLEDGER.ACNAME= A.ACNAME  FROM                              
ACMAST A WHERE LTRIM(RTRIM(A.CLTCODE)) = LTRIM(RTRIM(#TMPMLEDGER.CLTCODE))                              
                
              
                        
IF @STRORDER = 'ACCODE'                              
 BEGIN                              
  IF @SELECTBY = 'VDT'                              
   BEGIN                               
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.CLTCODE,VOUDT                              
   END                              
  ELSE                              
   BEGIN                              
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A   WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.CLTCODE,EFFDT                              
   END                              
 END         
ELSE                              
  BEGIN                              
   IF @SELECTBY = 'VDT'                              
    BEGIN                               
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A   WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.ACNAME,VOUDT                              
    END                              
   ELSE                              
    BEGIN                              
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.ACNAME,EFFDT                              
    END                              
  END                              
                              
/*  ------------------------------   END OF THE PROC  -------------------------------------*/                              
                              
                            
-------------------------------------------------      
-- DESTROYING TEMPORARY TABLE      
-------------------------------------------------      
TRUNCATE TABLE #OPPBALANCE                            
TRUNCATE TABLE #LEDGERCLIENTS      
TRUNCATE TABLE #LEDGERDATA      
TRUNCATE TABLE #TMPMLEDGER    
      
DROP TABLE #OPPBALANCE      
DROP TABLE #LEDGERCLIENTS                        
DROP TABLE #LEDGERDATA                      
DROP TABLE #TMPMLEDGER    
-------------------------------------------------      
-- DESTROYING TEMPORARY TABLE      
-------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger
-- --------------------------------------------------


      
      
--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'        
        
        
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''              
              
CREATE PROCEDURE [dbo].[rpt_acc_partyledger]              
(                
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE VARCHAR(10),                      
 @TCODE VARCHAR(10),                      
 @STRORDER VARCHAR(8),                      
 @SELECTBY VARCHAR(3),                      
 @STATUSID VARCHAR(15),                      
 @STATUSNAME VARCHAR(15),                      
 @STRBRANCH VARCHAR(10),      
 @FORPDF VARCHAR(1) = 'N'      
)                
                
AS               
        
DECLARE                      
 @@REPTYPE VARCHAR(1),        
 @@STRORDER VARCHAR(6)        
        
        
SELECT @@REPTYPE = .DBO.PIECE(@STRORDER, '~', 2)        
SELECT @@STRORDER = .DBO.PIECE(@STRORDER, '~', 1)        
        
IF @@REPTYPE = 'P'        
BEGIN        
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH        
 RETURN        
END        
        
        
                      
/*========================================================================                
      EXEC RPT_ACC_PARTYLEDGER_ALL                 
            'NOV  1 2005',                
            'DEC 31 2005',                
            'A',                
            'ZZZ',                
            'ACCODE',                
            'VDT',                
            'BROKER',                
            'UNDEFINED',                
            ''                
========================================================================*/                
                
DECLARE                 
 @@OPENDATE   AS VARCHAR(11)                      
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                      
                      
/*GETTING LAST OPENING DATE */                      
      IF UPPER(@SELECTBY) = 'VDT'                      
      BEGIN                      
            SELECT                 
                  @@OPENDATE =                 
                  (                 
                        SELECT                 
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11)                 
                        FROM LEDGER WITH(NOLOCK)                 
                        WHERE VTYP = 18                 
                              AND VDT < = @FDATE                 
                  )                 
      END                      
      ELSE                      
      BEGIN                      
            SELECT                 
                  @@OPENDATE =                 
                  (                 
                        SELECT                 
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)                 
                        FROM LEDGER WITH(NOLOCK)                 
                        WHERE VTYP = 18                 
                              AND EDT < = @FDATE                 
                  )                 
      END                      
                            
                      
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                      
            SELECT                 
                  CLTCODE,                 
                  OPPBAL = VAMT                 
            INTO #OPPBALANCE                 
            FROM LEDGER WITH(NOLOCK)                 
            WHERE 1 = 2                 
                            
                      
      /*GETTING OPENING BALANCE*/                      
      IF @SELECTBY = 'VDT'                      
      BEGIN                      
            IF @@OPENDATE = @FDATE                       
           BEGIN       
      INSERT                 
                  INTO #OPPBALANCE                 
                  SELECT                 
                        CLTCODE,                 
           OPPBAL = ISNULL(SUM(                 
                        CASE                 
                              WHEN UPPER(B.DRCR) = 'D'                 
                              THEN B.VAMT                 
                              ELSE -B.VAMT                 
                        END                
                        ), 0)                 
                  FROM LEDGER B WITH(NOLOCK)                 
      WHERE B.CLTCODE > = @FCODE                 
                        AND B.CLTCODE < = @TCODE                 
                        AND B.VDT LIKE @FDATE + '%'                 
                        AND VTYP = 18                 
                  GROUP BY CLTCODE                 
      
            END                      
            ELSE                      
            BEGIN                      
                  INSERT                 
                  INTO #OPPBALANCE                 
                  SELECT            
                        CLTCODE,                 
                        OPPBAL = ISNULL(SUM(                 
                        CASE                 
                              WHEN UPPER(B.DRCR) = 'D'                 
                       THEN B.VAMT                 
                              ELSE -B.VAMT                 
                        END                
                        ), 0)                 
                  FROM LEDGER B WITH(NOLOCK)                         WHERE B.CLTCODE > = @FCODE                 
                        AND B.CLTCODE < = @TCODE                 
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'                 
                        AND VDT < @FDATE                 
               GROUP BY CLTCODE                 
            END                      
      END                       
      ELSE                      
      BEGIN                       
            IF @@OPENDATE = @FDATE                       
            BEGIN                    
                  INSERT                 
                  INTO #OPPBALANCE                 
                  SELECT                 
                        CLTCODE,                 
OPBAL = SUM(OPBAL)                 
                  FROM                 
                        (                 
                              SELECT                 
                                    CLTCODE,                 
                                    OPBAL = ISNULL(SUM(                 
                                    CASE                 
                                          WHEN UPPER(DRCR) = 'D'                 
                                          THEN VAMT                 
                                          ELSE -VAMT                 
                                    END                
                                    ), 0)                 
                              FROM LEDGER WITH(NOLOCK)                 
                              WHERE CLTCODE = @FCODE                 
                                    AND EDT LIKE @@OPENDATE + '%'                 
                                    AND VTYP = 18                 
                              GROUP BY CLTCODE                 
                              UNION ALL                 
                              SELECT                 
                                    CLTCODE,                 
                                    OPPBAL = ISNULL(SUM(                 
                                    CASE                 
                                          WHEN UPPER(B.DRCR) = 'C'                 
                                          THEN B.VAMT                 
                                          ELSE -B.VAMT                 
                                    END                
            ), 0)                 
                              FROM LEDGER B WITH(NOLOCK)                 
                              WHERE B.CLTCODE > = @FCODE                 
                                    AND B.CLTCODE < = @TCODE                 
                                    AND B.VDT < @@OPENDATE                
                          AND EDT >= @@OPENDATE                 
                              GROUP BY CLTCODE                 
                        )                 
                        T                 
                  GROUP BY CLTCODE                 
            END                    
            ELSE                    
            BEGIN                    
  INSERT                 
                  INTO #OPPBALANCE                 
                  SELECT                 
                        CLTCODE,                 
                        OPBAL = SUM(OPBAL)                 
                  FROM                 
                        (                 
                              SELECT                 
        CLTCODE,                 
                                    OPBAL = ISNULL(SUM(                 
                                    CASE                 
                                          WHEN UPPER(DRCR) = 'D'                 
                                          THEN VAMT                 
                                          ELSE -VAMT                 
                                    END                
                                    ), 0)                 
               FROM LEDGER WITH(NOLOCK)                 
                              WHERE CLTCODE = @FCODE                 
                                    AND EDT LIKE @@OPENDATE + '%'                 
                                    AND VTYP = 18                 
                              GROUP BY CLTCODE                 
                              UNION ALL                 
                   SELECT                 
                                    CLTCODE,                 
                                    OPBAL = SUM(                 
                                    CASE                 
                                          WHEN UPPER(DRCR) = 'D'                 
                                          THEN VAMT                 
                                          ELSE -VAMT               
                                    END                
                                    )                 
                              FROM LEDGER WITH(NOLOCK)                 
                              WHERE CLTCODE = @FCODE                 
                                    AND EDT > = @@OPENDATE + ' 00:00:00'                 
                                    AND EDT < @FDATE                 
                                    AND VTYP <> 18                 
                              GROUP BY CLTCODE                 
                              UNION ALL                 
                              SELECT                 
                                    CLTCODE,                 
                                    OPPBAL = ISNULL(SUM(                 
                                    CASE                 
                                          WHEN UPPER(B.DRCR) = 'C'                 
                                          THEN B.VAMT                 
      ELSE -B.VAMT                 
                                    END                
                                    ), 0)                 
                              FROM LEDGER B WITH(NOLOCK)                 
                              WHERE B.CLTCODE > = @FCODE                 
                                    AND B.CLTCODE < = @TCODE                 
                                    AND B.VDT < @@OPENDATE                 
                                    AND EDT >= @@OPENDATE                 
                              GROUP BY CLTCODE                 
                        )                                         T                 
                  GROUP BY CLTCODE                 
            END                    
      END                      
                            
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                      
            SELECT                 
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                 
              SHORTDESC = SPACE(35)                 
            INTO #LEDGERDATA                 
            FROM LEDGER L WITH(NOLOCK)                 
            WHERE 1 = 2                 
        
                           
                      
                      
      /*GETTING FIILTERED LEDGER*/                      
      IF @SELECTBY = 'VDT'                      
      BEGIN                      
            INSERT                 
            INTO #LEDGERDATA                 
            SELECT                 
       VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                 
                  ISNULL(V.SHORTDESC, '') SHORTDESC                 
            FROM LEDGER L WITH(NOLOCK),                 
                  VMAST V WITH(NOLOCK)                 
            WHERE VDT > = @FDATE + ' 00:00:00'                 
                  AND L.VTYP = V.VTYPE                 
                  AND VDT < = @TDATE +' 23:59:59'                 
                  AND CLTCODE > = @FCODE                 
                  AND CLTCODE < = @TCODE                 
      END                       
      ELSE                      
      BEGIN                      
            INSERT                 
            INTO #LEDGERDATA                 
            SELECT                 
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                 
                  ISNULL(V.SHORTDESC, '') SHORTDESC                 
            FROM LEDGER L WITH(NOLOCK),                 
                  VMAST V WITH(NOLOCK)                 
            WHERE EDT > = @FDATE + ' 00:00:00'                 
                  AND L.VTYP = V.VTYPE                 
                  AND EDT < = @TDATE +' 23:59:59'                 
                  AND CLTCODE > = @FCODE                 
                  AND CLTCODE < = @TCODE                 
      END                      
                      
                
                
/*GETTING CLIENT LIST*/                      
      SELECT                 
            C2.PARTY_CODE,                
   C1.LONG_NAME,                
            BANK_NAME = ISNULL(C4.BANKID, ''),                 
            L_ADDRESS1,                 
            L_ADDRESS2,                 
            L_ADDRESS3,                 
            L_CITY,                 
            L_ZIP,                 
            RES_PHONE1,                 
            C1.BRANCH_CD,                 
           FAMILY,                 
            C1.SUB_BROKER,                 
            TRADER,                 
            CL_TYPE,                 
            PAN_GIR_NO = ISNULL(PAN_GIR_NO, '')                 
      INTO #LEDGERCLIENTS                 
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),                 
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                 
      LEFT OUTER JOIN                 
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)                 
            ON                 
            (                
                  C2.PARTY_CODE = C4.PARTY_CODE                 
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')                 
      AND DEFDP = 1                
--                  AND DEFDP = 0            
            )                 
      WHERE C1.CL_CODE = C2.CL_CODE                 
            AND C1.BRANCH_CD LIKE (                
            CASE                 
                  WHEN @STATUSID = 'BRANCH'                 
                  THEN @STATUSNAME                 
                  ELSE '%'                 
            END                
            )      
            AND SUB_BROKER LIKE (                
            CASE                 
                  WHEN @STATUSID = 'SUB_BROKER'                 
                  THEN @STATUSNAME                 
                  ELSE '%'                 
            END                
            )                 
   AND SUB_BROKER LIKE (                
            CASE                 
                  WHEN @STATUSID = 'SUBBROKER'                 
                  THEN @STATUSNAME                
                  ELSE '%'                 
            END                
            )                 
            AND TRADER LIKE (                
            CASE                 
                  WHEN @STATUSID = 'TRADER'                 
                  THEN @STATUSNAME                 
                  ELSE '%'                 
            END                
            )                 
            AND C1.FAMILY LIKE (                
            CASE                 
                  WHEN @STATUSID = 'FAMILY'                 
                  THEN @STATUSNAME                 
                  ELSE '%'                 
            END                
            )                 
            AND C2.PARTY_CODE LIKE (                
            CASE                 
                  WHEN @STATUSID = 'CLIENT'                 
                  THEN @STATUSNAME                 
                  ELSE '%'                 
            END                
         )                 
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%' 
                          
            AND C2.PARTY_CODE > = @FCODE                 
            AND C2.PARTY_CODE < = @TCODE                 
                
                
      CREATE TABLE [#TMPLEDGER] (                
       [BOOKTYPE] [CHAR] (2)  NULL ,                
       [VOUDT] [DATETIME] NULL ,                
       [EFFDT] [DATETIME] NULL ,                
       [SHORTDESC] [VARCHAR] (35)  NULL ,                
       [DRAMT] [MONEY] NULL ,                
       [CRAMT] [MONEY] NULL ,                
       [VNO] [VARCHAR] (12)  NULL ,                
       [DDNO] [VARCHAR] (30)  NULL ,                
       [NARRATION] [VARCHAR] (234)  NULL ,                
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,                
       [VTYP] [SMALLINT] NULL ,                
       [VDT] [VARCHAR] (30)  NULL ,                
       [EDT] [VARCHAR] (30)  NULL ,                
       [ACNAME] [VARCHAR] (100)  NULL ,                
       [OPBAL] [MONEY] NULL ,                
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,                
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,                
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,                
       [L_CITY] [VARCHAR] (40)  NULL ,                
       [L_ZIP] [VARCHAR] (10)  NULL ,                
       [RES_PHONE1] [VARCHAR] (15)  NULL ,                
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,                
       [CROSAC] [VARCHAR] (10)  NULL ,                
       [EDIFF] [INT] NULL ,                
       [FAMILY] [VARCHAR] (10)  NOT NULL ,                
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,                
       [TRADER] [VARCHAR] (20)  NOT NULL ,                
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,                
       [BANK_NAME] [VARCHAR] (100)  NOT NULL ,                
       [PAN_GIR_NO] [VARCHAR] (20)  NOT NULL ,                
       [LNO] [INT] NULL,              
       [PDT] [DATETIME] NULL      
      ) ON [PRIMARY]                
         
                 
/*GETTING LDDGER ENTRIES*/                      
      INSERT                 
            INTO #TMPLEDGER                 
      SELECT                 
            L.BOOKTYPE,                 
 VOUDT = L.VDT,                 
            EFFDT = L.EDT,                 
            L.SHORTDESC,                 
            DRAMT = (                
            CASE                 
                  WHEN UPPER(L.DRCR) = 'D'                 
                  THEN L.VAMT                 
                  ELSE 0                 
            END                
            ),                 
            CRAMT = (                
            CASE                 
                  WHEN UPPER(L.DRCR) = 'C'                 
                  THEN L.VAMT                 
                  ELSE 0                 
            END                
            ),                 
            L.VNO,                 
            DDNO = SPACE(15),                 
            L.NARRATION,                 
            C.PARTY_CODE CLTCODE,                 
            VTYP = ISNULL(L.VTYP, 18),                 
            CONVERT(VARCHAR, L.VDT, 103) VDT,                 
            CONVERT(VARCHAR, L.EDT, 103) EDT,                 
--            L.ACNAME ,                 
            C.LONG_NAME,                
            OPBAL = VAMT,                 
            C.L_ADDRESS1,                 
            C.L_ADDRESS2,                 
            C.L_ADDRESS3,                 
            C.L_CITY,                 
            C.L_ZIP,                 
            C.RES_PHONE1,                 
            C.BRANCH_CD,                 
            L.CLTCODE CROSAC ,                 
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),                 
            C.FAMILY,                 
            C.SUB_BROKER,                 
            C.TRADER,                 
            C.CL_TYPE,                 
            C.BANK_NAME,                 
            C.PAN_GIR_NO,                 
            L.LNO,              
   L.PDT      
      FROM #LEDGERDATA L WITH(NOLOCK)                 
      RIGHT OUTER JOIN                 
            #LEDGERCLIENTS C WITH(NOLOCK)                 
            ON                 
            (                
                  L.CLTCODE = C.PARTY_CODE                
            )                 
                
                
                      
/*UPDATING OPENING BLANACE*/                      
      UPDATE                 
            #TMPLEDGER                 
            SET OPBAL = 0                 
                
      UPDATE                 
            #TMPLEDGER                 
            SET OPBAL = T.OPPBAL                 
      FROM #TMPLEDGER L WITH(NOLOCK),                 
            #OPPBALANCE T WITH(NOLOCK)                 
      WHERE L.CLTCODE = T.CLTCODE                 
                      
                
                
/*UPDATING CHEQUE NUMBER*/                      
      UPDATE                 
            #TMPLEDGER                 
            SET DDNO = L1.DDNO                 
      FROM LEDGER1 L1 WITH(NOLOCK)                 
      WHERE L1.VNO = #TMPLEDGER.VNO                 
            AND L1.VTYP = #TMPLEDGER.VTYP                 
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE                 
            AND L1.LNO = #TMPLEDGER.LNO                 
                      
                
                
/*UPDATING CROSS ACCOUNT CODE*/                      
      UPDATE                 
            #TMPLEDGER                 
            SET #TMPLEDGER.CROSAC = B.CLTCODE                 
      FROM LEDGER B WITH(NOLOCK),                 
            ACMAST V WITH(NOLOCK)                 
      WHERE B.CLTCODE = V.CLTCODE                 
            AND V.ACCAT = 2                 
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE                 
            AND #TMPLEDGER.VNO = B.VNO                 
            AND #TMPLEDGER.VTYP = B.VTYP                 
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')                 
                      
                
                
/*UPDATING BANK NAME*/                                     
      UPDATE                 
            #TMPLEDGER                 
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME                
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)                 
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))                 
            
      IF @FORPDF = 'Y'      
  BEGIN      
   ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT      
   UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER      
   FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C      
   WHERE #TMPLEDGER.CLTCODE = C.CLTCODE      
  END      
                      
      IF @@STRORDER = 'ACCODE'                      
      BEGIN                      
            IF @SELECTBY = 'VDT'                      
            BEGIN                       
                  SELECT                 
                        L.*      
                  FROM #TMPLEDGER L WITH(NOLOCK),                 
                        ACMAST A WITH(NOLOCK)                 
                  WHERE L.CLTCODE = A.CLTCODE                 
                        AND ACCAT IN ('4', '104')                 
    AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.CLTCODE,              
                        VOUDT, PDT              
            END                      
            ELSE                      
            BEGIN                      
                  SELECT                 
                        L.*      
                  FROM #TMPLEDGER L WITH(NOLOCK),                 
                        ACMAST A WITH(NOLOCK)                 
                  WHERE L.CLTCODE = A.CLTCODE                 
                        AND ACCAT IN ('4', '104')                 
                  ORDER BY L.CLTCODE,                
                        EFFDT, PDT              
            END                      
      END                      
      ELSE                      
      BEGIN                      
            IF @SELECTBY = 'VDT'                      
            BEGIN                       
                  SELECT                 
                        L.*                 
                  FROM #TMPLEDGER L WITH(NOLOCK),                 
                        ACMAST A WITH(NOLOCK)                 
  WHERE L.CLTCODE = A.CLTCODE                 
                        AND ACCAT IN ('4', '104')             
                  ORDER BY L.ACNAME,               
                        VOUDT, PDT                 
            END                      
            ELSE                      
            BEGIN                      
                  SELECT                 
                        L.*                 
                  FROM #TMPLEDGER L WITH(NOLOCK),                 
                        ACMAST A WITH(NOLOCK)                 
                  WHERE L.CLTCODE = A.CLTCODE                 
                        AND ACCAT IN ('4', '104')                 
                  ORDER BY L.ACNAME,                
                        EFFDT, PDT              
            END                      
      END                      
                      
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_partyledger_All
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[rpt_acc_partyledger_All]    
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @FCODE VARCHAR(10),    
 @TCODE VARCHAR(10),    
 @STRORDER VARCHAR(6),    
 @SELECTBY VARCHAR(3),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(15),    
 @STRBRANCH VARCHAR(10),    
 @ORDERFLG VARCHAR(1) = 'N',     
 @SINGLE VARCHAR(1) = 'N'    
  
  
    
AS    
BEGIN    
    
 CREATE TABLE [DBO].[#TMPLEDGERNEW]     
 (    
  [BOOKTYPE] [CHAR] (2) NULL ,    
  [VOUDT] [DATETIME] NULL ,    
  [EFFDT] [DATETIME] NULL ,    
  [SHORTDESC] [VARCHAR] (35) NULL ,    
  [DRAMT] [MONEY] NULL ,    
  [CRAMT] [MONEY] NULL ,    
  [VNO] [VARCHAR] (12) NULL ,    
  [DDNO] [VARCHAR] (20) NULL ,    
  [NARRATION] [VARCHAR] (234) NULL ,    
  [CLTCODE] [VARCHAR] (10) NOT NULL ,    
  [VTYP] [SMALLINT] NULL ,    
  [VDT] [VARCHAR] (30) NULL ,    
  [EDT] [VARCHAR] (30) NULL ,    
  [ACNAME] [VARCHAR] (100) NULL ,    
  [OPBAL] [MONEY] NULL ,    
  [L_ADDRESS1] [VARCHAR] (40) NULL ,    
  [L_ADDRESS2] [VARCHAR] (40) NULL ,    
  [L_ADDRESS3] [VARCHAR] (40) NULL ,    
  [L_CITY] [VARCHAR] (40) NULL ,    
  [L_ZIP] [VARCHAR] (10) NULL ,    
  [RES_PHONE1] [VARCHAR] (15) NULL ,    
  [BRANCH_CD] [VARCHAR] (10) NULL ,    
  [CROSAC] [VARCHAR] (10) NULL ,    
  [EDIFF] [INT] NULL ,    
  [FAMILY] [VARCHAR] (10) NULL ,    
  [SUB_BROKER] [VARCHAR] (10) NULL ,    
  [TRADER] [VARCHAR] (20) NULL ,    
  [CL_TYPE] [VARCHAR] (3) NULL ,    
  [BANK_NAME] [VARCHAR] (50) NULL ,    
  [CLTDPID] [VARCHAR] (20) NULL ,    
  [LNO] [INT] NULL ,    
  [PDT] [DATETIME] NULL ,    
  [SEGMENT] [VARCHAR] (5) NULL,    
  [ENTITY] [VARCHAR] (50) NULL,    
  [ORDERSEG][BIGINT] NULL    
 ) ON [PRIMARY]    
    
 CREATE TABLE #OPBAL    
 (    
  CLTCODE VARCHAR(10),    
  SEGMENT VARCHAR(10),    
  ORDERSEG INT,    
  OPBAL MONEY    
 )    
    
 CREATE TABLE #FINOPBAL    
 (    
  CLTCODE VARCHAR(10),    
  ORDERSEG INT,    
  OPBAL MONEY    
 )    
    
 --PRINT 'NSECMINSERT'    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNT.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
  
 --PRINT 'NSECMUPDATE'    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='CAPITAL - NSE', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
    
 --PRINT 'BSECMINSERT'    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNTBSE.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 --PRINT 'BSECMUPDATE'    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='CAPITAL - BSE', ORDERSEG = 2 WHERE SEGMENT IS NULL    
 END    
    
 --NSEFO START    
 --PRINT 'NSEFOINSERT'    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNTFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 --NSEFO END    
 --PRINT 'NSEFOUPDATE'    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='DERIVATIVES - NSE', ORDERSEG = 3 WHERE SEGMENT IS NULL    
 END    
    
 --COMMON START    
 --PRINT 'COMMINSERT'    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCCOMMON.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 --BSEFO END    
 --PRINT 'COMMUPDATE'    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='4ALL',ENTITY='COMMON LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='4ALL',ENTITY='COMMON LEDGER', ORDERSEG = 7 WHERE SEGMENT IS NULL    
 END    
    
 --PRINT 'COMMON MRG INSERT'    
 INSERT INTO #TMPLEDGERNEW    
 (BOOKTYPE, VOUDT,EFFDT,SHORTDESC,DRAMT, CRAMT,VNO,DDNO,NARRATION,CLTCODE, VTYP,VDT,EDT, ACNAME, OPBAL,    
 L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,    
 CL_TYPE,BANK_NAME, CLTDPID,LNO,PDT)    
 EXEC ACCCOMMON.DBO.RPT_ACC_MARGINLEDGER @FDATE ,@TDATE ,@FCODE ,@TCODE ,@STRORDER ,@SELECTBY ,@STATUSID ,@STATUSNAME ,@STRBRANCH    
    
 --PRINT 'COMMON MRG UPDATE'    
 UPDATE #TMPLEDGERNEW    
 SET SEGMENT = '8ALL',    
 ENTITY = 'CHARGES LEDGER', ORDERSEG = 8 WHERE SEGMENT IS NULL    
    
 --  PRINT '1'    
 --MARGIN    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNT.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN - NSE', ORDERSEG = 4 WHERE SEGMENT IS NULL    
 END    
    
 --PRINT '2'    
    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNTBSE.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN - BSE', ORDERSEG = 5 WHERE SEGMENT IS NULL    
 END    
    
 --  PRINT '3'    
 --NSEFO START    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNTFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
 --NSEFO END    
    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN - NFO', ORDERSEG = 6 WHERE SEGMENT IS NULL    
 END    
    
 INSERT INTO #TMPLEDGERNEW    
 (VOUDT,    
 EFFDT,    
 SHORTDESC,    
 DRAMT,    
 CRAMT,    
 VNO,    
 DDNO,    
 NARRATION,    
 CLTCODE,    
 VTYP,    
 VDT,    
 EDT)    
 EXEC NSEFO.DBO.V2_GETMARGINREQ    
 @TDATE ,    
 @FCODE ,    
 @TCODE ,    
 @STATUSID ,    
 @STATUSNAME ,    
 @STRBRANCH    
    
 UPDATE #TMPLEDGERNEW    
 SET SEGMENT = '8NFO',    
 ENTITY = 'MARGIN REQ - NFO',    
 ORDERSEG = 8,    
 OPBAL = 0    
 WHERE SEGMENT IS NULL    
    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNTCURFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='9NSX',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='9NSX',ENTITY='CAPITAL - NSX', ORDERSEG = 1 WHERE SEGMENT IS NULL    
 END    
    
 INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
 VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,    
 CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)    
 EXEC ACCOUNTCURFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH    
    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='10NSX',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL    
 END    
 ELSE    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='10NSX',ENTITY='MARGIN - NSX', ORDERSEG = 4 WHERE SEGMENT IS NULL    
 END    
    
 --  PRINT '4'    
 IF @ORDERFLG = 'N'    
 BEGIN    
    
  INSERT INTO #OPBAL    
  SELECT CLTCODE, SEGMENT, ORDERSEG, OPBAL = MAX(OPBAL) FROM #TMPLEDGERNEW    
  GROUP BY CLTCODE, SEGMENT, ORDERSEG    
    
  INSERT INTO #FINOPBAL    
  SELECT CLTCODE, ORDERSEG, OPBAL = SUM(OPBAL) FROM #OPBAL    
  GROUP BY CLTCODE, ORDERSEG    
    
  UPDATE    
  #TMPLEDGERNEW    
  SET OPBAL = 0    
    
  UPDATE    
  #TMPLEDGERNEW    
  SET OPBAL = T.OPBAL    
  FROM #TMPLEDGERNEW L WITH(NOLOCK),    
  #FINOPBAL T WITH(NOLOCK)    
  WHERE L.CLTCODE = T.CLTCODE  AND L.ORDERSEG = T.ORDERSEG    
 END    
    
 IF @STRORDER = 'ACCODE'    
 BEGIN    
  IF @SELECTBY = 'VDT'    
  BEGIN    
    
   IF @ORDERFLG = 'N'    
   BEGIN    
    SELECT * FROM #TMPLEDGERNEW WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY CLTCODE,ORDERSEG,VOUDT    
   END    
   ELSE    
   BEGIN    
    SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY CLTCODE,ORDERSEG,VOUDT    
   END    
  END    
  ELSE    
  BEGIN       
   IF @ORDERFLG = 'N'    
   BEGIN    
    SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY CLTCODE,ORDERSEG,EFFDT    
   END    
   ELSE    
   BEGIN    
    SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY CLTCODE,EFFDT,ORDERSEG    
   END    
  END    
 END    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_ALL_COMM
-- --------------------------------------------------
/*      
Exec rpt_acc_partyledger_all_Comm 'Apr  1 2005','Mar 31 2006','0A141','0A141','ACCODE','vdt','broker','broker','%','Y'    
EXEC account..RPT_ACC_PARTYLEDGER 'Apr  2 2008','Oct 15 2008','0A141','0A141','ACCODE','vdt','broker','broker',''      
*/        
CREATE PROCEDURE [dbo].[RPT_ACC_PARTYLEDGER_ALL_COMM]          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */          
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */          
 @FCODE VARCHAR(10),          
 @TCODE VARCHAR(10),          
 @STRORDER VARCHAR(6),          
 @SELECTBY VARCHAR(3),          
 @STATUSID VARCHAR(15),          
 @STATUSNAME VARCHAR(15),          
 @STRBRANCH VARCHAR(10),          
 @ORDERFLG VARCHAR(1) = 'N' ,          
 @SINGLE VARCHAR(1) = 'N'          
          
AS          
         
          
 CREATE TABLE [DBO].[#TMPLEDGERNEW]           
 (          
  [BOOKTYPE] [CHAR] (2) NULL ,          
  [VOUDT] [DATETIME] NULL ,          
  [EFFDT] [DATETIME] NULL ,          
  [SHORTDESC] [VARCHAR] (35) NULL ,          
  [DRAMT] [MONEY] NULL ,          
  [CRAMT] [MONEY] NULL ,          
  [VNO] [VARCHAR] (12) NULL ,          
  [DDNO] [VARCHAR] (20) NULL ,          
  [NARRATION] [VARCHAR] (234) NULL ,          
  [CLTCODE] [VARCHAR] (10) NOT NULL ,          
  [VTYP] [SMALLINT] NULL ,          
  [VDT] [VARCHAR] (30) NULL ,          
  [EDT] [VARCHAR] (30) NULL ,          
  [ACNAME] [VARCHAR] (100) NULL ,          
  [OPBAL] [MONEY] NULL ,          
  [L_ADDRESS1] [VARCHAR] (40) NULL ,          
  [L_ADDRESS2] [VARCHAR] (40) NULL ,          
  [L_ADDRESS3] [VARCHAR] (40) NULL ,          
  [L_CITY] [VARCHAR] (40) NULL ,          
  [L_ZIP] [VARCHAR] (10) NULL ,          
  [RES_PHONE1] [VARCHAR] (15) NULL ,          
  [BRANCH_CD] [VARCHAR] (10) NULL ,          
  [CROSAC] [VARCHAR] (10) NULL ,          
  [EDIFF] [INT] NULL ,          
  [FAMILY] [VARCHAR] (10) NULL ,          
  [SUB_BROKER] [VARCHAR] (10) NULL ,          
  [TRADER] [VARCHAR] (20) NULL ,          
  [CL_TYPE] [VARCHAR] (3) NULL ,          
  [BANK_NAME] [VARCHAR] (50) NULL ,          
  [CLTDPID] [VARCHAR] (20) NULL ,          
  [LNO] [INT] NULL ,          
  [PDT] [DATETIME] NULL ,          
  [EXCHANGE] [VARCHAR] (15) NULL,          
  [SEGMENT] [VARCHAR] (15) NULL,          
  [ENTITY] [VARCHAR] (50) NULL,          
  [ORDERSEG][BIGINT] NULL          
 ) ON [PRIMARY]          
          
 CREATE TABLE #OPBAL          
 (          
  CLTCODE VARCHAR(10),          
  SEGMENT VARCHAR(10),          
  ORDERSEG INT,          
  OPBAL MONEY          
 )          
          
 CREATE TABLE #FINOPBAL          
 (          
  CLTCODE VARCHAR(10),          
  ORDERSEG INT,          
  OPBAL MONEY          
 )          
        
DECLARE        
 @@ACCOUNTDB VARCHAR(20),        
 @@EXCHANGE VARCHAR(15),        
 @@SEGMENT VARCHAR(15),        
 @@SQL VARCHAR(1000),        
 @@SEGORD TINYINT,        
 @@MAINREC AS CURSOR        
        
SET @@MAINREC = CURSOR FOR                      
                
SELECT ACCOUNTDB, EXCHANGE, SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE PRIMARYSERVER = 1         
            
/*select vno,vtyp,booktype,count(1) from ledger(nolock)            
where lno=2 and vdt between 'APR  1 2007' and 'MAR 31 2008'            
group by vno,vtyp,booktype            
having count(1)>1 */            
             
SET @@SEGORD = 1        
                    
OPEN @@MAINREC                      
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT                    
WHILE @@FETCH_STATUS = 0                      
BEGIN                      
        
 IF @@ACCOUNTDB = 'ACCOUNT' OR @@ACCOUNTDB = 'ACCOUNTBSE' OR @@ACCOUNTDB = 'ACCOUNTFO'  OR @@ACCOUNTDB = 'ACCOUNTBFO' OR @@ACCOUNTDB = 'ACCOUNTCURFO' OR @@ACCOUNTDB = 'ACCOUNTCURBFO' OR @@ACCOUNTDB  = 'ACCOUNTMCDXCDS'     
 BEGIN        
  --PRINT 'NSECMINSERT'          
  SET @@SQL = "INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,  "        
  SET @@SQL = @@SQL +  "VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,  "        
  SET @@SQL = @@SQL +  "CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)  "        
  SET @@SQL = @@SQL +  "EXEC " + @@ACCOUNTDB + ".DBO.RPT_ACC_PARTYLEDGER_COMM '" + @FDATE + "','" + @TDATE + "','"        
  SET @@SQL = @@SQL +  @FCODE + "','" + @TCODE + "','" + @STRORDER + "','" + @SELECTBY + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @STRBRANCH + "'"        
       
  PRINT @@SQL        
  EXEC (@@SQL)        
        
 IF @ORDERFLG = 'N'          
  BEGIN          
   UPDATE #TMPLEDGERNEW SET EXCHANGE = @@EXCHANGE, SEGMENT= @@SEGMENT, ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL          
  END          
  ELSE          
  BEGIN          
   UPDATE #TMPLEDGERNEW SET EXCHANGE = @@EXCHANGE, SEGMENT= @@SEGMENT, ENTITY =  @@EXCHANGE + ' - ' + @@SEGMENT, ORDERSEG = @@SEGORD WHERE SEGMENT IS NULL          
  END          
        
  SET @@SQL = "INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,  "        
  SET @@SQL = @@SQL +  "VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,  "        
  SET @@SQL = @@SQL +  "CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)  "        
  SET @@SQL = @@SQL +  "EXEC " + @@ACCOUNTDB + ".DBO.RPT_ACC_MARGINLEDGER_COMM '" + @FDATE + "','" + @TDATE + "','"        
  SET @@SQL = @@SQL +  @FCODE + "','" + @TCODE + "','" + @STRORDER + "','" + @SELECTBY + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @STRBRANCH + "'"        
        
  PRINT @@SQL        
  EXEC (@@SQL)        
        
 IF @ORDERFLG = 'N'          
  BEGIN          
   UPDATE #TMPLEDGERNEW SET EXCHANGE = @@EXCHANGE, SEGMENT= @@SEGMENT, ENTITY='MARGIN LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL          
  END          
  ELSE          
  BEGIN          
   UPDATE #TMPLEDGERNEW SET EXCHANGE = @@EXCHANGE, SEGMENT= @@SEGMENT, ENTITY = 'MARGIN ' + @@EXCHANGE + ' - ' + @@SEGMENT, ORDERSEG = CONVERT(TINYINT, @@SEGORD) + 4 WHERE SEGMENT IS NULL          
  END          
        
 SET @@SEGORD = @@SEGORD + 1         
 END        
          
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT          
END        
        
IF @ORDERFLG = 'N'          
 BEGIN          
          
  INSERT INTO #OPBAL          
  SELECT CLTCODE, SEGMENT, ORDERSEG, OPBAL = MAX(OPBAL) FROM #TMPLEDGERNEW          
  GROUP BY CLTCODE, EXCHANGE, SEGMENT, ORDERSEG          
          
  INSERT INTO #FINOPBAL          
  SELECT CLTCODE, ORDERSEG, OPBAL = SUM(OPBAL) FROM #OPBAL          
  GROUP BY CLTCODE, ORDERSEG          
          
  UPDATE          
  #TMPLEDGERNEW          
  SET OPBAL = 0          
          
  UPDATE          
  #TMPLEDGERNEW          
  SET OPBAL = T.OPBAL          
  FROM #TMPLEDGERNEW L WITH(NOLOCK),          
  #FINOPBAL T WITH(NOLOCK)          
  WHERE L.CLTCODE = T.CLTCODE  AND L.ORDERSEG = T.ORDERSEG          
 END        
      
/* DELETE T FROM #TMPLEDGERNEW T WHERE EXISTS(SELECT CLTCODE FROM #TMPLEDGERNEW T1       
 WHERE T.CLTCODE = T1.CLTCODE AND VTYP <> 18 GROUP BY CLTCODE HAVING ABS(SUM(OPBAL) + SUM(CASE WHEN DRAMT <> 0 THEN DRAMT ELSE -CRAMT END)) < 3120)*/      
   
IF @STRORDER = 'ACCODE'          
 BEGIN          
  IF @SELECTBY = 'VDT'          
  BEGIN          
     SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY CLTCODE,ORDERSEG,VOUDT          
   END          
  ELSE          
  BEGIN     
    SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY CLTCODE,ORDERSEG, EFFDT        
   END          
 END   
ELSE  
 BEGIN  
  IF @SELECTBY = 'VDT'          
  BEGIN          
     SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY ACNAME,ORDERSEG,VOUDT          
   END          
  ELSE          
  BEGIN     
    SELECT * FROM #TMPLEDGERNEW  WHERE (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)   ORDER BY ACNAME,ORDERSEG, EFFDT        
   END          
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_ALL_NEW
-- --------------------------------------------------
     
CREATE PROCEDURE [DBO].[RPT_ACC_PARTYLEDGER_ALL_NEW]          
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */          
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */          
@FCODE VARCHAR(10),          
@TCODE VARCHAR(10),          
@STRORDER VARCHAR(6),          
@SELECTBY VARCHAR(3),          
@STATUSID VARCHAR(15),          
@STATUSNAME VARCHAR(15),          
@STRBRANCH VARCHAR(10),  
@ORDERFLG VARCHAR(1) = 'N' ,      
@SINGLE VARCHAR(1) = 'N' ,        
@NSEFLG VARCHAR(1)  ,      
@BSEFLG VARCHAR(1)  ,      
@FOFLG VARCHAR(1)         
          
AS          
          
BEGIN          
          
CREATE TABLE [DBO].[#TMPLEDGERNEW] (          
  [BOOKTYPE] [CHAR] (2) NULL ,          
  [VOUDT] [DATETIME] NULL ,          
  [EFFDT] [DATETIME] NULL ,          
  [SHORTDESC] [CHAR] (6) NULL ,          
  [DRAMT] [MONEY] NULL ,          
  [CRAMT] [MONEY] NULL ,          
  [VNO] [VARCHAR] (12) NULL ,          
  [DDNO] [VARCHAR] (15) NULL ,          
  [NARRATION] [VARCHAR] (234) NULL ,          
  [CLTCODE] [VARCHAR] (10) NOT NULL ,          
  [VTYP] [SMALLINT] NULL ,          
  [VDT] [VARCHAR] (30) NULL ,          
  [EDT] [VARCHAR] (30) NULL ,          
  [ACNAME] [VARCHAR] (100) NULL ,          
  [OPBAL] [MONEY] NULL ,          
  [L_ADDRESS1] [VARCHAR] (40) NULL ,          
  [L_ADDRESS2] [VARCHAR] (40) NULL ,          
  [L_ADDRESS3] [VARCHAR] (40) NULL ,          
  [L_CITY] [VARCHAR] (40) NULL ,          
  [L_ZIP] [VARCHAR] (10) NULL ,          
  [RES_PHONE1] [VARCHAR] (15) NULL ,          
  [BRANCH_CD] [VARCHAR] (10) NULL ,          
  [CROSAC] [VARCHAR] (10) NULL ,          
  [EDIFF] [INT] NULL ,          
  [FAMILY] [VARCHAR] (10) NULL ,          
  [SUB_BROKER] [VARCHAR] (10) NULL ,          
  [TRADER] [VARCHAR] (20) NULL ,          
  [CL_TYPE] [VARCHAR] (3) NULL ,          
  [BANK_NAME] [VARCHAR] (50) NULL ,          
  [CLTDPID] [VARCHAR] (16) NULL ,          
  [LNO] [DECIMAL](5, 0) NULL ,          
  [PDT] [DATETIME] NULL ,          
  [SEGMENT] [VARCHAR] (4) NULL,          
  [ENTITY] [VARCHAR] (50) NULL,          
  [ORDERSEG][BIGINT] NULL          
 ) ON [PRIMARY]          
          
          
  IF @NSEFLG = 'Y'  
BEGIN         
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,          
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,          
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)          
EXEC ACCOUNT.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH          
  
 IF @ORDERFLG = 'N'  
 BEGIN  
  UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL          
 END  
 ELSE  
 BEGIN  
   UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='CAPITAL - NSE', ORDERSEG = 1 WHERE SEGMENT IS NULL          
 END  
  
-----------------  
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,          
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,          
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)          
EXEC ACCOUNT.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH          
IF @ORDERFLG = 'N'  
 BEGIN            
UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL          
END  
ELSE  
BEGIN  
UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN - NSE', ORDERSEG = 5 WHERE SEGMENT IS NULL          
END  
  
  
  
END  
  
  
  IF @BSEFLG = 'Y'  
BEGIN           
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,          
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,          
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)          
EXEC ACCOUNTBSE.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH          
IF @ORDERFLG = 'N'  
 BEGIN    
 UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL          
END  
ELSE  
BEGIN  
 UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='CAPITAL - BSE', ORDERSEG = 2 WHERE SEGMENT IS NULL          
END  
----------------  
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,          
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,          
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)          
EXEC ACCOUNTBSE.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH          
  
IF @ORDERFLG = 'N'  
 BEGIN             
UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL          
END   
ELSE  
BEGIN  
UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN - BSE', ORDERSEG = 6 WHERE SEGMENT IS NULL          
END  
  
  
  
  
END  
  
IF @FOFLG = 'Y'  
BEGIN  
--NSEFO START          
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,          
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,          
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)          
EXEC ACCOUNTFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH          
          
--NSEFO END          
IF @ORDERFLG = 'N'  
 BEGIN            
UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL          
END  
ELSE  
BEGIN  
UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='DERIVATIVES - NSE', ORDERSEG = 3 WHERE SEGMENT IS NULL        
END  
---------------  
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,          
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,          
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)          
EXEC ACCOUNTFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH          
--NSEFO END          
          
 IF @ORDERFLG = 'N'  
 BEGIN            
UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL          
END   
ELSE  
BEGIN  
UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN - NFO', ORDERSEG = 7 WHERE SEGMENT IS NULL          
END  
  
  
END  
  
  
        
IF @ORDERFLG = 'N'  
 BEGIN   
SELECT CLTCODE, SEGMENT, ORDERSEG, OPBAL = MAX(OPBAL) INTO #OPBAL FROM #TMPLEDGERNEW     
GROUP BY CLTCODE, SEGMENT, ORDERSEG    
    
SELECT CLTCODE, ORDERSEG, OPBAL = SUM(OPBAL) INTO #FINOPBAL FROM #OPBAL     
GROUP BY CLTCODE, ORDERSEG    
    
    
UPDATE             
            #TMPLEDGERNEW           
            SET OPBAL = 0             
            
      UPDATE             
            #TMPLEDGERNEW            
            SET OPBAL = T.OPBAL             
      FROM #TMPLEDGERNEW L WITH(NOLOCK),             
            #FINOPBAL T WITH(NOLOCK)             
      WHERE L.CLTCODE = T.CLTCODE  AND L.ORDERSEG = T.ORDERSEG         
END  
    
          
IF @STRORDER = 'ACCODE'          
 BEGIN          
 IF @SELECTBY = 'VDT'   
   BEGIN  
     SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VOUDT            
   END  
 ELSE     
  BEGIN  
   SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,EFFDT   
  END   
   
 END    
 ELSE  
 BEGIN          
 IF @SELECTBY = 'VDT'      
    BEGIN  
     SELECT * FROM #TMPLEDGERNEW ORDER BY ACNAME,ORDERSEG,VOUDT           
   END  
 ELSE   
  BEGIN  
   SELECT * FROM #TMPLEDGERNEW ORDER BY ACNAME,ORDERSEG,EFFDT   
  END   
END  
        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_BKUP_22AUG2022
-- --------------------------------------------------
  
--Exec rpt_acc_partyledger 'Jan  1 2007','Jan 25 2007','051','051','ACCODE','vdt','broker','broker',''    
  
CREATE Procedure [dbo].[Rpt_acc_partyledger_BKUP_22AUG2022]    
(    
 @Fdate Varchar(11),            /* As Mmm Dd Yyyy */    
 @Tdate Varchar(11),            /* As Mmm Dd Yyyy */    
 @Fcode Varchar(10),    
 @Tcode Varchar(10),    
 @Strorder Varchar(6),    
 @Selectby Varchar(3),    
 @Statusid Varchar(15),    
 @Statusname Varchar(15),    
 @Strbranch Varchar(10)    
)    
    
As    
    
/*========================================================================    
      Exec rpt_acc_partyledger_all    
            'Nov  1 2005',    
            'Dec 31 2005',    
            'a',    
            'zzz',    
            'ACCODE',    
            'vdt',    
            'broker',    
            'undefined',    
            ''    
========================================================================*/    
    
Declare    
 @@Opendate   As Varchar(11)    
    
Set Transaction Isolation Level Read Uncommitted    
    
    
/*getting Last Opening Date */    
      If Upper(@Selectby) = 'Vdt'    
      Begin    
            SELECT    
                  @@Opendate =    
                  (    
                        SELECT    
                              Left(Convert(Varchar, SDTCUR, 109), 11)    
                        FROM Parameter WITH(NoLock)    
                        WHERE @Fdate >= SdtCur and @Fdate <= LdtCur  
                  )    
      End    
      Else    
      Begin    
            SELECT    
                  @@Opendate =    
                  (    
                        SELECT    
                              Left(Convert(Varchar, SDTCUR, 109), 11)    
                        FROM Parameter WITH(NoLock)    
                        WHERE @Fdate >= SdtCur and @Fdate <= LdtCur   
                  )    
      End    
    
    
      /*creating Blank Table For Opening Balance*/   
  
 CREATE TABLE #oppbalance  
 (  
  Cltcode Varchar(10),  
  Oppbal Money   
 )  
    
    
      /*getting Opening Balance*/    
      If @Selectby = 'Vdt'    
      Begin    
            If @@Opendate = @Fdate    
         Begin    
                  INSERT    
                  INTO #oppbalance    
            SELECT    
                        Cltcode,    
                        Oppbal = Isnull(Sum(    
                       CASE    
                              WHEN Upper(B.Drcr) = 'D'    
                              THEN B.Vamt    
                              ELSE -b.Vamt    
                        END    
                        ), 0)    
               FROM Ledger B WITH(NoLock)    
                  WHERE B.Cltcode > = @Fcode    
                        AND B.Cltcode < = @Tcode    
                      AND B.Vdt Like @Fdate + '%'    
                        AND Vtyp = 18    
                  GROUP BY Cltcode    
            End    
            Else    
            Begin    
                  INSERT    
                  INTO #oppbalance    
                  SELECT    
                        Cltcode,    
                        Oppbal = Isnull(Sum(    
                        CASE    
                              WHEN Upper(B.Drcr) = 'D'    
                       THEN B.Vamt    
                              ELSE -b.Vamt    
                        END    
                        ), 0)    
                  FROM Ledger B WITH(NoLock)                         WHERE B.Cltcode > = @Fcode    
                        AND B.Cltcode < = @Tcode    
                        AND B.Vdt > = @@Opendate + ' 00:00:00'    
                        AND Vdt < @Fdate    
               GROUP BY Cltcode    
            End    
      End    
      Else    
      Begin    
            If @@Opendate = @Fdate    
            Begin    
                  INSERT    
                  INTO #oppbalance    
                  SELECT    
                        Cltcode,    
        Opbal = Sum(Opbal)    
                  FROM    
                        (    
                              SELECT    
                                    Cltcode,    
                   Opbal = Isnull(Sum(    
    CASE    
                                          WHEN Upper(Drcr) = 'D'    
                                          THEN Vamt    
                                          ELSE -vamt    
                                    END    
                                    ), 0)    
                              FROM Ledger WITH(NoLock)    
                              WHERE Cltcode > = @Fcode    
                                    AND Cltcode < = @Tcode    
                                    AND Edt Like @@Opendate + '%'    
                                    AND Vtyp = 18    
                              GROUP BY Cltcode    
                              UNION ALL    
                              SELECT    
                                    Cltcode,    
                                    Oppbal = Isnull(Sum(    
                                    CASE    
                                  WHEN Upper(B.Drcr) = 'C'    
                                          THEN B.Vamt    
                                          ELSE -b.Vamt    
                                    END    
                                  ), 0)    
                              FROM Ledger B WITH(NoLock)    
                              WHERE B.Cltcode > = @Fcode    
                                    AND B.Cltcode < = @Tcode    
                            AND B.Vdt < @@Opendate    
                                    AND Edt >= @@Opendate    
                              GROUP BY Cltcode    
                        )    
                        T    
      GROUP BY Cltcode    
            End    
            Else    
            Begin    
                  INSERT    
                  INTO #oppbalance    
                  SELECT    
                        Cltcode,    
                   Opbal = Sum(Opbal)    
                  FROM    
                        (    
                              SELECT    
                                    Cltcode,    
                                    Opbal = Isnull(Sum(    
                  CASE    
                                          WHEN Upper(Drcr) = 'D'    
                                          THEN Vamt    
                                          ELSE -vamt    
                                    END    
                                    ), 0)    
             FROM Ledger WITH(NoLock)    
                              WHERE Cltcode > = @Fcode    
                                    AND Cltcode < = @Tcode    
                                    AND Edt Like @@Opendate + '%'    
                                    AND Vtyp = 18    
                              GROUP BY Cltcode    
                              UNION ALL    
                   SELECT    
                                    Cltcode,    
                                    Opbal = Sum(    
                                    CASE    
                                          WHEN Upper(Drcr) = 'D'    
                                          THEN Vamt    
                                          ELSE -vamt    
                                    END    
                                    )    
                              FROM Ledger WITH(NoLock)    
                              WHERE Cltcode > = @Fcode    
                                    AND Cltcode < = @Tcode    
                                    AND Edt > = @@Opendate + ' 00:00:00'    
                                    AND Edt < @Fdate    
                                    AND Vtyp <> 18    
                              GROUP BY Cltcode    
                              UNION ALL    
              SELECT    
                                    Cltcode,    
                                    Oppbal = Isnull(Sum(    
                                    CASE    
                                          WHEN Upper(B.Drcr) = 'C'    
                                          THEN B.Vamt    
             ELSE -b.Vamt    
                                    END    
        ), 0)    
                              FROM Ledger B WITH(NoLock)    
                              WHERE B.Cltcode > = @Fcode    
                                    AND B.Cltcode < = @Tcode    
                AND B.Vdt < @@Opendate    
                                    AND Edt >= @@Opendate    
                              GROUP BY Cltcode    
                        )    
                        T    
                  GROUP BY Cltcode    
            End    
      End    
    
    
      /*generating Blank Structure For Filtered Ledger */    
 Create Table #ledgerdata  
 (  
  vtyp smallint,  
  vno varchar(12),  
  edt datetime,  
  lno int,  
  acname varchar(100),  
  drcr char(1),  
  vamt money,  
  vdt datetime,  
  cltcode varchar(10),  
  BookType char(2),  
  EnteredBy varchar(25),  
  pdt datetime,  
  CheckedBy varchar(25),  
  narration varchar(234),  
  Shortdesc Varchar(35)  
 )  
  
   
      /*getting Fiiltered Ledger*/    
      If @Selectby = 'Vdt'    
      Begin    
            INSERT    
            INTO #ledgerdata    
            SELECT    
                l.vtyp, vno, edt, lno, acname, drcr, vamt, vdt, cltcode, BookType, EnteredBy,  
  pdt, CheckedBy, l.narration, Isnull(V.Shortdesc, '') Shortdesc    
            FROM Ledger L WITH(NoLock),    
                  Vmast V WITH(NoLock)    
            WHERE Vdt > = @Fdate + ' 00:00:00'    
                  AND L.Vtyp = V.Vtype    
                  AND Vdt < = @Tdate +' 23:59:59'    
                  AND Cltcode > = @Fcode    
                  AND Cltcode < = @Tcode    
      End    
      Else    
      Begin    
            INSERT    
            INTO #ledgerdata    
            SELECT    
                l.vtyp, vno, edt, lno, acname, drcr, vamt, vdt, cltcode, BookType, EnteredBy,  
          pdt, CheckedBy, l.narration, Isnull(V.Shortdesc, '') Shortdesc    
            FROM Ledger L WITH(NoLock),    
                  Vmast V WITH(NoLock)    
            WHERE Edt > = @Fdate + ' 00:00:00'    
                  AND L.Vtyp = V.Vtype    
                  AND Edt < = @Tdate +' 23:59:59'    
                  AND Cltcode > = @Fcode    
                  AND Cltcode < = @Tcode    
      End    
    
    
    
/*getting Client List*/    
      SELECT    
            C2.Party_code,    
       C1.Long_Name,    
--          Bank_name = Isnull(C4.Bankid, ''),    
    L_address1,    
            L_address2,    
            L_address3,    
            L_city,    
            L_zip,    
            Res_phone1,    
            C1.Branch_cd,    
           Family,    
            C1.Sub_broker,    
            Trader,    
            Cl_type    
--          Cltdpid = Isnull(Cltdpid, '')    
      INTO #ledgerclients    
      FROM NSESLBS.Dbo.Client1 C1 WITH(NoLock),    
            NSESLBS.Dbo.Client2 C2 WITH(NoLock)    
/*      LEFT OUTER JOIN    
            NSESLBS.Dbo.Client4 C4 WITH(NoLock)    
            ON    
            (    
                  C2.Party_code = C4.Party_code    
                  AND Depository Not In ('Nsdl', 'Cdsl')    
-- AND Defdp = 1    
         AND Defdp = 0    
            )               */    
      WHERE C1.Cl_code = C2.Cl_code    
            AND C1.Branch_cd Like (    
            CASE    
                  WHEN @Statusid = 'Branch'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Sub_broker Like (    
            CASE    
                  WHEN @Statusid = 'Sub_broker'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
     AND Sub_broker Like (    
            CASE    
                  WHEN @Statusid = 'Subbroker'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Trader Like (    
            CASE    
                  WHEN @Statusid = 'Trader'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Area Like (    
            CASE    
   WHEN @Statusid = 'Area'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Region Like (    
            CASE    
                  WHEN @Statusid = 'Region'    
                  THEN @Statusname    
                  ELSE '%'    
           END    
            )    
            AND C1.Family Like (    
            CASE    
                  WHEN @Statusid = 'Family'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND C2.Party_code Like (    
            CASE    
                  WHEN @Statusid = 'Client'    
                  THEN @Statusname    
                  ELSE '%'    
          END    
         )    
            AND C1.Branch_cd Like @Strbranch +'%'    
           AND C2.Party_code > = @Fcode    
            AND C2.Party_code < = @Tcode    
    
    
      CREATE TABLE [#tmpledger] (    
       [Booktype] [char] (2)  NULL ,    
       [Voudt] [datetime] NULL ,    
       [Effdt] [datetime] NULL ,    
       [Shortdesc] [varchar] (35)  NULL ,    
       [Dramt] [money] NULL ,    
       [Cramt] [money] NULL ,    
       [Vno] [varchar] (12)  NULL ,    
       [Ddno] [varchar] (15)  NULL ,    
       [Narration] [varchar] (234)  NULL ,    
       [Cltcode] [varchar] (10)  NOT NULL ,    
       [Vtyp] [smallint] NULL ,    
       [Vdt] [varchar] (30)  NULL ,    
       [Edt] [varchar] (30)  NULL ,    
       [Acname] [varchar] (100)  NULL ,    
       [Opbal] [money] NULL ,    
       [L_address1] [varchar] (40)  NOT NULL ,    
       [L_address2] [varchar] (40)  NULL ,    
       [L_address3] [varchar] (40)  NULL ,    
     [L_city] [varchar] (40)  NULL ,    
       [L_zip] [varchar] (10)  NULL ,    
       [Res_phone1] [varchar] (15)  NULL ,    
  [Branch_cd] [varchar] (10)  NOT NULL ,    
       [Crosac] [varchar] (10)  NULL ,    
       [Ediff] [int] NULL ,    
       [Family] [varchar] (10)  NOT NULL ,    
       [Sub_broker] [varchar] (10)  NOT NULL ,    
       [Trader] [varchar] (20)  NOT NULL ,    
       [Cl_type] [varchar] (3)  NOT NULL ,    
--       [Bank_name] [varchar] (50)  NOT NULL ,    
--       [Cltdpid] [varchar] (16)  NOT NULL ,    
       [Lno] [int] NULL,    
       [Pdt] [datetime] NULL    
      ) ON [PRIMARY]    
    
    
/*getting Lddger Entries*/    
      INSERT    
            INTO #tmpledger    
      SELECT    
            L.Booktype,    
            Voudt = L.Vdt,    
            Effdt = L.Edt,    
            L.Shortdesc,    
            Dramt = (    
            CASE    
                  WHEN Upper(L.Drcr) = 'D'    
                  THEN L.Vamt    
                  ELSE 0    
            END    
            ),    
            Cramt = (                            CASE    
                  WHEN Upper(L.Drcr) = 'C'    
                  THEN L.Vamt    
                  ELSE 0    
            END    
            ),    
            L.Vno,    
            Ddno = Space(15),    
            L.Narration,    
            C.Party_code Cltcode,    
            L.Vtyp,    
            Convert(Varchar, L.Vdt, 103) Vdt,    
            Convert(Varchar, L.Edt, 103) Edt,    
--            L.Acname ,    
            C.Long_Name,    
            Opbal = Vamt,    
    C.L_address1,    
            C.L_address2,    
            C.L_address3,    
            C.L_city,    
            C.L_zip,    
            C.Res_phone1,    
            C.Branch_cd,    
            L.Cltcode Crosac ,    
            Ediff = Datediff(D, L.Edt, Getdate()),    
            C.Family,    
            C.Sub_broker,    
            C.Trader,    
            C.Cl_type,    
--          C.Bank_name,    
--          C.Cltdpid,    
            L.Lno,    
       L.Pdt    
      FROM #ledgerdata L WITH(NoLock)    
      RIGHT OUTER JOIN    
            #ledgerclients C WITH(NoLock)    
            ON    
            (    
                  L.Cltcode = C.Party_code    
            )    
    
    
    
/*updating Opening Blanace*/    
     UPDATE    
            #tmpledger    
            SET Opbal = 0    
    
      UPDATE    
            #tmpledger    
            SET Opbal = T.Oppbal    
      FROM #tmpledger L WITH(NoLock),    
            #oppbalance T WITH(NoLock)    
      WHERE L.Cltcode = T.Cltcode    
    
    
    
/*updating Cheque Number*/    
      UPDATE    
            #tmpledger    
            SET Ddno = L1.Ddno    
      FROM Ledger1 L1 WITH(NoLock)    
      WHERE L1.Vno = #tmpledger.Vno    
            AND L1.Vtyp = #tmpledger.Vtyp    
            AND L1.Booktype = #tmpledger.Booktype    
            AND L1.Lno = #tmpledger.Lno    
    
    
    
/*updating Cross Account Code*/    
      UPDATE    
            #tmpledger    
            SET #tmpledger.Crosac = B.Cltcode    
      FROM Ledger B WITH(NoLock),    
            Acmast V WITH(NoLock)    
      WHERE B.Cltcode = V.Cltcode    
            AND V.Accat = 2    
            AND #tmpledger.Booktype = B.Booktype    
            AND #tmpledger.Vno = B.Vno    
            AND #tmpledger.Vtyp = B.Vtyp    
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')    
    
    
    
/*updating Bank Name*/    
/*      UPDATE    
            #tmpledger    
            SET #tmpledger.Bank_name = B.Bank_name    
      FROM NSESLBS.Dbo.Pobank B WITH(NoLock)    
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name))    
*/    
    
      If @Strorder = 'Accode'    
      Begin    
If @Selectby = 'Vdt'    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                        AND Accat In ('4', '104')    
        AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Cltcode,    
                        Voudt, Pdt    
            End    
            Else    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                   AND Accat In ('4', '104')    
         AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Cltcode,    
                        Effdt, Pdt    
            End    
      End    
      Else    
      Begin    
            If @Selectby = 'Vdt'    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                        AND Accat In ('4', '104')    
        AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Acname,    
                        Voudt, Pdt    
            End    
            Else    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                        AND Accat In ('4', '104')    
        AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Acname,    
                        Effdt, Pdt    
            End    
      End    
    
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_ccpl
-- --------------------------------------------------
--Exec rpt_acc_partyledger_all 'Aug  1 2007','Aug  8 2007','0000','zzzz','ACCODE','vdt','broker','broker','', 'N','N'      
      
      
      
--Exec rpt_acc_partyledger 'Jan  1 2007','Jan 25 2007','051','051','ACCODE','vdt','broker','broker',''            
            
CREATE Procedure [dbo].[Rpt_acc_partyledger_ccpl]            
(              
 @Fdate Varchar(11),            /* As Mmm Dd Yyyy */                    
 @Tdate Varchar(11),            /* As Mmm Dd Yyyy */                    
 @Fcode Varchar(10),                    
 @Tcode Varchar(10),                    
 @Strorder Varchar(6),                    
 @Selectby Varchar(3),                    
 @Statusid Varchar(15),                    
 @Statusname Varchar(15),                    
 @Strbranch Varchar(10)                    
)              
              
As                    
                    
/*========================================================================              
      Exec rpt_acc_partyledger_all               
            'Nov  1 2005',              
            'Dec 31 2005',              
            'a',              
            'zzz',              
            'ACCODE',              
            'vdt',              
            'broker',              
            'undefined',              
            ''              
========================================================================*/              
              
Declare               
 @@Opendate   As Varchar(11)                    
                    
Set Transaction Isolation Level Read Uncommitted                    
                    
                    
/*getting Last Opening Date */                    
      If Upper(@Selectby) = 'Vdt'                    
      Begin                    
            SELECT               
                  @@Opendate =               
                  (               
                        SELECT               
                              Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11)               
                        FROM Ledger WITH(NoLock)               
                        WHERE Vtyp = 18               
                              AND Vdt < = @Fdate               
                  )               
      End                    
      Else                    
      Begin                    
            SELECT               
                  @@Opendate =               
                  (               
                        SELECT               
                              Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11)               
                        FROM Ledger WITH(NoLock)               
                        WHERE Vtyp = 18               
                              AND Edt < = @Fdate               
                  )               
      End                    
                          
                    
      /*creating Blank Table For Opening Balance*/                    
            SELECT               
                  Cltcode,               
                  Oppbal = Vamt               
            INTO #oppbalance               
            FROM Ledger WITH(NoLock)               
            WHERE 1 = 2               
                          
                    
      /*getting Opening Balance*/                    
      If @Selectby = 'Vdt'                    
      Begin                    
            If @@Opendate = @Fdate                     
            Begin                    
                  INSERT               
                  INTO #oppbalance               
                  SELECT               
                        Cltcode,               
                        Oppbal = Isnull(Sum(               
                        CASE               
                              WHEN Upper(B.Drcr) = 'D'               
                              THEN B.Vamt               
                              ELSE -b.Vamt               
                        END              
                        ), 0)               
                  FROM Ledger B WITH(NoLock)               
                  WHERE B.Cltcode > = @Fcode               
                        AND B.Cltcode < = @Tcode               
                        AND B.Vdt Like @Fdate + '%'               
                        AND Vtyp = 18               
                  GROUP BY Cltcode               
            End                    
            Else                    
            Begin                    
                  INSERT               
                  INTO #oppbalance               
                  SELECT          
                        Cltcode,               
                        Oppbal = Isnull(Sum(               
                        CASE               
                              WHEN Upper(B.Drcr) = 'D'               
                       THEN B.Vamt               
                              ELSE -b.Vamt               
                        END              
                        ), 0)               
                  FROM Ledger B WITH(NoLock)                         WHERE B.Cltcode > = @Fcode               
                        AND B.Cltcode < = @Tcode               
                        AND B.Vdt > = @@Opendate + ' 00:00:00'               
                        AND Vdt < @Fdate               
               GROUP BY Cltcode               
            End                    
      End                     
      Else                    
      Begin                     
            If @@Opendate = @Fdate                     
            Begin                  
                  INSERT               
                  INTO #oppbalance               
                  SELECT               
                        Cltcode,               
Opbal = Sum(Opbal)               
                  FROM               
                        (               
                              SELECT               
                                    Cltcode,               
                                    Opbal = Isnull(Sum(               
                                    CASE               
                                          WHEN Upper(Drcr) = 'D'               
                                          THEN Vamt               
                                          ELSE -vamt               
                                    END              
                                    ), 0)               
                              FROM Ledger WITH(NoLock)               
                              WHERE Cltcode = @Fcode               
                                    AND Edt Like @@Opendate + '%'               
                                    AND Vtyp = 18               
                              GROUP BY Cltcode               
                              UNION ALL               
                              SELECT               
                                    Cltcode,               
                                    Oppbal = Isnull(Sum(               
                                    CASE               
                                          WHEN Upper(B.Drcr) = 'C'               
                                          THEN B.Vamt               
                                          ELSE -b.Vamt               
                                    END              
                                    ), 0)               
                              FROM Ledger B WITH(NoLock)               
                              WHERE B.Cltcode > = @Fcode               
                                    AND B.Cltcode < = @Tcode               
                                    AND B.Vdt < @@Opendate              
                                    AND Edt >= @@Opendate               
                              GROUP BY Cltcode               
                        )               
                        T               
                  GROUP BY Cltcode               
            End                  
            Else                  
            Begin                  
                  INSERT         
                  INTO #oppbalance               
                  SELECT               
                        Cltcode,               
                        Opbal = Sum(Opbal)               
                  FROM               
                        (               
                              SELECT               
                Cltcode,               
                                    Opbal = Isnull(Sum(               
                                    CASE               
                                          WHEN Upper(Drcr) = 'D'               
                                          THEN Vamt               
                                          ELSE -vamt         
                                    END              
                                    ), 0)               
               FROM Ledger WITH(NoLock)               
                              WHERE Cltcode = @Fcode               
                                    AND Edt Like @@Opendate + '%'               
                                    AND Vtyp = 18               
                              GROUP BY Cltcode               
                              UNION ALL               
                   SELECT               
                                    Cltcode,               
                                    Opbal = Sum(               
                                    CASE               
                                          WHEN Upper(Drcr) = 'D'               
                                          THEN Vamt               
                                          ELSE -vamt             
                                    END              
                                    )               
                              FROM Ledger WITH(NoLock)               
                              WHERE Cltcode = @Fcode               
                                    AND Edt > = @@Opendate + ' 00:00:00'               
                                    AND Edt < @Fdate               
                                    AND Vtyp <> 18               
                              GROUP BY Cltcode               
                              UNION ALL               
                              SELECT               
                                    Cltcode,               
                                    Oppbal = Isnull(Sum(               
                                    CASE               
                                          WHEN Upper(B.Drcr) = 'C'               
                                          THEN B.Vamt               
      ELSE -b.Vamt               
                                    END              
                                    ), 0)               
                              FROM Ledger B WITH(NoLock)               
                              WHERE B.Cltcode > = @Fcode               
                                    AND B.Cltcode < = @Tcode               
                                    AND B.Vdt < @@Opendate               
                                    AND Edt >= @@Opendate               
                              GROUP BY Cltcode               
                        )               
                        T               
                  GROUP BY Cltcode               
            End                  
      End                    
                          
                    
      /*generating Blank Structure For Filtered Ledger */                    
            SELECT               
                  Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,L.Narration,               
                  Shortdesc = Space(35)               
            INTO #ledgerdata               
            FROM Ledger L WITH(NoLock)               
            WHERE 1 = 2               
      
                         
                    
                    
      /*getting Fiiltered Ledger*/                    
      If @Selectby = 'Vdt'         
      Begin                    
            INSERT               
            INTO #ledgerdata               
            SELECT               
                  Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,L.Narration,               
                  Isnull(V.Shortdesc, '') Shortdesc               
            FROM Ledger L WITH(NoLock),               
                  Vmast V WITH(NoLock)             
            WHERE Vdt > = @Fdate + ' 00:00:00'               
                  AND L.Vtyp = V.Vtype               
                  AND Vdt < = @Tdate +' 23:59:59'               
                  AND Cltcode > = @Fcode               
                  AND Cltcode < = @Tcode               
      End                     
      Else                    
      Begin                    
            INSERT               
            INTO #ledgerdata               
            SELECT               
                  Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,L.Narration,               
                  Isnull(V.Shortdesc, '') Shortdesc               
            FROM Ledger L WITH(NoLock),               
                  Vmast V WITH(NoLock)               
            WHERE Edt > = @Fdate + ' 00:00:00'               
                  AND L.Vtyp = V.Vtype               
                  AND Edt < = @Tdate +' 23:59:59'               
                  AND Cltcode > = @Fcode               
                  AND Cltcode < = @Tcode               
      End                    
                    
              
              
/*getting Client List*/                    
      SELECT               
            C2.Party_code,              
   C1.Long_Name,              
            Bank_name = Isnull(C4.Bankid, ''),               
            L_address1,               
            L_address2,               
            L_address3,               
            L_city,               
            L_zip,               
            Res_phone1,               
            C1.Branch_cd,               
           Family,               
            C1.Sub_broker,               
            Trader,               
            Cl_type,               
            Cltdpid = Isnull(Cltdpid, '')               
      INTO #ledgerclients               
      FROM Msajag.Dbo.Client1 C1 WITH(NoLock),               
    Msajag.Dbo.Client5 C5 WITH(NoLock),               
          Msajag.Dbo.Client2 C2 WITH(NoLock)               
          LEFT OUTER JOIN               
            Msajag.Dbo.Client4 C4 WITH(NoLock)               
            ON               
            (              
                  C2.Party_code = C4.Party_code               
                  AND Depository Not In ('Nsdl', 'Cdsl')               
-- AND Defdp = 1              
                  AND Defdp = 0          
            )               
      WHERE C1.Cl_code = C2.Cl_code               
        AND C1.CL_CODE = C5.CL_CODE  
     AND INACTIVEFROM >= GETDATE()   
            AND C1.Branch_cd Like (              
            CASE               
                  WHEN @Statusid = 'Branch'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )               
            AND Sub_broker Like (              
            CASE               
                  WHEN @Statusid = 'Sub_broker'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )               
     AND Sub_broker Like (              
            CASE               
                  WHEN @Statusid = 'Subbroker'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )               
            AND Trader Like (              
            CASE               
WHEN @Statusid = 'Trader'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )               
            AND Area Like (              
            CASE               
                  WHEN @Statusid = 'Area'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )         
            AND Region Like (              
            CASE               
                  WHEN @Statusid = 'Region'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )              
            AND C1.Family Like (              
            CASE               
                  WHEN @Statusid = 'Family'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
            )               
            AND C2.Party_code Like (              
            CASE               
                  WHEN @Statusid = 'Client'               
                  THEN @Statusname               
                  ELSE '%'               
            END              
         )               
            AND C1.Branch_cd Like @Strbranch +'%'               
            AND C2.Party_code > = @Fcode               
            AND C2.Party_code < = @Tcode               
              
              
      CREATE TABLE [#tmpledger] (              
       [Booktype] [char] (2)  NULL ,              
       [Voudt] [datetime] NULL ,              
       [Effdt] [datetime] NULL ,              
       [Shortdesc] [varchar] (35)  NULL ,              
       [Dramt] [money] NULL ,              
       [Cramt] [money] NULL ,              
       [Vno] [varchar] (12)  NULL ,              
       [Ddno] [varchar] (15)  NULL ,              
       [Narration] [varchar] (234)  NULL ,              
       [Cltcode] [varchar] (10)  NOT NULL ,              
       [Vtyp] [smallint] NULL ,              
      [Vdt] [varchar] (30)  NULL ,              
       [Edt] [varchar] (30)  NULL ,              
       [Acname] [varchar] (100)  NULL ,              
       [Opbal] [money] NULL ,              
       [L_address1] [varchar] (40)  NOT NULL ,              
       [L_address2] [varchar] (40)  NULL ,              
       [L_address3] [varchar] (40)  NULL ,              
       [L_city] [varchar] (40)  NULL ,              
       [L_zip] [varchar] (10)  NULL ,              
       [Res_phone1] [varchar] (15)  NULL ,              
       [Branch_cd] [varchar] (10)  NOT NULL ,              
       [Crosac] [varchar] (10)  NULL ,              
       [Ediff] [int] NULL ,              
       [Family] [varchar] (10)  NOT NULL ,              
       [Sub_broker] [varchar] (10)  NOT NULL ,              
       [Trader] [varchar] (20)  NOT NULL ,              
       [Cl_type] [varchar] (3)  NOT NULL ,              
       [Bank_name] [varchar] (50)  NOT NULL ,              
       [Cltdpid] [varchar] (16)  NOT NULL ,              
       [Lno] [int] NULL,            
       [Pdt] [datetime] NULL            
      ) ON [PRIMARY]              
              
                    
/*getting Lddger Entries*/                    
      INSERT               
            INTO #tmpledger               
      SELECT               
            L.Booktype,               
 Voudt = L.Vdt,               
            Effdt = L.Edt,               
            L.Shortdesc,               
            Dramt = (              
            CASE               
                  WHEN Upper(L.Drcr) = 'D'               
                  THEN L.Vamt               
                  ELSE 0               
            END              
            ),               
            Cramt = (              
            CASE               
                  WHEN Upper(L.Drcr) = 'C'               
                  THEN L.Vamt               
                  ELSE 0             
            END              
            ),               
            L.Vno,               
            Ddno = Space(15),               
            L.Narration,               
            C.Party_code Cltcode,               
            L.Vtyp,               
            Convert(Varchar, L.Vdt, 103) Vdt,               
            Convert(Varchar, L.Edt, 103) Edt,               
--            L.Acname ,               
            C.Long_Name,              
            Opbal = Vamt,               
            C.L_address1,               
            C.L_address2,               
            C.L_address3,               
            C.L_city,               
            C.L_zip,               
            C.Res_phone1,               
            C.Branch_cd,               
            L.Cltcode Crosac ,               
            Ediff = Datediff(D, L.Edt, Getdate()),               
            C.Family,               
            C.Sub_broker,               
            C.Trader,        
            C.Cl_type,               
            C.Bank_name,               
            C.Cltdpid,               
            L.Lno,            
  L.Pdt               
      FROM #ledgerdata L WITH(NoLock)               
      RIGHT OUTER JOIN               
            #ledgerclients C WITH(NoLock)               
            ON               
            (              
                  L.Cltcode = C.Party_code              
            )               
              
              
                    
/*updating Opening Blanace*/                    
      UPDATE               
            #tmpledger               
            SET Opbal = 0               
              
      UPDATE               
            #tmpledger               
            SET Opbal = T.Oppbal               
      FROM #tmpledger L WITH(NoLock),               
            #oppbalance T WITH(NoLock)               
      WHERE L.Cltcode = T.Cltcode               
                    
              
              
/*updating Cheque Number*/                    
      UPDATE               
            #tmpledger               
            SET Ddno = L1.Ddno               
      FROM Ledger1 L1 WITH(NoLock)               
      WHERE L1.Vno = #tmpledger.Vno               
            AND L1.Vtyp = #tmpledger.Vtyp               
            AND L1.Booktype = #tmpledger.Booktype               
            AND L1.Lno = #tmpledger.Lno               
                    
              
              
/*updating Cross Account Code*/                    
      UPDATE               
       #tmpledger               
            SET #tmpledger.Crosac = B.Cltcode               
      FROM Ledger B WITH(NoLock),               
            Acmast V WITH(NoLock)               
      WHERE B.Cltcode = V.Cltcode               
            AND V.Accat = 2               
            AND #tmpledger.Booktype = B.Booktype               
            AND #tmpledger.Vno = B.Vno               
            AND #tmpledger.Vtyp = B.Vtyp               
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')               
                    
              
              
/*updating Bank Name*/                                   
      UPDATE               
            #tmpledger               
            SET #tmpledger.Bank_name = B.Bank_name               
      FROM Msajag.Dbo.Pobank B WITH(NoLock)               
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name))               
              
                    
      If @Strorder = 'Accode'                    
      Begin                    
            If @Selectby = 'Vdt'                    
            Begin                     
                  SELECT               
                        L.*               
                  FROM #tmpledger L WITH(NoLock),               
                        Acmast A WITH(NoLock)               
                  WHERE L.Cltcode = A.Cltcode               
         AND Accat In ('4', '104')               
    AND (cramt <> 0 or dramt <> 0 or opbal <> 0)              
                  ORDER BY L.Cltcode,            
                        Voudt, Pdt            
            End                    
            Else                    
            Begin                    
                  SELECT               
                        L.*               
                  FROM #tmpledger L WITH(NoLock),               
                        Acmast A WITH(NoLock)               
                  WHERE L.Cltcode = A.Cltcode               
                        AND Accat In ('4', '104')               
                  ORDER BY L.Cltcode,              
                        Effdt, Pdt            
            End                    
      End                    
      Else                    
      Begin                    
            If @Selectby = 'Vdt'                    
            Begin                     
                  SELECT               
                        L.*               
                  FROM #tmpledger L WITH(NoLock),               
                        Acmast A WITH(NoLock)               
                  WHERE L.Cltcode = A.Cltcode               
                        AND Accat In ('4', '104')           
                  ORDER BY L.Acname,             
                        Voudt, Pdt               
            End                    
            Else                    
            Begin                    
                  SELECT               
                        L.*               
                  FROM #tmpledger L WITH(NoLock),               
                        Acmast A WITH(NoLock)               
                  WHERE L.Cltcode = A.Cltcode               
                        AND Accat In ('4', '104')               
                  ORDER BY L.Acname,              
                        Effdt, Pdt            
            End                    
      End                    
                    
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_COMBINED
-- --------------------------------------------------
--EXEC RPT_ACC_PARTYLEDGER_ALL 'JAN 1 2007','JAN 25 2007','051','051','ACCODE','VDT','BROKER','BROKER','', 'N'            
            
            
CREATE PROCEDURE [DBO].[RPT_ACC_PARTYLEDGER_COMBINED]              
	@FDATE VARCHAR(11),            /* AS MMM DD YYYY */              
	@TDATE VARCHAR(11),            /* AS MMM DD YYYY */              
	@FCODE VARCHAR(10),              
	@TCODE VARCHAR(10),              
	@STRORDER VARCHAR(6),              
	@SELECTBY VARCHAR(3),              
	@STATUSID VARCHAR(15),              
	@STATUSNAME VARCHAR(15),              
	@STRBRANCH VARCHAR(10),         
	@ORDERFLG VARCHAR(1) = 'N' ,          
	@SINGLE VARCHAR(1) = 'N'              
              
AS              
              
BEGIN              
              
CREATE TABLE [DBO].[#TMPLEDGERNEW] 
(              
	[BOOKTYPE] [CHAR] (2) NULL ,              
	[VOUDT] [DATETIME] NULL ,              
	[EFFDT] [DATETIME] NULL ,              
	[SHORTDESC] [CHAR] (6) NULL ,              
	[DRAMT] [MONEY] NULL ,              
	[CRAMT] [MONEY] NULL ,              
	[VNO] [VARCHAR] (12) NULL ,              
	[DDNO] [VARCHAR] (15) NULL ,              
	[NARRATION] [VARCHAR] (234) NULL ,              
	[CLTCODE] [VARCHAR] (10) NOT NULL ,              
	[VTYP] [SMALLINT] NULL ,              
	[VDT] [VARCHAR] (30) NULL ,              
	[EDT] [VARCHAR] (30) NULL ,              
	[ACNAME] [VARCHAR] (100) NULL ,              
	[OPBAL] [MONEY] NULL ,              
	[L_ADDRESS1] [VARCHAR] (40) NULL ,              
	[L_ADDRESS2] [VARCHAR] (40) NULL ,              
	[L_ADDRESS3] [VARCHAR] (40) NULL ,              
	[L_CITY] [VARCHAR] (40) NULL ,              
	[L_ZIP] [VARCHAR] (10) NULL ,              
	[RES_PHONE1] [VARCHAR] (15) NULL ,              
	[BRANCH_CD] [VARCHAR] (10) NULL ,              
	[CROSAC] [VARCHAR] (10) NULL ,              
	[EDIFF] [INT] NULL ,              
	[FAMILY] [VARCHAR] (10) NULL ,              
	[SUB_BROKER] [VARCHAR] (10) NULL ,              
	[TRADER] [VARCHAR] (20) NULL ,              
	[CL_TYPE] [VARCHAR] (3) NULL ,              
	[BANK_NAME] [VARCHAR] (50) NULL ,              
	[CLTDPID] [VARCHAR] (16) NULL ,              
	[LNO] [DECIMAL](5, 0) NULL ,              
	[PDT] [DATETIME] NULL ,              
	[SEGMENT] [VARCHAR] (4) NULL,              
	[ENTITY] [VARCHAR] (50) NULL,              
	[ORDERSEG][BIGINT] NULL              
) ON [PRIMARY]              
              
              
              
INSERT INTO #TMPLEDGERNEW 
	(BOOKTYPE, VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE,              
	VTYP, VDT, EDT, ACNAME, OPBAL, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP, RES_PHONE1, BRANCH_CD,              
	CROSAC, EDIFF, FAMILY, SUB_BROKER, TRADER, CL_TYPE, BANK_NAME, CLTDPID, LNO, PDT)              
EXEC ACCOUNT.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
      
IF @ORDERFLG = 'N'      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL              
END      
ELSE      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='CAPITAL - NSE', ORDERSEG = 1 WHERE SEGMENT IS NULL              
END      
            
INSERT INTO #TMPLEDGERNEW
	(BOOKTYPE, VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE,              
	VTYP, VDT, EDT, ACNAME, OPBAL, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP, RES_PHONE1, BRANCH_CD,              
	CROSAC, EDIFF, FAMILY, SUB_BROKER, TRADER, CL_TYPE, BANK_NAME, CLTDPID, LNO, PDT)              
EXEC ACCOUNTBSE.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH   

IF @ORDERFLG = 'N'      
BEGIN        
	UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL              
END      
ELSE      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='CAPITAL - BSE', ORDERSEG = 2 WHERE SEGMENT IS NULL         
END      
--NSEFO START              
INSERT INTO #TMPLEDGERNEW
	(BOOKTYPE, VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE,              
	VTYP, VDT, EDT, ACNAME, OPBAL, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP, RES_PHONE1, BRANCH_CD,              
	CROSAC, EDIFF, FAMILY, SUB_BROKER, TRADER, CL_TYPE, BANK_NAME, CLTDPID, LNO, PDT)              
EXEC ACCOUNTFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
              
--NSEFO END              
IF @ORDERFLG = 'N'      
BEGIN                
	UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL              
END      
ELSE      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='DERIVATIVES - NSE', ORDERSEG = 3 WHERE SEGMENT IS NULL            
END      
/*              
--BSEFO START              
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,              
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,              
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)              
EXEC ACCOUNTBSEFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
              
--BSEFO END              
              
UPDATE #TMPLEDGERNEW SET SEGMENT='4BFO',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL              
*/            
              
PRINT '1'            
--MARGIN              
INSERT INTO #TMPLEDGERNEW
	(BOOKTYPE, VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE,              
	VTYP, VDT, EDT, ACNAME, OPBAL, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP, RES_PHONE1, BRANCH_CD,              
	CROSAC, EDIFF, FAMILY, SUB_BROKER, TRADER, CL_TYPE, BANK_NAME, CLTDPID, LNO, PDT)              
EXEC ACCOUNT.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              

IF @ORDERFLG = 'N'      
BEGIN                
	UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL              
END      
ELSE      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN - NSE', ORDERSEG = 4 WHERE SEGMENT IS NULL              
END      
      
            
PRINT '2'              
INSERT INTO #TMPLEDGERNEW
	(BOOKTYPE, VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE,              
	VTYP, VDT, EDT, ACNAME, OPBAL, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP, RES_PHONE1, BRANCH_CD,              
	CROSAC, EDIFF, FAMILY, SUB_BROKER, TRADER, CL_TYPE, BANK_NAME, CLTDPID, LNO, PDT)              
EXEC ACCOUNTBSE.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
       
IF @ORDERFLG = 'N'      
BEGIN                 
	UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL              
END       
ELSE      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN - BSE', ORDERSEG = 5 WHERE SEGMENT IS NULL              
END      
             
PRINT '3'            
--NSEFO START              
INSERT INTO #TMPLEDGERNEW
	(BOOKTYPE, VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE,              
	VTYP, VDT, EDT, ACNAME, OPBAL, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_ZIP, RES_PHONE1, BRANCH_CD,              
	CROSAC, EDIFF, FAMILY, SUB_BROKER, TRADER, CL_TYPE, BANK_NAME, CLTDPID, LNO, PDT)              
EXEC ACCOUNTFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
--NSEFO END              
              
IF @ORDERFLG = 'N'      
BEGIN                
	UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL              
END       
ELSE      
BEGIN      
	UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN - NFO', ORDERSEG = 6 WHERE SEGMENT IS NULL              
END      
      
      

            
/*            
PRINT '4'
--BSEFO START              
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,      
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,              
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)              
EXEC ACCOUNTBSEFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
--BSEFO END              
              
              
        
UPDATE #TMPLEDGERNEW SET SEGMENT='8BFO',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL              
*/            
      
IF @ORDERFLG = 'N'      
BEGIN       
	SELECT 
		CLTCODE, SEGMENT, ORDERSEG, OPBAL = MAX(OPBAL) 
	INTO 
		#OPBAL 
	FROM 
		#TMPLEDGERNEW         
	GROUP BY 
		CLTCODE, SEGMENT, ORDERSEG        	

	SELECT 
		CLTCODE, ORDERSEG, OPBAL = SUM(OPBAL) 
	INTO 
		#FINOPBAL 
	FROM 
		#OPBAL         
	GROUP BY 
		CLTCODE, ORDERSEG        


	UPDATE                 
		#TMPLEDGERNEW               
	SET OPBAL = 0                 

	UPDATE                 
		#TMPLEDGERNEW                
	SET 
		OPBAL = T.OPBAL                 
	FROM 
		#TMPLEDGERNEW L WITH(NOLOCK),                 
		#FINOPBAL T WITH(NOLOCK)                 
	WHERE 
		L.CLTCODE = T.CLTCODE  AND L.ORDERSEG = T.ORDERSEG             

END      
        
              
IF @STRORDER = 'ACCODE'              
BEGIN              
	IF @SELECTBY = 'VDT'              
	BEGIN              
		IF @ORDERFLG = 'N'      
		BEGIN    
			SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VOUDT              
		END      
		ELSE      
		BEGIN      
			SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VOUDT              
		END      
	END              
	ELSE              
	BEGIN              
		IF @ORDERFLG = 'N'      
		BEGIN      
			SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,EFFDT       
		END      
		ELSE      
		BEGIN         
			SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,EFFDT,ORDERSEG      
		END          
	END              
	END              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_COMM
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[RPT_ACC_PARTYLEDGER_COMM]                            
(                              
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                                    
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                                    
 @FCODE VARCHAR(10),                                    
 @TCODE VARCHAR(10),                                    
 @STRORDER VARCHAR(6),                                    
 @SELECTBY VARCHAR(3),                                    
 @STATUSID VARCHAR(15),                                    
 @STATUSNAME VARCHAR(15),                                    
 @STRBRANCH VARCHAR(10)                                    
)                              
                              
AS                                    
                                    
/*========================================================================                              
      EXEC Rpt_acc_partyledger_Comm_ALL                               
            'NOV  1 2005',                              
            'DEC 31 2005',                              
            'A',                              
            'ZZZ',                              
            'ACCODE',                              
            'VDT',                              
            'BROKER',                              
            'UNDEFINED',                              
            ''                              
========================================================================*/                              
                              
DECLARE                               
 @@OPENDATE   AS VARCHAR(11)                                    
-------------------------------------------------              
-- CREATING TEMPORARY TABLE              
-------------------------------------------------              
CREATE TABLE #OPPBALANCE              
(              
 CLTCODE VARCHAR(10),              
 OPPBAL MONEY              
)              
              
CREATE TABLE #LEDGERCLIENTS(              
 [PARTY_CODE] [CHAR](10) NOT NULL,              
 [LONG_NAME] [VARCHAR](100) NULL,              
 [BANK_NAME] [VARCHAR](50) NOT NULL,              
 [L_ADDRESS1] [VARCHAR](40) NOT NULL,              
 [L_ADDRESS2] [VARCHAR](40) NULL,              
 [L_ADDRESS3] [VARCHAR](40) NULL,              
 [L_CITY] [VARCHAR](40) NULL,              
 [L_ZIP] [VARCHAR](10) NULL,              
 [RES_PHONE1] [VARCHAR](15) NULL,              
 [BRANCH_CD] [VARCHAR](10) NULL,              
 [FAMILY] [VARCHAR](10) NOT NULL,              
 [SUB_BROKER] [VARCHAR](10) NOT NULL,              
 [TRADER] [VARCHAR](20) NULL,              
 [CL_TYPE] [VARCHAR](3) NOT NULL,              
 [CLTDPID] [VARCHAR](20) NOT NULL              
)              
              
CREATE TABLE #LEDGERDATA (              
 [VTYP] [SMALLINT] NOT NULL,              
 [VNO] [VARCHAR](12) NOT NULL,              
 [EDT] [DATETIME] NULL,              
 [LNO] [INT] NOT NULL,              
 [ACNAME] [VARCHAR](100) NOT NULL,              
 [DRCR] [CHAR](1) NULL,              
 [VAMT] [MONEY] NULL,              
 [VDT] [DATETIME] NULL,              
 [VNO1] [VARCHAR](12) NULL,              
 [REFNO] [CHAR](12) NULL,              
 [BALAMT] [MONEY] NOT NULL,              
 [NODAYS] [INT] NULL,              
 [CDT] [DATETIME] NULL,              
 [CLTCODE] [VARCHAR](10) NOT NULL,              
 [BOOKTYPE] [CHAR](2) NOT NULL,              
 [ENTEREDBY] [VARCHAR](25) NULL,              
 [PDT] [DATETIME] NULL,              
 [CHECKEDBY] [VARCHAR](25) NULL,              
 [ACTNODAYS] [INT] NULL,              
 [NARRATION] [VARCHAR](234) NULL,              
 [SHORTDESC] [VARCHAR](35) NULL              
)              
-------------------------------------------------              
-- CREATING TEMPORARY TABLES              
-------------------------------------------------              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
                 
/*GETTING LAST OPENING DATE */                                    
      IF UPPER(@SELECTBY) = 'VDT'                                    
      BEGIN                           SELECT                               
                  @@OPENDATE =                               
                  (                               
                    SELECT                
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11)                               
                        FROM LEDGER WITH(NOLOCK)                               
         WHERE VTYP = 18                               
                              AND VDT < = @FDATE                               
                  )                               
      END                                    
      ELSE                                    
      BEGIN                                    
            SELECT                               
                  @@OPENDATE =                               
                  (                               
                        SELECT                               
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)                               
                        FROM LEDGER WITH(NOLOCK)                               
                        WHERE VTYP = 18                               
                              AND EDT < = @FDATE                               
                  )                               
      END                                    
                                          
                                 
      /*GETTING OPENING BALANCE*/                                    
      IF @SELECTBY = 'VDT'                                    
      BEGIN                                    
            IF @@OPENDATE = @FDATE                                     
            BEGIN                                    
                  INSERT                               
                  INTO #OPPBALANCE                               
                  SELECT                               
                        CLTCODE,                               
                        OPPBAL = ISNULL(SUM(                               
                        CASE                               
                              WHEN UPPER(B.DRCR) = 'D'                               
                              THEN B.VAMT                               
                             ELSE -B.VAMT                               
                        END                              
                        ), 0)                               
                  FROM LEDGER B WITH(NOLOCK)                               
                  WHERE B.CLTCODE > = @FCODE                               
                        AND B.CLTCODE < = @TCODE                               
                        AND B.VDT LIKE @FDATE + '%'                               
                        AND VTYP = 18                               
                  GROUP BY CLTCODE                               
            END                                    
            ELSE                                    
            BEGIN                                    
                  INSERT                               
                  INTO #OPPBALANCE                               
                  SELECT                          
                        CLTCODE,                               
                        OPPBAL = ISNULL(SUM(                               
                        CASE                               
                              WHEN UPPER(B.DRCR) = 'D'                               
                       THEN B.VAMT                               
                              ELSE -B.VAMT                               
                        END                              
                        ), 0)                               
                  FROM LEDGER B WITH(NOLOCK)                             
      WHERE B.CLTCODE > = @FCODE               
                        AND B.CLTCODE < = @TCODE                               
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'                               
                        AND VDT < @FDATE              
               GROUP BY CLTCODE                               
            END                                  END                                     
      ELSE                                    
      BEGIN                                     
            IF @@OPENDATE = @FDATE                                 
            BEGIN                                  
                  INSERT                               
                  INTO #OPPBALANCE                               
     SELECT                               
                        CLTCODE,                               
      OPBAL = SUM(OPBAL)                               
            FROM                               
                        (                               
                              SELECT                               
                                    CLTCODE,                               
                                    OPBAL = ISNULL(SUM(                               
                                    CASE                               
                                          WHEN UPPER(DRCR) = 'D'                               
                                          THEN VAMT                               
                                          ELSE -VAMT                               
                                    END                              
                                    ), 0)                               
                              FROM LEDGER WITH(NOLOCK)                               
                              WHERE CLTCODE = @FCODE                               
                                    AND EDT LIKE @@OPENDATE + '%'                               
                                    AND VTYP = 18                               
                              GROUP BY CLTCODE                               
                              UNION ALL                               
                              SELECT                               
                                    CLTCODE,                               
                                    OPPBAL = ISNULL(SUM(                               
                                    CASE                               
                                          WHEN UPPER(B.DRCR) = 'C'                               
                                          THEN B.VAMT                               
                                          ELSE -B.VAMT                               
                                    END                              
                                    ), 0)                               
                              FROM LEDGER B WITH(NOLOCK)                               
                              WHERE B.CLTCODE > = @FCODE                               
                                    AND B.CLTCODE < = @TCODE                               
                                    AND B.VDT < @@OPENDATE                              
                                    AND EDT >= @@OPENDATE                               
                         GROUP BY CLTCODE                               
                        )                               
                        T                               
                  GROUP BY CLTCODE                               
            END                                  
            ELSE                                  
            BEGIN                                  
                  INSERT                         
                  INTO #OPPBALANCE                               
                  SELECT                               
                        CLTCODE,                  
                        OPBAL = SUM(OPBAL)                               
                  FROM                               
                        (                               
                              SELECT                               
                CLTCODE,                               
                                    OPBAL = ISNULL(SUM(                               
                       CASE                               
                                          WHEN UPPER(DRCR) = 'D'                               
                                          THEN VAMT                               
                                          ELSE -VAMT                         
                                    END                              
    ), 0)                              
               FROM LEDGER WITH(NOLOCK)                             
                              WHERE CLTCODE = @FCODE                               
                                    AND EDT LIKE @@OPENDATE + '%'                               
                                    AND VTYP = 18                               
                              GROUP BY CLTCODE                               
                              UNION ALL                               
                   SELECT                               
               CLTCODE,                               
                                    OPBAL = SUM(                               
                                    CASE                               
                                          WHEN UPPER(DRCR) = 'D'                               
                                          THEN VAMT                               
                                          ELSE -VAMT                             
                                    END                              
                                    )                               
                              FROM LEDGER WITH(NOLOCK)                               
                              WHERE CLTCODE = @FCODE                               
                                    AND EDT > = @@OPENDATE + ' 00:00:00'                               
                                    AND EDT < @FDATE                               
                                    AND VTYP <> 18                               
                              GROUP BY CLTCODE                               
                              UNION ALL                               
                              SELECT                               
                                    CLTCODE,                               
                                    OPPBAL = ISNULL(SUM(                               
                                    CASE                               
                                          WHEN UPPER(B.DRCR) = 'C'                               
                                          THEN B.VAMT                               
            ELSE -B.VAMT                               
                                    END                              
                                    ), 0)                               
                              FROM LEDGER B WITH(NOLOCK)                               
                              WHERE B.CLTCODE > = @FCODE                               
                                    AND B.CLTCODE < = @TCODE                               
                                    AND B.VDT < @@OPENDATE                               
                                    AND EDT >= @@OPENDATE                               
                              GROUP BY CLTCODE                               
                        )                               
                        T                               
                  GROUP BY CLTCODE                               
            END                                  
      END      
                                          
                                    
                                    
                                    
      /*GETTING FIILTERED LEDGER*/                                    
      IF @SELECTBY = 'VDT'                         
      BEGIN                                    
            INSERT                               
            INTO #LEDGERDATA                               
            SELECT                               
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                               
                  ISNULL(V.SHORTDESC, '') SHORTDESC                                     FROM LEDGER L WITH(NOLOCK),                               
                  VMAST V WITH(NOLOCK)                             
            WHERE VDT > = @FDATE + ' 00:00:00'                               
                  AND L.VTYP = V.VTYPE                               
                AND VDT < = @TDATE +' 23:59:59'                               
                  AND CLTCODE > = @FCODE                               
                  AND CLTCODE < = @TCODE                               
      END                                     
      ELSE                                    
      BEGIN                                    
            INSERT                               
            INTO #LEDGERDATA                               
            SELECT                               
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                               
                  ISNULL(V.SHORTDESC, '') SHORTDESC                               
            FROM LEDGER L WITH(NOLOCK),                               
                  VMAST V WITH(NOLOCK)                               
            WHERE EDT > = @FDATE + ' 00:00:00'                 
                  AND L.VTYP = V.VTYPE                               
                  AND EDT < = @TDATE +' 23:59:59'                               
                  AND CLTCODE > = @FCODE                               
                  AND CLTCODE < = @TCODE                               
      END                                    
                                    
                              
                              
/*GETTING CLIENT LIST*/               
 INSERT INTO #LEDGERCLIENTS                                   
      SELECT                               
            C2.PARTY_CODE,                              
            C1.LONG_NAME,                              
            BANK_NAME = '',                               
            L_ADDRESS1,                               
            L_ADDRESS2,                               
            L_ADDRESS3,                               
            L_CITY,                               
            L_ZIP,                               
            RES_PHONE1,                               
            C1.BRANCH_CD,                               
            FAMILY,                               
            C1.SUB_BROKER,                               
            TRADER,                               
            CL_TYPE = '',                               
            CLTDPID = ''    
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),                               
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                               
      WHERE C1.CL_CODE = C2.CL_CODE                               
            AND C1.BRANCH_CD LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'BRANCH'                               
                  THEN @STATUSNAME                               
                  ELSE '%'                               
            END                              
            )                               
            AND SUB_BROKER LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'SUB_BROKER'                               
                  THEN @STATUSNAME                       
                  ELSE '%'                               
            END                              
            )                               
     AND SUB_BROKER LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'SUBBROKER'                               
                  THEN @STATUSNAME              
                  ELSE '%'                               
 END                              
            )                               
            AND TRADER LIKE (                             
            CASE                               
                  WHEN @STATUSID = 'TRADER'                               
                  THEN @STATUSNAME                               
                  ELSE '%'                               
            END                              
            )                               
            AND AREA LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'AREA'                               
                  THEN @STATUSNAME                               
                  ELSE '%'                  
            END                              
            )                         
            AND REGION LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'REGION'                               
                  THEN @STATUSNAME                               
                  ELSE '%'                               
            END                              
            )                              
            AND C1.FAMILY LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'FAMILY'                               
                  THEN @STATUSNAME                               
                  ELSE '%'                               
            END                              
  )                               
            AND C2.PARTY_CODE LIKE (                              
            CASE                               
                  WHEN @STATUSID = 'CLIENT'                               
                  THEN @STATUSNAME                               
                  ELSE '%'                               
            END                              
         )                               
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                               
            AND C2.PARTY_CODE > = @FCODE                               
            AND C2.PARTY_CODE < = @TCODE                               
                              
                              
      CREATE TABLE [#TMPLEDGER] (                              
       [BOOKTYPE] [CHAR] (2)  NULL ,                              
       [VOUDT] [DATETIME] NULL ,                              
       [EFFDT] [DATETIME] NULL ,                              
       [SHORTDESC] [VARCHAR] (35)  NULL ,                              
       [DRAMT] [MONEY] NULL ,                              
       [CRAMT] [MONEY] NULL ,                              
       [VNO] [VARCHAR] (12)  NULL ,                              
       [DDNO] [VARCHAR] (20)  NULL ,                              
       [NARRATION] [VARCHAR] (234)  NULL ,                              
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,                              
       [VTYP] [SMALLINT] NULL ,                              
       [VDT] [VARCHAR] (30)  NULL ,                              
       [EDT] [VARCHAR] (30)  NULL ,                              
       [ACNAME] [VARCHAR] (100)  NULL ,                              
       [OPBAL] [MONEY] NULL ,                              
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,                              
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,                              
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,                              
       [L_CITY] [VARCHAR] (40)  NULL ,                              
       [L_ZIP] [VARCHAR] (10)  NULL ,                              
       [RES_PHONE1] [VARCHAR] (15)  NULL ,                              
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,                              
       [CROSAC] [VARCHAR] (10)  NULL ,                              
       [EDIFF] [INT] NULL ,                              
       [FAMILY] [VARCHAR] (10)  NOT NULL ,                              
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,                              
       [TRADER] [VARCHAR] (20)  NOT NULL ,                              
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,                              
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,                              
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,                             
     [LNO] [INT] NULL,                            
       [PDT] [DATETIME] NULL                            
      ) ON [PRIMARY]                              
                              
                                    
/*GETTING LDDGER ENTRIES*/                                    
      INSERT                               
            INTO #TMPLEDGER                               
      SELECT                               
            L.BOOKTYPE,                               
 VOUDT = L.VDT,                               
            EFFDT = L.EDT,                               
            L.SHORTDESC,                               
            DRAMT = (                              
            CASE                               
                  WHEN UPPER(L.DRCR) = 'D'                               
                  THEN L.VAMT                               
                  ELSE 0                               
            END                              
       ),                               
            CRAMT = (                              
            CASE                               
                  WHEN UPPER(L.DRCR) = 'C'                               
                  THEN L.VAMT                               
                  ELSE 0                               
            END                              
            ),                               
            L.VNO,                               
            DDNO = SPACE(15),                               
            L.NARRATION,                               
            C.PARTY_CODE CLTCODE,                               
            L.VTYP,                               
            CONVERT(VARCHAR, L.VDT, 103) VDT,                               
            CONVERT(VARCHAR, L.EDT, 103) EDT,                               
--            L.ACNAME ,                               
            C.LONG_NAME,                              
            OPBAL = VAMT,                            
  C.L_ADDRESS1,                               
            C.L_ADDRESS2,                               
            C.L_ADDRESS3,                               
            C.L_CITY,                               
            C.L_ZIP,                               
            C.RES_PHONE1,                               
            C.BRANCH_CD,                               
            L.CLTCODE CROSAC ,                               
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),                               
            C.FAMILY,                               
            C.SUB_BROKER,                               
            C.TRADER,                        
            C.CL_TYPE,                               
            C.BANK_NAME,                               
            C.CLTDPID,                               
            L.LNO,                            
  L.PDT                               
      FROM #LEDGERDATA L WITH(NOLOCK)                               
 RIGHT OUTER JOIN                               
            #LEDGERCLIENTS C WITH(NOLOCK)                               
            ON                               
            (                              
                  L.CLTCODE = C.PARTY_CODE                              
            )                               
                              
                              
                                    
/*UPDATING OPENING BLANACE*/                                    
      UPDATE                               
            #TMPLEDGER                               
            SET OPBAL = 0                               
                              
      UPDATE                               
            #TMPLEDGER                               
            SET OPBAL = T.OPPBAL                               
      FROM #TMPLEDGER L WITH(NOLOCK),                               
            #OPPBALANCE T WITH(NOLOCK)                           
      WHERE L.CLTCODE = T.CLTCODE                               
                                    
                              
                              
/*UPDATING CHEQUE NUMBER*/                                    
      UPDATE                               
            #TMPLEDGER                               
            SET DDNO = L1.DDNO                               
      FROM LEDGER1 L1 WITH(NOLOCK)                               
      WHERE L1.VNO = #TMPLEDGER.VNO                               
            AND L1.VTYP = #TMPLEDGER.VTYP                             
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE                               
            AND L1.LNO = #TMPLEDGER.LNO                               
                                    
                              
                              
/*UPDATING CROSS ACCOUNT CODE*/                                    
      UPDATE                               
       #TMPLEDGER                               
            SET #TMPLEDGER.CROSAC = B.CLTCODE                               
      FROM LEDGER B WITH(NOLOCK),                               
            ACMAST V WITH(NOLOCK)                               
      WHERE B.CLTCODE = V.CLTCODE                               
            AND V.ACCAT = 2                               
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE                               
            AND #TMPLEDGER.VNO = B.VNO                               
            AND #TMPLEDGER.VTYP = B.VTYP                               
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')                               
                             
                   
                              
/*UPDATING BANK NAME*/                                                   
      UPDATE                               
            #TMPLEDGER                               
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME                               
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)                               
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))                               
                              
                                    
      IF @STRORDER = 'ACCODE'                                    
      BEGIN                                    
            IF @SELECTBY = 'VDT'                                    
            BEGIN                                     
                  SELECT                               
                        L.*                               
                  FROM #TMPLEDGER L WITH(NOLOCK),                               
                        ACMAST A WITH(NOLOCK)                               
                  WHERE L.CLTCODE = A.CLTCODE                               
                        AND ACCAT IN ('4', '104')                               
          AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                              
   ORDER BY L.CLTCODE,                            
                        VOUDT, PDT                            
            END                                    
            ELSE                                    
            BEGIN                                    
                  SELECT                               
                        L.*                               
                  FROM #TMPLEDGER L WITH(NOLOCK),                               
                        ACMAST A WITH(NOLOCK)                               
                  WHERE L.CLTCODE = A.CLTCODE                               
                        AND ACCAT IN ('4', '104')                               
                        AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.CLTCODE,                              
                        EFFDT, PDT                            
            END                                    
      END                                    
      ELSE                                    
      BEGIN                            
            IF @SELECTBY = 'VDT'                                    
            BEGIN                                     
                  SELECT                               
                        L.*                               
                  FROM #TMPLEDGER L WITH(NOLOCK),                               
                        ACMAST A WITH(NOLOCK)                               
                  WHERE L.CLTCODE = A.CLTCODE                               
                        AND ACCAT IN ('4', '104')                 
         AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                          
                  ORDER BY L.ACNAME,                             
                        VOUDT, PDT                               
            END                                    
            ELSE            
            BEGIN                                    
                  SELECT                               
                        L.*                               
                  FROM #TMPLEDGER L WITH(NOLOCK),                               
                        ACMAST A WITH(NOLOCK)                               
                  WHERE L.CLTCODE = A.CLTCODE                               
                        AND ACCAT IN ('4', '104')                
                        AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                               
                  ORDER BY L.ACNAME,                              
                        EFFDT, PDT                            
            END                                    
      END                                    
                                    
/*  ------------------------------   END OF THE PROC  -------------------------------------*/                                    
                                    
-------------------------------------------------              
-- DESTROYING TEMPORARY TABLE              
-------------------------------------------------              
TRUNCATE TABLE #OPPBALANCE                                    
TRUNCATE TABLE #LEDGERCLIENTS              
TRUNCATE TABLE #LEDGERDATA              
              
DROP TABLE #OPPBALANCE              
DROP TABLE #LEDGERCLIENTS                                
DROP TABLE #LEDGERDATA                              
-------------------------------------------------              
-- DESTROYING TEMPORARY TABLE              
-------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_EOD
-- --------------------------------------------------





CREATE   Procedure Rpt_acc_partyledger_EOD
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Fcode Varchar(10),
	@Tcode Varchar(10),
	@Strorder Varchar(6),
	@Selectby Varchar(3),
	@Statusid Varchar(15),
	@Statusname Varchar(15),
	@Strbranch Varchar(10)
)

As

/*========================================================================
Exec Rpt_acc_partyledger_EOD 'Sep  1 2006','Sep 21 2006','0','z','ACCODE','vdt','broker','broker','%'
Exec account.dbo.Rpt_acc_partyledger_EOD 'Sep  1 2006', 'Sep 29 2006', '0A147', '0A147', 'CltCode', 'VDT', 'broker', 'broker', ''
Exec account.dbo.Rpt_acc_partyledger_EOD_Summ 'Sep  1 2006', 'Sep 29 2006', 'Apr  1 2006', 'Mar 31 2007', 'broker', 'broker', 'VDT', '0', 'z'
Exec account.dbo.Rpt_acc_partyledger_EOD 'Sep 1 2006', 'Sep 29 2006', '0A147', '0A147', 'ACCODE', 'VDT', 'broker', 'broker', ''
========================================================================*/

Declare
	@@Opendate As Varchar(11),
	@@SQL AS VARCHAR(2000),
	@@SHAREDB AS VARCHAR(50)

Set Transaction Isolation Level Read Uncommitted


/*getting Last Opening Date */
	If Upper(@Selectby) = 'Vdt'
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Vdt < = @Fdate
				)
		End
	Else
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Edt < = @Fdate
				)
		End

	/*creating Blank Table For Opening Balance*/
	CREATE TABLE #oppbalance
	(
		CLTCODE VARCHAR(10),
		OPPBAL MONEY
	)

	/*getting Opening Balance*/
	If @Selectby = 'Vdt'
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE  <= @Tcode
						AND B.Vdt Like @Fdate + '%'
						AND B.Vtyp = 18
					GROUP BY PARTY_CODE
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.Vdt >= @@Opendate + ' 00:00:00'
						AND B.Vdt < @Fdate
					GROUP BY PARTY_CODE
				End
		End
	Else
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT Cltcode,
						Opbal = Sum(Opbal)
					FROM
						(SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS
						WITH(NoLock)
						WHERE PARTY_CODE >= @Fcode
							AND PARTY_CODE <= @TCODE
							AND Edt Like @@Opendate + '%'
							AND Vtyp = 18
						GROUP BY PARTY_CODE
					UNION ALL
					SELECT
					Cltcode = PARTY_CODE,
					Oppbal  = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.Vdt < @@Opendate
						AND B.Edt >= @@Opendate
					GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT
						Cltcode,
						Opbal = Sum(Opbal)
					FROM
					(
						SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.Edt Like @@Opendate + '%'
							AND B.Vtyp = 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Opbal =  Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.Edt >= @@Opendate + ' 00:00:00'
							AND B.Edt < @Fdate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Oppbal = Isnull(Sum(CREDIT_AMOUNT - DEBIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.Vdt < @@Opendate
							AND B.Edt >= @@Opendate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
		End

	/*generating Blank Structure For Filtered Ledger */

	CREATE TABLE [#ledgerdata]
		(
		VTYP SMALLINT NOT NULL,
		VNO VARCHAR (12) NOT NULL,
		EDT DATETIME NULL,
		LNO DECIMAL(4, 0) NOT NULL,
		ACNAME VARCHAR (100) NOT NULL,
		DRCR CHAR (1) NULL,
		DRAMT MONEY NULL,
		CRAMT MONEY NULL,
		VDT DATETIME NULL,
		VNO1 VARCHAR (12) NULL,
		REFNO CHAR (12) NULL,
		BALAMT MONEY NOT NULL,
		NODAYS INT NULL,
		CDT DATETIME NULL,
		CLTCODE VARCHAR (10) NOT NULL,
		BOOKTYPE CHAR (2) NOT NULL,
		ENTEREDBY VARCHAR (25) NULL,
		PDT DATETIME NULL,
		CHECKEDBY VARCHAR (25) NULL,
		ACTNODAYS INT NULL,
		NARRATION VARCHAR (234) NULL,
		DDNO VARCHAR(35) NULL,
		SHORTDESC VARCHAR(35)
		)

	/*getting Fiiltered Ledger*/
	If @Selectby = 'Vdt'
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE L.Vdt >= @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Vdt <= @Tdate +' 23:59:59'
				AND L.PARTY_CODE >= @Fcode
				AND L.PARTY_CODE <= @Tcode
				AND L.VTYP <> 18
		End
	Else
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE Edt > = @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Edt < = @Tdate +' 23:59:59'
				AND L.PARTY_CODE > = @Fcode
				AND L.PARTY_CODE < = @Tcode
		End

	/*getting Client List*/
	CREATE TABLE #ledgerclients (PARTY_CODE VARCHAR(10))

	SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER
	SELECT @@SQL = "INSERT INTO #ledgerclients SELECT "
	SELECT @@SQL = @@SQL + "		C2.Party_code "
	SELECT @@SQL = @@SQL + "      FROM " + @@SHAREDB + ".Dbo.Client1 C1 WITH(NoLock), "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client2 C2 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "      LEFT OUTER JOIN "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client4 C4 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "            ON (C2.Party_code = C4.Party_code AND Depository Not In ('Nsdl', 'Cdsl') AND Defdp = 1) "
	SELECT @@SQL = @@SQL + "      WHERE C1.Cl_code = C2.Cl_code "
	SELECT @@SQL = @@SQL + "	AND '" + @Statusname + "' =  "
	SELECT @@SQL = @@SQL + "			CASE '" + @STATUSID + "' WHEN 'BRANCH' THEN C1.BRANCH_CD "
	SELECT @@SQL = @@SQL + "			WHEN 'AREA' THEN C1.AREA "
	SELECT @@SQL = @@SQL + "			WHEN 'REGION' THEN C1.REGION "
	SELECT @@SQL = @@SQL + "			WHEN 'SUBBROKER' THEN C1.SUB_BROKER "
	SELECT @@SQL = @@SQL + "			WHEN 'TRADER' THEN C1.TRADER "
	SELECT @@SQL = @@SQL + "			WHEN 'FAMILY' THEN C1.FAMILY "
	SELECT @@SQL = @@SQL + "			WHEN 'CLIENT' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			WHEN 'PARTY' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			ELSE 'BROKER' END "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code > = '" + @Fcode + "' "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code < = '" + @Tcode + "' "
	EXEC (@@SQL)

	CREATE TABLE [#tmpledger]
	(
		[Booktype] [char] (2)  NULL ,
		[Voudt] [datetime] NULL ,
		[Effdt] [datetime] NULL ,
		[Shortdesc] [varchar] (35)  NULL ,
		[Dramt] [money] NULL ,
		[Cramt] [money] NULL ,
		[Vno] [varchar] (12)  NULL ,
		[Ddno] [varchar] (15)  NULL ,
		[Narration] [varchar] (234)  NULL ,
		[Cltcode] [varchar] (10)  NULL ,
		[Vtyp] [smallint] NULL ,
		[Vdt] [varchar] (30)  NULL ,
		[Edt] [varchar] (30)  NULL ,
		[Acname] [varchar] (100)  NULL ,
		[Opbal] [money] NULL ,
		[L_address1] [varchar] (40)  NULL ,
		[L_address2] [varchar] (40)  NULL ,
		[L_address3] [varchar] (40)  NULL ,
		[L_city] [varchar] (40)  NULL ,
		[L_zip] [varchar] (10)  NULL ,
		[Res_phone1] [varchar] (15)  NULL ,
		[Branch_cd] [varchar] (10)  NULL ,
		[Crosac] [varchar] (10)  NULL ,
		[Ediff] [int] NULL ,
		[Family] [varchar] (10)  NULL ,
		[Sub_broker] [varchar] (10)  NULL ,
		[Trader] [varchar] (20)  NULL ,
		[Cl_type] [varchar] (3)  NULL ,
		[Bank_name] [varchar] (16)  NULL ,
		[Cltdpid] [varchar] (16)  NULL ,
		[Lno] [smallint] NULL
	)

	/*getting Lddger Entries*/
	INSERT
	INTO #tmpledger
	SELECT L.Booktype,
		Voudt = L.Vdt,
		Effdt = L.Edt,
		L.Shortdesc,
		Dramt,
		Cramt,
		L.Vno,
		Ddno = L.ddNo,
		L.Narration,
		C.Party_code,
		L.Vtyp,
		Convert(Varchar, L.Vdt, 103) Vdt,
		Convert(Varchar, L.Edt, 103) Edt,
		L.Acname ,
		Opbal = (DRAMT + CRAMT),
		L_address1 = '',
		L_address2 = '',
		L_address3 = '',
		L_city = '',
		L_zip = '',
		Res_phone1 = '',
		Branch_cd = '',
		Cltcode Crosac ,
		Ediff = Datediff(D, L.Edt, Getdate()),
		Family = '',
		Sub_broker = '',
		Trader = '',
		Cl_type = '',
		Bank_name = '',
		Cltdpid = '',
		Lno
	FROM #ledgerdata L WITH(NoLock)
	RIGHT OUTER JOIN #ledgerclients C WITH(NoLock) ON (L.Cltcode = C.Party_code )

	/*updating Opening Blanace*/
	UPDATE
		#tmpledger
		SET Opbal = 0

	UPDATE
		#tmpledger
		SET Opbal = T.Oppbal
	FROM #tmpledger L WITH(NoLock),
		#oppbalance T WITH(NoLock)
	WHERE L.Cltcode = T.Cltcode

	SELECT @@SQL = "SELECT "
	SELECT @@SQL = @@SQL + "	L.Booktype, L.Voudt, L.Effdt, L.Shortdesc, Dramt = IsNull(L.Dramt, 0), CrAmt = IsNull(L.Cramt, 0), L.Vno, L.Ddno, L.Narration, "
	SELECT @@SQL = @@SQL + "	L.Cltcode, L.Vtyp, L.Vdt, L.Edt, A.Acname, opBal = IsNull(L.Opbal, 0), L.L_address1, L.L_address2, L.L_address3, "
	SELECT @@SQL = @@SQL + "	L.L_city, L.L_zip, L.Res_phone1, L.Branch_cd, L.Crosac, L.Ediff, L.Family, L.Sub_broker, "
	SELECT @@SQL = @@SQL + "	L.Trader, L.Cl_type, L.Bank_name, L.Cltdpid, L.Lno "
	SELECT @@SQL = @@SQL + "	FROM #tmpledger L WITH(NoLock), "
	SELECT @@SQL = @@SQL + "		Acmast A WITH(NoLock) "
	SELECT @@SQL = @@SQL + "	WHERE L.Cltcode = A.Cltcode "
	SELECT @@SQL = @@SQL + "		AND Accat In ('4', '104') "
	SELECT @@SQL = @@SQL + "		AND (cramt <> 0 or dramt <> 0 or opbal <> 0) "
	IF @STRORDER = 'ACCODE'
		BEGIN
			IF @SELECTBY = 'VDT'
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY L.CLTCODE, L.VOUDT "
				END
			ELSE
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY L.CLTCODE, L.EFFDT "
				END
		END
	ELSE
		BEGIN
			IF @SELECTBY = 'VDT'
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY A.ACNAME, L.VOUDT "
				END
			ELSE
				BEGIN
					SELECT @@SQL = @@SQL + "		ORDER BY A.ACNAME, L.EFFDT "
				END
		END

/*
      If @Strorder = 'Accode'
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.Booktype, L.Voudt, L.Effdt, L.Shortdesc, L.Dramt, L.Cramt, L.Vno, L.Ddno, L.Narration, 
						A.Cltcode, L.Vtyp, L.Vdt, L.Edt, L.Acname, L.Opbal, L.L_address1, L.L_address2, L.L_address3,
						L.L_city, L.L_zip, L.Res_phone1, L.Branch_cd, L.Crosac, L.Ediff, L.Family, L.Sub_broker, 
						L.Trader, L.Cl_type, L.Bank_name, L.Cltdpid, L.Lno
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
						AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
					ORDER BY L.Cltcode,
						Voudt
				End
			Else
				Begin
					SELECT
						L.Booktype, L.Voudt, L.Effdt, L.Shortdesc, L.Dramt, L.Cramt, L.Vno, L.Ddno, L.Narration, 
						A.Cltcode, L.Vtyp, L.Vdt, L.Edt, L.Acname, L.Opbal, L.L_address1, L.L_address2, L.L_address3,
						L.L_city, L.L_zip, L.Res_phone1, L.Branch_cd, L.Crosac, L.Ediff, L.Family, L.Sub_broker, 
						L.Trader, L.Cl_type, L.Bank_name, L.Cltdpid, L.Lno
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Cltcode,
						Effdt
				End
		End
	Else
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Voudt
				End
			Else
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Effdt
				End
		End
*/
EXEC (@@SQL)
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_EOD_Summ
-- --------------------------------------------------








/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	Rpt_acc_partyledger_EOD_Summ 'Apr  1 2006','Sep 27 2006','Apr  1 2006','Mar 31 2007','broker','broker','Vdt','0','z'
	*****************************************************************************************************
*/
CREATE  PROC Rpt_acc_partyledger_EOD_Summ
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(25),
@@OBJID AS INT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER

	--INSERTING NORMAL LEDGER RECORDS
	SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
	SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "UNREALISED = 0, "
		END
	SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
	SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "
	SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	IF @STATUSID = 'AREA'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'REGION'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'BRANCH'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'SUBBROKER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'TRADER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'FAMILY'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'CLIENT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "
		END
	PRINT (@@SQL)
	EXEC (@@SQL)

	--INSERTING MARGIN LEDGER RECORDS
	SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
	SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "
	SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "UNREALISED = 0, "
		END
	SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
	SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "
	SELECT @@SQL = @@SQL + "LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "
	SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
	SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
	IF @DISPLAYRPT = 'VDT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	ELSE
		BEGIN
			SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	IF @STATUSID = 'AREA'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'REGION'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'BRANCH'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'SUBBROKER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'TRADER'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'FAMILY'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
		END
	ELSE IF @STATUSID = 'CLIENT'
		BEGIN
			SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "
		END

	PRINT (@@SQL)
	EXEC (@@SQL)

	IF @DISPLAYRPT = 'EDT'
		BEGIN
			--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
			--INSTEAD OF GIVING REVERSAL EFFECT
			--THIS SAVES UNION JOIN
			SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
			SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
			EXEC (@@SQL)
		END
	SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
	IF @@RECCOUNTER <= 0
		BEGIN
			SELECT CLTCODE, BRANCH AS LONG_NAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			RETURN
		END
	SELECT @@SQL = "SELECT CLTCODE, BRANCH AS LONG_NAME, SUM(VAMT) AS LEDGERAMOUNT, "
	SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
/*				IF @DISPLAYRPT = 'VDT'
		BEGIN*/
			SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
--					END
	SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
	SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
	SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
	SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH "
	SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "
	PRINT (@@SQL)
	EXEC (@@SQL)
	DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_Offline
-- --------------------------------------------------
CREATE Procedure Rpt_acc_partyledger_Offline
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */
	@Fcode Varchar(10),
	@Tcode Varchar(10),
	@Strorder Varchar(6),
	@Selectby Varchar(3),
	@Statusid Varchar(15),
	@Statusname Varchar(15),
	@Strbranch Varchar(10)
)

As

/*========================================================================
Exec Rpt_acc_partyledger 'Sep  1 2006','Sep 21 2006','0','z','ACCODE','VDT','broker','broker','%'
========================================================================*/

Declare
	@@Opendate   As Varchar(11),
	@@SQL AS VARCHAR(2000),
	@@SHAREDB AS VARCHAR(50),
	@@EXCHANGE AS VARCHAR(5),
	@@SEGMENT AS VARCHAR(10)

Set Transaction Isolation Level Read Uncommitted


SELECT TOP 1 
	@@SHAREDB = SHAREDB,
	@@EXCHANGE = EXCHANGE,
	@@SEGMENT = SEGMENT
FROM 
	OWNER
/*getting Last Opening Date */
	If Upper(@Selectby) = 'Vdt'
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Vdt < = @Fdate
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
				)
		End
	Else
		Begin
			SELECT
				@@Opendate =
				(
					SELECT
						Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11)
					FROM CLS_LEDGER_REPORTS WITH(NoLock)
					WHERE Vtyp = 18
						AND Edt < = @Fdate
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
				)
		End

	/*creating Blank Table For Opening Balance*/
	CREATE TABLE #oppbalance
	(
		CLTCODE VARCHAR(10),
		OPPBAL MONEY
	)

	/*getting Opening Balance*/
	If @Selectby = 'Vdt'
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE  <= @Tcode
						AND B.Vdt Like @Fdate + '%'
						AND B.Vtyp = 18
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
					GROUP BY PARTY_CODE
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT PARTY_CODE,
						Oppbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.Vdt >= @@Opendate + ' 00:00:00'
						AND B.Vdt < @Fdate
						AND EXCHANGE = @@EXCHANGE
						AND SEGMENT = @@SEGMENT
					GROUP BY PARTY_CODE
				End
		End
	Else
		Begin
			If @@Opendate = @Fdate
				Begin
					INSERT
					INTO #oppbalance
					SELECT Cltcode,
						Opbal = Sum(Opbal)
					FROM
						(SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS
						WITH(NoLock)
						WHERE PARTY_CODE >= @Fcode
							AND PARTY_CODE <= @TCODE
							AND Edt Like @@Opendate + '%'
							AND EXCHANGE = @@EXCHANGE
							AND SEGMENT = @@SEGMENT
							AND Vtyp = 18
						GROUP BY PARTY_CODE
					UNION ALL
					SELECT
					Cltcode = PARTY_CODE,
					Oppbal  = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
					FROM CLS_LEDGER_REPORTS B
					WITH(NoLock)
					WHERE B.PARTY_CODE >= @Fcode
						AND B.PARTY_CODE <= @Tcode
						AND B.EXCHANGE = @@EXCHANGE
						AND B.SEGMENT = @@SEGMENT
						AND B.Vdt < @@Opendate
						AND B.Edt >= @@Opendate
					GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
			Else
				Begin
					INSERT
					INTO #oppbalance
					SELECT
						Cltcode,
						Opbal = Sum(Opbal)
					FROM
					(
						SELECT Cltcode = PARTY_CODE,
							Opbal = Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.EXCHANGE = @@EXCHANGE
							AND B.SEGMENT = @@SEGMENT
							AND B.Edt Like @@Opendate + '%'
							AND B.Vtyp = 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Opbal =  Isnull(Sum(DEBIT_AMOUNT - CREDIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.EXCHANGE = @@EXCHANGE
							AND B.SEGMENT = @@SEGMENT
							AND B.Edt >= @@Opendate + ' 00:00:00'
							AND B.Edt < @Fdate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
						UNION ALL
						SELECT Cltcode = PARTY_CODE,
							Oppbal = Isnull(Sum(CREDIT_AMOUNT - DEBIT_AMOUNT), 0)
						FROM CLS_LEDGER_REPORTS B
						WITH(NoLock)
						WHERE B.PARTY_CODE >= @Fcode
							AND B.PARTY_CODE <= @Tcode
							AND B.EXCHANGE = @@EXCHANGE
							AND B.SEGMENT = @@SEGMENT
							AND B.Vdt < @@Opendate
							AND B.Edt >= @@Opendate
							AND B.Vtyp <> 18
						GROUP BY PARTY_CODE
					) T
					GROUP BY Cltcode
				End
		End

	/*generating Blank Structure For Filtered Ledger */

	CREATE TABLE [#ledgerdata]
		(
		VTYP SMALLINT NOT NULL,
		VNO VARCHAR (12) NOT NULL,
		EDT DATETIME NULL,
		LNO DECIMAL(4, 0) NOT NULL,
		ACNAME VARCHAR (100) NOT NULL,
		DRCR CHAR (1) NULL,
		DRAMT MONEY NULL,
		CRAMT MONEY NULL,
		VDT DATETIME NULL,
		VNO1 VARCHAR (12) NULL,
		REFNO CHAR (12) NULL,
		BALAMT MONEY NOT NULL,
		NODAYS INT NULL,
		CDT DATETIME NULL,
		CLTCODE VARCHAR (10) NOT NULL,
		BOOKTYPE CHAR (2) NOT NULL,
		ENTEREDBY VARCHAR (25) NULL,
		PDT DATETIME NULL,
		CHECKEDBY VARCHAR (25) NULL,
		ACTNODAYS INT NULL,
		NARRATION VARCHAR (234) NULL,
		DDNO VARCHAR(15) NULL,
		SHORTDESC VARCHAR(35)
		)

	/*getting Fiiltered Ledger*/
	If @Selectby = 'Vdt'
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE L.Vdt >= @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Vdt <= @Tdate +' 23:59:59'
				AND L.PARTY_CODE >= @Fcode
				AND L.PARTY_CODE <= @Tcode
				AND L.VTYP <> 18
				AND L.EXCHANGE = @@EXCHANGE
				AND L.SEGMENT = @@SEGMENT
		End
	Else
		Begin
			INSERT
			INTO #ledgerdata
			SELECT VTYP,
				VNO,
				EDT,
				LNO = 0,
				PARTY_NAME,
				DRCR = CASE WHEN DEBIT_AMOUNT <> 0 THEN 'D' ELSE 'C' END,
				DRAMT = DEBIT_AMOUNT,
				CRAMT = CREDIT_AMOUNT,
				VDT,
				VNO1    = VNO,
				REFNO   = '',
				BALAMT  = 0,
				NODAYS  = 0,
				CDT     = GETDATE(),
				CLTCODE = PARTY_CODE,
				BOOKTYPE,
				ENTEREDBY = 'SYSTEM',
				PDT       = GETDATE(),
				CHECKEDBY = 'SYSTEM',
				ACTNODAYS = 0,
				L.NARRATION,
				DDNO = CHEQUE_NO,
				SHORTDESC = ISNULL(V.SHORTDESC, '')
			FROM CLS_LEDGER_REPORTS L WITH(	NoLock),
				Vmast V WITH(	NoLock)
			WHERE Edt > = @Fdate + ' 00:00:00'
				AND L.Vtyp = V.Vtype
				AND L.Edt < = @Tdate +' 23:59:59'
				AND L.PARTY_CODE > = @Fcode
				AND L.PARTY_CODE < = @Tcode
				AND L.EXCHANGE = @@EXCHANGE
				AND L.SEGMENT = @@SEGMENT
		End

	/*getting Client List*/
	CREATE TABLE #ledgerclients (PARTY_CODE VARCHAR(10), LONG_NAME VARCHAR(100))

	SELECT @@SQL = "INSERT INTO #ledgerclients SELECT "
	SELECT @@SQL = @@SQL + "		C2.Party_code, "
	SELECT @@SQL = @@SQL + "		C1.LONG_NAME "
	SELECT @@SQL = @@SQL + "      FROM " + @@SHAREDB + ".Dbo.Client1 C1 WITH(NoLock), "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client2 C2 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "      LEFT OUTER JOIN "
	SELECT @@SQL = @@SQL + "            " + @@SHAREDB + ".Dbo.Client4 C4 WITH(NoLock) "
	SELECT @@SQL = @@SQL + "            ON (C2.Party_code = C4.Party_code AND Depository Not In ('Nsdl', 'Cdsl') AND Defdp = 1) "
	SELECT @@SQL = @@SQL + "      WHERE C1.Cl_code = C2.Cl_code "
	SELECT @@SQL = @@SQL + "	AND '" + @Statusname + "' =  "
	SELECT @@SQL = @@SQL + "			CASE '" + @STATUSID + "' WHEN 'BRANCH' THEN C1.BRANCH_CD "
	SELECT @@SQL = @@SQL + "			WHEN 'AREA' THEN C1.AREA "
	SELECT @@SQL = @@SQL + "			WHEN 'REGION' THEN C1.REGION "
	SELECT @@SQL = @@SQL + "			WHEN 'SUBBROKER' THEN C1.SUB_BROKER "
	SELECT @@SQL = @@SQL + "			WHEN 'TRADER' THEN C1.TRADER "
	SELECT @@SQL = @@SQL + "			WHEN 'FAMILY' THEN C1.FAMILY "
	SELECT @@SQL = @@SQL + "			WHEN 'CLIENT' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			WHEN 'PARTY' THEN C2.Party_code "
	SELECT @@SQL = @@SQL + "			ELSE 'BROKER' END "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code > = '" + @Fcode + "' "
	SELECT @@SQL = @@SQL + "            AND C2.Party_code < = '" + @Tcode + "' "
	EXEC (@@SQL)

	CREATE TABLE [#tmpledger]
	(
		[Booktype] [char] (2)  NULL ,
		[Voudt] [datetime] NULL ,
		[Effdt] [datetime] NULL ,
		[Shortdesc] [varchar] (35)  NULL ,
		[Dramt] [money] NULL ,
		[Cramt] [money] NULL ,
		[Vno] [varchar] (12)  NULL ,
		[Ddno] [varchar] (15)  NULL ,
		[Narration] [varchar] (234)  NULL ,
		[Cltcode] [varchar] (10)  NULL ,
		[Vtyp] [smallint] NULL ,
		[Vdt] [varchar] (30)  NULL ,
		[Edt] [varchar] (30)  NULL ,
		[Acname] [varchar] (100)  NULL ,
		[Opbal] [money] NULL ,
		[L_address1] [varchar] (40)  NULL ,
		[L_address2] [varchar] (40)  NULL ,
		[L_address3] [varchar] (40)  NULL ,
		[L_city] [varchar] (40)  NULL ,
		[L_zip] [varchar] (10)  NULL ,
		[Res_phone1] [varchar] (15)  NULL ,
		[Branch_cd] [varchar] (10)  NULL ,
		[Crosac] [varchar] (10)  NULL ,
		[Ediff] [int] NULL ,
		[Family] [varchar] (10)  NULL ,
		[Sub_broker] [varchar] (10)  NULL ,
		[Trader] [varchar] (20)  NULL ,
		[Cl_type] [varchar] (3)  NULL ,
		[Bank_name] [varchar] (16)  NULL ,
		[Cltdpid] [varchar] (16)  NULL ,
		[Lno] [smallint] NULL
	)

	/*getting Lddger Entries*/
	INSERT
	INTO #tmpledger
	SELECT L.Booktype,
		Voudt = L.Vdt,
		Effdt = L.Edt,
		L.Shortdesc,
		Dramt,
		Cramt,
		L.Vno,
		Ddno,
		L.Narration,
		C.Party_code,
		L.Vtyp,
		Convert(Varchar, L.Vdt, 103) Vdt,
		Convert(Varchar, L.Edt, 103) Edt,
		Acname = C.LONG_NAME,
		Opbal = (DRAMT + CRAMT),
		L_address1 = '',
		L_address2 = '',
		L_address3 = '',
		L_city = '',
		L_zip = '',
		Res_phone1 = '',
		Branch_cd = '',
		Crosac = '',
		Ediff = Datediff(D, L.Edt, Getdate()),
		Family = '',
		Sub_broker = '',
		Trader = '',
		Cl_type = '',
		Bank_name = '',
		Cltdpid = '',
		Lno
	FROM #ledgerdata L WITH(NoLock)
	RIGHT OUTER JOIN #ledgerclients C WITH(NoLock) ON (L.Cltcode = C.Party_code )

	/*updating Opening Blanace*/
	UPDATE
		#tmpledger
		SET Opbal = 0

	UPDATE
		#tmpledger
		SET Opbal = T.Oppbal
	FROM #tmpledger L WITH(NoLock),
		#oppbalance T WITH(NoLock)
	WHERE L.Cltcode = T.Cltcode

      If @Strorder = 'Accode'
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
						AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
					ORDER BY L.Cltcode,
						Voudt
				End
			Else
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Cltcode,
						Effdt
				End
		End
	Else
		Begin
			If @Selectby = 'Vdt'
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Voudt
				End
			Else
				Begin
					SELECT
						L.*
					FROM #tmpledger L WITH(NoLock),
						Acmast A WITH(NoLock)
					WHERE L.Cltcode = A.Cltcode
						AND Accat In ('4', '104')
					ORDER BY L.Acname,
						Effdt
				End
		End

/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_ORG
-- --------------------------------------------------
  
--Exec rpt_acc_partyledger 'Jan  1 2007','Jan 25 2007','051','051','ACCODE','vdt','broker','broker',''    
  
CREATE Procedure [dbo].[Rpt_acc_partyledger_ORG]    
(    
 @Fdate Varchar(11),            /* As Mmm Dd Yyyy */    
 @Tdate Varchar(11),            /* As Mmm Dd Yyyy */    
 @Fcode Varchar(10),    
 @Tcode Varchar(10),    
 @Strorder Varchar(6),    
 @Selectby Varchar(3),    
 @Statusid Varchar(15),    
 @Statusname Varchar(15),    
 @Strbranch Varchar(10)    
)    
    
As    
    
/*========================================================================    
      Exec rpt_acc_partyledger_all    
            'Nov  1 2005',    
            'Dec 31 2005',    
            'a',    
            'zzz',    
            'ACCODE',    
            'vdt',    
            'broker',    
            'undefined',    
            ''    
========================================================================*/    
    
Declare    
 @@Opendate   As Varchar(11)    
    
Set Transaction Isolation Level Read Uncommitted    
    
    
/*getting Last Opening Date */    
      If Upper(@Selectby) = 'Vdt'    
      Begin    
            SELECT    
                  @@Opendate =    
                  (    
                        SELECT    
                              Left(Convert(Varchar, SDTCUR, 109), 11)    
                        FROM Parameter WITH(NoLock)    
                        WHERE @Fdate >= SdtCur and @Fdate <= LdtCur  
                  )    
      End    
      Else    
      Begin    
            SELECT    
                  @@Opendate =    
                  (    
                        SELECT    
                              Left(Convert(Varchar, SDTCUR, 109), 11)    
                        FROM Parameter WITH(NoLock)    
                        WHERE @Fdate >= SdtCur and @Fdate <= LdtCur   
                  )    
      End    
    
    
      /*creating Blank Table For Opening Balance*/   
  
 CREATE TABLE #oppbalance  
 (  
  Cltcode Varchar(10),  
  Oppbal Money   
 )  
    
    
      /*getting Opening Balance*/    
      If @Selectby = 'Vdt'    
      Begin    
            If @@Opendate = @Fdate    
         Begin    
                  INSERT    
                  INTO #oppbalance    
            SELECT    
                        Cltcode,    
                        Oppbal = Isnull(Sum(    
                       CASE    
                              WHEN Upper(B.Drcr) = 'D'    
                              THEN B.Vamt    
                              ELSE -b.Vamt    
                        END    
                        ), 0)    
               FROM Ledger B WITH(NoLock)    
                  WHERE B.Cltcode > = @Fcode    
                        AND B.Cltcode < = @Tcode    
                      AND B.Vdt Like @Fdate + '%'    
                        AND Vtyp = 18    
                  GROUP BY Cltcode    
            End    
            Else    
            Begin    
                  INSERT    
                  INTO #oppbalance    
                  SELECT    
                        Cltcode,    
                        Oppbal = Isnull(Sum(    
                        CASE    
                              WHEN Upper(B.Drcr) = 'D'    
                       THEN B.Vamt    
                              ELSE -b.Vamt    
                        END    
                        ), 0)    
                  FROM Ledger B WITH(NoLock)                         WHERE B.Cltcode > = @Fcode    
                        AND B.Cltcode < = @Tcode    
                        AND B.Vdt > = @@Opendate + ' 00:00:00'    
                        AND Vdt < @Fdate    
               GROUP BY Cltcode    
            End    
      End    
      Else    
      Begin    
            If @@Opendate = @Fdate    
            Begin    
                  INSERT    
                  INTO #oppbalance    
                  SELECT    
                        Cltcode,    
        Opbal = Sum(Opbal)    
                  FROM    
                        (    
                              SELECT    
                                    Cltcode,    
                   Opbal = Isnull(Sum(    
    CASE    
                                          WHEN Upper(Drcr) = 'D'    
                                          THEN Vamt    
                                          ELSE -vamt    
                                    END    
                                    ), 0)    
                              FROM Ledger WITH(NoLock)    
                              WHERE Cltcode > = @Fcode    
                                    AND Cltcode < = @Tcode    
                                    AND Edt Like @@Opendate + '%'    
                                    AND Vtyp = 18    
                              GROUP BY Cltcode    
                              UNION ALL    
                              SELECT    
                                    Cltcode,    
                                    Oppbal = Isnull(Sum(    
                                    CASE    
                                  WHEN Upper(B.Drcr) = 'C'    
                                          THEN B.Vamt    
                                          ELSE -b.Vamt    
                                    END    
                                  ), 0)    
                              FROM Ledger B WITH(NoLock)    
                              WHERE B.Cltcode > = @Fcode    
                                    AND B.Cltcode < = @Tcode    
                            AND B.Vdt < @@Opendate    
                                    AND Edt >= @@Opendate    
                              GROUP BY Cltcode    
                        )    
                        T    
      GROUP BY Cltcode    
            End    
            Else    
            Begin    
                  INSERT    
                  INTO #oppbalance    
                  SELECT    
                        Cltcode,    
                   Opbal = Sum(Opbal)    
                  FROM    
                        (    
                              SELECT    
                                    Cltcode,    
                                    Opbal = Isnull(Sum(    
                  CASE    
                                          WHEN Upper(Drcr) = 'D'    
                                          THEN Vamt    
                                          ELSE -vamt    
                                    END    
                                    ), 0)    
             FROM Ledger WITH(NoLock)    
                              WHERE Cltcode > = @Fcode    
                                    AND Cltcode < = @Tcode    
                                    AND Edt Like @@Opendate + '%'    
                                    AND Vtyp = 18    
                              GROUP BY Cltcode    
                              UNION ALL    
                   SELECT    
                                    Cltcode,    
                                    Opbal = Sum(    
                                    CASE    
                                          WHEN Upper(Drcr) = 'D'    
                                          THEN Vamt    
                                          ELSE -vamt    
                                    END    
                                    )    
                              FROM Ledger WITH(NoLock)    
                              WHERE Cltcode > = @Fcode    
                                    AND Cltcode < = @Tcode    
                                    AND Edt > = @@Opendate + ' 00:00:00'    
                                    AND Edt < @Fdate    
                                    AND Vtyp <> 18    
                              GROUP BY Cltcode    
                              UNION ALL    
              SELECT    
                                    Cltcode,    
                                    Oppbal = Isnull(Sum(    
                                    CASE    
                                          WHEN Upper(B.Drcr) = 'C'    
                                          THEN B.Vamt    
             ELSE -b.Vamt    
                                    END    
        ), 0)    
                              FROM Ledger B WITH(NoLock)    
                              WHERE B.Cltcode > = @Fcode    
                                    AND B.Cltcode < = @Tcode    
                AND B.Vdt < @@Opendate    
                                    AND Edt >= @@Opendate    
                              GROUP BY Cltcode    
                        )    
                        T    
                  GROUP BY Cltcode    
            End    
      End    
    
    
      /*generating Blank Structure For Filtered Ledger */    
 Create Table #ledgerdata  
 (  
  vtyp smallint,  
  vno varchar(12),  
  edt datetime,  
  lno int,  
  acname varchar(100),  
  drcr char(1),  
  vamt money,  
  vdt datetime,  
  cltcode varchar(10),  
  BookType char(2),  
  EnteredBy varchar(25),  
  pdt datetime,  
  CheckedBy varchar(25),  
  narration varchar(234),  
  Shortdesc Varchar(35)  
 )  
  
   
      /*getting Fiiltered Ledger*/    
      If @Selectby = 'Vdt'    
      Begin    
            INSERT    
            INTO #ledgerdata    
            SELECT    
                l.vtyp, vno, edt, lno, acname, drcr, vamt, vdt, cltcode, BookType, EnteredBy,  
  pdt, CheckedBy, l.narration, Isnull(V.Shortdesc, '') Shortdesc    
            FROM Ledger L WITH(NoLock),    
                  Vmast V WITH(NoLock)    
            WHERE Vdt > = @Fdate + ' 00:00:00'    
                  AND L.Vtyp = V.Vtype    
                  AND Vdt < = @Tdate +' 23:59:59'    
                  AND Cltcode > = @Fcode    
                  AND Cltcode < = @Tcode    
      End    
      Else    
      Begin    
            INSERT    
            INTO #ledgerdata    
            SELECT    
                l.vtyp, vno, edt, lno, acname, drcr, vamt, vdt, cltcode, BookType, EnteredBy,  
          pdt, CheckedBy, l.narration, Isnull(V.Shortdesc, '') Shortdesc    
            FROM Ledger L WITH(NoLock),    
                  Vmast V WITH(NoLock)    
            WHERE Edt > = @Fdate + ' 00:00:00'    
                  AND L.Vtyp = V.Vtype    
                  AND Edt < = @Tdate +' 23:59:59'    
                  AND Cltcode > = @Fcode    
                  AND Cltcode < = @Tcode    
      End    
    
    
    
/*getting Client List*/    
      SELECT    
            C2.Party_code,    
       C1.Long_Name,    
--          Bank_name = Isnull(C4.Bankid, ''),    
    L_address1,    
            L_address2,    
            L_address3,    
            L_city,    
            L_zip,    
            Res_phone1,    
            C1.Branch_cd,    
           Family,    
            C1.Sub_broker,    
            Trader,    
            Cl_type    
--          Cltdpid = Isnull(Cltdpid, '')    
      INTO #ledgerclients    
      FROM MSAJAG.Dbo.Client1 C1 WITH(NoLock),    
            MSAJAG.Dbo.Client2 C2 WITH(NoLock)    
/*      LEFT OUTER JOIN    
            MSAJAG.Dbo.Client4 C4 WITH(NoLock)    
            ON    
            (    
                  C2.Party_code = C4.Party_code    
                  AND Depository Not In ('Nsdl', 'Cdsl')    
-- AND Defdp = 1    
         AND Defdp = 0    
            )               */    
      WHERE C1.Cl_code = C2.Cl_code    
            AND C1.Branch_cd Like (    
            CASE    
                  WHEN @Statusid = 'Branch'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Sub_broker Like (    
            CASE    
                  WHEN @Statusid = 'Sub_broker'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
     AND Sub_broker Like (    
            CASE    
                  WHEN @Statusid = 'Subbroker'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Trader Like (    
            CASE    
                  WHEN @Statusid = 'Trader'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Area Like (    
            CASE    
   WHEN @Statusid = 'Area'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND Region Like (    
            CASE    
                  WHEN @Statusid = 'Region'    
                  THEN @Statusname    
                  ELSE '%'    
           END    
            )    
            AND C1.Family Like (    
            CASE    
                  WHEN @Statusid = 'Family'    
                  THEN @Statusname    
                  ELSE '%'    
            END    
            )    
            AND C2.Party_code Like (    
            CASE    
                  WHEN @Statusid = 'Client'    
                  THEN @Statusname    
                  ELSE '%'    
          END    
         )    
            AND C1.Branch_cd Like @Strbranch +'%'    
           AND C2.Party_code > = @Fcode    
            AND C2.Party_code < = @Tcode    
    
    
      CREATE TABLE [#tmpledger] (    
       [Booktype] [char] (2)  NULL ,    
       [Voudt] [datetime] NULL ,    
       [Effdt] [datetime] NULL ,    
       [Shortdesc] [varchar] (35)  NULL ,    
       [Dramt] [money] NULL ,    
       [Cramt] [money] NULL ,    
       [Vno] [varchar] (12)  NULL ,    
       [Ddno] [varchar] (15)  NULL ,    
       [Narration] [varchar] (234)  NULL ,    
       [Cltcode] [varchar] (10)  NOT NULL ,    
       [Vtyp] [smallint] NULL ,    
       [Vdt] [varchar] (30)  NULL ,    
       [Edt] [varchar] (30)  NULL ,    
       [Acname] [varchar] (100)  NULL ,    
       [Opbal] [money] NULL ,    
       [L_address1] [varchar] (40)  NOT NULL ,    
       [L_address2] [varchar] (40)  NULL ,    
       [L_address3] [varchar] (40)  NULL ,    
     [L_city] [varchar] (40)  NULL ,    
       [L_zip] [varchar] (10)  NULL ,    
       [Res_phone1] [varchar] (15)  NULL ,    
  [Branch_cd] [varchar] (10)  NOT NULL ,    
       [Crosac] [varchar] (10)  NULL ,    
       [Ediff] [int] NULL ,    
       [Family] [varchar] (10)  NOT NULL ,    
       [Sub_broker] [varchar] (10)  NOT NULL ,    
       [Trader] [varchar] (20)  NOT NULL ,    
       [Cl_type] [varchar] (3)  NOT NULL ,    
--       [Bank_name] [varchar] (50)  NOT NULL ,    
--       [Cltdpid] [varchar] (16)  NOT NULL ,    
       [Lno] [int] NULL,    
       [Pdt] [datetime] NULL    
      ) ON [PRIMARY]    
    
    
/*getting Lddger Entries*/    
      INSERT    
            INTO #tmpledger    
      SELECT    
            L.Booktype,    
            Voudt = L.Vdt,    
            Effdt = L.Edt,    
            L.Shortdesc,    
            Dramt = (    
            CASE    
                  WHEN Upper(L.Drcr) = 'D'    
                  THEN L.Vamt    
                  ELSE 0    
            END    
            ),    
            Cramt = (                            CASE    
                  WHEN Upper(L.Drcr) = 'C'    
                  THEN L.Vamt    
                  ELSE 0    
            END    
            ),    
            L.Vno,    
            Ddno = Space(15),    
            L.Narration,    
            C.Party_code Cltcode,    
            L.Vtyp,    
            Convert(Varchar, L.Vdt, 103) Vdt,    
            Convert(Varchar, L.Edt, 103) Edt,    
--            L.Acname ,    
            C.Long_Name,    
            Opbal = Vamt,    
    C.L_address1,    
            C.L_address2,    
            C.L_address3,    
            C.L_city,    
            C.L_zip,    
            C.Res_phone1,    
            C.Branch_cd,    
            L.Cltcode Crosac ,    
            Ediff = Datediff(D, L.Edt, Getdate()),    
            C.Family,    
            C.Sub_broker,    
            C.Trader,    
            C.Cl_type,    
--          C.Bank_name,    
--          C.Cltdpid,    
            L.Lno,    
       L.Pdt    
      FROM #ledgerdata L WITH(NoLock)    
      RIGHT OUTER JOIN    
            #ledgerclients C WITH(NoLock)    
            ON    
            (    
                  L.Cltcode = C.Party_code    
            )    
    
    
    
/*updating Opening Blanace*/    
     UPDATE    
            #tmpledger    
            SET Opbal = 0    
    
      UPDATE    
            #tmpledger    
            SET Opbal = T.Oppbal    
      FROM #tmpledger L WITH(NoLock),    
            #oppbalance T WITH(NoLock)    
      WHERE L.Cltcode = T.Cltcode    
    
    
    
/*updating Cheque Number*/    
      UPDATE    
            #tmpledger    
            SET Ddno = L1.Ddno    
      FROM Ledger1 L1 WITH(NoLock)    
      WHERE L1.Vno = #tmpledger.Vno    
            AND L1.Vtyp = #tmpledger.Vtyp    
            AND L1.Booktype = #tmpledger.Booktype    
            AND L1.Lno = #tmpledger.Lno    
    
    
    
/*updating Cross Account Code*/    
      UPDATE    
            #tmpledger    
            SET #tmpledger.Crosac = B.Cltcode    
      FROM Ledger B WITH(NoLock),    
            Acmast V WITH(NoLock)    
      WHERE B.Cltcode = V.Cltcode    
            AND V.Accat = 2    
            AND #tmpledger.Booktype = B.Booktype    
            AND #tmpledger.Vno = B.Vno    
            AND #tmpledger.Vtyp = B.Vtyp    
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')    
    
    
    
/*updating Bank Name*/    
/*      UPDATE    
            #tmpledger    
            SET #tmpledger.Bank_name = B.Bank_name    
      FROM MSAJAG.Dbo.Pobank B WITH(NoLock)    
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name))    
*/    
    
      If @Strorder = 'Accode'    
      Begin    
If @Selectby = 'Vdt'    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                        AND Accat In ('4', '104')    
        AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Cltcode,    
                        Voudt, Pdt    
            End    
            Else    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                   AND Accat In ('4', '104')    
         AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Cltcode,    
                        Effdt, Pdt    
            End    
      End    
      Else    
      Begin    
            If @Selectby = 'Vdt'    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                        AND Accat In ('4', '104')    
        AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Acname,    
                        Voudt, Pdt    
            End    
            Else    
            Begin    
                  SELECT    
                        L.*    
                  FROM #tmpledger L WITH(NoLock),    
                        Acmast A WITH(NoLock)    
                  WHERE L.Cltcode = A.Cltcode    
                        AND Accat In ('4', '104')    
        AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
                  ORDER BY L.Acname,    
                        Effdt, Pdt    
            End    
      End    
    
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_PARENT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_ACC_PARTYLEDGER_PARENT]                                          
(                                            
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                                                  
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                                                  
 @FCODE VARCHAR(10),                                                  
 @TCODE VARCHAR(10),                                                  
 @STRORDER VARCHAR(6),                                                  
 @SELECTBY VARCHAR(3),                                                  
 @STATUSID VARCHAR(15),                                                  
 @STATUSNAME VARCHAR(15),                                                  
 @STRBRANCH VARCHAR(10),        
 @ONDEMAND VARCHAR(1)=0                                                  
)                                            
                                            
AS                                                  
                                                  
/*========================================================================                                            
      EXEC RPT_ACC_PARTYLEDGER_ALL                                             
            'NOV  1 2005',                                            
            'DEC 31 2005',                                            
            'A',                                            
            'ZZZ',                                            
            'ACCODE',                                            
            'VDT',                                            
            'BROKER',                                            
            'UNDEFINED',                                            
            ''                                            
========================================================================*/                                            
                                            
DECLARE                                             
 @@OPENDATE   AS VARCHAR(11)                                                  
-------------------------------------------------                            
-- CREATING TEMPORARY TABLE                            
-------------------------------------------------                            
CREATE TABLE #OPPBALANCE                            
(                            
 CLTCODE VARCHAR(10),                            
 OPPBAL MONEY                            
)                            
                            
CREATE TABLE #LEDGERCLIENTS(                            
 [PARTY_CODE] [CHAR](10) NOT NULL,                            
 [LONG_NAME] [VARCHAR](100) NULL,                            
 [BANK_NAME] [VARCHAR](50) NOT NULL,                            
 [L_ADDRESS1] [VARCHAR](40) NOT NULL,                            
 [L_ADDRESS2] [VARCHAR](40) NULL,                            
 [L_ADDRESS3] [VARCHAR](40) NULL,                            
 [L_CITY] [VARCHAR](40) NULL,                            
 [L_ZIP] [VARCHAR](10) NULL,                            
 [RES_PHONE1] [VARCHAR](15) NULL,                            
 [BRANCH_CD] [VARCHAR](10) NULL,                            
 [FAMILY] [VARCHAR](10) NOT NULL,                            
 [SUB_BROKER] [VARCHAR](10) NOT NULL,                            
 [TRADER] [VARCHAR](20) NULL,                            
 [CL_TYPE] [VARCHAR](3) NOT NULL,                            
 [CLTDPID] [VARCHAR](20) NOT NULL,                
 [PARENTCODE] [VARCHAR](10) NOT NULL                
)                            
                
CREATE TABLE #LEDGERDATA (                            
 [VTYP] [SMALLINT] NOT NULL,                            
 [VNO] [VARCHAR](12) NOT NULL,                            
 [EDT] [DATETIME] NULL,                            
 [LNO] [INT] NOT NULL,                            
 [ACNAME] [VARCHAR](100) NOT NULL,                            
 [DRCR] [CHAR](1) NULL,              
 [VAMT] [MONEY] NULL,                            
 [VDT] [DATETIME] NULL,               
 [VNO1] [VARCHAR](12) NULL,               
 [REFNO] [CHAR](12) NULL,                            
 [BALAMT] [MONEY] NOT NULL,                            
 [NODAYS] [INT] NULL,                            
 [CDT] [DATETIME] NULL,                            
 [CLTCODE] [VARCHAR](10) NOT NULL,                            
 [BOOKTYPE] [CHAR](2) NOT NULL,                        
 [ENTEREDBY] [VARCHAR](25) NULL,                            
 [PDT] [DATETIME] NULL,                            
 [CHECKEDBY] [VARCHAR](25) NULL,                            
 [ACTNODAYS] [INT] NULL,                            
 [NARRATION] [VARCHAR](234) NULL,                            
 [SHORTDESC] [VARCHAR](35) NULL,                
 [PARENTCODE] VARCHAR(12)                            
)                            
-------------------------------------------------                            
-- CREATING TEMPORARY TABLES                            
-------------------------------------------------                            
                                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                                  
                                                  
/*GETTING LAST OPENING DATE */                                                  
      IF UPPER(@SELECTBY) = 'VDT'                                                  
      BEGIN                               
            SELECT                                             
                  @@OPENDATE =                                             
                  (                                             
                        SELECT                              
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11)                                             
                        FROM LEDGER WITH(NOLOCK)                                             
      WHERE VTYP = 18                                             
                              AND VDT < = @FDATE                                             
                  )                                             
      END                                                  
      ELSE                                                  
      BEGIN                                                  
            SELECT                                             
                  @@OPENDATE =                                             
                  (                                             
                        SELECT                                             
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)                                             
                        FROM LEDGER WITH(NOLOCK)                                             
                        WHERE VTYP = 18                                             
                              AND EDT < = @FDATE                                             
                  )                                             
      END                                                  
                                                        
IF @ONDEMAND = 0        
BEGIN                                               
      /*GETTING OPENING BALANCE*/                                                  
      IF @SELECTBY = 'VDT'                                                  
      BEGIN                                                  
            IF @@OPENDATE = @FDATE                                                   
            BEGIN                                                  
                  INSERT                                             
                  INTO #OPPBALANCE                                             
                  SELECT                                
                        PARENTCODE,                                             
                        OPPBAL = ISNULL(SUM(                                             
                        CASE                                             
             WHEN UPPER(B.DRCR) = 'D'                                             
                              THEN B.VAMT                                             
                             ELSE -B.VAMT                                             
                        END                                            
                        ), 0)                                             
                  FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
                  WHERE                 
         B.CLTCODE = C2.PARTY_CODE                
         AND PARENTCODE > = @FCODE                
                        AND PARENTCODE < = @TCODE                
                        AND B.VDT LIKE @FDATE + '%'                               
                        AND VTYP = 18                                             
                  GROUP BY PARENTCODE                                             
            END                                                  
            ELSE                                                  
            BEGIN                                                  
                  INSERT                                             
                  INTO #OPPBALANCE                                             
                  SELECT                                        
                        PARENTCODE,                                             
      OPPBAL = ISNULL(SUM(                                             
                        CASE                                             
                              WHEN UPPER(B.DRCR) = 'D'                                             
                       THEN B.VAMT                                             
                              ELSE -B.VAMT                                             
                        END                                            
                      ), 0)                                             
                  FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
      WHERE                 
      B.CLTCODE = C2.PARTY_CODE                
      AND PARENTCODE > = @FCODE                
                        AND PARENTCODE < = @TCODE                                          
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'                                             
                        AND VDT < @FDATE                                             
               GROUP BY PARENTCODE                                             
            END                                          
  END                                                   
      ELSE                                                  
      BEGIN                                                   
            IF @@OPENDATE = @FDATE                                                   
            BEGIN                                                
                  INSERT                                             
                  INTO #OPPBALANCE                                             
      SELECT                                             
                        CLTCODE,                                             
      OPBAL = SUM(OPBAL)                                             
     FROM                                             
                        (                                             
                              SELECT                                             
                                    CLTCODE = PARENTCODE,                                             
                                    OPBAL = ISNULL(SUM(                                             
                                    CASE                                             
                      WHEN UPPER(DRCR) = 'D'             
                                          THEN VAMT                                             
                                          ELSE -VAMT                                             
                                    END                                            
         ), 0)                                             
             FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
        WHERE                 
            B.CLTCODE = C2.PARTY_CODE                
            AND PARENTCODE > = @FCODE                
            AND PARENTCODE < = @TCODE                                                
                                    AND EDT LIKE @@OPENDATE + '%'                                             
                                    AND VTYP = 18                                             
                              GROUP BY PARENTCODE                         
                              UNION ALL                                             
                              SELECT                                             
                                    CLTCODE = PARENTCODE,                                             
                                    OPPBAL = ISNULL(SUM(                                             
         CASE                                             
                                          WHEN UPPER(B.DRCR) = 'C'                                             
                                          THEN B.VAMT                                             
                                          ELSE -B.VAMT                                             
                                    END                                            
         ), 0)                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
        WHERE                 
         B.CLTCODE = C2.PARTY_CODE                
         AND PARENTCODE > = @FCODE                
         AND PARENTCODE < = @TCODE                                               
                                    AND B.VDT < @@OPENDATE                                            
                                    AND EDT >= @@OPENDATE                                             
                         GROUP BY PARENTCODE                                             
                        )                                             
                        T                                             
                  GROUP BY CLTCODE                                             
            END                                                
            ELSE                                                
            BEGIN                                                
                  INSERT                                       
                  INTO #OPPBALANCE                                             
                  SELECT                                             
                        CLTCODE,                                          
                        OPBAL = SUM(OPBAL)                                             
      FROM                                             
                        (                                             
                              SELECT                                             
         CLTCODE = PARENTCODE,                                             
                                    OPBAL = ISNULL(SUM(                                             
         CASE                                             
         WHEN UPPER(DRCR) = 'D'                                             
                                          THEN VAMT                                             
                                          ELSE -VAMT              
                                    END                                            
                                    ), 0)                                            
         FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
         WHERE                 
         B.CLTCODE = C2.PARTY_CODE                
         AND PARENTCODE > = @FCODE                
         AND PARENTCODE < = @TCODE                                           
                                    AND EDT LIKE @@OPENDATE + '%'                                             
                                    AND VTYP = 18                                             
                 GROUP BY PARENTCODE                                             
                              UNION ALL                                             
         SELECT                                             
           CLTCODE = PARENTCODE,                                             
                                    OPBAL = SUM(                                             
                                    CASE                                             
                                          WHEN UPPER(DRCR) = 'D'                                             
                                          THEN VAMT                                             
            ELSE -VAMT                                           
                                    END                                            
                                    )                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
         WHERE                 
        B.CLTCODE = C2.PARTY_CODE                
        AND PARENTCODE > = @FCODE                
        AND PARENTCODE < = @TCODE                                              
                                AND EDT > = @@OPENDATE + ' 00:00:00'                                             
                                AND EDT < @FDATE                                             
                                AND VTYP <> 18                                             
                              GROUP BY PARENTCODE                                             
                              UNION ALL                                             
         SELECT                                             
                                    CLTCODE = PARENTCODE,                                             
                                    OPPBAL = ISNULL(SUM(                                             
                                    CASE                                             
                                          WHEN UPPER(B.DRCR) = 'C'                                             
                                          THEN B.VAMT                                             
            ELSE -B.VAMT                              
                                    END                                            
                                    ), 0)                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
         WHERE                 
        B.CLTCODE = C2.PARTY_CODE                
        AND PARENTCODE > = @FCODE                
        AND PARENTCODE < = @TCODE                                             
                                AND B.VDT < @@OPENDATE                                             
                                AND EDT >= @@OPENDATE                                             
                              GROUP BY PARENTCODE                                             
                        )                                             
                        T                                             
                 GROUP BY CLTCODE                                             
            END                                                
      END                                                  
                                                        
                                                  
                          
                                                  
      /*GETTING FIILTERED LEDGER*/                     
      IF @SELECTBY = 'VDT'                                       
      BEGIN                     
            INSERT                                             
            INTO #LEDGERDATA                                             
            SELECT                                             
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                                           
                  ISNULL(V.SHORTDESC, '') SHORTDESC, PARENTCODE                
   FROM LEDGER L WITH(NOLOCK),                
                  VMAST V WITH(NOLOCK),                
      (SELECT PARTY_CODE, PARENTCODE FROM MSAJAG.DBO.CLIENT2                
                  WHERE PARENTCODE > = @FCODE                                             
                  AND PARENTCODE < = @TCODE) C2                
            WHERE VDT > = @FDATE + ' 00:00:00'                
                  AND L.VTYP = V.VTYPE                
                  AND VDT < = @TDATE +' 23:59:59'                
      AND L.CLTCODE = C2.PARTY_CODE                
      END                                                   
      ELSE                                                  
      BEGIN                                                  
            INSERT                               
            INTO #LEDGERDATA                                             
            SELECT                                             
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                                             
                  ISNULL(V.SHORTDESC, '') SHORTDESC, PARENTCODE                                             
            FROM LEDGER L WITH(NOLOCK),                                             
                  VMAST V WITH(NOLOCK),                
      (SELECT PARTY_CODE, PARENTCODE FROM MSAJAG.DBO.CLIENT2                
                  WHERE PARENTCODE > = @FCODE                                             
                  AND PARENTCODE < = @TCODE) C2                
            WHERE EDT > = @FDATE + ' 00:00:00'                
                  AND L.VTYP = V.VTYPE                
                  AND EDT < = @TDATE +' 23:59:59'                
      AND L.CLTCODE = C2.PARTY_CODE                                            
      END             
END        
ELSE        
BEGIN        
 /*GETTING OPENING BALANCE*/                                                  
      IF @SELECTBY = 'VDT'                                                  
      BEGIN                                                  
            IF @@OPENDATE = @FDATE                                                   
            BEGIN                                                  
                  INSERT                                             
                  INTO #OPPBALANCE                                             
                  SELECT                                             
                        PARENTCODE,                                             
                        OPPBAL = ISNULL(SUM(                                             
                        CASE                                             
                              WHEN UPPER(B.DRCR) = 'D'                                             
                              THEN B.VAMT                                             
                             ELSE -B.VAMT                
                        END                                            
                        ), 0)                                             
                  FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
                  WHERE                 
         B.CLTCODE = C2.PARTY_CODE                
         AND PARENTCODE > = @FCODE                
                        AND PARENTCODE < = @TCODE                
                        AND B.VDT LIKE @FDATE + '%'                               
                        AND VTYP = 18       
                  GROUP BY PARENTCODE                                             
            END                                                  
            ELSE                                                  
            BEGIN                                                  
                  INSERT                                             
                  INTO #OPPBALANCE                                             
                  SELECT                                        
                        PARENTCODE,                                             
      OPPBAL = ISNULL(SUM(                                             
                        CASE                  
                              WHEN UPPER(B.DRCR) = 'D'                                             
                       THEN B.VAMT                                             
                              ELSE -B.VAMT                                             
                        END                                            
                      ), 0)                                             
                  FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
      WHERE                 
      B.CLTCODE = C2.PARTY_CODE                
      AND PARENTCODE > = @FCODE                
                        AND PARENTCODE < = @TCODE                                          
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'                                             
                        AND VDT < @FDATE              
      AND VTYP <> 8                                       
               GROUP BY PARENTCODE                                             
            END                                          
  END                                                   
      ELSE                                                  
      BEGIN                                                   
            IF @@OPENDATE = @FDATE                                                   
            BEGIN                                                
                  INSERT                                             
                  INTO #OPPBALANCE                                             
      SELECT                                             
                        CLTCODE,                                             
      OPBAL = SUM(OPBAL)                                             
     FROM                                             
                        (                                             
                              SELECT                                             
                                    CLTCODE = PARENTCODE,                                             
                                    OPBAL = ISNULL(SUM(                                             
                                    CASE                                             
                                          WHEN UPPER(DRCR) = 'D'                                             
                                          THEN VAMT                                             
                                          ELSE -VAMT                                             
                                    END                                            
                                    ), 0)                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
        WHERE                 
            B.CLTCODE = C2.PARTY_CODE                
            AND PARENTCODE > = @FCODE                
            AND PARENTCODE < = @TCODE                                                
                                    AND EDT LIKE @@OPENDATE + '%'                                             
                                    AND VTYP = 18                                             
                              GROUP BY PARENTCODE                         
                              UNION ALL                                             
                              SELECT                                    
                                    CLTCODE = PARENTCODE,                                             
                                    OPPBAL = ISNULL(SUM(                                             
         CASE                                             
                                          WHEN UPPER(B.DRCR) = 'C'                                             
                                          THEN B.VAMT                                             
                                          ELSE -B.VAMT                                             
                                    END                                            
         ), 0)                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
        WHERE                 
         B.CLTCODE = C2.PARTY_CODE                
         AND PARENTCODE > = @FCODE                
         AND PARENTCODE < = @TCODE                                               
                                    AND B.VDT < @@OPENDATE                                            
                                    AND EDT >= @@OPENDATE        
         AND VTYP <> 8                                             
       GROUP BY PARENTCODE                                             
                        )                                             
                        T                                             
                  GROUP BY CLTCODE                                             
            END                                                
            ELSE                                                
            BEGIN                                                
                  INSERT                                       
                  INTO #OPPBALANCE                                             
                  SELECT                                             
                        CLTCODE,                                          
                        OPBAL = SUM(OPBAL)                                             
      FROM                                             
                        (                                             
                              SELECT                                             
         CLTCODE = PARENTCODE,                                             
                                    OPBAL = ISNULL(SUM(                                             
         CASE                                             
         WHEN UPPER(DRCR) = 'D'                                             
                                          THEN VAMT                                             
                                          ELSE -VAMT                                       
                                    END                                            
                                    ), 0)                                            
         FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
         WHERE     
         B.CLTCODE = C2.PARTY_CODE                
         AND PARENTCODE > = @FCODE                
         AND PARENTCODE < = @TCODE                                           
                                    AND EDT LIKE @@OPENDATE + '%'                                             
                                    AND VTYP = 18                                             
                              GROUP BY PARENTCODE                                             
                              UNION ALL                                             
         SELECT                                             
           CLTCODE = PARENTCODE,                                             
                                    OPBAL = SUM(                                             
   CASE                                             
                                          WHEN UPPER(DRCR) = 'D'                                             
        THEN VAMT                                             
            ELSE -VAMT                                           
                                    END                                            
                                    )                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
         WHERE                 
        B.CLTCODE = C2.PARTY_CODE                
        AND PARENTCODE > = @FCODE                
        AND PARENTCODE < = @TCODE                                              
                                AND EDT > = @@OPENDATE + ' 00:00:00'                                             
                                AND EDT < @FDATE                                             
                                AND VTYP NOT IN (8, 18)        
      GROUP BY PARENTCODE                                             
                              UNION ALL                                             
         SELECT                                             
                                    CLTCODE = PARENTCODE,                                             
                                    OPPBAL = ISNULL(SUM(                                             
                                    CASE                                             
                                          WHEN UPPER(B.DRCR) = 'C'                                             
                                          THEN B.VAMT                                             
            ELSE -B.VAMT                              
                                    END                                            
                                    ), 0)                                             
                              FROM LEDGER B WITH(NOLOCK), MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                                             
         WHERE                 
        B.CLTCODE = C2.PARTY_CODE                
        AND PARENTCODE > = @FCODE                
        AND PARENTCODE < = @TCODE                                             
                                AND B.VDT < @@OPENDATE                                             
                                AND EDT >= @@OPENDATE                                             
                              GROUP BY PARENTCODE                                             
                        )                                             
                        T                                             
                  GROUP BY CLTCODE                                             
            END                                                
      END                                                  
                                                        
                                                  
                          
                                                  
      /*GETTING FIILTERED LEDGER*/                                     
      IF @SELECTBY = 'VDT'                                       
      BEGIN                                                  
            INSERT                                             
            INTO #LEDGERDATA                                             
            SELECT                                             
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                                           
                  ISNULL(V.SHORTDESC, '') SHORTDESC, PARENTCODE                
   FROM LEDGER L WITH(NOLOCK),                
                  (SELECT * FROM VMAST WITH(NOLOCK) WHERE VTYPE <> 8) V,        
      (SELECT PARTY_CODE, PARENTCODE FROM MSAJAG.DBO.CLIENT2                
                  WHERE PARENTCODE > = @FCODE                         
                  AND PARENTCODE < = @TCODE) C2                
            WHERE VDT > = @FDATE + ' 00:00:00'                
                  AND L.VTYP = V.VTYPE                
                  AND VDT < = @TDATE +' 23:59:59'                
      AND L.CLTCODE = C2.PARTY_CODE                
      END                                                   
      ELSE                                                  
      BEGIN                                                  
            INSERT                               
            INTO #LEDGERDATA                                             
            SELECT                                             
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                                             
                  ISNULL(V.SHORTDESC, '') SHORTDESC, PARENTCODE                                             
            FROM LEDGER L WITH(NOLOCK),                                             
                  (SELECT * FROM VMAST WITH(NOLOCK) WHERE VTYPE <> 8) V,                
      (SELECT PARTY_CODE, PARENTCODE FROM MSAJAG.DBO.CLIENT2                
                  WHERE PARENTCODE > = @FCODE                            
                  AND PARENTCODE < = @TCODE) C2                
            WHERE EDT > = @FDATE + ' 00:00:00'                
                  AND L.VTYP = V.VTYPE                
                  AND EDT < = @TDATE +' 23:59:59'                
      AND L.CLTCODE = C2.PARTY_CODE                                            
      END        
END                                             
                                                  
                                            
                                            
/*GETTING CLIENT LIST*/                             
 INSERT INTO #LEDGERCLIENTS                                          
      SELECT                                             
            C2.PARTY_CODE,                                            
            C1.LONG_NAME,                                            
            BANK_NAME = ISNULL(C4.BANKID, ''),                                             
            L_ADDRESS1,                                             
            L_ADDRESS2,                                             
            L_ADDRESS3,                                             
            L_CITY,                                             
            L_ZIP,                                             
            RES_PHONE1,                                             
            C1.BRANCH_CD,                                             
   FAMILY,                                             
            C1.SUB_BROKER,                                             
            TRADER,                                             
            CL_TYPE,                                             
            CLTDPID = ISNULL(CLTDPID, ''),                
   PARENTCODE                                             
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),                                             
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)                
      LEFT OUTER JOIN                                             
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)                                             
            ON                                             
            (                                            
                  C2.PARTY_CODE = C4.PARTY_CODE                                             
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')                                             
                  AND DEFDP = 0                                        
            )                                             
      WHERE C1.CL_CODE = C2.CL_CODE                
   AND C2.PARTY_CODE BETWEEN @FCODE AND @TCODE                
   AND C2.PARENTCODE BETWEEN @FCODE AND @TCODE                
            AND C1.BRANCH_CD LIKE (                                            
            CASE                       
      WHEN @STATUSID = 'BRANCH'                                             
                  THEN @STATUSNAME                                             
                  ELSE '%'                                             
            END                                            
            )                                             
            AND SUB_BROKER LIKE (                                      
            CASE                                             
                  WHEN @STATUSID = 'SUB_BROKER'                                             
                  THEN @STATUSNAME                                     
                  ELSE '%'                                             
            END                                            
            )                                             
   AND SUB_BROKER LIKE (                                            
            CASE                                        
      WHEN @STATUSID = 'SUBBROKER'                                             
                  THEN @STATUSNAME                            
                  ELSE '%'                                             
            END                                            
            )                                             
            AND TRADER LIKE (                                            
            CASE                                             
                  WHEN @STATUSID = 'TRADER'                                             
                  THEN @STATUSNAME                                             
                  ELSE '%'                                             
            END                                            
            )                                             
   AND AREA LIKE (                                            
            CASE                                             
                  WHEN @STATUSID = 'AREA'                                             
                  THEN @STATUSNAME                                             
                  ELSE '%'                                
            END                                            
            )                                       
            AND REGION LIKE (                                            
            CASE                                             
                  WHEN @STATUSID = 'REGION'                                             
                  THEN @STATUSNAME                                             
                  ELSE '%'                                             
            END                    
            )                                            
            AND C1.FAMILY LIKE (                                            
            CASE                                             
                  WHEN @STATUSID = 'FAMILY'                                             
                  THEN @STATUSNAME                                             
            ELSE '%'                                             
            END                                            
  )                                             
            AND C2.PARTY_CODE LIKE (                                            
            CASE                                             
                  WHEN @STATUSID = 'CLIENT'                                             
                  THEN @STATUSNAME                                             
                  ELSE '%'                                             
            END                             
         )                                             
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                                             
                                                      
                                            
                                            
      CREATE TABLE [#TMPLEDGER] (                                            
       [BOOKTYPE] [CHAR] (2)  NULL ,                                            
       [VOUDT] [DATETIME] NULL ,                   
       [EFFDT] [DATETIME] NULL ,                                            
       [SHORTDESC] [VARCHAR] (35)  NULL ,                                            
       [DRAMT] [MONEY] NULL ,                                            
       [CRAMT] [MONEY] NULL ,                                            
       [VNO] [VARCHAR] (12)  NULL ,                                            
       [DDNO] [VARCHAR] (20)  NULL ,                                            
       [NARRATION] [VARCHAR] (234)  NULL ,                                            
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,                                            
       [VTYP] [SMALLINT] NULL ,                                            
       [VDT] [VARCHAR] (30)  NULL ,                                            
       [EDT] [VARCHAR] (30)  NULL ,                       
       [ACNAME] [VARCHAR] (100)  NULL ,                                            
       [OPBAL] [MONEY] NULL ,                                            
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,                                            
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,                                            
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,                                            
       [L_CITY] [VARCHAR] (40)  NULL ,           
       [L_ZIP] [VARCHAR] (10)  NULL ,                                            
       [RES_PHONE1] [VARCHAR] (15)  NULL ,                                            
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,                                            
       [CROSAC] [VARCHAR] (10)  NULL ,                                            
       [EDIFF] [INT] NULL ,                                            
       [FAMILY] [VARCHAR] (10)  NOT NULL ,                                  
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,                                            
       [TRADER] [VARCHAR] (20)  NOT NULL ,                                            
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,                                            
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,                                            
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,              
       [LNO] [INT] NULL,                                          
       [PDT] [DATETIME] NULL,                
       [PARENTCODE] VARCHAR(10) NULL                                          
      ) ON [PRIMARY]                                            
                                            
                                                  
/*GETTING LDDGER ENTRIES*/                                                  
      INSERT                                             
            INTO #TMPLEDGER                                             
      SELECT                                             
            L.BOOKTYPE,                                             
            VOUDT = L.VDT,                                             
            EFFDT = L.EDT,                                             
            L.SHORTDESC,                                             
            DRAMT = (                                            
            CASE                                             
             WHEN UPPER(L.DRCR) = 'D'                                             
                  THEN L.VAMT                                             
                  ELSE 0                                             
            END),                
            CRAMT = (                                            
            CASE                                             
                  WHEN UPPER(L.DRCR) = 'C'                                             
                  THEN L.VAMT                                             
                  ELSE 0                                             
            END                                            
            ),                                             
            L.VNO,                                             
            DDNO = SPACE(15),                                             
        L.NARRATION,                                             
            C.PARTY_CODE CLTCODE,                                             
            L.VTYP,                                             
            CONVERT(VARCHAR, L.VDT, 103) VDT,                                             
            CONVERT(VARCHAR, L.EDT, 103) EDT,                                             
--            L.ACNAME ,                                             
            C.LONG_NAME,                                            
            OPBAL = VAMT,                                          
   C.L_ADDRESS1,        
            C.L_ADDRESS2,                                             
            C.L_ADDRESS3,                                             
            C.L_CITY,                                             
            C.L_ZIP,                                             
            C.RES_PHONE1,                                             
            C.BRANCH_CD,                                             
            L.CLTCODE CROSAC ,                                             
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),                                             
            C.FAMILY,                                             
            C.SUB_BROKER,                                             
            C.TRADER,                                      
            C.CL_TYPE,                                             
            C.BANK_NAME,                                             
            C.CLTDPID,                                             
            L.LNO,                                          
      L.PDT,                
      C.PARENTCODE                                             
      FROM #LEDGERDATA L WITH(NOLOCK)                                  
      RIGHT OUTER JOIN                                             
            #LEDGERCLIENTS C WITH(NOLOCK)                                             
            ON         
            (                                            
                  L.PARENTCODE = C.PARTY_CODE              
            )                                             
                                            
                                            
                                                  
/*UPDATING OPENING BLANACE*/                                                  
      UPDATE                                             
            #TMPLEDGER                                             
            SET OPBAL = 0                                             
                                            
      UPDATE                                             
            #TMPLEDGER                                             
            SET OPBAL = T.OPPBAL         
      FROM #TMPLEDGER L WITH(NOLOCK),                                             
            #OPPBALANCE T WITH(NOLOCK)                                             
      WHERE L.PARENTCODE = T.CLTCODE                                             
                                           
                                            
                                            
/*UPDATING CHEQUE NUMBER*/                                                  
      UPDATE                                             
            #TMPLEDGER                                             
            SET DDNO = L1.DDNO                                             
      FROM LEDGER1 L1 WITH(NOLOCK)                                             
      WHERE L1.VNO = #TMPLEDGER.VNO                                             
            AND L1.VTYP = #TMPLEDGER.VTYP                                           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE                                             
            AND L1.LNO = #TMPLEDGER.LNO                                             
                
                                            
                                            
/*UPDATING CROSS ACCOUNT CODE*/                                                  
      UPDATE          
       #TMPLEDGER                                             
            SET #TMPLEDGER.CROSAC = B.CLTCODE                                             
      FROM LEDGER B WITH(NOLOCK),                                             
            ACMAST V WITH(NOLOCK)                                             
      WHERE B.CLTCODE = V.CLTCODE                                             
            AND V.ACCAT = 2                                             
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE                                             
            AND #TMPLEDGER.VNO = B.VNO                                             
            AND #TMPLEDGER.VTYP = B.VTYP                                             
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')                                             
                                           
                                 
                          
/*UPDATING BANK NAME*/                                                                 
      UPDATE                                             
            #TMPLEDGER                                             
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME                                             
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)                                             
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))                                             
                
                
                                           
                
      IF @STRORDER = 'ACCODE'                                                  
      BEGIN                                                  
            IF @SELECTBY = 'VDT'                                                  
            BEGIN                                                   
                  SELECT                                             
                        L.BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE=L.PARENTCODE,VTYP,VDT,EDT,      
L.ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,      
SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT                
                  FROM #TMPLEDGER L WITH(NOLOCK),                                             
                        ACMAST A WITH(NOLOCK)                                             
                  WHERE L.CLTCODE = A.CLTCODE                                             
                        AND ACCAT IN ('4', '104')                                             
      AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                                  
                  ORDER BY L.CLTCODE,                                          
                        VOUDT, PDT                                          
            END                                                  
            ELSE                                                  
            BEGIN                                                  
                  SELECT                                             
                        L.BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE=L.PARENTCODE,VTYP,VDT,EDT      
,L.ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,      
SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT                
                  FROM #TMPLEDGER L WITH(NOLOCK),                                             
                        ACMAST A WITH(NOLOCK)                                             
                  WHERE L.CLTCODE = A.CLTCODE                                             
                        AND ACCAT IN ('4', '104')                                             
                        AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                              
                  ORDER BY L.CLTCODE,                                            
                        EFFDT, PDT                                          
        END                                                  
      END                                                  
      ELSE                                                  
      BEGIN                                                  
            IF @SELECTBY = 'VDT'                                                  
            BEGIN                                                   
                  SELECT                                             
                        L.BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE=L.PARENTCODE,VTYP,VDT,EDT      
,L.ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,      
SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT                
                  FROM #TMPLEDGER L WITH(NOLOCK),          
                        ACMAST A WITH(NOLOCK)                                             
                  WHERE L.CLTCODE = A.CLTCODE                                             
                        AND ACCAT IN ('4', '104')                               
      AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                                        
                  ORDER BY L.ACNAME,                                           
                        VOUDT, PDT                                             
            END                                                  
            ELSE                          
            BEGIN                                                  
                  SELECT                                             
                        L.BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE=L.PARENTCODE,VTYP,VDT,EDT 
 ,L.ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,      
SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT                
                  FROM #TMPLEDGER L WITH(NOLOCK),                                             
                        ACMAST A WITH(NOLOCK)                                             
                  WHERE L.CLTCODE = A.CLTCODE                                             
                        AND ACCAT IN ('4', '104')                              
                        AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                                             
                  ORDER BY L.ACNAME,                                                           EFFDT, PDT                                          
            END                                                  
      END                                                  
                                          
/*  ------------------------------   END OF THE PROC  -------------------------------------*/                                                  
                                                  
-------------------------------------------------                            
-- DESTROYING TEMPORARY TABLE                            
-------------------------------------------------                            
TRUNCATE TABLE #OPPBALANCE                                                  
TRUNCATE TABLE #LEDGERCLIENTS                            
TRUNCATE TABLE #LEDGERDATA                            
                            
DROP TABLE #OPPBALANCE                            
DROP TABLE #LEDGERCLIENTS                                              
DROP TABLE #LEDGERDATA                                            
-------------------------------------------------                            
-- DESTROYING TEMPORARY TABLE                            
-------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[RPT_ACC_TRIALBALANCE]    

	@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */    
	@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */    
	@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */    
	@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */    
	@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */    
	@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */    
	@OPENENTRYFLAG INT,    
	@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */    
	@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */    
	@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */    
	@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */    
	@BULK VARCHAR(1) = 'N',
	@FNAME VARCHAR(200) = ''

/*
	Exec rpt_Acc_TrialBalance 'Mar 31 2007', 'codewise', 'all', 'withopbal', 'Apr  1 2006', 'Apr  1 2006', 0,'Apr  1 2006', 'BROKER', '%', 'Edt', 'Y', 'D:\TEST.TXT'
*/
    
AS    

DECLARE  
	@@COSTCODE AS VARCHAR(3),
	@@TEMPTABLE AS VARCHAR(100),
	@@SQL AS VARCHAR(2000),
	@@ERRORCNT AS INT

    
SELECT * INTO 	#ACMAST FROM ACMAST WHERE 1 = 2    
  
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2    
  
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2    

IF UPPER(@STATUSID) = 'BROKER'    
	BEGIN
		IF @BALANCE='NORMAL'    
			IF @SORTBYDATE = 'VDT'    
				BEGIN       
					INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,  
					AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)    
					FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'      
					GROUP BY L.CLTCODE    
				END    
			ELSE   
				BEGIN    
					INSERT INTO #TEMPLEDGER    
					SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0     
					FROM      
					(       
					SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)  
					FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18      
					GROUP BY L.CLTCODE      
					
					UNION ALL      
					
					SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)   
					FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <=  @VDT + ' 23:59:59' AND VTYP <> 18      
					GROUP BY L.CLTCODE
					
					UNION ALL      
					
					SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)  
					FROM LEDGER L  WHERE L.EDT >=  @CURRYRSTDATE + ' 00:00:00'    
					AND VDT < @CURRYRSTDATE      
					GROUP BY L.CLTCODE       
					) T      
					GROUP BY CLTCODE       
				END    
		ELSE  
			IF @SORTBYDATE = 'VDT'    
				BEGIN    
					IF @STDATE = @CURRYRSTDATE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
					ELSE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
				END    
			ELSE    
				BEGIN    
					IF @STDATE = @CURRYRSTDATE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND EDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND EDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END + CASE WHEN (EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE) THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END)
							FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
					ELSE
						BEGIN
							INSERT INTO #TEMPLEDGER    
							SELECT L.CLTCODE ,    
							DRTOT = SUM(CASE WHEN VTYP <> 18 AND EDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
							CRTOT = SUM(CASE WHEN VTYP <> 18 AND EDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
							OPBAL = SUM(CASE WHEN EDT < @STDATE THEN (CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END  + CASE WHEN (EDT >= @CURRYRSTDATE AND VDT < @CURRYRSTDATE) THEN (CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
							FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'     
							GROUP BY L.CLTCODE    
						END
				END     
  
		IF  @VIEWOPTION = 'PARTYWISE'     
			BEGIN    
				INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
				FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)  
			END    
		ELSE    
			IF @VIEWOPTION = 'GL'    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END    
			ELSE    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END   
		  
		IF @VIEWOPTION = 'GL'    
			BEGIN  
				INSERT INTO #TEMPLEDGERFINAL  
				SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4   
			END  
	END 
/*  -- FOR BRANCH SELECTION --  */  
IF UPPER(@STATUSID) = 'BRANCH'    
	BEGIN
		SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )  
			IF @BALANCE='NORMAL'    
				IF @SORTBYDATE = 'VDT'    
					BEGIN       
						INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,  
						AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)    
						FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'      
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE    
					END    
				ELSE   
					BEGIN    
						INSERT INTO #TEMPLEDGER    
						SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0     
						FROM      
						(       
						SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)  
						FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18      
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE      

						UNION ALL      

						SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)   
						FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18      
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE       

						UNION ALL      

						SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)  
						FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L.CLTCODE       
						) T      
						GROUP BY CLTCODE       
					END    
			ELSE  
				IF @SORTBYDATE = 'VDT'    
					BEGIN    
						INSERT INTO #TEMPLEDGER    
						SELECT L2.CLTCODE ,    
						DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
						CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
						OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
						FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L2.CLTCODE    
					END    
				ELSE    
					BEGIN    
						INSERT INTO #TEMPLEDGER    
						SELECT L2.CLTCODE ,    
						DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),     
						CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),     
						OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)    
						FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'     
						AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO
						AND COSTCODE = @@COSTCODE
						GROUP BY L2.CLTCODE    
					END     

		IF  @VIEWOPTION = 'PARTYWISE'     
			BEGIN    
				INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
				FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)  
			END    
		ELSE    
			IF @VIEWOPTION = 'GL'    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END    
			ELSE    
				BEGIN    
					INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT   
					FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)  
				END   
  
		IF @VIEWOPTION = 'GL'    
			BEGIN  
				INSERT INTO #TEMPLEDGERFINAL  
				SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4   
			END  
	END 
/* ---------------------------- */  

IF @BULK = 'N'
	BEGIN
		IF @FLAG = 'CODEWISE'    
			BEGIN  
				SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE  
			END  
		ELSE  
			BEGIN  
				SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE  
			END  
	END
ELSE IF @BULK = 'Y'
	BEGIN
		IF @FNAME <> ''
			BEGIN
				INSERT INTO TEMP_TRIALBALANCE_BULK (CLTCODE, DRTOT, CRTOT, AMOUNT, ACNAME, BRANCHCODE, ACCAT, PROCID)
				SELECT CLTCODE,DRTOT,CRTOT, AMOUNT, ACNAME, BRANCHCODE, ACCAT, PROCID = @@SPID FROM #TEMPLEDGERFINAL
/*				CREATE TABLE ERROR_TBL
					(
						ERR_ID INT
					)*/
				IF @FLAG = 'CODEWISE'
					BEGIN
						SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'DEL " + @FNAME + "', no_output"
						EXEC (@@SQL)
						SELECT @@SQL = "INSERT INTO ERROR_TBL EXEC MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + "SELECT * FROM ACCOUNT.DBO.TEMP_TRIALBALANCE_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " ORDER BY CLTCODE, ACNAME, BRANCHCODE" + CHAR(34) + " queryout " + CHAR(34) + @FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -U " + CHAR(34) + "SA" + CHAR(34) + " -P " + CHAR(34) + "M0" + CHAR(34) + "', no_output "
					END
				ELSE
					BEGIN
						SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'DEL " + @FNAME + "', no_output"
						EXEC (@@SQL)
						SELECT @@SQL = "INSERT INTO ERROR_TBL EXEC MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + "SELECT * FROM ACCOUNT.DBO.TEMP_TRIALBALANCE_BULK WHERE PROCID = "  + CONVERT(VARCHAR, @@SPID) + " ORDER BY CLTCODE, ACNAME, BRANCHCODE" + CHAR(34) + " queryout " + CHAR(34) + @FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -U " + CHAR(34) + "SA" + CHAR(34) + " -P " + CHAR(34) + "M0" + CHAR(34) + "', no_output "
					END
				SELECT @@SQL
				RETURN
				EXEC (@@SQL)
/*				IF @@ERRORCNT <> 0
					BEGIN
						SELECT 'SOME ERROR OCCURED WHILE EXPORTING FILE'
					END*/
			END
		ELSE
			BEGIN
				SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE  
			END
	END
ELSE	
	BEGIN
		SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE  
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE_1
-- --------------------------------------------------
--Exec rpt_Acc_TrialBalance 'Mar 31 2007', 'codewise','partywise','withopbal','Apr  1 2006', 'Apr  1 2006', 0,'Apr  1 2006', 'BROKER', '%', 'vdt'

CREATE PROCEDURE RPT_ACC_TRIALBALANCE_1
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */      
      
AS      
  
DECLARE    
@@COSTCODE AS VARCHAR(3)  
  
      
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2      
    
    
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN  
  IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
         GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
         GROUP BY L.CLTCODE  
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'      
         AND EDT < @CURRYRSTDATE        
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
	IF @STDATE = @CURRYRSTDATE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = 18) THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
	ELSE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
       END      
      ELSE      
       BEGIN      
	IF @STDATE = @CURRYRSTDATE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = 18) THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
	ELSE
	BEGIN
	        INSERT INTO #TEMPLEDGER      
	        SELECT L.CLTCODE ,      
	        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
	        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
	        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
	        GROUP BY L.CLTCODE      
	END
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
   
  
/*  -- FOR BRANCH SELECTION --  */    
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN  
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )    
 IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
   AND COSTCODE = @@COSTCODE  
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
     GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE  
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'  
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
       END      
     ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
/* ---------------------------- */    
  
  
IF @FLAG = 'CODEWISE'      
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE    
 END    
ELSE    
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE_ALL
-- --------------------------------------------------


--RPT_ACC_TRIALBALANCE_ALL 'MAR 31 2006', 'CODEWISE','PARTYWISE','NORMAL','APR  1 2005', 'APR  1 2005', 1,'APR  1 2005', 'BROKER', '%', 'VDT', 'Y', '' 

CREATE PROCEDURE RPT_ACC_TRIALBALANCE_ALL  
 @VDT VARCHAR(11),    					/* AS ON DATE ENTERED BY USER */  
 @FLAG VARCHAR(15),    					/* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
 @VIEWOPTION VARCHAR(10),  				/* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
 @BALANCE VARCHAR(10),   				/* NORMAL OR WITHOPBAL */  
 @STDATE VARCHAR(11),   				/* START DATE ENTERED BY USER */  
 @CURRYRSTDATE VARCHAR(11),  			/* START DATE OF FINANCIAL YEAR */  
 @OPENENTRYFLAG INT,  
 @OPENINGENTRYDATE VARCHAR(11), 		/* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
 @STATUSID VARCHAR(20),   				/* AS BROKER/BRANCH/CLIENT ETC. */  
 @STATUSNAME VARCHAR(20),  				/* IN CASE OF BRANCH LOGIN BRANCHCODE */  
 @SORTBYDATE VARCHAR(3),   				/* WHETHER REPORT IS BASED ON VDT OR EDT */  
 @SHOWZEROBAL VARCHAR(1),  				/* SHOW ZERO BAL   */  
 @SHOWMARGIN VARCHAR(1)   				/* SHOW MARGIN LEDGER   */  
AS  


  
CREATE TABLE [DBO].[#TMPTRIALBALANCE]  
 (  
 [CLTCODE] [VARCHAR] (10) ,  
 [ACNAME] [VARCHAR] (100) NULL ,  
 [BRANCHCODE] [VARCHAR] (10) NULL,  
 [AMOUNT] [MONEY] NULL ,  
 [SEGMENT] [VARCHAR] (5) NULL,  
 [ENTITY] [VARCHAR] (50) NULL  
 ) ON [PRIMARY]  
  

DECLARE  
 @@ACCOUNTDB VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@SQL VARCHAR(1000),  
 @@SEGORD TINYINT,  
 @@MAINREC AS CURSOR  
  
             
BEGIN  
  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNT.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNT.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='1NSE',ENTITY='CAPITAL - NSE' WHERE SEGMENT IS NULL  
	  
	  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNTBSE.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNTBSE.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='2BSE',ENTITY='CAPITAL - BSE' WHERE SEGMENT IS NULL  
	  
	----------------------------------------------COMMENTED SPECIFICALLY FOR VERSION---------------------------------------  
	--NSEFO START  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNTFO.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNTFO.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='3NFO',ENTITY='DERIVATIVES - NSE' WHERE SEGMENT IS NULL  
	  
	-- NSEFO END  
	--MARGIN TRIAL BALANCE  
	/*-------------------------------------------------------------------------------------------------------------------------*/  
	--BSEFO START  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNTBFO.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNTBFO.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='3BFO',ENTITY='DERIVATIVES - BSE' WHERE SEGMENT IS NULL  
	  
	--BSEFO END  
	
	  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNT.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNT.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='4NSE',ENTITY='MARGIN CAPITAL - NSE' WHERE SEGMENT IS NULL  
	  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNTBSE.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNTBSE.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='5BSE',ENTITY='MARGIN CAPITAL - BSE' WHERE SEGMENT IS NULL  
	  
	----------------------------------------------COMMENTED SPECIFICALLY FOR VERSION---------------------------------------  
	--NSEFO START  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNTFO.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNTFO.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='6NFO',ENTITY='MARGIN DERIVATIVES - NSE' WHERE SEGMENT IS NULL  
	--NSEFO END  
	  
	--BSEFO START  
	INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)  
	EXEC ACCOUNTBFO.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	  
	IF @VIEWOPTION='GL'  
	 BEGIN  
	  INSERT INTO #TMPTRIALBALANCE(AMOUNT)  
	  EXEC ACCOUNTBFO.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE  
	 END  
	  
	UPDATE #TMPTRIALBALANCE SET SEGMENT='6BFO',ENTITY='MARGIN DERIVATIVES - BSE' WHERE SEGMENT IS NULL  
	--NSEFO END  

	
IF @VIEWOPTION='GL'  
 BEGIN  
  UPDATE #TMPTRIALBALANCE SET ACNAME='CLIENT BALANCES',CLTCODE=' ',BRANCHCODE=' ' WHERE CLTCODE IS NULL  
 END  
  
/* ADDED BY UPPILIK */  
  
UPDATE #TMPTRIALBALANCE  
SET AMOUNT = ISNULL(AMOUNT,0)  
  
  
DELETE FROM #TMPTRIALBALANCE  
WHERE ISNULL(CLTCODE,'') = '' AND ISNULL(ACNAME,'') = ''  
  
IF @STATUSID = 'CLIENT'  
BEGIN  
 DELETE FROM #TMPTRIALBALANCE  
 WHERE CLTCODE <> @STATUSNAME  
END  
  
  
/* ADDED BY UPPILIK */  
  
IF @FLAG = 'CODEWISE'  
 BEGIN  
  
  
  IF @SHOWZEROBAL='Y'  
   BEGIN  
  
    SELECT CLTCODE,ACNAME,BRANCHCODE,  
    SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,  
    SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,  
    SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,  
    SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,  
    SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,  
    SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML,  
    SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFO,  
    SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFOML
    FROM #TMPTRIALBALANCE  
    GROUP BY CLTCODE,ACNAME,BRANCHCODE  
    ORDER BY CLTCODE  
   END  
  ELSE  
   BEGIN  
    IF @SHOWMARGIN='Y'  
     BEGIN  
  
      SELECT CLTCODE,ACNAME,BRANCHCODE,  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,  
      SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,  
      SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,  
      SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML,  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFO,  
      SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFOML
      FROM #TMPTRIALBALANCE  
      GROUP BY CLTCODE,ACNAME,BRANCHCODE  
      HAVING  (  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END)<>0  )  
      ORDER BY CLTCODE  
     END  
    ELSE  
     BEGIN  
  
      SELECT CLTCODE,ACNAME,BRANCHCODE,  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,  
      SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,  
      SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,  
      SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML,  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFO,  
      SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFOML
      FROM #TMPTRIALBALANCE  
      GROUP BY CLTCODE,ACNAME,BRANCHCODE  
      HAVING    (  
	  SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END)<>0  )  
      ORDER BY CLTCODE  
     END  
   END  
 END  
ELSE  
BEGIN  
  IF @SHOWZEROBAL='Y'  
   BEGIN  
    SELECT CLTCODE,ACNAME,BRANCHCODE,  
    SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,  
    SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,  
    SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,  
    SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,  
    SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,  
    SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML,  
    SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFO,  
    SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFOML
    FROM #TMPTRIALBALANCE  
    GROUP BY CLTCODE,ACNAME,BRANCHCODE  
    ORDER BY ACNAME  
   END  
  ELSE  
   BEGIN  
    IF @SHOWMARGIN='Y'  
     BEGIN  
      SELECT CLTCODE,ACNAME,BRANCHCODE,  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,  
      SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,  
      SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,  
      SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML,  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFO,  
      SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END) AS NETBSEFOML
      FROM #TMPTRIALBALANCE  
      GROUP BY CLTCODE,ACNAME,BRANCHCODE  
      HAVING    (  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='6BFO' THEN AMOUNT ELSE 0 END)<>0 )  
      ORDER BY ACNAME  
     END  
    ELSE  
     BEGIN  
      SELECT CLTCODE,ACNAME,BRANCHCODE,  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,  
      SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,  
      SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,  
      SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML
      FROM #TMPTRIALBALANCE  
      GROUP BY CLTCODE,ACNAME,BRANCHCODE  
      HAVING    (  
      SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 OR  
      SUM(CASE WHEN SEGMENT='3BFO' THEN AMOUNT ELSE 0 END)<>0  ) 
      ORDER BY ACNAME  
     END  
   END  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE_ALL_NEW
-- --------------------------------------------------

------------------------------------
--CREATED BY BHARAT FOR ALL SEGMENT
--DATED ON: 01 OCT 2008  
------------------------------------
--RPT_ACC_TRIALBALANCE_ALL_NEW 'Mar 31 2006', 'codewise','GL','normal','Apr 1 2005', 'Apr 1 2005', 1,'Apr 1 2005', 'BROKER', '%', 'vdt', 'Y', ''
--rpt_acc_trialbalance_All_New 'Mar 31 2006', 'codewise','partywise','normal','Apr  1 2005', 'Apr  1 2005',  1,'Apr  1 2005', 'BROKER', '%', 'vdt', 'Y', 'Y' 

CREATE PROCEDURE [dbo].[RPT_ACC_TRIALBALANCE_ALL_NEW]
 @VDT VARCHAR(11),    					/* AS ON DATE ENTERED BY USER */
 @FLAG VARCHAR(15),    					/* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */
 @VIEWOPTION VARCHAR(10),  				/* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
 @BALANCE VARCHAR(10),   				/* NORMAL OR WITHOPBAL */
 @STDATE VARCHAR(11),   				/* START DATE ENTERED BY USER */
 @CURRYRSTDATE VARCHAR(11),  			/* START DATE OF FINANCIAL YEAR */
 @OPENENTRYFLAG INT,
 @OPENINGENTRYDATE VARCHAR(11), 		/* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */
 @STATUSID VARCHAR(20),   				/* AS BROKER/BRANCH/CLIENT ETC. */
 @STATUSNAME VARCHAR(20),  				/* IN CASE OF BRANCH LOGIN BRANCHCODE */
 @SORTBYDATE VARCHAR(3),   				/* WHETHER REPORT IS BASED ON VDT OR EDT */
 @SHOWZEROBAL VARCHAR(1),  				/* SHOW ZERO BAL   */
 @SHOWMARGIN VARCHAR(1)   				/* SHOW MARGIN LEDGER   */
AS

DECLARE @CHKFLAG INT
   
CREATE TABLE [DBO].[#TMPTRIALBALANCE]
 (
 [CLTCODE] [VARCHAR] (10) ,
 [ACNAME] [VARCHAR] (100) NULL ,
 [BRANCHCODE] [VARCHAR] (10) NULL,
 [AMOUNT] [MONEY] NULL ,
 [SEGMENT] [VARCHAR] (5) NULL,
 [ENTITY] [VARCHAR] (50) NULL,
 [ACCAT][CHAR](3)
 ) ON [PRIMARY]
/*
********** CREATE DYNAMICALLY SP BY BHARAT ****************************
********** ON OCT 10 2008 *********************************************
********** FOR ALL SEGMENT BASED ON MULTICOMPANY TBL OF PRADNYA DB ****
*/
SET NOCOUNT ON

DECLARE
 @@ACCOUNTDB VARCHAR(20),
 @@EXCHANGE VARCHAR(15),
 @@SEGMENT VARCHAR(15),
 @@ORDERFLAG VARCHAR(1),
 @@SQL VARCHAR(3000),
 @@SEGORD TINYINT,
 @@MAINREC AS CURSOR,

 @@NSE VARCHAR(1), 
 @@BSE VARCHAR(1), 
 @@NFO VARCHAR(1), 
 @@BFO VARCHAR(1), 
 @@NSX VARCHAR(1), 
 @@BSX VARCHAR(1) 

 SET @@NSE = '0' 
 SET @@BSE = '0' 
 SET @@NFO = '0' 
 SET @@BFO = '0' 
 SET @@NSX = '0' 
 SET @@BSX = '0' 




SET @@MAINREC = CURSOR FOR

SELECT ACCOUNTDB, EXCHANGE, SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE PRIMARYSERVER = 1 ORDER BY EXCHANGE

SET @@SEGORD = 1

OPEN @@MAINREC
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT
WHILE @@FETCH_STATUS = 0
BEGIN

 IF @@ACCOUNTDB = 'ACCOUNT' OR @@ACCOUNTDB = 'ACCOUNTBSE' OR @@ACCOUNTDB = 'ACCOUNTFO'  OR @@ACCOUNTDB = 'ACCOUNTBFO' OR @@ACCOUNTDB = 'ACCOUNTCURFO' OR @@ACCOUNTDB = 'ACCOUNTCURBFO'
 BEGIN
	SET @@SQL = " INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT,ACCAT) "
	SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.NEWASP_TRIALBALANCE '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"
	SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE + "','" + @SHOWZEROBAL + "' "

	IF @VIEWOPTION='GL'
	 BEGIN
	  SET @@SQL = @@SQL + " INSERT INTO #TMPTRIALBALANCE(AMOUNT)"
	  SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.NEWASP_TRIALBALANCEPARTYTOTAL '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"
 	  SET @@SQL = @@SQL +  @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE + "' "
	 END

	SET @@SQL = @@SQL + " UPDATE #TMPTRIALBALANCE SET SEGMENT='" + @@EXCHANGE + "', ENTITY='" + @@EXCHANGE + " - " + @@SEGMENT +"' WHERE SEGMENT IS NULL "

	PRINT @@SQL
	EXEC (@@SQL)

	--For Margin Ledger
	IF @SHOWMARGIN = 'Y'
	 BEGIN
 	 SET @@SQL = " INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)"
	 SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.NEWASP_MARGINTRIALBALANCE '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"
     SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE +"','" + @SHOWZEROBAL + "' "
    

	IF @VIEWOPTION='GL'
	 BEGIN
	  SET @@SQL = @@SQL + " INSERT INTO #TMPTRIALBALANCE(AMOUNT)"
	  SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"
      SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','" + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE +"' "
	 END

	SET @@SQL = @@SQL + " UPDATE #TMPTRIALBALANCE SET SEGMENT='" + @@EXCHANGE + "', ENTITY= 'MARGIN " + @@EXCHANGE + " - " + @@SEGMENT +"' WHERE SEGMENT IS NULL "

	PRINT @@SQL
	EXEC (@@SQL)
   END	
	IF @@ACCOUNTDB = 'ACCOUNT'
 	 SET @@NSE = '1'
    
	IF @@ACCOUNTDB = 'ACCOUNTBSE'
 	 SET @@BSE = '1'

	IF @@ACCOUNTDB = 'ACCOUNTFO'
 	 SET @@NFO = '1'	
	
	IF @@ACCOUNTDB = 'ACCOUNTBFO'
 	 SET @@BFO = '1'

	IF @@ACCOUNTDB = 'ACCOUNTCURFO'
 	 SET @@NSX = '1'

	IF @@ACCOUNTDB = 'ACCOUNTCURBFO'
 	 SET @@BSX = '1'

 SET @@SEGORD = @@SEGORD + 1
 END

 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT
END


IF @VIEWOPTION='GL'
 BEGIN
  UPDATE #TMPTRIALBALANCE SET ACNAME='CLIENT BALANCES',CLTCODE=' ',BRANCHCODE=' ' WHERE CLTCODE IS NULL
 END

UPDATE #TMPTRIALBALANCE
SET AMOUNT = ISNULL(AMOUNT,0)

DELETE FROM #TMPTRIALBALANCE
WHERE ISNULL(CLTCODE,'') = '' AND ISNULL(ACNAME,'') = ''

IF @STATUSID = 'CLIENT'
BEGIN
 DELETE FROM #TMPTRIALBALANCE
 WHERE CLTCODE <> @STATUSNAME
END
--SELECT * FROM #TMPTRIALBALANCE

IF UPPER(@FLAG) = 'CODEWISE'
 BEGIN
	IF @SHOWMARGIN='Y'
		BEGIN
				SET @@SQL = " SELECT CLTCODE,ACNAME,BRANCHCODE, "
			IF @@NSE = '1'
			BEGIN
				 SET @@SQL = @@SQL + " NETNSECM 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETNSECMML 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			END
			IF @@BSE = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETBSECM 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETBSECMML 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			END 
			IF @@NFO = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETNSEFO 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETNSEFOML 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			END 
			IF @@BFO = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETBSEFO 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETBSEFOML 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			END
			IF @@NSX = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETNSX 		= SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETNSXML 	= SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'MARGIN NSX - FUTURES' THEN AMOUNT ELSE 0 END) "
			END
			IF @@BSX = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETBSX 		= SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETBSXML 	= SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'MARGIN BSX - FUTURES' THEN AMOUNT ELSE 0 END) "
			END
				SET @@SQL = @@SQL + " ,ACCAT FROM #TMPTRIALBALANCE "
				SET @@SQL = @@SQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE,ACCAT "
				SET @@SQL = @@SQL + " ORDER BY CLTCODE "
				SET @@SQL = @@SQL + " COMPUTE "

			SET @CHKFLAG = 0
			IF @@NSE = '1'
			BEGIN
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@BSE = '1'
			BEGIN
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@NFO = '1'
			BEGIN
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@BFO = '1'
			BEGIN
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@NSX = '1'
			BEGIN
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'MARGIN NSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@BSX = '1'
			BEGIN
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'MARGIN BSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END
		END
	ELSE
		BEGIN
			SET @@SQL = " SELECT CLTCODE,ACNAME,BRANCHCODE, "
			IF @@NSE = '1'
				SET @@SQL = @@SQL + " NETNSECM 	= ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END),0), "
			IF @@BSE = '1'
				SET @@SQL = @@SQL + " NETBSECM 	= ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END),0), "
			IF @@NFO = '1'
				SET @@SQL = @@SQL + " NETNSEFO 	= ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END),0), " 
			IF @@BFO = '1'
				SET @@SQL = @@SQL + " NETBSEFO 	= ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END),0), "
			IF @@NSX = '1'		
				SET @@SQL = @@SQL + " NETNSX 	= ISNULL(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END),0), "
			IF @@BSX = '1'
				SET @@SQL = @@SQL + " NETBSX 	= ISNULL(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END),0), "
				
			SET @@SQL = @@SQL + " NETTOTAL 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 				+ SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " ,ACCAT FROM #TMPTRIALBALANCE " 
			SET @@SQL = @@SQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE,ACCAT "
			SET @@SQL = @@SQL + " ORDER BY CLTCODE "
			SET @@SQL = @@SQL + " COMPUTE "
	
			SET @CHKFLAG = 0 
			IF @@NSE = '1'
			BEGIN
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END),0)) "
			END

			IF @@BSE = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END),0)) "
			END 
			IF @@NFO = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END),0)) "
			END
			IF @@BFO = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END),0)) "
			END
			IF @@NSX = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END),0))  "
			END
			IF @@BSX = '1'	
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END),0)) "
			END
	 	END
 END
ELSE
BEGIN
		IF @SHOWMARGIN='Y'
		BEGIN
				SET @@SQL = " SELECT CLTCODE,ACNAME,BRANCHCODE, "
			IF @@NSE = '1'
			BEGIN
				 SET @@SQL = @@SQL + " NETNSECM 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETNSECMML 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			END
			IF @@BSE = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETBSECM 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETBSECMML 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			END 
			IF @@NFO = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETNSEFO 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETNSEFOML 	= SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			END 
			IF @@BFO = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETBSEFO 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETBSEFOML 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			END
			IF @@NSX = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETNSX 		= SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETNSXML 	= SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'MARGIN NSX - FUTURES' THEN AMOUNT ELSE 0 END) "
				END
			IF @@BSX = '1'
			BEGIN
				 SET @@SQL = @@SQL + " ,NETBSX 		= SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END) "
				 SET @@SQL = @@SQL + " ,NETBSXML 	= SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'MARGIN BSX - FUTURES' THEN AMOUNT ELSE 0 END) "
			END
				SET @@SQL = @@SQL + " ,ACCAT FROM #TMPTRIALBALANCE "
				SET @@SQL = @@SQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE,ACCAT "
				SET @@SQL = @@SQL + " ORDER BY ACNAME "
				SET @@SQL = @@SQL + " COMPUTE "

			SET @CHKFLAG = 0
			IF @@NSE = '1'
			BEGIN
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - CAPITAL' THEN AMOUNT ELSE 0 END))"
			END

			IF @@BSE = '1'
			BEGIN
				IF @CHKFLAG > 0
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - CAPITAL' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@NFO = '1'
			BEGIN
				IF @CHKFLAG > 0
					SET @@SQL = @@SQL + ", "
				
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'MARGIN NSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@BFO = '1'
			BEGIN
				IF @CHKFLAG > 0
					SET @@SQL = @@SQL + ", "
				
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'MARGIN BSE - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@NSX = '1'
			BEGIN
				IF @CHKFLAG > 0
					SET @@SQL = @@SQL + ", "
				
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'MARGIN NSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END

			IF @@BSX = '1'
			BEGIN
				IF @CHKFLAG > 0
					SET @@SQL = @@SQL + ", "
				
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
				SET @@SQL = @@SQL + " ,SUM(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'MARGIN BSX - FUTURES' THEN AMOUNT ELSE 0 END)) "
			END
		END
	ELSE
		BEGIN
			SET @@SQL = " SELECT CLTCODE,ACNAME,BRANCHCODE, "
		IF @@NSE = '1'
		    SET @@SQL = @@SQL + " NETNSECM 	= ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END), 0), "
		IF @@BSE = '1'
		    SET @@SQL = @@SQL + " NETBSECM 	= ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END), 0), "
		IF @@NFO = '1'
		    SET @@SQL = @@SQL + " NETNSEFO 	= ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END), 0), " 
		IF @@BFO = '1'
		    SET @@SQL = @@SQL + " NETBSEFO 	= ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END), 0), "
		IF @@NSX = '1'		
			SET @@SQL = @@SQL + " NETNSX 	= ISNULL(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END), 0), "
		IF @@BSX = '1'
		    SET @@SQL = @@SQL + " NETBSX 	= ISNULL(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END), 0), "
		ELSE
			SET @@SQL = @@SQL + " NETTOTAL 	= SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 			    + SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END) "
			SET @@SQL = @@SQL + " 				+ SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END) "
		    SET @@SQL = @@SQL + " ,ACCAT FROM #TMPTRIALBALANCE " 
		    SET @@SQL = @@SQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE,ACCAT "
			SET @@SQL = @@SQL + " ORDER BY ACNAME "
			SET @@SQL = @@SQL + " COMPUTE "
			
			SET @CHKFLAG = 0 
			IF @@NSE = '1'
			BEGIN
				SET @CHKFLAG = 1
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - CAPITAL' THEN AMOUNT ELSE 0 END),0)) "
			END

			IF @@BSE = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - CAPITAL' THEN AMOUNT ELSE 0 END),0)) "
			END 
			IF @@NFO = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='NSE' AND ENTITY = 'NSE - FUTURES' THEN AMOUNT ELSE 0 END),0)) "
			END
			IF @@BFO = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='BSE' AND ENTITY = 'BSE - FUTURES' THEN AMOUNT ELSE 0 END),0)) "
			END
			IF @@NSX = '1'
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='NSX' AND ENTITY = 'NSX - FUTURES' THEN AMOUNT ELSE 0 END),0))  "
			END
			IF @@BSX = '1'	
			BEGIN 
				IF @CHKFLAG > 0 
					SET @@SQL = @@SQL + ", "

				SET @CHKFLAG = 1	
				SET @@SQL = @@SQL + " SUM(ISNULL(SUM(CASE WHEN SEGMENT='BSX' AND ENTITY = 'BSX - FUTURES' THEN AMOUNT ELSE 0 END),0)) "
			END
	END
END
	PRINT @@SQL
	EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------
CREATE PROCEDURE RPT_ACCALLPARTYLEDVOUCHERDISP          
 @VTYP SMALLINT ,          
 @VNO VARCHAR (12),          
 @VDT VARCHAR(12) ,          
 @BOOKTYPE VARCHAR(2),          
 @BRANCH VARCHAR(10),          
 @CLTCODE VARCHAR(10)          
          
AS      
    
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'          
BEGIN          
	SELECT  
		VAMT, L.VTYP, L.VNO, L.VDT, L.DRCR, CLTCODE, ACNAME,  L.LNO, 
		DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,           
		NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,           
		DDDT  =  CONVERT(VARCHAR, DDDT, 103)            
	FROM 
		LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO       
		AND L.LNO = L1.LNO          
	WHERE 
		L.VTYP = @VTYP          
		AND L.VNO = @VNO            
		AND L.VDT LIKE  LTRIM(VDT) + '%'          
		AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE          
	ORDER BY 
		L.DRCR DESC , L.LNO           
END          
ELSE          
BEGIN          
	 SELECT  
		VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,           
		DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),           
		NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,           
		DDDT  =  CONVERT(VARCHAR, DDDT, 103)            
	 FROM 
		LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO       
		AND L.LNO = L1.LNO,          
		LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE          
	 WHERE 
		L.VTYP = @VTYP          
		AND L.VNO = @VNO            
		AND L.VDT LIKE  LTRIM(VDT) + '%'          
		AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE          
		AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO          
		AND COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))          
	 ORDER BY 
		L2.DRCR DESC , L2.LNO           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accallpartyMarginledvoucherdisp
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_accallpartyMarginledvoucherdisp    Script Date: 12/27/2005 12:19:25 PM ******/

/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 04/15/2004 11:47:30 AM ******/  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 06/11/2004 14:22:56 ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 12/16/2003 12:59:37 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 02/28/2003 2:39:05 PM ******/  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 01/19/2002 12:15:11 ******/  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 01/04/1980 5:06:24 AM ******/  
/* report : Allpartyledger   
    filename :  voucherdisp.asp  
*/  
/* displays details of a voucher for a party for a date */  
    
CREATE  Procedure rpt_accallpartyMarginledvoucherdisp  
@vtyp smallint ,  
@vno varchar (12),  
@vdt varchar(12) ,  
@booktype varchar(2),  
@branch varchar(10),  
@cltcode varchar(10)  
  
as  
if @branch = 'full' or @branch= '' or @branch = '%'  
begin  
	select vamt=amount ,l.vtyp , l.vno , l.vdt , l.drcr , cltcode=party_code,a.acname,  l.lno ,drcrflag = (case when upper(l.drcr)='D' then 'Dr' else 'Cr' end) ,   
	nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,   
	dddt  =  convert(varchar,dddt,103)
	from marginledger m,ledger l ,ledger1 l1, acmast a
	where 
	l1.vtyp = m.vtyp and l1.booktype = m.booktype and l1.vno = m.vno and m.lno = l1.lno
	and l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno
	and m.mcltcode=a.cltcode 
	and l.vtyp=@vtyp  
	and l.vno= @vno    
	and l.vdt like  ltrim(m.vdt) + '%'  
	and l.BookType = @booktype and m.party_code = @cltcode  
	order by l.drcr desc , l.lno 
end  
else  
begin  
/*
 select  vamt=l2.camt ,l.vtyp , l2.vno , vdt , l2.drcr , l2.cltcode, a.acname, l2.lno ,   
 drcrflag = (case when upper(l2.drcr)='D' then 'Dr' else 'Cr' end),   
 nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,   
 dddt  =  convert(varchar,dddt,103)    
 from account.dbo.ledger l left outer join account.dbo.ledger1 l1 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno,  
 account.dbo.ledger2 l2 left outer join account.dbo.acmast a on l2.cltcode = a.cltcode  
 where l.vtyp=@vtyp  
 and l.vno= @vno    
 and l.vdt like  ltrim(vdt) + '%'  
 and l.BookType = @booktype and l.cltcode = @cltcode  
 and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  
 and costcode = (select costcode from account.dbo.costmast where costname = rtrim(@branch))  
 order by l2.drcr desc , l2.lno   
*/

select  vamt=m.amount ,l.vtyp , l2.vno , m.vdt , l2.drcr , cltcode=m.party_code, a.acname, l2.lno ,   
drcrflag = (case when upper(l2.drcr)='D' then 'Dr' else 'Cr' end),   
nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,   
dddt  =  convert(varchar,dddt,103)    
from marginledger m,ledger l ,ledger1 l1,   
ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode  
where m.mcltcode=a.cltcode
and m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and l.lno = m.lno
and l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno
and l.vno= @vno    
and l.vdt like  ltrim(m.vdt) + '%'  
and l.BookType = @booktype
and m.party_code = @cltcode 
and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  
and costcode = (select costcode from costmast where costname = rtrim(@branch))  
order by l2.drcr desc , l2.lno   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accchkpathsegbalsign
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 05/10/2004 5:11:16 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 01/11/2003 3:46:55 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 11/28/2001 12:23:46 PM ******/  
  
create procedure rpt_accchkpathsegbalsign  
@sharedb varchar(15)  
as  
select conpath ,segment ,balsign from account.dbo.owner   
where sharedb = @sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acccompanyname
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 06/24/2004 8:32:37 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 05/10/2004 5:29:41 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 01/14/2002 20:39:18 ******/  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_acccompanyname    Script Date: 11/28/2001 12:23:46 PM ******/  
  
CREATE proc rpt_acccompanyname  
@sharedb varchar(15)  
as  
select companyname from multicompany where sharedb = @sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_AccodeList
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_AccodeList    Script Date: 12/16/2003 12:59:37 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 04/13/2003 12:09:05 PM ******/  
---------------------------------------------------------------------------------------------------------  
--  PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT  
---------------------------------------------------------------------------------------------------------  
  
CREATE PROCEDURE rpt_AccodeList  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH  
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.  
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.  
 @ACCAT varchar(3),  -- Account Category  
 @LOOKFORNAME VARCHAR(25) -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH  
AS  
  
DECLARE  
@strSQL VarChar(2500),  
@@Inaccat varchar(3)  
  
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))  
  
--SET DEFAULT VALUES  
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"  
/* SET @BOOKTYPE = @BOOKTYPE + "%" */  
  
--BROKER LOGIN  
If  @STATUSID="BROKER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT cltcode, acname, branchcode "  
 Set @strSQL = @strSQL + "FROM acmast "  
 Set @strSQL = @strSQL + "WHERE "  
        if len(rtrim(@WHATTOLOOKFOR)) <> 0 and len(rtrim(@LOOKFORNAME)) <> 0   
           begin  
    Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' and acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' "   
    end  
        else  
           if len(rtrim(@LOOKFORNAME)) <> 0   
               begin  
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' "   
               end  
           else  
               begin  
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @WHATTOLOOKFOR + "') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' "   
               end  
        if rtrim(@accat) = '3'  
           begin  
  select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))"   
           end  
        else  
           begin  
  select @strSQL = @strSQL + " )"   
           end  
  
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.  
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS   
 If @WHICHWAY = ">"  
 Begin  
  Set @strSQL = @strSQL + " AND "  
  Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "  
 End  
 Else  
 Begin  
  If @WHICHWAY = "<"  
  Begin  
   Set @strSQL = @strSQL + " AND "  
   Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
  End  
 End  
  
 Set @strSQL = @strSQL + "ORDER BY cltcode, branchcode "  
End  
  
--BRANCH LOGIN  
IF @STATUSID="BRANCH"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " acname, "  
 Set @strSQL = @strSQL + " branchcode "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " (branchcode LIKE '" + @STATUSNAME + "' OR branchcode = 'ALL') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' "   
        if rtrim(@accat) = '3'  
           begin  
  select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))"   
           end  
        else  
           begin  
  select @strSQL = @strSQL + " )"   
           end  
  
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.  
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS  
 If @WHICHWAY = ">"  
 Begin  
  Set @strSQL = @strSQL + " AND "  
  Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "  
 End  
 Else  
 Begin  
  If @WHICHWAY = "<"  
  Begin  
   Set @strSQL = @strSQL + " AND "  
   Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
  End  
 End  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " branchcode "  
End  
  
--SUB-BROKER LOGIN  
IF @STATUSID="SUBBROKER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.sub_broker "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " msajag.dbo.client1 c1, "  
 Set @strSQL = @strSQL + " msajag.dbo.client2 c2, "  
 Set @strSQL = @strSQL + " msajag.dbo.subbrokers s "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.sub_broker = s.sub_broker AND "  
 Set @strSQL = @strSQL + " c1.sub_broker LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @WHATTOLOOKFOR + "' "  
  
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.  
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS  
 If @WHICHWAY = ">"  
 Begin  
  Set @strSQL = @strSQL + " AND "  
  Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "  
 End  
 Else  
 Begin  
  If @WHICHWAY = "<"  
  Begin  
   Set @strSQL = @strSQL + " AND "  
   Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
  End  
 End  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.sub_broker "  
End  

--AREA LOGIN  
IF @STATUSID="AREA"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.area "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " msajag.dbo.client1 c1, "  
 Set @strSQL = @strSQL + " msajag.dbo.client2 c2, "  
 Set @strSQL = @strSQL + " msajag.dbo.area s "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.area = s.areacode AND "  
 Set @strSQL = @strSQL + " c1.area LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @WHATTOLOOKFOR + "' "  
  
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.  
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS  
 If @WHICHWAY = ">"  
 Begin  
  Set @strSQL = @strSQL + " AND "  
  Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "  
 End  
 Else  
 Begin  
  If @WHICHWAY = "<"  
  Begin  
   Set @strSQL = @strSQL + " AND "  
   Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
  End  
 End  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.area "  
End  
  
--TRADER LOGIN  
If @STATUSID="TRADER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.trader "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " msajag.dbo.client1 c1, "  
 Set @strSQL = @strSQL + " msajag.dbo.client2 c2, "  
 Set @strSQL = @strSQL + " msajag.dbo.branches s "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 /*Set @strSQL = @strSQL + " c1.trader = s.branch_cd AND "*/  
             Set @strSQL = @strSQL + " c1.Branch_cd = s.branch_cd AND "  
 Set @strSQL = @strSQL + " c1.trader LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @WHATTOLOOKFOR + "' "  
  
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.  
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS  
 If @WHICHWAY = ">"  
 Begin  
  Set @strSQL = @strSQL + " AND "  
  Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "  
 End  
 Else  
 Begin  
  If @WHICHWAY = "<"  
  Begin  
   Set @strSQL = @strSQL + " AND "  
   Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
  End  
 End  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.trader "  
End  
  
--FAMILY LOGIN  
If @STATUSID="FAMILY"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.family "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " msajag.dbo.client1 c1, "  
 Set @strSQL = @strSQL + " msajag.dbo.client2 c2 "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.family LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @WHATTOLOOKFOR + "' "  
  
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.  
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS  
 If @WHICHWAY = ">"  
 Begin  
  Set @strSQL = @strSQL + " AND "  
  Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "  
 End  
 Else  
 Begin  
  If @WHICHWAY = "<"  
  Begin  
   Set @strSQL = @strSQL + " AND "  
   Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
  End  
 End  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.family "  
End  
  
If @STATUSID="CLIENT"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " msajag.dbo.client1 c1, "  
 Set @strSQL = @strSQL + " msajag.dbo.client2 c2 "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @STATUSNAME + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode "  
End  
  
 Set @strSQL = @strSQL + " OPTION  (FAST 10)"  
  
Print @strSQL  
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accownercompanyname
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_accownercompanyname    Script Date: 06/24/2004 8:32:37 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accownercompanyname    Script Date: 05/10/2004 5:29:41 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_accownercompanyname    Script Date: 01/14/2002 20:39:18 ******/  
  
/****** Object:  Stored Procedure dbo.rpt_accownercompanyname    Script Date: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_accownercompanyname    Script Date: 11/28/2001 12:23:46 PM ******/  
  
CREATE proc rpt_accownercompanyname  
@sharedb varchar(15)  
as  
select companyname from accountbse.dbo.owner where sharedb = @sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accvdesc
-- --------------------------------------------------
/*this Procedure Gives Us The Discription For Supplied Vtype*/
Create Procedure 
Rpt_accvdesc 
@Vtype Smallint
As
Select Vdesc From Account.Dbo.Vmast Where 
Vtype = @Vtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ALL_PARTY_SUMMARY_MASTER
-- --------------------------------------------------




CREATE PROC RPT_ALL_PARTY_SUMMARY_MASTER
/*
EXEC RPT_ALL_PARTY_SUMMARY_MASTER 'APR  1 2006', 'MAR 31 2007', 'APR  1 2006', 'MAR 31 2007', 'BROKER', 'BROKER', 'VDT', '0', 'ZZZ', 'PARTY', 'S', 
'Y', 'ACCOUNT', 'Y', 'ACCOUNTBSE', 'Y', 'ACCOUNTFO', 'Y', 'ACCOUNTNCDX', 'Y', 'ACCOUNTMCDX'

Exec RPT_ALL_PARTY_SUMMARY_MASTER 'Apr 1 2006','May 16 2006','Apr 1 2003','Apr 1 2003','broker','broker','Vdt','0','z','PARTY','S','Y', 'ACCOUNT', 'Y', 'ACCOUNTBSE', 'Y', 'ACCOUNTFO', 'Y', 'ACCOUNTNCDX', 'Y', 'ACCOUNTMCDX' 
*/
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(50),
	@DISPRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@RPTNAME VARCHAR(20),
	@SUMOPT VARCHAR(1),
	@NSE VARCHAR(1),
	@NSEDATA VARCHAR(30),
	@BSE VARCHAR(1),
	@BSEDATA VARCHAR(30),
	@NSEFO VARCHAR(1),
	@NSEFODATA VARCHAR(30),
	@NCX VARCHAR(1),
	@NCXDATA VARCHAR(30),
	@MCX VARCHAR(1),
	@MCXDATA VARCHAR(30)

AS

DECLARE
	@@SQL AS VARCHAR(2000)

/*
SELECT @@SQL = "CREATE TABLE #ALLPARTYLEDGER "
SELECT @@SQL = @@SQL + "	("
SELECT @@SQL = @@SQL + "		CLTCODE VARCHAR(10),"
SELECT @@SQL = @@SQL + "		ACNAME VARCHAR(100),"
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		NSELEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		NSEMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		NSEUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		NSETOTAL MONEY,"
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		BSELEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		BSEMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		BSEUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		BSETOTAL MONEY,"
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		NSEFOLEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		NSEFOMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		NSEFOUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		NSEFOTOTAL MONEY,"
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		MCXLEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		MCXMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		MCXUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		MCXTOTAL MONEY,"
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "		NCXLEDGER MONEY,"
		SELECT @@SQL = @@SQL + "		NCXMARGIN MONEY,"
		SELECT @@SQL = @@SQL + "		NCXUNREL MONEY,"
		SELECT @@SQL = @@SQL + "		NCXTOTAL MONEY,"
	END
IF RIGHT(@@SQL, 1) = ','
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 1)
	END
SELECT @@SQL = @@SQL + "	) "
*/

CREATE TABLE #ALLPARTYLEDGER
	(
		CLTCODE VARCHAR(10),
		ACNAME VARCHAR(100),
		NSELEDGER MONEY,
		NSEMARGIN MONEY,
		NSEUNREL MONEY,
		NSETOTAL MONEY,
		BSELEDGER MONEY,
		BSEMARGIN MONEY,
		BSEUNREL MONEY,
		BSETOTAL MONEY,
		NSEFOLEDGER MONEY,
		NSEFOMARGIN MONEY,
		NSEFOUNREL MONEY,
		NSEFOTOTAL MONEY,
		MCXLEDGER MONEY,
		MCXMARGIN MONEY,
		MCXUNREL MONEY,
		MCXTOTAL MONEY,
		NCXLEDGER MONEY,
		NCXMARGIN MONEY,
		NCXUNREL MONEY,
		NCXTOTAL MONEY,
	)

IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, NSELEDGER, NSEMARGIN, NSEUNREL, NSETOTAL) EXEC "
		SELECT @@SQL = @@SQL + @NSEDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, BSELEDGER, BSEMARGIN, BSEUNREL, BSETOTAL) EXEC "
		SELECT @@SQL = @@SQL + @BSEDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, NSEFOLEDGER, NSEFOMARGIN, NSEFOUNREL, NSEFOTOTAL) EXEC "
		SELECT @@SQL = @@SQL + @NSEFODATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, NCXLEDGER, NCXMARGIN, NCXUNREL, NCXTOTAL) EXEC "
		SELECT @@SQL = @@SQL + @NCXDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = "INSERT INTO #ALLPARTYLEDGER (CLTCODE, ACNAME, MCXLEDGER, MCXMARGIN, MCXUNREL, MCXTOTAL) EXEC "
		SELECT @@SQL = @@SQL + @MCXDATA + ".DBO.RPT_MASTER_PARTYLEDGER '" + @FDATE + "', '" + @TDATE + "', '" + @STDDATE + "', "
		SELECT @@SQL = @@SQL + "'" + @LSTDATE + "', '" + @STATUSID + "', '" + @STATUSNAME + "', '" + @DISPRPT + "', '" + @FPARTY + "', "
		SELECT @@SQL = @@SQL + "'" + @TPARTY + "', '" + @RPTNAME + "', '" + @SUMOPT + "'"
		PRINT (@@SQL)
		EXEC (@@SQL)
	END
SELECT @@SQL = "SELECT CLTCODE, ACNAME = MAX(ACNAME), "
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "NSELEDGER = SUM(ISNULL(NSELEDGER, 0)), NSEMARGIN = SUM(ISNULL(NSEMARGIN, 0)), NSEUNREL = SUM(ISNULL(NSEUNREL, 0)), NSETOTAL = SUM(ISNULL(NSETOTAL, 0)), "
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "BSELEDGER = SUM(ISNULL(BSELEDGER, 0)), BSEMARGIN = SUM(ISNULL(BSEMARGIN, 0)), BSEUNREL = SUM(ISNULL(BSEUNREL, 0)), BSETOTAL = SUM(ISNULL(BSETOTAL, 0)), "
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "NSEFOLEDGER = SUM(ISNULL(NSEFOLEDGER, 0)), NSEFOMARGIN = SUM(ISNULL(NSEFOMARGIN, 0)), NSEFOUNREL = SUM(ISNULL(NSEFOUNREL, 0)), NSEFOTOTAL = SUM(ISNULL(NSEFOTOTAL, 0)), "
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "NCXLEDGER = SUM(ISNULL(NCXLEDGER, 0)), NCXMARGIN = SUM(ISNULL(NCXMARGIN, 0)), NCXUNREL = SUM(ISNULL(NCXUNREL, 0)), NCXTOTAL = SUM(ISNULL(NCXTOTAL, 0)), "
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "MCXLEDGER = SUM(ISNULL(MCXLEDGER, 0)), MCXMARGIN = SUM(ISNULL(MCXMARGIN, 0)), MCXUNREL = SUM(ISNULL(MCXUNREL, 0)), MCXTOTAL = SUM(ISNULL(MCXTOTAL, 0)), "
	END

SELECT @@SQL = LTRIM(RTRIM(@@SQL))

IF RIGHT(@@SQL, 1) = ','
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 1) + ' '
	END

SELECT @@SQL = @@SQL + "FROM #ALLPARTYLEDGER GROUP BY CLTCODE "
SELECT @@SQL = @@SQL + "COMPUTE "
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(NSELEDGER, 0))), SUM(SUM(ISNULL(NSEMARGIN, 0))), SUM(SUM(ISNULL(NSEUNREL, 0))), SUM(SUM(ISNULL(NSETOTAL, 0))), "
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(BSELEDGER, 0))), SUM(SUM(ISNULL(BSEMARGIN, 0))), SUM(SUM(ISNULL(BSEUNREL, 0))), SUM(SUM(ISNULL(BSETOTAL, 0))), "
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(NSEFOLEDGER, 0))), SUM(SUM(ISNULL(NSEFOMARGIN, 0))), SUM(SUM(ISNULL(NSEFOUNREL, 0))), SUM(SUM(ISNULL(NSEFOTOTAL, 0))), "
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(NCXLEDGER, 0))), SUM(SUM(ISNULL(NCXMARGIN, 0))), SUM(SUM(ISNULL(NCXUNREL, 0))), SUM(SUM(ISNULL(NCXTOTAL, 0))), "
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "SUM(SUM(ISNULL(MCXLEDGER, 0))), SUM(SUM(ISNULL(MCXMARGIN, 0))), SUM(SUM(ISNULL(MCXUNREL, 0))), SUM(SUM(ISNULL(MCXTOTAL, 0))), "
	END

SELECT @@SQL = LTRIM(RTRIM(@@SQL))

IF RIGHT(@@SQL, 1) = ','
	BEGIN
		SELECT @@SQL = LEFT(@@SQL, LEN(@@SQL) - 1) + ' '
	END


PRINT (@@SQL)
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONPATH
-- --------------------------------------------------

/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 01/15/2005 1:33:40 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 12/16/2003 2:31:48 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 05/08/2002 12:35:11 PM ******/




/*REPORT :  ALLPARTY LEDGER 
    FILE : ALLPARTY.ASP
    FILE : LEDGERVIEW.ASP
*/

/* SELECTS CONPATH FROM OWNER FOR A EXCHANGE AND SEGMENT */

CREATE PROCEDURE RPT_CONPATH

@EXCH VARCHAR(3),
@SEGMENT VARCHAR(20),
@NARRATION VARCHAR(25),
@VTYPE INT,
@SETTTYPE VARCHAR(3) = ''

AS

	SELECT 
		REPORTURL 
	FROM 
		ACCOUNT.DBO.PLDETAIL 
	WHERE 
		EXCHANGE=@EXCH 
		AND SEGMENT LIKE LTRIM(@SEGMENT)+'%'
		AND NARRATION = @NARRATION
		AND ISNULL(SETTTYPE, '') = @SETTTYPE
		AND VTYPE = @VTYPE
		AND FLAG = 'Y'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_CostMaster
-- --------------------------------------------------
CREATE  Procedure rpt_CostMaster as

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Select 
	branchname,
	brcontrolac,
	maincontrolac,
	Costname ,
	grpcode
From
	CostMast (nolock),
	BranchAccounts (nolock)
Where 
	CostName=BranchName 
Order by 
	branchname,costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CURRENTOPENTRY
-- --------------------------------------------------

CREATE PROCEDURE RPT_CURRENTOPENTRY
                @sdtcur DATETIME,
                @ldtcur DATETIME
AS

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SELECT ISNULL(LEFT(CONVERT(VARCHAR,SDTCUR,109),11),'')
  FROM   PARAMETER WITH(NOLOCK)
  WHERE  @sdtcur >= SDTCUR
         AND @ldtcur + ' 23:59:59' <= LDTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_family
-- --------------------------------------------------
/* Familywise Ledger */
/* Finds Families From Client1 */
Create Procedure Rpt_family
@Statusid Varchar(15), 
@Statusname  Varchar(25)
As
If @Statusid = 'Broker'
Begin
 Select Distinct Family From Client1
 Order By Family
End
If @Statusid = 'Family'
Begin
 Select Distinct Family From Client1
 Where Family = @Statusname
 Order By Family
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_finyearlist
-- --------------------------------------------------
Create Procedure  Rpt_finyearlist  
As  
Select Distinct  Smonth = Datename(Month, Sdtcur), Syear = Datename(Year, Sdtcur), Emonth = Datename(Month, Ldtcur),   
 Lyear = Datename(Year, Ldtcur) , Sdt = Convert(Varchar, Sdtcur, 103),   
Ldt = Convert(Varchar, Ldtcur, 103), Curyear From Account.Dbo.Parameter  
Order By Curyear Desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_GrpCombineTrialBalance
-- --------------------------------------------------


--EXEC rpt_GrpCombineTrialBalance 'Apr  1 2005', 'Dec 31 2005', 'NSEFO', ''
CREATE  Proc rpt_GrpCombineTrialBalance    
(    
@FromDate varchar(11),    
@ToDate varchar(11),    
@Segment Varchar(5)='ALL',    
@BranchCd Varchar(10)=''    
)    
    
as     
    
    
Declare @CodeStrip varchar(11)    
Declare @GrpName varchar(100)    
Declare @GrpCode varchar(15)    
Declare @TBCur Cursor      
    
    
 
CREATE 
    Table #TrialBalance 
	( 
		Segment varchar(5), 
		CltCode varchar(10), 
		ACName varchar(100), 
		GrpCode varchar(20), 
		GrpName varchar(100), 
		Amount money, 
		DrAmount money, 
		CrAmount money, 
		BranchCode varchar(20) 
	)     
	if @Segment = '' begin 
		SET @Segment = 'ALL' 
	END                             
	if @Segment = 'ALL' or @Segment = 'NSECM'    
		begin    
 
			SET transaction isolation level read uncommitted 
			INSERT 
			INTO #TrialBalance 
			SELECT 
				Segment, 
				CltCode, 
				AcName, 
				A.GrpCode, 
				B.GrpName, 
				Amount = VAmt, 
				DrAmount = (
				CASE 
					WHEN Vamt >= 0 
					THEN abs(Vamt) 
					ELSE 0 
				END
				), 
				CrAmount = (
				CASE 
					WHEN Vamt < 0 
					THEN Abs(Vamt) 
					ELSE 0 
				END
				), 
				'' 
			FROM 
				( 
				SELECT 
					Segment = 'NSECM', 
					GrpCode = A.grpcode, 
					CltCode = a.CltCode, 
					AcName = a.acname, 
					Vamt = sUM(
					CASE 
						WHEN DRCR = 'D' 
						THEN Vamt 
						ELSE -vamt 
					END
					) 
				FROM account.dbo.ledger l, --with(index(ledind),nolock),     
					account.dbo.acmast a --with(index(accat),nolock)                 
				WHERE l.cltcode = a.cltcode 
					AND vdt >= @FromDate + ' 00:00:00' 
					AND vdt <= @ToDate + ' 23:59:59' 
					AND accat not in (4,104,204) 
				GROUP BY a.GrpCode,
					A.cltcode, 
					a.ACName 
				) 
				A, 
				Account.dbo.GrpMast b (nolock) 
			WHERE a.GrpCode = b.GrpCode                                               
	            
	
				SET transaction isolation level read uncommitted 
			INSERT 
			INTO #TrialBalance 
			SELECT 
				Segment, 
				CltCode, 
				AcName, 
				A.GrpCode, 
				B.GrpName, 
				Amount = VAmt, 
				DrAmount = (
				CASE 
					WHEN Vamt >= 0 
					THEN abs(Vamt) 
					ELSE 0 
				END
				), 
				CrAmount = (
				CASE 
					WHEN Vamt < 0 
					THEN Abs(Vamt) 
					ELSE 0 
				END
				), 
				'' 
			FROM 
				( 
				SELECT 
					Segment = 'NSECM', 
					GrpCode = A.grpcode, 
					CltCode = 'CLIENT A/C', 
					AcName = 'CLIENT A/C - SUNDRY DEBTORS', 
					Vamt = sUM(
					CASE 
						WHEN DRCR = 'D' 
						THEN Vamt 
						ELSE -vamt 
					END
					) 
				FROM account.dbo.ledger l, --with(index(ledind),nolock),     
					account.dbo.acmast a --with(index(accat),nolock)                 
				WHERE l.cltcode = a.cltcode 
					AND vdt >= @FromDate + ' 00:00:00' 
					AND vdt <= @ToDate + ' 23:59:59' 
					AND accat in (4,104,204) 
				GROUP BY a.GrpCode 
				) 
				A, 
				Account.dbo.GrpMast b (nolock) 
			WHERE a.GrpCode = b.GrpCode 
		End
                            
                        --- now doing bse    
		if @Segment = 'ALL' or @Segment = 'BSECM'    
			begin    
				INSERT 
				INTO #TrialBalance 
				SELECT 
					Segment, 
					CltCode, 
					AcName, 
					A.GrpCode, 
					B.GrpName, 
					Amount = VAmt, 
					DrAmount = (
					CASE 
						WHEN Vamt >= 0 
						THEN abs(Vamt) 
						ELSE 0 
					END
					), 
					CrAmount = (
					CASE 
						WHEN Vamt < 0 
						THEN Abs(Vamt) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						Segment = 'BSECM', 
						GrpCode = A.grpcode, 
						CltCode = a.CltCode, 
						AcName = a.acname, 
						Vamt = sUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN Vamt 
							ELSE -vamt 
						END
						) 
					FROM accountbse.dbo.ledger l, --with(index(ledind),nolock),     
						accountbse.dbo.acmast a --with(index(accat),nolock)                 
					WHERE l.cltcode = a.cltcode 
						AND vdt >= @FromDate + ' 00:00:00' 
						AND vdt <= @ToDate + ' 23:59:59' 
						AND accat not in (4,104,204) 
					GROUP BY a.GrpCode,
						A.cltcode, 
						a.ACName 
					) 
					A, 
					accountbse.dbo.GrpMast b (nolock) 
				WHERE a.GrpCode = b.GrpCode 
				SET transaction isolation level read uncommitted 
				INSERT 
				INTO #TrialBalance 
				SELECT 
					Segment, 
					CltCode, 
					AcName, 
					A.GrpCode, 
					B.GrpName, 
					Amount = VAmt, 
					DrAmount = (
					CASE 
						WHEN Vamt >= 0 
						THEN abs(Vamt) 
						ELSE 0 
					END
					), 
					CrAmount = (
					CASE 
						WHEN Vamt < 0 
						THEN Abs(Vamt) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						Segment = 'BSECM', 
						GrpCode = A.grpcode, 
						CltCode = 'CLIENT A/C', 
						AcName = 'CLIENT A/C - SUNDRY DEBTORS', 
						Vamt = sUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN Vamt 
							ELSE -vamt 
						END
						) 
					FROM accountbse.dbo.ledger l, --with(index(ledind),nolock),     
						accountbse.dbo.acmast a --with(index(accat),nolock)                 
					WHERE l.cltcode = a.cltcode 
						AND vdt >= @FromDate + ' 00:00:00' 
						AND vdt <= @ToDate + ' 23:59:59' 
						AND accat in (4,104,204) 
					GROUP BY a.GrpCode 
					) 
					A, 
					accountbse.dbo.GrpMast b (nolock) 
				WHERE a.GrpCode = b.GrpCode
                            
                                    End    
                        --- now doing fo    
/*-----------------------------COMMENTED SPECIFICALLY FOR VERSION------------------------
		if @Segment = 'ALL' or @Segment = 'NSEFO'    
			begin    
					SET transaction isolation level read uncommitted 
				INSERT 
				INTO #TrialBalance 
				SELECT 
					Segment, 
					CltCode, 
					AcName, 
					A.GrpCode, 
					B.GrpName, 
					Amount = VAmt, 
					DrAmount = (
					CASE 
						WHEN Vamt >= 0 
						THEN abs(Vamt) 
						ELSE 0 
					END
					), 
					CrAmount = (
					CASE 
						WHEN Vamt < 0 
						THEN Abs(Vamt) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						Segment = 'NSEFO', 
						GrpCode = A.grpcode, 
						CltCode = a.CltCode, 
						AcName = a.acname, 
						Vamt = sUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN Vamt 
							ELSE -vamt 
						END
						) 
					FROM accountFO.dbo.ledger l, --with(index(ledind),nolock),     
						accountFO.dbo.acmast a --with(index(accat),nolock)                 
					WHERE l.cltcode = a.cltcode 
						AND vdt >= @FromDate + ' 00:00:00' 
						AND vdt <= @ToDate + ' 23:59:59' 
						AND accat not in (4,104,204) 
					GROUP BY a.GrpCode,
						A.cltcode, 
						a.ACName 
					) 
					A, 
					accountFO.dbo.GrpMast b (nolock) 
				WHERE a.GrpCode = b.GrpCode 

					SET transaction isolation level read uncommitted 
				INSERT 
				INTO #TrialBalance 
				SELECT 
					Segment, 
					CltCode, 
					AcName, 
					A.GrpCode, 
					B.GrpName, 
					Amount = VAmt, 
					DrAmount = (
					CASE 
						WHEN Vamt >= 0 
						THEN abs(Vamt) 
						ELSE 0 
					END
					), 
					CrAmount = (
					CASE 
						WHEN Vamt < 0 
						THEN Abs(Vamt) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						Segment = 'NSEFO', 
						GrpCode = A.grpcode, 
						CltCode = 'CLIENT A/C', 
						AcName = 'CLIENT A/C - SUNDRY DEBTORS', 
						Vamt = sUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN Vamt 
							ELSE -vamt 
						END
						) 
					FROM accountFO.dbo.ledger l, --with(index(ledind),nolock),     
						accountFO.dbo.acmast a --with(index(accat),nolock)                 
					WHERE l.cltcode = a.cltcode 
						AND vdt >= @FromDate + ' 00:00:00' 
						AND vdt <= @ToDate + ' 23:59:59' 
						AND accat in (4,104,204) 
					GROUP BY a.GrpCode 
					) 
					A, 
					accountFO.dbo.GrpMast b (nolock) 
				WHERE a.GrpCode = b.GrpCode
			End    
*/
-- NOW GETTING FORMATTED VALUES          
	CREATE 
		Table #TBOutput 
		( 
			SNO bigint identity(1,1), 
			Segment varchar(5), 
			LevelCode varchar(15), 
			CltCode varchar(20), 
			AcName varchar(100), 
			Amount money, 
			DrAmount money, 
			CrAmount money 
		)
    
	SET @TBCur = Cursor for 
	SELECT 
		GrpCode, 
		GrpName, 
		CodeStrip 
	FROM 
		( 
		SELECT 
			grpcode, 
			grpname, 
			CodeStrip = replace(replace(replace(replace(replace(replace(replace(replace(Replace(grpcode,'0000000000',''),'000000000',''),'00000000',''),'0000000',''),'000000',''),'00000',''),'0000',''),'000',''),'00','') 
		FROM account.dbo.grpmast 
		UNION 
		SELECT 
			grpcode, 
			grpname, 
			CodeStrip = replace(replace(replace(replace(replace(replace(replace(replace(Replace(grpcode,'0000000000',''),'000000000',''),'00000000',''),'0000000',''),'000000',''),'00000',''),'0000',''),'000',''),'00','') 
		FROM accountbse.dbo.grpmast 
/*		UNION 
		SELECT 
			grpcode, 
			grpname, 
			CodeStrip = replace(replace(replace(replace(replace(replace(replace(replace(Replace(grpcode,'0000000000',''),'000000000',''),'00000000',''),'0000000',''),'000000',''),'00000',''),'0000',''),'000',''),'00','') 
		FROM accountfo.dbo.grpmast */
		) 
		A 
	ORDER BY GrpCode 
	Open @TBCur Fetch Next 
	FROM @TBCur 
	INTO @GrpCode, @GrpName, @CodeStrip
	While @@Fetch_Status = 0
		Begin 
			INSERT 
			INTO #TBOutput 
			SELECT 
				'', 
				@CodeStrip, 
				CltCode, 
				AcName = LEFT(AcName,90)+'~'+Segment, 
				Sum(Amount), 
				Sum(DrAmount), 
				Sum(CrAmount) 
			FROM #TrialBalance 
			WHERE GrpCode = @GrpCode 
			GROUP BY CltCode, 
				LEFT(AcName,90)+'~'+Segment Fetch Next 
			FROM @TBCur 
			INTO @GrpCode, 
				@GrpName, 
				@CodeStrip 
		END 
		Select * From #TbOutPut
		Return    
		Close @TBCur      
		Deallocate @TBCur      
	Drop Table #TrialBalance    
	SELECT 
		SNo, 
		LevelCode, 
		CltCode, 
		AcName, 
		Amount, 
		DrAmount, 
		CrAmount 
	FROM #TBOutput 
	WHERE isnull(amount,0) <> 0 
		OR isnull(DrAmount,0) <> 0 
		OR isnull(CrAmount,0) <> 0 
	ORDER BY Sno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_lastopentry
-- --------------------------------------------------
/*
This Query Is Used If Opening Entry For Current Yr Is Not Found
This Query Gives Us The Latest Opeing Entry Date
*/
Create Procedure Rpt_lastopentry
@Sdtcur Datetime
As
Select   Isnull(Left((Convert(Varchar, Max(Vdt), 109)), 11), '') From Ledger Where Vtyp = '18' And
Vdt < @Sdtcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MASTER_PARTYLEDGER
-- --------------------------------------------------
        
CREATE PROC RPT_MASTER_PARTYLEDGER        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @STDDATE VARCHAR(11),        
 @LSTDATE VARCHAR(11),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(20),        
 @DISPLAYRPT VARCHAR(3),        
 @FPARTY VARCHAR(10),        
 @TPARTY VARCHAR(10),        
 @REPORTNAME varchar(15),        
 @SUMMARYOPT CHAR(1),  
 @SHOWZERO VARCHAR(1) = 'N'  
        
AS        
        
DECLARE        
@@CALLINGSP VARCHAR(100),        
@@SELECTQUERY VARCHAR(1000)        
        
        
 SELECT         
  @@CALLINGSP = CALLINGSP         
 FROM         
  TBL_MASTER_PARTYLEDGER        
 WHERE        
  REPORTNAME = @REPORTNAME        
  AND STATUSID = @STATUSID        
  AND SUMMARYOPT = @SUMMARYOPT        
      
        
SET @@SELECTQUERY = @@CALLINGSP + ' ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' +  @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY  + ''',''' + @REPORTNAME + ''''
print (@@SELECTQUERY)  
   
      
  
EXEC (@@SELECTQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MASTER_PARTYLEDGER_new
-- --------------------------------------------------

--Exec RPT_MASTER_PARTYLEDGER 'Dec  1 2005','Dec 14 2005','Apr  1 2005','Apr  1 2005','broker','broker','Edt','c','b','BRANCH','S'    
/*       
THIS PROCEDURE IS A MASTER PROCEDURE WHICH INTERNALLY CALL THE DIFFERENT PROCEDURES ON BASIS OF FOLLOWING PARAMETERS      
@STATUSID       
@REPORTNAME      
@SUMMARYOPT       
IT TAKES A PROCEDURE NAME FROM TBL_MASTER_PARTYLEDGER TABLE AND EXECUTE WITH THE PARAMETERS PASSED IN MASTER PROCEDURE.      
CREATED BY := NIKHIL NAVARE      
CREATED DATE := DECEMBER 12 2005      
DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX      
SYNTAX AS FOLLOWS -----      
EXEC RPT_MASTER_PARTYLEDGER 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'ABC', 'ZZZ', 'BRANCH', 'S'      
*/      
      
CREATE  PROC [dbo].[RPT_MASTER_PARTYLEDGER_new]      
 @FDATE VARCHAR(11),      
 @TDATE VARCHAR(11),      
 @STDDATE VARCHAR(11),      
 @LSTDATE VARCHAR(11),      
 @STATUSID VARCHAR(20),      
 @STATUSNAME VARCHAR(20),      
 @DISPLAYRPT VARCHAR(3),      
 @FPARTY VARCHAR(10),      
 @TPARTY VARCHAR(10),      
 @REPORTNAME varchar(15),      
 @SUMMARYOPT CHAR(1),
 @SHOWZERO VARCHAR(1) = 'N',
	@nseflg varchar(1)  ,    
	@bseflg varchar(1)  ,    
	@nfoflg varchar(1)    
      
AS      
      
DECLARE      
@@CALLINGSP VARCHAR(100),      
@@SELECTQUERY VARCHAR(1000)      
      
      
 SELECT       
  @@CALLINGSP = CALLINGSP       
 FROM       
  TBL_MASTER_PARTYLEDGER_NEW      
 WHERE      
  REPORTNAME = @REPORTNAME      
  AND STATUSID = @STATUSID      
  AND SUMMARYOPT = @SUMMARYOPT      
    
      
SET @@SELECTQUERY = @@CALLINGSP + ' ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' +  @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY  + ''',''' + @REPORTNAME + ''''  
    

EXEC (@@SELECTQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_MisReporInterest_Check
-- --------------------------------------------------
--sp_helptext rpt_MisReporInterest_Check  
--Text  
CREATE Procedure  [dbo].[rpt_MisReporInterest_Check]    
@fromparty varchar(10),    
@toparty varchar(10),    
@fromdt varchar(11),    
@todate varchar(11),    
@reporttype varchar(30),    
@branchcode varchar(10),    
@reportby varchar(10),    
@StatusId Varchar(30),    
@StatusName Varchar(30)    
    
as    
/*    
exec rpt_MisReporInterest_Check 'a00000', 'Z','Apr 1 2006', 'Nov 29 2006','PARTY','rnaspravin','SUMMARY', 'subbroker', 'rnaspravin'    
*/    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
if upper(rtrim(@reporttype)) = 'FAMILY' or  upper(rtrim(@reporttype)) =  'c'    
 Begin    
  Set @reportby =  'DETAIL'    
 End    
    
if @reportby <>  'SUMMARY'    
 Begin    
  if upper(rtrim(@reporttype)) = 'PARTY'    
   begin    
    Select    
     BalanceDate,    
     CltCode = C2.Party_Code,    
     Short_Name = C1.Long_Name,    
     Balance,    
     Interest=abs(Interest),  
     MBalance,    
     MInterest=abs(MInterest),  
     IntRateCr,    
     IntRateDr    
    INTO #Interest    
    From    
     Tbl_Report_Interest_Margin (nolock),    
     msaJag.dbo.Client1 C1 (nolock),    
     msaJag.dbo.Client2 C2 (nolock)    
    Where    
     C1.Cl_Code = C2.Cl_Code    
     And Tbl_Report_Interest_Margin.Cltcode = C2.Party_Code    
     And BalanceDate Between @fromdt And @todate + ' 23:59'    
     And C2.Party_Code Between @fromparty And @toparty    
     And @StatusName = (Case When @StatusId = 'Region' Then C1.Region    
          When @StatusId = 'Area' Then C1.Area    
          When @StatusId = 'Branch' Then C1.Branch_Cd    
          When @StatusId = 'SubBroker' Then C1.Sub_Broker    
          When @StatusId = 'Trader' Then C1.Trader    
          When @StatusId = 'Family' Then C1.Family    
          When @StatusId = 'Client' Then C2.Party_Code    
          Else 'Broker' End)    
     And C1.Branch_Cd like case When @branchcode <> '' Then @branchcode Else  '%' End    
/*    SELECT * FROM #Interest where MBalance > 0 Order By Cltcode, BalanceDate    */
    SELECT * FROM #Interest Order By Cltcode, BalanceDate    
    DROP TABLE #Interest    
   end    
  else if upper(rtrim(@reporttype)) = 'FAMILY'    
   begin    
    Select    
     BalanceDate,    
     C1.Family,    
     Short_Name = C1.Long_Name ,    
     Balance,    
     Interest=abs(Interest),    
     MBalance,    
     MInterest=abs(MInterest),    
     IntRateCr,    
     IntRateDr    
    INTO #Interest1    
    From    
     Tbl_Report_Interest_Margin with(index(indxIntBal_Margin)),    
     msaJag.dbo.Client1 C1 (nolock),    
     msaJag.dbo.Client2 C2 (noLock)    
    Where    
     C1.Cl_Code = C2.Cl_Code    
     And Tbl_Report_Interest_Margin.Cltcode = C2.Party_Code    
     And BalanceDate Between @fromdt And @todate + ' 23:59'    
     And C1.Family Between @fromparty And @toparty    
     And C1.branch_cd like case When @branchcode <> '' Then @branchcode Else  '%' End    
     And @StatusName = (Case When @StatusId = 'Region' Then C1.Region    
          When @StatusId = 'Area' Then C1.Area    
          When @StatusId = 'Branch' Then C1.Branch_Cd    
          When @StatusId = 'SubBroker' Then C1.Sub_Broker    
          When @StatusId = 'Trader' Then C1.Trader    
          When @StatusId = 'Family' Then C1.Family    
          When @StatusId = 'Client' Then C2.Party_Code    
          Else 'Broker' End)    
    SELECT * FROM #Interest1 Order By Family    
    DROP TABLE #Interest1    
   End    
  else if upper(rtrim(@reporttype)) = 'FAMILYPARTY'    
   begin    
    Select    
     BalanceDate,    
     CltCode = C2.Party_Code,    
     Short_Name = C1.Long_Name,    
     Balance,    
     Interest=abs(Interest),    
     MBalance,    
     MInterest=abs(MInterest),    
     IntRateCr,    
     IntRateDr    
    Into #Interest2    
    From    
 	 Tbl_Report_Interest_Margin with(index(indxIntBal_Margin)),    
     msaJag.dbo.Client1 C1 (noLock),    
     msaJag.dbo.Client2 C2 (noLock)    
    Where    
     C1.Cl_Code = C2.Cl_Code    
     And Tbl_Report_Interest_Margin.Cltcode = C2.Party_Code    
     And BalanceDate Between @fromdt And @todate + ' 23:59'    
     And C1.Family Between @fromparty And @toparty    
     And C1.branch_cd like case When @branchcode <> '' Then @branchcode Else  '%' End    
     And @StatusName = (Case When @StatusId = 'Region' Then C1.Region    
          When @StatusId = 'Area' Then C1.Area    
          When @StatusId = 'Branch' Then C1.Branch_Cd    
          When @StatusId = 'SubBroker' Then C1.Sub_Broker    
          When @StatusId = 'Trader' Then C1.Trader    
          When @StatusId = 'Family' Then C1.Family    
          When @StatusId = 'Client' Then C2.Party_Code    
          Else 'Broker' End)    
    SELECT * FROM #Interest2 Order By CltCode    
    DROP TABLE #Interest2    
   End    
 End    
else    
--Print 'vinay '
 Begin    
  if upper(rtrim(@reporttype)) = 'PARTY'    
   begin    
    Select    
     Cltcode = C2.Party_Code,    
     Short_Name = C1.Long_Name,    
     InterestDr = Sum(Case When Balance > 0 Then Interest Else 0 End),    
     InterestCr =abs(Sum(Case When Balance < 0 Then Interest Else 0 End)),    
     MInterestCr =abs(Sum(Case When MBalance < 0 Then MInterest Else 0 End)),    
     IntRateCr,    
     IntRateDr,    
--     netInterest  =  abs(Sum(Case When Balance > 0 Then Interest Else 0 End) - (abs(Sum(Case When Balance < 0 Then Interest Else 0 End)) + abs(Sum(Case When MBalance < 0 Then MInterest Else 0 End))))  
     netInterest  =   (abs(Sum(Case When Balance < 0 Then Interest Else 0 End)) + abs(Sum(Case When MBalance < 0 Then MInterest Else 0 End))) - Sum(Case When Balance > 0 Then Interest Else 0 End)  
    INTO #Interest3    
    From    
     Tbl_Report_Interest_Margin with(index(indxIntBal_Margin)),    
     msaJag.dbo.Client1 C1 (noLock),    
     msaJag.dbo.Client2 C2 (noLock)    
    Where    
     C1.Cl_Code = C2.Cl_Code    
     And Tbl_Report_Interest_Margin.Cltcode = C2.party_Code    
     And BalanceDate Between @fromdt And @todate + ' 23:59'    
     And C2.Party_Code Between @fromparty And @toparty    
     And C1.Branch_Cd like case When @branchcode <> '' Then @branchcode Else  '%' End    
     And @StatusName = (Case When @StatusId = 'Region' Then C1.Region    
          When @StatusId = 'Area' Then C1.Area    
          When @StatusId = 'Branch' Then C1.Branch_Cd    
          When @StatusId = 'SubBroker' Then C1.Sub_Broker    
          When @StatusId = 'Trader' Then C1.Trader    
          When @StatusId = 'Family' Then C1.Family    
          When @StatusId = 'Client' Then C2.Party_Code    
          Else 'Broker' End)    
    Group By    
     C2.Party_Code,    
     C1.Long_Name,    
     IntRateDr,    
     IntRateCr    
      SELECT * FROM #Interest3 where (InterestDr<>0 or InterestCr<>0)  Order By Cltcode    
--	  SELECT * FROM #Interest3 Order By Cltcode    
    DROP TABLE #Interest3    
   End    
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_MultiBankId
-- --------------------------------------------------

CREATE  Proc rpt_MultiBankId
(
	@partyfrom varchar(20),  
	@partyto varchar(20),  
	@sortby varchar(20)  
) 
as  
if @partyto ='' begin set @partyto ='zzzzzzz' end

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
        
Select   
	strOrder = case 
		when @sortby= 1 then Cltcode 
		when @sortby= 2 then Chequename 
		when @sortby= 3 then Bank_Name 
		when @sortby= 4 then Branch_Name 
		end,

 	Cltcode,
	Chequename,
	Bank_Name,
	Branch_Name,
	Acctype,
	Accno,
	Defaultbank = case when Defaultbank=1 then 'Yes' else '' end
From   
 	MultiBankId (NOLOCK) ,Msajag..PoBank P (NOLOCK)
Where   
	MultiBankId.Bankid=P.Bankid 
	And cltcode Between @partyfrom and @partyto

Order by 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_netBalancesTBAllS
-- --------------------------------------------------
/**All Segments**/  
CREATE proc rpt_netBalancesTBAllS  
@fromdt varchar(11),        
@todt varchar(11),        
@Grpcode varchar(11),        
@statusid varchar(15),        
@statusname varchar(25)        
        
as        
  
Select cltcode, acname, sum(Amount) Amount, sum(DrAmount) DrAmount, sum(CrAmount) CrAmount  
from (     
Select cltcode=substring(a.grpcode,1,len(rtrim(@grpcode))+2), acname=grpname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
from ledger l, acmast a, grpmast g        
where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)         
and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
and g.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode))+2)+ right('0000000000',11-(len(rtrim(@grpcode))+2))        
group by substring(a.grpcode,1,len(rtrim(@grpcode))+2), grpname        
having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
  
union  
  
Select cltcode=substring(a.grpcode,1,len(rtrim(@grpcode))+2), acname=grpname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g        
where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)         
and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
and g.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode))+2)+ right('0000000000',11-(len(rtrim(@grpcode))+2))        
group by substring(a.grpcode,1,len(rtrim(@grpcode))+2), grpname        
having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
  
union  
  
Select cltcode=substring(a.grpcode,1,len(rtrim(@grpcode))+2), acname=grpname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g        
where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)         
and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
and g.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode))+2)+ right('0000000000',11-(len(rtrim(@grpcode))+2))        
group by substring(a.grpcode,1,len(rtrim(@grpcode))+2), grpname        
having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0  
) z  
group by cltcode, acname  
order by cltcode, acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_netBalancesTBDetailsAllS
-- --------------------------------------------------
--*************************************************************  
create proc rpt_netBalancesTBDetailsAllS  
@fromdt varchar(11),      
@todt varchar(11),      
@Grpcode varchar(11),      
@statusid varchar(15),      
@statusname varchar(25)      
      
as  
  
Select cltcode, acname, sum(Amount) Amount, sum(DrAmount) DrAmount, sum(CrAmount) CrAmount  
from (     
Select l.cltcode, l.acname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),      
DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),      
CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)    
from ledger l, acmast a      
where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)       
and a.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode)))+ right('0000000000',11-(len(rtrim(@grpcode))))    
and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'      
and a.accat<>'4'      
group by l.cltcode,l.acname      
having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0      
  
union  
  
Select l.cltcode, l.acname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),      
DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),      
CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)    
from accountbse.dbo.ledger l, accountbse.dbo.acmast a      
where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)       
and a.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode)))+ right('0000000000',11-(len(rtrim(@grpcode))))    
and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'      
and a.accat<>'4'      
group by l.cltcode,l.acname      
having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0      
  
union  
  
Select l.cltcode, l.acname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),      
DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),      
CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)    
from accountfo.dbo.ledger l, accountfo.dbo.acmast a      
where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)       
and a.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode)))+ right('0000000000',11-(len(rtrim(@grpcode))))    
and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'      
and a.accat<>'4'      
group by l.cltcode,l.acname      
having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0      
) z  
group by cltcode, acname  
order by cltcode, acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_netBalancesTBDetailsSS
-- --------------------------------------------------
--*************************************************************

CREATE proc rpt_netBalancesTBDetailsSS
@fromdt varchar(11),    
@todt varchar(11),    
@Grpcode varchar(11),    
@statusid varchar(15),    
@statusname varchar(25),
@segment varchar(3)

as

if @segment = 'NSE' 
begin 
	Select l.cltcode, l.acname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
	DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
	CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)  
	from ledger l, acmast a    
	where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)     
	and a.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode)))+ right('0000000000',11-(len(rtrim(@grpcode))))  
	and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'    
	and a.accat<>'4'    
	group by l.cltcode,l.acname    
	having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0    
	order by l.cltcode, l.acname
end

else if @segment = 'BSE' 
begin
	Select l.cltcode, l.acname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
	DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
	CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)  
	from accountbse.dbo.ledger l, accountbse.dbo.acmast a    
	where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)     
	and a.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode)))+ right('0000000000',11-(len(rtrim(@grpcode))))  
	and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'    
	and a.accat<>'4'    
	group by l.cltcode,l.acname    
	having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0    
	order by l.cltcode, l.acname
end

else if @segment = 'FNO' 
begin
	Select l.cltcode, l.acname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
	DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
	CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)  
	from accountfo.dbo.ledger l, accountfo.dbo.acmast a    
	where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)     
	and a.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode)))+ right('0000000000',11-(len(rtrim(@grpcode))))  
	and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'    
	and a.accat<>'4'    
	group by l.cltcode,l.acname    
	having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0    
	order by l.cltcode, l.acname
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_netBalancesTBSS
-- --------------------------------------------------
--*******************************************************************************************

/**Specific Segment**/
CREATE proc rpt_netBalancesTBSS
@fromdt varchar(11),      
@todt varchar(11),      
@Grpcode varchar(11),      
@statusid varchar(15),      
@statusname varchar(25),  
@segment varchar(3)
      
as      

if @segment = 'NSE' 
begin
	Select cltcode=substring(a.grpcode,1,len(rtrim(@grpcode))+2), acname=grpname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
	DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
	CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)      
	from ledger l, acmast a, grpmast g      
	where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)       
	and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'      
	and g.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode))+2)+ right('0000000000',11-(len(rtrim(@grpcode))+2))      
	group by substring(a.grpcode,1,len(rtrim(@grpcode))+2), grpname      
	having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0      
	order by cltcode, acname
end

else if @segment = 'BSE' 
begin
	Select cltcode=substring(a.grpcode,1,len(rtrim(@grpcode))+2), acname=grpname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
	DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
	CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)      
	from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g      
	where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)       
	and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'      
	and g.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode))+2)+ right('0000000000',11-(len(rtrim(@grpcode))+2))      
	group by substring(a.grpcode,1,len(rtrim(@grpcode))+2), grpname      
	having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0      
	order by cltcode, acname
end

else if @segment = 'FNO' 
begin
	Select cltcode=substring(a.grpcode,1,len(rtrim(@grpcode))+2), acname=grpname, Amount= isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
	DrAmount= isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
	CrAmount= isnull(sum(case when drcr = 'c' then vamt else 0 end),0)      
	from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g      
	where l.cltcode = a.cltcode and substring(a.grpcode,1,len(rtrim(@grpcode))) = rtrim(@grpcode)       
	and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'      
	and g.grpcode = substring(a.grpcode,1,len(rtrim(@grpcode))+2)+ right('0000000000',11-(len(rtrim(@grpcode))+2))      
	group by substring(a.grpcode,1,len(rtrim(@grpcode))+2), grpname      
	having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0
	order by cltcode, acname
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_netTBAllS
-- --------------------------------------------------

CREATE proc rpt_netTBAllS          
@fromdt varchar(11),          
@todt varchar(11),          
@statusid varchar(15),          
@statusname varchar(25),  
@Level smallint,  
@MainGrp varchar(25)          
          
as          
if @Level = 1          
 if @MainGrp<>''      
     begin      
 Select cltcode, acname, sum(Amount) Amount, sum(DrAmount) DrAmount, sum(CrAmount) CrAmount  
 from (  
 select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from ledger l, acmast a, grpmast g          
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)      
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'           
 group by substring(a.grpcode,1,1), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
   
 union  
   
 select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g          
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)      
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'           
 group by substring(a.grpcode,1,1), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
   
 union  
   
 select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g          
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)      
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'           
 group by substring(a.grpcode,1,1), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
 ) z  
 group by cltcode, acname  
 order by cltcode, acname   
     end      
 else      
     begin    
 Select cltcode, acname, sum(Amount) Amount, sum(DrAmount) DrAmount, sum(CrAmount) CrAmount  
 from (  
 Select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from ledger l, acmast a, grpmast g  
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in ('A','L','X','N')  
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'           
 group by substring(a.grpcode,1,1), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
   
 union  
   
 Select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g  
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in ('A','L','X','N')  
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'           
 group by substring(a.grpcode,1,1), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
   
 union  
   
 Select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g  
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in ('A','L','X','N')  
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'           
 group by substring(a.grpcode,1,1), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
 ) z  
 group by cltcode, acname  
 order by cltcode, acname   
     end      
else          
     begin          
 Select cltcode, acname, sum(Amount) Amount, sum(DrAmount) DrAmount, sum(CrAmount) CrAmount  
 from (  
 select cltcode=substring(a.grpcode,1,3) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from ledger l, acmast a, grpmast g          
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)          
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,3)+ '00000000' and a.cltcode <> '99999'          
 group by substring(a.grpcode,1,3), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
   
 union  
   
 select cltcode=substring(a.grpcode,1,3) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g          
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)          
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,3)+ '00000000' and a.cltcode <> '99999'          
 group by substring(a.grpcode,1,3), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0         
   
 union  
   
 select cltcode=substring(a.grpcode,1,3) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),    
 DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),    
 CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)          
 from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g          
 where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)          
 and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'          
 and g.grpcode = substring(a.grpcode,1,3)+ '00000000' and a.cltcode <> '99999'          
 group by substring(a.grpcode,1,3), grpname          
 having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0          
 ) z  
 group by cltcode, acname  
 order by cltcode, acname   
     end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_netTBSS
-- --------------------------------------------------

--*************************************************************

CREATE proc rpt_netTBSS        
@fromdt varchar(11),        
@todt varchar(11),        
@statusid varchar(15),        
@statusname varchar(25),
@Level smallint,
@MainGrp varchar(25),
@segment varchar(3)
     
as        
if @Level = 1        
if @MainGrp<>''    
begin    
	if @segment = 'NSE' 
	begin 
		select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from ledger l, acmast a, grpmast g        
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)    
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'         
		group by substring(a.grpcode,1,1), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
	end

	else if @segment = 'BSE' 
	begin
		select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g        
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)    
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'         
		group by substring(a.grpcode,1,1), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
	end

	else if @segment = 'FNO' 
	begin
		select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g        
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)    
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'         
		group by substring(a.grpcode,1,1), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
		order by cltcode, acname 	
	end
end    
 
else    
begin  
	if @segment = 'NSE' 
	begin
		Select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from ledger l, acmast a, grpmast g
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in ('A','L','X','N')
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'         
		group by substring(a.grpcode,1,1), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
	end

	else if @segment = 'BSE' 
	begin
		Select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in ('A','L','X','N')
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'         
		group by substring(a.grpcode,1,1), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
	end

	else if @segment = 'FNO' 
	begin
		Select cltcode=substring(a.grpcode,1,1) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in ('A','L','X','N')
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,1)+ '0000000000'         
		group by substring(a.grpcode,1,1), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
		order by cltcode, acname 
	end
end    

else        
begin        
	if @segment = 'NSE' 
	begin
		select cltcode=substring(a.grpcode,1,3) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from ledger l, acmast a, grpmast g        
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)        
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,3)+ '00000000' and a.cltcode <> '99999'        
		group by substring(a.grpcode,1,3), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
	end

	else if @segment = 'BSE' 
	begin
		select cltcode=substring(a.grpcode,1,3) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from accountbse.dbo.ledger l, accountbse.dbo.acmast a, accountbse.dbo.grpmast g        
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)        
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,3)+ '00000000' and a.cltcode <> '99999'        
		group by substring(a.grpcode,1,3), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0       
	end

	else if @segment = 'FNO' 
	begin
		select cltcode=substring(a.grpcode,1,3) , acname=grpname, Amount=isnull(sum(case when drcr = 'd' then vamt else -vamt end),0),  
		DrAmount=isnull(sum(case when drcr = 'd' then vamt else 0 end),0),  
		CrAmount=isnull(sum(case when drcr = 'c' then vamt else 0 end),0)        
		from accountfo.dbo.ledger l, accountfo.dbo.acmast a, accountfo.dbo.grpmast g        
		where l.cltcode = a.cltcode and substring(a.grpcode,1,1) in (@MainGrp)        
		and vdt >= @fromdt + ' 00:00:00' and vdt <= @todt + ' 23:59:59'        
		and g.grpcode = substring(a.grpcode,1,3)+ '00000000' and a.cltcode <> '99999'        
		group by substring(a.grpcode,1,3), grpname        
		having abs(isnull(sum(case when drcr = 'd' then vamt else -vamt end),0)) > 0        
		order by cltcode, acname 
	end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_BRANCH_SUMMARY_V3
-- --------------------------------------------------
/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	*****************************************************************************************************
*/
CREATE PROC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@REPORTNAME VARCHAR(100)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(25),
@@OBJID AS INT
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)
IF @@OBJID = 0
	BEGIN
		EXEC CREATEPARTYLEDGER
	END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER

IF @REPORTNAME = 'BRANCH'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				--INSERT LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				EXEC (@@SQL)
		
				--INSERT MARGINLEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				PRINT @@SQL
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, SUM(VAMT) AS LEDGERAMOUNT, SUM(MAMT) AS MARGINAMOUNT"
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + ", SUM(UNREALISED) AS UNREALISED "
					END
				SELECT @@SQL = @@SQL + ", SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)) "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + ", SUM(SUM(UNREALISED)) "
					END
				SELECT @@SQL = @@SQL + ", SUM(SUM(VAMT + MAMT)) "
				PRINT @@SQL
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'AREA'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'REGION'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'SUBBROKER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'TRADER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'FAMILY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_ALL
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_ALL]            
 @FDATE VARCHAR(11),            
 @TDATE VARCHAR(11),            
 @STDDATE VARCHAR(11),            
 @LSTDATE VARCHAR(11),            
 @STATUSID VARCHAR(20),            
 @STATUSNAME VARCHAR(20),            
 @DISPLAYRPT VARCHAR(3),            
 @FPARTY VARCHAR(10),            
 @TPARTY VARCHAR(10),            
 @REPORTNAME VARCHAR(100),            
 @nseflg varchar(1)  ,                
 @bseflg varchar(1)  ,                
 @nfoflg varchar(1) ,         
 @SESSIONID VARCHAR(10)        
            
            
AS            
BEGIN            
DECLARE            
@@SQL AS VARCHAR(2000),            
@@RECCOUNTER AS NUMERIC,            
@@SHAREDB AS VARCHAR(25),            
@@OBJID AS INT,            
@@ACCNSESERV AS  VARCHAR(25),           
@@ACCBSESERV AS  VARCHAR(25),           
@@ACCNFOSERV AS  VARCHAR(25),           
@@ACCNSEDB AS  VARCHAR(25),           
@@ACCBSEDB AS  VARCHAR(25),           
@@ACCNFODB AS  VARCHAR(25)        
          
          
          
select @@ACCNSEDB = AccountDb,@@ACCNSESERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'NSE' and Segment = 'CAPITAL'          
select @@ACCBSEDB =AccountDb,@@ACCBSESERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'BSE' and Segment = 'CAPITAL'          
select @@ACCNFODB =AccountDb,@@ACCNFOSERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'NSE' and Segment = 'FUTURES'          
          
Select @@ACCNSESERV = '[' + @@ACCNSESERV + ']'          
Select @@ACCBSESERV = '[' + @@ACCBSESERV + ']'          
Select @@ACCNFOSERV = '[' + @@ACCNFOSERV + ']'          
          
          
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER1'), 0)            
IF @@OBJID = 0            
 BEGIN            
  EXEC CREATEPARTYLEDGER_new            
 END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
            
DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID            
        
            
--SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER            
            
            
IF @REPORTNAME = 'BRANCH'            
 Begin            
 If @nseflg ='Y'            
  Begin            
 Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'             
 Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
 EXEC( @@SQL)       
PRINT (@@SQL)        
  end            
 If @bseflg = 'Y'            
  Begin            
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'          
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
    EXEC( @@SQL)          
  End            
 If @nfoflg ='Y'            
  Begin            
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'             
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
 EXEC( @@SQL)             
  end            
end            
-------------------------------      
IF @REPORTNAME = 'AREA'            
 begin            
 If @nseflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'               
   Select @@SQL = @@SQL    + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT
   
+ ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC( @@SQL)               
end            
 If @bseflg = 'Y'            
  Begin            
 Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1(AREA, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'           
 Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + '''' EXEC(@@SQL)          
  end            
 If @nfoflg ='Y'            
  Begin            
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'          
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
  end            
 end            
----------------------------------            
IF @REPORTNAME = 'REGION'            
 begin            
 If @nseflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
  end            
 If @bseflg = 'Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
 EXEC(@@SQL)          
  end            
 If @nfoflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
  end            
end            
--------------------------------            
IF @REPORTNAME = 'SUBBROKER'            
 begin            
 If @nseflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'              
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)         
print (@@SQL)        
  end            
 If @bseflg = 'Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
  end            
 If @nfoflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
  end            
 end            
            
-----------------------------------            
            
IF @REPORTNAME = 'TRADER'            
 begin            
 If @nseflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'                
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
  end            
 If @bseflg = 'Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'            
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + 
  
''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
  end            
 If @nfoflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'            
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
 end            
end            
-----------------------------------            
            
            
IF @REPORTNAME = 'FAMILY'            
 begin            
 If @nseflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'      
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
print (@@SQL) 
 end            
 If @bseflg = 'Y'            
  Begin            
  Select @@SQL = ' INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'             
  Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)
print (@@SQL)           
  end            
 If @nfoflg ='Y'            
  Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   EXEC(@@SQL)          
print (@@SQL)           
  end            
 end            
            
---------------------------------------            
IF @REPORTNAME = 'PARTY'            
 begin            
 If @nseflg ='Y'            
 Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   PRINT(@@SQL)           
   EXEC(@@SQL)          
 end            
 If @bseflg = 'Y'            
 Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'              
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
PRINT(@@SQL)             
EXEC(@@SQL)          
 end            
 If @nfoflg ='Y'            
 Begin            
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'            
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +
  
 ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''          
   PRINT(@@SQL)           
   EXEC(@@SQL)          
 end            
end            
---------------------------------------------          
          
IF @REPORTNAME = 'BRANCH'            
 Begin            
            
Print 'vin'        
        
 Select ISNULL(BRANCH_CODE,''), BRANCH,ISNULL(SUM(NSEVAMT), 0) AS NSEL,ISNULL(SUM(BSEVAMT), 0) AS BSEL,ISNULL(SUM(NFOVAMT), 0) AS NFOL,ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,          
 ISNULL(SUM(NSEMAMT), 0) AS NSEM,ISNULL(SUM(BSEMAMT), 0) AS BSEM,ISNULL(SUM(NFOMAMT), 0) AS NFOL,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT,          
 ISNULL(SUM(NSEUNREALISED), 0) AS NSEU , ISNULL(SUM(BSEUNREALISED), 0) AS BSEU , ISNULL(SUM(NFOUNREALISED), 0) AS NFOU ,ISNULL(SUM(UNREALISED), 0) AS UNREALISED ,           
 ISNULL(SUM(NSEHTOTAL), 0) AS NSEH,ISNULL(SUM(BSEHTOTAL), 0) AS BSEH,ISNULL(SUM(NFOHTOTAL), 0) AS NHOH,ISNULL(SUM(HTOTAL), 0) AS HTOTAL           
          
from NEWPARTYLEDGER1             
            
 GROUP BY BRANCH_CODE, BRANCH            
 Order BY BRANCH_CODE, BRANCH            
 COMPUTE SUM(ISNULL(SUM(NSEVAMT), 0)),SUM(ISNULL(SUM(BSEVAMT), 0)),SUM(ISNULL(SUM(NFOVAMT), 0)),SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(NSEMAMT), 0)) , SUM(ISNULL(SUM(BSEMAMT), 0)) , SUM(ISNULL(SUM(NFOMAMT), 0)) , SUM(ISNULL(SUM(MAMT), 0)) , SUM(ISNULL 
  
    
     
(        
          
SUM(NSEUNREALISED), 0)) ,SUM(ISNULL(SUM(BSEUNREALISED), 0)) ,SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,SUM(ISNULL(SUM(UNREALISED), 0)) , SUM(ISNULL(SUM(BSEHTOTAL), 0)),SUM(ISNULL(SUM(NSEHTOTAL), 0)),SUM(ISNULL(SUM(NFOHTOTAL), 0)),SUM(ISNULL(SUM(HTOTAL), 0))    
  
    
      
        
end            
          
DECLARE          
@@SQL1 AS VARCHAR(200),          
@@SQL2 AS VARCHAR(200),          
@@SQL3 AS VARCHAR(200),          
@@SQL4 AS VARCHAR(200),          
@@SQL5 AS VARCHAR(200),          
@@SQL6 AS VARCHAR(200),          
@@SQL7 AS VARCHAR(200),          
@@SQL8 AS VARCHAR(200),          
@@SQL9 AS VARCHAR(200),          
@@SQL10 AS VARCHAR(200),          
@@SQLCOMPUTE1 AS VARCHAR(200),          
@@SQLCOMPUTE2 AS VARCHAR(200),          
@@SQLCOMPUTE3 AS VARCHAR(200),          
@@SQLCOMPUTE4 AS VARCHAR(200),          
@@SQLFIN AS VARCHAR(2000)          
          
select @@SQL1 =''          
select @@SQL2 =''          
select @@SQL3 =''          
select @@SQL4 =''          
select @@SQLCOMPUTE1 =''          
select @@SQLCOMPUTE2 =''          
select @@SQLCOMPUTE3 =''          
select @@SQLCOMPUTE4 =''          
          
if @nseflg = 'Y'          
 begin          
 select @@SQL1 = 'ISNULL(SUM(NSEVAMT), 0) AS NSEL,'          
 select @@SQL2 = 'ISNULL(SUM(NSEMAMT), 0) AS NSEM,'          
 select @@SQL3 = 'ISNULL(SUM(NSEUNREALISED), 0) AS NSEU,'          
 select @@SQL4 = 'ISNULL(SUM(NSEHTOTAL), 0) AS NSEH,'          
 select @@SQLCOMPUTE1 = 'SUM(ISNULL(SUM(NSEVAMT), 0)),'          
 select @@SQLCOMPUTE2 = 'SUM(ISNULL(SUM(NSEMAMT), 0)),'          
 select @@SQLCOMPUTE3 = 'SUM(ISNULL(SUM(NSEUNREALISED), 0)),'          
 select @@SQLCOMPUTE4 = 'SUM(ISNULL(SUM(NSEHTOTAL), 0)),'          
 end          
          
if @bseflg = 'Y'            
   begin          
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(BSEVAMT), 0) AS BSEL,'          
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(BSEMAMT), 0) AS BSEM,'          
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(BSEUNREALISED), 0) AS BSEU,'          
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NSEHTOTAL), 0) AS BSEH,'          
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(BSEVAMT), 0)),'          
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(BSEMAMT), 0)),'          
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(BSEUNREALISED), 0)),'          
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NSEHTOTAL), 0)),'          
   end          
           
if @nfoflg = 'Y'            
    begin          
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(NFOVAMT), 0) AS NFOL,'          
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(NFOMAMT), 0) AS NFOM,'          
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(NFOUNREALISED), 0) AS NFOU,'          
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NFOHTOTAL), 0) AS NFOH,'          
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(NFOVAMT), 0)) ,'          
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(NFOMAMT), 0)) ,'          
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,'          
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NFOHTOTAL), 0)),'          
 end          
           
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,'          
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT,'          
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(UNREALISED), 0) AS UNREALISED,'          
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(HTOTAL), 0) AS HTOTAL'          
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(VAMT), 0)),'          
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(MAMT), 0)),'          
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(UNREALISED), 0)),'          
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(HTOTAL), 0))'          
          
            
IF @REPORTNAME = 'AREA'            
 begin            
  select @@SQLFIN =  'select  AREA, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4          
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '              
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''        
  select @@SQLFIN = @@SQLFIN + 'GROUP BY AREA, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'Order BY AREA, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4          
end            
            
            
            
IF @REPORTNAME = 'REGION'            
 begin            
  select @@SQLFIN =  'select REGION, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4          
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '              
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''        
  select @@SQLFIN = @@SQLFIN + 'GROUP BY REGION, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'Order BY REGION, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4          
end            
            
            
IF @REPORTNAME = 'SUBBROKER'            
 begin            
  select @@SQLFIN =  'select SUB_BROKER, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4          
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '              
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''        
  select @@SQLFIN = @@SQLFIN + 'GROUP BY SUB_BROKER, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'Order BY SUB_BROKER, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4          
end            
            
            
            
IF @REPORTNAME = 'TRADER'            
 begin            
  select @@SQLFIN =  'select TRADER, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4          
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '              
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''        
  select @@SQLFIN = @@SQLFIN + 'GROUP BY TRADER, BRANCH '           
  select @@SQLFIN = @@SQLFIN + 'ORDER BY TRADER, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4          
end            
            
            
            
IF @REPORTNAME = 'FAMILY'            
 begin            
  select @@SQLFIN =  'select FAMILY, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4           
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '              
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''        
  select @@SQLFIN = @@SQLFIN + 'GROUP BY FAMILY, BRANCH '           
  select @@SQLFIN = @@SQLFIN + 'ORDER BY FAMILY, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4          
end            
            
            
            
IF @REPORTNAME = 'PARTY'            
 begin            
--select * from NEWPARTYLEDGER1             
  select @@SQLFIN =  'select CLTCODE, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4           
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '              
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''        
  select @@SQLFIN = @@SQLFIN + 'GROUP BY CLTCODE, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'ORDER BY CLTCODE, BRANCH '            
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4          
end            
PRINT @@SQLFIN          
EXEC (@@SQLFIN)            
            
           
            
--DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID          
        
DELETE FROM NEWPARTYLEDGER1 WHERE SESSIONID = @SESSIONID        
            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_ALL_1
-- --------------------------------------------------
--use account    
--sp_helptext RPT_PARTYLEDGER_SUMMARY_ALL     
 --Exec RPT_PARTYLEDGER_SUMMARY_ALL 'Jun 17 2007','Sep 25 2007','Apr  1 2007','Mar 31 2008','broker','broker','Vdt','0A146','0A146','PARTY','Y','Y','Y'        
        
 /* *****************************************************************************************************          
 THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH          
 IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.          
 THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.          
 CREATED BY := GAUREE MAHAJAN          
 CREATED DATE := AUGUEST 31 2007          
 MODIFIED DATE := SEPTEMBER 24 2007          
 DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX          
 SYNTAX AS FOLLOWS -----          
 EXEC RPT_PARTYLEDGER_SUMMARY_ALL 'APR  1 2007', 'AUG 31 2007', 'APR  1 2007', 'MAR 31 2008', 'BROKER', 'BROKER', 'VDT', '000', 'ZZZ', 'FAMILY','Y','Y','Y'          
 EXEC RPT_PARTYLEDGER_SUMMARY_ALL 'APR  1 2007', 'AUG 31 2007', 'APR  1 2007', 'MAR 31 2008', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA','Y','Y','Y'          
 EXEC RPT_PARTYLEDGER_SUMMARY_ALL 'APR  1 2007', 'AUG 31 2007', 'APR  1 2007', 'MAR 31 2008','REGION', 'AHM', 'VDT', 'APS', 'ZPS','Y','N','N'          
          
          
 *****************************************************************************************************          
*/          
          
CREATE PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_ALL_1]          
 @FDATE VARCHAR(11),          
 @TDATE VARCHAR(11),          
 @STDDATE VARCHAR(11),          
 @LSTDATE VARCHAR(11),          
 @STATUSID VARCHAR(20),          
 @STATUSNAME VARCHAR(20),          
 @DISPLAYRPT VARCHAR(3),          
 @FPARTY VARCHAR(10),          
 @TPARTY VARCHAR(10),          
 @REPORTNAME VARCHAR(100),          
 @nseflg varchar(1)  ,              
 @bseflg varchar(1)  ,              
 @nfoflg varchar(1) ,     
 @nsxfoflg varchar(1) ,       
 @SESSIONID VARCHAR(10)      
          
          
AS          
BEGIN          
DECLARE          
@@SQL AS VARCHAR(2000),          
@@RECCOUNTER AS NUMERIC,          
@@SHAREDB AS VARCHAR(25),          
@@OBJID AS INT,          
@@ACCNSESERV AS  VARCHAR(25),         
@@ACCBSESERV AS  VARCHAR(25),         
@@ACCNFOSERV AS  VARCHAR(25),         
@@ACCNCURFOSERV AS  VARCHAR(25),  
@@ACCNSEDB AS  VARCHAR(25),         
@@ACCNCURFODB AS  VARCHAR(25),  
@@ACCBSEDB AS  VARCHAR(25),         
@@ACCNFODB AS  VARCHAR(25)      
        
        
        
select @@ACCNSEDB = AccountDb,@@ACCNSESERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'NSE' and Segment = 'CAPITAL'        
select @@ACCBSEDB =AccountDb,@@ACCBSESERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'BSE' and Segment = 'CAPITAL'        
select @@ACCNFODB =AccountDb,@@ACCNFOSERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'NSE' and Segment = 'FUTURES'        
select @@ACCNCURFODB =AccountDb,@@ACCNCURFOSERV = AccountServer from pradnya.dbo.multicompany where Exchange = 'NSX' and Segment = 'FUTURES'        
        
Select @@ACCNSESERV = '[' + @@ACCNSESERV + ']'        
Select @@ACCBSESERV = '[' + @@ACCBSESERV + ']'        
Select @@ACCNFOSERV = '[' + @@ACCNFOSERV + ']'        
Select @@ACCNCURFOSERV = '[' + @@ACCNCURFOSERV + ']'        
        
        
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER1'), 0)          
IF @@OBJID = 0          
 BEGIN          
  EXEC CREATEPARTYLEDGER_new          
 END          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
          
DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID          
      
          
--SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER          
          
          
IF @REPORTNAME = 'BRANCH'          
 Begin          
 If @nseflg ='Y'          
  Begin          
 Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'           
 Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC( @@SQL)        
  end          
 If @bseflg = 'Y'          
  Begin          
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'           
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
    EXEC( @@SQL)        
  End          
 If @nfoflg ='Y'          
  Begin          
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC( @@SQL)           
  end          
If @nsxfoflg ='Y'          
  Begin          
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +  ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC( @@SQL)           
  end          
end          
-------------------------------          
IF @REPORTNAME = 'AREA'          
 begin          
 If @nseflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'             
   Select @@SQL = @@SQL    + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC( @@SQL)             
end          
 If @bseflg = 'Y'          
  Begin          
 Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1(AREA, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'         
 Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC(@@SQL)        
  end          
 If @nfoflg ='Y'          
  Begin          
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'        
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC(@@SQL)    
  end          
If @nsxfoflg ='Y'          
  Begin          
    Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'        
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +  ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC(@@SQL)    
  end          
 end          
----------------------------------          
IF @REPORTNAME = 'REGION'          
 begin          
 If @nseflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end          
 If @bseflg = 'Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
 EXEC(@@SQL)        
  end          
 If @nfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end       
If @nsxfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +  ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end             
end          
--------------------------------          
IF @REPORTNAME = 'SUBBROKER'          
 begin          
 If @nseflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'            
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end          
 If @bseflg = 'Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end          
 If @nfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end         
If @nsxfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +   ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end      
 end          
          
-----------------------------------          
          
IF @REPORTNAME = 'TRADER'          
 begin          
 If @nseflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'              
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end          
 If @bseflg = 'Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'          
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end          
 If @nfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'          
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
 end       
If @nsxfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'          
    Select @@SQL = @@SQL  + 'Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +  ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
 end             
end          
-----------------------------------          
          
          
IF @REPORTNAME = 'FAMILY'          
 begin          
 If @nseflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'              
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
 end          
 If @bseflg = 'Y'          
  Begin          
  Select @@SQL = ' INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'           
  Select @@SQL = @@SQL  + 'Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end          
 If @nfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end         
If @nsxfoflg ='Y'          
  Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + 'Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +   ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   EXEC(@@SQL)        
  end       
 end          
          
---------------------------------------          
IF @REPORTNAME = 'PARTY'          
 begin          
 If @nseflg ='Y'          
 Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NSEVAMT,VAMT,NSEMAMT,MAMT, NSEUNREALISED,UNREALISED,NSEHTOTAL,HTOTAL,SESSIONID)'           
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNSESERV + '.' + @@ACCNSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   PRINT(@@SQL)         
   EXEC(@@SQL)        
 end          
 If @bseflg = 'Y'          
 Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,BSEVAMT,VAMT,BSEMAMT,MAMT,BSEUNREALISED,UNREALISED,BSEHTOTAL,HTOTAL,SESSIONID)'            
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCBSESERV + '.' + @@ACCBSEDB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
PRINT(@@SQL)           
EXEC(@@SQL)        
 end       
 If @nfoflg ='Y'          
 Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'          
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNFOSERV + '.' + @@ACCNFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +  ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   PRINT(@@SQL)         
   EXEC(@@SQL)        
 end          
 If @nsxfoflg ='Y'          
 Begin          
   Select @@SQL = 'INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH,NFOVAMT,VAMT,NFOMAMT,MAMT,NFOUNREALISED, UNREALISED,NFOHTOTAL,HTOTAL,SESSIONID)'          
   Select @@SQL = @@SQL  + ' Exec ' + @@ACCNCURFOSERV + '.' + @@ACCNCURFODB  + '.DBO.RPT_PARTYLEDGER_SUMMARY_V3_new ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' + @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT +  ''',''' + @FPARTY + ''',''' + @TPARTY + ''',''' + @REPORTNAME + ''',''' +  @SESSIONID + ''''        
   PRINT(@@SQL)         
   EXEC(@@SQL)        
 end          
end          
---------------------------------------------        
        
IF @REPORTNAME = 'BRANCH'          
 Begin          
          
 Select BRANCH_CODE, BRANCH,ISNULL(SUM(NSEVAMT), 0) AS NSEL,ISNULL(SUM(BSEVAMT), 0) AS BSEL,ISNULL(SUM(NFOVAMT), 0) AS NFOL,ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,        
 ISNULL(SUM(NSEMAMT), 0) AS NSEM,ISNULL(SUM(BSEMAMT), 0) AS BSEM,ISNULL(SUM(NFOMAMT), 0) AS NFOL,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT,     ISNULL(SUM(NSEUNREALISED), 0) AS NSEU , ISNULL(SUM(BSEUNREALISED), 0) AS BSEU , ISNULL(SUM(NFOUNREALISED), 0) AS NFOU ,ISNULL(SUM(UNREALISED), 0) AS UNREALISED ,         
 ISNULL(SUM(NSEHTOTAL), 0) AS NSEH,ISNULL(SUM(BSEHTOTAL), 0) AS BSEH,ISNULL(SUM(NFOHTOTAL), 0) AS NHOH,ISNULL(SUM(HTOTAL), 0) AS HTOTAL         
        
from NEWPARTYLEDGER1           
          
 GROUP BY BRANCH_CODE, BRANCH          
 Order BY BRANCH_CODE, BRANCH          
 COMPUTE SUM(ISNULL(SUM(NSEVAMT), 0)),SUM(ISNULL(SUM(BSEVAMT), 0)),SUM(ISNULL(SUM(NFOVAMT), 0)),SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(NSEMAMT), 0)) , SUM(ISNULL(SUM(BSEMAMT), 0)) , SUM(ISNULL(SUM(NFOMAMT), 0)) , SUM(ISNULL(SUM(MAMT), 0)) , SUM(ISNULL(SUM(NSEUNREALISED), 0)) ,SUM(ISNULL(SUM(BSEUNREALISED), 0)) ,SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,SUM(ISNULL(SUM(UNREALISED), 0)) , SUM(ISNULL(SUM(BSEHTOTAL), 0)),SUM(ISNULL(SUM(NSEHTOTAL), 0)),SUM(ISNULL(SUM(NFOHTOTAL), 0)),SUM(ISNULL(SUM(HTOTAL), 0))    
  
    
      
end          
        
DECLARE        
@@SQL1 AS VARCHAR(200),        
@@SQL2 AS VARCHAR(200),        
@@SQL3 AS VARCHAR(200),        
@@SQL4 AS VARCHAR(200),        
@@SQLCOMPUTE1 AS VARCHAR(200),        
@@SQLCOMPUTE2 AS VARCHAR(200),        
@@SQLCOMPUTE3 AS VARCHAR(200),        
@@SQLCOMPUTE4 AS VARCHAR(200),        
@@SQLFIN AS VARCHAR(2000)        
        
select @@SQL1 =''        
select @@SQL2 =''        
select @@SQL3 =''        
select @@SQL4 =''        
select @@SQLCOMPUTE1 =''        
select @@SQLCOMPUTE2 =''        
select @@SQLCOMPUTE3 =''        
select @@SQLCOMPUTE4 =''        
        
if @nseflg = 'Y'        
 begin        
 select @@SQL1 = 'ISNULL(SUM(NSEVAMT), 0) AS NSEL,'        
 select @@SQL2 = 'ISNULL(SUM(NSEMAMT), 0) AS NSEM,'        
 select @@SQL3 = 'ISNULL(SUM(NSEUNREALISED), 0) AS NSEU,'        
 select @@SQL4 = 'ISNULL(SUM(NSEHTOTAL), 0) AS NSEH,'        
 select @@SQLCOMPUTE1 = 'SUM(ISNULL(SUM(NSEVAMT), 0)),'        
 select @@SQLCOMPUTE2 = 'SUM(ISNULL(SUM(NSEMAMT), 0)),'        
 select @@SQLCOMPUTE3 = 'SUM(ISNULL(SUM(NSEUNREALISED), 0)),'        
 select @@SQLCOMPUTE4 = 'SUM(ISNULL(SUM(NSEHTOTAL), 0)),'        
 end        
        
if @bseflg = 'Y'          
   begin        
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(BSEVAMT), 0) AS BSEL,'        
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(BSEMAMT), 0) AS BSEM,'        
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(BSEUNREALISED), 0) AS BSEU,'        
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NSEHTOTAL), 0) AS BSEH,'        
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(BSEVAMT), 0)),'        
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(BSEMAMT), 0)),'        
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(BSEUNREALISED), 0)),'        
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NSEHTOTAL), 0)),'        
   end        
         
if @nfoflg = 'Y'          
    begin        
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(NFOVAMT), 0) AS NFOL,'        
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(NFOMAMT), 0) AS NFOM,'        
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(NFOUNREALISED), 0) AS NFOU,'        
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NFOHTOTAL), 0) AS NFOH,'        
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(NFOVAMT), 0)) ,'        
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(NFOMAMT), 0)) ,'        
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,'        
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NFOHTOTAL), 0)),'        
 end       
    
if @nsxfoflg = 'Y'          
    begin        
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(NFOVAMT), 0) AS NFOL,'        
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(NFOMAMT), 0) AS NFOM,'        
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(NFOUNREALISED), 0) AS NFOU,'        
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(NFOHTOTAL), 0) AS NFOH,'        
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(NFOVAMT), 0)) ,'        
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(NFOMAMT), 0)) ,'        
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(NFOUNREALISED), 0)) ,'        
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(NFOHTOTAL), 0)),'        
 end      
         
  select @@SQL1 = @@SQL1 + 'ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,'        
  select @@SQL2 = @@SQL2 + 'ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT,'        
  select @@SQL3 = @@SQL3 + 'ISNULL(SUM(UNREALISED), 0) AS UNREALISED,'        
  select @@SQL4 = @@SQL4 + 'ISNULL(SUM(HTOTAL), 0) AS HTOTAL'        
  select @@SQLCOMPUTE1 = @@SQLCOMPUTE1 + 'SUM(ISNULL(SUM(VAMT), 0)),'        
  select @@SQLCOMPUTE2 = @@SQLCOMPUTE2 + 'SUM(ISNULL(SUM(MAMT), 0)),'        
  select @@SQLCOMPUTE3 = @@SQLCOMPUTE3 + 'SUM(ISNULL(SUM(UNREALISED), 0)),'        
  select @@SQLCOMPUTE4 = @@SQLCOMPUTE4 + 'SUM(ISNULL(SUM(HTOTAL), 0))'        
        
          
IF @REPORTNAME = 'AREA'          
 begin          
  select @@SQLFIN =  'select  AREA, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4        
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '            
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''      
  select @@SQLFIN = @@SQLFIN + 'GROUP BY AREA, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'Order BY AREA, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4        
end          
          
          
          
IF @REPORTNAME = 'REGION'          
 begin          
  select @@SQLFIN =  'select REGION, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4        
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '            
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''      
  select @@SQLFIN = @@SQLFIN + 'GROUP BY REGION, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'Order BY REGION, BRANCH '        
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4        
end          
          
          
IF @REPORTNAME = 'SUBBROKER'          
 begin          
  select @@SQLFIN =  'select SUB_BROKER, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4        
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '            
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''      
  select @@SQLFIN = @@SQLFIN + 'GROUP BY SUB_BROKER, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'Order BY SUB_BROKER, BRANCH '        
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4        
end          
          
          
          
IF @REPORTNAME = 'TRADER'          
 begin          
  select @@SQLFIN =  'select TRADER, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4        
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '            
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''      
  select @@SQLFIN = @@SQLFIN + 'GROUP BY TRADER, BRANCH '         
  select @@SQLFIN = @@SQLFIN + 'ORDER BY TRADER, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4        
end          
          
          
          
IF @REPORTNAME = 'FAMILY'          
 begin          
  select @@SQLFIN =  'select FAMILY, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4         
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '            
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''      
  select @@SQLFIN = @@SQLFIN + 'GROUP BY FAMILY, BRANCH '         
  select @@SQLFIN = @@SQLFIN + 'ORDER BY FAMILY, BRANCH '        
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4        
end          
          
          
          
IF @REPORTNAME = 'PARTY'          
 begin          
--select * from NEWPARTYLEDGER1           
  select @@SQLFIN =  'select CLTCODE, BRANCH,' + @@SQL1 + @@SQL2 + @@SQL3 + @@SQL4         
  select @@SQLFIN = @@SQLFIN + ' from NEWPARTYLEDGER1 '            
  select @@SQLFIN = @@SQLFIN + ' WHERE  SESSIONID =  '''   + @SESSIONID + ''''      
  select @@SQLFIN = @@SQLFIN + 'GROUP BY CLTCODE, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'ORDER BY CLTCODE, BRANCH '          
  select @@SQLFIN = @@SQLFIN + 'COMPUTE ' + @@SQLCOMPUTE1 + @@SQLCOMPUTE2 + @@SQLCOMPUTE3 + @@SQLCOMPUTE4        
end          
PRINT @@SQLFIN        
EXEC (@@SQLFIN)          
          
          
           
          
          
--DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID        
      
DELETE FROM NEWPARTYLEDGER1 WHERE SESSIONID = @SESSIONID      
          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V3
-- --------------------------------------------------
CREATE PROC RPT_PARTYLEDGER_SUMMARY_V3  
 @FDATE VARCHAR(11),  
 @TDATE VARCHAR(11),  
 @STDDATE VARCHAR(11),  
 @LSTDATE VARCHAR(11),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(20),  
 @DISPLAYRPT VARCHAR(3),  
 @FPARTY VARCHAR(10),  
 @TPARTY VARCHAR(10),
 @REPORTNAME VARCHAR(100)
  
AS  
  
DECLARE  
@@SQL AS VARCHAR(2000),  
@@RECCOUNTER AS NUMERIC,  
@@SHAREDB AS VARCHAR(25),  
@@OBJID AS INT  
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)  
IF @@OBJID = 0  
 BEGIN  
  EXEC CREATEPARTYLEDGER  
 END  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
  
SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER  
  
IF @REPORTNAME = 'BRANCH'  
 BEGIN  
  IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERT LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'BROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
     END  
    ELSE IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"  
     END  
    EXEC (@@SQL)  
    
    --INSERT MARGINLEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'BROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
     END  
    ELSE IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"  
     END  
    PRINT @@SQL  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT BRANCH_CODE, BRANCH, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0  
      FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + ", ISNULL(SUM(UNREALISED), 0) AS UNREALISED "  
--     END  
    SELECT @@SQL = @@SQL + ", ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)) "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(UNREALISED), 0)) "  
--     END  
    SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT @@SQL  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'AREA'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT AREA, BRANCH AS AREANAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'REGION'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT REGION, BRANCH AS REGIONNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'SUBBROKER'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT SUB_BROKER, BRANCH AS SUBNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'TRADER'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "  
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT TRADER, BRANCH AS TRADERNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'FAMILY'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT FAMILY, BRANCH AS FAMILYNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
  
IF @REPORTNAME = 'PARTY'  
 BEGIN  
  IF @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'CLIENT'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'CLIENT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
	IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'CLIENT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT CLTCODE, BRANCH AS LONG_NAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT CLTCODE, BRANCH AS LONG_NAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
	
    SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH "
	SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V3_new
-- --------------------------------------------------
CREATE  PROC [dbo].[RPT_PARTYLEDGER_SUMMARY_V3_new]      
 @FDATE VARCHAR(11),      
 @TDATE VARCHAR(11),      
 @STDDATE VARCHAR(11),      
 @LSTDATE VARCHAR(11),      
 @STATUSID VARCHAR(20),      
 @STATUSNAME VARCHAR(20),      
 @DISPLAYRPT VARCHAR(3),      
 @FPARTY VARCHAR(10),      
 @TPARTY VARCHAR(10),      
 @REPORTNAME VARCHAR(100),    
 @SESSIONID VARCHAR(10)       
-- @SPID INT ,   
      
AS      
      
DECLARE      
@@SQL AS VARCHAR(2000),      
@@RECCOUNTER AS NUMERIC,      
@@SHAREDB AS VARCHAR(25),      
@@OBJID AS INT      
  
    
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER1'), 0)      
IF @@OBJID = 0      
 BEGIN      
  EXEC CREATEPARTYLEDGER_new      
 END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    
      
SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER      
      
IF @REPORTNAME = 'BRANCH'      
 BEGIN      
  IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'      
   BEGIN      
 PRINT CONVERT(VARCHAR,@@SPID)  
    --INSERT LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID , SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
    SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
    /*IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END    */  
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
       
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'BROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
     END      
    ELSE IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"      
     END      
  
 SELECT @@SQL = @@SQL + "INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID , SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, VAMT = 0, "      
 IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
       
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "      
    /*IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END    */  
    IF @STATUSID = 'BROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
     END      
    ELSE IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"      
     END    
    EXEC (@@SQL)      
        
    --INSERT MARGINLEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
   SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'BROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
     END      
    ELSE IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"      
     END      
    PRINT @@SQL      
    EXEC (@@SQL)      
-------------------------------------------------------------------------------        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
-----------------------------------------      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT BRANCH_CODE, BRANCH,SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0,SESSIONID      
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
    SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL , SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH , SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "      
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)) "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
--      SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(UNREALISED), 0)) "      
--     END      
--    SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT @@SQL      
    EXEC (@@SQL)      
-----------------------------------------      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
  ELSE      
   BEGIN      
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'      
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END      
      
IF @REPORTNAME = 'AREA'      
 BEGIN      
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'      
   BEGIN      
    --INSERTING NORMAL LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID , SESSIONID ) "      
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "      
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    --INSERTING MARGIN LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID , SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "      
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "      
    SELECT @@SQL = @@SQL + "LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "      
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
        
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT AREA, BRANCH AS AREANAME,SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0 ,SESSIONID          
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
      
    SELECT @@SQL = "SELECT AREA, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
      
          
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH, SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "      
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
--      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "      
--     END      
--    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
  ELSE      
   BEGIN      
  PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'      
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END      
      
IF @REPORTNAME = 'REGION'      
 BEGIN      
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'      
   BEGIN      
    --INSERTING NORMAL LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
     
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "      
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
     
    --INSERTING MARGIN LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "      
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
     
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "      
    SELECT @@SQL = @@SQL + "LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "      
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
        
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT REGION, BRANCH AS REGIONNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0,SESSIONID          
       FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
   SELECT @@SQL = "SELECT REGION, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH, SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "      
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
    --  SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "      
--     END      
    --SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
  ELSE      
   BEGIN      
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'      
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END      
      
IF @REPORTNAME = 'SUBBROKER'      
 BEGIN      
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'      
   BEGIN      
    --INSERTING NORMAL LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "      
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    --INSERTING MARGIN LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "      
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "      
    SELECT @@SQL = @@SQL + "LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "      
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
        
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT SUB_BROKER, BRANCH AS SUBNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0 ,SESSIONID      
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
   SELECT @@SQL = "SELECT SUB_BROKER, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH, SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "      
   -- SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
    --  SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "      
--     END      
   -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
  ELSE      
   BEGIN      
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'      
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END      
      
IF @REPORTNAME = 'TRADER'      
 BEGIN      
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'      
   BEGIN      
    --INSERTING NORMAL LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN     
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "      
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    --INSERTING MARGIN LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "      
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "      
    SELECT @@SQL = @@SQL + "LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "      
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT TRADER, BRANCH AS TRADERNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0, SESSIONID       
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
    SELECT @@SQL = "SELECT TRADER, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH, SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "      
  --  SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
  -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "      
--     END      
   -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
  ELSE      
   BEGIN      
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'      
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END      
      
IF @REPORTNAME = 'FAMILY'      
 BEGIN      
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'      
   BEGIN      
    --INSERTING NORMAL LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "      
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'FAMILY'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "      
     END      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    --INSERTING MARGIN LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "      
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
   
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
   
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "      
    SELECT @@SQL = @@SQL + "LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "      
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'FAMILY'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "      
     END      
        
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT FAMILY, BRANCH AS FAMILYNAME, SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0 ,SESSIONID           
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
   SELECT @@SQL = "SELECT FAMILY, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH, SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "      
    --SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
    --  SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "      
--     END      
    --SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END      
      
      
IF @REPORTNAME = 'PARTY'      
BEGIN      
  IF @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'CLIENT'      
   BEGIN      
    --INSERTING NORMAL LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "      
 SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
    /*IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END    */  
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'FAMILY'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'CLIENT'     
    BEGIN      
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "      
     END      
  
 SELECT @@SQL = @@SQL + "INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, VAMT = 0, "      
 IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "      
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    /*IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END    */  
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'FAMILY'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'CLIENT'     
    BEGIN      
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "      
     END      
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    --INSERTING MARGIN LEDGER RECORDS      
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER1 (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID, SESSIONID) "      
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "      
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "      
     END      
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, " + CONVERT(VARCHAR,@@SPID) + ", " + @SESSIONID     
    
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "      
    SELECT @@SQL = @@SQL + "LEDGER L "      
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "      
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "      
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "      
    IF @DISPLAYRPT = 'VDT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    ELSE      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "      
     END      
    IF @STATUSID = 'AREA'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'REGION'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'BRANCH'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'SUBBROKER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'TRADER'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'FAMILY'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "      
     END      
    ELSE IF @STATUSID = 'CLIENT'      
     BEGIN      
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "      
     END      
        
    PRINT (@@SQL)      
    EXEC (@@SQL)      
        
    IF @DISPLAYRPT = 'EDT'      
     BEGIN      
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR      
      --INSTEAD OF GIVING REVERSAL EFFECT      
      --THIS SAVES UNION JOIN      
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER1 WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "      
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"      
      EXEC (@@SQL)      
     END      
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
    IF @@RECCOUNTER <= 0      
     BEGIN      
      SELECT CLTCODE, BRANCH AS LONG_NAME,SECTORAMOUNT = 0, LEDGERAMOUNT = 0,SECTORMARGIN =0 ,MARGINAMOUNT = 0,SECTORUNREALISED = 0, UNREALISED = 0, SECTORTOTAL= 0,HTOTAL = 0,SESSIONID      
      FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
      RETURN      
     END      
    SELECT @@SQL = "SELECT CLTCODE, BRANCH,ISNULL(SUM(VAMT), 0) AS SECTORAMOUNT, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT,ISNULL(SUM(MAMT), 0) AS SECTORMARGIN ,ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"      
    SELECT @@SQL = @@SQL + ",  ISNULL(SUM(UNREALISED), 0) AS SECTORUNREALISED,ISNULL(SUM(UNREALISED), 0) AS UNREALISED "      
    SELECT @@SQL = @@SQL + ",ISNULL(SUM(VAMT + MAMT), 0) AS SECTORTOTAL, ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL, SESSIONID "      
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER1 "      
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "      
    SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH, SESSIONID "      
    SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "      
   -- SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "      
/*    IF @DISPLAYRPT = 'VDT'      
     BEGIN*/      
   --   SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "      
--     END      
   -- SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "      
    PRINT (@@SQL)      
   EXEC (@@SQL)      
    DELETE FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
  ELSE      
   BEGIN      
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'      
    SELECT * FROM NEWPARTYLEDGER1 WHERE SPID = @@SPID      
   END      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS
-- --------------------------------------------------

CREATE PROC RPT_RETURNFIELDS      
 @STATUSID VARCHAR(20),      
 @SUMMARYOPT CHAR(1),      
 @REPORTNAME VARCHAR(15)  
  
AS      
      
DECLARE      
@@RETURNFIELDS AS VARCHAR(1000)      
      
 SELECT  
  RETURNFIELDS
 FROM      
   TBL_MASTER_PARTYLEDGER      
 WHERE      
   REPORTNAME = @REPORTNAME      
   AND STATUSID = @STATUSID      
   AND SUMMARYOPT = @SUMMARYOPT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS_ALL
-- --------------------------------------------------


CREATE PROC RPT_RETURNFIELDS_ALL
/*
	EXEC RPT_RETURNFIELDS_ALL 'BROKER', 'S', 'PARTY', 'Y', 'N', 'Y', 'N', 'Y'
*/
	@STATUSID VARCHAR(10),
	@SUMMARYOPT VARCHAR(1),
	@RPTNAME VARCHAR(20),
	@NSE VARCHAR(1),
	@BSE VARCHAR(1),
	@NSEFO VARCHAR(1),
	@NCX VARCHAR(1),
	@MCX VARCHAR(1)
AS

DECLARE
	@@SQL AS VARCHAR(2000)

SET NOCOUNT ON

SELECT @@SQL = "SELECT RETURNFLDS = FIRSTPART "
IF @NSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ NSEPART "
	END
IF @BSE = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ BSEPART "
	END
IF @NSEFO = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ NSEFOPART "
	END
IF @NCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ NCXPART "
	END
IF @MCX = 'Y'
	BEGIN
		SELECT @@SQL = @@SQL + "+ MCXPART "
	END

SELECT @@SQL = LTRIM(RTRIM(@@SQL))

SELECT @@SQL = @@SQL + " FROM TBL_MASTER_PARTYLEDGER_ALL "
SELECT @@SQL = @@SQL + "WHERE REPORTNAME = '" + @RPTNAME + "' "
SELECT @@SQL = @@SQL + "AND STATUSID = '" + @STATUSID + "' "
SELECT @@SQL = @@SQL + "AND SUMMARYOPT = '" + @SUMMARYOPT + "'"

--PRINT (@@SQL)
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS_new
-- --------------------------------------------------

Create PROC [dbo].[RPT_RETURNFIELDS_new]      
 @STATUSID VARCHAR(20),      
 @SUMMARYOPT CHAR(1),      
 @REPORTNAME VARCHAR(15)  
  
AS      
      
DECLARE      
@@RETURNFIELDS AS VARCHAR(1000)      
      
 SELECT  
  RETURNFIELDS
 FROM      
   TBL_MASTER_PARTYLEDGER_new      
 WHERE      
   REPORTNAME = @REPORTNAME      
   AND STATUSID = @STATUSID      
   AND SUMMARYOPT = @SUMMARYOPT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_todaydate
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 06/24/2004 8:32:39 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 05/10/2004 5:29:46 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 01/14/2002 20:39:23 ******/  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 01/04/1980 1:40:42 AM ******/  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 11/28/2001 12:23:51 PM ******/  
  
  
  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 2/17/01 5:19:55 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 3/21/01 12:50:24 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 20-Mar-01 11:39:03 PM ******/  
  
  
  
CREATE PROCEDURE rpt_todaydate  
AS  
select convert(varchar,getdate(),103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_todaydate1
-- --------------------------------------------------
Create Procedure Rpt_todaydate1
As
Select Convert(varchar(11),getdate(),109)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_UserRights
-- --------------------------------------------------

CREATE Procedure [dbo].[Rpt_UserRights]

   @voucher_type Varchar(2)

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT 

	U.UserCategory,
	U.UserStatusId,
	vtyp = convert(varchar, U.vtyp) +' ' + V.Vdesc,
	Booktype = convert(varchar, U.Booktype) +' ' + B.Description,
	U.NoDays,
	U.NoDaysD 

FROM 

	userrights U (nolock),
	vmast V (nolock),
	Booktype B (nolock),
	msajag.dbo.tblcategory T (nolock)

WHERE

	 U.vtyp = @voucher_type and
	 U.vtyp = V.Vtype and
	 U.Booktype=B.Booktype and
	 U.UserCategory=T.Fldcategorycode 

ORDER BY

	U.UserCategory,
	U.NoDays,
	U.NoDaysD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_VoucherPrinting
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 06/10/2008 12:09:57 PM ******/

/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 06/24/2004 8:32:37 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 05/10/2004 5:29:41 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_VoucherPrinting    Script Date: 04/07/2003 12:28:25 PM ******/  
  
  
CREATE  Proc rpt_VoucherPrinting  
@Vtyp    varchar(2),  
@BookType    varchar(2),  
@FromDate   Varchar(11),  
@ToDate   Varchar(11),  
@VnoFrom   Varchar(12),  
@VnoTo   Varchar(12)  
  
as  
declare  
  
 @@selectqury   as varchar(8000),  
 @@fromtables   as varchar(2000),  
 @@wherepart    as varchar(8000),  
 @@sortby       as varchar(200)  
  
  
   if @VnoFrom <> '' and @VnoTo <> ''   
    begin   
      -- select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'  and l.booktype = '" + @Booktype + "'  
     select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'    
      and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'    
       and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
        
    end  
   else  
    begin  
      -- select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'  and l.booktype = '" + @Booktype + "'  
     select @@wherepart = " where l.Vtyp = '" + @Vtyp + "'   
       and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
    end         
  
  
   if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'    
   begin  
    select @@wherepart = @@wherepart + "  and   cltcode <> '" + @Booktype + "'"   
  
   end  
   else  
   begin  
    select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"  
   end   
  
  
   select @@selectqury = " select distinct l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,  
   cltcode,  acname ,   
   isnull(l.Vamt,0) Vamt,  l.drcr,  l.vtyp, l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
     l.narration, cltcode2 = cltcode, acname2 = acname "  
  
   select @@fromtables = " from Ledger l left outer join ledger1 l1 on  l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "  
  
   select @@sortby = " order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc "  
      
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby )  
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_voucherreport
-- --------------------------------------------------
Create Procedure Rpt_voucherreport
@Fromdt Varchar(15), 
@Todt Varchar(15), 
@Typ Int, 
@Vno Varchar(15)
As
If @Vno = '%'
Begin
If @Typ In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , L1.Ddno, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L, Ledger1 L1
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
And L1.Vtyp = L.Vtyp 
And L.Vno = L1.Vno
Order By L.Vtyp, L.Vno
End
If @Typ Not In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , Ddno = 0, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
Order By L.Vtyp, L.Vno
End
End
If @Vno <> '%'
Begin
If @Typ In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , L1.Ddno, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L, Ledger1 L1
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
And L.Vno = @Vno 
And L1.Vtyp = L.Vtyp 
And L.Vno = L1.Vno
Order By L.Vtyp, L.Vno
End
If @Typ Not In ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
Begin
Select Distinct L.Cltcode, Ltrim(Rtrim(L.Acname)) As Acname , L.Vno, L.Vtyp, 
Left(Convert(Varchar, L.Vdt, 109), 11) As Vdt , Ddno = 0, 
Cramt = Case When L.Drcr = 'C' Then Vamt Else 0 End, 
Dramt = Case When L.Drcr = 'D' Then Vamt Else 0 End, 
Left(Convert(Varchar, L.Edt, 109), 11) As Edt, L.Lno
From Ledger L
Where L.Vdt > = @Fromdt 
And L.Vdt < = @Todt+' 23:59:59' 
And L.Vtyp = @Typ 
And L.Vno = @Vno 
Order By L.Vtyp, L.Vno
End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Searchinall
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Searchinall]       
(@strFind AS VARCHAR(MAX))
AS
BEGIN
    SET NOCOUNT ON; 
    --TO FIND STRING IN ALL PROCEDURES        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) SP_Name
              ,OBJECT_DEFINITION(OBJECT_ID) SP_Definition
        FROM   sys.procedures
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@strFind+'%'
    END 

    --TO FIND STRING IN ALL VIEWS        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) View_Name
              ,OBJECT_DEFINITION(OBJECT_ID) View_Definition
        FROM   sys.views
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@strFind+'%'
    END 

    --TO FIND STRING IN ALL FUNCTION        
    BEGIN
        SELECT ROUTINE_NAME           Function_Name
              ,ROUTINE_DEFINITION     Function_definition
        FROM   INFORMATION_SCHEMA.ROUTINES
        WHERE  ROUTINE_DEFINITION LIKE '%'+@strFind+'%'
               AND ROUTINE_TYPE = 'FUNCTION'
        ORDER BY
               ROUTINE_NAME
    END

    --TO FIND STRING IN ALL TABLES OF DATABASE.    
    BEGIN
        SELECT t.name      AS Table_Name
              ,c.name      AS COLUMN_NAME
        FROM   sys.tables  AS t
               INNER JOIN sys.columns c
                    ON  t.OBJECT_ID = c.OBJECT_ID
        WHERE  c.name LIKE '%'+@strFind+'%'
        ORDER BY
               Table_Name
    END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTION_QUERIES_PROC
-- --------------------------------------------------
--EXEC SELECTION_QUERIES_PROC 'BROKER','%','REGION','%'
CREATE PROC SELECTION_QUERIES_PROC
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(10),
@SELECTON VARCHAR(15),
@SEARCH VARCHAR(10),
@FROMAC VARCHAR(10) = '0000000000',
@TOAC VARCHAR(10) = 'ZZZZZZZZZZ'
AS

DECLARE
@@SELECTIONQUERY AS VARCHAR(500),
@@FINALQUERY AS VARCHAR(500)

DECLARE CUR_SELECTION_PARAMETER CURSOR FOR
	SELECT 
		SELECTIONQUERY
	FROM
		SELECTION_QUERIES_TABLE
	WHERE
		STATUSID = @STATUSID
		AND SELECTON = @SELECTON		
        
        OPEN CUR_SELECTION_PARAMETER
        
        FETCH NEXT FROM CUR_SELECTION_PARAMETER
        INTO @@SELECTIONQUERY

WHILE @@FETCH_STATUS = 0        
BEGIN
	SELECT @@FINALQUERY = REPLACE(@@SELECTIONQUERY, 'STATUSNAME', '''' + @STATUSNAME + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'FROMAC', '''' + @FROMAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'TOAC', '''' + @TOAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'SEARCH', '''' + @SEARCH + '''')

	FETCH NEXT FROM CUR_SELECTION_PARAMETER
	INTO @@SELECTIONQUERY
END

CLOSE CUR_SELECTION_PARAMETER
DEALLOCATE CUR_SELECTION_PARAMETER

PRINT @@FINALQUERY
EXEC (@@FINALQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 06/24/2004 8:32:35 PM ******/  
  
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 05/10/2004 5:29:35 PM ******/  
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/  
CREATE Proc SelectVoucherDetails 
@Vtyp   varchar(2),  
@BookType  varchar(2),  
@FromDate  varchar(12),  
@Todate  varchar(12),  
@VnoFrom  varchar(12),  
@VnoTo   varchar(12),  
@BankCode  varchar(12)   
  
as  
  
Declare  
@@selectqury  as varchar(8000),  
@@fromtables  as varchar(2000),  
@@wherepart   as varchar(8000),  
@@sortby      as varchar(200)  
  
   
if @VnoFrom <> '' and @VnoTo <> ''   
   begin   
   select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'    
  and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'    
   and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
   end  
else  
   begin  
  select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'    
 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "  
   end         
  
if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'    
   begin  
 select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' 
and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "  
 select @@wherepart = @@wherepart + " and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  cltcode <> '" + @BankCode + "'"   
   end  
else  
   begin  
 select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'" 
 select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "  
   end   
  
select @@wherepart = @@wherepart   
  
select @@selectqury = " select distinct l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
  
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype   
and party_code = cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"  
  
select @@sortby = " order by l.vno "  
      
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby )   
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTVOUCHERDETAILS_NEW
-- --------------------------------------------------
--SELECT * FROM COSTMAST      
--Exec SELECTVOUCHERDETAILS_NEW  19 , '01  ' , 'aPR  1 2006' , 'Feb  1 2007' , '0'  , '999' , 'BANK01', 'BRANCH', 'tr001'      
--Exec SELECTVOUCHERDETAILS_NEW  19 , '01  ' , 'aPR  1 2006' , 'Feb  1 2007' , '0'  , '999' , 'BANK01', 'BRANCH', 'al001'      
    
CREATE PROC SELECTVOUCHERDETAILS_NEW      
@VTYP INT,      
@BOOKTYPE VARCHAR(2),      
@FROMDATE VARCHAR(12),      
@TODATE VARCHAR(12),      
@VNOFROM VARCHAR(12),      
@VNOTO VARCHAR(12),      
@BANKCODE VARCHAR(10),      
@STATUSID VARCHAR(15),      
@STATUSNAME VARCHAR(10)      
      
AS      
      
DECLARE       
@@COSTCODE INT      
      
IF (@VTYP <> 19 AND @VTYP <> 20)      
BEGIN      
 IF UPPER(@STATUSID) = 'BROKER'      
 BEGIN      
  SELECT       
   L.VNO, DD, DDNO, CONVERT(VARCHAR(11),DDDT,103) AS DDDT, BNKNAME, VAMT, DRCR = L.DRCR, CLTCODE = L.CLTCODE, ACNAME = L.ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, A.BRANCHCODE      
  FROM       
   LEDGER L,       
   (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,      
   LEDGER1 L1, ACMAST A      
  WHERE       
   L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE      
   AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND A.CLTCODE = L.CLTCODE  
 END      
 ELSE      
 BEGIN      
  SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME      
  SELECT       
   L.VNO, DD, DDNO, CONVERT(VARCHAR(11),DDDT,103) AS DDDT, BNKNAME, VAMT = CAMT, DRCR = L.DRCR, CLTCODE = L.CLTCODE, ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE, A.BRANCHCODE      
  FROM       
   LEDGER2 L,  
   (SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,      
   LEDGER1 L1,      
   ACMAST A      
  WHERE       
   A.CLTCODE = L.CLTCODE      
   AND L.VNO = L2.VNO AND L.VTYPE = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE      
   AND L.VNO = L1.VNO AND L.VTYPE = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND COSTCODE = @@COSTCODE      
 END      
END        
ELSE      
BEGIN      
 IF @STATUSID = 'BROKER'      
 BEGIN      
  SELECT       
   L.VNO, DD, DDNO, CONVERT(VARCHAR(11),DDDT,103) AS DDDT, BNKNAME, VAMT = AMOUNT, DRCR = L.DRCR, CLTCODE = L.PARTY_CODE, ACNAME = A.ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE, A.BRANCHCODE      
  FROM       
   MARGINLEDGER L,       
   (SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,      
   LEDGER1 L1,      
   ACMAST A      
  WHERE       
   L.PARTY_CODE = A.CLTCODE         
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE       
   AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE       
 END      
 ELSE      
 BEGIN      
  SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME      
  SELECT       
   ML.VNO, DD, DDNO, CONVERT(VARCHAR(11),DDDT,103) AS DDDT, BNKNAME, VAMT = AMOUNT, DRCR = ML.DRCR, CLTCODE = ML.PARTY_CODE, ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE, A.BRANCHCODE       
  FROM       
   MARGINLEDGER ML,      
   LEDGER2 L,       
   (SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,      
   LEDGER1 L1,      
   ACMAST A      
  WHERE       
   A.CLTCODE = ML.PARTY_CODE      
   AND ML.VNO = L2.VNO AND ML.VTYP = L2.VTYP AND ML.BOOKTYPE = L2.BOOKTYPE      
   AND L.VNO = L2.VNO AND L.VTYPE = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE      
   AND L.VNO = L1.VNO AND L.VTYPE = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND COSTCODE = @@COSTCODE      
 END      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_New_FP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_FP    Script Date: 10/20/2005 12:19:54 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_FP    Script Date: 08/29/2005 5:57:25 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc SelectVoucherDetails_New_FP

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@Vtype1 	varchar(2),
@BranchCode varchar(12)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
		and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'  
		 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno /*and l1.ddno='0' */and l1.chqprinted=0 and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " /*and l1.ddno='0' */and l1.chqprinted=0 and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' and dd = 'C' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_New_RP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_RP    Script Date: 10/20/2005 12:19:54 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_RP    Script Date: 08/29/2005 5:57:26 PM ******/


/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc SelectVoucherDetails_New_RP

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@vtype1	varchar(2),
@BranchCode varchar(12)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
		and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'  
		 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l1.ddno<>'0' and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " and l1.ddno<>'0' and l1.chqprinted > 0 and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' and dd = 'C' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_Upd
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_Upd    Script Date: 10/20/2005 12:19:54 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_Upd    Script Date: 08/29/2005 5:57:26 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc SelectVoucherDetails_Upd

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@vtype1	varchar(2),
@BranchCode varchar(12),
@newprintflag varchar(2)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
		and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'  
		 and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l1.ddno>'0' and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	if @newprintflag = 'FP'
		select @@wherepart = @@wherepart + " and l1.chqprinted = 0 "
	if @newprintflag = 'RP'
		select @@wherepart = @@wherepart + " and l1.chqprinted > 0 "
	select @@wherepart = @@wherepart + " and l1.ddno>'0' and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' and dd = 'C' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno and l1.ddno>'0' "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SETCONSTRAINTS
-- --------------------------------------------------
CREATE PROC SETCONSTRAINTS
AS
/*---------------------------------------RULES AND CONSTRAINTS FOR LEDGER--------------------------------------------*/
DECLARE @@OBJ AS INT
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'LEDGER'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VTYP_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_VTYP_SL] CHECK (VTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VTYP_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_ZERO_VTYP_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_ZERO_VTYP_SL] CHECK (VTYP <> 0)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_ZERO_VTYP_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VNO_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_VNO_SL] CHECK (VNO IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VNO_SL ALREADY EXISTS'
			END


		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VNO_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_VNO_SL] CHECK (LTRIM(RTRIM(VNO)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VNO_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_EDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_EDT_SL] CHECK (EDT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_EDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_EDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_EDT_SL] CHECK (EDT <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_EDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACNAME_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_ACNAME_SL] CHECK (ACNAME IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACNAME_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACNAME_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_ACNAME_SL] CHECK (LTRIM(RTRIM(ACNAME)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACNAME_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_DRCR_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_DRCR_SL] CHECK (LTRIM(RTRIM(DRCR)) = 'D' OR LTRIM(RTRIM(DRCR)) = 'C')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_DRCR_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_VDT_SL] CHECK (VDT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VDT_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_VDT_SL] CHECK (VDT <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VDT_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_CLTCODE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_CLTCODE_SL] CHECK (CLTCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_CLTCODE_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_CLTCODE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_CLTCODE_SL] CHECK (LTRIM(RTRIM(CLTCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_CLTCODE_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BOOKTYPE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NOT_NULL_BOOKTYPE_SL] CHECK (BOOKTYPE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BOOKTYPE_SL ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BOOKTYPE_SL')
			BEGIN
				ALTER TABLE LEDGER
					ADD CONSTRAINT [NON_BLANK_BOOKTYPE_SL] CHECK (LTRIM(RTRIM(BOOKTYPE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BOOKTYPE_SL ALREADY EXISTS'
			END
	END
/*---------------------------------------RULES AND CONSTRAINTS FOR MARGIN LEDGER--------------------------------------------*/
	SELECT @@OBJ = 0
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'MARGINLEDGER'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VTYP_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_VTYP_ML] CHECK (VTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VTYP_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VTYP_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_VTYP_ML] CHECK (VTYP <> 0)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VTYP_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VNO_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_VNO_ML] CHECK (VNO IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VNO_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VNO_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_VNO_ML] CHECK (LTRIM(RTRIM(VNO)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VNO_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_DRCR_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_DRCR_ML] CHECK (LTRIM(RTRIM(DRCR)) = 'D' OR LTRIM(RTRIM(DRCR)) = 'C')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_DRCR_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VDT_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_VDT_ML] CHECK (VDT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VDT_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VDT_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_VDT_ML] CHECK (VDT <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VDT_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_PARTYCODE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_PARTYCODE_ML] CHECK (PARTY_CODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_PARTYCODE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_PARTYCODE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_PARTYCODE_ML] CHECK (LTRIM(RTRIM(PARTY_CODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_PARTYCODE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BOOKTYPE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_BOOKTYPE_ML] CHECK (BOOKTYPE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BOOKTYPE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BOOKTYPE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_BOOKTYPE_ML] CHECK (LTRIM(RTRIM(BOOKTYPE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BOOKTYPE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_MCLTCODE_ML')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NOT_NULL_MCLTCODE_ML] CHECK (MCLTCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_MCLTCODE_ML ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_MCLTCODE_SL')
			BEGIN
				ALTER TABLE MARGINLEDGER
					ADD CONSTRAINT [NON_BLANK_MCLTCODE_SL] CHECK (LTRIM(RTRIM(MCLTCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_MCLTCODE_SL ALREADY EXISTS'
			END

	END

/*---------------------------------------RULES AND CONSTRAINTS FOR LEDGER1--------------------------------------------*/

	SELECT @@OBJ = 0
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'LEDGER1'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VTYP_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NOT_NULL_VTYP_L1] CHECK (VTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VTYP_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_ZERO_VTYP_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_ZERO_VTYP_L1] CHECK (VTYP <> 0)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_ZERO_VTYP_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_VNO_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NOT_NULL_VNO_L1] CHECK (VNO IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_VNO_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_VNO_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_BLANK_VNO_L1] CHECK (LTRIM(RTRIM(VNO)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_VNO_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_DRCR_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_BLANK_DRCR_L1] CHECK (LTRIM(RTRIM(DRCR)) = 'D' OR LTRIM(RTRIM(DRCR)) = 'C')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_DRCR_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BOOKTYPE_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NOT_NULL_BOOKTYPE_L1] CHECK (BOOKTYPE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BOOKTYPE_L1 ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BOOKTYPE_L1')
			BEGIN
				ALTER TABLE LEDGER1
					ADD CONSTRAINT [NON_BLANK_BOOKTYPE_L1] CHECK (LTRIM(RTRIM(BOOKTYPE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BOOKTYPE_L1 ALREADY EXISTS'
			END

	END

/*---------------------------------------RULES AND CONSTRAINTS FOR ACMAST--------------------------------------------*/

	SELECT @@OBJ = 0
	SELECT @@OBJ = ID FROM SYSOBJECTS WHERE NAME = 'ACMAST'
IF @@OBJ <> 0
	BEGIN
		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_ACNAME_AM] CHECK (ACNAME IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_ACNAME_AM] CHECK (LTRIM(RTRIM(ACNAME)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_LONGNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_LONGNAME_AM] CHECK (LONGNAME IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_LONGNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_LONGNAME_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_LONGNAME_AM] CHECK (LTRIM(RTRIM(LONGNAME)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_LONGNAME_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACTYP_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_ACTYP_AM] CHECK (ACTYP IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACTYP_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACTYP_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_ACTYP_AM] CHECK (LTRIM(RTRIM(ACTYP)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACTYP_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_ACCAT_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_ACCAT_AM] CHECK (ACCAT IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_ACCAT_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_ACCAT_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_ACCAT_AM] CHECK (LTRIM(RTRIM(ACCAT)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_ACCAT_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_CLTCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_CLTCODE_AM] CHECK (CLTCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_CLTCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_CLTCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_CLTCODE_AM] CHECK (LTRIM(RTRIM(CLTCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_CLTCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_GRPCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_GRPCODE_AM] CHECK (GRPCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_GRPCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_GRPCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_GRPCODE_AM] CHECK (LTRIM(RTRIM(GRPCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_GRPCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NOT_NULL_BRANCHCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NOT_NULL_BRANCHCODE_AM] CHECK (BRANCHCODE IS NOT NULL)
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NOT_NULL_BRANCHCODE_AM ALREADY EXISTS'
			END

		IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE PARENT_OBJ = @@OBJ AND XTYPE IN ('C ','PK','UQ','F ', 'D') AND NAME = 'NON_BLANK_BRANCHCODE_AM')
			BEGIN
				ALTER TABLE ACMAST
					ADD CONSTRAINT [NON_BLANK_BRANCHCODE_AM] CHECK (LTRIM(RTRIM(BRANCHCODE)) <> '')
			END
		ELSE
			BEGIN
				PRINT 'CONSTRAINT NON_BLANK_BRANCHCODE_AM ALREADY EXISTS'
			END

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
CREATE PROC SP @spName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Addbranch_Execute
-- --------------------------------------------------
--insert into delsegment select * from gunavatta.msajag.dbo.delsegment
  /****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 01/15/2005 4:39:22 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 12/16/2003 2:21:39 Pm ******/  
  
  
Create Proc Sp_Addbranch_Execute  
@Strsql Varchar(8000)  
As  
 Print @Strsql  
 Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Addclient_Execute
-- --------------------------------------------------
--insert into delsegment select * from gunavatta.msajag.dbo.delsegment
 /****** Object:  Stored Procedure Dbo.Sp_Addclient_Execute    Script Date: 01/15/2005 4:39:23 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.Sp_Addclient_Execute    Script Date: 12/16/2003 2:21:39 Pm ******/  
  
Create Proc Sp_Addclient_Execute  
@Strsql Varchar(8000)  
As  
 Print @Strsql  
 Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_EXTEND_BILL_FINANCIAL
-- --------------------------------------------------



CREATE PROC SP_EXTEND_BILL_FINANCIAL
	@SETT_NO VARCHAR(7), 
	@SETT_TYPE VARCHAR(2), 
	@VDT VARCHAR(11), 
	@EDT VARCHAR(11)

AS

	DECLARE
		@@NNEWVNO AS VARCHAR(12), 
		@@NOLDVNO AS VARCHAR(12), 
		@@INEWVNO AS VARCHAR(12), 
		@@IOLDVNO AS VARCHAR(12), 
		@@VNOFLAG AS SMALLINT, 
		@@COUNTER AS INT, 
		@@OLDVDT AS VARCHAR(12), 
		@@OLDEDT AS VARCHAR(12),
		@@STRCURDATE AS DATETIME,
		@@LDTCURDATE AS DATETIME, 
		@@OBJID AS INT,
		@@OBJID1 AS INT,
		@@LASTVNOEXISTS AS TINYINT,
		@@V2_LASTVNOEXISTS AS TINYINT		

SET @@LASTVNOEXISTS = 0
IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[LASTVNO]') AND XTYPE = 'U')
	SET @@LASTVNOEXISTS = 1

SET @@V2_LASTVNOEXISTS = 0
IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[V2_LASTVNO]') AND XTYPE = 'U')
	SET @@V2_LASTVNOEXISTS = 1

SELECT
	@@VNOFLAG = VNOFLAG,
	@@STRCURDATE = SDTCUR,
	@@LDTCURDATE = LDTCUR
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR

IF CONVERT(DATETIME, @EDT) < @@STRCURDATE
	BEGIN
		SELECT 'EFFECTIVE DATE IS LESSER THAN ' + CONVERT(VARCHAR(11), @@STRCURDATE) + '. CANNOT CONTINUE...'
		RETURN
	END

SELECT @@NOLDVNO = ''
SELECT @@IOLDVNO = ''

SELECT 
	TOP 1 @@NOLDVNO = VNO, 
	@@OLDVDT = CONVERT(VARCHAR(11), VDT, 109), 
	@@OLDEDT = CONVERT(VARCHAR(11), EDT, 109)
FROM 
	LEDGER 
WHERE 
	VTYP = 15 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'NSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%'
	AND BOOKTYPE = '01'

SELECT 
	TOP 1 @@IOLDVNO = VNO 
FROM 
	LEDGER 
WHERE 
	VTYP = 21 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'NSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%' 
	AND BOOKTYPE = '01'

IF @@NOLDVNO = '' AND @@IOLDVNO = ''
	BEGIN
		SELECT 'NO BILLS FOUND FOR SELECTED SETTLEMENT'
		RETURN
	END

IF CONVERT(DATETIME, @@OLDVDT) < @@STRCURDATE
	BEGIN
		SELECT 'VOUCHER DATE ALREADY FALLS IN NEXT FINANCIAL YEAR'
		RETURN
	END

IF CONVERT(DATETIME, @@OLDEDT) > @@STRCURDATE
	BEGIN
		SELECT 'EFFECTIVE DATE ALREADY FALLS IN PREVIOUS FINANCIAL YEAR'
		RETURN
	END

IF @@VNOFLAG = 0
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT))) + '00000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT))) + '00000001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		IF @@LASTVNOEXISTS = 1
		BEGIN
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				LASTVNO
			WHERE 
				VTYP = 15
				AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			IF @@COUNTER > 0
				BEGIN
					UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
				END
			ELSE
				BEGIN
					INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
				END
	
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				LASTVNO
			WHERE 
				VTYP = 21
				AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			IF @@COUNTER > 0
				BEGIN
					UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
				END
			ELSE
				BEGIN
					INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
				END
		END

		IF @@V2_LASTVNOEXISTS = 1
		BEGIN
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				V2_LASTVNO
			WHERE 
				VTYP = 15
				AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			IF @@COUNTER > 0
				BEGIN
					UPDATE V2_LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
				END
			ELSE
				BEGIN
					INSERT INTO V2_LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO, VNOFLAG) VALUES (15, '01', @VDT, @@NNEWVNO, @@VNOFLAG)
				END
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				V2_LASTVNO
			WHERE 
				VTYP = 21
				AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			IF @@COUNTER > 0
				BEGIN
					UPDATE V2_LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
				END
			ELSE
				BEGIN
					INSERT INTO V2_LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO, VNOFLAG) VALUES (21, '01', @VDT, @@INEWVNO, @@VNOFLAG)
				END
		END
	END

ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		IF @@LASTVNOEXISTS = 1
		BEGIN
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				LASTVNO
			WHERE 
				VTYP = 15
				AND BOOKTYPE = '01'
				AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
			IF @@COUNTER > 0
				BEGIN
					UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
				END
			ELSE
				BEGIN
					INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
				END
	
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				LASTVNO
			WHERE 
				VTYP = 21
				AND BOOKTYPE = '01'
				AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
			IF @@COUNTER > 0
				BEGIN
					UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
				END
			ELSE
				BEGIN
					INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
				END
		END

		IF @@V2_LASTVNOEXISTS = 1
		BEGIN
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				V2_LASTVNO
			WHERE 
				VTYP = 15
				AND BOOKTYPE = '01'
				AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
			IF @@COUNTER > 0
				BEGIN
					UPDATE V2_LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
				END
			ELSE
				BEGIN
					INSERT INTO V2_LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO, VNOFLAG) VALUES (15, '01', @VDT, @@NNEWVNO, @@VNOFLAG)
				END
	
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				V2_LASTVNO
			WHERE 
				VTYP = 21
				AND BOOKTYPE = '01'
				AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
			IF @@COUNTER > 0
				BEGIN
					UPDATE V2_LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
				END
			ELSE
				BEGIN
					INSERT INTO V2_LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO, VNOFLAG) VALUES (21, '01', @VDT, @@INEWVNO, @@VNOFLAG)
				END
		END

	END

ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2)) + '000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2)) + '000001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		IF @@LASTVNOEXISTS = 1
		BEGIN
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				LASTVNO
			WHERE 
				VTYP = 15
				AND BOOKTYPE = '01'
				AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
			IF @@COUNTER > 0
				BEGIN
					UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
				END
			ELSE
				BEGIN
					INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
				END
	
	
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				LASTVNO
			WHERE 
				VTYP = 21
				AND BOOKTYPE = '01'
				AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
			IF @@COUNTER > 0
				BEGIN
					UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
				END
			ELSE
				BEGIN
					INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
				END
		END
		IF @@V2_LASTVNOEXISTS = 1
		BEGIN
			EXEC UPDATE_FLDAUTO 
		SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				V2_LASTVNO
			WHERE 
				VTYP = 15
				AND BOOKTYPE = '01'
				AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
			IF @@COUNTER > 0
				BEGIN
					UPDATE V2_LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
				END
			ELSE
				BEGIN
					INSERT INTO V2_LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
				END
	
	
			SELECT 
				@@COUNTER = COUNT(1)
			FROM 
				V2_LASTVNO
			WHERE 
				VTYP = 21
				AND BOOKTYPE = '01'
				AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
			IF @@COUNTER > 0
				BEGIN
					UPDATE V2_LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
				END
			ELSE
				BEGIN
					INSERT INTO V2_LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
				END
		END
	END

SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)
SELECT @@OBJID1 = ISNULL(OBJECT_ID('BILLPOSTED'), 0)

IF @@NOLDVNO <> ''
	BEGIN
		BEGIN TRAN		
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@NNEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@NNEWVNO, 15, '01', GETDATE())

		IF @@V2_LASTVNOEXISTS = 1
		BEGIN
			UPDATE V2 SET FINYEAR = P.FLDAUTO FROM V2_LASTVNO V2, PARAMETER P
			WHERE VTYP IN(15, 21) AND @VDT BETWEEN SDTCUR AND LDTCUR
			AND VDT LIKE @VDT + '%'
		END
		COMMIT TRAN

	END

IF @@IOLDVNO <> ''
	BEGIN
		BEGIN TRAN
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@INEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@INEWVNO, 21, '01', GETDATE())
		COMMIT TRAN
	END

SELECT 'BILL SUCCESSFULLY POSTED IN NEXT FINANCIAL YEAR WITH VNO : ' + @@NNEWVNO + ' [15] AND ' + @@INEWVNO + ' [21]'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_EXTEND_BILL_FINANCIAL_BSE
-- --------------------------------------------------


CREATE PROC SP_EXTEND_BILL_FINANCIAL_BSE
	@SETT_NO VARCHAR(7), 
	@SETT_TYPE VARCHAR(2), 
	@VDT VARCHAR(11), 
	@EDT VARCHAR(11)

AS

	DECLARE
		@@NNEWVNO AS VARCHAR(12), 
		@@NOLDVNO AS VARCHAR(12), 
		@@INEWVNO AS VARCHAR(12), 
		@@IOLDVNO AS VARCHAR(12), 
		@@VNOFLAG AS SMALLINT, 
		@@COUNTER AS INT, 
		@@OLDVDT AS VARCHAR(12), 
		@@OLDEDT AS VARCHAR(12),
		@@STRCURDATE AS DATETIME,
		@@LDTCURDATE AS DATETIME, 
		@@OBJID AS INT,
		@@OBJID1 AS INT



IF CONVERT(DATETIME, @EDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE IS LESSER THAN APR 1 2007. CANNOT CONTINUE...'
		RETURN
	END



SELECT @@NOLDVNO = ''
SELECT @@IOLDVNO = ''

SELECT 
	TOP 1 @@NOLDVNO = VNO, 
	@@OLDVDT = CONVERT(VARCHAR(11), VDT, 109), 
	@@OLDEDT = CONVERT(VARCHAR(11), EDT, 109)
FROM 
	LEDGER 
WHERE 
	VTYP = 15 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'BSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%'
	AND BOOKTYPE = '01'

SELECT 
	TOP 1 @@IOLDVNO = VNO 
FROM 
	LEDGER 
WHERE 
	VTYP = 21 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'BSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%' 
	AND BOOKTYPE = '01'

IF @@NOLDVNO = '' AND @@IOLDVNO = ''
	BEGIN
		SELECT 'NO BILLS FOUND FOR SELECTED SETTLEMENT'
		RETURN
	END

IF CONVERT(DATETIME, @@OLDVDT) > 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'VOUCHER DATE ALREADY FALLS IN NEXT FINANCIAL YEAR'
		RETURN
	END
IF CONVERT(DATETIME, @@OLDEDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE ALREADY FALLS IN PREVIOUS FINANCIAL YEAR'
		RETURN
	END

SELECT 
	@@VNOFLAG = VNOFLAG,
	@@STRCURDATE = SDTCUR,
	@@LDTCURDATE = LDTCUR
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR


IF @@VNOFLAG = 0
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END
ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END

	END
ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200704000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200704010001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END
		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END


		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END

SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)
SELECT @@OBJID1 = ISNULL(OBJECT_ID('BILLPOSTED'), 0)


IF @@NOLDVNO <> ''
	BEGIN
		BEGIN TRAN		
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@NNEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@NNEWVNO, 15, '01', GETDATE())
		COMMIT TRAN

	END
IF @@IOLDVNO <> ''
	BEGIN
		BEGIN TRAN
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@INEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@INEWVNO, 21, '01', GETDATE())
		COMMIT TRAN
	END

SELECT 'BILL SUCCESSFULLY POSTED IN NEXT FINANCIAL YEAR WITH VNO : ' + @@NNEWVNO + ' [15] AND ' + @@INEWVNO + ' [21]'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_EXTEND_BILL_FINANCIAL_NSE
-- --------------------------------------------------


CREATE PROC SP_EXTEND_BILL_FINANCIAL_NSE
	@SETT_NO VARCHAR(7), 
	@SETT_TYPE VARCHAR(2), 
	@VDT VARCHAR(11), 
	@EDT VARCHAR(11)

AS

	DECLARE
		@@NNEWVNO AS VARCHAR(12), 
		@@NOLDVNO AS VARCHAR(12), 
		@@INEWVNO AS VARCHAR(12), 
		@@IOLDVNO AS VARCHAR(12), 
		@@VNOFLAG AS SMALLINT, 
		@@COUNTER AS INT, 
		@@OLDVDT AS VARCHAR(12), 
		@@OLDEDT AS VARCHAR(12),
		@@STRCURDATE AS DATETIME,
		@@LDTCURDATE AS DATETIME, 
		@@OBJID AS INT,
		@@OBJID1 AS INT



IF CONVERT(DATETIME, @EDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE IS LESSER THAN APR 1 2007. CANNOT CONTINUE...'
		RETURN
	END



SELECT @@NOLDVNO = ''
SELECT @@IOLDVNO = ''

SELECT 
	TOP 1 @@NOLDVNO = VNO, 
	@@OLDVDT = CONVERT(VARCHAR(11), VDT, 109), 
	@@OLDEDT = CONVERT(VARCHAR(11), EDT, 109)
FROM 
	LEDGER 
WHERE 
	VTYP = 15 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'NSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%'
	AND BOOKTYPE = '01'

SELECT 
	TOP 1 @@IOLDVNO = VNO 
FROM 
	LEDGER 
WHERE 
	VTYP = 21 
	AND NARRATION LIKE 'SETTNO=' + LTRIM(RTRIM(@SETT_NO)) + 'NSECM' + LTRIM(RTRIM(@SETT_TYPE)) + '%' 
	AND BOOKTYPE = '01'

IF @@NOLDVNO = '' AND @@IOLDVNO = ''
	BEGIN
		SELECT 'NO BILLS FOUND FOR SELECTED SETTLEMENT'
		RETURN
	END

IF CONVERT(DATETIME, @@OLDVDT) > 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'VOUCHER DATE ALREADY FALLS IN NEXT FINANCIAL YEAR'
		RETURN
	END
IF CONVERT(DATETIME, @@OLDEDT) <= 'MAR 31 2007 23:59:59'
	BEGIN
		SELECT 'EFFECTIVE DATE ALREADY FALLS IN PREVIOUS FINANCIAL YEAR'
		RETURN
	END

SELECT 
	@@VNOFLAG = VNOFLAG,
	@@STRCURDATE = SDTCUR,
	@@LDTCURDATE = LDTCUR
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR


IF @@VNOFLAG = 0
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200700000001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND VDT BETWEEN @@STRCURDATE AND @@LDTCURDATE 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END
ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = (convert(varchar,year(@VDT)) + right('0'+ltrim(convert(varchar,month(@VDT))),2) + right('00'+ltrim(convert(varchar,day(@VDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END

		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND CONVERT(VARCHAR(12), VDT, 109) = @VDT
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND CONVERT(VARCHAR(12), VDT, 109) = @VDT 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END

	END
ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@NNEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@NNEWVNO = '0'
			BEGIN
				SELECT @@NNEWVNO = '200704000001'
			END
		ELSE
			BEGIN
				SELECT @@NNEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@NNEWVNO) + 1)
			END

		SELECT @@INEWVNO = ISNULL(MAX(VNO), '0') FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@INEWVNO = '0'
			BEGIN
				SELECT @@INEWVNO = '200704010001'
			END
		ELSE
			BEGIN
				SELECT @@INEWVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@INEWVNO) + 1)
			END
		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 15
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 15 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (15, '01', @VDT, @@NNEWVNO)
			END


		SELECT 
			@@COUNTER = COUNT(1)
		FROM 
			LASTVNO
		WHERE 
			VTYP = 21
			AND BOOKTYPE = '01'
			AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT)
		IF @@COUNTER > 0
			BEGIN
				UPDATE LASTVNO SET LASTVNO = @@NNEWVNO WHERE VTYP = 21 AND BOOKTYPE = '01' AND MONTH(VDT) = MONTH(@VDT) AND YEAR(VDT) = YEAR(@VDT) 
			END
		ELSE
			BEGIN
				INSERT INTO LASTVNO (VTYP, BOOKTYPE, VDT, LASTVNO) VALUES (21, '01', @VDT, @@INEWVNO)
			END
	END

SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)
SELECT @@OBJID1 = ISNULL(OBJECT_ID('BILLPOSTED'), 0)


IF @@NOLDVNO <> ''
	BEGIN
		BEGIN TRAN		
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@NNEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@NNEWVNO, [DATE] = @VDT WHERE VNO = @@NOLDVNO AND VTYPE = 15 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@NNEWVNO WHERE VNO = @@NOLDVNO AND VTYP = 15 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@NNEWVNO, 15, '01', GETDATE())
		COMMIT TRAN

	END
IF @@IOLDVNO <> ''
	BEGIN
		BEGIN TRAN
		INSERT INTO LEDGER_JRNL SELECT VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION, UPDDATE = GETDATE() FROM LEDGER WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER SET VNO = @@INEWVNO, VDT = @VDT, EDT = @EDT WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER1 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER2 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		UPDATE LEDGER3 SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
		UPDATE BILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
		IF @@OBJID > 0
			BEGIN
				UPDATE BFBILLMATCH SET VNO = @@INEWVNO, [DATE] = @VDT WHERE VNO = @@IOLDVNO AND VTYPE = 21 AND BOOKTYPE = '01'
			END
		IF @@OBJID1 > 0
			BEGIN
				UPDATE BILLPOSTED SET VNO = @@INEWVNO WHERE VNO = @@IOLDVNO AND VTYP = 21 AND BOOKTYPE = '01'
			END
		INSERT INTO BILL_SHIFT_LOG (SETT_NO, SETT_TYPE, GEN_VNO, VTYP, BOOKTYPE, UPDDATE) VALUES (@SETT_NO, @SETT_TYPE, @@INEWVNO, 21, '01', GETDATE())
		COMMIT TRAN
	END

SELECT 'BILL SUCCESSFULLY POSTED IN NEXT FINANCIAL YEAR WITH VNO : ' + @@NNEWVNO + ' [15] AND ' + @@INEWVNO + ' [21]'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MPI_PayIn
-- --------------------------------------------------


CREATE procedure SP_MPI_PayIn   
@branchcode varchar(10),  
@partycode varchar(10),  
@bankcode varchar(10),  
@bankac varchar(16),  
@longname varchar(100)  
as  
if(@branchcode=@partycode)   
 BEGIN  
    insert into ACCOUNT.DBO.MPI_PayIn values (@branchcode,@partycode,@bankcode,@bankac,'HDFC BANK','S','CA',@longname,'53','10001')  
    insert into ACCOUNTBSE.DBO.MPI_PayIn values (@branchcode,@partycode,@bankcode,@bankac,'HDFC BANK','S','CA',@longname,'51','10001')  
 END  
ELSE  
  BEGIN  
     insert into ACCOUNT.DBO.MPI_PayIn values (@branchcode,@partycode,@bankcode,@bankac,'HDFC BANK','E','CA',@longname,'53','10001')  
     insert into ACCOUNTBSE.DBO.MPI_PayIn values (@branchcode,@partycode,@bankcode,@bankac,'HDFC BANK','E','CA',@longname,'51','10001')   
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_voucherreport
-- --------------------------------------------------

CREATE  Procedure [dbo].[Sp_voucherreport]
(  
 @Reptype Varchar(2),   
 @Fromdate Varchar(11),   
 @Todate Varchar(11),   
 @Frombankcode Varchar(10),   
 @Tobankcode Varchar(10),   
 @Fromclientid Varchar(10),   
 @Toclientid Varchar(10),   
 @Statusid Varchar(12),   
 @Statusname Varchar(12),   
 @Datetype varchar(6),  
 @VamtFr varchar(20),  
 @VamtTo varchar(20),  
 @Chqno  varchar(15),  
 @PageSize varchar(3),  
 @VnoFr varchar(12),  
 @VnoTo varchar(12)  
)  
As
Declare @Strsql As Varchar(1000)  



If  @Statusid = 'broker'  
Begin  
 
 If @Reptype = '16'  
    Begin  
           --Cheque Is Cancelled.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +   
    " A.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A" +   
    " Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "   
    If  @Frombankcode <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = ' " + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"  
    End  
      
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
    " Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
    " Where A.Vno <> '' And A.Vtyp = 16 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + "' And A.Vdt < = '" + @Todate + " 23:59:59'" --test   
    If @Chqno <> ''    
    Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
    End  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
     If @Fromclientid <> ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
      End  
    /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc " */  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "   
    End   
  
  Else If @Reptype = '17'   
    Begin  
  --  ****  Cheque Is Returned.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     " A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +  
     " Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "   
     If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End   
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     " Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     " Where A.Vno <> '' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00'" +  
     " And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
    If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +  
      "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  
    Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
  
    End  
  Else If @Reptype = '19'   
    Begin  
  --  **** Margin Bank Received.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.lno = A.lno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00'" +  
     " And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End 
    If @FromDate <> '' or @ToDate <> ''   
    Begin  
      Set @Strsql = @Strsql + "and A.vdt between '" + @FromDate + "'  And  '" + @ToDate + "' "  
    End 	   
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"       
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
  /*  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration" */     End  
  
  Else If @Reptype = '8'   
    Begin  
  --  **** Journal Voucher.  

    Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +   
     "a.Vamt, A.Narration From Ledger A Where A.Vno <> '' And A.Vtyp = 8  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
       
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
     /*if(@Frombankcode <> "")   
      --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If*/  
      
     If @Fromclientid <>  ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    /* Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
    "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "
print 'hi123'

    End  
  
  Else If @Reptype = '6'   
    Begin  
  --  **** Debit Note.  
    Set @Strsql = "select   A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 6  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''    
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
     If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '7'   
    Begin  
  --  **** Credit Note.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 7  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"  
     End  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '5'   
    Begin  
  --  **** Contra Entry.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 5 " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
   If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
   If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '20'   
    Begin  
  --  **** Margin Bank Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.lno = A.lno And Ledger.Vtyp = A.Vtyp And " +  
     "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +  
     "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 20 "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
    If @FromDate <> '' or @ToDate <> ''   
    Begin  
      Set @Strsql = @Strsql + "and A.vdt between '" + @FromDate + "'  And  '" + @ToDate + "' "  
    End  
    If @Frombankcode <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"       
     End  
     If @Fromclientid <> ''  
     Begin   
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
    Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr,   
     C.Ddno,  C.Dddt, Ledger.Narration"  
    End  
  
  Else If @Reptype = '22'    
    Begin  
  --  **** Margin Cash Received.    
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 22 "  
       
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
    End  
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End    
     If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
    End  
    If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
    End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"*/  
    End  
  
  Else If @Reptype = '23'   
    Begin  
  --  **** Margin Cash Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 23 "  
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End    
    If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"*/  
    End  
  
  Else If @Reptype = '24'      
    Begin  
  --  **** Margin Journal Entries.(Vtyp = 24)  
      
    Set @Strsql = "select  A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, " +  
     " A.Amount Vamt, C.Narration From Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +  
     "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode " +  
     "where A.Vno <> ''  And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
    /*if(Trim(Strbankcode) <> "")   
      'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If */  
      
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "') "   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '3'   
  --  **** Payment Bank.  
    Begin  
       IF @datetype ='Voudt'  
   Begin  
     Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname,   
        A.Drcr, A.Vamt, " +  "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration , D.CLTCODE as ctl     
       From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
      "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "   
       
      If @Frombankcode <> ''   
      Begin  
       Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
      End  
     
      Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Inner Join " +  
      "ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' " +  
      "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
    
      If @Fromclientid <> ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
      End  
     if @Chqno <> ''    
      Begin  
       Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
      End     
     If @VamtFr <> '' or @VamtTo <> ''   
      Begin  
          Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
        End   
     If @VnoFr <> '' or @VnoTo <> ''   
         Begin  
              Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
            End    
     Set @Strsql = @Strsql + " /* Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,   
        C.Dddt, A.Narration, D.Cltcode */ Order By A.Vno, A.Vdt, A.Drcr Desc "  
        End  
      else if  @datetype ='EntDt'  
       Begin   
       Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Pdt, 109) Pdt, A.Acname,   
       A.Drcr, A.Vamt, " +  "convert(Varchar(11), C.Dddt, 109) cdt, A.Narration , D.CLTCODE as ct     
       From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
"booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "   
       If @VamtFr <> '' or @VamtTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
       End    
       If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End     
       If @Frombankcode <> ''   
       Begin  
       Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
       End  
     
      Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Inner Join " +  
      "ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' " +  
      "and A.Vtyp = 3 And A.Drcr = 'D' And A.Pdt > = '" + @Fromdate + " 00:00:00' And A.Pdt < = '" + @Todate + " 23:59:59' "  
    
      If @Fromclientid <> ''  
      Begin  
       Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
      End  
      Set @Strsql = @Strsql + "/* Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Pdt, A.Acname, A.Drcr, A.Vamt,   
      C.Dddt, A.Narration, D.Cltcode */ Order By A.Vno, A.Pdt, A.Drcr Desc "  
    End  
  End  
  
  Else If @Reptype = '4'   
    Begin  
  --  **** Payment Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 4 And Drcr = 'C' "  
     If @Frombankcode <> ''   
     Begin   
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Where A.Vno <> '' And A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
       
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End   
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  Else If @Reptype =  '2'   
    Begin  
  --  **** Receipt Bank.  
     IF @datetype ='Voudt'  
     Begin  
     Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration , D.CLTCODE as ctl   From Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "   
     if @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "' And '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + "/* Group By C.Ddno, A.Vtyp, A.Cltcode ,A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE */ Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  Else If @datetype='Entdt'  
   Begin    
    Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Pdt, 109) Pdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration ,D.Cltcode as ct From Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And A.Vtyp = 2 And A.Drcr = 'C' And A.Pdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Pdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + "/* Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Pdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE */ Order By A.Vno, A.Pdt, A.Drcr Desc "  
   End  
  End  
  
  Else If @Reptype = '1'   
    Begin  
  --  **** Receipt Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 1 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Where A.Vno <> '' " +  
     "and A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
      
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
    If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
     
   --else Raiserror ('50001 : No Voucher Type Found', 0, 13)  
   End  
  End

--New  
--Else 
Else if @Statusid ='Subbroker'  
	If @Reptype = '8'   
	Begin  
  --  **** Journal Voucher.  
		Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
		 "a.Vamt, A.Narration From Ledger A , msajag.dbo.Subbrokers S, msajag.dbo.Client1 C Where A.Vno <> '' And A.Vtyp = 8  " + 
		 "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  +
		 "and A.cltcode= C.Cl_Code and C.sub_broker = '" + @StatusName + "'  "  
       
		If @VamtFr <> '' or @VamtTo <> ''   
		 Begin  
		  Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
		 End   
		If @VnoFr <> '' or @VnoTo <> ''   
		 Begin  
		  Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
		 End    

		Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
	 End  
   Else If @Reptype =  '2'   
    Begin  
  --  **** Receipt Bank.  
     IF @datetype ='Voudt'  
     Begin  
     Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration , D.CLTCODE as ctl From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 ,Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
	 
	 If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "   
     if @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "' And '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode ,A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE  Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  Else If @datetype='Entdt'  
   Begin    
    Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Pdt, 109) Pdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration ,D.Cltcode as ct From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 ,Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Pdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Pdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Pdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration , D.CLTCODE  Order By A.Vno, A.Pdt, A.Drcr Desc "  
   End  
  End  

 Else If @Reptype = '16'   
    Begin  
  --  **** When Cheque Is Cancelled.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +  
     "a.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger A " +  
     "inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"  
     End  
      
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker = '" + @Statusname + "' And A.Vtyp = 16 And A.Drcr = 'C' " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
   If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc "   
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '17'   
    Begin  
  --  **** When Cheque Is Returned.(Vtyp = 17)  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger A " +  
     "Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End   
  If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype  " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype  " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
    Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc "   
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
    End  
  
  Else If @Reptype = '19'   
    Begin  
  --  **** Margin Bank Received.(Vtyp = 19)  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype  " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End      
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
     Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
    If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
    Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration"  
      
    End  

 Else If @Reptype = '6'   
    Begin  
  --  **** Debit Note.(Vtyp = 6)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "'  and A.Vtyp = 6  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End     
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''      Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"       
     End  
      
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid +"' ) "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '7'  
    Begin   
  --  **** Credit Note.(Vtyp = 7)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "'  and A.Vtyp = 7   " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''  
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End   
      
     If @Fromclientid <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '5'   
    Begin  
  --  **** Contra Entry. (Vtyp = 5)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 5 " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''   
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
     
    End  
  
  Else If @Reptype = '20'   
   Begin  
 --  **** Margin Bank Repayment. (Vtyp = 20)  
   Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
    "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt  " +  
    "from msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And " +  
    "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +  
    "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 20 "  
    If @Chqno <> ''    
    Begin  
     Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
    End    
   If @VamtFr <> '' or @VamtTo <> ''   
    Begin  
     Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
    End   
   If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End   
    If (@Frombankcode <> "")   
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "' )"  
    End  
    If @Fromclientid <> ''  
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
    End  
    
  /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, " +  
    "c.Ddno,  C.Dddt, Ledger.Narration" */  
   End  
  
  Else If @Reptype = '22'   
    Begin  
  --  **** Margin Cash Received.(Vtyp = 22)    
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "' and A.Vtyp = 22 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
      
    End    
  
  Else If @Reptype = '23'   
    Begin  
  --  **** Margin Cash Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode and A.cltcode= C1.Cl_Code Where C1.sub_broker= '" + @Statusname + "'  and A.Vtyp = 23 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
    End  
  
  Else If @Reptype = '24'      
    Begin  
  --  **** Margin Journal Entries.(Vtyp = 24)  
      
    Set @Strsql = "select  A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, "+  
     " A.Amount Vamt, C.Narration From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +  
     "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode And A.Booktype = B.Booktype " +  
     "where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     /*if(Trim(Strbankcode) <> "")   
      'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If */  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '3'   
    Begin  
  --  **** Payment Bank.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration, D.CLTCODE as ctl From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 ,Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
     "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
       
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Inner Join Ledger1 C On A.Vno = C.Vno " +  
     "and A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "'" +  
     "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
      End   
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, " +  
       "c.Dddt, A.Narration,D.Cltcode Order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '4'   
    Begin  
  --  **** Payment Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "from Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 ,Ledger Where Vtyp = 4 And Drcr = 'C' "  
     If @Frombankcode <> ''   
  Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End   
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "'" +  
     "and A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''    
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
   End  
 
   Else If @Reptype = '1'   
    Begin  
  --  **** Receipt Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From msajag.dbo.Subbrokers S, msajag.dbo.Client1 C1 , Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype from Ledger Where Vtyp = 1 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     " Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' and A.cltcode= C1.Cl_Code And C1.sub_broker= '" + @Statusname + "'" +  
     " And A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
  -----else Raiserror ('50001 : No Voucher Type Found For Branch.', 0, 13)  
   End  


        

--New */


else if  @Statusid ='Branch' 
 Begin  
 -- **** Branch Login.  
  If @Reptype = '16'   
    Begin  
  --  **** When Cheque Is Cancelled.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +  
     "a.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +  
     "inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"  
     End  
      
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 16 And A.Drcr = 'C' " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
   If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '17'   
    Begin  
  --  **** When Cheque Is Returned.(Vtyp = 17)  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +  
     "Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
   If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End   
  If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
    Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype  " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype  " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
    End  
  
  Else If @Reptype = '19'   
    Begin  
  --  **** Margin Bank Received.(Vtyp = 19)  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +  
     "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype  " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
   If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End      
   If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
     Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
    If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration"*/  
      
    End  
  
  Else If @Reptype = '8'   
    Begin  
  --  **** Journal Voucher.(Vtyp = 8)  
    Set @Strsql = "select   A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +   
     "a.Vamt, A.Narration From Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' " +  
     "and B.Branchcode = '" + @Statusname + "' And A.Vtyp = 8  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
      If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End    
     /*if(@Frombankcode <> "")   
      --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If*/  
      
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + "order By A.Vno, A.Vdt, A.Drcr Desc "  
  
    End  
  
  Else If @Reptype = '6'   
    Begin  
  --  **** Debit Note.(Vtyp = 6)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 6  " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End     
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''      Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"       
     End  
      
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid +"' ) "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '7'  
    Begin   
  --  **** Credit Note.(Vtyp = 7)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 7   " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Frombankcode <> ''  
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End   
      
     If @Fromclientid <> ''   
    Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
    End  
  
  Else If @Reptype = '5'   
    Begin  
  --  **** Contra Entry. (Vtyp = 5)  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +  
     "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 5 " +  
     "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"   
     End  
      
     If @Fromclientid <> ''   
     Begin   
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End  
    Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"  
     
    End  
  
  Else If @Reptype = '20'   
   Begin  
 --  **** Margin Bank Repayment. (Vtyp = 20)  
   Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
    "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt  " +  
    "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.lno = A.lno And Ledger.Vtyp = A.Vtyp And " +  
    "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +  
    "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 20 "  
    If @Chqno <> ''    
    Begin  
     Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
    End    
   If @VamtFr <> '' or @VamtTo <> ''   
    Begin  
     Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
    End   
   If @VnoFr <> '' or @VnoTo <> ''   
     Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End   
    If (@Frombankcode <> "")   
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "' )"  
    End  
    If @Fromclientid <> ''  
    Begin  
     Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
    End  
    
  /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, " +  
    "c.Ddno,  C.Dddt, Ledger.Narration" */  
   End  
  
  Else If @Reptype = '22'   
    Begin  
  --  **** Margin Cash Received.(Vtyp = 22)    
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 22 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End    
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
    If @Frombankcode <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
      
    End    
  
  Else If @Reptype = '23'   
    Begin  
  --  **** Margin Cash Repayment.  
    Set @Strsql = "select  Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +  
     "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +  
     "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +  
     "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' and A.Vtyp = 23 "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
    If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
    End  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"   
     End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"  
     End  
     
   /* Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration" */  
    End  
  
  Else If @Reptype = '24'      
    Begin  
  --  **** Margin Journal Entries.(Vtyp = 24)  
      
    Set @Strsql = "select  A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, "+  
     " A.Amount Vamt, C.Narration From Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +  
     "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode And A.Booktype = B.Booktype " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     /*if(Trim(Strbankcode) <> "")   
      'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"       
     End If */  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
       Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
     End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') "   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration  " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '3'   
    Begin  
  --  **** Payment Bank.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +  
     "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration, D.CLTCODE as ctl From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +  
     "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End  
       
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Inner Join Ledger1 C On A.Vno = C.Vno " +  
     "and A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +  
     "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )"   
     End  
    
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End   
     If @VnoFr <> '' or @VnoTo <> ''   
       Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
      End   
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, " +  
       "c.Dddt, A.Narration,D.Cltcode Order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '4'   
    Begin  
  --  **** Payment Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "from Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 4 And Drcr = 'C' "  
     If @Frombankcode <> ''   
  Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"   
     End   
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +  
     "and A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "   
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''    
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End   
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
       "order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "   
    End  
  
  Else If @Reptype = '2'   
    Begin  
  --  **** Receipt Bank.  
    Set @Strsql = "select  C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +  
     "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration, D.CLTCODE as ctl From Ledger A Inner Join " +  
     "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "' )"  
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     "inner Join Acmast B On A.Cltcode = B.Cltcode " +  
     "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +  
     "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +  
     "and A.Vdt < = '" + @Todate + " 23:59:59' "  
    If @Chqno <> ''    
     Begin  
      Set @Strsql = @Strsql + "and C.Ddno = '" + @Chqno + "' "   
     End    
    If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
    If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
        Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration,D.Cltcode Order By A.Vno, A.Vdt, A.Drcr Desc " */  
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc "  
    End  
  
  Else If @Reptype = '1'   
    Begin  
  --  **** Receipt Cash.  
    Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 1 And Drcr = 'D' "  
     If @Frombankcode <> ''   
     Begin  
      Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"       
     End  
     Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +  
     " Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +  
     " And A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "  
     If @VamtFr <> '' or @VamtTo <> ''   
     Begin  
      Set @Strsql = @Strsql + "and A.vamt between " + @VamtFr + " And " + @VamtTo + " "  
     End  
     If @VnoFr <> '' or @VnoTo <> ''   
        Begin  
         Set @Strsql = @Strsql + "and A.vno between '" + @VnoFr + "'  And  '" + @VnoTo + "' "  
       End  
     If @Fromclientid <> ''  
     Begin  
      Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')"   
     End  
   /* Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +  
     "order By A.Vno, A.Vdt, A.Drcr Desc " */  
   Set @Strsql = @Strsql + " order By A.Vno, A.Vdt, A.Drcr Desc "  
  -----else Raiserror ('50001 : No Voucher Type Found For Branch.', 0, 13)  
   End  
End  
  
Print @Strsql  
Execute ( @Strsql )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_VOUCHERREPORT_NEW
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SP_VOUCHERREPORT_NEW    Script Date: 9/17/2007 10:25:06 AM ******/  
  
/****** RECREATED BY BHARAT ON SEP 11 2007 ******/   
/****** Execute SP_VOUCHERREPORT_NEW '2','Jan  1 2008', 'Apr 16 2008','BANK01','ZZZZZZZZZZZZ', '0A146','0A146','broker', 'broker','VOUDT','', '','',100000,  '',''  ****/  
  
CREATE PROCEDURE SP_VOUCHERREPORT_NEW    
(    
 @VNOTYPE VARCHAR(2),     
 @FROMDATE VARCHAR(11),     
 @TODATE VARCHAR(11),     
 @FROMBANKCD VARCHAR(10),     
 @TOBANKCD VARCHAR(10),     
 @FROMCLIENTID VARCHAR(10),     
 @TOCLIENTID VARCHAR(10),     
 @STATUSID VARCHAR(12),     
 @STATUSNAME VARCHAR(12),     
 @DATETYPE VARCHAR(6),    
 @FROMVAMT VARCHAR(20),    
 @TOVAMT VARCHAR(20),    
 @CHQNUM  VARCHAR(15),    
 @FROMVNO VARCHAR(12),    
 @TOVNO VARCHAR(12)    
)    
AS  
DECLARE @@SQL AS VARCHAR(1000)  
  
PRINT UPPER(@STATUSID)  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
  
  
 IF @VNOTYPE = '1' OR @VNOTYPE = '4'  
 -- RECEIPT CASH   OR PAYMENT CASH  
  BEGIN  
  
  SET @@SQL =" "  
  SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11),L.VDT,109) VDT,L.ACNAME, L.DRCR, L.VAMT, L.NARRATION "  
  SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN "  
  SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = " + @VNOTYPE + " AND "  
            
          IF @VNOTYPE = '1'  
          BEGIN        
     SET @@SQL = @@SQL + " DRCR = 'D' "  
          END   
          ELSE IF @VNOTYPE = '4'  
          BEGIN     
     SET @@SQL = @@SQL + " DRCR = 'C' "   
          END   
       
          IF @FROMBANKCD <> ''  
          BEGIN  
           SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') "   
          END  
  
  SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "  
  SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND "  
    
  IF @VNOTYPE = '1'  
  BEGIN  
  SET @@SQL = @@SQL + " L.DRCR = 'C' "   
  END  
  ELSE IF @VNOTYPE = '4'  
  BEGIN  
  SET @@SQL = @@SQL + " L.DRCR = 'D' "   
  END   
     
  SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "   
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
  
  SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC "   
 END  
   
 ELSE IF @VNOTYPE = '2' OR @VNOTYPE = '3' OR @VNOTYPE = '5' OR @VNOTYPE = '16' OR @VNOTYPE = '17'    
      -- RECEIPT BANK   OR PAYMENT BANK   OR CONTRY ENTRY   OR CHEQUE CANCEL   OR CHEQUE RETURN  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT L1.DDNO, L.VTYP, L.CLTCODE, L.VNO, L.ACNAME, L.DRCR, L.VAMT, L.NARRATION, "  
    
  IF UPPER(@DATETYPE) = 'VOUDT'  
  BEGIN   
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.VDT,109) VDT, "  
  END  
  ELSE   
  BEGIN  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.PDT,109) PDT, "  
  END  
  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L1.DDDT,109) CDT, L.CLTCODE AS ctl FROM LEDGER L INNER JOIN "  
  SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE, LNO FROM LEDGER WHERE VTYP = " + @VNOTYPE + " "  
          IF @VNOTYPE = '2' OR @VNOTYPE = '16'    
          BEGIN        
     SET @@SQL = @@SQL + " AND DRCR = 'D' "  
          END   
          ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'  
          BEGIN     
     SET @@SQL = @@SQL + " AND DRCR = 'C' "   
          END   
            
          IF @FROMBANKCD <> ''  
          BEGIN  
           SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') "   
          END  
  
  SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "  
    
  IF @VNOTYPE = '5'  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.LNO = D.LNO "    
  END   
  SET @@SQL = @@SQL + " INNER JOIN LEDGER1 L1 ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE "  
     
  IF @VNOTYPE = '5'  
  BEGIN  
  SET @@SQL  = @@SQL + " AND L1.LNO = L.LNO "  
  END  
    
  SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " "  
    
  IF @VNOTYPE = '2' OR @VNOTYPE = '16'  
  BEGIN  
  SET @@SQL = @@SQL + " AND L.DRCR = 'C' "   
  END  
  ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'  
  BEGIN  
  SET @@SQL = @@SQL + " AND L.DRCR = 'D' "   
  END   
    
  IF UPPER(@DATETYPE) = 'VOUDT'    
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "   
  END  
  ELSE  
  BEGIN  
  SET @@SQL = @@SQL + " AND L.PDT > = '" + @FROMDATE + " 00:00:00' AND L.PDT < = '" + @TODATE + " 23:59:59' "   
  END  
    
  IF @CHQNUM <> ''      
       BEGIN  
  SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "     
      END  
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
 END  
  
 ELSE IF @VNOTYPE = '6' OR @VNOTYPE = '7' OR @VNOTYPE = '8'  
        --   DEBIT NOTE        OR CREDIT NOTE      OR JOURNAL VOUCHER  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11), L.VDT, 109) VDT, L.ACNAME, L.DRCR, "  
   SET @@SQL = @@SQL + " L.VAMT, L.NARRATION, CONVERT(VARCHAR(11), L.CDT, 109) CDT  "  
   SET @@SQL = @@SQL + " FROM LEDGER L "  
   SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " "  
  SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "    
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
  
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC "   
 END     
   
 ELSE IF @VNOTYPE = '19' OR @VNOTYPE = '20'  
 --MARGIN BANK RECEIVED  OR MARGIN BANK PAYMENT  
 BEGIN   
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR, L1.DDNO, "  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), L1.DDDT, 109) CDT "   
  SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND"  
  SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN LEDGER1 L1 ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND "  
  SET @@SQL = @@SQL + " ML.BOOKTYPE = L1.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "  
  SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " AND ML.VDT > = '" + @FROMDATE + " 00:00:00' AND ML.VDT < = '" + @TODATE + " 23:59:59' "   
  
  IF @CHQNUM <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "  
  END   
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + "  "  
  END    
      
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
  
  IF @FROMBANKCD <> ''  
  BEGIN    
   SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC "       
 END   
   
 ELSE IF @VNOTYPE = '22' OR @VNOTYPE = '23' OR @VNOTYPE = '24'  
 --MARGIN CASH RECEIVED  OR MARGIN CASH PAYMENT  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR "  
   SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND "   
  SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "  
  SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " "  
  
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END    
      
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
  
  IF @FROMBANKCD <> ''  
  BEGIN    
   SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC "   
 END   
END  
ELSE   
BEGIN  
 IF @VNOTYPE = '1' OR @VNOTYPE = '4'  
 -- RECEIPT CASH   OR PAYMENT CASH  
  BEGIN  
  SET @@SQL =" "  
  SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11),L.VDT,109) VDT,L.ACNAME, L.DRCR, L.VAMT, L.NARRATION "  
  SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN "  
  SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = " + @VNOTYPE + " AND "  
            
          IF @VNOTYPE = '1'  
          BEGIN        
     		SET @@SQL = @@SQL + " DRCR = 'D' "  
          END   
          ELSE IF @VNOTYPE = '4'  
          BEGIN     
   		  SET @@SQL = @@SQL + " DRCR = 'C' "   
          END   
       
          IF @FROMBANKCD <> ''  
          BEGIN  
           SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') "   
          END  
  
  SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "  
  SET @@SQL = @@SQL + " INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "   
  SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND "  
  SET @@SQL = @@SQL + " A.BRANCHCODE = '" + @STATUSNAME + "' AND "  
    
  IF @VNOTYPE = '1'  
  BEGIN  
  SET @@SQL = @@SQL + " L.DRCR = 'C' "   
  END  
  ELSE IF @VNOTYPE = '4'  
  BEGIN  
  SET @@SQL = @@SQL + " L.DRCR = 'D' "   
  END   
     
  SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "   
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
  
  SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC "   
 END  
  
 ELSE IF @VNOTYPE = '2' OR @VNOTYPE = '3' OR @VNOTYPE = '16' OR @VNOTYPE = '17'  
      -- RECEIPT BANK   OR PAYMENT BANK   OR CHEQUE CANCEL   OR CHEQUE RETURN  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT L1.DDNO, L.VTYP, L.CLTCODE, L.VNO, L.ACNAME, L.DRCR, L.VAMT, L.NARRATION, "  
    
  IF UPPER(@DATETYPE) = 'VOUDT'  
  BEGIN   
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.VDT,109) VDT, "  
  END  
  ELSE   
  BEGIN  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L.PDT,109) PDT, "  
  END  
  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),L1.DDDT,109) CDT, L.CLTCODE AS ctl FROM LEDGER L INNER JOIN "  
  SET @@SQL = @@SQL + " (SELECT VNO, CLTCODE ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = " + @VNOTYPE + " "  
          IF @VNOTYPE = '2' OR @VNOTYPE = '16'    
          BEGIN        
     SET @@SQL = @@SQL + " AND DRCR = 'D' "  
          END   
          ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'  
          BEGIN     
     SET @@SQL = @@SQL + " AND DRCR = 'C' "   
          END   
       
          IF @FROMBANKCD <> ''  
          BEGIN  
           SET @@SQL = @@SQL + " AND (CLTCODE > = '" + @FROMBANKCD + "' AND CLTCODE < = '" + @TOBANKCD + "') "   
          END  
  
  SET @@SQL = @@SQL + " ) D ON L.VNO = D.VNO AND L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE "  
  SET @@SQL = @@SQL + " INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "  
  SET @@SQL = @@SQL + " INNER JOIN LEDGER1 L1 ON L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE "  
  SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND "  
  SET @@SQL = @@SQL + " A.BRANCHCODE = '" + @STATUSNAME + "' "  
    
  IF @VNOTYPE = '2' OR @VNOTYPE = '16'  
  BEGIN  
  SET @@SQL = @@SQL + " AND L.DRCR = 'C' "   
  END  
  ELSE IF @VNOTYPE = '3' OR @VNOTYPE = '17'  
  BEGIN  
  SET @@SQL = @@SQL + " AND L.DRCR = 'D' "   
  END   
    
  IF UPPER(@DATETYPE) = 'VOUDT'    
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "   
  END  
  ELSE  
  BEGIN  
  SET @@SQL = @@SQL + " AND L.PDT > = '" + @FROMDATE + " 00:00:00' AND L.PDT < = '" + @TODATE + " 23:59:59' "   
  END  
    
  IF @CHQNUM <> ''      
       BEGIN  
  SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "     
      END  
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
 END  
  
 ELSE IF @VNOTYPE = '5' OR @VNOTYPE = '6' OR @VNOTYPE = '7'  
 ---     CONTRY ENTRY   OR DEBIT NOTE     OR CREDIT NOTE  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11),L.VDT,109) VDT, L.ACNAME, L.DRCR, L.VAMT, L.NARRATION, "   
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), L.CDT, 109) CDT, A.POBANKNAME, A.POBANKCODE "  
  SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "  
  SET @@SQL = @@SQL + " WHERE A.BRANCHCODE = '" + @STATUSNAME + "' AND L.VTYP = '" + @VNOTYPE + "' AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "   
    
  IF @CHQNUM <> ''      
       BEGIN  
  SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "     
      END  
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC "   
 END  
  
 ELSE IF @VNOTYPE = '8'  
 -- JOURNAL VOUCHER  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT L.VTYP, L.CLTCODE, L.VNO, CONVERT(VARCHAR(11), L.VDT, 109) VDT, L.ACNAME, L.DRCR, "  
   SET @@SQL = @@SQL + " L.VAMT, L.NARRATION "  
   SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "  
   SET @@SQL = @@SQL + " WHERE L.VNO <> '' AND L.VTYP = " + @VNOTYPE + " AND A.BRANCHCODE = '" + @STATUSNAME + "' "  
  SET @@SQL = @@SQL + " AND L.VDT > = '" + @FROMDATE + " 00:00:00' AND L.VDT < = '" + @TODATE + " 23:59:59' "    
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END  
  
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
  
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND L.CLTCODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY L.VNO, L.VDT, L.DRCR DESC "   
 END     
   
 ELSE IF @VNOTYPE = '19' OR @VNOTYPE = '20'  
 --MARGIN BANK RECEIVED  OR MARGIN BANK PAYMENT  
 BEGIN   
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11),ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR, L1.DDNO, "  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), L1.DDDT, 109) CDT "   
  SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND"  
  SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN LEDGER1 L1 ON ML.VNO = L1.VNO AND ML.VTYP = L1.VTYP AND "  
  SET @@SQL = @@SQL + " ML.BOOKTYPE = L1.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "  
  SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " AND A.BRANCHCODE = '" + @STATUSNAME + "' AND ML.VDT > = '" + @FROMDATE + " 00:00:00' AND ML.VDT < = '" + @TODATE + " 23:59:59' "   
  
  IF @CHQNUM <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND L1.DDNO = '" + @CHQNUM + "' "  
  END   
    
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + "  "  
  END    
      
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
  
  IF @FROMBANKCD <> ''  
  BEGIN    
   SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC "       
 END   
   
 ELSE IF @VNOTYPE = '22' OR @VNOTYPE = '23' OR @VNOTYPE = '24'  
 --MARGIN CASH RECEIVED  OR MARGIN CASH PAYMENT  
 BEGIN  
  SET @@SQL = " "  
  SET @@SQL = @@SQL + " SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.PARTY_CODE CLTCODE, L.NARRATION, "  
  SET @@SQL = @@SQL + " CONVERT(VARCHAR(11), ML.VDT, 109) VDT, A.ACNAME, ML.AMOUNT VAMT, ML.DRCR "  
   SET @@SQL = @@SQL + " FROM LEDGER L INNER JOIN MARGINLEDGER ML ON L.VNO = ML.VNO AND L.VTYP = ML.VTYP AND "   
  SET @@SQL = @@SQL + " L.BOOKTYPE = ML.BOOKTYPE INNER JOIN ACMAST A ON ML.PARTY_CODE = A.CLTCODE "  
  SET @@SQL = @@SQL + " WHERE ML.VTYP = " + @VNOTYPE + " AND A.BRANCHCODE = '" + @STATUSNAME + "' "  
  
  IF @FROMVAMT <> '' OR @TOVAMT <> ''  
  BEGIN   
  SET @@SQL = @@SQL + " AND ML.VAMT BETWEEN " + @FROMVAMT + " AND " + @TOVAMT + " "  
  END    
      
  IF @FROMVNO <> '' OR @TOVNO <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.VNO BETWEEN '" + @FROMVNO + "' AND '" + @TOVNO + "' "  
  END   
  
  IF @FROMBANKCD <> ''  
  BEGIN    
   SET @@SQL = @@SQL + " AND (ML.PARTY_CODE > = '" + @FROMBANKCD + "' AND ML.PARTY_CODE < = '" + @TOBANKCD + "') "  
  END   
    
  IF @FROMCLIENTID <> '' OR @TOCLIENTID <> ''   
  BEGIN  
  SET @@SQL = @@SQL + " AND ML.PARTY_CODE BETWEEN '" + @FROMCLIENTID + "' AND '" + @TOCLIENTID + "' "  
  END  
    
  SET @@SQL = @@SQL + " ORDER BY ML.VNO, ML.VDT, ML.DRCR DESC "   
 END  
   
END  
  
PRINT @@SQL  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spa_InsVouchertemp
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 06/24/2004 8:32:35 PM ******/  
  
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 05/10/2004 5:29:35 PM ******/  
  
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 02/18/2003 10:25:07 AM ******/  
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 01/27/2003 9:57:08 PM ******/  
CREATE PROCEDURE Spa_InsVouchertemp  
 @vno varchar(20),  
 @vtype varchar(2),  
 @booktype varchar(2),  
 @billflag char(1),  
 @costflag char(1),  
 @sid varchar(20)  
 AS  
declare @@tmpcat varchar(50),  
@@tmplno varchar(3),  
@@tmpcost varchar(50),  
@@tmpcostname varchar(50),  
@@tmpexists integer,  
@@tmpcltcode varchar(16),  
@@CNo Cursor  
  
if @billflag=1  
begin  
insert into tempbilldetails   
/*  
 select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,  
 b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno   
 from matchdetails m left outer join billmatch b on m.vno=b.vno and m.vtype=b.vtype and m.booktype= b.booktype and   
 m.lno=b.lno and b.vtype=15 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype    
 and m.description not like 'Advances%' */  
  
  
 select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,  
 b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno   
 from billmatch b left outer join matchdetails m on b.vno=m.vno and b.vtype=m.vtype and b.booktype= m.booktype and   
 b.lno=m.lno and b.party_code = m.party_code and b.vtype=15  
 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype  and m.description not like 'Advances%'  
end  
  
  
If @costflag=1  
begin  
 insert into templedger2 (vtype,vno,lno,drcr,paidamt,costcode,BookType,sessionid,party_code)  
 select distinct vtype,vno,lno,drcr,camt,costcode,BookType,sessionid=@sid,cltcode  
 from ledger2  where vno= @vno and vtype=@vtype and booktype= @booktype  
  
  
 Set @@Cno = Cursor For   
 select distinct lno,costcode,cltcode  
 from ledger2  where vno= @vno  and vtype=@vtype and booktype= @booktype  
 Open @@CNo   
 Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode  
 While @@Fetch_Status = 0   
 Begin  
  select @@tmpexists = (select count(*) as cnt from branchaccounts where BrControlAc =  @@tmpcltcode)  
  if @@tmpexists = 0  
  begin  
   select @@tmpcat = (select distinct top 1 c.category from category c, costmast m   
   where c.catcode = m.catcode and m.costcode=@@tmpcost)  
   update templedger2   set category= @@tmpcat where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and  party_code =@@tmpcltcode  
  end   
  else   
  begin  
   select @@tmpcat = 'BRANCH'  
   update templedger2   set category= 'BRANCH' where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code =@@tmpcltcode  
  end  
 print @@tmpcost   
 select @@tmpcostname = (select distinct top 1 m.COSTNAME from category c, costmast m where c.catcode = m.catcode and m.costcode= @@tmpcost)  
 update templedger2 set branch = @@tmpcostname  where sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code = @@tmpcltcode and costcode=@@tmpcost  
 select @@tmpcat= ''  
 select @@tmpcostname =''  
 select @@tmpcltcode = ''  
 select @@tmpcost=''  
 Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode  
 end  
 Close @@CNo  
 DeAllocate @@CNo  
  
 delete from templedger2 where party_code in ( select BrControlAc from branchaccounts)  
 update templedger2 set costflag = 'A', rowid = lno  
        where upper(category) = 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno  
 update templedger2 set costflag = 'A', rowid = lno  
        where upper(category) <> 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------

CREATE PROC Tbl @TblName VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEST_AGEING
-- --------------------------------------------------
--exec Ageingcursor_NEW1_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'

CREATE PROCEDURE TEST_AGEING
                @fromparty   VARCHAR(10),
                @toparty     VARCHAR(10),
                @opendate    VARCHAR(11),
                @todate      VARCHAR(11),
                @Reporttype  VARCHAR(15),
                @family      VARCHAR(10),
                @amoutgtthan MONEY,
                @ageoption   VARCHAR(1),
                @dttype      VARCHAR(3),
                @statusid    VARCHAR(10),
                @statusname  VARCHAR(25),
                @Days1       INT  = 6,
                @Days2       INT  = 29,
                @Days3       INT  = 90,
                @Days4       INT  = 180,
                @Days5       INT  = 181,
                @FrSb        VARCHAR(10)  = '0',
                @ToSb        VARCHAR(10)  = 'ZZZZ'
                                            
AS

  DECLARE  @@balcur      AS CURSOR,
           @@baldate     AS VARCHAR(11),
           @@openbaldt   AS VARCHAR(11),
           @@balamt      AS MONEY,
           @@ocltcode    AS VARCHAR(10),
           @@vtyp        AS SMALLINT,
           @@vno        VARCHAR(12),
           @@EVdt        AS DATETIME,
           @@vamt        AS MONEY,
           @@closbal     AS MONEY,
           @@cltcode     AS VARCHAR(10),
           @@Branchcode  AS VARCHAR(25),
           @@area        AS VARCHAR(25),
           @@drcr        AS VARCHAR(1),
           @@startdt     AS DATETIME
                            
  PRINT 'Strated '
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SET NOCOUNT ON
  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SELECT @@startdt = (SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@todate)),
                                          109),11))
                     
  IF UPPER(@statusid) = 'BROKER'
    BEGIN
      SELECT @@branchcode = '%'
      
      SELECT @@area = '%'
    END
  ELSE
    IF UPPER(@statusid) = 'BRANCH'
      BEGIN
        SELECT @@branchcode = RTRIM(@statusname)
        
        SELECT @@area = '%'
      END
    ELSE
      IF UPPER(@statusid) = 'AREA'
        BEGIN
          SELECT @@branchcode = '%'
          
          SELECT @@area = RTRIM(@statusname)
        END
        
  SELECT CLTCODE,
         VDT         AS BALDATE,
         VAMT        CLOSBAL,
         AGEDAYS = 0
  INTO   #TEMPAGEING
  FROM   LEDGER
  WHERE  1 = 2
  
  SELECT CLTCODE,
         VDT         AS BALDATE,
         VAMT        CLOSBAL,
         AGEDAYS = 0
  INTO   #TEMPAGEING1
  FROM   LEDGER
  WHERE  1 = 2
             
  SELECT *
  INTO   #LEDGER
  FROM   LEDGER
  WHERE  1 = 2
             
  SELECT CLTCODE,
         VTYP,
         VNO,
         EDT     AS EVDT,
         VAMT,
         VAMT    CLOSBAL
  INTO   #LEDGERCURSOR
  FROM   LEDGER
  WHERE  1 = 2
             
  IF @dttype = 'vdt'
    BEGIN
      SELECT @@openbaldt = LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11)
      FROM   LEDGER
      WHERE  VTYP = '18'
             AND VDT < = @opendate
                         
      IF UPPER(@Reporttype) = 'PARTY'
        BEGIN
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     LEDGER L,
                   MSAJAG.DBO.CLIENT1 C1,
                   MSAJAG.DBO.CLIENT2 C2
          WHERE    L.CLTCODE = C2.PARTY_CODE
                   AND C1.CL_CODE = C2.CL_CODE
                   AND VDT >= @@openbaldt + ' 00:00:00'
                   AND VDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND C1.BRANCH_CD LIKE @@branchcode + '%'
                   AND AREA LIKE @@area + '%'
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
          
          INSERT INTO #TEMPAGEING
          SELECT   CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CLOSBAL),
                   AGEDAYS = 0
          FROM     #TEMPAGEING1
          GROUP BY CLTCODE
          ORDER BY CLTCODE
        END
          
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  VDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
        END
        
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   L.CLTCODE,
                       VTYP,
                       VNO,
                       VDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       #TEMPAGEING A
              WHERE    CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND L.CLTCODE = A.CLTCODE
                       AND VDT <= @todate + ' 23:59:59'
                       --
                       AND VTYP <> '18'
              ORDER BY L.CLTCODE,
                       VDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND L.CLTCODE = A.CLTCODE
                         AND VDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         VDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    DRCR = (CASE 
                                   WHEN CLOSBAL >= 0 THEN 'd'
                                   ELSE 'c'
                                 END)
                         AND L.CLTCODE = A.CLTCODE
                         AND VDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         VDT DESC,
                         VTYP,
                         VNO
              END
        END

    END
    
  ELSE
    BEGIN
      SELECT @@openbaldt = LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDT),0),109),11)
      FROM   LEDGER
      WHERE  VTYP = '18'
             AND EDT < = @opendate
                         
      IF UPPER(@Reporttype) = 'PARTY'
        BEGIN
          INSERT INTO #TEMPAGEING1
          SELECT   L.CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CASE 
                                   WHEN DRCR = 'd' THEN VAMT
                                   ELSE -VAMT
                                 END),
                   AGEDAYS = 0
          FROM     LEDGER L,
                   ACMAST A,
                   MSAJAG.DBO.CLIENT1 C1
          WHERE    L.CLTCODE = A.CLTCODE
                   AND L.CLTCODE = C1.CL_CODE
                   AND EDT >= @@openbaldt + ' 00:00:00'
                   AND EDT <= @todate + ' 23:59:59'
                   AND L.CLTCODE >= @fromparty
                   AND L.CLTCODE <= @toparty
                   AND A.BRANCHCODE LIKE @@branchcode + '%'
                   AND A.ACCAT = 4
                   AND C1.SUB_BROKER >= @FrSb
                   AND C1.SUB_BROKER <= @ToSb
          GROUP BY L.CLTCODE
          ORDER BY L.CLTCODE
          
          INSERT INTO #TEMPAGEING
          SELECT   CLTCODE,
                   BALDATE = @todate,
                   CLOSBAL = SUM(CLOSBAL),
                   AGEDAYS = 0
          FROM     #TEMPAGEING1
          GROUP BY CLTCODE
          ORDER BY CLTCODE
                   
        END
           
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          INSERT INTO #LEDGER
          SELECT *
          FROM   LEDGER
          WHERE  EDT <= @todate + ' 23:59:59'
                 AND CLTCODE IN (SELECT DISTINCT CLTCODE
                                 FROM   #TEMPAGEING)
        END
        
      IF UPPER(@Reporttype) = 'PARTY'
          OR UPPER(@Reporttype) = 'FAMILYPARTY'
        BEGIN
          IF UPPER(RTRIM(@ageoption)) = 'D'
            BEGIN
              INSERT INTO #LEDGERCURSOR
              SELECT   L.CLTCODE,
                       VTYP,
                       VNO,
                       EDT,
                       VAMT,
                       CLOSBAL
              FROM     #LEDGER L,
                       #TEMPAGEING A
              WHERE    CLOSBAL >= 0
                       AND DRCR = (CASE 
                                     WHEN CLOSBAL >= 0 THEN 'd'
                                     ELSE 'c'
                                   END)
                       AND L.CLTCODE = A.CLTCODE
                       AND EDT <= @todate + ' 23:59:59'
                       --
                       AND VTYP <> '18'
              ORDER BY L.CLTCODE,
                       EDT DESC,
                       VTYP,
                       VNO
            END
            
          ELSE
            IF UPPER(RTRIM(@ageoption)) = 'C'
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGEREDT L,
                         #TEMPAGEING A
                WHERE    CLOSBAL < 0
                         AND DRCR = (CASE 
                                       WHEN CLOSBAL >= 0 THEN 'd'
                                       ELSE 'c'
                                     END)
                         AND L.CLTCODE = A.CLTCODE
                         AND EDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
              
            ELSE
              BEGIN
                INSERT INTO #LEDGERCURSOR
                SELECT   L.CLTCODE,
                         VTYP,
                         VNO,
                         EDT,
                         VAMT,
                         CLOSBAL
                FROM     #LEDGER L,
                         #TEMPAGEING A
                WHERE    DRCR = (CASE 
                                   WHEN CLOSBAL >= 0 THEN 'd'
                                   ELSE 'c'
                                 END)
                         AND L.CLTCODE = A.CLTCODE
                         AND EDT <= @todate + ' 23:59:59'
                         --
                         AND VTYP <> '18'
                ORDER BY L.CLTCODE,
                         EDT DESC,
                         VTYP,
                         VNO
              END
        END
        
    END
    
  SET @@balcur = CURSOR FOR SELECT   CLTCODE,
                                     VTYP,
                                     VNO,
                                     EVDT,
                                     VAMT,
                                     CLOSBAL
                            FROM     #LEDGERCURSOR
                            ORDER BY CLTCODE,
                                     EVDT DESC,
                                     VTYP,
                                     VNO
  
  SELECT CLTCODE,
         VAMT    BALAMT,
         0       AGEDAYS,
         DRCR
  INTO   #FINTEMPAGEING
  FROM   #LEDGER
  WHERE  1 = 2
             
  OPEN @@balcur
  
  FETCH NEXT FROM @@balcur
  INTO @@cltcode,
       @@vtyp,
       @@vno,
       @@EVdt,
       @@vamt,
       @@closbal
       
  WHILE @@FETCH_STATUS = 0
    BEGIN
      SELECT @@ocltcode = @@cltcode
      
      SELECT @@balamt = ABS(@@closbal)
      
      IF @@closbal >= 0
        BEGIN
          SELECT @@drcr = 'd'
        END
      ELSE
        BEGIN
          SELECT @@drcr = 'c'
        END
        
      WHILE @@FETCH_STATUS = 0
            AND @@ocltcode = @@cltcode
            AND @@balamt > 0
        BEGIN
          IF @@balamt >= @@vamt
            BEGIN
              INSERT INTO #FINTEMPAGEING
              SELECT @@cltcode,
                     @@vamt,
                     DATEDIFF(DAY,@@EVdt,@todate),
                     @@drcr
              
              SELECT @@balamt = @@balamt - @@vamt
            END
            
          ELSE
            BEGIN
              INSERT INTO #FINTEMPAGEING
              SELECT @@cltcode,
                     @@balamt,
                     DATEDIFF(DAY,@@EVdt,@todate),
                     @@drcr
              
              SELECT @@balamt = @@balamt - @@vamt
            END
            
          FETCH NEXT FROM @@balcur
          INTO @@cltcode,
               @@vtyp,
               @@vno,
               @@EVdt,
               @@vamt,
               @@closbal
        END
        
      IF @@balamt > 0
        BEGIN
          INSERT INTO #FINTEMPAGEING
          SELECT @@ocltcode,
                 @@balamt,
                 181,
                 @@drcr
          
          SELECT @@balamt = @@balamt - @@vamt
        END
        
      WHILE @@FETCH_STATUS = 0
            AND @@ocltcode = @@cltcode
        BEGIN
          FETCH NEXT FROM @@balcur
          INTO @@cltcode,
               @@vtyp,
               @@vno,
               @@EVdt,
               @@vamt,
               @@closbal
        END
    END
    
  CLOSE @@balcur
  
  DEALLOCATE @@balcur
  
  PRINT 'cursor closed'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days1,
           DRCR
  INTO     #AGEINGLIST
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= 0
           AND AGEDAYS <= @Days1
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days2,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days1 + 1
           AND AGEDAYS <= @Days2
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days3,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days2 + 1
           AND AGEDAYS <= @Days3
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days4,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days3 + 1
           AND AGEDAYS <= @Days4
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  INSERT INTO #AGEINGLIST
  SELECT   CLTCODE,
           BALANCE = SUM(BALAMT),
           AGEDAYS = @Days5,
           DRCR
  FROM     #FINTEMPAGEING
  WHERE    AGEDAYS >= @Days5
  GROUP BY CLTCODE,DRCR
  ORDER BY CLTCODE,
           DRCR
           
  PRINT 'done'
  
  PRINT CONVERT(DATETIME,GETDATE(),113)
  
  SELECT   A1.CLTCODE,
           SHORT_NAME = A2.SHORT_NAME,
           BALANCE,
           AGEDAYS,
           DRCR,
           A2.BRANCH_CD,
           A2.SUB_BROKER,
           B.BRANCH,
           S.NAME
  FROM     #AGEINGLIST A1,
           MSAJAG.DBO.CLIENT1 A2,
           MSAJAG.DBO.SUBBROKERS S,
           MSAJAG.DBO.BRANCH B--msajag.dbo.clientmaster a2--account.dbo.acmast  a2         
  WHERE    BALANCE >= @amoutgtthan
           AND A1.CLTCODE = A2.CL_CODE
           AND A2.BRANCH_CD = B.BRANCH_CODE
           AND A2.SUB_BROKER = S.SUB_BROKER
  ORDER BY A2.BRANCH_CD,
           A2.SUB_BROKER,
           A1.CLTCODE,
           A2.SHORT_NAME
           
  DROP TABLE #TEMPAGEING
  
  DROP TABLE #LEDGER
  
  DROP TABLE #LEDGERCURSOR
  
  DROP TABLE #AGEINGLIST
  
  DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UNCLEARED_CHEQUES
-- --------------------------------------------------
CREATE PROC UNCLEARED_CHEQUES  
@FROM_CODE VARCHAR(10),  
@TO_CODE VARCHAR(10),  
@VDT VARCHAR(11),
@BANKCODE_FR VARCHAR(10) = '0', 
@BANKCODE_TO VARCHAR(10) = 'Z'
  
AS  
  
SELECT   
 L.VNO, VDT = CONVERT(VARCHAR(10), VDT, 103), EDT = CONVERT(VARCHAR(10), EDT, 103),   
 CLTCODE, ACNAME, DDNO, VAMT, BANK_CODE  
FROM   
 (SELECT * FROM LEDGER WHERE VDT <= @VDT + ' 23:59' AND EDT > @VDT + ' 23:59' AND CLTCODE BETWEEN @FROM_CODE AND @TO_CODE AND VTYP = 2) L,   
 LEDGER1 L1,
 (SELECT VNO, VTYP, BOOKTYPE, BANK_CODE = CLTCODE FROM LEDGER WHERE CLTCODE BETWEEN @BANKCODE_FR AND @BANKCODE_TO) L2 
WHERE  
 L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO  
 AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> BANK_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_CHQ_SETTING
-- --------------------------------------------------
  
CREATE PROC [dbo].[UPDATE_CHQ_SETTING]  
(  
 @STRING VARCHAR(1000)  
)  
AS   
SELECT * INTO #CHQ FROM SPLIT(@STRING,'|')  
SELECT * FROM #CHQ  
DROP TABLE #CHQ

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_FLDAUTO
-- --------------------------------------------------
CREATE PROCEDURE UPDATE_FLDAUTO
	@VDT VARCHAR(11)
AS

UPDATE V2 SET FINYEAR = P.FLDAUTO FROM V2_LASTVNO V2, PARAMETER P
WHERE VTYP IN(15, 21) AND @VDT BETWEEN SDTCUR AND LDTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATEACMAST
-- --------------------------------------------------
CREATE PROC [dbo].[UPDATEACMAST]  
 @EXCHANGE VARCHAR(20),  
 @SEGMENT VARCHAR(20),  
 @COMPANY VARCHAR(100)  
AS  
DECLARE  
 @@SHAREDB AS VARCHAR(50),  
 @@GRPCODE AS VARCHAR(50),  
 @@SQL AS VARCHAR(2000)  

SELECT @@SHAREDB = ''  
SELECT TOP 1  
 @@SHAREDB = SHAREDB  
FROM  
 PRADNYA.DBO.MULTICOMPANY  
WHERE  
 EXCHANGE = @EXCHANGE  
 AND SEGMENT = @SEGMENT  
 AND COMPANYNAME = @COMPANY  
 AND PRIMARYSERVER = 1  
  
SELECT @@GRPCODE = ''  
SELECT  
 @@GRPCODE = ISNULL(GRPCODE, '')  
FROM  
 OWNER O,  
 GRPMAST G  
WHERE  
 O.CLIENTGROUP = G.GRPNAME  
IF @@SHAREDB = ''  
 BEGIN  
  SELECT ERR = 1, DESCRIPTION = 'SHARE DATABASE NOT FOUND.CANNOT CONTINUE...'  
  RETURN  
 END  
BEGIN TRANSACTION  
SELECT @@SQL = "INSERT INTO ACMAST SELECT LONG_NAME, LONG_NAME , (CASE WHEN CL_TYPE = 'REM' THEN 'LIABILITY' ELSE 'ASSET' END), (CASE WHEN CL_TYPE = 'REM' THEN '3' ELSE '4' END), '', PARTY_CODE , '', "  
SELECT @@SQL = @@SQL + "'" + @@GRPCODE + "', '', 0, BRANCH_CD, '0', 'C', 'HDFC BANK', 'MUMBAI', 'GB019' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), " + LTRIM(RTRIM(@@SHAREDB))  
SELECT @@SQL = @@SQL + ".DBO.CLIENT2 C2 (NOLOCK) WHERE C1.CL_CODE=C2.CL_CODE "  
SELECT @@SQL = @@SQL + "AND NOT EXISTS (SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4) AND C2.PARTY_CODE = A.CLTCODE) "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONG_NAME, LONGNAME = LONG_NAME, "  
SELECT @@SQL = @@SQL + "BRANCHCODE = BRANCH_CD, GRPCODE = '" + @@GRPCODE + "' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), "  
SELECT @@SQL = @@SQL + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT2 C2 (NOLOCK) "  
SELECT @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = ACMAST.CLTCODE "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONGNAME WHERE ACNAME <> LONGNAME "  
SELECT @@SQL = @@SQL + "UPDATE LEDGER SET ACNAME = A.LONGNAME "  
SELECT @@SQL = @@SQL + "FROM ACMAST A (NOLOCK) WHERE LEDGER.CLTCODE = A.CLTCODE "  
SELECT @@SQL = @@SQL + "AND ISNULL(LEDGER.ACNAME, '') <> A.LONGNAME "  
  
PRINT @@SQL  
EXEC (@@SQL)  
COMMIT TRANSACTION  
SELECT ERR = 0, DESCRIPTION = 'ACMAST UPDATED SUCCESSFULLY...'  
  
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Acc_MoneypayoutAdhoc
-- --------------------------------------------------






CREATE Procedure V2_Acc_MoneypayoutAdhoc    
   @stltypno varchar (16),          
   @strPayMode varchar (4),          
   @effdate varchar(11),          
   @sdate varchar(11),          
   @setttype1 varchar(2),          
   @setttype2 varchar(2),          
   @statusname varchar(30),          
   @branchcode varchar(10),
   @NoRec varchar(5) = '250'
        
As         

/*
EXEC V2_Acc_MoneypayoutAdhoc 
    @stltypno = '2005125', 
    @strPayMode = 'BOTH', 
    @effdate = 'Feb 17 2006', 
    @sdate = 'Apr  1 2005', 
    @setttype1 = 'N', 
    @setttype2 = 'W', 
    @statusname = 'broker', 
    @branchcode = 'ALL', 
    @NoRec = '1000'
*/
        
Declare         
   @@SettNo Varchar(7),         
   @@PendingCnt Varchar(11),         
   @@MaxDate Varchar(11), 
   @@SQL Varchar(3000)
        
Set @@SettNo = Left(@stltypno, 7)        
Set @@PendingCnt = 0        
Set @@MaxDate = 'Jan  1 1900'        

Set Transaction Isolation Level Read Uncommitted    
     
/*=============================================================================
      LOOP for Broker Login to Rejection of Requests
            1. All Old Date Pending Requests
            2. Multiple Requests. All requests other than the first request of the lowest amount are rejected. 
=============================================================================*/

      If upper(@statusname) = 'BROKER'         
      Begin         
          SET @@PendingCnt = 
                (
                      SELECT 
                          Count(*) 
                      FROM SettPayout WITH(NoLock) 
                      WHERE status='P' 
                          AND GenFlag='A'
                )        
           
          If @@PendingCnt <> 0        
          Begin        
            SET @@MaxDate = 
              (
                    SELECT 
                        Left(Convert(Varchar, Max(RequestDt), 109), 11) 
                    FROM SettPayout WITH(NoLock) 
                    WHERE status='P' 
                        AND GenFlag='A' 
              )
          End        
           
            /*=============================================================================
                        1. All Old Date Pending Requests
            =============================================================================*/
                      UPDATE 
                          SettPayout 
                          SET status = 'R' 
                      WHERE status='P' 
                          AND GenFlag='A' 
                          AND RequestDt < @@MaxDate 
           
          SELECT 
              CltCode, 
              Amt = min(AmountToBePaid), 
              SrNo = 0 
          INTO #Payout_Reject 
          FROM SettPayout WITH(NoLock) 
          WHERE status='P' 
              AND GenFlag='A' 
          GROUP BY CltCode 
          HAVING Count(*) > 1         
           
          UPDATE 
              #Payout_Reject 
              SET SrNo = S.SrNo 
          FROM 
              (
                    SELECT 
                        #Payout_Reject.CltCode, 
                        SrNo = Min(SettPayout.SrNo) 
                    FROM SettPayout WITH(NoLock), 
                        #Payout_Reject WITH(NoLock) 
                    WHERE status='P' 
                        AND GenFlag='A' 
                        AND SettPayout.CltCode = #Payout_Reject.CltCode 
                        AND AmountToBePaid = Amt 
                    GROUP BY #Payout_Reject.CltCode 
              ) 
              S, 
              #Payout_Reject P WITH(NoLock) 
          WHERE S.CltCode = P.CltCode 
           
      /*=============================================================================
                  2. Multiple Requests. All requests other than the first request of the lowest amount are rejected. 
      =============================================================================*/
                UPDATE 
                    SettPayout 
                    SET Status = 'R' 
                WHERE status='P' 
                    AND GenFlag='A' 
                    AND CltCode In 
                          (
                                SELECT 
                                    CltCode 
                                FROM #Payout_Reject WITH(NoLock)
                          ) 
                    AND SrNo Not In 
                          (
                                SELECT 
                                    SrNo 
                                FROM #Payout_Reject WITH(NoLock)
                          )   
      End        
              
/*=============================================================================
      Temp Table Creation: 
            1. #LedgerTmp: Final Table for Ledger Balances And Bill Amount
            2. #LedgerBillTmp: Table for populating Bill Amounts as posted in SettPayout Table for Pending Requests. 
=============================================================================*/
      create table #LedgerTmp         
      (         
         cltcode varchar(10),          
         acname varchar(100),           
         ChequeName varchar(100),          
         branchcode varchar(10),          
         accat varchar(10),          
         BtoBPayment Int,          
         LedgerBalance money,          
         LedgerBalanceNSE money,          
         LedgerBalanceBSE money,          
         LedgerBalanceFNO money,          
         BillAmt money,          
         futurepayout money,          
         shOrtage money,          
         Amounttobepaid money,         
         Narration varchar (234)  NULL, 
         Remark varchar (234)  NULL,         
         Paymode varchar(1),         
         Bankcode varchar(10)         
      )         
              
      CREATE TABLE [#LedgerBillTmp]         
      (         
         [cltcode] [varchar] (10)  NULL ,          
         [branchcode] [varchar] (10)  NULL ,          
         [longname] [varchar] (100)  NULL ,          
         [accat] [char] (10)  NULL ,          
         [BtoBPayment] [Int] NULL ,          
         [PayMode] [char] (1)  NULL ,          
         [POBankcode] [varchar] (10)  NULL,         
         [BillAmt] [money],          
         [Amounttobepaid] [money],         
         [Narration] [varchar] (234)  NULL, 
         [Remark] [varchar] (234)  NULL         
      ) ON [PRIMARY]         
              
     
/*=============================================================================
      Fetching data for Bill Amount from SettPayout Table 
      -------Main Condition: Pending Requests for the Settlement Number provided----------------        
=============================================================================*/
              
Select @@SQL = "      INSERT "
Select @@SQL = @@SQL + "      INTO #LedgerBillTmp "
Select @@SQL = @@SQL + "      SELECT "
Select @@SQL = @@SQL + "      Top " + @NoRec
Select @@SQL = @@SQL + "          S.CltCode, "
Select @@SQL = @@SQL + "          A.BranchCode, "
Select @@SQL = @@SQL + "          longname, "
Select @@SQL = @@SQL + "          accat, "
Select @@SQL = @@SQL + "          BtoBPayment, "
Select @@SQL = @@SQL + "          PayMode, "
Select @@SQL = @@SQL + "          POBankcode, "
Select @@SQL = @@SQL + "          BillAmt, "
Select @@SQL = @@SQL + "          Amounttobepaid, "
Select @@SQL = @@SQL + "          Narration, "
Select @@SQL = @@SQL + "          Remark "
Select @@SQL = @@SQL + "      FROM SettPayout S WITH(NoLock), "
Select @@SQL = @@SQL + "          Acmast A WITH(NoLock) "
Select @@SQL = @@SQL + "      WHERE S.CltCode = A.CltCode "
Select @@SQL = @@SQL + "          AND A.accat In (4, 104) "
Select @@SQL = @@SQL + "          AND Status = 'P' "
Select @@SQL = @@SQL + "          AND GenFlag = 'A' "
Select @@SQL = @@SQL + "          AND upper(S.BranchCode) like (Case When upper('" + @branchcode + "') = 'ALL' Then '%' Else upper('" + @branchcode + "') End) "

EXEC (@@SQL)
 
      CREATE  INDEX [Cltcode] ON [dbo].[#LedgerBillTmp]([cltcode]) ON [PRIMARY]         
           
/*===========================================================================
      Calculate NSE Cash Ledger Balances for Clients with Credit in the Selected Settlement 
===========================================================================*/        
      INSERT 
      INTO #LedgerTmp 
      SELECT 
          l.cltcode , 
          acname = a.longname, 
          ChequeName = a.longname, 
          a.branchcode, 
          a.accat, 
          a.BtoBPayment , 
          LedgerBalance = 0, 
          LedgerBalanceNSE = Sum(
                CASE 
                    WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00' 
                    THEN (
                    CASE 
                        WHEN DrCr = 'D' 
                        THEN -Vamt 
                        ELSE Vamt 
                    END
                    )
                    ELSE 0 
                END 
                ) + Sum(
                CASE 
                    WHEN Edt > @effdate + ' 23:59:00' 
                    THEN (
                    CASE 
                        WHEN DrCr = 'D' 
                        THEN -Vamt
                        ELSE 0 
                    END
                    ) 
                    ELSE 0 
                END 
                ), 
          LedgerBalanceBSE = 0, 
          LedgerBalanceFNO = 0, 
          a.BillAmt, 
          futurepayout = 0 , 
          shOrtage=0, 
          a.Amounttobepaid, 
          a.Narration, 
          a.Remark, 
          a.paymode, 
          a.POBankCode 
      FROM #LedgerBillTmp a WITH(NoLock), 
          Account..Ledger l WITH(NoLock) 
      WHERE l.cltcode= a.cltcode 
          AND l.vdt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
      GROUP BY a.branchcode, 
          l.cltcode , 
          a.longname, 
          a.accat, 
          a.BtoBPayment, 
          a.paymode, 
          a.Narration, 
          a.Remark, 
          a.BillAmt, 
          a.Amounttobepaid, 
          a.POBankCode        
      
/*===========================================================================
      Calculate BSE Cash Ledger Balances for Clients with Credit in the Selected Settlement 
===========================================================================*/        
      INSERT 
      INTO #LedgerTmp 
      SELECT 
          l.cltcode , 
          acname = a.longname, 
          ChequeName = a.longname, 
          a.branchcode, 
          a.accat, 
          a.BtoBPayment , 
          LedgerBalance = 0, 
          LedgerBalanceNSE = 0,
          LedgerBalanceBSE = Sum(
                CASE 
                    WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00' 
                    THEN (
                    CASE 
                        WHEN DrCr = 'D' 
                        THEN -Vamt 
                        ELSE Vamt 
                    END
                    )
                    ELSE 0 
                END 
                ) + Sum(
                CASE 
                    WHEN Edt > @effdate + ' 23:59:00' 
                    THEN (
                    CASE 
                        WHEN DrCr = 'D' 
                        THEN -Vamt
                        ELSE 0  
                    END
                    ) 
                    ELSE 0 
                END 
                ), 
          LedgerBalanceFNO = 0, 
          a.BillAmt, 
          futurepayout = 0 , 
          shOrtage=0, 
          a.Amounttobepaid, 
          a.Narration, 
          a.Remark, 
          a.paymode, 
          a.POBankCode 
      FROM #LedgerBillTmp a WITH(NoLock), 
          AccountBSE..Ledger l WITH(NoLock) 
      WHERE l.cltcode= a.cltcode 
          AND l.vdt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
      GROUP BY a.branchcode, 
          l.cltcode , 
          a.longname, 
          a.accat, 
          a.BtoBPayment, 
          a.paymode, 
          a.Narration, 
          a.Remark, 
          a.BillAmt, 
          a.Amounttobepaid, 
          a.POBankCode          
      
/*===========================================================================
      Calculate NSE Derivative Ledger Balances for Clients with Credit in the Selected Settlement 
===========================================================================*/        
      INSERT 
      INTO #LedgerTmp 
      SELECT 
          l.cltcode , 
          acname = a.longname, 
          ChequeName = a.longname, 
          a.branchcode, 
          a.accat, 
          a.BtoBPayment , 
          LedgerBalance = 0, 
          LedgerBalanceNSE = 0, 
          LedgerBalanceBSE = 0, 
          LedgerBalanceFNO = Sum(
                CASE 
                    WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00' 
                    THEN (
                    CASE 
                        WHEN DrCr = 'D' 
                        THEN -Vamt 
                        ELSE Vamt 
                    END
                    )
                    ELSE 0 
                END 
                ) + Sum(
                CASE 
                    WHEN Edt > @effdate + ' 23:59:00' 
                    THEN (
                    CASE 
                        WHEN DrCr = 'D' 
                        THEN -Vamt 
                        ELSE 0 
                    END
                    ) 
                    ELSE 0 
                END 
                ), 
          a.BillAmt, 
          futurepayout = 0 , 
          shOrtage=0, 
          a.Amounttobepaid, 
          a.Narration, 
          a.Remark, 
          a.paymode, 
          a.POBankCode 
      FROM #LedgerBillTmp a WITH(NoLock), 
          AccountFO..Ledger l WITH(NoLock) 
      WHERE l.cltcode= a.cltcode 
          AND l.vdt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
      GROUP BY a.branchcode, 
          l.cltcode , 
          a.longname, 
          a.accat, 
          a.BtoBPayment, 
          a.paymode, 
          a.Narration, 
          a.Remark, 
          a.BillAmt, 
          a.Amounttobepaid, 
          a.POBankCode        
      HAVING Sum(
          CASE 
              WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00' 
              THEN (
              CASE 
                    WHEN DrCr = 'D' 
                    THEN -Vamt 
                    ELSE Vamt 
              END
              )
              ELSE 0 
          END 
          ) + Sum(
          CASE 
              WHEN Edt > @effdate + ' 23:59:00'       
              THEN (
              CASE 
                    WHEN DrCr = 'D' 
                    THEN -Vamt 
                    ELSE 0 
              END
              ) 
              ELSE 0 
          END 
          ) < 0 
          
      CREATE  INDEX [Cltcode] ON [dbo].[#LedgerTmp]([cltcode]) ON [PRIMARY]         
             
/*===========================================================================
      Updating cheque In name From multibankid 
===========================================================================*/        
              
      UPDATE 
          tmp 
          SET ChequeName = m.ChequeName 
      FROM #LedgerTmp tmp, 
          MultiBankId m 
      WHERE m.cltcode = tmp.cltcode           AND m.DefaultBank = '1' 
              
      SELECT 
          PartyCode = l.cltcode, 
          PartyName = l.acname, 
          PartyName = l.chequename, 
          l.branchcode, 
          l.accat, 
          l.BtoBPayment, 
          TOTLedBal = Sum(l.LedgerBalanceNSE) + Sum(l.LedgerBalanceBSE) + Sum(l.LedgerBalanceFNO), 
          NSELedBal = Sum(l.LedgerBalanceNSE), 
          BSELedBal = Sum(l.LedgerBalanceBSE), 
          FNOLedBal = Sum(l.LedgerBalanceFNO), 
          l.BillAmt, 
          l.Futurepayout, 
          l.shOrtage, 
          l.amounttobepaid, 
          l.narration, 
          l.paymode, 
          l.remark, 
          l.bankcode 
      FROM #LedgerTmp l WITH(NoLock)
      GROUP BY l.cltcode, 
          l.acname, 
          l.chequename, 
          l.branchcode, 
          l.accat, 
          l.BtoBPayment, 
          l.BillAmt, 
          l.Futurepayout, 
          l.shOrtage, 
          l.amounttobepaid, 
          l.narration, 
          l.paymode, 
          l.remark, 
          l.bankcode 
      ORDER BY l.branchcode, 
          l.cltcode     


/*  -----------------------------------EOF  ----------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ACC_MONEYPAYOUTADHOC_NEW
-- --------------------------------------------------


CREATE PROCEDURE V2_ACC_MONEYPAYOUTADHOC_NEW
	@STLTYPNO VARCHAR (16),
	@STRPAYMODE VARCHAR (4),
	@EFFDATE VARCHAR(11),
	@SDATE VARCHAR(11),
	@SETTTYPE1 VARCHAR(2),
	@SETTTYPE2 VARCHAR(2),
	@STATUSNAME VARCHAR(30),
	@BRANCHCODE VARCHAR(10),
	@NOREC VARCHAR(5) = '250',
	@REMARK VARCHAR(2) = '',
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@CLTYPE VARCHAR(4) = 'ALL', -- CLTYPE -> [WEB / NON-WEB / ALL]
	@PAYMODE CHAR(1),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7)

AS

	/*
	EXEC V2_ACC_MONEYPAYOUTADHOC_NEW
		@STLTYPNO = '2005125',
		@STRPAYMODE = 'BOTH',
		@EFFDATE = 'FEB 17 2006',
		@SDATE = 'APR  1 2005',
		@SETTTYPE1 = 'N',
		@SETTTYPE2 = 'W',
		@STATUSNAME = 'BROKER',
		@BRANCHCODE = 'ALL',
		@NOREC = '1000',
		@REMARK = '',
		@FPARTY = '0',
		@TPARTY = 'zz',
		@CLTYPE = 'ALL',
		@PAYMODE = 'C'
	*/

	DECLARE
		@@SETTNO VARCHAR(7),
		@@PENDINGCNT VARCHAR(11),
		@@MAXDATE VARCHAR(11),
		@@SQL VARCHAR(3000)

	SET @@SETTNO = LEFT(@STLTYPNO, 7)
	SET @@PENDINGCNT = 0
	SET @@MAXDATE = 'JAN  1 1900'

	SET NOCOUNT ON

	IF @FPARTY = ''
	BEGIN
		SET @FPARTY = '0000000000'
	END

	IF @TPARTY = ''
	BEGIN
		SET @TPARTY = 'ZZZZZZZZZZ'
	END

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	/*=============================================================================
   LOOP FOR BROKER LOGIN TO REJECTION OF REQUESTS
         1. ALL OLD DATE PENDING REQUESTS
         2. MULTIPLE REQUESTS. ALL REQUESTS OTHER THAN THE FIRST REQUEST OF THE LOWEST AMOUNT ARE REJECTED.
	=============================================================================*/

	IF UPPER(@STATUSNAME) = 'BROKER'
	BEGIN
		SET @@PENDINGCNT =
		(
			SELECT
			COUNT(*)
			FROM SETTPAYOUT WITH(NOLOCK)
			WHERE STATUS='P'
			AND GENFLAG='A'
		)

		IF @@PENDINGCNT <> 0
		BEGIN
			SET @@MAXDATE =
			(
				SELECT
				LEFT(CONVERT(VARCHAR, MAX(REQUESTDT), 109), 11)
				FROM SETTPAYOUT WITH(NOLOCK)
				WHERE STATUS='P'
				AND GENFLAG='A'
			)
		END

   /*=============================================================================
               1. ALL OLD DATE PENDING REQUESTS
   =============================================================================*/
		UPDATE
			SETTPAYOUT
		SET
			STATUS = 'R'
		WHERE
			STATUS='P'
			AND GENFLAG='A'
			AND REQUESTDT < @@MAXDATE

		SELECT
			CLTCODE,
			AMT = MIN(AMOUNTTOBEPAID),
			SRNO = 0
		INTO
			#PAYOUT_REJECT
		FROM
			SETTPAYOUT WITH(NOLOCK)
		WHERE
			STATUS='P'
			AND GENFLAG='A'
		GROUP BY
			CLTCODE
		HAVING
			COUNT(*) > 1

		UPDATE
			#PAYOUT_REJECT
		SET
			SRNO = S.SRNO
		FROM
			(
				SELECT
					#PAYOUT_REJECT.CLTCODE,
					SRNO = MIN(SETTPAYOUT.SRNO)
				FROM
					SETTPAYOUT WITH(NOLOCK),
					#PAYOUT_REJECT WITH(NOLOCK)
				WHERE
					STATUS='P'
					AND GENFLAG='A'
					AND SETTPAYOUT.CLTCODE = #PAYOUT_REJECT.CLTCODE
					AND AMOUNTTOBEPAID = AMT
				GROUP BY
					#PAYOUT_REJECT.CLTCODE
			)
			S,
			#PAYOUT_REJECT P WITH(NOLOCK)
		WHERE
			S.CLTCODE = P.CLTCODE

		/*=============================================================================
		2. MULTIPLE REQUESTS. ALL REQUESTS OTHER THAN THE FIRST REQUEST OF THE LOWEST AMOUNT ARE REJECTED.
		=============================================================================*/
		UPDATE
			SETTPAYOUT
		SET
			STATUS = 'R'
		WHERE
			STATUS='P'
			AND GENFLAG='A'
			AND CLTCODE IN
			(
				SELECT
				   CLTCODE
				FROM
					#PAYOUT_REJECT WITH(NOLOCK)
			)
			AND SRNO NOT IN
			(
				SELECT
				   SRNO
				FROM
					#PAYOUT_REJECT WITH(NOLOCK)
			)
	END

	/*=============================================================================
	TEMP TABLE CREATION:
	      1. #LEDGERTMP: FINAL TABLE FOR LEDGER BALANCES AND BILL AMOUNT
	      2. #LEDGERBILLTMP: TABLE FOR POPULATING BILL AMOUNTS AS POSTED IN SETTPAYOUT TABLE FOR PENDING REQUESTS.
	=============================================================================*/
	CREATE TABLE [#LedgerBalanceUp]
	(
		[PartyCode] [varchar] (10) NULL ,
		[PartyName] [varchar] (100) NULL ,
		[ChequeName] [varchar] (100) NULL ,
		[branchcode] [varchar] (10) NULL ,
		[accat] [varchar] (10) NULL ,
		[BtoBPayment] [int] NULL ,
		[TOTLedBal] [money] NULL ,
		[NSELedBal] [money] NULL ,
		[BSELedBal] [money] NULL ,
		[FNOLedBal] [money] NULL ,
		[NETLedBal] [money] NULL ,
		[FAMLedBal] [money] NULL ,
		[Sett_No] [varchar] (7) NULL ,
		[NormalBillAmt] [money] NULL ,
		[T2TBillAmt] [money] NULL ,
		[BillAmt] [money] NULL ,
		[futurepayout] [money] NULL ,
		[shortage] [money] NULL ,
		[Amounttobepaid] [money] NULL ,
		[Paymode] [varchar] (1) NULL ,
		[Bankcode] [varchar] (10) NULL ,
		[GenFlag] [varchar] (1) NULL ,
		[CL_TYPE] [varchar] (3) NULL,
		[FAMILYCODE] [varchar] (10) NULL,
		[RunDate] [datetime] NULL ,
	)

	INSERT INTO
		#LedgerBalanceUp
	EXEC V2_GETLEDGERBALANCE_NEW
		@SDATE,
		@FPARTY,
		@TPARTY,
		'', --@STLNO
		'A', --@GENFLAG
		'HO', --@USER
		@EXCHANGE,
		@SEGMENT,
		@EFFDATE,
		'HO' --@COMP_FOR
	
	CREATE TABLE #LEDGERTMP
	(
		CLTCODE VARCHAR(10),
		ACNAME VARCHAR(100),
		CHEQUENAME VARCHAR(100),
		BRANCHCODE VARCHAR(10),
		ACCAT VARCHAR(10),
		BTOBPAYMENT INT,
		LEDGERBALANCE MONEY,
		LEDGERBALANCENSE MONEY,
		LEDGERBALANCEBSE MONEY,
		LEDGERBALANCEFNO MONEY,
		NETLEDBAL MONEY NULL,
		FAMLEDBAL MONEY NULL,
		BILLAMT MONEY,
		FUTUREPAYOUT MONEY,
		SHORTAGE MONEY,
		AMOUNTTOBEPAID MONEY,
		NARRATION VARCHAR (234) NULL,
		REMARK VARCHAR (234) NULL,
		PAYMODE VARCHAR(1),
		BANKCODE VARCHAR(10)
	)


	SELECT @@SQL = "	INSERT INTO #LEDGERTMP "
	SELECT @@SQL = @@SQL + "	SELECT "
	SELECT @@SQL = @@SQL + "		CLTCODE = L.PartyCode, "
	SELECT @@SQL = @@SQL + "		ACNAME = L.PartyName, "
	SELECT @@SQL = @@SQL + "		CHEQUENAME = L.ChequeName, "
	SELECT @@SQL = @@SQL + "		BRANCHCODE = L.branchcode, "
	SELECT @@SQL = @@SQL + "		ACCAT = L.accat, "
	SELECT @@SQL = @@SQL + "		BTOBPAYMENT = L.BtoBPayment, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCE = L.TOTLedBal, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCENSE = L.NSELedBal, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCEBSE = L.BSELedBal, "
	SELECT @@SQL = @@SQL + "		LEDGERBALANCEFNO = L.FNOLedBal, "
	SELECT @@SQL = @@SQL + "		NETLEDBAL = L.NETLEDBAL, "
	SELECT @@SQL = @@SQL + "		FAMLEDBAL = L.FAMLEDBAL, "
	SELECT @@SQL = @@SQL + "		BILLAMT = S.BILLAMT, "
	SELECT @@SQL = @@SQL + "		FUTUREPAYOUT = L.futurepayout, "
	SELECT @@SQL = @@SQL + "		SHORTAGE = L.shortage, "
	SELECT @@SQL = @@SQL + "		AMOUNTTOBEPAID = S.AMOUNTTOBEPAID, "
	SELECT @@SQL = @@SQL + "		S.NARRATION, "
	SELECT @@SQL = @@SQL + "		S.REMARK, "
	SELECT @@SQL = @@SQL + "		PAYMODE = L.Paymode, "
	SELECT @@SQL = @@SQL + "		BANKCODE = L.Bankcode "
	SELECT @@SQL = @@SQL + "	FROM "
	SELECT @@SQL = @@SQL + "		#LedgerBalanceUp L WITH(NOLOCK), "
	SELECT @@SQL = @@SQL + "		SETTPAYOUT S WITH(NOLOCK) "
	SELECT @@SQL = @@SQL + "	WHERE S.CLTCODE = L.PARTYCODE "
	SELECT @@SQL = @@SQL + "		AND STATUS = 'P' "
	SELECT @@SQL = @@SQL + "		AND S.GENFLAG = 'A' "
	SELECT @@SQL = @@SQL + "		AND UPPER(S.BRANCHCODE) LIKE (CASE WHEN UPPER('" + @BRANCHCODE + "') = 'ALL' THEN '%' ELSE UPPER('" + @BRANCHCODE + "') END) "

	IF @CLTYPE = 'WEB'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND L.CL_TYPE = 'WEB' "
	END
	ELSE IF @CLTYPE = 'NWEB'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND L.CL_TYPE <> 'WEB' "
	END

	IF @PAYMODE <> 'A'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND L.PAYMODE = '" + @PAYMODE + "' "
	END

	IF @REMARK = 'ON'
	BEGIN
		SELECT @@SQL = @@SQL + "	AND S.REMARK <> '' "
	END

	EXEC (@@SQL)

	UPDATE
		TMP
	SET 
		CHEQUENAME = M.CHEQUENAME
	FROM 
		#LEDGERTMP TMP,
		MULTIBANKID M
	WHERE 
		M.CLTCODE = TMP.CLTCODE
		AND M.DEFAULTBANK = '1'
	
	SELECT
		PARTYCODE = L.CLTCODE,
		PARTYNAME = L.ACNAME,
		L.BRANCHCODE,
		L.BTOBPAYMENT,
		TOTLEDBAL = SUM(L.LEDGERBALANCENSE) + SUM(L.LEDGERBALANCEBSE) + SUM(L.LEDGERBALANCEFNO),
		NSELEDBAL = SUM(L.LEDGERBALANCENSE),
		BSELEDBAL = SUM(L.LEDGERBALANCEBSE),
		FNOLEDBAL = SUM(L.LEDGERBALANCEFNO),
		L.BILLAMT,
		L.PAYMODE,
		L.BANKCODE,
		L.REMARK,
		L.SHORTAGE,
		L.AMOUNTTOBEPAID,
		L.NARRATION,
		PARTYNAME = L.CHEQUENAME,
		L.ACCAT,
		L.FUTUREPAYOUT,
		NETLEDBAL = SUM(NETLEDBAL),
		FAMLEDBAL = SUM(FAMLEDBAL)
	FROM 
		#LEDGERTMP L WITH(NOLOCK)
	GROUP BY 
		L.CLTCODE,
		L.ACNAME,
		L.CHEQUENAME,
		L.BRANCHCODE,
		L.ACCAT,
		L.BTOBPAYMENT,
		L.BILLAMT,
		L.FUTUREPAYOUT,
		L.SHORTAGE,
		L.AMOUNTTOBEPAID,
		L.NARRATION,
		L.PAYMODE,
		L.REMARK,
		L.BANKCODE
	ORDER BY 
		L.BRANCHCODE,
		L.CLTCODE

/*  -----------------------------------EOF  ----------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ACC_MONEYPAYOUTCOMBINED
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[V2_ACC_MONEYPAYOUTCOMBINED]
	@EFFDATE VARCHAR(11),
	@SDATE VARCHAR(11),
	@STATUSNAME VARCHAR(30),
	@BRANCHCODE VARCHAR(10),
	@SBCODE VARCHAR(10),
	@NOREC VARCHAR(5) = '250',
	@REMARK VARCHAR(2) = '',
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@CLTYPE VARCHAR(4) = 'ALL', -- CLTYPE -> [WEB / NON-WEB / ALL]
	@PAYMODE CHAR(1),
	@SERVERFR VARCHAR(15),
	@SERVERTO VARCHAR(15)

AS
/*
	EXEC V2_ACC_MONEYPAYOUTCOMBINED
		@EFFDATE = 'AUG  4 2007',
		@SDATE = 'APR  1 2005',
		@STATUSNAME = 'BROKER',
		@BRANCHCODE = 'ARSL',
		@SBCODE = 'BANGALORE',
		@NOREC = '1000',
		@REMARK = '',
		@FPARTY = '0',
		@TPARTY = 'ZZ',
		@CLTYPE = 'ALL',
		@PAYMODE = 'C',
		@SERVERFR = '[127.0.0.1]',
		@SERVERTO = '[127.0.0.1]'
	*/

	DECLARE
		@@PENDINGCNT VARCHAR(11),
		@@MAXDATE VARCHAR(11),
		@@SQL VARCHAR(3000)

	SET @@PENDINGCNT = 0
	SET @@MAXDATE = 'JAN  1 1900'

	SET NOCOUNT ON

	IF @FPARTY = ''
	BEGIN
		SET @FPARTY = '0000000000'
	END

	IF @TPARTY = ''
	BEGIN
		SET @TPARTY = 'ZZZZZZZZZZ'
	END

	--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	/*=============================================================================
	LOOP FOR BROKER LOGIN TO REJECTION OF REQUESTS
	1. ALL OLD DATE PENDING REQUESTS
	2. MULTIPLE REQUESTS. ALL REQUESTS OTHER THAN THE FIRST REQUEST OF THE LOWEST AMOUNT ARE REJECTED.
	=============================================================================*/

	IF UPPER(@STATUSNAME) = 'BROKER'
	BEGIN
		SET @@PENDINGCNT =
		(
			SELECT
			COUNT(*)
			FROM V2_SETTPAYOUT WITH(NOLOCK)
			WHERE STATUS IN ('P', 'I')
			AND GENFLAG = 'A'
		)

		IF @@PENDINGCNT <> 0
		BEGIN
			SET @@MAXDATE =
			(
				SELECT
				LEFT(CONVERT(VARCHAR, MAX(REQUESTDT), 109), 11)
				FROM V2_SETTPAYOUT WITH(NOLOCK)
				WHERE STATUS IN ('P', 'I')
				AND GENFLAG = 'A'
			)
		END

		/*=============================================================================
		REJECT ALL OLD DATE PENDING REQUESTS
		=============================================================================*/
		UPDATE
			V2_SETTPAYOUT
		SET
			STATUS = 'R'
		WHERE
			STATUS IN ('P', 'I')
			AND GENFLAG = 'A'
			AND REQUESTDT < @@MAXDATE
		
	END

	/*===================================================================================
	TEMP TABLE CREATION:
	1. #LEDGERTMP: FINAL TABLE FOR LEDGER BALANCES AND BILL AMOUNT
	2. #LEDGERBILLTMP: TABLE FOR POPULATING BILL AMOUNTS AS POSTED IN V2_SETTPAYOUT TABLE FOR PENDING REQUESTS.
	===================================================================================*/
	CREATE TABLE [DBO].[#V2_LEDGERBALANCEUP](
		[PARTYCODE] [VARCHAR](10) NULL,
		[PARTYNAME] [VARCHAR](100) NULL,
		[CHEQUENAME] [VARCHAR](100) NULL,
		[BRANCHCODE] [VARCHAR](10) NULL,
		[ACCAT] [VARCHAR](10) NULL,
		[BTOBPAYMENT] [INT] NULL,
		[NSE_VDTLEDBAL] [MONEY] NULL,
		[NSE_EDTLEDBAL] [MONEY] NULL,
		[NSE_POLEDBAL] [MONEY] NULL,
		[NFO_EDTLEDBAL] [MONEY] NULL,
		[NFO_MARGINBAL] [MONEY] NULL,
		[NFO_POLEDBAL] [MONEY] NULL,
		[PAYMODE] [VARCHAR](1) NULL,
		[NSE_BANKCODE] [VARCHAR](10) NULL,
		[NFO_BANKCODE] [VARCHAR](10) NULL,
		[CLIENTTYPE] [VARCHAR](3) NULL,
		[RUNDATE] [DATETIME] NULL,
		[SUB_BROKER] [VARCHAR] (10) NULL,
		[BILLAMT] [MONEY] NULL
	) ON [PRIMARY]

	INSERT INTO
		#V2_LEDGERBALANCEUP
	EXEC
		V2_GETLEDGERBALANCE_COMBINED
			@SDATE,
			@FPARTY,
			@TPARTY,
			'HO', --@USER
			@SERVERFR,
			@SERVERTO,
			@EFFDATE,
			'HO' --@COMP_FOR

	CREATE TABLE #V2_LEDGERTMPUP
	(
		[CLTCODE] [VARCHAR](10) NULL,
		[ACNAME] [VARCHAR](100) NULL,
		[CHEQUENAME] [VARCHAR](100) NULL,
		[BRANCHCODE] [VARCHAR](10) NULL,
		[ACCAT] [INT] NULL,
		[BTOBPAYMENT] [INT] NULL,
		[NSE_VDTLEDBAL] [MONEY] NULL,
		[NSE_EDTLEDBAL] [MONEY] NULL,
		[NSE_POLEDBAL] [MONEY] NULL,
		[NFO_EDTLEDBAL] [MONEY] NULL,
		[NFO_MARGINBAL] [MONEY] NULL,
		[NFO_POLEDBAL] [MONEY] NULL,
		[BILLAMT] [MONEY] NULL,
		[CM_AMOUNTTOBEPAID] [MONEY] NULL,
		[FO_AMOUNTTOBEPAID] [MONEY] NULL,		
		[REMARK] [VARCHAR](234) NULL,
		[PAYMODE] [VARCHAR](1),
		[CM_BANKCODE] [VARCHAR](10),
		[FO_BANKCODE] [VARCHAR](10),
		[STATUS] [CHAR] (1),
		[SUB_BROKER] [VARCHAR] (10)
	)

	CREATE TABLE #V2_LEDGERTMP
	(
		[CLTCODE] [VARCHAR](10) NULL,
		[ACNAME] [VARCHAR](100) NULL,
		[CHEQUENAME] [VARCHAR](100) NULL,
		[BRANCHCODE] [VARCHAR](10) NULL,
		[ACCAT] [INT] NULL,
		[BTOBPAYMENT] [INT] NULL,
		[NSE_VDTLEDBAL] [MONEY] NULL,
		[NSE_EDTLEDBAL] [MONEY] NULL,
		[NSE_POLEDBAL] [MONEY] NULL,
		[NFO_EDTLEDBAL] [MONEY] NULL,
		[NFO_MARGINBAL] [MONEY] NULL,
		[NFO_POLEDBAL] [MONEY] NULL,
		[BILLAMT] [MONEY] NULL,
		[CM_AMOUNTTOBEPAID] [MONEY] NULL,
		[FO_AMOUNTTOBEPAID] [MONEY] NULL,		
		[REMARK] [VARCHAR](234) NULL,
		[PAYMODE] [VARCHAR](1),
		[CM_BANKCODE] [VARCHAR](10),
		[FO_BANKCODE] [VARCHAR](10),
		[STATUS] [CHAR] (1),
		[SUB_BROKER] [VARCHAR] (10),
		[SRNO] [INT] IDENTITY(1,1)
	)

	SELECT @@SQL = "INSERT INTO #V2_LEDGERTMPUP "
	SELECT @@SQL = @@SQL + "		SELECT "
	SELECT @@SQL = @@SQL + "			CLTCODE = L.PARTYCODE, "
	SELECT @@SQL = @@SQL + "			ACNAME = L.PARTYNAME, "
	SELECT @@SQL = @@SQL + "			CHEQUENAME = L.CHEQUENAME, "
	SELECT @@SQL = @@SQL + "			BRANCHCODE = L.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "			ACCAT = L.ACCAT, "
	SELECT @@SQL = @@SQL + "			BTOBPAYMENT = L.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "			NSE_VDTLEDBAL = SUM(L.NSE_VDTLEDBAL), "
	SELECT @@SQL = @@SQL + "			NSE_EDTLEDBAL = SUM(L.NSE_EDTLEDBAL), "
	SELECT @@SQL = @@SQL + "			NSE_POLEDBAL = SUM(L.NSE_POLEDBAL), "
	SELECT @@SQL = @@SQL + "			NFO_EDTLEDBAL = SUM(L.NFO_EDTLEDBAL), "
	SELECT @@SQL = @@SQL + "			NFO_MARGINBAL = SUM(L.NFO_MARGINBAL), "
	SELECT @@SQL = @@SQL + "			NFO_POLEDBAL = SUM(L.NFO_POLEDBAL), "
	SELECT @@SQL = @@SQL + "			BILLAMT = SUM(S.BILLAMT), "
	SELECT @@SQL = @@SQL + "			CM_AMOUNTTOBEPAID = (CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL' THEN SUM(S.AMOUNTTOBEPAID) ELSE 0 END), "
	SELECT @@SQL = @@SQL + "			FO_AMOUNTTOBEPAID = (CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' THEN SUM(S.AMOUNTTOBEPAID) ELSE 0 END), "
	SELECT @@SQL = @@SQL + "			S.REMARK, "
	SELECT @@SQL = @@SQL + "			PAYMODE = L.PAYMODE, "
	SELECT @@SQL = @@SQL + "			CM_BANKCODE = L.NSE_BANKCODE, "
	SELECT @@SQL = @@SQL + "			FO_BANKCODE = L.NFO_BANKCODE, "
	SELECT @@SQL = @@SQL + "			STATUS, "
	SELECT @@SQL = @@SQL + "			SUB_BROKER = S.SUB_BROKER "
	SELECT @@SQL = @@SQL + "		FROM  "
	SELECT @@SQL = @@SQL + "			#V2_LEDGERBALANCEUP L WITH(NOLOCK),  "
	SELECT @@SQL = @@SQL + "			V2_SETTPAYOUT S WITH(NOLOCK) "
	SELECT @@SQL = @@SQL + "		WHERE "
	SELECT @@SQL = @@SQL + "			S.CLTCODE = L.PARTYCODE "
	SELECT @@SQL = @@SQL + "			AND STATUS IN ('P', 'I') "
	SELECT @@SQL = @@SQL + "			AND S.GENFLAG = 'A' "
	SELECT @@SQL = @@SQL + "			AND UPPER(S.BRANCHCODE) LIKE (CASE WHEN UPPER('" + @BRANCHCODE + "') = 'ALL' THEN '%' ELSE UPPER('" + @BRANCHCODE + "') END) "
	SELECT @@SQL = @@SQL + "			AND UPPER(S.SUB_BROKER) LIKE (CASE WHEN UPPER('" + @SBCODE + "') = 'ALL' THEN '%' ELSE UPPER('" + @SBCODE + "') END) "

	IF @CLTYPE = 'WEB'
	BEGIN
		SELECT @@SQL = @@SQL + "		AND L.CLIENTTYPE = 'WEB' "
	END

	ELSE IF @CLTYPE = 'NWEB'
	BEGIN
		SELECT @@SQL = @@SQL + "		AND L.CLIENTTYPE <> 'WEB' "
	END

	IF @PAYMODE <> 'A'
	BEGIN
		SELECT @@SQL = @@SQL + "		AND L.PAYMODE = '" + @PAYMODE + "' "
	END

	IF @REMARK = 'ON'
	BEGIN
		SELECT @@SQL = @@SQL + "		AND S.REMARK <> '' "
	END

	SELECT @@SQL = @@SQL + "		GROUP BY "
	SELECT @@SQL = @@SQL + "			L.PARTYCODE, "
	SELECT @@SQL = @@SQL + "			L.PARTYNAME, "
	SELECT @@SQL = @@SQL + "			L.CHEQUENAME, "
	SELECT @@SQL = @@SQL + "			L.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "			L.ACCAT, "
	SELECT @@SQL = @@SQL + "			L.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "			S.REMARK, "
	SELECT @@SQL = @@SQL + "			L.PAYMODE, "
	SELECT @@SQL = @@SQL + "			L.NSE_BANKCODE, "
	SELECT @@SQL = @@SQL + "			L.NFO_BANKCODE, "
	SELECT @@SQL = @@SQL + "			EXCHANGE, "
	SELECT @@SQL = @@SQL + "			SEGMENT, "
	SELECT @@SQL = @@SQL + "			STATUS, "
	SELECT @@SQL = @@SQL + "			S.SUB_BROKER "

	EXEC (@@SQL)

	SELECT @@SQL = "INSERT INTO #V2_LEDGERTMP "
	SELECT @@SQL = @@SQL + "		SELECT "
	SELECT @@SQL = @@SQL + "			CLTCODE, "
	SELECT @@SQL = @@SQL + "			ACNAME, "
	SELECT @@SQL = @@SQL + "			CHEQUENAME, "
	SELECT @@SQL = @@SQL + "			BRANCHCODE, "
	SELECT @@SQL = @@SQL + "			ACCAT, "
	SELECT @@SQL = @@SQL + "			BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "			NSE_VDTLEDBAL = MAX(NSE_VDTLEDBAL), "
	SELECT @@SQL = @@SQL + "			NSE_EDTLEDBAL = MAX(NSE_EDTLEDBAL), "
	SELECT @@SQL = @@SQL + "			NSE_POLEDBAL = MAX(NSE_POLEDBAL), "
	SELECT @@SQL = @@SQL + "			NFO_EDTLEDBAL = MAX(NFO_EDTLEDBAL), "
	SELECT @@SQL = @@SQL + "			NFO_MARGINBAL = MAX(NFO_MARGINBAL), "
	SELECT @@SQL = @@SQL + "			NFO_POLEDBAL = MAX(NFO_POLEDBAL), "
	SELECT @@SQL = @@SQL + "			BILLAMT = MAX(BILLAMT), "
	SELECT @@SQL = @@SQL + "			CM_AMOUNTTOBEPAID = MAX(CM_AMOUNTTOBEPAID), "
	SELECT @@SQL = @@SQL + "			FO_AMOUNTTOBEPAID = MAX(FO_AMOUNTTOBEPAID), "
	SELECT @@SQL = @@SQL + "			REMARK, "
	SELECT @@SQL = @@SQL + "			PAYMODE, "
	SELECT @@SQL = @@SQL + "			CM_BANKCODE, "
	SELECT @@SQL = @@SQL + "			FO_BANKCODE, "
	SELECT @@SQL = @@SQL + "			STATUS, "
	SELECT @@SQL = @@SQL + "			SUB_BROKER "
	SELECT @@SQL = @@SQL + "		FROM  "
	SELECT @@SQL = @@SQL + "			#V2_LEDGERTMPUP "
	SELECT @@SQL = @@SQL + "		GROUP BY "
	SELECT @@SQL = @@SQL + "			CLTCODE, "
	SELECT @@SQL = @@SQL + "			ACNAME, "
	SELECT @@SQL = @@SQL + "			CHEQUENAME, "
	SELECT @@SQL = @@SQL + "			BRANCHCODE, "
	SELECT @@SQL = @@SQL + "			ACCAT, "
	SELECT @@SQL = @@SQL + "			BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "			REMARK, "
	SELECT @@SQL = @@SQL + "			PAYMODE, "
	SELECT @@SQL = @@SQL + "			CM_BANKCODE, "
	SELECT @@SQL = @@SQL + "			FO_BANKCODE, "
	SELECT @@SQL = @@SQL + "			STATUS, "
	SELECT @@SQL = @@SQL + "			SUB_BROKER "

	EXEC (@@SQL)

	UPDATE
		TMP
	SET
		CHEQUENAME = M.CHEQUENAME
	FROM
		#V2_LEDGERTMP TMP,
		MULTIBANKID M
	WHERE
		M.CLTCODE = TMP.CLTCODE
		AND M.DEFAULTBANK = '1'

	SELECT
		PARTYCODE = CLTCODE,
		PARTYNAME = ACNAME,
		BRANCHCODE,
		BTOBPAYMENT,
		NSE_VDTLEDBAL = SUM(NSE_VDTLEDBAL),
		NSE_EDTLEDBAL = SUM(NSE_EDTLEDBAL),
		NSE_POLEDBAL = SUM(NSE_POLEDBAL),
		NFO_EDTLEDBAL = SUM(NFO_EDTLEDBAL),
		NFO_MARGINBAL = SUM(NFO_MARGINBAL),
		NFO_POLEDBAL = SUM(NFO_POLEDBAL),
		BILLAMT = SUM(BILLAMT),
		PAYMODE,
		CM_BANKCODE,		
		REMARK,
		SRNO,
		FO_BANKCODE,
		CM_AMOUNTTOBEPAID = SUM(CM_AMOUNTTOBEPAID),
		FO_AMOUNTTOBEPAID = SUM(FO_AMOUNTTOBEPAID),
		STATUS,
		SUB_BROKER
	FROM
		#V2_LEDGERTMP WITH(NOLOCK)
	GROUP BY
		CLTCODE,
		ACNAME,
		BRANCHCODE,
		BTOBPAYMENT,
		PAYMODE,
		CM_BANKCODE,
		FO_BANKCODE,
		REMARK,
		SRNO,
		STATUS,
		SUB_BROKER
	ORDER BY
		BRANCHCODE,
		CLTCODE

/*-----------------------------------EOF----------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ACCOUNT_LISTING
-- --------------------------------------------------


CREATE PROCEDURE V2_ACCOUNT_LISTING  
(  
    @FILTER VARCHAR(11), 
	@FROMPARTY VARCHAR(10), 
	@TOPARTY VARCHAR(10), 
	@STATUSID VARCHAR(20), 
	@STATUSNAME VARCHAR(20) 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_ACCOUNT_LISTING  
	    @FILTER = 'BRANCH', 
		@FROMPARTY = '0000000000', 
		@TOPARTY = 'ZZZZZZZZZZ', 
		@STATUSID = 'BROKER', 
		@STATUSNAME = 'BROKER' 
==============================================================================================================*/  
  
        SET NOCOUNT ON

		IF @FILTER = 'BRANCH' 
		BEGIN 
			SELECT DISTINCT 
				PARTY_CODE = BRANCH_CODE, 
				LONG_NAME = BRANCH 
			FROM MSAJAG.DBO.CLIENT_DETAILS C, 
				MSAJAG.DBO.BRANCH B 
			WHERE PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND BRANCH_CD = BRANCH_CODE 
					AND @STATUSNAME = (   
							CASE 
									WHEN @STATUSID = 'BRANCH' 
									THEN C.BRANCH_CD 
									WHEN @STATUSID = 'SUBBROKER' 
									THEN C.SUB_BROKER 
									WHEN @STATUSID = 'TRADER' 
									THEN C.TRADER 
									WHEN @STATUSID = 'FAMILY' 
									THEN C.FAMILY 
									WHEN @STATUSID = 'AREA' 
									THEN C.AREA 
									WHEN @STATUSID = 'REGION' 
									THEN C.REGION 
									WHEN @STATUSID = 'CLIENT' 
									THEN C.PARTY_CODE 
									ELSE 'BROKER' END) 
		END

		IF @FILTER = 'FAMILY' 
		BEGIN 
			SELECT DISTINCT 
				PARTY_CODE, 
				LONG_NAME 
			FROM MSAJAG.DBO.CLIENT_DETAILS C 
			WHERE PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND PARTY_CODE = FAMILY 
					AND @STATUSNAME = (   
							CASE 
									WHEN @STATUSID = 'BRANCH' 
									THEN C.BRANCH_CD 
									WHEN @STATUSID = 'SUBBROKER' 
									THEN C.SUB_BROKER 
									WHEN @STATUSID = 'TRADER' 
									THEN C.TRADER 
									WHEN @STATUSID = 'FAMILY' 
									THEN C.FAMILY 
									WHEN @STATUSID = 'AREA' 
									THEN C.AREA 
									WHEN @STATUSID = 'REGION' 
									THEN C.REGION 
									WHEN @STATUSID = 'CLIENT' 
									THEN C.PARTY_CODE 
									ELSE 'BROKER' END) 
		END

		IF @FILTER = 'CLIENT' 
		BEGIN
			SELECT 
				PARTY_CODE, 
				LONG_NAME 
			FROM MSAJAG.DBO.CLIENT_DETAILS C
			WHERE PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND @STATUSNAME = (   
							CASE 
									WHEN @STATUSID = 'BRANCH' 
									THEN C.BRANCH_CD 
									WHEN @STATUSID = 'SUBBROKER' 
									THEN C.SUB_BROKER 
									WHEN @STATUSID = 'TRADER' 
									THEN C.TRADER 
									WHEN @STATUSID = 'FAMILY' 
									THEN C.FAMILY 
									WHEN @STATUSID = 'AREA' 
									THEN C.AREA 
									WHEN @STATUSID = 'REGION' 
									THEN C.REGION 
									WHEN @STATUSID = 'CLIENT' 
									THEN C.PARTY_CODE 
									ELSE 'BROKER' END) 
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ACCOUNTBALANCES_UP
-- --------------------------------------------------
CREATE PROCEDURE V2_ACCOUNTBALANCES_UP  
(  
        @REFRESHTYPE VARCHAR(1)   
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_ACCOUNTBALANCES_UP  
                @REFRESHTYPE = 'I'  
  
==============================================================================================================*/  
  
        SET NOCOUNT ON  
          
        DECLARE  
         @@ACCCUR AS CURSOR,  
                @@ACCOUNTDB VARCHAR(20),   
                @@SEGMENTCODE INT,   
                @@NOOFDAYS INT,   
                @@DATEFROM INT,   
                @@UPDATEDATE DATETIME,   
                @@SQL VARCHAR(5000)   
          
        SET @@ACCCUR = CURSOR FOR  
                SELECT SEGMENTCODE,   
                        ACCOUNTDB,   
                        UPDATEDATE   
                FROM V2_MULTIACCOUNTS   
                WHERE ENABLED = 1   
                ORDER BY 1   
          
        OPEN @@ACCCUR  
        FETCH NEXT FROM @@ACCCUR INTO  @@SEGMENTCODE, @@ACCOUNTDB, @@UPDATEDATE   
          
        WHILE @@FETCH_STATUS = 0  
        BEGIN  
                IF @REFRESHTYPE = 'I'   
                BEGIN   
						--SELECT @@SQL = " "
						--SELECT @@SQL = @@SQL + "UPDATE V2_MULTIACCOUNTS SET NOOFDAYS = DATEDIFF(DAY,'" + @@UPDATEDATE + "',MIN(VDT)) FROM " + @@ACCOUNTDB + ".DBO.LEDGER WHERE CDT >= '" + @@UPDATEDATE + "' AND SEGMENTCODE = " + @@SEGMENTCODE + " "

						SELECT @@NOOFDAYS = NOOFDAYS FROM V2_MULTIACCOUNTS WHERE SEGMENTCODE = @@SEGMENTCODE 

                        SELECT @@DATEFROM = CONVERT(INT,CONVERT(VARCHAR,GETDATE() - @@NOOFDAYS,112))  
						
						--SELECT @@DATEFROM 
						--RETURN
                END   
                ELSE   
                BEGIN   
                        SELECT @@DATEFROM = 19000101   
                END  
          
                IF @@DATEFROM = 0 
		BEGIN 
			RETURN  
          	END

--SELECT @@SEGMENTCODE, @@ACCOUNTDB, @@NOOFDAYS, @@SQL, @@DATEFROM   

		UPDATE V2_MULTIACCOUNTS SET UPDATEDATE = GETDATE() WHERE SEGMENTCODE = @@SEGMENTCODE 

        DELETE FROM V2_ACCOUNTBALANCES WHERE SEGMENTCODE = @@SEGMENTCODE AND VDT >= @@DATEFROM   
          

		SELECT @@SQL = " "
		  
		SELECT @@SQL = @@SQL + "INSERT INTO V2_ACCOUNTBALANCES  "
		SELECT @@SQL = @@SQL + "SELECT  " 
		SELECT @@SQL = @@SQL + "CLTCODE,   "
		SELECT @@SQL = @@SQL + "SEGMENTCODE = " + CONVERT(CHAR,@@SEGMENTCODE) + ",    "
		SELECT @@SQL = @@SQL + "LEDTYPE = 1,   "
		SELECT @@SQL = @@SQL + "VDT = CONVERT(INT,CONVERT(VARCHAR,VDT,112)), "  
		SELECT @@SQL = @@SQL + "EDT = CONVERT(INT,CONVERT(VARCHAR,EDT,112)),  " 
		SELECT @@SQL = @@SQL + "BALDR = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),  " 
		SELECT @@SQL = @@SQL + "BALCR = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "OPBALDR = SUM(CASE WHEN DRCR = 'D' AND VTYP = 18 THEN VAMT ELSE 0 END),  " 
		SELECT @@SQL = @@SQL + "OPBALCR = SUM(CASE WHEN DRCR = 'C' AND VTYP = 18 THEN VAMT ELSE 0 END),  " 
		SELECT @@SQL = @@SQL + "BILLSDR = SUM(CASE WHEN DRCR = 'D' AND VTYP = 15 THEN VAMT ELSE 0 END),  " 
		SELECT @@SQL = @@SQL + "BILLSCR = SUM(CASE WHEN DRCR = 'C' AND VTYP = 15 THEN VAMT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "INSBILLSDR = SUM(CASE WHEN DRCR = 'D' AND VTYP = 21 THEN VAMT ELSE 0 END), "  
		SELECT @@SQL = @@SQL + "INSBILLSCR = SUM(CASE WHEN DRCR = 'C' AND VTYP = 21 THEN VAMT ELSE 0 END), "  
		SELECT @@SQL = @@SQL + "PAYBANK = SUM(CASE WHEN VTYP = 3 THEN VAMT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "RECBANK = SUM(CASE WHEN VTYP = 2 THEN VAMT ELSE 0 END) "
		SELECT @@SQL = @@SQL + "FROM " + @@ACCOUNTDB + ".DBO.LEDGER WITH(NOLOCK) "
		SELECT @@SQL = @@SQL + "WHERE CONVERT(INT,CONVERT(VARCHAR,VDT,112)) >= " + CONVERT(CHAR,@@DATEFROM) + " "
		SELECT @@SQL = @@SQL + "GROUP BY   "
		SELECT @@SQL = @@SQL + "CLTCODE, CONVERT(INT,CONVERT(VARCHAR,VDT,112)), CONVERT(INT,CONVERT(VARCHAR,EDT,112))   "
		          
		SELECT @@SQL = @@SQL + "INSERT INTO ACCOUNT..V2_ACCOUNTBALANCES  "
		SELECT @@SQL = @@SQL + "SELECT   "
		SELECT @@SQL = @@SQL + "CLTCODE = M.PARTY_CODE,   "
		SELECT @@SQL = @@SQL + "SEGMENTCODE = " + CONVERT(CHAR,@@SEGMENTCODE) + ",    "
		SELECT @@SQL = @@SQL + "LEDTYPE = 2,   "
		SELECT @@SQL = @@SQL + "VDT = CONVERT(INT,CONVERT(VARCHAR,VDT,112)),   "
		SELECT @@SQL = @@SQL + "EDT = CONVERT(INT,CONVERT(VARCHAR,VDT,112)),   "
		SELECT @@SQL = @@SQL + "BALDR = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "BALCR = SUM(CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "OPBALDR = SUM(CASE WHEN DRCR = 'D' AND VTYP = 18 THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "OPBALCR = SUM(CASE WHEN DRCR = 'C' AND VTYP = 18 THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "BILLSDR = SUM(CASE WHEN DRCR = 'D' AND VTYP = 15 THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "BILLSCR = SUM(CASE WHEN DRCR = 'C' AND VTYP = 15 THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "INSBILLSDR = SUM(CASE WHEN DRCR = 'D' AND VTYP = 21 THEN AMOUNT ELSE 0 END),  " 
		SELECT @@SQL = @@SQL + "INSBILLSCR = SUM(CASE WHEN DRCR = 'C' AND VTYP = 21 THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "PAYBANK = SUM(CASE WHEN VTYP = 20 THEN AMOUNT ELSE 0 END),   "
		SELECT @@SQL = @@SQL + "RECBANK = SUM(CASE WHEN VTYP = 19 THEN AMOUNT ELSE 0 END) "
		SELECT @@SQL = @@SQL + "FROM " + @@ACCOUNTDB + ".DBO.MARGINLEDGER M "
		SELECT @@SQL = @@SQL + "WHERE CONVERT(INT,CONVERT(VARCHAR,VDT,112)) >= " + CONVERT(CHAR,@@DATEFROM)  + " "
		SELECT @@SQL = @@SQL + "GROUP BY   "
		SELECT @@SQL = @@SQL + "M.PARTY_CODE,   CONVERT(INT,CONVERT(VARCHAR,VDT,112))  "
		
		EXEC (@@SQL)
          
        FETCH NEXT FROM @@ACCCUR INTO  @@SEGMENTCODE, @@ACCOUNTDB, @@UPDATEDATE   
        END  
        CLOSE @@ACCCUR  
        DEALLOCATE @@ACCCUR  
          
  		PRINT 'S'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_CAL
-- --------------------------------------------------
--sp_helptext v2_ageing_cal
   CREATE PROCEDURE V2_AGEING_CAL   
(    
        @@BALDATE INT   
)    
    
AS    
    
/*==============================================================================================================    
        EXEC V2_AGEING_CAL    
                @@BALDATE = 20070626   
==============================================================================================================*/    
    
  
SET NOCOUNT ON  
  
DECLARE   
    @@BUCKET_1 INT,   
    @@BUCKET_2 INT,   
    @@BUCKET_3 INT,   
    @@BUCKET_4 INT,   
    @@CALDATE INT,   
    @@BUCKET INT,   
    @@UPDATEDATE DATETIME    
  
    SELECT @@UPDATEDATE = GETDATE()   
      
    SET @@BUCKET = 0   
      
/*==============================================================================================================    
    Populate No of Days Bucket Values for Canned Ageing  
        Also, identify & store the dates for Balance Computation based on Bucket Values  
==============================================================================================================*/    
  
    SELECT   
        @@BUCKET_1 = BUCKET_1,   
        @@BUCKET_2 = BUCKET_2,   
        @@BUCKET_3 = BUCKET_3,   
        @@BUCKET_4 = BUCKET_4   
    FROM V2_AGEINGBUCKETS  
      
    SELECT BUCKET = 0, BUCKET_DAYS = 0, BALDATE = @@BALDATE INTO #BUCKETS   
      
    INSERT INTO #BUCKETS SELECT 1, @@BUCKET_1, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_1,112))   
    INSERT INTO #BUCKETS SELECT 2, @@BUCKET_2, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_2,112))   
    INSERT INTO #BUCKETS SELECT 3, @@BUCKET_3, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_3,112))   
    INSERT INTO #BUCKETS SELECT 4, @@BUCKET_4, CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(CHAR,@@BALDATE)) - @@BUCKET_4,112))   
  
/*==============================================================================================================    
    Populate default NSEFO Margin Settings for considering Margin Requirement (after adjusting ]collateral)   
==============================================================================================================*/    
 DECLARE   
  @@SPAN_MARGIN INT,  
  @@EXPOSURE_MARGIN INT  
  
 SELECT   
        @@SPAN_MARGIN = SPAN_MARGIN,   
        @@EXPOSURE_MARGIN = EXPOSURE_MARGIN   
 FROM V2_CLIENTPROFILES_FA   
 WHERE CLTCODE = 'ALL'  
  
/*==============================================================================================================    
    Create Based Data for calculating Ageing  
        The base data is created using the summarized data as populated in the V2_ACCOUNTBALANCES Table  
==============================================================================================================*/    
    TRUNCATE TABLE V2_AGEINGDATA_TMP  
      
    SELECT DISTINCT CLTCODE    
    INTO #CLIENT   
    FROM V2_ACCOUNTBALANCES   
      
    CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[#CLIENT]   
    (  
     [CLTCODE] ASC  
    )  
  
    /*==============================================================================================================    
        Voucher Date wise Balances for the date   
    ==============================================================================================================*/    
    INSERT INTO V2_AGEINGDATA_TMP   
    SELECT   
        BALDATETYPE = 1,   
     V.CLTCODE,   
     V.SEGMENTCODE,   
     BALANCE = SUM(BALCR - BALDR),   
        BUCKET_1 = 0,   
        BUCKET_2 = 0,   
        BUCKET_3 = 0,   
        BUCKET_4 = 0,   
        'BACKEND',   
        @@UPDATEDATE   
    FROM   
     V2_ACCOUNTBALANCES V,   
     #CLIENT C,   
     PARAMETER P   
    WHERE   
     CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE  
     AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE   
     AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE   
     AND V.CLTCODE = C.CLTCODE   
    GROUP BY   
     V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE  
    HAVING SUM(BALCR - BALDR) <> 0   
      
    /*==============================================================================================================    
        Effective Date wise Balances for the date   
    ==============================================================================================================*/    
    INSERT INTO V2_AGEINGDATA_TMP   
    SELECT   
        BALDATETYPE = 2,   
     V.CLTCODE,   
     V.SEGMENTCODE,   
     BALANCE = SUM(BALCR - BALDR),   
        BUCKET_1 = 0,   
        BUCKET_2 = 0,   
        BUCKET_3 = 0,   
        BUCKET_4 = 0,   
        'BACKEND',   
        @@UPDATEDATE   
    FROM   
     V2_ACCOUNTBALANCES V,   
     #CLIENT C,   
     PARAMETER P   
    WHERE   
     CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE  
     AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE   
     AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE   
     AND V.CLTCODE = C.CLTCODE   
    GROUP BY   
     V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE  
    HAVING SUM(BALCR - BALDR) <> 0   
  
    INSERT INTO V2_AGEINGDATA_TMP   
    SELECT   
        BALDATETYPE = 2,   
     V.CLTCODE,   
     V.SEGMENTCODE,   
     BALANCE = SUM(BALDR - BALCR),   
        BUCKET_1 = 0,   
        BUCKET_2 = 0,   
        BUCKET_3 = 0,   
        BUCKET_4 = 0,   
        'BACKEND',   
        @@UPDATEDATE   
    FROM   
     V2_ACCOUNTBALANCES V,   
     #CLIENT C,   
     PARAMETER P   
    WHERE   
     CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE  
     AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE   
     AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE   
        AND VDT < CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112))   
     AND V.CLTCODE = C.CLTCODE   
    GROUP BY   
     V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE  
    HAVING SUM(BALDR - BALCR) <> 0   
  
    /*==============================================================================================================    
        NSEFO Margin Requirement for the date   
    ==============================================================================================================*/    
 INSERT INTO V2_AGEINGDATA_TMP    
 SELECT   
        BALDATETYPE = 0,   
     V.CLTCODE,   
     SEGMENTCODE = 3,   
     BALANCE = NONCASH - (  
                            (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END)   
                            +   
                            (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END)   
                                ),   
        BUCKET_1 = 0,   
        BUCKET_2 = 0,   
        BUCKET_3 = 0,   
        BUCKET_4 = 0,   
        'BACKEND',   
        @@UPDATEDATE   
 FROM   
  (   
   SELECT   
    CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE),   
    NONCASH = ISNULL(NONCASH,0),   
    TOTALMARGIN = ISNULL(TOTALMARGIN,0),   
    MTOM = ISNULL(MTOM,0)   
   FROM   
    (  
     SELECT CLTCODE = PARTY_CODE, NONCASH   
     FROM MSAJAG.DBO.COLLATERAL   
     WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) =   
                        (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(TRANS_DATE),112)) FROM MSAJAG.DBO.COLLATERAL WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) <= @@BALDATE AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES')   
     AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'  
    ) C FULL OUTER JOIN   
    (  
     SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM   
     FROM NSEFO.DBO.FOMARGINNEW   
     WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) =   
                        (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(MDATE),112)) FROM NSEFO.DBO.FOMARGINNEW WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) <= @@BALDATE)   
    ) M   
   ON M.CLTCODE = C.CLTCODE   
   ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)  
 WHERE NONCASH - (  
                        (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END)   
                        +   
                        (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END)   
                            ) < 0   
  
    DELETE #CLIENT WHERE CLTCODE NOT IN (SELECT DISTINCT CLTCODE FROM V2_AGEINGDATA_TMP)  
      
/*==============================================================================================================    
    Begin Loop for calculating Balances for the dates computed based on Bucket Values   
        Provision for 4 + 1 Buckets has been provided  
==============================================================================================================*/    
    WHILE @@BUCKET <= 4   
    BEGIN   
        SELECT @@CALDATE = BALDATE FROM #BUCKETS WHERE BUCKET = @@BUCKET   
      
    /*==============================================================================================================    
        Voucher Date wise Balances as on the date populate against each Bucket  
    ==============================================================================================================*/    
        INSERT INTO V2_AGEINGDATA_TMP   
        SELECT   
            BALDATETYPE = 1,   
         V.CLTCODE,   
         V.SEGMENTCODE,   
         BALANCE = 0,   
            BUCKET_1 = (CASE WHEN @@BUCKET = 1 THEN SUM(BALCR - BALDR) ELSE 0 END),   
            BUCKET_2 = (CASE WHEN @@BUCKET = 2 THEN SUM(BALCR - BALDR) ELSE 0 END),    
            BUCKET_3 = (CASE WHEN @@BUCKET = 3 THEN SUM(BALCR - BALDR) ELSE 0 END),   
            BUCKET_4 = (CASE WHEN @@BUCKET = 4 THEN SUM(BALCR - BALDR) ELSE 0 END),   
            'BACKEND',   
            @@UPDATEDATE   
        FROM   
         V2_ACCOUNTBALANCES V,   
         #CLIENT C,   
         PARAMETER P   
        WHERE   
         CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@CALDATE  
         AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@CALDATE   
         AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@CALDATE   
         AND V.CLTCODE = C.CLTCODE   
        GROUP BY   
         V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE  
        HAVING SUM(BALCR - BALDR) <> 0   
  
    /*==============================================================================================================    
        Effective Date wise Balances as on the date populate against each Bucket  
    ==============================================================================================================*/    
        INSERT INTO V2_AGEINGDATA_TMP   
        SELECT   
            BALDATETYPE = 2,   
         V.CLTCODE,   
         V.SEGMENTCODE,   
         BALANCE = 0,   
            BUCKET_1 = (CASE WHEN @@BUCKET = 1 THEN SUM(BALCR - BALDR) ELSE 0 END),   
            BUCKET_2 = (CASE WHEN @@BUCKET = 2 THEN SUM(BALCR - BALDR) ELSE 0 END),    
            BUCKET_3 = (CASE WHEN @@BUCKET = 3 THEN SUM(BALCR - BALDR) ELSE 0 END),   
            BUCKET_4 = (CASE WHEN @@BUCKET = 4 THEN SUM(BALCR - BALDR) ELSE 0 END),   
            'BACKEND',   
            @@UPDATEDATE   
        FROM   
         V2_ACCOUNTBALANCES V,   
         #CLIENT C,   
         PARAMETER P   
        WHERE   
         CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@CALDATE  
         AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@CALDATE   
         AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@CALDATE   
         AND V.CLTCODE = C.CLTCODE   
        GROUP BY   
         V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE  
        HAVING SUM(BALCR - BALDR) <> 0   
  
        INSERT INTO V2_AGEINGDATA_TMP   
        SELECT   
            BALDATETYPE = 2,   
         V.CLTCODE,   
         V.SEGMENTCODE,   
         BALANCE = 0,   
            BUCKET_1 = (CASE WHEN @@BUCKET = 1 THEN SUM(BALDR - BALCR) ELSE 0 END),   
            BUCKET_2 = (CASE WHEN @@BUCKET = 2 THEN SUM(BALDR - BALCR) ELSE 0 END),    
            BUCKET_3 = (CASE WHEN @@BUCKET = 3 THEN SUM(BALDR - BALCR) ELSE 0 END),   
            BUCKET_4 = (CASE WHEN @@BUCKET = 4 THEN SUM(BALDR - BALCR) ELSE 0 END),   
            'BACKEND',   
            @@UPDATEDATE   
        FROM   
         V2_ACCOUNTBALANCES V,   
         #CLIENT C,   
         PARAMETER P   
        WHERE   
         CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@CALDATE  
         AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@CALDATE   
         AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@CALDATE   
         AND V.CLTCODE = C.CLTCODE   
        GROUP BY   
         V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE  
        HAVING SUM(BALDR - BALCR) <> 0   
  
    /*==============================================================================================================    
        NSEFO Margin Requirement as on the date populate against each Bucket  
    ==============================================================================================================*/    
     INSERT INTO V2_AGEINGDATA_TMP    
     SELECT   
            BALDATETYPE = 0,   
         V.CLTCODE,   
         SEGMENTCODE = 3,   
         BALANCE = NONCASH - (  
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END)   
                                +   
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END)   
                                    ),   
            BUCKET_1 = 0,   
            BUCKET_2 = 0,   
            BUCKET_3 = 0,   
            BUCKET_4 = 0,   
            'BACKEND',   
            @@UPDATEDATE   
     FROM   
      (   
       SELECT   
        CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE),   
        NONCASH = ISNULL(NONCASH,0),   
        TOTALMARGIN = ISNULL(TOTALMARGIN,0),   
        MTOM = ISNULL(MTOM,0)   
       FROM   
        (  
         SELECT CLTCODE = PARTY_CODE, NONCASH   
         FROM MSAJAG.DBO.COLLATERAL   
         WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) =   
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(TRANS_DATE),112)) FROM MSAJAG.DBO.COLLATERAL WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) <= @@CALDATE AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES')   
         AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'  
        ) C FULL OUTER JOIN   
        (  
         SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM   
         FROM NSEFO.DBO.FOMARGINNEW   
         WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) =   
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(MDATE),112)) FROM NSEFO.DBO.FOMARGINNEW WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) <= @@CALDATE)   
        ) M   
       ON M.CLTCODE = C.CLTCODE   
       ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)  
     WHERE NONCASH - (  
                            (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END)   
                            +   
                            (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END)   
                                ) < 0   
  
        SET @@BUCKET = @@BUCKET + 1   
    END  
  
    /*==============================================================================================================    
        Margin Requirement dummy data populated for Effective Date wise Calculation  
    ==============================================================================================================*/    
    INSERT INTO V2_AGEINGDATA_TMP   
    SELECT 2,CLTCODE,SEGMENTCODE,BALANCE,BUCKET_1,BUCKET_2,BUCKET_3,BUCKET_4,UPDATEBY,UPDATEDATE   
    FROM V2_AGEINGDATA_TMP WHERE BALDATETYPE = 0  
      
    UPDATE V2_AGEINGDATA_TMP SET BALDATETYPE = 1 WHERE BALDATETYPE = 0  
      
/*==============================================================================================================    
    Begin transaction to compute Final Ageing based on the Data created above   
==============================================================================================================*/    
    BEGIN TRAN  
        TRUNCATE TABLE V2_AGEINGDATA   
      
    /*==============================================================================================================    
        Computation Ageing Data based on the Consolidated Balances  
    ==============================================================================================================*/    
        INSERT INTO V2_AGEINGDATA   
        SELECT   
            @@BALDATE,   
            BALDATETYPE,   
            CLTCODE,   
            SEGMENTCODE = 0,   
            SUM(BALANCE),   
            SUM(BUCKET_1),   
            SUM(BUCKET_2),   
            SUM(BUCKET_3),   
            SUM(BUCKET_4),   
            UPDATEBY,   
            UPDATEDATE   
        FROM V2_AGEINGDATA_TMP   
        GROUP BY   
            BALDATETYPE,   
            CLTCODE,   
            UPDATEBY,   
            UPDATEDATE       
      
    /*==============================================================================================================    
        Computation Ageing Data based on the Segment Wise Balances  
    ==============================================================================================================*/    
        INSERT INTO V2_AGEINGDATA   
        SELECT   
            @@BALDATE,   
            BALDATETYPE,   
            CLTCODE,   
            SEGMENTCODE,   
            SUM(BALANCE),   
            SUM(BUCKET_1),   
            SUM(BUCKET_2),   
            SUM(BUCKET_3),   
            SUM(BUCKET_4),   
            UPDATEBY,   
            UPDATEDATE   
        FROM V2_AGEINGDATA_TMP   
        GROUP BY   
            BALDATETYPE,   
            CLTCODE,   
            SEGMENTCODE,   
            UPDATEBY,   
            UPDATEDATE       
      
    /*==============================================================================================================    
        Computation Final Ageing based on the Ageing Data populated above   
            Value in each Bucket is updated after desired splitting of the net balance of the Client  
    ==============================================================================================================*/    
        TRUNCATE TABLE V2_AGEINGFINAL   
        INSERT INTO V2_AGEINGFINAL   
        SELECT BALDATE,BALDATETYPE,CLTCODE,SEGMENTCODE,BALANCE,BUCKET_1,BUCKET_2,BUCKET_3,BUCKET_4,BUCKET_5 = 0,  
        UPDATEBY,UPDATEDATE   
        FROM V2_AGEINGDATA  
          
        UPDATE V2_AGEINGFINAL   
        SET BUCKET_1 =   
            (CASE   
                WHEN SIGN(BUCKET_1) = SIGN(BALANCE)   
                    AND ABS(BALANCE) > ABS(BUCKET_1)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1)) * SIGN(BALANCE)   
            ELSE   
            CASE   
                WHEN SIGN(BUCKET_1) <> SIGN(BALANCE)   
                THEN BALANCE   
            ELSE 0 END END)  
          
        UPDATE V2_AGEINGFINAL   
        SET BUCKET_2 =   
            (CASE   
                WHEN SIGN(BUCKET_2) = SIGN(BALANCE)   
                    AND ABS(BALANCE) - ABS(BUCKET_1) > ABS(BUCKET_2)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2)) * SIGN(BALANCE)   
            ELSE   
            CASE   
                WHEN SIGN(BUCKET_2) <> SIGN(BALANCE)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1)) * SIGN(BALANCE)   
            ELSE 0 END END)  
          
        UPDATE V2_AGEINGFINAL   
        SET BUCKET_3 =   
            (CASE   
                WHEN SIGN(BUCKET_3) = SIGN(BALANCE)   
                    AND ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) > ABS(BUCKET_3)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3)) * SIGN(BALANCE)   
            ELSE   
            CASE   
                WHEN SIGN(BUCKET_3) <> SIGN(BALANCE)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2)) * SIGN(BALANCE)   
            ELSE 0 END END)  
          
        UPDATE V2_AGEINGFINAL   
        SET BUCKET_4 =   
            (CASE   
                WHEN SIGN(BUCKET_4) = SIGN(BALANCE)   
                    AND ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3) > ABS(BUCKET_4)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3) - ABS(BUCKET_4)) * SIGN(BALANCE)   
            ELSE   
            CASE   
                WHEN SIGN(BUCKET_4) <> SIGN(BALANCE)   
                THEN (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3)) * SIGN(BALANCE)   
            ELSE 0 END END)  
          
        UPDATE V2_AGEINGFINAL   
        SET BUCKET_5 =   
            (ABS(BALANCE) - ABS(BUCKET_1) - ABS(BUCKET_2) - ABS(BUCKET_3) - ABS(BUCKET_4)) * SIGN(BALANCE)   
        WHERE   
            ABS(BALANCE) > ABS(BUCKET_1) + ABS(BUCKET_2) + ABS(BUCKET_3) + ABS(BUCKET_4)  
  
    TRUNCATE TABLE V2_AGEINGBUCKETS_TMP   
  
    INSERT INTO V2_AGEINGBUCKETS_TMP SELECT @@BUCKET_1, @@BUCKET_2, @@BUCKET_3, @@BUCKET_4   
  
    COMMIT  
      
/*==============================================================================================================    
    Clean Temporary Table   
==============================================================================================================*/    
    TRUNCATE TABLE V2_AGEINGDATA_TMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_REPORT
-- --------------------------------------------------



CREATE PROCEDURE V2_AGEING_REPORT 
(  
    @FILTER VARCHAR(11), 
    @FROMPARTY VARCHAR(10), 
    @TOPARTY VARCHAR(10), 
    @FILTERON VARCHAR(2), 
    @AGEINGON VARCHAR(3), 
    @SEGMENTCODE INT, 
	@STATUSID VARCHAR(20), 
	@STATUSNAME VARCHAR(20), 
    @BRANCH_CD VARCHAR(10) = '%'  
)  
  
AS  

SELECT PARTY_CODE, LONG_NAME INTO #CLIENT FROM MSAJAG.DBO.CLIENT_DETAILS C WHERE 1 = 2

INSERT INTO #CLIENT 
EXEC V2_ACCOUNT_LISTING  
	    @FILTER, 
		@FROMPARTY, 
		@TOPARTY, 
		@STATUSID, 
		@STATUSNAME 


    SELECT 
    	CLTCODE = C1.PARTY_CODE, 
    	BALANCE = SUM(BALANCE), 
        BUCKET_1 = SUM(BUCKET_1), 
        BUCKET_2 = SUM(BUCKET_2), 
        BUCKET_3 = SUM(BUCKET_3), 
        BUCKET_4 = SUM(BUCKET_4), 
        BUCKET_5 = SUM(BUCKET_5), 
    	C1.LONG_NAME 
    FROM 
        V2_AGEINGFINAL V, 
    	MSAJAG.DBO.CLIENT_DETAILS C, 
    	#CLIENT C1  
    WHERE 
        CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
        AND BALDATETYPE = (CASE WHEN @AGEINGON = 'VDT' THEN 1 ELSE 2 END)
        AND SEGMENTCODE = @SEGMENTCODE  
        AND SIGN(BALANCE) = (CASE WHEN @FILTERON = 'DR' THEN -1 ELSE 1 END)
        AND V.CLTCODE = C.PARTY_CODE     	
        AND C1.PARTY_CODE = ( 
    		CASE 
    			WHEN @FILTER = 'BRANCH' 
    			THEN C.BRANCH_CD 
    			WHEN @FILTER = 'CLIENT' 
    			THEN C.PARTY_CODE 
    			WHEN @FILTER = 'FAMILY' 
    			THEN C.FAMILY 
    		END) 
        AND C.BRANCH_CD LIKE @BRANCH_CD 
    GROUP BY 
        C1.PARTY_CODE, C1.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_REPORT_DETAIL
-- --------------------------------------------------



CREATE PROCEDURE V2_AGEING_REPORT_DETAIL 
(  
    @PARTY VARCHAR(10), 
    @AGEINGON VARCHAR(3), 
	@STATUSID VARCHAR(20), 
	@STATUSNAME VARCHAR(20)
)  
  
AS  

    SELECT PARTY_CODE, LONG_NAME INTO #CLIENT FROM MSAJAG.DBO.CLIENT_DETAILS C WHERE 1 = 2
    
    INSERT INTO #CLIENT 
    EXEC V2_ACCOUNT_LISTING  
    	    'CLIENT', 
    		@PARTY, 
    		@PARTY, 
    		@STATUSID, 
    		@STATUSNAME 

    SELECT 
    	CLTCODE = C.PARTY_CODE, 
        EXCHANGE, 
        SEGMENT, 
    	BALANCE = SUM(BALANCE), 
        BUCKET_1 = SUM(BUCKET_1), 
        BUCKET_2 = SUM(BUCKET_2), 
        BUCKET_3 = SUM(BUCKET_3), 
        BUCKET_4 = SUM(BUCKET_4), 
        BUCKET_5 = SUM(BUCKET_5), 
    	C.LONG_NAME 
    FROM 
        V2_AGEINGFINAL V, 
    	#CLIENT C, 
        V2_MULTIACCOUNTS A 
    WHERE 
        CLTCODE = @PARTY 
        AND BALDATETYPE = (CASE WHEN @AGEINGON = 'VDT' THEN 1 ELSE 2 END)
        AND V.SEGMENTCODE = A.SEGMENTCODE  
        AND V.CLTCODE = C.PARTY_CODE     	
    GROUP BY 
        C.PARTY_CODE, 
        EXCHANGE, 
        SEGMENT, 
        C.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_AGEING_REPORT_NEW
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[V2_AGEING_REPORT_NEW](              
                @FILTER      VARCHAR(11),              
                @FROMPARTY   VARCHAR(10),              
                @TOPARTY     VARCHAR(10),              
                @BALANCE     MONEY,              
                @AGEINGON    VARCHAR(3),              
                @SEGMENT     INT,              
                @STATUSID    VARCHAR(20),              
                @STATUSNAME  VARCHAR(20),              
                @BRANCH_CD   VARCHAR(10)  = '%',      
    @AMOUNTOVER MONEY)              

/*==============================================================================================              
 @FILTER =               
  'CLIENT'               
  'FAMILY'               
  'TRADER'               
  'SUBBROKER'               
  'BRANCH'               
  'REGION'               
  'AREA'               
==============================================================================================*/              
              
AS              
            
  SET NOCOUNT ON            

SELECT        @SEGMENT = 1     

            
  DECLARE               
   @@SELECT_CLAUSE  VARCHAR(1000),               
   @@FROM_CLAUSE    VARCHAR(1000),               
   @@WHERE_CLAUSE   VARCHAR(1000),               
   @@GROUP_CLAUSE   VARCHAR(200),               
   @@ORDER_CLAUSE   VARCHAR(100),               
   @@GROUPCODE      VARCHAR(20),               
   @@GROUPNAME      VARCHAR(100)              
            
  SELECT @@GROUPCODE = ( CASE @FILTER               
      WHEN "CLIENT" THEN " F.PARTY_CODE "               
      WHEN "FAMILY" THEN " F.FAMILY "              
      WHEN "TRADER" THEN " F.TRADER "              
      WHEN "SUBBROKER" THEN " F.SUB_BROKER "              
      WHEN "BRANCH" THEN " F.BRANCH_CD "              
      WHEN "REGION" THEN " F.REGION "              
      WHEN "AREA" THEN " F.AREA "              
        END )               
                
  SELECT @@GROUPNAME = ( CASE @FILTER               
      WHEN "CLIENT" THEN " F.PARTY_NAME "               
      WHEN "FAMILY" THEN " F.FAMILY "              
      WHEN "TRADER" THEN " F.TRADER "              
      WHEN "SUBBROKER" THEN " F.SUB_BROKER "              
      WHEN "BRANCH" THEN " F.BRANCH_CD "              
      WHEN "REGION" THEN " F.REGION "              
      WHEN "AREA" THEN " F.AREA "              
        END )               
            
  SET @@SELECT_CLAUSE =                   " SELECT CLTCODE = " + @@GROUPCODE + ", LONG_NAME = " + @@GROUPNAME + ", "               
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   BALANCE = SUM(BALANCE), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   BUCKET_1 = SUM(BUCKET_1), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   BUCKET_2 = SUM(BUCKET_2), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   BUCKET_3 = SUM(BUCKET_3), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   BUCKET_4 = SUM(BUCKET_4), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   BUCKET_5 = SUM(BUCKET_5), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   CASH = SUM(F.CASH), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   NONCASH = SUM(F.NONCASH), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   IMMARGIN = SUM(F.IMMARGIN), "             
  SET @@SELECT_CLAUSE = @@SELECT_CLAUSE + "   VARMARGIN = SUM(F.VARMARGIN) "             
            
  SET @@FROM_CLAUSE =                 " FROM V2_AGEINGFINAL V WITH(NOLOCK), "              
  SET @@FROM_CLAUSE = @@FROM_CLAUSE + "      V2_FOUT_LEDGERBALANCES F WITH(NOLOCK) "              
            
  SET @@WHERE_CLAUSE  =                  " WHERE V.CLTCODE = F.PARTY_CODE "              
  SET @@WHERE_CLAUSE  = @@WHERE_CLAUSE + "    AND V.SEGMENTCODE = " + CONVERT(CHAR,@SEGMENT) + " "             
  SET @@WHERE_CLAUSE  = @@WHERE_CLAUSE + "    AND V.BALDATETYPE = (CASE WHEN '" + @AGEINGON + "' = 'VDT' THEN 1 ELSE 2 END) "             
  SET @@WHERE_CLAUSE  = @@WHERE_CLAUSE + "    AND " + @@GROUPCODE + " BETWEEN '" + @FROMPARTY + "' AND '" + @TOPARTY + "' "            
            
  SET @@GROUP_CLAUSE = " Group By " + @@GROUPCODE + ", " + @@GROUPNAME               
  IF @BALANCE <> 0             
  BEGIN             
    SET @@GROUP_CLAUSE  = @@GROUP_CLAUSE + "    HAVING SIGN(SUM(BALANCE)) = " + CONVERT(CHAR,@BALANCE) + " AND"            
  END             
ELSE      
 BEGIN       
  SET @@GROUP_CLAUSE  = @@GROUP_CLAUSE + "  HAVING "       
 END      
      
  SET @@GROUP_CLAUSE  = @@GROUP_CLAUSE + " abs(sum(BUCKET_1+BUCKET_2+BUCKET_3+BUCKET_4+BUCKET_5))>" + CONVERT(CHAR,@AMOUNTOVER)      
      
  SET @@ORDER_CLAUSE = " Order By 1 "             
            
--PRINT ( @@SELECT_CLAUSE + @@FROM_CLAUSE + @@WHERE_CLAUSE + @@GROUP_CLAUSE + @@ORDER_CLAUSE )            
            
EXEC ( @@SELECT_CLAUSE + @@FROM_CLAUSE + @@WHERE_CLAUSE + @@GROUP_CLAUSE + @@ORDER_CLAUSE )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BulkPayoutPosting
-- --------------------------------------------------





CREATE Procedure V2_BulkPayoutPosting 
(
      @SessionId varchar(50), 
      @Uname varchar(50), 
      @S_SessionId varchar(50), 
      @Sett_No varchar(50), 
      @Sett_Type varchar(50), 
      @GenFlag varchar(1) 
)

As

-- Exec V2_BulkPayoutPosting '1971159042202006', 'boxm', '1971159042', '2006012', 'N', 'S' 

            Set NoCount On

            Declare 
            @@NEWVNO As Varchar(12), 
            @@MAXCOUNT As Int, 
            @@VDT As Varchar(11), 
            @@BANKBRANCH As Varchar(10), 
            @@BANKCOST As Numeric, 
            @@LNOCUR As Cursor, 
            @@LNOVNO As Varchar(12), 
            @@ERROR_COUNT Int 
            
            DECLARE 
            @@STD_DATE VARCHAR(11), 
            @@LST_DATE VARCHAR(11), 
            @@VNOMETHOD INT, 
            @@ACNAME CHAR(100), 
            @@BOOKTYPE CHAR(2), 
            @@MICRNO VARCHAR(10), 
            @@DRCR VARCHAR(1), 
            @@VTYP SMALLINT 

            -------------------------- UPDATE BANK CODE DETAILS ------------------------
            UPDATE 
                p 
                SET bnkname = a.acname, 
                branchcode = a.branchcode, 
                micrno = a.micrno, 
                BookType = a.BookType, 
                accdtls = a.accdtls, 
                updflag = 'Y' 
            FROM V2_payout_temp p, 
                Acmast a 
            WHERE p.bnkcode = a.Cltcode 
                AND Accat = 2 
                AND SessionId = @SessionId 
      
            UPDATE 
                P 
                SET COSTCODE = C.COSTCODE 
            FROM ACMAST a, 
                COSTMAST C, 
                V2_payout_temp P 
            WHERE a.cltcode = Accode 
                AND ACCAT in ('4') 
                AND A.BRANCHCODE = C.COSTNAME 
      
      
            UPDATE 
                P 
                SET COSTCODE = C.COSTCODE 
            FROM ACMAST a, 
                COSTMAST C, 
                V2_payout_temp P
            WHERE a.cltcode = bnkcode 
                AND ACCAT in ('2') 
                AND A.BRANCHCODE = C.COSTNAME 
            
            
           UPDATE 
                V2_payout_temp 
                SET bankcost = costcode 
            WHERE bankcost = '' 
      
	
	SELECT  top 1
		@@ACNAME = bnkname,  
		@@BOOKTYPE = booktype,  
		@@MICRNO = MicrNo,  
		@@VTYP = vtyp 
	FROM V2_payout_temp  Where SessionId = @SessionId 
	
	-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
	Select @@ERROR_COUNT = COUNT(1) From 
		( 
		Select Distinct acCode 
	            From V2_payout_temp 
	            Where updflag = 'N' And SessionId = @SessionId 
	      ) A 
      
	If @@ERROR_COUNT > 0 
	Begin 
		Select 'FOLLOWING CLIENTS DO NOT EXIST' 
		Union All 
		Select Distinct acCode 
			From V2_payout_temp 
			Where updflag = 'N' And SessionId = @SessionId 
			RETURN 
	END 	

	--------------------------AUTO GENERATION OF VNO ------------------------
	Select 
		@@STD_DATE = LEFT(SDTCUR, 11), 
		@@LST_DATE = LEFT(LDTCUR, 11), 
		@@VNOMETHOD = VNOFLAG 
		From Parameter 
		Where Curyear = 1 

	Select @@MAXCOUNT = Count(Distinct Srno) From V2_payout_temp Where SessionId = @SessionId 
	Select Top 1 @@VDT = vdt From V2_payout_temp Where SessionId = @SessionId 
	Select Lastvno Into #VNO From Lastvno Where 1 = 2 

	Insert Into #VNO 
		EXEC Acc_GenVno_New 
			@@VDT, 
			@@VTYP, 
			@@BOOKTYPE, 
			@@STD_DATE, 
			@@LST_DATE 
      
	SELECT @@NEWVNO = Lastvno From #VNO 

	Update 
		V2_payout_temp 
			SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (Srno - 1)) Where SessionId = @SessionId 

	UPDATE 
		V2_LASTVNO 
			SET LASTVNO = 
				( 
					SELECT 
						MAX(VNO) 
							FROM V2_payout_temp 
							WHERE VTYP = @@VTYP 
							AND BOOKTYPE = @@BOOKTYPE And SessionId = @SessionId 
				) 
			WHERE VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59' 
	DROP TABLE #VNO 
	
	--------------------------AUTO GENERATION OF LNO ------------------------
	Update 
		V2_payout_temp 
			Set lno = 2 
		Where vno in 
		( 
			Select 
				vno 
			From V2_payout_temp WITH(NOLOCK) 
			Where SessionId = @SessionId 
			Group By vno 
			Having count(*) = 1 
		) 

	Set @@LNOCUR = CURSOR For 
		Select 
			vno 
		From V2_payout_temp With(NOLOCK) Where SessionId = @SessionId 
		Group BY vno 
		Having count(*) > 1 
		OPEN @@LNOCUR 
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO 
		WHILE @@FETCH_STATUS = 0 
		BEGIN 
	
			Create Table [#lnogen] ( 
				VNO varchar(12), 
				SNO INT, 
				LNO INT IDENTITY(1,1)) 

			Insert Into #lnogen 
				Select 
					vno, 
					sno 
				From V2_payout_temp WITH(NoLock) 
				Where vno = @@LNOVNO And SessionId = @SessionId 
				Order BY sno 
            
			Update 
				V2_payout_temp 
				Set lno = l.lno + 1 
			From #lnogen l 
			Where V2_payout_temp.vno = l.vno 
			And V2_payout_temp.sno = l.sno 
			And V2_payout_temp.lno = 0 And SessionId = @SessionId 
            
			Drop Table #lnogen 
			FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO 
		END 
		CLOSE @@LNOCUR 
		DEALLOCATE @@LNOCUR 


	--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
	Insert 
		Into ledger1 
		Select 
			bnkname = MAX(bnkname), 
			brnname = MAX(brcode), 
			dd = LEFT(MAX(Paymode), 1), 
			ddno = MAX(ddno), 
			dddt = MAX(vdt), 
			reldt = '', 
			relamt = SUM(amt), 
			refno = 0, 
			receiptno = 0, 
			vtyp, 
			vno, 
			lno = 2, 
			drcr, 
			BookType = @@BOOKTYPE, 
			MicrNo = @@MICRNO, 
			SlipNo = 0, 
			slipdate = '', 
			ChequeInName = MAX(ISNULL(Acname,'')), 
			Chqprinted = 0, 
			clear_mode = '' 
		From 
			V2_payout_temp Where SessionId = @SessionId 
		Group By VTYP, VNO, DRCR 
		 
	/*============================== 
	      CLIENT SIDE RECORD 
	==============================*/ 
	Insert 
		Into ledger 
		Select 
			vtyp, 
			vno, 
			edt, 
			lno, 
			acname, 
			drcr, 
			vamt = amt, 
			vdt, 
			vno1 = VNO, 
			refno = 0, 
			balamt = amt, 
			NoDays = 0, 
			cdt = GETDATE(), 
			cltcode = acCode, 
			BookType = @@BOOKTYPE, 
			EnteredBy = @Uname, 
			pdt = GETDATE(), 
			CheckedBy = @Uname, 
			actnodays = 0, 
			narration 
		From 
			V2_payout_temp Where SessionId = @SessionId 
    
	/*============================== 
	      BANK SIDE RECORD 
	==============================*/ 
	Insert 
		Into ledger 
		Select 
			vtyp, 
			vno, 
			edt, 
			lno = 1, 
			@@acname, 
			drcr = (Case When DrCr = 'D' Then 'C' Else 'D' End), 
			vamt = Sum(amt), 
			vdt, 
			vno1 = VNO, 
			refno = 0, 
			balamt = Sum(amt), 
			NoDays = 0, 
			cdt = GETDATE(), 
			cltcode = bnkcode, 
			BookType = @@BOOKTYPE, 
			EnteredBy = @Uname, 
			pdt = GETDATE(), 
			CheckedBy = @Uname, 
			actnodays = 0, 
			narration = MAX(narration) 
		From 
			V2_payout_temp Where SessionId = @SessionId 
		Group By VTYP, VNO, EDT, DRCR, VDT, bnkcode 
		
	/*============================== 
	      BANK SIDE RECORD 
	==============================*/ 
	Insert 
		Into ledger3 
		Select 
			naratno = 1, 
			narration = MAX(narration), 
			refno = 0, 
			vtyp, 
			vno, 
			@@BookType 
		From 
			V2_payout_temp Where SessionId = @SessionId 
		Group By VTYP, VNO 

	/*============================== 
	      CLIENT SIDE RECORD 
	==============================*/ 
	Insert 
		Into ledger3 
		Select 
			naratno = LNO, 
			narr = NARRATION, 
			refno = 0, 
			vtyp, 
			vno, 
			@@BookType 
		From 
			V2_payout_temp Where SessionId = @SessionId 
	
	DECLARE @@L2CUR AS CURSOR, 
		@@L2VNO AS VARCHAR(12) 
		SET @@L2CUR = CURSOR FOR 
			SELECT DISTINCT VNO FROM V2_payout_temp Where SessionId = @SessionId ORDER BY VNO 
		OPEN @@L2CUR 
		FETCH NEXT FROM @@L2CUR INTO @@L2VNO 
		WHILE @@FETCH_STATUS = 0 
			BEGIN 
				Delete From Templedger2 
					Where Sessionid =  @S_SessionId

	/*============================== 
	      CLIENT SIDE RECORD 
	==============================*/ 
	
				Insert Into Templedger2 
				Select 
					'BRANCH', 
					C.COSTNAME, 
					amt, 
					VTYP, 
					VNO, 
					LNO, 
					DRCR, 
					'0', 
					@@BOOKTYPE, 
					@S_SessionId , 
					acCode, 
					'A', 
					'0' 
				From 
					V2_payout_temp RP, 
					COSTMAST C 
				Where 
					RP.COSTCODE = C.COSTCODE 
					And VNO = @@L2VNO And SessionId = @SessionId 
	/*============================== 
	      BANK SIDE RECORD 
	==============================*/ 
	
				Insert Into Templedger2 
				Select 
					'BRANCH', 
					branchcode, 
					SUM(amt), 
					VTYP, 
					VNO, 
					LNO = 1, 
					DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), 
					'0', 
					@@BOOKTYPE, 
					@S_SessionId, 
					bnkcode, 
					'A', 
					'0' 
				From 
					V2_payout_temp 
				Where 
					VNO = @@L2VNO And SessionId = @SessionId 
				Group By branchcode, VTYP, VNO, (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), bnkcode 


				EXEC InsertToLedger2 @S_SessionId, @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER' 

				FETCH NEXT FROM @@L2CUR INTO @@L2VNO 
			END 
				Delete From Templedger2 
					Where Sessionid =  @S_SessionId   
	
	Update S 
		Set status = 'A', 
		ApprovedDt = getDate(), 
		HOPaymode = P.Paymode, 
		bankcode = P.bnkcode, 
		Vno = P.Vno, 
		vdt = P.vdt, 
		edt = P.edt, 
		Amounttobepaid = P.amt 
	From 
		SettPayout S, 
		V2_payout_temp P 
	Where 
		CltCode = acCode 
		And S.branchcode = brcode 
		And isnull(settno,'') = isnull(@Sett_No,'') 
		And isnull(setttype,'') = isnull(@Sett_Type,'')
                  And GenFlag = @GenFlag 
		And Status = 'P' 
                  And P.SessionId = @SessionId 
			
	Delete From 
		V2_LedgerBalance 
	Where 
		PartyCode In (Select acCode From V2_payout_temp Where updflag = 'Y' And SessionId = @SessionId) 


	Select 'Voucher Numbers Generated : <BR>' 
         Union All 
	Select VNO + ' : ' + acCode + Space(10 - len(acCode)) + ' : ' + Convert(Varchar, amt) + '~' As Result 
	From V2_payout_temp Where SessionId = @SessionId  

	Delete From V2_payout_temp Where SessionId = @SessionId

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_COMBINED
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[V2_BULKPAYOUTPOSTING_COMBINED]
(
@SESSIONID VARCHAR(50),
@UNAME VARCHAR(50),
@S_SESSIONID VARCHAR(50),
@GENFLAG VARCHAR(1),
@SEGMENT CHAR(2)
)

AS
-- EXEC V2_BULKPAYOUTPOSTING_COMBINED '1971159042202006', 'BOXM', '1971159042', 'A'

SET NOCOUNT ON

DECLARE
@@NEWVNO AS VARCHAR(12),
@@MAXCOUNT AS INT,
@@VDT AS VARCHAR(11),
@@BANKBRANCH AS VARCHAR(10),
@@BANKCOST AS NUMERIC,
@@VNOCUR AS CURSOR,
@@LNOCUR AS CURSOR,
@@LNOVNO AS VARCHAR(12),
@@ERROR_COUNT INT,
@@STD_DATE VARCHAR(11),
@@LST_DATE VARCHAR(11),
@@VNOMETHOD INT,
@@ACNAME CHAR(100),
@@BOOKTYPE CHAR(2),
@@MICRNO VARCHAR(10),
@@DRCR VARCHAR(1),
@@VTYP SMALLINT,
@@BNKCODE VARCHAR(100),
@@MAXVNO INT,
@@ACCOUNTSERVER VARCHAR(15),
@@SQL VARCHAR(2500)

SELECT @@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY WHERE ACCOUNTDB  = 'ACCOUNT'

-------------------------- UPDATE BANK CODE DETAILS ------------------------
UPDATE
P
SET BNKNAME = A.ACNAME,
BRANCHCODE = A.BRANCHCODE,
MICRNO = A.MICRNO,
BOOKTYPE = A.BOOKTYPE,
ACCDTLS = A.ACCDTLS,
UPDFLAG = 'Y'
FROM V2_PAYOUT_TEMP P,
ACMAST A
WHERE P.BNKCODE = A.CLTCODE
AND ACCAT = 2
AND SESSIONID = @SESSIONID

UPDATE
P
SET COSTCODE = C.COSTCODE,
ACNAME = A.LONGNAME
FROM ACMAST A,
COSTMAST C,
V2_PAYOUT_TEMP P
WHERE A.CLTCODE = ACCODE
AND ACCAT IN ('4')
AND A.BRANCHCODE = C.COSTNAME
AND SESSIONID = @SESSIONID

UPDATE
P
SET BANKCOST = C.COSTCODE
FROM ACMAST A,
COSTMAST C,
V2_PAYOUT_TEMP P
WHERE A.CLTCODE = BNKCODE
AND ACCAT IN ('2')
AND A.BRANCHCODE = C.COSTNAME
AND SESSIONID = @SESSIONID

UPDATE
V2_PAYOUT_TEMP
SET BANKCOST = COSTCODE
WHERE BANKCOST = ''
AND SESSIONID = @SESSIONID

-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
SELECT @@ERROR_COUNT = COUNT(1) FROM
(
SELECT DISTINCT ACCODE
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE UPDFLAG = 'N' AND SESSIONID = @SESSIONID
) A

IF @@ERROR_COUNT > 0
BEGIN
SELECT 'FOLLOWING CLIENTS DO NOT EXIST'
UNION ALL
SELECT DISTINCT ACCODE
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE UPDFLAG = 'N' AND SESSIONID = @SESSIONID
DELETE FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID
RETURN
END

--------------------------AUTO GENERATION OF VNO ------------------------
SELECT
@@STD_DATE = LEFT(SDTCUR, 11),
@@LST_DATE = LEFT(LDTCUR, 11),
@@VNOMETHOD = VNOFLAG
FROM PARAMETER
WHERE CURYEAR = 1     

SET @@VNOCUR = CURSOR FOR
SELECT DISTINCT
BNKCODE,
BOOKTYPE,
VTYP
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
SESSIONID = @SESSIONID

OPEN @@VNOCUR
FETCH NEXT
FROM
@@VNOCUR
INTO
@@BNKCODE,
@@BOOKTYPE,
@@VTYP
WHILE @@FETCH_STATUS = 0
BEGIN
CREATE TABLE
#BANK_VNO
(
SRNO INT,
NEWSRNO INT IDENTITY (1, 1)
)

INSERT INTO
#BANK_VNO
SELECT
DISTINCT SRNO
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
BNKCODE = @@BNKCODE
AND BOOKTYPE = @@BOOKTYPE
AND SESSIONID = @SESSIONID

SELECT
@@MAXCOUNT = COUNT(DISTINCT SRNO)
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
SESSIONID = @SESSIONID

SELECT TOP 1
@@VDT = VDT
FROM
V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE
SESSIONID = @SESSIONID

SELECT  
LASTVNO  
INTO #VNO  
FROM  
LASTVNO  
WHERE  
1 = 2

SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

INSERT INTO #VNO
EXEC ACC_GENVNO_NEW
@@VDT,
@@VTYP,
@@BOOKTYPE,
@@STD_DATE,
@@LST_DATE,  
@@MAXVNO  

SELECT  
@@NEWVNO = LASTVNO  
FROM  
#VNO

UPDATE
P
SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
FROM
V2_PAYOUT_TEMP P WITH(NOLOCK),
#BANK_VNO BV
WHERE
P.SRNO = BV.SRNO 
AND SESSIONID = @SESSIONID

DROP TABLE #VNO  
DROP TABLE #BANK_VNO

FETCH NEXT  
FROM @@VNOCUR  
INTO  
@@BNKCODE,  
@@BOOKTYPE,
@@VTYP  
END  

DEALLOCATE @@VNOCUR

--------------------------AUTO GENERATION OF LNO ------------------------
UPDATE
V2_PAYOUT_TEMP
SET LNO = 2
WHERE VNO IN
(
SELECT
VNO
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE SESSIONID = @SESSIONID
GROUP BY VNO
HAVING COUNT(*) = 1
)

SET @@LNOCUR = CURSOR FOR
SELECT
VNO
FROM V2_PAYOUT_TEMP WITH(NOLOCK) WHERE SESSIONID = @SESSIONID
GROUP BY VNO
HAVING COUNT(*) > 1

OPEN @@LNOCUR
FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
WHILE @@FETCH_STATUS = 0

BEGIN
CREATE TABLE [#LNOGEN] (
VNO VARCHAR(12),
SNO INT,
LNO INT IDENTITY(1,1))

INSERT INTO #LNOGEN
SELECT
VNO,
SRNO
FROM V2_PAYOUT_TEMP WITH(NOLOCK)
WHERE VNO = @@LNOVNO AND SESSIONID = @SESSIONID
ORDER BY SRNO

UPDATE
V2_PAYOUT_TEMP
SET LNO = L.LNO + 1
FROM #LNOGEN L
WHERE V2_PAYOUT_TEMP.VNO = L.VNO
AND V2_PAYOUT_TEMP.SRNO = L.SNO
AND V2_PAYOUT_TEMP.LNO = 0 AND SESSIONID = @SESSIONID

DROP TABLE #LNOGEN
FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
END
CLOSE @@LNOCUR
DEALLOCATE @@LNOCUR

BEGIN TRANSACTION

--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
INSERT
INTO LEDGER1
SELECT
BNKNAME,
BRNNAME = BRCODE,
DD = LEFT(PAYMODE, 1),
DDNO,
DDDT = VDT,
RELDT = '',
RELAMT = AMT,
REFNO = 0,
RECEIPTNO = 0,
VTYP,
VNO,
LNO = 2,
DRCR,
BOOKTYPE,
MICRNO,
SLIPNO = 0,
SLIPDATE = '',
CHEQUEINNAME = ISNULL(ACNAME,''),
CHQPRINTED = 0,
CLEAR_MODE = ''
FROM
V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID

/*==============================
CLIENT SIDE RECORD
==============================*/
INSERT
INTO LEDGER
SELECT
VTYP,
VNO,
EDT,
LNO,
ACNAME,
DRCR,
VAMT = AMT,
VDT,
VNO1 = VNO,
REFNO = 0,
BALAMT = AMT,
NODAYS = 0,
CDT = GETDATE(),
CLTCODE = ACCODE,
BOOKTYPE,
ENTEREDBY = @UNAME,
PDT = GETDATE(),
CHECKEDBY = @UNAME,
ACTNODAYS = 0,
NARRATION
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID

INSERT INTO LEDGER2
SELECT
VTYP,
VNO,
LNO,
DRCR,
CAMT = AMT,
COSTCODE,
BOOKTYPE,
CLTCODE = ACCODE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID
AND COSTCODE = BANKCOST

/*==============================
BANK SIDE RECORD
==============================*/
INSERT
INTO LEDGER
SELECT
VTYP,
VNO,
EDT,
LNO = 1,
BNKNAME,
DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
VAMT = AMT,
VDT,
VNO1 = VNO,
REFNO = 0,
BALAMT = AMT,
NODAYS = 0,
CDT = GETDATE(),
CLTCODE = BNKCODE,
BOOKTYPE,
ENTEREDBY = @UNAME,
PDT = GETDATE(),
CHECKEDBY = @UNAME,
ACTNODAYS = 0,
NARRATION
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID


INSERT INTO LEDGER2
SELECT
VTYP,
VNO,
LNO = 1,
DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
CAMT = AMT,
COSTCODE,
BOOKTYPE,
CLTCODE = BNKCODE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID
AND COSTCODE = BANKCOST

UPDATE V2_PAYOUT_TEMP SET LEDGER2_UPD = 'Y' WHERE SESSIONID = @SESSIONID AND COSTCODE = BANKCOST


/*==============================
BANK SIDE RECORD
==============================*/
INSERT
INTO LEDGER3
SELECT
NARATNO = 1,
NARRATION,
REFNO = 0,
VTYP,
VNO,
BOOKTYPE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID

/*==============================
CLIENT SIDE RECORD
==============================*/
INSERT
INTO LEDGER3
SELECT
NARATNO = LNO,
NARR = NARRATION,
REFNO = 0,
VTYP,
VNO,
BOOKTYPE
FROM
V2_PAYOUT_TEMP
WHERE
SESSIONID = @SESSIONID


DECLARE @@L2CUR AS CURSOR,
@@L2VNO AS VARCHAR(12)
SET @@L2CUR = CURSOR FOR
SELECT DISTINCT VNO FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
OPEN @@L2CUR
FETCH NEXT FROM @@L2CUR INTO @@L2VNO
WHILE @@FETCH_STATUS = 0

BEGIN
DELETE FROM TEMPLEDGER2
WHERE SESSIONID =  @S_SESSIONID

/*==============================
CLIENT SIDE RECORD
==============================*/

INSERT INTO TEMPLEDGER2
SELECT
'BRANCH',
C.COSTNAME,
AMT,
VTYP,
VNO,
LNO,
DRCR,
'0',
BOOKTYPE,
@S_SESSIONID ,
ACCODE,
'A',
'0'
FROM
V2_PAYOUT_TEMP RP,
COSTMAST C
WHERE
RP.COSTCODE = C.COSTCODE
AND VNO = @@L2VNO
AND SESSIONID = @SESSIONID

/*==============================
BANK SIDE RECORD
==============================*/

INSERT INTO TEMPLEDGER2
SELECT
'BRANCH',
BRANCHCODE,
SUM(AMT),
VTYP,
VNO,
LNO = 1,
DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
'0',
BOOKTYPE,
@S_SESSIONID,
BNKCODE,
'A',
'0'
FROM
V2_PAYOUT_TEMP
WHERE
VNO = @@L2VNO
AND SESSIONID = @SESSIONID
GROUP BY BRANCHCODE, VTYP, VNO, (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE


EXEC INSERTTOLEDGER2 @S_SESSIONID, @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'

FETCH NEXT FROM @@L2CUR INTO @@L2VNO
END

DELETE FROM TEMPLEDGER2
WHERE SESSIONID =  @S_SESSIONID

SELECT @@SQL = ""
SELECT @@SQL = @@SQL + "UPDATE S "
SELECT @@SQL = @@SQL + "SET STATUS = 'A', "
SELECT @@SQL = @@SQL + "APPROVEDDT = GETDATE(), "
SELECT @@SQL = @@SQL + "HOPAYMODE = P.PAYMODE, "
SELECT @@SQL = @@SQL + "BANKCODE = P.BNKCODE, "
SELECT @@SQL = @@SQL + "VNO = P.VNO, "
SELECT @@SQL = @@SQL + "VDT = P.VDT, "
SELECT @@SQL = @@SQL + "EDT = P.EDT, "
SELECT @@SQL = @@SQL + "AMOUNTTOBEPAID = P.AMT, "
SELECT @@SQL = @@SQL + "REMARK = P.REMARK "
SELECT @@SQL = @@SQL + "FROM "
SELECT @@SQL = @@SQL + "[" + @@ACCOUNTSERVER + "].ACCOUNT.DBO.V2_SETTPAYOUT S, "
SELECT @@SQL = @@SQL + "V2_PAYOUT_TEMP P "
SELECT @@SQL = @@SQL + "WHERE "
SELECT @@SQL = @@SQL + "CLTCODE = ACCODE "
SELECT @@SQL = @@SQL + "AND S.BRANCHCODE = BRCODE "
SELECT @@SQL = @@SQL + "AND GENFLAG = '" + @GENFLAG + "' "
SELECT @@SQL = @@SQL + "AND STATUS = 'P' "
SELECT @@SQL = @@SQL + "AND P.SESSIONID = '" + @SESSIONID + "' "

SELECT @@SQL = @@SQL + "INSERT INTO [" + @@ACCOUNTSERVER + "].ACCOUNT.DBO.V2_PAYOUTCLIENT "
SELECT @@SQL = @@SQL + "SELECT ACCODE FROM V2_PAYOUT_TEMP WHERE UPDFLAG = 'Y' AND SESSIONID = '" + @SESSIONID + "' "

SELECT @@SQL = @@SQL + "DELETE FROM "
SELECT @@SQL = @@SQL + "[" + @@ACCOUNTSERVER + "].ACCOUNT.DBO.V2_LEDGERBALANCE_COMBINED "
SELECT @@SQL = @@SQL + "WHERE "
SELECT @@SQL = @@SQL + "PARTYCODE IN (SELECT CLTCODE FROM [" + @@ACCOUNTSERVER + "].ACCOUNT.DBO.V2_PAYOUTCLIENT) "

SELECT @@SQL = @@SQL + "DELETE FROM [" + @@ACCOUNTSERVER + "].ACCOUNT.DBO.V2_PAYOUTCLIENT "

EXEC (@@SQL)

SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
UNION ALL
SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
UNION ALL
SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
UNION ALL
SELECT '<HR>'
UNION ALL
SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
UNION ALL
SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '~<BR>'
FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

DELETE FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CALCULATE_FOUT_BALANCES
-- --------------------------------------------------
CREATE  PROC [DBO].[V2_CALCULATE_FOUT_BALANCES](        
         @COLL_COMPO_PER MONEY = 1)      
      
AS      
    
  SET NOCOUNT ON    
    
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
    
  DECLARE  @@rmsdate VARCHAR(11)    
                         
  SELECT TOP 1 @@rmsdate = ISNULL(LEFT(SAUDA_DATE,11),LEFT(GETDATE(),11))    
  FROM   MSAJAG..RMSALLSEGMENT    
  WHERE  SAUDA_DATE >= LEFT(GETDATE()-3,11)    
  ORDER BY 1 DESC     
    
  IF @COLL_COMPO_PER < 0.1 SET @COLL_COMPO_PER = 0.1        
        
  IF @COLL_COMPO_PER > 1 SET @COLL_COMPO_PER = 1        
        
  DECLARE       
    @FROMDATE VARCHAR(11),       
    @PROCESSPARAMS VARCHAR(100)      
      
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11)        
      
  TRUNCATE TABLE V2_FOUT_LEDGERBALANCES_TEMP      
      
  INSERT INTO V2_FOUT_LEDGERBALANCES_TEMP      
  SELECT PARTY_CODE = C1.CL_CODE,      
         PARTY_NAME = C1.LONG_NAME,      
         FAMILY_CODE = C1.FAMILY,      
         FAMILY_NAME = C1.FAMILY,      
         BRANCH_CODE = C1.BRANCH_CD,      
         BRANCH_NAME = ISNULL(BR.BRANCH,'UNSPECIFIED'),      
         TRADER = C1.TRADER,      
         TRADER_NAME = ISNULL(TR.LONG_NAME,'UNSPECIFIED'),      
         SUBBROKER_CODE = C1.SUB_BROKER,      
         SUBBROKER_NAME = ISNULL(SR.NAME,'UNSPECIFIED'),      
         AREACODE = ISNULL(C1.AREA,''),      
         AREANAME = ISNULL(AR.DESCRIPTION,'UNSPECIFIED'),      
         REGION_CODE = ISNULL(C1.REGION,''),      
         REGION_NAME = ISNULL(RE.DESCRIPTION,'UNSPECIFIED'),      
         RES_PHONE = ISNULL(C1.RES_PHONE1,''),      
         NSEBALANCE = 0,      
         BSEBALANCE = 0,      
         NSEFOBALANCE = 0,      
	 NSXCURBALANCE =0,
	 MCXCURBALANCE =0,
         NSEESTIMATED1 = 0,      
         NSEESTIMATED2 = 0,      
         BSEESTIMATED1 = 0,      
         BSEESTIMATED2 = 0,      
         FAACTUAL = 0,      
         NONCASH = 0,      
         CASH = 0,      
         IMMARGIN = 0,      
         VARMARGIN = 0,      
         REPDATE = GETDATE(),     
         BEN_HOLDING = 0       
  FROM   MSAJAG.DBO.CLIENT_DETAILS C1 WITH(NOLOCK)      
           LEFT OUTER JOIN MSAJAG.DBO.BRANCH BR WITH(NOLOCK)      
           ON (C1.BRANCH_CD = BR.BRANCH_CODE)      
           LEFT OUTER JOIN MSAJAG.DBO.SUBBROKERS SR WITH(NOLOCK)      
           ON (C1.SUB_BROKER = SR.SUB_BROKER)      
           LEFT OUTER JOIN MSAJAG.DBO.BRANCHES TR WITH(NOLOCK)      
           ON (C1.TRADER = TR.SHORT_NAME)      
           LEFT OUTER JOIN (SELECT AREACODE, DESCRIPTION = MAX(DESCRIPTION) FROM MSAJAG.DBO.AREA WITH(NOLOCK) GROUP BY AREACODE)  AR      
           ON (C1.AREA = AR.AREACODE)      
           LEFT OUTER JOIN (SELECT REGIONCODE, DESCRIPTION = MAX(DESCRIPTION) FROM MSAJAG.DBO.REGION WITH(NOLOCK) GROUP BY REGIONCODE)  RE      
           ON (C1.REGION = RE.REGIONCODE)      
     
  UPDATE  V2_FOUT_LEDGERBALANCES_TEMP     
  SET     FAMILY_NAME = LONG_NAME     
  FROM    MSAJAG.DBO.CLIENT_DETAILS     
  WHERE   V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE = FAMILY     
    
/*=======================================================================================      
PARTY CODE UPDATE IS COMPLETE      
    BALANCE_1 = EFFECTIVE DATE WISE NET BALANCE AFTER EXCLUDING [Receipt Bank] ENTRIES      
    BALANCE_2 = TOTAL [Receipt Bank] BASED ON VOUCHER DATE       
    ACTUAL_1 = VOUCHER DATE WISE NET BALANCE AFTER EXCLUDING [Receipt Bank] ENTRIES      
    ACTUAL_2 = TOTAL [Receipt Bank] BASED ON EFFECTIVE DATE       
      
    NSEBALANCE = BALANCE_1 + BALANCE_2      
    FAACTUAL = ACTUAL_1 + ACTUAL_2          
=======================================================================================*/      
      
  UPDATE V2_FOUT_LEDGERBALANCES_TEMP          
  SET    NSEBALANCE = BALANCE_1 +  BALANCE_2,          
         FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2          
  FROM   (SELECT L.CLTCODE,          
                 BALANCE_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                   AND VTYP <> 2 THEN (CASE     
                                                                                           WHEN L.DRCR = 'D' THEN VAMT     
                                                                                           ELSE -VAMT     
                                                                                         END)              
                                                                ELSE 0     
                                                              END),0)),      
                 BALANCE_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN VTYP = 2 THEN -VAMT           
                                                                ELSE 0     
                                                              END),0)),      
                 ACTUAL_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                               WHEN VTYP <> 2 THEN (CASE     
                                                                                      WHEN L.DRCR = 'D' THEN VAMT     
                                                                                      ELSE -VAMT     
                                                                                    END)          
                                                               ELSE 0     
                                                             END),0)),      
                 ACTUAL_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE           
                                                               WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                    AND VTYP = 2 THEN -VAMT           
                                                               ELSE 0     
                                                             END),0))       
          FROM   ACCOUNT.DBO.LEDGER L WITH(NOLOCK),      
                 ACCOUNT.DBO.PARAMETER P WITH(NOLOCK),      
                 V2_FOUT_LEDGERBALANCES_TEMP FL WITH(NOLOCK)          
          WHERE  VDT BETWEEN SDTCUR AND @FROMDATE + ' 23:59'          
                 AND @FROMDATE BETWEEN SDTCUR AND LDTCUR          
                 AND L.CLTCODE = FL.PARTY_CODE      
          GROUP BY L.CLTCODE) A       
  WHERE  V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE          
      
      
/*--------------------------------------------------------------------------------------------------------------          
BSE CASH      
UPDATE EDT LEDGER BALANCES - RECEIPT BANK ENTRIES IGNORED          
UPDATE TOTAL RECEIPT BANK ENTRIES AMOUNT AS ON VDT      
UPDATE THE ACTUAL CONSOLIDATED LEDGER BALANCE (FAACTUAL)          
RECEIPT BANK ENTRIES CONSIDERED ON EFFECTIVE DATE BASIS          
--------------------------------------------------------------------------------------------------------------*/          
  UPDATE V2_FOUT_LEDGERBALANCES_TEMP          
  SET    BSEBALANCE = BALANCE_1 +  BALANCE_2,          
         FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2          
  FROM   (SELECT L.CLTCODE,          
                 BALANCE_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                     AND VTYP <> 2 THEN (CASE     
                                                                                           WHEN L.DRCR = 'D' THEN VAMT     
                                                                                           ELSE -VAMT     
                                                                                         END)              
                                                                ELSE 0     
                                                              END),0)),      
                 BALANCE_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN VTYP = 2 THEN -VAMT           
                                                                ELSE 0     
                                                              END),0)),      
                 ACTUAL_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                               WHEN VTYP <> 2 THEN (CASE     
                                                                                      WHEN L.DRCR = 'D' THEN VAMT     
                                                                                      ELSE -VAMT     
                                                                                    END)          
                                                               ELSE 0     
                                                             END),0)),      
                 ACTUAL_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE           
                                                               WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                    AND VTYP = 2 THEN -VAMT           
                                                               ELSE 0     
                                                             END),0))       
          FROM   ACCOUNTBSE.DBO.LEDGER L WITH(NOLOCK),      
                 ACCOUNTBSE.DBO.PARAMETER P WITH(NOLOCK),      
                 V2_FOUT_LEDGERBALANCES_TEMP FL WITH(NOLOCK)          
          WHERE  VDT BETWEEN SDTCUR AND @FROMDATE + ' 23:59'          
                 AND @FROMDATE BETWEEN SDTCUR AND LDTCUR          
                 AND L.CLTCODE = FL.PARTY_CODE      
          GROUP BY L.CLTCODE) A       
  WHERE  V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE          
      
/*--------------------------------------------------------------------------------------------------------------          
NSE DERIVATIVES      
UPDATE EDT LEDGER BALANCES - RECEIPT BANK ENTRIES IGNORED          
UPDATE TOTAL RECEIPT BANK ENTRIES AMOUNT AS ON VDT      
UPDATE THE ACTUAL CONSOLIDATED LEDGER BALANCE (FAACTUAL)          
RECEIPT BANK ENTRIES CONSIDERED ON EFFECTIVE DATE BASIS          
--------------------------------------------------------------------------------------------------------------*/          
  UPDATE V2_FOUT_LEDGERBALANCES_TEMP          
  SET    NSEFOBALANCE = BALANCE_1 +  BALANCE_2,          
         FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2          
  FROM   (SELECT L.CLTCODE,          
                 BALANCE_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                     AND VTYP <> 2 THEN (CASE     
                                                                                           WHEN L.DRCR = 'D' THEN VAMT     
                                                                                           ELSE -VAMT     
                                                                                         END)              
                                                                ELSE 0     
                                                              END),0)),      
                 BALANCE_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN VTYP = 2 THEN -VAMT           
                                                                ELSE 0     
                                                              END),0)),      
                 ACTUAL_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                               WHEN VTYP <> 2 THEN (CASE     
                                                                                      WHEN L.DRCR = 'D' THEN VAMT     
                                                                                      ELSE -VAMT     
                                                                                    END)          
                                                               ELSE 0     
                                                             END),0)),      
                 ACTUAL_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE           
                                                               WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                    AND VTYP = 2 THEN -VAMT           
                                                               ELSE 0     
                                                             END),0))       
          FROM   ACCOUNTFO.DBO.LEDGER L WITH(NOLOCK),      
                 ACCOUNTFO.DBO.PARAMETER P WITH(NOLOCK),      
                 V2_FOUT_LEDGERBALANCES_TEMP FL WITH(NOLOCK)          
          WHERE  VDT BETWEEN SDTCUR AND @FROMDATE + ' 23:59'          
                 AND @FROMDATE BETWEEN SDTCUR AND LDTCUR          
                 AND L.CLTCODE = FL.PARTY_CODE      
          GROUP BY L.CLTCODE) A       
  WHERE  V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE          

/*--------------------------------------------------------------------------------------------------------------          
NSX CURRNECY       
UPDATE EDT LEDGER BALANCES - RECEIPT BANK ENTRIES IGNORED          
UPDATE TOTAL RECEIPT BANK ENTRIES AMOUNT AS ON VDT      
UPDATE THE ACTUAL CONSOLIDATED LEDGER BALANCE (FAACTUAL)          
RECEIPT BANK ENTRIES CONSIDERED ON EFFECTIVE DATE BASIS          
--------------------------------------------------------------------------------------------------------------*/          
  UPDATE V2_FOUT_LEDGERBALANCES_TEMP          
  SET    NSXCURBALANCE = BALANCE_1 +  BALANCE_2,          
         FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2          
  FROM   (SELECT L.CLTCODE,          
                 BALANCE_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                     AND VTYP <> 2 THEN (CASE     
                                                                                           WHEN L.DRCR = 'D' THEN VAMT     
                                                                                           ELSE -VAMT     
                                                                                         END)              
                                                                ELSE 0     
                                                              END),0)),      
                 BALANCE_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN VTYP = 2 THEN -VAMT           
                                                                ELSE 0     
                                                              END),0)),      
                 ACTUAL_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                               WHEN VTYP <> 2 THEN (CASE     
                                                                                      WHEN L.DRCR = 'D' THEN VAMT     
                                                                                      ELSE -VAMT     
                                                                                    END)          
                                                               ELSE 0     
                                                             END),0)),      
                 ACTUAL_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE           
                                                               WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                    AND VTYP = 2 THEN -VAMT           
                                                               ELSE 0     
                                                             END),0))       
          FROM   ACCOUNTCURFO.DBO.LEDGER L WITH(NOLOCK),      
                 ACCOUNTCURFO.DBO.PARAMETER P WITH(NOLOCK),      
                 V2_FOUT_LEDGERBALANCES_TEMP FL WITH(NOLOCK)          
          WHERE  VDT BETWEEN SDTCUR AND @FROMDATE + ' 23:59'          
                 AND @FROMDATE BETWEEN SDTCUR AND LDTCUR          
                 AND L.CLTCODE = FL.PARTY_CODE      
          GROUP BY L.CLTCODE) A       
  WHERE  V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE 



/*--------------------------------------------------------------------------------------------------------------          
MCX CURRENCY       
UPDATE EDT LEDGER BALANCES - RECEIPT BANK ENTRIES IGNORED          
UPDATE TOTAL RECEIPT BANK ENTRIES AMOUNT AS ON VDT      
UPDATE THE ACTUAL CONSOLIDATED LEDGER BALANCE (FAACTUAL)          
RECEIPT BANK ENTRIES CONSIDERED ON EFFECTIVE DATE BASIS          
--------------------------------------------------------------------------------------------------------------*/          
  UPDATE V2_FOUT_LEDGERBALANCES_TEMP          
  SET    MCXCURBALANCE = BALANCE_1 +  BALANCE_2,          
         FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2          
  FROM   (SELECT L.CLTCODE,          
                 BALANCE_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                     AND VTYP <> 2 THEN (CASE     
                                                                                           WHEN L.DRCR = 'D' THEN VAMT     
                                                                                           ELSE -VAMT     
                                                                                         END)              
                                                                ELSE 0     
                                                              END),0)),      
                 BALANCE_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                                WHEN VTYP = 2 THEN -VAMT           
                                                                ELSE 0     
                                                              END),0)),      
                 ACTUAL_1 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE       
                                                               WHEN VTYP <> 2 THEN (CASE     
                                                                                      WHEN L.DRCR = 'D' THEN VAMT     
                                                                                      ELSE -VAMT     
                                                                                    END)          
                                                               ELSE 0     
                                                             END),0)),      
                 ACTUAL_2 = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE           
                                                               WHEN EDT <= @FROMDATE + ' 23:59:59'     
                                                                    AND VTYP = 2 THEN -VAMT           
                                                               ELSE 0     
                                                             END),0))       
          FROM   ACCOUNTMCDXCDS.DBO.LEDGER L WITH(NOLOCK),      
                 ACCOUNTMCDXCDS.DBO.PARAMETER P WITH(NOLOCK),      
                 V2_FOUT_LEDGERBALANCES_TEMP FL WITH(NOLOCK)          
          WHERE  VDT BETWEEN SDTCUR AND @FROMDATE + ' 23:59'          
                 AND @FROMDATE BETWEEN SDTCUR AND LDTCUR          
                 AND L.CLTCODE = FL.PARTY_CODE      
          GROUP BY L.CLTCODE) A       
  WHERE  V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE 

      
CREATE TABLE [#LED]      
(                    
    [VDT] [DATETIME] NULL ,                    
    [CLTCODE] [VARCHAR] (10) NOT NULL ,       
    [DRCR] [CHAR] (1) NULL ,                    
    [VAMT] [MONEY] NULL ,                    
    [NARRATION] [VARCHAR] (234) NULL      
) ON [PRIMARY]               
      
CREATE NONCLUSTERED INDEX [VDT] ON [#LED] ([VDT]) ON [PRIMARY]                    
      
/*--------------------------------------------------------------------------------------------------------------          
RETRIEVING NSE VDT WISE BILL AMOUNTS FOR FUTURE DATED BILLS I.E. (EFFECTIVE DATE > RUNDATE)          
--------------------------------------------------------------------------------------------------------------*/                 
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
    INSERT INTO #LED      
    SELECT      
        VDT, CLTCODE, DRCR, VAMT, NARRATION      
    FROM      
        ACCOUNT.DBO.LEDGER L WITH(NOLOCK)      
    WHERE      
        VDT <= @FROMDATE + ' 23:59:59'       
        AND EDT >= @FROMDATE + ' 23:59:59'          
        AND (VTYP = 15 OR VTYP = 21)       
      
    SELECT      
        EXC='NSE',      
        VDT,      
        L.CLTCODE,         
        AMOUNT=CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0) )       
    INTO      
        #LEDGERESTIMATE          
    FROM      
        #LED L WITH(NOLOCK),      
        MSAJAG.DBO.SETT_MST S WITH(NOLOCK)      
    WHERE                 
        L.NARRATION LIKE '%' + RTRIM(SETT_NO) + 'NSECM' + RTRIM(SETT_TYPE) + '%'        
        AND VDT >= S.START_DATE          
        AND VDT <= S.SEC_PAYIN          
    GROUP BY      
        VDT,      
        L.CLTCODE       
      
      
/*--------------------------------------------------------------------------------------------------------------          
RETRIEVING BSE VDT WISE BILL AMOUNTS FOR FUTURE DATED BILLS I.E. (EFFECTIVE DATE > RUNDATE)          
--------------------------------------------------------------------------------------------------------------*/          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
      
    TRUNCATE TABLE #LED                    
      
    INSERT INTO #LED      
    SELECT      
        VDT, CLTCODE, DRCR, VAMT, NARRATION      
    FROM      
        ACCOUNTBSE.DBO.LEDGER L WITH(NOLOCK)      
    WHERE      
        VDT <= @FROMDATE + ' 23:59:59'                   
        AND EDT >= @FROMDATE + ' 23:59:59'          
        AND (VTYP = 15 OR VTYP = 21)       
      
    INSERT INTO      
        #LEDGERESTIMATE        
    SELECT      
        EXC='BSE',      
        VDT,      
        L.CLTCODE,         
        AMOUNT=CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0) )       
    FROM      
        #LED L WITH(NOLOCK),      
        BSEDB.DBO.SETT_MST S WITH(NOLOCK)      
    WHERE      
        L.NARRATION LIKE '%' + RTRIM(SETT_NO) + 'BSECM' + RTRIM(SETT_TYPE) + '%'        
        AND VDT >= S.START_DATE          
        AND VDT <= S.SEC_PAYIN          
    GROUP BY      
        VDT,      
        L.CLTCODE        
      
/*--------------------------------------------------------------------------------------------------------------          
UPDATING NSE FUTURE DATED BILL AMOUNTS AS RETRIEVED IN THE ABOVE QUERY          
FOR THE MOST RECENT BILL AS ESTIMATED AMOUNT 1          
--------------------------------------------------------------------------------------------------------------*/          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED           
    UPDATE      
        V2_FOUT_LEDGERBALANCES_TEMP      
    SET      
        NSEESTIMATED1 = AMOUNT          
    FROM      
    (          
        SELECT      
            CLTCODE,      
            AMOUNT=ISNULL(SUM(AMOUNT),0)          
        FROM      
            #LEDGERESTIMATE L (NOLOCK)          
        WHERE      
            LEFT(VDT,11) =      
                (          
                SELECT      
                    LEFT(CONVERT(VARCHAR,MIN(VDT),109),11)        
                FROM      
                    #LEDGERESTIMATE (NOLOCK)          
                WHERE      
                    L.EXC = EXC      
                    AND EXC = 'NSE'      
                )          
        GROUP BY      
        CLTCODE      
    ) A       
    WHERE      
    V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE          
      
/*--------------------------------------------------------------------------------------------------------------          
UPDATING NSE FUTURE DATED BILL AMOUNTS AS RETRIEVED IN THE ABOVE QUERY          
FOR ALL BILLS OTHER THAN THE MOST RECENT BILL AS ESTIMATED AMOUNT 2          
--------------------------------------------------------------------------------------------------------------*/          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
    UPDATE      
        V2_FOUT_LEDGERBALANCES_TEMP          
    SET      
        NSEESTIMATED2 = AMOUNT          
    FROM      
    (          
        SELECT      
            CLTCODE,      
            AMOUNT=ISNULL(SUM(AMOUNT),0)      
        FROM      
            #LEDGERESTIMATE L  (NOLOCK)          
        WHERE      
            LEFT(VDT,11) <>       
                (          
                SELECT      
                    LEFT(CONVERT(VARCHAR,MIN(VDT),109),11)       
                FROM      
                    #LEDGERESTIMATE (NOLOCK)          
                WHERE      
                    L.EXC = EXC      
                    AND EXC = 'NSE'      
                )          
        GROUP BY      
            CLTCODE      
    ) A              
    WHERE      
        V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE          
      
/*--------------------------------------------------------------------------------------------------------------          
UPDATING BSE FUTURE DATED BILL AMOUNTS AS RETRIEVED IN THE ABOVE QUERY          
FOR THE MOST RECENT BILL AS ESTIMATED AMOUNT 1          
--------------------------------------------------------------------------------------------------------------*/          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED           
    UPDATE      
        V2_FOUT_LEDGERBALANCES_TEMP          
    SET      
        BSEESTIMATED1 = AMOUNT          
    FROM      
    (          
        SELECT      
            CLTCODE,      
            AMOUNT=ISNULL(SUM(AMOUNT),0)      
        FROM      
            #LEDGERESTIMATE L (NOLOCK)          
        WHERE      
            LEFT(VDT,11) =      
                (          
                SELECT      
                    LEFT(CONVERT(VARCHAR,MIN(VDT),109),11)       
                FROM      
                    #LEDGERESTIMATE (NOLOCK)          
                WHERE      
                    L.EXC = EXC      
                    AND EXC = 'BSE'      
                )          
        GROUP BY      
        CLTCODE      
    ) A       
    WHERE      
    V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE         
      
/*--------------------------------------------------------------------------------------------------------------          
UPDATING BSE FUTURE DATED BILL AMOUNTS AS RETRIEVED IN THE ABOVE QUERY          
FOR ALL BILLS OTHER THAN THE MOST RECENT BILL AS ESTIMATED AMOUNT 2          
--------------------------------------------------------------------------------------------------------------*/          
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED           
    UPDATE      
        V2_FOUT_LEDGERBALANCES_TEMP          
    SET      
        BSEESTIMATED2 = AMOUNT          
    FROM      
    (          
        SELECT      
            CLTCODE,      
            AMOUNT=ISNULL(SUM(AMOUNT),0)      
FROM      
            #LEDGERESTIMATE L (NOLOCK)          
        WHERE      
            LEFT(VDT,11) <>       
            (          
            SELECT                    
                LEFT(CONVERT(VARCHAR,MIN(VDT),109),11)       
            FROM      
                #LEDGERESTIMATE (NOLOCK)          
            WHERE      
                L.EXC = EXC      
                AND EXC = 'BSE'          
            )          
    GROUP BY      
        CLTCODE      
    ) A       
    WHERE      
        V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.CLTCODE          
      
/*--------------------------------------------------------------------------------------------------------------          
  COLLATERAL AND NSEFO MARGIN REQUIREMENT UPDATE     
--------------------------------------------------------------------------------------------------------------*/          
      
DECLARE @@MARGINDATE VARCHAR(11)         
      
SELECT @@MARGINDATE = LEFT(MAX(TRANS_DATE),11) FROM MSAJAG.DBO.COLLATERAL (NOLOCK)        
      
    UPDATE V2_FOUT_LEDGERBALANCES_TEMP                
    SET    NONCASH = CC.NONCASH,                
           CASH = CC.CASH                
    FROM   (SELECT PARTY_CODE,                
                   CASH = SUM(CASH),                
                   NONCASH = SUM(NONCASH)        
            FROM   MSAJAG.DBO.COLLATERAL C   WITH(INDEX(PARTYCODE),NOLOCK)                
            WHERE  LEFT(TRANS_DATE,11) = @@MARGINDATE         
            GROUP BY PARTY_CODE) CC                
    WHERE   V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=CC.PARTY_CODE                
      
    UPDATE V2_FOUT_LEDGERBALANCES_TEMP          
    SET    IMMARGIN = ISNULL(MARGIN,0),     
           VARMARGIN = ISNULL(VMARGIN,0)           
    FROM   (SELECT PARTY_CODE,      
                   MARGIN = SUM(pspanmargin),     
                   VMARGIN = SUM(MTOM)        
            FROM   NSEFO.DBO.FOMARGINNEW F  WITH(INDEX(CLTYPEPARTYDATE),NOLOCK)         
            WHERE MDATE = (SELECT TOP 1 MDATE           
                           FROM   NSEFO.DBO.FOMARGINNEW (NOLOCK)          
                           WHERE  MDATE <= @FROMDATE +' 23:59:59'      
                           ORDER BY 1 DESC)                  
            GROUP BY PARTY_CODE) A       
    WHERE  V2_FOUT_LEDGERBALANCES_TEMP.PARTY_CODE=A.PARTY_CODE          
      
/*--------------------------------------------------------------------------------------------------------------          
  BENEFICIARY ACCOUNT BALANCES UPDATE     
--------------------------------------------------------------------------------------------------------------*/          
    UPDATE V2_FOUT_LEDGERBALANCES_TEMP     
    SET    BEN_HOLDING = DEBITVALUEAFTERHAIRCUT     
    FROM   (SELECT PCODE = PARTY_CODE,    
                   DEBITVALUEAFTERHAIRCUT    
            FROM   MSAJAG..RMSALLSEGMENT    
            WHERE  SAUDA_DATE BETWEEN @@rmsdate AND @@rmsdate + ' 23:59') RMS    
    WHERE  PARTY_CODE = PCODE     
      
--------------------------------------------------------------------------------------------------------------*/          
--    select * from RMSALLSEGMENT  
      
DELETE FROM      
    V2_FOUT_LEDGERBALANCES_TEMP        
WHERE      
    NSEBALANCE           = 0        
    AND BSEBALANCE       = 0        
    AND NSEFOBALANCE     = 0        
    AND NSEESTIMATED1    = 0        
    AND NSEESTIMATED2    = 0        
    AND BSEESTIMATED1    = 0        
    AND BSEESTIMATED2    = 0        
    AND FAACTUAL         = 0        
    AND NONCASH          = 0        
    AND CASH             = 0        
    AND IMMARGIN         = 0        
    AND VARMARGIN        = 0       
    AND BEN_HOLDING      = 0     
    
/*--------------------------------------------------------------------------------------------------------------          
  FINAL INSERT     
--------------------------------------------------------------------------------------------------------------*/          
      
SELECT   @PROCESSPARAMS = PROCESSPARAMS FROM V2_PROCESS_MASTER WHERE PROCESSNAME = 'FOUT REPORT'      
      
    UPDATE V2_PROCESS_MASTER      
    SET       
        PROCESSFLAG = 'N',      
        PROCESSPARAMS = 'FOUT REPORT IS BEING CALCULATED FOR ' + @FROMDATE + ' AT ' + LEFT(CONVERT(VARCHAR,GETDATE(),109),20),      
        PROCESSBY = 'SYSTEM',      
        PROCESSDATE = GETDATE()      
    WHERE       
        PROCESSNAME = 'FOUT REPORT'      
      
      
BEGIN TRAN      
      
    TRUNCATE TABLE V2_FOUT_LEDGERBALANCES      
          
    INSERT INTO       
        V2_FOUT_LEDGERBALANCES      
    SELECT       
        *       
    FROM       
        V2_FOUT_LEDGERBALANCES_TEMP      
      
    IF @@ERROR = 0      
    BEGIN      
        COMMIT TRAN      
        SELECT @PROCESSPARAMS = 'FOUT REPORT CALCULATED FOR ' + @FROMDATE + ' AT ' + LEFT(CONVERT(VARCHAR,GETDATE(),109),20)                  
    END      
    ELSE      
    BEGIN      
        ROLLBACK TRAN      
    END      
      
    DROP TABLE #LEDGERESTIMATE          
    DROP TABLE #LED      
      
    UPDATE V2_PROCESS_MASTER      
    SET       
        PROCESSFLAG = 'Y',      
        PROCESSPARAMS = @PROCESSPARAMS,      
        PROCESSBY = 'SYSTEM',      
        PROCESSDATE = GETDATE()      
    WHERE       
        PROCESSNAME = 'FOUT REPORT'      
      
      
      
/*--------------------------------------------------------------------------------------------------------------          
END PROCESS      
--------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Calculate_Fout_Balances_vin
-- --------------------------------------------------
create Proc V2_Calculate_Fout_Balances_vin  

                

as                

                

Declare @FromDate varchar(11)                

Declare @ProcessParams varchar(100)                

                

                

select @FromDate = Left(Convert(Varchar,getdate(),109),11)                  

                

                

Truncate Table V2_Fout_LedgerBalances_Temp                

                

set Transaction Isolation Level Read Uncommitted                

Insert into V2_Fout_LedgerBalances_Temp                

select       

 Party_Code = c1.Cl_Code,                

 Party_Name = c1.Long_Name,                

 Family_Code = c1.Family,                

 Family_Name = c1.Family,                

 Branch_Code = c1.Branch_Cd,                

 Branch_Name = isnull(br.Branch,'Unspecified'),                

 Trader = c1.Trader,                

 Trader_Name = isnull(tr.Short_Name,'UnSpecified'),                

 SubBroker_Code = c1.sub_Broker,                

 SubBroker_Name = isnull(sr.Name,'Unspecified'),                

 AreaCode = isnull(c1.Area,''),                

 AreaName = isnull(ar.Description,'Unspecified'),                

 Region_Code = isnull(c1.Region,''),                

 Region_Name = isnull(c1.Region,''),                

         Res_Phone = isnull(c1.Res_Phone1,''),                

 NSEBALANCE = 0,                

 BSEBALANCE = 0,                

 NSEFOBALANCE = 0,                

 NSEESTIMATED1 = 0,                

 NSEESTIMATED2 = 0,                

 BSEESTIMATED1 = 0,                

 BSEESTIMATED2 = 0,                

 FAActual = 0,                

 NonCash = 0,                

 Cash = 0,                

 IMMargin = 0,                

 VarMargin = 0,                

 RepDate = GetDate()                

From                

 Msajag.dbo.Client_Details c1 With(NoLock)                

  Left Outer Join Msajag.dbo.Branch br With(NoLock)               

   on (c1.BRANCH_CD = br.BRANCH_CODE)                

  left Outer Join Msajag.dbo.SubBrokers Sr With(NoLock)               

   on (c1.SUB_BROKER = sr.SUB_BROKER And c1.BRANCH_CD = sr.Branch_Code)                

  left Outer Join Msajag.dbo.Branches tr With(NoLock)               

   on (c1.TRADER = tr.SHORT_NAME and c1.BRANCH_CD = tr.Branch_Cd)                

  left Outer Join (Select distinct areacode, description,Branch_Code from Msajag.dbo.Area With(NoLock))  ar               

   on (c1.AREA = ar.AREACODE and ar.Branch_Code = c1.BRANCH_CD)      /*branch condition included sinu 14 may07*/          

                

---------------------------------------------------------------------------------------                

-- party code update is complete                

---------------------------------------------------------------------------------------                

                

                

                

set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            NSEBALANCE = BALANCE_1 +  BALANCE_2,                    

            FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2                    
      From                     

            (                        

            SELECT                     

                  L.CltCode,                         

                  BALANCE_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                                EDT <= @FromDate + ' 23:59:59'                     

                                                AND Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  BALANCE_2 =      

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                         (CASE WHEN                     

                                                Vtyp = 2                     

     THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

       (CASE WHEN                     

                                                Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_2 =                     

  CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                    

                EDT <= @FromDate + ' 23:59:59'                          

                                                And Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0))                                      

            FROM                     

                  ACCOUNT.DBO.LEDGER L With(NoLock),                     

                  ACCOUNT.DBO.PARAMETER P With(NoLock),                

                  V2_Fout_LedgerBalances_Temp FL With(NoLock)                    

            WHERE                     

                  EDT Between SdtCur And @FromDate + ' 23:59'                    

                  And @FromDate BetWeen SdtCur And LdtCur                         

                  And L.CltCode = fl.Party_Code                

            Group By                     

                  L.CltCode                        

            ) A                                      

      where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.cltcode                         

--union all

--set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            NSEBALANCE = NSEBALANCE + BALANCE_1 +  BALANCE_2,                    

            FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2                    

      From                     

            (                        

            SELECT                     

                  L.CltCode,                         

                  BALANCE_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                                EDT <= @FromDate + ' 23:59:59'                     

                                                AND Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  BALANCE_2 =      

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                         (CASE WHEN                     

                                                Vtyp = 2                     

     THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

       (CASE WHEN                     

                                                Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_2 =                     

  CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                    

                EDT <= @FromDate + ' 23:59:59'                          

                                                And Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0))                                      

            FROM                     

                  ACCOUNT.DBO.LEDGER L With(NoLock),                     

                  ACCOUNT.DBO.PARAMETER P With(NoLock),                

                  V2_Fout_LedgerBalances_Temp FL With(NoLock)                    

            WHERE                     

                  EDT >= SdtCur And VDT < SdtCur

                  And L.CltCode = fl.Party_Code                

            Group By                     

                  L.CltCode                        

            ) A                                      

      where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.cltcode                         

                    

/*--------------------------------------------------------------------------------------------------------------                    

BSE Cash                     

Update EDT ledger balances - Receipt Bank Entries ignored                    

Update Total Receipt Bank Entries Amount as on VDT                     

Update the Actual Consolidated Ledger Balance (FAACTUAL)                    

      Receipt Bank Entries considered on Effective Date Basis                    

--------------------------------------------------------------------------------------------------------------*/                    

set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            BSEBALANCE = BALANCE_1 +  BALANCE_2,                    

            FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2                    

      From                     

            (                        

            SELECT                     

                  L.CltCode,                         

                  BALANCE_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                                EDT <= @FromDate + ' 23:59:59'                     

                                                AND Vtyp <> 2                     

                                   THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                    ELSE 0 END)                    

                              ,0)),                     

                  BALANCE_2 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

(SUM                    

                                    (CASE WHEN                     

                                                Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

       ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                            Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_2 =             

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                    

                                                EDT <= @FromDate + ' 23:59:59'                          

    And Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0))                                      

            FROM                     

                  ACCOUNTBSE.DBO.LEDGER L  With(NoLock),                   

                  ACCOUNTBSE.DBO.PARAMETER P  With(NoLock),                

                  V2_Fout_LedgerBalances_Temp FL  With(NoLock)               

            WHERE                     

                  EDT Between SdtCur And @FromDate + ' 23:59'                    

                  And @FromDate BetWeen SdtCur And LdtCur                         

                  And L.CltCode = fl.Party_Code                

            Group By                     

                  l.CltCode                        

            ) A                                      

      where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.cltcode                         

 

--Union All

 

set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            BSEBALANCE = BSEBALANCE + BALANCE_1 +  BALANCE_2,                    

            FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2                    

      From                     

            (                        

            SELECT                     

                  L.CltCode,                         

                  BALANCE_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                                EDT <= @FromDate + ' 23:59:59'                     

                                                AND Vtyp <> 2                     

                                   THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                    ELSE 0 END)                    

                              ,0)),                     

                  BALANCE_2 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

(SUM                    

                                    (CASE WHEN                     

                                                Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

       ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                            Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_2 =             

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                    

                                                EDT <= @FromDate + ' 23:59:59'                          

    And Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0))                                      

            FROM                     

                  ACCOUNTBSE.DBO.LEDGER L  With(NoLock),                   

                  ACCOUNTBSE.DBO.PARAMETER P  With(NoLock),                

                  V2_Fout_LedgerBalances_Temp FL  With(NoLock)               

            WHERE                     

                          EDT >= SdtCur And VDT < SdtCur

--                And @FromDate BetWeen SdtCur And LdtCur                         

                  And L.CltCode = fl.Party_Code                

            Group By                     

                  l.CltCode                        

            ) A                                      

      where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.cltcode     

 

                

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

NSE Derivatives                     

Update EDT ledger balances - Receipt Bank Entries ignored                    

Update Total Receipt Bank Entries Amount as on VDT                     

Update The Actual Consolidated Ledger Balance (FAACTUAL)                    

      Receipt Bank Entries considered on Effective Date Basis                    

--------------------------------------------------------------------------------------------------------------*/                    

set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            NSEFOBALANCE = BALANCE_1 +  BALANCE_2,                    

            FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2                    

      From                     

            (                        

            SELECT                     

                  L.CltCode,                         

                  BALANCE_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                   (SUM                    

                                    (CASE WHEN                     

                                                EDT <= @FromDate + ' 23:59:59'                     

                                                AND Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                 

                              ,0)),                     

                  BALANCE_2 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                                Vtyp = 2                     

            THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                               Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_2 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

           (CASE WHEN                    

                                                EDT <= @FromDate + ' 23:59:59'                          

                                                And Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0))                                      

            FROM                     

                  ACCOUNTFO.DBO.LEDGER L With(NoLock),                     

                  ACCOUNTFO.DBO.PARAMETER P With(NoLock),                

                  V2_Fout_LedgerBalances_Temp FL With(NoLock)               

            WHERE                     

                  EDT Between SdtCur And @FromDate + ' 23:59'                    

                  And @FromDate BetWeen SdtCur And LdtCur                         

                  And L.CltCode = fl.Party_Code                

            Group By                     

                  l.CltCode                        

            ) A                                      

      where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.cltcode           

 

--Union All 

 

set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            NSEFOBALANCE = BSEBALANCE+BALANCE_1 +  BALANCE_2,                    

            FAACTUAL = FAACTUAL + ACTUAL_1 + ACTUAL_2                    

      From                     

            (                        

            SELECT                     

                  L.CltCode,                         

                  BALANCE_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                   (SUM                    

                                    (CASE WHEN                     

                                                EDT <= @FromDate + ' 23:59:59'                     

                                                AND Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                 

                              ,0)),                     

                  BALANCE_2 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                                                Vtyp = 2                     

            THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_1 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

                                    (CASE WHEN                     

                               Vtyp <> 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0)),                     

                  ACTUAL_2 =                     

                        CONVERT(NUMERIC(18,4),ISNULL                    

                              (SUM                    

           (CASE WHEN                    

                                                EDT <= @FromDate + ' 23:59:59'                          

                                                And Vtyp = 2                     

                                          THEN (CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)                    

                                          ELSE 0 END)                    

                              ,0))                                      

            FROM                     

                  ACCOUNTFO.DBO.LEDGER L With(NoLock),                     

                  ACCOUNTFO.DBO.PARAMETER P With(NoLock),                

                  V2_Fout_LedgerBalances_Temp FL With(NoLock)               

            WHERE                     

                  EDT >= SdtCur And VDT < SdtCur

--                And @FromDate BetWeen SdtCur And LdtCur                         

                  And L.CltCode = fl.Party_Code                

            Group By                     

                  l.CltCode                        

            ) A                                      

      where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.cltcode     

 

 

 

                

              

      CREATE TABLE [#led]               

      (              

       [Vdt] [datetime] NULL ,              

       [CltCode] [varchar] (10) NOT NULL ,              

       [DrCr] [char] (1) NULL ,              

       [VAmt] [money] NULL ,              

       [Narration] [varchar] (234) NULL               

      ) ON [PRIMARY]              

              

      CREATE               

        NONCLUSTERED INDEX [vdt] ON [#led] ([Vdt])              

      ON [PRIMARY]              

                    

/*--------------------------------------------------------------------------------------------------------------                    

Retrieving NSE VDT Wise Bill Amounts for Future Dated Bills i.e. (Effective Date > RunDate)                    

--------------------------------------------------------------------------------------------------------------*/                    

              

      set transaction isolation level read uncommitted                            

              

      Insert into #led               

      Select               

            Vdt, CltCode, DrCr, VAmt, Narration               

      From               

            ACCOUNT.DBO.LEDGER L With(NoLock)               

      Where               

            Vdt <= @FromDate + ' 23:59:59'                                      

            AND Edt >= @FromDate + ' 23:59:59'                         

            And Vtyp in (15,21)                     

              

      Select                     

            Exc='NSE',                     

        Vdt,                     

            L.CltCode,                        

            Amount=CONVERT(NUMERIC(18,4),isnull(Sum(Case When DrCr = 'D' Then Vamt Else -Vamt End),0) )                                      

      Into                     

            #LedgerEstimate                         

      From                     

             #led L With(NoLock),                     

             MSAJAG.DBO.Sett_Mst S With(NoLock),                

             V2_Fout_LedgerBalances_Temp FL With(NoLock)                

      Where           

            L.narration Like '%' + RTrim(Sett_No) + 'NSECM' + RTrim(Sett_Type) + '%'                                       

            And Vdt >= S.Start_Date                         

            And Vdt <= S.Sec_PayIn                         

            and L.CltCode = fl.Party_Code                

      Group By                     

            VDT,                     

            L.CltCode                                      

                  

                    

/*--------------------------------------------------------------------------------------------------------------                    

Retrieving BSE VDT Wise Bill Amounts for Future Dated Bills i.e. (Effective Date > RunDate)                    

--------------------------------------------------------------------------------------------------------------*/                    

      set transaction isolation level read uncommitted                            

              

      Truncate Table #led              

              

      Insert into #led               

      Select               

            Vdt, CltCode, DrCr, VAmt, Narration               

      From               

            ACCOUNTBSE.DBO.LEDGER L With(NoLock)               

      Where               

            Vdt <= @FromDate + ' 23:59:59'             

            AND Edt >= @FromDate + ' 23:59:59'                         

            And Vtyp in (15,21)                     

              

      Insert Into                     

            #LedgerEstimate                                       

      Select                     

            Exc='BSE',                     

            Vdt,                     

            L.CltCode,                        

            Amount=CONVERT(NUMERIC(18,4),isnull(Sum(Case When DrCr = 'D' Then Vamt Else -Vamt End),0) )                                      

      From                     

            #led L With(NoLock),                     

            BSEDB.DBO.Sett_Mst S With(NoLock),                

     V2_Fout_LedgerBalances_Temp FL With(NoLock)                    

      Where                     

            L.narration Like '%' + RTrim(Sett_No) + 'BSECM' + RTrim(Sett_Type) + '%'                                       

            And Vdt >= S.Start_Date                         

            And Vdt <= S.Sec_PayIn                         

            and L.cltcode = fl.Party_Code                

      Group By                     

            VDT,                     

            L.CltCode                                       

                  

                  

/*--------------------------------------------------------------------------------------------------------------                    

Updating NSE Future Dated Bill Amounts as retrieved in the above query                    

for the most recent Bill as Estimated Amount 1                    

--------------------------------------------------------------------------------------------------------------*/                    

                

     set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                     

      set                     

            NSEESTIMATED1 = Amount                         

      From                     

            (                    

                  Select                     

                        CltCode,                     

                        Amount=IsNull(Sum(Amount),0)                         

                  From                     

                        #LedgerEstimate L (nolock)                    

      Where                     

                        Vdt Like                     

                        (                    

                              Select                     

                                    Left(Convert(Varchar,Min(Vdt),109),11) + '%'                         

                              From                     

                                    #LedgerEstimate (nolock)                    

                              Where                     

                                    L.Exc = Exc                     

                                    And Exc = 'NSE'                     

                        )                         

                  Group By                     

                        CltCode                     

            ) A                                      

      Where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.Cltcode                         

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

Updating NSE Future Dated Bill Amounts as retrieved in the above query                    

for all bills other than the most recent Bill as Estimated Amount 2                    

--------------------------------------------------------------------------------------------------------------*/                    

set transaction isolation level read uncommitted                       

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            NSEESTIMATED2 = Amount                         

      From                     

            (                    

                  Select                     

                        CltCode,                     

                        Amount=IsNull(Sum(Amount),0)                     

                  From                     

                        #LedgerEstimate L  (nolock)                    

                  Where                     

                        Vdt Not Like                     

                

                        (                    

                              Select                     

                                    Left(Convert(Varchar,Min(Vdt),109),11) + '%'                         

                              From                     

                                    #LedgerEstimate (nolock)                    

                              Where                     

                                    L.Exc = Exc                     

                                    And Exc = 'NSE'                     

                        )                         

                  Group By                     

                        CltCode                     

            ) A                             

      Where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.Cltcode                         

                

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

Updating BSE Future Dated Bill Amounts as retrieved in the above query            

for the most recent Bill as Estimated Amount 1                    

--------------------------------------------------------------------------------------------------------------*/                    

      set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            BSEESTIMATED1 = Amount                         

      From                     

            (                    

                  Select                     

                        CltCode,                     

                        Amount=IsNull(Sum(Amount),0)                     

                  From                     

                        #LedgerEstimate L (nolock)                    

                  Where                     

          Vdt Like                     

                        (                    

                 Select                     

                                    Left(Convert(Varchar,Min(Vdt),109),11) + '%'                         

                              From                     

                                    #LedgerEstimate (nolock)                    

                              Where                     

                      L.Exc = Exc                     

                                    And Exc = 'BSE'                     

                        )                         

                  Group By                     

                        CltCode                     

            ) A                                      

      Where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.Cltcode                        

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

Updating BSE Future Dated Bill Amounts as retrieved in the above query                    

for all bills other than the most recent Bill as Estimated Amount 2                    

--------------------------------------------------------------------------------------------------------------*/                    

                

      set transaction isolation level read uncommitted                          

      update                     

            V2_Fout_LedgerBalances_Temp                         

      set                     

            BSEESTIMATED2 = Amount                         

      From                     

            (                    

                  Select                     

                        CltCode,                     

        Amount=IsNull(Sum(Amount),0)                     

                  From                     

                        #LedgerEstimate L (nolock)                    

                  Where                     

                        Vdt Not Like                     

                        (                    

                              Select                     

                                    Left(Convert(Varchar,Min(Vdt),109),11) + '%'                         

                              From                     

                                    #LedgerEstimate (nolock)                    

                              Where                     

                                    L.Exc = Exc                     

                            And Exc = 'BSE'                    

                        )                         

                  Group By                     

                        CltCode                     

            ) A                                      

  Where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.Cltcode                         

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

                    

--------------------------------------------------------------------------------------------------------------*/                    

      set transaction isolation level read uncommitted                          

-- select * from V2_Fout_LedgerBalances_Temp where party_code = 'MUM3P001' and repdate like 'may 18 2006%'          

          

          

 Update           

  V2_Fout_LedgerBalances_Temp          

 Set           

  NonCash = CC.NonCash,          

  Cash = CC.Cash          

 From           

  (          

   Select           

    Party_Code,          

    Cash = Sum(Cash),          

    NonCash = Sum(NonCash)          

   From           

    MSAJAG.DBO.Collateral C   WITH(INDEX(PARTYCODE),nolock)          

   Where          

    Trans_Date = (Select Max(Trans_Date) From MsaJag.Dbo.Collateral (NoLock))          

   Group By          

    Party_Code          

  ) CC          

 Where          

  V2_Fout_LedgerBalances_Temp.Party_Code=CC.Party_Code          

          

          

/*          

          

      Update                     

            V2_Fout_LedgerBalances_Temp                         

      Set                     

            NonCash = sum(C.NonCash),                     

            Cash = sum(C.Cash)                                      

      From                     

            MSAJAG.DBO.Collateral C   WITH(INDEX(PARTYCODE),nolock)                     

      Where                     

            Trans_Date =                     

                  (                    

                        SELECT                     

     MAX(TRANS_DATE)                     

                        FROM                     

                              MSAJAG.DBO.COLLATERAL (nolock)                    

                  )                      

            And V2_Fout_LedgerBalances_Temp.Party_Code=C.Party_Code            

group by ca              

                    

          

select max(trans_date),sum(cash) from msajag.dbo.collateral where trans_date like 'may 18 2006%' and party_code like 'MUM3P001'                    

group by cash*/          

/*--------------------------------------------------------------------------------------------------------------                    

                    

--------------------------------------------------------------------------------------------------------------*/                    

      set transaction isolation level read uncommitted                          

      Update                     

            V2_Fout_LedgerBalances_Temp                         

      Set                     

            IMMargin = IsNull(Margin,0)                         

      From                     

            (                    

                  Select                     

                        Party_Code,                     

                        Margin = Sum(PspanMargin)                                        

                  From                     

                        NSEFO.DBO.FoMarginNew F  WITH(INDEX(CLTYPEPARTYDATE),nolock)                        

                  Where                     

                        Mdate =                     

                              (                    

                                    Select                     

                  Max(MDate)                         

                                    From                     

                                          NSEFO.DBO.FoMarginNew (nolock)                    

                                    Where                     

                                          MDate <= @FromDate +' 23:59:59'                     

                              )                                 

                  Group By                     

                  Party_Code                     

            ) A                                      

      Where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.Party_Code                         

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

                    

--------------------------------------------------------------------------------------------------------------*/                    

      set transaction isolation level read uncommitted                          

      Update                     

            V2_Fout_LedgerBalances_Temp                         

Set                     

            VarMargin = IsNull(VMargin,0)                         

      From                     

            (                    

                  Select                     

                        Party_Code,                     

                        VMargin = Sum(MtoM)                                        

                  From                     

                        NSEFO.DBO.FoMarginNew F  WITH(INDEX(CLTYPEPARTYDATE),nolock)                        

                  Where                     

                        Mdate =                     

                              (                    

                                    Select                     

                                          Max(MDate)                         

                 From                     

                                          NSEFO.DBO.FoMarginNew (Nolock)                    

                                    Where                     

                                          MDate <= @FromDate +' 23:59:59'                     

                              )                                 

              Group By                     

                        Party_Code                    

            ) A                                      

      Where                     

            V2_Fout_LedgerBalances_Temp.Party_Code=A.Party_Code                         

                    

                    

/*--------------------------------------------------------------------------------------------------------------                    

                    

--------------------------------------------------------------------------------------------------------------*/                    

set transaction isolation level read uncommitted                          

      Update                     

            V2_Fout_LedgerBalances_Temp                         

      Set                     

            NonCash = ((Case When ((IMMargin + VarMargin)*0.75)  < NonCash Then  ((IMMargin + VarMargin)*0.75) Else nonCash End)) * -1,                

     Cash = Cash * -1                

                    

                    

                    

--------------------------------------------------------------------------------------------------------------*/                    

                

                

      Delete From                     

            V2_Fout_LedgerBalances_Temp                                       

      Where                     

            NSEBALANCE   = 0                                       

            And BSEBALANCE      = 0                                       

            And NSEFOBALANCE  = 0                                       

            And NSEESTIMATED1 = 0                                       

            And NSEESTIMATED2 = 0                                       

            And BSEESTIMATED1 = 0                                       

            And BSEESTIMATED2 = 0                                       

            And FAActual           = 0                                       

            And NonCash           = 0                                       

            And Cash                = 0                                       

      And IMMargin           = 0                                       

            And VarMargin         = 0                                      

                

                

                    

/*--------------------------------------------------------------------------------------------------------------                    

                    

--------------------------------------------------------------------------------------------------------------*/                    

                

/*         

      if @reportopt='D'                      

      begin                

            set transaction isolation level read uncommitted                  

            select                     

                  FamilyCode,                    

                  CLTCODE,                    

                  ACNAME,                    

                  NSEBALANCE,                    

                  BSEBALANCE,                    

                  NSEFOBALANCE,                    

                  NSEESTIMATED1,                    

                  NSEESTIMATED2,                                   

                  BSEESTIMATED1,                    

                  BSEESTIMATED2,                    

                  FAActual,                    

                  Res_Phone1,                    

                  Cash,                    

                  NonCash,                    

      IMMargin,                    

                  VarMargin,                     

                  @@SPID as SesID                                   

            from                     

                  V2_Fout_LedgerBalances_Temp L (nolock),                    

                  MSAJAG.DBO.ClientMaster C  with(index(partycdidx),nolock)                                  

            Where                     

                  C.Party_Code = L.CltCode                     

                  and procid=@@spid                                  

            Order By                     

                  FamilyCode,                    

                  CLTCODE,                    

                  C.Long_Name,                    

                  Res_Phone1                                   

      end                                

      else                                

      begin                                

            set transaction isolation level read uncommitted                  

            select                     

                  L.REP_GROUP as FamilyCode,                     

                  L.REP_GROUP_NAME as AcName,                    

                  sum(NSEBALANCE) as TotNSEBALANCE,                        

                  sum(BSEBALANCE) as TotBSEBALANCE,                    

                  sum(NSEFOBALANCE) as TotNSEFOBALANCE,                                

                  sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) as TotTotalParty,                                

                  sum(NSEESTIMATED1) as TotNSEESTIMATED1,                    

                  sum(NSEESTIMATED2) as TotNSEESTIMATED2,                                   

                  sum(BSEESTIMATED1) as TotBSEESTIMATED1,                    

  sum(BSEESTIMATED2) as TotBSEESTIMATED2,                                

                  sum(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) as TotEstimateTotalParty,                                

                  sum(FAActual) as TotFAACTUAL,                                

                  sum(FAActual - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) as TotFANETPARTY,                                

                  sum(Cash) as TotCASH,                    

                  sum(NonCash) as TotNonCash,                     

                  sum(IMMargin) as TotIMMargin,                    

                  sum(VarMargin) as TotVarMargin,                                

                  sum(FAActual + IMMargin + VarMargin + NONCASH + CASH) as TotFinTotalParty,                     

                  @@SPID as SesID                                     

            from                     

                  V2_Fout_LedgerBalances_Temp L (nolock)                    

            Where                     

                  L.Procid=@@spid                                  

            group By                     

       L.Rep_Group,                     

                  L.Rep_Group_Name                    

    Order By                     

                  L.Rep_Group                     

      end                                   

                                  

*/                

                

                

Select   @ProcessParams = ProcessParams from V2_Process_Master where ProcessName = 'FOUT REPORT'                

                

                

                

Update V2_Process_Master                

Set ProcessFlag = 'N',                

ProcessParams = 'Fout Report is being Calculated for ' + @FromDate + ' at ' + left(convert(varchar,getdate(),109),20),                

ProcessBy = 'SYSTEM',                

ProcessDate = GetDate()                

Where ProcessName = 'FOUT REPORT'                

                

                

begin Tran                

                

      Truncate Table V2_Fout_LedgerBalances                

                

                      

      Insert Into                 

            V2_Fout_LedgerBalances                

      select                 

            *                 

      From                 

            V2_Fout_LedgerBalances_Temp                

                

                

IF @@ERROR = 0                

begin                

      Commit Tran                

      Select @ProcessParams = 'Fout Report Calculated for ' + @FromDate + ' at ' + left(convert(varchar,getdate(),109),20)            

End                

Else                

Begin                

      RollBack Tran                

End                

                

                

                

      Drop Table #LedgerEstimate                    

                

                

      Update V2_Process_Master                

      Set ProcessFlag = 'Y',                

      ProcessParams = @ProcessParams,                

      ProcessBy = 'SYSTEM',                

      ProcessDate = GetDate()                

      Where ProcessName = 'FOUT REPORT'                

                

                

                    

/*--------------------------------------------------------------------------------------------------------------                    

END Process                    

--------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CANNEDLEDGERBALANCE
-- --------------------------------------------------

CREATE PROCEDURE V2_CANNEDLEDGERBALANCE(
                @SDATE   VARCHAR(11),
                @EFFDATE VARCHAR(11))

AS

  DECLARE  @@RUNDATE DATETIME
                     
  SET @@RUNDATE = GETDATE()
                  
  TRUNCATE TABLE CANNED_LEDGERBALANCE
  
  INSERT INTO CANNED_LEDGERBALANCE
  SELECT   L.CLTCODE,
           LEDBAL = SUM(CASE 
                          WHEN DRCR = 'D' THEN -(VAMT)
                          ELSE (VAMT)
                        END),
           ENTRYTYPE = 1,
           @@RUNDATE
  FROM     LEDGER L WITH (NOLOCK),
           ACMAST A WITH (NOLOCK)
  WHERE    L.CLTCODE = A.CLTCODE
           AND A.ACCAT = 4
           AND L.VDT BETWEEN @SDATE + ' 00:00:00'
                             AND @EFFDATE + ' 23:59:59'
           AND L.EDT <= @EFFDATE + ' 23:59:59'
  GROUP BY L.CLTCODE
  HAVING   SUM(CASE 
                 WHEN DRCR = 'D' THEN -(VAMT)
                 ELSE (VAMT)
               END) <> 0
                       
  INSERT INTO CANNED_LEDGERBALANCE
  SELECT   L.CLTCODE,
           LEDBAL = SUM(CASE 
                          WHEN DRCR = 'D' THEN -(VAMT)
                          ELSE 0
                        END),
           ENTRYTYPE = 2,
           @@RUNDATE
  FROM     LEDGER L WITH (NOLOCK),
           ACMAST A WITH (NOLOCK)
  WHERE    L.CLTCODE = A.CLTCODE
           AND A.ACCAT = 4
           AND L.VDT BETWEEN @SDATE + ' 00:00:00'
                             AND @EFFDATE + ' 23:59:59'
           AND EDT > @EFFDATE + ' 23:59:59'
  GROUP BY L.CLTCODE
  HAVING   SUM(CASE 
                 WHEN DRCR = 'D' THEN -(VAMT)
                 ELSE 0
               END) <> 0 
           
  INSERT INTO CANNED_LEDGERBALANCE
  SELECT   L.CLTCODE,
           LEDBAL = SUM(CASE 
                          WHEN DRCR = 'D' THEN 0
                          ELSE -(VAMT)
                        END),
           ENTRYTYPE = 3,
           @@RUNDATE
  FROM     LEDGER L WITH (NOLOCK),
           ACMAST A WITH (NOLOCK)
  WHERE    L.CLTCODE = A.CLTCODE
           AND A.ACCAT = 4
           AND L.EDT >= @EFFDATE + ' 23:59:59'
           AND L.VDT < @SDATE
  GROUP BY L.CLTCODE
  HAVING   SUM(CASE 
                 WHEN DRCR = 'D' THEN 0
                 ELSE -(VAMT)
               END) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ComputeLedgerBalance
-- --------------------------------------------------

CREATE Procedure V2_ComputeLedgerBalance
(          
      @sdate varchar(11),            
      @fparty varchar(10),             
      @tparty varchar(10),         
      @stlno varchar(7),    
      @GenFlag varchar(1),               
      @user varchar(25),        
      @Exchange varchar(3),    
      @effdate varchar(11)          
)          
          
As              
            
/*===========================================================================    
      Exec V2_ComputeLedgerBalance
            @sdate = 'Apr  1 2005',     
            @fparty = '',     
            @Tparty = '',     
            @stlno = '2005125',    
            @GenFlag = 'S',                 
            @user = 'PM',     
            @Exchange = 'NSE',     
            @effdate = 'Mar  4 2006'
    
      Exec V2_ComputeLedgerBalance
            @sdate = 'Apr  1 2005',     
            @fparty = '',     
            @Tparty = '',     
            @stlno = '',    
            @GenFlag = 'A',                 
            @user = 'PM',     
            @Exchange = 'NSE',     
            @effdate = 'Mar  4 2006'
    
      SELECT * FROM V2_LedgerBalance     
    
      SELECT PartyCode FROM V2_LedgerBalance Group By PartyCode Having Count(*) > 1    
    
      Select * From Msajag..AccBill Where Sett_No = '2005079'    
===========================================================================*/    
    
Set Nocount On    
    
If @fparty = ''                           
Begin                           
      Set @fparty = '0000000000'         
End                          
          
If @tparty = ''                           
Begin                           
      Set @tparty = 'ZZZZZZZZZZ'          
End             
      
Set Transaction Isolation Level Read Uncommitted      
      
Declare     
      @@reccount int    
    
Set @@reccount = 0    
    
Select @@reccount = Count(1) From SettPayout Where Left(RequestDt,11) = Left(GetDate(),11) And Status = 'P'     
    
      IF @@reccount <> 0     
      BEGIN    
            SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO RECALCULATE ::'    
            Return    
      END    
    
      DELETE     
            V2_LedgerBalance     
      WHERE PartyCode BETWEEN @fparty AND @tparty     
    
/*===========================================================================    
      Create # Tables for Canned Ledger Balances And Bill Amounts    
===========================================================================*/    
      Create Table #LedgerBalance    
      (           
            PartyCode varchar(10),            
            PartyName varchar(100),             
            ChequeName varchar(100),            
            branchcode varchar(10),            
            accat varchar(10),            
            BtoBPayment Int,            
            TOTLedBal money,            
            NSELedBal money,            
            BSELedBal money,            
            FNOLedBal money,            
            Sett_No varchar(7),            
            NormalBillAmt money,            
            T2TBillAmt money,            
            BillAmt money,            
            futurepayout money,            
            shortage money,            
            Amounttobepaid money,           
            Paymode varchar(1),           
            Bankcode varchar(10),    
            GenFlag varchar(1),           
            RunDate DateTime           
      )     
          
      CREATE  INDEX [PartyCode] ON [dbo].[#LedgerBalance]([PartyCode]) ON [PRIMARY]           
          
      Create Table [#LedgerBillTmp]           
      (           
            [cltcode] [varchar] (10)  NULL ,            
            [branchcode] [varchar] (10)  NULL ,            
            [longname] [varchar] (100)  NULL ,            
            [accat] [char] (10)  NULL ,            
            [BtoBPayment] [Int] NULL ,            
            [PayMode] [char] (1)  NULL ,            
            [POBankcode] [varchar] (10)  NULL,           
            [Sett_No] [varchar] (7) NOT NULL,           
            [NormalBillAmt] [money],           
            [T2TBillAmt] [money],     
            [RunDate] [datetime]           
      ) ON [PRIMARY]          
    
    
/*===========================================================================    
      Populate Bill Amounts from AccBill table in the ShareDB for Normal And T2T Settlements    
      Delete Clients with Client Type Set As ('MTF', 'PMS', 'WEB')     
===========================================================================*/     
IF @Exchange = 'NSE' --NSE
BEGIN
      IF @GenFlag = 'S'    
      BEGIN    
            INSERT     
            INTO #LedgerBillTmp     
            SELECT     
                  A.cltcode ,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode,     
                  Sett_No = @stlno,     
                  NormalBillAmt = sum(    
                        CASE     
                              WHEN Sett_Type = 'N'     
                              THEN (    
                              CASE     
                                    WHEN Sell_Buy = '1'     
                                    THEN -Amount     
                                    ELSE Amount     
                              END    
                              )     
                              ELSE 0     
                        END    
                        ),     
                  T2TBillAmt = sum(    
                        CASE     
                              WHEN Sett_Type = 'W'     
                              THEN (    
                              CASE     
                                    WHEN Sell_Buy = '1'     
                                    THEN -Amount     
                                    ELSE Amount     
                              END    
                              )     
                              ELSE 0     
                        END    
                        ),     
                  RunDate = getdate()     
            FROM MSAJAG..AccBill l WITH(NoLock),     
                  Acmast A WITH(NoLock)     
            WHERE L.Party_Code = a.CltCode     
                  AND a.CltCode BETWEEN @fparty AND @tparty     
                  AND a.accat In (4, 104)     
                  AND l.Sett_No = @stlno     
                  AND a.POBankCode In     
                        (    
                              SELECT     
                                    CltCode     
                              FROM AcMast     
                              WITH(NoLock)     
                              WHERE Accat = 2    
                        )     
            GROUP BY A.CltCode,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode     
            HAVING sum(    
                        CASE     
                              WHEN Sell_Buy = '1'     
                              THEN -Amount     
                              ELSE Amount     
                        END    
                        ) > 0     
      END    
      ELSE    
      BEGIN    
            INSERT     
            INTO #LedgerBillTmp     
            SELECT     
                  A.cltcode ,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode,     
                  Sett_No = '',     
                  NormalBillAmt = 0,     
                  T2TBillAmt = 0,     
                  RunDate = getdate()     
            FROM Acmast A WITH(NoLock)     
            WHERE a.CltCode BETWEEN @fparty AND @tparty     
                  AND a.accat In (4, 104)                       
                  AND a.POBankCode In     
                        (    
                        SELECT     
                                    CltCode     
                              FROM AcMast     
                              WITH(NoLock)     
                              WHERE Accat = 2    
                        )     
            GROUP BY A.CltCode,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode                 
      END    
       
      CREATE  INDEX [Cltcode] ON [dbo].[#LedgerBillTmp]([cltcode]) ON [PRIMARY]           
             
      DELETE     
            #LedgerBillTmp     
      FROM MSAJAG..Client1 C1,     
            MSAJAG..Client2 C2     
      WHERE CltCode = C2.Party_Code     
            AND C1.Cl_Code = C2.Cl_Code     
            AND C1.Cl_Type In ('MTF', 'PMS', 'WEB') 

END

ELSE --BSE
BEGIN
      IF @GenFlag = 'S'    
      BEGIN    
            INSERT     
            INTO #LedgerBillTmp     
            SELECT     
                  A.cltcode ,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode,     
                  Sett_No = @stlno,     
                  NormalBillAmt = sum(    
                        CASE     
                              WHEN Sett_Type = 'D'     
                              THEN (    
                              CASE     
                                    WHEN Sell_Buy = '1'     
                                    THEN -Amount     
                                    ELSE Amount     
                              END    
                              )     
                              ELSE 0     
                        END    
                        ),     
                  T2TBillAmt = sum(    
                        CASE     
                              WHEN Sett_Type = 'C'     
                              THEN (    
                              CASE     
                                    WHEN Sell_Buy = '1'     
                                    THEN -Amount     
                                    ELSE Amount     
                              END    
                              )     
                              ELSE 0     
                        END    
                        ),     
                  RunDate = getdate()     
            FROM BSEDB..AccBill l WITH(NoLock),     
                  Acmast A WITH(NoLock)     
            WHERE L.Party_Code = a.CltCode     
                  AND a.CltCode BETWEEN @fparty AND @tparty     
                  AND a.accat In (4, 104)     
                  AND l.Sett_No = @stlno     
                  AND a.POBankCode In     
                        (    
                              SELECT     
                                    CltCode     
                              FROM AcMast     
                              WITH(NoLock)     
                              WHERE Accat = 2    
                        )     
            GROUP BY A.CltCode,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode     
            HAVING sum(    
                        CASE     
                              WHEN Sell_Buy = '1'     
                              THEN -Amount     
                              ELSE Amount     
                        END    
                        ) > 0     
      END    
      ELSE    
      BEGIN    
            INSERT     
            INTO #LedgerBillTmp     
            SELECT     
                  A.cltcode ,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode,     
                  Sett_No = '',     
                  NormalBillAmt = 0,     
                  T2TBillAmt = 0,     
                  RunDate = getdate()     
            FROM Acmast A WITH(NoLock)     
            WHERE a.CltCode BETWEEN @fparty AND @tparty     
                  AND a.accat In (4, 104)                       
                  AND a.POBankCode In     
                        (    
                        SELECT     
                                    CltCode     
                              FROM AcMast     
                              WITH(NoLock)     
                              WHERE Accat = 2    
                        )     
            GROUP BY A.CltCode,     
                  A.BranchCode,     
                  longname,     
                  accat,     
                  BtoBPayment,     
                  PayMode,     
                  POBankcode                 
      END    
       
      CREATE  INDEX [Cltcode] ON [dbo].[#LedgerBillTmp]([cltcode]) ON [PRIMARY]           
             
      DELETE     
            #LedgerBillTmp     
      FROM BSEDB..Client1 C1,     
            BSEDB..Client2 C2     
      WHERE CltCode = C2.Party_Code     
            AND C1.Cl_Code = C2.Cl_Code     
            AND C1.Cl_Type In ('MTF', 'PMS', 'WEB') 

END        
    
/*===========================================================================    
      Calculate NSE Cash Ledger Balances for Clients with Credit in the Selected Settlement     
===========================================================================*/    
      INSERT     
      INTO #LedgerBalance     
      SELECT     
            l.cltcode ,     
            acname = a.longname,     
            ChequeName = a.longname,     
            a.branchcode,     
            a.accat,     
            a.BtoBPayment ,     
            TOTLedBal = 0,     
            NSELedBal = Sum(    
                        CASE     
                              WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DrCr = 'D'     
                                    THEN -Vamt     
                                    ELSE Vamt     
                              END    
                              )    
                              ELSE 0     
                        END     
                  ) + Sum(    
                        CASE     
                              WHEN Edt > @effdate + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DrCr = 'D'     
                                    THEN -Vamt     
                                    ELSE 0     
                              END    
                              )     
                              ELSE 0     
                        END     
                  ),     
            BSELedBal = 0,     
            FNOLedBal = 0,     
            a.Sett_No,     
            a.NormalBillAmt,     
            a.T2TBillAmt,     
            BillAmt = a.NormalBillAmt + a.T2TBillAmt,     
            futurepayout = 0 ,     
            shortage = 0,     
            Amounttobepaid = 0,     
            a.paymode,     
            a.POBankCode,     
            GenFlag = @GenFlag,     
            RunDate      
      FROM #LedgerBillTmp a WITH(NoLock),     
            Account..Ledger l WITH(NoLock)     
      WHERE l.cltcode = a.cltcode     
            AND l.vdt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
      GROUP BY a.branchcode,     
            l.cltcode,     
            a.longname,     
            a.accat,     
            a.BtoBPayment,     
            a.paymode,     
            a.POBankCode,     
            a.Sett_No,     
            a.NormalBillAmt,     
            a.T2TBillAmt,     
            RunDate      
    
    
/*===========================================================================    
      Calculate BSE Cash Ledger Balances for Clients with Credit in the Selected Settlement     
===========================================================================*/    
      INSERT     
      INTO #LedgerBalance     
      SELECT     
            l.cltcode ,     
            acname = a.longname,     
            ChequeName = a.longname,     
            a.branchcode,     
            a.accat,     
            a.BtoBPayment ,     
       TOTLedBal = 0,     
            NSELedBal = 0,     
            BSELedBal = Sum(    
                        CASE     
                              WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DrCr = 'D'     
                                    THEN -Vamt     
                                    ELSE Vamt     
                              END    
                              )    
                              ELSE 0     
                        END     
                  ) + Sum(    
                        CASE     
                             WHEN Edt > @effdate + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DrCr = 'D'     
                                    THEN -Vamt     
                                    ELSE 0     
                              END    
                              )     
                              ELSE 0     
                        END     
                  ),     
            FNOLedBal = 0,     
            a.Sett_No,     
            a.NormalBillAmt,     
            a.T2TBillAmt,     
            BillAmt = a.NormalBillAmt + a.T2TBillAmt,     
            futurepayout = 0 ,     
            shortage = 0,     
            Amounttobepaid = 0,     
            a.paymode,     
            a.POBankCode,     
            GenFlag = @GenFlag,     
            RunDate      
      FROM #LedgerBillTmp a WITH(NoLock),     
            AccountBse..Ledger l WITH(NoLock)     
      WHERE l.cltcode = a.cltcode     
            AND l.vdt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
      GROUP BY a.branchcode,     
            l.cltcode,     
            a.longname,     
            a.accat,     
            a.BtoBPayment,     
            a.paymode,     
            a.POBankCode,     
            a.Sett_No,     
            a.NormalBillAmt,     
            a.T2TBillAmt,     
            RunDate      
    
    
/*===========================================================================    
      Calculate NSE Derivative Ledger Balances for Clients with Credit in the Selected Settlement     
===========================================================================*/    
      INSERT     
      INTO #LedgerBalance     
      SELECT     
            l.cltcode ,     
            acname = a.longname,     
            ChequeName = a.longname,     
            a.branchcode,     
            a.accat,     
            a.BtoBPayment ,     
            TOTLedBal = 0,     
            NSELedBal = 0,     
            BSELedBal = 0,     
            FNOLedBal = Sum(    
                        CASE     
                              WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DrCr = 'D'     
                                    THEN -Vamt     
                                    ELSE Vamt     
                              END    
                              )    
                              ELSE 0     
                        END     
                  ) + Sum(    
                        CASE     
                              WHEN Edt > @effdate + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DrCr = 'D'     
                                    THEN -Vamt     
                                    ELSE 0     
                              END    
                              )     
                              ELSE 0     
                        END     
                  ),     
            a.Sett_No,     
            a.NormalBillAmt,     
            a.T2TBillAmt,     
            BillAmt = a.NormalBillAmt + a.T2TBillAmt,     
            futurepayout = 0 ,     
            shortage = 0,     
            Amounttobepaid = 0,     
            a.paymode,     
            a.POBankCode,     
            GenFlag = @GenFlag,     
            RunDate      
      FROM #LedgerBillTmp a WITH(NoLock),     
            AccountFo..Ledger l WITH(NoLock)     
      WHERE l.cltcode = a.cltcode     
            AND l.vdt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
      GROUP BY a.branchcode,     
            l.cltcode,     
            a.longname,     
            a.accat,     
            a.BtoBPayment,     
            a.paymode,     
            a.POBankCode,     
            a.Sett_No,     
            a.NormalBillAmt,     
            a.T2TBillAmt,     
            RunDate      
      HAVING Sum(    
                  CASE     
                        WHEN Edt BETWEEN @sdate + ' 00:00:00' AND @effdate + ' 23:59:00'     
                        THEN (    
                        CASE     
                 WHEN DrCr = 'D'     
                              THEN -Vamt     
                              ELSE Vamt     
                        END    
                        )    
                        ELSE 0     
                  END     
            ) + Sum(    
                  CASE     
                        WHEN Edt > @effdate + ' 23:59:00'      
                        THEN (    
                        CASE     
                              WHEN DrCr = 'D'     
                              THEN -Vamt     
                              ELSE 0     
                        END    
                        )     
                        ELSE 0     
                  END     
            ) < 0     
    
    
/*===========================================================================    
      Insert Into Physical table From Temp Table after Grouping as Required     
===========================================================================*/    
      INSERT     
      INTO V2_LedgerBalance     
      SELECT     
            PartyCode,    
            PartyName,    
            ChequeName,    
            branchcode,    
            accat,    
            BtoBPayment,    
            TOTLedBal = Sum(NSELedBal + BSELedBal + FNOLedBal),    
            NSELedBal = Sum(NSELedBal),    
            BSELedBal = Sum(BSELedBal),    
            FNOLedBal = Sum(FNOLedBal),    
            Sett_No,    
            NormalBillAmt,    
            T2TBillAmt,    
            BillAmt,    
            futurepayout,    
            shortage,    
            Amounttobepaid,    
            Paymode,    
            Bankcode,    
            GenFlag,    
            RunDate     
      FROM #LedgerBalance     
      GROUP BY PartyCode,    
            PartyName,    
            ChequeName,    
            branchcode,    
            accat,    
            BtoBPayment,    
            Sett_No,    
            NormalBillAmt,    
            T2TBillAmt,    
            BillAmt,    
            futurepayout,    
            shortage,    
            Amounttobepaid,    
            Paymode,    
            Bankcode,    
            GenFlag,    
            RunDate     
      --HAVING    
            --Sum(NSELedBal + BSELedBal + FNOLedBal) > 0    
    
      IF @GenFlag = 'A'     
      BEGIN    
            IF @Exchange = 'NSE' --NSE
            BEGIN
                  UPDATE     
                        V2_LedgerBalance     
                        SET BillAmt = NSELedBal     
                  WHERE PartyCode BETWEEN @fparty AND @tparty     
            END

            ELSE --BSE
            BEGIN
                  UPDATE     
                        V2_LedgerBalance     
                        SET BillAmt = BSELedBal     
                  WHERE PartyCode BETWEEN @fparty AND @tparty     
            END
      END    
    
SELECT ':: UPDATION COMPLETED SUCCESSFULLY ::'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_COMPUTELEDGERBALANCE_NEW
-- --------------------------------------------------


CREATE PROCEDURE V2_COMPUTELEDGERBALANCE_NEW
(
	@SDATE VARCHAR(11),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@STLNO VARCHAR(7),
	@GENFLAG VARCHAR(1),
	@USER VARCHAR(25),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@EFFDATE VARCHAR(11),
	@COMP_FOR VARCHAR(6) = 'BRANCH' -- COMPUTATION FOR BRANCH REQUESTING / ONLINE CLIENTS PAYOUT
)

AS

	/*===========================================================================
		---------------------------------------------------------------------
		FNO CREDIT BALANCES AFTER ADJUSTING
		MARGIN REQUIREMENT & COLLATERAL
		TO BE CONSIDERED WHILE COMPUTING NET BALANCE
		---------------------------------------------------------------------

		EXEC V2_COMPUTELEDGERBALANCE_NEW
			@SDATE = 'APR  1 2005',
			@FPARTY = '',
			@TPARTY = '',
			@STLNO = '',
			@GENFLAG = 'A',
			@USER = 'PM',
			@EXCHANGE = 'NSE',
			@SEGMENT = 'CAPITAL',
			@EFFDATE = 'MAR 31 2006',
			@COMP_FOR = 'BRANCH'

		SELECT * FROM V2_LEDGERBALANCE

		SELECT PARTYCODE FROM V2_LEDGERBALANCE GROUP BY PARTYCODE HAVING COUNT(*) > 1
	===========================================================================*/

	SET NOCOUNT ON

	IF @FPARTY = '' SET @FPARTY = '0000000000'

	IF @TPARTY = '' SET @TPARTY = 'ZZZZZZZZZZ'

	DECLARE @@RECCOUNT INT

	SET @@RECCOUNT = 0

	SELECT @@RECCOUNT = COUNT(1) FROM SETTPAYOUT WHERE LEFT(REQUESTDT,11) = LEFT(GETDATE(),11) AND STATUS = 'P'

	IF @COMP_FOR = 'BRANCH'
	BEGIN
		IF @@RECCOUNT <> 0
		BEGIN
			SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO RECALCULATE ::'
			RETURN
		END
 	END

   BEGIN TRAN

	DELETE
		V2_LEDGERBALANCE
	WHERE
		PARTYCODE BETWEEN @FPARTY AND @TPARTY

	/*===========================================================================
	INSERT INTO PHYSICAL TABLE FROM TEMP TABLE AFTER GROUPING AS REQUIRED
	===========================================================================*/
	INSERT INTO
		V2_LEDGERBALANCE
	EXEC V2_GETLEDGERBALANCE_NEW
		@SDATE,
		@FPARTY,
		@TPARTY,
		@STLNO,
		@GENFLAG,
		@USER,
		@EXCHANGE,
		@SEGMENT,
		@EFFDATE,
		@COMP_FOR

	IF @GENFLAG = 'A'
	BEGIN
		IF @EXCHANGE = 'NSE' AND @SEGMENT = 'CAPITAL' --NSE
		BEGIN
			UPDATE
			V2_LEDGERBALANCE
			SET BILLAMT = NSELEDBAL
			WHERE PARTYCODE BETWEEN @FPARTY AND @TPARTY
		END

		ELSE IF @EXCHANGE = 'BSE' AND @SEGMENT = 'CAPITAL' --BSE
		BEGIN
			UPDATE
			V2_LEDGERBALANCE
			SET BILLAMT = BSELEDBAL
			WHERE PARTYCODE BETWEEN @FPARTY AND @TPARTY
		END

		ELSE IF @EXCHANGE = 'NSE' AND @SEGMENT = 'FUTURES' --NSEFO
		BEGIN
			UPDATE
			V2_LEDGERBALANCE
			SET BILLAMT = FNOLEDBAL
			WHERE PARTYCODE BETWEEN @FPARTY AND @TPARTY
		END
	END

	COMMIT TRAN

	SELECT ':: UPDATION COMPLETED SUCCESSFULLY ::'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_EQUITY_FOUT_BALANCES_UP
-- --------------------------------------------------

CREATE PROC [dbo].[V2_EQUITY_FOUT_BALANCES_UP](                       
          @UNAME VARCHAR(20) = 'PROCESS',              
          @BALDATE VARCHAR(11) = '')                       
                      
AS                       
                
  IF @BALDATE = ''              
  BEGIN              
    SELECT @BALDATE = LEFT(GETDATE(),11)              
  END                
                
  TRUNCATE TABLE NSEFO_TBL_CLIENTMARGIN               
  TRUNCATE TABLE BSEFO_TBL_CLIENTMARGIN               
  TRUNCATE TABLE NSECURFO_TBL_CLIENTMARGIN
              
  INSERT INTO NSEFO_TBL_CLIENTMARGIN               
  EXEC NSEFO.DBO.CLIENTMARGIN_GET @BALDATE              
              
  INSERT INTO BSEFO_TBL_CLIENTMARGIN               
  EXEC BSEFO.DBO.CLIENTMARGIN_GET @BALDATE              

  INSERT INTO NSECURFO_TBL_CLIENTMARGIN               
  EXEC NSECURFO.DBO.CLIENTMARGIN_GET @BALDATE              
                  
  TRUNCATE TABLE V2_EQUITY_FOUT_BALANCES                       
                        
  INSERT INTO V2_EQUITY_FOUT_BALANCES                      
  SELECT PARTY_CODE,                      
         BILLAMOUNT,                      
         LEDGERAMOUNT,                      
         CASH_COLL,                      
         NONCASH_COLL,                      
         INITIALMARGIN,                      
         MTMMARGIN,                      
         ADDMARGIN,                       
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0, 
		 0,0,0,0,0,0,0,                     
         0,0,0,0,0,0,0,                      
         0,0,                       
         @UNAME,                       
         GETDATE()                       
  FROM   NSEFO_TBL_CLIENTMARGIN                      
                        
  UPDATE V2_EQUITY_FOUT_BALANCES                       
  SET    BF_BILLAMOUNT = BILLAMOUNT,                      
         BF_LEDGERAMOUNT = LEDGERAMOUNT,                      
         BF_CASH_COLL = CASH_COLL,                      
         BF_NONCASH_COLL = NONCASH_COLL,                      
         BF_INITIALMARGIN = INITIALMARGIN,                      
         BF_MTMMARGIN = MTMMARGIN,                      
         BF_ADDMARGIN = ADDMARGIN,                       
         CREATEDATE = GETDATE()                       
  FROM   BSEFO_TBL_CLIENTMARGIN N                       
  WHERE  V2_EQUITY_FOUT_BALANCES.PARTY_CODE = N.PARTY_CODE                       
                        
  INSERT INTO V2_EQUITY_FOUT_BALANCES                      
  SELECT PARTY_CODE,                      
         0,0,0,0,0,0,0,                      
         BILLAMOUNT,                      
         LEDGERAMOUNT,                      
         CASH_COLL,                      
         NONCASH_COLL,                      
         INITIALMARGIN,                      
         MTMMARGIN,                      
         ADDMARGIN,                       
		 0,0,0,0,0,0,0, 
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,0,                       
         @UNAME,                       
         GETDATE()                       
  FROM   BSEFO_TBL_CLIENTMARGIN N                      
  WHERE  NOT EXISTS (SELECT PARTY_CODE                       
                     FROM   V2_EQUITY_FOUT_BALANCES F                       
                     WHERE  N.PARTY_CODE = F.PARTY_CODE)                      

UPDATE V2_EQUITY_FOUT_BALANCES                       
  SET    NX_BILLAMOUNT = BILLAMOUNT,                      
         NX_LEDGERAMOUNT = LEDGERAMOUNT,                      
         NX_CASH_COLL = CASH_COLL,                      
         NX_NONCASH_COLL = NONCASH_COLL,                      
         NX_INITIALMARGIN = INITIALMARGIN,                      
         NX_MTMMARGIN = MTMMARGIN,                      
         NX_ADDMARGIN = ADDMARGIN,                       
         CREATEDATE = GETDATE()                       
  FROM   BSEFO_TBL_CLIENTMARGIN N                       
  WHERE  V2_EQUITY_FOUT_BALANCES.PARTY_CODE = N.PARTY_CODE                       
                        
  INSERT INTO V2_EQUITY_FOUT_BALANCES                      
  SELECT PARTY_CODE,                      
         0,0,0,0,0,0,0,
		 0,0,0,0,0,0,0,                       
         BILLAMOUNT,                      
         LEDGERAMOUNT,                      
         CASH_COLL,                      
         NONCASH_COLL,                      
         INITIALMARGIN,                      
         MTMMARGIN,                      
         ADDMARGIN,                       
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,0,                       
         @UNAME,                       
         GETDATE()                       
  FROM   BSEFO_TBL_CLIENTMARGIN N                      
  WHERE  NOT EXISTS (SELECT PARTY_CODE                       
                     FROM   V2_EQUITY_FOUT_BALANCES F                       
                     WHERE  N.PARTY_CODE = F.PARTY_CODE)   
                        
  CREATE TABLE [#C_BALANCES] (                      
    [PARTY_CODE]    [VARCHAR](10)   NULL,                      
    [LEDGERAMOUNT]  [MONEY]   NULL,                      
    [CHARGESAMOUNT] [MONEY]   NULL)                      
  ON [PRIMARY]                      
                        
----------------------------------------------------------------------                
--NSECM BALANCES                
----------------------------------------------------------------------                
  INSERT INTO #C_BALANCES                      
  SELECT   CLTCODE,                      
           SUM(LEDGERAMOUNT),                      
           SUM(CHARGESAMOUNT)                      
  FROM     (SELECT   L.CLTCODE,                      
                     LEDGERAMOUNT = SUM(CASE        
                                          WHEN DRCR = 'C' THEN VAMT                      
                                          ELSE -VAMT                      
                                  END),                      
                     CHARGESAMOUNT = 0                      
            FROM     ACCOUNT.DBO.LEDGER L,                      
                  ACCOUNT.DBO.ACMAST A,                      
                     ACCOUNT.DBO.PARAMETER P                      
            WHERE    L.CLTCODE = A.CLTCODE                      
   AND A.ACCAT = 4                      
                     AND @BALDATE BETWEEN SDTCUR AND LDTCUR                      
                     AND VDT >= SDTCUR                      
                     AND VDT <= @BALDATE + ' 23:59:00'                      
            GROUP BY L.CLTCODE                    
            UNION ALL                      
            SELECT   CLTCODE = PARTY_CODE,                      
          LEDGERAMOUNT = 0,                      
                     CHARGESAMOUNT = SUM(CASE                       
                                           WHEN DRCR = 'C' THEN AMOUNT                      
  ELSE -AMOUNT                      
                                         END)                      
            FROM     ACCOUNT.DBO.MARGINLEDGER L,                      
                     ACCOUNT.DBO.ACMAST A,                      
                     ACCOUNT.DBO.PARAMETER P                      
            WHERE    L.PARTY_CODE = A.CLTCODE                      
                     AND A.ACCAT = 4                      
                     AND @BALDATE BETWEEN SDTCUR AND LDTCUR                      
                     AND VDT >= SDTCUR                      
                     AND VDT <= @BALDATE + ' 23:59:00'                    
            GROUP BY PARTY_CODE) A                      
  GROUP BY CLTCODE                      
                    
  UPDATE V2_EQUITY_FOUT_BALANCES                       
  SET    NC_LEDGERAMOUNT = LEDGERAMOUNT,                      
         NC_CASH_COLL = CHARGESAMOUNT,                       
         CREATEDATE = GETDATE()                       
  FROM   #C_BALANCES N                       
  WHERE  V2_EQUITY_FOUT_BALANCES.PARTY_CODE = N.PARTY_CODE                       
                        
  INSERT INTO V2_EQUITY_FOUT_BALANCES                      
  SELECT PARTY_CODE,                      
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,                
         LEDGERAMOUNT,                      
         CHARGESAMOUNT,                       
         0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,0,                
         @UNAME,                       
         GETDATE()                       
  FROM   #C_BALANCES N                      
  WHERE  NOT EXISTS (SELECT PARTY_CODE                       
                     FROM   V2_EQUITY_FOUT_BALANCES F                       
                     WHERE  N.PARTY_CODE = F.PARTY_CODE)                       
                
  TRUNCATE TABLE  #C_BALANCES                
                
----------------------------------------------------------------------                
--BSECM BALANCES                
----------------------------------------------------------------------                
  INSERT INTO #C_BALANCES                      
  SELECT   CLTCODE,                      
           SUM(LEDGERAMOUNT),                      
           SUM(CHARGESAMOUNT)                      
  FROM     (SELECT   L.CLTCODE,                      
                     LEDGERAMOUNT = SUM(CASE                       
                                          WHEN DRCR = 'C' THEN VAMT                      
                                          ELSE -VAMT                      
                                        END),                      
                     CHARGESAMOUNT = 0                      
            FROM     ACCOUNTBSE.DBO.LEDGER L,                    
                     ACCOUNTBSE.DBO.ACMAST A,                      
                     ACCOUNTBSE.DBO.PARAMETER P                      
            WHERE    L.CLTCODE = A.CLTCODE                      
                     AND A.ACCAT = 4                      
                     AND @BALDATE BETWEEN SDTCUR AND LDTCUR                      
                     AND VDT >= SDTCUR                      
                     AND VDT <= LEFT(@BALDATE,11) + ' 23:59:00'                      
            GROUP BY L.CLTCODE                    
            UNION ALL                      
            SELECT   CLTCODE = PARTY_CODE,                                       LEDGERAMOUNT = 0,                      
                     CHARGESAMOUNT = SUM(CASE                       
                                           WHEN DRCR = 'C' THEN AMOUNT                      
                                           ELSE -AMOUNT                      
                                         END)              
            FROM     ACCOUNTBSE.DBO.MARGINLEDGER L,                      
                     ACCOUNTBSE.DBO.ACMAST A,                      
                     ACCOUNTBSE.DBO.PARAMETER P                      
            WHERE    L.PARTY_CODE = A.CLTCODE                      
                     AND A.ACCAT = 4                      
                     AND @BALDATE BETWEEN SDTCUR AND LDTCUR                      
                     AND VDT >= SDTCUR                      
                     AND VDT <= @BALDATE + ' 23:59:00'                    
            GROUP BY PARTY_CODE) A                      
  GROUP BY CLTCODE                      
                    
  UPDATE V2_EQUITY_FOUT_BALANCES                       
  SET    BC_LEDGERAMOUNT = LEDGERAMOUNT,                
         BC_CASH_COLL = CHARGESAMOUNT,                       
         CREATEDATE = GETDATE()                       
  FROM   #C_BALANCES N                       
  WHERE  V2_EQUITY_FOUT_BALANCES.PARTY_CODE = N.PARTY_CODE                       
                        
  INSERT INTO V2_EQUITY_FOUT_BALANCES                      
  SELECT PARTY_CODE,                      
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,                
         0,0,                
         0,0,0,0,                      
         0,                
         LEDGERAMOUNT,                      
         CHARGESAMOUNT,                       
         0,0,0,0,                      
         0,0,                
         @UNAME,                       
         GETDATE()                       
  FROM   #C_BALANCES N                      
  WHERE  NOT EXISTS (SELECT PARTY_CODE                       
            FROM   V2_EQUITY_FOUT_BALANCES F                       
                     WHERE  N.PARTY_CODE = F.PARTY_CODE)                       
                
  TRUNCATE TABLE  #C_BALANCES                
                
----------------------------------------------------------------------                
--COMMON POOL BALANCES                
----------------------------------------------------------------------                
  INSERT INTO #C_BALANCES                      
  SELECT   CLTCODE,                      
           SUM(LEDGERAMOUNT),                      
           SUM(CHARGESAMOUNT)                      
  FROM     (SELECT   L.CLTCODE,                      
                     LEDGERAMOUNT = SUM(CASE                       
                                          WHEN DRCR = 'C' THEN VAMT                      
                                          ELSE -VAMT                      
                                        END),                      
                     CHARGESAMOUNT = 0                      
            FROM     ACCCOMMON.DBO.LEDGER L,                      
                     ACCCOMMON.DBO.ACMAST A,                      
                     ACCCOMMON.DBO.PARAMETER P                      
            WHERE    L.CLTCODE = A.CLTCODE       
                     AND A.ACCAT = 4                      
                     AND @BALDATE BETWEEN SDTCUR AND LDTCUR                      
                     AND VDT >= SDTCUR                      
                     AND VDT <= @BALDATE + ' 23:59:00'                      
            GROUP BY L.CLTCODE                    
            UNION ALL                      
            SELECT   CLTCODE = PARTY_CODE,                      
                     LEDGERAMOUNT = 0,                      
                     CHARGESAMOUNT = SUM(CASE                       
                                           WHEN DRCR = 'C' THEN AMOUNT                      
                                           ELSE -AMOUNT                      
                                         END)                      
            FROM     ACCCOMMON.DBO.MARGINLEDGER L,                      
                     ACCCOMMON.DBO.ACMAST A,                      
      ACCCOMMON.DBO.PARAMETER P                      
            WHERE    L.PARTY_CODE = A.CLTCODE                      
                     AND A.ACCAT = 4                      
                     AND @BALDATE BETWEEN SDTCUR AND LDTCUR                      
                     AND VDT >= SDTCUR                      
                     AND VDT <= @BALDATE + ' 23:59:00'                    
            GROUP BY PARTY_CODE) A                      
  GROUP BY CLTCODE                      
                    
  UPDATE V2_EQUITY_FOUT_BALANCES                       
  SET    C_LEDGERAMOUNT = LEDGERAMOUNT,                      
         C_CHARGESAMOUNT = CHARGESAMOUNT,                       
         CREATEDATE = GETDATE()                       
  FROM   #C_BALANCES N                       
  WHERE  V2_EQUITY_FOUT_BALANCES.PARTY_CODE = N.PARTY_CODE                       
                        
  INSERT INTO V2_EQUITY_FOUT_BALANCES                      
  SELECT PARTY_CODE,                      
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         0,0,0,0,0,0,0,                      
         C_LEDGERAMOUNT = LEDGERAMOUNT,                      
         C_CHARGESAMOUNT = CHARGESAMOUNT,                       
         @UNAME,                       
         GETDATE()                       
  FROM   #C_BALANCES N                      
  WHERE  NOT EXISTS (SELECT PARTY_CODE                       
                     FROM   V2_EQUITY_FOUT_BALANCES F                       
                     WHERE  N.PARTY_CODE = F.PARTY_CODE)                       
                    
  DROP TABLE #C_BALANCES                       
    
 --EXEC ACCCOMMODITY.DBO.V2_AGEING_CAL @@MDATE               
--EXEC ACCCOMMON.DBO.V2_AGEING_CAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Fout_Report
-- --------------------------------------------------

CREATE   PROC V2_FOUT_REPORT(                    
         @FROMCODE   VARCHAR(20),                    
         @TOCODE     VARCHAR(20),                    
         @OPT        VARCHAR(10),                    
         @STATUSID   VARCHAR(10),                    
         @STATUSNAME VARCHAR(25),                    
         @SESSIONID  VARCHAR(30),                  
         @REPORTOPT  VARCHAR(1))                    
                    
AS                    
              
  SET NOCOUNT ON    
    
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
    
  INSERT INTO V2_PROCESS_LOGS              
  VALUES ('FOUT_REPORT',               
          'EXEC V2_FOUT_REPORT @FROMCODE='+@FROMCODE+', @TOCODE='+@TOCODE+' ,@OPT='+@OPT+' , @STATUSID='+@STATUSID+' ,@STATUSNAME='+@STATUSNAME+' ,@SESSIONID='+@SESSIONID+' ,@REPORTOPT='+@REPORTOPT,              
          LEFT(@STATUSID+'-'+@STATUSNAME,50),              
          GETDATE())              
              
  IF ISNULL(@FROMCODE,'') = ''                             
    BEGIN                            
      SELECT @FROMCODE ='0000000000'                            
    END                            
                        
  IF ISNULL(@TOCODE,'') = ''                             
    BEGIN                            
      SELECT @TOCODE ='ZZZZZZZZZZ'                            
    END                            
                    
                    
  IF @REPORTOPT='D'                          
    BEGIN                    
      SELECT GROUPNAME,                  
             PARTY_CODE,                        
             PARTY_NAME,                        
             NSEBALANCE,                        
             BSEBALANCE,                        
             NSEFOBALANCE,                        
             NSEESTIMATED1,                        
             NSEESTIMATED2,                                       
             BSEESTIMATED1,                        
             BSEESTIMATED2,                        
             FAACTUAL,                        
             CASH=-CASH,                        
             NONCASH=-NONCASH,                        
             IMMARGIN,                        
             VARMARGIN,                  
             RES_PHONE,                  
             SESID,            
             TOTALPARTY=NSEBALANCE+BSEBALANCE+NSEFOBALANCE,            
             ESTIMATETOTALPARTY = NSEBALANCE+BSEBALANCE+NSEFOBALANCE+NSEESTIMATED1+BSEESTIMATED1+NSEESTIMATED2+BSEESTIMATED2,            
             FANETPARTY = FAACTUAL - (NSEBALANCE+BSEBALANCE+NSEFOBALANCE+NSEESTIMATED1+BSEESTIMATED1+NSEESTIMATED2+BSEESTIMATED2),            
             FINTOTALPARTY = FAACTUAL + IMMARGIN + VARMARGIN + NONCASH - CASH,     
             BEN_HOLDING=-BEN_HOLDING             
      FROM   (SELECT GROUPNAME = (CASE                    
                                    WHEN @OPT = 'BROKER' THEN BRANCH_CODE                    
                                    WHEN @OPT = 'SUBBROKER' THEN SUBBROKER_CODE                                                 
                                    WHEN @OPT = 'TRADER' THEN TRADER                    
                                    WHEN @OPT = 'FAMILY' THEN FAMILY_CODE                    
                                    WHEN @OPT = 'CLIENT' THEN PARTY_CODE                    
                                    WHEN @OPT = 'AREA' THEN AREA_CODE                    
                                    WHEN @OPT = 'REGION' THEN REGION_CODE                    
                                    ELSE BRANCH_CODE                    
                                  END),                    
                     PARTY_CODE,                        
                     PARTY_NAME,                   
                     NSEBALANCE,                        
                     BSEBALANCE,                        
                     NSEFOBALANCE,                        
                     NSEESTIMATED1,                        
             	NSEESTIMATED2,                                    
                     BSEESTIMATED1,                        
                     BSEESTIMATED2,                        
                     FAACTUAL,                        
                     CASH,                        
                     NONCASH,                        
                     IMMARGIN,                        
                     VARMARGIN,                  
                     RES_PHONE,    
                     BEN_HOLDING,                   
                     SESID = @SESSIONID                         
              FROM   V2_FOUT_LEDGERBALANCES WITH(INDEX(FOUTIDX),NOLOCK)                    
              WHERE  @STATUSNAME = (CASE                     
                                      WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
                                      WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE                    
                                      WHEN @STATUSID = 'TRADER' THEN TRADER                    
                                      WHEN @STATUSID = 'SUBBROKER' THEN SUBBROKER_CODE                    
                                      WHEN @STATUSID = 'AREA' THEN AREA_CODE                    
                                      WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                    
                                      WHEN @STATUSID = 'REGION' THEN REGION_CODE                    
                                      ELSE ''                                
                                    END)) DTL                  
      WHERE GROUPNAME >= @FROMCODE     
            AND GROUPNAME <= @TOCODE + 'ZZZZ'          
      ORDER BY 1, 2, 3                    
    END                          
    
  IF @REPORTOPT<>'D'                          
    BEGIN                                    
      SELECT GROUPNAME,                         
             PARTY_NAME,                        
             SUM(NSEBALANCE) AS NSEBALANCE,                            
             SUM(BSEBALANCE) AS BSEBALANCE,                        
             SUM(NSEFOBALANCE) AS NSEFOBALANCE,                                    
             SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTALPARTY,                                    
             SUM(NSEESTIMATED1) AS NSEESTIMATED1,                        
             SUM(NSEESTIMATED2) AS NSEESTIMATED2,                                       
             SUM(BSEESTIMATED1) AS BSEESTIMATED1,                        
             SUM(BSEESTIMATED2) AS BSEESTIMATED2,                                    
             SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS ESTIMATETOTALPARTY,                                    
             SUM(FAACTUAL) AS FAACTUAL,                                    
             SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS FANETPARTY,                                    
             SUM(CASH) AS CASH,                        
             SUM(NONCASH) AS NONCASH,                         
             SUM(IMMARGIN) AS IMMARGIN,                        
             SUM(VARMARGIN) AS VARMARGIN,                                    
             SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS FINTOTALPARTY,                  
             SUM(BEN_HOLDING) AS BEN_HOLDING,                   
             SESID,              
             RES_PHONE=''                      
      FROM   (SELECT GROUPNAME = (CASE                    
                                    WHEN @OPT = 'BROKER' THEN BRANCH_CODE                    
                                    WHEN @OPT = 'SUBBROKER' THEN SUBBROKER_CODE                                                 
                                    WHEN @OPT = 'TRADER' THEN TRADER                    
                                    WHEN @OPT = 'FAMILY' THEN FAMILY_CODE                    
                         WHEN @OPT = 'CLIENT' THEN PARTY_CODE                    
                                    WHEN @OPT = 'AREA' THEN AREA_CODE                    
                                    WHEN @OPT = 'REGION' THEN REGION_CODE                    
        ELSE BRANCH_CODE                    
                                  END),                    
                     PARTY_CODE,                        
                     PARTY_NAME = (CASE                    
                                     WHEN @OPT = 'BROKER' THEN BRANCH_NAME                    
                                     WHEN @OPT = 'SUBBROKER' THEN SUBBROKER_NAME                                            
                                     WHEN @OPT = 'TRADER' THEN TRADER_NAME                    
                                     WHEN @OPT = 'FAMILY' THEN FAMILY_NAME                    
                                     WHEN @OPT = 'CLIENT' THEN PARTY_NAME                    
                                     WHEN @OPT = 'AREA' THEN AREA_NAME                    
                                     WHEN @OPT = 'REGION' THEN REGION_NAME                    
                                     ELSE BRANCH_NAME                    
                                   END),    
                     NSEBALANCE,                        
                     BSEBALANCE,                        
                     NSEFOBALANCE,                        
                     NSEESTIMATED1,                        
                     NSEESTIMATED2,                                       
                     BSEESTIMATED1,                        
                     BSEESTIMATED2,                        
                     FAACTUAL,                        
                     CASH=-CASH,                        
                     NONCASH=-NONCASH,                        
                     IMMARGIN,                        
                     VARMARGIN,                  
                     RES_PHONE,    
                     BEN_HOLDING=-BEN_HOLDING,                   
                     SESID = @SESSIONID                                
              FROM   V2_FOUT_LEDGERBALANCES WITH(INDEX(FOUTIDX),NOLOCK)                    
              WHERE  @STATUSNAME = (CASE                     
                                      WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
                                      WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE                    
                                      WHEN @STATUSID = 'TRADER' THEN TRADER                    
                                      WHEN @STATUSID = 'SUBBROKER' THEN SUBBROKER_CODE                    
                                      WHEN @STATUSID = 'AREA' THEN AREA_CODE                    
                                      WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                    
                                      WHEN @STATUSID = 'REGION' THEN REGION_CODE                    
                                      ELSE ''                                
                                    END)) DTLRPT                  
      WHERE  GROUPNAME >= @FROMCODE                  
             AND GROUPNAME <= @TOCODE + 'ZZZZ'                 
      GROUP BY GROUPNAME, PARTY_NAME, SESID                  
      ORDER BY GROUPNAME, PARTY_NAME                  
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FT_COMBINED_RMS
-- --------------------------------------------------
CREATE PROC [dbo].[V2_FT_COMBINED_RMS]    
 @START_DATE VARCHAR(11),              
 @END_DATE VARCHAR(11),              
 @VDT VARCHAR(11),              
 @CLIENT_FR VARCHAR(15),              
 @CLIENT_TO VARCHAR(15),              
 @BRANCH_CODE VARCHAR(15),              
 @DATE_TYPE CHAR(3),              
 @SR_NO VARCHAR(100),              
 @UNAME VARCHAR(100),              
 @COMPUTE_FLG BIT,              
 @MIN_AMOUNT MONEY = 0,              
 @COMP_FLAG CHAR(3) = 'FDT'              
              
AS              
/*BEGIN TRAN       
EXEC V2_FT_COMBINED_RMS 'APR  1 2008', 'MAR 31 2009', 'OCT 15 2008', '001A000001', '001A000001', '%', 'VDT', '1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30', 'NIKHIL', 0, 0      
SELECT * FROM V2_FT_COMPUTEBALANCES WHERE CLTCODE = '001A000001' ORDER BY ENTRY_TYPE      
SELECT * FROM V2_FT_PRIORITY WHERE SR_NO = 30      
SELECT * FROM V2_FT_COMPUTEBALANCES WHERE LEDGER_TYPE = 'BSE'      
SELECT * FROM LEDGER WHERE VNO = '200810170011' AND VTYP = 88      
SELECT * FROM MARGINLEDGER WHERE VNO = '200810170011' AND VTYP = 88      
SELECT * FROM V2_FT_PRIORITY WHERE SR_NO = 14    
ROLLBACK*/              
              
              
DECLARE              
 @SDTCUR VARCHAR(11),              
 @LDTCUR VARCHAR(11)              
              
SELECT              
 @SDTCUR = LEFT(CONVERT(VARCHAR,SDTCUR,109),11),              
 @LDTCUR = LEFT(CONVERT(VARCHAR,LDTCUR,109),11)              
FROM              
 ACCOUNT.DBO.PARAMETER              
WHERE              
 @VDT BETWEEN SDTCUR AND LDTCUR              
              
              
              
DECLARE              
 @@COMPUTE_CUR AS CURSOR,              
 @@FT_CUR AS CURSOR,              
 @@EXCH_FR VARCHAR(15),              
 @@DB_FR VARCHAR(15),              
 @@EXCH_TO VARCHAR(15),              
 @@EXCH_DEFAULT VARCHAR(15),              
 @@DB_TO VARCHAR(15),              
 @@SR_NO SMALLINT,              
 @@TRF_TYPE TINYINT,              
 @@VNO_FR VARCHAR(12),              
 @@VNO_TO VARCHAR(12),              
 @@VNO_COMMON VARCHAR(12),              
 @@VNO_COUNT INT,              
 @@SQL VARCHAR(8000),              
 @@ML_CODE_FR VARCHAR(15),              
 @@ML_NAME_FR VARCHAR(50),              
 @@ML_CODE_TO VARCHAR(15),              
 @@ML_NAME_TO VARCHAR(50),              
 @@JV_CODE_FR VARCHAR(10),              
 @@JV_NAME_FR VARCHAR(100),              
 @@JV_CODE_TO VARCHAR(10),              
 @@JV_NAME_TO VARCHAR(100)              
              
              
TRUNCATE TABLE V2_FT_COMPUTEBALANCES              
              
              
              
INSERT INTO               
 V2_FT_COMPUTEBALANCES               
SELECT               
 A.CLTCODE,               
 A.ACNAME,               
 LEDGER_TYPE = CASE WHEN EXCHANGE = 'NSE' THEN CASE WHEN SEGMENT = 'CAPITAL' THEN 'NSE' ELSE 'NFO' END ELSE 'BSE' END,               
 VTYPE = 0,               
 FINAL_LEDGER_AMOUNT = SUM(VDTLEDBAL),              
 FINAL_MARGIN_AMOUNT = 0,              
 LEDGER_AMOUNT = SUM(VDTLEDBAL) + SUM(OPENDEBITBILL),              
 MARGIN_AMOUNT = 0,              
 MARGIN_AVAILABLE = SUM(NONCASHCOLL),              
 MARGIN_USAGE_AMOUNT = SUM(BUYOPENPOS) - SUM(OPENDEBITBILL),              
 MARGIN_REQ = CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' THEN -SUM(FOMARGIN) ELSE SUM(BUYOPENPOS + NDBUYPOS + UN_BUYOPENPOS) END,             
 ENTRY_TYPE = 0,               
 SOURCE_VO = '',              
 TARGET_VNO = '',              
 LNO = 0,              
 NARRATION = '',  
 BTOBPAYMENT = CASE WHEN BTOBPAYMENT <> 1 THEN 0 ELSE 1 END              
FROM               
 (SELECT * FROM MSAJAG.DBO.TBL_RMS_DATA WHERE RMS_DATE LIKE @VDT + '%') R,               
 ACMAST A              
WHERE               
 R.PARTY_CODE = A.CLTCODE              
 AND A.BRANCHCODE LIKE @BRANCH_CODE  
GROUP BY               
 A.CLTCODE,              
 A.ACNAME,              
 EXCHANGE,              
 SEGMENT,  
 BTOBPAYMENT        

UPDATE V2 
	SET MARGIN_REQ = MARGIN_REQ - AMOUNT
FROM
	V2_FT_COMPUTEBALANCES V2, 
	(SELECT EXCHANGE,PARTY_CODE,AMOUNT=SUM(AMOUNT) FROM  (SELECT EXCHANGE = (CASE WHEN D.BRANCH_CD = 'BSE' THEN 'BSE' ELSE 'NSE' END), D.PARTY_CODE, 
AMOUNT = SUM(CASE WHEN HOLDFLAG <> 'NDPOS' THEN FUTQTY*CL_RATE ELSE 0 END) + SUM(CASE WHEN HOLDFLAG = 'NDPOS' THEN FUTQTY*CL_RATE ELSE 0 END)
+ (CASE WHEN SUM(SHRTQTY) >= SUM(DEBITQTY) 
					THEN (SUM(SHRTQTY*CL_RATE) - SUM(DEBITQTY*CL_RATE))*(CASE WHEN CASHMARGINMARKUP > 0 
													 THEN (CASE WHEN (VARMARGIN * CASHMARGINMARKUP) > 100 
													 THEN 100
													 ELSE (VARMARGIN * CASHMARGINMARKUP)
												 END)
										   ELSE VARMARGIN
									  END)/100
				    ELSE 0
			   END)
+ SUM(SHRTQTY*CL_RATE) +SUM(CASE WHEN HOLDFLAG='PNL' THEN CL_RATE ELSE 0 END)
FROM MSAJAG.DBO.DELDEBITSUMMARYNEW D, MSAJAG.DBO.CLIENTTYPE C, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE RUNDATE BETWEEN @VDT AND @VDT + ' 23:59:59' 
AND C1.PARTY_CODE = D.PARTY_CODE AND C.CL_TYPE = C1.CL_TYPE 
GROUP BY (CASE WHEN D.BRANCH_CD = 'BSE' THEN 'BSE' ELSE 'NSE' END), D.PARTY_CODE, VARMARGIN, CL_RATE, CASHMARGINMARKUP ) D
GROUP BY EXCHANGE,PARTY_CODE ) B

WHERE
	V2.CLTCODE = PARTY_CODE
	AND LEDGER_TYPE = EXCHANGE      
    

UPDATE V2 SET FINAL_MARGIN_AMOUNT = AMOUNT,  MARGIN_AMOUNT = AMOUNT FROM 
V2_FT_COMPUTEBALANCES V2, 
(SELECT 
	PARTY_CODE, EXCHANGE, SEGMENT, AMOUNT = SUM(AMOUNT) 
FROM 
	MSAJAG.DBO.COLLATERALDETAILS C
WHERE
	UPPER(COLL_TYPE) = 'MARGIN' AND EFFDATE LIKE @VDT + '%'
GROUP BY
	PARTY_CODE, EXCHANGE, SEGMENT) C
WHERE V2.CLTCODE = PARTY_CODE AND (CASE WHEN EXCHANGE = 'NSE' THEN CASE WHEN SEGMENT = 'CAPITAL' THEN 'NSE' ELSE 'NFO' END ELSE 'BSE' END) = LEDGER_TYPE

              
CREATE TABLE #FUND_TRF              
(              
 CLTCODE VARCHAR(15),              
 ACNAME VARCHAR(100),              
 TRF_AMOUNT MONEY,    
 BTOBPAYMENT BIT,            
 SR_NO INT IDENTITY(1,1)              
)              
              
CREATE TABLE #VNO              
(              
 VNO VARCHAR(12)              
)              
              
SET @@FT_CUR = CURSOR FOR              
 SELECT SR_NO, EXCH_FR, EXCH_TO, EXCH_DEFAULT, DB_FR, DB_TO, TRF_TYPE, JV_CODE_FR, JV_NAME_FR, JV_CODE_TO, JV_NAME_TO, ML_CODE_FR, ML_NAME_FR, ML_CODE_TO, ML_NAME_TO FROM V2_FT_PRIORITY ORDER BY SR_NO              
              
OPEN @@FT_CUR              
 FETCH NEXT FROM @@FT_CUR INTO @@SR_NO, @@EXCH_FR, @@EXCH_TO, @@EXCH_DEFAULT, @@DB_FR, @@DB_TO, @@TRF_TYPE, @@JV_CODE_FR, @@JV_NAME_FR, @@JV_CODE_TO, @@JV_NAME_TO, @@ML_CODE_FR, @@ML_NAME_FR, @@ML_CODE_TO, @@ML_NAME_TO              
              
WHILE @@FETCH_STATUS = 0              
BEGIN              
              
 TRUNCATE TABLE #FUND_TRF              
              
 IF @@TRF_TYPE = 1 AND (@@EXCH_TO = 'NFO' OR @@DB_FR = @@DB_TO)              
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_LEDGER_AMOUNT + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END + MARGIN_REQ +  + MARGIN_AMOUNT), BTOBPAYMENT      
   FROM              
  V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(FINAL_LEDGER_AMOUNT + MARGIN_REQ + MARGIN_AMOUNT) > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_REQ + FINAL_MARGIN_AMOUNT + MARGIN_AVAILABLE), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
   LEDGER_TYPE = @@EXCH_TO              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_REQ + FINAL_MARGIN_AMOUNT + MARGIN_AVAILABLE) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
               
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, -(TRF_AMOUNT), 0,0, 0, 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
          
             
  INSERT INTO               
     V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, 0, 0, 0, 0, 0, 0, (TRF_AMOUNT), @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
 END              
 ELSE IF @@TRF_TYPE = 1              
 BEGIN              
  INSERT INTO #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT              
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_LEDGER_AMOUNT + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END + MARGIN_REQ + MARGIN_AMOUNT), BTOBPAYMENT     
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(FINAL_LEDGER_AMOUNT + MARGIN_AMOUNT + MARGIN_REQ) > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_REQ + FINAL_MARGIN_AMOUNT + MARGIN_AVAILABLE), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_REQ + FINAL_MARGIN_AMOUNT + MARGIN_AVAILABLE) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
          
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, -(TRF_AMOUNT), 0,0, 0, 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
          
             
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, 0, 0, 0, 0, 0, 0, (TRF_AMOUNT), @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
          
 END              
              
 IF @@TRF_TYPE = 0 AND @@EXCH_TO = 'NFO'              
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_LEDGER_AMOUNT + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END  + MARGIN_REQ + MARGIN_AMOUNT), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(FINAL_LEDGER_AMOUNT  + MARGIN_REQ + MARGIN_AMOUNT) > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_USAGE_AMOUNT), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_USAGE_AMOUNT) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
             
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, -(TRF_AMOUNT), 0, 0, 0, 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, (TRF_AMOUNT), (TRF_AMOUNT), 0, 0, 0, (TRF_AMOUNT), 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
              
 END              
 ELSE IF @@TRF_TYPE = 0              
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_LEDGER_AMOUNT + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END  + MARGIN_REQ + MARGIN_AMOUNT), BTOBPAYMENT  
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(FINAL_LEDGER_AMOUNT + MARGIN_REQ + MARGIN_AMOUNT) > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_USAGE_AMOUNT), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_USAGE_AMOUNT) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, -(TRF_AMOUNT), 0, 0, 0, 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, (TRF_AMOUNT), 0, 0, 0, 0, (TRF_AMOUNT), 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
 END              
              
 IF @@TRF_TYPE = 2 AND (@@EXCH_TO = 'NFO' OR @@DB_FR = @@DB_TO)              
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ  + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END, BTOBPAYMENT  
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_USAGE_AMOUNT), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_USAGE_AMOUNT) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
   SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, 0, -(TRF_AMOUNT), 0, -(TRF_AMOUNT), 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
          
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, (TRF_AMOUNT), 0, (TRF_AMOUNT), 0, 0, (TRF_AMOUNT), 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
 END              
 ELSE IF @@TRF_TYPE = 2         
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END, BTOBPAYMENT  
   FROM              
    V2_FT_COMPUTEBALANCES  
   WHERE              
    LEDGER_TYPE = @@EXCH_FR              
	AND BTOBPAYMENT = 0  
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_USAGE_AMOUNT), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO  
 AND BTOBPAYMENT = 0              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_USAGE_AMOUNT) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
             
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
   SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, 0, -(TRF_AMOUNT), 0, -(TRF_AMOUNT), 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
          
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
 CLTCODE, ACNAME, @@EXCH_TO, 88, (TRF_AMOUNT), 0, (TRF_AMOUNT), 0, 0, (TRF_AMOUNT), 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
 END              
              
 IF @@TRF_TYPE = 3 AND @@EXCH_TO = 'NFO'              
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END, BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_AMOUNT + MARGIN_REQ), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT             
   HAVING              
    SUM(MARGIN_AMOUNT + MARGIN_REQ) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, 0, -(TRF_AMOUNT), 0, -(TRF_AMOUNT), 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
            
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, 0, (TRF_AMOUNT), 0, 0, 0, 0, (TRF_AMOUNT), @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
 END              
 ELSE IF @@TRF_TYPE = 3              
 BEGIN              
  INSERT INTO               
   #FUND_TRF              
  SELECT              
   A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END, A.BTOBPAYMENT  
  FROM              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END, BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_FR              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    CASE WHEN SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) > SUM(MARGIN_AMOUNT) THEN SUM(MARGIN_AMOUNT) ELSE SUM(MARGIN_AMOUNT + MARGIN_REQ + CASE WHEN MARGIN_USAGE_AMOUNT < 0 THEN MARGIN_USAGE_AMOUNT ELSE 0 END) END > 0) A,              
   (SELECT              
    CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(MARGIN_AMOUNT + MARGIN_REQ), BTOBPAYMENT              
   FROM              
    V2_FT_COMPUTEBALANCES              
   WHERE              
    LEDGER_TYPE = @@EXCH_TO              
   GROUP BY              
    CLTCODE, LEDGER_TYPE, ACNAME, BTOBPAYMENT              
   HAVING              
    SUM(MARGIN_AMOUNT + MARGIN_REQ) < 0) B              
  WHERE              
   A.CLTCODE = B.CLTCODE              
   AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_FR, 88, 0, -(TRF_AMOUNT), 0, -(TRF_AMOUNT), 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT  
  FROM               
   #FUND_TRF              
              
  INSERT INTO               
   V2_FT_COMPUTEBALANCES              
  SELECT              
   CLTCODE, ACNAME, @@EXCH_TO, 88, 0, (TRF_AMOUNT), 0, 0, 0, 0, (TRF_AMOUNT), @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO, BTOBPAYMENT              
  FROM               
   #FUND_TRF              
 END          
      
IF @@TRF_TYPE = 1      
BEGIN        
 SET @@SQL = "UPDATE V2_FT_COMPUTEBALANCES SET FINAL_LEDGER_AMOUNT = MARGIN_REQ WHERE LEDGER_TYPE = '" + @@EXCH_TO + "' AND FINAL_LEDGER_AMOUNT = 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
 EXEC (@@SQL)      
END     
    
IF @@TRF_TYPE = 2      
BEGIN        
 SET @@SQL = "UPDATE V2_FT_COMPUTEBALANCES SET FINAL_LEDGER_AMOUNT = FINAL_MARGIN_AMOUNT WHERE LEDGER_TYPE = '" + @@EXCH_FR + "' AND FINAL_LEDGER_AMOUNT = 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
 EXEC (@@SQL)      
END      
    
IF @@TRF_TYPE = 3      
BEGIN        
 SET @@SQL = "UPDATE V2_FT_COMPUTEBALANCES SET FINAL_LEDGER_AMOUNT = FINAL_MARGIN_AMOUNT WHERE ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
 EXEC (@@SQL)      
END        
      
       
      
      
DELETE FROM V2_FT_COMPUTEBALANCES WHERE VTYPE = 88 AND FINAL_LEDGER_AMOUNT = 0 AND FINAL_MARGIN_AMOUNT = 0 AND MARGIN_REQ = 0 AND MARGIN_USAGE_AMOUNT = 0             
              
 SELECT @@VNO_COUNT = COUNT(SR_NO) FROM #FUND_TRF              
              
 SET @@SQL = "INSERT INTO #VNO "              
 SET @@SQL = @@SQL + " EXEC " + @@DB_FR + ".DBO.ACC_GENVNO_NEW '" + @VDT + "', 88, '01', '" + @START_DATE + "', '" + @END_DATE + "'," + CONVERT(VARCHAR, @@VNO_COUNT)              
              
 EXEC (@@SQL)              
              
 SELECT @@VNO_FR = VNO FROM #VNO              
              
              
 TRUNCATE TABLE #VNO              
              
 SET @@SQL = "INSERT INTO #VNO "              
 SET @@SQL = @@SQL + " EXEC " + @@DB_TO + ".DBO.ACC_GENVNO_NEW '" + @VDT + "', 88, '01', '" + @START_DATE + "', '" + @END_DATE + "'," + CONVERT(VARCHAR, @@VNO_COUNT)              
              
 EXEC (@@SQL)              
              
 SELECT @@VNO_TO = VNO FROM #VNO              
              
 TRUNCATE TABLE #VNO              
              
 SELECT @@VNO_FR = VNO FROM #VNO              
 SELECT @@VNO_TO = VNO FROM #VNO              
              
              
 UPDATE V2_FT_COMPUTEBALANCES SET SOURCE_VNO = (CONVERT(NUMERIC, @@VNO_FR) - 1) + SR_NO FROM #FUND_TRF F WHERE F.CLTCODE = V2_FT_COMPUTEBALANCES.CLTCODE AND ENTRY_TYPE = @@SR_NO             
 UPDATE V2_FT_COMPUTEBALANCES SET TARGET_VNO = (CONVERT(NUMERIC, @@VNO_TO) - 1) + SR_NO FROM #FUND_TRF F WHERE F.CLTCODE = V2_FT_COMPUTEBALANCES.CLTCODE AND ENTRY_TYPE = @@SR_NO              
              
              
              
 IF @@TRF_TYPE = 0              
 BEGIN              
  SET @@SQL = "INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  2, "              
  SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
  SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
  SET @@SQL = @@SQL + "  CLTCODE, "              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  1, "              
              
  SET @@SQL = @@SQL + "  '" + @@JV_NAME_FR + "', "              
              
  SET @@SQL = @@SQL + " CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  SET @@SQL = @@SQL + "  '" + @@JV_CODE_FR + "', "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "              
              
  EXEC (@@SQL)              
              
  SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  2, "              
  SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
  SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "       
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
  SET @@SQL = @@SQL + "  CLTCODE, "              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  1, "              
              
  SET @@SQL = @@SQL + "  '" + @@JV_NAME_TO + "', "              
              
  SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  SET @@SQL = @@SQL + "  '" + @@JV_CODE_TO + "', "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  TARGET_VNO, NARRATION "              
              
  EXEC (@@SQL)              
              
 END              
              
 IF @@TRF_TYPE = 1              
 BEGIN              
              
  SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.MARGINLEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
  SET @@SQL = @@SQL + "  CLTCODE, "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_TO, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'NSE' THEN 'NSE' ELSE 'BSE' END + "', "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_TO, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'BFO' THEN 'FUTURES' ELSE 'CAPITAL' END + "', "              
  SET @@SQL = @@SQL + "  0, '', "              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_to + "' "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND FINAL_LEDGER_AMOUNT > 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  2, "              
  IF @@DB_FR <> @@DB_TO              
    SET @@SQL = @@SQL + "  '" + @@JV_NAME_TO + "', "              
  ELSE              
    SET @@SQL = @@SQL + " ACNAME, "              
              
  SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  IF @@DB_FR <> @@DB_TO              
   SET @@SQL = @@SQL + "'" + @@JV_CODE_TO + "', "              
  ELSE              
   SET @@SQL = @@SQL + " CLTCODE, "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "'  AND FINAL_LEDGER_AMOUNT>0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  TARGET_VNO, NARRATION "              
  IF @@DB_FR = @@DB_TO              
   SET @@SQL = @@SQL + ", ACNAME, CLTCODE "              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "             
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  '" + @@ML_NAME_TO + "', CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "              
              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_TO + "', "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND FINAL_LEDGER_AMOUNT>0  AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  TARGET_VNO, LNO, NARRATION "              
              
  EXEC (@@SQL)              
              
  IF @@DB_FR <> @@DB_TO              
  BEGIN              
     SET @@SQL = "INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
     SET @@SQL = @@SQL + " SELECT "              
     SET @@SQL = @@SQL + "  88, "              
     SET @@SQL = @@SQL + "  SOURCE_VNO, "              
     SET @@SQL = @@SQL + "'" + @VDT + "', "              
     SET @@SQL = @@SQL + "  2, "              
              
     SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
              
     SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
     SET @@SQL = @@SQL + "'" + @VDT + "',"              
     SET @@SQL = @@SQL + "  SOURCE_VNO, "              
     SET @@SQL = @@SQL + "  REFNO = '', "              
     SET @@SQL = @@SQL + "  BALAMT = 0, "              
     SET @@SQL = @@SQL + "  NODAYS = 0, "              
     SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
     SET @@SQL = @@SQL + "  CLTCODE, "              
              
     SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
     SET @@SQL = @@SQL + "'" + @UNAME + "', "              
     SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
     SET @@SQL = @@SQL + "'" + @UNAME + "', "              
     SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
     SET @@SQL = @@SQL + " NARRATION "              
     SET @@SQL = @@SQL + " FROM "              
     SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
     SET @@SQL = @@SQL + " WHERE "              
     SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
     SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
     SET @@SQL = @@SQL + " SELECT "              
     SET @@SQL = @@SQL + "  88, "              
     SET @@SQL = @@SQL + "  SOURCE_VNO, "              
     SET @@SQL = @@SQL + "'" + @VDT + "', "              
     SET @@SQL = @@SQL + "  1, "              
              
     SET @@SQL = @@SQL + "  '" + @@JV_NAME_FR + "', CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
              
     SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
     SET @@SQL = @@SQL + "'" + @VDT + "',"              
     SET @@SQL = @@SQL + "   SOURCE_VNO, "              
     SET @@SQL = @@SQL + "  REFNO = '', "              
     SET @@SQL = @@SQL + "  BALAMT = 0, "              
     SET @@SQL = @@SQL + "  NODAYS = 0, "              
     SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
     SET @@SQL = @@SQL + "'" + @@JV_CODE_FR + "', "              
              
     SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
     SET @@SQL = @@SQL + "'" + @UNAME + "', "              
     SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
     SET @@SQL = @@SQL + "'" + @UNAME + "', "              
     SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
     SET @@SQL = @@SQL + " NARRATION "              
     SET @@SQL = @@SQL + " FROM "              
 SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
     SET @@SQL = @@SQL + " WHERE "              
     SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
     SET @@SQL = @@SQL + " GROUP BY "              
     SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "              
              
     EXEC (@@SQL)              
  END              
 END              
              
 IF @@TRF_TYPE = 2              
 BEGIN              
              
  SET @@SQL = "INSERT INTO " + @@DB_FR + ".DBO.MARGINLEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "         
  SET @@SQL = @@SQL + "  CLTCODE, "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_FR, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'NSE' THEN 'NSE' ELSE 'BSE' END + "', "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_FR, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'BFO' THEN 'FUTURES' ELSE 'CAPITAL' END + "', "              
  SET @@SQL = @@SQL + "  0, '', "              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_FR + "' "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND FINAL_LEDGER_AMOUNT < 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  2, "              
  IF @@DB_FR <> @@DB_TO              
  BEGIN      
   SET @@SQL = @@SQL + "  '" + @@JV_NAME_FR + "', "              
  END      
  ELSE              
  BEGIN      
   SET @@SQL = @@SQL + " ACNAME, "              
  END      
      
  SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
              
        
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  IF @@DB_FR <> @@DB_TO              
   SET @@SQL = @@SQL + "'" + @@JV_CODE_FR + "', "              
  ELSE              
   SET @@SQL = @@SQL + " CLTCODE, "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND FINAL_LEDGER_AMOUNT < 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
        
      
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "              
  IF @@DB_FR = @@DB_TO              
   SET @@SQL = @@SQL + ", ACNAME, CLTCODE "              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  '" + @@ML_NAME_FR + "', CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "              
              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_FR + "', "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
 SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND FINAL_LEDGER_AMOUNT < 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
        
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, LNO, NARRATION "              
              
  EXEC (@@SQL)              
              
  IF @@DB_FR <> @@DB_TO               
  BEGIN              
   SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
   SET @@SQL = @@SQL + " SELECT "              
   SET @@SQL = @@SQL + "  88, "              
   SET @@SQL = @@SQL + "  TARGET_VNO, "              
   SET @@SQL = @@SQL + "'" + @VDT + "', "              
   SET @@SQL = @@SQL + "  2, "              
              
   SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
   ----(change)            
   SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
   SET @@SQL = @@SQL + "'" + @VDT + "',"              
   SET @@SQL = @@SQL + "  TARGET_VNO, "              
   SET @@SQL = @@SQL + "  REFNO = '', "              
   SET @@SQL = @@SQL + "  BALAMT = 0, "              
   SET @@SQL = @@SQL + "  NODAYS = 0, "              
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
   SET @@SQL = @@SQL + "  CLTCODE, "              
              
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
   SET @@SQL = @@SQL + "'" + @UNAME + "', "              
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
   SET @@SQL = @@SQL + "'" + @UNAME + "', "              
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
   SET @@SQL = @@SQL + " NARRATION "              
   SET @@SQL = @@SQL + " FROM "              
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
   SET @@SQL = @@SQL + " WHERE "              
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
   SET @@SQL = @@SQL + " SELECT "              
   SET @@SQL = @@SQL + "  88, "              
   SET @@SQL = @@SQL + "  TARGET_VNO, "              
   SET @@SQL = @@SQL + "'" + @VDT + "', "              
   SET @@SQL = @@SQL + "  1, "              
              
   SET @@SQL = @@SQL + "  '" + @@JV_NAME_FR + "', CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
   ---(change)            
              
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
   SET @@SQL = @@SQL + "'" + @VDT + "',"              
   SET @@SQL = @@SQL + "   TARGET_VNO, "              
   SET @@SQL = @@SQL + "  REFNO = '', "          
   SET @@SQL = @@SQL + "  BALAMT = 0, "              
   SET @@SQL = @@SQL + "  NODAYS = 0, "              
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
   SET @@SQL = @@SQL + "'" + @@JV_CODE_TO + "', "              
              
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
   SET @@SQL = @@SQL + "'" + @UNAME + "', "              
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
   SET @@SQL = @@SQL + "'" + @UNAME + "', "              
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
   SET @@SQL = @@SQL + " NARRATION "              
   SET @@SQL = @@SQL + " FROM "              
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
   SET @@SQL = @@SQL + " WHERE "              
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
   SET @@SQL = @@SQL + " GROUP BY "              
   SET @@SQL = @@SQL + "  TARGET_VNO, NARRATION "              
              
   EXEC (@@SQL)              
  END              
 END              
              
 IF @@TRF_TYPE = 3              
 BEGIN              
              
  SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.MARGINLEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  1, "                                      
  SET @@SQL = @@SQL + "  CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
  SET @@SQL = @@SQL + "  CLTCODE, "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_TO, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'NSE' THEN 'NSE' ELSE 'BSE' END + "', "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_TO, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'BFO' THEN 'FUTURES' ELSE 'CAPITAL' END + "', "              
  SET @@SQL = @@SQL + "  0, '', "              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_TO + "' "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
  SET @@SQL = @@SQL + "INSERT INTO " + @@DB_FR + ".DBO.MARGINLEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  CASE WHEN FINAL_LEDGER_AMOUNT < 0 THEN 'D' ELSE 'C' END, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  ABS(FINAL_LEDGER_AMOUNT), "              
  SET @@SQL = @@SQL + "  CLTCODE, "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_TO, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'NSE' THEN 'NSE' ELSE 'BSE' END + "', "              
  SET @@SQL = @@SQL + "'" + CASE WHEN LEFT(@@EXCH_TO, 3) = 'NFO' OR LEFT(@@EXCH_FR, 3) = 'BFO' THEN 'FUTURES' ELSE 'CAPITAL' END + "', "              
  SET @@SQL = @@SQL + "  0, '', "              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_FR + "' "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  2, "              
  IF @@DB_FR <> @@DB_TO              
    SET @@SQL = @@SQL + "  '" + @@JV_NAME_TO + "', "              
  ELSE              
    SET @@SQL = @@SQL + " ACNAME, "              
              
  SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  IF @@DB_FR <> @@DB_TO              
   SET @@SQL = @@SQL + "'" + @@JV_CODE_TO + "', "              
  ELSE              
   SET @@SQL = @@SQL + " CLTCODE, "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  TARGET_VNO, NARRATION "              
  IF @@DB_FR = @@DB_TO              
   SET @@SQL = @@SQL + ", ACNAME, CLTCODE "              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  '" + @@ML_NAME_TO + "', CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "              
              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  TARGET_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_TO + "', "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  TARGET_VNO, LNO, NARRATION "              
                
  EXEC (@@SQL)              
              
  SET @@SQL = " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  2, "              
  IF @@DB_FR <> @@DB_TO              
    SET @@SQL = @@SQL + "  '" + @@JV_NAME_FR + "', "              
  ELSE              
    SET @@SQL = @@SQL + " ACNAME, "              
              
  SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "              
 SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  IF @@DB_FR <> @@DB_TO              
   SET @@SQL = @@SQL + "'" + @@JV_CODE_FR + "', "              
  ELSE              
   SET @@SQL = @@SQL + " CLTCODE, "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)            
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "              
  IF @@DB_FR = @@DB_TO              
   SET @@SQL = @@SQL + ", ACNAME, CLTCODE "              
              
  SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "              
  SET @@SQL = @@SQL + " SELECT "              
  SET @@SQL = @@SQL + "  88, "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "'" + @VDT + "', "              
  SET @@SQL = @@SQL + "  1, "              
  SET @@SQL = @@SQL + "  '" + @@ML_NAME_FR + "', CASE WHEN SUM(FINAL_LEDGER_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "              
              
  SET @@SQL = @@SQL + "  ABS(SUM(FINAL_LEDGER_AMOUNT)), "              
  SET @@SQL = @@SQL + "'" + @VDT + "',"              
  SET @@SQL = @@SQL + "  SOURCE_VNO, "              
  SET @@SQL = @@SQL + "  REFNO = '', "              
  SET @@SQL = @@SQL + "  BALAMT = 0, "              
  SET @@SQL = @@SQL + "  NODAYS = 0, "              
  SET @@SQL = @@SQL + "  CDT = GETDATE(), "              
              
  SET @@SQL = @@SQL + "'" + @@ML_CODE_FR + "', "              
              
  SET @@SQL = @@SQL + "  BOOKTYPE = '01', "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + "  PDT = GETDATE(), "              
  SET @@SQL = @@SQL + "'" + @UNAME + "', "              
  SET @@SQL = @@SQL + " ACTNODAYS = 0, "              
  SET @@SQL = @@SQL + " NARRATION "              
  SET @@SQL = @@SQL + " FROM "              
  SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "              
  SET @@SQL = @@SQL + " WHERE "              
  SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)              
  SET @@SQL = @@SQL + " GROUP BY "              
  SET @@SQL = @@SQL + "  SOURCE_VNO, LNO, NARRATION "              
              
  EXEC (@@SQL)              
              
 END              
      
IF @@TRF_TYPE = 1    
BEGIN        
 SET @@SQL = "UPDATE V2_FT_COMPUTEBALANCES SET FINAL_LEDGER_AMOUNT = 0 WHERE LEDGER_TYPE = '" + @@EXCH_TO + "' AND FINAL_LEDGER_AMOUNT > 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
 EXEC (@@SQL)      
END           
      
IF @@TRF_TYPE = 2      
BEGIN        
 SET @@SQL = "UPDATE V2_FT_COMPUTEBALANCES SET FINAL_LEDGER_AMOUNT = 0 WHERE LEDGER_TYPE = '" + @@EXCH_FR + "' AND FINAL_LEDGER_AMOUNT < 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
 EXEC (@@SQL)      
END           
    
IF @@TRF_TYPE = 3      
BEGIN        
 SET @@SQL = "UPDATE V2_FT_COMPUTEBALANCES SET FINAL_LEDGER_AMOUNT = 0 WHERE ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
SET @@SQL = @@SQL + " UPDATE V2_FT_COMPUTEBALANCES SET FINAL_MARGIN_AMOUNT = 0 WHERE FINAL_MARGIN_AMOUNT > 0 AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)      
 EXEC (@@SQL)      
END           
      
      
      
 INSERT INTO               
  V2_LEDGERTRANSFER              
 SELECT              
  A.BRANCHCODE,              
  F.CLTCODE,              
  F.ACNAME,              
  FINAL_LEDGER_AMOUNT,              
  FINAL_MARGIN_AMOUNT,              
  LEDGER_AMOUNT,              
  MARGIN_AMOUNT,              
  MARGIN_AVAILABLE,              
  MARGIN_USAGE_AMOUNT,              
  MARGIN_REQ,              
  '',              
  @@EXCH_FR,              
  @@EXCH_TO,           
  @VDT,              
  'P',              
  @UNAME,              
  GETDATE(),              
  'FT',              
  NARRATION,              
  0              
 FROM              
  V2_FT_COMPUTEBALANCES F,              
  ACMAST A              
 WHERE              
  LEDGER_TYPE = @@EXCH_FR AND ENTRY_TYPE = CONVERT(VARCHAR, @@SR_NO)              
  AND A.CLTCODE = F.CLTCODE              
              
 FETCH NEXT FROM @@FT_CUR INTO @@SR_NO, @@EXCH_FR, @@EXCH_TO, @@EXCH_DEFAULT, @@DB_FR, @@DB_TO, @@TRF_TYPE, @@JV_CODE_FR, @@JV_NAME_FR, @@JV_CODE_TO, @@JV_NAME_TO, @@ML_CODE_FR, @@ML_NAME_FR, @@ML_CODE_TO, @@ML_NAME_TO              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FUNDSPAYIN
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[V2_FUNDSPAYIN]  
(  
 @SETTNO VARCHAR(12),  
 @RPTTYPE CHAR(4),  
 @BANK_CODE VARCHAR(12)  
)  
  
AS  
 /*  
  EXEC [DBO].[V2_FUNDSPAYIN]  
   '2005059',  
   'FILE',  
   '326090'  
  
  EXEC [DBO].[V2_FUNDSPAYIN]  
   '2005059',  
   'HTML',  
   '326090'  
 */  
  
 DECLARE  
  @@FDATE DATETIME,  
  @@DBNAME VARCHAR(25),  
  @@EXCHANGE VARCHAR(3),  
  @@SEGMENT VARCHAR(20)  
   
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
 SET NOCOUNT ON  
   
 DECLARE  
  @@TDATE DATETIME  
   
 SET @@TDATE = CONVERT(VARCHAR(11), GETDATE())  
  
 EXEC MSAJAG.DBO.PROC_RMS_CALCULATION   
  @SAUDA_DATE=@@TDATE,  
  @FROMPARTY='0',  
  @TOPARTY='ZZZZ',  
  @INSERTFINAL=0  
  
 SELECT  
  @@FDATE = SDTCUR  
 FROM  
  PARAMETER  
 WHERE  
  GETDATE() BETWEEN SDTCUR AND LDTCUR  
  
 SELECT   
  @@DBNAME = DB_NAME()  
  
 SELECT  
  @@EXCHANGE = EXCHANGE,  
  @@SEGMENT = SEGMENT  
 FROM  
  PRADNYA.DBO.MULTICOMPANY  
 WHERE  
  ACCOUNTDB = @@DBNAME  
  
 CREATE TABLE [DBO].[#FUNDSPAYIN_DATA](  
  [SETT_NO] [VARCHAR](12) NOT NULL,  
  [SETT_TYPE] [VARCHAR](3) NOT NULL,  
  [PARTY_CODE] [VARCHAR](10) NOT NULL,  
  [BILLDATE] [DATETIME] NOT NULL,  
  [AMOUNT] [MONEY] NOT NULL,  
  [DRCR] [CHAR](1) NOT NULL,  
  [VNO] [VARCHAR](12) NOT NULL,  
  [BRANCH] [VARCHAR](10) NOT NULL,  
  [EXCHANGE] [VARCHAR](3) NOT NULL,  
  [SEGMENT] [VARCHAR](7) NOT NULL,  
  [BANK_CODE] [VARCHAR](10) NOT NULL,  
  [SRNO] [INT] IDENTITY (1, 1)  
 ) ON [PRIMARY]  
  
 INSERT INTO  
  #FUNDSPAYIN_DATA  
 SELECT  
  SETT_NO,  
  SETT_TYPE,  
  PARTY_CODE,  
  DATE = CONVERT(VARCHAR(11), DATE),  
  AMOUNT,  
  DRCR = CASE DRCR WHEN 'D' THEN 'C' END,  
  VNO,  
  BRANCH,  
  EXCHANGE,  
  SEGMENT,  
  BANK_CODE = @BANK_CODE  
 FROM  
  BFBILLMATCH B,  
  ACMAST A  
 WHERE  
  VTYPE = 15  
  AND SETT_NO = @SETTNO  
  AND DRCR = 'D'  
  AND B.PARTY_CODE = A.CLTCODE  
  AND BTOBPAYMENT = 1  
   
 UNION ALL  
  
 SELECT  
  SETT_NO = '',  
  SETT_TYPE = '',  
  PARTY_CODE = A.CLTCODE,  
  DATE = GETDATE(),  
  AMOUNT = ABS(SUM(VDTLEDBAL)),  
  DRCR = 'C',  
  VNO = '',  
  BRANCH = BRANCHCODE,  
  EXCHANGE = @@EXCHANGE,  
  SEGMENT = @@SEGMENT,  
  BANK_CODE = @BANK_CODE  
 FROM  
  MSAJAG.DBO.TBL_RMS_DATA_TODAY L,  
  ACMAST A  
 WHERE    
  BTOBPAYMENT = 0  
  AND L.PARTY_CODE = A.CLTCODE  
  AND RMS_DATE = CONVERT(VARCHAR(11), GETDATE())  
  AND EXCHANGE = @@EXCHANGE  
  AND SEGMENT = @@SEGMENT  
 GROUP BY  
  A.CLTCODE,  
  BRANCHCODE  
 HAVING  
  SUM(VDTLEDBAL) < 0  
 ORDER BY  
  PARTY_CODE,  
  BRANCH  
  
 IF @RPTTYPE = 'HTML'  
  SELECT  
   SRNO,  
   SETT_NO,  
   SETT_TYPE,  
   PARTY_CODE,  
   BILLDATE = CONVERT(VARCHAR(11), BILLDATE),  
   AMOUNT,  
   DRCR,  
   VNO,  
   BRANCH,  
   EXCHANGE,  
   SEGMENT  
  FROM  
   #FUNDSPAYIN_DATA  
  ORDER BY  
   SRNO  
  
 ELSE --FILE  
  SELECT  
   PROCESSDT = CONVERT(VARCHAR(11), BILLDATE, 103),  
   TXN_TYPE = '1',  
   ACCNO,  
   BRANCH = '1',  
   TXN_CODE = '1408',  
   TXN_DT = CONVERT(VARCHAR(11), BILLDATE, 103),  
   DRCR,  
   VALUEDT = CONVERT(VARCHAR(11), BILLDATE, 103),  
   TXN_CCY = '104',  
   AMT_LCY = AMOUNT,  
   AMT_TCY = AMOUNT,  
   RATE_CON = '1.00',  
   REFNO = ACCNO,  
   TRN_DESC = 'FUNDSPAYIN ' + @SETTNO + ' - ' + PARTY_CODE  
  FROM  
   #FUNDSPAYIN_DATA R,  
   MULTIBANKID M  
  WHERE  
   PARTY_CODE = CLTCODE  
   AND DEFAULTBANK = 1  
    
  UNION ALL  
    
  SELECT --BARCLAYS CLIENT DESIGNATED A/C DETAILS  
   PROCESSDT = CONVERT(VARCHAR(11), BILLDATE, 103),  
   TXN_TYPE = '3',  
   ACCDTLS,  
   BRANCH = '1',  
   TXN_CODE = '1008',  
   TXN_DT = CONVERT(VARCHAR(11), BILLDATE, 103),  
   DRCR = 'D',  
   VALUEDT = CONVERT(VARCHAR(11), BILLDATE, 103),  
   TXN_CCY = '104',  
   AMT_LCY = 0,  
   AMT_TCY = 0,  
   RATE_CON = '1.00',  
   REFNO = ACCDTLS,  
   TRN_DESC = 'FUNDSPAYIN ' + @SETTNO  
  FROM  
   #FUNDSPAYIN_DATA R,  
   ACMAST A  
  WHERE  
   BANK_CODE = CLTCODE  
   AND ACCAT = 2  
  GROUP BY  
   CONVERT(VARCHAR(11), BILLDATE, 103),  
   ACCDTLS  
  ORDER BY  
   TXN_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_GETLEDGERBALANCE
-- --------------------------------------------------
CREATE PROCEDURE V2_GETLEDGERBALANCE  
(  
 @SDATE VARCHAR(11),  
 @FPARTY VARCHAR(10),  
 @TPARTY VARCHAR(10),  
 @STLNO VARCHAR(7),  
 @GENFLAG VARCHAR(1),  
 @USER VARCHAR(25),  
 @EXCHANGE VARCHAR(3),  
 @SEGMENT VARCHAR(7),  
 @EFFDATE VARCHAR(11),  
 --@CLTYPE VARCHAR(3) = 'ALL', -- [NOT IN USE] CLTYPE -> [WEB / HNI / ALL ETC.]  
 --@INCL_MARGIN CHAR(1) = 'Y', -- [NOT IN USE] INCLUDE DERIVATIVES MARGIN REQUIREMENT -> [Y / N]  
 @COMP_FOR VARCHAR(6) = 'BRANCH' -- COMPUTATION FOR BRANCH REQUESTING / ONLINE CLIENTS PAYOUT  
)  
  
AS  
  
 /*===========================================================================  
  ---------------------------------------------------------------------  
  FNO CREDIT BALANCES AFTER ADJUSTING  
  MARGIN REQUIREMENT & COLLATERAL  
  TO BE CONSIDERED WHILE COMPUTING NET BALANCE  
  ---------------------------------------------------------------------  
  
  EXEC V2_GETLEDGERBALANCE  
   @SDATE = 'APR  1 2005',  
   @FPARTY = '',  
   @TPARTY = '',  
   @STLNO = '2005125',  
   @GENFLAG = 'S',  
   @USER = 'PM',  
   @EXCHANGE = 'NSE',  
   @SEGMENT = 'CAPITAL',  
   @EFFDATE = 'MAR  4 2006',  
   @COMP_FOR = 'BRANCH'  
  
  EXEC V2_GETLEDGERBALANCE  
   @SDATE = 'APR  1 2005',  
   @FPARTY = '',  
   @TPARTY = '',  
   @STLNO = '',  
   @GENFLAG = 'A',  
   @USER = 'PM',  
   @EXCHANGE = 'NSE',  
   @SEGMENT = 'CAPITAL',  
   @EFFDATE = 'MAR 31 2006',  
   @COMP_FOR = 'BRANCH'  
  
  SELECT * FROM V2_LEDGERBALANCE  
  
  SELECT PARTYCODE FROM V2_LEDGERBALANCE GROUP BY PARTYCODE HAVING COUNT(*) > 1  
  
  SELECT * FROM MSAJAG..ACCBILL WHERE SETT_NO = '2005079'  
 ===========================================================================*/  
   
 SET NOCOUNT ON  
  
 IF @FPARTY = '' SET @FPARTY = '0000000000'  
  
 IF @TPARTY = '' SET @TPARTY = 'ZZZZZZZZZZ'  
  
 DECLARE @@RECCOUNT INT  
  
 SET @@RECCOUNT = 0  
  
 SELECT @@RECCOUNT = COUNT(1) FROM SETTPAYOUT WHERE LEFT(REQUESTDT,11) = LEFT(GETDATE(),11) AND STATUS = 'P'  
  
 IF @COMP_FOR = 'BRANCH'  
 BEGIN  
  IF @@RECCOUNT <> 0  
  BEGIN  
   SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO RECALCULATE ::'  
   RETURN  
  END  
        END   
        ELSE   
 IF @COMP_FOR = 'ONLINE'  
 BEGIN  
  IF @@RECCOUNT <> 0  
  BEGIN  
   SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO UPLOAD ONLINE FILE AGAIN ::'  
   RETURN  
  END  
 END  
  
 /*===========================================================================  
 CREATE # TABLES FOR CANNED LEDGER BALANCES AND BILL AMOUNTS  
 ===========================================================================*/  
 CREATE TABLE #LEDGERBALANCE  
 (  
  PARTYCODE VARCHAR(10),  
  PARTYNAME VARCHAR(100),  
  CHEQUENAME VARCHAR(100),  
  BRANCHCODE VARCHAR(10),  
  ACCAT VARCHAR(10),  
  BTOBPAYMENT INT,  
  TOTLEDBAL MONEY,  
  NSELEDBAL MONEY,  
  BSELEDBAL MONEY,  
  FNOLEDBAL MONEY,  
  SETT_NO VARCHAR(7),  
  NORMALBILLAMT MONEY,  
  T2TBILLAMT MONEY,  
  BILLAMT MONEY,  
  FUTUREPAYOUT MONEY,  
  SHORTAGE MONEY,  
  AMOUNTTOBEPAID MONEY,  
  PAYMODE VARCHAR(1),  
  BANKCODE VARCHAR(10),  
  GENFLAG VARCHAR(1),  
  CLIENTTYPE VARCHAR(3),    
  FAMILYCODE VARCHAR(10),    
  RUNDATE DATETIME  
 )  
  
 CREATE INDEX [PARTYCODE] ON [DBO].[#LEDGERBALANCE]([PARTYCODE]) ON [PRIMARY]  
  
 CREATE TABLE [#LEDGERBILLTMP]  
 (  
  [CLTCODE] [VARCHAR] (10)  NULL,  
  [BRANCHCODE] [VARCHAR] (10)  NULL,  
  [LONGNAME] [VARCHAR] (100)  NULL,  
  [ACCAT] [CHAR] (10)  NULL,  
  [BTOBPAYMENT] [INT] NULL,  
  [PAYMODE] [CHAR] (1)  NULL,  
  [POBANKCODE] [VARCHAR] (10)  NULL,  
  [SETT_NO] [VARCHAR] (7) NOT NULL,  
  [NORMALBILLAMT] [MONEY],  
  [T2TBILLAMT] [MONEY],  
  [CLIENTTYPE] [VARCHAR] (3),    
  [FAMILYCODE] [VARCHAR] (10),    
  [RUNDATE] [DATETIME]  
 ) ON [PRIMARY]  
  
 CREATE INDEX [CLTCODE] ON [DBO].[#LEDGERBILLTMP]([CLTCODE]) ON [PRIMARY]  
  
 IF @COMP_FOR = 'BRANCH'  
 BEGIN  
  IF @GENFLAG = 'A' -- ADHOC PAYOUT  
  BEGIN  
   INSERT INTO  
    #LEDGERBILLTMP  
   SELECT  
    A.CLTCODE,  
    A.BRANCHCODE,  
    LONGNAME,  
    ACCAT,  
    BTOBPAYMENT,  
    PAYMODE,  
    POBANKCODE,  
    SETT_NO = '',  
    NORMALBILLAMT = 0,  
    T2TBILLAMT = 0,  
    CLIENTTYPE = '',       
    FAMILYCODE = '',       
    RUNDATE = GETDATE()  
   FROM   
    ACMAST A WITH(NOLOCK)  
   WHERE   
    A.CLTCODE BETWEEN @FPARTY AND @TPARTY  
    AND A.ACCAT IN (4, 104)  
    AND A.POBANKCODE IN  
    (  
     SELECT  
     CLTCODE  
     FROM ACMAST  
     WITH(NOLOCK)  
     WHERE ACCAT = 2  
    )  
   GROUP BY   
    A.CLTCODE,  
    A.BRANCHCODE,  
    LONGNAME,  
    ACCAT,  
    BTOBPAYMENT,  
    PAYMODE,  
    POBANKCODE  
  
   UPDATE  
    #LEDGERBILLTMP  
   SET   
    CLIENTTYPE = C1.CL_TYPE,       
    FAMILYCODE = C1.FAMILY   
   FROM   
    MSAJAG..CLIENT1 C1,  
    MSAJAG..CLIENT2 C2,  
    MSAJAG..CLIENTTYPE C3  
   WHERE   
    CLTCODE = C2.PARTY_CODE  
    AND C1.CL_CODE = C2.CL_CODE  
    AND C1.CL_TYPE = C3.CL_TYPE  
  
   DELETE   
    #LEDGERBILLTMP  
   WHERE   
    CLIENTTYPE IN (SELECT CL_TYPE FROM MSAJAG..CLIENTTYPE WHERE FUNDS_ADHOC_PAYOUT <> '1')  
  END   
  ELSE   
  IF @GENFLAG = 'S' --SETTLEMENT PAYOUT CAPITAL  
  BEGIN  
   IF @SEGMENT <> 'FUTURES'   
   BEGIN  
    DECLARE @SQL VARCHAR(1000)  
  
    SET @SQL = ''  
  
    IF @EXCHANGE = 'NSE'   
    BEGIN  
     SET @SQL = 'SELECT PARTY_CODE, SELL_BUY, AMOUNT, SETT_NO, SETT_TYPE INTO #ACCBILL FROM MSAJAG..ACCBILL WHERE SETT_NO = ' + @STLNO   
    END  
  
    IF @EXCHANGE = 'BSE'   
    BEGIN  
     SET @SQL = 'SELECT PARTY_CODE, SELL_BUY, AMOUNT, SETT_NO, SETT_TYPE INTO #ACCBILL FROM BSEDB..ACCBILL WHERE SETT_NO = ' + @STLNO   
    END  
  
    EXEC (@SQL)  
      
    INSERT INTO  
     #LEDGERBILLTMP  
    SELECT  
     A.CLTCODE,  
     A.BRANCHCODE,  
     LONGNAME,  
     ACCAT,  
     BTOBPAYMENT,  
     PAYMODE,  
     POBANKCODE,  
     SETT_NO = @STLNO,  
     NORMALBILLAMT = SUM(  
         CASE  
         WHEN SETT_TYPE = (CASE WHEN @EXCHANGE = 'NSE' THEN 'N' ELSE 'D' END)  
         THEN (  
          CASE  
          WHEN SELL_BUY = '1'  
          THEN -AMOUNT  
          ELSE AMOUNT  
          END  
         )  
         ELSE 0  
         END  
         ),  
     T2TBILLAMT = SUM(  
         CASE  
         WHEN SETT_TYPE = (CASE WHEN @EXCHANGE = 'NSE' THEN 'W' ELSE 'C' END)  
         THEN (  
          CASE  
          WHEN SELL_BUY = '1'  
          THEN -AMOUNT  
          ELSE AMOUNT  
          END  
         )  
         ELSE 0  
         END  
         ),  
     CLIENTTYPE = '',       
     FAMILYCODE = '',       
     RUNDATE = GETDATE()  
    FROM   
     #ACCBILL L WITH(NOLOCK),  
     ACMAST A WITH(NOLOCK)  
    WHERE   
     L.PARTY_CODE = A.CLTCODE  
     AND A.CLTCODE BETWEEN @FPARTY AND @TPARTY  
     AND A.ACCAT IN (4, 104)  
     AND L.SETT_NO = @STLNO  
     AND A.POBANKCODE IN  
     (  
      SELECT  
      CLTCODE  
      FROM ACMAST  
      WITH(NOLOCK)  
      WHERE ACCAT = 2  
     )  
    GROUP BY   
     A.CLTCODE,  
     A.BRANCHCODE,  
     LONGNAME,  
     ACCAT,  
     BTOBPAYMENT,  
     PAYMODE,  
     POBANKCODE  
    HAVING  
     SUM(  
     CASE  
     WHEN SELL_BUY = '1'  
     THEN -AMOUNT  
     ELSE AMOUNT  
     END  
     ) > 0  
  
    UPDATE  
     #LEDGERBILLTMP  
    SET   
     CLIENTTYPE = C1.CL_TYPE,       
     FAMILYCODE = C1.FAMILY   
    FROM   
     MSAJAG..CLIENT1 C1,  
     MSAJAG..CLIENT2 C2,  
     MSAJAG..CLIENTTYPE C3  
    WHERE   
     CLTCODE = C2.PARTY_CODE  
     AND C1.CL_CODE = C2.CL_CODE  
     AND C1.CL_TYPE = C3.CL_TYPE  
  
    DELETE   
     #LEDGERBILLTMP  
    WHERE   
     CLIENTTYPE IN (SELECT CL_TYPE FROM MSAJAG..CLIENTTYPE WHERE FUNDS_SETT_PAYOUT <> '1')  
   END  
  END   
 END   
  
 IF @COMP_FOR = 'ONLINE'  
 BEGIN  
  INSERT INTO  
   #LEDGERBILLTMP  
  SELECT  
   A.CLTCODE,  
   A.BRANCHCODE,  
   LONGNAME,  
   ACCAT,  
   BTOBPAYMENT,  
   PAYMODE,  
   POBANKCODE,  
   SETT_NO = '',  
   NORMALBILLAMT = 0,  
   T2TBILLAMT = 0,  
   CLIENTTYPE = '',       
   FAMILYCODE = '',       
   RUNDATE = GETDATE()  
  FROM   
   ACMAST A WITH(NOLOCK),   
   V2_ONLINEPAYOUT P WITH(NOLOCK)  
  WHERE   
   A.CLTCODE = P.CLIENT_CODE  
   AND A.ACCAT IN (4, 104)  
   AND A.POBANKCODE IN  
   (  
    SELECT  
    CLTCODE  
    FROM ACMAST  
    WITH(NOLOCK)  
    WHERE ACCAT = 2  
   )  
                        AND TRANSACTION_DATE = REPLACE(CONVERT(VARCHAR,GETDATE(),103),'/','')   
  GROUP BY   
   A.CLTCODE,  
   A.BRANCHCODE,  
   LONGNAME,  
   ACCAT,  
   BTOBPAYMENT,  
   PAYMODE,  
   POBANKCODE  
  
  UPDATE  
   #LEDGERBILLTMP  
  SET   
   CLIENTTYPE = C1.CL_TYPE,       
   FAMILYCODE = C1.FAMILY   
  FROM   
   MSAJAG..CLIENT1 C1,  
   MSAJAG..CLIENT2 C2,  
   MSAJAG..CLIENTTYPE C3  
  WHERE   
   CLTCODE = C2.PARTY_CODE  
   AND C1.CL_CODE = C2.CL_CODE  
   AND C1.CL_TYPE = C3.CL_TYPE  
  
  DELETE   
   #LEDGERBILLTMP  
  WHERE   
   CLIENTTYPE IN (SELECT CL_TYPE FROM MSAJAG..CLIENTTYPE WHERE FUNDS_SETT_PAYOUT <> '2')  
 END   
  
 IF @COMP_FOR = 'HO'  
 BEGIN  
  INSERT INTO  
   #LEDGERBILLTMP  
  SELECT  
   A.CLTCODE,  
   A.BRANCHCODE,  
   LONGNAME,  
   ACCAT,  
   BTOBPAYMENT,  
   PAYMODE,  
   POBANKCODE,  
   SETT_NO = '',  
   NORMALBILLAMT = 0,  
   T2TBILLAMT = 0,  
   CLIENTTYPE = '',       
   FAMILYCODE = '',       
   RUNDATE = GETDATE()  
  FROM   
   ACMAST A WITH(NOLOCK),   
   SETTPAYOUT P WITH(NOLOCK)  
  WHERE   
   A.CLTCODE = P.CLTCODE  
   AND A.ACCAT IN (4, 104)  
   AND STATUS = 'P'   
                        AND A.POBANKCODE IN  
   (  
    SELECT  
    CLTCODE  
    FROM ACMAST  
    WITH(NOLOCK)  
    WHERE ACCAT = 2  
   )  
            AND GENFLAG = @GENFLAG   
  GROUP BY   
   A.CLTCODE,  
   A.BRANCHCODE,  
   LONGNAME,  
   ACCAT,  
   BTOBPAYMENT,  
   PAYMODE,  
   POBANKCODE  
  
  UPDATE  
   #LEDGERBILLTMP  
  SET   
   CLIENTTYPE = C1.CL_TYPE,       
   FAMILYCODE = C1.FAMILY   
  FROM   
   MSAJAG..CLIENT1 C1,  
   MSAJAG..CLIENT2 C2,  
   MSAJAG..CLIENTTYPE C3  
  WHERE   
   CLTCODE = C2.PARTY_CODE  
   AND C1.CL_CODE = C2.CL_CODE  
   AND C1.CL_TYPE = C3.CL_TYPE  
 END   
  
 /*============================================================================  
 CALCULATE NSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER  
 ============================================================================*/  
 INSERT INTO   
  #LEDGERBALANCE  
 SELECT  
  L.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  TOTLEDBAL = 0,  
  NSELEDBAL = SUM(  
     CASE  
     WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'  
     THEN (  
      CASE  
      WHEN DRCR = 'D'  
      THEN -VAMT  
      ELSE VAMT  
      END  
     )  
     ELSE 0  
     END  
     ) + SUM(  
       CASE  
       WHEN EDT > @EFFDATE + ' 23:59:00'  
       THEN (  
        CASE  
        WHEN DRCR = 'D'  
        THEN -VAMT  
        ELSE 0  
        END  
      )  
     ELSE 0  
     END  
     ),  
  BSELEDBAL = 0,  
  FNOLEDBAL = 0,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  ACCOUNT..LEDGER L WITH(NOLOCK)  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'  
 GROUP BY   
  A.BRANCHCODE,  
  L.CLTCODE,  
  A.LONGNAME,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  A.PAYMODE,  
  A.POBANKCODE,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
  
 UNION ALL  
  
 SELECT  
  L.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT ,  
  TOTLEDBAL = 0,  
  NSELEDBAL = SUM(  
     CASE  
     WHEN DRCR = 'D'  
     THEN VAMT  
     ELSE -VAMT  
     END  
     ),  
  BSELEDBAL = 0,  
  FNOLEDBAL = 0,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  ACCOUNT..LEDGER L WITH(NOLOCK)  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND L.EDT >= @SDATE  
  AND L.VDT < @SDATE  
 GROUP BY   
  A.BRANCHCODE,  
  L.CLTCODE,  
  A.LONGNAME,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  A.PAYMODE,  
  A.POBANKCODE,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
  
 /*============================================================================  
 CALCULATE BSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER  
 ============================================================================*/  
 INSERT INTO   
  #LEDGERBALANCE  
 SELECT  
  L.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT ,  
  TOTLEDBAL = 0,  
  NSELEDBAL = 0,  
  BSELEDBAL = SUM(  
     CASE  
     WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'  
     THEN (  
      CASE  
      WHEN DRCR = 'D'  
      THEN -VAMT  
      ELSE VAMT  
      END  
     )  
     ELSE 0  
     END  
     ) + SUM(  
       CASE  
       WHEN EDT > @EFFDATE + ' 23:59:00'  
       THEN (  
       CASE  
       WHEN DRCR = 'D'  
       THEN -VAMT  
       ELSE 0  
       END  
      )  
     ELSE 0  
     END  
     ),  
  FNOLEDBAL = 0,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  ACCOUNTBSE..LEDGER L WITH(NOLOCK)  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'  
 GROUP BY   
  A.BRANCHCODE,  
  L.CLTCODE,  
  A.LONGNAME,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  A.PAYMODE,  
  A.POBANKCODE,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
  
 UNION ALL  
  
 SELECT  
  L.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT ,  
  TOTLEDBAL = 0,  
  NSELEDBAL = 0,  
  BSELEDBAL = SUM(  
     CASE  
     WHEN DRCR = 'D'  
     THEN VAMT  
     ELSE -VAMT  
     END  
     ),  
  FNOLEDBAL = 0,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  ACCOUNTBSE..LEDGER L WITH(NOLOCK)  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND L.EDT >= @SDATE  
  AND L.VDT < @SDATE  
 GROUP BY   
  A.BRANCHCODE,  
  L.CLTCODE,  
  A.LONGNAME,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  A.PAYMODE,  
  A.POBANKCODE,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
  
 /*================================================================================  
 CALCULATE NSE DERIVATIVE LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER  
 ================================================================================*/  
 INSERT INTO   
  #LEDGERBALANCE  
 SELECT  
  L.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT ,  
  TOTLEDBAL = 0,  
  NSELEDBAL = 0,  
  BSELEDBAL = 0,  
  FNOLEDBAL = SUM(  
     CASE  
     WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'  
     THEN (  
      CASE  
      WHEN DRCR = 'D'  
      THEN -VAMT  
      ELSE VAMT  
      END  
     )  
     ELSE 0  
     END  
     ) + SUM(  
       CASE  
       WHEN EDT > @EFFDATE + ' 23:59:00'  
       THEN (  
       CASE  
       WHEN DRCR = 'D'  
       THEN -VAMT  
       ELSE 0  
       END  
      )  
     ELSE 0  
     END  
     ),  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  ACCOUNTFO..LEDGER L WITH(NOLOCK)  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'  
 GROUP BY   
  A.BRANCHCODE,  
  L.CLTCODE,  
  A.LONGNAME,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  A.PAYMODE,  
  A.POBANKCODE,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
  
 UNION ALL  
  
 SELECT  
  L.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT ,  
  TOTLEDBAL = 0,  
  NSELEDBAL = 0,  
  BSELEDBAL = 0,  
  FNOLEDBAL = SUM(  
     CASE  
     WHEN DRCR = 'D'  
     THEN VAMT  
     ELSE -VAMT  
     END  
     ),  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  ACCOUNTFO..LEDGER L WITH(NOLOCK)  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND L.EDT >= @SDATE  
  AND L.VDT < @SDATE  
 GROUP BY   
  A.BRANCHCODE,  
  L.CLTCODE,  
  A.LONGNAME,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  A.PAYMODE,  
  A.POBANKCODE,  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
  
 /*==========================================================================  
 STORE NSE DERIVATIVE COLLATERAL & MARGIN BALANCES FOR CLIENTS  
 ==========================================================================*/  
 TRUNCATE TABLE FNOLEDBAL  
  
        SELECT   
                PARTY_CODE = CLTCODE,  
                SPANMARGIN,  
                EXPOSUREMARGIN,  
                CASH,  
                NONCASH,    
                MDATE = MARGIN_DATE  
        INTO #FNOLEDBAL   
        FROM FNOLEDBAL   
        WHERE 1=2  
  
 INSERT INTO   
  #FNOLEDBAL  
        SELECT   
  PARTY_CODE = LTRIM(RTRIM(M.PARTY_CODE)),  
  SPANMARGIN = -(M.TOTALMARGIN),  
  EXPOSUREMARGIN = -(M.MTOM),  
  CASH = 0,  
  NONCASH = 0,  
  MDATE = MDATE  
        FROM   
  NSEFO..FOMARGINNEW M WITH(NOLOCK)  
        WHERE           
  M.MDATE = (SELECT MAX(MDATE) FROM NSEFO..FOMARGINNEW WHERE MDATE <= LEFT(GETDATE(),11))  
  
 INSERT INTO   
  #FNOLEDBAL  
        SELECT   
  PARTY_CODE = LTRIM(RTRIM(C.PARTY_CODE)),  
  SPANMARGIN = 0,  
  EXPOSUREMARGIN = 0,  
  CASH = C.CASH,  
  NONCASH = C.NONCASH,  
  MDATE = TRANS_DATE  
        FROM   
  MSAJAG..COLLATERAL C WITH(NOLOCK)  
        WHERE           
  C.TRANS_DATE = (SELECT MAX(TRANS_DATE) FROM MSAJAG..COLLATERAL WHERE TRANS_DATE <= LEFT(GETDATE(),11) AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES')  
  
 INSERT INTO   
  FNOLEDBAL  
 SELECT  
  CLTCODE = A.CLTCODE,  
  FNO_TOTALBAL = 0,  
  FNO_LEDBAL = 0,  
  FNO_COLLATERAL = SUM(L.CASH + L.NONCASH),  
  FNO_MARGIN = SUM(L.SPANMARGIN),  
  MARGIN_DATE = MAX(MDATE),  
  SPANMARGIN = SUM(L.SPANMARGIN),  
  EXPOSUREMARGIN = SUM(L.EXPOSUREMARGIN),  
  CASH = SUM(L.CASH),  
  NONCASH = SUM(L.NONCASH)  
 FROM   
  #LEDGERBILLTMP A WITH(NOLOCK),  
  (  
  SELECT  
   PARTY_CODE,  
   SPANMARGIN = SUM(SPANMARGIN),  
   EXPOSUREMARGIN = SUM(EXPOSUREMARGIN),   
   CASH = SUM(CASH),   
   NONCASH = SUM(NONCASH),   
   MDATE = MAX(MDATE)  
  FROM  
   #FNOLEDBAL  
                GROUP BY   
                        PARTY_CODE   
  ) L  
 WHERE  
  L.PARTY_CODE = A.CLTCODE  
 GROUP BY  
  A.CLTCODE  
  
  
 UPDATE  
  F  
 SET  
  FNO_TOTALBAL = FNOLEDBAL + (SPANMARGIN + EXPOSUREMARGIN + CASH + NONCASH),  
  FNO_LEDBAL = FNOLEDBAL  
 FROM  
  FNOLEDBAL F,  
  (SELECT PARTYCODE, FNOLEDBAL = SUM(FNOLEDBAL) FROM #LEDGERBALANCE GROUP BY PARTYCODE) L  
 WHERE  
  F.CLTCODE = L.PARTYCODE  
  
  
 /*===========================================================================  
 CALCULATE NSE DERIVATIVE MARGIN REQUIREMENT AFTER ADJUSTING COLLATERAL  
 ONLY IF -VE I.E. DEBIT  
 ===========================================================================*/  
 INSERT INTO   
  #LEDGERBALANCE  
 SELECT  
  A.CLTCODE,  
  ACNAME = A.LONGNAME,  
  CHEQUENAME = A.LONGNAME,  
  A.BRANCHCODE,  
  A.ACCAT,  
  A.BTOBPAYMENT,  
  TOTLEDBAL = 0,  
  NSELEDBAL = 0,  
  BSELEDBAL = 0,  
  FNOLEDBAL = (CASE C.IMEXPOFLAG  
     WHEN '11' THEN L.SPANMARGIN + L.EXPOSUREMARGIN  
     WHEN '10' THEN L.SPANMARGIN  
     WHEN '01' THEN L.EXPOSUREMARGIN  
     ELSE 0 END)  
    + (L.CASH + L.NONCASH),  
  A.SETT_NO,  
  A.NORMALBILLAMT,  
  A.T2TBILLAMT,  
  BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,  
  FUTUREPAYOUT = 0 ,  
  SHORTAGE = 0,  
  AMOUNTTOBEPAID = 0,  
  A.PAYMODE,  
  A.POBANKCODE,  
  GENFLAG = @GENFLAG,  
  A.CLIENTTYPE,    
  A.FAMILYCODE,    
  RUNDATE  
 FROM  
  #LEDGERBILLTMP A WITH(NOLOCK),  
  FNOLEDBAL L WITH(NOLOCK),  
  (SELECT CL_TYPE, IMEXPOFLAG = FUNDS_FNO_IM + FUNDS_FNO_EXP FROM MSAJAG..CLIENTTYPE) C  
 WHERE   
  L.CLTCODE = A.CLTCODE  
  AND A.CLIENTTYPE = C.CL_TYPE  
  AND C.IMEXPOFLAG <> '00'  
                AND (CASE C.IMEXPOFLAG  
     WHEN '11' THEN L.SPANMARGIN + L.EXPOSUREMARGIN  
     WHEN '10' THEN L.SPANMARGIN  
     WHEN '01' THEN L.EXPOSUREMARGIN  
     ELSE 0 END)  
    + (L.CASH + L.NONCASH) <= 0  
  
 IF @COMP_FOR = 'ONLINE'  
 BEGIN  
  SELECT  
   PARTYCODE,  
   BRANCHCODE,  
   LEDGERBALNSE = SUM(NSELEDBAL),  
   LEDGERBALBSE = SUM(BSELEDBAL),  
   LEDGERBALFNO = SUM(FNOLEDBAL),  
   LEDGERBALTOT = SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL)  
  INTO  
   #LEDGERBALANCETOT  
  FROM  
   #LEDGERBALANCE  
  GROUP BY  
   PARTYCODE,  
   BRANCHCODE  
  
  UPDATE  
   P  
  SET  
   LEDGERBALNSE = L.LEDGERBALNSE,  
   LEDGERBALBSE = L.LEDGERBALBSE,  
   LEDGERBALFNO = L.LEDGERBALFNO,  
   LEDGERBALTOT = L.LEDGERBALTOT,  
   BRANCHCODE = L.BRANCHCODE  
  FROM  
   V2_ONLINEPAYOUT P, #LEDGERBALANCETOT L  
  WHERE  
   P.CLIENT_CODE = L.PARTYCODE  
 END  
  
 /*===========================================================================  
 INSERT INTO PHYSICAL TABLE FROM TEMP TABLE AFTER GROUPING AS REQUIRED  
 ===========================================================================*/  
  
  
 CREATE TABLE [DBO].[#V2_LEDGERBALANCE](  
  [SNO] [bigint] IDENTITY(1,1) NOT NULL,   
  [PARTYCODE] [VARCHAR](10) NULL,  
  [PARTYNAME] [VARCHAR](100) NULL,  
  [CHEQUENAME] [VARCHAR](100) NULL,  
  [BRANCHCODE] [VARCHAR](10) NULL,  
  [ACCAT] [VARCHAR](10) NULL,  
  [BTOBPAYMENT] [INT] NULL,  
  [TOTLEDBAL] [MONEY] NULL,  
  [NSELEDBAL] [MONEY] NULL,  
  [BSELEDBAL] [MONEY] NULL,  
  [FNOLEDBAL] [MONEY] NULL,  
  [NETLEDBAL] [MONEY] NULL,  
  [FAMLEDBAL] [MONEY] NULL,  
  [SETT_NO] [VARCHAR](7) NULL,  
  [NORMALBILLAMT] [MONEY] NULL,  
  [T2TBILLAMT] [MONEY] NULL,  
  [BILLAMT] [MONEY] NULL,  
  [FUTUREPAYOUT] [MONEY] NULL,  
  [SHORTAGE] [MONEY] NULL,  
  [AMOUNTTOBEPAID] [MONEY] NULL,  
  [PAYMODE] [VARCHAR](1) NULL,  
  [BANKCODE] [VARCHAR](10) NULL,  
  [GENFLAG] [VARCHAR](1) NULL,  
  [CLIENTTYPE] [VARCHAR](3) NULL,  
  [FAMILYCODE] [VARCHAR](10) NULL,  
  [RUNDATE] [DATETIME] NULL  
 ) ON [PRIMARY]  
  
 INSERT INTO #V2_LEDGERBALANCE   
 SELECT  
  PARTYCODE,  
  PARTYNAME,  
  CHEQUENAME,  
  BRANCHCODE,  
  ACCAT,  
  BTOBPAYMENT,   
        TOTLEDBAL = 0,                                   
  NSELEDBAL = SUM(NSELEDBAL),  
  BSELEDBAL = SUM(BSELEDBAL),  
  FNOLEDBAL = SUM(FNOLEDBAL),  
        NETLEDBAL = CASE @EXCHANGE + @SEGMENT   
     WHEN 'NSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--NSE  
     WHEN 'BSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--BSE  
     WHEN 'NSEFUTURES' THEN SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL)--NFO  
     ELSE 0 END,                                   
  FAMLEDBAL = ISNULL(FAMLEDBAL,0),   
  SETT_NO,  
  NORMALBILLAMT,  
  T2TBILLAMT,  
  BILLAMT,  
  FUTUREPAYOUT,  
  SHORTAGE,  
  AMOUNTTOBEPAID,  
  PAYMODE,  
  BANKCODE,  
  GENFLAG,  
  CLIENTTYPE,  
  L.FAMILYCODE,   
  RUNDATE   
 FROM   
  #LEDGERBALANCE L LEFT OUTER JOIN    
  /*===========================================================================  
  FAMILY LEVEL BALANCES   
  ===========================================================================*/  
  (  
   SELECT   
    FAMILYCODE,   
    FAMLEDBAL = CASE @EXCHANGE + @SEGMENT   
       WHEN 'NSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--NSE  
       WHEN 'BSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--BSE  
       WHEN 'NSEFUTURES' THEN SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL)--NFO  
       ELSE 0 END   
   FROM   
    #LEDGERBALANCE  
   GROUP BY                                    
    FAMILYCODE   
  ) F   
  ON L.FAMILYCODE = F.FAMILYCODE   
 GROUP BY   
  PARTYCODE,  
  PARTYNAME,  
  CHEQUENAME,  
  BRANCHCODE,  
  ACCAT,  
  BTOBPAYMENT,  
  SETT_NO,  
  NORMALBILLAMT,  
  T2TBILLAMT,  
  BILLAMT,  
  FUTUREPAYOUT,  
  SHORTAGE,  
  AMOUNTTOBEPAID,  
  PAYMODE,  
  BANKCODE,  
  GENFLAG,  
  CLIENTTYPE,    
  L.FAMILYCODE,   
  FAMLEDBAL,   
  RUNDATE  
  
  
 UPDATE #V2_LEDGERBALANCE SET FAMLEDBAL = A.FAMLEDBAL   
 FROM   
 (  
  SELECT SNO, --PARTYCODE, FAMILYCODE,    
  FAMLEDBAL = FAMLEDBAL -   
      (SELECT ISNULL(SUM(ISNULL(TOTLEDBAL,0)),0)   
      FROM #V2_LEDGERBALANCE V1   
      WHERE V1.FAMILYCODE = V.FAMILYCODE   
      AND V1.SNO < V.SNO  
      AND TOTLEDBAL > 0)  
  FROM #V2_LEDGERBALANCE V  
  WHERE TOTLEDBAL > 0   
 ) A,   
 (  
 SELECT FAMILYCODE FROM #V2_LEDGERBALANCE GROUP BY FAMILYCODE HAVING COUNT(1) > 1   
 ) B   
 WHERE #V2_LEDGERBALANCE.SNO = A.SNO  
 AND A.FAMLEDBAL > 0   
 AND #V2_LEDGERBALANCE.FAMILYCODE = B.FAMILYCODE   
  
 UPDATE #V2_LEDGERBALANCE   
 SET TOTLEDBAL =   
    (CASE   
     WHEN FAMLEDBAL < 0 OR FAMLEDBAL < NETLEDBAL   
     THEN FAMLEDBAL   
     ELSE NETLEDBAL   
    END)   
  
 SELECT   
  PARTYCODE,PARTYNAME,CHEQUENAME,BRANCHCODE,ACCAT,BTOBPAYMENT,  
  TOTLEDBAL,NSELEDBAL,BSELEDBAL,FNOLEDBAL,NETLEDBAL,FAMLEDBAL,  
  SETT_NO,NORMALBILLAMT,T2TBILLAMT,BILLAMT,FUTUREPAYOUT,SHORTAGE,AMOUNTTOBEPAID,  
  PAYMODE,BANKCODE,GENFLAG,CLIENTTYPE,FAMILYCODE,RUNDATE   
 FROM #V2_LEDGERBALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_GETLEDGERBALANCE_COMBINED
-- --------------------------------------------------


CREATE PROCEDURE V2_GETLEDGERBALANCE_COMBINED
(
	@SDATE VARCHAR(11),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@USER VARCHAR(25),
	@SERVERFR VARCHAR(15),
	@SERVERTO VARCHAR(15),
	@EFFDATE VARCHAR(11),	
	@COMP_FOR VARCHAR(6) = 'BRANCH' -- COMPUTATION FOR BRANCH REQUESTING / ONLINE CLIENTS PAYOUT
)

AS

	/*===========================================================================
		---------------------------------------------------------------------
		FNO CREDIT BALANCES AFTER ADJUSTING
		MARGIN REQUIREMENT & COLLATERAL
		TO BE CONSIDERED WHILE COMPUTING NET BALANCE
		---------------------------------------------------------------------
		EXEC V2_GETLEDGERBALANCE_COMBINED
			@SDATE = 'APR  1 2005',
			@FPARTY = '',
			@TPARTY = '',			
			@USER = 'PM',
			@SERVERFR = '[10.11.12.27]',
			@SERVERTO = '[10.11.12.27]',
			@EFFDATE = 'MAR 31 2008',
			@COMP_FOR = 'BRANCH'

		EXEC V2_GETLEDGERBALANCE_COMBINED
			@SDATE = 'APR  1 2005',
			@FPARTY = '',
			@TPARTY = '',			
			@USER = 'PM',
			@SERVERFR = '[10.11.12.27]',
			@SERVERTO = '[10.11.12.27]',
			@EFFDATE = 'MAR 31 2008',
			@COMP_FOR = 'JV'

		SELECT * FROM V2_LEDGERBALANCE_COMBINED

		SELECT PARTYCODE FROM V2_LEDGERBALANCE_COMBINED GROUP BY PARTYCODE HAVING COUNT(*) > 1		

		SELECT * FROM FT_LEDGERBALANCE
	===========================================================================*/

	SET NOCOUNT ON

	IF @FPARTY = '' SET @FPARTY = '0000000000'

	IF @TPARTY = '' SET @TPARTY = 'ZZZZZZZZZZ'

	IF @EFFDATE = '' SET @EFFDATE = CONVERT(VARCHAR(11), GETDATE())

	DECLARE @@RECCOUNT INT
	SET @@RECCOUNT = 0
	SELECT @@RECCOUNT = COUNT(1) FROM V2_SETTPAYOUT WHERE LEFT(REQUESTDT,11) = LEFT(GETDATE(),11) AND STATUS IN ('P', 'I')

	IF @COMP_FOR = 'BRANCH'
	BEGIN
		IF @@RECCOUNT <> 0
		BEGIN
			SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO RECALCULATE ::'
			RETURN
		END

		ELSE
		BEGIN
			UPDATE V2_PAYOUT_GLOBALPARAMS SET POFLAG = 'N'

			DELETE
				V2_LEDGERBALANCE_COMBINED
			WHERE 
				PARTYCODE BETWEEN @FPARTY AND @TPARTY
		END
     END 	

	DECLARE
		@@SQL AS VARCHAR(5000)
	
	/*===========================================================================
	CREATE # TABLES FOR CANNED LEDGER BALANCES AND BILL AMOUNTS
	===========================================================================*/
	CREATE TABLE #LEDGERBALANCE
	(
		PARTYCODE VARCHAR(10),
		PARTYNAME VARCHAR(100),
		CHEQUENAME VARCHAR(100),
		BRANCHCODE VARCHAR(10),
		ACCAT VARCHAR(10),
		BTOBPAYMENT INT,
		NSE_VDTLEDBAL MONEY,
		NSE_EDTLEDBAL MONEY,
		NSE_POLEDBAL MONEY,
		NFO_EDTLEDBAL MONEY,
		NFO_MARGINBAL MONEY,
		NFO_POLEDBAL MONEY,		
		PAYMODE VARCHAR(1),
		NSE_BANKCODE VARCHAR(10),
		NFO_BANKCODE VARCHAR(10),
		CLIENTTYPE VARCHAR(3),
		RUNDATE DATETIME,
		SUB_BROKER VARCHAR(10) NULL,
		BILLAMT MONEY NULL
	)

	CREATE INDEX [PARTYCODE] ON [DBO].[#LEDGERBALANCE]([PARTYCODE]) ON [PRIMARY]

	CREATE TABLE [#LEDGERBILLTMP]
	(
		[CLTCODE] [VARCHAR] (10)  NULL,
		[BRANCHCODE] [VARCHAR] (10)  NULL,
		[LONGNAME] [VARCHAR] (100)  NULL,
		[ACCAT] [CHAR] (10)  NULL,
		[BTOBPAYMENT] [INT] NULL,
		[PAYMODE] [CHAR] (1)  NULL,
		[CM_POBANKCODE] [VARCHAR] (10)  NULL,
		[FO_POBANKCODE] [VARCHAR] (10)  NULL,
		[CLIENTTYPE] [VARCHAR] (3),
		[RUNDATE] [DATETIME],
		[SUB_BROKER] [VARCHAR] (10) NULL
	) ON [PRIMARY]

	CREATE INDEX [CLTCODE] ON [DBO].[#LEDGERBILLTMP]([CLTCODE]) ON [PRIMARY]

	IF @COMP_FOR = 'BRANCH' OR @COMP_FOR = 'JV'
	BEGIN		
		INSERT INTO
			#LEDGERBILLTMP
		SELECT
			A.CLTCODE,
			A.BRANCHCODE,
			LONGNAME,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,
			POBANKCODE,
			'',			
			CLIENTTYPE = '',
			RUNDATE = GETDATE(),
			SUB_BROKER = ''
		FROM
			ACMAST A WITH(NOLOCK)
		WHERE
			A.CLTCODE BETWEEN @FPARTY AND @TPARTY
			AND A.ACCAT IN (4, 104)			
		GROUP BY
			A.CLTCODE,
			A.BRANCHCODE,
			LONGNAME,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,
			POBANKCODE

		UPDATE
			#LEDGERBILLTMP
		SET
			CLIENTTYPE = C1.CL_TYPE,
			SUB_BROKER = C1.SUB_BROKER
		FROM
			MSAJAG..CLIENT1 C1,
			MSAJAG..CLIENT2 C2,
			MSAJAG..CLIENTTYPE C3
		WHERE
			CLTCODE = C2.PARTY_CODE
			AND C1.CL_CODE = C2.CL_CODE
			AND C1.CL_TYPE = C3.CL_TYPE	
	END		

	IF @COMP_FOR = 'HO'
	BEGIN
		INSERT INTO
			#LEDGERBILLTMP
		SELECT
			A.CLTCODE,
			A.BRANCHCODE,
			LONGNAME,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,
			POBANKCODE,
			'',
			CLIENTTYPE = '',
			RUNDATE = GETDATE(),
			SUB_BROKER = ''
		FROM
			ACMAST A WITH(NOLOCK),
			V2_SETTPAYOUT P WITH(NOLOCK)
		WHERE
			A.CLTCODE = P.CLTCODE
			AND A.CLTCODE BETWEEN @FPARTY AND @TPARTY
			AND A.ACCAT IN (4, 104)
			AND STATUS IN ('P', 'I')
            AND A.POBANKCODE IN
			(
				SELECT
					CLTCODE
				FROM 
					ACMAST WITH(NOLOCK)
				WHERE 
					ACCAT = 2
			)            
		GROUP BY
			A.CLTCODE,
			A.BRANCHCODE,
			LONGNAME,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,
			POBANKCODE		

		UPDATE
			#LEDGERBILLTMP
		SET
			CLIENTTYPE = C1.CL_TYPE,
			SUB_BROKER = C1.SUB_BROKER
		FROM
			MSAJAG..CLIENT1 C1,
			MSAJAG..CLIENT2 C2,
			MSAJAG..CLIENTTYPE C3
		WHERE
			CLTCODE = C2.PARTY_CODE
			AND C1.CL_CODE = C2.CL_CODE
			AND C1.CL_TYPE = C3.CL_TYPE
	END

	/*============================================================================
	CALCULATE NSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER
	============================================================================*/
	SELECT @@SQL = ""

	SELECT @@SQL = @@SQL + "UPDATE L "
	SELECT @@SQL = @@SQL + "SET FO_POBANKCODE = POBANKCODE "
	SELECT @@SQL = @@SQL + "FROM #LEDGERBILLTMP L, " + @SERVERTO + ".ACCOUNTFO.DBO.ACMAST A "
	SELECT @@SQL = @@SQL + "WHERE L.CLTCODE = A.CLTCODE "
	SELECT @@SQL = @@SQL + "AND POBANKCODE IN "
	SELECT @@SQL = @@SQL + "(SELECT CLTCODE FROM " + @SERVERTO + ".ACCOUNTFO.DBO.ACMAST WHERE ACCAT = 2) "

	SELECT @@SQL = @@SQL + "INSERT INTO "
	SELECT @@SQL = @@SQL + "	#LEDGERBALANCE "
	SELECT @@SQL = @@SQL + "SELECT "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	ACNAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	CHEQUENAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	NSE_VDTLEDBAL = SUM( "
	SELECT @@SQL = @@SQL + "				CASE "
	SELECT @@SQL = @@SQL + "				WHEN VDT BETWEEN '" + @SDATE + " 00:00:00' AND '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "				THEN ( "
	SELECT @@SQL = @@SQL + "					CASE "
	SELECT @@SQL = @@SQL + "					WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "					THEN -VAMT "
	SELECT @@SQL = @@SQL + "					ELSE VAMT "
	SELECT @@SQL = @@SQL + "					END "
	SELECT @@SQL = @@SQL + "				) "
	SELECT @@SQL = @@SQL + "				ELSE 0 "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				), "
	SELECT @@SQL = @@SQL + "	NSE_EDTLEDBAL = SUM( "
	SELECT @@SQL = @@SQL + "				CASE "
	SELECT @@SQL = @@SQL + "				WHEN EDT BETWEEN '" + @SDATE + " 00:00:00' AND '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "				THEN ( "
	SELECT @@SQL = @@SQL + "					CASE "
	SELECT @@SQL = @@SQL + "					WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "					THEN -VAMT "
	SELECT @@SQL = @@SQL + "					ELSE VAMT "
	SELECT @@SQL = @@SQL + "					END "
	SELECT @@SQL = @@SQL + "				) "
	SELECT @@SQL = @@SQL + "				ELSE 0 "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				) + SUM( "
	SELECT @@SQL = @@SQL + "						CASE "
	SELECT @@SQL = @@SQL + "						WHEN EDT > '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "						THEN ( "
	SELECT @@SQL = @@SQL + "							CASE "
	SELECT @@SQL = @@SQL + "							WHEN  DRCR = 'D' "
	SELECT @@SQL = @@SQL + "							THEN -VAMT "
	SELECT @@SQL = @@SQL + "							ELSE 0 "
	SELECT @@SQL = @@SQL + "							END "
	SELECT @@SQL = @@SQL + "					) "
	SELECT @@SQL = @@SQL + "				ELSE 0 "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				), "
	SELECT @@SQL = @@SQL + "	NSE_POLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_EDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_MARGINBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_POLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	A.CM_POBANKCODE, "	
	SELECT @@SQL = @@SQL + "	'', "
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER, "
	SELECT @@SQL = @@SQL + "	BILLAMT = SUM( "
	SELECT @@SQL = @@SQL + "				CASE "
	SELECT @@SQL = @@SQL + "					WHEN VTYP IN (15, 21) AND EDT LIKE CONVERT(VARCHAR(11), GETDATE()) + '%' "
	SELECT @@SQL = @@SQL + "				THEN ( "
	SELECT @@SQL = @@SQL + "					CASE "
	SELECT @@SQL = @@SQL + "					WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "					THEN -VAMT "
	SELECT @@SQL = @@SQL + "					ELSE VAMT "
	SELECT @@SQL = @@SQL + "					END "
	SELECT @@SQL = @@SQL + "				) "
	SELECT @@SQL = @@SQL + "				ELSE 0 "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				) "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	#LEDGERBILLTMP A WITH(NOLOCK), "
	SELECT @@SQL = @@SQL + @SERVERFR + ".ACCOUNT.DBO.LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	L.CLTCODE = A.CLTCODE "
	SELECT @@SQL = @@SQL + "	AND L.VDT BETWEEN '" + @SDATE + " 00:00:00' AND '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "GROUP BY "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	A.CM_POBANKCODE, "	
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER "

	SELECT @@SQL = @@SQL + "UNION ALL "

	SELECT @@SQL = @@SQL + "SELECT "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	ACNAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	CHEQUENAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	NSE_VDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NSE_EDTLEDBAL = SUM( "
	SELECT @@SQL = @@SQL + "				CASE "
	SELECT @@SQL = @@SQL + "				WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "				THEN VAMT "
	SELECT @@SQL = @@SQL + "				ELSE -VAMT "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				), "
	SELECT @@SQL = @@SQL + "	NSE_POLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_EDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_MARGINBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_POLEDBAL = 0, "	
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	A.CM_POBANKCODE, "	
	SELECT @@SQL = @@SQL + "	'', "
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER, "
	SELECT @@SQL = @@SQL + "	BILLAMT = 0 "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	#LEDGERBILLTMP A WITH(NOLOCK), "
	SELECT @@SQL = @@SQL + @SERVERFR + ".ACCOUNT.DBO.LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	L.CLTCODE = A.CLTCODE "
	SELECT @@SQL = @@SQL + "	AND L.EDT >= '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "	AND L.VDT < '" + @SDATE + "' "
	SELECT @@SQL = @@SQL + "GROUP BY "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	A.CM_POBANKCODE, "	
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER "

	/*================================================================================
	CALCULATE NSE DERIVATIVE LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER
	================================================================================*/
	SELECT @@SQL = @@SQL + "INSERT INTO "
	SELECT @@SQL = @@SQL + "	#LEDGERBALANCE "
	SELECT @@SQL = @@SQL + "SELECT "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	ACNAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	CHEQUENAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	NSE_VDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NSE_EDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NSE_POLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_EDTLEDBAL = SUM( "
	SELECT @@SQL = @@SQL + "				CASE "
	SELECT @@SQL = @@SQL + "				WHEN EDT BETWEEN '" + @SDATE + " 00:00:00' AND '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "				THEN ( "
	SELECT @@SQL = @@SQL + "					CASE "
	SELECT @@SQL = @@SQL + "					WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "					THEN -VAMT "
	SELECT @@SQL = @@SQL + "					ELSE VAMT "
	SELECT @@SQL = @@SQL + "					END "
	SELECT @@SQL = @@SQL + "				) "
	SELECT @@SQL = @@SQL + "				ELSE 0 "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				) + SUM( "
	SELECT @@SQL = @@SQL + "						CASE "
	SELECT @@SQL = @@SQL + "						WHEN EDT > '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "						THEN ( "
	SELECT @@SQL = @@SQL + "						CASE "
	SELECT @@SQL = @@SQL + "						WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "						THEN -VAMT "
	SELECT @@SQL = @@SQL + "						ELSE 0 "
	SELECT @@SQL = @@SQL + "						END "
	SELECT @@SQL = @@SQL + "					) "
	SELECT @@SQL = @@SQL + "				ELSE 0 "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				), "
	SELECT @@SQL = @@SQL + "	NFO_MARGINBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_POLEDBAL = 0, "	
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	'', "
	SELECT @@SQL = @@SQL + "	A.FO_POBANKCODE, "
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER, "
	SELECT @@SQL = @@SQL + "	BILLAMT = 0 "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	#LEDGERBILLTMP A WITH(NOLOCK), "
	SELECT @@SQL = @@SQL + @SERVERTO + ".ACCOUNTFO.DBO.LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	L.CLTCODE = A.CLTCODE "
	SELECT @@SQL = @@SQL + "	AND L.VDT BETWEEN '" + @SDATE + " 00:00:00' AND '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "GROUP BY "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	A.FO_POBANKCODE, "	
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER "

	SELECT @@SQL = @@SQL + "UNION ALL "

	SELECT @@SQL = @@SQL + "SELECT "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	ACNAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	CHEQUENAME = A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	NSE_VDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NSE_EDTLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NSE_POLEDBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_EDTLEDBAL = SUM( "
	SELECT @@SQL = @@SQL + "				CASE "
	SELECT @@SQL = @@SQL + "				WHEN DRCR = 'D' "
	SELECT @@SQL = @@SQL + "				THEN VAMT "
	SELECT @@SQL = @@SQL + "				ELSE -VAMT "
	SELECT @@SQL = @@SQL + "				END "
	SELECT @@SQL = @@SQL + "				), "
	SELECT @@SQL = @@SQL + "	NFO_MARGINBAL = 0, "
	SELECT @@SQL = @@SQL + "	NFO_POLEDBAL = 0, "	
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	'', "
	SELECT @@SQL = @@SQL + "	A.FO_POBANKCODE, "
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER, "
	SELECT @@SQL = @@SQL + "	BILLAMT = 0 "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	#LEDGERBILLTMP A WITH(NOLOCK), "
	SELECT @@SQL = @@SQL + @SERVERTO + ".ACCOUNTFO.DBO.LEDGER L "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	L.CLTCODE = A.CLTCODE "
	SELECT @@SQL = @@SQL + "	AND L.EDT >= '" + @EFFDATE + " 23:59:00' "
	SELECT @@SQL = @@SQL + "	AND L.VDT < '" + @SDATE + "' "
	SELECT @@SQL = @@SQL + "GROUP BY "
	SELECT @@SQL = @@SQL + "	A.BRANCHCODE, "
	SELECT @@SQL = @@SQL + "	L.CLTCODE, "
	SELECT @@SQL = @@SQL + "	A.LONGNAME, "
	SELECT @@SQL = @@SQL + "	A.ACCAT, "
	SELECT @@SQL = @@SQL + "	A.BTOBPAYMENT, "
	SELECT @@SQL = @@SQL + "	A.PAYMODE, "
	SELECT @@SQL = @@SQL + "	A.FO_POBANKCODE, "	
	SELECT @@SQL = @@SQL + "	A.CLIENTTYPE, "
	SELECT @@SQL = @@SQL + "	RUNDATE, "
	SELECT @@SQL = @@SQL + "	SUB_BROKER "

	EXEC (@@SQL)

	/*==========================================================================
	STORE NSE DERIVATIVE COLLATERAL & MARGIN BALANCES FOR CLIENTS
	==========================================================================*/	
	TRUNCATE TABLE FNOLEDBAL

	SELECT
		PARTY_CODE = CLTCODE,
		SPANMARGIN,
		EXPOSUREMARGIN,
		CASH,
		NONCASH,
		MDATE = MARGIN_DATE
	INTO #FNOLEDBAL
	FROM FNOLEDBAL
	WHERE 1=2

	INSERT INTO
		#FNOLEDBAL
	SELECT
		PARTY_CODE = LTRIM(RTRIM(M.PARTY_CODE)),
		SPANMARGIN = -(M.TOTALMARGIN),
		EXPOSUREMARGIN = -(M.MTOM),
		CASH = 0,
		NONCASH = 0,
		MDATE = MDATE
	FROM
		NSEFO..FOMARGINNEW M WITH(NOLOCK)
	WHERE
		M.MDATE = (SELECT MAX(MDATE) FROM NSEFO..FOMARGINNEW WHERE MDATE <= LEFT(GETDATE(),11))

	INSERT INTO
		#FNOLEDBAL
	SELECT
		PARTY_CODE = LTRIM(RTRIM(C.PARTY_CODE)),
		SPANMARGIN = 0,
		EXPOSUREMARGIN = 0,
		CASH = C.CASH,
		NONCASH = C.NONCASH,
		MDATE = TRANS_DATE
	FROM
		MSAJAG..COLLATERAL C WITH(NOLOCK)
	WHERE
		C.TRANS_DATE = (SELECT MAX(TRANS_DATE) FROM MSAJAG..COLLATERAL WHERE TRANS_DATE <= LEFT(GETDATE(),11) AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES')

	INSERT INTO
		FNOLEDBAL
	SELECT
		CLTCODE = A.CLTCODE,
		NFO_TOTALBAL = 0,
		NFO_LEDBAL = 0,
		NFO_COLLATERAL = SUM(L.CASH + L.NONCASH),
		NFO_MARGIN = SUM(L.SPANMARGIN),
		MARGIN_DATE = MAX(MDATE),
		SPANMARGIN = SUM(L.SPANMARGIN),
		EXPOSUREMARGIN = SUM(L.EXPOSUREMARGIN),
		CASH = SUM(L.CASH),
		NONCASH = SUM(L.NONCASH)
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		(
		SELECT
			PARTY_CODE,
			SPANMARGIN = SUM(SPANMARGIN),
			EXPOSUREMARGIN = SUM(EXPOSUREMARGIN),
			CASH = SUM(CASH),
			NONCASH = SUM(NONCASH),
			MDATE = MAX(MDATE)
		FROM
			#FNOLEDBAL
                GROUP BY
                        PARTY_CODE
		) L
	WHERE
		L.PARTY_CODE = A.CLTCODE
	GROUP BY
		A.CLTCODE

	UPDATE
		F
	SET
		FNO_TOTALBAL = NFO_EDTLEDBAL + (SPANMARGIN + EXPOSUREMARGIN + CASH + NONCASH),
		FNO_LEDBAL = NFO_EDTLEDBAL
	FROM
		FNOLEDBAL F,
		(SELECT PARTYCODE, NFO_EDTLEDBAL = SUM(NFO_EDTLEDBAL) FROM #LEDGERBALANCE GROUP BY PARTYCODE) L
	WHERE
		F.CLTCODE = L.PARTYCODE
	
	/*===========================================================================
	CALCULATE NSE DERIVATIVE MARGIN REQUIREMENT AFTER ADJUSTING COLLATERAL
	ONLY IF -VE I.E. DEBIT
	===========================================================================*/
	INSERT INTO
		#LEDGERBALANCE
	SELECT
		A.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT,		
		NSE_VDTLEDBAL = 0,
		NSE_EDTLEDBAL = 0,
		NSE_POLEDBAL = 0,		
		NFO_EDTLEDBAL = 0,
		NFO_MARGINBAL = (L.SPANMARGIN + L.EXPOSUREMARGIN) + (L.CASH + L.NONCASH),
		NFO_POLEDBAL = 0,		
		A.PAYMODE,
		A.CM_POBANKCODE,
		A.FO_POBANKCODE,
		A.CLIENTTYPE,
		RUNDATE,
		SUB_BROKER,
		BILLAMT = 0 
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		FNOLEDBAL L WITH(NOLOCK)		
	WHERE
		L.CLTCODE = A.CLTCODE		
		AND (L.SPANMARGIN + L.EXPOSUREMARGIN) + (L.CASH + L.NONCASH) <= 0

	/*===========================================================================
	UPDATE ELLIGIBLE PO AMOUNT IN BOTH THE SEGMENTS
	===========================================================================*/
	UPDATE
		#LEDGERBALANCE
	SET
		NSE_POLEDBAL = (CASE WHEN NSE_VDTLEDBAL < NSE_EDTLEDBAL THEN NSE_VDTLEDBAL ELSE NSE_EDTLEDBAL END),
		NFO_POLEDBAL = NFO_EDTLEDBAL +  NFO_MARGINBAL

	IF @COMP_FOR <> 'JV'
	BEGIN
		UPDATE
			#LEDGERBALANCE
		SET
			NSE_POLEDBAL = (CASE WHEN NSE_POLEDBAL < BILLAMT THEN NSE_POLEDBAL ELSE BILLAMT END)
		WHERE
			BTOBPAYMENT IN (1, 2)
	END
	
	/*===========================================================================
	INSERT INTO PHYSICAL TABLE FROM TEMP TABLE AFTER GROUPING AS REQUIRED
	===========================================================================*/
	CREATE TABLE [DBO].[#V2_LEDGERBALANCE](
		[SNO] [BIGINT] IDENTITY(1,1) NOT NULL,
		[PARTYCODE] [VARCHAR](10) NULL,
		[PARTYNAME] [VARCHAR](100) NULL,
		[CHEQUENAME] [VARCHAR](100) NULL,
		[BRANCHCODE] [VARCHAR](10) NULL,
		[ACCAT] [VARCHAR](10) NULL,
		[BTOBPAYMENT] [INT] NULL,		
		[NSE_VDTLEDBAL] [MONEY] NULL,
		[NSE_EDTLEDBAL] [MONEY] NULL,
		[NSE_POLEDBAL] [MONEY] NULL,
		[NFO_EDTLEDBAL] [MONEY] NULL,
		[NFO_MARGINBAL] [MONEY] NULL,
		[NFO_POLEDBAL] [MONEY] NULL,		
		[PAYMODE] [VARCHAR](1) NULL,
		[NSE_BANKCODE] [VARCHAR](10) NULL,		
		[NFO_BANKCODE] [VARCHAR](10) NULL,	
		[CLIENTTYPE] [VARCHAR](3) NULL,
		[RUNDATE] [DATETIME] NULL,
		[SUB_BROKER] [VARCHAR] (10) NULL,
		[BILLAMT] [MONEY] NULL
	) ON [PRIMARY]

	INSERT INTO #V2_LEDGERBALANCE
	SELECT
		PARTYCODE,
		PARTYNAME,
		CHEQUENAME,
		BRANCHCODE,
		ACCAT,
		BTOBPAYMENT,
		NSE_VDTLEDBAL = SUM(NSE_VDTLEDBAL),
		NSE_EDTLEDBAL = SUM(NSE_EDTLEDBAL),
		NSE_POLEDBAL = SUM(NSE_POLEDBAL),
		NFO_EDTLEDBAL = SUM(NFO_EDTLEDBAL),
		NFO_MARGINBAL = SUM(NFO_MARGINBAL),
		NFO_POLEDBAL = SUM(NFO_POLEDBAL),		
		PAYMODE,
		NSE_BANKCODE,
		NFO_BANKCODE,
		CLIENTTYPE,
		RUNDATE,
		SUB_BROKER,
		BILLAMT = SUM(BILLAMT)
	FROM
		#LEDGERBALANCE L
	GROUP BY
		PARTYCODE,
		PARTYNAME,
		CHEQUENAME,
		BRANCHCODE,
		ACCAT,
		BTOBPAYMENT,
		PAYMODE,
		NSE_BANKCODE,
		NFO_BANKCODE,
		CLIENTTYPE,
		RUNDATE,
		SUB_BROKER

	IF @COMP_FOR = 'BRANCH'
	BEGIN
		INSERT INTO 
			V2_LEDGERBALANCE_COMBINED
		SELECT
			PARTYCODE,
			PARTYNAME = MAX(PARTYNAME),
			CHEQUENAME = MAX(CHEQUENAME),
			BRANCHCODE,
			ACCAT,
			BTOBPAYMENT,
			NSE_VDTLEDBAL = SUM(NSE_VDTLEDBAL),
			NSE_EDTLEDBAL = SUM(NSE_EDTLEDBAL),
			NSE_POLEDBAL = SUM(NSE_POLEDBAL),
			NFO_EDTLEDBAL = SUM(NFO_EDTLEDBAL),
			NFO_MARGINBAL = SUM(NFO_MARGINBAL),
			NFO_POLEDBAL = SUM(NFO_POLEDBAL),
			PAYMODE,
			NSE_BANKCODE = MAX(NSE_BANKCODE),
			NFO_BANKCODE = MAX(NFO_BANKCODE),
			CLIENTTYPE,
			RUNDATE,
			SUB_BROKER,
			BILLAMT = SUM(BILLAMT)
		FROM 
			#V2_LEDGERBALANCE
		GROUP BY
			PARTYCODE,			
			BRANCHCODE,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,			
			CLIENTTYPE,
			RUNDATE,
			SUB_BROKER
		HAVING
			SUM(NSE_POLEDBAL) > 0
			OR SUM(NFO_POLEDBAL) > 0

		UPDATE V2_PAYOUT_GLOBALPARAMS SET POFLAG = 'Y'
		
		SELECT ':: UPDATION COMPLETED SUCCESSFULLY ::'
	END
	
	ELSE IF @COMP_FOR = 'JV'
	BEGIN
		TRUNCATE TABLE FT_LEDGERBALANCE

		INSERT INTO			
			FT_LEDGERBALANCE
		SELECT
			PARTYCODE,
			PARTYNAME = MAX(PARTYNAME),
			BRANCHCODE,
			ACCAT,
			BTOBPAYMENT,
			NSE_VDTLEDBAL = SUM(NSE_VDTLEDBAL),
			NSE_EDTLEDBAL = SUM(NSE_EDTLEDBAL),
			NSE_POLEDBAL = SUM(NSE_POLEDBAL),
			NFO_EDTLEDBAL = SUM(NFO_EDTLEDBAL),
			NFO_MARGINBAL = SUM(NFO_MARGINBAL),
			NFO_POLEDBAL = SUM(NFO_POLEDBAL),	
			CLIENTTYPE,
			RUNDATE	
		FROM 
			#V2_LEDGERBALANCE
		GROUP BY
			PARTYCODE,
			BRANCHCODE,
			ACCAT,
			BTOBPAYMENT,
			CLIENTTYPE,
			RUNDATE
	END	

	ELSE
	BEGIN
		SELECT
			PARTYCODE,
			PARTYNAME = MAX(PARTYNAME),
			CHEQUENAME = MAX(CHEQUENAME),
			BRANCHCODE,
			ACCAT,
			BTOBPAYMENT,
			NSE_VDTLEDBAL = SUM(NSE_VDTLEDBAL),
			NSE_EDTLEDBAL = SUM(NSE_EDTLEDBAL),
			NSE_POLEDBAL = SUM(NSE_POLEDBAL),
			NFO_EDTLEDBAL = SUM(NFO_EDTLEDBAL),
			NFO_MARGINBAL = SUM(NFO_MARGINBAL),
			NFO_POLEDBAL = SUM(NFO_POLEDBAL),
			PAYMODE,
			NSE_BANKCODE = MAX(NSE_BANKCODE),
			NFO_BANKCODE = MAX(NFO_BANKCODE),
			CLIENTTYPE,
			RUNDATE,
			SUB_BROKER,
			BILLAMT = SUM(BILLAMT)
		FROM 
			#V2_LEDGERBALANCE
		GROUP BY
			PARTYCODE,			
			BRANCHCODE,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,			
			CLIENTTYPE,
			RUNDATE,
			SUB_BROKER
		HAVING
			SUM(NSE_POLEDBAL) > 0
			OR SUM(NFO_POLEDBAL) > 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_GETLEDGERBALANCE_NEW
-- --------------------------------------------------


CREATE PROCEDURE V2_GETLEDGERBALANCE_NEW
(
	@SDATE VARCHAR(11),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@STLNO VARCHAR(7),
	@GENFLAG VARCHAR(1),
	@USER VARCHAR(25),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@EFFDATE VARCHAR(11),
	@COMP_FOR VARCHAR(6) = 'BRANCH' -- COMPUTATION FOR BRANCH REQUESTING / ONLINE CLIENTS PAYOUT
)

AS

	/*===========================================================================
		---------------------------------------------------------------------
		FNO CREDIT BALANCES AFTER ADJUSTING
		MARGIN REQUIREMENT & COLLATERAL
		TO BE CONSIDERED WHILE COMPUTING NET BALANCE
		---------------------------------------------------------------------

		EXEC V2_GETLEDGERBALANCE_NEW
			@SDATE = 'APR  1 2005',
			@FPARTY = '',
			@TPARTY = '',
			@STLNO = '',
			@GENFLAG = 'A',
			@USER = 'PM',
			@EXCHANGE = 'NSE',
			@SEGMENT = 'CAPITAL',
			@EFFDATE = 'MAR 31 2006',
			@COMP_FOR = 'BRANCH'

		SELECT * FROM V2_LEDGERBALANCE

		SELECT PARTYCODE FROM V2_LEDGERBALANCE GROUP BY PARTYCODE HAVING COUNT(*) > 1
		
	===========================================================================*/

	SET NOCOUNT ON

	IF @FPARTY = '' SET @FPARTY = '0000000000'

	IF @TPARTY = '' SET @TPARTY = 'ZZZZZZZZZZ'

	DECLARE @@RECCOUNT INT

	SET @@RECCOUNT = 0

	SELECT @@RECCOUNT = COUNT(1) FROM SETTPAYOUT WHERE LEFT(REQUESTDT,11) = LEFT(GETDATE(),11) AND STATUS = 'P'

	IF @COMP_FOR = 'BRANCH'
	BEGIN
		IF @@RECCOUNT <> 0
		BEGIN
			SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO RECALCULATE ::'
			RETURN
		END
	END

	/*===========================================================================
	CREATE # TABLES FOR CANNED LEDGER BALANCES AND BILL AMOUNTS
	===========================================================================*/
	CREATE TABLE #LEDGERBALANCE
	(
		PARTYCODE VARCHAR(10),
		PARTYNAME VARCHAR(100),
		CHEQUENAME VARCHAR(100),
		BRANCHCODE VARCHAR(10),
		ACCAT VARCHAR(10),
		BTOBPAYMENT INT,
		TOTLEDBAL MONEY,
		NSELEDBAL MONEY,
		BSELEDBAL MONEY,
		FNOLEDBAL MONEY,
		SETT_NO VARCHAR(7),
		NORMALBILLAMT MONEY,
		T2TBILLAMT MONEY,
		BILLAMT MONEY,
		FUTUREPAYOUT MONEY,
		SHORTAGE MONEY,
		AMOUNTTOBEPAID MONEY,
		PAYMODE VARCHAR(1),
		BANKCODE VARCHAR(10),
		GENFLAG VARCHAR(1),
		CLIENTTYPE VARCHAR(3),
		FAMILYCODE VARCHAR(10),
		RUNDATE DATETIME
	)

	CREATE INDEX [PARTYCODE] ON [DBO].[#LEDGERBALANCE]([PARTYCODE]) ON [PRIMARY]

	CREATE TABLE [#LEDGERBILLTMP]
	(
		[CLTCODE] [VARCHAR] (10)  NULL,
		[BRANCHCODE] [VARCHAR] (10)  NULL,
		[LONGNAME] [VARCHAR] (100)  NULL,
		[ACCAT] [CHAR] (10)  NULL,
		[BTOBPAYMENT] [INT] NULL,
		[PAYMODE] [CHAR] (1)  NULL,
		[POBANKCODE] [VARCHAR] (10)  NULL,
		[SETT_NO] [VARCHAR] (7) NOT NULL,
		[NORMALBILLAMT] [MONEY],
		[T2TBILLAMT] [MONEY],
		[CLIENTTYPE] [VARCHAR] (3),
		[FAMILYCODE] [VARCHAR] (10),
		[RUNDATE] [DATETIME]
	) ON [PRIMARY]

	CREATE INDEX [CLTCODE] ON [DBO].[#LEDGERBILLTMP]([CLTCODE]) ON [PRIMARY]

	IF @COMP_FOR = 'BRANCH'
	BEGIN
		IF @GENFLAG = 'A' -- ADHOC PAYOUT
		BEGIN
			INSERT INTO
				#LEDGERBILLTMP
			SELECT
				A.CLTCODE,
				A.BRANCHCODE,
				LONGNAME,
				ACCAT,
				BTOBPAYMENT,
				PAYMODE,
				POBANKCODE,
				SETT_NO = '',
				NORMALBILLAMT = 0,
				T2TBILLAMT = 0,
				CLIENTTYPE = '',
				FAMILYCODE = '',
				RUNDATE = GETDATE()
			FROM
				ACMAST A WITH(NOLOCK)
			WHERE
				A.CLTCODE BETWEEN @FPARTY AND @TPARTY
				AND A.ACCAT IN (4, 104)
				AND A.POBANKCODE IN
				(
					SELECT
					CLTCODE
					FROM ACMAST
					WITH(NOLOCK)
					WHERE ACCAT = 2
				)
			GROUP BY
				A.CLTCODE,
				A.BRANCHCODE,
				LONGNAME,
				ACCAT,
				BTOBPAYMENT,
				PAYMODE,
				POBANKCODE

			UPDATE
				#LEDGERBILLTMP
			SET
				CLIENTTYPE = C1.CL_TYPE,
				FAMILYCODE = C1.FAMILY
			FROM
				MSAJAG..CLIENT1 C1,
				MSAJAG..CLIENT2 C2,
				MSAJAG..CLIENTTYPE C3
			WHERE
				CLTCODE = C2.PARTY_CODE
				AND C1.CL_CODE = C2.CL_CODE
				AND C1.CL_TYPE = C3.CL_TYPE

			DELETE
				#LEDGERBILLTMP
			FROM MSAJAG..CLIENT1 C1,
				MSAJAG..CLIENT2 C2
			WHERE
				CLTCODE = C2.PARTY_CODE
				AND C1.CL_CODE = C2.CL_CODE
				AND C1.CL_TYPE IN ('MTF', 'PMS', 'WEB')
		END
		ELSE
		IF @GENFLAG = 'S' --SETTLEMENT PAYOUT CAPITAL
		BEGIN
			IF @SEGMENT <> 'FUTURES'
			BEGIN
				DECLARE @@SQL VARCHAR(1000)

				SELECT @@SQL = ""

				SELECT PARTY_CODE, SELL_BUY, AMOUNT, SETT_NO, SETT_TYPE INTO #ACCBILL FROM MSAJAG..ACCBILL WHERE 1 = 2

				IF @EXCHANGE = 'NSE'
				BEGIN
					SELECT @@SQL = "INSERT INTO #ACCBILL SELECT PARTY_CODE, SELL_BUY, AMOUNT, SETT_NO, SETT_TYPE FROM MSAJAG..ACCBILL WHERE SETT_NO = '" + @STLNO + "' "
				END

				IF @EXCHANGE = 'BSE'
				BEGIN
					SELECT @@SQL = "INSERT INTO #ACCBILL SELECT PARTY_CODE, SELL_BUY, AMOUNT, SETT_NO, SETT_TYPE FROM BSEDB..ACCBILL WHERE SETT_NO = '" + @STLNO + "' "
				END

				EXEC (@@SQL)

				INSERT INTO
					#LEDGERBILLTMP
				SELECT
					A.CLTCODE,
					A.BRANCHCODE,
					LONGNAME,
					ACCAT,
					BTOBPAYMENT,
					PAYMODE,
					POBANKCODE,
					SETT_NO = @STLNO,
					NORMALBILLAMT = SUM(
									CASE
									WHEN SETT_TYPE = (CASE WHEN @EXCHANGE = 'NSE' THEN 'N' ELSE 'D' END)
									THEN (
										CASE
										WHEN SELL_BUY = '1'
										THEN -AMOUNT
										ELSE AMOUNT
										END
									)
									ELSE 0
									END
									),
					T2TBILLAMT = SUM(
									CASE
									WHEN SETT_TYPE = (CASE WHEN @EXCHANGE = 'NSE' THEN 'W' ELSE 'C' END)
									THEN (
										CASE
										WHEN SELL_BUY = '1'
										THEN -AMOUNT
										ELSE AMOUNT
										END
									)
									ELSE 0
									END
									),
					CLIENTTYPE = '',
					FAMILYCODE = '',
					RUNDATE = GETDATE()
				FROM
					#ACCBILL L WITH(NOLOCK),
					ACMAST A WITH(NOLOCK)
				WHERE
					L.PARTY_CODE = A.CLTCODE
					AND A.CLTCODE BETWEEN @FPARTY AND @TPARTY
					AND A.ACCAT IN (4, 104)
					AND L.SETT_NO = @STLNO
					AND A.POBANKCODE IN
					(
						SELECT
						CLTCODE
						FROM ACMAST
						WITH(NOLOCK)
						WHERE ACCAT = 2
					)
				GROUP BY
					A.CLTCODE,
					A.BRANCHCODE,
					LONGNAME,
					ACCAT,
					BTOBPAYMENT,
					PAYMODE,
					POBANKCODE
				HAVING
					SUM(
					CASE
					WHEN SELL_BUY = '1'
					THEN -AMOUNT
					ELSE AMOUNT
					END
					) > 0

				UPDATE
					#LEDGERBILLTMP
				SET
					CLIENTTYPE = C1.CL_TYPE,
					FAMILYCODE = C1.FAMILY
				FROM
					MSAJAG..CLIENT1 C1,
					MSAJAG..CLIENT2 C2,
					MSAJAG..CLIENTTYPE C3
				WHERE
					CLTCODE = C2.PARTY_CODE
					AND C1.CL_CODE = C2.CL_CODE
					AND C1.CL_TYPE = C3.CL_TYPE

				DELETE
					#LEDGERBILLTMP
				FROM MSAJAG..CLIENT1 C1,
					MSAJAG..CLIENT2 C2
				WHERE
					CLTCODE = C2.PARTY_CODE
					AND C1.CL_CODE = C2.CL_CODE
					AND C1.CL_TYPE IN ('MTF', 'PMS', 'WEB')
			END
		END
	END

	IF @COMP_FOR = 'HO'
	BEGIN
		INSERT INTO
			#LEDGERBILLTMP
		SELECT
			A.CLTCODE,
			A.BRANCHCODE,
			LONGNAME,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,
			POBANKCODE,
			SETT_NO = '',
			NORMALBILLAMT = 0,
			T2TBILLAMT = 0,
			CLIENTTYPE = '',
			FAMILYCODE = '',
			RUNDATE = GETDATE()
		FROM
			ACMAST A WITH(NOLOCK),
			SETTPAYOUT P WITH(NOLOCK)
		WHERE
			A.CLTCODE = P.CLTCODE
			AND A.ACCAT IN (4, 104)
			AND STATUS = 'P'
                        AND A.POBANKCODE IN
			(
				SELECT
				CLTCODE
				FROM ACMAST
				WITH(NOLOCK)
				WHERE ACCAT = 2
			)
            AND GENFLAG = @GENFLAG
		GROUP BY
			A.CLTCODE,
			A.BRANCHCODE,
			LONGNAME,
			ACCAT,
			BTOBPAYMENT,
			PAYMODE,
			POBANKCODE

		UPDATE
			#LEDGERBILLTMP
		SET
			CLIENTTYPE = C1.CL_TYPE,
			FAMILYCODE = C1.FAMILY
		FROM
			MSAJAG..CLIENT1 C1,
			MSAJAG..CLIENT2 C2,
			MSAJAG..CLIENTTYPE C3
		WHERE
			CLTCODE = C2.PARTY_CODE
			AND C1.CL_CODE = C2.CL_CODE
			AND C1.CL_TYPE = C3.CL_TYPE
	END

	/*============================================================================
	CALCULATE NSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER
	============================================================================*/
	INSERT INTO
		#LEDGERBALANCE
	SELECT
		L.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT,
		TOTLEDBAL = 0,
		NSELEDBAL = SUM(
					CASE
					WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'
					THEN (
						CASE
						WHEN DRCR = 'D'
						THEN -VAMT
						ELSE VAMT
						END
					)
					ELSE 0
					END
					) + SUM(
							CASE
							WHEN EDT > @EFFDATE + ' 23:59:00'
							THEN (
								CASE
								WHEN DRCR = 'D'
								THEN -VAMT
								ELSE 0
								END
						)
					ELSE 0
					END
					),
		BSELEDBAL = 0,
		FNOLEDBAL = 0,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		ACCOUNT..LEDGER L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'
	GROUP BY
		A.BRANCHCODE,
		L.CLTCODE,
		A.LONGNAME,
		A.ACCAT,
		A.BTOBPAYMENT,
		A.PAYMODE,
		A.POBANKCODE,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE

	UNION ALL

	SELECT
		L.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT ,
		TOTLEDBAL = 0,
		NSELEDBAL = SUM(
					CASE
					WHEN DRCR = 'D'
					THEN VAMT
					ELSE -VAMT
					END
					),
		BSELEDBAL = 0,
		FNOLEDBAL = 0,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		ACCOUNT..LEDGER L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND L.EDT >= @EFFDATE + ' 23:59:00'
		AND L.VDT < @SDATE
	GROUP BY
		A.BRANCHCODE,
		L.CLTCODE,
		A.LONGNAME,
		A.ACCAT,
		A.BTOBPAYMENT,
		A.PAYMODE,
		A.POBANKCODE,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE

	/*============================================================================
	CALCULATE BSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER
	============================================================================*/
	INSERT INTO
		#LEDGERBALANCE
	SELECT
		L.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT ,
		TOTLEDBAL = 0,
		NSELEDBAL = 0,
		BSELEDBAL = SUM(
					CASE
					WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'
					THEN (
						CASE
						WHEN DRCR = 'D'
						THEN -VAMT
						ELSE VAMT
						END
					)
					ELSE 0
					END
					) + SUM(
							CASE
							WHEN EDT > @EFFDATE + ' 23:59:00'
							THEN (
							CASE
							WHEN DRCR = 'D'
							THEN -VAMT
							ELSE 0
							END
						)
					ELSE 0
					END
					),
		FNOLEDBAL = 0,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		ACCOUNTBSE..LEDGER L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'
	GROUP BY
		A.BRANCHCODE,
		L.CLTCODE,
		A.LONGNAME,
		A.ACCAT,
		A.BTOBPAYMENT,
		A.PAYMODE,
		A.POBANKCODE,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE

	UNION ALL

	SELECT
		L.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT ,
		TOTLEDBAL = 0,
		NSELEDBAL = 0,
		BSELEDBAL = SUM(
					CASE
					WHEN DRCR = 'D'
					THEN VAMT
					ELSE -VAMT
					END
					),
		FNOLEDBAL = 0,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		ACCOUNTBSE..LEDGER L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND L.EDT >= @EFFDATE + ' 23:59:00'
		AND L.VDT < @SDATE
	GROUP BY
		A.BRANCHCODE,
		L.CLTCODE,
		A.LONGNAME,
		A.ACCAT,
		A.BTOBPAYMENT,
		A.PAYMODE,
		A.POBANKCODE,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE

	/*================================================================================
	CALCULATE NSE DERIVATIVE LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT / LEDGER
	================================================================================*/
	INSERT INTO
		#LEDGERBALANCE
	SELECT
		L.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT ,
		TOTLEDBAL = 0,
		NSELEDBAL = 0,
		BSELEDBAL = 0,
		FNOLEDBAL = SUM(
					CASE
					WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'
					THEN (
						CASE
						WHEN DRCR = 'D'
						THEN -VAMT
						ELSE VAMT
						END
					)
					ELSE 0
					END
					) + SUM(
							CASE
							WHEN EDT > @EFFDATE + ' 23:59:00'
							THEN (
							CASE
							WHEN DRCR = 'D'
							THEN -VAMT
							ELSE 0
							END
						)
					ELSE 0
					END
					),
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		ACCOUNTFO..LEDGER L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'
	GROUP BY
		A.BRANCHCODE,
		L.CLTCODE,
		A.LONGNAME,
		A.ACCAT,
		A.BTOBPAYMENT,
		A.PAYMODE,
		A.POBANKCODE,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE

	UNION ALL

	SELECT
		L.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT ,
		TOTLEDBAL = 0,
		NSELEDBAL = 0,
		BSELEDBAL = 0,
		FNOLEDBAL = SUM(
					CASE
					WHEN DRCR = 'D'
					THEN VAMT
					ELSE -VAMT
					END
					),
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		ACCOUNTFO..LEDGER L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND L.EDT >= @EFFDATE + ' 23:59:00'
		AND L.VDT < @SDATE
	GROUP BY
		A.BRANCHCODE,
		L.CLTCODE,
		A.LONGNAME,
		A.ACCAT,
		A.BTOBPAYMENT,
		A.PAYMODE,
		A.POBANKCODE,
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE

	/*==========================================================================
	STORE NSE DERIVATIVE COLLATERAL & MARGIN BALANCES FOR CLIENTS
	==========================================================================*/
	TRUNCATE TABLE FNOLEDBAL

    SELECT
		PARTY_CODE = CLTCODE,
		SPANMARGIN,
		EXPOSUREMARGIN,
		CASH,
		NONCASH,
		MDATE = MARGIN_DATE
    INTO #FNOLEDBAL
    FROM FNOLEDBAL
    WHERE 1=2

	INSERT INTO
		#FNOLEDBAL
	SELECT
		PARTY_CODE = LTRIM(RTRIM(M.PARTY_CODE)),
		SPANMARGIN = -(M.TOTALMARGIN),
		EXPOSUREMARGIN = -(M.MTOM),
		CASH = 0,
		NONCASH = 0,
		MDATE = MDATE
	FROM
		NSEFO..FOMARGINNEW M WITH(NOLOCK)
	WHERE
		M.MDATE = (SELECT MAX(MDATE) FROM NSEFO..FOMARGINNEW WHERE MDATE <= LEFT(GETDATE(),11))

	INSERT INTO
		#FNOLEDBAL
	SELECT
		PARTY_CODE = LTRIM(RTRIM(C.PARTY_CODE)),
		SPANMARGIN = 0,
		EXPOSUREMARGIN = 0,
		CASH = C.CASH,
		NONCASH = C.NONCASH,
		MDATE = TRANS_DATE
	FROM
		MSAJAG..COLLATERAL C WITH(NOLOCK)
	WHERE
		C.TRANS_DATE = (SELECT MAX(TRANS_DATE) FROM MSAJAG..COLLATERAL WHERE TRANS_DATE <= LEFT(GETDATE(),11) AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES')

	INSERT INTO
		FNOLEDBAL
	SELECT
		CLTCODE = A.CLTCODE,
		FNO_TOTALBAL = 0,
		FNO_LEDBAL = 0,
		FNO_COLLATERAL = SUM(L.CASH + L.NONCASH),
		FNO_MARGIN = SUM(L.SPANMARGIN),
		MARGIN_DATE = MAX(MDATE),
		SPANMARGIN = SUM(L.SPANMARGIN),
		EXPOSUREMARGIN = SUM(L.EXPOSUREMARGIN),
		CASH = SUM(L.CASH),
		NONCASH = SUM(L.NONCASH)
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		(
		SELECT
			PARTY_CODE,
			SPANMARGIN = SUM(SPANMARGIN),
			EXPOSUREMARGIN = SUM(EXPOSUREMARGIN),
			CASH = SUM(CASH),
			NONCASH = SUM(NONCASH),
			MDATE = MAX(MDATE)
		FROM
			#FNOLEDBAL
		GROUP BY
			PARTY_CODE
		) L
	WHERE
		L.PARTY_CODE = A.CLTCODE
	GROUP BY
		A.CLTCODE

	UPDATE
		F
	SET
		FNO_TOTALBAL = FNOLEDBAL + (SPANMARGIN + EXPOSUREMARGIN + CASH + NONCASH),
		FNO_LEDBAL = FNOLEDBAL
	FROM
		FNOLEDBAL F,
		(SELECT PARTYCODE, FNOLEDBAL = SUM(FNOLEDBAL) FROM #LEDGERBALANCE GROUP BY PARTYCODE) L
	WHERE
		F.CLTCODE = L.PARTYCODE

	/*===========================================================================
	CALCULATE NSE DERIVATIVE MARGIN REQUIREMENT AFTER ADJUSTING COLLATERAL
	ONLY IF -VE I.E. DEBIT
	===========================================================================*/
	INSERT INTO
		#LEDGERBALANCE
	SELECT
		A.CLTCODE,
		ACNAME = A.LONGNAME,
		CHEQUENAME = A.LONGNAME,
		A.BRANCHCODE,
		A.ACCAT,
		A.BTOBPAYMENT,
		TOTLEDBAL = 0,
		NSELEDBAL = 0,
		BSELEDBAL = 0,
		FNOLEDBAL = (L.SPANMARGIN + L.EXPOSUREMARGIN) + (L.CASH + L.NONCASH),
		A.SETT_NO,
		A.NORMALBILLAMT,
		A.T2TBILLAMT,
		BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,
		FUTUREPAYOUT = 0 ,
		SHORTAGE = 0,
		AMOUNTTOBEPAID = 0,
		A.PAYMODE,
		A.POBANKCODE,
		GENFLAG = @GENFLAG,
		A.CLIENTTYPE,
		A.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBILLTMP A WITH(NOLOCK),
		FNOLEDBAL L WITH(NOLOCK)
	WHERE
		L.CLTCODE = A.CLTCODE
		AND (L.SPANMARGIN + L.EXPOSUREMARGIN) + (L.CASH + L.NONCASH) <= 0

	/*===========================================================================
	INSERT INTO PHYSICAL TABLE FROM TEMP TABLE AFTER GROUPING AS REQUIRED
	===========================================================================*/

	CREATE TABLE [DBO].[#V2_LEDGERBALANCE](
		[SNO] [bigint] IDENTITY(1,1) NOT NULL,
		[PARTYCODE] [VARCHAR](10) NULL,
		[PARTYNAME] [VARCHAR](100) NULL,
		[CHEQUENAME] [VARCHAR](100) NULL,
		[BRANCHCODE] [VARCHAR](10) NULL,
		[ACCAT] [VARCHAR](10) NULL,
		[BTOBPAYMENT] [INT] NULL,
		[TOTLEDBAL] [MONEY] NULL,
		[NSELEDBAL] [MONEY] NULL,
		[BSELEDBAL] [MONEY] NULL,
		[FNOLEDBAL] [MONEY] NULL,
		[NETLEDBAL] [MONEY] NULL,
		[FAMLEDBAL] [MONEY] NULL,
		[SETT_NO] [VARCHAR](7) NULL,
		[NORMALBILLAMT] [MONEY] NULL,
		[T2TBILLAMT] [MONEY] NULL,
		[BILLAMT] [MONEY] NULL,
		[FUTUREPAYOUT] [MONEY] NULL,
		[SHORTAGE] [MONEY] NULL,
		[AMOUNTTOBEPAID] [MONEY] NULL,
		[PAYMODE] [VARCHAR](1) NULL,
		[BANKCODE] [VARCHAR](10) NULL,
		[GENFLAG] [VARCHAR](1) NULL,
		[CLIENTTYPE] [VARCHAR](3) NULL,
		[FAMILYCODE] [VARCHAR](10) NULL,
		[RUNDATE] [DATETIME] NULL
	) ON [PRIMARY]

	INSERT INTO #V2_LEDGERBALANCE
	SELECT
		PARTYCODE,
		PARTYNAME,
		CHEQUENAME,
		BRANCHCODE,
		ACCAT,
		BTOBPAYMENT,
        TOTLEDBAL = 0,
		NSELEDBAL = SUM(NSELEDBAL),
		BSELEDBAL = SUM(BSELEDBAL),
		FNOLEDBAL = SUM(FNOLEDBAL),
        NETLEDBAL = CASE @EXCHANGE + @SEGMENT
					WHEN 'NSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--NSE
					WHEN 'BSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--BSE
					WHEN 'NSEFUTURES' THEN SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL)--NFO
					ELSE 0 END,
		FAMLEDBAL = ISNULL(FAMLEDBAL,0),
		SETT_NO,
		NORMALBILLAMT,
		T2TBILLAMT,
		BILLAMT,
		FUTUREPAYOUT,
		SHORTAGE,
		AMOUNTTOBEPAID,
		PAYMODE,
		BANKCODE,
		GENFLAG,
		CLIENTTYPE,
		L.FAMILYCODE,
		RUNDATE
	FROM
		#LEDGERBALANCE L LEFT OUTER JOIN
		/*===========================================================================
		FAMILY LEVEL BALANCES
		===========================================================================*/
		(
			SELECT
				FAMILYCODE,
				FAMLEDBAL = CASE @EXCHANGE + @SEGMENT
							WHEN 'NSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--NSE
							WHEN 'BSECAPITAL' THEN SUM(NSELEDBAL) + SUM(BSELEDBAL) + (CASE WHEN SUM(FNOLEDBAL) < 0 THEN SUM(FNOLEDBAL) ELSE 0 END)--BSE
							WHEN 'NSEFUTURES' THEN SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL)--NFO
							ELSE 0 END
			FROM
				#LEDGERBALANCE
			GROUP BY
				FAMILYCODE
		) F
		ON L.FAMILYCODE = F.FAMILYCODE
	GROUP BY
		PARTYCODE,
		PARTYNAME,
		CHEQUENAME,
		BRANCHCODE,
		ACCAT,
		BTOBPAYMENT,
		SETT_NO,
		NORMALBILLAMT,
		T2TBILLAMT,
		BILLAMT,
		FUTUREPAYOUT,
		SHORTAGE,
		AMOUNTTOBEPAID,
		PAYMODE,
		BANKCODE,
		GENFLAG,
		CLIENTTYPE,
		L.FAMILYCODE,
		FAMLEDBAL,
		RUNDATE

	UPDATE #V2_LEDGERBALANCE SET FAMLEDBAL = A.FAMLEDBAL
	FROM
	(
		SELECT SNO, --PARTYCODE, FAMILYCODE,
		FAMLEDBAL = FAMLEDBAL -
						(SELECT ISNULL(SUM(ISNULL(TOTLEDBAL,0)),0)
						FROM #V2_LEDGERBALANCE V1
						WHERE V1.FAMILYCODE = V.FAMILYCODE
						AND V1.SNO < V.SNO
						AND TOTLEDBAL > 0)
		FROM #V2_LEDGERBALANCE V
		WHERE TOTLEDBAL > 0
	) A,
	(
	SELECT FAMILYCODE FROM #V2_LEDGERBALANCE GROUP BY FAMILYCODE HAVING COUNT(1) > 1
	) B
	WHERE #V2_LEDGERBALANCE.SNO = A.SNO
	AND A.FAMLEDBAL > 0
	AND #V2_LEDGERBALANCE.FAMILYCODE = B.FAMILYCODE

	UPDATE #V2_LEDGERBALANCE
	SET TOTLEDBAL =
				(CASE
					WHEN FAMLEDBAL < 0 OR FAMLEDBAL < NETLEDBAL
					THEN FAMLEDBAL
					ELSE NETLEDBAL
				END)

	SELECT
		PARTYCODE,PARTYNAME,CHEQUENAME,BRANCHCODE,ACCAT,BTOBPAYMENT,
		TOTLEDBAL,NSELEDBAL,BSELEDBAL,FNOLEDBAL,NETLEDBAL,FAMLEDBAL,
		SETT_NO,NORMALBILLAMT,T2TBILLAMT,BILLAMT,FUTUREPAYOUT,SHORTAGE,AMOUNTTOBEPAID,
		PAYMODE,BANKCODE,GENFLAG,CLIENTTYPE,FAMILYCODE,RUNDATE
	FROM #V2_LEDGERBALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INTEREST_CAL
-- --------------------------------------------------


CREATE PROCEDURE V2_INTEREST_CAL 
(  
        @@BALDATE INT 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_INTEREST_CAL  
                @@BALDATE = 20070401 
==============================================================================================================*/  
  
        SET NOCOUNT ON

	DECLARE 
		@@CREDIT_INT MONEY, 
		@@DEBIT_INT MONEY,
		@@SPAN_MARGIN INT, 
		@@EXPOSURE_MARGIN INT

	SELECT 
		@@CREDIT_INT = CREDIT_INT, 
		@@DEBIT_INT = DEBIT_INT, 
        @@SPAN_MARGIN = SPAN_MARGIN, 
        @@EXPOSURE_MARGIN = EXPOSURE_MARGIN
	FROM V2_CLIENTPROFILES_FA 
	WHERE CLTCODE = 'ALL'


    SELECT 
        CLTCODE, 
        SEGMENTCODE, 
        LEDTYPE, 
        VDTBAL = SUM(VDTBAL), 
        VDTINTEREST = SUM(VDTINTEREST), 
        EDTBAL = SUM(EDTBAL), 
        EDTINTEREST = SUM(EDTINTEREST), 
		INTDATE = @@BALDATE 
    FROM 
    (
        SELECT 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
            V.LEDTYPE, 
        	VDTBAL = SUM(BALCR - BALDR), 
    		VDTINTEREST = (CASE WHEN SUM(BALCR - BALDR) > 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN SUM(BALCR - BALDR) < 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END), 
    		EDTBAL = 0, 
    		EDTINTEREST = 0
        FROM 
        	V2_ACCOUNTBALANCES V LEFT OUTER JOIN 
            V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE), 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
        	AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE, CREDIT_INT, DEBIT_INT
        HAVING SUM(BALCR - BALDR) <> 0 
        
        UNION ALL
    
        SELECT 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
            V.LEDTYPE, 
    		VDTBAL = 0, 
    		VDTINTEREST = 0, 
        	EDTBAL = SUM(BALCR - BALDR), 
    		EDTINTEREST = (CASE WHEN SUM(BALCR - BALDR) > 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN SUM(BALCR - BALDR) < 0 
    				THEN ((SUM(BALCR - BALDR) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END)
        FROM 
        	V2_ACCOUNTBALANCES V LEFT OUTER JOIN 
            V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE), 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
        	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE, CREDIT_INT, DEBIT_INT
        HAVING SUM(BALCR - BALDR) <> 0 
    
        UNION ALL
    
        SELECT 
        	V.CLTCODE, 
        	V.SEGMENTCODE, 
            V.LEDTYPE, 
    		VDTBAL = 0, 
    		VDTINTEREST = 0, 
        	EDTBAL = SUM(BALCR - BALDR), 
    		EDTINTEREST = (CASE WHEN SUM(BALDR - BALCR) > 0 
    				THEN ((SUM(BALDR - BALCR) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN SUM(BALDR - BALCR) < 0 
    				THEN ((SUM(BALDR - BALCR) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 0 END) END)
        FROM 
        	V2_ACCOUNTBALANCES V LEFT OUTER JOIN 
            V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE), 
        	PARAMETER P 
        WHERE 
        	CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
        	AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
        	AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
            AND VDT < CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112))
        GROUP BY 
        	V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE, CREDIT_INT, DEBIT_INT
        HAVING SUM(BALDR - BALCR) <> 0 

        UNION ALL 
    
    	SELECT 
        	V.CLTCODE, 
        	SEGMENTCODE = 3, 
            LEDTYPE = 3, 
        	VDTBAL = NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ), 
    		VDTINTEREST = (CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) > 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) < 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END), 
        	EDTBAL = NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ), 
    		EDTINTEREST = (CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) > 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(CREDIT_INT,@@CREDIT_INT)) / 100) / 365
    				ELSE 
    				(CASE WHEN NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) < 0 
    				THEN ((NONCASH - (
                                (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                                + 
                                (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                    ) * ISNULL(DEBIT_INT,@@DEBIT_INT)) / 100) / 365
    				ELSE 0 END) END)
    	FROM 
    		( 
    			SELECT 
    				CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE), 
    				NONCASH = ISNULL(NONCASH,0), 
    				TOTALMARGIN = ISNULL(TOTALMARGIN,0), 
    				MTOM = ISNULL(MTOM,0) 
    			FROM 
    				(
    					SELECT CLTCODE = PARTY_CODE, NONCASH 
    					FROM MSAJAG.DBO.COLLATERAL 
    					WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) = 
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(TRANS_DATE),112)) FROM MSAJAG.DBO.COLLATERAL WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) <= @@BALDATE AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES') 
    					AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
    				) C FULL OUTER JOIN 
    				(
    					SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM 
    					FROM NSEFO.DBO.FOMARGINNEW 
    					WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) = 
                            (SELECT CONVERT(INT,CONVERT(VARCHAR,MAX(MDATE),112)) FROM NSEFO.DBO.FOMARGINNEW WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) <= @@BALDATE) 
    				) M 
    			ON M.CLTCODE = C.CLTCODE 
    		 ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)
    	WHERE NONCASH - (
                            (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                            + 
                            (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                                ) < 0 
    ) FINAL 
    GROUP BY 
        CLTCODE, 
        SEGMENTCODE, 
        LEDTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INTEREST_CUR
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_INTEREST_CUR]      
(      
        @@FROMDATE VARCHAR(11),  
        @@TODATE VARCHAR(11)  
)      
      
AS      
      
/*==============================================================================================================      
        EXEC V2_INTEREST_CUR      
                @@FROMDATE VARCHAR(11),  
                @@TODATE VARCHAR(11)  
==============================================================================================================*/      
      
        SET NOCOUNT ON    
    
 DECLARE     
  @@VDATE DATETIME,     
  @@BALDATE INT     
    
 SET @@VDATE = @@FROMDATE     
    
 WHILE @@VDATE <= @@TODATE     
 BEGIN     
  SET @@BALDATE = CONVERT(INT,CONVERT(VARCHAR,@@VDATE,112))    
    
  DELETE FROM V2_INTEREST WHERE INTDATE = @@BALDATE    
    
  INSERT INTO V2_INTEREST EXEC V2_INTEREST_CAL @@BALDATE    
    
  SET @@VDATE = @@VDATE + 1    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INTEREST_REPORT
-- --------------------------------------------------
CREATE PROCEDURE V2_INTEREST_REPORT(    
                @FILTER      VARCHAR(11),    
                @INTERESTON  VARCHAR(3),    
                @SEGMENTCODE INT,    
                @DRCR        VARCHAR(3),    
                @FROMDATE    VARCHAR(11),    
                @TODATE      VARCHAR(11),    
                @FROMPARTY   VARCHAR(10),    
                @TOPARTY     VARCHAR(10),    
                @STATUSID    VARCHAR(20),    
                @STATUSNAME  VARCHAR(20))    
    
AS    
    
  /*==============================================================================================================      
        EXEC V2_INTEREST_REPORT      
     @FILTER = 'BRANCH',     
     @INTERESTON = 'VDT',
	@SEGMENTCODE = 0,
 @DRCR = 'C',	     
     @FROMDATE = 'JUN  1 2007',     
  @TODATE = 'JUN  7 2007',     
  @FROMPARTY = '0000000000',     
  @TOPARTY = 'ZZZZZZZZZZ',     
  @STATUSID = 'BROKER',     
  @STATUSNAME = 'BROKER'     
==============================================================================================================*/    
  SET NOCOUNT ON   

  IF (SELECT DATEDIFF(DAY,CONVERT(DATETIME,LEFT(GETDATE() - DAY(GETDATE()),11)),CONVERT(DATETIME,@TODATE))) > 0
  BEGIN
     SELECT 'NO RECORDS FOUND'
	 RETURN
  END
 
  DECLARE  @@FDATE INT,    
           @@TDATE INT    
                       
--  SET @@FDATE = CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112))    
                    
--  SET @@TDATE = CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),112))    
                    
  SELECT PARTY_CODE,    
         LONG_NAME    
  INTO   #CLIENT    
  FROM   MSAJAG.DBO.CLIENT_DETAILS C    
  WHERE  1 = 2    
  
                 
  INSERT INTO #CLIENT    
  EXEC V2_ACCOUNT_LISTING    
     @FILTER ,    
     @FROMPARTY ,    
     @TOPARTY ,    
     @STATUSID ,    
     @STATUSNAME    
--SELECT * FROM  #CLIENT  
--RETURN        
  IF @DRCR = 'ALL'    
    BEGIN    
      IF @SEGMENTCODE = 0    
        BEGIN    
          SELECT   CLTCODE = C1.PARTY_CODE,    
                   NSECM = SUM(CASE     
                                 WHEN SEGMENTCODE = 1 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                               ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   BSECM = SUM(CASE     
                                 WHEN SEGMENTCODE = 2 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                               ELSE (CASE     
                                                                         WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   NSEFO = SUM(CASE     
                                 WHEN SEGMENTCODE = 3 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                               ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   BSEFO = SUM(CASE     
                                 WHEN SEGMENTCODE = 4 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                               ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                              END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   INTEREST = SUM(CASE     
                                    WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                     WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                     ELSE (CASE     
                                                                             WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                             ELSE 0    
                                                                           END)    
                                                                   END)    
                                    ELSE (CASE     
                                            WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                            ELSE (CASE     
                                                    WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                    ELSE 0    
                                                  END)    
                                          END)    
                                  END),    
                   C1.LONG_NAME    
          FROM     V2_INTEREST V    
                   LEFT OUTER JOIN V2_CLIENTPROFILES_FA F    
                     ON (V.CLTCODE = F.CLTCODE),    
                   (SELECT CREDIT_INT,    
                           DEBIT_INT,    
                           SPAN_MARGIN,    
                           EXPOSURE_MARGIN    
                    FROM   V2_CLIENTPROFILES_FA    
                    WHERE  CLTCODE = 'ALL') A,    
                   MSAJAG.DBO.CLIENT_DETAILS C,    
                   #CLIENT C1    
          WHERE    C.PARTY_CODE = V.CLTCODE    
                   AND V.INTDATE BETWEEN @@FDATE    
                                         AND @@TDATE    
                   AND C1.PARTY_CODE = (CASE     
                                          WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD    
                                          WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE    
                                          WHEN @FILTER = 'FAMILY' THEN C.FAMILY    
                                        END)    
                   AND C.PARTY_CODE BETWEEN @FROMPARTY    
                                            AND @TOPARTY    
          GROUP BY C1.PARTY_CODE,C1.LONG_NAME    
        END    
      ELSE    
        BEGIN    
          SELECT   CLTCODE = C1.PARTY_CODE,    
                   NSECM = SUM(CASE     
                                 WHEN SEGMENTCODE = 1 THEN (CASE     
                                 WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                            ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   BSECM = SUM(CASE     
                                 WHEN SEGMENTCODE = 2 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                               ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   NSEFO = SUM(CASE     
                                 WHEN SEGMENTCODE = 3 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                     ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                        ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   BSEFO = SUM(CASE     
                                 WHEN SEGMENTCODE = 4 THEN (CASE     
                                                              WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                               WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                               ELSE (CASE     
                                                                                                       WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                       ELSE 0    
                                                                                                     END)    
                                                                                             END)    
                                                              ELSE (CASE     
                                                                      WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                              ELSE 0    
                                                                            END)    
                                                                    END)    
                                                            END)    
                                 ELSE 0    
                               END),    
                   INTEREST = SUM(CASE     
                                    WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                     WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                     ELSE (CASE     
                                                                             WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                             ELSE 0    
                                                                           END)    
                                                                   END)    
                                    ELSE (CASE     
                                            WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                            ELSE (CASE     
                                                    WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                    ELSE 0    
                                                  END)    
                                          END)    
                                  END),    
                   C1.LONG_NAME    
          FROM     V2_INTEREST V    
                   LEFT OUTER JOIN V2_CLIENTPROFILES_FA F    
                     ON (V.CLTCODE = F.CLTCODE),    
                   (SELECT CREDIT_INT,    
                           DEBIT_INT,    
                           SPAN_MARGIN,    
                           EXPOSURE_MARGIN    
                    FROM   V2_CLIENTPROFILES_FA    
                    WHERE  CLTCODE = 'ALL') A,    
                   MSAJAG.DBO.CLIENT_DETAILS C,    
                   #CLIENT C1    
          WHERE    C.PARTY_CODE = V.CLTCODE    
                   AND V.INTDATE BETWEEN @@FDATE    
                                         AND @@TDATE    
                   AND C1.PARTY_CODE = (CASE     
                                          WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD    
                                          WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE    
                                          WHEN @FILTER = 'FAMILY' THEN C.FAMILY    
                                        END)    
                   AND C.PARTY_CODE BETWEEN @FROMPARTY    
                                            AND @TOPARTY    
          GROUP BY C1.PARTY_CODE,C1.LONG_NAME    
          HAVING   SUM(CASE     
                         WHEN SEGMENTCODE = @SEGMENTCODE THEN (CASE     
                                                                 WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                  WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                  ELSE (CASE     
                                                                                                          WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                          ELSE 0    
                                                                                                        END)    
                                                                                                END)    
                                                                 ELSE (CASE     
                                                                         WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                         ELSE (CASE     
                                                                                 WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                 ELSE 0    
                                                                               END)    
                                                                       END)    
                                                               END)    
                         ELSE 0    
                       END) <> 0    
        END    
    END    
  ELSE    
    BEGIN    
      IF @SEGMENTCODE = 0    
        BEGIN    
          SELECT CLTCODE,    
                 NSECM,    
                 BSECM,    
                 NSEFO,    
                 BSEFO,    
                 INTEREST,    
                 LONG_NAME    
          FROM   (SELECT   CLTCODE = C1.PARTY_CODE,    
                           NSECM = SUM(CASE     
                                         WHEN SEGMENTCODE = 1 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                       ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           BSECM = SUM(CASE     
                                         WHEN SEGMENTCODE = 2 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                       ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
              END)    
                                         ELSE 0    
                                       END),    
                           NSEFO = SUM(CASE     
                                         WHEN SEGMENTCODE = 3 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                     ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           BSEFO = SUM(CASE     
                                         WHEN SEGMENTCODE = 4 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                       ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           INTEREST = SUM(CASE     
                                            WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                             WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                             ELSE (CASE     
                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                     ELSE 0    
                                                                                   END)    
                                                                           END)    
                                            ELSE (CASE     
                                                    WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                    ELSE (CASE     
                                                            WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                            ELSE 0    
                                                          END)    
                                                  END)    
                                          END),    
                           C1.LONG_NAME    
                  FROM     V2_INTEREST V    
                           LEFT OUTER JOIN V2_CLIENTPROFILES_FA F    
                             ON (V.CLTCODE = F.CLTCODE),    
                           (SELECT CREDIT_INT,    
                                   DEBIT_INT,    
                                   SPAN_MARGIN,    
                                   EXPOSURE_MARGIN    
                            FROM   V2_CLIENTPROFILES_FA    
                            WHERE  CLTCODE = 'ALL') A,    
                           MSAJAG.DBO.CLIENT_DETAILS C,    
                           #CLIENT C1    
                  WHERE    C.PARTY_CODE = V.CLTCODE    
                           AND V.INTDATE BETWEEN @@FDATE    
                                                 AND @@TDATE    
                           AND C1.PARTY_CODE = (CASE     
                                                  WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD    
                                                  WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE    
                                                  WHEN @FILTER = 'FAMILY' THEN C.FAMILY    
                                                END)    
                           AND C.PARTY_CODE BETWEEN @FROMPARTY    
                                                    AND @TOPARTY    
                  GROUP BY C1.PARTY_CODE,C1.LONG_NAME) A    
          WHERE  SIGN(INTEREST) = (CASE @DRCR     
                                     WHEN 'DR' THEN -1    
                                     WHEN 'CR' THEN +1    
                                   END)    
        END    
      ELSE    
        BEGIN    
          SELECT CLTCODE,    
                 NSECM,    
                 BSECM,    
                 NSEFO,    
                 BSEFO,    
                 INTEREST,    
                 LONG_NAME    
          FROM   (SELECT   CLTCODE = C1.PARTY_CODE,    
                           NSECM = SUM(CASE     
                                         WHEN SEGMENTCODE = 1 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                  ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                               WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           BSECM = SUM(CASE     
                                         WHEN SEGMENTCODE = 2 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                       ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           NSEFO = SUM(CASE     
                                         WHEN SEGMENTCODE = 3 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                 ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                 WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           BSEFO = SUM(CASE     
                                         WHEN SEGMENTCODE = 4 THEN (CASE     
                                                                      WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                       WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                       ELSE (CASE     
                                                                                                               WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                               ELSE 0    
                                                                                                             END)    
                                                                                                     END)    
                                                                      ELSE (CASE     
                                                                              WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                              ELSE (CASE     
                                                                                      WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                      ELSE 0    
                                                                                    END)    
                                                                            END)    
                                                                    END)    
                                         ELSE 0    
                                       END),    
                           INTEREST = SUM(CASE     
                                            WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                             WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                             ELSE (CASE     
                                                              WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                     ELSE 0    
                                                                                   END)    
                                                                           END)    
                                            ELSE (CASE     
                                                    WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                    ELSE (CASE     
                                                            WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                            ELSE 0    
                                                          END)    
                                                  END)    
                                          END),    
                           C1.LONG_NAME    
                  FROM     V2_INTEREST V    
                           LEFT OUTER JOIN V2_CLIENTPROFILES_FA F    
                             ON (V.CLTCODE = F.CLTCODE),    
                           (SELECT CREDIT_INT,    
                                   DEBIT_INT,    
                                   SPAN_MARGIN,    
                                   EXPOSURE_MARGIN    
                            FROM   V2_CLIENTPROFILES_FA    
                            WHERE  CLTCODE = 'ALL') A,    
                           MSAJAG.DBO.CLIENT_DETAILS C,    
                           #CLIENT C1    
                  WHERE    C.PARTY_CODE = V.CLTCODE    
                           AND V.INTDATE BETWEEN @@FDATE    
                                                 AND @@TDATE    
                           AND C1.PARTY_CODE = (CASE     
                                                  WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD    
                                                  WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE    
                                                  WHEN @FILTER = 'FAMILY' THEN C.FAMILY    
                                                END)    
                           AND C.PARTY_CODE BETWEEN @FROMPARTY    
                                                    AND @TOPARTY    
                  GROUP BY C1.PARTY_CODE,C1.LONG_NAME    
                  HAVING   SUM(CASE     
                                 WHEN SEGMENTCODE = @SEGMENTCODE THEN (CASE     
                                                                         WHEN @INTERESTON = 'VDT' THEN (CASE     
                                                                                                          WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                                          ELSE (CASE     
                                                                                                                  WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                                                  ELSE 0    
                                                                                                                END)    
                                                                                                        END)    
                                                                         ELSE (CASE     
                                                                                 WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365    
                                                                                 ELSE (CASE     
                                                                                         WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365    
                                                                                         ELSE 0    
                                                                                       END)    
                                                                               END)    
                                                                       END)    
                                 ELSE 0    
                               END) <> 0) A    
          WHERE  SIGN(INTEREST) = (CASE @DRCR     
                                     WHEN 'DR' THEN -1    
                                     WHEN 'CR' THEN +1    
                                   END)    
        END    
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_INTEREST_REPORT_DETAIL
-- --------------------------------------------------

CREATE PROCEDURE V2_INTEREST_REPORT_DETAIL(
                @FILTER      VARCHAR(11),
                @INTERESTON  VARCHAR(3),
                @SEGMENTCODE INT,
                @FROMDATE    VARCHAR(11),
                @TODATE      VARCHAR(11),
                @FROMPARTY   VARCHAR(10),
                @TOPARTY     VARCHAR(10),
                @STATUSID    VARCHAR(20),
                @STATUSNAME  VARCHAR(20))

AS

  /*==============================================================================================================  
        EXEC V2_INTEREST_REPORT_DETAIL  
	    @FILTER = 'BRANCH', 
	    @INTERESTON = 'VDT', 
	    @FROMDATE = 'JUN  1 2007', 
		@TODATE = 'JUN  7 2007', 
		@FROMPARTY = '0000000000', 
		@TOPARTY = 'ZZZZZZZZZZ', 
		@STATUSID = 'BROKER', 
		@STATUSNAME = 'BROKER' 
==============================================================================================================*/
  SET NOCOUNT ON
  
  DECLARE  @@FDATE INT,
           @@TDATE INT
                   
  SET @@FDATE = CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112))
                
  SET @@TDATE = CONVERT(INT,CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),112))
                
  SELECT PARTY_CODE,
         LONG_NAME
  INTO   #CLIENT
  FROM   MSAJAG.DBO.CLIENT_DETAILS C
  WHERE  1 = 2
             
  INSERT INTO #CLIENT
  EXEC V2_ACCOUNT_LISTING
     @FILTER ,
     @FROMPARTY ,
     @TOPARTY ,
     @STATUSID ,
     @STATUSNAME
    
  IF @SEGMENTCODE = 0
    BEGIN
      SELECT   BALDATE = LEFT(CONVERT(DATETIME,CONVERT(VARCHAR,INTDATE)),
                              11),
               NSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 1 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 2 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               NSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 3 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 4 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               INTEREST = SUM(CASE 
                                WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                 WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                 ELSE (CASE 
                                                                         WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                         ELSE 0
                                                                       END)
                                                               END)
                                ELSE (CASE 
                                        WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                        ELSE (CASE 
                                                WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                ELSE 0
                                              END)
                                      END)
                              END),
               INTDATE
      FROM     V2_INTEREST V
               LEFT OUTER JOIN V2_CLIENTPROFILES_FA F
                 ON (V.CLTCODE = F.CLTCODE),
               (SELECT CREDIT_INT,
                       DEBIT_INT,
                       SPAN_MARGIN,
                       EXPOSURE_MARGIN
                FROM   V2_CLIENTPROFILES_FA
                WHERE  CLTCODE = 'ALL') A,
               MSAJAG.DBO.CLIENT_DETAILS C,
               #CLIENT C1
      WHERE    C.PARTY_CODE = V.CLTCODE
               AND V.INTDATE BETWEEN @@FDATE
                                     AND @@TDATE
               AND C1.PARTY_CODE = (CASE 
                                      WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD
                                      WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE
                                      WHEN @FILTER = 'FAMILY' THEN C.FAMILY
                                    END)
               AND C.PARTY_CODE BETWEEN @FROMPARTY
                                        AND @TOPARTY
      GROUP BY C1.PARTY_CODE,C1.LONG_NAME,INTDATE
      ORDER BY 7
    END
  ELSE
    BEGIN
      SELECT   BALDATE = LEFT(CONVERT(DATETIME,CONVERT(VARCHAR,INTDATE)),
                              11),
               NSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 1 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSECM = SUM(CASE 
                             WHEN SEGMENTCODE = 2 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               NSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 3 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               BSEFO = SUM(CASE 
                             WHEN SEGMENTCODE = 4 THEN (CASE 
                                                          WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                           WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                           ELSE (CASE 
                                                                                                   WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                   ELSE 0
                                                                                                 END)
                                                                                         END)
                                                          ELSE (CASE 
                                                                  WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                  ELSE (CASE 
                                                                          WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                          ELSE 0
                                                                        END)
                                                                END)
                                                        END)
                             ELSE 0
                           END),
               INTEREST = SUM(CASE 
                                WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                 WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                 ELSE (CASE 
                                                                         WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                         ELSE 0
                                                                       END)
                                                               END)
                                ELSE (CASE 
                                        WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                        ELSE (CASE 
                                                WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                ELSE 0
                                              END)
                                      END)
                              END),
               INTDATE
      FROM     V2_INTEREST V
               LEFT OUTER JOIN V2_CLIENTPROFILES_FA F
                 ON (V.CLTCODE = F.CLTCODE),
               (SELECT CREDIT_INT,
                       DEBIT_INT,
                       SPAN_MARGIN,
                       EXPOSURE_MARGIN
                FROM   V2_CLIENTPROFILES_FA
                WHERE  CLTCODE = 'ALL') A,
               MSAJAG.DBO.CLIENT_DETAILS C,
               #CLIENT C1
      WHERE    C.PARTY_CODE = V.CLTCODE
               AND V.INTDATE BETWEEN @@FDATE
                                     AND @@TDATE
               AND C1.PARTY_CODE = (CASE 
                                      WHEN @FILTER = 'BRANCH' THEN C.BRANCH_CD
                                      WHEN @FILTER = 'CLIENT' THEN C.PARTY_CODE
                                      WHEN @FILTER = 'FAMILY' THEN C.FAMILY
                                    END)
               AND C.PARTY_CODE BETWEEN @FROMPARTY
                                        AND @TOPARTY
      GROUP BY C1.PARTY_CODE,C1.LONG_NAME,INTDATE
      HAVING   SUM(CASE 
                     WHEN SEGMENTCODE = @SEGMENTCODE THEN (CASE 
                                                             WHEN @INTERESTON = 'VDT' THEN (CASE 
                                                                                              WHEN VDTBAL > 0 THEN ((VDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                                              ELSE (CASE 
                                                                                                      WHEN VDTBAL < 0 THEN ((VDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                                                      ELSE 0
                                                                                                    END)
                                                                                            END)
                                                             ELSE (CASE 
                                                                     WHEN EDTBAL > 0 THEN ((EDTBAL * ISNULL(F.CREDIT_INT,A.CREDIT_INT)) / 100) / 365
                                                                     ELSE (CASE 
                                                                             WHEN EDTBAL < 0 THEN ((EDTBAL * ISNULL(F.DEBIT_INT,A.DEBIT_INT)) / 100) / 365
                                                                             ELSE 0
                                                                           END)
                                                                   END)
                                                           END)
                     ELSE 0
                   END) <> 0
      ORDER BY 7
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_LedgerBalanceReport
-- --------------------------------------------------


CREATE PROCEDURE V2_LedgerBalanceReport
(          
      @SDATE VARCHAR(11),            
      @FPARTY VARCHAR(10),             
      @TPARTY VARCHAR(10),         
      @EFFDATE VARCHAR(11), 
      @CL_TYPE VARCHAR(3)
)          

AS              
            
/*===========================================================================    
      EXEC V2_LedgerBalanceReport
            @SDATE = 'APR  1 2005',     
            @FPARTY = '',     
            @TPARTY = '',     
            @EFFDATE = 'MAR  4 2006', 
            @CL_TYPE = '' 
===========================================================================*/    
    
SET NOCOUNT ON    
    
IF @FPARTY = ''                           
BEGIN                           
      SET @FPARTY = '0000000000'         
END                          
          
IF @TPARTY = ''                           
BEGIN                           
      SET @TPARTY = 'ZZZZZZZZZZ'          
END             
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
DECLARE     
      @@RECCOUNT INT    
    
SET @@RECCOUNT = 0    
    
SELECT @@RECCOUNT = COUNT(1) FROM SETTPAYOUT WHERE LEFT(REQUESTDT,11) = LEFT(GETDATE(),11) AND STATUS = 'P'     
    
      IF @@RECCOUNT <> 0     
      BEGIN    
            SELECT ':: SORRY!! CANNOT PROCEED. THERE ARE SOME REQUESTS PENDING. PLEASE REJECT/APPROVE TO RECALCULATE ::'    
            RETURN    
      END    
    
/*===========================================================================    
      CREATE # TABLES FOR CANNED LEDGER BALANCES AND BILL AMOUNTS    
===========================================================================*/    
      CREATE TABLE #LEDGERBALANCE    
      (           
            PARTYCODE VARCHAR(10),            
            PARTYNAME VARCHAR(100),             
            CHEQUENAME VARCHAR(100),            
            BRANCHCODE VARCHAR(10),            
            CL_TYPE VARCHAR(3),            
            ACCAT VARCHAR(10),            
            BTOBPAYMENT INT,            
            TOTLEDBAL MONEY,            
            NSELEDBAL MONEY,            
            BSELEDBAL MONEY,            
            FNOLEDBAL MONEY,            
            SETT_NO VARCHAR(7),            
            NORMALBILLAMT MONEY,            
            T2TBILLAMT MONEY,            
            BILLAMT MONEY,            
            FUTUREPAYOUT MONEY,            
            SHORTAGE MONEY,            
            AMOUNTTOBEPAID MONEY,           
            PAYMODE VARCHAR(1),           
            BANKCODE VARCHAR(10),    
            RUNDATE DATETIME           
      )     
          
      CREATE  INDEX [PARTYCODE] ON [DBO].[#LEDGERBALANCE]([PARTYCODE]) ON [PRIMARY]           
          
      CREATE TABLE [#LEDGERBILLTMP]           
      (           
            [CLTCODE] [VARCHAR] (10)  NULL ,            
            [BRANCHCODE] [VARCHAR] (10)  NULL ,            
            [CL_TYPE] [VARCHAR] (3)  NULL ,            
            [LONGNAME] [VARCHAR] (100)  NULL ,            
            [ACCAT] [CHAR] (10)  NULL ,            
            [BTOBPAYMENT] [INT] NULL ,            
            [PAYMODE] [CHAR] (1)  NULL ,            
            [POBANKCODE] [VARCHAR] (10)  NULL,           
            [SETT_NO] [VARCHAR] (7) NOT NULL,           
            [NORMALBILLAMT] [MONEY],           
            [T2TBILLAMT] [MONEY],     
            [RUNDATE] [DATETIME]           
      ) ON [PRIMARY]          
    
    
/*===========================================================================    
      POPULATE BILL AMOUNTS FROM ACCBILL TABLE IN THE SHAREDB FOR NORMAL AND T2T SETTLEMENTS    
      DELETE CLIENTS WITH CLIENT TYPE SET AS ('MTF', 'PMS', 'WEB')     
===========================================================================*/     
      INSERT     
      INTO #LEDGERBILLTMP     
      SELECT     
            A.CLTCODE ,     
            A.BRANCHCODE,     
            C1.CL_TYPE, 
            LONGNAME,     
            ACCAT,     
            BTOBPAYMENT,     
            PAYMODE,     
            POBANKCODE,     
            SETT_NO = '',     
            NORMALBILLAMT = 0,     
            T2TBILLAMT = 0,     
            RUNDATE = GETDATE()     
      FROM ACMAST A WITH(NOLOCK), 
            MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK), 
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK) 
      WHERE A.CLTCODE BETWEEN @FPARTY AND @TPARTY     
            AND A.ACCAT IN (4, 104)                       
            AND A.CLTCODE = C2.PARTY_CODE
            AND C2.CL_CODE = C1.CL_CODE 
            AND C1.CL_TYPE LIKE @CL_TYPE 
            AND A.POBANKCODE IN     
                  (    
                  SELECT     
                              CLTCODE     
                        FROM ACMAST     
                        WITH(NOLOCK)     
                        WHERE ACCAT = 2    
                  )     
      GROUP BY A.CLTCODE,     
            A.BRANCHCODE,     
            C1.CL_TYPE, 
            LONGNAME,     
            ACCAT,     
            BTOBPAYMENT,     
            PAYMODE,     
            POBANKCODE                 
       
      CREATE  INDEX [CLTCODE] ON [DBO].[#LEDGERBILLTMP]([CLTCODE]) ON [PRIMARY]           
             
    
/*===========================================================================    
      CALCULATE NSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT     
===========================================================================*/    
      INSERT     
      INTO #LEDGERBALANCE     
      SELECT     
            L.CLTCODE ,     
            ACNAME = A.LONGNAME,     
            CHEQUENAME = A.LONGNAME,     
            A.BRANCHCODE,     
            A.CL_TYPE, 
            A.ACCAT,     
            A.BTOBPAYMENT ,     
            TOTLEDBAL = 0,     
            NSELEDBAL = SUM(    
                            CASE     
                              WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'     
                              THEN (
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN -VAMT     
                                    ELSE VAMT     
                              END    
                              )    
                              ELSE 0     
                        END     
                  ) + SUM(    
                        CASE     
                              WHEN EDT > @EFFDATE + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN -VAMT     
                                    ELSE 0     
                              END    
                              )     
                              ELSE 0     
                        END     
                  ),     
            BSELEDBAL = 0,     
            FNOLEDBAL = 0,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,     
            FUTUREPAYOUT = 0 ,     
            SHORTAGE = 0,     
            AMOUNTTOBEPAID = 0,     
            A.PAYMODE,     
            A.POBANKCODE,     
            RUNDATE      
      FROM #LEDGERBILLTMP A WITH(NOLOCK),     
            ACCOUNT..LEDGER L WITH(NOLOCK)     
      WHERE L.CLTCODE = A.CLTCODE     
            AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'     
      GROUP BY A.BRANCHCODE,     
            A.CL_TYPE, 
            L.CLTCODE,     
            A.LONGNAME,     
            A.ACCAT,     
            A.BTOBPAYMENT,     
            A.PAYMODE,     
            A.POBANKCODE,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            RUNDATE      
      
      UNION ALL
      
      SELECT     
            L.CLTCODE ,     
            ACNAME = A.LONGNAME,     
            CHEQUENAME = A.LONGNAME,     
            A.BRANCHCODE,     
            A.CL_TYPE, 
            A.ACCAT,     
            A.BTOBPAYMENT ,     
            TOTLEDBAL = 0,     
            NSELEDBAL = SUM(    
                              CASE     
                                     WHEN DRCR = 'D'     
                                     THEN VAMT     
                                     ELSE -VAMT     
                              END                                
                              ),     
            BSELEDBAL = 0,     
            FNOLEDBAL = 0,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,     
            FUTUREPAYOUT = 0 ,     
            SHORTAGE = 0,     
            AMOUNTTOBEPAID = 0,     
            A.PAYMODE,     
            A.POBANKCODE,     
            RUNDATE      
      FROM #LEDGERBILLTMP A WITH(NOLOCK),     
            ACCOUNT..LEDGER L WITH(NOLOCK)     
      WHERE L.CLTCODE = A.CLTCODE     
            AND L.EDT >= @SDATE 
            AND L.VDT < @SDATE
      GROUP BY A.BRANCHCODE,     
            A.CL_TYPE, 
            L.CLTCODE,     
            A.LONGNAME,     
            A.ACCAT,     
            A.BTOBPAYMENT,     
            A.PAYMODE,     
            A.POBANKCODE,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            RUNDATE    
    
/*===========================================================================    
      CALCULATE BSE CASH LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT     
===========================================================================*/    
      INSERT     
      INTO #LEDGERBALANCE     
      SELECT     
            L.CLTCODE ,     
            ACNAME = A.LONGNAME,     
            CHEQUENAME = A.LONGNAME,     
            A.BRANCHCODE,     
            A.CL_TYPE, 
            A.ACCAT,     
            A.BTOBPAYMENT ,     
            TOTLEDBAL = 0,     
            NSELEDBAL = 0,     
            BSELEDBAL = SUM(    
                            CASE     
                              WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN -VAMT     
                                    ELSE VAMT     
                              END    
                              )    
                              ELSE 0     
                        END     
                  ) + SUM(    
                        CASE     
                             WHEN EDT > @EFFDATE + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN -VAMT     
                                    ELSE 0     
                              END    
                              )     
                              ELSE 0     
                        END     
                  ),     
            FNOLEDBAL = 0,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,     
            FUTUREPAYOUT = 0 ,     
            SHORTAGE = 0,     
            AMOUNTTOBEPAID = 0,     
            A.PAYMODE,     
            A.POBANKCODE,     
            RUNDATE      
      FROM #LEDGERBILLTMP A WITH(NOLOCK),     
            ACCOUNTBSE..LEDGER L WITH(NOLOCK)     
      WHERE L.CLTCODE = A.CLTCODE     
            AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'     
      GROUP BY A.BRANCHCODE,     
            A.CL_TYPE, 
            L.CLTCODE,     
            A.LONGNAME,     
            A.ACCAT,     
            A.BTOBPAYMENT,     
            A.PAYMODE,     
            A.POBANKCODE,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            RUNDATE      

      UNION ALL

      SELECT     
            L.CLTCODE ,     
            ACNAME = A.LONGNAME,     
            CHEQUENAME = A.LONGNAME,     
            A.BRANCHCODE,     
            A.CL_TYPE, 
            A.ACCAT,     
            A.BTOBPAYMENT ,     
            TOTLEDBAL = 0,     
            NSELEDBAL = 0,     
            BSELEDBAL = SUM(    
                              CASE     
                                  WHEN DRCR = 'D'     
                                  THEN VAMT     
                                  ELSE -VAMT     
                              END
                              ),     
            FNOLEDBAL = 0,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,     
            FUTUREPAYOUT = 0 ,     
            SHORTAGE = 0,     
            AMOUNTTOBEPAID = 0,     
            A.PAYMODE,     
            A.POBANKCODE,     
            RUNDATE      
      FROM #LEDGERBILLTMP A WITH(NOLOCK),     
            ACCOUNTBSE..LEDGER L WITH(NOLOCK)     
      WHERE L.CLTCODE = A.CLTCODE     
            AND L.EDT >= @SDATE 
            AND L.VDT < @SDATE
      GROUP BY A.BRANCHCODE,     
            A.CL_TYPE, 
            L.CLTCODE,     
            A.LONGNAME,     
            A.ACCAT,     
            A.BTOBPAYMENT,     
            A.PAYMODE,     
            A.POBANKCODE,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            RUNDATE    
    
/*===========================================================================    
      CALCULATE NSE DERIVATIVE LEDGER BALANCES FOR CLIENTS WITH CREDIT IN THE SELECTED SETTLEMENT     
===========================================================================*/    
      INSERT     
      INTO #LEDGERBALANCE     
      SELECT     
            L.CLTCODE ,     
            ACNAME = A.LONGNAME,     
            CHEQUENAME = A.LONGNAME,     
            A.BRANCHCODE,     
            A.CL_TYPE, 
            A.ACCAT,     
            A.BTOBPAYMENT ,     
            TOTLEDBAL = 0,     
            NSELEDBAL = 0,     
            BSELEDBAL = 0,     
            FNOLEDBAL = SUM(    
                            CASE     
                              WHEN EDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN -VAMT     
                                    ELSE VAMT     
                              END    
                              )    
                              ELSE 0     
                        END     
                  ) + SUM(    
                        CASE     
                              WHEN EDT > @EFFDATE + ' 23:59:00'     
                              THEN (    
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN -VAMT     
                                    ELSE 0     
                              END    
                              )     
                              ELSE 0     
                        END     
                  ),     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,     
            FUTUREPAYOUT = 0 ,     
            SHORTAGE = 0,     
            AMOUNTTOBEPAID = 0,     
            A.PAYMODE,     
            A.POBANKCODE,     
            RUNDATE      
      FROM #LEDGERBILLTMP A WITH(NOLOCK),     
            ACCOUNTFO..LEDGER L WITH(NOLOCK)     
      WHERE L.CLTCODE = A.CLTCODE     
            AND L.VDT BETWEEN @SDATE + ' 00:00:00' AND @EFFDATE + ' 23:59:00'     
      GROUP BY A.BRANCHCODE,     
            A.CL_TYPE, 
            L.CLTCODE,     
            A.LONGNAME,     
            A.ACCAT,     
            A.BTOBPAYMENT,     
            A.PAYMODE,     
            A.POBANKCODE,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            RUNDATE             
    
      UNION ALL

      SELECT     
            L.CLTCODE ,     
            ACNAME = A.LONGNAME,     
            CHEQUENAME = A.LONGNAME,     
            A.BRANCHCODE,     
            A.CL_TYPE, 
            A.ACCAT,     
            A.BTOBPAYMENT ,     
            TOTLEDBAL = 0,     
            NSELEDBAL = 0,     
            BSELEDBAL = 0,     
            FNOLEDBAL = SUM(    
                              CASE     
                                    WHEN DRCR = 'D'     
                                    THEN VAMT     
                                    ELSE -VAMT     
                              END    
                              ),     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            BILLAMT = A.NORMALBILLAMT + A.T2TBILLAMT,     
            FUTUREPAYOUT = 0 ,     
            SHORTAGE = 0,     
            AMOUNTTOBEPAID = 0,     
            A.PAYMODE,     
            A.POBANKCODE,     
            RUNDATE      
      FROM #LEDGERBILLTMP A WITH(NOLOCK),     
            ACCOUNTFO..LEDGER L WITH(NOLOCK)     
      WHERE L.CLTCODE = A.CLTCODE     
            AND L.EDT >= @SDATE 
            AND L.VDT < @SDATE
      GROUP BY A.BRANCHCODE,     
            A.CL_TYPE, 
            L.CLTCODE,     
            A.LONGNAME,     
            A.ACCAT,     
            A.BTOBPAYMENT,     
            A.PAYMODE,     
            A.POBANKCODE,     
            A.SETT_NO,     
            A.NORMALBILLAMT,     
            A.T2TBILLAMT,     
            RUNDATE      
      HAVING SUM(    
                  CASE     
                        WHEN DRCR = 'D'     
                        THEN -VAMT     
                        ELSE VAMT     
                  END                       
            ) + SUM(    
                  CASE     
                        WHEN EDT > @EFFDATE + ' 23:59:00'      
                        THEN (    
                        CASE     
                              WHEN DRCR = 'D'     
                              THEN -VAMT     
                              ELSE 0     
                        END    
                        )     
                        ELSE 0     
                  END     
            ) < 0    
    
/*===========================================================================    
      INSERT INTO PHYSICAL TABLE FROM TEMP TABLE AFTER GROUPING AS REQUIRED     
===========================================================================*/    
      SELECT     
            PARTYCODE,    
            PARTYNAME,    
            CHEQUENAME,    
            BRANCHCODE,    
            CL_TYPE, 
            ACCAT,    
            BTOBPAYMENT,    
            TOTLEDBAL = SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL),    
            NSELEDBAL = SUM(NSELEDBAL),    
            BSELEDBAL = SUM(BSELEDBAL),    
            FNOLEDBAL = SUM(CASE WHEN FNOLEDBAL < 0 THEN FNOLEDBAL ELSE 0 END),    
/*            SETT_NO,    
            NORMALBILLAMT,    
            T2TBILLAMT,    
            BILLAMT,    */
            FUTUREPAYOUT,    
            SHORTAGE,    
            AMOUNTTOBEPAID,    
            PAYMODE,    
            BANKCODE,    
            RUNDATE     
      FROM #LEDGERBALANCE     
      GROUP BY PARTYCODE,    
            PARTYNAME,    
            CHEQUENAME,    
            BRANCHCODE,    
            CL_TYPE, 
            ACCAT,    
            BTOBPAYMENT,    
            SETT_NO,    
            NORMALBILLAMT,    
            T2TBILLAMT,    
            BILLAMT,    
            FUTUREPAYOUT,    
            SHORTAGE,    
            AMOUNTTOBEPAID,    
            PAYMODE,    
            BANKCODE,    
            RUNDATE     
      --HAVING    
            --SUM(NSELEDBAL + BSELEDBAL + FNOLEDBAL) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_CONTRAUPLOAD
-- --------------------------------------------------

CREATE PROC [dbo].[V2_OFFLINE_CONTRAUPLOAD](    
    
  @UNAME     VARCHAR(25),    
  @USERCAT   INT,    
  @EXCHANGE  VARCHAR(3),    
  @SEGMENT   VARCHAR(10),    
  @IP_VDATE varchar(11),    
  @RECOFLAG  CHAR(1) = 'N'    
)    
AS
/*    
V2_OFFLINE_CONTRAUPLOAD 'OFFLINE',1,'NSE','CAPITAL','DEC 29 2008','N'    
*/    
    
    
  SET NOCOUNT ON    
    
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/    
  DECLARE  @@STD_DATE        VARCHAR(11),    
           @@LST_DATE        VARCHAR(11),    
           @@BRANCHFLAG       AS TINYINT,    
           @@VNOFLAG          AS TINYINT,    
           @@VNOMETHOD       INT,    
           @@ACNAME          CHAR(100),    
           @@BOOKTYPE        CHAR(2),    
           @@MICRNO          VARCHAR(10),    
           @@DRCR            VARCHAR(1),    
           @@VTYP            SMALLINT,    
           @@BANK_CODE       VARCHAR(100),    
           @@BACKDAYS        INT,    
           @@BACKDATE        VARCHAR(11),    
           @@BRNCOUNT        TINYINT,    
           @@MonthlyVdt      VARCHAR(11),    
           @@SERIAL_NO       INT,    
           @@COSTCODECOUNT   TINYINT,    
           @@COSTCODEUPDATES CURSOR,    
           @@NEWVNO           AS VARCHAR(12),    
           @@MAXCOUNT         AS INT,    
           @@VDT              AS VARCHAR(11),    
           @@BANKBRANCH       AS VARCHAR(10),    
           @@BANKCOST         AS NUMERIC,    
           @@LNOCUR           AS CURSOR,    
           @@VNOCUR           AS CURSOR,    
           @@LNOVNO           AS VARCHAR(12),    
           @@MAXVNO           AS INT,    
           @@L2CUR            AS CURSOR,    
           @@L2VNO            AS VARCHAR(12),    
           @@ERROR_COUNT      AS BIGINT,    
           @@FILEEXISTS       AS INT,    
           @@SQL              AS VARCHAR(2000),    
           @ERRORCODE         AS INT,    
           @MESSAGE           AS VARCHAR(200) ,  
     @@VOUCHERNO    AS VARCHAR(12),     
     @@RECPAYTBLCOUNT   BIGINT    
    
 SET @@VTYP = 5   
 SET @@BOOKTYPE = '01'   
    
 BEGIN TRAN    
    
  CREATE TABLE [#RECPAY_TABLE] (    
    SERIAL_NO    INT   IDENTITY ( 1,1 ),    
    EDATE        VARCHAR(20),    
    VOUCHER_DATE VARCHAR(20),    
    CLIENT_CODE  VARCHAR(50),    
    AMOUNT       MONEY,    
    DRCR         VARCHAR(1),    
    NARRATION    VARCHAR(234),    
    BANK_CODE    VARCHAR(10),    
    BANK_NAME    VARCHAR(100),    
    REF_NO       VARCHAR(15),    
    BRANCHCODE   VARCHAR(20),    
    BRANCH_NAME  VARCHAR(50),    
    CHQ_MODE     VARCHAR(1),    
    CHQ_DATE     VARCHAR(20),    
    CHQ_NAME     VARCHAR(100),    
    CL_MODE      VARCHAR(1),    
    FLD_AUTO     BIGINT,    
    ENTEREDBY    VARCHAR(25),    
    VDT          DATETIME   NULL,    
    FYSTART      DATETIME   NULL,    
    FYEND        DATETIME   NULL,    
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),    
    EDT          DATETIME   NULL,    
    DDDT         DATETIME   NULL,    
    VNO          VARCHAR(12)   NULL,    
    VTYP         SMALLINT   NULL,    
    ACNAME       VARCHAR(100)   NULL,    
    COSTCODE     SMALLINT   NULL,    
    BANKCOST     SMALLINT   NULL,                  LNO          SMALLINT   NOT NULL   DEFAULT (0),    
    BANKNAME     VARCHAR(100)   NULL,    
    MICRNO       INT   NULL,    
    BOOKTYPE     VARCHAR(2)   NULL,    
    ACC_NO       VARCHAR(16),  
 VOUCHERNO  VARCHAR(12)   NULL)  
  ON [PRIMARY]    
    
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */    
  INSERT INTO #RECPAY_TABLE    
             (EDATE,    
              VOUCHER_DATE,    
              CLIENT_CODE,    
              AMOUNT,    
              DRCR,    
              NARRATION,    
              BANK_CODE,    
              BANK_NAME,    
              REF_NO,    
              BRANCHCODE,    
              BRANCH_NAME,    
              CHQ_MODE,    
              CHQ_DATE,    
              CHQ_NAME,    
              CL_MODE,    
              FLD_AUTO,    
              ENTEREDBY,    
     VDT,    
              EDT,    
              DDDT,    
              ACC_NO,VTYP,VOUCHERNO)    
  SELECT /*CONVERT(VARCHAR,EDATE,103),*/ ---BY BHRT FOR ENTRY POST SHOULD BE GETDATE FOR FULLERTON CLIENT
		 CONVERT(VARCHAR,GETDATE(),103),      	
         CONVERT(VARCHAR,VDATE,103),    
         CLTCODE,    
         AMOUNT = CASE WHEN CREDITAMT = '' THEN DEBITAMT ELSE CREDITAMT END,  
         DECR = CASE WHEN CREDITAMT = '' THEN 'D' ELSE 'C' END,   
         NARRATION,    
         OPPCODE,    
         OPPCODENAME,    
         DDNO,    
         'ALL',    
         'ALL',    
         CHEQUEMODE,    
         CONVERT(VARCHAR,CHEQUEDATE,103),    
         CHEQUENAME,    
         CLEAR_MODE,    
         FLDAUTO,    
         ADDBY,    
         VDATE,    
         GETDATE(),    
         CHEQUEDATE,    
         TPAccountNumber='', VOUCHERTYPE,VOUCHERNO    
  FROM   ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)    
  WHERE  VOUCHERTYPE = @@VTYP     
         AND EXCHANGE = @EXCHANGE    
         AND SEGMENT = @SEGMENT    
         AND ISNULL(ROWSTATE,0) = 0    
   AND VDATE LIKE @IP_VDATE + '%'    
   AND APPROVALFLAG = 1    
  
    
 SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE    
    
 IF @@RECPAYTBLCOUNT = 0    
 BEGIN    
  COMMIT    
  RETURN    
 END    
    
    
  UPDATE ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK)    
  SET    ROWSTATE = 9    
  FROM   #RECPAY_TABLE    
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO    
    
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)    
  FROM   #RECPAY_TABLE    
    
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),    
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),    
         @@BRANCHFLAG = BRANCHFLAG,    
         @@VNOFLAG = VNOFLAG    
  FROM   PARAMETER WITH(NOLOCK)    
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR    
    
  IF @@VNOFLAG <> 0    
    BEGIN    
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)    
      FROM   #RECPAY_TABLE    
    
      IF @@ERROR_COUNT > 1    
        BEGIN    
     DROP TABLE #RECPAY_TABLE    
     ROLLBACK TRANSACTION    
     SET @ERRORCODE = 1    
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'    
     EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
     RETURN    
        END    
    END    
    
  IF @@BRANCHFLAG = 1    
    BEGIN    
      UPDATE #RECPAY_TABLE    
      SET    BRANCHCODE = A.BRANCHCODE,    
             FYSTART = P.SDTCUR,    
             FYEND = P.LDTCUR,    
             UPDFLAG = 'Y',    
             ACNAME = A.LONGNAME,    
             COSTCODE = C.COSTCODE,    
             BANKNAME = A.LONGNAME,    
             BOOKTYPE = A.BOOKTYPE,    
             MICRNO = ISNULL(A.MICRNO,0)    
      FROM   ACMAST A WITH(NOLOCK),    
             PARAMETER P WITH(NOLOCK),    
             COSTMAST C WITH(NOLOCK)    
      WHERE  A.CLTCODE = BANK_CODE    
             AND P.CURYEAR = 1    
             AND A.ACCAT = '2'    
             AND A.BRANCHCODE = COSTNAME    
    
      UPDATE #RECPAY_TABLE    
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),    
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),    
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),    
             FYSTART = P.SDTCUR,    
             FYEND = P.LDTCUR,    
             UPDFLAG = 'Y',    
             ACNAME = A.LONGNAME,    
             COSTCODE = (SELECT TOP 1 COSTCODE    
                         FROM   COSTMAST    
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),    
             BANKNAME = A.LONGNAME,    
             BOOKTYPE = A.BOOKTYPE,    
             MICRNO = ISNULL(A.MICRNO,0)    
      FROM   ACMAST A WITH(NOLOCK),    
             PARAMETER P WITH(NOLOCK),    
             COSTMAST C WITH(NOLOCK)    
      WHERE  A.CLTCODE = BANK_CODE    
             AND P.CURYEAR = 1    
             AND A.ACCAT = '2'    
             AND A.BRANCHCODE = 'ALL'    
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'    
    
      UPDATE #RECPAY_TABLE    
      SET    BRANCHCODE = 'HO',    
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),    
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),    
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),    
             FYSTART = P.SDTCUR,    
             FYEND = P.LDTCUR,    
    UPDFLAG = 'Y',    
             ACNAME = A.LONGNAME,    
             COSTCODE = (SELECT TOP 1 COSTCODE    
                         FROM   COSTMAST    
             WHERE  COSTNAME = 'HO'),    
             BANKNAME = A.LONGNAME,    
             BOOKTYPE = A.BOOKTYPE,    
             MICRNO = ISNULL(A.MICRNO,0)    
      FROM   ACMAST A WITH(NOLOCK),    
             PARAMETER P WITH(NOLOCK),    
             COSTMAST C WITH(NOLOCK)    
     WHERE  A.CLTCODE = BANK_CODE    
             AND P.CURYEAR = 1    
             AND A.ACCAT = '2'    
             AND A.BRANCHCODE = 'ALL'    
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'    
    END    
 ELSE    
    BEGIN    
      UPDATE #RECPAY_TABLE    
      SET    FYSTART = @@STD_DATE,    
             FYEND = @@LST_DATE + ' 23:59:59',    
             UPDFLAG = 'Y',    
             ACNAME = A.LONGNAME,    
             BANKNAME = A.LONGNAME,    
             BOOKTYPE = A.BOOKTYPE,    
             MICRNO = ISNULL(A.MICRNO,0)    
      FROM   ACMAST A WITH(NOLOCK)    
      WHERE  A.CLTCODE = BANK_CODE  
             AND A.ACCAT = '2'    
    END    
    
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */    
  SELECT @@ERROR_COUNT = COUNT(SERIAL_NO)    
  FROM   #RECPAY_TABLE    
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND    
    
  IF @@ERROR_COUNT > 0    
    BEGIN    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
    
  SET @@ERROR_COUNT = 0    
    
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/    
  SELECT @@ERROR_COUNT = COUNT(1)    
  FROM   #RECPAY_TABLE    
  WHERE  VDT > EDT    
    
  IF @@ERROR_COUNT > 0    
    BEGIN    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
            /*----------VALIDATION FOR ZERO AMOUNT --------*/    
 /* SELECT @@ERROR_COUNT = COUNT(1)    
  FROM   #RECPAY_TABLE    
  WHERE  AMOUNT <= 0    
    
  IF @@ERROR_COUNT > 0    
    BEGIN    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END  */  
  
 /*-----------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ----*/   
   SELECT @@ERROR_COUNT = COUNT(1) FROM  
 (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 FROM #RECPAY_TABLE  
 HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A  
  
 IF @@ERROR_COUNT > 0  
   BEGIN  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   SET @ERRORCODE = 1  
   SET @MESSAGE ='DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'  
      EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME  
      RETURN  
      END  
    
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */    
  SELECT @@ERROR_COUNT = COUNT(1)    
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,    
                          CLTCODE = RP.CLIENT_CODE    
   FROM   #RECPAY_TABLE RP,    
                 LEDGER L WITH(NOLOCK),    
                 LEDGER1 L1 WITH(NOLOCK)    
          WHERE  L1.DDNO = RP.REF_NO    
                 AND L1.DD = RP.CHQ_MODE    
                 AND L1.DRCR = @@DRCR    
                 AND L1.VTYP = @@VTYP    
                 AND RP.REF_NO <> 0    
                 AND L.VTYP = @@VTYP    
                 AND L.VNO = L1.VNO    
                 AND L.BOOKTYPE = L1.BOOKTYPE    
                 AND L.DRCR = @@DRCR    
                 AND L.CLTCODE = RP.CLIENT_CODE) A    
    
  IF @@ERROR_COUNT > 0    
    BEGIN    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
    
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/    
  SELECT @@ERROR_COUNT = COUNT(1)    
  FROM   (SELECT DISTINCT CLIENT_CODE    
          FROM   #RECPAY_TABLE    
          WHERE  UPDFLAG = 'N') A    
    
  IF @@ERROR_COUNT > 0    
    BEGIN    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
    
  /*    ----------AUTO GENERATION OF VNO -------- */    
 CREATE TABLE    
    #BANK_VNO    
    (    
     VOUCHERNO VARCHAR(12),    
     NEWSRNO INT IDENTITY (1, 1)    
    )    
    
   INSERT INTO    
    #BANK_VNO    
   SELECT    
    DISTINCT VOUCHERNO    
   FROM    
    #RECPAY_TABLE    
       
   SELECT TOP 1    
    @@VDT = VDT    
   FROM    
    #RECPAY_TABLE    
    
   SELECT    
    @@STD_DATE = LEFT(SDTCUR, 11),    
    @@LST_DATE = LEFT(LDTCUR, 11),    
    @@VNOMETHOD = VNOFLAG    
   FROM    
    PARAMETER    
   WHERE    
    @@VDT BETWEEN SDTCUR AND LDTCUR    
    
   SELECT    
    @@MAXCOUNT = COUNT(DISTINCT VOUCHERNO)    
   FROM    
    #RECPAY_TABLE    
    
   SELECT    
    LASTVNO    
   INTO #VNO    
   FROM    
    V2_LASTVNO    
   WHERE    
    1 = 2    
    
   SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO    
    
   INSERT INTO    
    #VNO    
   EXEC     
    ACC_GENVNO_NEW    
     @@VDT,    
     @@VTYP,    
     @@BOOKTYPE,    
     @@STD_DATE,    
     @@LST_DATE,    
     @@MAXVNO    
    
   SELECT    
    @@NEWVNO = LASTVNO    
   FROM    
    #VNO    
          
   UPDATE    
    RP    
   SET     
    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))    
   FROM    
    #RECPAY_TABLE RP,    
    #BANK_VNO BV    
   WHERE    
      RP.VOUCHERNO = BV.VOUCHERNO  
    
   DROP TABLE #VNO    
   DROP TABLE #BANK_VNO       
    
  /*   ----------AUTO GENERATION OF LNO -------- */    
  --bhrt  
  CREATE TABLE [#RECPAY_TABLE_LNO]  
 (  
  SNO VARCHAR(12) ,  
  LNO INT IDENTITY (1, 1) NOT NULL  
 ) ON [PRIMARY]  
  
 SET @@LNOCUR = CURSOR FOR  
  SELECT DISTINCT VOUCHERNO FROM #RECPAY_TABLE  
 OPEN @@LNOCUR  
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO  
 WHILE @@FETCH_STATUS = 0  
  BEGIN  
  
   INSERT INTO #RECPAY_TABLE_LNO  
    (SNO)  
   SELECT SERIAL_NO FROM #RECPAY_TABLE WHERE VOUCHERNO = @@LNOVNO  
   UPDATE RP  
    SET LNO = RL.LNO  
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL  
   WHERE RP.SERIAL_NO = RL.SNO  
   TRUNCATE TABLE #RECPAY_TABLE_LNO  
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO  
  END  
 CLOSE @@LNOCUR  
 DEALLOCATE @@LNOCUR  
 DROP TABLE #RECPAY_TABLE_LNO  
    
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */    
  INSERT INTO LEDGER1    
             (BNKNAME,    
              BRNNAME,    
              DD,    
     DDNO,    
              DDDT,    
              RELDT,    
              RELAMT,    
              REFNO,    
              RECEIPTNO,    
              VTYP,    
              VNO,    
              LNO,    
     DRCR,    
              BOOKTYPE,    
              MICRNO,    
              SLIPNO,    
              SLIPDATE,    
              CHEQUEINNAME,    
              CHQPRINTED,    
              CLEAR_MODE)    
  SELECT   BNKNAME = MAX(BANK_NAME),    
           BRNNAME = MAX(BRANCH_NAME),    
           DD = MAX(CHQ_MODE),    
           DDNO = MAX(REF_NO),    
           DDDT = MAX(DDDT),    
           RELDT = '',    
           RELAMT = SUM(AMOUNT),    
           REFNO = 0,    
           RECEIPTNO = 0,    
           VTYP,    
           VNO,    
           LNO,    
           DRCR,    
           BOOKTYPE = BOOKTYPE,    
           MICRNO = MICRNO,    
           SLIPNO = 0,    
           SLIPDATE = '',    
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),    
           CHQPRINTED = 0,    
           CLEAR_MODE = MAX(CL_MODE)    
  FROM     #RECPAY_TABLE    
  GROUP BY VTYP,VNO,LNO,DRCR,BOOKTYPE,    
           MICRNO    
    
  IF @@ERROR <> 0    
    BEGIN    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
  
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/    
  CREATE TABLE #LEDGER (    
    VTYP      SMALLINT,    
    VNO       VARCHAR(12),    
    EDT       DATETIME,    
    LNO       SMALLINT,    
    ACNAME    VARCHAR(100),    
    DRCR      VARCHAR(1),    
    VAMT      MONEY,    
    VDT       DATETIME,    
    VNO1      VARCHAR(12),    
    REFNO     CHAR(12),    
    BALAMT    MONEY,    
    NODAYS    INT,    
    CDT       DATETIME,    
    CLTCODE   VARCHAR(10),    
    BOOKTYPE  VARCHAR(2),    
    ENTEREDBY VARCHAR(25),    
    PDT       DATETIME,    
    CHECKEDBY VARCHAR(25),    
    ACTNODAYS INT,    
    NARRATION VARCHAR(234))    
    
  CREATE TABLE #LEDGER3 (    
    NARATNO  INT,    
    NARR     VARCHAR(234),    
    REFNO    CHAR(12),    
    VTYP     SMALLINT,    
    VNO      VARCHAR(12),    
    BOOKTYPE VARCHAR(2))    
    
/*======CLIENT SIDE RECORD======*/    
  INSERT INTO #LEDGER    
             (VTYP,    
              VNO,    
              EDT,    
              LNO,    
              ACNAME,    
              DRCR,    
     VAMT,    
              VDT,    
              VNO1,    
              REFNO,    
              BALAMT,    
              NODAYS,    
              CDT,    
              CLTCODE,    
              BOOKTYPE,    
              ENTEREDBY,    
              PDT,    
              CHECKEDBY,    
              ACTNODAYS,    
              NARRATION)    
  SELECT VTYP,    
         VNO,    
         EDT = (CASE    
                  WHEN VTYP = 5    
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/    
                  ELSE EDT    
                END),    
         LNO,    
         ACNAME,    
         DRCR,    
         VAMT = AMOUNT,    
         VDT,    
         VNO1 = VNO,    
         REFNO = 0,    
         BALAMT = AMOUNT,    
         NODAYS = 0,    
         CDT = GETDATE(),    
         CLTCODE = BANK_CODE,    
         BOOKTYPE = BOOKTYPE,    
         ENTEREDBY = ENTEREDBY,    
         PDT = GETDATE(),    
         CHECKEDBY = @UNAME,    
         ACTNODAYS = 0,    
         NARRATION    
  FROM   #RECPAY_TABLE    
    
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/    
  INSERT INTO LEDGER    
             (VTYP,    
              VNO,    
              EDT,    
              LNO,    
              ACNAME,    
              DRCR,    
              VAMT,    
              VDT,    
              VNO1,    
              REFNO,    
              BALAMT,    
              NODAYS,    
              CDT,    
              CLTCODE,    
              BOOKTYPE,    
              ENTEREDBY,    
              PDT,    
              CHECKEDBY,    
              ACTNODAYS,    
              NARRATION)    
  SELECT   VTYP,    
           VNO,    
           EDT,    
           LNO,    
           ACNAME,    
           DRCR,    
           VAMT,    
           VDT,    
           VNO1,    
           REFNO,    
           BALAMT,    
           NODAYS,    
           CDT,    
           CLTCODE,    
           BOOKTYPE,    
   ENTEREDBY,    
           PDT,    
           CHECKEDBY,    
           ACTNODAYS,    
           NARRATION    
  FROM     #LEDGER    
  ORDER BY BOOKTYPE,    
           VTYP,    
           VNO,    
           LNO    
    
  IF @@ERROR <> 0    
    BEGIN    
    DROP TABLE #LEDGER    
    DROP TABLE #LEDGER3    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
    
  DROP TABLE #LEDGER    
    
/*======CLIENT SIDE RECORD======*/    
  INSERT INTO #LEDGER3    
  SELECT NARATNO = LNO,    
         NARR = NARRATION,    
         REFNO = 0,    
         VTYP,    
         VNO,    
         BOOKTYPE    
  FROM   #RECPAY_TABLE    
    
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/    
  INSERT INTO LEDGER3    
  SELECT   *    
  FROM     #LEDGER3    
  ORDER BY BOOKTYPE,    
           VTYP,    
           VNO,    
           NARATNO    
    
  IF @@ERROR <> 0    
    BEGIN    
    DROP TABLE #LEDGER3    
    DROP TABLE #RECPAY_TABLE    
    ROLLBACK TRAN    
    SET @ERRORCODE = 1    
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME    
    RETURN    
    END    
  DROP TABLE #LEDGER3    
  
  IF @@BRANCHFLAG = 1    
    BEGIN    
  
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO    
                               FROM     #RECPAY_TABLE    
                               ORDER BY VNO    
      OPEN @@L2CUR    
    
      FETCH NEXT FROM @@L2CUR    
      INTO @@L2VNO    
    
      WHILE @@FETCH_STATUS = 0    
        BEGIN    
          DELETE FROM TEMPLEDGER2    
          WHERE       SESSIONID = '9999999999'    
  
  /*======CLIENT SIDE RECORD======*/    
          INSERT INTO TEMPLEDGER2    
          SELECT 'BRANCH',    
                 C.COSTNAME,    
                 AMOUNT,    
                 VTYP,    
                 VNO,    
                 LNO,    
                 DRCR,    
                 '0',    
                 BOOKTYPE,    
                 '9999999999',    
                 BANK_CODE,    
                 'A',    
                 '0'    
    FROM   #RECPAY_TABLE RP,    
                 COSTMAST C WITH(NOLOCK)    
          WHERE  RP.COSTCODE = C.COSTCODE    
                 AND VNO = @@L2VNO    
    
          EXEC INSERTTOLEDGER2    
            '9999999999' ,    
            @@L2VNO ,    
            '1' ,    
            '1' ,    
            '1' ,    
            'BROKER' ,    
            'BROKER'    
    
  FETCH NEXT FROM @@L2CUR    
          INTO @@L2VNO    
        END    
  
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)    
      WHERE       SESSIONID = '9999999999'    
 END    
  
UPDATE ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK)    
SET    
 ROWSTATE = 1,    
 APPROVALFLAG = 1,    
 APPROVALDATE = GETDATE(),  
 UPLOADDT = GETDATE(),   
 --APPROVEDBY = 'SYSTEM',    
 LEDGERVNO = VNO    
FROM   #RECPAY_TABLE    
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO    

COMMIT TRAN    
    
DROP TABLE #RECPAY_TABLE    
SET @ERRORCODE = 0    
SET @MESSAGE = 'POSTED SUCCESSFULLY'    
EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_COSTCENTER_REPORT
-- --------------------------------------------------
CREATE Procedure V2_OFFLINE_COSTCENTER_REPORT  
as  
  
select  /*a.FldAuto as [S No],  */
 a.VoucherNo as [Ref No],  
 a.LedgerVNo as [V No],  
 a.VoucherType as [V Type],    
 a.BookType as [Book Type],    
 a.SNo  as [L No],    
 a.VDate as [V Dt],    
 a.Edate as [E Dt],    
 a.CltCode  as [Clt Code],    
 a.OppCode  as [GL Code],    
 [Credit Amt] = (Case when b.CreditAmt <> 0 then b.CreditAmt else a.CreditAmt end),  
 [Debit Amt] = (case when b.DebitAmt <> 0 then b.DebitAmt else a.DebitAmt end),  
 isnull(b.BranchCode, a.BranchCode) as [Branch Cd],  
 isnull(b.CatCode, a.BranchCode) as [Cat Cd],  
 isnull(b.CostCode, a.BranchCode) as [Cost Cd]/*,  
 a.addby  as [Add By],    
 a.adddt  as [Add Dt] */
from   
 v2_offline_cc_entries b  
inner  join   
 v2_offline_ledger_entries a  
 on (b.VOLE_RefNo = a.FldAuto)  
Where  
 a.RowState = 0  
Order by A.FldAuto

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_ENTRIES_FROMLEDGER
-- --------------------------------------------------
CREATE Proc V2_OFFLINE_ENTRIES_FROMLEDGER    
(@EXCHANGE VARCHAR(3), @SEGMENT VARCHAR(10))  
  
as    
  
--INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
Select z.*  from     
(    
Select l.Vtyp, l.BookTYpe,  
Lno =(case when L.vtyp not in ('6','7','8') then    
 CAST(L.LNO AS INT) - 1   
else  
 l.lno  
   end    
 ),  
vdt =cast(left(l.Vdt,11) as datetime), evdt =cast(left(l.edt,11) as datetime), l.CltCode,CreditAmt= Case when L.drcr = 'C' then l.Vamt else 0 end ,    
DebitAmt = Case when L.drcr = 'D' then l.Vamt else 0 end,     
l.Narration,     
OppCode = (case when L.vtyp not in (6,7,8) then    
  case when L.lno = 1 then l.CltCode     
   else    
    (Select top 1 CltCode from Ledger x where x.vno = l.vno and x.vtyp = l.vtyp and x.booktype = l.booktype and x.lno = 1)    
   end    
    else '' end),    
MARGINCODE = '',  
BankName= l1.BNKNAME,    
BankBranch = L1.BRNNAME, a.BranchCode,     
DDNo = L1.DDNO,     
ChqMode =  L1.DD,  
ChqDt = L1.DDDT,     
ChqName = L1.CHEQUEINNAME,    
ClearMode = L1.CLEAR_MODE,     
TPACNum = (CASE WHEN A.ACNAME = L1.CHEQUEINNAME THEN 1 ELSE 0 END),   
Exchange='NSE',    
Segment='CAPITAL',    
TPFlag = '0',    
AddDt = l.pdt,     
AddBy = l.EnteredBy,    
StatusId= 'STATUSID',    
StatusName = 'STATUSNAME',    
RowState = 1,    
ApprovalFlag = 1,    
ApprovedDt = l.pdt,     
ApprovedBy = l.CheckedBy,     
VoucherNo = l.Vno,     
UploadDt = l.Pdt,     
LedgerVno = l.vno,     
ClientName = a.AcName,     
OppCodeName = a.AcName,     
MarginCodeName = '',    
SettNo = '',    
SettType = '',    
ProductType = '',    
RevAmt = 0,    
RevCode = '',    
MICR = L1.MICRNO
From Ledger l    
join acmast a    
on (a.cltcode = l.cltcode)    
LEFT OUTER JOIN LEDGER1 L1  
ON (L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE AND L1.LNO = L.LNO)  
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE = L.BOOKTYPE AND L2.LNO = L.LNO)  
Where l.Vtyp < '10'    
) z     
where z.cltcode <> z.oppcode    
Order by VTyp    
    
--INSERT INTO V2_OFFLINE_CC_ENTRIES  
SELECT V.FLDAUTO, 
CCCREDIT = CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END,
CCDEBIT = CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END,
V.CLTCODE, 
V.OPPCODE,
V.BRANCHCODE,
C.CATEGORY,
CM.COSTNAME,
V.ADDBY,
V.STATUSID,
V.STATUSNAME,
V.ADDDT
FROM V2_OFFLINE_LEDGER_ENTRIES V
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = V.VOUCHERTYPE AND L2.VNO = V.LEDGERVNO AND L2.BOOKTYPE = V.BOOKTYPE AND L2.LNO = V.SNO)  
WHERE ISNULL(C.CATEGORY,'') <> ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_LEDGER_REPORT
-- --------------------------------------------------
 
CREATE PROC V2_OFFLINE_LEDGER_REPORT            
(            
@startDate varchar(11),            
@endDate varchar(11),          
@fromParty varchar(10),          
@toParty varchar(10),      
@Selectionby VARCHAR(3),
@SortBy varchar(6),
@EXCSEGMENT VARCHAR(11)         
)            
AS          
    
/*    
EXEC V2_OFFLINE_LEDGER_REPORT 'SEP  1 2007','SEP 17 2007','0a141','0a141','VDT'    
*/    
    
DECLARE @@QRY AS VARCHAR(8000)    
DECLARE @@CLOSEBALQRY as VARCHAR(8000)
DECLARE @@OPENDATE AS VARCHAR(11)    
DECLARE @@FINSTART AS DATETIME    
DECLARE @@FINSTARTCHAR AS VARCHAR(11)    
    
SELECT @@QRY = "  "
SELECT @@CLOSEBALQRY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "    
    
SELECT @@FINSTART = SDTCUR, @@FINSTARTCHAR = LEFT(SDTCUR,11) FROM PARAMETER (NOLOCK) WHERE CONVERT(DATETIME,@startDate,109) BETWEEN SDTCUR AND LDTCUR      
    
IF UPPER(@SELECTIONBY) = 'VDT'    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND VDATE <= @@FINSTART)    
    
    
END    
ELSE    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND EDATE <= @@FINSTART)    
END    
    
    
IF Upper(@Selectionby) = 'VDT'      
  BEGIN      
  IF @startDate = @@FINSTART     
        Begin      
   If @@Opendate = @@FINSTARTCHAR       
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "   
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "   
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
   Else      
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "      
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
        End      
  Else      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
END       
ELSE     
  BEGIN      
  If @StartDate = @@FINSTARTCHAR And @@Opendate = @@FINSTARTCHAR      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
  Else      
        Begin      
    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) <= 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) > 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "     
      SELECT @@QRY = @@QRY + " FROM "     
      SELECT @@QRY = @@QRY + " (Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE  "    
      SELECT @@QRY = @@QRY + " UNION ALL  "    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And EDATE < '" + @@FINSTARTCHAR + "' AND VOUCHERTYPE <> 18"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE ) T"     
      SELECT @@QRY = @@QRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE "    
        End      
  End      
    
    
 SELECT @@QRY = @@QRY + " UNION ALL "    
 SELECT @@QRY = @@QRY + " select A.Exchange, A.Segment, "     
 SELECT @@QRY = @@QRY + " UPPER(ISNULL(V.SHORTDESC,'')) AS VNAME, "       
 SELECT @@QRY = @@QRY + " A.VOUCHERTYPE AS VTYP, "    
 SELECT @@QRY = @@QRY + " A.BOOKTYPE AS BOOKTYPE, "      
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Vdate,105) as VDt, "            
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Edate,105) as Edt, "            
 SELECT @@QRY = @@QRY + " a.OppCode as GLCode, "    
 SELECT @@QRY = @@QRY + " a.CltCode,"    
 SELECT @@QRY = @@QRY + " a.BranchCode,"    
 SELECT @@QRY = @@QRY + " a.CreditAmt, "          
 SELECT @@QRY = @@QRY + " a.DebitAmt,"           
 SELECT @@QRY = @@QRY + " a.Narration, "                   
 SELECT @@QRY = @@QRY + " a.VoucherNo as VNO, "        
 SELECT @@QRY = @@QRY + " a.Vdate, "     
 SELECT @@QRY = @@QRY + " a.BankName, "   
 SELECT @@QRY = @@QRY + " a.BranchName "   
 SELECT @@QRY = @@QRY + " from "        
 SELECT @@QRY = @@QRY + " v2_offline_ledger_entries a (NOLOCK) "    
 SELECT @@QRY = @@QRY + " LEFT OUTER JOIN "    
 SELECT @@QRY = @@QRY + " VMAST V ON (V.VTYPE = A.VOUCHERTYPE) "       
 SELECT @@QRY = @@QRY + " Where 1=1 "        
 IF Upper(@Selectionby) = 'VDT'    
 BEGIN      
 SELECT @@QRY = @@QRY + " And a.vDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.vDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "           
 END    
 ELSE    
 BEGIN    
 SELECT @@QRY = @@QRY + " And a.EDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.EDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "    
 END    
 SELECT @@QRY = @@QRY + " and a.CltCode >= '" + @FromParty + "' "         
 SELECT @@QRY = @@QRY + " and a.CltCode <= '" + @ToParty + "'"         
 SELECT @@QRY = @@QRY + " AND A.VOUCHERTYPE <> '18'"      
 	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END 


      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSEBAL' AS VNAME, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VTYP, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BOOKTYPE, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as VDt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as Edt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as GLCode, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " CltCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " BranchCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) > 0 THEN SUM(CREDITAMT) - SUM(DEBITAMT) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) <= 0 THEN SUM(DEBITAMT) - SUM(CREDITAMT) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSING BALANCE' AS Narration, "                   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VNO, "        
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '31-DEC-2049' AS Vdate, "     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BankName, "   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BranchName "  
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " FROM "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ( "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ) X " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " UNION ALL " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	if @SORTBY = 'DTASC'
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate asc" 
	end
	else
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate desc" 
	end
EXEC (@@CLOSEBALQRY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_MARGINPAYMENTCASHUPLOAD
-- --------------------------------------------------
CREATE PROC [dbo].[V2_OFFLINE_MARGINPAYMENTCASHUPLOAD](

           @UNAME     VARCHAR(25),
           @USERCAT   INT,
           @EXCHANGE  VARCHAR(3),
           @SEGMENT   VARCHAR(10),
		   @IP_VDATE varchar(11),
           @RECOFLAG  CHAR(1) = 'N')

AS

--SET XACT_ABORT ON
/*
V2_OFFLINE_MARGINPAYMENTCASHUPLOAD 'OFFLINE', 1, 'NSE', 'CAPITAL', 'NOV 21 2008','N'
*/

  SET NOCOUNT ON

  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/
  DECLARE  @@STD_DATE        VARCHAR(11),
           @@LST_DATE        VARCHAR(11),
           @@BRANCHFLAG       AS TINYINT,
           @@VNOFLAG          AS TINYINT,
           @@VNOMETHOD       INT,
           @@ACNAME          CHAR(100),
           @@BOOKTYPE        CHAR(2),
           @@MICRNO          VARCHAR(10),
           @@DRCR            VARCHAR(1),
           @@VTYP            SMALLINT,
           @@BANK_CODE       VARCHAR(100),
           @@BACKDAYS        INT,
           @@BACKDATE        VARCHAR(11),
           @@BRNCOUNT        TINYINT,
           @@MonthlyVdt      VARCHAR(11),
           @@SERIAL_NO       INT,
           @@COSTCODECOUNT   TINYINT,
           @@COSTCODEUPDATES CURSOR,
           @@NEWVNO           AS VARCHAR(12),
           @@MAXCOUNT         AS INT,
           @@VDT              AS VARCHAR(11),
           @@BANKBRANCH       AS VARCHAR(10),
           @@BANKCOST         AS NUMERIC,
           @@LNOCUR           AS CURSOR,
           @@VNOCUR           AS CURSOR,
           @@LNOVNO           AS VARCHAR(12),
           @@MAXVNO           AS INT,
           @@L2CUR            AS CURSOR,
           @@L2VNO            AS VARCHAR(12),
           @@ERROR_COUNT      AS BIGINT,
           @@FILEEXISTS       AS INT,
           @@SQL              AS VARCHAR(2000),
           @ERRORCODE         AS INT,
           @MESSAGE           AS VARCHAR(200) ,
           @@RECPAYTBLCOUNT BIGINT


 SET @@VTYP = 23

       BEGIN TRAN

  CREATE TABLE [#RECPAY_TABLE] (
    SNO    INT   IDENTITY ( 1,1 ),
    EDATE        VARCHAR(20),
    VOUCHER_DATE VARCHAR(20),
    CLIENT_CODE  VARCHAR(50),
	MCLIENT_CODE  VARCHAR(50),
    AMOUNT       MONEY,
    DRCR         VARCHAR(1),
    NARRATION    VARCHAR(234),
    BANK_CODE    VARCHAR(10),
    BANK_NAME    VARCHAR(100),
    REF_NO       VARCHAR(15),
    BRANCHCODE   VARCHAR(20),
    BRANCH_NAME  VARCHAR(50),
    CHQ_MODE     VARCHAR(1),
    CHQ_DATE     VARCHAR(20),
    CHQ_NAME     VARCHAR(100),
    CL_MODE      VARCHAR(1),
    FLD_AUTO     BIGINT,
    ENTEREDBY    VARCHAR(25),
    VDT          DATETIME   NULL,
    FYSTART      DATETIME   NULL,
    FYEND        DATETIME   NULL,
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),
    EDT          DATETIME   NULL,
    DDDT         DATETIME   NULL,
    VNO          VARCHAR(12)   NULL,
    VTYP         SMALLINT   NULL,
    ACNAME       VARCHAR(100)   NULL,
    COSTCODE     SMALLINT   NULL,
    BANKCOST     SMALLINT   NULL,
    LNO          SMALLINT   NOT NULL DEFAULT (0),
    BANKNAME     VARCHAR(100)   NULL,
    MICRNO       INT   NULL,
    BOOKTYPE     VARCHAR(2)   NULL,
    ACC_NO       VARCHAR(16),
	SETT_NO		 VARCHAR(7),
	SETT_TYPE	 VARCHAR(3))
  ON [PRIMARY]

  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */
  INSERT INTO #RECPAY_TABLE
             (EDATE,
              VOUCHER_DATE,
              CLIENT_CODE,
			  MCLIENT_CODE,
              AMOUNT,
              DRCR,
              NARRATION,
              BANK_CODE,
              BANK_NAME,
              REF_NO,
              BRANCHCODE,
              BRANCH_NAME,
              CHQ_MODE,
              CHQ_DATE,
              CHQ_NAME,
              CL_MODE,
              FLD_AUTO,
              ENTEREDBY,
              VDT,
              EDT,
              DDDT,
              ACC_NO,
			  VTYP,
			  SETT_NO,
			  SETT_TYPE)
  SELECT CONVERT(VARCHAR,EDATE,103),
         CONVERT(VARCHAR,VDATE,103),
         CLTCODE,
		 MARGINCODE,
         DEBITAMT,
         'D',
         NARRATION,
         OPPCODE,
         BANKNAME,
         DDNO,
         'ALL',
         BRANCHNAME,
         CHEQUEMODE,
         CONVERT(VARCHAR,CHEQUEDATE,103),
         CHEQUENAME,
         CLEAR_MODE,
         FLDAUTO,
         ADDBY,
		 VDATE,
         EDATE,
         CHEQUEDATE,
         TPAccountNumber,
		 VOUCHERTYPE,
		 SETT_NO,
		 SETT_TYPE
  FROM   ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)
  WHERE  VOUCHERTYPE = @@VTYP
         AND EXCHANGE = @EXCHANGE
         AND SEGMENT = @SEGMENT
         AND ISNULL(ROWSTATE,0) = 0
   AND ISNULL(APPROVALFLAG,0) = 1
   AND VDATE LIKE @IP_VDATE + '%'



  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE

 IF @@RECPAYTBLCOUNT = 0
 BEGIN
  COMMIT
  RETURN
 END



  UPDATE ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK)
  SET    ROWSTATE = 9
  FROM   #RECPAY_TABLE
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)
  FROM   #RECPAY_TABLE

  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),
         @@BRANCHFLAG = BRANCHFLAG,
         @@VNOFLAG = VNOFLAG
  FROM   PARAMETER WITH(NOLOCK)
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR

  IF @@VNOFLAG <> 0
    BEGIN
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)
      FROM   #RECPAY_TABLE

      IF @@ERROR_COUNT > 1
        BEGIN
     DROP TABLE #RECPAY_TABLE
     ROLLBACK TRANSACTION                                           SET @ERRORCODE = 1
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'
     EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
     RETURN
      END
    END

  IF @@BRANCHFLAG = 1
    BEGIN
      UPDATE #RECPAY_TABLE
      SET    BRANCHCODE = A.BRANCHCODE,
             FYSTART = P.SDTCUR,
           FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = C.COSTCODE,
             BANKNAME = B.LONGNAME,
             BOOKTYPE = B.BOOKTYPE,
             MICRNO = ISNULL(B.MICRNO,0)
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK),
             COSTMAST C WITH(NOLOCK),
             ACMAST B WITH(NOLOCK)
      WHERE  A.CLTCODE = MCLIENT_CODE
             AND B.CLTCODE = BANK_CODE
             --AND P.CURYEAR = 1
			 AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR
             AND A.ACCAT IN ('3','4','18')
             AND B.ACCAT = '1'
             AND A.BRANCHCODE = COSTNAME

      UPDATE #RECPAY_TABLE
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = (SELECT TOP 1 COSTCODE
                         FROM   COSTMAST
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),
             BANKNAME = B.LONGNAME,
             BOOKTYPE = B.BOOKTYPE,
             MICRNO = ISNULL(B.MICRNO,0)
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK),
             COSTMAST C WITH(NOLOCK),
             ACMAST B WITH(NOLOCK)
      WHERE  A.CLTCODE = MCLIENT_CODE
             AND B.CLTCODE = BANK_CODE
             --AND P.CURYEAR = 1
			 AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR
             AND A.ACCAT IN ('3','4','18','14')
             AND B.ACCAT = '1'
             AND A.BRANCHCODE = 'ALL'
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'

      UPDATE #RECPAY_TABLE
      SET    BRANCHCODE = 'HO',
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = (SELECT TOP 1 COSTCODE
                         FROM   COSTMAST
						 WHERE  COSTNAME = 'HO'),
             BANKNAME = B.LONGNAME,
             BOOKTYPE = B.BOOKTYPE,
             MICRNO = ISNULL(B.MICRNO,0)
      FROM   ACMAST A WITH(NOLOCK),
			 PARAMETER P WITH(NOLOCK),
             --COSTMAST C WITH(NOLOCK),
             ACMAST B WITH(NOLOCK)
      WHERE  A.CLTCODE = MCLIENT_CODE
             AND B.CLTCODE = BANK_CODE
             --AND P.CURYEAR = 1
			 AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR
             AND A.ACCAT IN ('3','4','18','14')
             AND B.ACCAT = '1'
             AND A.BRANCHCODE = 'ALL'
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'
    END
  ELSE
    BEGIN
      UPDATE #RECPAY_TABLE
      SET    FYSTART = @@STD_DATE,
             FYEND = @@LST_DATE + ' 23:59:59',
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             BANKNAME = B.LONGNAME,
             BOOKTYPE = B.BOOKTYPE,
             MICRNO = ISNULL(B.MICRNO,0)
      FROM   ACMAST A WITH(NOLOCK),
             ACMAST B WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND B.CLTCODE = BANK_CODE
             AND A.ACCAT IN ('3','4','18','14')
             AND B.ACCAT = '1'
    END

  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */
  SELECT @@ERROR_COUNT = COUNT(SNO)
  FROM   #RECPAY_TABLE
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  SET @@ERROR_COUNT = 0

  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   #RECPAY_TABLE
  WHERE  VDT > EDT

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END
            /*----------VALIDATION FOR ZERO AMOUNT --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   #RECPAY_TABLE
  WHERE  AMOUNT <= 0

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,
                          CLTCODE = RP.CLIENT_CODE
   FROM   #RECPAY_TABLE RP,
                 LEDGER L WITH(NOLOCK),
               LEDGER1 L1 WITH(NOLOCK)
          WHERE  L1.DDNO = RP.REF_NO
                 AND L1.DD = RP.CHQ_MODE
                 AND L1.DRCR = @@DRCR
                 AND L1.VTYP = @@VTYP
                 AND RP.REF_NO <> 0
                 AND L.VTYP = @@VTYP
                 AND L.VNO = L1.VNO
                 AND L.BOOKTYPE = L1.BOOKTYPE
                 AND L.DRCR = @@DRCR
                 AND L.CLTCODE = RP.CLIENT_CODE) A

  IF @@ERROR_COUNT > 0
    BEGIN
 DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   (SELECT DISTINCT CLIENT_CODE
          FROM   #RECPAY_TABLE
       WHERE  UPDFLAG = 'N') A

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  /*    ----------AUTO GENERATION OF VNO -------- */
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,
         BOOKTYPE
                            FROM   #RECPAY_TABLE WITH (NOLOCK)

  OPEN @@VNOCUR

  FETCH NEXT FROM @@VNOCUR
  INTO @@BANK_CODE,
       @@BOOKTYPE

  WHILE @@FETCH_STATUS = 0
    BEGIN
      IF @@BRANCHFLAG = 1
        BEGIN
          SELECT @@BANKBRANCH = BRANCHCODE,
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)
          FROM   ACMAST A WITH(NOLOCK)
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)
                   ON (A.BRANCHCODE = C.COSTNAME)
          WHERE  A.CLTCODE = @@BANK_CODE

          IF @@BANKBRANCH <> 'ALL'
            BEGIN
              UPDATE RP
              SET    COSTCODE = @@BANKCOST
              FROM   #RECPAY_TABLE RP,
                     ACMAST A WITH(NOLOCK)
              WHERE  A.CLTCODE = RP.CLIENT_CODE
                     AND A.BRANCHCODE = 'ALL'

        UPDATE #RECPAY_TABLE
              SET    BANKCOST = @@BANKCOST
              WHERE  BANK_CODE = @@BANK_CODE
            END
          ELSE
            BEGIN
              UPDATE #RECPAY_TABLE
              SET    COSTCODE = (SELECT TOP 1 COSTCODE
                                 FROM   COSTMAST WITH(NOLOCK)
                                 WHERE  COSTNAME = 'HO')
              WHERE  COSTCODE = ''
                     AND BANK_CODE = @@BANK_CODE

              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,
                                    COUNT(DISTINCT COSTCODE)
                                                 FROM     #RECPAY_TABLE
                                                 WHERE    BANK_CODE = @@BANK_CODE
                                                 GROUP BY SNO
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1

              OPEN @@COSTCODEUPDATES

              FETCH NEXT FROM @@COSTCODEUPDATES
              INTO @@SERIAL_NO,
                   @@COSTCODECOUNT

              WHILE @@FETCH_STATUS = 0
                BEGIN
                  UPDATE #RECPAY_TABLE
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE
                                  FROM   COSTMAST WITH(NOLOCK)
                                     WHERE  COSTNAME = 'HO')
                  WHERE  (BANKCOST = ''
                     OR BANKCOST IS NULL)
                         AND BANK_CODE = @@BANK_CODE
                         AND SNO = @@SERIAL_NO

                  FETCH NEXT FROM @@COSTCODEUPDATES
                  INTO @@SERIAL_NO,
         @@COSTCODECOUNT
                END

              CLOSE @@COSTCODEUPDATES

              DEALLOCATE @@COSTCODEUPDATES

              UPDATE #RECPAY_TABLE
              SET    BANKCOST = COSTCODE
              WHERE  BANK_CODE = @@BANK_CODE
                     AND (BANKCOST = ''
                           OR BANKCOST IS NULL)
END
        END

      CREATE TABLE #BANK_VNO (
        SRNO    INT,
        NEWSRNO INT   IDENTITY ( 1,1 ))

      INSERT INTO #BANK_VNO
      SELECT DISTINCT SNO
      FROM   #RECPAY_TABLE
      WHERE  BANK_CODE = @@BANK_CODE
          AND BOOKTYPE = @@BOOKTYPE

      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)
      FROM   #RECPAY_TABLE

      SELECT TOP 1 @@VDT = VDT
      FROM   #RECPAY_TABLE

      SELECT LASTVNO
      INTO   #VNO
      FROM  V2_LASTVNO WITH(NOLOCK)
      WHERE  1 = 2

      SELECT @@MAXVNO = MAX(NEWSRNO)
      FROM   #BANK_VNO




     IF @EXCHANGE = 'BSE' AND @SEGMENT = 'FUTURES'
     BEGIN
      INSERT INTO #VNO
      EXEC ACC_GENVNO_NEW_OFFLINE
        @@VDT ,
        @@VTYP ,
        @@BOOKTYPE ,
        @@STD_DATE ,
        @@LST_DATE ,
        @@MAXVNO
     END
     ELSE
     BEGIN
      INSERT INTO #VNO
      EXEC ACC_GENVNO_NEW
        @@VDT ,
        @@VTYP ,
        @@BOOKTYPE ,
        @@STD_DATE ,
        @@LST_DATE ,
        @@MAXVNO
     END

      SELECT @@NEWVNO = LASTVNO
      FROM   #VNO

      UPDATE RP
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))
      FROM   #RECPAY_TABLE RP,
             #BANK_VNO BV
      WHERE  RP.SNO = BV.SRNO



      DROP TABLE #VNO

      DROP TABLE #BANK_VNO

      FETCH NEXT FROM @@VNOCUR
      INTO @@BANK_CODE,
          @@BOOKTYPE
    END

  /*   ----------AUTO GENERATION OF LNO -------- */
  UPDATE #RECPAY_TABLE
 SET    LNO = 2
  WHERE  VNO IN (SELECT   VNO
                 FROM     #RECPAY_TABLE
                 GROUP BY VNO
                 HAVING   COUNT(*) = 1)




  SET @@LNOCUR = CURSOR FOR SELECT  VNO
                            FROM     #RECPAY_TABLE
                            GROUP BY VNO
                            HAVING   COUNT(*) > 1

  OPEN @@LNOCUR

  FETCH NEXT FROM @@LNOCUR
  INTO @@LNOVNO

  WHILE @@FETCH_STATUS = 0
    BEGIN
      CREATE TABLE [#LNOGEN] (
        VNO VARCHAR(12),
        SNO INT,
        LNO INT   IDENTITY ( 1,1 ))

      INSERT INTO #LNOGEN
      SELECT   VNO, SNO
      FROM     #RECPAY_TABLE WITH (NOLOCK)
      WHERE    VNO = @@LNOVNO
      ORDER BY SNO

      UPDATE #RECPAY_TABLE
      SET    LNO = L.LNO + 1
      FROM   #LNOGEN L
      WHERE  #RECPAY_TABLE.VNO = L.VNO
             AND #RECPAY_TABLE.SNO = L.SNO
             AND #RECPAY_TABLE.LNO = 0

      DROP TABLE #LNOGEN

      FETCH NEXT FROM @@LNOCUR
      INTO @@LNOVNO
    END

  CLOSE @@LNOCUR

  DEALLOCATE @@LNOCUR


/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/
  CREATE TABLE #LEDGER (
    VTYP      SMALLINT,
    VNO       VARCHAR(12),
    EDT       DATETIME,
    LNO       SMALLINT,
    ACNAME    VARCHAR(100),
    DRCR      VARCHAR(1),
    VAMT      MONEY,
    VDT       DATETIME,
    VNO1      VARCHAR(12),
    REFNO     CHAR(12),
    BALAMT    MONEY,
    NODAYS    INT,
    CDT       DATETIME,
    CLTCODE   VARCHAR(10),
    BOOKTYPE  VARCHAR(2),
    ENTEREDBY VARCHAR(25),
    PDT       DATETIME,
    CHECKEDBY VARCHAR(25),
    ACTNODAYS INT,
    NARRATION VARCHAR(234))

  CREATE TABLE #LEDGER3 (
    NARATNO  INT,
    NARR     VARCHAR(234),
    REFNO    CHAR(12),
    VTYP     SMALLINT,
    VNO      VARCHAR(12),
    BOOKTYPE VARCHAR(2))

/*======CLIENT SIDE RECORD======*/
  INSERT INTO #LEDGER
             (VTYP,
              VNO,
              EDT,
              LNO,
              ACNAME,
              DRCR,
              VAMT,
              VDT,
              VNO1,
              REFNO,
              BALAMT,
              NODAYS,
              CDT,
              CLTCODE,
              BOOKTYPE,
              ENTEREDBY,
              PDT,
              CHECKEDBY,
              ACTNODAYS,
              NARRATION)
  SELECT VTYP,
         VNO,
         EDT = (CASE
                  WHEN VTYP = @@VTYP
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/
                  ELSE EDT
                END),
         LNO,
         ACNAME,
		 DRCR,
         VAMT = AMOUNT,
         VDT,
         VNO1 = VNO,
         REFNO = 0,
         BALAMT = AMOUNT,
         NODAYS = 0,
         CDT = GETDATE(),
         CLTCODE = MCLIENT_CODE,
         BOOKTYPE = BOOKTYPE,
         ENTEREDBY = ENTEREDBY,
         PDT = GETDATE(),
         CHECKEDBY = @UNAME,
         ACTNODAYS = 0,
         NARRATION
  FROM   #RECPAY_TABLE

/*======BANK SIDE RECORD======*/
  INSERT INTO #LEDGER
  SELECT   VTYP,
           VNO,
           EDT = (CASE
                    WHEN VTYP = @@VTYP
                         AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/
         ELSE EDT
                  END),
           LNO = 1,
           BANKNAME,
           DRCR = (CASE
                     WHEN DRCR = 'D' THEN 'C'
                     ELSE 'D'
                   END),
           VAMT = SUM(AMOUNT),
           VDT,
           VNO1 = VNO,
           REFNO = 0,
           BALAMT = SUM(AMOUNT),
           NODAYS = 0,
		   CDT = GETDATE(),
           CLTCODE = BANK_CODE,
           BOOKTYPE = BOOKTYPE,
           ENTEREDBY = ENTEREDBY,
           PDT = GETDATE(),
           CHECKEDBY = @UNAME,
           ACTNODAYS = 0,
           NARRATION = MAX(NARRATION)
  FROM     #RECPAY_TABLE
  GROUP BY VTYP,VNO,EDT,DRCR,
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,
           ENTEREDBY

/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/
  INSERT INTO LEDGER
 (			  VTYP,
              VNO,
              EDT,
              LNO,
              ACNAME,
              DRCR,
              VAMT,
              VDT,
              VNO1,
              REFNO,
              BALAMT,
              NODAYS,
              CDT,
              CLTCODE,
              BOOKTYPE,
              ENTEREDBY,
              PDT,
              CHECKEDBY,
              ACTNODAYS,
              NARRATION)
  SELECT   VTYP,
           VNO,
		   EDT,
           LNO,
           ACNAME,
           DRCR,
           VAMT,
           VDT,
           VNO1,
           REFNO,
           BALAMT,
           NODAYS,
           CDT,
           CLTCODE,
           BOOKTYPE,
           ENTEREDBY,
           PDT,
           CHECKEDBY,
           ACTNODAYS,
           NARRATION
  FROM     #LEDGER
  ORDER BY BOOKTYPE,
           VTYP,
           VNO,
           LNO

  IF @@ERROR <> 0
    BEGIN
    DROP TABLE #LEDGER
    DROP TABLE #LEDGER3
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  DROP TABLE #LEDGER
/*======INSERTING MARGINLEDGER RECORDS ======*/
  INSERT INTO MARGINLEDGER(
			  VTYP,
			  VNO,
			  LNO,
			  DRCR,
			  VDT,
			  AMOUNT,
			  PARTY_CODE,
			  EXCHANGE,
			  SEGMENT,
			  SETT_NO,
			  SETT_TYPE,
			  BOOKTYPE,
			  MCLTCODE)
  SELECT VTYP,
		 VNO,
		 LNO = 2,
		 DRCR ='D',
		 VDT,
         AMOUNT,
		 CLIENT_CODE,
		 EXCHANGE = @EXCHANGE,
		 SEGMENT = @SEGMENT,
		 SETT_NO = ISNULL(SETT_NO,''),
		 SETT_TYPE = ISNULL(SETT_TYPE,''),
		 BOOKTYPE,
		 MCLIENT_CODE
  FROM #RECPAY_TABLE

/*======BANK SIDE RECORD======*/
  INSERT INTO #LEDGER3
  SELECT   NARATNO = 1,
           NARRATION = MAX(NARRATION),
           REFNO = 0,
           VTYP,
           VNO,
           BOOKTYPE
  FROM     #RECPAY_TABLE
  GROUP BY VTYP,VNO,BOOKTYPE

/*======CLIENT SIDE RECORD======*/
  INSERT INTO #LEDGER3
  SELECT NARATNO = LNO,
         NARR = NARRATION,
         REFNO = 0,
         VTYP,
         VNO,
         BOOKTYPE
  FROM   #RECPAY_TABLE

/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/
  INSERT INTO LEDGER3
  SELECT   *
  FROM     #LEDGER3
  ORDER BY BOOKTYPE,
           VTYP,
		   VNO,
           NARATNO

  IF @@ERROR <> 0
    BEGIN
    DROP TABLE #LEDGER3
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END
ELSE
 BEGIN
      COMMIT TRAN
 END

  DROP TABLE #LEDGER3

  

UPDATE ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK)
SET
 ROWSTATE = 1,
 APPROVALFLAG = 1,
 UPLOADDT = GETDATE(),
 APPROVEDBY = 'SYSTEM',
 LEDGERVNO = VNO
FROM   #RECPAY_TABLE
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO


DROP TABLE #RECPAY_TABLE
SET @ERRORCODE = 0
SET @MESSAGE = 'POSTED SUCCESSFULLY'
EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME

--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD
-- --------------------------------------------------
CREATE PROC [DBO].[V2_OFFLINE_RECPAYUPLOAD] (
        @UNAME    VARCHAR (25),
        @USERCAT  int,
        @EXCHANGE VARCHAR (3),
        @SEGMENT  VARCHAR (10),
            
  @ErrorCode   INT   OUTPUT,                                        
  @Message   VARCHAR (200)  OUTPUT    
 )        
            
AS            
/*            
begin tran            
SP_HELPTRIGGER LEDGER            
LEDGER_TRG_BILL            
LEDGER_TRG            
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388            
SELECT TOP 1 * FROM LEDGER3            
SELECT TOP 1 * FROM LEDGER_TRG            
ROLLBACK            
*/            
SET NOCOUNT ON            
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/            
DECLARE            
 @@STD_DATE VARCHAR(11),            
 @@LST_DATE VARCHAR(11),            
 @@BRANCHFLAG AS TINYINT,            
 @@VNOFLAG AS TINYINT,            
 @@VNOMETHOD INT,            
 @@ACNAME CHAR(100),            
 @@BOOKTYPE CHAR(2),            
 @@MICRNO VARCHAR(10),            
 @@DRCR VARCHAR(1),            
 @@VTYP SMALLINT,            
 @@BANK_CODE VARCHAR(100),            
 @@BACKDAYS INT,            
 @@BACKDATE VARCHAR(11),            
 @@BRNCOUNT   TINYINT,            
 @@MonthlyVdt VARCHAR(11),            
 @@SERIAL_NO INT,            
 @@COSTCODECOUNT TINYINT,            
 @@COSTCODEUPDATES CURSOR,            
 @@NEWVNO AS VARCHAR(12),            
 @@MAXCOUNT AS INT,            
 @@VDT AS VARCHAR(11),            
 @@BANKBRANCH AS VARCHAR(10),            
 @@BANKCOST AS NUMERIC,            
 @@LNOCUR AS CURSOR,            
 @@VNOCUR AS CURSOR,            
 @@LNOVNO AS VARCHAR(12),            
 @@MAXVNO AS INT,            
 @@L2CUR AS CURSOR,            
 @@L2VNO AS VARCHAR(12),            
 @@ERROR_COUNT AS BIGINT,            
 @@FILEEXISTS AS INT,            
 @@SQL AS VARCHAR(2000)            
            
            

BEGIN TRAN            
CREATE TABLE #RECPAY_TABLE_TMP            
(            
 SERIAL_NO INT IDENTITY(1,1),            
 EDATE VARCHAR(20),            
 VOUCHER_DATE VARCHAR(20),            
 CLIENT_CODE VARCHAR(50),            
 AMOUNT MONEY,            
 DRCR VARCHAR(1),            
 NARRATION VARCHAR(234),            
 BANK_CODE VARCHAR(10),            
 BANK_NAME VARCHAR(100),            
 REF_NO VARCHAR(15),            
 BRANCHCODE VARCHAR(20),            
 BRANCH_NAME VARCHAR(50),            
 CHQ_MODE VARCHAR(1),            
 CHQ_DATE VARCHAR(20),            
 CHQ_NAME VARCHAR(100),            
 CL_MODE VARCHAR(1) ,
 FLD_AUTO BIGINT,
 ENTEREDBY VARCHAR(25)          
)            
CREATE TABLE [#RECPAY_TABLE]            
 (            
  SERIAL_NO INT,            
  EDATE VARCHAR(20),            
  VOUCHER_DATE VARCHAR(20),            
  CLIENT_CODE VARCHAR(50),            
  AMOUNT MONEY,            
  DRCR VARCHAR(1),            
  NARRATION VARCHAR(234),            
  BANK_CODE VARCHAR(10),            
  BANK_NAME VARCHAR(100),            
  REF_NO VARCHAR(15),            
  BRANCHCODE VARCHAR(20),            
  BRANCH_NAME VARCHAR(50),            
  CHQ_MODE VARCHAR(1),            
  CHQ_DATE VARCHAR(20),            
  CHQ_NAME VARCHAR(100),            
  CL_MODE VARCHAR(1), 
  FLD_AUTO BIGINT,
 ENTEREDBY VARCHAR(25)  ,            
  SNO INT IDENTITY (1, 1) NOT NULL ,            
  VDT DATETIME NULL ,            
  FYSTART DATETIME NULL ,            
  FYEND DATETIME NULL ,            
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),            
  EDT DATETIME NULL ,            
  DDDT DATETIME NULL ,            
  VNO VARCHAR (12) NULL ,        
VTYP SMALLINT NULL ,            
  ACNAME VARCHAR (100) NULL ,            
  COSTCODE SMALLINT NULL,            
  BANKCOST SMALLINT NULL,            
  LNO SMALLINT NOT NULL DEFAULT(0),            
  BANKNAME VARCHAR(100) NULL,            
  MICRNO INT NULL,            
  BOOKTYPE VARCHAR(2) NULL,            
 ) ON [PRIMARY]            
    




-- UPPILI
INSERT
INTO    #RECPAY_TABLE_TMP
SELECT  CONVERT(VARCHAR,EDATE,103)    ,
        CONVERT(VARCHAR,VDATE,103)     ,
        CLTCODE            ,
        CREDITAMT          ,
        'C'                ,
        NARRATION          ,
        OPPCODE            ,
        OPPCODENAME        ,
        DDNO               ,
        'ALL'              ,
        'ALL'              ,
		CHEQUEMODE	,
        CONVERT(VARCHAR,CHEQUEDATE,103),
        CHEQUENAME         ,
        CLEAR_MODE,
		FLDAUTO,
		ADDBY
FROM    ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES
WHERE   VOUCHERTYPE = 2
    AND EXCHANGE    = @EXCHANGE
    AND SEGMENT     = @SEGMENT
    AND ISNULL(ROWSTATE,0)   <> 1

       

            
INSERT INTO            
 #RECPAY_TABLE            
 (            
  SERIAL_NO,            
  EDATE,            
  VOUCHER_DATE,            
  CLIENT_CODE,            
  AMOUNT,            
  DRCR,            
  NARRATION,            
  BANK_CODE,            
  BANK_NAME,            
  REF_NO,            
  BRANCHCODE,            
  BRANCH_NAME,            
  CHQ_MODE,            
  CHQ_DATE,            
  CHQ_NAME,            
  CL_MODE   ,
  FLD_AUTO  ,
  ENTEREDBY       
 )            
SELECT            
 SERIAL_NO,            
 EDATE,            
 VOUCHER_DATE,            
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),            
 AMOUNT,            
 UPPER(LTRIM(RTRIM(DRCR))),            
 NARRATION,            
 UPPER(LTRIM(RTRIM(BANK_CODE))),            
 UPPER(LTRIM(RTRIM(BANK_NAME))),            
 REF_NO,            
 UPPER(LTRIM(RTRIM(BRANCHCODE))),            
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),            
 UPPER(LTRIM(RTRIM(CHQ_MODE))),            
 CHQ_DATE,            
 CHQ_NAME,            
 CL_MODE,
 FLD_AUTO   ,
 ENTEREDBY        
FROM            
 #RECPAY_TABLE_TMP            
            
UPDATE            
 #RECPAY_TABLE            
SET            
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),            
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),            
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))            
      

      
SELECT TOP 1            
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)            
FROM            
 #RECPAY_TABLE            
      
      
SELECT            
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),            
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),            
 @@BRANCHFLAG = BRANCHFLAG,            
 @@VNOFLAG = VNOFLAG            
FROM            
 PARAMETER            
WHERE            
 @@VDT BETWEEN SDTCUR AND LDTCUR         
            
IF @@VNOFLAG <> 0       
BEGIN           
 SELECT            
  @@ERROR_COUNT = COUNT(DISTINCT VDT)            
 FROM            
  #RECPAY_TABLE            
             
 IF @@ERROR_COUNT > 1            
  BEGIN            
   DROP TABLE #RECPAY_TABLE_TMP            
   DROP TABLE #RECPAY_TABLE            
   ROLLBACK TRANSACTION      
	SET @ERRORCODE = 1      
   SET @MESSAGE =  'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'            
   RETURN            
  END          
END        
            
            
IF @@BRANCHFLAG = 1        
 BEGIN            
  UPDATE            
   #RECPAY_TABLE            
  SET            
   BRANCHCODE = A.BRANCHCODE,            
   FYSTART = P.SDTCUR,            
   FYEND = P.LDTCUR,            
   UPDFLAG = 'Y',            
   ACNAME = A.LONGNAME,            
   COSTCODE = C.COSTCODE,            
   BANKNAME = B.LONGNAME,            
   BOOKTYPE = B.BOOKTYPE,            
   MICRNO = ISNULL(B.MICRNO, 0)            
  FROM            
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B            
  WHERE            
   A.CLTCODE = CLIENT_CODE            
AND B.CLTCODE = BANK_CODE            
   AND P.CURYEAR = 1            
   AND A.ACCAT IN ('3','4','18')            
   AND B.ACCAT = '2'            
   AND A.BRANCHCODE = COSTNAME            
              
  UPDATE            
   #RECPAY_TABLE            
  SET            
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),            
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),            
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),            
   FYSTART = P.SDTCUR,            
   FYEND = P.LDTCUR,            
   UPDFLAG = 'Y',            
   ACNAME = A.LONGNAME,            
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,            
   BANKNAME = B.LONGNAME,            
   BOOKTYPE = B.BOOKTYPE,            
   MICRNO = ISNULL(B.MICRNO, 0)            
  FROM            
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B            
  WHERE            
   A.CLTCODE = CLIENT_CODE            
   AND B.CLTCODE = BANK_CODE            
   AND P.CURYEAR = 1            
   AND A.ACCAT IN ('3','4','18')            
   AND B.ACCAT = '2'            
   AND A.BRANCHCODE = 'ALL'            
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'            
            
  UPDATE            
   #RECPAY_TABLE            
  SET            
   BRANCHCODE = 'HO',            
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),            
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),            
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),            
   FYSTART = P.SDTCUR,            
   FYEND = P.LDTCUR,            
   UPDFLAG = 'Y',            
   ACNAME = A.LONGNAME,            
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,            
   BANKNAME = B.LONGNAME,            
   BOOKTYPE = B.BOOKTYPE,            
   MICRNO = ISNULL(B.MICRNO, 0)            
  FROM            
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B            
  WHERE            
   A.CLTCODE = CLIENT_CODE            
   AND B.CLTCODE = BANK_CODE            
   AND P.CURYEAR = 1            
   AND A.ACCAT IN ('3','4','18')            
   AND B.ACCAT = '2'            
   AND A.BRANCHCODE = 'ALL'            
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'            
 END            
ELSE            
 BEGIN            
  UPDATE            
   #RECPAY_TABLE            
  SET            
   FYSTART = @@STD_DATE,            
   FYEND = @@LST_DATE + ' 23:59:59',            
   UPDFLAG = 'Y',            
   ACNAME = A.LONGNAME,            
   BANKNAME = B.LONGNAME,            
   BOOKTYPE = B.BOOKTYPE,            
   MICRNO = ISNULL(B.MICRNO, 0)            
  FROM            
   ACMAST A, ACMAST B            
  WHERE            
   A.CLTCODE = CLIENT_CODE            
   AND B.CLTCODE = BANK_CODE            
   AND A.ACCAT IN ('3','4','18')            
   AND B.ACCAT = '2'            
 END            
      
      
      
           
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */            
            
SELECT      
 SERIAL_NO, VOUCHER_DATE      
INTO #DUP_VDTS      
FROM      
 #RECPAY_TABLE      
GROUP BY SERIAL_NO, VOUCHER_DATE      
      
SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM #DUP_VDTS      
GROUP BY SERIAL_NO      
HAVING COUNT(1) > 1      
      
 IF @@ERROR_COUNT > 1            
  BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =  'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES IN SAME SERIAL NO'           
   DROP TABLE #RECPAY_TABLE_TMP            
   DROP TABLE #RECPAY_TABLE            
   ROLLBACK TRAN                     
   RETURN            
  END            
      
      
SELECT       
 @@ERROR_COUNT = COUNT(SERIAL_NO)       
FROM       
 #RECPAY_TABLE      
WHERE VDT NOT BETWEEN FYSTART AND FYEND      
  
 IF @@ERROR_COUNT > 0      
  BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'       
   DROP TABLE #RECPAY_TABLE_TMP            
   DROP TABLE #RECPAY_TABLE            
   ROLLBACK TRAN            
       
   RETURN            
  END            
      
SET @@ERROR_COUNT = 0      
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/            
          
            
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */            
 SELECT            
  @@ERROR_COUNT = COUNT(1)            
 FROM            
  (            
   SELECT            
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),            
    SERIAL_NO            
   FROM            
    #RECPAY_TABLE            
   GROUP BY            
    SERIAL_NO            
   HAVING            
    COUNT(DISTINCT BANK_CODE) > 1            
  ) A            
 IF @@ERROR_COUNT > 0            
  BEGIN  
/*          
   SELECT            
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'            
   UNION ALL            
   SELECT            
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))            
   FROM            
    #RECPAY_TABLE            
   GROUP BY            
    SERIAL_NO            
   HAVING            
    COUNT(DISTINCT BANK_CODE) > 1            
 */
	SET @ERRORCODE = 1      
   SET @MESSAGE =  'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS.'           
   DROP TABLE #RECPAY_TABLE_TMP            
   DROP TABLE #RECPAY_TABLE            
   ROLLBACK TRAN                    
   RETURN            
  END            
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */            
SELECT            
 @@ERROR_COUNT = COUNT(1)            
FROM            
 (            
 SELECT DISTINCT            
  DRCR            
 FROM            
  #RECPAY_TABLE            
 ) A            
IF @@ERROR_COUNT > 1            
 BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =  'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.'          
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN                     
  RETURN            
 END            
ELSE            
 BEGIN            
  SELECT TOP 1            
   @@DRCR = DRCR,            
   @@VTYP =            
    (            
    CASE            
     WHEN DRCR = 'D'            
     THEN 3            
     ELSE 2            
    END            
    )            
  FROM            
   #RECPAY_TABLE            
  UPDATE            
   #RECPAY_TABLE            
  SET VTYP =            
   (            
   CASE            
     WHEN DRCR = 'D'            
     THEN 3            
     ELSE 2            
    END            
   )            
 END            
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/            
 SELECT @@ERROR_COUNT = COUNT(1)            
 FROM #RECPAY_TABLE            
 WHERE VDT > EDT            
            IF @@ERROR_COUNT > 0            
             BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =  'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'            
     DROP TABLE #RECPAY_TABLE_TMP            
     DROP TABLE #RECPAY_TABLE            
     ROLLBACK TRAN                      
     RETURN            
             END            
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/            
 SELECT @@ERROR_COUNT = COUNT(1)            
 FROM #RECPAY_TABLE            
 WHERE AMOUNT <= 0            
 IF @@ERROR_COUNT > 0            
  BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =   'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'            
     DROP TABLE #RECPAY_TABLE_TMP            
     DROP TABLE #RECPAY_TABLE            
     ROLLBACK TRAN                      
     RETURN            
  END         
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */            
/*Select REF_NO,CHQ_MODE,BANK_NAME into #tempchqno from       
#RECPAY_TABLE RP,            
   LEDGER1 L1            
    WITH(NOLOCK)            
  WHERE            
   L1.DDNO = RP.REF_NO            
  AND L1.DD = RP.CHQ_MODE        
   AND L1.BNKNAME = RP.BANK_NAME          
   AND L1.DRCR = @@DRCR            
   AND L1.VTYP = @@VTYP            
   AND RP.REF_NO <> 0         
      
SELECT            
@@ERROR_COUNT = COUNT(1)            
FROM            
 (            
  SELECT DISTINCT            
   DDNO  = RP.REF_NO            
  FROM            
   #tempchqno RP where not exists(select vno from  LEDGER1 L1            
    WITH(NOLOCK)            
  WHERE            
   L1.DDNO = RP.REF_NO            
   AND L1.DD = RP.CHQ_MODE        
  AND L1.BNKNAME = RP.BANK_NAME and l1.vtyp = 17)      
 ) A            
*/      
      
-----------------------------old code     
PRINT  @@DRCR   
PRINT  @@VTYP   
SELECT            
 @@ERROR_COUNT = COUNT(1)            
FROM            
 (            
  SELECT DISTINCT            
   DDNO  = RP.REF_NO ,   
   CLTCODE=RP.CLIENT_CODE           
  FROM            
   #RECPAY_TABLE RP,Ledger l ,    
   LEDGER1 L1            
    WITH(NOLOCK)            
  WHERE            
   L1.DDNO = RP.REF_NO          
   AND L1.DD = RP.CHQ_MODE          
   AND L1.DRCR = @@DRCR          
   AND L1.VTYP = @@VTYP          
   AND RP.REF_NO <> 0          
   AND L.VTYP=@@VTYP  
   AND L.VNO=L1.VNO  
   AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L.DRCR=@@DRCR   
   AND L.CLTCODE=RP.CLIENT_CODE  
 ) A         
----------------         
IF @@ERROR_COUNT > 0            
 BEGIN        
/*    
  SELECT            
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'            
  UNION ALL            
  SELECT DISTINCT            
   RP.REF_NO, 'NA','NA'            
  FROM            
   #RECPAY_TABLE RP, LEDGER L,   
   LEDGER1 L1            
    WITH(NOLOCK)            
  WHERE            
   L1.DDNO = RP.REF_NO            
   AND L1.DD = RP.CHQ_MODE            
   AND L1.DRCR = @@DRCR            
   AND L1.VTYP = @@VTYP            
   AND RP.CHQ_MODE <> 'N'   
   AND L.VTYP=@@VTYP  
   AND L.VNO=L1.VNO  
   AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L.DRCR=@@DRCR   
   AND L.CLTCODE=RP.CLIENT_CODE  
*/
	SET @ERRORCODE = 1      
   SET @MESSAGE =   'FILE CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'      
       
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN                    
  RETURN            
 END            
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/            
SELECT            
 @@ERROR_COUNT = COUNT(1)            
FROM            
 (            
  SELECT DISTINCT            
   CLIENT_CODE            
  FROM            
   #RECPAY_TABLE            
  WHERE            
   UPDFLAG = 'N'            
 ) A            
IF @@ERROR_COUNT > 0            
 BEGIN            
/*
  SELECT            
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'            
  UNION ALL            
  SELECT DISTINCT            
   CLIENT_CODE, 'NA','NA'            
  FROM            
   #RECPAY_TABLE            
  WHERE            
   UPDFLAG = 'N'         
*/
	SET @ERRORCODE = 1      
   SET @MESSAGE =   'FILE CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'   
  DROP TABLE #RECPAY_TABLE_TMP            
DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN                     
  RETURN            
 END            
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */            
  SET @@VNOCUR = CURSOR FOR            
   SELECT DISTINCT            
    BANK_CODE,            
    BOOKTYPE            
   FROM            
    #RECPAY_TABLE WITH(NOLOCK)            
  OPEN @@VNOCUR            
  FETCH NEXT            
   FROM            
    @@VNOCUR            
   INTO            
    @@BANK_CODE,            
    @@BOOKTYPE            
  WHILE @@FETCH_STATUS = 0            
   BEGIN            
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------      
/*   
 SELECT            
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)            
    FROM            
     USERWRITESTABLE            
    WHERE            
     USERCATEGORY = @USERCAT            
     AND VTYP = @@VTYP            
     AND BOOKTYPE = @@BOOKTYPE            
    SELECT            
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS            
    SELECT            
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)            
    FROM            
     #RECPAY_TABLE            
    WHERE            
     VDT < @@BACKDATE            
    IF @@ERROR_COUNT > 0            
     BEGIN            
      SELECT            
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'            
      DROP TABLE #RECPAY_TABLE_TMP            
      DROP TABLE #RECPAY_TABLE            
      ROLLBACK TRAN                      
      RETURN            
     END      
*/
    IF @@BRANCHFLAG = 1            
     BEGIN            
      SELECT            
       @@BANKBRANCH = BRANCHCODE,            
       @@BANKCOST = ISNULL(C.COSTCODE, -1)            
      FROM            
       ACMAST A            
        LEFT OUTER JOIN            
        COSTMAST C            
        ON            
         (            
          A.BRANCHCODE = C.COSTNAME            
         )            
      WHERE            
    A.CLTCODE = @@BANK_CODE            
      IF @@BANKBRANCH <> 'ALL'            
       BEGIN          
        UPDATE            
         RP            
          SET COSTCODE = @@BANKCOST            
        FROM            
         #RECPAY_TABLE RP,            
         ACMAST A            
        WHERE            
         A.CLTCODE = RP.CLIENT_CODE            
         AND A.BRANCHCODE = 'ALL'            
        UPDATE            
         #RECPAY_TABLE            
          SET BANKCOST = @@BANKCOST            
        WHERE            
         BANK_CODE = @@BANK_CODE            
       END            
      ELSE            
       BEGIN            
        UPDATE            
         #RECPAY_TABLE            
          SET COSTCODE =            
           (            
            SELECT TOP 1            
             COSTCODE            
            FROM            
             COSTMAST            
            WHERE            
             COSTNAME = 'HO'            
           )            
        WHERE            
         COSTCODE = ''            
         AND BANK_CODE = @@BANK_CODE            
                            SET @@COSTCODEUPDATES = CURSOR FOR            
                                       SELECT            
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)            
                                       FROM            
                                             #RECPAY_TABLE WITH(NOLOCK)            
                                       WHERE            
          BANK_CODE = @@BANK_CODE            
                                       GROUP BY            
                                             SERIAL_NO            
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1            
                            OPEN @@COSTCODEUPDATES            
                            FETCH NEXT            
 FROM            
                              @@COSTCODEUPDATES            
                             INTO            
                              @@SERIAL_NO,            
                              @@COSTCODECOUNT            
                            WHILE @@FETCH_STATUS = 0            
                             BEGIN            
          UPDATE            
           #RECPAY_TABLE            
            SET BANKCOST =            
             (            
              SELECT TOP 1            
               COSTCODE            
              FROM            
               COSTMAST            
              WHERE            
               COSTNAME = 'HO'            
             )            
          WHERE            
           (BANKCOST = ''   OR BANKCOST IS NULL)            
           AND BANK_CODE = @@BANK_CODE            
                                           AND SERIAL_NO = @@SERIAL_NO            
                              FETCH NEXT            
                               FROM            
                                @@COSTCODEUPDATES            
                               INTO            
                                @@SERIAL_NO,            
                                @@COSTCODECOUNT            
                             END            
                            CLOSE @@COSTCODEUPDATES            
                            DEALLOCATE @@COSTCODEUPDATES            
                  UPDATE            
                   #RECPAY_TABLE            
                    SET BANKCOST = COSTCODE            
            WHERE            
                   BANK_CODE = @@BANK_CODE            
  AND (BANKCOST = ''   OR BANKCOST IS NULL)            
       END            
     END            
    CREATE TABLE            
     #BANK_VNO            
     (            
      SRNO INT,            
      NEWSRNO INT IDENTITY (1, 1)            
     )            
    INSERT INTO            
     #BANK_VNO            
    SELECT            
     DISTINCT SERIAL_NO            
    FROM            
     #RECPAY_TABLE            
    WHERE            
     BANK_CODE = @@BANK_CODE            
     AND BOOKTYPE = @@BOOKTYPE            
            
   SELECT            
     @@MAXCOUNT = COUNT(DISTINCT SNO)            
    FROM            
     #RECPAY_TABLE            
            
    SELECT TOP 1            
     @@VDT = VDT            
    FROM            
     #RECPAY_TABLE            
    SELECT            
     LASTVNO            
    INTO #VNO            
    FROM            
     LASTVNO            
    WHERE            
     1 = 2            
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO            
    INSERT            
    INTO #VNO            
     EXEC ACC_GENVNO_NEW            
      @@VDT,            
      @@VTYP,            
      @@BOOKTYPE,            
      @@STD_DATE,            
      @@LST_DATE,            
      @@MAXVNO            
    SELECT            
     @@NEWVNO = LASTVNO            
    FROM            
     #VNO            
    UPDATE            
     RP            
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))            
    FROM            
     #RECPAY_TABLE RP,            
     #BANK_VNO BV            
    WHERE            
     RP.SERIAL_NO = BV.SRNO            
   DROP TABLE #VNO            
   DROP TABLE #BANK_VNO            
  FETCH NEXT            
   FROM @@VNOCUR            
   INTO            
    @@BANK_CODE,            
    @@BOOKTYPE            
 END            
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */            
UPDATE            
 #RECPAY_TABLE            
  SET LNO = 2            
WHERE            
 VNO IN            
  (            
   SELECT            
    VNO            
   FROM            
    #RECPAY_TABLE            
     WITH(NOLOCK)            
   GROUP BY            
    VNO            
   HAVING            
    COUNT(*) = 1            
  )            
SET @@LNOCUR = CURSOR FOR            
 SELECT            
  VNO            
 FROM            
  #RECPAY_TABLE            
   WITH(NOLOCK)            
 GROUP BY            
  VNO            
 HAVING            
  COUNT(*) > 1            
OPEN @@LNOCUR            
FETCH NEXT            
 FROM            
  @@LNOCUR            
 INTO            
  @@LNOVNO            
WHILE @@FETCH_STATUS = 0            
 BEGIN            
  CREATE TABLE            
   [#LNOGEN]            
    (            
     VNO VARCHAR(12),            
     SNO INT,            
     LNO INT IDENTITY(1,1)            
    )            
  INSERT INTO            
   #LNOGEN            
    SELECT            
     VNO,            
     SNO            
    FROM            
     #RECPAY_TABLE            
      WITH(NOLOCK)            
    WHERE            
     VNO = @@LNOVNO            
    ORDER BY            
     SNO            
  UPDATE            
   #RECPAY_TABLE            
    SET LNO = L.LNO + 1            
  FROM            
   #LNOGEN L            
  WHERE            
   #RECPAY_TABLE.VNO = L.VNO            
   AND #RECPAY_TABLE.SNO = L.SNO            
   AND #RECPAY_TABLE.LNO = 0            
  DROP TABLE #LNOGEN            
  FETCH NEXT            
   FROM            
    @@LNOCUR            
   INTO            
    @@LNOVNO            
 END            
CLOSE @@LNOCUR            
DEALLOCATE @@LNOCUR            
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */            
INSERT INTO            
 LEDGER1            
  (            
   BNKNAME,            
   BRNNAME,            
   DD,            
   DDNO,            
   DDDT,            
   RELDT,            
   RELAMT,            
   REFNO,            
   RECEIPTNO,            
   VTYP,            
   VNO,            
   LNO,            
   DRCR,            
   BOOKTYPE,            
   MICRNO,            
   SLIPNO,            
   SLIPDATE,            
   CHEQUEINNAME,            
   CHQPRINTED,            
   CLEAR_MODE            
  )            
SELECT            
 BNKNAME = MAX(BANK_NAME),            
 BRNNAME = MAX(BRANCH_NAME),            
 DD = MAX(CHQ_MODE),            
 DDNO = MAX(REF_NO),            
 DDDT = MAX(DDDT),            
 RELDT = '',            
 RELAMT = SUM(AMOUNT),            
 REFNO = 0,            
 RECEIPTNO = 0,            
 VTYP,            
 VNO,            
 LNO = 2,            
 DRCR,          
 BOOKTYPE = BOOKTYPE,            
 MICRNO = MICRNO,            
 SLIPNO = 0,            
 SLIPDATE = '',            
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),            
 CHQPRINTED = 0,            
 CLEAR_MODE = MAX(CL_MODE)            
FROM            
 #RECPAY_TABLE            
GROUP BY            
 VTYP,            
 VNO,            
 DRCR,            
 BOOKTYPE,          
 MICRNO          
            
IF @@ERROR <> 0            
 BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'            
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN                    
  RETURN            
 END            
            
/*================================            
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK            
=================================*/            
CREATE TABLE #LEDGER            
(            
 VTYP SMALLINT,            
 VNO VARCHAR(12),            
 EDT DATETIME,            
 LNO SMALLINT,            
 ACNAME VARCHAR(100),            
 DRCR VARCHAR(1),            
 VAMT MONEY,            
 VDT DATETIME,            
 VNO1 VARCHAR(12),            
 REFNO CHAR(12),            
 BALAMT MONEY,            
 NODAYS INT,            
 CDT DATETIME,            
 CLTCODE VARCHAR(10),            
 BOOKTYPE VARCHAR(2),            
 ENTEREDBY VARCHAR(25),            
 PDT DATETIME,            
 CHECKEDBY VARCHAR(25),            
 ACTNODAYS INT,            
 NARRATION VARCHAR(234)            
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0            
CREATE TABLE #LEDGER3            
(            
 NARATNO INT,            
 NARR VARCHAR(234),            
 REFNO CHAR(12),            
 VTYP SMALLINT,            
 VNO VARCHAR(12),            
 BOOKTYPE VARCHAR(2)            
)            
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0            
/*==============================            
CLIENT SIDE RECORD            
==============================*/            
INSERT INTO            
 #LEDGER            
 (            
  VTYP,            
  VNO,          
  EDT,            
  LNO,            
  ACNAME,            
  DRCR,            
  VAMT,            
  VDT,            
  VNO1,            
  REFNO,            
  BALAMT,            
  NODAYS,            
  CDT,            
  CLTCODE,            
  BOOKTYPE,            
  ENTEREDBY,            
  PDT,            
  CHECKEDBY,            
  ACTNODAYS,            
  NARRATION            
 )            
SELECT            
 VTYP,            
 VNO,            
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),            
 LNO,            
 ACNAME,            
 DRCR,            
 VAMT = AMOUNT,            
 VDT,            
 VNO1 = VNO,            
 REFNO = 0,            
 BALAMT = AMOUNT,            
 NODAYS = 0,            
 CDT = GETDATE(),            
 CLTCODE = CLIENT_CODE,            
 BOOKTYPE = BOOKTYPE,            
 ENTEREDBY = ENTEREDBY,            
 PDT = GETDATE(),            
 CHECKEDBY = @UNAME,            
 ACTNODAYS = 0,            
 NARRATION            
FROM            
 #RECPAY_TABLE            
/*==============================            
BANK SIDE RECORD            
==============================*/            
INSERT INTO            
 #LEDGER            
SELECT            
 VTYP,            
 VNO,            
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),            
 LNO = 1,            
 BANKNAME,            
 DRCR =            
  (            
   CASE            
    WHEN DRCR = 'D'            
    THEN 'C'            
    ELSE 'D'            
   END            
  ),            
 VAMT = SUM(AMOUNT),            
 VDT,            
 VNO1 = VNO,            
 REFNO = 0,            
 BALAMT = SUM(AMOUNT),            
 NODAYS = 0,            
 CDT = GETDATE(),            
 CLTCODE = BANK_CODE,            
 BOOKTYPE = BOOKTYPE,            
 ENTEREDBY = ENTEREDBY,            
 PDT = GETDATE(),            
 CHECKEDBY = @UNAME,            
 ACTNODAYS = 0,            
 NARRATION = MAX(NARRATION)            
FROM            
 #RECPAY_TABLE            
GROUP BY            
 VTYP,            
 VNO,            
 EDT,            
 DRCR,            
 VDT,            
 BANK_CODE,            
 BOOKTYPE,            
 BANKNAME,
 ENTEREDBY           
/*==============================            
INSERTING ALL LEDGER RECORDS AT ONE TIME            
==============================*/            

INSERT INTO LEDGER  
(
Vtyp,
Vno,
Edt,
Lno,
Acname,
Drcr,
Vamt,
Vdt,
Vno1,
Refno,
Balamt,
Nodays,
Cdt,
Cltcode,
Booktype,
Enteredby,
Pdt,
Checkedby,
Actnodays,
Narration
)
SELECT            
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration            
FROM            
 #LEDGER            
ORDER BY            
 BOOKTYPE,            
 VTYP,            
 VNO,            
 LNO            
            
IF @@ERROR <> 0            
 BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'            
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  DROP TABLE #LEDGER            
  DROP TABLE #LEDGER3            
  ROLLBACK TRAN                     
  RETURN            
 END            
DROP TABLE #LEDGER            
/*==============================            
BANK SIDE RECORD            
==============================*/            
INSERT INTO            
 #LEDGER3            
SELECT            
 NARATNO = 1,            
 NARRATION = MAX(NARRATION),            
 REFNO = 0,       
 VTYP,            
 VNO,            
 BOOKTYPE            
FROM            
 #RECPAY_TABLE            
GROUP BY            
 VTYP,            
 VNO,            
 BOOKTYPE            
/*==============================            
CLIENT SIDE RECORD            
==============================*/            
INSERT INTO            
 #LEDGER3            
SELECT            
 NARATNO = LNO,            
 NARR = NARRATION,            
 REFNO = 0,            
 VTYP,            
 VNO,            
 BOOKTYPE            
FROM            
 #RECPAY_TABLE            
            
            
/*==============================            
INSERTING ALL LEDGER3 RECORDS AT ONE TIME            
==============================*/            
INSERT INTO LEDGER3            
SELECT            
 *            
FROM            
 #LEDGER3            
ORDER BY            
 BOOKTYPE,            
 VTYP,            
 VNO,            
 NARATNO            
            
IF @@ERROR <> 0            
 BEGIN            
	SET @ERRORCODE = 1      
   SET @MESSAGE =  'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'            
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  DROP TABLE #LEDGER3            
  ROLLBACK TRAN                  
  RETURN            
 END            
DROP TABLE #LEDGER3            
            
            
IF @@BRANCHFLAG = 1            
 BEGIN            
  SET @@L2CUR = CURSOR FOR            
   SELECT DISTINCT            
    VNO            
   FROM            
    #RECPAY_TABLE            
   ORDER BY            
    VNO            
  OPEN @@L2CUR            
   FETCH NEXT            
   FROM            
    @@L2CUR            
   INTO            
    @@L2VNO            
  WHILE @@FETCH_STATUS = 0            
   BEGIN            
    DELETE FROM            
     TEMPLEDGER2            
    WHERE            
     SESSIONID = '9999999999'            
/*==============================            
CLIENT SIDE RECORD            
==============================*/            
    INSERT INTO            
     TEMPLEDGER2            
    SELECT            
     'BRANCH',            
     C.COSTNAME,            
    AMOUNT,            
     VTYP,            
     VNO,            
     LNO,            
     DRCR,            
     '0',            
     BOOKTYPE,            
     '9999999999',            
     CLIENT_CODE,            
     'A',            
     '0'            
    FROM            
     #RECPAY_TABLE RP,            
     COSTMAST C            
    WHERE            
     RP.COSTCODE = C.COSTCODE            
     AND VNO = @@L2VNO            
/*==============================            
BANK SIDE RECORD            
==============================*/            
    INSERT INTO            
     TEMPLEDGER2            
    SELECT            
     'BRANCH',            
     C.COSTNAME,            
     SUM(AMOUNT),            
     VTYP,            
     VNO,            
     LNO = 1,            
     DRCR =            
      (            
       CASE            
       WHEN DRCR = 'D'            
       THEN 'C'            
       ELSE 'D'            
       END            
      ),            
     '0',            
     BOOKTYPE,            
     '9999999999',            
     BANK_CODE,            
     'A',            
     '0'            
    FROM            
     #RECPAY_TABLE RP,            
     COSTMAST C            
    WHERE            
     RP.BANKCOST = C.COSTCODE            
     AND VNO = @@L2VNO            
    GROUP BY            
     C.COSTNAME,            
     VTYP,        
     VNO,            
      (            
       CASE            
       WHEN DRCR = 'D'            
       THEN 'C'            
       ELSE 'D'            
       END            
      ),            
     BANK_CODE,            
     BOOKTYPE            
    EXEC INSERTTOLEDGER2            
     '9999999999',            
     @@L2VNO,            
     '1',            
     '1',            
     '1',            
     'BROKER',            
     'BROKER'            
    FETCH NEXT            
     FROM            
      @@L2CUR            
     INTO            
      @@L2VNO            
   END            
  DELETE FROM            
   TEMPLEDGER2            
  WHERE            
   SESSIONID = '9999999999'            
  COMMIT TRAN            
 END            



UPDATE    ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES
SET ROWSTATE  = 1, 
LEDGERVNO = VNO
FROM #RECPAY_TABLE
WHERE FLDAUTO = #RECPAY_TABLE.FLD_AUTO
/*
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL            
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE   
*/


         
DROP TABLE #RECPAY_TABLE_TMP            
DROP TABLE #RECPAY_TABLE            

	SET @ERRORCODE = 0      
   SET @MESSAGE =   'POSTED SUCCESSFULLY'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Recreate_VNo
-- --------------------------------------------------
/*select * from ledger where vno like '2006%'     
exec V2_Recreate_VNo*/    
    
    
CREATE Proc V2_Recreate_VNo    
as    
/*    
            VnoFlag = 0 Yearly      
            VnoFlag = 1 Daily      
            VnoFlag = 2 Monthly      
*/    
    
    
    
    
    
Select f.Vtyp, f.BookType, f.Vdt, Max(VNo), f.VNoFlag, f.FinYear    
From    
(    
      Select     
            x.Vtyp,     
            x.BookType,    
            Vdt = (Case when x.VNoFlag = 0 then Cast(x.Mn1 + ' 1 '+cast(x.Yr as varchar) as Datetime)    
                              when x.VnoFlag = 1 then Cast(left(x.Vdt,11) as Datetime)    
                              when x.VnoFlag = 2 then Cast(x.Mn + ' 1 '+cast(x.Yr as varchar) as Datetime)    
                        End),    
            X.VNO,    
            x.VnoFlag,    
            FinYear = x.FldAuto    
      From    
            (    
                  select     
                  a.Vtyp,     
                  a.BookType,     
                  a.Vdt,     
                  a.VNo,     
                  B.VnoFlag,     
                  b.FldAuto,     
                  Yr = Year(b.sdtCur) ,     
                  Mn1 = left(B.sdtCur,4),    
                  Mn = left(a.Vdt,4),    
                  Dt = day(a.Vdt)    
                  from LEDGER a, Parameter b    
                  where a.Vdt between b.SdtCur and b.LdtCur    
            ) X    
) F    
group by     
f.Vtyp, f.BookType, f.Vdt, f.VNoFlag, f.FinYear

GO

-- --------------------------------------------------
-- PROCEDURE dbo.v2_rpt_acc_trialbalance_All
-- --------------------------------------------------
/*  
v2_rpt_acc_trialbalance_All 'Dec 15 2006', 'codewise','partywise','normal','Apr 1 2006', 'Apr 1 2006', 1,'Apr 1 2006', 'BRANCH', '01', 'vdt', 'Y', ''  
*/  
/****** Object:  Stored Procedure dbo.v2_rpt_acc_trialbalance_All    Script Date: 03/28/2005 2:41:12 PM ******/  
CREATE PROCEDURE v2_rpt_acc_trialbalance_All  
 @vdt varchar(11),    /* As on date entered by user */  
 @flag varchar(15),    /* sort order for report - Codewise or Namewise */  
 @viewoption varchar(10),  /* options for accounts selection - ALL, GL, PARTY */  
 @balance varchar(10),   /* Normal or Withopbal */  
 @stdate varchar(11),   /* Start date entered by user */  
 @curryrstdate varchar(11),  /* start date of financial year */  
 @openentryflag int,  
 @openingentrydate varchar(11), /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */  
 @statusid varchar(20),   /* As Broker/Branch/Client etc. */  
 @statusname varchar(20),  /* In case of Branch login branchcode */  
 @sortbydate varchar(3),   /* Whether report is based on VDT or EDT */  
 @showzerobal varchar(1),  /* Show Zero Bal   */  
 @showmargin varchar(1)   /* Show Margin Ledger   */  
AS  
/*  
 v2_rpt_acc_trialbalance_All 'Dec 14 2006', 'codewise','partywise','normal','Apr  1 2006', 'Apr  1 2006', 1,'Apr  1 2006', 'BROKER', '%', 'vdt', 'Y', ''  
 v2_rpt_acc_trialbalance_All_Test 'Dec 14 2006', 'codewise','partywise','normal','Apr  1 2006', 'Apr  1 2006', 1,'Apr  1 2006', 'BROKER', '%', 'vdt', 'Y', ''  
*/  
BEGIN  
  
CREATE TABLE [dbo].[#tmpTrialBalance]  
 (  
 [cltcode] [varchar] (10) ,  
 [Acname] [varchar] (100) NULL ,  
 [branchcode] [varchar] (10) NULL,  
 [amount] [money] NULL ,  
 [Segment] [varchar] (4) NULL,  
 [Entity] [varchar] (50) NULL  
 ) ON [PRIMARY]  
  
  
  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNT.DBO.newasp_trialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNT.DBO.newasp_trialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='1NSE',Entity='CAPITAL - NSE' where Segment is NULL  
  
  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNTBSE.DBO.newasp_trialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNTBSE.DBO.newasp_trialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='2BSE',Entity='CAPITAL - BSE' where Segment is NULL  
  
----------------------------------------------COMMENTED SPECIFICALLY FOR VERSION---------------------------------------  
--Nsefo start  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNTFO.DBO.newasp_trialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNTFO.DBO.newasp_trialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='3NFO',Entity='DERIVATIVES - NSE' where Segment is NULL  
  
-- Nsefo end  
--Margin Trial Balance  
/*-------------------------------------------------------------------------------------------------------------------------*/  
--Bsefo start  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNTBFO.DBO.newasp_trialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNTBFO.DBO.newasp_trialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='3BFO',Entity='DERIVATIVES - BSE' where Segment is NULL  
  
--Bsefo end  
/*-------------------------------------------------------------------------------------------------------------------------*/  
  
  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNT.DBO.newasp_MarginTrialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNT.DBO.newasp_MarginTrialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='4NSE',Entity='MARGIN CAPITAL - NSE' where Segment is NULL  
  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNTBSE.DBO.newasp_MarginTrialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNTBSE.DBO.newasp_MarginTrialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='5BSE',Entity='MARGIN CAPITAL - BSE' where Segment is NULL  
  
----------------------------------------------COMMENTED SPECIFICALLY FOR VERSION---------------------------------------  
--Nsefo start  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNTFO.DBO.newasp_MarginTrialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNTFO.DBO.newasp_MarginTrialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='6NFO',Entity='MARGIN DERIVATIVES - NSE' where Segment is NULL  
--Nsefo end  
  
--Bsefo start  
INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCOUNTBFO.DBO.newasp_MarginTrialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCOUNTBFO.DBO.newasp_MarginTrialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='6BFO',Entity='MARGIN DERIVATIVES - BSE' where Segment is NULL  
--Nsefo end  
  

INSERT INTO #tmpTrialBalance(cltcode,Acname,branchcode,amount)  
Exec ACCCOMMON.DBO.newasp_trialbalance @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
  
if @viewoption='gl'  
 begin  
  INSERT INTO #tmpTrialBalance(amount)  
  exec ACCCOMMON.DBO.newasp_trialbalancepartytotal @vdt,@flag,@viewoption,@balance,@stdate,@curryrstdate,@openentryflag,@openingentrydate,@statusid,@statusname,@sortbydate  
 end  
  
UPDATE #tmpTrialBalance set Segment='7COM',Entity='COMMON - COMMON' where Segment is NULL  

  
if @viewoption='gl'  
 begin  
  UPDATE #tmpTrialBalance set Acname='Client Balances',cltcode=' ',branchcode=' ' where cltcode is NULL  
 end  
  
/* Added by UPPILIK */  
  
update #tmpTrialBalance  
set Amount = isnull(amount,0)  
  
  
Delete from #tmpTrialBalance  
where isnull(cltcode,'') = '' and isnull(Acname,'') = ''  
  
/*if @statusid = 'BRANCH'  
begin  
 delete from #TmpTrialBalance  
 where branchcode <> @statusname  
 and branchcode <> 'ALL'  
end */  
  
if @statusid = 'CLIENT'  
begin  
 delete from #TmpTrialBalance  
 where cltcode <> @statusname  
end  
/*  
v2_rpt_acc_trialbalance_All 'Dec 15 2006', 'codewise','partywise','normal','Apr 1 2006', 'Apr 1 2006', 1,'Apr 1 2006', 'BRANCH', '01', 'vdt', 'N', ''  
*/  
--select * From #tmpTrialBalance  
--where amount <> 0  
--return  
  
  
  
  
/* Added by UPPILIK */  
  
if @flag = 'codewise'  
 begin  
  
  
  if @showzerobal='Y'  
   begin  
  
    select cltcode,acname,branchcode,  
    sum(case when Segment='1NSE' then amount else 0 end) as NetNSECM,  
    sum(case when Segment='4NSE' then amount else 0 end) as NetNSECMML,  
    sum(case when Segment='2BSE' then amount else 0 end) as NetBSECM,  
    sum(case when Segment='5BSE' then amount else 0 end) as NetBSECMML,  
    sum(case when Segment='3NFO' then amount else 0 end) as NetNSEFO,  
    sum(case when Segment='6NFO' then amount else 0 end) as NetNSEFOML,  
    sum(case when Segment='3BFO' then amount else 0 end) as NetBSEFO,  
    sum(case when Segment='6BFO' then amount else 0 end) as NetBSEFOML,
    sum(case when Segment='7COM' then amount else 0 end) as NetCOMMON  
    from #tmpTrialBalance  
    group by cltcode,acname,branchcode  
    order by cltcode  
   end  
  else  
   begin  
    if @showmargin='Y'  
     begin  
  
      select cltcode,acname,branchcode,  
      sum(case when Segment='1NSE' then amount else 0 end) as NetNSECM,  
      sum(case when Segment='4NSE' then amount else 0 end) as NetNSECMML,  
      sum(case when Segment='2BSE' then amount else 0 end) as NetBSECM,  
      sum(case when Segment='5BSE' then amount else 0 end) as NetBSECMML,  
      sum(case when Segment='3NFO' then amount else 0 end) as NetNSEFO,  
      sum(case when Segment='6NFO' then amount else 0 end) as NetNSEFOML,  
      sum(case when Segment='3BFO' then amount else 0 end) as NetBSEFO,  
      sum(case when Segment='6BFO' then amount else 0 end) as NetBSEFOML,
      sum(case when Segment='7COM' then amount else 0 end) as NetCOMMON  
      from #tmpTrialBalance  
      group by cltcode,acname,branchcode  
      having  (  
      sum(case when Segment='1NSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='4NSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='2BSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='5BSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='3NFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='6NFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='3BFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='6BFO' then amount else 0 end)<>0 OR
      sum(case when Segment='7COM' then amount else 0 end) <>0)  
      order by cltcode  
     end  
    else  
     begin  
  
      select cltcode,acname,branchcode,  
      sum(case when Segment='1NSE' then amount else 0 end) as NetNSECM,  
      sum(case when Segment='4NSE' then amount else 0 end) as NetNSECMML,  
      sum(case when Segment='2BSE' then amount else 0 end) as NetBSECM,  
      sum(case when Segment='5BSE' then amount else 0 end) as NetBSECMML,  
      sum(case when Segment='3NFO' then amount else 0 end) as NetNSEFO,  
      sum(case when Segment='6NFO' then amount else 0 end) as NetNSEFOML,  
      sum(case when Segment='3BFO' then amount else 0 end) as NetBSEFO,  
      sum(case when Segment='6BFO' then amount else 0 end) as NetBSEFOML,
      sum(case when Segment='7COM' then amount else 0 end) as NetCOMMON  
      from #tmpTrialBalance  
      group by cltcode,acname,branchcode  
      having    (  
      sum(case when Segment='1NSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='2BSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='3NFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='3BFO' then amount else 0 end)<>0 OR
      sum(case when Segment='7COM' then amount else 0 end)<>0   )  
      order by cltcode  
     end  
   end  
 end  
else  
begin  
  if @showzerobal='Y'  
   begin  
    select cltcode,acname,branchcode,  
    sum(case when Segment='1NSE' then amount else 0 end) as NetNSECM,  
    sum(case when Segment='4NSE' then amount else 0 end) as NetNSECMML,  
    sum(case when Segment='2BSE' then amount else 0 end) as NetBSECM,  
    sum(case when Segment='5BSE' then amount else 0 end) as NetBSECMML,  
    sum(case when Segment='3NFO' then amount else 0 end) as NetNSEFO,  
    sum(case when Segment='6NFO' then amount else 0 end) as NetNSEFOML,  
    sum(case when Segment='3BFO' then amount else 0 end) as NetBSEFO,  
    sum(case when Segment='6BFO' then amount else 0 end) as NetBSEFOML,
    sum(case when Segment='7COM' then amount else 0 end) as NetCOMMON  
    from #tmpTrialBalance  
    group by cltcode,acname,branchcode  
    order by acname  
   end  
  else  
   begin  
    if @showmargin='Y'  
     begin  
      select cltcode,acname,branchcode,  
      sum(case when Segment='1NSE' then amount else 0 end) as NetNSECM,  
      sum(case when Segment='4NSE' then amount else 0 end) as NetNSECMML,  
      sum(case when Segment='2BSE' then amount else 0 end) as NetBSECM,  
      sum(case when Segment='5BSE' then amount else 0 end) as NetBSECMML,  
      sum(case when Segment='3NFO' then amount else 0 end) as NetNSEFO,  
      sum(case when Segment='6NFO' then amount else 0 end) as NetNSEFOML,  
      sum(case when Segment='3BFO' then amount else 0 end) as NetBSEFO,  
      sum(case when Segment='6BFO' then amount else 0 end) as NetBSEFOML,
      sum(case when Segment='7COM' then amount else 0 end) as NetCOMMON  
      from #tmpTrialBalance  
      group by cltcode,acname,branchcode  
      having    (  
      sum(case when Segment='1NSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='4NSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='2BSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='5BSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='3NFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='6NFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='3BFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='6BFO' then amount else 0 end)<>0 OR
      sum(case when Segment='7COM' then amount else 0 end)<>0  )  
      order by acname  
     end  
    else  
     begin  
      select cltcode,acname,branchcode,  
      sum(case when Segment='1NSE' then amount else 0 end) as NetNSECM,  
      sum(case when Segment='4NSE' then amount else 0 end) as NetNSECMML,  
      sum(case when Segment='2BSE' then amount else 0 end) as NetBSECM,  
      sum(case when Segment='5BSE' then amount else 0 end) as NetBSECMML,  
      sum(case when Segment='3NFO' then amount else 0 end) as NetNSEFO,  
      sum(case when Segment='6NFO' then amount else 0 end) as NetNSEFOML,
      sum(case when Segment='7COM' then amount else 0 end) as NetCOMMON  
      from #tmpTrialBalance  
      group by cltcode,acname,branchcode  
      having    (  
      sum(case when Segment='1NSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='2BSE' then amount else 0 end)<>0 OR  
      sum(case when Segment='3NFO' then amount else 0 end)<>0 OR  
      sum(case when Segment='3BFO' then amount else 0 end)<>0 OR
      sum(case when Segment='7COM' then amount else 0 end)<>0  )  
      order by acname  
     end  
   end  
 end  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_RUNNINGBALANCES_CUR
-- --------------------------------------------------


CREATE PROCEDURE V2_RUNNINGBALANCES_CUR  
(  
        @@NOFDAYS INT 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_RUNNINGBALANCES_CUR  
                @@NOFDAYS = 80 
==============================================================================================================*/  
  
        SET NOCOUNT ON

	DECLARE 
		@@VDATE DATETIME, 
		@@BALDATE INT 

	SET @@VDATE = LEFT(GETDATE() - @@NOFDAYS,11)

	WHILE @@VDATE <= LEFT(GETDATE(),11) 
	BEGIN 
		SET @@BALDATE = CONVERT(INT,CONVERT(VARCHAR,@@VDATE,112))

		EXEC V2_RUNNINGBALANCES_UP @@BALDATE

		SET @@VDATE = @@VDATE + 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_RUNNINGBALANCES_UP
-- --------------------------------------------------


CREATE PROCEDURE V2_RUNNINGBALANCES_UP  
(  
        @@BALDATE INT 
)  
  
AS  
  
/*==============================================================================================================  
        EXEC V2_RUNNINGBALANCES_UP  
                @@BALDATE = 20060402 
  
==============================================================================================================*/  
  
        SET NOCOUNT ON

	DECLARE 
		@@SPAN_MARGIN INT,
		@@EXPOSURE_MARGIN INT

	SELECT 
        @@SPAN_MARGIN = SPAN_MARGIN, 
        @@EXPOSURE_MARGIN = EXPOSURE_MARGIN 
	FROM V2_CLIENTPROFILES_FA 
	WHERE CLTCODE = 'ALL'

/*==============================================================================================================  
	TO CALCULATE RUNNING BALANCE FOR CLIENTS WHO HAVE AN ENTRY IN THE LEDGER 
==============================================================================================================*/  
	SELECT DISTINCT CLTCODE, SEGMENTCODE, LEDTYPE 
	INTO #CLIENT 
	FROM V2_ACCOUNTBALANCES 
	WHERE VDT = @@BALDATE OR EDT = @@BALDATE 

	CREATE NONCLUSTERED INDEX [MAINIDX] ON [dbo].[#CLIENT] 
	(
		[CLTCODE] ASC
	)

	CREATE STATISTICS [MAINSTATS] ON [dbo].[#CLIENT]([CLTCODE], [SEGMENTCODE], [LEDTYPE])
	
	TRUNCATE TABLE V2_RUNNINGBALANCES_TMP 

/*==============================================================================================================  
	POPULATE VOUCHER DATE WISE LEDGER BALANCES
==============================================================================================================*/  
	INSERT INTO V2_RUNNINGBALANCES_TMP  
	SELECT 
		V.CLTCODE, 
		V.SEGMENTCODE, 
		V.LEDTYPE, 
		VDTBAL = SUM(BALCR - BALDR), 
		EDTBAL = 0, 
		BALDATE = @@BALDATE 
	FROM 
		V2_ACCOUNTBALANCES V, 
		#CLIENT C, 
		PARAMETER P 
	WHERE 
		CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
		AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
		AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
		AND V.CLTCODE = C.CLTCODE 
		AND V.SEGMENTCODE = C.SEGMENTCODE
		AND V.LEDTYPE = C.LEDTYPE 
	GROUP BY 
		V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE
	
/*==============================================================================================================  
	POPULATE EFFECTIVE DATE WISE LEDGER BALANCES
==============================================================================================================*/  
	INSERT INTO V2_RUNNINGBALANCES_TMP  
	SELECT 
		V.CLTCODE, 
		V.SEGMENTCODE, 
		V.LEDTYPE, 
		VDTBAL = 0, 
		EDTBAL = SUM(BALCR - BALDR), 
		BALDATE = @@BALDATE 
	FROM 
		V2_ACCOUNTBALANCES V, 
		#CLIENT C, 
		PARAMETER P 
	WHERE 
		CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) <= @@BALDATE
		AND CONVERT(INT,CONVERT(VARCHAR,LDTCUR,112)) >= @@BALDATE 
		AND VDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
		AND EDT BETWEEN CONVERT(INT,CONVERT(VARCHAR,SDTCUR,112)) AND @@BALDATE 
		AND V.CLTCODE = C.CLTCODE 
		AND V.SEGMENTCODE = C.SEGMENTCODE
		AND V.LEDTYPE = C.LEDTYPE 
	GROUP BY 
		V.CLTCODE, V.SEGMENTCODE, V.LEDTYPE


/*==============================================================================================================  
	POPULATE MARGIN REQUIREMENT 
==============================================================================================================*/  
	INSERT INTO V2_RUNNINGBALANCES_TMP  
	SELECT 
		V.CLTCODE, 
		SEGMENTCODE = 3, 
		LEDTYPE = 3, 
		VDTBAL = NONCASH - (
                        (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                        + 
                        (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                            ), 
		EDTBAL = NONCASH - (
                        (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                        + 
                        (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                            ), 
		BALDATE = @@BALDATE 
	FROM 
		( 
			SELECT 
				CLTCODE = ISNULL(C.CLTCODE,M.CLTCODE), 
				NONCASH = ISNULL(NONCASH,0), 
				TOTALMARGIN = ISNULL(TOTALMARGIN,0), 
				MTOM = ISNULL(MTOM,0) 
			FROM 
				(
					SELECT CLTCODE = PARTY_CODE, NONCASH 
					FROM MSAJAG.DBO.COLLATERAL 
					WHERE CONVERT(INT,CONVERT(VARCHAR,TRANS_DATE,112)) = @@BALDATE 
					AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
				) C FULL OUTER JOIN 
				(
					SELECT CLTCODE = PARTY_CODE, TOTALMARGIN, MTOM 
					FROM NSEFO.DBO.FOMARGINNEW 
					WHERE CONVERT(INT,CONVERT(VARCHAR,MDATE,112)) = @@BALDATE
				) M 
			ON M.CLTCODE = C.CLTCODE 
		 ) V LEFT OUTER JOIN V2_CLIENTPROFILES_FA F ON (V.CLTCODE = F.CLTCODE)
	WHERE NONCASH - (
                        (CASE WHEN ISNULL(SPAN_MARGIN,@@SPAN_MARGIN) = 1 THEN TOTALMARGIN ELSE 0 END) 
                        + 
                        (CASE WHEN ISNULL(EXPOSURE_MARGIN,@@EXPOSURE_MARGIN) = 1 THEN MTOM ELSE 0 END) 
                            ) < 0 

/*==============================================================================================================  
	POPULATE DATA IN FINAL TABLE 
==============================================================================================================*/  
	BEGIN TRAN 
		DELETE V2_RUNNINGBALANCES WHERE BALDATE = @@BALDATE

		INSERT INTO V2_RUNNINGBALANCES 
		SELECT 
			CLTCODE, 
			SEGMENTCODE, 
			LEDTYPE, 
			SUM(VDTBAL), 
			SUM(EDTBAL), 
			BALDATE 
		FROM 
			V2_RUNNINGBALANCES_TMP 
		GROUP BY  
			CLTCODE, 
			SEGMENTCODE, 
			LEDTYPE, 
			BALDATE 

		TRUNCATE TABLE V2_RUNNINGBALANCES_TMP 
	COMMIT TRAN

	TRUNCATE TABLE #CLIENT

/*==============================================================================================================  
	END OF PROCESS
==============================================================================================================*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_NEW
-- --------------------------------------------------
--SELECT * FROM COSTMAST  
--Exec v2_SelectVoucherDetails_New '19' , '01 ' , 'Jun 11 2007' , 'Jun 11 2008' , '200700000004' , '200700000004' , 'BANK01','broker','broker'

CREATE PROC V2_SELECTVOUCHERDETAILS_NEW
@VTYP INT,  
@BOOKTYPE VARCHAR(2),  
@FROMDATE VARCHAR(12),  
@TODATE VARCHAR(12),  
@VNOFROM VARCHAR(12),  
@VNOTO VARCHAR(12),  
@BANKCODE VARCHAR(10),  
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(10)  
  
AS  
  
DECLARE   
@@COSTCODE INT  

IF (@VTYP <> 19 AND @VTYP <> 20)  
BEGIN  
 IF UPPER(@STATUSID) = 'BROKER'  
 BEGIN 
	IF (@VTYP = 2 AND @VTYP = 3)  
	   BEGIN 
		SELECT DISTINCT 
		   	AL.VNO, 
			DD, 
			DDNO, 
			AL.VAMT, 
			DRCR = AL.DRCR, 
			CLTCODE = AL.CLTCODE, 
			ACNAME = AL.ACNAME, 
			CHEQUEINNAME, 
			AL.NARRATION, 
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			MICRNO, 
			AL.BOOKTYPE   
		FROM 
			LEDGER L 
			LEFT OUTER JOIN ACCCOMMON.DBO.RECPAYENTRY_MAPPING R ON L.VNO = R.VNO_DEF AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE 
			LEFT OUTER JOIN ACCCOMMON.DBO.LEDGER AL ON AL.VNO = R.VNO AND AL.VTYP = R.VTYP AND AL.BOOKTYPE = R.BOOKTYPE  
			LEFT OUTER JOIN LEDGER1 AL1 ON  AL.VTYP = AL1.VTYP AND AL.BOOKTYPE = AL1.BOOKTYPE AND AL.VNO = AL1.VNO AND AL.LNO = AL1.LNO 
		WHERE 
			AL.VTYP = @VTYP AND AL.VNO >= @VNOFROM  AND AL.VNO <= @VNOTO    
		    AND L.VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
			AND L.BOOKTYPE = @BOOKTYPE
			AND AL.CLTCODE <> @BANKCODE 
		ORDER BY 
			AL.VNO, AL.DRCR DESC
	  END
	ELSE
	 BEGIN 
	  SELECT DISTINCT  
	   L.VNO, DD, DDNO, VAMT, DRCR = L.DRCR, CLTCODE = L.CLTCODE, ACNAME = L.ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), MICRNO, L.BOOKTYPE  
	  FROM   
	   LEDGER L,   
	   (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,  
	   LEDGER1 L1  
	  WHERE   
	   L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE  
	   AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE  
	 END
 END  
 ELSE  
 BEGIN  
  SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME  
  SELECT   
   L.VNO, DD, DDNO, VAMT = CAMT, DRCR = L.DRCR, CLTCODE = L.CLTCODE, ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE  
  FROM   
   LEDGER2 L,   
   (SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,  
   LEDGER1 L1,  
   ACMAST A  
  WHERE   
   A.CLTCODE = L.CLTCODE  
   AND L.VNO = L2.VNO AND L.VTYPE = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE  
   AND L.VNO = L1.VNO AND L.VTYPE = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND COSTCODE = @@COSTCODE  
 END  
END    
ELSE  
BEGIN  
 IF @STATUSID = 'BROKER'  
 BEGIN 
  SELECT   
   L.VNO, DD, DDNO, VAMT = AMOUNT, DRCR = L.DRCR, CLTCODE = L.PARTY_CODE, ACNAME = A.ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE  
  FROM   
   MARGINLEDGER L,   
   (SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,  
   LEDGER1 L1,  
   ACMAST A  
  WHERE   
   L.PARTY_CODE = A.CLTCODE     
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE   
   AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE   
 END  
 ELSE  
 BEGIN  
  SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME  
  SELECT   
   ML.VNO, DD, DDNO, VAMT = AMOUNT, DRCR = ML.DRCR, CLTCODE = ML.PARTY_CODE, ACNAME, CHEQUEINNAME, NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), A.MICRNO, L.BOOKTYPE  
  FROM   
   MARGINLEDGER ML,  
   LEDGER2 L,   
   (SELECT VNO, VTYP, BOOKTYPE, NARRATION FROM LEDGER WHERE CLTCODE = @BANKCODE AND VDT BETWEEN @FROMDATE AND @TODATE + ' 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO BETWEEN @VNOFROM AND @VNOTO) L2,  
   LEDGER1 L1,  
   ACMAST A  
  WHERE   
   A.CLTCODE = ML.PARTY_CODE  
   AND ML.VNO = L2.VNO AND ML.VTYP = L2.VTYP AND ML.BOOKTYPE = L2.BOOKTYPE  
   AND L.VNO = L2.VNO AND L.VTYPE = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> @BANKCODE  
    AND L.VNO = L1.VNO AND L.VTYPE = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND COSTCODE = @@COSTCODE  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_NEW_FP
-- --------------------------------------------------



CREATE PROC V2_SELECTVOUCHERDETAILS_NEW_FP

@VTYP VARCHAR(2),
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(12) ,
@BANKNAME VARCHAR(50),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
    @@SELECTQURY AS VARCHAR(8000),
    @@FROMTABLES AS VARCHAR(2000),
    @@WHEREPART AS VARCHAR(8000),
    @@SORTBY AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
    BEGIN 
        SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "' AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END

ELSE
    BEGIN
        SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
    BEGIN
        SELECT @@FROMTABLES = " FROM LEDGER L WITH (NOLOCK) LEFT OUTER JOIN  LEDGER1 L1 WITH (NOLOCK) ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.CHQPRINTED=0 AND L.LNO = L1.LNO LEFT OUTER JOIN MULTIBANKID M ON L.CLTCODE = M.CLTCODE AND DEFAULTBANK = 1, " 
        IF @BRANCHCODE <> '%' 
            BEGIN
                SELECT @@FROMTABLES = @@FROMTABLES + " ACMAST A, "
            END
        SELECT @@FROMTABLES = @@FROMTABLES + " ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
        SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED=0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
        IF @BRANCHCODE <> '%' 
            BEGIN        
                SELECT @@WHEREPART = @@WHEREPART + " AND A.CLTCODE = L.CLTCODE AND A.BRANCHCODE = '" + @BRANCHCODE + "' "
            END
    END

SELECT @@WHEREPART = @@WHEREPART

SELECT @@SELECTQURY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "
SELECT @@SELECTQURY = @@SELECTQURY + " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT L.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME=ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, ACCNO = ISNULL(M.ACCNO, '') "

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_NEW_RP
-- --------------------------------------------------




CREATE  PROC V2_SELECTVOUCHERDETAILS_NEW_RP

@VTYP VARCHAR(2),
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(12) ,
@BANKNAME VARCHAR(50),
@BRANCHCODE VARCHAR(12)

AS

DECLARE
    @@SELECTQURY AS VARCHAR(8000),
    @@FROMTABLES AS VARCHAR(2000),
    @@WHEREPART AS VARCHAR(8000),
    @@SORTBY AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
    BEGIN 
        SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "' AND L.VNO <= '" + @VNOTO + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END
ELSE
    BEGIN
        SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "' AND L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
    BEGIN
        SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO LEFT OUTER JOIN MULTIBANKID M ON L.CLTCODE = M.CLTCODE AND DEFAULTBANK = 1, " 
        IF @BRANCHCODE <> '%' 
            BEGIN
                SELECT @@FROMTABLES = @@FROMTABLES + " ACMAST A, "
            END
        SELECT @@FROMTABLES = @@FROMTABLES + " ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
        SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
        IF @BRANCHCODE <> '%' 
            BEGIN        
                SELECT @@WHEREPART = @@WHEREPART + " AND A.CLTCODE = L.CLTCODE AND A.BRANCHCODE = '" + @BRANCHCODE + "' "
            END
    END

SELECT @@WHEREPART = @@WHEREPART

SELECT @@SELECTQURY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "
SELECT @@SELECTQURY = @@SELECTQURY + " SELECT DISTINCT L1.DDDT, L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = pradnya.dbo.numininr(ISNULL(cast(L.VAMT as numeric(18,2)),0)), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT L.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, ACCNO = ISNULL(M.ACCNO, '') "

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_SELECTVOUCHERDETAILS_UPD
-- --------------------------------------------------



CREATE PROC V2_SELECTVOUCHERDETAILS_UPD

@VTYP VARCHAR(2),
@BOOKTYPE VARCHAR(2),
@FROMDATE VARCHAR(12),
@TODATE VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO VARCHAR(12),
@BANKCODE VARCHAR(12) ,
@BANKNAME VARCHAR(50),
@BRANCHCODE VARCHAR(12),
@NEWPRINTFLAG VARCHAR(2)

AS

DECLARE
    @@SELECTQURY AS VARCHAR(8000),
    @@FROMTABLES AS VARCHAR(2000),
    @@WHEREPART AS VARCHAR(8000),
    @@SORTBY AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
    BEGIN 
        SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END
ELSE
    BEGIN
        SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "' AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
    END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
    BEGIN
        SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO LEFT OUTER JOIN MULTIBANKID M ON L.CLTCODE = M.CLTCODE AND DEFAULTBANK = 1, " 
        IF @BRANCHCODE <> '%' 
            BEGIN
                SELECT @@FROMTABLES = @@FROMTABLES + " ACMAST A, "
            END
        SELECT @@FROMTABLES = @@FROMTABLES + " ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
        IF @NEWPRINTFLAG = 'FP'
            SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED = 0 AND L1.DDNO >= '0' "
        IF @NEWPRINTFLAG = 'RP'
            SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED > 0 AND L1.DDNO > '0' "
        SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
        IF @BRANCHCODE <> '%' 
            BEGIN        
                SELECT @@WHEREPART = @@WHEREPART + " AND A.CLTCODE = L.CLTCODE AND A.BRANCHCODE = '" + @BRANCHCODE + "' "
            END
    END

SELECT @@WHEREPART = @@WHEREPART

SELECT @@SELECTQURY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "
SELECT @@SELECTQURY = @@SELECTQURY + " SELECT DISTINCT L1.DDDT, L.VNO, ISNULL(DD,'') DD, ISNULL(DDNO,'') DDNO, VAMT = ISNULL(L.VAMT,0), L.DRCR, CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT L.ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION, PRINTEDFLAG = ISNULL(CHQPRINTED,0), L1.MICRNO, L.BOOKTYPE, ACCNO = ISNULL(M.ACCNO, '') "

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPLOADFILESELECT
-- --------------------------------------------------
CREATE PROC [dbo].[V2_UPLOADFILESELECT](
         @FILE_GROUP VARCHAR(100) = '')

AS

  SET NOCOUNT ON

  IF @FILE_GROUP = '' 
  SELECT   DISTINCT FILE_GROUP 
  FROM     ACCOUNTS_FILE_LIST 
  ORDER BY 1

  IF @FILE_GROUP <> '' 
  SELECT   DISTINCT FILE_DESC 
  FROM     ACCOUNTS_FILE_LIST 
  WHERE    FILE_GROUP = @FILE_GROUP
  ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V3_AGEINGCURSOR_NEW11_BULK
-- --------------------------------------------------

/*
exec V3_AGEINGCURSOR_NEW11_BULK '983311', '983311', 'Apr 1 2007', 'Dec 17 2007','party','',0, 'A','vdt','broker','broker', 6, 29, 90, 180, 181, '0', 'ZZZZ', 'Y', 'Y', 'Y', 'N', 'N', 'N' 
Alter Table TEMP_AGEING_BULK
Add TRADER varchar(20)
*/




CREATE PROCEDURE [dbo].[V3_AGEINGCURSOR_NEW11_BULK]
/*
EXEC V3_AGEINGCURSOR_NEW11_BULK_TRADER '0', 'z', 'Apr  1 2006', 'Jun 15 2006','party','',0, 'A','vdt','BROKER','BROKER',6,29,90,180,181,'A', 'O', 'N', 'Y', 'Y', 'Y', 'Y', 'Y'
exec V3_AGEINGCURSOR_NEW11_BULK '0', 'Z', 'Apr 1 2006', 'Jun 19 2006','party','',0, 'A','vdt','broker','broker', 6, 29, 90, 180, 181, '0', 'ZZZZ', 'Y'
exec V3_AGEINGCURSOR_NEW11_BULK '0', 'z', 'Apr 1 2006', 'Jun 19 2006','party','',0, 'A','vdt','broker','broker', 6, 29, 90, 180, 181, '0', 'ZZZZ', 'N'
SELECT * FROM FILE_OUTPUT
SELECT CLTCODE = 'T O T A L', SHORT_NAME = '', BALANCE = CONVERT(VARCHAR(20), SUM(BALANCE)), [0-6] = CONVERT(VARCHAR(20), SUM([0-6])), [7-29] = CONVERT(VARCHAR(20), SUM([7-29])), [30-90] = CONVERT(VARCHAR(20), SUM([30-90])), [91-180] = CONVERT(VARCHAR(20), SUM([91-180])), [MORE THAN 181] = CONVERT(VARCHAR(20), SUM([MORE THAN 181])) FROM AGE_16_28_58270 
*/
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@OPENDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@REPORTTYPE VARCHAR(15),
	@FAMILY VARCHAR(10),
	@AMOUTGTTHAN MONEY,
	@AGEOPTION VARCHAR(1),
	@DTTYPE VARCHAR(3),
	@STATUSID VARCHAR(10),
	@STATUSNAME VARCHAR(25),
	@DAYS1 INT,
	@DAYS2 INT,
	@DAYS3 INT,
	@DAYS4 INT,
	@DAYS5 INT,
	@FRSB VARCHAR(10) = '0',
	@TOSB VARCHAR(10) = 'ZZZZZZZZZZ',
	@BULK VARCHAR(1) = 'N',
	@NSE VARCHAR(1) = 'Y',
	@BSE VARCHAR(1) = 'Y',
	@FO VARCHAR(1) = 'Y',
	@MCX VARCHAR(1) = 'Y',
	@NCDX VARCHAR(1) = 'Y'

AS

DECLARE
	@@BALCUR AS CURSOR,
	@@BALDATE AS VARCHAR(11),
	@@OPENBALDT AS VARCHAR(11),
	@@BALAMT AS MONEY,
	@@OCLTCODE AS VARCHAR(10),
	@@VTYP AS SMALLINT,
	@@VNO VARCHAR(12),
	@@EVDT AS DATETIME,
	@@VAMT AS MONEY,
	@@CLOSBAL AS MONEY,
	@@CLTCODE AS VARCHAR(10),
	@@TRADER AS VARCHAR(10),
	@@BRANCHCODE AS VARCHAR(25),
	@@SUB_BROKER AS VARCHAR(10),
	@@SUB_BRNAME AS VARCHAR(50),
	@@BRANCHCD AS VARCHAR(10),
	@@BRANCHNAME AS VARCHAR(100),
	@@AREA AS VARCHAR(25),
	@@DRCR    AS VARCHAR(1),
	@@STARTDT AS DATETIME,
	@@FNAME AS VARCHAR(200),
	@@SQL AS VARCHAR(2000),
	@@NSEDATA TINYINT,
	@@BSEDATA TINYINT,
	@@FODATA TINYINT,
	@@MCXDATA TINYINT,
	@@NCDXDATA TINYINT,
	@@DBNAME AS VARCHAR(25)

SELECT @@NSEDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNT'
SELECT @@BSEDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTBSE'
SELECT @@FODATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTFO'
SELECT @@MCXDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTMCDX'
SELECT @@NCDXDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTNCDX'
SELECT @@DBNAME = DB_NAME()

SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
	@@STARTDT = (SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@TODATE)),109),11) )


SELECT 
	CLTCODE,
	BALDATE = VDT,
	CLOSBAL = VAMT,
	AGEDAYS=0,
	TRADER = SPACE(20),
	SUB_BROKER = SPACE(10),
	SUB_BRNAME = SPACE(50),
	BRANCHCODE = SPACE(10),
	BRANCHNAME = SPACE(100)
INTO
	#TEMPAGEING
FROM
	LEDGER
WHERE
	1=2

SELECT
	CLTCODE,
	BALDATE = VDT,
	CLOSBAL = VAMT,
	AGEDAYS=0,
	TRADER = SPACE(20),
	SUB_BROKER = SPACE(10),
	SUB_BRNAME = SPACE(50),
	BRANCHCODE = SPACE(10),
	BRANCHNAME = SPACE(100)
INTO
	#TEMPAGEING1
FROM
	LEDGER
WHERE
	1=2

SELECT
	VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
INTO
	#LEDGER
FROM
	LEDGER
WHERE
	1=2

SELECT
	CLTCODE,
	VTYP,
	VNO,
	EVDT = EDT,
	VAMT,
	CLOSBAL = VAMT,
	TRADER = SPACE(20),
	SUB_BROKER = SPACE(10),
	SUB_BRNAME = SPACE(50),
	BRANCHCODE = SPACE(10),
	BRANCHNAME = SPACE(100)
INTO
	#LEDGERCURSOR
FROM
	LEDGER
WHERE
	1=2

IF @DTTYPE='VDT'
	BEGIN
		SELECT
			@@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MIN(VDT),0),109),11)
		FROM
			LEDGER
		WHERE
			VTYP = '18'
			AND VDT <= @OPENDATE
		IF UPPER(@REPORTTYPE) = 'PARTY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT INTO #TEMPAGEING1
						SELECT
							L.CLTCODE,
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM
							ACCOUNT.DBO.LEDGER L,
							MSAJAG.DBO.CLIENT1 C1,
							MSAJAG.DBO.CLIENT2 C2,
							MSAJAG.DBO.SUBBROKERS S,
							MSAJAG.DBO.BRANCH B
						WHERE
							L.CLTCODE = C2.PARTY_CODE
							AND C1.CL_CODE = C2.CL_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND VDT >= @OPENDATE + ' 00:00:00'
							AND VDT <= @TODATE + ' 23:59'
							AND L.CLTCODE >= @FROMPARTY
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT
							L.CLTCODE,
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM
							ACCOUNTBSE.DBO.LEDGER L,
							BSEDB.DBO.CLIENT1 C1,
							BSEDB.DBO.CLIENT2 C2,
							BSEDB.DBO.SUBBROKERS S,
							BSEDB.DBO.BRANCH B
						WHERE
							L.CLTCODE = C2.PARTY_CODE
							AND C1.CL_CODE = C2.CL_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND VDT >= @OPENDATE + ' 00:00:00'
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY
							L.CLTCODE
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM
							ACCOUNTFO.DBO.LEDGER L,
							NSEFO.DBO.CLIENT1 C1,
							NSEFO.DBO.CLIENT2 C2,
							NSEFO.DBO.SUBBROKERS S,
							NSEFO.DBO.BRANCH B
						WHERE 
							L.CLTCODE = C2.PARTY_CODE
							AND C1.CL_CODE = C2.CL_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND VDT >= @OPENDATE + ' 00:00:00'
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM
							ACCOUNTMCDX.DBO.LEDGER L,
							MCDX.DBO.CLIENT1 C1,
							MCDX.DBO.CLIENT2 C2,
							MCDX.DBO.SUBBROKERS S,
							MCDX.DBO.BRANCH B
						WHERE 
							L.CLTCODE = C2.PARTY_CODE
							AND C1.CL_CODE = C2.CL_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND VDT >= @OPENDATE + ' 00:00:00'
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM
							ACCOUNTNCDX.DBO.LEDGER L,
							NCDX.DBO.CLIENT1 C1,
							NCDX.DBO.CLIENT2 C2,
							NCDX.DBO.SUBBROKERS S,
							NCDX.DBO.BRANCH B
						WHERE 
							L.CLTCODE = C2.PARTY_CODE
							AND C1.CL_CODE = C2.CL_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND VDT >= @OPENDATE + ' 00:00:00'
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END

				INSERT INTO #TEMPAGEING
				SELECT 
					CLTCODE, 
					BALDATE=@TODATE,
					CLOSBAL = SUM(CLOSBAL),
					AGEDAYS=0,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				FROM
					#TEMPAGEING1
				GROUP BY
					CLTCODE,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				HAVING
					ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)
				ORDER BY 
					CLTCODE
			END
		ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE,
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNT.DBO.LEDGER L,  
							MSAJAG.DBO.CLIENT1 C1, 
							MSAJAG.DBO.CLIENT2 C2,
							MSAJAG.DBO.SUBBROKERS S,
							MSAJAG.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTBSE.DBO.LEDGER L,
							BSEDB.DBO.CLIENT1 C1, 
							BSEDB.DBO.CLIENT2 C2,
							BSEDB.DBO.SUBBROKERS S,
							BSEDB.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTFO.DBO.LEDGER L,  
							NSEFO.DBO.CLIENT1 C1, 
							NSEFO.DBO.CLIENT2 C2,
							NSEFO.DBO.SUBBROKERS S,
							NSEFO.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END

				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTMCDX.DBO.LEDGER L,
							MCDX.DBO.CLIENT1 C1, 
							MCDX.DBO.CLIENT2 C2,
							MCDX.DBO.SUBBROKERS S,
							MCDX.DBO.BRANCH B 
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER 
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTNCDX.DBO.LEDGER L,  
							NCDX.DBO.CLIENT1 C1, 
							NCDX.DBO.CLIENT2 C2,
							NCDX.DBO.SUBBROKERS S,
							NCDX.DBO.BRANCH B  
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END

				INSERT   INTO #TEMPAGEING
				SELECT 
					CLTCODE, 
					BALDATE=@TODATE,
					CLOSBAL = SUM(CLOSBAL),
					AGEDAYS=0,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				FROM 
					#TEMPAGEING1
				GROUP BY 
					CLTCODE,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				HAVING
					ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)
				ORDER BY 
					CLTCODE,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
			END
		ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNT.DBO.LEDGER L, 
							MSAJAG.DBO.CLIENT1 C1, 
							MSAJAG.DBO.CLIENT2 C2,
							MSAJAG.DBO.SUBBROKERS S,
							MSAJAG.DBO.BRANCH B  
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER 
							AND C1.FAMILY = @FAMILY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTBSE.DBO.LEDGER L, 
							BSEDB.DBO.CLIENT1 C1, 
							BSEDB.DBO.CLIENT2 C2,
							BSEDB.DBO.SUBBROKERS S,
							BSEDB.DBO.BRANCH B   
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER 
							AND C1.FAMILY = @FAMILY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTFO.DBO.LEDGER L, 
							NSEFO.DBO.CLIENT1 C1, 
							NSEFO.DBO.CLIENT2 C2,
							NSEFO.DBO.SUBBROKERS S,
							NSEFO.DBO.BRANCH B  
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER 
							AND C1.FAMILY = @FAMILY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END

				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTMCDX.DBO.LEDGER L, 
							MCDX.DBO.CLIENT1 C1, 
							MCDX.DBO.CLIENT2 C2,
							MCDX.DBO.SUBBROKERS S,
							MCDX.DBO.BRANCH B 
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER  
							AND C1.FAMILY = @FAMILY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							TRADER = C1.TRADER,
							SUB_BROKER = C1.SUB_BROKER,
							SUB_BRNAME = S.NAME,
							BRANCHCODE = C1.BRANCH_CD,
							BRANCHNAME = B.BRANCH
						FROM 
							ACCOUNTNCDX.DBO.LEDGER L, 
							NCDX.DBO.CLIENT1 C1, 
							NCDX.DBO.CLIENT2 C2,
							NCDX.DBO.SUBBROKERS S,
							NCDX.DBO.BRANCH B  
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND VDT >= @OPENDATE + ' 00:00:00' 
							AND VDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER   
							AND C1.FAMILY = @FAMILY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END

				INSERT   INTO #TEMPAGEING
				SELECT 
					CLTCODE, 
					BALDATE=@TODATE,
					CLOSBAL = SUM(CLOSBAL),
					AGEDAYS=0,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				FROM 
					#TEMPAGEING1
				GROUP BY 
					CLTCODE,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				HAVING
					ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)
				ORDER BY 
					CLTCODE,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
			END
		IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNT.DBO.LEDGER 
						WHERE VDT <= @TODATE  + ' 23:59:59'
						AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNT.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTBSE.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTBSE.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTFO.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTFO.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTMCDX.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTMCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTNCDX.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTNCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
			END
		ELSE
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNT.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM MSAJAG.DBO.CLIENT2 C2, MSAJAG.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNT.DBO.LEDGER.CLTCODE)
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTBSE.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM BSEDB.DBO.CLIENT2 C2, BSEDB.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTBSE.DBO.LEDGER.CLTCODE)
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTFO.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM NSEFO.DBO.CLIENT2 C2, NSEFO.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTFO.DBO.LEDGER.CLTCODE)
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTMCX.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM MCDX.DBO.CLIENT2 C2, MCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTMCDX.DBO.LEDGER.CLTCODE)
					END

				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTNCDX.DBO.LEDGER 
						WHERE 
							VDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM NCDX.DBO.CLIENT2 C2, NCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTNCDX.DBO.LEDGER.CLTCODE)
					END

			END
		IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'
			BEGIN
				IF UPPER(RTRIM(@AGEOPTION)) = 'D'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							SUB_BROKER,
							SUB_BRNAME,
							BRANCHCODE,
							BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND VDT <= @TODATE  + ' 23:59'
							AND VTYP <> 18
						ORDER BY 
							L.CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							SUB_BROKER,
							SUB_BRNAME,
							BRANCHCODE,
							BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND VDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
						ORDER BY 
							L.CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

					END
				ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							SUB_BROKER,
							SUB_BRNAME,
							BRANCHCODE,
							BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND VDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
						ORDER BY 
							L.CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							SUB_BROKER,
							SUB_BRNAME,
							BRANCHCODE,
							BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND VDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
						ORDER BY 
							L.CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

					END
				ELSE
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							SUB_BROKER,
							SUB_BRNAME,
							BRANCHCODE,
							BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND VDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
						ORDER BY 
							L.CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							SUB_BROKER,
							SUB_BRNAME,
							BRANCHCODE,
							BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND VDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
						ORDER BY 
							L.CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

					END
			END
		ELSE
			BEGIN
				IF UPPER(RTRIM(@AGEOPTION)) = 'D'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C,  
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND VDT <= @TODATE  + ' 23:59:59'
							AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY
							AND VTYP <> '18'
						ORDER BY CLTCODE, VDT DESC, VTYP, VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C,  
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND VDT LIKE @@OPENBALDT + '%'
							AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY
							AND VTYP = '18'
						ORDER BY CLTCODE, VDT DESC, VTYP, VNO


					END
				ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE  
							A.CLTCODE = FAMILY
							AND CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND VDT <= @TODATE  + ' 23:59:59'
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
							AND VTYP <> 18
						ORDER BY 
							CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE  
							A.CLTCODE = FAMILY
							AND CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND VDT LIKE @@OPENBALDT + '%'
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
							AND VTYP = 18
						ORDER BY 
							CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO
					END
				ELSE
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND VDT <= @TODATE  + ' 23:59:59'
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
							AND VTYP <> 18
						ORDER BY 
							CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							VDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND VDT LIKE @@OPENBALDT + '%'
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
							AND VTYP = 18
						ORDER BY 
							CLTCODE, 
							VDT DESC, 
							VTYP, 
							VNO

					END
			END
	END
ELSE
	BEGIN
		SELECT 
			@@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MIN(EDT),0),109),11) 
		FROM 
			LEDGER
		WHERE 
			VTYP = '18' 
			AND EDT < = @OPENDATE
		IF UPPER(@REPORTTYPE) = 'PARTY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNT.DBO.LEDGER L, 
							MSAJAG.DBO.CLIENT1 C1,
							MSAJAG.DBO.CLIENT2 C2,
							MSAJAG.DBO.SUBBROKERS S,
							MSAJAG.DBO.BRANCH B
						WHERE 
							C1. CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY

									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTBSE.DBO.LEDGER L, 
							BSEDB.DBO.CLIENT1 C1,
							BSEDB.DBO.CLIENT2 C2,
							BSEDB.DBO.SUBBROKERS S,
							BSEDB.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @FO = 'Y' AND @@FODATA = 'Y'
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTFO.DBO.LEDGER L, 
							NSEFO.DBO.CLIENT1 C1,
							NSEFO.DBO.CLIENT2 C2,
							NSEFO.DBO.SUBBROKERS S,
							NSEFO.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTMCDX.DBO.LEDGER L, 
							MCDX.DBO.CLIENT1 C1,
							MCDX.DBO.CLIENT2 C2,
							MCDX.DBO.SUBBROKERS S,
							MCDX.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE


							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @NCDX = 'Y' AND @@NCDXDATA = 'Y'
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTNCDX.DBO.LEDGER L, 
							NCDX.DBO.CLIENT1 C1,
							NCDX.DBO.CLIENT2 C2,
							NCDX.DBO.SUBBROKERS S,
							NCDX.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY 
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END

				INSERT   INTO #TEMPAGEING
				SELECT 
					CLTCODE, BALDATE=@TODATE,
					CLOSBAL = SUM(CLOSBAL),
					AGEDAYS=0,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				FROM 
					#TEMPAGEING1
				GROUP BY 
					CLTCODE,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				HAVING
					ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)
				ORDER BY 
					CLTCODE
			END
		ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNT.DBO.LEDGER L,  
							MSAJAG.DBO.CLIENT1 C1, 
							MSAJAG.DBO.CLIENT2 C2,
							MSAJAG.DBO.SUBBROKERS S,
							MSAJAG.DBO.BRANCH B 
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTBSE.DBO.LEDGER L,  
							BSEDB.DBO.CLIENT1 C1, 
							BSEDB.DBO.CLIENT2 C2,
							BSEDB.DBO.SUBBROKERS S,
							BSEDB.DBO.BRANCH B  
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER 
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTFO.DBO.LEDGER L,  
							NSEFO.DBO.CLIENT1 C1, 
							NSEFO.DBO.CLIENT2 C2,
							NSEFO.DBO.SUBBROKERS S,
							NSEFO.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTMCDX.DBO.LEDGER L,  
							MCDX.DBO.CLIENT1 C1, 
							MCDX.DBO.CLIENT2 C2,
							MCDX.DBO.SUBBROKERS S,
							MCDX.DBO.BRANCH B 
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							FAMILY AS CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTNCDX.DBO.LEDGER L,  
							NCDX.DBO.CLIENT1 C1, 
							NCDX.DBO.CLIENT2 C2,
							NCDX.DBO.SUBBROKERS S,
							NCDX.DBO.BRANCH B  
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND C1.FAMILY >= @FROMPARTY 
							AND C1.FAMILY <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							FAMILY,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							FAMILY
					END

				INSERT INTO #TEMPAGEING
				SELECT 
					CLTCODE, 
					BALDATE=@TODATE,
					CLOSBAL = SUM(CLOSBAL),
					AGEDAYS=0,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				FROM 
					#TEMPAGEING1
				GROUP BY 
					CLTCODE,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				HAVING
					ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)
				ORDER BY 
					CLTCODE
			END
		ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNT.DBO.LEDGER L, 
							MSAJAG.DBO.CLIENT1 C1,
							MSAJAG.DBO.CLIENT2 C2,
							MSAJAG.DBO.SUBBROKERS S,
							MSAJAG.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTBSE.DBO.LEDGER L, 
							BSEDB.DBO.CLIENT1 C1,
							BSEDB.DBO.CLIENT2 C2,
							BSEDB.DBO.SUBBROKERS S,
							BSEDB.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE 
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTFO.DBO.LEDGER L, 
							NSEFO.DBO.CLIENT1 C1, 
							NSEFO.DBO.CLIENT2 C2,
							NSEFO.DBO.SUBBROKERS S,
							NSEFO.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTMCDX.DBO.LEDGER L, 
							MCDX.DBO.CLIENT1 C1,
							MCDX.DBO.CLIENT2 C2,
							MCDX.DBO.SUBBROKERS S,
							MCDX.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT   INTO #TEMPAGEING1
						SELECT 
							L.CLTCODE, 
							BALDATE=@TODATE,
							CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
							AGEDAYS=0,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						FROM 
							ACCOUNTNCDX.DBO.LEDGER L, 
							NCDX.DBO.CLIENT1 C1, 
							NCDX.DBO.CLIENT2 C2,
							NCDX.DBO.SUBBROKERS S,
							NCDX.DBO.BRANCH B
						WHERE 
							C1.CL_CODE = C2.CL_CODE
							AND L.CLTCODE = C2.PARTY_CODE
							AND C1.BRANCH_CD = B.BRANCH_CODE
							AND C1.SUB_BROKER = S.SUB_BROKER
							AND EDT >= @OPENDATE + ' 00:00:00' 
							AND EDT <= @TODATE + ' 23:59:59'
							AND L.CLTCODE >= @FROMPARTY 
							AND L.CLTCODE <= @TOPARTY
							AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB
							AND @STATUSNAME = 
								(CASE 
									WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
									WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
									WHEN @STATUSID = 'TRADER' THEN C1.TRADER
									WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
									WHEN @STATUSID = 'AREA' THEN C1.AREA
									WHEN @STATUSID = 'REGION' THEN C1.REGION
									WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
								ELSE 
									'BROKER'
								END)
						GROUP BY 
							L.CLTCODE,
							C1.TRADER,
							C1.SUB_BROKER,
							S.NAME,
							C1.BRANCH_CD,
							B.BRANCH
						ORDER BY 
							L.CLTCODE
					END

				INSERT   INTO #TEMPAGEING
				SELECT 
					CLTCODE, 
					BALDATE=@TODATE,
					CLOSBAL = SUM(CLOSBAL),
					AGEDAYS=0,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				FROM 
					#TEMPAGEING1
				GROUP BY 
					CLTCODE,
					TRADER,
					SUB_BROKER,
					SUB_BRNAME,
					BRANCHCODE,
					BRANCHNAME
				HAVING
					ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)
				ORDER BY 
					CLTCODE
			END

		IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNT.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNT.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTBSE.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTBSE.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTFO.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTFO.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTMCDX.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTMCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTNCDX.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTNCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)
					END
			END
		ELSE
			BEGIN
				IF @NSE = 'Y' AND @@NSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNT.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM MSAJAG.DBO.CLIENT2 C2, MSAJAG.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNT.DBO.LEDGER.CLTCODE)
					END
				IF @BSE = 'Y' AND @@BSEDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTBSE.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM BSEDB.DBO.CLIENT2 C2, BSEDB.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTBSE.DBO.LEDGER.CLTCODE)
					END
				IF @FO = 'Y' AND @@FODATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTFO.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM NSEFO.DBO.CLIENT2 C2, NSEFO.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTFO.DBO.LEDGER.CLTCODE)
					END
				IF @MCX = 'Y' AND @@MCXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTMCDX.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM MCDX.DBO.CLIENT2 C2, MCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTMCDX.DBO.LEDGER.CLTCODE)
					END
				IF @NCDX = 'Y' AND @@NCDXDATA > 0
					BEGIN
						INSERT INTO #LEDGER
						SELECT 
							VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION
						FROM 
							ACCOUNTNCDX.DBO.LEDGER 
						WHERE 
							EDT <= @TODATE  + ' 23:59:59'
							AND EXISTS (SELECT PARTY_CODE FROM NCDX.DBO.CLIENT2 C2, NCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTNCDX.DBO.LEDGER.CLTCODE)
					END
			END

		IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'
			BEGIN
				IF UPPER(RTRIM(@AGEOPTION)) = 'D'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND EDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
						ORDER BY 
							L.CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND EDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
						ORDER BY 
							L.CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO
					END
				ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND EDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
						ORDER BY 
							L.CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND EDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
						ORDER BY 
							L.CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

					END
				ELSE
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND EDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
						ORDER BY 
							L.CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							L.CLTCODE, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							#TEMPAGEING A
						WHERE 
							DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND L.CLTCODE = A.CLTCODE
							AND EDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
						ORDER BY 
							L.CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

					END
			END
		ELSE
			BEGIN
				IF UPPER(RTRIM(@AGEOPTION)) = 'D'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C,  
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND EDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
						ORDER BY 
							CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C,  
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND CLOSBAL >= 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND EDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
						ORDER BY 
							CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

					END
				ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE  
							A.CLTCODE = FAMILY
							AND CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)

							AND EDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
						ORDER BY 
							CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE  
							A.CLTCODE = FAMILY
							AND CLOSBAL < 0 
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND EDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
						ORDER BY 
							CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

					END
				ELSE
					BEGIN
						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND EDT <= @TODATE  + ' 23:59:59'
							AND VTYP <> 18
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
						ORDER BY 
							CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

						INSERT INTO #LEDGERCURSOR
						SELECT 
							CLTCODE=FAMILY, 
							VTYP, 
							VNO, 
							EDT, 
							VAMT, 
							CLOSBAL,
							A.TRADER,
							A.SUB_BROKER,
							A.SUB_BRNAME,
							A.BRANCHCODE,
							A.BRANCHNAME
						FROM 
							#LEDGER L, 
							MSAJAG.DBO.CLIENTMASTER C, 
							#TEMPAGEING A 
						WHERE 
							A.CLTCODE = FAMILY
							AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)
							AND EDT LIKE @@OPENBALDT + '%'
							AND VTYP = 18
							AND L.CLTCODE = C.PARTY_CODE 
							AND FAMILY >= @FROMPARTY 
							AND FAMILY <= @TOPARTY
						ORDER BY 
							CLTCODE, 
							EDT DESC, 
							VTYP, 
							VNO

					END
			END
	END


SET @@BALCUR = CURSOR FOR
SELECT 
	CLTCODE, 
	VTYP, 
	VNO, 
	EVDT, 
	VAMT, 
	CLOSBAL,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
FROM 
	#LEDGERCURSOR 
ORDER BY 
	CLTCODE, 
	EVDT DESC, 
	VTYP, 
	VNO

SELECT 
	CLTCODE,
	BALAMT = VAMT ,
	AGEDAYS = 0,
	DRCR,
	TRADER = SPACE(20),
	SUB_BROKER = SPACE(10),
	SUB_BRNAME = SPACE(50),
	BRANCHCODE = SPACE(10),
	BRANCHNAME = SPACE(100)
INTO 
	#FINTEMPAGEING 
FROM 
	#LEDGER 
WHERE 
	1= 2



OPEN @@BALCUR
FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL, @@TRADER, @@SUB_BROKER, @@SUB_BRNAME, @@BRANCHCD, @@BRANCHNAME

WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT @@OCLTCODE = @@CLTCODE
		SELECT @@BALAMT = ABS(@@CLOSBAL)
		IF @@CLOSBAL >= 0
			BEGIN
				SELECT @@DRCR = 'D'
			END
		ELSE
			BEGIN
				SELECT @@DRCR = 'C'
			END
		WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  AND @@BALAMT > 0
			BEGIN
				IF @@BALAMT >= @@VAMT
					BEGIN
						INSERT INTO #FINTEMPAGEING
						SELECT 
							@@CLTCODE, 
							@@VAMT, 
							DATEDIFF(DAY,@@EVDT,@TODATE), 
							@@DRCR,
							@@TRADER,
							@@SUB_BROKER,
							@@SUB_BRNAME,
							@@BRANCHCD,
							@@BRANCHNAME
						SELECT 
							@@BALAMT = @@BALAMT - @@VAMT
					END
				ELSE
					BEGIN
						INSERT INTO #FINTEMPAGEING
						SELECT 
							@@CLTCODE, 
							@@BALAMT, 
							DATEDIFF(DAY,@@EVDT,@TODATE), 
							@@DRCR,
							@@TRADER,
							@@SUB_BROKER,
							@@SUB_BRNAME,
							@@BRANCHCD,
							@@BRANCHNAME

						SELECT 
							@@BALAMT = @@BALAMT - @@VAMT
					END
				FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL, @@TRADER, @@SUB_BROKER, @@SUB_BRNAME, @@BRANCHCD, @@BRANCHNAME
			END
		IF @@BALAMT > 0
			BEGIN
				INSERT INTO #FINTEMPAGEING
				SELECT 
					@@OCLTCODE, 
					@@BALAMT, 
					@DAYS5, 
					@@DRCR,
					@@TRADER,
					@@SUB_BROKER,
					@@SUB_BRNAME,
					@@BRANCHCD,
					@@BRANCHNAME
				SELECT 
					@@BALAMT = @@BALAMT - @@VAMT
			END
		WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE
			BEGIN
				FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL, @@TRADER, @@SUB_BROKER, @@SUB_BRNAME, @@BRANCHCD, @@BRANCHNAME
			END
	END
CLOSE @@BALCUR
DEALLOCATE @@BALCUR


SELECT 
	CLTCODE = UPPER(CLTCODE), 
	BALANCE = SUM(BALAMT), 
	AGEDAYS = @DAYS1, 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
INTO 
	#AGEINGLIST
FROM 
	#FINTEMPAGEING
WHERE 
	AGEDAYS >= 0 
	AND AGEDAYS <= @DAYS1
GROUP BY 
	UPPER(CLTCODE), 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
ORDER BY 
	UPPER(CLTCODE), 
	DRCR

INSERT INTO #AGEINGLIST
SELECT 
	CLTCODE = UPPER(CLTCODE), 
	BALANCE=SUM(BALAMT), 
	AGEDAYS = @DAYS2, 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
FROM 
	#FINTEMPAGEING
WHERE 
	AGEDAYS >= (@DAYS1 + 1) 
	AND AGEDAYS <= @DAYS2
GROUP BY 
	UPPER(CLTCODE), 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
ORDER BY 
	UPPER(CLTCODE), 
	DRCR

INSERT INTO #AGEINGLIST
SELECT 
	CLTCODE = UPPER(CLTCODE),
	BALANCE=SUM(BALAMT), 
	AGEDAYS = @DAYS3, 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
FROM 
	#FINTEMPAGEING
WHERE 
	AGEDAYS >= (@DAYS2 + 1) 
	AND AGEDAYS <= @DAYS3
GROUP BY 
	UPPER(CLTCODE), 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
ORDER BY 
	UPPER(CLTCODE), 
	DRCR

INSERT INTO #AGEINGLIST
SELECT 
	CLTCODE = UPPER(CLTCODE), 
	BALANCE=SUM(BALAMT), 
	AGEDAYS = @DAYS4, 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
FROM 
	#FINTEMPAGEING
WHERE 
	AGEDAYS >= (@DAYS3 + 1) 
	AND AGEDAYS <= @DAYS4
GROUP BY 
	UPPER(CLTCODE), 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
ORDER BY 
	UPPER(CLTCODE), 
	DRCR


INSERT INTO #AGEINGLIST
SELECT 
	CLTCODE = UPPER(CLTCODE), 
	BALANCE=SUM(BALAMT), 
	AGEDAYS = @DAYS5, 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
FROM 
	#FINTEMPAGEING
WHERE 
	AGEDAYS >= @DAYS5
GROUP BY 
	UPPER(CLTCODE), 
	DRCR,
	TRADER,
	SUB_BROKER,
	SUB_BRNAME,
	BRANCHCODE,
	BRANCHNAME
ORDER BY 
	UPPER(CLTCODE), 
	DRCR


IF @BULK = 'N'
	BEGIN
		SELECT CLTCODE = RTRIM(LTRIM(A1.CLTCODE)) + '[' + RTRIM(LTRIM(A1.TRADER)) + ']', SHORT_NAME = A2.SHORT_NAME, BALANCE, AGEDAYS, DRCR, BRANCH_CD = A1.BRANCHCODE, A1.SUB_BROKER, BRANCH = A1.BRANCHNAME, NAME = SUB_BRNAME
		FROM #AGEINGLIST A1, MSAJAG.DBO.CLIENTMASTER A2--ACCOUNT.DBO.ACMAST  A2
		WHERE /*ABS(BALANCE) >= ABS(@AMOUTGTTHAN) AND*/
		A1.CLTCODE = A2.PARTY_CODE  ORDER BY A1.BRANCHCODE, A1.SUB_BROKER, A1.CLTCODE,A2.SHORT_NAME
	END
ELSE IF @BULK = 'Y'
	BEGIN
		DECLARE @@FFNAME AS VARCHAR(200), @@FINALNAME AS VARCHAR(200)
		SELECT @@FFNAME = 'AGE_' + REPLACE(REPLACE(SUBSTRING(CONVERT(VARCHAR(30), GETDATE(), 121), CHARINDEX(' ', CONVERT(VARCHAR(30), GETDATE(), 121)) + 1, LEN(CONVERT(VARCHAR(30), GETDATE(), 121))), ':', '_'), '.', '')
		SELECT @@FINALNAME = @@FFNAME + '_F'
		SELECT @@FNAME = 'C:\BACKOFFICE\' + @@FFNAME + '.CSV'
		DELETE FROM TEMP_AGEING_BULK WHERE PROCID = @@SPID
		INSERT INTO TEMP_AGEING_BULK (CLTCODE, SHORT_NAME, BALANCE, AGEDAYS, DRCR, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, PROCID)
		SELECT A1.CLTCODE, SHORT_NAME = A2.SHORT_NAME, BALANCE = (CASE WHEN DRCR = 'D' THEN -BALANCE ELSE BALANCE END), AGEDAYS, DRCR, A1.TRADER, A1.SUB_BROKER, A1.SUB_BRNAME, BRANCH_CD = A1.BRANCHCODE, BRANCH = A1.BRANCHNAME, @@SPID
		FROM #AGEINGLIST A1, MSAJAG.DBO.CLIENTMASTER A2
		WHERE A1.CLTCODE = A2.PARTY_CODE
		ORDER BY A1.BRANCHCODE, A1.SUB_BROKER, A1.CLTCODE,A2.SHORT_NAME

		SELECT @@SQL = "CREATE TABLE " + @@FFNAME + " "

		SELECT @@SQL = @@SQL + "	("
		SELECT @@SQL = @@SQL + "		CLTCODE VARCHAR(10),"
		SELECT @@SQL = @@SQL + "		SHORT_NAME VARCHAR(100),"
		SELECT @@SQL = @@SQL + "		TRADER VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		SUB_BROKER VARCHAR(10),"
		SELECT @@SQL = @@SQL + "		SUB_BRNAME VARCHAR(50),"
		SELECT @@SQL = @@SQL + "		BRANCHCODE VARCHAR(10),"
		SELECT @@SQL = @@SQL + "		BRANCHNAME VARCHAR(100),"
		SELECT @@SQL = @@SQL + "		BALANCE MONEY DEFAULT(0) NULL,"
		SELECT @@SQL = @@SQL + "		[0-" + CONVERT(VARCHAR, @DAYS1) + "] MONEY NULL,"
		SELECT @@SQL = @@SQL + "		[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] MONEY NULL,"
		SELECT @@SQL = @@SQL + "		[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] MONEY NULL,"
		SELECT @@SQL = @@SQL + "		[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] MONEY NULL,"
		SELECT @@SQL = @@SQL + "		[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] MONEY NULL"
		SELECT @@SQL = @@SQL + "	)"
		EXEC (@@SQL)

		SELECT @@SQL = "CREATE TABLE " + @@FINALNAME + " "
		SELECT @@SQL = @@SQL + "	("
		SELECT @@SQL = @@SQL + "		CLTCODE VARCHAR(10),"
		SELECT @@SQL = @@SQL + "		SHORT_NAME VARCHAR(100),"
		SELECT @@SQL = @@SQL + "		TRADER VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		SUB_BROKER VARCHAR(10),"
		SELECT @@SQL = @@SQL + "		SUB_BRNAME VARCHAR(50),"
		SELECT @@SQL = @@SQL + "		BRANCHCODE VARCHAR(10),"
		SELECT @@SQL = @@SQL + "		BRANCHNAME VARCHAR(100),"
		SELECT @@SQL = @@SQL + "		BALANCE VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		[0-" + CONVERT(VARCHAR, @DAYS1) + "] VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] VARCHAR(20),"
		SELECT @@SQL = @@SQL + "		[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] VARCHAR(20), "
		SELECT @@SQL = @@SQL + "		SNO INT IDENTITY (1,1) "
		SELECT @@SQL = @@SQL + "	)"

		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "
		SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, BALANCE, 0, 0, 0, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS1) + " "
		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "
		SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, BALANCE, 0, 0, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS2) + " "
		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "
		SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, 0, BALANCE, 0, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS3) + " "

		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "
		SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, 0, 0, BALANCE, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS4) + " "
		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "
		SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, 0, 0, 0, BALANCE FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS5) + " "
		EXEC (@@SQL)

		SELECT @@SQL = "UPDATE " + @@FFNAME + " SET BALANCE = [0-" + CONVERT(VARCHAR, @DAYS1) + "] + [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] + [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] + [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] + [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] "
		EXEC (@@SQL)


		SELECT @@SQL = "INSERT INTO " + @@FINALNAME + " "
		SELECT @@SQL = @@SQL + " VALUES "
		SELECT @@SQL = @@SQL + "('PARTY NAME', 'PARTY NAME', 'TRADER', 'SUB BROKER', 'SUB BROKER NAME', 'BRANCH CD', 'BRANCH NAME', 'BALANCE', '0 To " + CONVERT(VARCHAR, @DAYS1) + "', '" + CONVERT(VARCHAR, @DAYS1 + 1) + " To " + CONVERT(VARCHAR, @DAYS2) + "', '" + CONVERT(VARCHAR, @DAYS2 + 1) + " To " + CONVERT(VARCHAR, @DAYS3) + "', '" + CONVERT(VARCHAR, @DAYS3 + 1) + " To " + CONVERT(VARCHAR, @DAYS4) + "', 'MORE THAN " + CONVERT(VARCHAR, @DAYS4) + "') "

		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FINALNAME + " "
		SELECT @@SQL = @@SQL + "SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE = CONVERT(VARCHAR(20), SUM(BALANCE)), "
		SELECT @@SQL = @@SQL + "[0-" + CONVERT(VARCHAR, @DAYS1) + "] = CONVERT(VARCHAR(20), SUM([0-" + CONVERT(VARCHAR, @DAYS1) + "])), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "])), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "])), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "])), "
		SELECT @@SQL = @@SQL + "[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] = CONVERT(VARCHAR(20), SUM([MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "])) "
		SELECT @@SQL = @@SQL + "FROM " + @@FFNAME + " "
		SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME ORDER BY CLTCODE, SHORT_NAME "
		EXEC (@@SQL)

		SELECT @@SQL = "INSERT INTO " + @@FINALNAME + " "
		SELECT @@SQL = @@SQL + "SELECT CLTCODE = 'T O T A L', SHORT_NAME = 'T O T A L ', TRADER = 'T O T A L ', SUB_BROKER = 'T O T A L ', SUB_BRNAME = 'T O T A L ', BRANCHCODE = 'T O T A L ', BRANCHNAME = 'T O T A L ', BALANCE = CONVERT(VARCHAR(20), SUM(BALANCE)), "
		SELECT @@SQL = @@SQL + "[0-" + CONVERT(VARCHAR, @DAYS1) + "] = CONVERT(VARCHAR(20), SUM([0-" + CONVERT(VARCHAR, @DAYS1) + "])), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "])), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "])), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "])), "
		SELECT @@SQL = @@SQL + "[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] = CONVERT(VARCHAR(20), SUM([MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "])) "
		SELECT @@SQL = @@SQL + "FROM " + @@FFNAME + " "
		EXEC (@@SQL)

		SELECT @@SQL = "SELECT CLTCODE, SHORT_NAME, TRADER, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, "
		SELECT @@SQL = @@SQL + "[0-" + CONVERT(VARCHAR, @DAYS1) + "] = CONVERT(VARCHAR, [0-" + CONVERT(VARCHAR, @DAYS1) + "]), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] = CONVERT(VARCHAR, [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "]), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] = CONVERT(VARCHAR, [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "]), "
		SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] = CONVERT(VARCHAR, [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "]), "
		SELECT @@SQL = @@SQL + "[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] = CONVERT(VARCHAR, [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "]) "
		SELECT @@SQL = @@SQL + "FROM " + @@DBNAME + ".DBO." + @@FINALNAME + " ORDER BY SNO"
--		SELECT @@SQL = "DECLARE @@ERR AS INT EXEC @@ERR = MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + @@SQL + " " + CHAR(34) + " queryout " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + "', no_output SELECT @@ERR, '" + @@FNAME + "'"
		CREATE TABLE #RESULTS
			(
				ERR INT,
				FNAME VARCHAR(200)
			)
		SELECT @@SQL = "DECLARE @@ERR AS INT EXEC @@ERR = MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + @@SQL + " " + CHAR(34) + " queryout " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -U " + CHAR(34) + "sa" + CHAR(34) + " -P " + CHAR(34) + "jmmsrs" + CHAR(34) + "', no_output INSERT INTO #RESULTS (ERR, FNAME) VALUES (@@ERR, '" + @@FNAME + "')"
		EXEC (@@SQL)
--		PRINT (@@SQL)
		DECLARE @@ERR AS INT
		SELECT @@ERR = ERR FROM #RESULTS
--		PRINT @@FFNAME
		IF @@ERR = 0
			BEGIN
				CREATE TABLE #OUTPUT
					(
						CONTENTS VARCHAR(2000)
					)
				SELECT @@SQL = "BULK INSERT #OUTPUT FROM '" + @@FNAME + "' WITH (FIELDTERMINATOR = '')"
				EXEC (@@SQL)
				ALTER TABLE #OUTPUT ADD SNO INT IDENTITY(1,1)
				DELETE FROM FILE_OUTPUT WHERE PROCID = @@SPID AND CSVFILE = @@FNAME
				SELECT @@SQL = "INSERT INTO FILE_OUTPUT (PROCID,CSVFILE,CONTENTS) SELECT " + CONVERT(VARCHAR, @@SPID) + ", "
				SELECT @@SQL = @@SQL + "'" + @@FNAME + "', CONTENTS FROM #OUTPUT ORDER BY SNO "
				EXEC (@@SQL)
				SELECT ERR = 0, PROCID = @@SPID, CSVNAME = @@FNAME
				SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'DEL " + @@FNAME + "', NO_OUTPUT"
				EXEC (@@SQL)
				DROP TABLE #OUTPUT
			END
		ELSE
			BEGIN
				SELECT ERR = 1, MSG = 'COULD NOT SAVE THE FILE DUE TO SOME UNKNOWN ERROR'
			END
	END


SELECT @@SQL = "DROP TABLE " + @@FFNAME + " DROP TABLE " + @@FINALNAME + " DELETE FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " DROP TABLE #RESULTS"
EXEC (@@SQL)

DROP TABLE #TEMPAGEING
DROP TABLE #LEDGER
DROP TABLE #LEDGERCURSOR
DROP TABLE #AGEINGLIST
DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V3_AGEINGCURSOR_NEW11_BULK_11
-- --------------------------------------------------
CREATE  PROCEDURE V3_AGEINGCURSOR_NEW11_BULK_11
/*  
EXEC V3_AGEINGCURSOR_NEW11_BULK '0', 'z', 'Apr  1 2006', 'Jun 15 2006','party','',0, 'A','vdt','SUBBROKER','AGHRSUB',6,29,90,180,181,'A', 'O', 'N', 'Y', 'Y', 'Y', 'Y', 'Y'  
exec V3_AGEINGCURSOR_NEW11_BULK '0', 'Z', 'Apr 1 2006', 'Jun 19 2006','party','',0, 'A','vdt','broker','broker', 6, 29, 90, 180, 181, '0', 'ZZZZ', 'Y'  
exec V3_AGEINGCURSOR_NEW11_BULK '0', 'z', 'Apr 1 2006', 'Jun 19 2006','party','',0, 'A','vdt','broker','broker', 6, 29, 90, 180, 181, '0', 'ZZZZ', 'N'  
SELECT * FROM FILE_OUTPUT  
SELECT CLTCODE = 'T O T A L', SHORT_NAME = '', BALANCE = CONVERT(VARCHAR(20), SUM(BALANCE)), [0-6] = CONVERT(VARCHAR(20), SUM([0-6])), [7-29] = CONVERT(VARCHAR(20), SUM([7-29])), [30-90] = CONVERT(VARCHAR(20), SUM([30-90])), [91-180] = CONVERT(VARCHAR(20)
, SUM([91-180])), [MORE THAN 181] = CONVERT(VARCHAR(20), SUM([MORE THAN 181])) FROM AGE_16_28_58270   
*/  
 @FROMPARTY VARCHAR(10),  
 @TOPARTY VARCHAR(10),  
 @OPENDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @REPORTTYPE VARCHAR(15),  
 @FAMILY VARCHAR(10),  
 @AMOUTGTTHAN MONEY,  
 @AGEOPTION VARCHAR(1),  
 @DTTYPE VARCHAR(3),  
 @STATUSID VARCHAR(10),  
 @STATUSNAME VARCHAR(25),  
 @DAYS1 INT,  
 @DAYS2 INT,  
 @DAYS3 INT,  
 @DAYS4 INT,  
 @DAYS5 INT,  
 @FRSB VARCHAR(10) = '0',  
 @TOSB VARCHAR(10) = 'ZZZZZZZZZZ',  
 @BULK VARCHAR(1) = 'N',  
 @NSE VARCHAR(1) = 'Y',  
 @BSE VARCHAR(1) = 'Y',  
 @FO VARCHAR(1) = 'Y',  
 @MCX VARCHAR(1) = 'Y',  
 @NCDX VARCHAR(1) = 'Y'  
  
AS  
  
DECLARE  
 @@BALCUR AS CURSOR,  
 @@BALDATE AS VARCHAR(11),  
 @@OPENBALDT AS VARCHAR(11),  
 @@BALAMT AS MONEY,  
 @@OCLTCODE AS VARCHAR(10),  
 @@VTYP AS SMALLINT,  
 @@VNO VARCHAR(12),  
 @@EVDT AS DATETIME,  
 @@VAMT AS MONEY,  
 @@CLOSBAL AS MONEY,  
 @@CLTCODE AS VARCHAR(10),  
 @@BRANCHCODE AS VARCHAR(25),  
 @@SUB_BROKER AS VARCHAR(10),  
 @@SUB_BRNAME AS VARCHAR(50),  
 @@BRANCHCD AS VARCHAR(10),  
 @@BRANCHNAME AS VARCHAR(100),  
 @@AREA AS VARCHAR(25),  
 @@DRCR    AS VARCHAR(1),  
 @@STARTDT AS DATETIME,  
 @@FNAME AS VARCHAR(200),  
 @@SQL AS VARCHAR(2000),  
 @@NSEDATA TINYINT,  
 @@BSEDATA TINYINT,  
 @@FODATA TINYINT,  
 @@MCXDATA TINYINT,  
 @@NCDXDATA TINYINT  
  
SELECT @@NSEDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNT'  
SELECT @@BSEDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTBSE'  
SELECT @@FODATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTFO'  
SELECT @@MCXDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTMCDX'  
SELECT @@NCDXDATA = COUNT(1) FROM MASTER.DBO.SYSDATABASES WHERE NAME = 'ACCOUNTNCDX'  
  
SET NOCOUNT ON  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
SELECT   
 @@STARTDT = (SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@TODATE)),109),11) )  
  
SELECT   
 CLTCODE,  
 BALDATE = VDT,  
 CLOSBAL = VAMT,  
 AGEDAYS=0,  
 SUB_BROKER = SPACE(10),  
 SUB_BRNAME = SPACE(50),  
 BRANCHCODE = SPACE(10),  
 BRANCHNAME = SPACE(100)  
INTO  
 #TEMPAGEING  
FROM  
 LEDGER  
WHERE  
 1=2  
  
SELECT  
 CLTCODE,  
 BALDATE = VDT,  
 CLOSBAL = VAMT,  
 AGEDAYS=0,  
 SUB_BROKER = SPACE(10),  
 SUB_BRNAME = SPACE(50),  
 BRANCHCODE = SPACE(10),  
 BRANCHNAME = SPACE(100)  
INTO  
 #TEMPAGEING1  
FROM  
 LEDGER  
WHERE  
 1=2  
  
SELECT  
 VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
INTO  
 #LEDGER  
FROM  
 LEDGER  
WHERE  
 1=2  
  
SELECT  
 CLTCODE,  
 VTYP,  
 VNO,  
 EVDT = EDT,  
 VAMT,  
 CLOSBAL = VAMT,  
 SUB_BROKER = SPACE(10),  
 SUB_BRNAME = SPACE(50),  
 BRANCHCODE = SPACE(10),  
 BRANCHNAME = SPACE(100)  
INTO  
 #LEDGERCURSOR  
FROM  
 LEDGER  
WHERE  
 1=2  
  
IF @DTTYPE='VDT'  
 BEGIN  
  SELECT  
   @@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MIN(VDT),0),109),11)  
  FROM  
   LEDGER  
  WHERE  
   VTYP = '18'  
   AND VDT <= @OPENDATE  
  IF UPPER(@REPORTTYPE) = 'PARTY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT INTO #TEMPAGEING1  
      SELECT  
       L.CLTCODE,  
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM  
       ACCOUNT.DBO.LEDGER L,  
       MSAJAG.DBO.CLIENT1 C1,  
       MSAJAG.DBO.CLIENT2 C2,  
       MSAJAG.DBO.SUBBROKERS S,  
       MSAJAG.DBO.BRANCH B  
      WHERE  
       L.CLTCODE = C2.PARTY_CODE  
       AND C1.CL_CODE = C2.CL_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND VDT >= @OPENDATE + ' 00:00:00'  
       AND VDT <= @TODATE + ' 23:59'  
       AND L.CLTCODE >= @FROMPARTY  
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT  
       L.CLTCODE,  
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM  
       ACCOUNTBSE.DBO.LEDGER L,  
       BSEDB.DBO.CLIENT1 C1,  
       BSEDB.DBO.CLIENT2 C2,  
       BSEDB.DBO.SUBBROKERS S,  
       BSEDB.DBO.BRANCH B  
      WHERE  
       L.CLTCODE = C2.PARTY_CODE  
       AND C1.CL_CODE = C2.CL_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND VDT >= @OPENDATE + ' 00:00:00'  
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY  
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY  
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY  
       L.CLTCODE  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM  
       ACCOUNTFO.DBO.LEDGER L,  
       NSEFO.DBO.CLIENT1 C1,  
       NSEFO.DBO.CLIENT2 C2,  
       NSEFO.DBO.SUBBROKERS S,  
       NSEFO.DBO.BRANCH B  
      WHERE   
       L.CLTCODE = C2.PARTY_CODE  
       AND C1.CL_CODE = C2.CL_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND VDT >= @OPENDATE + ' 00:00:00'  
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM  
       ACCOUNTMCDX.DBO.LEDGER L,  
       MCDX.DBO.CLIENT1 C1,  
       MCDX.DBO.CLIENT2 C2,  
       MCDX.DBO.SUBBROKERS S,  
       MCDX.DBO.BRANCH B  
      WHERE   
       L.CLTCODE = C2.PARTY_CODE  
       AND C1.CL_CODE = C2.CL_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND VDT >= @OPENDATE + ' 00:00:00'  
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM  
       ACCOUNTNCDX.DBO.LEDGER L,  
       NCDX.DBO.CLIENT1 C1,  
       NCDX.DBO.CLIENT2 C2,  
       NCDX.DBO.SUBBROKERS S,  
       NCDX.DBO.BRANCH B  
      WHERE   
       L.CLTCODE = C2.PARTY_CODE  
       AND C1.CL_CODE = C2.CL_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND VDT >= @OPENDATE + ' 00:00:00'  
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
  
    INSERT INTO #TEMPAGEING  
    SELECT   
     CLTCODE,   
     BALDATE=@TODATE,  
     CLOSBAL = SUM(CLOSBAL),  
     AGEDAYS=0,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    FROM  
     #TEMPAGEING1  
    GROUP BY  
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    HAVING  
     ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)  
    ORDER BY   
     CLTCODE  
   END  
  ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,  
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNT.DBO.LEDGER L,    
       MSAJAG.DBO.CLIENT1 C1,   
       MSAJAG.DBO.CLIENT2 C2,  
       MSAJAG.DBO.SUBBROKERS S,  
       MSAJAG.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTBSE.DBO.LEDGER L,  
       BSEDB.DBO.CLIENT1 C1,   
       BSEDB.DBO.CLIENT2 C2,  
       BSEDB.DBO.SUBBROKERS S,  
       BSEDB.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTFO.DBO.LEDGER L,    
       NSEFO.DBO.CLIENT1 C1,   
       NSEFO.DBO.CLIENT2 C2,  
       NSEFO.DBO.SUBBROKERS S,  
       NSEFO.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER L,  
       MCDX.DBO.CLIENT1 C1,   
       MCDX.DBO.CLIENT2 C2,  
       MCDX.DBO.SUBBROKERS S,  
       MCDX.DBO.BRANCH B   
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER   
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER L,    
       NCDX.DBO.CLIENT1 C1,   
       NCDX.DBO.CLIENT2 C2,  
       NCDX.DBO.SUBBROKERS S,  
       NCDX.DBO.BRANCH B    
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
  
    INSERT   INTO #TEMPAGEING  
    SELECT   
     CLTCODE,   
     BALDATE=@TODATE,  
     CLOSBAL = SUM(CLOSBAL),  
     AGEDAYS=0,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    FROM   
     #TEMPAGEING1  
    GROUP BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    HAVING  
     ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)  
    ORDER BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
   END  
  ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNT.DBO.LEDGER L,   
       MSAJAG.DBO.CLIENT1 C1,   
       MSAJAG.DBO.CLIENT2 C2,  
       MSAJAG.DBO.SUBBROKERS S,  
       MSAJAG.DBO.BRANCH B    
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER   
       AND C1.FAMILY = @FAMILY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTBSE.DBO.LEDGER L,   
       BSEDB.DBO.CLIENT1 C1,   
       BSEDB.DBO.CLIENT2 C2,  
       BSEDB.DBO.SUBBROKERS S,  
       BSEDB.DBO.BRANCH B     
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER   
       AND C1.FAMILY = @FAMILY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTFO.DBO.LEDGER L,   
       NSEFO.DBO.CLIENT1 C1,   
       NSEFO.DBO.CLIENT2 C2,  
       NSEFO.DBO.SUBBROKERS S,  
       NSEFO.DBO.BRANCH B    
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER   
       AND C1.FAMILY = @FAMILY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER L,   
       MCDX.DBO.CLIENT1 C1,   
       MCDX.DBO.CLIENT2 C2,  
       MCDX.DBO.SUBBROKERS S,  
       MCDX.DBO.BRANCH B   
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER    
       AND C1.FAMILY = @FAMILY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       SUB_BROKER = C1.SUB_BROKER,  
       SUB_BRNAME = S.NAME,  
       BRANCHCODE = C1.BRANCH_CD,  
       BRANCHNAME = B.BRANCH  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER L,   
       NCDX.DBO.CLIENT1 C1,   
       NCDX.DBO.CLIENT2 C2,  
       NCDX.DBO.SUBBROKERS S,  
       NCDX.DBO.BRANCH B    
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND VDT >= @OPENDATE + ' 00:00:00'   
       AND VDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER     
       AND C1.FAMILY = @FAMILY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
  
    INSERT   INTO #TEMPAGEING  
    SELECT   
     CLTCODE,   
     BALDATE=@TODATE,  
     CLOSBAL = SUM(CLOSBAL),  
     AGEDAYS=0,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    FROM   
     #TEMPAGEING1  
    GROUP BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    HAVING  
     ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)  
    ORDER BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
   END  
  IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNT.DBO.LEDGER   
      WHERE VDT <= @TODATE  + ' 23:59:59'  
      AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNT.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT  
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTBSE.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTBSE.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTFO.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTFO.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT  
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTMCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTNCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
   END  
  ELSE  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNT.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM MSAJAG.DBO.CLIENT2 C2, MSAJAG.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNT.DBO.LEDGER.CLTCODE)  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTBSE.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM BSEDB.DBO.CLIENT2 C2, BSEDB.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTBSE.DBO.LEDGER.CLTCODE)  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTFO.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM NSEFO.DBO.CLIENT2 C2, NSEFO.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTFO.DBO.LEDGER.CLTCODE)  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTMCX.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM MCDX.DBO.CLIENT2 C2, MCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTMCDX.DBO.LEDGER.CLTCODE)  
     END  
  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER   
      WHERE   
       VDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM NCDX.DBO.CLIENT2 C2, NCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTNCDX.DBO.LEDGER.CLTCODE)  
     END  
  
   END  
  IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
   BEGIN  
    IF UPPER(RTRIM(@AGEOPTION)) = 'D'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       SUB_BROKER,  
       SUB_BRNAME,  
       BRANCHCODE,  
       BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND VDT <= @TODATE  + ' 23:59'  
       AND VTYP <> 18  
      ORDER BY   
       L.CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       SUB_BROKER,  
       SUB_BRNAME,  
       BRANCHCODE,  
       BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND VDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
      ORDER BY   
       L.CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
     END  
    ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       SUB_BROKER,  
       SUB_BRNAME,  
       BRANCHCODE,  
       BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND VDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
      ORDER BY   
       L.CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       SUB_BROKER,  
       SUB_BRNAME,  
       BRANCHCODE,  
       BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND VDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
      ORDER BY   
       L.CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
     END  
    ELSE  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       SUB_BROKER,  
       SUB_BRNAME,  
       BRANCHCODE,  
       BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND VDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
      ORDER BY   
       L.CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       SUB_BROKER,  
       SUB_BRNAME,  
       BRANCHCODE,  
       BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND VDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
      ORDER BY   
       L.CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
     END  
   END  
  ELSE  
   BEGIN  
    IF UPPER(RTRIM(@AGEOPTION)) = 'D'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,    
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND VDT <= @TODATE  + ' 23:59:59'  
       AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY  
       AND VTYP <> '18'  
      ORDER BY CLTCODE, VDT DESC, VTYP, VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,    
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND VDT LIKE @@OPENBALDT + '%'  
       AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY  
       AND VTYP = '18'  
      ORDER BY CLTCODE, VDT DESC, VTYP, VNO  
  
  
     END  
    ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE    
       A.CLTCODE = FAMILY  
       AND CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND VDT <= @TODATE  + ' 23:59:59'  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
       AND VTYP <> 18  
      ORDER BY   
       CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE    
       A.CLTCODE = FAMILY  
       AND CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND VDT LIKE @@OPENBALDT + '%'  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
       AND VTYP = 18  
      ORDER BY   
       CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
     END  
    ELSE  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND VDT <= @TODATE  + ' 23:59:59'  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
       AND VTYP <> 18  
      ORDER BY   
       CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       VDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND VDT LIKE @@OPENBALDT + '%'  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
       AND VTYP = 18  
      ORDER BY   
       CLTCODE,   
       VDT DESC,   
       VTYP,   
       VNO  
  
     END  
   END  
 END  
ELSE  
 BEGIN  
  SELECT   
   @@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MIN(EDT),0),109),11)   
  FROM   
   LEDGER  
  WHERE   
   VTYP = '18'   
   AND EDT < = @OPENDATE  
  IF UPPER(@REPORTTYPE) = 'PARTY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNT.DBO.LEDGER L,   
       MSAJAG.DBO.CLIENT1 C1,  
       MSAJAG.DBO.CLIENT2 C2,  
       MSAJAG.DBO.SUBBROKERS S,  
       MSAJAG.DBO.BRANCH B  
      WHERE   
       C1. CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTBSE.DBO.LEDGER L,   
       BSEDB.DBO.CLIENT1 C1,  
       BSEDB.DBO.CLIENT2 C2,  
       BSEDB.DBO.SUBBROKERS S,  
       BSEDB.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @FO = 'Y' AND @@FODATA = 'Y'  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTFO.DBO.LEDGER L,   
       NSEFO.DBO.CLIENT1 C1,  
       NSEFO.DBO.CLIENT2 C2,  
       NSEFO.DBO.SUBBROKERS S,  
       NSEFO.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER L,   
       MCDX.DBO.CLIENT1 C1,  
       MCDX.DBO.CLIENT2 C2,  
       MCDX.DBO.SUBBROKERS S,  
       MCDX.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA = 'Y'  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER L,   
       NCDX.DBO.CLIENT1 C1,  
       NCDX.DBO.CLIENT2 C2,  
       NCDX.DBO.SUBBROKERS S,  
       NCDX.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY   
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
  
    INSERT   INTO #TEMPAGEING  
    SELECT   
     CLTCODE, BALDATE=@TODATE,  
     CLOSBAL = SUM(CLOSBAL),  
     AGEDAYS=0,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    FROM   
     #TEMPAGEING1  
    GROUP BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    HAVING  
     ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)  
    ORDER BY   
     CLTCODE  
   END  
  ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNT.DBO.LEDGER L,    
       MSAJAG.DBO.CLIENT1 C1,   
       MSAJAG.DBO.CLIENT2 C2,  
       MSAJAG.DBO.SUBBROKERS S,  
       MSAJAG.DBO.BRANCH B   
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTBSE.DBO.LEDGER L,    
       BSEDB.DBO.CLIENT1 C1,   
       BSEDB.DBO.CLIENT2 C2,  
       BSEDB.DBO.SUBBROKERS S,  
       BSEDB.DBO.BRANCH B    
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER   
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTFO.DBO.LEDGER L,    
       NSEFO.DBO.CLIENT1 C1,   
       NSEFO.DBO.CLIENT2 C2,  
       NSEFO.DBO.SUBBROKERS S,  
       NSEFO.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER L,    
       MCDX.DBO.CLIENT1 C1,   
       MCDX.DBO.CLIENT2 C2,  
       MCDX.DBO.SUBBROKERS S,  
       MCDX.DBO.BRANCH B   
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       FAMILY AS CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER L,    
       NCDX.DBO.CLIENT1 C1,   
       NCDX.DBO.CLIENT2 C2,  
       NCDX.DBO.SUBBROKERS S,  
       NCDX.DBO.BRANCH B    
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND C1.FAMILY >= @FROMPARTY   
       AND C1.FAMILY <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       FAMILY,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       FAMILY  
     END  
  
    INSERT INTO #TEMPAGEING  
    SELECT   
     CLTCODE,   
     BALDATE=@TODATE,  
     CLOSBAL = SUM(CLOSBAL),  
     AGEDAYS=0,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    FROM   
     #TEMPAGEING1  
    GROUP BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    HAVING  
     ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)  
    ORDER BY   
     CLTCODE  
   END  
  ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNT.DBO.LEDGER L,   
       MSAJAG.DBO.CLIENT1 C1,  
       MSAJAG.DBO.CLIENT2 C2,  
       MSAJAG.DBO.SUBBROKERS S,  
       MSAJAG.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTBSE.DBO.LEDGER L,   
       BSEDB.DBO.CLIENT1 C1,  
       BSEDB.DBO.CLIENT2 C2,  
       BSEDB.DBO.SUBBROKERS S,  
       BSEDB.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE   
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTFO.DBO.LEDGER L,   
       NSEFO.DBO.CLIENT1 C1,   
       NSEFO.DBO.CLIENT2 C2,  
       NSEFO.DBO.SUBBROKERS S,  
       NSEFO.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER L,   
       MCDX.DBO.CLIENT1 C1,  
       MCDX.DBO.CLIENT2 C2,  
       MCDX.DBO.SUBBROKERS S,  
       MCDX.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT   INTO #TEMPAGEING1  
      SELECT   
       L.CLTCODE,   
       BALDATE=@TODATE,  
       CLOSBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),  
       AGEDAYS=0,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER L,   
       NCDX.DBO.CLIENT1 C1,   
       NCDX.DBO.CLIENT2 C2,  
       NCDX.DBO.SUBBROKERS S,  
       NCDX.DBO.BRANCH B  
      WHERE   
       C1.CL_CODE = C2.CL_CODE  
       AND L.CLTCODE = C2.PARTY_CODE  
       AND C1.BRANCH_CD = B.BRANCH_CODE  
       AND C1.SUB_BROKER = S.SUB_BROKER  
       AND EDT >= @OPENDATE + ' 00:00:00'   
       AND EDT <= @TODATE + ' 23:59:59'  
       AND L.CLTCODE >= @FROMPARTY   
       AND L.CLTCODE <= @TOPARTY  
       AND C1.SUB_BROKER BETWEEN @FRSB AND @TOSB  
       AND @STATUSNAME =   
        (CASE   
         WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
         WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
         WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
         WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
         WHEN @STATUSID = 'AREA' THEN C1.AREA  
         WHEN @STATUSID = 'REGION' THEN C1.REGION  
         WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
        ELSE   
         'BROKER'  
        END)  
      GROUP BY   
       L.CLTCODE,  
       C1.SUB_BROKER,  
       S.NAME,  
       C1.BRANCH_CD,  
       B.BRANCH  
      ORDER BY   
       L.CLTCODE  
     END  
  
    INSERT   INTO #TEMPAGEING  
    SELECT   
     CLTCODE,   
     BALDATE=@TODATE,  
     CLOSBAL = SUM(CLOSBAL),  
     AGEDAYS=0,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    FROM   
     #TEMPAGEING1  
    GROUP BY   
     CLTCODE,  
     SUB_BROKER,  
     SUB_BRNAME,  
     BRANCHCODE,  
     BRANCHNAME  
    HAVING  
     ABS(SUM(CLOSBAL)) > ABS(@AMOUTGTTHAN)  
    ORDER BY   
     CLTCODE  
   END  
  
  IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNT.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNT.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTBSE.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTBSE.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTFO.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTFO.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTMCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT DISTINCT CLTCODE FROM #TEMPAGEING WHERE ACCOUNTNCDX.DBO.LEDGER.CLTCODE = #TEMPAGEING.CLTCODE)  
     END  
   END  
  ELSE  
   BEGIN  
    IF @NSE = 'Y' AND @@NSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNT.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM MSAJAG.DBO.CLIENT2 C2, MSAJAG.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNT.DBO.LEDGER.CLTCODE)  
     END  
    IF @BSE = 'Y' AND @@BSEDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTBSE.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM BSEDB.DBO.CLIENT2 C2, BSEDB.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTBSE.DBO.LEDGER.CLTCODE)  
     END  
    IF @FO = 'Y' AND @@FODATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTFO.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM NSEFO.DBO.CLIENT2 C2, NSEFO.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTFO.DBO.LEDGER.CLTCODE)  
     END  
    IF @MCX = 'Y' AND @@MCXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTMCDX.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM MCDX.DBO.CLIENT2 C2, MCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTMCDX.DBO.LEDGER.CLTCODE)  
     END  
    IF @NCDX = 'Y' AND @@NCDXDATA > 0  
     BEGIN  
      INSERT INTO #LEDGER  
      SELECT   
       VTYP, VNO, EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION  
      FROM   
       ACCOUNTNCDX.DBO.LEDGER   
      WHERE   
       EDT <= @TODATE  + ' 23:59:59'  
       AND EXISTS (SELECT PARTY_CODE FROM NCDX.DBO.CLIENT2 C2, NCDX.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C2.PARTY_CODE = ACCOUNTNCDX.DBO.LEDGER.CLTCODE)  
     END  
   END  
  
  IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
   BEGIN  
    IF UPPER(RTRIM(@AGEOPTION)) = 'D'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND EDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
      ORDER BY   
       L.CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND EDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
      ORDER BY   
       L.CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
     END  
    ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND EDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
      ORDER BY   
       L.CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND EDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
      ORDER BY   
       L.CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
     END  
    ELSE  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND EDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
      ORDER BY   
       L.CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       L.CLTCODE,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       #TEMPAGEING A  
      WHERE   
       DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND L.CLTCODE = A.CLTCODE  
       AND EDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
      ORDER BY   
       L.CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
     END  
   END  
  ELSE  
   BEGIN  
    IF UPPER(RTRIM(@AGEOPTION)) = 'D'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,    
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND EDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
      ORDER BY   
       CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,    
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND CLOSBAL >= 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND EDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
      ORDER BY   
       CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
     END  
    ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE    
       A.CLTCODE = FAMILY  
       AND CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
  
       AND EDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
      ORDER BY   
       CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE    
       A.CLTCODE = FAMILY  
       AND CLOSBAL < 0   
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND EDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
      ORDER BY   
       CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
     END  
    ELSE  
     BEGIN  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND EDT <= @TODATE  + ' 23:59:59'  
       AND VTYP <> 18  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
      ORDER BY   
       CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
      INSERT INTO #LEDGERCURSOR  
      SELECT   
       CLTCODE=FAMILY,   
       VTYP,   
       VNO,   
       EDT,   
       VAMT,   
       CLOSBAL,  
       A.SUB_BROKER,  
       A.SUB_BRNAME,  
       A.BRANCHCODE,  
       A.BRANCHNAME  
      FROM   
       #LEDGER L,   
       MSAJAG.DBO.CLIENTMASTER C,   
       #TEMPAGEING A   
      WHERE   
       A.CLTCODE = FAMILY  
       AND DRCR = (CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END)  
       AND EDT LIKE @@OPENBALDT + '%'  
       AND VTYP = 18  
       AND L.CLTCODE = C.PARTY_CODE   
       AND FAMILY >= @FROMPARTY   
       AND FAMILY <= @TOPARTY  
      ORDER BY   
       CLTCODE,   
       EDT DESC,   
       VTYP,   
       VNO  
  
     END  
   END  
 END  
  
  
SET @@BALCUR = CURSOR FOR  
SELECT   
 CLTCODE,   
 VTYP,   
 VNO,   
 EVDT,   
 VAMT,   
 CLOSBAL,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
FROM   
 #LEDGERCURSOR   
ORDER BY   
 CLTCODE,   
 EVDT DESC,   
 VTYP,   
 VNO  
  
SELECT   
 CLTCODE,  
 BALAMT = VAMT ,  
 AGEDAYS = 0,  
 DRCR,  
 SUB_BROKER = SPACE(10),  
 SUB_BRNAME = SPACE(50),  
 BRANCHCODE = SPACE(10),  
 BRANCHNAME = SPACE(100)  
INTO   
 #FINTEMPAGEING   
FROM   
 #LEDGER   
WHERE   
 1= 2  
  
  
  
OPEN @@BALCUR  
FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL, @@SUB_BROKER, @@SUB_BRNAME, @@BRANCHCD, @@BRANCHNAME  
  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SELECT @@OCLTCODE = @@CLTCODE  
  SELECT @@BALAMT = ABS(@@CLOSBAL)  
  IF @@CLOSBAL >= 0  
   BEGIN  
    SELECT @@DRCR = 'D'  
   END  
  ELSE  
   BEGIN  
    SELECT @@DRCR = 'C'  
   END  
  WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  AND @@BALAMT > 0  
   BEGIN  
    IF @@BALAMT >= @@VAMT  
     BEGIN  
      INSERT INTO #FINTEMPAGEING  
      SELECT   
       @@CLTCODE,   
       @@VAMT,   
       DATEDIFF(DAY,@@EVDT,@TODATE),   
       @@DRCR,  
       @@SUB_BROKER,  
       @@SUB_BRNAME,  
       @@BRANCHCD,  
       @@BRANCHNAME  
      SELECT   
       @@BALAMT = @@BALAMT - @@VAMT  
     END  
    ELSE  
     BEGIN  
      INSERT INTO #FINTEMPAGEING  
      SELECT   
       @@CLTCODE,   
       @@BALAMT,   
       DATEDIFF(DAY,@@EVDT,@TODATE),   
       @@DRCR,  
       @@SUB_BROKER,  
       @@SUB_BRNAME,  
       @@BRANCHCD,  
       @@BRANCHNAME  
  
      SELECT   
       @@BALAMT = @@BALAMT - @@VAMT  
     END  
    FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL, @@SUB_BROKER, @@SUB_BRNAME, @@BRANCHCD, @@BRANCHNAME  
   END  
  IF @@BALAMT > 0  
   BEGIN  
    INSERT INTO #FINTEMPAGEING  
    SELECT   
     @@OCLTCODE,   
     @@BALAMT,   
     @DAYS5,   
     @@DRCR,  
     @@SUB_BROKER,  
     @@SUB_BRNAME,  
     @@BRANCHCD,  
     @@BRANCHNAME  
    SELECT   
     @@BALAMT = @@BALAMT - @@VAMT  
   END  
  WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  
   BEGIN  
    FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL, @@SUB_BROKER, @@SUB_BRNAME, @@BRANCHCD, @@BRANCHNAME  
   END  
 END  
CLOSE @@BALCUR  
DEALLOCATE @@BALCUR  
  
  
SELECT   
 CLTCODE = UPPER(CLTCODE),   
 BALANCE = SUM(BALAMT),   
 AGEDAYS = @DAYS1,   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
INTO   
 #AGEINGLIST  
FROM   
 #FINTEMPAGEING  
WHERE   
 AGEDAYS >= 0   
 AND AGEDAYS <= @DAYS1  
GROUP BY   
 UPPER(CLTCODE),   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
ORDER BY   
 UPPER(CLTCODE),   
 DRCR  
  
INSERT INTO #AGEINGLIST  
SELECT   
 CLTCODE = UPPER(CLTCODE),   
 BALANCE=SUM(BALAMT),   
 AGEDAYS = @DAYS2,   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
FROM   
 #FINTEMPAGEING  
WHERE   
 AGEDAYS >= (@DAYS1 + 1)   
 AND AGEDAYS <= @DAYS2  
GROUP BY   
 UPPER(CLTCODE),   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
ORDER BY   
 UPPER(CLTCODE),   
 DRCR  
  
INSERT INTO #AGEINGLIST  
SELECT   
 CLTCODE = UPPER(CLTCODE),  
 BALANCE=SUM(BALAMT),   
 AGEDAYS = @DAYS3,   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
FROM   
 #FINTEMPAGEING  
WHERE   
 AGEDAYS >= (@DAYS2 + 1)   
 AND AGEDAYS <= @DAYS3  
GROUP BY   
 UPPER(CLTCODE),   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
ORDER BY   
 UPPER(CLTCODE),   
 DRCR  
  
INSERT INTO #AGEINGLIST  
SELECT   
 CLTCODE = UPPER(CLTCODE),   
 BALANCE=SUM(BALAMT),   
 AGEDAYS = @DAYS4,   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
FROM   
 #FINTEMPAGEING  
WHERE   
 AGEDAYS >= (@DAYS3 + 1)   
 AND AGEDAYS <= @DAYS4  
GROUP BY   
 UPPER(CLTCODE),   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
ORDER BY   
 UPPER(CLTCODE),   
 DRCR  
  
  
INSERT INTO #AGEINGLIST  
SELECT   
 CLTCODE = UPPER(CLTCODE),   
 BALANCE=SUM(BALAMT),   
 AGEDAYS = @DAYS5,   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
FROM   
 #FINTEMPAGEING  
WHERE   
 AGEDAYS >= @DAYS5  
GROUP BY   
 UPPER(CLTCODE),   
 DRCR,  
 SUB_BROKER,  
 SUB_BRNAME,  
 BRANCHCODE,  
 BRANCHNAME  
ORDER BY   
 UPPER(CLTCODE),   
 DRCR  
  
  
IF @BULK = 'N'  
 BEGIN  
  SELECT A1.CLTCODE, SHORT_NAME = A2.SHORT_NAME, BALANCE, AGEDAYS, DRCR, BRANCH_CD = A1.BRANCHCODE, A1.SUB_BROKER, BRANCH = A1.BRANCHNAME, NAME = SUB_BRNAME  
  FROM #AGEINGLIST A1, MSAJAG.DBO.CLIENTMASTER A2--ACCOUNT.DBO.ACMAST  A2  
  WHERE /*ABS(BALANCE) >= ABS(@AMOUTGTTHAN) AND*/  
  A1.CLTCODE = A2.PARTY_CODE  ORDER BY A1.BRANCHCODE, A1.SUB_BROKER, A1.CLTCODE,A2.SHORT_NAME  
 END  
ELSE IF @BULK = 'Y'  
 BEGIN  
  DECLARE @@FFNAME AS VARCHAR(200), @@FINALNAME AS VARCHAR(200)  
  SELECT @@FFNAME = 'AGE_' + REPLACE(REPLACE(SUBSTRING(CONVERT(VARCHAR(30), GETDATE(), 121), CHARINDEX(' ', CONVERT(VARCHAR(30), GETDATE(), 121)) + 1, LEN(CONVERT(VARCHAR(30), GETDATE(), 121))), ':', '_'), '.', '')  
  SELECT @@FINALNAME = @@FFNAME + '_F'  
  SELECT @@FNAME = 'D:\BACKOFFICE\' + @@FFNAME + '.CSV'  
  DELETE FROM TEMP_AGEING_BULK WHERE PROCID = @@SPID  
  INSERT INTO TEMP_AGEING_BULK (CLTCODE, SHORT_NAME, BALANCE, AGEDAYS, DRCR, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, PROCID)  
  SELECT A1.CLTCODE, SHORT_NAME = A2.SHORT_NAME, BALANCE = (CASE WHEN DRCR = 'D' THEN -BALANCE ELSE BALANCE END), AGEDAYS, DRCR, A1.SUB_BROKER, A1.SUB_BRNAME, BRANCH_CD = A1.BRANCHCODE, BRANCH = A1.BRANCHNAME, @@SPID  
  FROM #AGEINGLIST A1, MSAJAG.DBO.CLIENTMASTER A2  
  WHERE A1.CLTCODE = A2.PARTY_CODE  
  ORDER BY A1.BRANCHCODE, A1.SUB_BROKER, A1.CLTCODE,A2.SHORT_NAME  
  
  SELECT @@SQL = "CREATE TABLE " + @@FFNAME + " "  
  SELECT @@SQL = @@SQL + " ("  
  SELECT @@SQL = @@SQL + "  CLTCODE VARCHAR(10),"  
  SELECT @@SQL = @@SQL + "  SHORT_NAME VARCHAR(100),"  
  SELECT @@SQL = @@SQL + "  SUB_BROKER VARCHAR(10),"  
  SELECT @@SQL = @@SQL + "  SUB_BRNAME VARCHAR(50),"  
  SELECT @@SQL = @@SQL + "  BRANCHCODE VARCHAR(10),"  
  SELECT @@SQL = @@SQL + "  BRANCHNAME VARCHAR(100),"  
  SELECT @@SQL = @@SQL + "  BALANCE MONEY DEFAULT(0) NULL,"  
  SELECT @@SQL = @@SQL + "  [0-" + CONVERT(VARCHAR, @DAYS1) + "] MONEY NULL,"  
  SELECT @@SQL = @@SQL + "  [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] MONEY NULL,"  
  SELECT @@SQL = @@SQL + "  [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] MONEY NULL,"  
  SELECT @@SQL = @@SQL + "  [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] MONEY NULL,"  
  SELECT @@SQL = @@SQL + "  [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] MONEY NULL"  
  SELECT @@SQL = @@SQL + " )"  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "CREATE TABLE " + @@FINALNAME + " "  
  SELECT @@SQL = @@SQL + " ("  
  SELECT @@SQL = @@SQL + "  CLTCODE VARCHAR(10),"  
  SELECT @@SQL = @@SQL + "  SHORT_NAME VARCHAR(100),"  
  SELECT @@SQL = @@SQL + "  SUB_BROKER VARCHAR(10),"  
  SELECT @@SQL = @@SQL + "  SUB_BRNAME VARCHAR(50),"  
  SELECT @@SQL = @@SQL + "  BRANCHCODE VARCHAR(10),"  
  SELECT @@SQL = @@SQL + "  BRANCHNAME VARCHAR(100),"  
  SELECT @@SQL = @@SQL + "  BALANCE VARCHAR(20),"  
  SELECT @@SQL = @@SQL + "  [0-" + CONVERT(VARCHAR, @DAYS1) + "] VARCHAR(20),"  
  SELECT @@SQL = @@SQL + "  [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] VARCHAR(20),"  
  SELECT @@SQL = @@SQL + "  [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] VARCHAR(20),"  
  SELECT @@SQL = @@SQL + "  [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] VARCHAR(20),"  
  SELECT @@SQL = @@SQL + "  [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] VARCHAR(20), "  
  SELECT @@SQL = @@SQL + "  SNO INT IDENTITY (1,1) "  
  SELECT @@SQL = @@SQL + " )"  
  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "  
  SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, BALANCE, 0, 0, 0, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS1) + " "  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "  
  SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, BALANCE, 0, 0, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS2) + " "  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "  
  SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, 0, BALANCE, 0, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS3) + " "  
  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "  
  SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, 0, 0, BALANCE, 0 FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS4) + " "  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FFNAME + " (CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, [0-" + CONVERT(VARCHAR, @DAYS1) + "], [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "], [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "], [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "], [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] ) "  
  SELECT @@SQL = @@SQL + " SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, 0, 0, 0, 0, 0, BALANCE FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " AND AGEDAYS = " + CONVERT(VARCHAR, @DAYS5) + " "  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "UPDATE " + @@FFNAME + " SET BALANCE = [0-" + CONVERT(VARCHAR, @DAYS1) + "] + [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] + [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] + [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] + [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] "  
  EXEC (@@SQL)  
  
  
  SELECT @@SQL = "INSERT INTO " + @@FINALNAME + " "  
  SELECT @@SQL = @@SQL + " VALUES "  
  SELECT @@SQL = @@SQL + "('PARTY NAME', 'PARTY NAME', 'SUB BROKER', 'SUB BROKER NAME', 'BRANCH CD', 'BRANCH NAME', 'BALANCE', '0 To " + CONVERT(VARCHAR, @DAYS1) + "', '" + CONVERT(VARCHAR, @DAYS1 + 1) + " To " + CONVERT(VARCHAR, @DAYS2) + "', '" + CONVERT(VARCHAR, @DAYS2 + 1) + " To " + CONVERT(VARCHAR, @DAYS3) + "', '" + CONVERT(VARCHAR, @DAYS3 + 1) + " To " + CONVERT(VARCHAR, @DAYS4) + "', 'MORE THAN " + CONVERT(VARCHAR, @DAYS4) + "') "  
  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FINALNAME + " "  
  SELECT @@SQL = @@SQL + "SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE = CONVERT(VARCHAR(20), SUM(BALANCE)), "  
  SELECT @@SQL = @@SQL + "[0-" + CONVERT(VARCHAR, @DAYS1) + "] = CONVERT(VARCHAR(20), SUM([0-" + CONVERT(VARCHAR, @DAYS1) + "])), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "])), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "])), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "])), "  
  SELECT @@SQL = @@SQL + "[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] = CONVERT(VARCHAR(20), SUM([MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "])) "  
  SELECT @@SQL = @@SQL + "FROM " + @@FFNAME + " "  
  SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME ORDER BY CLTCODE, SHORT_NAME "  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "INSERT INTO " + @@FINALNAME + " "  
  SELECT @@SQL = @@SQL + "SELECT CLTCODE = 'T O T A L', SHORT_NAME = 'T O T A L ', SUB_BROKER = 'T O T A L ', SUB_BRNAME = 'T O T A L ', BRANCHCODE = 'T O T A L ', BRANCHNAME = 'T O T A L ', BALANCE = CONVERT(VARCHAR(20), SUM(BALANCE)), "  
  SELECT @@SQL = @@SQL + "[0-" + CONVERT(VARCHAR, @DAYS1) + "] = CONVERT(VARCHAR(20), SUM([0-" + CONVERT(VARCHAR, @DAYS1) + "])), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "])), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "])), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] = CONVERT(VARCHAR(20), SUM([" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "])), "  
  SELECT @@SQL = @@SQL + "[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] = CONVERT(VARCHAR(20), SUM([MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "])) "  
  SELECT @@SQL = @@SQL + "FROM " + @@FFNAME + " "  
  EXEC (@@SQL)  
  
  SELECT @@SQL = "SELECT CLTCODE, SHORT_NAME, SUB_BROKER, SUB_BRNAME, BRANCHCODE, BRANCHNAME, BALANCE, "  
  SELECT @@SQL = @@SQL + "[0-" + CONVERT(VARCHAR, @DAYS1) + "] = CONVERT(VARCHAR, [0-" + CONVERT(VARCHAR, @DAYS1) + "]), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "] = CONVERT(VARCHAR, [" + CONVERT(VARCHAR, @DAYS1 + 1) + "-" + CONVERT(VARCHAR, @DAYS2) + "]), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "] = CONVERT(VARCHAR, [" + CONVERT(VARCHAR, @DAYS2 + 1) + "-" + CONVERT(VARCHAR, @DAYS3) + "]), "  
  SELECT @@SQL = @@SQL + "[" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "] = CONVERT(VARCHAR, [" + CONVERT(VARCHAR, @DAYS3 + 1) + "-" + CONVERT(VARCHAR, @DAYS4) + "]), "  
  SELECT @@SQL = @@SQL + "[MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "] = CONVERT(VARCHAR, [MORE THAN " + CONVERT(VARCHAR, @DAYS5) + "]) "  
  SELECT @@SQL = @@SQL + "FROM ACCOUNT.DBO." + @@FINALNAME + " ORDER BY SNO"  
--  SELECT @@SQL = "DECLARE @@ERR AS INT EXEC @@ERR = MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + @@SQL + " " + CHAR(34) + " queryout " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + "', no_output SELECT @@ERR, '" + @@FNAME + "'"  
  CREATE TABLE #RESULTS  
   (  
    ERR INT,  
    FNAME VARCHAR(200)  
   )  
  
  SELECT @@SQL = "DECLARE @@ERR AS INT EXEC @@ERR = MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + @@SQL + " " + CHAR(34) + " queryout " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -U " + CHAR(34) + "sa" + CHAR(34) + " -P " + CHAR(34) + "POOL" + CHAR(34) + "', no_output INSERT INTO #RESULTS (ERR, FNAME) VALUES (@@ERR, '" + @@FNAME + "')"
  EXEC (@@SQL)  
  DECLARE @@ERR AS INT  
  SELECT @@ERR = ERR FROM #RESULTS  
  SELECT @@SQL = "DROP TABLE " + @@FFNAME + " DROP TABLE " + @@FINALNAME + " DELETE FROM TEMP_AGEING_BULK WHERE PROCID = " + CONVERT(VARCHAR, @@SPID) + " DROP TABLE #RESULTS"  
--  EXEC (@@SQL)  
--  PRINT @@FFNAME  
  IF @@ERR = 0  
   BEGIN  
    CREATE TABLE #OUTPUT  
     (  
      CONTENTS VARCHAR(2000)  
     )  
    SELECT @@SQL = "BULK INSERT #OUTPUT FROM '" + @@FNAME + "' WITH (FIELDTERMINATOR = '')"  
    EXEC (@@SQL)  
    ALTER TABLE #OUTPUT ADD SNO INT IDENTITY(1,1)  
    DELETE FROM FILE_OUTPUT WHERE PROCID = @@SPID AND CSVFILE = @@FNAME  
    SELECT @@SQL = "INSERT INTO FILE_OUTPUT (PROCID,CSVFILE,CONTENTS) SELECT " + CONVERT(VARCHAR, @@SPID) + ", "  
    SELECT @@SQL = @@SQL + "'" + @@FNAME + "', CONTENTS FROM #OUTPUT ORDER BY SNO "  
    EXEC (@@SQL)  
    SELECT ERR = 0, PROCID = @@SPID, CSVNAME = @@FNAME  
    SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'DEL " + @@FNAME + "', NO_OUTPUT"  
    EXEC (@@SQL)  
    DROP TABLE #OUTPUT  
   END  
  ELSE  
   BEGIN  
    SELECT ERR = 1, MSG = 'COULD NOT SAVE THE FILE DUE TO SOME UNKNOWN ERROR'  
   END  
 END  
  
  
  
  
DROP TABLE #TEMPAGEING  
DROP TABLE #LEDGER  
DROP TABLE #LEDGERCURSOR  
DROP TABLE #AGEINGLIST  
DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vdtyearend
-- --------------------------------------------------
CREATE Procedure Vdtyearend  
@sdtcur varchar(11),  
@ldtcur varchar(11),  
@vtyp   smallint,  
@vno varchar(12),  
@BookType char(2),  
@vdt    datetime,  
@msg1   varchar(234)  
AS  
declare  
@@cltcode as varchar(10),  
@@acname  as varchar(100),  
@@vdtbal  as money,  
@@lno     as int,  
@@cdt     as datetime,  
@@netdiff as money,  
@@plcount as int,  
@@plbal   as money,  
@@rcursor as cursor,
@@FixCode Varchar(10) 

Select @@FixCode = '999999'

select @@cdt = ( select getdate() )  
  
set @@rcursor = cursor for  
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)  
from ledger l left outer join acmast a on l.cltcode = a.cltcode  
where l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'  
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> @@FixCode  
group by l.cltcode,l.acname  
order by l.cltcode,l.acname  
  
open @@rcursor  
fetch next from @@rcursor   
into @@cltcode, @@acname, @@vdtbal  
  
select @@lno = 0  
select @@netdiff = 0  
while @@fetch_status = 0  
begin  
   select @@lno = @@lno + 1  
   select @@netdiff = @@netdiff + @@vdtbal  
  
   Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,  
                      EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)   
               values (@vtyp,@vno,(case when @@vdtbal >= 0 then 'D' else 'C' end),isnull(abs(@@vdtbal),0),@vdt,'',upper(@@cltcode),  
                       'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)  
  
  
   Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType)   
                values(@@lno,@msg1,'',@vtyp,@vno,@BookType)  
  
   fetch next from @@rcursor   
   into @@cltcode, @@acname, @@vdtbal  
end  
  
close @@rcursor  
deallocate @@rcursor  
  
select @@lno = @@lno + 1  
select @@acname = ( select acname from acmast where cltcode = @@FixCode)  
Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,  
                   EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)   
            values (@vtyp,@vno,(case when @@netdiff >= 0 then 'C' else 'D' end),abs(@@netdiff),@vdt,'',@@FixCode,  
                    'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)  
  
  
Insert into ledger3  
select lno, narration, refno, vtyp, vno, BookType  
from ledger  
where vtyp = @vtyp and booktype = @booktype and vno = @vno and  cltcode=@@FixCode  
  
Insert into ledger3  
select 0, narration, refno, vtyp, vno, BookType  
from ledger  
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VIRTUAL_MIS_FILEGEN
-- --------------------------------------------------
CREATE PROCEDURE VIRTUAL_MIS_FILEGEN
(
	@SQLQRY varchar(1000),
	@DATASERVER varchar(50)	,
	@FNAME VARCHAR(500)
)
AS

DECLARE
	@@SQL VARCHAR(1000)

	SELECT @@SQL = "DECLARE @@ERR AS INT EXEC @@ERR = MASTER.DBO.XP_CMDSHELL 'BCP " + CHAR(34) + @SQLQRY + " " + CHAR(34) + " queryout " + CHAR(34) + @FNAME + CHAR(34) + " -c -q -t " + CHAR(34) + "," + CHAR(34) + " -T -S "+ CHAR(34) + CHAR(34) + @DATASERVER + CHAR(34) + "', no_output"
	PRINT @@SQL
	EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VNO_DUPLICATES_RECTIFOCATION
-- --------------------------------------------------
/*begin tran
--EXEC VNO_DUPLICATES_RECTIFOCATION
rollback*/


CREATE PROC VNO_DUPLICATES_RECTIFOCATION
AS

DECLARE 
	@@MAXVNO VARCHAR(12),
	@@VNO VARCHAR(12),
	@@VTYP SMALLINT,
	@@BOOKTYPE VARCHAR(3),
	@@SDTCUR VARCHAR(11),
	@@LDTCUR VARCHAR(11),
	@@VDT VARCHAR(11),
	@@VNO_SERIES VARCHAR(4),
	@@VAMT MONEY,
	@@NARRATION VARCHAR(250),
	@@COUNTER INT

	CREATE TABLE LEDGER_DUPS_LOG
	(
		VNO VARCHAR(12),
		VTYP SMALLINT,
		BOOKTYPE VARCHAR(3)
	)

	CREATE TABLE #LEDGER_DUPS
	(
		Vtyp SMALLINT,
		Vno VARCHAR(12),
		Edt DATETIME,
		Lno INT,
		Acname VARCHAR(100),
		Drcr CHAR(1),
		Vamt MONEY,
		Vdt DATETIME,
		Vno1 VARCHAR(12),
		Refno VARCHAR(10),
		Balamt MONEY,
		Nodays INT,
		Cdt DATETIME,
		Cltcode VARCHAR(10),
		Booktype VARCHAR(3),
		Enteredby VARCHAR(100),
		Pdt DATETIME,
		Checkedby VARCHAR(100),
		Actnodays INT,
		Narration VARCHAR(250),
		VNO_SERIES VARCHAR(4), 
		SDTCUR VARCHAR(11), 
		LDTCUR VARCHAR(11)
	)

/*	SELECT * INTO #LEDGER_DUPS
	FROM VNO_DUPS WHERE 1 = 2*/

	SELECT * INTO BAK_LEDGER_DUPS_310706 FROM LEDGER WHERE 1 = 2
	SELECT * INTO BAK_LEDGER1_DUPS_310706 FROM LEDGER1 WHERE 1 = 2
	SELECT * INTO BAK_LEDGER2_DUPS_310706 FROM LEDGER2 WHERE 1 = 2
	SELECT * INTO BAK_LEDGER3_DUPS_310706 FROM LEDGER3 WHERE 1 = 2

	
/*	ALTER TABLE #LEDGER_DUPS
	ADD VNO_SERIES VARCHAR(4), SDTCUR VARCHAR(11), LDTCUR VARCHAR(11)*/
	
	UPDATE 
		L 
	SET 
		VNO_SERIES = YEAR(P.SDTCUR), L.SDTCUR = CONVERT(VARCHAR(11), P.SDTCUR, 109), L.LDTCUR = CONVERT(VARCHAR(11), P.LDTCUR, 109)
	FROM 
		#LEDGER_DUPS L, PARAMETER P
	WHERE 
		VDT BETWEEN P.SDTCUR AND P.LDTCUR

	
	DECLARE RENUM_VOUCHER_VNOSERIES CURSOR FOR
	SELECT 
		DISTINCT VNO, VTYP, BOOKTYPE, SDTCUR, LDTCUR, CONVERT(VARCHAR(11), VDT, 109), VNO_SERIES
	FROM 
		#LEDGER_DUPS
	WHERE 
		LEFT(VNO, 4) <> VNO_SERIES
	
	OPEN RENUM_VOUCHER_VNOSERIES
	
	FETCH NEXT FROM RENUM_VOUCHER_VNOSERIES
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@SDTCUR, @@LDTCUR, @@VDT, @@VNO_SERIES
	
	WHILE @@FETCH_STATUS = 0
	BEGIN

		SELECT 
			@@MAXVNO = ISNULL(CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1), '')
		FROM 
			LASTVNO 
		WHERE 
			VDT BETWEEN CONVERT(DATETIME, @@SDTCUR) AND CONVERT(DATETIME, @@LDTCUR + ' 23:59')
			AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE

		IF @@MAXVNO IS NOT NULL AND @@MAXVNO <> '' AND LEFT(@@MAXVNO, 4) = @@VNO_SERIES
		BEGIN

			SELECT @@COUNTER = COUNT(1) FROM LEDGER
			WHERE VNO = @@MAXVNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE

			IF @@COUNTER = 0
			BEGIN 
				INSERT INTO BAK_LEDGER_DUPS_310706 
				SELECT * FROM VNO_DUPS
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%'
		
				UPDATE VNO_DUPS SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%'
		
				INSERT INTO BAK_LEDGER1_DUPS_310706 
				SELECT Bnkname,Brnname,Dd,Ddno,Dddt,Reldt,Relamt,Refno,Receiptno,Vtyp,Vno,Lno,Drcr,Booktype,Micrno,Slipno,Slipdate,Chequeinname,Chqprinted,Clear_mode FROM LEDGER1
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND RELAMT = (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%' AND LNO = 1)
		
				UPDATE LEDGER1 SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND RELAMT = (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%' AND LNO = 1)
		
				
				INSERT INTO BAK_LEDGER2_DUPS_310706 
				SELECT * FROM LEDGER2
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
				AND CAMT IN (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				UPDATE LEDGER2 SET VNO = @@MAXVNO
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
				AND CAMT IN (SELECT VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				INSERT INTO BAK_LEDGER3_DUPS_310706 
				SELECT * FROM LEDGER3
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND NARR IN (SELECT NARRATION FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				UPDATE LEDGER3 SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE 
				AND NARR IN (SELECT NARRATION FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VDT LIKE @@VDT + '%')
		
				UPDATE LASTVNO SET LASTVNO = @@MAXVNO
				WHERE VDT BETWEEN @@SDTCUR AND @@LDTCUR + ' 23:59'
				AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
			END
			ELSE
			BEGIN
				PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + @@VTYP + ' BOOKTYPE : ' + @@BOOKTYPE
				INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
			END
		END
		ELSE
		BEGIN 
			PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + @@VTYP + ' BOOKTYPE : ' + @@BOOKTYPE
			INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
		END
		
		
	FETCH NEXT FROM RENUM_VOUCHER_VNOSERIES
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@SDTCUR, @@LDTCUR, @@VDT, @@VAMT, @@NARRATION, @@VNO_SERIES
	
	END

	CLOSE RENUM_VOUCHER_VNOSERIES
	DEALLOCATE RENUM_VOUCHER_VNOSERIES

	DECLARE LEDGER_AMT_RENUM CURSOR FOR
	SELECT V.VNO, V.VTYP, V.BOOKTYPE, V.VAMT, V.NARRATION
	FROM 
	(
		SELECT VNO, VTYP, BOOKTYPE, LNO
		FROM VNO_DUPS 
		WHERE LNO = 1 AND VTYP IN(2,3) 
		GROUP BY VNO, VTYP, BOOKTYPE, LNO
		HAVING COUNT(1) > 1
	)A, VNO_DUPS V
	WHERE A.VNO = V.VNO AND A.VTYP = V.VTYP AND A.BOOKTYPE = V.BOOKTYPE 
	GROUP BY V.VNO, V.VTYP, V.BOOKTYPE, V.VAMT, V.NARRATION
	HAVING COUNT(1) = 2 AND SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) = 0

	OPEN LEDGER_AMT_RENUM

	FETCH NEXT FROM LEDGER_AMT_RENUM
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@VAMT, @@NARRATION

	WHILE @@FETCH_STATUS = 0
	BEGIN

		SELECT @@VDT = CONVERT(VARCHAR(11), VDT, 109) FROM LEDGER 
		WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND VAMT = @@VAMT


		SELECT 
			@@MAXVNO = ISNULL(CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1), ''), @@SDTCUR = MAX(YEAR(SDTCUR))
		FROM 
			LASTVNO L, PARAMETER P
		WHERE 
			@@VDT BETWEEN CONVERT(DATETIME, CONVERT(VARCHAR(11), SDTCUR, 109)) AND CONVERT(DATETIME, CONVERT(VARCHAR(11), LDTCUR, 11) + ' 23:59')
			AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE 
	
		IF @@MAXVNO IS NOT NULL AND @@MAXVNO <> '' AND @@SDTCUR = LEFT(@@MAXVNO, 11)
		BEGIN

			SELECT @@COUNTER = COUNT(1) FROM LEDGER
			WHERE VNO = @@MAXVNO AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
	
			IF @@COUNTER = 0
			BEGIN 
	
				INSERT INTO BAK_LEDGER_DUPS_310706 
				SELECT * FROM VNO_DUPS
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VAMT = @@VAMT
		
				UPDATE VNO_DUPS SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VAMT = @@VAMT
		
				UPDATE VNO_DUPS SET LNO = 2 
				WHERE VNO = @@MAXVNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND VAMT = @@VAMT AND LNO <> 1
		
				INSERT INTO BAK_LEDGER1_DUPS_310706 
				SELECT Bnkname,Brnname,Dd,Ddno,Dddt,Reldt,Relamt,Refno,Receiptno,Vtyp,Vno,Lno,Drcr,Booktype,Micrno,Slipno,Slipdate,Chequeinname,Chqprinted,Clear_mode FROM LEDGER1
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND RELAMT = @@VAMT
		
				UPDATE LEDGER1 SET VNO = @@MAXVNO, LNO = 2
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND RELAMT = @@VAMT
		
				INSERT INTO BAK_LEDGER2_DUPS_310706 
				SELECT * FROM LEDGER2
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND CAMT = @@VAMT
		
				UPDATE LEDGER2 SET VNO = @@MAXVNO
				WHERE VNO = @@VNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND CAMT = @@VAMT
		
				UPDATE LEDGER2 SET LNO = 2
				WHERE VNO = @@MAXVNO AND VTYPE = @@VTYP AND BOOKTYPE = @@BOOKTYPE AND CAMT = @@VAMT AND LNO <> 1
		
				INSERT INTO BAK_LEDGER3_DUPS_310706 
				SELECT * FROM LEDGER3
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND NARR = @@NARRATION
		
				UPDATE LEDGER3 SET VNO = @@MAXVNO 
				WHERE VNO = @@VNO AND VTYP = @@VTYP AND BOOKTYPE = BOOKTYPE AND NARR = @@NARRATION
		
				UPDATE L SET LASTVNO = @@MAXVNO
				FROM LASTVNO L, PARAMETER P
				WHERE @@VDT BETWEEN SDTCUR AND CONVERT(VARCHAR(11), LDTCUR, 109) + ' 23:59'
				AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE
			END
			ELSE
			BEGIN
				PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + CONVERT(VARCHAR, @@VTYP) + ' BOOKTYPE : ' + @@BOOKTYPE
				INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
			END
		END
		ELSE
		BEGIN 
			PRINT 'THE VOUCHERS IS NOT UPDATED VNO : ' + @@VNO + ' VTYP : ' + CONVERT(VARCHAR, @@VTYP) + ' BOOKTYPE : ' + @@BOOKTYPE
			INSERT INTO LEDGER_DUPS_LOG VALUES(@@VNO, @@VTYP, @@BOOKTYPE)
		END


	FETCH NEXT FROM LEDGER_AMT_RENUM
	INTO @@VNO, @@VTYP, @@BOOKTYPE, @@VAMT, @@NARRATION
	END 


	CLOSE LEDGER_AMT_RENUM
	DEALLOCATE LEDGER_AMT_RENUM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherPrintingSp
-- --------------------------------------------------
--exec VoucherPrintingSp '17','01','01','','','200705020001','200705020001',1,1 
          
--exec VoucherPrintingSp '4','01','01','','','200504020001','200504020001',1,1              
            
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 06/24/2004 8:32:35 PM ******/                
                
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 05/10/2004 5:29:36 PM ******/                
/* comm. narr replaced line narration  by amit requirment in mosl on 18/10/2002*/                
                
CREATE Proc VoucherPrintingSp                 
@Vtyp varchar(2),                
@BookTypeFrom varchar(2),                
@BookTypeTo varchar(2),                
@StartDate Varchar(11),                
@EndDate Varchar(11),                
@VnoFrom Varchar(12),                
@VnoTo Varchar(12),                
@VnoVdtFlag int,                
@Flag int                
as                
                
If @Flag = 0                
Begin                
   if @startdate = ''                 
      begin                
/* Conditions of VNO only */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                 
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
     cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                  
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno      
      end                
   else                
   if @Vnofrom = ''                 
      begin                
         /* Conditions on Vdt only */                
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                  
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                    ELSE L.CLTCODE END ),0),                 
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
    narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */                
  cnar = isnull(l.narration,'') ,                
  cltcode2 = cltcode, acname2 = acname            
  from ledger l ,LEDGER1 L1                
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                 
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                
                
      end                
   else                
      begin                
         /* Conditions on Vdt and VNo */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                 
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                  
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'                
    end)                 
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno -- desc                
      end                
end              
                
Else If @Flag = 1                
Begin                
  if @startdate = ''                 
     begin                
  /* Conditions of VNO only */                
  select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l                 
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo              
   --and l.drcr in (case when @Vtyp='6' then 'C' else case when @Vtyp='7' then 'D' else 'C''D' end end)              
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
     end                
 else                
 if @Vnofrom = ''                 
     begin                
                /* Conditions on Vdt only */                
                  
   select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                     THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                      ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                         ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     narr = isnull(l.narration,'') ,                
 /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') , */                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l                 
    where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                 
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno                
     End                
   Else                 
          /* Conditions on Vdt and VNo */                
      Begin                 
    select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
     from ledger l                 
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'       
    end)                 
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
      End                  
End                
              
Else If @flag = 2                
Begin                
 if @startdate = ''                 
  Begin                
  /* Conditions of VNO only */                
  select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
          ELSE L.CLTCODE END ),0),                
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                 
          ELSE L.acname END ),0),                
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                
     narr = isnull(l.narration,'') ,                
     /* cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
                        cnar = isnull(l.narration,'') ,                
   cltcode2 = l.cltcode, acname2 = l.acname                
   from ledger l, acmast a                
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
  End                 
    else                
 if @Vnofrom = ''                 
     begin                
                /* Conditions on Vdt only */                  
    select   CltCode = ISNULL((CASE WHEN a.accat = 14 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                    ELSE L.CLTCODE END ),0),                
     acname = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                 
           ELSE L.acname END ),0),                
    l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                
    narr = isnull(l.narration,'') ,                
    /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
  cnar = isnull(l.narration,'') ,                
  cltcode2 = l.cltcode, acname2 = l.acname                
  from ledger l, acmast a                
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                 
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                
                
                    
  End                 
  Else                 
          /* Conditions on Vdt and VNo */                
  Begin                
    select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
          ELSE L.CLTCODE END ),0),                
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                 
          ELSE L.acname END ),0),                
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = l.cltcode, acname2 = l.acname           
   from ledger l, acmast a                
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'                
    end)                
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno                
  End                 
                
End                
else if @flag = 3                
Begin                
   if @startdate = ''                 
      begin                
/* Conditions of VNO only */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype and l.lno = l1.lno                
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
      end                
   else                
   if @Vnofrom = ''                 
      begin                
         /* Conditions on Vdt only */                
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                  
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                    ELSE L.CLTCODE END ),0),                 
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
    narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */                
  cnar = isnull(l.narration,'') ,                
  cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1               
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype  and l.lno = l1.lno                
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                
                
      end                
   else                
      begin                
         /* Conditions on Vdt and VNo */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                 
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
 isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
  from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype   and l.lno = l1.lno                
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'                
    end)                 
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
      end               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------

CREATE PROC Vw @VwName VARCHAR(25)AS                 
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND
-- --------------------------------------------------
/*    
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18    
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200800000001', '01', 'APR  1 2008', 'OPENING BALANCE'  
*/    
CREATE PROC [dbo].[YEAREND]    
 @SDTCUR VARCHAR(11),    
 @LDTCUR VARCHAR(11),    
 @VTYP SMALLINT,    
 @VNO VARCHAR(12),    
 @BOOKTYPE VARCHAR(2),    
 @VDT VARCHAR(11),    
 @MSG1 VARCHAR(234),  
 @PNL_CODE VARCHAR(10) = '99999'  
AS    
/*    
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'    
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'    
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'    
     
*/    
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
    
 CREATE TABLE #VDT    
 (    
  CLTCODE VARCHAR(10),    
  ACNAME VARCHAR(100),    
  DRCR VARCHAR(1),    
  BALANCE MONEY    
 )    
    
 INSERT INTO #VDT    
  (CLTCODE, ACNAME, DRCR, BALANCE)    
 SELECT    
  A.CLTCODE,    
  ACNAME = ISNULL(A.LONGNAME, ''),    
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,    
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))    
 FROM    
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 WHERE    
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')    
  AND L.CLTCODE <> @PNL_CODE    
 GROUP BY    
  A.CLTCODE,    
  A.LONGNAME    
    
    
 CREATE TABLE #EDT    
 (    
  CLTCODE VARCHAR(10),    
  BALANCE MONEY    
 )    
    
 INSERT INTO #EDT    
  (CLTCODE, BALANCE)    
SELECT CLTCODE, BALANCE FROM
(
 SELECT    
  A.CLTCODE,    
  BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END)
 FROM    
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 WHERE    
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')    
  AND L.CLTCODE <> @PNL_CODE    
 GROUP BY    
  A.CLTCODE

 UNION ALL
 
  SELECT    
  A.CLTCODE,    
  BALANCE = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END)
 FROM    
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 WHERE    
  L.EDT >= @SDTCUR AND L.VDT < @SDTCUR
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')    
  AND L.CLTCODE <> @PNL_CODE    
 GROUP BY    
  A.CLTCODE

) L
    
    
 CREATE TABLE #LEDGER    
 (    
  VTYP SMALLINT,    
  VNO VARCHAR(12),    
  EDT DATETIME,    
  LNO INT IDENTITY(1,1),    
  ACNAME VARCHAR(100),    
  DRCR CHAR(1),    
  VAMT MONEY,    
  VDT DATETIME,    
  VNO1 VARCHAR(12),    
  REFNO CHAR(12),    
  BALAMT MONEY,    
  NODAYS INT,    
  CDT DATETIME,    
  CLTCODE VARCHAR(10),    
  BOOKTYPE VARCHAR(2),    
  ENTEREDBY VARCHAR(25),    
  PDT DATETIME,    
  CHECKEDBY VARCHAR(25),    
  ACTNODAYS INT,    
  NARRATION VARCHAR(234)    
 )    
    
INSERT INTO #LEDGER    
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)    
SELECT    
 VTYP = @VTYP,    
 VNO = @VNO,    
 EDT = @VDT,    
 ACNAME = V.ACNAME,    
 DRCR = V.DRCR,    
 VAMT = V.BALANCE,    
 VDT = @VDT,    
 VNO1 = @VNO,    
 REFNO = '',    
 BALAMT = ISNULL(E.BALANCE, 0),    
 NODAYS = 0,    
 CDT = GETDATE(),    
 V.CLTCODE,    
 BOOKTYPE = @BOOKTYPE,    
 ENTEREDBY = 'SYSTEM',    
 PDT = GETDATE(),    
 CHECKEDBY = 'SYSTEM',    
 ACTNODAYS = 0,    
 NARRATION = @MSG1    
FROM    
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE    
    
    
CREATE TABLE #PANDL    
(    
 VDTBAL MONEY,    
 EDTBAL MONEY    
)    
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER    
    
INSERT INTO #LEDGER    
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)    
SELECT    
 VTYP = @VTYP,    
 VNO = @VNO,    
 EDT = @VDT,    
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),    
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,    
 VAMT = ABS(VDTBAL),    
 VDT = @VDT,    
 VNO1 = @VNO,    
 REFNO = '',    
 BALAMT = EDTBAL,    
 NODAYS = 0,    
 CDT = GETDATE(),    
 A.CLTCODE,    
 BOOKTYPE = @BOOKTYPE,    
 ENTEREDBY = 'SYSTEM',    
 PDT = GETDATE(),    
 CHECKEDBY = 'SYSTEM',    
 ACTNODAYS = 0,    
 NARRATION = @MSG1    
FROM    
 #PANDL,    
 ACMAST A    
WHERE    
 A.CLTCODE = @PNL_CODE    
    
    
    
DROP TABLE #VDT    
DROP TABLE #EDT    
DROP TABLE #PANDL    
    
CREATE TABLE #MVDT    
(    
 PARTY_CODE VARCHAR(10),    
 MCLTCODE VARCHAR(10),    
 EXCHANGE VARCHAR(3),    
 SEGMENT VARCHAR(20),    
 DRCR VARCHAR(1),    
 AMOUNT MONEY    
)    
    
INSERT INTO #MVDT    
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)    
SELECT    
 PARTY_CODE,    
 MCLTCODE,    
 EXCHANGE,    
 SEGMENT,    
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,    
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)    
FROM    
 MARGINLEDGER    
WHERE    
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'    
GROUP BY    
 PARTY_CODE,    
 MCLTCODE,    
 EXCHANGE,    
 SEGMENT    
    
CREATE TABLE #MEDT    
(    
 PARTY_CODE VARCHAR(10),    
 MCLTCODE VARCHAR(10),    
 EXCHANGE VARCHAR(3),    
 SEGMENT VARCHAR(20),    
 AMOUNT MONEY    
)    
    
INSERT INTO #MEDT    
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)    
SELECT    
 M.PARTY_CODE,    
 M.MCLTCODE,    
 M.EXCHANGE,    
 M.SEGMENT,    
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)    
FROM    
 MARGINLEDGER M,    
 LEDGER L    
WHERE    
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO    
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'    
GROUP BY    
 M.PARTY_CODE,    
 M.MCLTCODE,    
 M.EXCHANGE,    
 M.SEGMENT    
    
CREATE TABLE #MARGINLEDGER    
(    
 VTYP SMALLINT,    
 VNO VARCHAR(12),    
 LNO INT,    
 DRCR VARCHAR(1),    
 VDT DATETIME,    
 AMOUNT MONEY,    
 PARTY_CODE VARCHAR(10),    
 EXCHANGE VARCHAR(3),    
 SEGMENT VARCHAR(20),    
 SETT_NO MONEY,    
 SETT_TYPE VARCHAR(3),    
 BOOKTYPE VARCHAR(2),    
 MCLTCODE VARCHAR(10)    
)    
    
INSERT INTO #MARGINLEDGER    
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)    
SELECT    
 VTYP = @VTYP,    
 VNO = @VNO,    
 DRCR = V.DRCR,    
 VDT = @VDT,    
 AMOUNT = ABS(V.AMOUNT),    
 PARTY_CODE = V.PARTY_CODE,    
 EXCHANGE = V.EXCHANGE,    
 SEGMENT = V.SEGMENT,    
 SETT_NO = ISNULL(E.AMOUNT, 0),    
 SETT_TYPE = '',    
 BOOKTYPE = @BOOKTYPE,    
 MCLTCODE = V.MCLTCODE    
FROM    
 #MVDT V LEFT OUTER JOIN #MEDT E ON    
  V.PARTY_CODE = E.PARTY_CODE    
  AND V.MCLTCODE = E.MCLTCODE    
  AND V.EXCHANGE = E.EXCHANGE    
  AND V.SEGMENT = E.SEGMENT    
    
UPDATE    
 H    
SET    
 LNO = L.LNO    
FROM    
 #MARGINLEDGER H,    
 #LEDGER L    
WHERE    
 H.MCLTCODE = L.CLTCODE    
    
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE    
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M   
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE    
DECLARE @ISDIFF INT    
SET @ISDIFF = 0    
SELECT    
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L    
WHERE    
 M.MCLTCODE = L.CLTCODE    
 AND M.BALANCE <> L.BALANCE    
    
/*IF @ISDIFF <> 0    
 BEGIN    
  DROP TABLE #LEDGER    
  DROP TABLE #MARGINLEDGER    
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'    
 END    
ELSE    
 BEGIN  */  
  INSERT INTO LEDGER SELECT * FROM #LEDGER    
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER    
--  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER    
  ---EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE    
  DROP TABLE #LEDGER    
  DROP TABLE #MARGINLEDGER    
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'    
-- END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_new
-- --------------------------------------------------


        
 /*            
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18            
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'          
*/            
CREATE PROC [dbo].[YEAREND_new]            
 @SDTCUR VARCHAR(11),            
 @LDTCUR VARCHAR(11),            
 @VTYP SMALLINT,            
 @VNO VARCHAR(12),            
 @BOOKTYPE VARCHAR(2),            
 @VDT VARCHAR(11),            
 @MSG1 VARCHAR(234),          
 @PNL_CODE VARCHAR(10) = '99999'          
AS            
/*            
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'            
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'            
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'            
             
*/            
          
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
            
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE            
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
            
 CREATE TABLE #VDT            
 (            
  CLTCODE VARCHAR(10),            
  ACNAME VARCHAR(100),            
  DRCR VARCHAR(1),            
  BALANCE MONEY            
 )            
            
 INSERT INTO #VDT            
  (CLTCODE, ACNAME, DRCR, BALANCE)            
 SELECT            
  A.CLTCODE,            
  ACNAME = ISNULL(A.LONGNAME, ''),            
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,            
  VAMT = ROUND(ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END)),2)            
 FROM            
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE            
 WHERE            
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'            
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')            
  AND L.CLTCODE <> @PNL_CODE            
 GROUP BY            
  A.CLTCODE,            
  A.LONGNAME            
            
            
 CREATE TABLE #EDT            
 (            
  CLTCODE VARCHAR(10),            
  BALANCE MONEY            
 )            
            
 INSERT INTO #EDT            
  (CLTCODE, BALANCE)            
 SELECT            
  A.CLTCODE,            
  BALANCE = ROUND(SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END),2)            
 FROM            
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE            
 WHERE            
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'            
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')            
  AND L.CLTCODE <> @PNL_CODE            
 GROUP BY            
  A.CLTCODE            
            
            
 CREATE TABLE #LEDGER            
 (            
  VTYP SMALLINT,            
  VNO VARCHAR(12),            
  EDT DATETIME,            
  LNO INT IDENTITY(1,1),            
  ACNAME VARCHAR(100),            
  DRCR CHAR(1),            
  VAMT MONEY,            
  VDT DATETIME,            
  VNO1 VARCHAR(12),            
  REFNO CHAR(12),            
  BALAMT MONEY,            
  NODAYS INT,            
  CDT DATETIME,            
  CLTCODE VARCHAR(10),            
  BOOKTYPE VARCHAR(2),            
  ENTEREDBY VARCHAR(25),            
  PDT DATETIME,            
  CHECKEDBY VARCHAR(25),            
  ACTNODAYS INT,            
  NARRATION VARCHAR(234)            
 )            
            
INSERT INTO #LEDGER            
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)            
SELECT            
 VTYP = @VTYP,            
 VNO = @VNO,            
 EDT = @VDT,            
 ACNAME = V.ACNAME,            
 DRCR = V.DRCR,            
 VAMT = V.BALANCE,            
 VDT = @VDT,            
 VNO1 = @VNO,            
 REFNO = '',            
 BALAMT = ISNULL(E.BALANCE, 0),            
 NODAYS = 0,            
 CDT = GETDATE(),            
 V.CLTCODE,            
 BOOKTYPE = @BOOKTYPE,            
 ENTEREDBY = 'SYSTEM',            
 PDT = GETDATE(),            
 CHECKEDBY = 'SYSTEM',            
 ACTNODAYS = 0,            
 NARRATION = @MSG1            
FROM            
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE            
            
            
CREATE TABLE #PANDL            
(            
 VDTBAL MONEY,            
 EDTBAL MONEY            
)            
INSERT INTO #PANDL SELECT VDTBAL = ROUND(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),2), EDTBAL = ROUND((SUM(BALAMT)),2) FROM #LEDGER            
            
INSERT INTO #LEDGER            
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)            
SELECT            
 VTYP = @VTYP,            
 VNO = @VNO,            
 EDT = @VDT,            
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),            
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,            
 VAMT = ABS(VDTBAL),            
 VDT = @VDT,            
 VNO1 = @VNO,            
 REFNO = '',            
 BALAMT = EDTBAL,            
 NODAYS = 0,            
 CDT = GETDATE(),            
 A.CLTCODE,            
 BOOKTYPE = @BOOKTYPE,            
 ENTEREDBY = 'SYSTEM',            
 PDT = GETDATE(),            
 CHECKEDBY = 'SYSTEM',            
 ACTNODAYS = 0,            
 NARRATION = @MSG1            
FROM            
 #PANDL,            
 ACMAST A            
WHERE            
 A.CLTCODE = @PNL_CODE            
            
            
            
DROP TABLE #VDT            
DROP TABLE #EDT            
DROP TABLE #PANDL            
            
CREATE TABLE #MVDT            
(            
 PARTY_CODE VARCHAR(10),            
 MCLTCODE VARCHAR(10),            
 EXCHANGE VARCHAR(3),            
 SEGMENT VARCHAR(20),            
 DRCR VARCHAR(1),            
 AMOUNT MONEY            
)            
            
INSERT INTO #MVDT            
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)            
SELECT            
 PARTY_CODE,            
 MCLTCODE,            
 EXCHANGE,            
 SEGMENT,            
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,            
 AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END),2)            
FROM            
 MARGINLEDGER            
WHERE            
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'            
GROUP BY            
 PARTY_CODE,            
 MCLTCODE,            
 EXCHANGE,            
 SEGMENT            
            
CREATE TABLE #MEDT            
(            
 PARTY_CODE VARCHAR(10),            
 MCLTCODE VARCHAR(10),            
 EXCHANGE VARCHAR(3),            
 SEGMENT VARCHAR(20),            
 AMOUNT MONEY            
)            
            
INSERT INTO #MEDT            
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)            
SELECT            
 M.PARTY_CODE,            
 M.MCLTCODE,            
 M.EXCHANGE,            
 M.SEGMENT,            
 AMOUNT = ROUND(SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END),2)            
FROM            
 MARGINLEDGER M,            
 LEDGER L            
WHERE            
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO            
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'            
GROUP BY            
 M.PARTY_CODE,            
 M.MCLTCODE,            
 M.EXCHANGE,            
 M.SEGMENT            
            
CREATE TABLE #MARGINLEDGER            
(            
 VTYP SMALLINT,            
 VNO VARCHAR(12),            
 LNO INT,            
 DRCR VARCHAR(1),            
 VDT DATETIME,            
 AMOUNT MONEY,            
 PARTY_CODE VARCHAR(10),            
 EXCHANGE VARCHAR(3),            
 SEGMENT VARCHAR(20),            
 SETT_NO MONEY,            
 SETT_TYPE VARCHAR(3),            
 BOOKTYPE VARCHAR(2),            
 MCLTCODE VARCHAR(10)            
)            
            
INSERT INTO #MARGINLEDGER            
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)            
SELECT            
 VTYP = @VTYP,            
 VNO = @VNO,            
 DRCR = V.DRCR,            
 VDT = @VDT,            
 AMOUNT = ABS(V.AMOUNT),            
 PARTY_CODE = V.PARTY_CODE,            
 EXCHANGE = V.EXCHANGE,            
 SEGMENT = V.SEGMENT,            
 SETT_NO = ISNULL(E.AMOUNT, 0),            
 SETT_TYPE = '',            
 BOOKTYPE = @BOOKTYPE,            
 MCLTCODE = V.MCLTCODE            
FROM            
 #MVDT V LEFT OUTER JOIN #MEDT E ON            
  V.PARTY_CODE = E.PARTY_CODE            
  AND V.MCLTCODE = E.MCLTCODE            
  AND V.EXCHANGE = E.EXCHANGE            
  AND V.SEGMENT = E.SEGMENT            
            
UPDATE            
 H            
SET            
 LNO = L.LNO            
FROM            
 #MARGINLEDGER H,            
 #LEDGER L            
WHERE            
 H.MCLTCODE = L.CLTCODE            
            
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE            
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M            
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE            
DECLARE @ISDIFF INT            
SET @ISDIFF = 0            
SELECT            
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L            
WHERE            
 M.MCLTCODE = L.CLTCODE            
 AND M.BALANCE <> L.BALANCE            
            
/*IF @ISDIFF <> 0            
 BEGIN            
  DROP TABLE #LEDGER            
  DROP TABLE #MARGINLEDGER            
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'            
 END            
ELSE            
 BEGIN  */          
  INSERT INTO LEDGER SELECT * FROM #LEDGER            
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER            
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER            
  ---EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE            
  DROP TABLE #LEDGER            
  DROP TABLE #MARGINLEDGER            
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'            
-- END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_VARIFICATION
-- --------------------------------------------------
--EXEC YEAREND_VARIFICATION 'APR  1 2007', 'MAR 31 2008', 18, '200800000001', '01', 'APR  1 2008', 'OPENING BALANCE', '99999'
CREATE PROC YEAREND_VARIFICATION
 @SDTCUR VARCHAR(11),  
 @LDTCUR VARCHAR(11),  
 @VTYP SMALLINT,  
 @VNO VARCHAR(12),  
 @BOOKTYPE VARCHAR(2),  
 @VDT VARCHAR(11),  
 @MSG1 VARCHAR(234),
 @PNL_CODE VARCHAR(10)
AS

	SELECT 'LEDGER BALANCES MISMATCH', 0
	UNION ALL
	SELECT CLTCODE, SUM(AMOUNT) FROM
	(
		SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)
		FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE 
		WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59'
		AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
		AND L.CLTCODE <> @PNL_CODE
		GROUP BY L.CLTCODE
		UNION ALL
		SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)
		FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE 
		WHERE VNO = @VNO AND VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE
		AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
		AND L.CLTCODE <> @PNL_CODE
		GROUP BY L.CLTCODE
	) L
	GROUP BY CLTCODE
	HAVING SUM(AMOUNT) <> 0

	SELECT 'LEDGER2 BALANCES MISMATCH', 0
	UNION ALL
	SELECT CLTCODE, SUM(AMOUNT) FROM
	(
		SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)
		FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L
		WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO 
		AND VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59'
		AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
		AND L2.CLTCODE <> @PNL_CODE
		GROUP BY L2.CLTCODE
		UNION ALL
		SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)
		FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L 
		WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO 
		AND L2.VNO = @VNO AND VTYPE = @VTYP AND L2.BOOKTYPE = @BOOKTYPE
		AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
		AND L2.CLTCODE <> @PNL_CODE
		GROUP BY L2.CLTCODE
	) L
	GROUP BY CLTCODE
	HAVING SUM(AMOUNT) <> 0

	SELECT 'PROFIT AND LOSS MISMATCH', 0
	UNION ALL
	SELECT 'AMOUNT_MISMATCH', SUM(AMOUNT) FROM
	(
		SELECT AMOUNT = SUM(AMOUNT) FROM
		(SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)
			FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE 
			WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59'
			AND (A.ACTYP LIKE 'INCO%' OR A.ACTYP LIKE 'EXP%')  
			UNION ALL
		SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)
			FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE 
			WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59'
			AND L.CLTCODE = @PNL_CODE
		) L1
		UNION ALL
		SELECT AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)
		FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE 
		WHERE VNO = @VNO AND VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE
		AND L.CLTCODE = @PNL_CODE
	) L

	SELECT 'LEDGER AND LEDGER2 MISMATCH', 0
	UNION ALL
	SELECT CLTCODE, SUM(AMOUNT) FROM
	(
		SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)
		FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE
		WHERE VNO = @VNO AND VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE
		AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
		GROUP BY L.CLTCODE
		UNION ALL
		SELECT L2.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)
		FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE
		WHERE L2.VNO = @VNO AND VTYPE = @VTYP AND L2.BOOKTYPE = @BOOKTYPE
		AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
		GROUP BY L2.CLTCODE
	) L
	GROUP BY CLTCODE
	HAVING SUM(AMOUNT) <> 0

	SELECT 'COSTCODEWISE AMOUNT MISMATCH', 0
	UNION ALL
	SELECT CONVERT(VARCHAR, COSTCODE), SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)
	FROM LEDGER2
	WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE
	GROUP BY CONVERT(VARCHAR, COSTCODE)
	HAVING SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) <> 0

GO

-- --------------------------------------------------
-- TABLE dbo.AAACM6094R_CE_20122021_01
-- --------------------------------------------------
CREATE TABLE [dbo].[AAACM6094R_CE_20122021_01]
(
    [TRADING MEMBER PAN] VARCHAR(50) NULL,
    [DATE] VARCHAR(50) NULL,
    [UNIQUE CLIENT CODE] VARCHAR(50) NULL,
    [CLIENT PAN] VARCHAR(50) NULL,
    [CLIENT NAME] VARCHAR(500) NULL,
    [MTF  NON MTF INDICATOR] VARCHAR(50) NULL,
    [FINANCIAL LEDGER BALANCE-A] VARCHAR(50) NULL,
    [FINANCIAL LEDGER BALANCE (CLEAR)-B] VARCHAR(50) NULL,
    [Peak Financial Ledger Balance (clear)-C] VARCHAR(50) NULL,
    [FINANCIAL LEDGER BALANCE-MCX] VARCHAR(50) NULL,
    [FINANCIAL LEDGER BALANCE-NCDEX] VARCHAR(50) NULL,
    [FINANCIAL LEDGER BALANCE-ICEX] VARCHAR(50) NULL,
    [BANK GUARANTEE (BG)] VARCHAR(50) NULL,
    [FIXED DEPOSIT RECEIPT (FDR)] VARCHAR(50) NULL,
    [GOVERNMENT OF INDIA SECURITIES (GSEC)] VARCHAR(50) NULL,
    [GILT FUNDS] VARCHAR(50) NULL,
    [Credit entry in ledger in lieu of EPI] VARCHAR(50) NULL,
    [Pool Account] VARCHAR(50) NULL,
    [Uncleared Cheques] VARCHAR(50) NULL,
    [Value of Commodities] VARCHAR(50) NULL,
    [LAST SETTLEMENT DATE] VARCHAR(50) NULL,
    [ES INFORMATION TYPE] VARCHAR(50) NULL,
    [Value] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acccategory
-- --------------------------------------------------
CREATE TABLE [dbo].[acccategory]
(
    [Categoryid] VARCHAR(10) NULL,
    [Categoryname] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACCOUNTS_FILE_LIST
-- --------------------------------------------------
CREATE TABLE [dbo].[ACCOUNTS_FILE_LIST]
(
    [FILE_CODE] INT NULL,
    [FILE_DESC] VARCHAR(100) NULL,
    [FILE_GROUP] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.accountscategory
-- --------------------------------------------------
CREATE TABLE [dbo].[accountscategory]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Category] VARCHAR(100) NULL,
    [Intrestdr] VARCHAR(100) NULL,
    [Intrestcr] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(100) NULL,
    [Dummy2] VARCHAR(100) NULL,
    [Dummy3] VARCHAR(100) NULL,
    [Dummy4] VARCHAR(100) NULL,
    [Dummy5] VARCHAR(100) NULL,
    [Dummy6] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Acmast]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_1211
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_1211]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_LEDGER]
(
    [ACNAME] VARCHAR(100) NOT NULL,
    [LONGNAME] VARCHAR(100) NOT NULL,
    [ACTYP] CHAR(10) NOT NULL,
    [ACCAT] CHAR(10) NOT NULL,
    [FAMILYCD] CHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [ACCDTLS] CHAR(35) NULL,
    [GRPCODE] CHAR(13) NOT NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [MICRNO] INT NULL,
    [BRANCHCODE] VARCHAR(10) NOT NULL,
    [BTOBPAYMENT] INT NULL,
    [PAYMODE] CHAR(1) NULL,
    [POBANKNAME] VARCHAR(50) NULL,
    [POBRANCH] VARCHAR(25) NULL,
    [POBANKCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_TLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_TLOG]
(
    [ACNAME] VARCHAR(100) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [ACTYP] CHAR(10) NULL,
    [ACCAT] CHAR(10) NULL,
    [FAMILYCD] CHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [ACCDTLS] CHAR(35) NULL,
    [GRPCODE] CHAR(13) NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [MICRNO] INT NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [BTOBPAYMENT] INT NULL,
    [PAYMODE] CHAR(1) NULL,
    [POBANKNAME] VARCHAR(50) NULL,
    [POBRANCH] VARCHAR(25) NULL,
    [POBANKCODE] VARCHAR(10) NULL,
    [UPDDATE] DATETIME NOT NULL,
    [DBACTION] VARCHAR(1) NULL,
    [COMP_NAME] VARCHAR(100) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_TRG]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] INT NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BalConfirm_Print_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[BalConfirm_Print_Setting]
(
    [Code] VARCHAR(50) NOT NULL,
    [Description] VARCHAR(1000) NOT NULL,
    [PrintFlag] VARCHAR(1) NOT NULL,
    [OrderNo] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Banklocat
-- --------------------------------------------------
CREATE TABLE [dbo].[Banklocat]
(
    [Cheque] VARCHAR(10) NULL,
    [Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(100) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SrNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_BALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_BALANCES]
(
    [CLTCODE] VARCHAR(10) NULL,
    [OPEN_DATE] DATETIME NULL,
    [CLOSE_DATE] DATETIME NULL,
    [OPEN_BALANCE] MONEY NULL,
    [CLOSE_BALANCE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_COMBINED
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_COMBINED]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_COMBINED_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_COMBINED_LOG]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT NOT NULL,
    [UPDATED_BY] VARCHAR(25) NULL,
    [UPDATE_DT] DATETIME NULL,
    [RECO_STATUS] VARCHAR(9) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco_Log]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(100) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_MISMATCH_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_MISMATCH_LOG]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(30) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL,
    [CrossReferenceNo] INT NULL,
    [Status] VARCHAR(9) NULL,
    [MicrNo] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [Upload_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfbillmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[bfbillmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(12) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [balamt] MONEY NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [Branch] VARCHAR(10) NULL,
    [BookType] CHAR(2) NULL,
    [BankPostDate] DATETIME NULL,
    [BankPostAmount] MONEY NULL,
    [BankStatus] CHAR(10) NULL,
    [BankReason] CHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILL_SHIFT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILL_SHIFT_LOG]
(
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [GEN_VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [UPDDATE] DATETIME NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLLOG]
(
    [GENNO] VARCHAR(50) NULL,
    [STARTTIME] DATETIME NULL,
    [ENDTIME] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [USERNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Billmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[Billmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_no] VARCHAR(12) NULL,
    [Billno] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [Drcr] CHAR(1) NULL,
    [Balamt] MONEY NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Branch] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillPosted
-- --------------------------------------------------
CREATE TABLE [dbo].[BillPosted]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPROCESS]
(
    [IN_PROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BOOKTYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[BOOKTYPE]
(
    [Vtyp] INT NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branchaccounts
-- --------------------------------------------------
CREATE TABLE [dbo].[Branchaccounts]
(
    [Branchname] VARCHAR(10) NOT NULL,
    [Brcontrolac] VARCHAR(10) NOT NULL,
    [Maincontrolac] VARCHAR(10) NOT NULL,
    [Defaultac] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchwiseclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[branchwiseclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(35) NULL,
    [Costcode] TINYINT NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CANNED_LEDGERBALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[CANNED_LEDGERBALANCE]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [LEDBAL] MONEY NULL,
    [ENTRYTYPE] INT NOT NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Category
-- --------------------------------------------------
CREATE TABLE [dbo].[Category]
(
    [Category] CHAR(35) NOT NULL,
    [Catcode] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.catmast
-- --------------------------------------------------
CREATE TABLE [dbo].[catmast]
(
    [Accat] CHAR(10) NOT NULL,
    [Catname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CBO_INT_DATEWISEBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[CBO_INT_DATEWISEBALANCES]
(
    [BALDATE] DATETIME NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [DAILYBAL] MONEY NOT NULL,
    [RUNNINGBAL] MONEY NOT NULL,
    [INT_PER] MONEY NOT NULL,
    [INT_AMT] MONEY NOT NULL,
    [CREATE_BY] VARCHAR(10) NOT NULL,
    [CREATE_DATE] DATETIME NOT NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CBO_INT_DATEWISEBALANCES_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[CBO_INT_DATEWISEBALANCES_TMP]
(
    [BALDATE] DATETIME NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [DAILYBAL] MONEY NOT NULL,
    [RUNNINGBAL] MONEY NOT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CBO_INT_DATEWISELOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CBO_INT_DATEWISELOG]
(
    [BALDATE] DATETIME NOT NULL,
    [DRINT] MONEY NOT NULL,
    [CRINT] MONEY NOT NULL,
    [CREATEBY] VARCHAR(20) NOT NULL,
    [CREATEDATE] DATETIME NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CBO_INT_POSTINGDETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[CBO_INT_POSTINGDETAILS]
(
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL,
    [BALDATE] DATETIME NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [POSTINGFLAG] VARCHAR(1) NOT NULL,
    [DAILYBAL] MONEY NOT NULL,
    [INT_PER] MONEY NOT NULL,
    [INT_AMT] MONEY NOT NULL,
    [VDT] DATETIME NOT NULL,
    [EDT] DATETIME NOT NULL,
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [BOOKTYPE] CHAR(2) NOT NULL,
    [CREATE_BY] VARCHAR(10) NOT NULL,
    [CREATE_DATE] DATETIME NOT NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cheque_detail_bank
-- --------------------------------------------------
CREATE TABLE [dbo].[cheque_detail_bank]
(
    [BankCode] VARCHAR(15) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(7) NULL,
    [ClientCode] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cheque_details
-- --------------------------------------------------
CREATE TABLE [dbo].[cheque_details]
(
    [Ch_Date] DATETIME NULL,
    [Party_code] VARCHAR(12) NULL,
    [DDNO] VARCHAR(30) NULL,
    [Bank] VARCHAR(35) NULL,
    [AccNo] VARCHAR(16) NULL,
    [Amt] MONEY NULL,
    [Created_By] VARCHAR(20) NULL,
    [Created_On] DATETIME NULL,
    [High_NonHigh] CHAR(1) NULL,
    [Bank_Code] VARCHAR(20) NULL,
    [Location] VARCHAR(30) NULL,
    [Entry_Date] DATETIME NULL,
    [SrNo] INT NULL,
    [Status_id] VARCHAR(10) NULL,
    [SLIPNO] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.chequeformats
-- --------------------------------------------------
CREATE TABLE [dbo].[chequeformats]
(
    [Bankstyle] VARCHAR(50) NOT NULL,
    [Formatcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(200) NULL,
    [IndexType] VARCHAR(18) NULL,
    [IndexColumns] NVARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableListing]
(
    [TableName] VARCHAR(50) NULL,
    [Description] VARCHAR(200) NULL,
    [StatusFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD]
(
    [FILE_DATA] VARCHAR(8000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_LOG]
(
    [FILE_PARAM] VARCHAR(1000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Clientsmargin
-- --------------------------------------------------
CREATE TABLE [dbo].[Clientsmargin]
(
    [Acname] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Exchange] VARCHAR(50) NULL,
    [Segment] VARCHAR(50) NULL,
    [Mcltcode] VARCHAR(10) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER_EOD_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER_EOD_STATUS]
(
    [EOD_STATUS] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER_REPORTS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER_REPORTS]
(
    [VNO] VARCHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [BookType] VARCHAR(3) NULL,
    [Debit_Amount] MONEY NULL,
    [Credit_Amount] MONEY NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [Narration] VARCHAR(500) NULL,
    [Cheque_No] VARCHAR(30) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(10) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [MarginCode] VARCHAR(10) NULL,
    [Entry_TYPE] TINYINT NULL,
    [Vdate] INT NULL,
    [Edate] INT NULL,
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chq_Printed] TINYINT NULL,
    [DD] CHAR(1) NULL,
    [Bank_Name] VARCHAR(100) NULL,
    [CROSS_ACC] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER_TRIG]
(
    [VNO] VARCHAR(12) NULL,
    [Vtyp] TINYINT NULL,
    [BookType] VARCHAR(3) NULL,
    [Updated_Date] DATETIME NULL,
    [Entry] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMS_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[CMS_TABLE]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [DEBIT_CREDIT] VARCHAR(1) NULL,
    [ENTRY_AMOUNT] MONEY NULL,
    [VALUE_DATE] DATETIME NULL,
    [PICKUP_LOCATION] VARCHAR(500) NULL,
    [PICKUP_DISC] VARCHAR(500) NULL,
    [PICKUP_DATE] DATETIME NULL,
    [DEPOSIT_SLIP] VARCHAR(10) NULL,
    [DEPOSIT_DATE] DATETIME NULL,
    [DEPOSIT_AMOUNT] MONEY NULL,
    [NO_OF_INST] VARCHAR(5) NULL,
    [INST_NO] VARCHAR(15) NULL,
    [DRAWEE_BANK] VARCHAR(500) NULL,
    [CLEAR_LOC] VARCHAR(500) NULL,
    [INST_AMOUNT] MONEY NULL,
    [INST_DATE] DATETIME NULL,
    [DRAWER_NAME] VARCHAR(500) NULL,
    [DRAWER_CODE] VARCHAR(10) NULL,
    [DRAWER_ACCNO] VARCHAR(20) NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [MICR_NO] INT NULL,
    [STATUS] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMSRECO
-- --------------------------------------------------
CREATE TABLE [dbo].[CMSRECO]
(
    [FILEHEADER_DATE] DATETIME NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [MICR_NO] INT NULL,
    [ENTRY_AMOUNT] MONEY NULL,
    [DEPOSIT_AMOUNT] MONEY NULL,
    [INST_AMOUNT] MONEY NULL,
    [STATUS_ID] VARCHAR(25) NULL,
    [STATUS_NAME] VARCHAR(25) NULL,
    [UPLOAD_BY] VARCHAR(25) NULL,
    [UPLOAD_DATE] DATETIME NULL,
    [AMOUNTMISMATCH] VARCHAR(5) NULL,
    [MANUALUPDATE] VARCHAR(5) NULL,
    [LEDGERAMOUNT] MONEY NULL,
    [CMS_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMSRECO_COMBINED
-- --------------------------------------------------
CREATE TABLE [dbo].[CMSRECO_COMBINED]
(
    [FILEHEADER_DATE] DATETIME NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [MICR_NO] INT NULL,
    [ENTRY_AMOUNT] MONEY NULL,
    [DEPOSIT_AMOUNT] MONEY NULL,
    [INST_AMOUNT] MONEY NULL,
    [STATUS_ID] VARCHAR(25) NULL,
    [STATUS_NAME] VARCHAR(25) NULL,
    [UPLOAD_BY] VARCHAR(25) NULL,
    [UPLOAD_DATE] DATETIME NULL,
    [AMOUNTMISMATCH] VARCHAR(5) NULL,
    [MANUALUPDATE] VARCHAR(5) NULL,
    [LEDGERAMOUNT] MONEY NULL,
    [CMS_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMSRECODETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[CMSRECODETAILS]
(
    [FILEHEADER_DATE] DATETIME NULL,
    [ROW_TYPE] VARCHAR(2) NULL,
    [ENTRY_ID] VARCHAR(12) NULL,
    [ENTRY_TYPE] VARCHAR(1) NULL,
    [DEBIT_CREDIT] VARCHAR(1) NULL,
    [ENTRY_AMOUNT] MONEY NULL,
    [VALUE_DATE] DATETIME NULL,
    [POST_DATE] DATETIME NULL,
    [PROD_CODE] VARCHAR(10) NULL,
    [PICKUP_LOCATION] VARCHAR(500) NULL,
    [PICKUP_DISC] VARCHAR(500) NULL,
    [PICKUP_DATE] DATETIME NULL,
    [DEPOSIT_SLIP] VARCHAR(10) NULL,
    [DEPOSIT_DATE] DATETIME NULL,
    [DEPOSIT_AMOUNT] MONEY NULL,
    [NO_OF_INST] VARCHAR(5) NULL,
    [DEPOSIT_REMARK] VARCHAR(500) NULL,
    [INST_NO] VARCHAR(30) NULL,
    [DRAWEE_BANK] VARCHAR(500) NULL,
    [CLEAR_LOC] VARCHAR(500) NULL,
    [INST_AMOUNT] MONEY NULL,
    [INST_DATE] DATETIME NULL,
    [DRAWER_NAME] VARCHAR(500) NULL,
    [ENRICHMENT_NO] VARCHAR(20) NULL,
    [ENRICHMENT_DATE] VARCHAR(10) NULL,
    [ENRICHMENT_REMARKS] VARCHAR(500) NULL,
    [FILLER] VARCHAR(57) NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [MICR_NO] INT NULL,
    [STATUS_ID] VARCHAR(25) NULL,
    [STATUS_NAME] VARCHAR(50) NULL,
    [UPLOAD_BY] VARCHAR(25) NULL,
    [UPLOAD_DATE] DATETIME NULL,
    [STATUS] VARCHAR(25) NULL,
    [LEDGERAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMSRECODETAILS_COMBINED
-- --------------------------------------------------
CREATE TABLE [dbo].[CMSRECODETAILS_COMBINED]
(
    [FILEHEADER_DATE] DATETIME NULL,
    [ROW_TYPE] VARCHAR(2) NULL,
    [ENTRY_ID] VARCHAR(12) NULL,
    [ENTRY_TYPE] VARCHAR(1) NULL,
    [DEBIT_CREDIT] VARCHAR(1) NULL,
    [ENTRY_AMOUNT] MONEY NULL,
    [VALUE_DATE] DATETIME NULL,
    [POST_DATE] DATETIME NULL,
    [PROD_CODE] VARCHAR(10) NULL,
    [PICKUP_LOCATION] VARCHAR(500) NULL,
    [PICKUP_DISC] VARCHAR(500) NULL,
    [PICKUP_DATE] DATETIME NULL,
    [DEPOSIT_SLIP] VARCHAR(10) NULL,
    [DEPOSIT_DATE] DATETIME NULL,
    [DEPOSIT_AMOUNT] MONEY NULL,
    [NO_OF_INST] VARCHAR(5) NULL,
    [DEPOSIT_REMARK] VARCHAR(500) NULL,
    [INST_NO] VARCHAR(15) NULL,
    [DRAWEE_BANK] VARCHAR(500) NULL,
    [CLEAR_LOC] VARCHAR(500) NULL,
    [INST_AMOUNT] MONEY NULL,
    [INST_DATE] DATETIME NULL,
    [DRAWER_NAME] VARCHAR(500) NULL,
    [DRAWER_CODE] VARCHAR(10) NULL,
    [DRAWER_ACCNO] VARCHAR(20) NULL,
    [ENRICHMENT_REMARKS] VARCHAR(500) NULL,
    [FILLER] VARCHAR(57) NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [MICR_NO] INT NULL,
    [STATUS_ID] VARCHAR(25) NULL,
    [STATUS_NAME] VARCHAR(50) NULL,
    [UPLOAD_BY] VARCHAR(25) NULL,
    [UPLOAD_DATE] DATETIME NULL,
    [STATUS] VARCHAR(25) NULL,
    [LEDGERAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Costmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Costmast]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.creditors
-- --------------------------------------------------
CREATE TABLE [dbo].[creditors]
(
    [Cltcode] NVARCHAR(10) NOT NULL,
    [L_address1] NVARCHAR(40) NULL,
    [L_address2] NVARCHAR(40) NULL,
    [L_address3] NVARCHAR(40) NULL,
    [L_city] NVARCHAR(20) NULL,
    [L_state] NVARCHAR(15) NULL,
    [L_nation] NVARCHAR(15) NULL,
    [L_zip] NVARCHAR(10) NULL,
    [Fax] NVARCHAR(15) NULL,
    [Off_phone1] NVARCHAR(15) NULL,
    [Off_phone2] NVARCHAR(15) NULL,
    [Email] NVARCHAR(50) NULL,
    [Mobile_pager] NVARCHAR(40) NULL,
    [Regsupplier] TINYINT NULL,
    [Cstno] NVARCHAR(40) NULL,
    [Sstno] NVARCHAR(40) NULL,
    [Omsflag] TINYINT NULL,
    [Crlimit] MONEY NULL,
    [Crdays] TINYINT NULL,
    [Pan_no] VARCHAR(50) NULL,
    [Servicetax_no] VARCHAR(50) NULL,
    [Tds_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DIAG_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[DIAG_LOG]
(
    [ACTIONDATE] DATETIME NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [USERNAME] VARCHAR(25) NULL,
    [OPTIONS] VARCHAR(100) NULL,
    [PERIOD] VARCHAR(30) NULL,
    [RESULT] VARCHAR(2000) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [PROCID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DIAG_RESULT
-- --------------------------------------------------
CREATE TABLE [dbo].[DIAG_RESULT]
(
    [RESULT] VARCHAR(2000) NULL,
    [PROCID] INT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.edtclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[edtclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(35) NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ERROR_TBL
-- --------------------------------------------------
CREATE TABLE [dbo].[ERROR_TBL]
(
    [ERR_ID] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Errvouchers
-- --------------------------------------------------
CREATE TABLE [dbo].[Errvouchers]
(
    [Cdt] DATETIME NULL,
    [Errstr] VARCHAR(300) NULL,
    [Statusid] VARCHAR(30) NULL,
    [Statusname] VARCHAR(30) NULL,
    [Username] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE_OUTPUT
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE_OUTPUT]
(
    [PROCID] INT NULL,
    [CSVFILE] VARCHAR(200) NULL,
    [CONTENTS] VARCHAR(2000) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILELOG
-- --------------------------------------------------
CREATE TABLE [dbo].[FILELOG]
(
    [FIELD1] VARCHAR(25) NULL,
    [FIELD2] VARCHAR(25) NULL,
    [FIELD3] VARCHAR(25) NULL,
    [FIELD4] VARCHAR(25) NULL,
    [FIELD5] VARCHAR(25) NULL,
    [FIELD6] VARCHAR(200) NULL,
    [FIELD7] VARCHAR(100) NULL,
    [FIELD8] VARCHAR(25) NULL,
    [FIELD9] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FNOLEDBAL
-- --------------------------------------------------
CREATE TABLE [dbo].[FNOLEDBAL]
(
    [CLTCODE] VARCHAR(10) NULL,
    [FNO_TOTALBAL] MONEY NULL,
    [FNO_LEDBAL] MONEY NULL,
    [FNO_COLLATERAL] MONEY NULL,
    [FNO_MARGIN] MONEY NULL,
    [MARGIN_DATE] DATETIME NULL,
    [SPANMARGIN] MONEY NULL,
    [EXPOSUREMARGIN] MONEY NULL,
    [CASH] MONEY NULL,
    [NONCASH] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER_PARENT
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER_PARENT]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [PARENT_CODE] VARCHAR(10) NULL,
    [PARENT_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESSCODE] VARCHAR(10) NULL,
    [PROCESSNAME] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [FORMULANAME] VARCHAR(MAX) NULL,
    [COMPAREWITH] VARCHAR(20) NULL,
    [COMPARISON] VARCHAR(10) NULL,
    [TR_TYPE] TINYINT NULL,
    [DBTYPE] VARCHAR(30) NULL,
    [ADDITIONAL_PARAMETERS] VARCHAR(1000) NULL,
    [FORMULA_FIELDS] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[grpmast]
(
    [Grpname] VARCHAR(60) NULL,
    [Grpmain] VARCHAR(13) NULL,
    [Grpcode] VARCHAR(13) NULL,
    [Vtyp] FLOAT NULL,
    [Dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IMPORT_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[IMPORT_TABLE]
(
    [RECNO] INT NULL,
    [TXNDT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [CHEQUENO] VARCHAR(30) NULL,
    [DRCR] VARCHAR(2) NULL,
    [TXNAMOUNT] MONEY NULL,
    [BALAMOUNT] MONEY NULL,
    [BANKCODE] VARCHAR(20) NULL,
    [STATUS] CHAR(3) NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastchequeno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastchequeno]
(
    [Bankcode] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Ddno] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastvno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastvno]
(
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NOT NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NOT NULL,
    [Acname] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(500) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_JRNL
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_JRNL]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [sno] BIGINT IDENTITY(1,1) NOT NULL,
    [UPDDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [optcode] CHAR(1) NULL,
    [Editdate] DATETIME NULL,
    [EditName] VARCHAR(15) NULL,
    [Status] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Report
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Report]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] NUMERIC(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [SNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRIG]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger1]
(
    [Bnkname] VARCHAR(50) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_log]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_MANUALRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_MANUALRECO_LOG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger2]
(
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Camt] MONEY NULL,
    [Costcode] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger2_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger2_log]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3]
(
    [Naratno] INT NOT NULL,
    [Narr] VARCHAR(500) NULL,
    [Refno] CHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3_log]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledgerbalances
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledgerbalances]
(
    [Familycode] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [Nsebalance] MONEY NULL,
    [Bsebalance] MONEY NULL,
    [Nsefobalance] MONEY NULL,
    [Nseestimated1] MONEY NULL,
    [Nseestimated2] MONEY NULL,
    [Bseestimated1] MONEY NULL,
    [Bseestimated2] MONEY NULL,
    [Faactual] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Marginledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Marginledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Mcltcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marginledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[marginledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NULL,
    [MCltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Matchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Matchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Lvtype] SMALLINT NULL,
    [Lvno] VARCHAR(12) NULL,
    [Llno] DECIMAL(4, 0) NULL,
    [Lbooktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.matchdetails_log
-- --------------------------------------------------
CREATE TABLE [dbo].[matchdetails_log]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MoneyPayin_Mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[MoneyPayin_Mismatch]
(
    [CONSTANT] VARCHAR(1) NULL,
    [BANK_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(50) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [AMOUNT] MONEY NULL,
    [Nnull] VARCHAR(4) NULL,
    [VOUCHER_DATE] VARCHAR(20) NULL,
    [SERIAL_NO] INT NULL,
    [REF_NO] VARCHAR(15) NULL,
    [DEFAULT_VAL] INT NULL,
    [BANK_NAME] VARCHAR(100) NULL,
    [BRANCH_NAME] VARCHAR(50) NULL,
    [DEPOSIT_SLIP_NO] VARCHAR(7) NULL,
    [DRCR] VARCHAR(1) NULL,
    [BRANCHCODE] VARCHAR(20) NULL,
    [CHQ_MODE] VARCHAR(1) NULL,
    [CHQ_DATE] VARCHAR(20) NULL,
    [CHQ_NAME] VARCHAR(100) NULL,
    [CL_MODE] VARCHAR(1) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [VDT] DATETIME NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [EDT] DATETIME NULL,
    [DDDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [COSTCODE] SMALLINT NULL,
    [BANKCOST] SMALLINT NULL,
    [LNO] SMALLINT NOT NULL DEFAULT 0,
    [BANKNAME] VARCHAR(100) NULL,
    [MICRNO] INT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [STATUS_FLAG] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MPI_PayIn
-- --------------------------------------------------
CREATE TABLE [dbo].[MPI_PayIn]
(
    [BranchCode] VARCHAR(10) NOT NULL,
    [PartyCode] VARCHAR(10) NOT NULL,
    [BankCode] VARCHAR(10) NOT NULL,
    [BankAC] VARCHAR(16) NOT NULL,
    [BankName] VARCHAR(50) NOT NULL,
    [ACOwner] CHAR(1) NOT NULL,
    [ACType] CHAR(2) NOT NULL,
    [LongName] VARCHAR(100) NOT NULL,
    [HOCltCode] VARCHAR(10) NOT NULL,
    [HOGlCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multibankid
-- --------------------------------------------------
CREATE TABLE [dbo].[multibankid]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NULL,
    [Chequename] VARCHAR(100) NULL,
    [Defaultbank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multibankid_back
-- --------------------------------------------------
CREATE TABLE [dbo].[multibankid_back]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(16) NOT NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIBANKID_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIBANKID_LOG]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(16) NOT NULL,
    [Accno] VARCHAR(16) NOT NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL,
    [editChequename] VARCHAR(100) NOT NULL,
    [editDefaultbank] CHAR(1) NOT NULL,
    [status] VARCHAR(100) NULL,
    [EditedBy] VARCHAR(20) NULL,
    [EditedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEWPARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[NEWPARTYLEDGER]
(
    [BRANCH_CODE] VARCHAR(11) NULL,
    [BRANCH] VARCHAR(40) NULL,
    [CLTCODE] VARCHAR(11) NULL,
    [ACNAME] VARCHAR(50) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [PARTY] VARCHAR(10) NULL,
    [VAMT] MONEY NULL DEFAULT 0,
    [MAMT] MONEY NULL DEFAULT 0,
    [UNREALISED] MONEY NULL DEFAULT 0,
    [SPID] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEWPARTYLEDGER1
-- --------------------------------------------------
CREATE TABLE [dbo].[NEWPARTYLEDGER1]
(
    [BRANCH_CODE] VARCHAR(11) NULL,
    [BRANCH] VARCHAR(40) NULL,
    [CLTCODE] VARCHAR(11) NULL,
    [ACNAME] VARCHAR(50) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [PARTY] VARCHAR(10) NULL,
    [NSEVAMT] MONEY NOT NULL DEFAULT 0,
    [BSEVAMT] MONEY NOT NULL DEFAULT 0,
    [NFOVAMT] MONEY NOT NULL DEFAULT 0,
    [NSEMAMT] MONEY NOT NULL DEFAULT 0,
    [BSEMAMT] MONEY NOT NULL DEFAULT 0,
    [NFOMAMT] MONEY NOT NULL DEFAULT 0,
    [NSEUNREALISED] MONEY NOT NULL DEFAULT 0,
    [BSEUNREALISED] MONEY NOT NULL DEFAULT 0,
    [NFOUNREALISED] MONEY NOT NULL DEFAULT 0,
    [NSEHTOTAL] MONEY NOT NULL DEFAULT 0,
    [BSEHTOTAL] MONEY NOT NULL DEFAULT 0,
    [NFOHTOTAL] MONEY NOT NULL DEFAULT 0,
    [VAMT] MONEY NOT NULL DEFAULT 0,
    [MAMT] MONEY NOT NULL DEFAULT 0,
    [UNREALISED] MONEY NOT NULL DEFAULT 0,
    [HTOTAL] MONEY NOT NULL DEFAULT 0,
    [SPID] INT NULL,
    [SESSIONID] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFLINE_RCPTUPLOAD_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFLINE_RCPTUPLOAD_TABLE]
(
    [vdt] DATETIME NULL,
    [edt] DATETIME NULL,
    [acCode] VARCHAR(50) NULL,
    [amt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [bnkcode] VARCHAR(10) NULL,
    [bnkname] VARCHAR(50) NULL,
    [ddno] VARCHAR(30) NULL,
    [brccode] VARCHAR(25) NULL,
    [narration] VARCHAR(500) NULL,
    [srno] INT NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [BRANCHCODE] VARCHAR(50) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [TPACCOUNTNUMBER] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [VoucherNo] VARCHAR(12) NULL,
    [ClientName] VARCHAR(100) NULL,
    [OppCodeName] VARCHAR(100) NULL,
    [ADDBY] VARCHAR(25) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Offline_RecPay_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[Offline_RecPay_Table]
(
    [EDATE] VARCHAR(20) NULL,
    [VOUCHER_DATE] VARCHAR(20) NULL,
    [CLIENT_CODE] VARCHAR(50) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SERIAL_NO] INT NULL,
    [SNO] INT NOT NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [VDT] DATETIME NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [COSTCODE] SMALLINT NULL,
    [CASHBRANCH] VARCHAR(100) NULL,
    [CASHCOST] SMALLINT NULL,
    [LNO] SMALLINT NOT NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.opencltcode
-- --------------------------------------------------
CREATE TABLE [dbo].[opencltcode]
(
    [Acname] VARCHAR(100) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Branch] VARCHAR(35) NULL,
    [Status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner]
(
    [Companyname] VARCHAR(80) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Sharedb] VARCHAR(10) NOT NULL,
    [Accountdb] VARCHAR(12) NULL,
    [Clientgroup] VARCHAR(35) NULL,
    [Balsign] TINYINT NULL,
    [Conpath] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Membertype] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [RecoFlag] CHAR(1) NOT NULL DEFAULT 'Y',
    [MULTI_MARGIN] CHAR(1) NULL DEFAULT 'N',
    [ActiveDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner_16Jul2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner_16Jul2018]
(
    [Companyname] VARCHAR(50) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Sharedb] VARCHAR(10) NOT NULL,
    [Accountdb] VARCHAR(12) NULL,
    [Clientgroup] VARCHAR(35) NULL,
    [Balsign] TINYINT NULL,
    [Conpath] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Membertype] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [RecoFlag] CHAR(1) NOT NULL,
    [MULTI_MARGIN] CHAR(1) NULL,
    [ActiveDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner_Bkup_09Jun22
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner_Bkup_09Jun22]
(
    [Companyname] VARCHAR(80) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Sharedb] VARCHAR(10) NOT NULL,
    [Accountdb] VARCHAR(12) NULL,
    [Clientgroup] VARCHAR(35) NULL,
    [Balsign] TINYINT NULL,
    [Conpath] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Membertype] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [RecoFlag] CHAR(1) NOT NULL,
    [MULTI_MARGIN] CHAR(1) NULL,
    [ActiveDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[Parameter]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Parameter_12062018
-- --------------------------------------------------
CREATE TABLE [dbo].[Parameter_12062018]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Payadv
-- --------------------------------------------------
CREATE TABLE [dbo].[Payadv]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] CHAR(100) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [Chequeno] VARCHAR(15) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Narration] VARCHAR(234) NULL,
    [Printedflag] TINYINT NULL,
    [Actamt] MONEY NULL,
    [Shortage] MONEY NULL,
    [Vtyp] SMALLINT NOT NULL DEFAULT 3,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Paymentmarking
-- --------------------------------------------------
CREATE TABLE [dbo].[Paymentmarking]
(
    [Paymentdate] DATETIME NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Defbtobpayment] CHAR(1) NULL,
    [Defpaymode] CHAR(1) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [Amounttobepaid] MONEY NULL,
    [Actualamoutpaid] MONEY NULL,
    [Instrumentno] INT NULL,
    [Paymarkflag] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Vno] VARCHAR(12) NULL,
    [Remark] VARCHAR(50) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Vtyp] VARCHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Approvedby] VARCHAR(15) NULL,
    [Hoapproval] INT NULL,
    [Approvedon] DATETIME NULL,
    [Chequeno] VARCHAR(12) NULL,
    [Chequeprinted] INT NULL,
    [SNO] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayOut_GlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[PayOut_GlobalParams]
(
    [ReqTime] INT NOT NULL,
    [AppTime] INT NOT NULL,
    [MinPayout] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLDetail
-- --------------------------------------------------
CREATE TABLE [dbo].[PLDetail]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Vtype] INT NULL,
    [Setttype] VARCHAR(3) NULL,
    [Narration] VARCHAR(25) NULL,
    [ReportURL] VARCHAR(250) NULL,
    [Flag] CHAR(1) NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLgroup_mstr
-- --------------------------------------------------
CREATE TABLE [dbo].[PLgroup_mstr]
(
    [Group_Code] VARCHAR(13) NULL,
    [Group_Name] VARCHAR(60) NULL,
    [Main_group] VARCHAR(13) NULL,
    [Amount] NUMERIC(18, 4) NULL,
    [type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PostBillLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[PostBillLedger]
(
    [VTYP] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [EDT] DATETIME NULL,
    [LNO] INT IDENTITY(1,1) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] VARCHAR(1) NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SNO] BIGINT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BILL_NO] INT NULL,
    [ACCAT] CHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[POSTBILLLEDGER2]
(
    [DRCR] CHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECOPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECOPROCESS]
(
    [INPROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[Selection_Levels_PartyLedger]
(
    [Level_No] SMALLINT NULL,
    [Level_Name] VARCHAR(20) NULL,
    [Enable_Flg] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SELECTION_QUERIES_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[SELECTION_QUERIES_TABLE]
(
    [SRNO] SMALLINT NOT NULL,
    [STATUSID] VARCHAR(15) NOT NULL,
    [SELECTON] VARCHAR(15) NOT NULL,
    [SELECTIONQUERY] VARCHAR(500) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SettPayout
-- --------------------------------------------------
CREATE TABLE [dbo].[SettPayout]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [BranchCode] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [BankCode] VARCHAR(10) NULL,
    [BillAmt] MONEY NULL,
    [LedgerBalNSE] MONEY NULL,
    [LedgerBalBSE] MONEY NULL,
    [LedgerBalFNO] MONEY NULL,
    [DueAmt] MONEY NULL,
    [RequestedAmt] MONEY NULL,
    [Amounttobepaid] MONEY NULL,
    [Narration] VARCHAR(234) NULL,
    [SettType] VARCHAR(3) NULL,
    [SettNo] VARCHAR(7) NULL,
    [RequestDt] DATETIME NULL,
    [UserId] VARCHAR(50) NULL,
    [Status] CHAR(1) NULL,
    [SessionId] VARCHAR(50) NULL,
    [Remark] VARCHAR(234) NULL,
    [ApprovedDt] DATETIME NULL,
    [HOPaymode] VARCHAR(25) NULL,
    [Vno] VARCHAR(12) NULL,
    [ChequeNo] VARCHAR(15) NULL,
    [edt] DATETIME NULL,
    [vdt] DATETIME NULL,
    [GenFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stalecheque_Vlog
-- --------------------------------------------------
CREATE TABLE [dbo].[stalecheque_Vlog]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [BPVNO] VARCHAR(12) NULL,
    [BPBOOKTYPE] VARCHAR(3) NULL,
    [BPVTYPE] INT NULL,
    [BPVDT] VARCHAR(11) NULL,
    [BRVNO] VARCHAR(12) NULL,
    [BRBOOKTYPE] VARCHAR(3) NULL,
    [BRVTYPE] INT NULL,
    [BrVDT] VARCHAR(11) NULL,
    [CLTCODE] VARCHAR(12) NULL,
    [LAVNO] VARCHAR(12) NULL,
    [LAVTYPE] INT NULL,
    [LAVBOOKTYPE] VARCHAR(3) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [VAMT] MONEY NULL,
    [NARRATION] VARCHAR(250) NULL,
    [DDNO] VARCHAR(30) NULL,
    [DDDT] VARCHAR(11) NULL,
    [BANKCODE] VARCHAR(12) NULL,
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [MICRNO] INT NULL,
    [REMARK] VARCHAR(10) NULL,
    [STATUS] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [StatusId] VARCHAR(25) NULL,
    [ReportName] VARCHAR(200) NULL,
    [SummaryOpt] VARCHAR(1) NULL,
    [CallingSP] VARCHAR(100) NULL,
    [ReturnFields] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER_ALL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER_ALL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STATUSID] VARCHAR(10) NULL,
    [REPORTNAME] VARCHAR(20) NULL,
    [SUMMARYOPT] VARCHAR(1) NULL,
    [CALLINGSP] VARCHAR(200) NULL,
    [FIRSTPART] VARCHAR(200) NULL,
    [NSEPART] VARCHAR(500) NULL,
    [BSEPART] VARCHAR(500) NULL,
    [NSEFOPART] VARCHAR(500) NULL,
    [NCXPART] VARCHAR(500) NULL,
    [MCXPART] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER_new
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER_new]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [StatusId] VARCHAR(25) NULL,
    [ReportName] VARCHAR(200) NULL,
    [SummaryOpt] VARCHAR(1) NULL,
    [CallingSP] VARCHAR(100) NULL,
    [ReturnFields] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_OppBalance]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [cltCode] VARCHAR(10) NULL,
    [OppBal] MONEY NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_REPORT_INTEREST_MARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_REPORT_INTEREST_MARGIN]
(
    [CltCode] VARCHAR(10) NULL,
    [BalanceDate] DATETIME NULL,
    [Vamt] MONEY NULL,
    [Balance] MONEY NULL,
    [Interest] MONEY NULL,
    [Mamt] MONEY NULL,
    [MBalance] MONEY NULL,
    [MInterest] MONEY NULL,
    [IntRateCr] MONEY NULL,
    [IntRateDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_RPTDATE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_RPTDATE]
(
    [Rpt_Date] DATETIME NULL,
    [ProgId] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_NONCMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_NONCMS_DATA]
(
    [SRNONCMS] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(150) NULL,
    [LEDGERBALANCE] NVARCHAR(50) NULL,
    [DRCR] NVARCHAR(50) NULL,
    [AMT] DECIMAL(20, 2) NULL,
    [VALUEDATE] NVARCHAR(50) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(150) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(200) NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL,
    [CLOSINGBALANCE] DECIMAL(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tempbilldetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Tempbilldetails]
(
    [Exchange] CHAR(10) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Sett_no] VARCHAR(25) NULL,
    [Sett_type] CHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [Billamount] MONEY NULL,
    [Balamt] MONEY NULL,
    [Payamount] MONEY NULL,
    [Sessionid] VARCHAR(50) NULL,
    [Rowid] DECIMAL(4, 0) NULL,
    [Billlno] DECIMAL(4, 0) NULL,
    [Date] DATETIME NULL,
    [Description] VARCHAR(20) NULL,
    [Billbooktype] CHAR(2) NULL,
    [Billvtype] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Vtype] VARCHAR(50) NULL,
    [Billvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Templedger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Templedger2]
(
    [Category] VARCHAR(20) NULL,
    [Branch] VARCHAR(25) NULL,
    [Paidamt] MONEY NULL,
    [Vtype] VARCHAR(2) NULL,
    [Vno] VARCHAR(25) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Costcode] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Sessionid] VARCHAR(15) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Costflag] CHAR(1) NULL,
    [Rowid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMPTBL
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMPTBL]
(
    [CLTCODE] VARCHAR(10) NULL,
    [DRTOT] MONEY NULL,
    [CRTOT] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [ACNAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [ACCAT] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.THIRDPARTY_COLLECTION
-- --------------------------------------------------
CREATE TABLE [dbo].[THIRDPARTY_COLLECTION]
(
    [TPR_SNO] INT IDENTITY(1,1) NOT NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [AMOUNT] MONEY NULL,
    [VDT] DATETIME NULL,
    [DDNO] VARCHAR(30) NULL,
    [ACCOUNT_NO] VARCHAR(25) NULL,
    [TPR_FLAG] CHAR(1) NULL,
    [UPD_FLAG] CHAR(1) NULL,
    [ENTERED_BY] VARCHAR(25) NULL,
    [ENTERED_DATE] DATETIME NULL,
    [MODIFY_BY] VARCHAR(25) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [VNO_JV] VARCHAR(12) NULL,
    [VNO_RJV] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Userwritestable
-- --------------------------------------------------
CREATE TABLE [dbo].[Userwritestable]
(
    [Usercategory] VARCHAR(50) NULL,
    [Userstatusid] VARCHAR(25) NULL,
    [Vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Nodays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_ACCOUNTBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_ACCOUNTBALANCES]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [LEDTYPE] SMALLINT NOT NULL,
    [VDT] INT NOT NULL,
    [EDT] INT NOT NULL,
    [BALDR] MONEY NOT NULL,
    [BALCR] MONEY NOT NULL,
    [OPBALDR] MONEY NOT NULL,
    [OPBALCR] MONEY NOT NULL,
    [BILLSDR] MONEY NOT NULL,
    [BILLSCR] MONEY NOT NULL,
    [INSBILLSDR] MONEY NOT NULL,
    [INSBILLSCR] MONEY NOT NULL,
    [PAYBANK] MONEY NOT NULL,
    [RECBANK] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGBUCKETS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGBUCKETS]
(
    [BUCKET_1] INT NOT NULL,
    [BUCKET_2] INT NOT NULL,
    [BUCKET_3] INT NOT NULL,
    [BUCKET_4] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGBUCKETS_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGBUCKETS_TMP]
(
    [BUCKET_1] INT NOT NULL,
    [BUCKET_2] INT NOT NULL,
    [BUCKET_3] INT NOT NULL,
    [BUCKET_4] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGDATA]
(
    [BALDATE] INT NOT NULL,
    [BALDATETYPE] INT NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [BALANCE] MONEY NOT NULL,
    [BUCKET_1] MONEY NOT NULL,
    [BUCKET_2] MONEY NOT NULL,
    [BUCKET_3] MONEY NOT NULL,
    [BUCKET_4] MONEY NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGDATA_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGDATA_TMP]
(
    [BALDATETYPE] INT NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [BALANCE] MONEY NOT NULL,
    [BUCKET_1] MONEY NOT NULL,
    [BUCKET_2] MONEY NOT NULL,
    [BUCKET_3] MONEY NOT NULL,
    [BUCKET_4] MONEY NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_AGEINGFINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_AGEINGFINAL]
(
    [BALDATE] INT NOT NULL,
    [BALDATETYPE] INT NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [SEGMENTCODE] INT NOT NULL,
    [BALANCE] MONEY NOT NULL,
    [BUCKET_1] MONEY NOT NULL,
    [BUCKET_2] MONEY NOT NULL,
    [BUCKET_3] MONEY NOT NULL,
    [BUCKET_4] MONEY NOT NULL,
    [BUCKET_5] MONEY NOT NULL,
    [UPDATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CHEQUEPRINT_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CHEQUEPRINT_SETTING]
(
    [CHQ_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CHQ_CODE] VARCHAR(30) NULL,
    [CHQ_DESC] VARCHAR(500) NULL,
    [CHQ_XPOS] DECIMAL(10, 0) NULL,
    [CHQ_YPOS] DECIMAL(18, 0) NULL,
    [CHQ_WIDTH] DECIMAL(10, 0) NULL,
    [CHQ_ALIGN] CHAR(1) NULL,
    [CHQ_PRINTFLAG] SMALLINT NULL,
    [CHQ_ROUNDING] TINYINT NULL,
    [CHQ_TYPE] VARCHAR(10) NOT NULL,
    [CHQ_PRINTFORMAT] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CHQPRINT_FORMAT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CHQPRINT_FORMAT]
(
    [CHQ_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CHQ_BANKNAME] VARCHAR(50) NULL,
    [CHQ_BANKFORMAT] INT NOT NULL DEFAULT 'A',
    [CHQ_EXCHANGE] VARCHAR(3) NULL,
    [CHQ_SEGMENT] VARCHAR(20) NULL,
    [CHQ_INSTNO] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CHQPRINT_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CHQPRINT_SETTING]
(
    [CHQ_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CHQ_CODE] VARCHAR(30) NULL,
    [CHQ_DESC] VARCHAR(500) NULL,
    [CHQ_XPOS] DECIMAL(10, 0) NULL,
    [CHQ_YPOS] DECIMAL(18, 0) NULL,
    [CHQ_WIDTH] DECIMAL(10, 0) NULL,
    [CHQ_ALIGN] CHAR(1) NULL,
    [CHQ_PRINTFLAG] SMALLINT NULL,
    [CHQ_ROUNDING] TINYINT NULL,
    [CHQ_TYPE] VARCHAR(10) NOT NULL,
    [CHQ_PRINTFORMAT] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLIENTPROFILES_FA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLIENTPROFILES_FA]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [CREDIT_INT] MONEY NOT NULL,
    [DEBIT_INT] MONEY NOT NULL,
    [FROMDATE] SMALLDATETIME NOT NULL,
    [TODATE] SMALLDATETIME NOT NULL,
    [SPAN_MARGIN] INT NOT NULL,
    [EXPOSURE_MARGIN] INT NOT NULL,
    [SPAN_MARGIN_MARKUP] INT NULL,
    [EXPOSURE_MARGIN_MARKUP] INT NULL,
    [ADHOC_MARGIN_MARKUP] INT NULL,
    [CREATEDATE] DATETIME NOT NULL,
    [CREATEBY] VARCHAR(20) NOT NULL,
    [UPDATEDATE] DATETIME NULL,
    [UPDATEBY] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_FOUT_LEDGERBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_FOUT_LEDGERBALANCES]
(
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Family_Code] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Branch_Name] VARCHAR(40) NULL,
    [Trader] VARCHAR(20) NULL,
    [Trader_Name] VARCHAR(50) NULL,
    [SubBroker_Code] VARCHAR(10) NULL,
    [SubBroker_Name] VARCHAR(25) NULL,
    [Area_Code] VARCHAR(20) NULL,
    [Area_Name] VARCHAR(50) NULL,
    [Region_Code] VARCHAR(50) NULL,
    [Region_Name] VARCHAR(50) NULL,
    [Res_Phone] VARCHAR(15) NULL,
    [NSEBALANCE] MONEY NULL,
    [BSEBALANCE] MONEY NULL,
    [NSEFOBALANCE] MONEY NULL,
    [NSXCURBALANCE] MONEY NULL,
    [MCXCURBALANCE] MONEY NULL,
    [NSEESTIMATED1] MONEY NULL,
    [NSEESTIMATED2] MONEY NULL,
    [BSEESTIMATED1] MONEY NULL,
    [BSEESTIMATED2] MONEY NULL,
    [FAActual] MONEY NULL,
    [NonCash] MONEY NULL,
    [Cash] MONEY NULL,
    [IMMargin] MONEY NULL,
    [VarMargin] MONEY NULL,
    [RepDate] DATETIME NULL,
    [BEN_HOLDING] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_FOUT_LEDGERBALANCES_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_FOUT_LEDGERBALANCES_TEMP]
(
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Family_Code] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Branch_Name] VARCHAR(40) NULL,
    [Trader] VARCHAR(20) NULL,
    [Trader_Name] VARCHAR(50) NULL,
    [SubBroker_Code] VARCHAR(10) NULL,
    [SubBroker_Name] VARCHAR(25) NULL,
    [Area_Code] VARCHAR(20) NULL,
    [Area_Name] VARCHAR(50) NULL,
    [Region_Code] VARCHAR(50) NULL,
    [Region_Name] VARCHAR(50) NULL,
    [Res_Phone] VARCHAR(15) NULL,
    [NSEBALANCE] MONEY NULL,
    [BSEBALANCE] MONEY NULL,
    [NSEFOBALANCE] MONEY NULL,
    [NSXCURBALANCE] MONEY NULL,
    [MCXCURBALANCE] MONEY NULL,
    [NSEESTIMATED1] MONEY NULL,
    [NSEESTIMATED2] MONEY NULL,
    [BSEESTIMATED1] MONEY NULL,
    [BSEESTIMATED2] MONEY NULL,
    [FAActual] MONEY NULL,
    [NonCash] MONEY NULL,
    [Cash] MONEY NULL,
    [IMMargin] MONEY NULL,
    [VarMargin] MONEY NULL,
    [RepDate] DATETIME NULL,
    [BEN_HOLDING] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_FT_COMPUTEBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_FT_COMPUTEBALANCES]
(
    [CLTCODE] VARCHAR(10) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [LEDGER_TYPE] VARCHAR(10) NULL,
    [VTYPE] INT NULL,
    [FINAL_LEDGER_AMOUNT] MONEY NULL,
    [FINAL_MARGIN_AMOUNT] MONEY NULL,
    [LEDGER_AMOUNT] MONEY NULL,
    [MARGIN_AMOUNT] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [MARGIN_USAGE_AMOUNT] MONEY NULL,
    [MARGIN_REQ] MONEY NULL,
    [ENTRY_TYPE] SMALLINT NULL,
    [SOURCE_VNO] VARCHAR(12) NULL,
    [TARGET_VNO] VARCHAR(12) NULL,
    [LNO] INT NULL,
    [NARRATION] VARCHAR(250) NULL,
    [BTOBPAYMENT] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INTEREST
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INTEREST]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NULL,
    [LEDTYPE] INT NULL,
    [VDTBAL] MONEY NULL,
    [VDTINTEREST] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [EDTINTEREST] MONEY NULL,
    [INTDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INTEREST_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INTEREST_BAK]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NULL,
    [LEDTYPE] INT NULL,
    [VDTBAL] MONEY NULL,
    [VDTINTEREST] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [EDTINTEREST] MONEY NULL,
    [INTDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INTEREST_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INTEREST_NEW]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NULL,
    [LEDTYPE] INT NULL,
    [VDTBAL] MONEY NULL,
    [VDTINTEREST] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [EDTINTEREST] MONEY NULL,
    [INTDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LastVno
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LastVno]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL,
    [VnoFlag] TINYINT NULL,
    [FinYear] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LEDGERBALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LEDGERBALANCE]
(
    [PARTYCODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [CHEQUENAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [BTOBPAYMENT] INT NULL,
    [TOTLEDBAL] MONEY NULL,
    [NSELEDBAL] MONEY NULL,
    [BSELEDBAL] MONEY NULL,
    [FNOLEDBAL] MONEY NULL,
    [NETLEDBAL] MONEY NULL,
    [FAMLEDBAL] MONEY NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [NORMALBILLAMT] MONEY NULL,
    [T2TBILLAMT] MONEY NULL,
    [BILLAMT] MONEY NULL,
    [FUTUREPAYOUT] MONEY NULL,
    [SHORTAGE] MONEY NULL,
    [AMOUNTTOBEPAID] MONEY NULL,
    [PAYMODE] VARCHAR(1) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [GENFLAG] VARCHAR(1) NULL,
    [CLIENTTYPE] VARCHAR(3) NULL,
    [FAMILYCODE] VARCHAR(10) NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LEDGERBALANCE_COMBINED
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LEDGERBALANCE_COMBINED]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTYCODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [CHEQUENAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [BTOBPAYMENT] INT NULL,
    [NSE_VDTLEDBAL] MONEY NULL,
    [NSE_EDTLEDBAL] MONEY NULL,
    [NSE_POLEDBAL] MONEY NULL,
    [NFO_EDTLEDBAL] MONEY NULL,
    [NFO_MARGINBAL] MONEY NULL,
    [NFO_POLEDBAL] MONEY NULL,
    [PAYMODE] VARCHAR(1) NULL,
    [NSE_BANKCODE] VARCHAR(10) NULL,
    [NFO_BANKCODE] VARCHAR(10) NULL,
    [CLIENTTYPE] VARCHAR(3) NULL,
    [RUNDATE] DATETIME NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [BILLAMT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LEDGERTRANSFER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LEDGERTRANSFER]
(
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [ACNAME] CHAR(100) NOT NULL,
    [FINAL_LEDGER_AMOUNT] MONEY NULL,
    [FINAL_MARGIN_AMOUNT] MONEY NULL,
    [LEDGER_AMOUNT] MONEY NULL,
    [MARGIN_AMOUNT] MONEY NULL,
    [MARGIN_AVAILABLE] MONEY NULL,
    [MARGIN_USAGE_AMOUNT] MONEY NULL,
    [MARGIN_REQ] MONEY NULL,
    [MARGINDATE] DATETIME NULL,
    [EXCH_FR] VARCHAR(25) NOT NULL,
    [EXCH_TO] VARCHAR(25) NOT NULL,
    [TRANSFER_DATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [TRANSFER_BY] VARCHAR(10) NULL,
    [REPORT_DATE] DATETIME NULL,
    [REPORT_TYPE] CHAR(2) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [RF_FLAG] BIT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Offline_CC_Entries
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Offline_CC_Entries]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [VOLE_RefNo] BIGINT NOT NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [CltCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [CatCode] VARCHAR(35) NULL,
    [CostCode] VARCHAR(35) NULL,
    [AddBy] VARCHAR(25) NULL,
    [StatusID] VARCHAR(25) NULL,
    [StatusName] VARCHAR(25) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Offline_Ledger_Entries
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Offline_Ledger_Entries]
(
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [VoucherType] SMALLINT NULL,
    [BookType] VARCHAR(2) NULL,
    [SNo] INT NULL,
    [Vdate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [CltCode] VARCHAR(10) NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [Narration] VARCHAR(255) NULL,
    [OppCode] VARCHAR(10) NULL,
    [MarginCode] VARCHAR(10) NULL,
    [BankName] VARCHAR(50) NULL,
    [BranchName] VARCHAR(20) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [DDNo] VARCHAR(30) NULL,
    [ChequeMode] VARCHAR(1) NULL,
    [ChequeDate] DATETIME NULL,
    [ChequeName] VARCHAR(50) NULL,
    [Clear_Mode] VARCHAR(1) NULL,
    [TPAccountNumber] VARCHAR(16) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [TPFlag] TINYINT NULL,
    [AddDt] DATETIME NULL,
    [AddBy] VARCHAR(25) NULL,
    [StatusID] VARCHAR(25) NULL,
    [StatusName] VARCHAR(25) NULL,
    [RowState] TINYINT NULL,
    [ApprovalFlag] TINYINT NULL,
    [ApprovalDate] DATETIME NULL,
    [ApprovedBy] VARCHAR(25) NULL,
    [VoucherNo] VARCHAR(12) NULL,
    [UploadDt] DATETIME NULL,
    [LedgerVNO] VARCHAR(12) NULL,
    [ClientName] VARCHAR(100) NULL,
    [OppCodeName] VARCHAR(100) NULL,
    [MarginCodeName] VARCHAR(100) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [ProductType] VARCHAR(3) NULL,
    [RevAmt] MONEY NULL,
    [RevCode] VARCHAR(10) NULL,
    [MICR] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Offline_Ledger_Entries_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Offline_Ledger_Entries_Jrnl]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [FldAuto] INT NULL,
    [VoucherType] SMALLINT NULL,
    [BookType] VARCHAR(2) NULL,
    [SNo] INT NULL,
    [Vdate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [CltCode] VARCHAR(10) NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [Narration] VARCHAR(255) NULL,
    [OppCode] VARCHAR(10) NULL,
    [MarginCode] VARCHAR(10) NULL,
    [BankName] VARCHAR(35) NULL,
    [BranchName] VARCHAR(20) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [DDNo] VARCHAR(30) NULL,
    [ChequeMode] VARCHAR(1) NULL,
    [ChequeDate] DATETIME NULL,
    [ChequeName] VARCHAR(50) NULL,
    [Clear_Mode] VARCHAR(1) NULL,
    [TPAccountNumber] VARCHAR(16) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [TPFlag] TINYINT NULL,
    [AddDt] DATETIME NULL,
    [AddBy] VARCHAR(25) NULL,
    [StatusID] VARCHAR(25) NULL,
    [StatusName] VARCHAR(25) NULL,
    [RowState] TINYINT NULL,
    [ApprovalFlag] TINYINT NULL,
    [ApprovalDate] DATETIME NULL,
    [ApprovedBy] VARCHAR(25) NULL,
    [VoucherNo] VARCHAR(12) NULL,
    [UploadDt] DATETIME NULL,
    [LedgerVNO] VARCHAR(12) NULL,
    [ClientName] VARCHAR(100) NULL,
    [OppCodeName] VARCHAR(100) NULL,
    [MarginCodeName] VARCHAR(100) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [ProductType] VARCHAR(3) NULL,
    [RevAmt] MONEY NULL,
    [RevCode] VARCHAR(10) NULL,
    [MICR] VARCHAR(9) NULL,
    [Action] VARCHAR(12) NULL,
    [ModifiedBy] VARCHAR(25) NULL,
    [ModifiedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OPENING_BALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OPENING_BALANCE]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(500) NULL DEFAULT 'Opening balance',
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [LNO] SMALLINT NOT NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_payout_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_payout_temp]
(
    [vdt] DATETIME NULL,
    [edt] DATETIME NULL,
    [acCode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [amt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [bnkcode] VARCHAR(10) NULL,
    [bnkname] VARCHAR(50) NULL,
    [ddno] VARCHAR(30) NULL,
    [brcode] VARCHAR(25) NULL,
    [narration] VARCHAR(500) NULL,
    [Paymode] CHAR(3) NULL,
    [srno] INT NULL,
    [branchcode] VARCHAR(25) NULL,
    [micrno] INT NULL,
    [BookType] CHAR(4) NULL,
    [accdtls] CHAR(35) NULL,
    [lno] SMALLINT NOT NULL,
    [costcode] SMALLINT NULL,
    [bankcost] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [updflag] VARCHAR(1) NOT NULL,
    [SessionId] VARCHAR(50) NULL,
    [Ledger2_Upd] CHAR(1) NOT NULL,
    [Remark] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PAYOUTCLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PAYOUTCLIENT]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PLEXCHANGE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PLEXCHANGE]
(
    [EXCHANGE] VARCHAR(7) NULL,
    [ACCOUNTDATA] VARCHAR(15) NULL,
    [SHARESERVER] VARCHAR(25) NULL,
    [ISEXTERNAL] BIT NULL,
    [ENABLED] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Process_Logs
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Process_Logs]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [ReportName] VARCHAR(100) NULL,
    [ReportParam] VARCHAR(4000) NULL,
    [ReportBy] VARCHAR(50) NULL,
    [ReportDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PROCESS_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PROCESS_MASTER]
(
    [Processid] INT IDENTITY(1,1) NOT NULL,
    [ProcessName] VARCHAR(100) NULL,
    [ProcessFlag] VARCHAR(1) NULL,
    [ProcessParams] VARCHAR(200) NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_RUNNINGBALANCES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_RUNNINGBALANCES]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NOT NULL,
    [LEDTYPE] SMALLINT NOT NULL,
    [VDTBAL] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [BALDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_RUNNINGBALANCES_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_RUNNINGBALANCES_TMP]
(
    [CLTCODE] VARCHAR(10) NULL,
    [SEGMENTCODE] INT NOT NULL,
    [LEDTYPE] SMALLINT NOT NULL,
    [VDTBAL] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [BALDATE] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_SETTPAYOUT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_SETTPAYOUT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] CHAR(3) NULL,
    [SEGMENT] VARCHAR(12) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [BILLAMT] MONEY NULL,
    [POBALCM] MONEY NULL,
    [POBALFO] MONEY NULL,
    [REQUESTEDAMT] MONEY NULL,
    [AMOUNTTOBEPAID] MONEY NULL,
    [REQUESTDT] DATETIME NULL,
    [USERID] VARCHAR(50) NULL,
    [STATUS] CHAR(1) NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [REMARK] VARCHAR(234) NULL,
    [APPROVEDDT] DATETIME NULL,
    [HOPAYMODE] VARCHAR(25) NULL,
    [VNO] VARCHAR(12) NULL,
    [CHEQUENO] VARCHAR(30) NULL,
    [EDT] DATETIME NULL,
    [VDT] DATETIME NULL,
    [GENFLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_UPLOADED_FILES]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAIN
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAIN]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAIN_04072013
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAIN_04072013]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [Shortdesc] CHAR(6) NULL,
    [Dispflag] CHAR(1) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAST_DESC
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAST_DESC]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [ShortDesc] CHAR(6) NULL,
    [DispFlag] CHAR(1) NULL,
    [NarratioN] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACMAST_DEL
-- --------------------------------------------------
CREATE TRIGGER [ACMAST_DEL] ON [dbo].[Acmast] 
FOR DELETE 
AS
INSERT INTO ACMAST_TRG
	(
		ACNAME, 
		LONGNAME, 
		ACTYP, 
		ACCAT, 
		FAMILYCD, 
		CLTCODE, 
		ACCDTLS, 
		GRPCODE, 
		BOOKTYPE, 
		MICRNO, 
		BRANCHCODE, 
		BTOBPAYMENT, 
		PAYMODE, 
		POBANKNAME, 
		POBRANCH, 
		POBANKCODE, 
		COMP_NAME, 
		UDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT
	ACNAME, 
	LONGNAME, 
	ACTYP, 
	ACCAT, 
	FAMILYCD, 
	CLTCODE, 
	ACCDTLS, 
	GRPCODE, 
	BOOKTYPE, 
	MICRNO, 
	BRANCHCODE, 
	BTOBPAYMENT, 
	PAYMODE, 
	POBANKNAME, 
	POBRANCH, 
	POBANKCODE, 
	COMP_NAME = HOST_NAME(), 
	UDDATE = GETDATE(), 
	DBACTION = 'DELETED', 
	APPLICATION = APP_NAME()
FROM
	DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACMAST_DEL_NEW
-- --------------------------------------------------
CREATE TRIGGER [ACMAST_DEL_NEW] ON [DBO].[ACMAST]
	FOR DELETE
AS
	INSERT INTO
		ACMAST_TLOG
		(
			ACNAME,
			LONGNAME,
			ACTYP,
			ACCAT,
			FAMILYCD,
			CLTCODE,
			ACCDTLS,
			GRPCODE,
			BOOKTYPE,
			MICRNO,
			BRANCHCODE,
			BTOBPAYMENT,
			PAYMODE,
			POBANKNAME,
			POBRANCH,
			POBANKCODE,
			UPDDATE,
			DBACTION,
			COMP_NAME,
			APPLICATION
		)
	SELECT
		ACNAME,
		LONGNAME,
		ACTYP,
		ACCAT,
		FAMILYCD,
		CLTCODE,
		ACCDTLS,
		GRPCODE,
		BOOKTYPE,
		MICRNO,
		BRANCHCODE,
		BTOBPAYMENT,
		PAYMODE,
		POBANKNAME,
		POBRANCH,
		POBANKCODE,
		UPDDATE = GETDATE(),
		DBACTION = 'D',
		COMP_NAME = LEFT(HOST_NAME(), 100),
		APPLICATION = LEFT(APP_NAME(), 100)
	FROM
		DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACMAST_LEDGER_TRG_INS
-- --------------------------------------------------


/*---------------------------------------UPDATION OF ACMAST REPLICA-----------------------------------------------*/

CREATE TRIGGER [ACMAST_LEDGER_TRG_INS] ON [DBO].[ACMAST]
	FOR INSERT
AS
	DECLARE @@COUNTER AS INT
	SELECT
		@@COUNTER = COUNT(1)
	FROM
		ACMAST_LEDGER L, INSERTED I
	WHERE
		L.CLTCODE = I.CLTCODE

	IF @@COUNTER > 0
		BEGIN
			UPDATE A
				SET
					ACNAME = I.ACNAME,
					LONGNAME = I.LONGNAME,
					ACTYP = I.ACTYP,
					ACCAT = I.ACCAT,
					FAMILYCD = I.FAMILYCD,
					ACCDTLS = I.ACCDTLS,
					GRPCODE = I.GRPCODE,
					BOOKTYPE = I.BOOKTYPE,
					MICRNO = I.MICRNO,
					BRANCHCODE = I.BRANCHCODE,
					BTOBPAYMENT = I.BTOBPAYMENT,
					PAYMODE = I.PAYMODE,
					POBANKNAME = I.POBANKNAME,
					POBRANCH = I.POBRANCH,
					POBANKCODE = I.POBANKCODE
			FROM
				ACMAST_LEDGER A,
				INSERTED I
			WHERE
				A.CLTCODE = I.CLTCODE
		END
	ELSE
		BEGIN
			INSERT INTO
				ACMAST_LEDGER
				(
					ACNAME,
					LONGNAME,
					ACTYP,
					ACCAT,
					FAMILYCD,
					CLTCODE,
					ACCDTLS,
					GRPCODE,
					BOOKTYPE,
					MICRNO,
					BRANCHCODE,
					BTOBPAYMENT,
					PAYMODE,
					POBANKNAME,
					POBRANCH,
					POBANKCODE
				)
			SELECT
				ACNAME,
				LONGNAME,
				ACTYP,
				ACCAT,
				FAMILYCD,
				CLTCODE,
				ACCDTLS,
				GRPCODE,
				BOOKTYPE,
				MICRNO,
				BRANCHCODE,
				BTOBPAYMENT,
				PAYMODE,
				POBANKNAME,
				POBRANCH,
				POBANKCODE
			FROM 
				INSERTED
		END

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACMAST_LEDGER_TRG_UPD
-- --------------------------------------------------

CREATE TRIGGER [ACMAST_LEDGER_TRG_UPD] ON [DBO].[ACMAST]
	FOR UPDATE
AS

	INSERT INTO
		ACMAST_TLOG
		(
			ACNAME,
			LONGNAME,
			ACTYP,
			ACCAT,
			FAMILYCD,
			CLTCODE,
			ACCDTLS,
			GRPCODE,
			BOOKTYPE,
			MICRNO,
			BRANCHCODE,
			BTOBPAYMENT,
			PAYMODE,
			POBANKNAME,
			POBRANCH,
			POBANKCODE,
			UPDDATE,
			DBACTION,
			COMP_NAME,
			APPLICATION
		)
	SELECT
		ACNAME,
		LONGNAME,
		ACTYP,
		ACCAT,
		FAMILYCD,
		CLTCODE,
		ACCDTLS,
		GRPCODE,
		BOOKTYPE,
		MICRNO,
		BRANCHCODE,
		BTOBPAYMENT,
		PAYMODE,
		POBANKNAME,
		POBRANCH,
		POBANKCODE,
		UPDDATE = GETDATE(),
		DBACTION = 'U',
		COMP_NAME = LEFT(HOST_NAME(), 100),
		APPLICATION = LEFT(APP_NAME(), 100)
	FROM
		DELETED

	UPDATE
		L
	SET
		ACNAME = I.ACNAME,
		LONGNAME = I.LONGNAME,
		ACTYP = I.ACTYP,
		ACCAT = I.ACCAT,
		FAMILYCD = I.FAMILYCD,
		ACCDTLS = I.ACCDTLS,
		GRPCODE = I.GRPCODE,
		BOOKTYPE = I.BOOKTYPE,
		MICRNO = I.MICRNO,
		BRANCHCODE = I.BRANCHCODE,
		BTOBPAYMENT = I.BTOBPAYMENT,
		PAYMODE = I.PAYMODE,
		POBANKNAME = I.POBANKNAME,
		POBRANCH = I.POBRANCH,
		POBANKCODE = I.POBANKCODE
	FROM
		ACMAST_LEDGER L,
		INSERTED I
	WHERE
		L.CLTCODE = I.CLTCODE

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACMAST_UP
-- --------------------------------------------------
CREATE TRIGGER [ACMAST_UP] ON [dbo].[Acmast] 
FOR UPDATE
AS
INSERT INTO ACMAST_TRG
	(
		ACNAME, 
		LONGNAME, 
		ACTYP, 
		ACCAT, 
		FAMILYCD, 
		CLTCODE, 
		ACCDTLS, 
		GRPCODE, 
		BOOKTYPE, 
		MICRNO, 
		BRANCHCODE, 
		BTOBPAYMENT, 
		PAYMODE, 
		POBANKNAME, 
		POBRANCH, 
		POBANKCODE, 
		COMP_NAME, 
		UDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT
	ACNAME, 
	LONGNAME, 
	ACTYP, 
	ACCAT, 
	FAMILYCD, 
	CLTCODE, 
	ACCDTLS, 
	GRPCODE, 
	BOOKTYPE, 
	MICRNO, 
	BRANCHCODE, 
	BTOBPAYMENT, 
	PAYMODE, 
	POBANKNAME, 
	POBRANCH, 
	POBANKCODE, 
	COMP_NAME = HOST_NAME(), 
	UDDATE = GETDATE(), 
	DBACTION = 'MODIFIED', 
	APPLICATION = APP_NAME()
FROM
	DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.BANKRECO_TRIG_INS
-- --------------------------------------------------
CREATE TRIGGER BANKRECO_TRIG_INS
ON BANKRECO
AFTER INSERT
AS
INSERT INTO BANKRECO_TRIG_TABLE SELECT Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2,BR_SNo, GETDATE(), HOST_NAME(), 'I'
FROM INSERTED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER1_DEL
-- --------------------------------------------------
CREATE TRIGGER [LEDGER1_DEL] ON [dbo].[Ledger1] 
FOR DELETE 
AS
INSERT INTO LEDGER1_TRG
	(
		BNKNAME, 
		BRNNAME, 
		DD, 
		DDNO, 
		DDDT, 
		RELDT, 
		RELAMT, 
		REFNO, 
		RECEIPTNO, 
		VTYP, 
		VNO, 
		LNO, 
		DRCR, 
		BOOKTYPE, 
		MICRNO, 
		SLIPNO, 
		SLIPDATE, 
		CHEQUEINNAME, 
		CHQPRINTED, 
		CLEAR_MODE, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT 
	BNKNAME, 
	BRNNAME, 
	DD, 
	DDNO, 
	DDDT, 
	RELDT, 
	RELAMT, 
	REFNO, 
	RECEIPTNO, 
	VTYP, 
	VNO, 
	LNO, 
	DRCR, 
	BOOKTYPE, 
	MICRNO, 
	SLIPNO, 
	SLIPDATE, 
	CHEQUEINNAME, 
	CHQPRINTED, 
	CLEAR_MODE, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'DELETED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP NOT IN (15, 21)

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER1_UP
-- --------------------------------------------------
CREATE TRIGGER [LEDGER1_UP] ON [dbo].[Ledger1] 
FOR UPDATE
AS
INSERT INTO LEDGER1_TRG
	(
		BNKNAME, 
		BRNNAME, 
		DD, 
		DDNO, 
		DDDT, 
		RELDT, 
		RELAMT, 
		REFNO, 
		RECEIPTNO, 
		VTYP, 
		VNO, 
		LNO, 
		DRCR, 
		BOOKTYPE, 
		MICRNO, 
		SLIPNO, 
		SLIPDATE, 
		CHEQUEINNAME, 
		CHQPRINTED, 
		CLEAR_MODE, 
		COMP_NAME, 
		UPDDATE, 
		DBACTION, 
		APPLICATION
	)
SELECT 
	BNKNAME, 
	BRNNAME, 
	DD, 
	DDNO, 
	DDDT, 
	RELDT, 
	RELAMT, 
	REFNO, 
	RECEIPTNO, 
	VTYP, 
	VNO, 
	LNO, 
	DRCR, 
	BOOKTYPE, 
	MICRNO, 
	SLIPNO, 
	SLIPDATE, 
	CHEQUEINNAME, 
	CHQPRINTED, 
	CLEAR_MODE, 
	COMP_NAME = HOST_NAME(), 
	UPDDATE = GETDATE(), 
	DBACTION = 'MODIFIED', 
	APPLICATION = APP_NAME()
FROM
	DELETED
WHERE
	VTYP NOT IN (15, 21)

GO

-- --------------------------------------------------
-- VIEW dbo.BANK_ACCOUNT_DETAILS
-- --------------------------------------------------
CREATE VIEW BANK_ACCOUNT_DETAILS
AS
SELECT BANKCODE, ACCOUNTNO FROM MSAJAG.dbo.BAnk_purpose_master B, OWNER O WHERE B.EXCHANGE = O.EXCHANGE AND B.SEGMENT = O.SEGMENT

GO

-- --------------------------------------------------
-- VIEW dbo.Clientsmarginview
-- --------------------------------------------------


Create View Clientsmarginview
As
Select Mcltcode, 
Amt = Isnull((select Sum(case When Drcr = 'c' Then Amount * -1 Else Amount End)
From Clientsmargin Where Mcltcode = C.Mcltcode), 0)
From Clientsmargin C
Group By Mcltcode

GO

-- --------------------------------------------------
-- VIEW dbo.FAMILYMST
-- --------------------------------------------------
/*
	SELECT * FROM FAMILYMST
*/
CREATE VIEW FAMILYMST
AS
SELECT 
--	C.CL_CODE, 
--	C.SHORT_NAME, 
	F.FAMILY,
	C.LONG_NAME AS FAMILYNAME
/*	C.L_ADDRESS1, 
	C.L_ADDRESS2, 
	C.L_CITY, 
	C.L_STATE, 
	C.L_NATION, 
	C.L_ZIP,
	FAX, 
	C.RES_PHONE1, 
	C.RES_PHONE2, 
	C.OFF_PHONE1, 
	C.OFF_PHONE2, 
	C.EMAIL, 
	C.BRANCH_CD, 
	C.CREDIT_LIMIT, 
	C.CL_TYPE, 
	C.CL_STATUS, 
	C.GL_CODE, 
	C.FD_CODE, */
/*	C.PENALTY, 
	C.SUB_BROKER, 
	C.CONFIRM_FAX, 
	C.PHONEOLD, 
	C.L_ADDRESS3, 
	C.MOBILE_PAGER, 
	C.PAN_GIR_NO, 
	C.TRADER, 
	C.WARD_NO, 
	C.REGION, 
	C.AREA, 
	C.CLRATING */
FROM MSAJAG.DBO.CLIENT1 C, 
	(
	SELECT DISTINCT 
		FAMILY 
	FROM MSAJAG.DBO.CLIENT1
	) 
	F 
WHERE C.CL_CODE = F.FAMILY

GO

-- --------------------------------------------------
-- VIEW dbo.FT_GL
-- --------------------------------------------------



CREATE VIEW [dbo].[FT_GL]
AS
	SELECT
		EXCH_FR,
		EXCH_TO,
		JV_CODE,
		JV_NAME
	FROM
		AngelBSECM.ACCOUNT_AB.DBO.FT_GL

GO

-- --------------------------------------------------
-- VIEW dbo.Ledgerdrcr
-- --------------------------------------------------
Create View Dbo.Ledgerdrcr
As
Select Sum(vamt) As Totalamount, Drcr
From Ledger
Group By Drcr

GO

-- --------------------------------------------------
-- VIEW dbo.Ledgermismatch
-- --------------------------------------------------
/*  Query To Find Out Vouchers Where Debit And Credit Is Not Matching */  
Create View  Ledgermismatch  
As  
Select Vtyp, Vno, Debit = ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'd'),   
Credit = ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'c'),   
Balance = ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'd')  
- ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'c')  
From Ledger L1  
Group By Vtyp, Vno  
Having ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'd') <> ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'c')

GO

-- --------------------------------------------------
-- VIEW dbo.Ledgermismatch1
-- --------------------------------------------------
/*  Query To Find Out Vouchers Where Debit And Credit Is Not Matching */    
Create View  Ledgermismatch1    
As    
Select Vtyp, Vno, Debit = ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'd'),     
Credit = ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'c'),     
Balance = ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'd')    
- ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'c')    
From Ledger L1    
Group By Vtyp, Vno    
Having ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'd') <> ( Select Isnull(sum(vamt), 0) From Ledger L2 Where L2.Vtyp = L1.Vtyp And L2.Vno = L1.Vno And L2.Drcr = 'c')

GO

-- --------------------------------------------------
-- VIEW dbo.VIEW_USERRIGHTS
-- --------------------------------------------------
CREATE VIEW [dbo].[VIEW_USERRIGHTS]  
AS   
  
SELECT  
 CATEGORY = C.FLDCATEGORYCODE,  
 USERID = FLDUSERNAME,  
 VTYPE = VTYP,  
 BOOKTYPE,  
 EXCHANGE = 'NSE',  
 SEGMENT = 'CAPITAL',  
 [START_DATE] = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), GETDATE() - NODAYS, 112)),  
 END_DATE = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), GETDATE() + NODAYS, 112)),  
 ADD_DAYS = NODAYS,  
 EDIT_DAYS = NODAYS,  
 DELETE_DAYS = NODAYSD,  
 MKCKFLAG = 4  
FROM  
 USERRIGHTS U,  
 MSAJAG.dbo.TBLPRADNYAUSERS T,  
 MSAJAG.dbo.TBLCATEGORY C  
WHERE  
 U.USERCATEGORY = T.FLDCATEGORY  
 AND T.FLDCATEGORY = FLDCATEGORYCODE  
 AND VTYP NOT IN (18, 21)  
  
/*  
SELECT   
 USERID = FLDUSERNAME,VTYP,BOOKTYPE,EXCHANGE = 'NSE', CAPITAL = 'CAPITAL',  
 START_DATE = REPLACE(CONVERT(VARCHAR,GETDATE() - NODAYS,111),'/',''),  
 END_DATE = REPLACE(CONVERT(VARCHAR,GETDATE() + NODAYS,111),'/',''),  
 ADD_DAYS = NODAYS, EDIT_DAYS = NODAYS, DELETE_DAYS = NODAYSD,MKCKFLAG=1  
   
FROM   
 USERRIGHTS U LEFT OUTER JOIN  
 MSAJAG.DBO.TBLPRADNYAUSERS T  
 ON U.USERCATEGORY = T.FLDCATEGORY   
WHERE FLDUSERNAME IS NOT NULL   
SELECT * FROM MSAJAG.dbo.TBLCATEGORY  
*/

GO

-- --------------------------------------------------
-- VIEW dbo.VW_MULTICOMPANY
-- --------------------------------------------------
CREATE VIEW [dbo].[VW_MULTICOMPANY]
AS
SELECT     *
FROM         Pradnya.dbo.multicompany

GO

