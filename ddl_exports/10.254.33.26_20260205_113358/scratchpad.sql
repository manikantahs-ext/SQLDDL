-- DDL Export
-- Server: 10.254.33.26
-- Database: scratchpad
-- Exported: 2026-02-05T11:34:15.962183

USE scratchpad;
GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTO_MTF_PROCESS
-- --------------------------------------------------
CREATE  PROC [dbo].[AUTO_MTF_PROCESS]       
( @SAUDA_DATE datetime  

)      
AS      
 BEGIN       
 
 DECLARE @MAX_SAUDA_DATE varchar(11)

 SELECT @MAX_SAUDA_DATE=MAX(SAUDA_DATE) from MSAJAG.dbo.Settlement with(nolock) where sett_type='M'

 IF (@SAUDA_DATE=@MAX_SAUDA_DATE)

 BEGIN

 EXEC msdb.DBO.SP_START_JOB 'AUTO_MTF_PROCESS'       

SELECT 'MTF process has started for the dated-'+CONVERT(VARCHAR(11), @SAUDA_DATE, 120)+'. You will be notified by email after completion.'  AS REMARK  
    
	END

	ELSE 

	BEGIN
SELECT 'Equity T-Day billing does not match the specified date'  AS REMARK  
	END
       END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTO_POST_MTF_PROCESS
-- --------------------------------------------------
-------https://angelbrokingpl.atlassian.net/browse/ORE-5057-----------------------------------

CREATE PROC [dbo].[AUTO_POST_MTF_PROCESS](@SAUDA_DATE VARCHAR(11))
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SAUDA_DATE1 VARCHAR(11);

    -------------------------------------------------
    -- Get Latest SAUDA_DATE from Settlement Table
    -------------------------------------------------
    SELECT @SAUDA_DATE1 =CAST ( MAX (SAUDA_DATE) AS DATE)
    FROM MSAJAG.DBO.SETTLEMENT with (nolock) where sett_type='M'; 
    -------------------------------------------------
    -- Step 1: Populate MTF Data (PRE)
    -------------------------------------------------
	--TRUNCATE TABLE POPULATE_TBL_MTF_DATA_LOG
    INSERT INTO POPULATE_TBL_MTF_DATA_LOG
    VALUES ('MTFTRADE.DBO.PROC_POPULATE_TBL_MTF_DATA_PRE', GETDATE(), 'START');

   EXEC MTFTRADE.DBO.PROC_POPULATE_TBL_MTF_DATA_PRE @SAUDA_DATE1;

    INSERT INTO POPULATE_TBL_MTF_DATA_LOG
    VALUES ('MTFTRADE.DBO.PROC_POPULATE_TBL_MTF_DATA_PRE', GETDATE(), 'END');

    -------------------------------------------------
    -- Step 2: MTF Cash Margin Details
    -------------------------------------------------
    INSERT INTO POPULATE_TBL_MTF_DATA_LOG
    VALUES ('INHOUSE.DBO.PROC_MTF_CASH_MARGIN_DETAILS', GETDATE(), 'START');

    EXEC INHOUSE.DBO.PROC_MTF_CASH_MARGIN_DETAILS @SAUDA_DATE1;

    INSERT INTO POPULATE_TBL_MTF_DATA_LOG
    VALUES ('INHOUSE.DBO.PROC_MTF_CASH_MARGIN_DETAILS', GETDATE(), 'END');

    -------------------------------------------------
    -- Final Status
    -------------------------------------------------
    
   SELECT 'AUTO POST MTF PROCESS COMPLETED SUCCESSFULLY FOR DATED ' + @SAUDA_DATE1 AS REMARK
       
END;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXCESS_PAYIN_DATA
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[EXCESS_PAYIN_DATA]  
--Created this SP under ORE-4513
(  
@sett_no VARCHAR(10)  
)  
AS   
BEGIN   
  
Select party_code,scrip_cd,series,certno,sum(qty ) as pay_in_qty,Sett_no,sett_type  into #del1  from ANGELDEMAT.MSAJAG.DBO.deltrans where sett_no =@sett_no and drcr ='C'  and filler2=1
Group by party_code,scrip_cd,series,certno ,Sett_no,sett_type

Select party_code,scrip_cd,series,i_isin,sum(qty ) as pay_in_qty,Sett_no,sett_type  into #obl1  from ANGELDEMAT.MSAJAG.DBO.deliveryclt where sett_no =@sett_no   and inout='I'
Group by party_code,scrip_cd,series,i_isin,Sett_no,sett_type

Select *,Excess_qty= OBL_Qty- recd_qty into #Excess from (
Select Isnull(O.Party_code,d.Party_Code) as party_code,isnull(O.scrip_cd,d.scrip_cd)as scrip_cd,isnull(O.series,d.series) as series,isnull(certno,i_isin) as isin
,isnull(O.Sett_no,D.Sett_No) as sett_no ,isnull(O.Sett_Type,d.Sett_type) as sett_type
,isnull(o.pay_in_qty,0) as OBL_Qty,Isnull(d.pay_in_qty,0) as recd_qty
from #obl1 O
full outer join
#del1 d on O.Party_code=d.Party_Code and O.scrip_cd=d.scrip_cd and O.series=d.series  ) A where OBL_Qty <> recd_qty and party_code <>'NSE'
and OBL_Qty< recd_qty

select party_code,Scrip_cd,Series,ISIN,Sett_no,Sett_type,OBL_Qty,Recd_qty,Excess_qty from #excess


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_EPI_POOL_ACCOUNT_TEST
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[GET_EPI_POOL_ACCOUNT_TEST]  
 @MARGINDATE VARCHAR(11)  
AS  
DECLARE @VARKEY VARCHAR(8),  
     @PrevDate Varchar(11),  
  @EPNDATE Varchar(11),  
  @Start_date Varchar(11),  
  @FLAG INT  
  
SET @FLAG = 1  
     
     
SELECT @EPNDATE = ISNULL(MAX(Margin_Date),'APR  1 2020') FROM MSAJAG..TBL_MG02  
WHERE Margin_Date <= @MARGINDATE    
  
SELECT @PREVDATE = ISNULL(MAX(Start_Date),'APR  1 2020') FROM MSAJAG..SETT_MST  
WHERE Start_Date < @EPNDATE AND Sett_Type = 'N'  
   
SELECT @Start_date = ISNULL(MAX(Start_date),'APR  1 2020') FROM MSAJAG..Sett_Mst  
WHERE Start_date <= @MARGINDATE AND Sett_Type = 'N'  
  
IF @EPNDATE = @Start_date  
 SET @FLAG = 0   
  
/*SELECT   
EXCHANGE = 'NSE', SEGMENT = 'CAPITAL', PARTY_CODE,   
POOLACCOUNT = SUM(MARGIN_BENEFIT),   
EPIACCOUNT = SUM(CASHBENEFIT)  
FROM TBL_EPN_BENEFIT  
WHERE TRANSDATE = 'DEC 31 2020'  
AND MARGIN_BENEFIT + CASHBENEFIT > 0   
GROUP BY TRANSDATE, PARTY_CODE*/  
  
SELECT @VARKEY = DETAILKEY FROM MSAJAG..VARCONTROL   
WHERE RECDATE >= @EPNDATE AND RECDATE <= @EPNDATE + ' 23:59'  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, NONEPNQTY,   
NETAMT = (SELLAMOUNT / SELLQTY ) * NONEPNQTY,  
MARGIN_BENEFIT, MTOMLOSS=CONVERT(NUMERIC(18,4),0),  
ADNL_MARGIN= CONVERT(NUMERIC(18,4),0),  
ADNL_PER=CONVERT(NUMERIC(18,4),0)  
INTO #PAYIN  
FROM MSAJAG..TBL_EPN_BENEFIT  
WHERE TRANSDATE = @EPNDATE  
AND MARGIN_BENEFIT > 0   
  
SELECT * INTO #TBL_MG02 FROM MSAJAG..TBL_MG02 WHERE Margin_Date = @EPNDATE AND MTOM < 0   
AND NETQTY < 0   
  
UPDATE #PAYIN SET MTOMLOSS = (ABS(MTOM)/ABS(NETQTY))*NONEPNQTY FROM #TBL_MG02 M  
WHERE #PAYIN.SETT_NO = M.Sett_No   
AND #PAYIN.SETT_TYPE = M.Sett_Type   
AND #PAYIN.SCRIP_CD=M.Scrip_Cd   
AND #PAYIN.SERIES = M.SERIES   
AND #PAYIN.PARTY_CODE = M.Party_Code   
  
UPDATE #PAYIN SET ADNL_PER = INDEXVAR  
FROM MSAJAG..VARDETAIL D WHERE DETAILKEY =@VARKEY   
AND D.SCRIP_CD = #PAYIN.SCRIP_CD AND D.SERIES = #PAYIN.SERIES  
  
UPDATE #PAYIN SET ADNL_MARGIN = ABS(NETAMT*ADNL_PER) / 100  
  
SELECT EXCHANGE, SEGMENT, PARTY_CODE, POOLACCOUNT = SUM(POOLACCOUNT), EPIACCOUNT = SUM(EPIACCOUNT), LEDACCOUNT = 0--SUM(LEDACCOUNT)  
FROM  
(  
SELECT   
EXCHANGE = 'NSE', SEGMENT = 'CAPITAL', PARTY_CODE,   
POOLACCOUNT = SUM(MARGIN_BENEFIT+MTOMLOSS+ADNL_MARGIN), EPIACCOUNT = CONVERT(NUMERIC(18,4),0), LEDACCOUNT = CONVERT(NUMERIC(18,4),0)   
FROM #PAYIN   
GROUP BY PARTY_CODE   
UNION ALL  
SELECT   
EXCHANGE = 'NSE', SEGMENT = 'CAPITAL', PARTY_CODE,    
POOLACCOUNT = CONVERT(NUMERIC(18,4),0), EPIACCOUNT = SUM(CASHBENEFIT),LEDACCOUNT = SUM(CASHBENEFIT)  
FROM MSAJAG..TBL_EPN_BENEFIT T  
WHERE TRANSDATE = @EPNDATE  
AND CASHBENEFIT > 0   
AND SETT_NO NOT IN (SELECT SETT_NO FROM MSAJAG..SETT_MST S WHERE T.SETT_NO = S.SETT_NO AND T.SETT_TYPE = S.SETT_TYPE  
AND Sec_Payin < @MARGINDATE + ' 23:59')  
GROUP BY TRANSDATE, PARTY_CODE  
UNION ALL  
SELECT EXCHANGE = 'NSE', SEGMENT = 'CAPITAL', PARTY_CODE, POOLACCOUNT = CONVERT(NUMERIC(18,4),0),EPIACCOUNT=-SUM(CASHBENEFIT)*0/100, LEDACCOUNT = CONVERT(NUMERIC(18,4),0)   
FROM (  
SELECT PARTY_CODE, CASHBENEFIT=-SUM(CASHBENEFIT) FROM MSAJAG..TBL_EPN_BENEFIT T  
WHERE TRANSDATE = @PREVDATE  
AND SETT_NO IN (SELECT SETT_NO FROM MSAJAG..TBL_EPN_BENEFIT T1  
WHERE TRANSDATE = @PREVDATE AND T.SETT_NO = T1.SETT_NO AND T.SETT_TYPE = T1.SETT_TYPE)  
AND SETT_NO NOT IN (SELECT SETT_NO FROM MSAJAG..SETT_MST S WHERE T.SETT_NO = S.SETT_NO AND T.SETT_TYPE = S.SETT_TYPE  
AND Sec_Payin < @MARGINDATE + ' 23:59')  
AND @FLAG = 0  
GROUP BY PARTY_CODE   
UNION ALL  
SELECT PARTY_CODE, CASHBENEFIT=SUM(CASHBENEFIT) FROM MSAJAG..TBL_EPN_BENEFIT T  
WHERE TRANSDATE = @EPNDATE AND @FLAG = 0  
AND SETT_NO NOT IN (SELECT SETT_NO FROM MSAJAG..SETT_MST S WHERE T.SETT_NO = S.SETT_NO AND T.SETT_TYPE = S.SETT_TYPE  
AND Sec_Payin < @MARGINDATE + ' 23:59')  
GROUP BY PARTY_CODE ) A   
GROUP BY PARTY_CODE  
HAVING SUM(CASHBENEFIT) > 0   
  
) A   
--WHERE PARTY_CODE = CASE WHEN @PARTY_CODE <> '' THEN @PARTY_CODE ELSE PARTY_CODE END  
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE  
  
  
DROP TABLE #TBL_MG02  
DROP TABLE #PAYIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_EDT_LEDGER_ALL
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_EDT_LEDGER_ALL] (@TODATE DATETIME)  
  --CREATE THIS SP UNDER ORE-4382 
  --REQUESTED BY NIRMAL PUROHIT

AS --- EXEC RPT_EDT_LEDGER_ALL 'OCT 11 2021','A686863'  
  
  DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\BACKOFFICE\NIRMAL\INPUT\CLIENT_EDT.CSV'
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL
    DROP TABLE #CODE
CREATE TABLE #CODE (CLTCODE VARCHAR(50))
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
    (
           FIRSTROW = 1,
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW
           TABLOCK
    )'
SET @SQLFINAL= @SQL + @SQL2
PRINT @SQLFINAL
EXEC (@SQLFINAL)

DECLARE @FROMDATE VARCHAR(11)  

  
SELECT @FROMDATE =SDTCUR FROM ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR      
  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED  
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'  
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM'   
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- BSECM  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM'   
FROM AngelBSECM.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'  
FROM AngelBSECM.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM'   
FROM  AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- NSEFO  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO'   
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'  
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO'   
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- BSEFO  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO'   
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO'   
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- NSECD  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD'   
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'  
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD'   
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- BSECD  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD'   
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD'   
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- MCXCD  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD'   
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD'   
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- MTF  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF'   
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'  
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF'   
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- SLBS  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS'   
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'  
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS'   
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
  
INSERT INTO #EDTLED --- BSEMF  
SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' FROM (  
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM ANGELFO.BBO_FA.DBO.ACC_TBL1 A (NOLOCK), ANGELFO.BBO_FA.DBO.ACC_TBL3 B (NOLOCK)  
WHERE A.SNO = B.MASTERSNO  
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18  AND CLTCODE IN(select * from #code)  
UNION ALL   
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM ANGELFO.BBO_FA.DBO.ACC_TBL1 A (NOLOCK), ANGELFO.BBO_FA.DBO.ACC_TBL3 B (NOLOCK)  
WHERE A.SNO = B.MASTERSNO  
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE   
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE  AND CLTCODE IN(select * from #code)  
UNION ALL  
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM ANGELFO.BBO_FA.DBO.ACC_TBL1 A (NOLOCK), ANGELFO.BBO_FA.DBO.ACC_TBL3 B (NOLOCK)  
WHERE A.SNO = B.MASTERSNO  
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00'   
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE + ' 23:59:59' AND A.VTYPE <> 18  AND CLTCODE IN(select * from #code)) A  
GROUP BY A.CLTCODE  
  
  
INSERT INTO #EDTLED --- MCDX  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX'   
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX'   
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- NCDX  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX'   
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX'   
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
INSERT INTO #EDTLED --- NCE  
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCE'   
FROM ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER WITH(NOLOCK)   
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE   
UNION ALL  
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCE'  
FROM ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER B WITH (NOLOCK)   
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
UNION ALL  
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCE'   
FROM  ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER L WITH (NOLOCK)    
WHERE L.EDT >= @FROMDATE + ' 00:00:00'  AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN(select * from #code)  
GROUP BY CLTCODE  
  
   IF OBJECT_ID(N'SCRATCHPAD..CLIENT_EDT_DATA') IS NOT NULL
    DROP TABLE CLIENT_EDT_DATA

SELECT REPORT_DATE=CONVERT(VARCHAR(11),@TODATE,105),CLTCODE,[NSECM]=ISNULL([NSECM],0),[BSECM]=ISNULL([BSECM],0),  
[NSEFO]=ISNULL([NSEFO],0),[BSEFO]=ISNULL([BSEFO],0),[BSEMF]=ISNULL([BSEMF],0),[MTF]=ISNULL([MTF],0),  
[SLBS]=ISNULL([SLBS],0),[NSECD]=ISNULL([NSECD],0),[BSECD]=ISNULL([BSECD],0),[MCXCD]=ISNULL([MCXCD],0),  
[MCDX]=ISNULL([MCDX],0),[NCDX]=ISNULL([NCDX],0),[NCE]=ISNULL([NCE],0),  
NET_BALANCE=ISNULL([NSECM],0)+ISNULL([BSECM],0)+ISNULL([NSEFO],0)+ISNULL([BSEFO],0)+ISNULL([BSEMF],0)+ISNULL([MTF],0)  
+ISNULL([SLBS],0)+ISNULL([NSECD],0)+ISNULL([BSECD],0)+ISNULL([MCXCD],0)+ISNULL([MCDX],0)+ISNULL([NCDX],0)+ISNULL([NCE],0)  
INTO CLIENT_EDT_DATA FROM ( SELECT CLTCODE,LEDBAL,EXCHANGE FROM #EDTLED WHERE CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZ999999999' ) AS SOURCETABLE  
PIVOT  
(SUM(LEDBAL) FOR EXCHANGE IN ([NSECM],[BSECM],[NSEFO],[BSEFO],[BSEMF],[MTF],[SLBS],[NSECD],[BSECD],[MCXCD],[MCDX],[NCDX],[NCE])) AS PIVOTTABLE  
ORDER BY PIVOTTABLE.CLTCODE


DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\NIRMAL\OUTPUT\' +'CLIENT_EDT' + '.CSV'        
DECLARE @ALL VARCHAR(MAX)                  
                  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''REPORT_DATE'''',''''CLTCODE'''',''''NSECM'''',''''BSECM'''',''''NSEFO'''',''''BSEFO'''',''''BSEMF'''',''''MTF'''',''''SLBS'''',''''NSECD'''',''''BSECD'''',''''MCXCD'''',''''MCDX'''',''''NCDX'''',''''NCE'''',''''NET_BALANCE'''''
SET @all = @all+ ' UNION ALL SELECT REPORT_DATE,CLTCODE,CONVERT(VARCHAR(max),NSECM),CONVERT(VARCHAR(max),BSECM),CONVERT(VARCHAR(max),NSEFO),CONVERT(VARCHAR(max),BSEFO),CONVERT(VARCHAR(max),BSEMF),CONVERT(VARCHAR(max),MTF),CONVERT(VARCHAR(max),SLBS),CONVERT(VARCHAR(max),NSECD),CONVERT(VARCHAR(max),BSECD),CONVERT(VARCHAR(max),MCXCD),CONVERT(VARCHAR(max),MCDX),CONVERT(VARCHAR(max),NCDX),CONVERT(VARCHAR(max),NCE),CONVERT(VARCHAR(max),NET_BALANCE) FROM SCRATCHPAD.DBO.CLIENT_EDT_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

DROP TABLE #CODE
DROP TABLE #EDTLED
DROP TABLE CLIENT_EDT_DATA

SELECT 'CLIENT EDT FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_GST_INVOICE_NEW_HIST_TEST
-- --------------------------------------------------
      
  --EXEC scratchpad.dbo.RPT_GST_INVOICE_NEW_HIST 'JULY2020','B82205','B82205','','zzzzzzzzzzz','','ZZZZZZZZZZ','broker','broker' --Invoice generation  
  
  ---EXEC MSajag.dbo.RPT_GST_INVOICE_NEW 'FEB2024','A0000000','zzzzzzzzzz','','zzzzzzzzzzz','','ZZZZZZZZZZ','broker','broker' --Invoice generation  
      
        
CREATE   PROC [dbo].[RPT_GST_INVOICE_NEW_HIST_TEST]        
(        
 @FORTHEMONTH VARCHAR(8),        
 @FROMCODE VARCHAR(20),        
 @TOCODE  VARCHAR(20),        
 @FROMBRANCH VARCHAR(20),        
 @TOBRANCH VARCHAR(20),        
 @FROMSUBBROKER VARCHAR(20),        
 @TOSUBBROKER VARCHAR(20),        
 @STATUSID VARCHAR(25),        
 @STATUSNAME VARCHAR(30),        
 @FLAG INT = 0         
)        
  
--EXEC RPT_GST_INVOICE_NEW 'MAR2021','Y14884','Y14884','','zzzzzzzzzzz','','zzzzzzzzzzz','broker','broker'  
--EXEC RPT_GST_INVOICE_NEW 'MAR2021','A100873','A100873','','zzzzzzzzzzz','','zzzzzzzzzzz','broker','broker'  
--go  
  
         
 AS        
        
DECLARE  @FROMDATE VARCHAR(11),        
   @TODATE  VARCHAR(11)        
        
SET @FROMDATE = LEFT(CONVERT(DATETIME,@FORTHEMONTH),11)        
        
SET @TODATE = LEFT(DATEADD(M,1,CONVERT(DATETIME,@FORTHEMONTH))-1,11)        
             
 CREATE TABLE #GST_INVOICE        
  (        
  SUPPLIER_NAME   VARCHAR(100),        
  SUPPLIER_ADD1   VARCHAR(300),        
  SUPPLIER_ADD2   VARCHAR(300),        
  SUPPLIER_STATE   VARCHAR(50),        
  SUPPLIER_GSTNO   VARCHAR(50),        
  SUPPLIER_FAXNO   VARCHAR(50),        
  SUPPLIER_TELNO   VARCHAR(100),        
  SUPPLIER_EMAIL   VARCHAR(100),        
  SUPPLIER_PANNO   VARCHAR(20),        
  SUPPLIER_CINNO   VARCHAR(30),        
  CLIENT_CODE    VARCHAR(20),          
  CLIENT_NAME    VARCHAR(100),        
  CLIENT_ADD1    VARCHAR(200),        
  CLIENT_ADD2    VARCHAR(200),        
  CLIENT_ADD3    VARCHAR(200),        
  CLIENT_STATE   VARCHAR(50),        
  CLIENT_STATECODE  VARCHAR(50),        
  CLIENT_PANNO   VARCHAR(20),        
  CLIENT_GSTNO   VARCHAR(20),        
  CLIENT_FAXNO   VARCHAR(50),        
  CLIENT_TELNO   VARCHAR(100),        
  CLIENT_EMAIL   VARCHAR(100),        
  PLACE_SUPPLY_STATENAME VARCHAR(100),        
  PLACE_SUPPLY_STATECODE VARCHAR(50),        
  REVERSE_CHRG_APPLICABLE CHAR(1),        
  INVOICE_NO    VARCHAR(30),        
  INVOICE_DATE   VARCHAR(11),        
  IEC_CODE    VARCHAR(20),        
  TRANS_TYPE    VARCHAR(20),        
  SRNO     INT,        
  HSN_SAN     VARCHAR(50),        
  DESCRIPTION_SERVICE  VARCHAR(500),        
  VALUE     NUMERIC(18,4),        
  GROSS_VALUE    NUMERIC(18,4),        
  TAXABLE_VALUE   NUMERIC(18,4),        
  IGST_RATE    NUMERIC(18,4),        
  IGST_AMOUNT    NUMERIC(18,4),        
  CGST_RATE    NUMERIC(18,4),        
  CGST_AMOUNT    NUMERIC(18,4),        
  SGST_RATE    NUMERIC(18,4),        
  SGST_AMOUNT    NUMERIC(18,4),        
  UGST_RATE    NUMERIC(18,4),        
  UGST_AMOUNT    NUMERIC(18,4),        
  TOTAL_VALUE    NUMERIC(18,4),        
  FT_TOTAL_VALUE   NUMERIC(18,4),        
  FT_AMT_REC_ADV   NUMERIC(18,4),        
  FT_NETAMOUNT   NUMERIC(18,4),        
  FT_TAXPAYABLE   NUMERIC(18,4),        
  FT_IGST   NUMERIC(18,4),        
  FT_CGST   NUMERIC(18,4),        
  FT_SGST   NUMERIC(18,4),        
  FT_GRAND_TOTAL   NUMERIC(18,4),        
  FT_AMT_INWORDS   VARCHAR(300),        
  FT_BANK_NAME   VARCHAR(100),        
  FT_BANK_BRANCH   VARCHAR(100),        
  FT_BANK_ACCOUNTNO  VARCHAR(50),        
  FT_BANK_IFSCCODE  VARCHAR(20),        
  FT_AUTHO_SIGNATORY  VARCHAR(200),        
  INVOICEDRCR    VARCHAR(1),        
  INOICE_TYPE    VARCHAR(20),  
  QR_CODE     VARCHAR(MAX),  
IRN_NO     VARCHAR(500)       
  )        
          
        
/*          
 INSERT INTO #GST_INVOICE        
 SELECT         
  SUPPLIER_NAME = O.COMPANY,        
  SUPPLIER_ADD1 = O.ADDR1,        
  SUPPLIER_ADD2 = O.ADDR2+' '+ O.CITY +' '+ O.ZIP,        
  SUPPLIER_STATE= O.STATE,        
  SUPPLIER_GSTNO= O.GSTNO,        
  SUPPLIER_FAXNO= O.FAX,        
  SUPPLIER_TELNO= O.PHONE,        
  SUPPLIER_EMAIL= O.EMAIL,        
  SUPPLIER_PANNO= O.PANNO,        
  SUPPLIER_CINNO= O.CIN,        
  CLIENT_CODE = CD.CL_CODE,        
  CLIENT_NAME = CD.LONG_NAME,        
  CLIENT_ADD1 = CD.L_ADDRESS1,        
  CLIENT_ADD2 = CD.L_ADDRESS2,        
  CLIENT_ADD3 = CD.L_ADDRESS3+' '+CD.L_CITY+' '+CD.L_ZIP,        
  CLIENT_STATE= CD.L_STATE,        
  CLIENT_STATECODE = '',        
  CLIENT_PANNO= CD.PAN_GIR_NO,        
  CLIENT_GSTNO= CD.GST_NO,        
  CLIENT_FAXNO= CD.FAX,        
  CLIENT_TELNO= CD.RES_PHONE1+' '+CD.RES_PHONE2,        
  CLIENT_EMAIL= CD.EMAIL,        
  PLACE_SUPPLY_STATENAME = '',        
  PLACE_SUPPLY_STATECODE = '',        
  REVERSE_CHRG_APPLICABLE= 'N',        
  INVOICE_NO = '000001',        
  INVOICE_DATE = @FROMDATE,        
  IEC_CODE = '',        
  TRANS_TYPE = 'Interstate',        
  SRNO = 1,        
  HSN_SAN = '',        
  DESCRIPTION_SERVICE = 'STOCK BROKER 1',        
  VALUE = 0.00,        
  GROSS_VALUE = 0.00,        
  TAXABLE_VALUE = 0.00,        
  IGST_RATE = 0.00,        
  IGST_AMOUNT = 0.00,        
  CGST_RATE = 0.00,        
  CGST_AMOUNT = 0.00,        
  SGST_RATE = 0.00,        
  SGST_AMOUNT = 0.00,        
  TOTAL_VALUE = 0.00,        
  FT_TOTAL_VALUE = 0.00,        
  FT_AMT_REC_ADV = 0.00,        
  FT_NETAMOUNT = 0.00,        
  FT_TAXPAYABLE = 0.00,        
  FT_GRAND_TOTAL = 0.00,        
  FT_AMT_INWORDS = '',        
  FT_BANK_NAME = CD.BANK_NAME,        
  FT_BANK_BRANCH = CD.BRANCH_NAME,        
  FT_BANK_ACCOUNTNO = CD.AC_NUM,        
  FT_BANK_IFSCCODE = '',        
  FT_AUTHO_SIGNATORY = 'XYZ'        
 FROM        
  CLIENT_DETAILS CD,        
  OWNER O        
 WHERE        
  CL_CODE BETWEEN @FROMCODE AND @TOCODE        
*/        
      
  
 SELECT Cl_COde into #cl  FROM MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)    where CL_CODE BETWEEN @FROMCODE AND @TOCODE  
 --WHERE C.GST_NO <> ''     
    
 SELECT DISTINCT T.* INTO #GSTINVOICE      
 FROM MSAJAG.DBO.TBL_GST_INVOICE T (NOLOCK)     ,#cl C  
 WHERE INVOICE_DATE BETWEEN @FROMDATE AND @TODATE         
 AND T.PARTY_CODE BETWEEN @FROMCODE AND @TOCODE     
 and cl_code = party_code  
 and recordfor = 'SETTLEMENT'-- Generate GST INVOICE FOR SETT (BKG ONLY)  
 ---and recordfor IN ('SETTLEMENT','LEDGER') -- Generate GST INVOICE FOR SETT (BKG ONLY)  
 And T.Party_code=C.cl_Code   

 INSERT INTO #GSTINVOICE
 SELECT DISTINCT T.*      
 FROM MSAJAG.DBO.TBL_GST_INVOICE_HISTORY T (NOLOCK)     ,#cl C  
 WHERE INVOICE_DATE BETWEEN @FROMDATE AND @TODATE         
 AND T.PARTY_CODE BETWEEN @FROMCODE AND @TOCODE     
 and cl_code = party_code  
 and recordfor = 'SETTLEMENT'-- Generate GST INVOICE FOR SETT (BKG ONLY)  
 ---and recordfor IN ('SETTLEMENT','LEDGER') -- Generate GST INVOICE FOR SETT (BKG ONLY)  
 And T.Party_code=C.cl_Code
      
      
 SELECT * INTO #CLDETAILS FROM MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)      
 WHERE PARTY_CODE BETWEEN @FROMCODE AND @TOCODE      
 AND C.branch_cd BETWEEN @FROMBRANCH AND @TOBRANCH        
 AND C.sub_broker BETWEEN @FROMSUBBROKER AND @TOSUBBROKER        
 AND EXISTS(SELECT DISTINCT PARTY_CODE FROM #GSTINVOICE WHERE #GSTINVOICE.PARTY_CODE = C.CL_CODE)    
 AND C.GST_NO <> ''      
 ---Note Without Commit "And C.GST.No <> '' " for generate file only GST number updated in MASTER and With commit should be generate PDF file for all client--      
  
  
INSERT INTO #GST_INVOICE      
SELECT         
  SUPPLIER_NAME = O.COMPANY,        
  SUPPLIER_ADD1 = ADDRESS1,        
  SUPPLIER_ADD2 = ADDRESS2 +' '+ G.CITY +' '+ G.ZIP,        
  SUPPLIER_STATE= G.STATE,        
  SUPPLIER_GSTNO= G.GST_NO,        
  SUPPLIER_FAXNO= G.FAX,        
  SUPPLIER_TELNO= G.PHONE1 + ' / ' + G.PHONE2,        
  SUPPLIER_EMAIL= G.EMAIL,        
  SUPPLIER_PANNO= O.PANNO,        
  SUPPLIER_CINNO= O.CIN,        
  CLIENT_CODE = CD.PARTY_CODE,        
  CLIENT_NAME = CD.LONG_NAME,        
  CLIENT_ADD1 = CD.L_ADDRESS1,        
  CLIENT_ADD2 = CD.L_ADDRESS2,        
  CLIENT_ADD3 = CD.L_ADDRESS3+' '+CD.L_CITY+' '+CD.L_ZIP,        
  CLIENT_STATE= CD.L_STATE,        
  CLIENT_STATECODE = STATE_CODE,        
  CLIENT_PANNO= C.PAN_GIR_NO,        
  CLIENT_GSTNO= CD.GST_NO,        
  CLIENT_FAXNO= C.FAX,        
  CLIENT_TELNO= C.RES_PHONE1+' '+C.RES_PHONE2,        
  CLIENT_EMAIL= C.EMAIL,        
  PLACE_SUPPLY_STATENAME = CD.L_STATE,        
  PLACE_SUPPLY_STATECODE = STATE_CODE,        
  REVERSE_CHRG_APPLICABLE= 'N',        
  INVOICE_NO = INV_NO,        
  INVOICE_DATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),        
  IEC_CODE = '',        
  TRANS_TYPE = (CASE WHEN IGST_AMOUNT > 0 THEN 'Interstate' ELSE 'Intrastate' END),        
  SRNO = 1,        
  HSN_SAN = (CASE WHEN LEN(SACCODE) = '' THEN '-' ELSE SACCODE END),        
  DESCRIPTION_SERVICE = INV_DESC + ' REF : ' + INT_REF_NO + (CASE WHEN RECORDFOR = 'SETTLEMENT' THEN  ' - ' + EXCHANGE + ' - ' + SEGMENT ELSE '' END),        
  VALUE = TAXABLE_AMT,        
  GROSS_VALUE = TAXABLE_AMT,        
  TAXABLE_VALUE =TAXABLE_AMT,        
  IGST_RATE,        
  IGST_AMOUNT,        
  CGST_RATE,        
  CGST_AMOUNT,        
  SGST_RATE,        
  SGST_AMOUNT,        
  UGST_RATE = SGST_RATE,        
  UGST_AMOUNT = SGST_AMOUNT,        
  TOTAL_VALUE = ROUND(TAXABLE_AMT,2) + ROUND(TAX_AMT,2),        
  FT_TOTAL_VALUE = 0.00,        
  FT_AMT_REC_ADV = 0.00,        
  FT_NETAMOUNT = 0.00,        
  FT_TAXPAYABLE = 0.00,        
  FT_IGST = 0.00,        
  FT_CGST = 0.00,        
  FT_SGST = 0.00,        
  FT_GRAND_TOTAL = 0.00,        
  FT_AMT_INWORDS = '',        
  FT_BANK_NAME = '',        
  FT_BANK_BRANCH = '',        
  FT_BANK_ACCOUNTNO = '',        
  FT_BANK_IFSCCODE = '',        
  FT_AUTHO_SIGNATORY = 'Harikrishna Negi',        
  INVOICEDRCR = LEFT(INVOICE_TYPE,1),        
  INOICE_TYPE = INVOICE_TYPE ,  
  QR_CODE = '',  
  IRN_NO = ''  
 FROM        
 #GSTINVOICE L (NOLOCK),       
 MSAJAG.DBO.CLIENT_GST_DATA CD (NOLOCK),       
 #CLDETAILS C (NOLOCK),        
 MSAJAG.DBO.OWNER O (NOLOCK),       
 MSAJAG.DBO.TBL_GST_LOCATION G (NOLOCK)        
 WHERE INVOICE_DATE BETWEEN @FROMDATE AND @TODATE         
 AND L.PARTY_CODE = CD.PARTY_CODE        
 AND L.PARTY_CODE = C.cl_code        
 AND INVOICE_DATE BETWEEN CD.EFF_FROM_DATE AND CD.EFF_TO_DATE        
 AND G.LOC_CODE = CD.GST_LOCATION          
 AND L.PARTY_CODE BETWEEN @FROMCODE AND @TOCODE        
 AND C.branch_cd BETWEEN @FROMBRANCH AND @TOBRANCH        
 AND C.sub_broker BETWEEN @FROMSUBBROKER AND @TOSUBBROKER        
 And @StatusName = (case                   
                        when @StatusId = 'BRANCH' then C.branch_cd                  
                        when @StatusId = 'SUBBROKER' then C.sub_broker                  
                        when @StatusId = 'Trader' then C.Trader                  
                        when @StatusId = 'Family' then C.Family                  
                        when @StatusId = 'Area' then C.Area                  
                        when @StatusId = 'Region' then C.Region                  
                        when @StatusId = 'Client' then C.party_code                  
        else                   
        'BROKER'                  
        End)          
        
 IF @FLAG = 1         
 BEGIN        
 UPDATE #GST_INVOICE SET UGST_RATE = SGST_RATE, UGST_AMOUNT = SGST_AMOUNT,        
 SGST_RATE = 0, SGST_AMOUNT = 0        
 FROM #TBL_CLIENT_GST_DATA (NOLOCK)      
 WHERE SUPPLIER_STATE = CLIENT_STATE        
 AND STATE_NAME = SUPPLIER_STATE        
 AND CONVERT(DATETIME,INVOICE_DATE,103)  BETWEEN EFF_FROM_DATE AND EFF_TO_DATE        
 AND UTI_FLAG = 1        
 END        
        
 UPDATE #GST_INVOICE SET UGST_RATE = 0, UGST_AMOUNT = 0        
 WHERE SGST_AMOUNT > 0        
        
 UPDATE #GST_INVOICE SET PLACE_SUPPLY_STATENAME = SUPPLIER_STATE        
 WHERE PLACE_SUPPLY_STATENAME NOT IN (SELECT STATE FROM MSAJAG.DBO.STATE_MASTER (NOLOCK) WHERE STATE <> 'OTHER')        
        
 UPDATE #GST_INVOICE SET CLIENT_STATECODE = TIN_NO        
 FROM MSAJAG.DBO.TBL_STATE_GST_DATA (NOLOCK)       
 WHERE STATE_NAME = PLACE_SUPPLY_STATENAME    
   
   
 --select value,INVOICE_NO,* from #GST_INVOICE   
 --return     
        
 UPDATE #GST_INVOICE       
 SET FT_TOTAL_VALUE = G.FT_TOTAL_VALUE,         
  FT_NETAMOUNT = G.FT_NETAMOUNT, FT_TAXPAYABLE = G.FT_TAXPAYABLE,        
  FT_IGST = G.FT_IGST,        
  FT_CGST = G.FT_CGST,        
  FT_SGST = G.FT_SGST,         
  FT_GRAND_TOTAL = G.FT_GRAND_TOTAL        
 FROM (        
   SELECT          
    INVOICE_NO,          
    FT_TOTAL_VALUE = SUM(CONVERT(NUMERIC(18,2),ROUND(VALUE,2))),        
    FT_NETAMOUNT = SUM(CONVERT(NUMERIC(18,2),ROUND(VALUE,2))),        
    FT_TAXPAYABLE = SUM(CONVERT(NUMERIC(18,2),ROUND(CGST_AMOUNT,2)+ROUND(SGST_AMOUNT,2)+ROUND(UGST_AMOUNT,2)+ROUND(IGST_AMOUNT,2))),        
    FT_IGST = SUM(CONVERT(NUMERIC(18,2),ROUND(IGST_AMOUNT,2))),        
    FT_CGST = SUM(CONVERT(NUMERIC(18,2),ROUND(CGST_AMOUNT,2))),        
    FT_SGST = SUM(CONVERT(NUMERIC(18,2),ROUND(SGST_AMOUNT,2))),        
    FT_GRAND_TOTAL = SUM(CONVERT(NUMERIC(18,2),ROUND(VALUE,2)        
          + (CASE WHEN INVOICEDRCR = 'C'         
            THEN ROUND(CGST_AMOUNT,2)+ROUND(SGST_AMOUNT,2)+ROUND(UGST_AMOUNT,2)+ROUND(IGST_AMOUNT,2)         
            ELSE (ROUND(CGST_AMOUNT,2)+ROUND(SGST_AMOUNT,2)+ROUND(UGST_AMOUNT,2)+ROUND(IGST_AMOUNT,2))         
          END)))        
   FROM #GST_INVOICE         
   GROUP BY INVOICE_NO        
  ) G        
 WHERE G.INVOICE_NO = #GST_INVOICE.INVOICE_NO  
   
   
  
     
   
  UPDATE #GST_INVOICE     
 SET  QR_CODE = ISNULL(V.QR_CODE,''),  
   IRN_NO = ISNULL(V.IRNNO,'')  
 FROM MSAJAG.DBO.GST_QRCODE_DETAILS V  
 WHERE V.PARTY_CODE = #GST_INVOICE.CLIENT_CODE  
   AND V.INV_NO = #GST_INVOICE.INVOICE_NO  
  
  
  
  
     
        
 SELECT    
 DISTINCT       
  SUPPLIER_NAME,        
  SUPPLIER_ADD1,        
  SUPPLIER_ADD2,        
  SUPPLIER_STATE,        
  SUPPLIER_GSTNO,        
  SUPPLIER_FAXNO,        
  SUPPLIER_TELNO,        
  SUPPLIER_EMAIL,        
  SUPPLIER_PANNO,        
  SUPPLIER_CINNO,        
  CLIENT_CODE,        
  CLIENT_NAME,        
  CLIENT_ADD1,        
  CLIENT_ADD2,        
  CLIENT_ADD3,        
  CLIENT_STATE,        
  CLIENT_STATECODE,        
  CLIENT_PANNO,        
  CLIENT_GSTNO,        
  CLIENT_FAXNO,        
  CLIENT_TELNO,        
  CLIENT_EMAIL,        
  PLACE_SUPPLY_STATENAME,        
  PLACE_SUPPLY_STATECODE,        
  REVERSE_CHRG_APPLICABLE,        
  INVOICE_NO,        
  INVOICE_DATE,        
  IEC_CODE,        
  TRANS_TYPE,        
  SRNO,        
  HSN_SAN,        
  DESCRIPTION_SERVICE,        
  VALUE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(VALUE,2))),        
  GROSS_VALUE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(GROSS_VALUE,2))),        
  TAXABLE_VALUE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(TAXABLE_VALUE,2))),        
  IGST_RATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(IGST_RATE,2))),        
  IGST_AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(IGST_AMOUNT,2))),        
  CGST_RATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(CGST_RATE,2))),        
  CGST_AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(CGST_AMOUNT,2))),        
  SGST_RATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SGST_RATE,2))),        
  SGST_AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SGST_AMOUNT,2))),        
  UGST_RATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(UGST_RATE,2))),        
  UGST_AMOUNT = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(UGST_AMOUNT,2))),        
  TOTAL_VALUE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(TOTAL_VALUE,2))),        
  FT_TOTAL_VALUE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(FT_TOTAL_VALUE,2))),        
  FT_AMT_REC_ADV = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(FT_AMT_REC_ADV,2))),        
  FT_NETAMOUNT = CONVERT(NUMERIC(18,2),ROUND(FT_NETAMOUNT,2)),        
  FT_TAXPAYABLE = CONVERT(NUMERIC(18,2),ROUND(FT_TAXPAYABLE,2)),        
  FT_IGST = CONVERT(NUMERIC(18,2),ROUND(FT_IGST,2)),        
  FT_CGST = CONVERT(NUMERIC(18,2),ROUND(FT_CGST,2)),        
  FT_SGST = CONVERT(NUMERIC(18,2),ROUND(FT_SGST,2)),        
  FT_GRAND_TOTAL = CONVERT(NUMERIC(18,2),ROUND(FT_GRAND_TOTAL,2)),          
  FT_AMT_INWORDS = pradnya.dbo.IndianCurrencyInWords(ROUND(FT_GRAND_TOTAL,2)),        
  FT_BANK_NAME,        
  FT_BANK_BRANCH,        
  FT_BANK_ACCOUNTNO,       
  FT_BANK_IFSCCODE,        
  FT_AUTHO_SIGNATORY,        
  INOICE_TYPE,        
  --FILENAME = CLIENT_CODE, --+'_'+ REPLACE(INVOICE_NO,'/','_')  
  FILENAME = CLIENT_CODE+'_'+ REPLACE(INVOICE_NO,'/','_'),  
  QR_CODE,  
IRN_NO  
 FROM        
   #GST_INVOICE        
 ORDER BY            
  CLIENT_CODE,            
  INVOICE_NO,          
  INVOICE_DATE          
/*      
 ORDER BY        
  INVOICE_DATE,        
  CLIENT_CODE */       
          
 DROP TABLE #GST_INVOICE        
 DROP TABLE #GSTINVOICE      
 DROP TABLE #CLDETAILS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PLEDGE_MARGIN_MTF_DIFF
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_PLEDGE_MARGIN_MTF_DIFF]
(@TODATE DATETIME)  
  
AS
Select exchange,segment,Party_Code,scrip_Cd,series,ISIN,Qty Into #colla from MSAJAG..collateraldetails (Nolock)
where effdate=@TODATE and cash_Ncash ='N'

Select exchange,segment,Party_Code,scrip_Cd,series,ISIN,Qty Into #Margin_Colla from MSAJAG..v2_tbl_collateral_margin_combine (Nolock)
where effdate=@TODATE

Select Party_Code,ISIN,Qty Into #MTf  from MTFTRADE.dbo.tbl_mtf_marking (Nolock)
where sauda_date=@TODATE and HOLDFLAG ='FOCOLL'

Alter table #colla
Add Margin_Qty numeric(18,4),Mtf_Adjustment Numeric(18,4)


Create index #c on #colla(exchange,segment,Party_Code,ISIN)
Create index #c on #Margin_Colla(exchange,segment,Party_Code,ISIN)
Create index #c on #MTf(Party_Code,ISIN)
 

Update C Set Margin_Qty =0 ,Mtf_Adjustment=0 from #colla C

Update C Set Margin_Qty=M.QTY from #colla C, #Margin_Colla M
where C.Exchange=M.EXCHANGE and C.Segment =M.SEGMENT and C.Party_Code=M.PARTY_CODE and C.Isin=M.ISIN

Update C Set Mtf_Adjustment=M.QTY from #colla C, #MTf M
where   C.Party_Code=M.PARTY_CODE and C.Isin=M.ISIN


	IF OBJECT_ID(N'SCRATCHPAD..COLLATERAL_RECON_DATA') IS NOT NULL
    DROP TABLE COLLATERAL_RECON_DATA

    SELECT *
    INTO COLLATERAL_RECON_DATA
    FROM #colla
    WHERE Qty <> Margin_qty;
	
      
	  DECLARE @COUNT VARCHAR (MAX) 
	  SELECT @COUNT=COUNT(1) FROM COLLATERAL_RECON_DATA WHERE Qty <> Margin_qty;

    DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\BHARAT\OUTPUT\' + 'COLLATERAL_DATA' + '.CSV';

    DECLARE @ALL VARCHAR(MAX)  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''EXCHANGE'''',''''SEGMENT'''',''''PARTY_CODE'''',''''SCRIP_CD'''',''''SERIES'''',''''ISIN'''',''''QTY'''',''''MARGIN_QTY'''',''''MTF_ADJUSTMENT'''''
SET @all = @all+ ' UNION ALL SELECT EXCHANGE,SEGMENT,PARTY_CODE,SCRIP_CD,SERIES,ISIN,CONVERT (VARCHAR,QTY),CONVERT (VARCHAR,MARGIN_QTY),CONVERT (VARCHAR,MTF_ADJUSTMENT) FROM SCRATCHPAD.DBO.COLLATERAL_RECON_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

    DROP TABLE #colla;
    DROP TABLE #Margin_Colla;
    DROP TABLE #MTf;
    DROP TABLE COLLATERAL_RECON_DATA;

    SELECT 'MTF_ADJUSTMENT DATA EXPORTED TO ' + @FILENAME +' AND THE TOTAL COUNT IS ' + @COUNT AS 'REMARK';

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VDT_LEDGER_ALL
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_VDT_LEDGER_ALL] (@TODATE DATETIME)  
    --CREATE THIS SP UNDER ORE-4382 
  --REQUESTED BY NIRMAL PUROHIT

AS --- RPT_VDT_LEDGER_ALL 'OCT 11 2021','A686863'  
    DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\BACKOFFICE\NIRMAL\INPUT\CLIENT_VDT.CSV'
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL
    DROP TABLE #CODE
CREATE TABLE #CODE (CLTCODE VARCHAR(50))
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
    (
           FIRSTROW = 1,
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW
           TABLOCK
    )'
SET @SQLFINAL= @SQL + @SQL2
PRINT @SQLFINAL
EXEC (@SQLFINAL)

DECLARE @FDATE VARCHAR(11)  
SELECT @FDATE =SDTCUR FROM ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR      
  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                    
FROM ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                    
FROM AngelBSECM.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                    
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                    
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                    
FROM MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,OPPBAL=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' FROM (  
SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT  
FROM ANGELFO.BBO_FA.DBO.ACC_TBL1 A (NOLOCK), ANGELFO.BBO_FA.DBO.ACC_TBL3 B (NOLOCK)  
WHERE A.SNO = B.MASTERSNO  AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) BETWEEN @FDATE AND @TODATE + ' 23:59:59' ) B   
WHERE CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                    
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                    
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                    
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                    
FROM ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                    
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                    
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
INSERT INTO #VDTLED  
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCE'                    
FROM ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TODATE  + ' 23:59'   
AND CLTCODE IN (SELECT * FROM #CODE)  
GROUP BY CLTCODE  
  
  IF OBJECT_ID(N'SCRATCHPAD..CLIENT_VDT_DATA') IS NOT NULL
    DROP TABLE CLIENT_VDT_DATA
  
SELECT REPORT_DATE=CONVERT(VARCHAR(11),@TODATE,105),CLTCODE,[NSECM]=ISNULL([NSECM],0),[BSECM]=ISNULL([BSECM],0),[NSEFO]=ISNULL([NSEFO],0),[BSEFO]=ISNULL([BSEFO],0),[BSEMF]=ISNULL([BSEMF],0),  
[MTF]=ISNULL([MTF],0),[SLBS]=ISNULL([SLBS],0),[NSECD]=ISNULL([NSECD],0),[BSECD]=ISNULL([BSECD],0),[MCXCD]=ISNULL([MCXCD],0),  
[MCDX]=ISNULL([MCDX],0),[NCDX]=ISNULL([NCDX],0),[NCE]=ISNULL([NCE],0),  
NET_BALANCE=ISNULL([NSECM],0)+ISNULL([BSECM],0)+ISNULL([NSEFO],0)+ISNULL([BSEFO],0)+ISNULL([BSEMF],0)+ISNULL([MTF],0)+ISNULL([SLBS],0)+ISNULL([NSECD],0)  
+ISNULL([BSECD],0)+ISNULL([MCXCD],0)+ISNULL([MCDX],0)+ISNULL([NCDX],0)+ISNULL([NCE],0)  
INTO CLIENT_VDT_DATA FROM ( SELECT CLTCODE,NETAMT,EXCHANGE FROM #VDTLED ) AS SourceTable  
PIVOT  
(SUM(NETAMT) FOR EXCHANGE IN ([NSECM],[BSECM],[NSEFO],[BSEFO],[BSEMF],[MTF],[SLBS],[NSECD],[BSECD],[MCXCD],[MCDX],[NCDX],[NCE])) AS PivotTable  
ORDER BY PivotTable.CLTCODE

DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\NIRMAL\OUTPUT\' +'CLIENT_VDT' + '.CSV'        
DECLARE @ALL VARCHAR(MAX)                  
                  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''REPORT_DATE'''',''''CLTCODE'''',''''NSECM'''',''''BSECM'''',''''NSEFO'''',''''BSEFO'''',''''BSEMF'''',''''MTF'''',''''SLBS'''',''''NSECD'''',''''BSECD'''',''''MCXCD'''',''''MCDX'''',''''NCDX'''',''''NCE'''',''''NET_BALANCE'''''
SET @all = @all+ ' UNION ALL SELECT REPORT_DATE,CLTCODE,CONVERT(VARCHAR(max),NSECM),CONVERT(VARCHAR(max),BSECM),CONVERT(VARCHAR(max),NSEFO),CONVERT(VARCHAR(max),BSEFO),CONVERT(VARCHAR(max),BSEMF),CONVERT(VARCHAR(max),MTF),CONVERT(VARCHAR(max),SLBS),CONVERT(VARCHAR(max),NSECD),CONVERT(VARCHAR(max),BSECD),CONVERT(VARCHAR(max),MCXCD),CONVERT(VARCHAR(max),MCDX),CONVERT(VARCHAR(max),NCDX),CONVERT(VARCHAR(max),NCE),CONVERT(VARCHAR(max),NET_BALANCE) FROM SCRATCHPAD.DBO.CLIENT_VDT_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

DROP TABLE #CODE
DROP TABLE #VDTLED
DROP TABLE CLIENT_VDT_DATA

SELECT 'CLIENT VDT FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_DETAIL_REPORT
-- --------------------------------------------------

---|| DESCRIPTION :- BROK DETAILS REPORT KYC TEAM (NILESH PAWAR)
---|| CREATED BY :- HRISHI Y
---|| CREATED DATE :- 03-NOV-2024

CREATE PROC [dbo].[USP_BROK_DETAIL_REPORT]

AS

DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\Backoffice\SL_AUTO\NILESH_P\BROK_DATA\INPUT\INPUT.txt'

IF OBJECT_ID(N'tempdb..#INPUT_DATA') IS NOT NULL
DROP TABLE #INPUT_DATA
CREATE TABLE #INPUT_DATA (CODE VARCHAR (100))

SET @SQL='BULK INSERT #INPUT_DATA FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
(                                          
       FIRSTROW = 1,                                          
       FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER                                          
       ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW                                          
       TABLOCK                                          
)'

SET @SQLFINAL= @SQL + @SQL2          
PRINT @SQLFINAL          
EXEC (@SQLFINAL)          

--SELECT TOP 10 * FROM #INPUT_DATA

--DECLARE @TDATE DATETIME = 'SEP  2 2024'

IF OBJECT_ID(N'TEMPDB..#CHECKBROK') IS NOT NULL
DROP TABLE #CHECKBROK

SELECT CL_CODE,EXCH = EXCHANGE+SEGMENT,BROK_SCHEME,TRD_BROK,DEL_BROK,CASH_VBB_TRD='00',CASH_VBB_DEL='00',                
Fut_Opt_Brok,                
Fut_Fut_Fin_Brok,                
Fut_Opt_Exc,                
Fut_Brok_Applicable                ,
OPT_VBB_TRD='00',OPT_VBB_DEL='00',BTB_BTC = ''         
INTO #CHECKBROK                
FROM MSAJAG.DBO.CLIENT_BROK_DETAILS C WITH (NOLOCK)  INNER JOIN #INPUT_DATA I ON C.CL_CODE=I.CODE

CREATE INDEX CLIIDX ON #CHECKBROK (CL_CODE,EXCH)                

DELETE FROM #CHECKBROK WHERE EXCH IN ('BSXFUTURES','MCDFUTURES','NSESLBS')

UPDATE #CHECKBROK SET CASH_VBB_TRD = SP_SCHEME_ID FROM                
MSAJAG.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NSECAPITAL'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO AND SP_TRD_TYPE= 'TRD'        AND SP_SCRIP = 'ALL'          
                
UPDATE #CHECKBROK SET CASH_VBB_DEL = SP_SCHEME_ID FROM                
MSAJAG.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NSECAPITAL'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO AND SP_TRD_TYPE= 'DEL'           AND SP_SCRIP = 'ALL'       
                
UPDATE #CHECKBROK SET CASH_VBB_TRD = SP_SCHEME_ID FROM                
ANAND.BSEDB_AB.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'BSECAPITAL'                 
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO  AND SP_TRD_TYPE= 'TRD'         AND SP_SCRIP = 'ALL'         
                
UPDATE #CHECKBROK SET CASH_VBB_DEL = SP_SCHEME_ID FROM                
ANAND.BSEDB_AB.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'BSECAPITAL'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO AND SP_TRD_TYPE= 'DEL'           AND SP_SCRIP = 'ALL'       
                
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                
ANGELFO.NSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NSEFUTURES'                 
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'TRD'        AND SP_SCRIP = 'ALL'           
                
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                
ANGELFO.NSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE   AND EXCH = 'NSEFUTURES'                 
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'DEL'        AND SP_SCRIP = 'ALL'           
                
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                
ANGELFO.NSECURFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NSXFUTURES'                 
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'TRD'        AND SP_SCRIP = 'ALL'           
                
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                
ANGELFO.NSECURFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NSXFUTURES'                
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'DEL'           AND SP_SCRIP = 'ALL'       
                
                
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                
ANGELCOMMODITY.NCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NCXFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'TRD'       AND SP_SCRIP = 'ALL'         
                
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                
ANGELCOMMODITY.NCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NCXFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                
AND SP_INST_TYPE = 'OPT'              AND SP_TRD_TYPE= 'DEL'       AND SP_SCRIP = 'ALL'            
                
                
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                
ANGELCOMMODITY.MCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'MCXFUTURES'                
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                 
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'TRD'           AND SP_SCRIP = 'ALL'       
                
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                
ANGELCOMMODITY.MCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'MCXFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                 
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'DEL'     AND SP_SCRIP = 'ALL'    


UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                
ANGELCOMMODITY.BSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'BSEFUTURES'                
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                 
AND SP_Product_Type = 'OPT'                
AND SP_TRD_TYPE= 'TRD'           AND SP_Product_code = 'ALL'       

UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                
ANGELCOMMODITY.BSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'BSEFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                 
AND SP_Product_Type = 'OPT'                
AND SP_TRD_TYPE= 'DEL'     AND SP_Product_code = 'ALL'   

UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                
ANGELCOMMODITY.NCE.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NCEFUTURES'                
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                 
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'TRD'           AND SP_SCRIP = 'ALL'       
                
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                
ANGELCOMMODITY.NCE.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NCEFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                 
AND SP_INST_TYPE = 'OPT'                
AND SP_TRD_TYPE= 'DEL'     AND SP_SCRIP = 'ALL'     

------->> 2ND FILE LOGIC

SELECT CL_CODE,MAX(ISNULL([BSECAPITAL_BROK_SCHEME],'')) AS [BSECAPITAL_BROK_SCHEME],
MAX(ISNULL([BSEFUTURES_BROK_SCHEME],'')) AS [BSEFUTURES_BROK_SCHEME],
MAX(ISNULL([MCXFUTURES_BROK_SCHEME],'')) AS [MCXFUTURES_BROK_SCHEME],
MAX(ISNULL([NCXFUTURES_BROK_SCHEME],'')) AS [NCXFUTURES_BROK_SCHEME],
MAX(ISNULL([NSECAPITAL_BROK_SCHEME],'')) AS [NSECAPITAL_BROK_SCHEME],
MAX(ISNULL([NSEFUTURES_BROK_SCHEME],'')) AS [NSEFUTURES_BROK_SCHEME],
MAX(ISNULL([NSXFUTURES_BROK_SCHEME],'')) AS [NSXFUTURES_BROK_SCHEME],
MAX(ISNULL([NCEFUTURES_BROK_SCHEME],'')) AS [NCEFUTURES_BROK_SCHEME],
MAX(ISNULL([BSECAPITAL_TRD_BROK],'')) AS [BSECAPITAL_TRD_BROK],
MAX(ISNULL([BSEFUTURES_TRD_BROK],'')) AS [BSEFUTURES_TRD_BROK],
MAX(ISNULL([MCXFUTURES_TRD_BROK],'')) AS [MCXFUTURES_TRD_BROK],
MAX(ISNULL([NCXFUTURES_TRD_BROK],'')) AS [NCXFUTURES_TRD_BROK],
MAX(ISNULL([NSECAPITAL_TRD_BROK],'')) AS [NSECAPITAL_TRD_BROK],
MAX(ISNULL([NSEFUTURES_TRD_BROK],'')) AS [NSEFUTURES_TRD_BROK],
MAX(ISNULL([NSXFUTURES_TRD_BROK],'')) AS [NSXFUTURES_TRD_BROK],
MAX(ISNULL([NCEFUTURES_TRD_BROK],'')) AS [NCEFUTURES_TRD_BROK],
MAX(ISNULL([BSECAPITAL_DEL_BROK],'')) AS [BSECAPITAL_DEL_BROK],
MAX(ISNULL([BSEFUTURES_DEL_BROK],'')) AS [BSEFUTURES_DEL_BROK],
MAX(ISNULL([MCXFUTURES_DEL_BROK],'')) AS [MCXFUTURES_DEL_BROK],
MAX(ISNULL([NCXFUTURES_DEL_BROK],'')) AS [NCXFUTURES_DEL_BROK],
MAX(ISNULL([NSECAPITAL_DEL_BROK],'')) AS [NSECAPITAL_DEL_BROK],
MAX(ISNULL([NSEFUTURES_DEL_BROK],'')) AS [NSEFUTURES_DEL_BROK],
MAX(ISNULL([NSXFUTURES_DEL_BROK],'')) AS [NSXFUTURES_DEL_BROK],
MAX(ISNULL([NCEFUTURES_DEL_BROK],'')) AS [NCEFUTURES_DEL_BROK],
MAX(ISNULL([BSECAPITAL_CASH_VBB_TRD],'')) AS [BSECAPITAL_CASH_VBB_TRD],
MAX(ISNULL([BSEFUTURES_CASH_VBB_TRD],'')) AS [BSEFUTURES_CASH_VBB_TRD],
MAX(ISNULL([MCXFUTURES_CASH_VBB_TRD],'')) AS [MCXFUTURES_CASH_VBB_TRD],
MAX(ISNULL([NCXFUTURES_CASH_VBB_TRD],'')) AS [NCXFUTURES_CASH_VBB_TRD],
MAX(ISNULL([NSECAPITAL_CASH_VBB_TRD],'')) AS [NSECAPITAL_CASH_VBB_TRD],
MAX(ISNULL([NSEFUTURES_CASH_VBB_TRD],'')) AS [NSEFUTURES_CASH_VBB_TRD],
MAX(ISNULL([NSXFUTURES_CASH_VBB_TRD],'')) AS [NSXFUTURES_CASH_VBB_TRD],
MAX(ISNULL([NCEFUTURES_CASH_VBB_TRD],'')) AS [NCEFUTURES_CASH_VBB_TRD],
MAX(ISNULL([BSECAPITAL_CASH_VBB_DEL],'')) AS [BSECAPITAL_CASH_VBB_DEL],
MAX(ISNULL([BSEFUTURES_CASH_VBB_DEL],'')) AS [BSEFUTURES_CASH_VBB_DEL],
MAX(ISNULL([MCXFUTURES_CASH_VBB_DEL],'')) AS [MCXFUTURES_CASH_VBB_DEL],
MAX(ISNULL([NCXFUTURES_CASH_VBB_DEL],'')) AS [NCXFUTURES_CASH_VBB_DEL],
MAX(ISNULL([NSECAPITAL_CASH_VBB_DEL],'')) AS [NSECAPITAL_CASH_VBB_DEL],
MAX(ISNULL([NSEFUTURES_CASH_VBB_DEL],'')) AS [NSEFUTURES_CASH_VBB_DEL],
MAX(ISNULL([NSXFUTURES_CASH_VBB_DEL],'')) AS [NSXFUTURES_CASH_VBB_DEL],
MAX(ISNULL([NCEFUTURES_CASH_VBB_DEL],'')) AS [NCEFUTURES_CASH_VBB_DEL],
MAX(ISNULL([BSECAPITAL_FUT_OPT_BROK],'')) AS [BSECAPITAL_FUT_OPT_BROK],
MAX(ISNULL([BSEFUTURES_FUT_OPT_BROK],'')) AS [BSEFUTURES_FUT_OPT_BROK],
MAX(ISNULL([MCXFUTURES_FUT_OPT_BROK],'')) AS [MCXFUTURES_FUT_OPT_BROK],
MAX(ISNULL([NCXFUTURES_FUT_OPT_BROK],'')) AS [NCXFUTURES_FUT_OPT_BROK],
MAX(ISNULL([NSECAPITAL_FUT_OPT_BROK],'')) AS [NSECAPITAL_FUT_OPT_BROK],
MAX(ISNULL([NSEFUTURES_FUT_OPT_BROK],'')) AS [NSEFUTURES_FUT_OPT_BROK],
MAX(ISNULL([NSXFUTURES_FUT_OPT_BROK],'')) AS [NSXFUTURES_FUT_OPT_BROK],
MAX(ISNULL([NCEFUTURES_FUT_OPT_BROK],'')) AS [NCEFUTURES_FUT_OPT_BROK],
MAX(ISNULL([BSECAPITAL_FUT_FUT_FIN_BROK],'')) AS [BSECAPITAL_FUT_FUT_FIN_BROK],
MAX(ISNULL([BSEFUTURES_FUT_FUT_FIN_BROK],'')) AS [BSEFUTURES_FUT_FUT_FIN_BROK],
MAX(ISNULL([MCXFUTURES_FUT_FUT_FIN_BROK],'')) AS [MCXFUTURES_FUT_FUT_FIN_BROK],
MAX(ISNULL([NCXFUTURES_FUT_FUT_FIN_BROK],'')) AS [NCXFUTURES_FUT_FUT_FIN_BROK],
MAX(ISNULL([NSECAPITAL_FUT_FUT_FIN_BROK],'')) AS [NSECAPITAL_FUT_FUT_FIN_BROK],
MAX(ISNULL([NSEFUTURES_FUT_FUT_FIN_BROK],'')) AS [NSEFUTURES_FUT_FUT_FIN_BROK],
MAX(ISNULL([NSXFUTURES_FUT_FUT_FIN_BROK],'')) AS [NSXFUTURES_FUT_FUT_FIN_BROK],
MAX(ISNULL([NCEFUTURES_FUT_FUT_FIN_BROK],'')) AS [NCEFUTURES_FUT_FUT_FIN_BROK],
MAX(ISNULL([BSECAPITAL_FUT_OPT_EXC],'')) AS [BSECAPITAL_FUT_OPT_EXC],
MAX(ISNULL([BSEFUTURES_FUT_OPT_EXC],'')) AS [BSEFUTURES_FUT_OPT_EXC],
MAX(ISNULL([MCXFUTURES_FUT_OPT_EXC],'')) AS [MCXFUTURES_FUT_OPT_EXC],
MAX(ISNULL([NCXFUTURES_FUT_OPT_EXC],'')) AS [NCXFUTURES_FUT_OPT_EXC],
MAX(ISNULL([NSECAPITAL_FUT_OPT_EXC],'')) AS [NSECAPITAL_FUT_OPT_EXC],
MAX(ISNULL([NSEFUTURES_FUT_OPT_EXC],'')) AS [NSEFUTURES_FUT_OPT_EXC],
MAX(ISNULL([NSXFUTURES_FUT_OPT_EXC],'')) AS [NSXFUTURES_FUT_OPT_EXC],
MAX(ISNULL([NCEFUTURES_FUT_OPT_EXC],'')) AS [NCEFUTURES_FUT_OPT_EXC],
MAX(ISNULL([BSECAPITAL_FUT_BROK_APPLICABLE],'')) AS [BSECAPITAL_FUT_BROK_APPLICABLE],
MAX(ISNULL([BSEFUTURES_FUT_BROK_APPLICABLE],'')) AS [BSEFUTURES_FUT_BROK_APPLICABLE],
MAX(ISNULL([MCXFUTURES_FUT_BROK_APPLICABLE],'')) AS [MCXFUTURES_FUT_BROK_APPLICABLE],
MAX(ISNULL([NCXFUTURES_FUT_BROK_APPLICABLE],'')) AS [NCXFUTURES_FUT_BROK_APPLICABLE],
MAX(ISNULL([NSECAPITAL_FUT_BROK_APPLICABLE],'')) AS [NSECAPITAL_FUT_BROK_APPLICABLE],
MAX(ISNULL([NSEFUTURES_FUT_BROK_APPLICABLE],'')) AS [NSEFUTURES_FUT_BROK_APPLICABLE],
MAX(ISNULL([NSXFUTURES_FUT_BROK_APPLICABLE],'')) AS [NSXFUTURES_FUT_BROK_APPLICABLE],
MAX(ISNULL([NCEFUTURES_FUT_BROK_APPLICABLE],'')) AS [NCEFUTURES_FUT_BROK_APPLICABLE],
MAX(ISNULL([BSECAPITAL_OPT_VBB_TRD],'')) AS [BSECAPITAL_OPT_VBB_TRD],
MAX(ISNULL([BSEFUTURES_OPT_VBB_TRD],'')) AS [BSEFUTURES_OPT_VBB_TRD],
MAX(ISNULL([MCXFUTURES_OPT_VBB_TRD],'')) AS [MCXFUTURES_OPT_VBB_TRD],
MAX(ISNULL([NCXFUTURES_OPT_VBB_TRD],'')) AS [NCXFUTURES_OPT_VBB_TRD],
MAX(ISNULL([NSECAPITAL_OPT_VBB_TRD],'')) AS [NSECAPITAL_OPT_VBB_TRD],
MAX(ISNULL([NSEFUTURES_OPT_VBB_TRD],'')) AS [NSEFUTURES_OPT_VBB_TRD],
MAX(ISNULL([NSXFUTURES_OPT_VBB_TRD],'')) AS [NSXFUTURES_OPT_VBB_TRD],
MAX(ISNULL([NCEFUTURES_OPT_VBB_TRD],'')) AS [NCEFUTURES_OPT_VBB_TRD],
MAX(ISNULL([BSECAPITAL_OPT_VBB_DEL],'')) AS [BSECAPITAL_OPT_VBB_DEL],
MAX(ISNULL([BSEFUTURES_OPT_VBB_DEL],'')) AS [BSEFUTURES_OPT_VBB_DEL],
MAX(ISNULL([MCXFUTURES_OPT_VBB_DEL],'')) AS [MCXFUTURES_OPT_VBB_DEL],
MAX(ISNULL([NCXFUTURES_OPT_VBB_DEL],'')) AS [NCXFUTURES_OPT_VBB_DEL],
MAX(ISNULL([NSECAPITAL_OPT_VBB_DEL],'')) AS [NSECAPITAL_OPT_VBB_DEL],
MAX(ISNULL([NSEFUTURES_OPT_VBB_DEL],'')) AS [NSEFUTURES_OPT_VBB_DEL],
MAX(ISNULL([NSXFUTURES_OPT_VBB_DEL],'')) AS [NSXFUTURES_OPT_VBB_DEL],
MAX(ISNULL([NCEFUTURES_OPT_VBB_DEL],'')) AS [NCEFUTURES_OPT_VBB_DEL] INTO #CHECKBROK1
FROM 
(SELECT CL_CODE,EXCH+'_'+'BROK_SCHEME' AS EXCH_BROK_SCHEME
,EXCH+'_'+'TRD_BROK' AS EXCH_TRD_BROK,EXCH+'_'+'DEL_BROK' AS EXCH_DEL_BROK,EXCH+'_'+'CASH_VBB_TRD' AS EXCH_CASH_VBB_TRD,
EXCH+'_'+'CASH_VBB_DEL' AS EXCH_CASH_VBB_DEL,
EXCH+'_'+'FUT_OPT_BROK' AS EXCH_FUT_OPT_BROK,
EXCH+'_'+'FUT_FUT_FIN_BROK' AS EXCH_FUT_FUT_FIN_BROK,
EXCH+'_'+'FUT_OPT_EXC' AS EXCH_FUT_OPT_EXC,
EXCH+'_'+'FUT_BROK_APPLICABLE' AS EXCH_FUT_BROK_APPLICABLE,
EXCH+'_'+'OPT_VBB_TRD' AS EXCH_OPT_VBB_TRD,
EXCH+'_'+'OPT_VBB_DEL' AS EXCH_OPT_VBB_DEL,
BROK_SCHEME,TRD_BROK,DEL_BROK,CASH_VBB_TRD,CASH_VBB_DEL,FUT_OPT_BROK,FUT_FUT_FIN_BROK,FUT_OPT_EXC,FUT_BROK_APPLICABLE,OPT_VBB_TRD,OPT_VBB_DEL FROM #CHECKBROK) AS SOUR
PIVOT
(MAX(BROK_SCHEME) FOR EXCH_BROK_SCHEME IN ([BSECAPITAL_BROK_SCHEME],[BSEFUTURES_BROK_SCHEME],[MCXFUTURES_BROK_SCHEME],[NCXFUTURES_BROK_SCHEME],
[NSECAPITAL_BROK_SCHEME],[NSEFUTURES_BROK_SCHEME],[NSXFUTURES_BROK_SCHEME],[NCEFUTURES_BROK_SCHEME])) AS PVT
PIVOT
(MAX(TRD_BROK) FOR EXCH_TRD_BROK IN ([BSECAPITAL_TRD_BROK],
[BSEFUTURES_TRD_BROK],
[MCXFUTURES_TRD_BROK],
[NCXFUTURES_TRD_BROK],
[NSECAPITAL_TRD_BROK],
[NSEFUTURES_TRD_BROK],
[NSXFUTURES_TRD_BROK],
[NCEFUTURES_TRD_BROK])) AS PVT2
PIVOT
(MAX(DEL_BROK) FOR EXCH_DEL_BROK IN ([BSECAPITAL_DEL_BROK],
[BSEFUTURES_DEL_BROK],
[MCXFUTURES_DEL_BROK],
[NCXFUTURES_DEL_BROK],
[NSECAPITAL_DEL_BROK],
[NSEFUTURES_DEL_BROK],
[NSXFUTURES_DEL_BROK],
[NCEFUTURES_DEL_BROK])) AS PVT3
PIVOT
(MAX(CASH_VBB_TRD) FOR EXCH_CASH_VBB_TRD IN ([BSECAPITAL_CASH_VBB_TRD],
[BSEFUTURES_CASH_VBB_TRD],
[MCXFUTURES_CASH_VBB_TRD],
[NCXFUTURES_CASH_VBB_TRD],
[NSECAPITAL_CASH_VBB_TRD],
[NSEFUTURES_CASH_VBB_TRD],
[NSXFUTURES_CASH_VBB_TRD],
[NCEFUTURES_CASH_VBB_TRD])) AS PVT4
PIVOT
(MAX(CASH_VBB_DEL) FOR EXCH_CASH_VBB_DEL IN ([BSECAPITAL_CASH_VBB_DEL],
[BSEFUTURES_CASH_VBB_DEL],
[MCXFUTURES_CASH_VBB_DEL],
[NCXFUTURES_CASH_VBB_DEL],
[NSECAPITAL_CASH_VBB_DEL],
[NSEFUTURES_CASH_VBB_DEL],
[NSXFUTURES_CASH_VBB_DEL],
[NCEFUTURES_CASH_VBB_DEL])) AS PVT5
PIVOT
(MAX(FUT_OPT_BROK) FOR EXCH_FUT_OPT_BROK IN ([BSECAPITAL_FUT_OPT_BROK],
[BSEFUTURES_FUT_OPT_BROK],
[MCXFUTURES_FUT_OPT_BROK],
[NCXFUTURES_FUT_OPT_BROK],
[NSECAPITAL_FUT_OPT_BROK],
[NSEFUTURES_FUT_OPT_BROK],
[NSXFUTURES_FUT_OPT_BROK],
[NCEFUTURES_FUT_OPT_BROK])) AS PVT6
PIVOT
(MAX(FUT_FUT_FIN_BROK) FOR EXCH_FUT_FUT_FIN_BROK IN ([BSECAPITAL_FUT_FUT_FIN_BROK],
[BSEFUTURES_FUT_FUT_FIN_BROK],
[MCXFUTURES_FUT_FUT_FIN_BROK],
[NCXFUTURES_FUT_FUT_FIN_BROK],
[NSECAPITAL_FUT_FUT_FIN_BROK],
[NSEFUTURES_FUT_FUT_FIN_BROK],
[NSXFUTURES_FUT_FUT_FIN_BROK],
[NCEFUTURES_FUT_FUT_FIN_BROK])) AS PVT7
PIVOT
(MAX(FUT_OPT_EXC) FOR EXCH_FUT_OPT_EXC IN ([BSECAPITAL_FUT_OPT_EXC],
[BSEFUTURES_FUT_OPT_EXC],
[MCXFUTURES_FUT_OPT_EXC],
[NCXFUTURES_FUT_OPT_EXC],
[NSECAPITAL_FUT_OPT_EXC],
[NSEFUTURES_FUT_OPT_EXC],
[NSXFUTURES_FUT_OPT_EXC],
[NCEFUTURES_FUT_OPT_EXC])) AS PVT8
PIVOT
(MAX(FUT_BROK_APPLICABLE) FOR EXCH_FUT_BROK_APPLICABLE IN ([BSECAPITAL_FUT_BROK_APPLICABLE],
[BSEFUTURES_FUT_BROK_APPLICABLE],
[MCXFUTURES_FUT_BROK_APPLICABLE],
[NCXFUTURES_FUT_BROK_APPLICABLE],
[NSECAPITAL_FUT_BROK_APPLICABLE],
[NSEFUTURES_FUT_BROK_APPLICABLE],
[NSXFUTURES_FUT_BROK_APPLICABLE],
[NCEFUTURES_FUT_BROK_APPLICABLE])) AS PVT9
PIVOT
(MAX(OPT_VBB_TRD) FOR EXCH_OPT_VBB_TRD IN ([BSECAPITAL_OPT_VBB_TRD],
[BSEFUTURES_OPT_VBB_TRD],
[MCXFUTURES_OPT_VBB_TRD],
[NCXFUTURES_OPT_VBB_TRD],
[NSECAPITAL_OPT_VBB_TRD],
[NSEFUTURES_OPT_VBB_TRD],
[NSXFUTURES_OPT_VBB_TRD],
[NCEFUTURES_OPT_VBB_TRD])) AS PVT10
PIVOT
(MAX(OPT_VBB_DEL) FOR EXCH_OPT_VBB_DEL IN ([BSECAPITAL_OPT_VBB_DEL],
[BSEFUTURES_OPT_VBB_DEL],
[MCXFUTURES_OPT_VBB_DEL],
[NCXFUTURES_OPT_VBB_DEL],
[NSECAPITAL_OPT_VBB_DEL],
[NSEFUTURES_OPT_VBB_DEL],
[NSXFUTURES_OPT_VBB_DEL],
[NCEFUTURES_OPT_VBB_DEL])) AS PVT11
GROUP BY CL_CODE


TRUNCATE TABLE SCRATCHPAD.DBO.TBL_BROK_DETAILS_DATA
TRUNCATE TABLE SCRATCHPAD.DBO.TBL_BROK_DETAILS_DATA_PIVOT

INSERT INTO SCRATCHPAD.DBO.TBL_BROK_DETAILS_DATA
SELECT CL_CODE,EXCH,CONVERT(VARCHAR (20),BROK_SCHEME) AS BROK_SCHEME, CONVERT(VARCHAR (20),TRD_BROK) AS TRD_BROK, CONVERT(VARCHAR (20),DEL_BROK) AS DEL_BROK, CASH_VBB_TRD, CASH_VBB_DEL,
CONVERT(VARCHAR (20),Fut_Opt_Brok) AS Fut_Opt_Brok, CONVERT(VARCHAR (20),Fut_Fut_Fin_Brok) AS Fut_Fut_Fin_Brok, CONVERT(VARCHAR (20),Fut_Opt_Exc) AS Fut_Opt_Exc, CONVERT(VARCHAR (20),Fut_Brok_Applicable) AS Fut_Brok_Applicable,
OPT_VBB_TRD, OPT_VBB_DEL, BTB_BTC
FROM #CHECKBROK

--INSERT INTO SCRATCHPAD.DBO.TBL_BROK_DETAILS_DATA_PIVOT
--SELECT CL_CODE, CAST (BSECAPITAL_BROK_SCHEME AS VARCHAR) AS BSECAPITAL_BROK_SCHEME, BSECAPITAL_CASH_VBB_DEL, BSECAPITAL_CASH_VBB_TRD, CAST (BSECAPITAL_DEL_BROK AS VARCHAR) AS BSECAPITAL_DEL_BROK,
--CAST (BSECAPITAL_FUT_BROK_APPLICABLE AS VARCHAR) AS BSECAPITAL_FUT_BROK_APPLICABLE, CAST (BSECAPITAL_FUT_FUT_FIN_BROK AS VARCHAR) AS BSECAPITAL_FUT_FUT_FIN_BROK, 
--CAST (BSECAPITAL_FUT_OPT_BROK AS VARCHAR) AS BSECAPITAL_FUT_OPT_BROK, CAST (BSECAPITAL_FUT_OPT_EXC AS VARCHAR) AS BSECAPITAL_FUT_OPT_EXC, BSECAPITAL_OPT_VBB_DEL, BSECAPITAL_OPT_VBB_TRD,
--CAST (BSECAPITAL_TRD_BROK AS VARCHAR) AS BSECAPITAL_TRD_BROK, CAST (BSEFUTURES_BROK_SCHEME AS VARCHAR) AS BSEFUTURES_BROK_SCHEME, BSEFUTURES_CASH_VBB_DEL, BSEFUTURES_CASH_VBB_TRD,
--CAST (BSEFUTURES_DEL_BROK AS VARCHAR) AS BSEFUTURES_DEL_BROK, CAST (BSEFUTURES_FUT_BROK_APPLICABLE AS VARCHAR) AS BSEFUTURES_FUT_BROK_APPLICABLE, CAST (BSEFUTURES_FUT_FUT_FIN_BROK AS VARCHAR) AS BSEFUTURES_FUT_FUT_FIN_BROK,
--CAST (BSEFUTURES_FUT_OPT_BROK AS VARCHAR) AS BSEFUTURES_FUT_OPT_BROK, CAST (BSEFUTURES_FUT_OPT_EXC AS VARCHAR) AS BSEFUTURES_FUT_OPT_EXC,

--FROM #CHECKBROK1

---------------------- || FILE GENERATION LOGIC || ----------------------

--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(10),GETDATE(),3),'/','')          
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\SL_AUTO\NILESH_P\BROK_DATA\OUTPUT\' +'BROK_DETAIL_REPORT' + '.CSV'          
DECLARE @ALL VARCHAR(MAX)                    
                    
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''CL_CODE'''',	''''EXCH'''',	''''BROK_SCHEME'''',	''''TRD_BROK'''',	''''DEL_BROK'''',	''''CASH_VBB_TRD'''',	''''CASH_VBB_DEL'''',	''''Fut_Opt_Brok'''',	''''Fut_Fut_Fin_Brok'''',	''''Fut_Opt_Exc'''',	''''Fut_Brok_Applicable'''',	''''OPT_VBB_TRD'''',	''''OPT_VBB_DEL'''',	''''BTB_BTC'''''                    
SET @ALL = @ALL+ ' UNION ALL SELECT * FROM SCRATCHPAD.DBO.TBL_BROK_DETAILS_DATA'                  
PRINT @ALL                    
SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'                    
PRINT @ALL                    
EXEC(@ALL)                    

---------------------- || FILE GENERATION LOGIC || ----------------------
                
SELECT 'BROK DETAILS REPORT DATA FILE EXPORTED TO \\10.253.33.91\' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_MISMATCH_REPORT
-- --------------------------------------------------
  
---|| DESCRIPTION :- BROK MISMATCH REPORT KYC TEAM (NILESH PAWAR)  
---|| CREATED BY :- HRISHI Y  
---|| CREATED DATE :- 03-NOV-2024  
---Modified under ORE --ORE-4802   AND( ORE-4834 11SEP2025)  
---Modified under ORE --ORE-4998   AND( ORE-4998 20NOV2025) 
CREATE PROC [dbo].[USP_BROK_MISMATCH_REPORT] (@TDATE DATETIME)  
  
AS  
  
  
DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)  
--SET @PATH='J:\Backoffice\SL_AUTO\COMPLIANCE_REPORTS\DMS_REPORT\INPUT\INPUT.txt'     
  
IF OBJECT_ID(N'TEMPDB..#CHECKBROK') IS NOT NULL  
DROP TABLE #CHECKBROK  
  
SELECT CL_CODE,EXCH = EXCHANGE+SEGMENT,BROK_SCHEME,TRD_BROK,DEL_BROK,CASH_VBB_TRD='00',CASH_VBB_DEL='00',                  
Fut_Opt_Brok,                  
Fut_Fut_Fin_Brok,                  
Fut_Opt_Exc,                  
Fut_Brok_Applicable                ,  
OPT_VBB_TRD='00',OPT_VBB_DEL='00',BTB_BTC = ''  
INTO #CHECKBROK                      
FROM MSAJAG.DBO.CLIENT_BROK_DETAILS WITH (NOLOCK) WHERE INACTIVE_FROM >= '2049-12-31' AND IMP_STATUS = 1 --AND CL_CODE IN ('RP61','K357','AAAB022593')  
  
  
CREATE INDEX CLIIDX ON #CHECKBROK (CL_CODE,EXCH)      
  
DELETE FROM #CHECKBROK WHERE EXCH IN ('BSXFUTURES','MCDFUTURES','NSESLBS') --5908484+152  
  
  
UPDATE #CHECKBROK SET CASH_VBB_TRD = SP_SCHEME_ID FROM                  
MSAJAG.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NSECAPITAL'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO AND SP_TRD_TYPE= 'TRD'        AND SP_SCRIP = 'ALL'            
                  
UPDATE #CHECKBROK SET CASH_VBB_DEL = SP_SCHEME_ID FROM                  
MSAJAG.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NSECAPITAL'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO AND SP_TRD_TYPE= 'DEL'           AND SP_SCRIP = 'ALL'         
                  
UPDATE #CHECKBROK SET CASH_VBB_TRD = SP_SCHEME_ID FROM                  
ANAND.BSEDB_AB.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'BSECAPITAL'                   
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO  AND SP_TRD_TYPE= 'TRD'         AND SP_SCRIP = 'ALL'           
                  
UPDATE #CHECKBROK SET CASH_VBB_DEL = SP_SCHEME_ID FROM                  
ANAND.BSEDB_AB.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'BSECAPITAL'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO AND SP_TRD_TYPE= 'DEL'           AND SP_SCRIP = 'ALL'         
                  
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                  
ANGELFO.NSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NSEFUTURES'                   
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                  
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'TRD'        AND SP_SCRIP = 'ALL'             
                  
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                  
ANGELFO.NSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE   AND EXCH = 'NSEFUTURES'                   
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                  
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'DEL'        AND SP_SCRIP = 'ALL'             
                  
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                  
ANGELFO.NSECURFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NSXFUTURES'                   
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                  
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'TRD'        AND SP_SCRIP = 'ALL'             
                  
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                  
ANGELFO.NSECURFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NSXFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                  
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'DEL'           AND SP_SCRIP = 'ALL'         
                  
     
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.NCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NCXFUTURES'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                  
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'TRD'       AND SP_SCRIP = 'ALL'           
                  
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.NCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NCXFUTURES'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                  
AND SP_INST_TYPE = 'OPT'              AND SP_TRD_TYPE= 'DEL'       AND SP_SCRIP = 'ALL'              
                  
                  
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.MCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'MCXFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                   
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'TRD'           AND SP_SCRIP = 'ALL'         
                  
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.MCDX.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'MCXFUTURES'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                   
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'DEL'     AND SP_SCRIP = 'ALL'      
  
  
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.BSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'BSEFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                   
AND SP_Product_Type = 'OPT'                  
AND SP_TRD_TYPE= 'TRD'           AND SP_Product_code = 'ALL'         
  
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.BSEFO.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'BSEFUTURES'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                   
AND SP_Product_Type = 'OPT'                  
AND SP_TRD_TYPE= 'DEL'     AND SP_Product_code = 'ALL'     
  
UPDATE #CHECKBROK SET OPT_VBB_TRD = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.NCE.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE  AND EXCH = 'NCEFUTURES'                  
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                   
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'TRD'           AND SP_SCRIP = 'ALL'         
                  
UPDATE #CHECKBROK SET OPT_VBB_DEL = SP_SCHEME_ID FROM                  
ANGELCOMMODITY.NCE.DBO.SCHEME_MAPPING WITH (NOLOCK) WHERE SP_PARTY_CODE = CL_CODE AND EXCH = 'NCEFUTURES'                    
AND GETDATE () BETWEEN SP_DATE_FROM AND SP_DATE_TO                   
AND SP_INST_TYPE = 'OPT'                  
AND SP_TRD_TYPE= 'DEL'     AND SP_SCRIP = 'ALL'       
                   
--SELECT * FROM #CHECKBROK  
  
SELECT *,  
CASE   
WHEN CASH_VBB_TRD between '52' and '59' THEN 'I Trade'  
WHEN CASH_VBB_TRD between '60' and '82' THEN 'I Trade Prime'  
WHEN CASH_VBB_TRD between '83' and '84' THEN 'SUPER10 K'  
WHEN CASH_VBB_TRD between '85' and '86' THEN 'ITRADE PRIME PLUS'   
WHEN CASH_VBB_TRD between '87' and '88' THEN 'VALUE ADDED'  
WHEN CASH_VBB_TRD between '91' and '92' THEN 'ITRADE PREMIRE' ------  
WHEN CASH_VBB_TRD between '93' and '94' THEN 'I TRADE PREMIER PRO'  
WHEN CASH_VBB_TRD between '95' and '96' THEN 'I TRADE PREMIER PLUS'  
  
  
WHEN CASH_VBB_DEL between '52' and '59' THEN 'I Trade'  
WHEN CASH_VBB_DEL between '60' and '82' THEN 'I Trade Prime'  
WHEN CASH_VBB_DEL between '83' and '84' THEN 'SUPER10 K'  
WHEN CASH_VBB_DEL between '85' and '86' THEN 'ITRADE PRIME PLUS'  
WHEN CASH_VBB_DEL between '87' and '88' THEN 'VALUE ADDED'   
WHEN CASH_VBB_DEL between '91' and '92' THEN 'ITRADE PREMIRE' ------  
WHEN CASH_VBB_DEL between '93' and '94' THEN 'I TRADE PREMIER PRO'    
WHEN CASH_VBB_DEL between '95' and '96' THEN 'I TRADE PREMIER PLUS'   

WHEN OPT_VBB_TRD between '52' and '59' THEN 'I Trade'  
WHEN OPT_VBB_TRD between '60' and '82' THEN 'I Trade Prime'  
WHEN OPT_VBB_TRD between '83' and '84' THEN 'SUPER10 K'  
WHEN OPT_VBB_TRD between '85' and '86' THEN 'ITRADE PRIME PLUS'  
WHEN OPT_VBB_TRD between '87' and '88' THEN 'VALUE ADDED'   
WHEN OPT_VBB_TRD between '91' and '92' THEN 'ITRADE PREMIRE' ------  
WHEN OPT_VBB_TRD between '93' and '94' THEN 'I TRADE PREMIER PRO'  
WHEN OPT_VBB_TRD between '95' and '96' THEN 'I TRADE PREMIER PLUS'   
  
WHEN OPT_VBB_DEL between '52' and '59' THEN 'I Trade'  
WHEN OPT_VBB_DEL between '60' and '82' THEN 'I Trade Prime'  
WHEN OPT_VBB_DEL between '83' and '84' THEN 'SUPER10 K'  
WHEN OPT_VBB_DEL between '85' and '86' THEN 'ITRADE PRIME PLUS'  
WHEN OPT_VBB_DEL between '87' and '88' THEN 'VALUE ADDED'   
WHEN OPT_VBB_DEL between '91' and '92' THEN 'ITRADE PREMIRE' ------  
WHEN OPT_VBB_DEL between '93' and '94' THEN 'I TRADE PREMIER PRO'  
WHEN OPT_VBB_DEL between '95' and '96' THEN 'I TRADE PREMIER PLUS'  
END AS SCHEME  
INTO #RAWDATA  
FROM #CHECKBROK --WHERE CL_CODE<>'A1034344'   
  
SELECT CL_CODE, COUNT(CL_CODE) AS CNT, SCHEME  
INTO #PARTIALDATA   
FROM #RAWDATA GROUP BY CL_CODE,SCHEME  
  
SELECT CL_CODE , '106' AS 'REMARKS'  
INTO #FINALDATA  
FROM (  
SELECT ROW_NUMBER() OVER (PARTITION BY CL_CODE ORDER BY CL_CODE) AS ROW_NUM,* FROM #PARTIALDATA  
) ABC   
WHERE ROW_NUM<>'1'  
  
  
  
TRUNCATE TABLE SCRATCHPAD.DBO.TBL_BROKMISMATCH_DATA    
    
INSERT INTO SCRATCHPAD.DBO.TBL_BROKMISMATCH_DATA    
SELECT CL_CODE,REMARKS FROM #FINALDATA  
  
---------------------- || FILE GENERATION LOGIC || ----------------------  
  
--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(10),GETDATE(),3),'/','')            
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\SL_AUTO\NILESH_P\MISMATCH_REPORT\OUTPUT\' +'BROK_MISMATCH_REPORT' + '.CSV'            
DECLARE @ALL VARCHAR(MAX)                      
                      
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''[CL_CODE]'''',''''[REMARKS]'''''                      
SET @ALL = @ALL+ ' UNION ALL SELECT * FROM SCRATCHPAD.DBO.TBL_BROKMISMATCH_DATA'                    
PRINT @ALL                      
SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'                      
PRINT @ALL                      
EXEC(@ALL)                      
  
---------------------- || FILE GENERATION LOGIC || ----------------------  
                  
SELECT 'BROK MISMATCH DATA FILE EXPORTED TO \\10.253.33.91\' + @FILENAME AS 'REMARK'    
  
DECLARE @COUNT INT  
SELECT @COUNT=COUNT(1) FROM SCRATCHPAD.DBO.TBL_BROKMISMATCH_DATA  
----------------send dbmail---------------------------  
  
If @count>=1  
begin   
EXEC msdb.dbo.sp_send_dbmail  
    @profile_name = 'BO SUPPORT',  
    @RECIPIENTS='nilesh@angelone.in;brokerage.modification@angelone.in',                         
    --@copy_recipients ='BO.SUPPORT@ANGELBROKING.COM',                
    @subject = 'BROKERAGE MISMATCH REPORT',  
 @body = 'Hi Team,<br><br>Please find attachment of Brokerage Mismatch Report.',  
    @body_format = 'HTML',  
    @file_attachments = 'J:\Backoffice\SL_AUTO\NILESH_P\MISMATCH_REPORT\OUTPUT\BROK_MISMATCH_REPORT.CSV';  
  
 END  
 else   
 begin  
 EXEC msdb.dbo.sp_send_dbmail  
   @profile_name = 'BO SUPPORT',  
    @RECIPIENTS='nilesh@angelone.in;brokerage.modification@angelone.in',                         
    --@copy_recipients ='BO.SUPPORT@ANGELBROKING.COM',                
    @subject = 'BROKERAGE MISMATCH REPORT',  
 @body = 'Hi Team,<br><br>No records found in brokerage mismatch report.',  
    @body_format = 'HTML'  
      
  
  
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CAPITAL_MIS_RPT
-- --------------------------------------------------

---|| DESCRIPTION :- CLIENTWISE EOD AND PEAK REPORT ALLOCATION TEAM (BHAGYASHREE PRADHAN)
---|| CREATED BY :- HRISHI Y
---|| CREATED DATE :- 11-DEC-2024

CREATE PROC [dbo].[USP_CAPITAL_MIS_RPT] (@TDATE DATETIME)

AS
--DECLARE @TDATE DATETIME='2024-12-09'

DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
--SET @PATH='J:\Backoffice\SL_AUTO\COMPLIANCE_REPORTS\DMS_REPORT\INPUT\INPUT.txt'

IF OBJECT_ID(N'TEMPDB..#CAPITALREQUIREMENT_DETAIL_EOD') IS NOT NULL
DROP TABLE #CAPITALREQUIREMENT_DETAIL_EOD

SELECT --TOP 100
MDATE,PARTY_CODE,MAX_MARGIN,EPIAMOUNT,MAX_VDT,MAX_EDT, 
CASE WHEN [SUM OF HC MISMATCH] like '-%' THEN '0' ELSE [SUM OF HC MISMATCH] END AS [SUM OF HC MISMATCH],
CASE WHEN [Sum of Excess Qty2] like '-%' THEN '0' ELSE [Sum of Excess Qty2] END AS [Sum of Excess Qty2],
CASE WHEN [Max of Diff-VDT-EDT] like '-%' THEN '0' ELSE [Max of Diff-VDT-EDT] END AS [Max of Diff-VDT-EDT],
CASE WHEN [Sum of RepledgeValue] like '-%' THEN '0' ELSE [Sum of RepledgeValue] END AS [Sum of RepledgeValue],
CASE WHEN [Sum of StockINHand Value] like '-%' THEN '0' ELSE [Sum of StockINHand Value] END AS [Sum of StockINHand Value]
,[Margin/2],[Cash Shortfall],[Non-cash shortfall],
CASE WHEN [Cash Shortfall for 50:50] like '-%' THEN '0' ELSE [Cash Shortfall for 50:50] END AS [Cash Shortfall for 50:50],
CASE WHEN [Sum of HC Mismatch-used] like '-%' THEN '0' ELSE [Sum of HC Mismatch-used] END AS [Sum of HC Mismatch-used],
CASE WHEN [Sum of Excess Qty21] like '-%' THEN '0' ELSE [Sum of Excess Qty21] END AS [Sum of Excess Qty21],
CASE WHEN [EPN] like '-%' THEN '0' ELSE [EPN] END AS [EPN],
CASE WHEN [Sum of StockINHand Value1] like '-%' THEN '0' ELSE [Sum of StockINHand Value1] END AS [Sum of StockINHand Value1],
CASE WHEN [Cash Shortfall for 50:501] like '-%' THEN '0' ELSE [Cash Shortfall for 50:501] END AS [Cash Shortfall for 50:501]
,[Funds],[PLEDGEFULLVAL1],[REPLEDGEFULLVAL1],[TOTALVALUE_CC],[EXCESSTOTALVALUE_CC],[FUNDS / MAX_MARGIN %],[90 %],[DIFF %],[DIFF AMT]
INTO #CAPITALREQUIREMENT_DETAIL_EOD
FROM INHOUSE.DBO.CAPITALREQUIREMENT_DETAIL_EOD
WHERE MDATE >=@TDATE AND MDATE <=@TDATE

--SELECT * FROM #CAPITALREQUIREMENT_DETAIL_EOD

IF OBJECT_ID(N'TEMPDB..#CAPITALREQUIREMENT_DETAIL_PEAK') IS NOT NULL
DROP TABLE #CAPITALREQUIREMENT_DETAIL_PEAK

SELECT --TOP 100 
MDATE,PARTY_CODE,MAX_MARGIN,EPIAMOUNT,MAX_VDT,MAX_EDT, 
CASE WHEN [SUM OF HC MISMATCH] like '-%' THEN '0' ELSE [SUM OF HC MISMATCH] END AS [SUM OF HC MISMATCH],
CASE WHEN [Sum of Excess Qty2] like '-%' THEN '0' ELSE [Sum of Excess Qty2] END AS [Sum of Excess Qty2],
CASE WHEN [Max of Diff-VDT-EDT] like '-%' THEN '0' ELSE [Max of Diff-VDT-EDT] END AS [Max of Diff-VDT-EDT],
CASE WHEN [Sum of RepledgeValue] like '-%' THEN '0' ELSE [Sum of RepledgeValue] END AS [Sum of RepledgeValue],
CASE WHEN [Sum of StockINHand Value] like '-%' THEN '0' ELSE [Sum of StockINHand Value] END AS [Sum of StockINHand Value]
,[Margin/2],[Cash Shortfall],[Non-cash shortfall],
CASE WHEN [Cash Shortfall for 50:50] like '-%' THEN '0' ELSE [Cash Shortfall for 50:50] END AS [Cash Shortfall for 50:50],
CASE WHEN [Sum of HC Mismatch-used] like '-%' THEN '0' ELSE [Sum of HC Mismatch-used] END AS [Sum of HC Mismatch-used],
CASE WHEN [Sum of Excess Qty21] like '-%' THEN '0' ELSE [Sum of Excess Qty21] END AS [Sum of Excess Qty21],
CASE WHEN [EPN] like '-%' THEN '0' ELSE [EPN] END AS [EPN],
CASE WHEN [Sum of StockINHand Value1] like '-%' THEN '0' ELSE [Sum of StockINHand Value1] END AS [Sum of StockINHand Value1],
CASE WHEN [Cash Shortfall for 50:501] like '-%' THEN '0' ELSE [Cash Shortfall for 50:501] END AS [Cash Shortfall for 50:501]
,[Funds],[PLEDGEFULLVAL1],[REPLEDGEFULLVAL1],[TOTALVALUE_CC],[EXCESSTOTALVALUE_CC],[FUNDS / MAX_MARGIN %],[90 %],[DIFF %],[DIFF AMT]
INTO #CAPITALREQUIREMENT_DETAIL_PEAK
FROM INHOUSE.DBO.CAPITALREQUIREMENT_DETAIL_PEAK
WHERE MDATE >=@TDATE AND MDATE<=@TDATE

--SELECT * FROM #CAPITALREQUIREMENT_DETAIL_PEAK

---------------------- || MAIN DATA INSERT END || ----------------------

TRUNCATE TABLE DUSTBIN.DBO.TBL_CAPITAL_MIS_EOD
TRUNCATE TABLE DUSTBIN.DBO.TBL_CAPITAL_MIS_PEAK

INSERT INTO DUSTBIN.DBO.TBL_CAPITAL_MIS_EOD
SELECT CAST ([MDATE] AS VARCHAR(11)) AS [MDATE],CAST ([PARTY_CODE] AS VARCHAR) AS [PARTY_CODE],
CAST ([MAX_MARGIN] AS VARCHAR) AS [MAX_MARGIN],CAST ([EPIAMOUNT] AS VARCHAR) AS [EPIAMOUNT],CAST ([MAX_VDT] AS VARCHAR) AS [MAX_VDT],CAST ([MAX_EDT] AS VARCHAR) AS [MAX_EDT],
CAST ([SUM OF HC MISMATCH] AS VARCHAR) AS [SUM OF HC MISMATCH],CAST ([Sum of Excess Qty2] AS VARCHAR) AS [Sum of Excess Qty2],
CAST ([Max of Diff-VDT-EDT] AS VARCHAR) AS [Max of Diff-VDT-EDT],CAST ([Sum of RepledgeValue] AS VARCHAR) AS [Sum of RepledgeValue],
CAST ([Sum of StockINHand Value] AS VARCHAR) AS [Sum of StockINHand Value],CAST ([Margin/2] AS VARCHAR) AS [Margin/2],CAST ([Cash Shortfall] AS VARCHAR) AS [Cash Shortfall],
CAST ([Non-cash shortfall] AS VARCHAR) AS [Non-cash shortfall],CAST ([Cash Shortfall for 50:50] AS VARCHAR) AS [Cash Shortfall for 50:50],
CAST ([Sum of HC Mismatch-used] AS VARCHAR) AS [Sum of HC Mismatch-used],CAST ([Sum of Excess Qty21] AS VARCHAR) AS [Sum of Excess Qty21],CAST ([EPN] AS VARCHAR) AS [EPN],
CAST ([Sum of StockINHand Value1] AS VARCHAR) AS [Sum of StockINHand Value1],CAST ([Cash Shortfall for 50:501] AS VARCHAR) AS [Cash Shortfall for 50:501],
CAST ([Funds] AS VARCHAR) AS [Funds],CAST ([PLEDGEFULLVAL1] AS VARCHAR) AS [PLEDGEFULLVAL1],CAST ([REPLEDGEFULLVAL1] AS VARCHAR) AS [REPLEDGEFULLVAL1],
CAST ([TOTALVALUE_CC] AS VARCHAR) AS [TOTALVALUE_CC],CAST ([EXCESSTOTALVALUE_CC] AS VARCHAR) AS [EXCESSTOTALVALUE_CC],CAST ([FUNDS / MAX_MARGIN %] AS VARCHAR) AS [FUNDS / MAX_MARGIN %],
CAST ([90 %] AS VARCHAR) AS [90 %],CAST ([DIFF %] AS VARCHAR) AS [DIFF %],CAST ([DIFF AMT] AS VARCHAR) AS [DIFF AMT]
FROM #CAPITALREQUIREMENT_DETAIL_EOD

INSERT INTO DUSTBIN.DBO.TBL_CAPITAL_MIS_PEAK
SELECT CAST ([MDATE] AS VARCHAR(11)) AS [MDATE],CAST ([PARTY_CODE] AS VARCHAR) AS [PARTY_CODE],CAST ([MAX_MARGIN] AS VARCHAR) AS [MAX_MARGIN],
CAST ([EPIAMOUNT] AS VARCHAR) AS [EPIAMOUNT],CAST ([MAX_VDT] AS VARCHAR) AS [MAX_VDT],CAST ([MAX_EDT] AS VARCHAR) AS [MAX_EDT],
CAST ([SUM OF HC MISMATCH] AS VARCHAR) AS [SUM OF HC MISMATCH],CAST ([SUM OF EXCESS QTY2] AS VARCHAR) AS [SUM OF EXCESS QTY2],CAST ([MAX OF DIFF-VDT-EDT] AS VARCHAR) AS [MAX OF DIFF-VDT-EDT],
CAST ([SUM OF REPLEDGEVALUE] AS VARCHAR) AS [SUM OF REPLEDGEVALUE],CAST ([SUM OF STOCKINHAND VALUE] AS VARCHAR) AS [SUM OF STOCKINHAND VALUE],CAST ([MARGIN/2] AS VARCHAR) AS [MARGIN/2],
CAST ([CASH SHORTFALL] AS VARCHAR) AS [CASH SHORTFALL],CAST ([NON-CASH SHORTFALL] AS VARCHAR) AS [NON-CASH SHORTFALL],CAST ([CASH SHORTFALL FOR 50:50] AS VARCHAR) AS [CASH SHORTFALL FOR 50:50],
CAST ([SUM OF HC MISMATCH-USED] AS VARCHAR) AS [SUM OF HC MISMATCH-USED],CAST ([SUM OF EXCESS QTY21] AS VARCHAR) AS [SUM OF EXCESS QTY21],CAST ([EPN] AS VARCHAR) AS [EPN],
CAST ([SUM OF STOCKINHAND VALUE1] AS VARCHAR) AS [SUM OF STOCKINHAND VALUE1],CAST ([CASH SHORTFALL FOR 50:501] AS VARCHAR) AS [CASH SHORTFALL FOR 50:501],CAST ([FUNDS] AS VARCHAR) AS [FUNDS],
CAST ([PLEDGEFULLVAL1] AS VARCHAR) AS [PLEDGEFULLVAL1],CAST ([REPLEDGEFULLVAL1] AS VARCHAR) AS [REPLEDGEFULLVAL1],CAST ([TOTALVALUE_CC] AS VARCHAR) AS [TOTALVALUE_CC],
CAST ([EXCESSTOTALVALUE_CC] AS VARCHAR) AS [EXCESSTOTALVALUE_CC],CAST ([FUNDS / MAX_MARGIN %] AS VARCHAR) AS [FUNDS / MAX_MARGIN %],CAST ([90 %] AS VARCHAR) AS [90 %],
CAST ([DIFF %] AS VARCHAR) AS [DIFF %],CAST ([DIFF AMT] AS VARCHAR) AS [DIFF AMT]
FROM #CAPITALREQUIREMENT_DETAIL_PEAK

---------------------- || FILE GENERATION LOGIC || ----------------------

--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(10),GETDATE(),3),'/','')          
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\SL_AUTO\ANAND_G\CAPITAL_MIS_DATA\OUTPUT\' +'CAPITAL_MIS_EOD_DATA' + '.CSV'          
DECLARE @ALL VARCHAR(MAX)                    
                    
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''[MDATE]'''',''''[PARTY_CODE]'''',''''[MAX_MARGIN]'''',''''[EPIAMOUNT]'''',''''[MAX_VDT]'''',''''[MAX_EDT]'''',''''[SUM OF HC MISMATCH]'''',''''[Sum of Excess Qty2]'''',''''[Max of Diff-VDT-EDT]'''',''''[Sum of RepledgeValue]'''',''''[Sum of StockINHand Value]'''',''''[Margin/2]'''',''''[Cash Shortfall]'''',''''[Non-cash shortfall]'''',''''[Cash Shortfall for 50:50]'''',''''[Sum of HC Mismatch-used]'''',''''[Sum of Excess Qty21]'''',''''[EPN]'''',''''[Sum of StockINHand Value1]'''',''''[Cash Shortfall for 50:501]'''',''''[Funds]'''',''''[PLEDGEFULLVAL1]'''',''''[REPLEDGEFULLVAL1]'''',''''[TOTALVALUE_CC]'''',''''[EXCESSTOTALVALUE_CC]'''',''''[FUNDS / MAX_MARGIN %]'''',''''[90 %]'''',''''[DIFF %]'''',''''[DIFF AMT]'''''
SET @ALL = @ALL+ ' UNION ALL SELECT * FROM DUSTBIN.DBO.TBL_CAPITAL_MIS_EOD'                  
PRINT @ALL                    
SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'                    
PRINT @ALL                    
EXEC(@ALL)    

DECLARE @FILENAME1 VARCHAR(100) = 'J:\Backoffice\SL_AUTO\ANAND_G\CAPITAL_MIS_DATA\OUTPUT\' +'CAPITAL_MIS_PEAK_DATA' + '.CSV'          
DECLARE @ALL1 VARCHAR(MAX)                    
                    
SET @ALL1 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''[MDATE]'''',''''[PARTY_CODE]'''',''''[MAX_MARGIN]'''',''''[EPIAMOUNT]'''',''''[MAX_VDT]'''',''''[MAX_EDT]'''',''''[SUM OF HC MISMATCH]'''',''''[Sum of Excess Qty2]'''',''''[Max of Diff-VDT-EDT]'''',''''[Sum of RepledgeValue]'''',''''[Sum of StockINHand Value]'''',''''[Margin/2]'''',''''[Cash Shortfall]'''',''''[Non-cash shortfall]'''',''''[Cash Shortfall for 50:50]'''',''''[Sum of HC Mismatch-used]'''',''''[Sum of Excess Qty21]'''',''''[EPN]'''',''''[Sum of StockINHand Value1]'''',''''[Cash Shortfall for 50:501]'''',''''[Funds]'''',''''[PLEDGEFULLVAL1]'''',''''[REPLEDGEFULLVAL1]'''',''''[TOTALVALUE_CC]'''',''''[EXCESSTOTALVALUE_CC]'''',''''[FUNDS / MAX_MARGIN %]'''',''''[90 %]'''',''''[DIFF %]'''',''''[DIFF AMT]'''''
SET @ALL1 = @ALL1+ ' UNION ALL SELECT * FROM DUSTBIN.DBO.TBL_CAPITAL_MIS_PEAK'                  
PRINT @ALL1                    
SET @ALL1=@ALL1+' " QUERYOUT ' +@FILENAME1+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'                    
PRINT @ALL1                    
EXEC(@ALL1)   

---------------------- || FILE GENERATION LOGIC || ----------------------
                
SELECT 'CAPITAL MIS EOD AND PEAK DATA FILE EXPORTED TO \\10.253.33.91 \ Backoffice \ SL_AUTO \ ANAND_G \ CAPITAL_MIS_DATA \ OUTPUT' AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CLIENT_DP_BO_INCOME_DATA
-- --------------------------------------------------


CREATE PROC [dbo].[USP_CLIENT_DP_BO_INCOME_DATA]
AS
DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\BACKOFFICE\SL_AUTO\PMLA_REPORTS\CLIENT_DATA\INPUT\INPUT.TXT'
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL
    DROP TABLE #CODE
CREATE TABLE #CODE (CLTCODE VARCHAR(50))
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
    (
           FIRSTROW = 1,
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW
           TABLOCK
    )'
SET @SQLFINAL= @SQL + @SQL2
PRINT @SQLFINAL
EXEC (@SQLFINAL)
--SELECT TOP 10 * FROM #CODE
IF OBJECT_ID(N'SCRATCHPAD..CLIENT_DP_BO_INCOME_DATA') IS NOT NULL

DROP TABLE CLIENT_DP_BO_INCOME_DATA

SELECT NISE_PARTY_CODE,CLIENT_CODE as CLTDPID,REPLACE(B.INCOME, ',', ' ') AS DP_INCOME INTO CLIENT_DP_BO_INCOME_DATA
FROM ANGELDP4.DMAT.CITRUS_USR.TBL_CLIENT_MASTER A WITH (NOLOCK),
AGMUBODPL3.DMAT.CITRUS_USR.INCOME_MST B WITH (NOLOCK)
WHERE A.INCOME_CODE = B.INCOME_CODE AND NISE_PARTY_CODE IN (SELECT * from #CODE)

ALTER TABLE CLIENT_DP_BO_INCOME_DATA
ADD CLIENT_NAME VARCHAR (MAX),BO_INCOME VARCHAR (100),GROSS_DATE DATETIME,NET_WORTH NUMERIC (17,2),NET_WORTH_DATE DATETIME 

UPDATE CLIENT_DP_BO_INCOME_DATA  
SET  BO_INCOME = isnull( ( 
CASE WHEN A.CATEGORY='I' THEN ( SELECT DESCRIPTION FROM MSAJAG.DBO.CLIENT_STATIC_CODES B (NOLOCK)
WHERE A.GROSS_INCOME = B.CODE AND CATEGORY IN('INCOMESLAB_IND') AND KRA_TYPE='CDSL')
WHEN CATEGORY='N' THEN ( SELECT DESCRIPTION FROM MSAJAG.DBO.CLIENT_STATIC_CODES B (NOLOCK)
WHERE A.GROSS_INCOME = B.CODE AND CATEGORY IN('INCOMESLAB_NONIND') AND KRA_TYPE='CDSL') ELSE '' END),0),
GROSS_DATE=A.GROSS_DATE,NET_WORTH=A.NET_WORTH ,
NET_WORTH_DATE=A.NET_WORTH_DATE
FROM MSAJAG.DBO.CLIENT_MASTER_UCC_DATA A  WHERE A.PARTY_CODE=CLIENT_DP_BO_INCOME_DATA.NISE_PARTY_CODE

UPDATE CLIENT_DP_BO_INCOME_DATA SET CLIENT_NAME = LONG_NAME
FROM CLIENT_DP_BO_INCOME_DATA A, MSAJAG.DBO.CLIENT_DETAILS B WITH (NOLOCK)
WHERE A.NISE_PARTY_CODE = B.CL_CODE



DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\SL_AUTO\PMLA_REPORTS\CLIENT_DATA\OUTPUT\' +'CLIENT_DATA' + '.CSV'        
DECLARE @ALL VARCHAR(MAX)                  
                  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''NISE_PARTY_CODE'''',''''CLTDPID'''',''''CLIENT_NAME'''',''''DP_INCOME'''',''''BO_INCOME'''',''''GROSS_DATE'''',''''NET_WORTH'''',''''NET_WORTH_DATE'''''
SET @all = @all+ ' UNION ALL SELECT NISE_PARTY_CODE,CLTDPID,CLIENT_NAME,DP_INCOME,BO_INCOME,CONVERT(VARCHAR(10),GROSS_DATE,120),CONVERT(VARCHAR(100),NET_WORTH),CONVERT(VARCHAR(10),NET_WORTH_DATE,120) FROM SCRATCHPAD.DBO.CLIENT_DP_BO_INCOME_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

DROP TABLE #CODE
DROP TABLE CLIENT_DP_BO_INCOME_DATA
SELECT 'CLIENT DATA DP AND BO INCOME EXPORTED TO  ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CLIENT_HOLDING_DATA
-- --------------------------------------------------

CREATE PROC [dbo].[USP_CLIENT_HOLDING_DATA]

(@DPHMC_ISIN VARCHAR(20),@TODATE DATETIME)

AS
DECLARE @SQL VARCHAR (MAX),@SQL2 VARCHAR (MAX)
SET @TODATE =FORMAT(@TODATE, 'MMM dd yyyy')
--DECLARE @DPHMC_ISIN VARCHAR(20)='INE009A01021'
--DECLARE @TODATE DATETIME='2025-12-15'


IF OBJECT_ID(N'DUSTBIN..CLIENT_HOLDING_DATA') IS NOT NULL                      
DROP TABLE SCRATCHPAD.DBO.CLIENT_HOLDING_DATA

Select DPHMC_HOLDING_DT,DPAM_SBA_NO,DPAM_BBO_CODE,DPHMC_ISIN,DPHMC_CURR_QTY,DPHMC_FREE_QTY 
INTO SCRATCHPAD.DBO.CLIENT_HOLDING_DATA 
from AGMUBODPL3.DMAT.citrus_usr.DP_HLDG_MSTR_CDSL H,AGMUBODPL3.DMAT.citrus_usr.DP_ACCT_MSTR
WHERE DPHMC_DPAM_ID =DPAM_ID AND DPHMC_ISIN = @DPHMC_ISIN and DPHMC_HOLDING_DT =@TODATE
 
insert   INTO SCRATCHPAD.DBO.CLIENT_HOLDING_DATA 
Select DPHMC_HOLDING_DT,DPAM_SBA_NO,DPAM_BBO_CODE,DPHMC_ISIN,DPHMC_CURR_QTY,DPHMC_FREE_QTY
from AngelDP5.DMAT.citrus_usr.DP_HLDG_MSTR_CDSL H,AngelDP5.DMAT.citrus_usr.DP_ACCT_MSTR
WHERE DPHMC_DPAM_ID =DPAM_ID AND DPHMC_ISIN =@DPHMC_ISIN and DPHMC_HOLDING_DT =@TODATE
    
insert  INTO SCRATCHPAD.DBO.CLIENT_HOLDING_DATA 
Select DPHMC_HOLDING_DT,DPAM_SBA_NO,DPAM_BBO_CODE,DPHMC_ISIN,DPHMC_CURR_QTY,DPHMC_FREE_QTY
from Angeldp202.DMAT.citrus_usr.DP_HLDG_MSTR_CDSL H,Angeldp202.DMAT.citrus_usr.DP_ACCT_MSTR
WHERE DPHMC_DPAM_ID =DPAM_ID AND DPHMC_ISIN =@DPHMC_ISIN and DPHMC_HOLDING_DT =@TODATE
   
insert   INTO SCRATCHPAD.DBO.CLIENT_HOLDING_DATA 
Select DPHMC_HOLDING_DT,DPAM_SBA_NO,DPAM_BBO_CODE,DPHMC_ISIN,DPHMC_CURR_QTY,DPHMC_FREE_QTY
from [10.253.78.167].DMAT.citrus_usr.DP_HLDG_MSTR_CDSL H,[10.253.78.167].DMAT.citrus_usr.DP_ACCT_MSTR
WHERE DPHMC_DPAM_ID =DPAM_ID AND DPHMC_ISIN =@DPHMC_ISIN and DPHMC_HOLDING_DT =@TODATE

insert   INTO SCRATCHPAD.DBO.CLIENT_HOLDING_DATA 
Select DPHMC_HOLDING_DT,DPAM_SBA_NO,DPAM_BBO_CODE,DPHMC_ISIN,DPHMC_CURR_QTY,DPHMC_FREE_QTY
from ABVSDP204.DMAT.citrus_usr.DP_HLDG_MSTR_CDSL H,ABVSDP204.DMAT.citrus_usr.DP_ACCT_MSTR
WHERE DPHMC_DPAM_ID =DPAM_ID AND DPHMC_ISIN =@DPHMC_ISIN and DPHMC_HOLDING_DT =@TODATE

--SELECT * FROM scratchpad.DBO.CLIENT_HOLDING_DATA FROM DUSTBIN.DBO.CLIENT_HOLDING_DATA

--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(11),@DATE,3),' ','')
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\BHARTI\HOLDING_DATA.CSV'
DECLARE @ALL VARCHAR(MAX)

SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''DPHMC_HOLDING_DT'''',''''DPAM_SBA_NO'''',''''DPAM_BBO_CODE'''',''''DPHMC_ISIN'''',''''DPHMC_CURR_QTY'''',''''DPHMC_FREE_QTY'''''
SET @all = @all+ ' UNION ALL SELECT CONVERT(VARCHAR(10),DPHMC_HOLDING_DT,120),DPAM_SBA_NO,DPAM_BBO_CODE,DPHMC_ISIN,CONVERT(VARCHAR(MAX),DPHMC_CURR_QTY),CONVERT(VARCHAR(MAX),DPHMC_FREE_QTY) FROM SCRATCHPAD.DBO.CLIENT_HOLDING_DATA'             
--SET @ALL = @ALL+ ' UNION ALL SELECT * FROM DUSTBIN.DBO.CLIENT_HOLDING_DATA'

SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'

EXEC(@ALL)

 


DROP TABLE SCRATCHPAD.DBO.CLIENT_HOLDING_DATA

--DROP TABLE #TMPHLDG

SELECT 'FILE HAS BEEN CREATED FOR CLIENT HOLDING DATA '+' IN "\\10.253.33.91\backoffice\bharti\" PATH'
AS REMARK

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CLIENT_HOLDING_DATA_BKP_16DEC2025
-- --------------------------------------------------

CREATE PROC [dbo].[USP_CLIENT_HOLDING_DATA]

 @DPHMCD_ISIN VARCHAR(20)
 AS
DECLARE @SQL VARCHAR (MAX)
--SET @DATE =FORMAT(@TDATE, 'MMM dd yyyy')
--DECLARE @DPHMCD_ISIN VARCHAR(20)='INE009A01021'


IF OBJECT_ID(N'DUSTBIN..CLIENT_HOLDING_DATA') IS NOT NULL                      
DROP TABLE SCRATCHPAD.DBO.CLIENT_HOLDING_DATA

select dpam_sba_no , dpam_bbo_code ,dphmcd_holding_dt,DPHMCD_ISIN,DPHMCD_CURR_QTY,DPHMCD_FREE_QTY
INTO SCRATCHPAD.DBO.CLIENT_HOLDING_DATA from AngelDP4.DMAT.CITRUS_USR.holdingallforview , AngelDP4.DMAT.CITRUS_USR.dp_Acct_mstr
where dphmcd_dpam_id = dpam_id
and  DPHMCD_ISIN = @DPHMCD_ISIN
group by dpam_sba_no , dpam_bbo_code,dphmcd_holding_dt,DPHMCD_ISIN,DPHMCD_CURR_QTY,DPHMCD_FREE_QTY


--SELECT * INTO scratchpad.DBO.CLIENT_HOLDING_DATA FROM DUSTBIN.DBO.CLIENT_HOLDING_DATA

--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(11),@DATE,3),' ','')
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\BHARTI\HOLDING_DATA.CSV'
DECLARE @ALL VARCHAR(MAX)

SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''dpam_sba_no'''',''''dpam_bbo_code'''',''''dphmcd_holding_dt'''',''''DPHMCD_ISIN'''',''''DPHMCD_CURR_QTY'''',''''DPHMCD_FREE_QTY'''''
SET @all = @all+ ' UNION ALL SELECT dpam_sba_no,dpam_bbo_code,CONVERT(VARCHAR(10),dphmcd_holding_dt,120),DPHMCD_ISIN,CONVERT(VARCHAR(MAX),DPHMCD_CURR_QTY),CONVERT(VARCHAR(MAX),DPHMCD_FREE_QTY) FROM SCRATCHPAD.DBO.CLIENT_HOLDING_DATA'             
--SET @ALL = @ALL+ ' UNION ALL SELECT * FROM DUSTBIN.DBO.CLIENT_HOLDING_DATA'

SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'

EXEC(@ALL)

 


DROP TABLE SCRATCHPAD.DBO.CLIENT_HOLDING_DATA

--DROP TABLE #TMPHLDG

SELECT 'FILE HAS BEEN CREATED FOR CLIENT HOLDING DATA '+' IN "\\10.253.33.91\backoffice\bharti\" PATH'
AS REMARK

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY
-- --------------------------------------------------

CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-1, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    

    
----NSECO    
select cltcode,SUM(vamt)as vamt  INTO #NSECO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK)
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS 
UNION ALL    
SELECT * FROM #NSECO
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #NSECO A WHERE A.CLTCODE =#FINAL.CLTCODE     

    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #NSECO
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 

----NSECO
select cltcode,SUM(vamt)as vamt  INTO #NSECO_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  [AngelCommodity].ACCOUNTNCE.dbo.ledger L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT 
UNION ALL    
SELECT * FROM #NSECO_EDT
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #NSECO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #NSECO_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
	  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE

--NSE---
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
INTO #DEBITBILL
FROM ACCOUNT.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--NSESLBS---

INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--MTFTRADE---

INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM MTFTRADE.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---BSE
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NSEFO
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NSX
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---MCDX
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---MCDXCDS
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NCDX
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NCE
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--BSEFO
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--BSX
INSERT INTO #DEBITBILL
SELECT CLTCODE, SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 15
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

SELECT CLTCODE, SUM(DEBITBILL) AS DEBITBILL
INTO #DEBITBILLFINAL
FROM #DEBITBILL
GROUP BY CLTCODE


--NSE---
SELECT CLTCODE, SUM(VAMT) AS JVBILL
INTO #JVBILL
FROM ACCOUNT.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--NSESLBS---

INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--MTFTRADE---

INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM MTFTRADE.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---BSE
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NSEFO
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NSX
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;
---MCDX
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---MCDXCDS
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NCDX
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

---NCE
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

--BSEFO
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;


--BSX
INSERT INTO #JVBILL
SELECT CLTCODE, SUM(VAMT) AS JVBILL
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK)
WHERE VTYP = 8
  AND VAMT > 0            -- Debit only
  AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ'
  AND EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' and DRCR='D'
    AND UPPER(ISNULL(NARRATION,'')) NOT LIKE 'BEING AMT TRF%'
GROUP BY CLTCODE
HAVING SUM(VAMT) <> 0;

SELECT CLTCODE, SUM(JVBILL) AS JVBILL
INTO #JVBILLFINAL
FROM #JVBILL
GROUP BY CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))
----Need to remove SP with live post CAB approval (MSAJAG..DBO.GET_EPI_POOL_ACCOUNT) Change-EPI benefit to 100%
INSERT INTO #TBL_EPN_BENEFIT EXEC SCRATCHPAD.DBO.GET_EPI_POOL_ACCOUNT_TEST @SAUDA_DATE

--;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
--GROUP BY PARTY_CODE)
--,
-- CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,PARTY_CODE,CASE WHEN SUM(today_margin) > 0 THEN SUM(today_margin) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM INHOUSE..MTF_TDAY_MARGIN_BENEFIT WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 where TOTAL <> 0
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(JVBILL) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #JVBILLFINAL GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(DEBITBILL) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #DEBITBILLFINAL GROUP BY CLTCODE
UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT where EPIACCOUNT80PC <> 0 UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE

UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL+PEAKAMT
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
WHERE CD.CLTCODE IS NULL

IF OBJECT_ID('dbo.DATACSV', 'U') IS NOT NULL 
  DROP TABLE dbo.DATACSV; 

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY_16APR2025
-- --------------------------------------------------

CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY_16APR2025]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-2, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    

    
----NSECO    
select cltcode,SUM(vamt)as vamt  INTO #NSECO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK)
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS 
UNION ALL    
SELECT * FROM #NSECO
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #NSECO A WHERE A.CLTCODE =#FINAL.CLTCODE     

    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #NSECO
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 

----NSECO
select cltcode,SUM(vamt)as vamt  INTO #NSECO_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  [AngelCommodity].ACCOUNTNCE.dbo.ledger L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT 
UNION ALL    
SELECT * FROM #NSECO_EDT
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #NSECO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #NSECO_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
	  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))
----Need to remove SP with live post CAB approval (MSAJAG..DBO.GET_EPI_POOL_ACCOUNT) Change-EPI benefit to 100%
INSERT INTO #TBL_EPN_BENEFIT EXEC SCRATCHPAD.DBO.GET_EPI_POOL_ACCOUNT_TEST @SAUDA_DATE

--;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
--GROUP BY PARTY_CODE)
--,
-- CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,PARTY_CODE,CASE WHEN SUM(today_margin) > 0 THEN SUM(today_margin) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM INHOUSE..MTF_TDAY_MARGIN_BENEFIT WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 where TOTAL <> 0
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT where EPIACCOUNT80PC <> 0 UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE

UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL+AG.VAMT
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
INNER JOIN #UNCLEARED_REC_ANG AG ON FA.CLTCODE = AG.CLTCODE
WHERE CD.CLTCODE IS NULL

IF OBJECT_ID('dbo.DATACSV', 'U') IS NOT NULL 
  DROP TABLE dbo.DATACSV; 

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY_BKP_07/03/2025
-- --------------------------------------------------

CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY_BKP_07/03/2025]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-1, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    

    
----NSECO    
select cltcode,SUM(vamt)as vamt  INTO #NSECO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK)
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS 
UNION ALL    
SELECT * FROM #NSECO
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #NSECO A WHERE A.CLTCODE =#FINAL.CLTCODE     

    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #NSECO
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 

----NSECO
select cltcode,SUM(vamt)as vamt  INTO #NSECO_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  [AngelCommodity].ACCOUNTNCE.dbo.ledger L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT 
UNION ALL    
SELECT * FROM #NSECO_EDT
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #NSECO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #NSECO_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

--NSE

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL INTO #DEBITBILLAMT
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

--BSE
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

--NSEFO
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


--NSECD
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

----MCDXCDS
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

----MCDX
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

----NCDX
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

----BSEFO
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


----BSX
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


----MTF
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

------SLBS
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

--------NCE
INSERT INTO #DEBITBILLAMT
SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS DEBITBILL
FROM ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 15
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ' and DRCR='D'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT EDT,CLTCODE,SUM(DEBITBILL) AS DEBITBILL INTO #FINALDEBITBILLAMT from #DEBITBILLAMT
GROUP BY CLTCODE,EDT


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
		  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))
----Need to remove SP with live post CAB approval (MSAJAG..DBO.GET_EPI_POOL_ACCOUNT) Change-EPI benefit to 100%
INSERT INTO #TBL_EPN_BENEFIT EXEC SCRATCHPAD.DBO.GET_EPI_POOL_ACCOUNT_TEST @SAUDA_DATE

--;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
--GROUP BY PARTY_CODE)
--,
-- CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,PARTY_CODE,CASE WHEN SUM(today_margin) > 0 THEN SUM(today_margin) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM INHOUSE..MTF_TDAY_MARGIN_BENEFIT WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 where TOTAL <> 0
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT where EPIACCOUNT80PC <> 0 UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE

UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
WHERE CD.CLTCODE IS NULL

UPDATE #FINALAMOUNT SET PEAKAMT = PEAKAMT + #FINALDEBITBILLAMT.DEBITBILL from #FINALDEBITBILLAMT WHERE #FINALDEBITBILLAMT.CLTCODE = #FINALAMOUNT.CLTCODE

IF OBJECT_ID('dbo.DATACSV', 'U') IS NOT NULL 
  DROP TABLE dbo.DATACSV; 

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY_BKP_24NOV2025
-- --------------------------------------------------


CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY_BKP_24NOV2025]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-1, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    

    
----NSECO    
select cltcode,SUM(vamt)as vamt  INTO #NSECO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK)
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS 
UNION ALL    
SELECT * FROM #NSECO
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #NSECO A WHERE A.CLTCODE =#FINAL.CLTCODE     

    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #NSECO
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 

----NSECO
select cltcode,SUM(vamt)as vamt  INTO #NSECO_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  [AngelCommodity].ACCOUNTNCE.dbo.ledger L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT 
UNION ALL    
SELECT * FROM #NSECO_EDT
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #NSECO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #NSECO_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
	  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))
----Need to remove SP with live post CAB approval (MSAJAG..DBO.GET_EPI_POOL_ACCOUNT) Change-EPI benefit to 100%
INSERT INTO #TBL_EPN_BENEFIT EXEC SCRATCHPAD.DBO.GET_EPI_POOL_ACCOUNT_TEST @SAUDA_DATE

--;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
--GROUP BY PARTY_CODE)
--,
-- CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,PARTY_CODE,CASE WHEN SUM(today_margin) > 0 THEN SUM(today_margin) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM INHOUSE..MTF_TDAY_MARGIN_BENEFIT WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 where TOTAL <> 0
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT where EPIACCOUNT80PC <> 0 UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE

UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
WHERE CD.CLTCODE IS NULL

IF OBJECT_ID('dbo.DATACSV', 'U') IS NOT NULL 
  DROP TABLE dbo.DATACSV; 

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY_BKP_25/03/2025
-- --------------------------------------------------

CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY_BKP_25/03/2025]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-1, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    

    
----NSECO    
select cltcode,SUM(vamt)as vamt  INTO #NSECO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK)
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS 
UNION ALL    
SELECT * FROM #NSECO
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #NSECO A WHERE A.CLTCODE =#FINAL.CLTCODE     

    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #NSECO
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 

----NSECO
select cltcode,SUM(vamt)as vamt  INTO #NSECO_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  [AngelCommodity].ACCOUNTNCE.dbo.ledger L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT 
UNION ALL    
SELECT * FROM #NSECO_EDT
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #NSECO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #NSECO_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT

SELECT start_date into #PFROMDATE from MSAJAG..sett_mst where sec_payin=@FROMDATE and sett_type='M'

Select Distinct CLTCODE into #bill -- into #temp
from account.dbo.ledger_all L ,#PFROMDATE P where L.VDT=P.start_date and Edt =@FROMDATE and vtyp ='15' and drcr='D'
GROUP BY CLTCODE

Create index #c on #bill(CLTCODE)

Select CLTCODE, SUM(CASE WHEN DRCR ='D' THEN VAMT ELSE VAMT*-1 END) as VAMT INTO #MTFBILLREVERSAL
from account.dbo.ledger_all L ,#PFROMDATE P where L.VDT=P.start_date and Edt =@FROMDATE and vtyp in ('35','15') and cltcode in (select * from #bill )
Group by CLTCODE

update #MTFBILLREVERSAL Set VAMT=( Case when VAMT >0 Then Vamt else 0 end)

Insert into #MTFBILLREVERSAL
Select CLTCODE, SUM(CASE WHEN DRCR ='D' THEN VAMT ELSE VAMT*-1 END) as Vamt
from account.dbo.ledger_all  where vdt =@FROMDATE and EDT =@FROMDATE and vtyp =35 --and cltcode ='S693606'
GROUP BY CLTCODE

update #MTFBILLREVERSAL Set VAMT=( Case when VAMT >0 Then Vamt else 0 end)

Select CLTCODE, SUM(CASE WHEN DRCR ='D' THEN VAMT ELSE VAMT*-1 END) as Vamt into #Jv
from account.dbo.ledger_all where vdt =@FROMDATE and vtyp =6
GROUP BY CLTCODE

update #Jv Set VAMT=( Case when VAMT >0 Then Vamt else 0 end)

insert into #MTFBILLREVERSAL
Select * from #Jv

Select CLTCODE,sum(vamt) as vamt into #FINALMTFBILLREVERSAL from #MTFBILLREVERSAL GROUP BY CLTCODE
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
	  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))
----Need to remove SP with live post CAB approval (MSAJAG..DBO.GET_EPI_POOL_ACCOUNT) Change-EPI benefit to 100%
INSERT INTO #TBL_EPN_BENEFIT EXEC SCRATCHPAD.DBO.GET_EPI_POOL_ACCOUNT_TEST @SAUDA_DATE

--;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
--GROUP BY PARTY_CODE)
--,
-- CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
--FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,PARTY_CODE,CASE WHEN SUM(today_margin) > 0 THEN SUM(today_margin) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM INHOUSE..MTF_TDAY_MARGIN_BENEFIT WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 where TOTAL <> 0
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL

SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,VAMT AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #FINALMTFBILLREVERSAL

UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT where EPIACCOUNT80PC <> 0 

UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE





UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
LEFT JOIN #FINALMTFBILLREVERSAL FMTF ON FA.CLTCODE = FMTF.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
WHERE CD.CLTCODE IS NULL


IF OBJECT_ID('dbo.DATACSV', 'U') IS NOT NULL 
  DROP TABLE dbo.DATACSV; 

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY_BKP-09NOV2024
-- --------------------------------------------------

CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY_BKP-09NOV2024]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-1, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    

    
----NSECO    
select cltcode,SUM(vamt)as vamt  INTO #NSECO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK)
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS 
UNION ALL    
SELECT * FROM #NSECO
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #NSECO A WHERE A.CLTCODE =#FINAL.CLTCODE     

    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #NSECO
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 

----NSECO
select cltcode,SUM(vamt)as vamt  INTO #NSECO_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM [AngelCommodity].ACCOUNTNCE.dbo.ledger B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  [AngelCommodity].ACCOUNTNCE.dbo.ledger L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT 
UNION ALL    
SELECT * FROM #NSECO_EDT
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #NSECO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #NSECO_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
	  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))
----Need to remove SP with live post CAB approval (MSAJAG..DBO.GET_EPI_POOL_ACCOUNT) Change-EPI benefit to 100%
INSERT INTO #TBL_EPN_BENEFIT EXEC SCRATCHPAD.DBO.GET_EPI_POOL_ACCOUNT_TEST @SAUDA_DATE

;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
GROUP BY PARTY_CODE)
,
 CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,CTE.PARTY_CODE,CASE WHEN SUM(NETAMT+MTFLEDBAL) > 0 THEN SUM(NETAMT+MTFLEDBAL) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM CTE , CTE1 WHERE CTE.PARTY_CODE = CTE1.PARTY_CODE
GROUP BY CTE.PARTY_CODE



SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 where TOTAL <> 0
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT where EPIACCOUNT80PC <> 0 UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE

UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
WHERE CD.CLTCODE IS NULL

IF OBJECT_ID('dbo.DATACSV', 'U') IS NOT NULL 
  DROP TABLE dbo.DATACSV; 

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_COMBINEDLEDGER_PDAY_TEST
-- --------------------------------------------------

CREATE PROC [dbo].[USP_COMBINEDLEDGER_PDAY_TEST]    
AS  

declare @FROMDATE varchar(11)
Set @FROMDATE= format (GETDATE()-1, 'MMM dd yyyy')
 

DECLARE @FINSTDT Datetime 

Select @FINSTDT = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @Fromdate between sdtcur and ldtcur
 

    
----NSEBLBS    
select cltcode,SUM(vamt)as vamt  INTO #SLBS from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNTSLBS..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
 Having SUM(vamt) <>0
    
------------MTF    
    
    
    
select cltcode,SUM(vamt)as vamt  INTO #MTF from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   MTFTRADE..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT  and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   ACCOUNT..ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------bse    
 select cltcode,SUM(vamt)as vamt  INTO #BSE from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelBSECM].account_ab.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
 ------------nsefo    
 select cltcode,SUM(vamt)as vamt  INTO #NSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
  ------------nsx    
 select cltcode,SUM(vamt)as vamt  INTO #NSX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelFO].accountcurfo.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(vamt)as vamt  INTO #MCD from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdxcds.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
  ------------mcX     
 select cltcode,SUM(vamt)as vamt  INTO #MCX from (    
 
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountmcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
   ------------NCX     
 select cltcode,SUM(vamt)as vamt  INTO #NCX from (    

select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountNcdx.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    ------------BSEFO     
 select cltcode,SUM(vamt)as vamt  INTO #BSEFO from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59'  group by cltcode)a    
 group by cltcode    
  Having SUM(vamt) <>0   
    
    
     ------------BSX     
 select cltcode,SUM(vamt)as vamt  INTO #BSX from (    
select CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from   [AngelCommodity].accountCURBFO.dbo.ledger WITH(NOLOCK)    
where    
VDT>=@FINSTDT and    
 VDT<=@FROMDATE  + ' 23:59' group by cltcode)a    
 group by cltcode    
   Having SUM(vamt) <>0  
    
 CREATE TABLE #FINAL    
(CLTCODE VARCHAR(10),    
NSE MONEY,    
BSE MONEY,    
FO MONEY,    
NSX MONEY,    
MCD MONEY,    
MCX MONEY,    
NCX MONEY,    
BSEFO MONEY,    
BSX MONEY,    
MTF MONEY,    
SLBS MONEY)    
    
	
    
 INSERT INTO #FINAL    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE   
UNION ALL    
SELECT * FROM #BSE   
UNION ALL    
SELECT * FROM #NSEFO    
UNION ALL    
SELECT * FROM #NSX    
UNION ALL    
SELECT * FROM #MCD    
UNION ALL    
SELECT * FROM #MCX    
UNION ALL    
SELECT * FROM #NCX    
UNION ALL    
SELECT * FROM #BSEFO    
UNION ALL    
SELECT * FROM #BSX    
UNION ALL    
SELECT * FROM #MTF    
UNION ALL    
SELECT * FROM #SLBS    
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL(CLTCODE)    
    
UPDATE #FINAL SET NSE =VAMT FROM #NSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSE =VAMT FROM #BSE A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET FO =VAMT FROM #NSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NSX =VAMT FROM #NSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCD =VAMT FROM #MCD A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MCX =VAMT FROM #MCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET NCX =VAMT FROM #NCX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSEFO =VAMT FROM #BSEFO A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET BSX =VAMT FROM #BSX A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET MTF =VAMT FROM #MTF A WHERE A.CLTCODE =#FINAL.CLTCODE     
UPDATE #FINAL SET SLBS =VAMT FROM #SLBS A WHERE A.CLTCODE =#FINAL.CLTCODE     
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE     AND CLTCODE LIKE '98%'    
    
     
 SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
 SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
      SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL    
  into #TEMP_VDT   
    FROM #FINAL  A  WHERE CLTCODE <>'BBBB'   AND CLTCODE >='A' and CLTCODE <='zzzzzzzzZZZZ'
  GROUP BY CLTCODE ORDER BY CLTCODE ASC    

  SELECT  VDT=@FROMDATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_VDT1  FROM #TEMP_VDT 

DROP TABLE #NSE
DROP TABLE #BSE
DROP TABLE #NSEFO
DROP TABLE #NSX
DROP TABLE #MCD
DROP TABLE #MCX
DROP TABLE #NCX
DROP TABLE #BSEFO
DROP TABLE #BSX
DROP TABLE #MTF
DROP TABLE #SLBS
DROP TABLE #FINAL
DROP TABLE #TEMP_VDT


Declare  @TODATE VARCHAR(11) 
Set @TODATE = @FROMDATE -- CHANGE DATE
    
Select @FROMDATE = sdtcur from ACCOUNT..Parameter WITH(NOLOCK) where @TODATE between sdtcur and ldtcur
 
----NSEBLBS
select cltcode,SUM(vamt)as vamt  INTO #SLBS_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
 Having SUM(vamt) <>0

 
    
------------MTF    
select cltcode,SUM(vamt)as vamt  INTO #MTF_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   

------------nse    
    
select cltcode,SUM(vamt)as vamt  INTO #NSE_EDT from (    
SELECT CLTCODE, Vamt = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, Vamt = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) 
FROM ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, Vamt = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) 
FROM  ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(vamt) <>0   
    
 ------------bse    
select cltcode,SUM(LEDBAL)as vamt  INTO #BSE_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
 ------------nsefo    
 select cltcode,SUM(LEDBAL)as vamt  INTO #NSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
  ------------nsx    
select cltcode,SUM(LEDBAL)as vamt  INTO #NSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
   Having SUM(LEDBAL) <>0  
    
    
  ------------mcd     
 select cltcode,SUM(LEDBAL)as vamt  INTO #MCD_EDT from (    
 SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
 group by cltcode    
  Having SUM(LEDBAL) <>0
  
  ------------mcX
  
select cltcode,SUM(LEDBAL)as vamt  INTO #MCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
   ------------NCX 
   
select cltcode,SUM(LEDBAL)as vamt  INTO #NCX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0
   
------------BSEFO

select cltcode,SUM(LEDBAL)as vamt  INTO #BSEFO_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <>0   
    
    
------------BSX     
select cltcode,SUM(LEDBAL)as vamt  INTO #BSX_EDT from (    
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT >= @FROMDATE + ' 00:00:00' AND EDT <= @FROMDATE + ' 23:59:59' AND VTYP = 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE --AND CLTCODE='A465362'
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  --AND CLTCODE='A465362'
GROUP BY CLTCODE)a    
group by cltcode    
Having SUM(LEDBAL) <> 0  
    
CREATE TABLE #FINAL_EDT    
(CLTCODE VARCHAR(10), NSE MONEY, BSE MONEY,FO MONEY,NSX MONEY,MCD MONEY,
MCX MONEY,NCX MONEY,BSEFO MONEY,BSX MONEY,MTF MONEY,SLBS MONEY)	
    
INSERT INTO #FINAL_EDT    
SELECT DISTINCT CLTCODE,0,0,0,0,0,0,0,0,0,0,0 FROM (    
SELECT *  FROM #NSE_EDT   
UNION ALL    
SELECT * FROM #BSE_EDT   
UNION ALL    
SELECT * FROM #NSEFO_EDT    
UNION ALL    
SELECT * FROM #NSX_EDT    
UNION ALL    
SELECT * FROM #MCD_EDT    
UNION ALL    
SELECT * FROM #MCX_EDT    
UNION ALL    
SELECT * FROM #NCX_EDT    
UNION ALL    
SELECT * FROM #BSEFO_EDT    
UNION ALL    
SELECT * FROM #BSX_EDT    
UNION ALL    
SELECT * FROM #MTF_EDT    
UNION ALL    
SELECT * FROM #SLBS_EDT    
 )A    


CREATE CLUSTERED INDEX IDXCLI ON #FINAL_EDT(CLTCODE)
    
UPDATE #FINAL_EDT SET NSE =VAMT FROM #NSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSE =VAMT FROM #BSE_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET FO =VAMT FROM #NSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NSX =VAMT FROM #NSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCD =VAMT FROM #MCD_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MCX =VAMT FROM #MCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET NCX =VAMT FROM #NCX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSEFO =VAMT FROM #BSEFO_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET BSX =VAMT FROM #BSX_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET MTF =VAMT FROM #MTF_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
UPDATE #FINAL_EDT SET SLBS =VAMT FROM #SLBS_EDT A WHERE A.CLTCODE =#FINAL_EDT.CLTCODE
    
--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    
    
SELECT CLTCODE,SUM(NSE)NSE,SUM(BSE)BSE,SUM(FO)FO,SUM(NSX)NSX,    
SUM(MCD)MCD ,SUM(MCX)MCX,SUM(NCX)NCX,SUM(BSEFO)BSEFO,SUM(BSX)BSX,SUM(MTF)MTF,SUM(SLBS)SLBS,    
SUM(NSE+BSE+FO+NSX+MCD+MCX+NCX+BSEFO+BSX+MTF+SLBS) AS TOTAL INTO #TEMP_EDT
FROM #FINAL_EDT A WHERE CLTCODE <>'BBBB' AND CLTCODE >='A' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE ORDER BY CLTCODE ASC

--UPDATE #FINAL SET CLTCODE =FAMILY FROM MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE Cl_code =CLTCODE AND CLTCODE LIKE '98%'    

  SELECT  EDT=@TODATE,CLTCODE,NSE*-1 AS NSE,BSE*-1 AS BSE,FO*-1 AS FO,NSX*-1 AS NSX,    
  MCD*-1 AS MCD ,MCX*-1 AS MCX,NCX*-1 AS NCX,BSEFO * -1 AS BSEFO,BSX * -1 AS BSX,MTF*-1 AS MTF,SLBS*-1 AS SLBS,    
      TOTAL*-1 AS TOTAL INTO #TEMP_EDT1  FROM #TEMP_EDT 

DROP TABLE #NSE_EDT
DROP TABLE #BSE_EDT
DROP TABLE #NSEFO_EDT
DROP TABLE #NSX_EDT
DROP TABLE #MCD_EDT
DROP TABLE #MCX_EDT
DROP TABLE #NCX_EDT
DROP TABLE #BSEFO_EDT
DROP TABLE #BSX_EDT
DROP TABLE #MTF_EDT
DROP TABLE #SLBS_EDT
DROP TABLE #FINAL_EDT
DROP TABLE #TEMP_EDT
	  

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMTREV INTO #CLIENTDATA_EXCL
FROM ACCOUNT..LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 16
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)

SELECT CONVERT(VARCHAR(11),EDT) AS EDT,CLTCODE,SUM(VAMT) AS PAYOUTAMT,NETAMT = CONVERT(NUMERIC(18,2),0),TOTAL = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA
FROM ACCOUNT..LEDGER WITH(NOLOCK) WHERE EDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND VTYP = 3
AND  CLTCODE >='A0' AND CLTCODE <='ZZZZZZZZZZZZZ'
GROUP BY CLTCODE,CONVERT(VARCHAR(11),EDT)


UPDATE #CLIENTDATA SET NETAMT = #TEMP_EDT1.TOTAL   FROM #TEMP_EDT1 WHERE #TEMP_EDT1.CLTCODE = #CLIENTDATA.CLTCODE
	  
UPDATE #CLIENTDATA SET TOTAL = NETAMT + PAYOUTAMT
	  
SELECT *,PAYOUTAMTREV = CONVERT(NUMERIC(18,2),0) INTO #CLIENTDATA1 FROM #CLIENTDATA 
WHERE NOT EXISTS (SELECT * FROM #CLIENTDATA_EXCL WHERE #CLIENTDATA.CLTCODE = #CLIENTDATA_EXCL.CLTCODE AND
#CLIENTDATA.PAYOUTAMT = #CLIENTDATA_EXCL.PAYOUTAMTREV  ) ORDER BY 1


UPDATE #CLIENTDATA1 SET PAYOUTAMTREV = #CLIENTDATA_EXCL.PAYOUTAMTREV , NETAMT = NETAMT + #CLIENTDATA_EXCL.PAYOUTAMTREV 
FROM #CLIENTDATA_EXCL WHERE 	  #CLIENTDATA_EXCL.CLTCODE = #CLIENTDATA1.CLTCODE



SELECT @TODATE AS FDATE,CLTCODE,SUM(VAMT) AS VAMT INTO #UNCLEARED_REC_ANG FROM (    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT..LEDGER L WITH (NOLOCK)     
WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND L.VTYP  =2    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))    
AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE    
UNION ALL    
SELECT CLTCODE,SUM(VAMT) AS VAMT FROM ACCOUNT..LEDGER L WITH (NOLOCK)     
WHERE VDT >= @FROMDATE    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) > CONVERT(DATETIME,@TODATE)    
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) <> CONVERT(DATETIME,@TODATE)    
AND VTYP = 2 AND CLTCODE BETWEEN 'A' AND 'ZZZZZZZZZZ' GROUP BY CLTCODE) AS A GROUP BY CLTCODE

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT @SAUDA_DATE= MAX(TRANSDATE) FROM MSAJAG.DBO.TBL_EPN_BENEFIT WITH (NOLOCK) WHERE TRANSDATE <= @TODATE

/*
SELECT TRANSDATE,PARTY_CODE,SUM(CASHBENEFIT)*80/100 AS  EPIACCOUNT80PC  INTO #TBL_EPN_BENEFIT
FROM MSAJAG.DBO.TBL_EPN_BENEFIT --EPN VALUE
WHERE TRANSDATE = @SAUDA_DATE AND  CASHBENEFIT <> 0
GROUP BY TRANSDATE,PARTY_CODE
*/

CREATE TABLE #TBL_EPN_BENEFIT(EXCHANGE VARCHAR(3),SEGMENT VARCHAR(7),PARTY_CODE VARCHAR(10),POOLAMT NUMERIC(18,2),EPIACCOUNT80PC NUMERIC(18,2),LEDAMT NUMERIC(18,2))

INSERT INTO #TBL_EPN_BENEFIT EXEC MSAJAG.DBO.GET_EPI_POOL_ACCOUNT @SAUDA_DATE

;WITH CTE AS(SELECT PARTY_CODE, NETAMT = SUM(NETAMT) 
FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE 
GROUP BY PARTY_CODE)
,
 CTE1 AS(SELECT DISTINCT PARTY_CODE,MTFLEDBAL 
FROM MTFTRADE.DBO.TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE )

SELECT @SAUDA_DATE AS SAUDA_DATE,CTE.PARTY_CODE,CASE WHEN SUM(NETAMT+MTFLEDBAL) > 0 THEN SUM(NETAMT+MTFLEDBAL) ELSE 0 END AS MTFAMOUNT INTO #MTFAMOUNT
FROM CTE , CTE1 WHERE CTE.PARTY_CODE = CTE1.PARTY_CODE
GROUP BY CTE.PARTY_CODE



SELECT  @TODATE AS RDATE,CLTCODE,SUM(VAMT) AS VAMT,SUM(EAMT) AS EAMT,SUM(UNCLEARAMT) AS UNCLEARAMT,SUM(PAYAMOUNT) AS PEAKAMT,
SUM(EPIAMOUNT) AS EPIAMOUNT,SUM(MTFAMOUNT) AS MTFAMOUNT INTO #FINALAMOUNT  
FROM (
SELECT CLTCODE,TOTAL AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #TEMP_VDT1 
UNION ALL
SELECT CLTCODE,0 AS VAMT,TOTAL AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT FROM #TEMP_EDT1
WHERE TOTAL <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,VAMT AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT 
FROM #UNCLEARED_REC_ANG WHERE VAMT <> 0 
UNION ALL
SELECT CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,SUM(TOTAL-PAYOUTAMTREV) AS PAYAMOUNT,0 AS EPIAMOUNT,0 AS MTFAMOUNT  
FROM #CLIENTDATA1 GROUP BY CLTCODE
UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,EPIACCOUNT80PC AS EPIAMOUNT,0 AS MTFAMOUNT
FROM #TBL_EPN_BENEFIT UNION ALL
SELECT PARTY_CODE AS CLTCODE,0 AS VAMT,0 AS EAMT,0 AS UNCLEARAMT,0 AS PAYAMOUNT,0 AS EPIAMOUNT,MTFAMOUNT AS MTFAMOUNT
FROM #MTFAMOUNT  WHERE MTFAMOUNT  <> 0) AS A GROUP BY CLTCODE

UPDATE #FINALAMOUNT
SET PEAKAMT = A.TOTAL
FROM #FINALAMOUNT FA
LEFT JOIN #CLIENTDATA1 CD ON FA.CLTCODE = CD.CLTCODE
INNER JOIN #TEMP_EDT1 A ON FA.CLTCODE = A.CLTCODE
WHERE CD.CLTCODE IS NULL

SELECT  #FINALAMOUNT.*,LONG_NAME,PAN_GIR_NO INTO DATACSV FROM #FINALAMOUNT , MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = CLTCODE ORDER BY 1,2
declare @RUNDATE varchar(11)
Set @RUNDATE= format (GETDATE()-1, 'MMM dd yyyy')
DECLARE @FILENAME VARCHAR(100) = 'J:\BACKOFFICE\Vaibhav\' +'Ledgerdata_' + CONVERT(VARCHAR, CONVERT(DATETIME,@RUNDATE), 105) + '.CSV' 
print @filename
DECLARE @ALL VARCHAR(MAX)  
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT RDATE,CLTCODE,CONVERT(VARCHAR,VAMT),CONVERT(VARCHAR,EAMT),CONVERT(VARCHAR,UNCLEARAMT),CONVERT(VARCHAR,PEAKAMT),CONVERT(VARCHAR,EPIAMOUNT),CONVERT(VARCHAR,MTFAMOUNT),LONG_NAME,PAN_GIR_NO from SCRATCHPAD.DBO.DATACSV with (nolock) " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
 EXEC(@ALL) 
DROP TABLE #FINALAMOUNT
DROP TABLE #MTFAMOUNT
DROP TABLE #CLIENTDATA1
DROP TABLE #TBL_EPN_BENEFIT
DROP TABLE #UNCLEARED_REC_ANG
DROP TABLE #TEMP_EDT1
DROP TABLE #TEMP_VDT1
DROP TABLE #CLIENTDATA
DROP TABLE #CLIENTDATA_EXCL
DROP TABLE DATACSV

SELECT 'LEDGER DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DMS_REPORT
-- --------------------------------------------------
---|| DESCRIPTION :- DMS REPORT COMPLIANCE TEAM (ANKITA KADHI)
---|| CREATED BY :- HRISHI Y
---|| CREATED DATE :- 29-OCT-2024

CREATE PROC [dbo].[USP_DMS_REPORT] (@TDATE DATETIME)

AS

DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\Backoffice\SL_AUTO\COMPLIANCE_REPORTS\DMS_REPORT\INPUT\INPUT.txt'

IF OBJECT_ID(N'tempdb..#INPUT_DATA') IS NOT NULL
DROP TABLE #INPUT_DATA
CREATE TABLE #INPUT_DATA (CODE VARCHAR (100))

SET @SQL='BULK INSERT #INPUT_DATA FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
(                                          
       FIRSTROW = 1,                                          
       FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER                                          
       ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW                                          
       TABLOCK                                          
)'

SET @SQLFINAL= @SQL + @SQL2          
PRINT @SQLFINAL          
EXEC (@SQLFINAL)          

--SELECT TOP 10 * FROM #INPUT_DATA

--DECLARE @TDATE DATETIME = 'SEP  2 2024'

IF OBJECT_ID(N'TEMPDB..#REPORTING_DATA') IS NOT NULL
DROP TABLE #REPORTING_DATA

SELECT MARGINDATE,PARTY_CODE,EXCHANGE +'_'+ SEGMENT AS EXCHANGE,TDAY_LEDGER,TDAY_CASHCOLL,TDAY_NONCASH
INTO #REPORTING_DATA 
FROM MSAJAG.DBO.TBL_COMBINE_REPORTING_DETAIL C WITH (NOLOCK) INNER JOIN #INPUT_DATA I ON C.PARTY_CODE=I.CODE
WHERE MARGINDATE=@TDATE --and EXCHANGE NOT IN ('MTF','EPN')

--SELECT * FROM #REPORTING_DATA

IF OBJECT_ID(N'TEMPDB..#MAIN_DATA') IS NOT NULL
DROP TABLE #MAIN_DATA
SELECT PARTY_CODE, MARGINDATE AS [DATE], [NSECM LED BALANCE]=ISNULL([NSE_CAPITAL],0), [BSECM LED BALANCE]=ISNULL([BSE_CAPITAL],0), [NSEFO LED BALANCE]=ISNULL([NSE_FUTURES],0),
[BSEFO LED BALANCE]=ISNULL([BSE_FUTURES],0), [NSECD LED BALANCE]=ISNULL([NSX_FUTURES],0), [MCDX LED BALANCE]=ISNULL([MCX_FUTURES],0), [NCDX LED BALANCE]=ISNULL([NCX_FUTURES],0)
INTO #MAIN_DATA
FROM ( SELECT PARTY_CODE,MARGINDATE, EXCHANGE, TDAY_LEDGER FROM #REPORTING_DATA ) AS SOURCETABLE
PIVOT
(SUM(TDAY_LEDGER) FOR EXCHANGE IN ([NSE_CAPITAL],[BSE_CAPITAL],[NSE_FUTURES],[BSE_FUTURES],[NSX_FUTURES],[MCX_FUTURES],[NCX_FUTURES])) AS PIVOTTABLE
ORDER BY PIVOTTABLE.PARTY_CODE

ALTER TABLE #MAIN_DATA
ADD [MSEI LED BALANCE] MONEY , [PLEDGE] MONEY , [POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT] MONEY , [EPN UNDER FUNDS COLUMN] MONEY , [MTF COLLATERAL] MONEY , [TOTAL] MONEY , [PAYMENT] MONEY 
, [TOTAL PEAK BALANCE] MONEY , [CLEAR LEDGER BALANCE AS PER DMS] MONEY , [CLEAR LEDGER BALANCE AS PER CLIENT LEDGER] MONEY , [CM_PEAK_1] MONEY , [CM_PEAK_2] MONEY , [CM_PEAK_3] MONEY 
, [CM_PEAK_4] MONEY , [COMMODITY_PEAK_1] MONEY , [COMMODITY_PEAK_2] MONEY , [COMMODITY_PEAK_3] MONEY , [COMMODITY_PEAK_4] MONEY , [NSEFO_PEAK_1] MONEY , [NSEFO_PEAK_2] MONEY 
, [NSEFO_PEAK_3] MONEY , [NSEFO_PEAK_4] MONEY , [NSECD_PEAK_1] MONEY , [NSECD_PEAK_2] MONEY , [NSECD_PEAK_3] MONEY , [NSECD_PEAK_4] MONEY , [MCDX_PEAK_1] MONEY , [MCDX_PEAK_2] MONEY 
, [MCDX_PEAK_3] MONEY , [MCDX_PEAK_4] MONEY , [MCDX_PEAK_5] MONEY , [MCDX_PEAK_6] MONEY , [MCDX_PEAK_7] MONEY , [MCDX_PEAK_8] MONEY , [NCDX_PEAK_1] MONEY , [NCDX_PEAK_2] MONEY , [NCDX_PEAK_3] MONEY 
, [NCDX_PEAK_4] MONEY , [NCDX_PEAK_5] MONEY , [SUM_OF_PEAK_1] MONEY , [SUM_OF_PEAK_2] MONEY , [SUM_OF_PEAK_3] MONEY , [SUM_OF_PEAK_4] MONEY , [SUM_OF_PEAK_5] MONEY , [SUM_OF_PEAK_6] MONEY 
, [SUM_OF_PEAK_7] MONEY , [SUM_OF_PEAK_8] MONEY , [MAX PEAK MARGIN] MONEY

--SELECT * FROM #MAIN_DATA

---------------------- || PLEDGE AND MTF COLLATERAL START || ----------------------
IF OBJECT_ID(N'TEMPDB..#PLEDGE_MTF_DATA') IS NOT NULL
DROP TABLE #PLEDGE_MTF_DATA

SELECT PARTY_CODE, MARGINDATE AS [DATE], [PLEDGE]=ISNULL([NSE_FUTURES],0), [MTF COLLATERAL]=ISNULL([MTF_MTF],0)
INTO #PLEDGE_MTF_DATA
FROM ( SELECT PARTY_CODE,MARGINDATE, EXCHANGE,  TDAY_NONCASH FROM #REPORTING_DATA ) AS SOURCETABLE
PIVOT
(
SUM(TDAY_NONCASH) FOR EXCHANGE IN ([MTF_MTF],[NSE_FUTURES]) 
) AS PIVOTTABLE
ORDER BY PIVOTTABLE.PARTY_CODE

--SELECT * FROM #PLEDGE_MTF_DATA
---------------------- || PLEDGE AND MTF COLLATERAL END || ----------------------

---------------------- || PAYMENT START || ----------------------
IF OBJECT_ID(N'TEMPDB..#PAYMENT') IS NOT NULL
DROP TABLE #PAYMENT

SELECT L.CLTCODE, SUM(L.VAMT) AS VAMT INTO #PAYMENT FROM ACCOUNT.DBO.LEDGER L WITH (NOLOCK) INNER JOIN #INPUT_DATA I ON L.CLTCODE=I.CODE WHERE VDT=@TDATE AND VTYP='3'
GROUP BY L.CLTCODE
--SELECT * FROM #PAYMENT
---------------------- || PAYMENT END || ----------------------

---------------------- || EPN (UNDER FUNDS COLUMN) START || ----------------------
IF OBJECT_ID(N'TEMPDB..#EPN_UNDER_FUND') IS NOT NULL
DROP TABLE #EPN_UNDER_FUND

SELECT C.PARTY_CODE, TDAY_CASHCOLL AS [EPN (UNDER FUNDS COLUMN)] INTO #EPN_UNDER_FUND 
FROM MSAJAG.DBO.TBL_COMBINE_REPORTING_PEAK C WITH (NOLOCK) INNER JOIN #INPUT_DATA I ON C.PARTY_CODE=I.CODE WHERE MARGINDATE=@TDATE
--SELECT * FROM #EPN_UNDER_FUND
---------------------- || EPN (UNDER FUNDS COLUMN) END || ----------------------

---------------------- || PEAK START || ----------------------
--DECLARE @TDATE DATETIME = 'SEP 02 2024'

IF OBJECT_ID(N'TEMPDB..#PEAK_DATA') IS NOT NULL
DROP TABLE #PEAK_DATA
CREATE TABLE #PEAK_DATA (PARTY_CODE VARCHAR (20), TOTAL_MARGIN NUMERIC (18,2), FILECOUNTER VARCHAR (10), EXCHANGE VARCHAR (100))

INSERT INTO #PEAK_DATA
SELECT PARTY_CODE, TOTAL_MARGIN, FILECOUNTER, EXCHANGE='NSECM'
FROM MSAJAG.DBO.TBL_CMMARGIN_INTRADAY M INNER JOIN #INPUT_DATA I ON M.PARTY_CODE=I.CODE WHERE MARGINDATE=@TDATE --NSECM

INSERT INTO #PEAK_DATA
SELECT PARTY_CODE, SPANMARGIN+EXTREAMELOSSMARGIN AS 'TOTAL_MARGIN',FILECOUNTER, EXCHANGE='NSE_COMMODITY' 
FROM ANGELCOMMODITY.NCE.DBO.FOMARGINNEW_INTRADAY M INNER JOIN #INPUT_DATA I ON M.PARTY_CODE=I.CODE WHERE MDATE=@TDATE --NCE

INSERT INTO #PEAK_DATA
SELECT PARTY_CODE, SPANMARGIN+EXTREAMELOSSMARGIN AS 'TOTAL_MARGIN', FILECOUNTER, EXCHANGE='NSEFO' 
FROM ANGELFO.NSEFO.DBO.FOMARGINNEW_INTRADAY M INNER JOIN #INPUT_DATA I ON M.PARTY_CODE=I.CODE WHERE MDATE=@TDATE --NSEFO

INSERT INTO #PEAK_DATA
SELECT PARTY_CODE, SPANMARGIN+EXTREAMELOSSMARGIN AS 'TOTAL_MARGIN', FILECOUNTER, EXCHANGE='NSECD' 
FROM ANGELFO.NSECURFO.DBO.FOMARGINNEW_INTRADAY M INNER JOIN #INPUT_DATA I ON M.PARTY_CODE=I.CODE WHERE MDATE=@TDATE --NSX (NSECD)

INSERT INTO #PEAK_DATA
SELECT PARTY_CODE, TOTALMARGIN, FILECOUNTER, EXCHANGE='MCDX' 
FROM ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW_INTRADAY M INNER JOIN #INPUT_DATA I ON M.PARTY_CODE=I.CODE WHERE MDATE=@TDATE --MCDX

INSERT INTO #PEAK_DATA
SELECT PARTY_CODE,NET_BUY_PREMIUM+INITIAL_MARGIN+ELM_MARGIN 'TOTAL_MARGIN', FILECOUNTER, EXCHANGE='NCDX' 
FROM ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW_INTRADAY M INNER JOIN #INPUT_DATA I ON M.PARTY_CODE=I.CODE WHERE MDATE=@TDATE --NCDX

--SELECT * FROM #PEAK_DATA

IF OBJECT_ID(N'TEMPDB..#PEAK_DATA_NEW') IS NOT NULL
DROP TABLE #PEAK_DATA_NEW

SELECT PARTY_CODE,FILECOUNTER,[NSECM]=ISNULL([NSECM],0),[NSE_COMMODITY]=ISNULL([NSE_COMMODITY],0),[NSEFO]=ISNULL([NSEFO],0),[NSECD]=ISNULL([NSECD],0),[MCDX]=ISNULL([MCDX],0),[NCDX]=ISNULL([NCDX],0)
,TOTAL_MARGIN=ISNULL([NSECM],0)+ISNULL([NSE_COMMODITY],0)+ISNULL([NSEFO],0)+ISNULL([NSECD],0)+ISNULL([MCDX],0)+ISNULL([NCDX],0) 
INTO #PEAK_DATA_NEW
FROM ( SELECT PARTY_CODE, TOTAL_MARGIN, FILECOUNTER, EXCHANGE FROM #PEAK_DATA ) AS SOURCETABLE
PIVOT
(SUM(TOTAL_MARGIN) FOR EXCHANGE IN ([NSECM],[NSE_COMMODITY],[NSEFO],[NSECD],[MCDX],[NCDX])) AS PIVOTTABLE 
ORDER BY PIVOTTABLE.PARTY_CODE,FILECOUNTER

---------------------- || PEAK END || ----------------------

---------------------- || MAIN DATA UPDATE START || ----------------------

--SELECT [EPN UNDER FUNDS COLUMN],* FROM #MAIN_DATA
--SELECT * FROM #PEAK_DATA_NEW WHERE FILECOUNTER='4' and PARTY_CODE='P154728'

UPDATE M SET PLEDGE=P.PLEDGE FROM #PLEDGE_MTF_DATA P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE ---- || PLEDGE DATA UPDATE
UPDATE M SET [MTF COLLATERAL]=P.[MTF COLLATERAL] FROM #PLEDGE_MTF_DATA P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE ---- || MTF COLLATERAL DATA UPDATE
UPDATE M SET PAYMENT=P.VAMT FROM #PAYMENT P INNER JOIN #MAIN_DATA M ON P.CLTCODE=M.PARTY_CODE ---- || PAYMENT DATA UPDATE
UPDATE M SET [EPN UNDER FUNDS COLUMN]=E.[EPN (UNDER FUNDS COLUMN)] FROM #EPN_UNDER_FUND E INNER JOIN #MAIN_DATA M ON E.PARTY_CODE=M.PARTY_CODE ---- || EPN (UNDER FUNDS COLUMN)

---------------------- || PEAK DATA UPDATED START
UPDATE M SET CM_PEAK_1=P.NSECM, COMMODITY_PEAK_1=P.NSE_COMMODITY, NSEFO_PEAK_1=P.NSEFO, NSECD_PEAK_1=P.NSECD, MCDX_PEAK_1=P.MCDX, NCDX_PEAK_1=P.NCDX 
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='1'
UPDATE M SET CM_PEAK_2=P.NSECM, COMMODITY_PEAK_2=P.NSE_COMMODITY, NSEFO_PEAK_2=P.NSEFO, NSECD_PEAK_2=P.NSECD, MCDX_PEAK_2=P.MCDX, NCDX_PEAK_2=P.NCDX 
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='2'
UPDATE M SET CM_PEAK_3=P.NSECM, COMMODITY_PEAK_3=P.NSE_COMMODITY, NSEFO_PEAK_3=P.NSEFO, NSECD_PEAK_3=P.NSECD, MCDX_PEAK_3=P.MCDX, NCDX_PEAK_3=P.NCDX 
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='3'
UPDATE M SET CM_PEAK_4=P.NSECM, COMMODITY_PEAK_4=P.NSE_COMMODITY, NSEFO_PEAK_4=P.NSEFO, NSECD_PEAK_4=P.NSECD, MCDX_PEAK_4=P.MCDX, NCDX_PEAK_4=P.NCDX 
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='4'
UPDATE M SET MCDX_PEAK_5=P.MCDX, NCDX_PEAK_5=P.NCDX 
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='5'
UPDATE M SET MCDX_PEAK_6=P.MCDX
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='6'
UPDATE M SET MCDX_PEAK_7=P.MCDX
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='7'
UPDATE M SET MCDX_PEAK_8=P.MCDX
FROM #PEAK_DATA_NEW P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE WHERE FILECOUNTER='8'

UPDATE M SET SUM_OF_PEAK_1 = (CM_PEAK_1+COMMODITY_PEAK_1+NSEFO_PEAK_1+NSECD_PEAK_1+MCDX_PEAK_1+NCDX_PEAK_1)
, SUM_OF_PEAK_2 = (CM_PEAK_2+COMMODITY_PEAK_2+NSEFO_PEAK_2+NSECD_PEAK_2+MCDX_PEAK_2+NCDX_PEAK_2)
, SUM_OF_PEAK_3 = (CM_PEAK_3+COMMODITY_PEAK_3+NSEFO_PEAK_3+NSECD_PEAK_3+MCDX_PEAK_3+NCDX_PEAK_3)
, SUM_OF_PEAK_4 = (CM_PEAK_4+COMMODITY_PEAK_4+NSEFO_PEAK_4+NSECD_PEAK_4+MCDX_PEAK_4+NCDX_PEAK_4)
, SUM_OF_PEAK_5 = (MCDX_PEAK_5+NCDX_PEAK_5)
, SUM_OF_PEAK_6 = MCDX_PEAK_6
, SUM_OF_PEAK_7 = MCDX_PEAK_7
, SUM_OF_PEAK_8 = MCDX_PEAK_8
FROM #MAIN_DATA M
---------------------- ||PEAK DATA UPDATED END

---------------------- || MAX PEAK MARGIN DATA UPDATED START 
IF OBJECT_ID(N'TEMPDB..#MAX_PEAK_VALUE') IS NOT NULL
DROP TABLE #MAX_PEAK_VALUE

SELECT  PARTY_CODE , MAX([MAX PEAK VALUE]) AS  [MAX PEAK VALUE] INTO #MAX_PEAK_VALUE
FROM  #MAIN_DATA 
UNPIVOT ( [MAX PEAK VALUE] FOR PEAK_VAL IN ( SUM_OF_PEAK_1, SUM_OF_PEAK_2 , SUM_OF_PEAK_3, SUM_OF_PEAK_4, SUM_OF_PEAK_5, SUM_OF_PEAK_6, SUM_OF_PEAK_7, SUM_OF_PEAK_8) ) as u
GROUP BY PARTY_CODE  

UPDATE M SET [MAX PEAK MARGIN]=P.[MAX PEAK VALUE] FROM #MAX_PEAK_VALUE P INNER JOIN #MAIN_DATA M ON P.PARTY_CODE=M.PARTY_CODE

---------------------- || MAX PEAK MARGIN DATA UPDATED END 


UPDATE M SET [TOTAL]=(ISNULL([NSECM LED BALANCE],0)+ISNULL([BSECM LED BALANCE],0)+ISNULL([NSEFO LED BALANCE],0)+ISNULL([BSEFO LED BALANCE],0)+ISNULL([NSECD LED BALANCE],0)
+ISNULL([MCDX LED BALANCE],0)+ISNULL([NCDX LED BALANCE],0)+ISNULL([MSEI LED BALANCE],0)+ISNULL([PLEDGE],0)+ISNULL([POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT],0)
+ISNULL([EPN UNDER FUNDS COLUMN],0)+ISNULL([MTF COLLATERAL],0))
FROM #MAIN_DATA M ---- || TOTAL DATA UPDATE

UPDATE M SET 
[TOTAL PEAK BALANCE]=(ISNULL([TOTAL],0)+ISNULL([PAYMENT],0)),
[CLEAR LEDGER BALANCE AS PER DMS]=(ISNULL([NSECM LED BALANCE],0)+ISNULL([BSECM LED BALANCE],0)+ISNULL([NSEFO LED BALANCE],0)+ISNULL([BSEFO LED BALANCE],0)+ISNULL([NSECD LED BALANCE],0)
+ISNULL([MCDX LED BALANCE],0)+ISNULL([NCDX LED BALANCE],0)+ISNULL([MSEI LED BALANCE],0)) ---- || [TOTAL PEAK BALANCE] AND [CLEAR LEDGER BALANCE AS PER DMS] DATA UPDATE
FROM #MAIN_DATA M

---------------------- || MAIN DATA UPDATE END || ----------------------

--SELECT * FROM #MAIN_DATA

TRUNCATE TABLE DUSTBIN.DBO.TBL_DMS_REPORT_DATA

INSERT INTO DUSTBIN.DBO.TBL_DMS_REPORT_DATA
SELECT [PARTY_CODE], CONVERT(VARCHAR(11),[DATE],103) AS [DATE], CAST([NSECM LED BALANCE] AS VARCHAR) AS [NSECM LED BALANCE], CAST ([BSECM LED BALANCE] AS VARCHAR) AS [BSECM LED BALANCE],
CAST ([NSEFO LED BALANCE] AS VARCHAR) AS [NSEFO LED BALANCE], CAST ([BSEFO LED BALANCE] AS VARCHAR) AS [BSEFO LED BALANCE], CAST ([NSECD LED BALANCE] AS VARCHAR) AS [NSECD LED BALANCE],
CAST ([MCDX LED BALANCE] AS VARCHAR) AS [MCDX LED BALANCE], CAST ([NCDX LED BALANCE] AS VARCHAR) AS [NCDX LED BALANCE], CAST ([MSEI LED BALANCE] AS VARCHAR) AS [MSEI LED BALANCE],
CAST ([PLEDGE] AS VARCHAR) AS [PLEDGE], CAST ([POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT] AS VARCHAR) AS [POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT],
CAST ([EPN UNDER FUNDS COLUMN] AS VARCHAR) AS [EPN UNDER FUNDS COLUMN], CAST ([MTF COLLATERAL] AS VARCHAR) AS [MTF COLLATERAL], CAST ([TOTAL] AS VARCHAR) AS [TOTAL],
CAST ([PAYMENT] AS VARCHAR) AS [PAYMENT], CAST ([TOTAL PEAK BALANCE] AS VARCHAR) AS [TOTAL PEAK BALANCE], CAST ([CLEAR LEDGER BALANCE AS PER DMS] AS VARCHAR) AS [CLEAR LEDGER BALANCE AS PER DMS],
CAST ([CLEAR LEDGER BALANCE AS PER CLIENT LEDGER] AS VARCHAR) AS [CLEAR LEDGER BALANCE AS PER CLIENT LEDGER], CAST ([CM_PEAK_1] AS VARCHAR) AS [CM_PEAK_1], CAST ([CM_PEAK_2] AS VARCHAR) AS [CM_PEAK_2],
CAST ([CM_PEAK_3] AS VARCHAR) AS [CM_PEAK_3], CAST ([CM_PEAK_4] AS VARCHAR) AS [CM_PEAK_4], CAST ([COMMODITY_PEAK_1] AS VARCHAR) AS [COMMODITY_PEAK_1], CAST ([COMMODITY_PEAK_2] AS VARCHAR) AS [COMMODITY_PEAK_2],
CAST ([COMMODITY_PEAK_3] AS VARCHAR) AS [COMMODITY_PEAK_3], CAST ([COMMODITY_PEAK_4] AS VARCHAR) AS [COMMODITY_PEAK_4], CAST ([NSEFO_PEAK_1] AS VARCHAR) AS [NSEFO_PEAK_1], CAST ([NSEFO_PEAK_2] AS VARCHAR) AS [NSEFO_PEAK_2],
CAST ([NSEFO_PEAK_3] AS VARCHAR) AS [NSEFO_PEAK_3], CAST ([NSEFO_PEAK_4] AS VARCHAR) AS [NSEFO_PEAK_4], CAST ([NSECD_PEAK_1] AS VARCHAR) AS [NSECD_PEAK_1], CAST ([NSECD_PEAK_2] AS VARCHAR) AS [NSECD_PEAK_2],
CAST ([NSECD_PEAK_3] AS VARCHAR) AS [NSECD_PEAK_3], CAST ([NSECD_PEAK_4] AS VARCHAR) AS [NSECD_PEAK_4], CAST ([MCDX_PEAK_1] AS VARCHAR) AS [MCDX_PEAK_1], CAST ([MCDX_PEAK_2] AS VARCHAR) AS [MCDX_PEAK_2],
CAST ([MCDX_PEAK_3] AS VARCHAR) AS [MCDX_PEAK_3], CAST ([MCDX_PEAK_4] AS VARCHAR) AS [MCDX_PEAK_4], CAST ([MCDX_PEAK_5] AS VARCHAR) AS [MCDX_PEAK_5], CAST ([MCDX_PEAK_6] AS VARCHAR) AS [MCDX_PEAK_6],
CAST ([MCDX_PEAK_7] AS VARCHAR) AS [MCDX_PEAK_7], CAST ([MCDX_PEAK_8] AS VARCHAR) AS [MCDX_PEAK_8], CAST ([NCDX_PEAK_1] AS VARCHAR) AS [NCDX_PEAK_1], CAST ([NCDX_PEAK_2] AS VARCHAR) AS [NCDX_PEAK_2],
CAST ([NCDX_PEAK_3] AS VARCHAR) AS [NCDX_PEAK_3], CAST ([NCDX_PEAK_4] AS VARCHAR) AS [NCDX_PEAK_4], CAST ([NCDX_PEAK_5] AS VARCHAR) AS [NCDX_PEAK_5], CAST ([SUM_OF_PEAK_1] AS VARCHAR) AS [SUM_OF_PEAK_1],
CAST ([SUM_OF_PEAK_2] AS VARCHAR) AS [SUM_OF_PEAK_2], CAST ([SUM_OF_PEAK_3] AS VARCHAR) AS [SUM_OF_PEAK_3], CAST ([SUM_OF_PEAK_4] AS VARCHAR) AS [SUM_OF_PEAK_4], CAST ([SUM_OF_PEAK_5] AS VARCHAR) AS [SUM_OF_PEAK_5],
CAST ([SUM_OF_PEAK_6] AS VARCHAR) AS [SUM_OF_PEAK_6], CAST ([SUM_OF_PEAK_7] AS VARCHAR) AS [SUM_OF_PEAK_7], CAST ([SUM_OF_PEAK_8] AS VARCHAR) AS [SUM_OF_PEAK_8], CAST ([MAX PEAK MARGIN] AS VARCHAR) AS [MAX PEAK MARGIN]
FROM #MAIN_DATA

---------------------- || FILE GENERATION LOGIC || ----------------------

--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(10),GETDATE(),3),'/','')          
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\SL_AUTO\COMPLIANCE_REPORTS\DMS_REPORT\OUTPUT\' +'DMS_PEAK_DATA_REPORT' + '.CSV'          
DECLARE @ALL VARCHAR(MAX)                    
                    
SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''[PARTY_CODE]'''',	''''[DATE]'''',	''''[NSECM LED BALANCE]'''',	''''[BSECM LED BALANCE]'''',	''''[NSEFO LED BALANCE]'''',	''''[BSEFO LED BALANCE]'''',	''''[NSECD LED BALANCE]'''',	''''[MCDX LED BALANCE]'''',	''''[NCDX LED BALANCE]'''',	''''[MSEI LED BALANCE]'''',	''''[PLEDGE]'''',	''''[POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT]'''',	''''[EPN UNDER FUNDS COLUMN]'''',	''''[MTF COLLATERAL]'''',	''''[TOTAL]'''',	''''[PAYMENT]'''',	''''[TOTAL PEAK BALANCE]'''',	''''[CLEAR LEDGER BALANCE AS PER DMS]'''',	''''[CLEAR LEDGER BALANCE AS PER CLIENT LEDGER]'''',	''''[CM_PEAK_1]'''',	''''[CM_PEAK_2]'''',	''''[CM_PEAK_3]'''',	''''[CM_PEAK_4]'''',	''''[COMMODITY_PEAK_1]'''',	''''[COMMODITY_PEAK_2]'''',	''''[COMMODITY_PEAK_3]'''',	''''[COMMODITY_PEAK_4]'''',	''''[NSEFO_PEAK_1]'''',	''''[NSEFO_PEAK_2]'''',	''''[NSEFO_PEAK_3]'''',	''''[NSEFO_PEAK_4]'''',	''''[NSECD_PEAK_1]'''',	''''[NSECD_PEAK_2]'''',	''''[NSECD_PEAK_3]'''',	''''[NSECD_PEAK_4]'''',	''''[MCDX_PEAK_1]'''',	''''[MCDX_PEAK_2]'''',	''''[MCDX_PEAK_3]'''',	''''[MCDX_PEAK_4]'''',	''''[MCDX_PEAK_5]'''',	''''[MCDX_PEAK_6]'''',	''''[MCDX_PEAK_7]'''',	''''[MCDX_PEAK_8]'''',	''''[NCDX_PEAK_1]'''',	''''[NCDX_PEAK_2]'''',	''''[NCDX_PEAK_3]'''',	''''[NCDX_PEAK_4]'''',	''''[NCDX_PEAK_5]'''',	''''[SUM_OF_PEAK_1]'''',	''''[SUM_OF_PEAK_2]'''',	''''[SUM_OF_PEAK_3]'''',	''''[SUM_OF_PEAK_4]'''',	''''[SUM_OF_PEAK_5]'''',	''''[SUM_OF_PEAK_6]'''',	''''[SUM_OF_PEAK_7]'''',	''''[SUM_OF_PEAK_8]'''',	''''[MAX PEAK MARGIN]'''''                    
SET @ALL = @ALL+ ' UNION ALL SELECT * FROM DUSTBIN.DBO.TBL_DMS_REPORT_DATA'                  
PRINT @ALL                    
SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'                    
PRINT @ALL                    
EXEC(@ALL)                    

---------------------- || FILE GENERATION LOGIC || ----------------------
                
SELECT 'DMS DATA FILE EXPORTED TO \\10.253.33.91\' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_LAST_TRADED_DATA
-- --------------------------------------------------

CREATE PROC [dbo].[USP_LAST_TRADED_DATA]
(  @EXCHANGE  VARCHAR(10),@SEGMENT varchar(20))
AS
DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\BACKOFFICE\NIRMAL\INPUT\CLIENT_DATA.CSV'
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL
    DROP TABLE #CODE
CREATE TABLE #CODE (CLTCODE VARCHAR(50))
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
    (
           FIRSTROW = 1,
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW
           TABLOCK
    )'
SET @SQLFINAL= @SQL + @SQL2
PRINT @SQLFINAL
EXEC (@SQLFINAL)
--SELECT TOP 10 * FROM #CODE
IF OBJECT_ID(N'SCRATCHPAD..CLIENT_LAST_TRADE_DATA') IS NOT NULL

DROP TABLE CLIENT_LAST_TRADE_DATA

select  cl_code,EXCHANGE,SEGMENT,INACTIVE_FROM,ACTIVE_DATE,DEACTIVE_VALUE,DEACTIVE_REMARKS  INTO CLIENT_LAST_TRADE_DATA
from MSAJAG..client_brok_details WHERE CL_CODE IN (SELECT * FROM #CODE) AND EXCHANGE NOT IN ('MCX')




SELECT PARTY_CODE,EXCHANGE,SEGMENT,LAST_TRADE_DATE=MAX(SAUDA_DATE) INTO #LASTTRADE1 
FROM MSAJAG.DBO.CMBILLVALAN WITH (NOLOCK) WHERE PARTY_CODE IN (SELECT * FROM #CODE)
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT


INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE,SEGMENT,LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANAND.BSEDB_AB.DBO.CMBILLVALAN WITH (NOLOCK)
WHERE PARTY_CODE IN (SELECT * FROM #CODE)
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT

INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE='NSE',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELFO.NSEFO.DBO.FOBILLVALAN WITH (NOLOCK)
WHERE PARTY_CODE IN (SELECT * FROM #CODE)AND EXCHANGE='NSEFO'
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT

INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE='NSX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELFO.NSECURFO.DBO.FOBILLVALAN WITH (NOLOCK) 
WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND  EXCHANGE='NSXFO'
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT

INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE='BSE',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.BSEFO.DBO.FOBILLVALAN WITH (NOLOCK) 
WHERE PARTY_CODE IN (SELECT * FROM #CODE)
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT

INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE='BSX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.BSECURFO.DBO.FOBILLVALAN WITH (NOLOCK) 
WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND EXCHANGE='BSXFO'
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT

INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE='NCE',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.NCE.DBO.FOBILLVALAN WITH (NOLOCK)
WHERE PARTY_CODE IN (SELECT * FROM #CODE) 
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT

INSERT INTO #LASTTRADE1
SELECT PARTY_CODE,EXCHANGE='NCX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN WITH (NOLOCK)
WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND EXCHANGE='BSXFO'
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT


ALTER TABLE CLIENT_LAST_TRADE_DATA 
ADD LAST_TRADE_DATE VARCHAR (20)

UPDATE A SET LAST_TRADE_DATE= CONVERT (VARCHAR (10),B.LAST_TRADE_DATE,120) FROM CLIENT_LAST_TRADE_DATA A INNER JOIN #LASTTRADE1 B ON
A.CL_CODE=B.PARTY_CODE 
AND A.EXCHANGE=B.EXCHANGE
AND A.SEGMENT=B.SEGMENT


--SELECT  * FROM CLIENT_LAST_TRADE_DATA WHERE EXCHANGE='NSE' AND SEGMENT ='CAPITAL'
--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(10),GETDATE(),3),'/','')

DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\NIRMAL\OUTPUT\' +'CLIENT_DATA' + '.CSV'        
DECLARE @ALL VARCHAR(MAX)                  
  
  IF (@EXCHANGE='ALL' AND  @SEGMENT='ALL')
  BEGIN

  

SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''CL_CODE'''',''''EXCHANGE'''',''''SEGMENT'''',''''INACTIVE_FROM'''',''''ACTIVE_DATE'''',''''DEACTIVE_VALUE'''',''''DEACTIVE_REMARKS'''',''''LAST_TRADE_DATE'''''
SET @all = @all+ ' UNION ALL SELECT CL_CODE,EXCHANGE,SEGMENT,CONVERT(VARCHAR(10),INACTIVE_FROM,120),CONVERT(VARCHAR(10),ACTIVE_DATE,120),DEACTIVE_VALUE,DEACTIVE_REMARKS,LAST_TRADE_DATE FROM SCRATCHPAD.DBO.CLIENT_LAST_TRADE_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)

END

ELSE

BEGIN



SELECT *  INTO CLIENT_LAST_TRADE_DATA_SEGMENTWISE FROM CLIENT_LAST_TRADE_DATA  WHERE EXCHANGE=@EXCHANGE AND SEGMENT=@SEGMENT

SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''CL_CODE'''',''''EXCHANGE'''',''''SEGMENT'''',''''INACTIVE_FROM'''',''''ACTIVE_DATE'''',''''DEACTIVE_VALUE'''',''''DEACTIVE_REMARKS'''',''''LAST_TRADE_DATE'''''
SET @all = @all+ ' UNION ALL SELECT CL_CODE,EXCHANGE,SEGMENT,CONVERT(VARCHAR(10),INACTIVE_FROM,120),CONVERT(VARCHAR(10),ACTIVE_DATE,120),DEACTIVE_VALUE,DEACTIVE_REMARKS,LAST_TRADE_DATE FROM SCRATCHPAD.DBO.CLIENT_LAST_TRADE_DATA_SEGMENTWISE'             
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)
DROP TABLE CLIENT_LAST_TRADE_DATA_SEGMENTWISE 
END


DROP TABLE #CODE
DROP TABLE CLIENT_LAST_TRADE_DATA

SELECT 'CLIENT DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_LAST_TRADED_DATA_3092025
-- --------------------------------------------------
  
CREATE PROC [dbo].[USP_LAST_TRADED_DATA_3092025]  
AS  
DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)  
SET @PATH='J:\BACKOFFICE\NIRMAL\INPUT\CLIENT_DATA.CSV'  
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL  
    DROP TABLE #CODE  
CREATE TABLE #CODE (CLTCODE VARCHAR(50))  
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''  
SET @SQL2=' WITH  
    (  
           FIRSTROW = 1,  
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER  
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW  
           TABLOCK  
    )'  
SET @SQLFINAL= @SQL + @SQL2  
PRINT @SQLFINAL  
EXEC (@SQLFINAL)  
--SELECT TOP 10 * FROM #CODE  
IF OBJECT_ID(N'SCRATCHPAD..CLIENT_LAST_TRADE_DATA') IS NOT NULL  
  
DROP TABLE CLIENT_LAST_TRADE_DATA  
  
select  cl_code,EXCHANGE,SEGMENT,INACTIVE_FROM,ACTIVE_DATE,DEACTIVE_VALUE,DEACTIVE_REMARKS  INTO CLIENT_LAST_TRADE_DATA  
from MSAJAG..client_brok_details WHERE CL_CODE IN (SELECT * FROM #CODE) AND EXCHANGE NOT IN ('MCX')  
  
SELECT PARTY_CODE,EXCHANGE,SEGMENT,LAST_TRADE_DATE=MAX(SAUDA_DATE) INTO #LASTTRADE1   
FROM MSAJAG.DBO.CMBILLVALAN WITH (NOLOCK) WHERE PARTY_CODE IN (SELECT * FROM #CODE)  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE,SEGMENT,LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANAND.BSEDB_AB.DBO.CMBILLVALAN WITH (NOLOCK)  
WHERE PARTY_CODE IN (SELECT * FROM #CODE)  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE='NSE',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELFO.NSEFO.DBO.FOBILLVALAN WITH (NOLOCK)  
WHERE PARTY_CODE IN (SELECT * FROM #CODE)AND EXCHANGE='NSEFO'  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE='NSX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELFO.NSECURFO.DBO.FOBILLVALAN WITH (NOLOCK)   
WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND  EXCHANGE='NSXFO'  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE='BSE',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.BSEFO.DBO.FOBILLVALAN WITH (NOLOCK)   
WHERE PARTY_CODE IN (SELECT * FROM #CODE)  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE='BSX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.BSECURFO.DBO.FOBILLVALAN WITH (NOLOCK)   
WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND EXCHANGE='BSXFO'  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE='NCE',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.NCE.DBO.FOBILLVALAN WITH (NOLOCK)  
WHERE PARTY_CODE IN (SELECT * FROM #CODE)   
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
INSERT INTO #LASTTRADE1  
SELECT PARTY_CODE,EXCHANGE='NCX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN WITH (NOLOCK)  
WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND EXCHANGE='BSXFO'  
GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  
  
--  INSERT INTO #LASTTRADE1  
--SELECT PARTY_CODE,EXCHANGE='MCX',SEGMENT='FUTURES',LAST_TRADE_DATE=MAX(SAUDA_DATE) FROM ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN WITH (NOLOCK)  
--WHERE PARTY_CODE IN (SELECT * FROM #CODE) AND EXCHANGE='BSXFO'  
--GROUP BY PARTY_CODE,EXCHANGE,SEGMENT  


ALTER TABLE CLIENT_LAST_TRADE_DATA   
ADD LAST_TRADE_DATE VARCHAR (20)  
  
UPDATE A SET LAST_TRADE_DATE= CONVERT (VARCHAR (10),B.LAST_TRADE_DATE,120) FROM CLIENT_LAST_TRADE_DATA A INNER JOIN #LASTTRADE1 B ON  
A.CL_CODE=B.PARTY_CODE   
AND A.EXCHANGE=B.EXCHANGE  
AND A.SEGMENT=B.SEGMENT  
  
  
--SELECT  * FROM CLIENT_LAST_TRADE_DATA  
--DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(10),GETDATE(),3),'/','')  
  
DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\NIRMAL\OUTPUT\' +'CLIENT_DATA' + '.CSV'          
DECLARE @ALL VARCHAR(MAX)                    
                    
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''CL_CODE'''',''''EXCHANGE'''',''''SEGMENT'''',''''INACTIVE_FROM'''',''''ACTIVE_DATE'''',''''DEACTIVE_VALUE'''',''''DEACTIVE_REMARKS'''',''''LAST_TRADE_DATE'''''  
SET @all = @all+ ' UNION ALL SELECT CL_CODE,EXCHANGE,SEGMENT,CONVERT(VARCHAR(10),INACTIVE_FROM,120),CONVERT(VARCHAR(10),ACTIVE_DATE,120),DEACTIVE_VALUE,DEACTIVE_REMARKS,LAST_TRADE_DATE FROM SCRATCHPAD.DBO.CLIENT_LAST_TRADE_DATA'                  
              
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'  
                   
EXEC(@all)      
  
DROP TABLE #CODE  
DROP TABLE CLIENT_LAST_TRADE_DATA  
SELECT 'CLIENT DATA FILE EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF2_FILE_GENERATION
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_MTF2_FILE_GENERATION]
(@SAUDA_DATE DATETIME)

AS

DECLARE @COUNT int, @count1 int, @count2 int,@count3 int, @count4 int,@count5 int, @count6 int,@count7 int,@count8 int

select @COUNT= count(1) from Mtftrade.dbo.TBL_PRODUCT_HOLD_DATA where sauda_date =@SAUDA_DATE and holdflag='MTFCOLL'

IF (@COUNT>20000)

BEGIN

Exec MIMANSA.CLIENTSERVICE.DBO.FillMTFReportingBaseBBG  'A','ZZZZZZZZ',@SAUDA_DATE,@SAUDA_DATE

Update MIMANSA.CLIENTSERVICE.DBO.MTFReportingBase Set BodValue = MtfExchangeDataV1.EodValue  From MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1 Where MtfExchangeDataV1.party_code = MTFReportingBase.Party_code and MtfExchangeDataV1.Scrip_Cd =MTFReportingBase.Scrip_Cd and MtfExchangeDataV1.Series = MTFReportingBase.Series

Update MIMANSA.CLIENTSERVICE.DBO.MTFReportingBase Set DayBuyValue = MTFReportingBase.DayBuyValue + MtfExchangeDataV1.ClientAmount from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1
Where MtfExchangeDataV1.party_code = MTFReportingBase.Party_code
and MtfExchangeDataV1.Scrip_Cd = MTFReportingBase.Scrip_Cd
and MtfExchangeDataV1.Series = MTFReportingBase.Series

Update MIMANSA.CLIENTSERVICE.DBO.MTFReportingBase Set EodValue = BodValue + Daybuyvalue - Daysellvalue

Exec MIMANSA.CLIENTSERVICE.DBO.ProcessMTF

 EXEC ('DROP TABLE CLIENTSERVICE..MtfExchangeDataV1') AT MIMANSA
  EXEC ('DROP TABLE CLIENTSERVICE..MTFReportingBaseV1') AT MIMANSA
--Drop table MIMANSA.CLIENTSERVICE..MtfExchangeDataV1
--Drop table MIMANSA.CLIENTSERVICE..MTFReportingBaseV1


--Select * into MIMANSA.CLIENTSERVICE..MtfExchangeDataV1 from MIMANSA.CLIENTSERVICE..MtfExchangeData

--Select * into MIMANSA.CLIENTSERVICE.DBO.MTFReportingBaseV1 from MIMANSA.CLIENTSERVICE.DBO.MTFReportingBase

Update MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1 Set Daysellvalue = DaySellValue + ClientAmount
Update MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1 Set EodValue = BodValue + DayBuyValue - Daysellvalue


select @count1=COUNT(1)  from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where EODvalue < 0 and EODQty = 0 
select @count2=COUNT(1)  from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where EODvalue > 0 and EODQty = 0


IF (@count1!=0 OR @count2!=0)

BEGIN

select * into #rcsmis from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where EODvalue <> 0 and EODQty = 0

select party_code,Scrip_Cd,daysellvalue_1=DaySellValue+EodValue into #rcsa from #rcsmis order by daysellvalue_1 desc
 
update A
set a.DaySellValue = b.daysellvalue_1,a.EodValue=0
from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1 a, #rcsa b
where a.party_code=b.party_code
and a.scrip_cd=b.scrip_cd

END


select @count3=count(1) from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where DaySellValue < 0---1  
select @count4=count(1)from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where DayBuyValue < 0---1
select @count5=count(1) from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where BodValue < 0---0
select @count6 =count(1) from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where BodValue > 0 and bodqty =0---0
select @count7 =count(1) from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1  where ClientAmount <0


IF (@count3=0 AND @count4=0 AND @count5=0 AND @count6=0  AND @count7=0  )

BEGIN

DELETE FROM MIMANSA.CLIENTSERVICE.DBO.MtfExchangeFileData where reportingdate=@SAUDA_DATE

Insert into MIMANSA.CLIENTSERVICE.DBO.MtfExchangeFileData 
Select * from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeDataV1

IF OBJECT_ID(N'SCRATCHPAD..MTF_FILE_GENERATION') IS NOT NULL
DROP TABLE MTF_FILE_GENERATION

SELECT * INTO MTF_FILE_GENERATION from  MIMANSA.CLIENTSERVICE.DBO.MtfExchangeFileData with(nolock)  where reportingdate =@SAUDA_DATE

select  @count8=COUNT(1) from MIMANSA.CLIENTSERVICE.DBO.MtfExchangeFileData where reportingdate =@SAUDA_DATE

DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\VAIBHAV\' +'MTF_27022025' + '.CSV'        
DECLARE @ALL VARCHAR(MAX)                  
                  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''Srn'''',''''NextDate'''',''''NextCash'''',''''ReportingDate'''',''''Party_code'''',''''ExchangeSegment'''',''''Scrip_Cd'''',''''SERIES'''',''''BODQty'''',''''BodValue'''',''''DayBuyQty'''',''''DayBuyValue'''',''''DaySellQty'''',''''DaySellValue'''',''''EodQty'''',''''EodValue'''',''''EodAdjustValue'''',''''EodCashCollateralDiff'''',''''AdjBuyCash'''',''''AdjSellCash'''',''''ADJCashCollateral'''',''''MtFLedgerBalance'''',''''YesterdayCashCollateral'''',''''CashCollateral'''',''''PleadgedFlag'''',''''ClientAmount'''''
SET @all = @all+ ' UNION ALL SELECT Convert(varchar(max),Srn),Convert(varchar(max),NextDate),Convert(varchar(max),NextCash),Convert(varchar(max),ReportingDate),Party_code,ExchangeSegment,Scrip_Cd,SERIES,Convert(varchar(max),BODQty),Convert(varchar(max),BodValue),Convert(varchar(max),DayBuyQty),Convert(varchar(max),DayBuyValue),Convert(varchar(max),DaySellQty),Convert(varchar(max),DaySellValue),Convert(varchar(max),EodQty),Convert(varchar(max),EodValue),Convert(varchar(max),EodAdjustValue),Convert(varchar(max),EodCashCollateralDiff),Convert(varchar(max),AdjBuyCash),Convert(varchar(max),AdjSellCash),Convert(varchar(max),ADJCashCollateral),Convert(varchar(max),MtFLedgerBalance),Convert(varchar(max),YesterdayCashCollateral),Convert(varchar(max),CashCollateral),PleadgedFlag,Convert(varchar(max),ClientAmount) FROM SCRATCHPAD.DBO.MTF_FILE_GENERATION'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

DROP TABLE MTF_FILE_GENERATION

SELECT 'MTF FILE FOR ' + CONVERT (Varchar(11),@SAUDA_DATE) + ' IS EXPORTED TO ' + @FILENAME + ' AND TOTAL COUNT is '+ CONVERT(VARCHAR(MAX),@count8) AS 'REMARK'

END


ELSE
BEGIN

SELECT 'MTF FILE GENERATION PROCESS IS NOT COMPLETED..KINDLY CONTACT WITH BO TEAM'

END

END

ELSE

BEGIN
SELECT 'MTF PROCESS COUNT IS LESS THAN EXPECTED LIMIT..KINDLY CONTACT WITH BO TEAM'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTR_FILE_GENERATION
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_MTR_FILE_GENERATION]
(@SAUDA_DATE DATETIME)

AS

DECLARE @PREVDATE VARCHAR(11),@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = '' ,     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM MTFTRADE..ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'			
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM MTFTRADE..TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,ReportingDate,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY=DayBuyQty,      
FRESHBUY=DayBuyValue,      
FRESHSQTY=DaySellQty,    
FRESHSELL=DaySellValue,
NETQTY=EodQty,      
NETAMOUNT=	EodValue
INTO #NSERPT
FROM mimansa.clientservice.dbo.MtfExchangeFileData P With(NOLOCK) 
, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE ReportingDate = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + DayBuyQty + DaySellQty) > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO MTFTRADE.DBO.ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
        
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM MTFTRADE..nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

--select * from #REPORT
--return

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM MTFTRADE..TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)
 

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM MTFTRADE..TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')



UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN
AND D.SCRIP_CD = #MTFCOLL.SCRIP_CD ---

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM MTFTRADE..nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
								  THEN SUM(NETAMT) + MTFLEDBAL
								  ELSE 0
						     END),
MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0)
INTO #COLLCASH
FROM MTFTRADE..TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

INSERT INTO #COLLCASH
SELECT DISTINCT PARTY_CODE, CASHCOLL = 0, MTFNONCASHCOLLATERAL = 0 FROM #HOLD
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #COLLCASH WHERE #COLLCASH.PARTY_CODE = #HOLD.PARTY_CODE)

UPDATE #COLLCASH SET MTFNONCASHCOLLATERAL = NONCASH
FROM (SELECT PARTY_CODE, NONCASH = SUM(AMOUNT)
	  FROM #HOLD
	  GROUP BY PARTY_CODE) C
WHERE C.PARTY_CODE = #COLLCASH.PARTY_CODE
/*
UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
	FROM   #HOLD
	GROUP BY PARTY_CODE, CASHCOLL
) A
*/
        

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(MTFNONCASHCOLLATERAL) 
	FROM   #COLLCASH
	GROUP BY PARTY_CODE, CASHCOLL
) A
     

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)
UPDATE #REPORT SET DATA = ISNULL (DATA,'')



INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

IF OBJECT_ID(N'SCRATCHPAD..MTR_DATA_T01') IS NOT NULL
DROP TABLE MTR_DATA_T01

SELECT SNO,FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),  DATA = LTRIM(RTRIM(DATA)) INTO MTR_DATA_T01 FROM #REPORT ORDER BY SNO   
 

DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\VAIBHAV\MTR_' +REPLACE(CONVERT (Varchar(11),@sauda_date,103), '/', '')+'.T01'
DECLARE @ALL VARCHAR(MAX)                  
                  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP " SELECT DATA FROM SCRATCHPAD.DBO.MTR_DATA_T01 ORDER BY SNO'
--SET @all = @all+ ' UNION ALL SELECT REPORT_DATE,CLTCODE,CONVERT(VARCHAR(max),NSECM),CONVERT(VARCHAR(max),BSECM),CONVERT(VARCHAR(max),NSEFO),CONVERT(VARCHAR(max),BSEFO),CONVERT(VARCHAR(max),BSEMF),CONVERT(VARCHAR(max),MTF),CONVERT(VARCHAR(max),SLBS),CONVERT(VARCHAR(max),NSECD),CONVERT(VARCHAR(max),BSECD),CONVERT(VARCHAR(max),MCXCD),CONVERT(VARCHAR(max),MCDX),CONVERT(VARCHAR(max),NCDX),CONVERT(VARCHAR(max),NCE),CONVERT(VARCHAR(max),NET_BALANCE) FROM SCRATCHPAD.DBO.CLIENT_EDT_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

DROP TABLE MTR_DATA_T01

SELECT 'MTR FILE FOR ' + CONVERT (Varchar(11),@SAUDA_DATE) + ' IS EXPORTED TO ' + @FILENAME AS 'REMARK'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_POP_CONTRACT_DATA_CHECK
-- --------------------------------------------------
    
CREATE PROCEDURE USP_POP_CONTRACT_DATA_CHECK ( @SAUDA_DATE VARCHAR(30) )    
AS    
BEGIN    
Select Sauda_date,exchange,segment,Sett_type,party_code_cnt=count(distinct party_code),tr_cnt=count(1)  Into #CCDCOUNT    
from MSAJAG.DBO.Common_contract_data (Nolock)    
where sauda_date >=@SAUDA_DATE and sauda_date <=CAST(@SAUDA_DATE + ' 23:59:59' AS DATETIME)  Group by Sauda_date,exchange,segment,Sett_type    
    
 Select Convert(varchar(11),Sauda_date,120)Sauda_date,Sett_type,party_code_cnt=count(distinct party_code),tr_cnt=count(1)  Into #NSECOUNT    
from MSAJAG.DBO.Settlement (Nolock)    
where sauda_date >=@SAUDA_DATE and sauda_date <=CAST(@SAUDA_DATE + ' 23:59:59' AS DATETIME) and marketrate <> 0 and auctionpart not like 'A%'    
Group by Convert(varchar(11),Sauda_date,120),Sett_type    
    
 Select Convert(varchar(11),Sauda_date,120)Sauda_date,Sett_type,party_code_cnt=count(distinct party_code),tr_cnt=count(1)  Into #BSECOUNT    
from angelbsecm.bsedb_ab.DBO.Settlement with(Nolock)    
where sauda_date >=@SAUDA_DATE and sauda_date <=CAST(@SAUDA_DATE + ' 23:59:59' AS DATETIME)   Group by Convert(varchar(11),Sauda_date,120),Sett_type    
     
 Select Convert(varchar(11),Sauda_date,120)Sauda_date,Sett_type='',party_code_cnt=count(distinct party_code),tr_cnt=count(1)  Into #NSEFOCOUNT    
from angelfo.nsefo.dbo.fosettlement with(Nolock)    
where sauda_date >=@SAUDA_DATE and sauda_date <=CAST(@SAUDA_DATE + ' 23:59:59' AS DATETIME)   and auctionpart<>'CA'  Group by Convert(varchar(11),Sauda_date,120)    
    
 Select Convert(varchar(11),Sauda_date,120)Sauda_date,Sett_type='',party_code_cnt=count(distinct party_code),tr_cnt=count(1)  Into #BSEFOCOUNT    
from angelcommodity.bsefo.dbo.bfosettlement with(Nolock)    
where sauda_date >=@SAUDA_DATE and sauda_date <=CAST(@SAUDA_DATE + ' 23:59:59' AS DATETIME)  and auctionpart<>'CA'  Group by Convert(varchar(11),Sauda_date,120)    
    
Alter table #CCDCOUNT    
Add Trade_Party_count int    
    
Update #CCDCOUNT Set  Trade_Party_count=#NSECOUNT.party_code_cnt    
from #NSECOUNT Where #NSECOUNT.Sett_type=#CCDCOUNT.Sett_type    
    
Update #CCDCOUNT Set  Trade_Party_count=#BSECOUNT.party_code_cnt    
from #BSECOUNT Where #BSECOUNT.Sett_type=#CCDCOUNT.Sett_type    
    
Update #CCDCOUNT Set  Trade_Party_count=#NSEFOCOUNT.party_code_cnt    
from #NSEFOCOUNT Where   exchange ='NSE' and Segment ='FUTURES' and #CCDCOUNT.sauda_date =@SAUDA_DATE
    
Update #CCDCOUNT Set  Trade_Party_count=#BSEFOCOUNT.party_code_cnt    
from #BSEFOCOUNT Where   exchange ='BSE' and Segment ='FUTURES' and #CCDCOUNT.sauda_date =@SAUDA_DATE
    
Select *, Diff =party_code_cnt - Trade_Party_count  from #CCDCOUNT    
    
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_POSTMTF2GENERATION
-- --------------------------------------------------

--EXEC USP_POSTMTF2GENERATION '2025-08-24'

CREATE PROCEDURE [dbo].[USP_POSTMTF2GENERATION]   
(@SAUDA_DATE DATETIME)  
  
AS  
  
DECLARE @COUNT int,@FINALCOUNT varchar(max);  
  
select @COUNT= count(1) from Inhouse..MTF_TDAY_MARGIN_BENEFIT where sauda_date =@SAUDA_DATE  
  
IF (@COUNT=0)  
  
BEGIN  
  
SELECT  PARTY_CODE,SCRIP_CD,SERIES,ISIN,SELL_BUY,Sum(QTY)QTY,Sum(NETAMT)NETAMT INTO #TEMP12
FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION (NOLOCK) WHERE SAUDA_DATE =@SAUDA_DATE AND SELL_BUY=1
Group by PARTY_CODE,SCRIP_CD,SERIES,ISIN,SELL_BUY

Select DISTINCT ISIN,HAIRCUT into #ISIN from MTFTRADE.DBO.TBL_MTF_DATA  where SAUDA_DATE =@SAUDA_DATE
SELECT  T.PARTY_CODE, SUM(T.NETAMT*HAIRCUT/100) AS REQUIRED_MARGIN  INTO #MTOM FROM #TEMP12 T,#ISIN M
WHERE  T.ISIN=M.ISIN
 GROUP BY T.PARTY_CODE

SELECT PARTY_CODE,  AVAILABLE_CASH_BAL=SUM(NETAMT) +MAX(MTFLEDBAL),SUM(MARGIN_REQ) MARGIN_REQ,SAUDA_DATE  INTO #CASH
FROM MTFTRADE.DBO.TBL_MTF_DATA (NOLOCK) WHERE SAUDA_DATE =@SAUDA_DATE
GROUP BY PARTY_CODE,SAUDA_DATE

INSERT INTO Inhouse..MTF_TDAY_MARGIN_BENEFIT
SELECT @SAUDA_DATE,* FROM (
SELECT M.*,AVAILABLE_CASH_BAL,TODAY_MARGIN =(CASE WHEN  REQUIRED_MARGIN >AVAILABLE_CASH_BAL THEN AVAILABLE_CASH_BAL ELSE REQUIRED_MARGIN END)
FROM #MTOM M,#CASH C
WHERE M.PARTY_CODE=C.PARTY_CODE   ) A WHERE TODAY_MARGIN >0

SELECT @FINALCOUNT= count(1) from Inhouse..MTF_TDAY_MARGIN_BENEFIT where sauda_date =@SAUDA_DATE  

IF (@FINALCOUNT=0)

BEGIN 
SELECT 'MTF MARGIN BENEFIT PROCESS DATA FOR TDAY IS ALREADY EXISTS' AS 'REMARK';
END

ELSE

BEGIN 
SELECT 'PROCESS IS COMPLETED AND TDAY MARGIN BENEFIT INSERTED COUNT IS :' + @FINALCOUNT AS 'REMARK';
END

  
END  
  
ELSE  
  
BEGIN  

SELECT 'MTF MARGIN BENEFIT PROCESS DATA FOR TDAY IS ALREADY EXISTS' as 'REMARK'  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_REPORTING_HOLDING_DATA
-- --------------------------------------------------

CREATE PROC [dbo].[USP_REPORTING_HOLDING_DATA] (@TDATE DATETIME)
AS

DECLARE @DATE VARCHAR(20)
SET @DATE =FORMAT(@TDATE, 'MMM dd yyyy')
--@DATE VARCHAR(20)='MAY 28 2024'


IF OBJECT_ID(N'DUSTBIN..TBL_HOLDING_DATA') IS NOT NULL                      
DROP TABLE DUSTBIN.DBO.TBL_HOLDING_DATA

  SELECT DPAM_SBA_NO,DPHMC_ISIN,CONVERT(VARCHAR,[DPHMC_CURR_QTY]) AS DP_HLD INTO DUSTBIN.DBO.TBL_HOLDING_DATA   from [AGMUBODPL3].DMAT.[CITRUS_USR].DP_HLDG_MSTR_CDSL with(nolock),[AGMUBODPL3].DMAT.[CITRUS_USR].DP_ACCT_MSTR with(nolock) where DPHMC_DPAM_ID=DPAM_ID
  AND 
  EXISTS (SELECT CLIENT_CODE FROM [AGMUBODPL3].DMAT.[CITRUS_USR].CLIENT_CODE_DND WHERE DPAM_SBA_NO=CLIENT_CODE) AND DPHMC_HOLDING_DT=@DATE
  order by DPAM_SBA_NO,DPHMC_ISIN

--SELECT * FROM DUSTBIN.DBO.TBL_HOLDING_DATA

DECLARE @RPT_DATE VARCHAR(30)=REPLACE(CONVERT(VARCHAR(11),@DATE,3),' ','')
DECLARE @FILENAME VARCHAR(100) = '\\ANGELDEMAT\Backoffice\SWAPNIL_HOLDING_AUTO\' +'HOLDING_DATA_' + @RPT_DATE + '.CSV'
DECLARE @ALL VARCHAR(MAX)

SET @ALL = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''DPAM_SBA_NO'''',''''DPHMCD_ISIN'''',''''DP_HLD'''''

SET @ALL = @ALL+ ' UNION ALL SELECT * FROM DUSTBIN.DBO.TBL_HOLDING_DATA'
PRINT @ALL
SET @ALL=@ALL+' " QUERYOUT ' +@FILENAME+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
PRINT @ALL
EXEC(@ALL)

DROP TABLE DUSTBIN.DBO.TBL_HOLDING_DATA

--DROP TABLE #TMPHLDG

SELECT 'FILE HAS BEEN CREATED FOR '+@DATE+' IN "\\10.253.33.232\D:\Backoffice\SWAPNIL_HOLDING_AUTO\" PATH'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RPT_GL_SERIES_42_43
-- --------------------------------------------------
--CREATE THIS REPORT UNDER ORE-5067...REQUESTED BY AYAJ SHEIKH DATED ON 02-01-2026


CREATE PROCEDURE [dbo].[USP_RPT_GL_SERIES_42_43]  (@FROMDATE DATETIME,@TODATE DATETIME)  


AS

  DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\BACKOFFICE\AYAZ\INPUT\CLIENT_LEDGER.txt'
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL
    DROP TABLE #CODE
CREATE TABLE #CODE (CLTCODE VARCHAR(50))
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''
SET @SQL2=' WITH
    (
           FIRSTROW = 1,
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW
           TABLOCK
    )'
SET @SQLFINAL= @SQL + @SQL2
PRINT @SQLFINAL
EXEC (@SQLFINAL)


  


select distinct vno,CLTCODE AS BANKCODE into #temp from ACCOUNT.DBO.ledger_all WITH (NOLOCK)where cltcode IN(select * from #code)  
AND VDT >= @FROMDATE + ' 00:00:00'  AND VDT <=@TODATE + ' 23:59:59'

 IF OBJECT_ID(N'SCRATCHPAD..CLIENT_GL_DATA') IS NOT NULL
    DROP TABLE CLIENT_GL_DATA


SELECT 
 T.BANKCODE,
	A.CLTCODE,
	A.EXCHANGE,
	A.ACNAME,A.VDT,A.NARRATION,A.VAMT,A.VNO,A.DRCR
	INTO CLIENT_GL_DATA
   FROM ACCOUNT.DBO.ledger_all A
INNER JOIN #TEMP T 
    ON A.VNO = T.VNO
WHERE A.VDT >= @FROMDATE + ' 00:00:00' 
  AND A.VDT <=@TODATE + ' 23:59:59'
  AND (A.CLTCODE LIKE '43%' 
       OR A.CLTCODE LIKE '42%');

DECLARE @FILENAME VARCHAR(100) = 'J:\Backoffice\AYAZ\OUTPUT\' +'CLIENT_LEDGER' + '.CSV'        
DECLARE @ALL VARCHAR(MAX)                  
                  
SET @all = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''BANKCODE'''',''''CLTCODE'''',''''EXCHANGE'''',''''ACNAME'''',''''VDT'''',''''NARRATION'''',''''VAMT'''',''''VNO'''',''''DRCR'''''
SET @all = @all+ ' UNION ALL SELECT BANKCODE,CLTCODE,EXCHANGE,CONVERT(VARCHAR(max),ACNAME),CONVERT(VARCHAR(10),VDT,120),CONVERT(VARCHAR(max),NARRATION),CONVERT(VARCHAR(max),VAMT),CONVERT(VARCHAR(max),VNO),CONVERT(VARCHAR(max),DRCR) FROM SCRATCHPAD.DBO.CLIENT_GL_DATA'                
            
set @all=@all+' " queryout ' +@filename+ ' -c -t"," -c -t"," -r"\n" -T'', NO_OUTPUT'
                 
EXEC(@all)    

--DROP TABLE #CODE
--DROP TABLE #TEMP
--DROP TABLE CLIENT_GL_DATA

SELECT 'CLIENT GL LEDGER FILE EXPORTED TO ' + @FILENAME AS 'REMARK'


--SELECT * FROM #FINAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_STANDARD_LEDGER
-- --------------------------------------------------
         
---- // DESCRIPTION :- PRAMILA SHELAR REQUIRED Standard Ledger DATA. CREATED BY Akshay M              
              
CREATE PROC [dbo].[USP_STANDARD_LEDGER]    
(@FROMDATE varchar(11),@TODATE varchar(11))
AS        
DECLARE @SQL VARCHAR (MAX) ,@SQL2 VARCHAR (MAX), @SQLFINAL VARCHAR (MAX) , @PATH VARCHAR (MAX)
SET @PATH='J:\BACKOFFICE\Export\nayan\INPUT\StandardLedger.CSV'                
           
 IF OBJECT_ID(N'tempdb..#CODE') IS NOT NULL          
    DROP TABLE #CODE          

CREATE TABLE #CODE (CLTCODE VARCHAR(50))
              
SET @SQL='BULK INSERT #CODE FROM ' + ''''+ @PATH +''''              
SET @SQL2=' WITH                
    (                
           FIRSTROW = 1,                
           FIELDTERMINATOR = '','',  --CSV FIELD DELIMITER                
           ROWTERMINATOR = ''\n'',   --USE TO SHIFT THE CONTROL TO NEXT ROW                
           TABLOCK                
    )'                
              
SET @SQLFINAL= @SQL + @SQL2                
PRINT @SQLFINAL                
EXEC (@SQLFINAL)          

ALTER table #CODE
ADD SNO int identity(1,1)


DECLARE @CNT INT, @FROMCNT INT , @clcode varchar(50),@maxcount int
 select @maxcount=MAX(SNO) from #CODE
SET @FROMCNT =1 
 
 WHILE(@FROMCNT<=@maxcount) 
		
 BEGIN 

Select @clcode =CLTCODE from #CODE WHERE SNO= @FROMCNT

IF OBJECT_ID(N'DUSTBIN..led_sebi') IS NOT NULL  
DROP TABLE DUSTBIN.DBO.led_sebi
  
EXEC DUSTBIN..API_CLIENT_FUNDS_REPORTING_for_Sebi @FROMDATE,@TODATE,@clcode,@clcode  

DECLARE @SQL1 VARCHAR(8000)
SELECT @SQL1 = ' BCP " SELECT DATA = DATA  FROM DUSTBIN.DBO.led_sebi ORDER BY SNO" QUERYOUT J:\\backoffice\Export\nayan\' + CONVERT(VARCHAR(11),@clcode)+'.CSV -r 0x0a -c -t "," -Sanand1 -UAOLINHOUSE -Pe$$gnfDTVs2455GZAcc'
		
EXEC MASTER.DBO.XP_CMDSHELL @SQL1, NO_OUTPUT 
 SET @FROMCNT=@FROMCNT+1

 	
 END
 
 SELECT 'STANDARD LEDGER DATA FILE EXPORTED TO J:\\backoffice\Export\nayan\' AS 'REMARK'

GO

-- --------------------------------------------------
-- TABLE dbo.AUTO_MTF_PROCESS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTO_MTF_PROCESS_LOG]
(
    [PROCESSNAME] VARCHAR(20) NULL,
    [PROCESS_DATE] DATETIME NULL,
    [FLAG] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_GL_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_GL_DATA]
(
    [BANKCODE] VARCHAR(10) NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [EXCHANGE] VARCHAR(5) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [VDT] DATETIME NULL,
    [NARRATION] VARCHAR(500) NULL,
    [VAMT] MONEY NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [DRCR] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DMS_MAIN1
-- --------------------------------------------------
CREATE TABLE [dbo].[DMS_MAIN1]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [NSECM LED BALANCE] MONEY NOT NULL,
    [BSECM LED BALANCE] MONEY NOT NULL,
    [NSEFO LED BALANCE] MONEY NOT NULL,
    [BSEFO LED BALANCE] MONEY NOT NULL,
    [NSECD LED BALANCE] MONEY NOT NULL,
    [MCDX LED BALANCE] MONEY NOT NULL,
    [NCDX LED BALANCE] MONEY NOT NULL,
    [MSEI LED BALANCE] VARCHAR(4) NOT NULL,
    [PLEDGE] VARCHAR(4) NOT NULL,
    [POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT] VARCHAR(4) NOT NULL,
    [EPN UNDER FUNDS COLUMN] VARCHAR(4) NOT NULL,
    [MTF COLLATERAL] VARCHAR(4) NOT NULL,
    [TOTAL] VARCHAR(4) NOT NULL,
    [PAYMENT] VARCHAR(4) NOT NULL,
    [TOTAL PEAK BALANCE] VARCHAR(4) NOT NULL,
    [CLEAR LEDGER BALANCE AS PER DMS] VARCHAR(4) NOT NULL,
    [CLEAR LEDGER BALANCE AS PER CLIENT LEDGER] VARCHAR(4) NOT NULL,
    [CM_PEAK_1] VARCHAR(4) NOT NULL,
    [CM_PEAK_2] VARCHAR(4) NOT NULL,
    [CM_PEAK_3] VARCHAR(4) NOT NULL,
    [CM_PEAK_4] VARCHAR(4) NOT NULL,
    [COMMODITY_PEAK_1] VARCHAR(4) NOT NULL,
    [COMMODITY_PEAK_2] VARCHAR(4) NOT NULL,
    [COMMODITY_PEAK_3] VARCHAR(4) NOT NULL,
    [COMMODITY_PEAK_4] VARCHAR(4) NOT NULL,
    [NSEFO_PEAK_1] VARCHAR(4) NOT NULL,
    [NSEFO_PEAK_2] VARCHAR(4) NOT NULL,
    [NSEFO_PEAK_3] VARCHAR(4) NOT NULL,
    [NSEFO_PEAK_4] VARCHAR(4) NOT NULL,
    [NSECD_PEAK_1] VARCHAR(4) NOT NULL,
    [NSECD_PEAK_2] VARCHAR(4) NOT NULL,
    [NSECD_PEAK_3] VARCHAR(4) NOT NULL,
    [NSECD_PEAK_4] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_1] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_2] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_3] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_4] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_5] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_6] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_7] VARCHAR(4) NOT NULL,
    [MCDX_PEAK_8] VARCHAR(4) NOT NULL,
    [NCDX_PEAK_1] VARCHAR(4) NOT NULL,
    [NCDX_PEAK_2] VARCHAR(4) NOT NULL,
    [NCDX_PEAK_3] VARCHAR(4) NOT NULL,
    [NCDX_PEAK_4] VARCHAR(4) NOT NULL,
    [NCDX_PEAK_5] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_1] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_2] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_3] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_4] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_5] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_6] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_7] VARCHAR(4) NOT NULL,
    [SUM_OF_PEAK_8] VARCHAR(4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[FINAL]
(
    [SRNO] INT NULL,
    [BANK NAME] VARCHAR(255) NULL,
    [Details] VARCHAR(255) NULL,
    [BANKCODE] VARCHAR(255) NULL,
    [TYPE OF ACCOUNT] VARCHAR(255) NULL,
    [SEGMENT] VARCHAR(255) NULL,
    [NAME] VARCHAR(255) NULL,
    [BANK STATEMENT BALANCE] NUMERIC(9, 2) NULL,
    [BANK BOOK BALANCE] NUMERIC(9, 2) NULL,
    [CHQ. DEPOSITED BUT NOT CREDITED] NUMERIC(9, 2) NULL,
    [CHQ. ISSUED BUT NOT DEBITED] NUMERIC(9, 2) NULL,
    [DIFF] NUMERIC(9, 2) NULL,
    [TALLY/ UNTALLY] VARCHAR(20) NULL,
    [REMARKS] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POPULATE_TBL_MTF_DATA_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[POPULATE_TBL_MTF_DATA_LOG]
(
    [PROCESS_NAME] VARCHAR(100) NULL,
    [PROCESS_DATE] DATETIME NULL,
    [FLAG] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BROK_DETAILS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BROK_DETAILS_DATA]
(
    [CL_CODE] VARCHAR(10) NOT NULL,
    [EXCH] VARCHAR(10) NOT NULL,
    [BROK_SCHEME] VARCHAR(20) NULL,
    [TRD_BROK] VARCHAR(20) NULL,
    [DEL_BROK] VARCHAR(20) NULL,
    [CASH_VBB_TRD] VARCHAR(2) NOT NULL,
    [CASH_VBB_DEL] VARCHAR(2) NOT NULL,
    [Fut_Opt_Brok] VARCHAR(20) NULL,
    [Fut_Fut_Fin_Brok] VARCHAR(20) NULL,
    [Fut_Opt_Exc] VARCHAR(20) NULL,
    [Fut_Brok_Applicable] VARCHAR(20) NULL,
    [OPT_VBB_TRD] VARCHAR(2) NOT NULL,
    [OPT_VBB_DEL] VARCHAR(2) NOT NULL,
    [BTB_BTC] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BROK_DETAILS_DATA_PIVOT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BROK_DETAILS_DATA_PIVOT]
(
    [CL_CODE] VARCHAR(10) NOT NULL,
    [BSECAPITAL_BROK_SCHEME] TINYINT NULL,
    [BSECAPITAL_CASH_VBB_DEL] VARCHAR(2) NULL,
    [BSECAPITAL_CASH_VBB_TRD] VARCHAR(2) NULL,
    [BSECAPITAL_DEL_BROK] INT NULL,
    [BSECAPITAL_FUT_BROK_APPLICABLE] INT NULL,
    [BSECAPITAL_FUT_FUT_FIN_BROK] INT NULL,
    [BSECAPITAL_FUT_OPT_BROK] INT NULL,
    [BSECAPITAL_FUT_OPT_EXC] INT NULL,
    [BSECAPITAL_OPT_VBB_DEL] VARCHAR(2) NULL,
    [BSECAPITAL_OPT_VBB_TRD] VARCHAR(2) NULL,
    [BSECAPITAL_TRD_BROK] INT NULL,
    [BSEFUTURES_BROK_SCHEME] TINYINT NULL,
    [BSEFUTURES_CASH_VBB_DEL] VARCHAR(2) NULL,
    [BSEFUTURES_CASH_VBB_TRD] VARCHAR(2) NULL,
    [BSEFUTURES_DEL_BROK] INT NULL,
    [BSEFUTURES_FUT_BROK_APPLICABLE] INT NULL,
    [BSEFUTURES_FUT_FUT_FIN_BROK] INT NULL,
    [BSEFUTURES_FUT_OPT_BROK] INT NULL,
    [BSEFUTURES_FUT_OPT_EXC] INT NULL,
    [BSEFUTURES_OPT_VBB_DEL] VARCHAR(2) NULL,
    [BSEFUTURES_OPT_VBB_TRD] VARCHAR(2) NULL,
    [BSEFUTURES_TRD_BROK] INT NULL,
    [MCXFUTURES_BROK_SCHEME] TINYINT NULL,
    [MCXFUTURES_CASH_VBB_DEL] VARCHAR(2) NULL,
    [MCXFUTURES_CASH_VBB_TRD] VARCHAR(2) NULL,
    [MCXFUTURES_DEL_BROK] INT NULL,
    [MCXFUTURES_FUT_BROK_APPLICABLE] INT NULL,
    [MCXFUTURES_FUT_FUT_FIN_BROK] INT NULL,
    [MCXFUTURES_FUT_OPT_BROK] INT NULL,
    [MCXFUTURES_FUT_OPT_EXC] INT NULL,
    [MCXFUTURES_OPT_VBB_DEL] VARCHAR(2) NULL,
    [MCXFUTURES_OPT_VBB_TRD] VARCHAR(2) NULL,
    [MCXFUTURES_TRD_BROK] INT NULL,
    [NCXFUTURES_BROK_SCHEME] TINYINT NULL,
    [NCXFUTURES_CASH_VBB_DEL] VARCHAR(2) NULL,
    [NCXFUTURES_CASH_VBB_TRD] VARCHAR(2) NULL,
    [NCXFUTURES_DEL_BROK] INT NULL,
    [NCXFUTURES_FUT_BROK_APPLICABLE] INT NULL,
    [NCXFUTURES_FUT_FUT_FIN_BROK] INT NULL,
    [NCXFUTURES_FUT_OPT_BROK] INT NULL,
    [NCXFUTURES_FUT_OPT_EXC] INT NULL,
    [NCXFUTURES_OPT_VBB_DEL] VARCHAR(2) NULL,
    [NCXFUTURES_OPT_VBB_TRD] VARCHAR(2) NULL,
    [NCXFUTURES_TRD_BROK] INT NULL,
    [NSECAPITAL_BROK_SCHEME] TINYINT NULL,
    [NSECAPITAL_CASH_VBB_DEL] VARCHAR(2) NULL,
    [NSECAPITAL_CASH_VBB_TRD] VARCHAR(2) NULL,
    [NSECAPITAL_DEL_BROK] INT NULL,
    [NSECAPITAL_FUT_BROK_APPLICABLE] INT NULL,
    [NSECAPITAL_FUT_FUT_FIN_BROK] INT NULL,
    [NSECAPITAL_FUT_OPT_BROK] INT NULL,
    [NSECAPITAL_FUT_OPT_EXC] INT NULL,
    [NSECAPITAL_OPT_VBB_DEL] VARCHAR(2) NULL,
    [NSECAPITAL_OPT_VBB_TRD] VARCHAR(2) NULL,
    [NSECAPITAL_TRD_BROK] INT NULL,
    [NSEFUTURES_BROK_SCHEME] TINYINT NULL,
    [NSEFUTURES_CASH_VBB_DEL] VARCHAR(2) NULL,
    [NSEFUTURES_CASH_VBB_TRD] VARCHAR(2) NULL,
    [NSEFUTURES_DEL_BROK] INT NULL,
    [NSEFUTURES_FUT_BROK_APPLICABLE] INT NULL,
    [NSEFUTURES_FUT_FUT_FIN_BROK] INT NULL,
    [NSEFUTURES_FUT_OPT_BROK] INT NULL,
    [NSEFUTURES_FUT_OPT_EXC] INT NULL,
    [NSEFUTURES_OPT_VBB_DEL] VARCHAR(2) NULL,
    [NSEFUTURES_OPT_VBB_TRD] VARCHAR(2) NULL,
    [NSEFUTURES_TRD_BROK] INT NULL,
    [NSXFUTURES_BROK_SCHEME] TINYINT NULL,
    [NSXFUTURES_CASH_VBB_DEL] VARCHAR(2) NULL,
    [NSXFUTURES_CASH_VBB_TRD] VARCHAR(2) NULL,
    [NSXFUTURES_DEL_BROK] INT NULL,
    [NSXFUTURES_FUT_BROK_APPLICABLE] INT NULL,
    [NSXFUTURES_FUT_FUT_FIN_BROK] INT NULL,
    [NSXFUTURES_FUT_OPT_BROK] INT NULL,
    [NSXFUTURES_FUT_OPT_EXC] INT NULL,
    [NSXFUTURES_OPT_VBB_DEL] VARCHAR(2) NULL,
    [NSXFUTURES_OPT_VBB_TRD] VARCHAR(2) NULL,
    [NSXFUTURES_TRD_BROK] INT NULL,
    [NCEFUTURES_BROK_SCHEME] TINYINT NULL,
    [NCEFUTURES_CASH_VBB_DEL] VARCHAR(2) NULL,
    [NCEFUTURES_CASH_VBB_TRD] VARCHAR(2) NULL,
    [NCEFUTURES_DEL_BROK] INT NULL,
    [NCEFUTURES_FUT_BROK_APPLICABLE] INT NULL,
    [NCEFUTURES_FUT_FUT_FIN_BROK] INT NULL,
    [NCEFUTURES_FUT_OPT_BROK] INT NULL,
    [NCEFUTURES_FUT_OPT_EXC] INT NULL,
    [NCEFUTURES_OPT_VBB_DEL] VARCHAR(2) NULL,
    [NCEFUTURES_OPT_VBB_TRD] VARCHAR(2) NULL,
    [NCEFUTURES_TRD_BROK] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BROKMISMATCH_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BROKMISMATCH_DATA]
(
    [CL_CODE] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DMS_DATA]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [DATE] DATETIME NOT NULL,
    [NSECM LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [BSECM LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [NSEFO LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [BSEFO LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [NSECD LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [MCDX LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [NCDX LED BALANCE] NUMERIC(38, 4) NOT NULL,
    [MSEI LED BALANCE] MONEY NULL,
    [PLEDGE] MONEY NULL,
    [POOL EPN - VALUE OF SECURITIES AFTER HAIRCUT] MONEY NULL,
    [EPN UNDER FUNDS COLUMN] MONEY NULL,
    [MTF COLLATERAL] MONEY NULL,
    [TOTAL] MONEY NULL,
    [PAYMENT] MONEY NULL,
    [TOTAL PEAK BALANCE] MONEY NULL,
    [CLEAR LEDGER BALANCE AS PER DMS] MONEY NULL,
    [CLEAR LEDGER BALANCE AS PER CLIENT LEDGER] MONEY NULL,
    [CM_PEAK_1] MONEY NULL,
    [CM_PEAK_2] MONEY NULL,
    [CM_PEAK_3] MONEY NULL,
    [CM_PEAK_4] MONEY NULL,
    [COMMODITY_PEAK_1] MONEY NULL,
    [COMMODITY_PEAK_2] MONEY NULL,
    [COMMODITY_PEAK_3] MONEY NULL,
    [COMMODITY_PEAK_4] MONEY NULL,
    [NSEFO_PEAK_1] MONEY NULL,
    [NSEFO_PEAK_2] MONEY NULL,
    [NSEFO_PEAK_3] MONEY NULL,
    [NSEFO_PEAK_4] MONEY NULL,
    [NSECD_PEAK_1] MONEY NULL,
    [NSECD_PEAK_2] MONEY NULL,
    [NSECD_PEAK_3] MONEY NULL,
    [NSECD_PEAK_4] MONEY NULL,
    [MCDX_PEAK_1] MONEY NULL,
    [MCDX_PEAK_2] MONEY NULL,
    [MCDX_PEAK_3] MONEY NULL,
    [MCDX_PEAK_4] MONEY NULL,
    [MCDX_PEAK_5] MONEY NULL,
    [MCDX_PEAK_6] MONEY NULL,
    [MCDX_PEAK_7] MONEY NULL,
    [MCDX_PEAK_8] MONEY NULL,
    [NCDX_PEAK_1] MONEY NULL,
    [NCDX_PEAK_2] MONEY NULL,
    [NCDX_PEAK_3] MONEY NULL,
    [NCDX_PEAK_4] MONEY NULL,
    [NCDX_PEAK_5] MONEY NULL,
    [SUM_OF_PEAK_1] MONEY NULL,
    [SUM_OF_PEAK_2] MONEY NULL,
    [SUM_OF_PEAK_3] MONEY NULL,
    [SUM_OF_PEAK_4] MONEY NULL,
    [SUM_OF_PEAK_5] MONEY NULL,
    [SUM_OF_PEAK_6] MONEY NULL,
    [SUM_OF_PEAK_7] MONEY NULL,
    [SUM_OF_PEAK_8] MONEY NULL,
    [MAX PEAK MARGIN] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST_09052025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST_09052025]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.CMR_AVL_TEST
-- --------------------------------------------------


CREATE VIEW CMR_AVL_TEST 
AS

SELECT PARTY_CODE, MARGINDATE,EXCHANGE,SEGMENT,B2C	,BRANCH_CD,SUB_BROKER,
SUM(T_MARGINAVL)T_MARGINAVL,SUM(T_MTMAVL)T_MTMAVL,
SUM(PEAK_TDAY_T_MARGINAVL)PEAK_TDAY_T_MARGINAVL,SUM(PEAK_TDAY_T_MTMAVL)PEAK_TDAY_T_MTMAVL,
SHORTAGE_VALUE = (CASE WHEN ( 
(CASE WHEN SUM(T_MARGINAVL + T_MTMAVL ) <  SUM(PEAK_TDAY_T_MARGINAVL)  THEN SUM(T_MARGINAVL + T_MTMAVL ) 
ELSE SUM(PEAK_TDAY_T_MARGINAVL) END ))< 0 THEN  
(CASE WHEN SUM(T_MARGINAVL + T_MTMAVL ) <  SUM(PEAK_TDAY_T_MARGINAVL)  THEN SUM(T_MARGINAVL + T_MTMAVL ) 
ELSE SUM(PEAK_TDAY_T_MARGINAVL) END ) ELSE 0 END )
FROM(
SELECT 			
MARGINDATE	,EXCHANGE,	SEGMENT	,A.PARTY_CODE,
(CASE WHEN T_MARGINAVL > 0 THEN 0 ELSE T_MARGINAVL END )			
T_MARGINAVL,(CASE WHEN T_MTMAVL > 0 THEN 0 ELSE T_MTMAVL END )	T_MTMAVL, 
PEAK_TDAY_T_MARGINAVL =0,PEAK_TDAY_T_MTMAVL=0,
B2C	,BRANCH_CD,SUB_BROKER	
FROM MSAJAG.DBO.TBL_COMBINE_REPORTING_DETAIL A,INTRANET.RISK.DBO.CLIENT_DETAILS B			
  WHERE (T_MARGINAVL < 0 OR T_MTMAVL < 0)			
	
AND A.PARTY_CODE = B.PARTY_CODE		
UNION ALL
SELECT 			
MARGINDATE	,EXCHANGE,	SEGMENT	,A.PARTY_CODE,
T_MARGINAVL =0,TDAY_T_MTMAVL=0,
(CASE WHEN T_MARGINAVL > 0 THEN 0 ELSE T_MARGINAVL END )	PEAK_TDAY_T_MARGINAVL		
,(CASE WHEN T_MTMAVL > 0 THEN 0 ELSE T_MTMAVL END )	PEAK_TDAY_T_MTMAVL,
B2C	,BRANCH_CD,SUB_BROKER	
FROM MSAJAG.DBO.TBL_COMBINE_REPORTING_PEAK_DETAIL A,INTRANET.RISK.DBO.CLIENT_DETAILS B			
  WHERE (T_MARGINAVL <0 OR T_MTMAVL < 0)			
	
AND A.PARTY_CODE = B.PARTY_CODE			
)A
GROUP BY PARTY_CODE, MARGINDATE,EXCHANGE,SEGMENT,B2C	,BRANCH_CD,SUB_BROKER

GO

