-- DDL Export
-- Server: 10.254.33.27
-- Database: BSEMFSS
-- Exported: 2026-02-05T11:34:22.659585

USE BSEMFSS;
GO

-- --------------------------------------------------
-- FUNCTION dbo.awsdms_fn_LsnSegmentToHexa
-- --------------------------------------------------
        
CREATE FUNCTION [dbo].[awsdms_fn_LsnSegmentToHexa] (@InputData VARBINARY(32)) RETURNS VARCHAR(64)
AS
  BEGIN
    DECLARE  @HexDigits   	CHAR(16),
             @OutputData      VARCHAR(64),
             @i           	INT,
             @InputDataLength INT

    DECLARE  @ByteInfo  	INT,
             @LeftNibble 	INT,
             @RightNibble INT

    SET @OutputData = ''

    SET @i = 1

    SET @InputDataLength = DATALENGTH(@InputData)

    SET @HexDigits = '0123456789abcdef'

    WHILE (@i <= @InputDataLength)
      BEGIN
        SET @ByteInfo = CONVERT(INT,SUBSTRING(@InputData,@i,1))
        SET @LeftNibble= FLOOR(@ByteInfo / 16)
        SET @RightNibble = @ByteInfo - (@LeftNibble* 16)
        SET @OutputData = @OutputData + SUBSTRING(@HexDigits,@LeftNibble+ 1,1) + SUBSTRING(@HexDigits,@RightNibble + 1,1)
        SET @i = @i + 1
      END

    RETURN @OutputData

  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.awsdms_fn_NumericLsnToHexa
-- --------------------------------------------------
        
CREATE FUNCTION [dbo].[awsdms_fn_NumericLsnToHexa](@numeric25Lsn numeric(25,0)) returns varchar(32)
 AS
 BEGIN
-- In order to avoid form sign overflow problems - declare the LSN segments 
-- to be one 'type' larger than the intendent target type.
-- For example, convert(smallint, convert(numeric(25,0),65535)) will fail 
-- but convert(binary(2), convert(int,convert(numeric(25,0),65535))) will give the 
-- expected result of 0xffff.

declare @high4bytelsnSegment bigint,@mid4bytelsnSegment bigint,@low2bytelsnSegment int
declare @highFactor bigint, @midFactor int

declare @lsnLeftSeg	binary(4)
declare @lsnMidSeg	binary(4)
declare @lsnRightSeg	binary(2)

declare	@hexaLsn	varchar(32)

select @highFactor = 1000000000000000
select @midFactor  = 100000

select @high4bytelsnSegment = convert(bigint, floor(@numeric25Lsn / @highFactor))
select @numeric25Lsn = @numeric25Lsn - convert(numeric(25,0), @high4bytelsnSegment) * @highFactor
select @mid4bytelsnSegment = convert(bigint,floor(@numeric25Lsn / @midFactor ))
select @numeric25Lsn = @numeric25Lsn - convert(numeric(25,0), @mid4bytelsnSegment) * @midFactor
select @low2bytelsnSegment = convert(int, @numeric25Lsn)

set	@lsnLeftSeg	= convert(binary(4), @high4bytelsnSegment)
set	@lsnMidSeg	= convert(binary(4), @mid4bytelsnSegment)
set   @lsnRightSeg	= convert(binary(2), @low2bytelsnSegment)

return [dbo].[awsdms_fn_LsnSegmentToHexa](@lsnLeftSeg)+':'+[dbo].[awsdms_fn_LsnSegmentToHexa](@lsnMidSeg)+':'+[dbo].[awsdms_fn_LsnSegmentToHexa](@lsnRightSeg)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_DATA_DECRYPT
-- --------------------------------------------------


CREATE FUNCTION [dbo].[FN_DATA_DECRYPT]
(
	@KEY	VARCHAR(100),
	@DATA	VARBINARY(8000)
) RETURNS VARCHAR(MAX)
AS
BEGIN
DECLARE @DECRYPT_DATA VARCHAR(MAX)

SELECT @DECRYPT_DATA =  DECRYPTBYKEY(@DATA,1,HASHBYTES(@KEY,CONVERT( VARBINARY, @KEY)))

RETURN @DECRYPT_DATA
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_DATA_ENCRYPT
-- --------------------------------------------------

CREATE FUNCTION [dbo].[FN_DATA_ENCRYPT]
(
	@KEY	VARCHAR(100),
	@DATA	VARCHAR(MAX)
) RETURNS VARBINARY(8000)
AS
BEGIN
DECLARE @ENCRYPT_DATA VARBINARY(8000)

SELECT @ENCRYPT_DATA = ENCRYPTBYKEY(KEY_GUID('Key4CertAutoProcess'),@DATA,1,HASHBYTES(@KEY,CONVERT( VARBINARY, @KEY)))

RETURN @ENCRYPT_DATA
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_SERIES_NAME
-- --------------------------------------------------
CREATE  FUNCTION [dbo].[FN_SERIES_NAME] (@DIV_REINVEST_FLAG VARCHAR(3) ) 
RETURNS VARCHAR(20) AS
BEGIN
	DECLARE @SERIES_NAME VARCHAR(20)
	SELECT @SERIES_NAME = CASE 
							WHEN @DIV_REINVEST_FLAG = 'N' THEN ' - Dividend Payout'
							WHEN @DIV_REINVEST_FLAG = 'Y' THEN ' - Dividend ReInvest'
							--WHEN @DIV_REINVEST_FLAG = 'Z' THEN ' - Dividend ReInvest' 
							ELSE ''
						  END

	RETURN @SERIES_NAME

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnSplitString2Tbl
-- --------------------------------------------------


CREATE FUNCTION [dbo].[fnSplitString2Tbl] (
      @InputString                  VARCHAR(8000),
      @Delimiter                    VARCHAR(50)
)

RETURNS @Items TABLE (
      Item                          VARCHAR(8000)
)

AS
BEGIN
      IF @Delimiter = ' '
      BEGIN
            SET @Delimiter = ','
            SET @InputString = REPLACE(@InputString, ' ', @Delimiter)
      END

      IF (@Delimiter IS NULL OR @Delimiter = '')
            SET @Delimiter = ','

      DECLARE @Item                 VARCHAR(8000)
      DECLARE @ItemList       VARCHAR(8000)
      DECLARE @DelimIndex     INT

      SET @ItemList = @InputString
      SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      WHILE (@DelimIndex != 0)
      BEGIN
            SET @Item = SUBSTRING(@ItemList, 0, @DelimIndex)
            INSERT INTO @Items VALUES (@Item)

            -- Set @ItemList = @ItemList minus one less item
            SET @ItemList = SUBSTRING(@ItemList, @DelimIndex+1, LEN(@ItemList)-@DelimIndex)
            SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      END -- End WHILE

      IF @Item IS NOT NULL -- At least one delimiter was encountered in @InputString
      BEGIN
            SET @Item = @ItemList
            INSERT INTO @Items VALUES (@Item)
      END

      -- No delimiters were encountered in @InputString, so just return @InputString
      ELSE INSERT INTO @Items VALUES (@InputString)

      RETURN

END -- End Function

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING
-- --------------------------------------------------
  
create  FUNCTION [dbo].[FUN_SPLITSTRING](  
                @SPLITSTRING VARCHAR(8000),  
                @DELIMITER   VARCHAR(3))  
RETURNS @SPLITTED TABLE (  
    [SNO] [INT] IDENTITY(1,1) NOT NULL,   
    [SPLITTED_VALUE] [VARCHAR](100) NOT NULL)  
  
AS  
  
/* Split the String and get splitted values in the result-set. Delimiter upto 3 characters long can be used for splitting */  
BEGIN     
  DECLARE  @STRING         VARCHAR(8000),  
           @POSITION       INT,  
           @START_LOCATION INT,  
           @STRING_LENGTH  INT  
                             
  SET @STRING = @SPLITSTRING  
                  
  SET @POSITION = 0  
                    
  SET @START_LOCATION = 0  
                          
  SET @STRING_LENGTH = LEN(@STRING)  
                         
  WHILE @STRING_LENGTH > 0  
    BEGIN  
      
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)  
                        
      IF @POSITION = 0  
        BEGIN  
          INSERT INTO @SPLITTED  
          SELECT @STRING  
                   
          SET @STRING_LENGTH = 0  
                                 
        END  
      ELSE  
        BEGIN  
          INSERT INTO @SPLITTED  
          SELECT LEFT(@STRING,@POSITION - 1)  
                   
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)  
                          
          SET @STRING_LENGTH = LEN(@STRING)  
        END  
          
    END  
  
  RETURN   
  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------



CREATE FUNCTION [dbo].[PIECE] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.UFN_LOGINCHECK
-- --------------------------------------------------
CREATE FUNCTION [dbo].[UFN_LOGINCHECK]      
(      
	@EXCHANGE UDTEXCHANGE = '',      
	@SEGMENT UDTSEGMENT = '',      
	@STATUSID VARCHAR(25),      
	@STATUSNAME VARCHAR(25),      
	@SEARCHWHAT VARCHAR(20) = 'PARTY',      
	@FROMCODE VARCHAR(20) = '0',      
	@TOCODE VARCHAR(20) = 'ZZZZZZZZZZ',      
	@CLTYPE VARCHAR(3) = ''      
)      
/*      
SELECT CODE, SHORT_NAME FROM UFN_LOGINCHECK('NSE', 'CAPITAL', 'BROKER', 'BROKER', 'party', '100', 'Z','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', 'BROKER', 'BROKER', 'party', '0', 'a','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'FAMILY', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', 'BRANCH', 'HO', 'TRADER', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'BRANCH', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'AREA', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'REGION', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', '', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'GL', '0', 'Z','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'cb', '0', 'Z','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'BB', '0', 'Z','')      
*/      
RETURNS      
@CLIENTLOGIN TABLE (      
 [CODE] VARCHAR(50) NOT NULL  DEFAULT '', -- PRIMARY KEY CLUSTERED,      
 [SHORT_NAME] UDTACNAME NOT NULL DEFAULT '',      
 [LONG_NAME] UDTACNAME NOT NULL DEFAULT '',      
 [L_ADDRESS1] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_ADDRESS2] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_ADDRESS3] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_CITY] VARCHAR(35) NOT NULL DEFAULT '',    
 [L_STATE] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_NATION] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_ZIP] VARCHAR(6) NOT NULL DEFAULT '',    
 [FAX] VARCHAR(20) NOT NULL DEFAULT '',    
 [RES_PHONE1] VARCHAR(15) NOT NULL DEFAULT '',    
 [RES_PHONE2] VARCHAR(15) NOT NULL DEFAULT '',    
 [MOBILE_PAGER] VARCHAR(50) NOT NULL DEFAULT '',    
 [PAN_GIR_NO] VARCHAR(10) NOT NULL DEFAULT '',    
 [EMAIL] VARCHAR(50) NOT NULL DEFAULT '',    
 [CL_TYPE] VARCHAR(3) NOT NULL DEFAULT '',   
 [FAMILY] [UDTPARTYCODE] NOT NULL DEFAULT '',      
 [TRADER] [UDTPARTYCODE] NOT NULL DEFAULT '',      
 [SUB_BROKER] UDTREMISIERCODE NOT NULL DEFAULT '',      
 [BRANCH_CD] [UDTBRANCHCODE] NOT NULL DEFAULT '',      
 [AREA] [UDTAREACODE] NOT NULL DEFAULT '',      
 [REGION] [UDTREGIONCODE] NOT NULL DEFAULT '',
 [BANK_NAME] VARCHAR(50) NOT NULL DEFAULT '',
 [ACC_NUM] VARCHAR(40) NOT NULL DEFAULT ''
 ) 
     
AS      
BEGIN   
  
IF @FROMCODE = '' OR @FROMCODE = 'ALL' OR @FROMCODE = '%'      
 BEGIN      
  SET @FROMCODE = '0'      
 END      
 IF @TOCODE = '' OR @TOCODE = 'ALL' OR @FROMCODE = '%'      
 BEGIN      
  SET @TOCODE = 'ZZZZZZZZZZ'      
 END  
 -- ======================================= PARTY ======================================      
 IF @SEARCHWHAT = 'PARTY'      
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,    
      L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE, FAMILY, TRADER, SUB_BROKER, BRANCH_CD, AREA, REGION, BANK_NAME, ACC_NUM)       
  SELECT CL_CODE, SHORT_NAME, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,    
      L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE, FAMILY, TRADER, SUB_BROKER, BRANCH_CD, AREA, REGION, BANK_NAME, ACC_NO     
  FROM CLIENT1 (NOLOCK)      
  WHERE @STATUSNAME = CASE @STATUSID WHEN 'FAMILY' THEN FAMILY      
   WHEN 'TRADER' THEN TRADER      
   WHEN 'SUBBROKER' THEN SUB_BROKER      
   WHEN 'BRANCH' THEN BRANCH_CD      
   WHEN 'AREA' THEN AREA      
   WHEN 'REGION' THEN REGION      
   ELSE 'BROKER' END      
   AND CL_CODE BETWEEN @FROMCODE AND @TOCODE
   AND CL_TYPE = CASE WHEN @CLTYPE = '' OR @CLTYPE = '%' OR @CLTYPE = 'ALL' THEN CL_TYPE ELSE @CLTYPE END      
  ORDER BY CL_CODE, SHORT_NAME      
 END      
 -- ======================================== PARTY ENDS ===============================      
      
 -- ==================================== FAMILY =======================================      
 ELSE IF @SEARCHWHAT = 'FAMILY'       
 BEGIN      
  IF @STATUSID = 'CLIENT'      
   RETURN       
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CL_CODE, SHORT_NAME, LONG_NAME      
  FROM CLIENT1 (NOLOCK)      
  WHERE @STATUSNAME = CASE @STATUSID WHEN 'FAMILY' THEN FAMILY      
   WHEN 'TRADER' THEN TRADER      
   WHEN 'SUBBROKER' THEN SUB_BROKER      
   WHEN 'BRANCH' THEN BRANCH_CD      
   WHEN 'AREA' THEN AREA      
   WHEN 'REGION' THEN REGION      
   ELSE 'BROKER' END      
   AND FAMILY BETWEEN @FROMCODE and @TOCODE      
   AND CL_TYPE = CASE WHEN @CLTYPE = '' OR @CLTYPE = '%' OR @CLTYPE = 'ALL' THEN CL_TYPE ELSE @CLTYPE END      
  ORDER BY CL_CODE, SHORT_NAME      
 END      
 -- ==================================== FAMILY ENDS=======================================      
      
 -- ==================================== TRADER ===========================================      
 ELSE IF @SEARCHWHAT = 'TRADER'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY'      
   RETURN       
  IF @STATUSID = 'TRADER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT BRANCH_CD, SHORT_NAME, LONG_NAME      
   FROM BRANCHES (NOLOCK)      
   WHERE BRANCH_CD = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
   ORDER BY BRANCH_CD, SHORT_NAME      
  END      
      
  ELSE IF @STATUSID = 'SUB_BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), SUBBROKERS S (NOLOCK)      
   WHERE B.BRANCH_CD = S.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE AND @TOCODE      
    AND S.SUB_BROKER = @STATUSNAME      
   ORDER BY B.SHORT_NAME      
  END      
      
  ELSE IF @STATUSID = 'BRANCH'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), BRANCH B1 (NOLOCK)      
   WHERE B.BRANCH_CD = B1.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE and @TOCODE      
    AND B1.BRANCH_CODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), AREA A (NOLOCK)      
   WHERE B.BRANCH_CD = A.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE and @TOCODE      
    AND A.AREACODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), REGION R (NOLOCK)      
   WHERE B.BRANCH_CD = R.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT SHORT_NAME, SHORT_NAME, LONG_NAME      
   FROM BRANCHES (NOLOCK)      
   WHERE SHORT_NAME BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== TRADER ENDS =======================================      
      
 -- ==================================== SUB BROKER ========================================      
 ELSE IF @SEARCHWHAT = 'SUB_BROKER'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY'      
   RETURN      
  IF @STATUSID = 'TRADER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM BRANCHES B (NOLOCK), SUBBROKERS S (NOLOCK)      
   WHERE B.BRANCH_CD = S.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE AND @TOCODE      
    AND B.SHORT_NAME = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'SUB_BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT SUB_BROKER, NAME, NAME      
   FROM SUBBROKERS (NOLOCK)      
   WHERE SUB_BROKER = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'BRANCH'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM SUBBROKERS S (NOLOCK), BRANCH B (NOLOCK)      
   WHERE S.BRANCH_CODE = B.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE and @TOCODE      
    AND B.BRANCH_CODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM SUBBROKERS S (NOLOCK), AREA A (NOLOCK)      
   WHERE S.BRANCH_CODE = A.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE and @TOCODE      
    AND A.AREACODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM SUBBROKERS S (NOLOCK), REGION R (NOLOCK)      
   WHERE S.BRANCH_CODE = R.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
 ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT SUB_BROKER, NAME, NAME      
   FROM SUBBROKERS (NOLOCK)      
   WHERE SUB_BROKER BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== SUB BROKER ENDS ===================================      
      
 -- ==================================== BRANCH ============================================      
 ELSE IF @SEARCHWHAT = 'BRANCH'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY' OR @STATUSID = 'TRADER' OR @STATUSID = 'SUB_BROKER'      
   RETURN      
  IF @STATUSID = 'BRANCH'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT BRANCH_CODE, BRANCH, LONG_NAME      
   FROM BRANCH (NOLOCK)      
   WHERE BRANCH_CODE = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.BRANCH_CODE, B.BRANCH, B.LONG_NAME      
   FROM BRANCH B (NOLOCK), AREA A (NOLOCK)      
   WHERE B.BRANCH_CODE = A.BRANCH_CODE      
    AND B.BRANCH_CODE BETWEEN @FROMCODE and @TOCODE      
    AND A.AREACODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.BRANCH_CODE, B.BRANCH, B.LONG_NAME      
   FROM BRANCH B (NOLOCK), REGION R (NOLOCK)      
   WHERE B.BRANCH_CODE = R.BRANCH_CODE      
    AND B.BRANCH_CODE BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT BRANCH_CODE, BRANCH, LONG_NAME      
   FROM BRANCH (NOLOCK)      
   WHERE BRANCH_CODE BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== BRANCH ENDS ===================================      
      
 -- ==================================== AREA ============================================      
 ELSE IF @SEARCHWHAT = 'AREA'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY' OR @STATUSID = 'TRADER' OR @STATUSID = 'SUB_BROKER' OR @STATUSID = 'BRANCH'      
   RETURN      
  IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT AREACODE, DESCRIPTION, DESCRIPTION      
   FROM AREA (NOLOCK)      
   WHERE AREACODE = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT A.AREACODE, A.DESCRIPTION, A.DESCRIPTION      
   FROM AREA A (NOLOCK), REGION R (NOLOCK)      
   WHERE A.BRANCH_CODE = R.BRANCH_CODE      
    AND A.AREACODE BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT AREACODE, DESCRIPTION, DESCRIPTION      
   FROM AREA (NOLOCK)      
   WHERE AREACODE BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== AREA ENDS ===================================      
      
 -- ==================================== REGION ============================================      
 ELSE IF @SEARCHWHAT = 'REGION'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY' OR @STATUSID = 'TRADER' OR @STATUSID = 'SUB_BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA'      
   RETURN      
  IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT REGIONCODE, DESCRIPTION, DESCRIPTION      
   FROM REGION (NOLOCK)      
   WHERE REGIONCODE = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT REGIONCODE, DESCRIPTION, DESCRIPTION      
   FROM REGION (NOLOCK)      
   WHERE REGIONCODE BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== REGION ENDS ===================================      
      
 -- ==================================== General Ledger ================================      
 ELSE IF @SEARCHWHAT = 'GL'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CLTCODE, ACNAME, LONGNAME      
  FROM ACMAST (NOLOCK)      
  WHERE       
  EXCHANGE = @EXCHANGE      
  AND SEGMENT = @SEGMENT      
  AND ACCAT IN (3, 14, 103)      
  AND (BRANCHCODE = 'ALL' OR      
   BRANCHCODE = CASE @STATUSID WHEN 'BROKER' THEN BRANCHCODE      
       WHEN 'BRANCH' THEN @STATUSNAME      
       ELSE '' END)      
  AND CLTCODE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CLTCODE, ACNAME      
 END      
      
 -- ==================================== General Ledger End ============================      
      
 -- ==================================== Cash Book ================================      
 ELSE IF @SEARCHWHAT = 'CB'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CLTCODE, ACNAME, LONGNAME      
  FROM ACMAST (NOLOCK)      
  WHERE       
  EXCHANGE = @EXCHANGE      
  AND SEGMENT = @SEGMENT      
  AND ACCAT = 1      
  AND (BRANCHCODE = 'ALL' OR      
   BRANCHCODE = CASE @STATUSID WHEN 'BROKER' THEN BRANCHCODE      
       WHEN 'BRANCH' THEN @STATUSNAME      
       ELSE '' END)      
  AND CLTCODE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CLTCODE, ACNAME      
 END      
      
 -- ==================================== Cash Book End ============================      
      
 -- ==================================== Bank Book ================================      
 ELSE IF @SEARCHWHAT = 'BB'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CLTCODE, ACNAME, LONGNAME      
  FROM ACMAST (NOLOCK)      
  WHERE       
  EXCHANGE = @EXCHANGE      
  AND SEGMENT = @SEGMENT      
  AND ACCAT = 2      
  AND (BRANCHCODE = 'ALL' OR      
   BRANCHCODE = CASE @STATUSID WHEN 'BROKER' THEN BRANCHCODE      
       WHEN 'BRANCH' THEN @STATUSNAME      
       ELSE '' END)      
  AND CLTCODE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CLTCODE, ACNAME      
 END      
      
 -- ==================================== Bank Book End ============================      
      
 -- ==================================== Client Type ================================      
 ELSE IF @SEARCHWHAT = 'CLTYPE'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT LTRIM(RTRIM(CL_TYPE)), LTRIM(RTRIM(DESCRIPTION)), LTRIM(RTRIM(DESCRIPTION))      
  FROM CLIENTTYPE (NOLOCK)      
  WHERE       
  CL_TYPE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CL_TYPE, DESCRIPTION      
 END      
      
 -- ==================================== Client Type End ============================      
  RETURN      
END      
/*      
SELECT TOP 5 * FROM CLIENT_DETAILS --WHERE FAMILY = '00000031'      
SELECT TOP 5 * FROM CLIENT1      
SELECT TOP 5 * FROM CLIENT2      
SELECT  TOP 5 * FROM BRANCH      
SELECT  TOP 5 * FROM BRANCHES      
SELECT TOP 5 * FROM SUBBROKERS      
SELECT TOP 5 * FROM AREA      
SELECT TOP 5 * FROM REGION      
SELECT TOP 5 * FROM ACMAST  WHERE  ACCAT = 3      
*/

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCH
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branch] ON [dbo].[BRANCH] ([BRANCH], [BRANCH_CODE], [LONG_NAME])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCH
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Brcode] ON [dbo].[BRANCH] ([BRANCH_CODE], [BRANCH])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCHES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branches] ON [dbo].[BRANCHES] ([SHORT_NAME], [BRANCH_CD], [COM_PERC])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCHES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branchshort] ON [dbo].[BRANCHES] ([BRANCH_CD], [SHORT_NAME], [COM_PERC])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Bk] ON [dbo].[broktable] ([Table_No], [Line_No], [Trd_Del], [Val_perc], [Upper_lim])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Broktable_Upperlim] ON [dbo].[broktable] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Tabnouplim] ON [dbo].[broktable] ([Table_No], [Upper_lim], [Line_No], [Val_perc])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Upperlim] ON [dbo].[broktable] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch], [sett_sales], [round_to])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTSTATUS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSt] ON [dbo].[CLIENTSTATUS] ([CL_STATUS])

GO

-- --------------------------------------------------
-- INDEX dbo.clienttype
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[clienttype] ([Cl_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.IMP_FilePath
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxFl] ON [dbo].[IMP_FilePath] ([File_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.MfMissingclient
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_PARTY] ON [dbo].[MfMissingclient] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.MfMissingclient
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MFCLI] ON [dbo].[MfMissingclient] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cli] ON [dbo].[MFSS_CLIENT] ([PARTY_CODE], [ACTIVE_FROM])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [DP] ON [dbo].[MFSS_CLIENT] ([DP_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_mfss_client] ON [dbo].[MFSS_CLIENT] ([PARTY_CODE], [PARTY_NAME], [SUB_BROKER])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MFSS_CLIENT_Active] ON [dbo].[MFSS_CLIENT] ([ACTIVE_FROM], [INACTIVE_FROM])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MFSS_CLIENT_EMAIL_ID_INACTIVE_FROM] ON [dbo].[MFSS_CLIENT] ([EMAIL_ID], [INACTIVE_FROM])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MFSS_CLIENT_INACTIVE_FROM] ON [dbo].[MFSS_CLIENT] ([INACTIVE_FROM]) INCLUDE ([PARTY_CODE], [PARTY_NAME], [BRANCH_CD], [SUB_BROKER])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MFSS_CLIENT_MOBILE_NO_INACTIVE_FROM] ON [dbo].[MFSS_CLIENT] ([MOBILE_NO], [INACTIVE_FROM])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MFSS_CLIENT_PAN_NO_INACTIVE_FROM] ON [dbo].[MFSS_CLIENT] ([PAN_NO], [INACTIVE_FROM])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sub] ON [dbo].[MFSS_CLIENT] ([SUB_BROKER]) INCLUDE ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLIENT_trig
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_party] ON [dbo].[MFSS_CLIENT_trig] ([PARTY_CODE], [MODIFIED_ON])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_CLMST_VALUES
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXTYPE] ON [dbo].[MFSS_CLMST_VALUES] ([V_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_FINAL_LIST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_PARTY] ON [dbo].[MFSS_FINAL_LIST] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.POBANK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [iX_BANK] ON [dbo].[POBANK] ([BANKID])

GO

-- --------------------------------------------------
-- INDEX dbo.POBANK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [iX_BANK_NAME] ON [dbo].[POBANK] ([BANK_NAME], [BRANCH_NAME]) INCLUDE ([BANKID])

GO

-- --------------------------------------------------
-- INDEX dbo.S_ACTIVE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_C] ON [dbo].[S_ACTIVE] ([PARTY_CODE], [CLTDPID])

GO

-- --------------------------------------------------
-- INDEX dbo.STATE_MASTER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxstate] ON [dbo].[STATE_MASTER] ([State])

GO

-- --------------------------------------------------
-- INDEX dbo.SUBBROKERS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSb] ON [dbo].[SUBBROKERS] ([SUB_BROKER], [BRANCH_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.SUBBROKERS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indSbBrok] ON [dbo].[SUBBROKERS] ([SUB_BROKER])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_AUTO_PROCESS_DETAIL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_TBL_AUTO_PROCESS_DETAIL] ON [dbo].[TBL_AUTO_PROCESS_DETAIL] ([PROCESS_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TblAdmin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TblAdmin] ([Fldauto_Admin])

GO

-- --------------------------------------------------
-- INDEX dbo.TblAdminconfig
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TblAdminconfig] ([Fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TblCategory
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [categoryidx] ON [dbo].[TblCategory] ([Fldcategorycode])

GO

-- --------------------------------------------------
-- INDEX dbo.TblCatmenu
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TblCatmenu] ([Fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXLOGIN] ON [dbo].[TBLCLASSUSERLOGINS] ([FLDUSERNAME], [FLDSESSION], [FLDIPADDRESS])

GO

-- --------------------------------------------------
-- INDEX dbo.TblMenuHead
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxMenu] ON [dbo].[TblMenuHead] ([Fldmenucode])

GO

-- --------------------------------------------------
-- INDEX dbo.TblPradnyausers
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxUser] ON [dbo].[TblPradnyausers] ([Fldauto], [Fldadminauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TblReportgrp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpr] ON [dbo].[TblReportgrp] ([Fldreportgrp], [Fldmenugrp])

GO

-- --------------------------------------------------
-- INDEX dbo.TblReports
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxReport] ON [dbo].[TblReports] ([Fldreportcode])

GO

-- --------------------------------------------------
-- INDEX dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpt] ON [dbo].[TblReports_Blocked] ([fldadminauto], [Fldreportcode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblUserControlGlobals] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [AutoIDx] ON [dbo].[tblUserControlMaster] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [UserIdidx] ON [dbo].[tblUserControlMaster] ([FLDUSERID])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblUserControlMaster_Jrnl] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Login_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxUser] ON [dbo].[V2_Login_Log] ([AddDt], [UserId])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxReport] ON [dbo].[V2_Report_Access_Log] ([RepPath])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.awsdms_truncation_safeguard
-- --------------------------------------------------
ALTER TABLE [dbo].[awsdms_truncation_safeguard] ADD CONSTRAINT [PK__awsdms_t__65C99AC8477313E5] PRIMARY KEY ([latchTaskName], [latchMachineGUID], [LatchKey])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.BRANCH
-- --------------------------------------------------
ALTER TABLE [dbo].[BRANCH] ADD CONSTRAINT [Pk_Branch] PRIMARY KEY ([BRANCH_CODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.BRANCHES
-- --------------------------------------------------
ALTER TABLE [dbo].[BRANCHES] ADD CONSTRAINT [Pk_Branches] PRIMARY KEY ([SHORT_NAME])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Delaccbalance
-- --------------------------------------------------
ALTER TABLE [dbo].[Delaccbalance] ADD CONSTRAINT [PK_Delaccbalance] PRIMARY KEY ([Cltcode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.DeliveryDp
-- --------------------------------------------------
ALTER TABLE [dbo].[DeliveryDp] ADD CONSTRAINT [PK_DeliveryDp] PRIMARY KEY ([SNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Demattrans
-- --------------------------------------------------
ALTER TABLE [dbo].[Demattrans] ADD CONSTRAINT [PK_demattrans] PRIMARY KEY ([Sno])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_BROKERAGE_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_BROKERAGE_MASTER] ADD CONSTRAINT [PK_MFSS_BROKERAGE_MASTER] PRIMARY KEY ([PARTY_CODE], [FROMDATE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_CLIEN_TEMP_TEST
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_CLIEN_TEMP_TEST] ADD CONSTRAINT [PK_MFSS_CLIENT_TEMP] PRIMARY KEY ([PARTY_CODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_CLIENT
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_CLIENT] ADD CONSTRAINT [PK_MFSS_CLIENT] PRIMARY KEY ([PARTY_CODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_DPMASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_DPMASTER] ADD CONSTRAINT [PK_MFSS_DPMASTER] PRIMARY KEY ([PARTY_CODE], [DP_TYPE], [DPID], [CLTDPID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_FUNDS_OBLIGATION
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_FUNDS_OBLIGATION] ADD CONSTRAINT [PK_MFSS_FUNDS_OBLIGATION] PRIMARY KEY ([ORDER_DATE], [ORDER_NO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_NAV
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_NAV] ADD CONSTRAINT [PK_MFSS_NAV] PRIMARY KEY ([NAV_DATE], [SCRIP_CD])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_ORDER
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_ORDER] ADD CONSTRAINT [PK_MFSS_ORDER] PRIMARY KEY ([ORDER_DATE], [ORDER_NO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_ORDER_STATUS
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_ORDER_STATUS] ADD CONSTRAINT [PK_MFSS_ORDER_STATUS] PRIMARY KEY ([SETT_NO], [SETT_TYPE], [ORDER_NO], [ORDER_DATE], [SCRIP_CD])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_SCRIP_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_SCRIP_MASTER] ADD CONSTRAINT [PK_MFSS_SCRIP_MASTER_1] PRIMARY KEY ([SCRIP_CD])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_SCRIP_MASTER_test
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_SCRIP_MASTER_test] ADD CONSTRAINT [PK_MFSS_SCRIP_MASTER_12] PRIMARY KEY ([SCRIP_CD])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_SETTLEMENT
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_SETTLEMENT] ADD CONSTRAINT [PK_MFSS_SETTLEMENT] PRIMARY KEY ([ORDER_DATE], [ORDER_NO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFSS_TRADE
-- --------------------------------------------------
ALTER TABLE [dbo].[MFSS_TRADE] ADD CONSTRAINT [PK_MFSS_TRADE] PRIMARY KEY ([ORDER_DATE], [ORDER_NO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Multicltid
-- --------------------------------------------------
ALTER TABLE [dbo].[Multicltid] ADD CONSTRAINT [PK_Multicltid_1] PRIMARY KEY ([Party_Code], [Cltdpno], [Dpid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SETT_MST
-- --------------------------------------------------
ALTER TABLE [dbo].[SETT_MST] ADD CONSTRAINT [PK_SETT_MST] PRIMARY KEY ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TblPradnyausers
-- --------------------------------------------------
ALTER TABLE [dbo].[TblPradnyausers] ADD CONSTRAINT [PK_tblpradnyausers] PRIMARY KEY ([Fldauto])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_Digital_File_Name
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_Digital_File_Name] ADD CONSTRAINT [PK_V2_Digital_File_Name] PRIMARY KEY ([SrNo], [D_Type], [D_Order])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTOPROCESS_NEWPOSTBILL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[AUTOPROCESS_NEWPOSTBILL]  
(                
 @SETT_NO [UDTSETTNO],    
 @SETT_TYPE [UDTSETTTYPE],    
 @BILLDATE VARCHAR(11),  
 @EXCHANGE [UDTEXCHANGE],    
 @SEGMENT [UDTSEGMENT]    
)     
--WITH ENCRYPTION               
AS      
    
  
DECLARE  
 @VTYPE [UDTVTYPE],    
 @BOOKTYPE [UDTBOOKTYPE],    
 @VDT VARCHAR(11),           
 @EDTDR VARCHAR(11),    
 @EDTCR VARCHAR(11),  
 @UNAME [UDTUSERID],   
 @IP_ADD VARCHAR(20),  
 @@SQL VARCHAR(500),  
 @SHAREDB VARCHAR(100)  
   
   
SET @VTYPE = 15  
SET @BOOKTYPE = '01'  
SET @VDT = @BILLDATE  
SET @UNAME = 'AUTO_PROCESS'  
SET @IP_ADD = 'AUTO_PROCESS'  
  
SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT    
  
CREATE TABLE #PAYIN_DATES  
(  
 PAYIN_DATE DATETIME  
)  
  
if @EXCHANGE = 'BSE'  
 INSERT INTO #PAYIN_DATES SELECT TOP 1 PAYIN_DATE FROM BSEMFSS..ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
else  
 INSERT INTO #PAYIN_DATES SELECT TOP 1 PAYIN_DATE FROM NSEMFSS..ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
  
  
SELECT @EDTDR = PAYIN_DATE, @EDTCR = PAYIN_DATE FROM #PAYIN_DATES  
  
--EXEC AUTO_NEWPOSTBILL 15,'01',@BILLDATE,@EDTDR,@EDTCR,@SETT_NO,@SETT_TYPE,'AUTO',@CATEGORY='1',@EXCHANGE,@SEGMENT,'','127.0.0.1'  
exec AUTO_NEWPOSTBILL 15,'01',@BILLDATE,@EDTDR,@EDTCR,@SETT_NO,@SETT_TYPE,'demo demo','1',@EXCHANGE,@SEGMENT,'','127.0.0.1'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER] (@TODATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER 'FEB 11 2022'

DECLARE @FROMDATE VARCHAR(11)
SELECT @FROMDATE =SDTCUR FROM ANAND1.ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTY_NAME =  PNAME FROM TDAYMFORDER A, 
(SELECT PARTY_CODE,PNAME=UPPER(PARTY_NAME) FROM BSEMFSS.DBO.MFSS_CLIENT WITH (NOLOCK))B
WHERE A.PARTY_CODE = B.PARTY_CODE


/* EDT LEDGER BALANCE */

SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM' 
FROM  ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCXCD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MTF
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF' 
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF' 
FROM  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- SLBS
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS' 
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS' 
FROM  ANAND1.ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECM UNRECO
SELECT CLTCODE,SUM(CASE WHEN DRCR ='D' THEN -VAMT ELSE VAMT END) AS BALANCE,EXCHANGE='NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VTYP='2' AND VDT >= @FROMDATE AND EDT='2049-12-31 00:00:00.000' 
AND ENTEREDBY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM UNRECO
SELECT CLTCODE,SUM(CASE WHEN DRCR ='D' THEN -VAMT ELSE VAMT END) AS BALANCE,EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VTYP='2' AND VDT > = @FROMDATE AND EDT='2049-12-31 00:00:00.000' 
AND ENTEREDBY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET EDT_LEDGER = EDTLEDBAL,REPORT_DATE=@TODATE FROM TDAYMFORDER A,
(SELECT CLTCODE,EDTLEDBAL=SUM(LEDBAL) FROM #EDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* VDT LEDGER BALANCE */

SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET VDT_LEDGER = VDTLEDBAL FROM TDAYMFORDER A,
(SELECT CLTCODE,VDTLEDBAL=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* COLLATERALS UPDATE */

UPDATE A SET COLLATERALS = COLL FROM TDAYMFORDER A,
(SELECT FO.PARTY_CODE,COLL=SUM(FO.NONCASH_COLL+FO.CASH_COLL)
FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK)
WHERE MARGINDATE IN (SELECT MAX(MARGINDATE) FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK))
GROUP BY PARTY_CODE) B WHERE A.PARTY_CODE = B.party_code


/* MF OPENING BALANCE DATA */

SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #OPMF FROM (
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18
UNION ALL 
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE
UNION ALL
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00' 
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE-1 + ' 23:59:59' AND A.VTYPE <> 18 ) A
GROUP BY A.CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 

--- PREVIOUS DAY RECEIPTS ENTIRES ADJEUSTMENT
SELECT CLTCODE,ACNAME,ACCAT,VNO,DRAMOUNT,CRAMOUNT,NARRATION,VDT,EDT,RELDT=CR_RELDT,CDT=POSTED_ON,ENTER_BY=POSTED_BY INTO #EDTADJ
FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @FROMDATE AND @TODATE-1 + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') AND EDT='2049-12-31 00:00:00.000'

SELECT CLTCODE,PDAY_BALANCE=SUM(LEDBAL),EXCHANGE INTO #PDAY_BALANCE FROM (
SELECT * FROM #OPMF UNION ALL SELECT CLTCODE,CRAMOUNT=SUM(CRAMOUNT),EXCHANGE='BSEMF' FROM #EDTADJ GROUP BY CLTCODE) A
GROUP BY A.CLTCODE,A.EXCHANGE

--- TDAY LEDGER BALANCE ADJEUSTMENT
INSERT INTO #PDAY_BALANCE
SELECT CLTCODE,PDAY_BALANCE = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE FROM (
SELECT B.CLTCODE,EXCHANGE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE <> '2'
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') A
GROUP BY CLTCODE,EXCHANGE

UPDATE A1 SET MF_OPEN_BALANCE = PDAY_BALANCE FROM TDAYMFORDER A1, 
(SELECT CLTCODE,PDAY_BALANCE=SUM(PDAY_BALANCE) FROM #PDAY_BALANCE GROUP BY CLTCODE) A2 WHERE A1.PARTY_CODE = A2.CLTCODE


/* BSE MFSS RECEIPTS DETAILS */

SELECT CLTCODE,TDAY_RECEIPTS=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #TDAY_RECEIPTS FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE = '2'AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE

INSERT INTO #TDAY_RECEIPTS
SELECT CLTCODE,TDAY_RECEIPTS=CRAMOUNT,EXCHANGE='BSEMF' FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') AND EDT='2049-12-31 00:00:00.000'

UPDATE A1 SET MF_TDAY_RECEIPTS = TDAY_RECEIPTS FROM TDAYMFORDER A1, 
(SELECT CLTCODE,TDAY_RECEIPTS=SUM(TDAY_RECEIPTS) FROM #TDAY_RECEIPTS GROUP BY CLTCODE) A2
WHERE A1.PARTY_CODE = A2.CLTCODE

---- PENDING RECEIPT ENTRIES 
UPDATE A SET MF_TDAY_RECEIPTS = MF_TDAY_RECEIPTS + VAMT FROM TDAYMFORDER A,
(SELECT CLTCODE,VAMT FROM PEDING_ENTRIES WHERE FIMPORT_DATE BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND EXCHANGE='BSEMF') B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE A SET TOTAL_FUNDS = EDT_LEDGER + MF_TDAY_RECEIPTS + MF_OPEN_BALANCE
FROM TDAYMFORDER A


/* SAME DAY ORDER UPDATE */

UPDATE A SET TDAY_ORDER = TDAY_ORDER + PDAY FROM TDAYMFORDER A,
(SELECT PARTY_CODE,PDAY=SUM(TDAY_ORDER) FROM TDAYMFORDER_LOG B1
WHERE REPORT_DATE = @TODATE AND B1.RUNDATE IN (SELECT MAX(B2.RUNDATE) 
FROM TDAYMFORDER_LOG B2 WHERE B2.REPORT_DATE = @TODATE AND B1.PARTY_CODE = B2.PARTY_CODE)
GROUP BY PARTY_CODE) B
WHERE A.PARTY_CODE = B.PARTY_CODE

UPDATE A SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER FROM TDAYMFORDER A


/* FINAL REPORT */

SELECT REPORT_DATE,A.PARTY_CODE,A.PARTY_NAME,B.BRANCH_CD,B.SUB_BROKER,
EDT_LEDGER,VDT_LEDGER,MF_TDAY_RECEIPTS,MF_OPEN_BALANCE,COLLATERALS,
TOTAL_FUNDS,TDAY_ORDER,NET_BALANCE,[BAL AFTER ORDER EXECUTIONS] = TOTAL_FUNDS - TDAY_ORDER,
ORDER_STAUS = CASE WHEN TOTAL_FUNDS - TDAY_ORDER > = -100 THEN 'APPROVED' 
WHEN MF_TDAY_RECEIPTS+MF_OPEN_BALANCE > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END,
FILEIMPORT=RUNDATE
FROM TDAYMFORDER A LEFT OUTER JOIN MFSS_CLIENT B ON (A.PARTY_CODE = B.PARTY_CODE)
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_05022022
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_05022022] (@TODATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER 'DEC  9 2021'

DECLARE @FROMDATE VARCHAR(11)
SELECT @FROMDATE =SDTCUR FROM ANAND1.ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTY_NAME =  PNAME FROM TDAYMFORDER A, 
(SELECT PARTY_CODE,PNAME=UPPER(PARTY_NAME) FROM BSEMFSS.DBO.MFSS_CLIENT WITH (NOLOCK))B
WHERE A.PARTY_CODE = B.PARTY_CODE


/* EDT LEDGER BALANCE */

SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM' 
FROM  ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCXCD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MTF
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF' 
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF' 
FROM  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- SLBS
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS' 
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS' 
FROM  ANAND1.ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET EDT_LEDGER = EDTLEDBAL,REPORT_DATE=@TODATE FROM TDAYMFORDER A,
(SELECT CLTCODE,EDTLEDBAL=SUM(LEDBAL) FROM #EDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* VDT LEDGER BALANCE */

SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET VDT_LEDGER = VDTLEDBAL FROM TDAYMFORDER A,
(SELECT CLTCODE,VDTLEDBAL=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* COLLATERALS UPDATE */

UPDATE A SET COLLATERALS = COLL FROM TDAYMFORDER A,
(SELECT FO.PARTY_CODE,COLL=SUM(FO.NONCASH_COLL+FO.CASH_COLL)
FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK)
WHERE MARGINDATE IN (SELECT MAX(MARGINDATE) FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK))
GROUP BY PARTY_CODE) B WHERE A.PARTY_CODE = B.party_code


/* MF OPENING BALANCE DATA */

SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #OPMF FROM (
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18
UNION ALL 
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE
UNION ALL
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00' 
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE-1 + ' 23:59:59' AND A.VTYPE <> 18 ) A
GROUP BY A.CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 

--- PREVIOUS DAY RECEIPTS ENTIRES ADJEUSTMENT
SELECT CLTCODE,ACNAME,ACCAT,VNO,DRAMOUNT,CRAMOUNT,NARRATION,VDT,EDT,RELDT=CR_RELDT,CDT=POSTED_ON,ENTER_BY=POSTED_BY INTO #EDTADJ
FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @FROMDATE AND @TODATE-1 + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1') AND EDT='2049-12-31 00:00:00.000'

SELECT CLTCODE,PDAY_BALANCE=SUM(LEDBAL),EXCHANGE INTO #PDAY_BALANCE FROM (
SELECT * FROM #OPMF UNION ALL SELECT CLTCODE,CRAMOUNT=SUM(CRAMOUNT),EXCHANGE='BSEMF' FROM #EDTADJ GROUP BY CLTCODE) A
GROUP BY A.CLTCODE,A.EXCHANGE

--- TDAY LEDGER BALANCE ADJEUSTMENT
INSERT INTO #PDAY_BALANCE
SELECT CLTCODE,PDAY_BALANCE = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE FROM (
SELECT B.CLTCODE,EXCHANGE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE <> '2'
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') A
GROUP BY CLTCODE,EXCHANGE

UPDATE A1 SET MF_OPEN_BALANCE = PDAY_BALANCE FROM TDAYMFORDER A1, 
(SELECT CLTCODE,PDAY_BALANCE=SUM(PDAY_BALANCE) FROM #PDAY_BALANCE GROUP BY CLTCODE) A2 WHERE A1.PARTY_CODE = A2.CLTCODE


/* BSE MFSS RECEIPTS DETAILS */

SELECT CLTCODE,TDAY_RECEIPTS=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #TDAY_RECEIPTS FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE = '2'AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE

INSERT INTO #TDAY_RECEIPTS
SELECT CLTCODE,TDAY_RECEIPTS=CRAMOUNT,EXCHANGE='BSEMF' FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1') AND EDT='2049-12-31 00:00:00.000'

UPDATE A1 SET MF_TDAY_RECEIPTS = TDAY_RECEIPTS FROM TDAYMFORDER A1, 
(SELECT CLTCODE,TDAY_RECEIPTS=SUM(TDAY_RECEIPTS) FROM #TDAY_RECEIPTS GROUP BY CLTCODE) A2
WHERE A1.PARTY_CODE = A2.CLTCODE

---- PENDING RECEIPT ENTRIES 
UPDATE A SET MF_TDAY_RECEIPTS = MF_TDAY_RECEIPTS + VAMT FROM TDAYMFORDER A,
(SELECT CLTCODE,VAMT FROM PEDING_ENTRIES WHERE FIMPORT_DATE BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND EXCHANGE='BSEMF') B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE A SET TOTAL_FUNDS = EDT_LEDGER + MF_TDAY_RECEIPTS + MF_OPEN_BALANCE
FROM TDAYMFORDER A

UPDATE A SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER FROM TDAYMFORDER A

SELECT REPORT_DATE,PARTY_CODE,PARTY_NAME,EDT_LEDGER,VDT_LEDGER,MF_TDAY_RECEIPTS,MF_OPEN_BALANCE,COLLATERALS,
TOTAL_FUNDS,TDAY_ORDER,NET_BALANCE,[BAL AFTER ORDER EXECUTIONS] = TOTAL_FUNDS - TDAY_ORDER,
ORDER_STAUS = CASE WHEN TOTAL_FUNDS - TDAY_ORDER > = -100 THEN 'APPROVED' 
WHEN MF_TDAY_RECEIPTS+MF_OPEN_BALANCE > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END,
FILEIMPORT=RUNDATE
FROM TDAYMFORDER 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_09122021
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER] (@TODATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER 'OCT  5 2021'

DECLARE @FROMDATE VARCHAR(11)
SELECT @FROMDATE =SDTCUR FROM ANAND1.ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTY_NAME =  PNAME FROM TDAYMFORDER A, 
(SELECT PARTY_CODE,PNAME=UPPER(PARTY_NAME) FROM BSEMFSS.DBO.MFSS_CLIENT WITH (NOLOCK))B
WHERE A.PARTY_CODE = B.PARTY_CODE


/* EDT LEDGER BALANCE */

SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM' 
FROM  ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCXCD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MTF
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF' 
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF' 
FROM  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- SLBS
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS' 
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS' 
FROM  ANAND1.ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET EDT_LEDGER = EDTLEDBAL,REPORT_DATE=@TODATE FROM TDAYMFORDER A,
(SELECT CLTCODE,EDTLEDBAL=SUM(LEDBAL) FROM #EDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* VDT LEDGER BALANCE */

SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET VDT_LEDGER = VDTLEDBAL FROM TDAYMFORDER A,
(SELECT CLTCODE,VDTLEDBAL=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* COLLATERALS UPDATE */

UPDATE A SET COLLATERALS = COLL FROM TDAYMFORDER A,
(SELECT FO.PARTY_CODE,COLL=SUM(FO.NONCASH_COLL+FO.CASH_COLL)
FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK)
WHERE MARGINDATE IN (SELECT MAX(MARGINDATE) FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK))
GROUP BY PARTY_CODE) B WHERE A.PARTY_CODE = B.party_code


/* MF OPENING BALANCE DATA */

UPDATE A1 SET MF_OPEN_BALANCE = LEDBAL FROM TDAYMFORDER A1,
(SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' FROM (
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18
UNION ALL 
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE
UNION ALL
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00' 
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE-1 + ' 23:59:59' AND A.VTYPE <> 18 ) A
GROUP BY A.CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 ) A2 WHERE A1.PARTY_CODE = A2.CLTCODE

UPDATE A1 SET MF_OPEN_BALANCE = MF_OPEN_BALANCE + TDAY_BALANCE FROM TDAYMFORDER A1,
(SELECT CLTCODE,TDAY_BALANCE=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE <> '2'
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 ) A2 WHERE A1.PARTY_CODE = A2.CLTCODE


/* BSE MFSS RECEIPTS DETAILS */

UPDATE A1 SET MF_TDAY_RECEIPTS = TDAY_RECEIPTS FROM TDAYMFORDER A1,
(SELECT CLTCODE,TDAY_RECEIPTS=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE = '2'AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE) A2 WHERE A1.PARTY_CODE = A2.CLTCODE

UPDATE A SET MF_TDAY_RECEIPTS = MF_TDAY_RECEIPTS + VAMT FROM TDAYMFORDER A,
(SELECT CLTCODE,VAMT FROM PEDING_ENTRIES WHERE FIMPORT_DATE BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND EXCHANGE='BSEMF') B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE A SET TOTAL_FUNDS = EDT_LEDGER + MF_TDAY_RECEIPTS + MF_OPEN_BALANCE
FROM TDAYMFORDER A

UPDATE A SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER FROM TDAYMFORDER A

SELECT REPORT_DATE,PARTY_CODE,PARTY_NAME,EDT_LEDGER,VDT_LEDGER,MF_TDAY_RECEIPTS,MF_OPEN_BALANCE,COLLATERALS,
TOTAL_FUNDS,TDAY_ORDER,NET_BALANCE,[BAL AFTER ORDER EXECUTIONS] = TOTAL_FUNDS - TDAY_ORDER,
ORDER_STAUS = CASE WHEN TOTAL_FUNDS - TDAY_ORDER > = -100 THEN 'APPROVED' 
WHEN MF_TDAY_RECEIPTS+MF_OPEN_BALANCE > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END,
FILEIMPORT=RUNDATE
FROM TDAYMFORDER 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_11022022
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_11022022] (@TODATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER 'DEC  9 2021'

DECLARE @FROMDATE VARCHAR(11)
SELECT @FROMDATE =SDTCUR FROM ANAND1.ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTY_NAME =  PNAME FROM TDAYMFORDER A, 
(SELECT PARTY_CODE,PNAME=UPPER(PARTY_NAME) FROM BSEMFSS.DBO.MFSS_CLIENT WITH (NOLOCK))B
WHERE A.PARTY_CODE = B.PARTY_CODE


/* EDT LEDGER BALANCE */

SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM' 
FROM  ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCXCD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MTF
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF' 
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF' 
FROM  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- SLBS
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS' 
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS' 
FROM  ANAND1.ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECM UNRECO
SELECT CLTCODE,SUM(CASE WHEN DRCR ='D' THEN -VAMT ELSE VAMT END) AS BALANCE,EXCHANGE='NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VTYP='2' AND VDT >= @FROMDATE AND EDT='2049-12-31 00:00:00.000' 
AND ENTEREDBY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM UNRECO
SELECT CLTCODE,SUM(CASE WHEN DRCR ='D' THEN -VAMT ELSE VAMT END) AS BALANCE,EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VTYP='2' AND VDT > = @FROMDATE AND EDT='2049-12-31 00:00:00.000' 
AND ENTEREDBY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET EDT_LEDGER = EDTLEDBAL,REPORT_DATE=@TODATE FROM TDAYMFORDER A,
(SELECT CLTCODE,EDTLEDBAL=SUM(LEDBAL) FROM #EDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* VDT LEDGER BALANCE */

SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET VDT_LEDGER = VDTLEDBAL FROM TDAYMFORDER A,
(SELECT CLTCODE,VDTLEDBAL=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* COLLATERALS UPDATE */

UPDATE A SET COLLATERALS = COLL FROM TDAYMFORDER A,
(SELECT FO.PARTY_CODE,COLL=SUM(FO.NONCASH_COLL+FO.CASH_COLL)
FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK)
WHERE MARGINDATE IN (SELECT MAX(MARGINDATE) FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK))
GROUP BY PARTY_CODE) B WHERE A.PARTY_CODE = B.party_code


/* MF OPENING BALANCE DATA */

SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #OPMF FROM (
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18
UNION ALL 
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE
UNION ALL
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00' 
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE-1 + ' 23:59:59' AND A.VTYPE <> 18 ) A
GROUP BY A.CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 

--- PREVIOUS DAY RECEIPTS ENTIRES ADJEUSTMENT
SELECT CLTCODE,ACNAME,ACCAT,VNO,DRAMOUNT,CRAMOUNT,NARRATION,VDT,EDT,RELDT=CR_RELDT,CDT=POSTED_ON,ENTER_BY=POSTED_BY INTO #EDTADJ
FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @FROMDATE AND @TODATE-1 + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') AND EDT='2049-12-31 00:00:00.000'

SELECT CLTCODE,PDAY_BALANCE=SUM(LEDBAL),EXCHANGE INTO #PDAY_BALANCE FROM (
SELECT * FROM #OPMF UNION ALL SELECT CLTCODE,CRAMOUNT=SUM(CRAMOUNT),EXCHANGE='BSEMF' FROM #EDTADJ GROUP BY CLTCODE) A
GROUP BY A.CLTCODE,A.EXCHANGE

--- TDAY LEDGER BALANCE ADJEUSTMENT
INSERT INTO #PDAY_BALANCE
SELECT CLTCODE,PDAY_BALANCE = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE FROM (
SELECT B.CLTCODE,EXCHANGE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE <> '2'
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') A
GROUP BY CLTCODE,EXCHANGE

UPDATE A1 SET MF_OPEN_BALANCE = PDAY_BALANCE FROM TDAYMFORDER A1, 
(SELECT CLTCODE,PDAY_BALANCE=SUM(PDAY_BALANCE) FROM #PDAY_BALANCE GROUP BY CLTCODE) A2 WHERE A1.PARTY_CODE = A2.CLTCODE


/* BSE MFSS RECEIPTS DETAILS */

SELECT CLTCODE,TDAY_RECEIPTS=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #TDAY_RECEIPTS FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE = '2'AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE

INSERT INTO #TDAY_RECEIPTS
SELECT CLTCODE,TDAY_RECEIPTS=CRAMOUNT,EXCHANGE='BSEMF' FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') AND EDT='2049-12-31 00:00:00.000'

UPDATE A1 SET MF_TDAY_RECEIPTS = TDAY_RECEIPTS FROM TDAYMFORDER A1, 
(SELECT CLTCODE,TDAY_RECEIPTS=SUM(TDAY_RECEIPTS) FROM #TDAY_RECEIPTS GROUP BY CLTCODE) A2
WHERE A1.PARTY_CODE = A2.CLTCODE

---- PENDING RECEIPT ENTRIES 
UPDATE A SET MF_TDAY_RECEIPTS = MF_TDAY_RECEIPTS + VAMT FROM TDAYMFORDER A,
(SELECT CLTCODE,VAMT FROM PEDING_ENTRIES WHERE FIMPORT_DATE BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND EXCHANGE='BSEMF') B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE A SET TOTAL_FUNDS = EDT_LEDGER + MF_TDAY_RECEIPTS + MF_OPEN_BALANCE
FROM TDAYMFORDER A

UPDATE A SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER FROM TDAYMFORDER A

SELECT REPORT_DATE,PARTY_CODE,PARTY_NAME,EDT_LEDGER,VDT_LEDGER,MF_TDAY_RECEIPTS,MF_OPEN_BALANCE,COLLATERALS,
TOTAL_FUNDS,TDAY_ORDER,NET_BALANCE,[BAL AFTER ORDER EXECUTIONS] = TOTAL_FUNDS - TDAY_ORDER,
ORDER_STAUS = CASE WHEN TOTAL_FUNDS - TDAY_ORDER > = -100 THEN 'APPROVED' 
WHEN MF_TDAY_RECEIPTS+MF_OPEN_BALANCE > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END,
FILEIMPORT=RUNDATE
FROM TDAYMFORDER 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_28012022
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_28012022] (@TODATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER 'DEC  9 2021'

DECLARE @FROMDATE VARCHAR(11)
SELECT @FROMDATE =SDTCUR FROM ANAND1.ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTY_NAME =  PNAME FROM TDAYMFORDER A, 
(SELECT PARTY_CODE,PNAME=UPPER(PARTY_NAME) FROM BSEMFSS.DBO.MFSS_CLIENT WITH (NOLOCK))B
WHERE A.PARTY_CODE = B.PARTY_CODE


/* EDT LEDGER BALANCE */

SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM' 
FROM  ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCXCD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MTF
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF' 
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF' 
FROM  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- SLBS
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS' 
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS' 
FROM  ANAND1.ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET EDT_LEDGER = EDTLEDBAL,REPORT_DATE=@TODATE FROM TDAYMFORDER A,
(SELECT CLTCODE,EDTLEDBAL=SUM(LEDBAL) FROM #EDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* VDT LEDGER BALANCE */

SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET VDT_LEDGER = VDTLEDBAL FROM TDAYMFORDER A,
(SELECT CLTCODE,VDTLEDBAL=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* COLLATERALS UPDATE */

UPDATE A SET COLLATERALS = COLL FROM TDAYMFORDER A,
(SELECT FO.PARTY_CODE,COLL=SUM(FO.NONCASH_COLL+FO.CASH_COLL)
FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK)
WHERE MARGINDATE IN (SELECT MAX(MARGINDATE) FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK))
GROUP BY PARTY_CODE) B WHERE A.PARTY_CODE = B.party_code


/* MF OPENING BALANCE DATA */

SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #OPMF FROM (
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18
UNION ALL 
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE
UNION ALL
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00' 
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE-1 + ' 23:59:59' AND A.VTYPE <> 18 ) A
GROUP BY A.CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 

--- PREVIOUS DAY RECEIPTS ENTIRES ADJEUSTMENT
SELECT CLTCODE,ACNAME,ACCAT,VNO,DRAMOUNT,CRAMOUNT,NARRATION,VDT,EDT,RELDT=CR_RELDT,CDT=POSTED_ON,ENTER_BY=POSTED_BY INTO #EDTADJ
FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @FROMDATE AND @TODATE-1 + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1') AND EDT='2049-12-31 00:00:00.000'

SELECT CLTCODE,PDAY_BALANCE=SUM(LEDBAL),EXCHANGE INTO #PDAY_BALANCE FROM (
SELECT * FROM #OPMF UNION ALL SELECT CLTCODE,CRAMOUNT=SUM(CRAMOUNT),EXCHANGE='BSEMF' FROM #EDTADJ GROUP BY CLTCODE) A
GROUP BY A.CLTCODE,A.EXCHANGE

--- TDAY LEDGER BALANCE ADJEUSTMENT
INSERT INTO #PDAY_BALANCE
SELECT CLTCODE,PDAY_BALANCE = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE FROM (
SELECT B.CLTCODE,EXCHANGE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE <> '2'
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') A
GROUP BY CLTCODE,EXCHANGE

UPDATE A1 SET MF_OPEN_BALANCE = PDAY_BALANCE FROM TDAYMFORDER A1, 
(SELECT CLTCODE,PDAY_BALANCE=SUM(PDAY_BALANCE) FROM #PDAY_BALANCE GROUP BY CLTCODE) A2 WHERE A1.PARTY_CODE = A2.CLTCODE


/* BSE MFSS RECEIPTS DETAILS */

SELECT CLTCODE,TDAY_RECEIPTS=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #TDAY_RECEIPTS FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE = '2'AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE

INSERT INTO #TDAY_RECEIPTS
SELECT CLTCODE,TDAY_RECEIPTS=CRAMOUNT,EXCHANGE='BSEMF' FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1') AND EDT='2049-12-31 00:00:00.000'

UPDATE A1 SET MF_TDAY_RECEIPTS = TDAY_RECEIPTS FROM TDAYMFORDER A1, 
(SELECT CLTCODE,TDAY_RECEIPTS=SUM(TDAY_RECEIPTS) FROM #TDAY_RECEIPTS GROUP BY CLTCODE) A2
WHERE A1.PARTY_CODE = A2.CLTCODE

---- PENDING RECEIPT ENTRIES 
UPDATE A SET MF_TDAY_RECEIPTS = MF_TDAY_RECEIPTS + VAMT FROM TDAYMFORDER A,
(SELECT CLTCODE,VAMT FROM PEDING_ENTRIES WHERE FIMPORT_DATE BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND EXCHANGE='BSEMF') B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE A SET TOTAL_FUNDS = EDT_LEDGER + MF_TDAY_RECEIPTS + MF_OPEN_BALANCE
FROM TDAYMFORDER A

UPDATE A SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER FROM TDAYMFORDER A

SELECT REPORT_DATE,PARTY_CODE,PARTY_NAME,EDT_LEDGER,VDT_LEDGER,MF_TDAY_RECEIPTS,MF_OPEN_BALANCE,COLLATERALS,
TOTAL_FUNDS,TDAY_ORDER,NET_BALANCE,[BAL AFTER ORDER EXECUTIONS] = TOTAL_FUNDS - TDAY_ORDER,
ORDER_STAUS = CASE WHEN TOTAL_FUNDS - TDAY_ORDER > = -100 THEN 'APPROVED' 
WHEN MF_TDAY_RECEIPTS+MF_OPEN_BALANCE > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END,
FILEIMPORT=RUNDATE
FROM TDAYMFORDER 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_28032022
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_28032022] (@TODATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER 'FEB 11 2022'

DECLARE @FROMDATE VARCHAR(11)
SELECT @FROMDATE =SDTCUR FROM ANAND1.ACCOUNT.DBO.PARAMETER WHERE @TODATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTY_NAME =  PNAME FROM TDAYMFORDER A, 
(SELECT PARTY_CODE,PNAME=UPPER(PARTY_NAME) FROM BSEMFSS.DBO.MFSS_CLIENT WITH (NOLOCK))B
WHERE A.PARTY_CODE = B.PARTY_CODE


/* EDT LEDGER BALANCE */

SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECM' INTO #EDTLED
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECM' 
FROM  ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECM'
FROM ANAND.ACCOUNT_AB.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECM' 
FROM  ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSEFO' 
FROM ACCOUNTFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSEFO'
FROM ACCOUNTFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSEFO' 
FROM  ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSEFO
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSEFO' 
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSEFO' 
FROM  ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NSECD' 
FROM ACCOUNTCURFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NSECD' 
FROM  ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'BSECD' 
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'BSECD' 
FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCXCD
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCXCD' 
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCXCD' 
FROM  ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MTF
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MTF' 
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MTF' 
FROM  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- SLBS
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'SLBS' 
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'SLBS' 
FROM  ANAND1.ACCOUNTSLBS.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- MCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'MCDX' 
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'MCDX' 
FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NCDX
SELECT CLTCODE, LEDBAL = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE -VAMT END ), 0) , EXCHANGE = 'NCDX' 
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH(NOLOCK) 
WHERE EDT LIKE @FROMDATE + '%' AND VTYP = 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE 
UNION ALL
SELECT CLTCODE, LEDBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END ), 0) , EXCHANGE = 'NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER B WITH (NOLOCK) 
WHERE B.VDT < @FROMDATE AND EDT >= @FROMDATE AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE
UNION ALL
SELECT CLTCODE, LEDBAL = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END) , EXCHANGE = 'NCDX' 
FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK) 	
WHERE L.EDT >= @FROMDATE + ' 00:00:00' 	AND L.EDT <= @TODATE + ' 23:59:59' AND VTYP <> 18  AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- NSECM UNRECO
SELECT CLTCODE,SUM(CASE WHEN DRCR ='D' THEN -VAMT ELSE VAMT END) AS BALANCE,EXCHANGE='NSECM'
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VTYP='2' AND VDT >= @FROMDATE AND EDT='2049-12-31 00:00:00.000' 
AND ENTEREDBY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #EDTLED --- BSECM UNRECO
SELECT CLTCODE,SUM(CASE WHEN DRCR ='D' THEN -VAMT ELSE VAMT END) AS BALANCE,EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VTYP='2' AND VDT > = @FROMDATE AND EDT='2049-12-31 00:00:00.000' 
AND ENTEREDBY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET EDT_LEDGER = EDTLEDBAL,REPORT_DATE=@TODATE FROM TDAYMFORDER A,
(SELECT CLTCODE,EDTLEDBAL=SUM(LEDBAL) FROM #EDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* VDT LEDGER BALANCE */

SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FROMDATE AND VDT <=@TODATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET VDT_LEDGER = VDTLEDBAL FROM TDAYMFORDER A,
(SELECT CLTCODE,VDTLEDBAL=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


/* COLLATERALS UPDATE */

UPDATE A SET COLLATERALS = COLL FROM TDAYMFORDER A,
(SELECT FO.PARTY_CODE,COLL=SUM(FO.NONCASH_COLL+FO.CASH_COLL)
FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK)
WHERE MARGINDATE IN (SELECT MAX(MARGINDATE) FROM NSEFO.DBO.TBL_CLIENTMARGIN FO (NOLOCK))
GROUP BY PARTY_CODE) B WHERE A.PARTY_CODE = B.party_code


/* MF OPENING BALANCE DATA */

SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #OPMF FROM (
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) LIKE @FROMDATE + '%' AND VTYPE = 18
UNION ALL 
SELECT B.CLTCODE,DRAMOUNT=B.DRAMOUNT,CRAMOUNT=-B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT)) < @FROMDATE AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT))>=@FROMDATE
UNION ALL
SELECT B.CLTCODE,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) >= @FROMDATE + ' 00:00:00' 
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) <= @TODATE-1 + ' 23:59:59' AND A.VTYPE <> 18 ) A
GROUP BY A.CLTCODE HAVING SUM(DRAMOUNT+CRAMOUNT) <> 0 

--- PREVIOUS DAY RECEIPTS ENTIRES ADJEUSTMENT
SELECT CLTCODE,ACNAME,ACCAT,VNO,DRAMOUNT,CRAMOUNT,NARRATION,VDT,EDT,RELDT=CR_RELDT,CDT=POSTED_ON,ENTER_BY=POSTED_BY INTO #EDTADJ
FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @FROMDATE AND @TODATE-1 + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') AND EDT='2049-12-31 00:00:00.000'

SELECT CLTCODE,PDAY_BALANCE=SUM(LEDBAL),EXCHANGE INTO #PDAY_BALANCE FROM (
SELECT * FROM #OPMF UNION ALL SELECT CLTCODE,CRAMOUNT=SUM(CRAMOUNT),EXCHANGE='BSEMF' FROM #EDTADJ GROUP BY CLTCODE) A
GROUP BY A.CLTCODE,A.EXCHANGE

--- TDAY LEDGER BALANCE ADJEUSTMENT
INSERT INTO #PDAY_BALANCE
SELECT CLTCODE,PDAY_BALANCE = SUM(DRAMOUNT+CRAMOUNT),EXCHANGE FROM (
SELECT B.CLTCODE,EXCHANGE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE <> '2'
AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') A
GROUP BY CLTCODE,EXCHANGE

UPDATE A1 SET MF_OPEN_BALANCE = PDAY_BALANCE FROM TDAYMFORDER A1, 
(SELECT CLTCODE,PDAY_BALANCE=SUM(PDAY_BALANCE) FROM #PDAY_BALANCE GROUP BY CLTCODE) A2 WHERE A1.PARTY_CODE = A2.CLTCODE


/* BSE MFSS RECEIPTS DETAILS */

SELECT CLTCODE,TDAY_RECEIPTS=SUM(DRAMOUNT+CRAMOUNT),EXCHANGE='BSEMF' INTO #TDAY_RECEIPTS FROM 
(SELECT B.CLTCODE,EXCHANGE,A.VTYPE,A.VNO,B.EDT,DRAMOUNT=(-B.DRAMOUNT),B.CRAMOUNT
FROM BBO_FA.DBO.ACC_TBL1 A (NOLOCK), BBO_FA.DBO.ACC_TBL3 B (NOLOCK)
WHERE A.SNO = B.MASTERSNO AND A.VTYPE = '2'AND CONVERT(DATETIME,CONVERT(VARCHAR(11),EDT)) BETWEEN @TODATE AND @TODATE + ' 23:59:59') B 
GROUP BY CLTCODE

INSERT INTO #TDAY_RECEIPTS
SELECT CLTCODE,TDAY_RECEIPTS=CRAMOUNT,EXCHANGE='BSEMF' FROM BBO_FA.DBO.ACC_LEDGER WHERE VDT BETWEEN @TODATE AND @TODATE + ' 23:59:59' 
AND VTYPE=2 AND ACCAT='4' AND POSTED_BY IN ('TPR','TPR1','B_TPR','B_Kyc','VIRTUAL','ANIMESH') AND EDT='2049-12-31 00:00:00.000'

UPDATE A1 SET MF_TDAY_RECEIPTS = TDAY_RECEIPTS FROM TDAYMFORDER A1, 
(SELECT CLTCODE,TDAY_RECEIPTS=SUM(TDAY_RECEIPTS) FROM #TDAY_RECEIPTS GROUP BY CLTCODE) A2
WHERE A1.PARTY_CODE = A2.CLTCODE

---- PENDING RECEIPT ENTRIES 
UPDATE A SET MF_TDAY_RECEIPTS = MF_TDAY_RECEIPTS + VAMT FROM TDAYMFORDER A,
(SELECT CLTCODE,VAMT FROM PEDING_ENTRIES WHERE FIMPORT_DATE BETWEEN @TODATE AND @TODATE + ' 23:59:59' AND EXCHANGE='BSEMF') B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE A SET TOTAL_FUNDS = EDT_LEDGER + MF_TDAY_RECEIPTS + MF_OPEN_BALANCE
FROM TDAYMFORDER A


/* SAME DAY ORDER UPDATE */

UPDATE A SET TDAY_ORDER = TDAY_ORDER + PDAY FROM TDAYMFORDER A,
(SELECT PARTY_CODE,PDAY=SUM(TDAY_ORDER) FROM TDAYMFORDER_LOG B1
WHERE REPORT_DATE = @TODATE AND B1.RUNDATE IN (SELECT MAX(B2.RUNDATE) 
FROM TDAYMFORDER_LOG B2 WHERE B2.REPORT_DATE = @TODATE AND B1.PARTY_CODE = B2.PARTY_CODE)
GROUP BY PARTY_CODE) B
WHERE A.PARTY_CODE = B.PARTY_CODE

UPDATE A SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER FROM TDAYMFORDER A


/* FINAL REPORT */

SELECT REPORT_DATE,PARTY_CODE,PARTY_NAME,EDT_LEDGER,VDT_LEDGER,MF_TDAY_RECEIPTS,MF_OPEN_BALANCE,COLLATERALS,
TOTAL_FUNDS,TDAY_ORDER,NET_BALANCE,[BAL AFTER ORDER EXECUTIONS] = TOTAL_FUNDS - TDAY_ORDER,
ORDER_STAUS = CASE WHEN TOTAL_FUNDS - TDAY_ORDER > = -100 THEN 'APPROVED' 
WHEN MF_TDAY_RECEIPTS+MF_OPEN_BALANCE > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END,
FILEIMPORT=RUNDATE
FROM TDAYMFORDER 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_NEW
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_NEW] (@TDATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER_NEW 'APR  4 2022'

DECLARE @FDATE VARCHAR(11)
SELECT @FDATE =SDTCUR FROM BBO_FA.DBO.PARAMETER WHERE @TDATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTYNAME = UPPER(B.PARTY_NAME),A.BRANCH = B.BRANCH_CD,A.SUBBROKER= B.SUB_BROKER
FROM TDAYMFORDER A, MFSS_CLIENT B WITH (NOLOCK) WHERE A.PARTY_CODE = B.PARTY_CODE

UPDATE TDAYMFORDER SET REPORT_DATE = @TDATE

/*
/* BROKING VDT LEDGER BALANCE  Debit (-), Credit (-) */

------NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM AngelNseCM.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---BSECM
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANGELBSECM.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---NSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----BSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----MTF
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM AngelNseCM.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----SLBS
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM AngelNseCM.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----NSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----BSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---MCXCD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----MCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----NCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET BROKING_VDT_LEDGER = VDT FROM TDAYMFORDER A,
(SELECT CLTCODE,VDT=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B WHERE A.PARTY_CODE = B.CLTCODE


/* BROKING UNSETTLED CREDIT BILLS  Debit (-), Credit (-) */

----NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #FCR
FROM AngelNseCM.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSECM
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM' 
FROM ANGELBSECM.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MTF
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'
FROM AngelNseCM.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='35' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----SLBS
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'
FROM AngelNseCM.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MCXCD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

UPDATE A SET A.UNSETTLED_CR_BILLS = FCRBILL FROM TDAYMFORDER A,
(SELECT CLTCODE,FCRBILL=SUM(NETAMT) FROM #FCR GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

*/

UPDATE TDAYMFORDER SET NET_BROKING_LEDGER =  BROKING_VDT_LEDGER - UNSETTLED_CR_BILLS



/* BSE MFSS VDT LEDGER BALANCE */
UPDATE A SET MF_VDT_LEDGER = BSEMF_VDT_BALANCE FROM TDAYMFORDER A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59' GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS TDAY RECEIPTS BALANCE */
UPDATE A SET A.MF_TDAY_RECEIPTS = BSEMF_VDT_BALANCE FROM TDAYMFORDER A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @TDATE AND @TDATE + ' 23:59'
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) AND VTYPE=2 GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS UNSETTLED CREDIT BILLS */
UPDATE A SET A.MF_UNSETTLED_CR_BILLS = CRAMOUNT FROM TDAYMFORDER A,
(SELECT CLTCODE,CRAMOUNT = SUM(CRAMOUNT) FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
AND EDT > @TDATE + ' 23:59' AND VTYPE='15' AND NARRATION NOT LIKE '%XSIP%' AND CRAMOUNT <> 0 GROUP BY CLTCODE) B 
WHERE A.PARTY_CODE = B.CLTCODE


/* BSE MFSS PENDING RECEIPTS */

UPDATE A SET MF_PENDING_RECEIPTS = CREDITAMT FROM TDAYMFORDER A, 
(SELECT CLTCODE,CREDITAMT=SUM(CREDITAMT)
FROM BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (NOLOCK)
WHERE VDATE=CONVERT(VARCHAR(11),GETDATE(),120) ----AND EDATE NOT LIKE 'DEC 31 2049%' 
AND ROWSTATE='0'  AND APPROVALFLAG ='1' AND VOUCHERTYPE ='2' AND  ADDBY IN ('TPR1','TPR') GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


UPDATE TDAYMFORDER SET MF_VDT_LEDGER = MF_VDT_LEDGER - MF_TDAY_RECEIPTS

UPDATE TDAYMFORDER SET NET_MF_LEDGER = (MF_VDT_LEDGER + MF_TDAY_RECEIPTS + MF_PENDING_RECEIPTS) - MF_UNSETTLED_CR_BILLS 

UPDATE TDAYMFORDER SET TOTAL_FUNDS = NET_BROKING_LEDGER + NET_MF_LEDGER

UPDATE TDAYMFORDER SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER

UPDATE TDAYMFORDER SET ORDER_STAUS = CASE WHEN NET_BALANCE > = -100 THEN 'APPROVED' 
WHEN NET_MF_LEDGER > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END

UPDATE A SET TDAY_ORDERS_COUNT = ORD_COUNT FROM TDAYMFORDER A,
(SELECT A.PARTY_CODE,ORD_COUNT=COUNT (A.PARTY_CODE)
FROM TDAYMFORDER_LOG A WITH (NOLOCK), TDAYMFORDER B WITH (NOLOCK)
WHERE A.REPORT_DATE = B.REPORT_DATE AND A.PARTY_CODE = B.PARTY_CODE
GROUP BY A.PARTY_CODE) B WHERE A.PARTY_CODE = B.PARTY_CODE

SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_NEW_04062022
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_NEW_04062022] (@TDATE DATETIME)

AS ----- EXEC BSEMF_COMBINE_LEDGER_NEW 'APR  4 2022'

DECLARE @FDATE VARCHAR(11)
SELECT @FDATE =SDTCUR FROM BBO_FA.DBO.PARAMETER WHERE @TDATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTYNAME = UPPER(B.PARTY_NAME),A.BRANCH = B.BRANCH_CD,A.SUBBROKER= B.SUB_BROKER
FROM TDAYMFORDER A, MFSS_CLIENT B WITH (NOLOCK) WHERE A.PARTY_CODE = B.PARTY_CODE

UPDATE TDAYMFORDER SET REPORT_DATE = @TDATE

/* BROKING VDT LEDGER BALANCE  Debit (-), Credit (-) */

------NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---BSECM
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---NSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----BSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----MTF
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----SLBS
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----NSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----BSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---MCXCD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----MCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----NCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET BROKING_VDT_LEDGER = VDT FROM TDAYMFORDER A,
(SELECT CLTCODE,VDT=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B WHERE A.PARTY_CODE = B.CLTCODE


/* BROKING UNSETTLED CREDIT BILLS  Debit (-), Credit (-) */

----NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #FCR
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSECM
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MTF
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='35' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----SLBS
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MCXCD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

UPDATE A SET A.UNSETTLED_CR_BILLS = FCRBILL FROM TDAYMFORDER A,
(SELECT CLTCODE,FCRBILL=SUM(NETAMT) FROM #FCR GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE TDAYMFORDER SET NET_BROKING_LEDGER =  BROKING_VDT_LEDGER - UNSETTLED_CR_BILLS



/* BSE MFSS VDT LEDGER BALANCE */
UPDATE A SET MF_VDT_LEDGER = BSEMF_VDT_BALANCE FROM TDAYMFORDER A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59' GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS TDAY RECEIPTS BALANCE */
UPDATE A SET A.MF_TDAY_RECEIPTS = BSEMF_VDT_BALANCE FROM TDAYMFORDER A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @TDATE AND @TDATE + ' 23:59'
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) AND VTYPE=2 GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS UNSETTLED CREDIT BILLS */
UPDATE A SET A.MF_UNSETTLED_CR_BILLS = CRAMOUNT FROM TDAYMFORDER A,
(SELECT CLTCODE,CRAMOUNT = SUM(CRAMOUNT) FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
AND EDT > @TDATE + ' 23:59' AND VTYPE='15' GROUP BY CLTCODE) B 
WHERE A.PARTY_CODE = B.CLTCODE


/* BSE MFSS PENDING RECEIPTS */

UPDATE A SET MF_PENDING_RECEIPTS = CREDITAMT FROM TDAYMFORDER A, 
(SELECT CLTCODE,CREDITAMT=SUM(CREDITAMT)
FROM BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (NOLOCK)
WHERE VDATE=CONVERT(VARCHAR(11),GETDATE(),120) ----AND EDATE NOT LIKE 'DEC 31 2049%' 
AND ROWSTATE='0'  AND APPROVALFLAG ='1' AND VOUCHERTYPE ='2' AND  ADDBY IN ('TPR1','TPR') GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


UPDATE TDAYMFORDER SET MF_VDT_LEDGER = MF_VDT_LEDGER - MF_TDAY_RECEIPTS

UPDATE TDAYMFORDER SET NET_MF_LEDGER = (MF_VDT_LEDGER + MF_TDAY_RECEIPTS + MF_PENDING_RECEIPTS) - MF_UNSETTLED_CR_BILLS 

UPDATE TDAYMFORDER SET TOTAL_FUNDS = NET_BROKING_LEDGER + NET_MF_LEDGER

UPDATE TDAYMFORDER SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER

UPDATE TDAYMFORDER SET ORDER_STAUS = CASE WHEN NET_BALANCE > = -100 THEN 'APPROVED' 
WHEN NET_MF_LEDGER > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END

UPDATE A SET TDAY_ORDERS_COUNT = ORD_COUNT FROM TDAYMFORDER A,
(SELECT A.PARTY_CODE,ORD_COUNT=COUNT (A.PARTY_CODE)
FROM TDAYMFORDER_LOG A WITH (NOLOCK), TDAYMFORDER B WITH (NOLOCK)
WHERE A.REPORT_DATE = B.REPORT_DATE AND A.PARTY_CODE = B.PARTY_CODE
GROUP BY A.PARTY_CODE) B WHERE A.PARTY_CODE = B.PARTY_CODE

SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_NEW_12042022
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_NEW_12042022] (@TDATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER_NEW 'APR  4 2022'

DECLARE @FDATE VARCHAR(11)
SELECT @FDATE =SDTCUR FROM BBO_FA.DBO.PARAMETER WHERE @TDATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTYNAME = UPPER(B.PARTY_NAME),A.BRANCH = B.BRANCH_CD,A.SUBBROKER= B.SUB_BROKER,A.REPORT_DATE=@TDATE
FROM TDAYMFORDER_NEW A, MFSS_CLIENT B WITH (NOLOCK)
WHERE A.PARTY_CODE = B.PARTY_CODE


/* BROKING VDT LEDGER BALANCE  Debit (-), Credit (-) */

------NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

---BSECM
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

---NSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----BSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----MTF
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----SLBS
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----NSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----BSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

---MCXCD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----MCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

----NCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW)
GROUP BY CLTCODE

UPDATE A SET BROKING_VDT_LEDGER = VDT FROM TDAYMFORDER_NEW A,
(SELECT CLTCODE,VDT=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE



/* BROKING UNSETTLED CREDIT BILLS  Debit (-), Credit (-) */

----NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #FCR
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----BSECM
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----NSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----BSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----MTF
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='35' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----SLBS
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----NSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----BSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----MCXCD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----MCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

----NCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) GROUP BY CLTCODE

UPDATE A SET A.UNSETTLED_CR_BILLS = FCRBILL FROM TDAYMFORDER_NEW A,
(SELECT CLTCODE,FCRBILL=SUM(NETAMT) FROM #FCR GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE TDAYMFORDER_NEW SET NET_BROKING_LEDGER =  BROKING_VDT_LEDGER - UNSETTLED_CR_BILLS



/* BSE MFSS VDT LEDGER BALANCE */
UPDATE A SET MF_VDT_LEDGER = BSEMF_VDT_BALANCE FROM TDAYMFORDER_NEW A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59' GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS TDAY RECEIPTS BALANCE */
UPDATE A SET A.MF_TDAY_RECEIPTS = BSEMF_VDT_BALANCE FROM TDAYMFORDER_NEW A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @TDATE AND @TDATE + ' 23:59'
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW) AND VTYPE=2 GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS UNSETTLED CREDIT BILLS */
UPDATE A SET A.MF_UNSETTLED_CR_BILLS = CRAMOUNT FROM TDAYMFORDER_NEW A,
(SELECT CLTCODE,CRAMOUNT = SUM(CRAMOUNT) FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
AND EDT > @TDATE + ' 23:59' AND VTYPE='15' GROUP BY CLTCODE) B 
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE TDAYMFORDER_NEW SET MF_VDT_LEDGER = MF_VDT_LEDGER - MF_TDAY_RECEIPTS

UPDATE TDAYMFORDER_NEW SET NET_MF_LEDGER = (MF_VDT_LEDGER + MF_TDAY_RECEIPTS) - MF_UNSETTLED_CR_BILLS 

UPDATE TDAYMFORDER_NEW SET TOTAL_FUNDS = NET_BROKING_LEDGER + NET_MF_LEDGER

UPDATE TDAYMFORDER_NEW SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER

UPDATE TDAYMFORDER_NEW SET ORDER_STAUS = CASE WHEN NET_BALANCE > = -100 THEN 'APPROVED' 
WHEN NET_MF_LEDGER > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END

SELECT * FROM TDAYMFORDER_NEW ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_NEW_13042022
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_NEW_13042022] (@TDATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER_NEW 'APR  4 2022'

DECLARE @FDATE VARCHAR(11)
SELECT @FDATE =SDTCUR FROM BBO_FA.DBO.PARAMETER WHERE @TDATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTYNAME = UPPER(B.PARTY_NAME),A.BRANCH = B.BRANCH_CD,A.SUBBROKER= B.SUB_BROKER,A.REPORT_DATE=@TDATE
FROM TDAYMFORDER_NEW_TEMP A, MFSS_CLIENT B WITH (NOLOCK)
WHERE A.PARTY_CODE = B.PARTY_CODE


/* BROKING VDT LEDGER BALANCE  Debit (-), Credit (-) */

------NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

---BSECM
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

---NSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----BSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----MTF
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----SLBS
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----NSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----BSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

---MCXCD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----MCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

----NCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP)
GROUP BY CLTCODE

UPDATE A SET BROKING_VDT_LEDGER = VDT FROM TDAYMFORDER_NEW_TEMP A,
(SELECT CLTCODE,VDT=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE



/* BROKING UNSETTLED CREDIT BILLS  Debit (-), Credit (-) */

----NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #FCR
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----BSECM
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----NSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----BSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----MTF
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='35' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----SLBS
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----NSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----BSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----MCXCD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----MCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

----NCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) GROUP BY CLTCODE

UPDATE A SET A.UNSETTLED_CR_BILLS = FCRBILL FROM TDAYMFORDER_NEW_TEMP A,
(SELECT CLTCODE,FCRBILL=SUM(NETAMT) FROM #FCR GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE TDAYMFORDER_NEW_TEMP SET NET_BROKING_LEDGER =  BROKING_VDT_LEDGER - UNSETTLED_CR_BILLS



/* BSE MFSS VDT LEDGER BALANCE */
UPDATE A SET MF_VDT_LEDGER = BSEMF_VDT_BALANCE FROM TDAYMFORDER_NEW_TEMP A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59' GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS TDAY RECEIPTS BALANCE */
UPDATE A SET A.MF_TDAY_RECEIPTS = BSEMF_VDT_BALANCE FROM TDAYMFORDER_NEW_TEMP A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @TDATE AND @TDATE + ' 23:59'
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER_NEW_TEMP) AND VTYPE=2 GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS UNSETTLED CREDIT BILLS */
UPDATE A SET A.MF_UNSETTLED_CR_BILLS = CRAMOUNT FROM TDAYMFORDER_NEW_TEMP A,
(SELECT CLTCODE,CRAMOUNT = SUM(CRAMOUNT) FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
AND EDT > @TDATE + ' 23:59' AND VTYPE='15' GROUP BY CLTCODE) B 
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS PENDING RECEIPTS */

UPDATE A SET MF_PENDING_RECEIPTS = CREDITAMT FROM TDAYMFORDER_NEW_TEMP A, 
(SELECT CLTCODE,CREDITAMT=SUM(CREDITAMT)
FROM BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (NOLOCK)
WHERE VDATE=CONVERT(VARCHAR(11),GETDATE(),120) AND EDATE NOT LIKE 'DEC 31 2049%' 
AND ROWSTATE='0'  AND APPROVALFLAG ='1' AND VOUCHERTYPE ='2' AND  ADDBY IN ('TPR1','TPR') GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE TDAYMFORDER_NEW_TEMP SET MF_VDT_LEDGER = MF_VDT_LEDGER - MF_TDAY_RECEIPTS

UPDATE TDAYMFORDER_NEW_TEMP SET NET_MF_LEDGER = (MF_VDT_LEDGER + MF_TDAY_RECEIPTS + MF_PENDING_RECEIPTS) - MF_UNSETTLED_CR_BILLS 

UPDATE TDAYMFORDER_NEW_TEMP SET TOTAL_FUNDS = NET_BROKING_LEDGER + NET_MF_LEDGER

UPDATE TDAYMFORDER_NEW_TEMP SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER

UPDATE TDAYMFORDER_NEW_TEMP SET ORDER_STAUS = CASE WHEN NET_BALANCE > = -100 THEN 'APPROVED' 
WHEN NET_MF_LEDGER > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END

SELECT * FROM TDAYMFORDER_NEW_TEMP ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_COMBINE_LEDGER_NEW_29062022
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[BSEMF_COMBINE_LEDGER_NEW_29062022] (@TDATE DATETIME)

AS ---- EXEC BSEMF_COMBINE_LEDGER_NEW 'APR  4 2022'

DECLARE @FDATE VARCHAR(11)
SELECT @FDATE =SDTCUR FROM BBO_FA.DBO.PARAMETER WHERE @TDATE BETWEEN SDTCUR AND LDTCUR

UPDATE A SET PARTYNAME = UPPER(B.PARTY_NAME),A.BRANCH = B.BRANCH_CD,A.SUBBROKER= B.SUB_BROKER
FROM TDAYMFORDER A, MFSS_CLIENT B WITH (NOLOCK) WHERE A.PARTY_CODE = B.PARTY_CODE

UPDATE TDAYMFORDER SET REPORT_DATE = @TDATE

/* BROKING VDT LEDGER BALANCE  Debit (-), Credit (-) */

------NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #VDTLED                  
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---BSECM
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM'                  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---NSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'                  
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----BSEFO
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'                  
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----MTF
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'                  
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----SLBS
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'                  
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----NSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'                  
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----BSECD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'                  
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

---MCXCD
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'                  
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----MCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'                  
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

----NCDX
INSERT INTO #VDTLED
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'                  
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' 
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER)
GROUP BY CLTCODE

UPDATE A SET BROKING_VDT_LEDGER = VDT FROM TDAYMFORDER A,
(SELECT CLTCODE,VDT=SUM(NETAMT) FROM #VDTLED GROUP BY CLTCODE) B WHERE A.PARTY_CODE = B.CLTCODE


/* BROKING UNSETTLED CREDIT BILLS  Debit (-), Credit (-) */

----NSECM
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECM' INTO #FCR
FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSECM
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECM' 
FROM ANAND.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSEFO'
FROM ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSEFO
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSEFO'
FROM ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MTF
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MTF'
FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='35' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----SLBS
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='SLBS'
FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NSECD'
FROM ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----BSECD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='BSECD'
FROM ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MCXCD
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCXCD'
FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----MCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='MCDX'
FROM ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

----NCDX
INSERT INTO #FCR
SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),EXCHANGE='NCDX'
FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >=@FDATE AND VDT <=@TDATE  + ' 23:59' AND EDT > @TDATE + ' 23:59'
AND DRCR='C' AND VTYP='15' AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) GROUP BY CLTCODE

UPDATE A SET A.UNSETTLED_CR_BILLS = FCRBILL FROM TDAYMFORDER A,
(SELECT CLTCODE,FCRBILL=SUM(NETAMT) FROM #FCR GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

UPDATE TDAYMFORDER SET NET_BROKING_LEDGER =  BROKING_VDT_LEDGER - UNSETTLED_CR_BILLS



/* BSE MFSS VDT LEDGER BALANCE */
UPDATE A SET MF_VDT_LEDGER = BSEMF_VDT_BALANCE FROM TDAYMFORDER A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59' GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS TDAY RECEIPTS BALANCE */
UPDATE A SET A.MF_TDAY_RECEIPTS = BSEMF_VDT_BALANCE FROM TDAYMFORDER A,
(SELECT CLTCODE,BSEMF_VDT_BALANCE=SUM((-DRAMOUNT) + CRAMOUNT)
FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @TDATE AND @TDATE + ' 23:59'
AND CLTCODE IN (SELECT PARTY_CODE FROM TDAYMFORDER) AND VTYPE=2 GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE

/* BSE MFSS UNSETTLED CREDIT BILLS */
UPDATE A SET A.MF_UNSETTLED_CR_BILLS = CRAMOUNT FROM TDAYMFORDER A,
(SELECT CLTCODE,CRAMOUNT = SUM(CRAMOUNT) FROM BBO_FA.DBO.MFSS_LEDGER_BSE WITH (NOLOCK) WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
AND EDT > @TDATE + ' 23:59' AND VTYPE='15' AND NARRATION NOT LIKE '%XSIP%' AND CRAMOUNT <> 0 GROUP BY CLTCODE) B 
WHERE A.PARTY_CODE = B.CLTCODE


/* BSE MFSS PENDING RECEIPTS */

UPDATE A SET MF_PENDING_RECEIPTS = CREDITAMT FROM TDAYMFORDER A, 
(SELECT CLTCODE,CREDITAMT=SUM(CREDITAMT)
FROM BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (NOLOCK)
WHERE VDATE=CONVERT(VARCHAR(11),GETDATE(),120) ----AND EDATE NOT LIKE 'DEC 31 2049%' 
AND ROWSTATE='0'  AND APPROVALFLAG ='1' AND VOUCHERTYPE ='2' AND  ADDBY IN ('TPR1','TPR') GROUP BY CLTCODE) B
WHERE A.PARTY_CODE = B.CLTCODE


UPDATE TDAYMFORDER SET MF_VDT_LEDGER = MF_VDT_LEDGER - MF_TDAY_RECEIPTS

UPDATE TDAYMFORDER SET NET_MF_LEDGER = (MF_VDT_LEDGER + MF_TDAY_RECEIPTS + MF_PENDING_RECEIPTS) - MF_UNSETTLED_CR_BILLS 

UPDATE TDAYMFORDER SET TOTAL_FUNDS = NET_BROKING_LEDGER + NET_MF_LEDGER

UPDATE TDAYMFORDER SET NET_BALANCE = TOTAL_FUNDS - TDAY_ORDER

UPDATE TDAYMFORDER SET ORDER_STAUS = CASE WHEN NET_BALANCE > = -100 THEN 'APPROVED' 
WHEN NET_MF_LEDGER > = TDAY_ORDER THEN 'APPROVED' ELSE 'REJECT' END

UPDATE A SET TDAY_ORDERS_COUNT = ORD_COUNT FROM TDAYMFORDER A,
(SELECT A.PARTY_CODE,ORD_COUNT=COUNT (A.PARTY_CODE)
FROM TDAYMFORDER_LOG A WITH (NOLOCK), TDAYMFORDER B WITH (NOLOCK)
WHERE A.REPORT_DATE = B.REPORT_DATE AND A.PARTY_CODE = B.PARTY_CODE
GROUP BY A.PARTY_CODE) B WHERE A.PARTY_CODE = B.PARTY_CODE

SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_ORDER_FILE_IMPORT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[BSEMF_ORDER_FILE_IMPORT] (@PATH VARCHAR(1000))

AS --- EXEC BSEMF_ORDER_FILE_IMPORT 'BSEMF_18082021.CSV'

DECLARE @NSECMJV NVARCHAR(4000) = 'BSEMFSS.DBO.BSEMF_ORDER_TDAY'

DECLARE @NSECMBCP VARCHAR(4000) = 'BCP "' + @NSECMJV + '" IN "F:\BACKOFFICE\IMPORT\' + @PATH + '" -c -t"," -r"\n" -T'

INSERT INTO TDAYMFORDER_LOG
SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

TRUNCATE TABLE BSEMF_ORDER_TDAY
TRUNCATE TABLE TDAYMFORDER

EXEC MASTER..XP_CMDSHELL @NSECMBCP, NO_OUTPUT

INSERT INTO TDAYMFORDER
SELECT PARTY_CODE,'','','',0,0,0,0,0,0,0,0,0,ORDAMT,0,'','','',GETDATE() FROM BSEMF_ORDER_TDAY WHERE PARTY_CODE NOT IN ('','CLIENT CODE')

---OLD FILE DELETE
DECLARE @N AS VARCHAR(2) = '1'
DECLARE @DPATH AS VARCHAR(200) =  'F:\BACKOFFICE\IMPORT'
DECLARE @DELETESQL AS VARCHAR(512)
  
SET @deleteSql = 'forfiles /P "' + @Dpath + '" /S /M *.* /D -' + @N + ' /C "cmd /c del @PATH"'

EXEC master.dbo.xp_cmdshell @deleteSql, NO_OUTPUT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_ORDER_FILE_IMPORT_04042022
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BSEMF_ORDER_FILE_IMPORT_04042022] (@PATH VARCHAR(1000))

AS --- EXEC BSEMF_ORDER_FILE_IMPORT 'BSEMF_18082021.CSV'

DECLARE @NSECMJV NVARCHAR(4000) = 'BSEMFSS.DBO.BSEMF_ORDER_TDAY'

DECLARE @NSECMBCP VARCHAR(4000) = 'BCP "' + @NSECMJV + '" IN "F:\BACKOFFICE\IMPORT\' + @PATH + '" -c -t"," -r"\n" -T'

INSERT INTO TDAYMFORDER_LOG
SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

TRUNCATE TABLE BSEMF_ORDER_TDAY
TRUNCATE TABLE TDAYMFORDER

EXEC MASTER..XP_CMDSHELL @NSECMBCP, NO_OUTPUT

INSERT INTO TDAYMFORDER
SELECT PARTY_CODE,'',0,0,0,0,0,0,ORDAMT,0,'',GETDATE() FROM BSEMF_ORDER_TDAY WHERE PARTY_CODE NOT IN ('','CLIENT CODE')

---OLD FILE DELETE
DECLARE @N AS VARCHAR(2) = '1'
DECLARE @DPATH AS VARCHAR(200) =  'F:\BACKOFFICE\IMPORT'
DECLARE @DELETESQL AS VARCHAR(512)
  
SET @deleteSql = 'forfiles /P "' + @Dpath + '" /S /M *.* /D -' + @N + ' /C "cmd /c del @PATH"'

EXEC master.dbo.xp_cmdshell @deleteSql, NO_OUTPUT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_ORDER_FILE_IMPORT_11022022
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BSEMF_ORDER_FILE_IMPORT_11022022] (@PATH VARCHAR(1000))

AS --- EXEC BSEMF_ORDER_FILE_IMPORT 'BSEMF_18082021.CSV'

DECLARE @NSECMJV NVARCHAR(4000) = 'BSEMFSS.DBO.BSEMF_ORDER_TDAY'

DECLARE @NSECMBCP VARCHAR(4000) = 'BCP "' + @NSECMJV + '" IN "F:\BACKOFFICE\IMPORT\' + @PATH + '" -c -t"," -r"\n" -T'

INSERT INTO TDAYMFORDER_LOG
SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

TRUNCATE TABLE BSEMF_ORDER_TDAY
TRUNCATE TABLE TDAYMFORDER

EXEC MASTER..XP_CMDSHELL @NSECMBCP, NO_OUTPUT

INSERT INTO TDAYMFORDER
SELECT PARTY_CODE,'',0,0,0,0,0,0,ORDAMT,0,'',GETDATE() FROM BSEMF_ORDER_TDAY WHERE PARTY_CODE NOT IN ('','CLIENT CODE')

---OLD FILE DELETE
DECLARE @N AS VARCHAR(2) = '1'
DECLARE @DPATH AS VARCHAR(200) =  'F:\BACKOFFICE\IMPORT'
DECLARE @DELETESQL AS VARCHAR(512)
  
SET @deleteSql = 'forfiles /P "' + @Dpath + '" /S /M *.* /D -' + @N + ' /C "cmd /c del @PATH"'

EXEC master.dbo.xp_cmdshell @deleteSql, NO_OUTPUT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_ORDER_FILE_IMPORT_12042022
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BSEMF_ORDER_FILE_IMPORT_12042022] (@PATH VARCHAR(1000))

AS --- EXEC BSEMF_ORDER_FILE_IMPORT 'BSEMF_18082021.CSV'

DECLARE @NSECMJV NVARCHAR(4000) = 'BSEMFSS.DBO.BSEMF_ORDER_TDAY'

DECLARE @NSECMBCP VARCHAR(4000) = 'BCP "' + @NSECMJV + '" IN "F:\BACKOFFICE\IMPORT\' + @PATH + '" -c -t"," -r"\n" -T'

INSERT INTO TDAYMFORDER_LOG
SELECT * FROM TDAYMFORDER ORDER BY PARTY_CODE

INSERT INTO TDAYMFORDER_NEW_LOG
SELECT * FROM TDAYMFORDER_NEW ORDER BY PARTY_CODE

TRUNCATE TABLE BSEMF_ORDER_TDAY
TRUNCATE TABLE TDAYMFORDER
TRUNCATE TABLE TDAYMFORDER_NEW

EXEC MASTER..XP_CMDSHELL @NSECMBCP, NO_OUTPUT

INSERT INTO TDAYMFORDER
SELECT PARTY_CODE,'',0,0,0,0,0,0,ORDAMT,0,'',GETDATE() FROM BSEMF_ORDER_TDAY WHERE PARTY_CODE NOT IN ('','CLIENT CODE')

INSERT INTO TDAYMFORDER_NEW
SELECT PARTY_CODE,'','','',0,0,0,0,0,0,0,0,ORDAMT,0,'','',GETDATE() FROM BSEMF_ORDER_TDAY WHERE PARTY_CODE NOT IN ('','CLIENT CODE')

---OLD FILE DELETE
DECLARE @N AS VARCHAR(2) = '1'
DECLARE @DPATH AS VARCHAR(200) =  'F:\BACKOFFICE\IMPORT'
DECLARE @DELETESQL AS VARCHAR(512)
  
SET @deleteSql = 'forfiles /P "' + @Dpath + '" /S /M *.* /D -' + @N + ' /C "cmd /c del @PATH"'

EXEC master.dbo.xp_cmdshell @deleteSql, NO_OUTPUT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMF_PENDING_FILE_IMPORT
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BSEMF_PENDING_FILE_IMPORT] (@PATH VARCHAR(1000)) 

AS ---- EXEC BSEMF_PENDING_FILE_IMPORT 'PENDING_25102021.csv'

TRUNCATE TABLE PEDING_ENTRIES_TEMP

DECLARE @NSECMJV NVARCHAR(4000) = 'BSEMFSS.DBO.PEDING_ENTRIES_TEMP'

DECLARE @NSECMBCP VARCHAR(4000) = 'BCP "' + @NSECMJV + '" IN "F:\BACKOFFICE\IMPORT\' + @PATH + '" -c -t"," -r"\n" -T'

EXEC MASTER..XP_CMDSHELL @NSECMBCP, NO_OUTPUT

INSERT INTO PEDING_ENTRIES_LOG
SELECT *,GETDATE() FROM PEDING_ENTRIES 

TRUNCATE TABLE PEDING_ENTRIES

INSERT INTO PEDING_ENTRIES
SELECT LEFT(GETDATE(),11),* FROM PEDING_ENTRIES_TEMP WHERE EXCHANGE='BSEMF'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_DUPRECCHECK
-- --------------------------------------------------
  
CREATE PROC [dbo].[BSEMFSS_DUPRECCHECK] (@SAUDA_DATE VARCHAR(11))    
AS    
    
IF (SELECT ISNULL(COUNT(1), 0) FROM MFSS_ORDER_TMP WHERE CONF_FLAG <> '' ) > 0     
BEGIN    
 UPDATE MFSS_ORDER SET CONF_FLAG = M.CONF_FLAG,    
        REJECT_REASON = M.REJECT_REASON    
 FROM MFSS_ORDER_TMP M    
 WHERE M.ORDER_DATE = @SAUDA_DATE    
 AND M.ORDER_NO = MFSS_ORDER.ORDER_NO    
 AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD      
END  
  
INSERT INTO MFSS_SETTLEMENT_LOG   
SELECT * FROM MFSS_SETTLEMENT  
WHERE MFSS_SETTLEMENT.ORDER_DATE = @SAUDA_DATE    
 AND ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_TMP     
      WHERE MFSS_ORDER_TMP.ORDER_DATE = @SAUDA_DATE    
      AND MFSS_SETTLEMENT.ORDER_NO = MFSS_ORDER_TMP.ORDER_NO    
      AND MFSS_SETTLEMENT.SCRIP_CD = MFSS_ORDER_TMP.SCRIP_CD  
      AND MFSS_ORDER_TMP.CONF_FLAG = 'INVALID'  
      AND MFSS_ORDER_TMP.REJECT_REASON <> 'PROVISIONAL ORDER')  
  
DELETE FROM MFSS_SETTLEMENT  
WHERE MFSS_SETTLEMENT.ORDER_DATE = @SAUDA_DATE    
 AND ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_TMP     
      WHERE MFSS_ORDER_TMP.ORDER_DATE = @SAUDA_DATE    
      AND MFSS_SETTLEMENT.ORDER_NO = MFSS_ORDER_TMP.ORDER_NO    
      AND MFSS_SETTLEMENT.SCRIP_CD = MFSS_ORDER_TMP.SCRIP_CD  
      AND MFSS_ORDER_TMP.CONF_FLAG = 'INVALID'  
      AND MFSS_ORDER_TMP.REJECT_REASON <> 'PROVISIONAL ORDER')  
        
INSERT INTO MFSS_ORDER    
SELECT MEMBERCODE,ORDER_DATE,ORDER_TIME,ORDER_NO,SETT_NO,PARTY_CODE,PARTY_NAME,SCRIP_CD,SCHEME_NAME,
ISIN,SUB_RED_FLAG,AMOUNT,QTY,ALLOTMENT_MODE,DPCLT,FOLIONO,User_Id,CONF_FLAG,REJECT_REASON,
NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,INT_REF_NO,SETTLEMENT_TYPE,ORDER_TYPE,SIP_REGN_NO,
SIP_REGN_DATE,FIRST_ORDER_FLAG,PUR_REDEEM_STATUS,MEMBER_REMARKS,KYC_FLAG,MIN_REDEEM_FLAG,
SUB_BROKER_ARN,SUBBRCODE,EUIN,EUIN_DECL,ALL_Units_Flag,ORD_DPC_FLAG,ORD_SUB_TYPE
FROM MFSS_ORDER_TMP M    
WHERE M.ORDER_DATE = @SAUDA_DATE    
AND ORDER_NO NOT IN (SELECT ORDER_NO FROM MFSS_ORDER     
      WHERE MFSS_ORDER.ORDER_DATE = @SAUDA_DATE    
      AND M.ORDER_NO = MFSS_ORDER.ORDER_NO    
      AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_DUPRECCHECK_17072017
-- --------------------------------------------------
  
create PROC [dbo].[BSEMFSS_DUPRECCHECK_17072017] (@SAUDA_DATE VARCHAR(11))    
AS    
    
IF (SELECT ISNULL(COUNT(1), 0) FROM MFSS_ORDER_TMP WHERE CONF_FLAG <> '' ) > 0     
BEGIN    
 UPDATE MFSS_ORDER SET CONF_FLAG = M.CONF_FLAG,    
        REJECT_REASON = M.REJECT_REASON    
 FROM MFSS_ORDER_TMP M    
 WHERE M.ORDER_DATE = @SAUDA_DATE    
 AND M.ORDER_NO = MFSS_ORDER.ORDER_NO    
 AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD      
END  
  
INSERT INTO MFSS_SETTLEMENT_LOG   
SELECT * FROM MFSS_SETTLEMENT  
WHERE MFSS_SETTLEMENT.ORDER_DATE = @SAUDA_DATE    
 AND ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_TMP     
      WHERE MFSS_ORDER_TMP.ORDER_DATE = @SAUDA_DATE    
      AND MFSS_SETTLEMENT.ORDER_NO = MFSS_ORDER_TMP.ORDER_NO    
      AND MFSS_SETTLEMENT.SCRIP_CD = MFSS_ORDER_TMP.SCRIP_CD  
      AND MFSS_ORDER_TMP.CONF_FLAG = 'INVALID'  
      AND MFSS_ORDER_TMP.REJECT_REASON <> 'PROVISIONAL ORDER')  
  
DELETE FROM MFSS_SETTLEMENT  
WHERE MFSS_SETTLEMENT.ORDER_DATE = @SAUDA_DATE    
 AND ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_TMP     
      WHERE MFSS_ORDER_TMP.ORDER_DATE = @SAUDA_DATE    
      AND MFSS_SETTLEMENT.ORDER_NO = MFSS_ORDER_TMP.ORDER_NO    
      AND MFSS_SETTLEMENT.SCRIP_CD = MFSS_ORDER_TMP.SCRIP_CD  
      AND MFSS_ORDER_TMP.CONF_FLAG = 'INVALID'  
      AND MFSS_ORDER_TMP.REJECT_REASON <> 'PROVISIONAL ORDER')  
        
INSERT INTO MFSS_ORDER    
SELECT MEMBERCODE,ORDER_DATE,ORDER_TIME,ORDER_NO,SETT_NO,PARTY_CODE,  
    PARTY_NAME,SCRIP_CD,SCHEME_NAME,ISIN,SUB_RED_FLAG,AMOUNT,QTY,  
    ALLOTMENT_MODE,DPCLT,FOLIONO,USER_ID,CONF_FLAG,  
    REJECT_REASON,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,INT_REF_NO,SETTLEMENT_TYPE,ORDER_TYPE,SIP_REGN_NO,SIP_REGN_DATE  
FROM MFSS_ORDER_TMP M    
WHERE M.ORDER_DATE = @SAUDA_DATE    
AND ORDER_NO NOT IN (SELECT ORDER_NO FROM MFSS_ORDER     
      WHERE MFSS_ORDER.ORDER_DATE = @SAUDA_DATE    
      AND M.ORDER_NO = MFSS_ORDER.ORDER_NO    
      AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_DUPRECSETTCHECK
-- --------------------------------------------------
 
CREATE PROC [dbo].[BSEMFSS_DUPRECSETTCHECK] (@SAUDA_DATE VARCHAR(11))    
AS    
    
IF (SELECT ISNULL(COUNT(1), 0) FROM MFSS_ORDER_TMP     
 WHERE ORDER_DATE = @SAUDA_DATE    
 AND CONF_FLAG = 'VALID' AND REJECT_REASON <> 'PROVISIONAL ORDER' ) > 0     
BEGIN    
 INSERT INTO MFSS_TRADE    
 SELECT MEMBERCODE,ORDER_DATE,ORDER_TIME,ORDER_NO,SETT_NO,SETT_TYPE=SETTLEMENT_TYPE,  
  PARTY_CODE,PARTY_NAME,SCRIP_CD,SCHEME_NAME,ISIN,SUB_RED_FLAG,  
  SETTFLAG = (CASE WHEN SUB_RED_FLAG = 'P' THEN 4 ELSE 5 END),  
  AMOUNT,QTY,ALLOTMENT_MODE,DPCLT,FOLIONO,USER_ID,CONF_FLAG,REJECT_REASON,  
  FILLER1 = '', FILLER2 = '', FILLER3 = ''  
 FROM MFSS_ORDER M    
 WHERE M.ORDER_DATE = @SAUDA_DATE    
 AND CONF_FLAG = 'VALID'   
 AND ORDER_NO NOT IN (SELECT ORDER_NO FROM MFSS_TRADE     
       WHERE MFSS_TRADE.ORDER_DATE = @SAUDA_DATE    
       AND M.ORDER_NO = MFSS_TRADE.ORDER_NO    
       AND M.SCRIP_CD = MFSS_TRADE.SCRIP_CD)    
 AND SETTLEMENT_TYPE <> '' AND SETT_NO <> ''
END    
    
DELETE FROM MFSS_TRADE    
WHERE ORDER_DATE = @SAUDA_DATE    
AND ORDER_NO IN (SELECT ORDER_NO FROM MFSS_SETTLEMENT M    
       WHERE M.ORDER_DATE = @SAUDA_DATE    
       AND M.ORDER_NO = MFSS_TRADE.ORDER_NO    
       AND M.SCRIP_CD = MFSS_TRADE.SCRIP_CD)    
/*    
UPDATE MFSS_TRADE SET SETT_NO = S.SETT_NO, SETT_TYPE = S.SETT_TYPE    
FROM SETT_MST S    
WHERE S.START_DATE LIKE @SAUDA_DATE + '%'  
AND   MFSS_TRADE.SETT_NO = ''
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_FILEUPLOAD
-- --------------------------------------------------








CREATE PROC [dbo].[BSEMFSS_FILEUPLOAD]  
(  
 @SNO   NUMERIC(18,0),  
 @BUSINESS_DATE VARCHAR(11),  
 @FILENAME  VARCHAR(200),  
 @FILEFOR  VARCHAR(200),  
 @UNAME   VARCHAR(50)  
)  
  
AS  
DECLARE @SQL VARCHAR(MAX)  

DECLARE @SETT_NO VARCHAR(7),  
  @SETT_TYPE VARCHAR(2),  
  @SETTCUR CURSOR,  
  @STATUS  VARCHAR(MAX),  
  @VNO  BIGINT,  
  @TDATE	VARCHAR(10)	

SELECT @TDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)

IF @FILEFOR = 'SCHEME_MASTER'  
BEGIN      
 TRUNCATE TABLE MFSS_SCRIP_MASTER_TMP       
         
 SET @SQL = LOWER('BULK INSERT MFSS_SCRIP_MASTER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'', firstrow=2)')       
 EXEC (@SQL)         
      
 UPDATE MFSS_SCRIP_MASTER_TMP SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')      
       
 DELETE FROM MFSS_SCRIP_MASTER WHERE SCRIP_CD IN ( SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER_TMP      
 Where MFSS_SCRIP_MASTER.SCRIP_CD = MFSS_SCRIP_MASTER_TMP.SCRIP_CD)      
         
INSERT INTO MFSS_SCRIP_MASTER  
(  
 TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,  
 PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,  
 RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,  
 DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,  
 SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1  
)  
SELECT   
 TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,  
 PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,  
 RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,  
 DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,  
 SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1  
FROM MFSS_SCRIP_MASTER_TMP  
     
 UPDATE MFSS_SCRIP_MASTER SET CATEGORYCODE = '' WHERE CATEGORYCODE IS NULL        
END  
  
IF @FILEFOR = 'SETT_MASTER'  
BEGIN  
 TRUNCATE TABLE Sett_MstTemp   
  
 SET @SQL = 'SELECT Sett_Type,Sett_No,Start_Date,Sec_Payin,Funds_Payin,Funds_Payout,Sec_Payout,FILLER=CONVERT(VARCHAR(10),'''') INTO #SETTMST_TEMP FROM Sett_MstTemp  '  
 SET @SQL = @SQL + LOWER('BULK INSERT #SETTMST_TEMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')   
 SET @SQL = @SQL + ' INSERT INTO Sett_MstTemp SELECT Exchange=''BSE'',Sett_Type,Sett_No,Start_Date,Start_Date + '' 23:59:59'',Funds_Payin,Funds_Payout+ '' 23:59:59'',Sec_Payin,Sec_Payout+ '' 23:59:59'' FROM #SETTMST_TEMP '  
 EXEC (@SQL)     
  
    select Sett_No, Sett_Type INTO #DATA From Sett_MstTemp   
    Group by Sett_No, Sett_Type   
    Having Count(1) > 1  
  
 IF (SELECT ISNULL(COUNT(1),0) FROM #DATA)> 0   
 BEGIN  
    UPDATE TBL_AUTO_PROCESS_DETAIL SET              
    PROCESS_HALTED_REASON = 'File is having some duplicate record. Please check the file and reimport.',              
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),              
    PROCESS_OUTPUT_QUERY = 'select Sett_No, Sett_Type From Sett_MstTemp Group by Sett_No, Sett_Type Having Count(1) > 1',    
    PROCESS_STATUS_ALERT_COUNT = 0              
    WHERE SNO = @SNO AND PROCESS_STATUS = 99   
   
    RETURN  
 END  
  
 Delete From Sett_Mst Where Sett_No In (Select Sett_No From Sett_MstTemp Where Sett_Mst.Sett_No = Sett_MstTemp.Sett_No And Sett_Mst.Sett_Type = Sett_MstTemp.Sett_Type )  
   
 Insert Into Sett_Mst  
 Select * From Sett_MstTemp  
  
END  
  
  
IF @FILEFOR = 'NAV_MASTER'  
BEGIN  
 DELETE FROM MFSS_NAV  
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'  
  
 SET @SQL = 'SELECT *,FILLER1=CONVERT(VARCHAR(10),'''') INTO #NAV FROM MFSS_NAV WHERE 1 = 2 '  
 SET @SQL = @SQL + LOWER('BULK INSERT #NAV FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')   
 SET @SQL = @SQL + ' INSERT INTO MFSS_NAV SELECT NAV_DATE + '' 23:59:59'',SCRIP_CD,SCHEME_NAME,RTA_SCHEME_CODE,DIV_REINVEST_FLAG,ISIN,NAV_VALUE,RTA_CODE FROM #NAV '  
 EXEC (@SQL)     
  
 UPDATE MFSS_NAV SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')  
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'  
END  

if @FILEFOR = 'XSIPMASTER'
BEGIN
	DELETE FROM FILEDATA WHERE PROGID = @@SPID  
	SELECT FILE_DATA INTO #XSIPMASTER FROM FILEDATA
	WHERE 1 = 2

	SET @SQL = lower('BULK INSERT #XSIPMASTER FROM ''' + @FILENAME  + '''  WITH ( ROWTERMINATOR = ''\n'')')
	EXEC(@SQL)    
	
	INSERT INTO FILEDATA
	SELECT @@SPID, FILE_DATA, GETDATE(), 'AUTOPROCESS' FROM #XSIPMASTER
	
	EXEC PROC_XSIP_REGN_MASTER @TDATE, '', '', @@spid, 'AUTOPROCESS', @FILENAME
END
  
IF @FILEFOR = 'ORDER_FILE'  
BEGIN    
 CREATE TABLE [dbo].[#MFSS_ORDER_TMP]  
(     
	[MEMBERCODE] VARCHAR(10), 
	[ORDER_DATE] VARCHAR(10), 
	[ORDER_TIME] VARCHAR(10), 
	[ORDER_NO] VARCHAR(16), 
	[SETT_NO] VARCHAR(100), 
	[PARTY_CODE] VARCHAR(100), 
	[PARTY_NAME] VARCHAR(100), 
	[SCRIP_CD] VARCHAR(500), 
	[SCHEME_NAME] VARCHAR(200), 
	[ISIN] VARCHAR(12), 
	[SUB_RED_FLAG] VARCHAR(100), 
	[AMOUNT] VARCHAR(100), 
	[QTY] VARCHAR(100), 
	[ALLOTMENT_MODE] VARCHAR(100), 
	[DPCLT] VARCHAR(16), 
	[FOLIONO] VARCHAR(16), 
	[User_ID] VARCHAR(20)  NULL, 
	[CONF_FLAG] VARCHAR(100)  NULL, 
	[REJECT_REASON] VARCHAR(200)  NULL, 
	[INT_REF_NO] VARCHAR(20)  NULL, 
	[SETTLEMENT_TYPE] VARCHAR(200)  NULL, 
	[ORDER_TYPE] VARCHAR(3)  NULL, 
	[SIP_REGN_NO] VARCHAR(100)   NULL, 
	[SIP_REGN_DATE] VARCHAR(10)  NULL, 
	[SUBBRCODE] VARCHAR(50)  NULL, 
	[EUIN] VARCHAR(10)  NULL, 
	[EUIN_DECL]		VARCHAR(1)  NULL, 
	[ALL_Units_Flag] VARCHAR(1)  NULL, 
	[ORD_DPC_FLAG] VARCHAR(1)  NULL, 
	[ORD_SUB_TYPE] VARCHAR(10)  NULL,
	FIRST_ORDER_FLAG	VARCHAR(1)  NULL,
    PUR_REDEEM_STATUS	VARCHAR(10)  NULL,
    MEMBER_REMARKS	VARCHAR(200)  NULL,
    KYC_FLAG	VARCHAR(1)  NULL,
    MIN_REDEEM_FLAG	VARCHAR(1)  NULL,
    SUB_BROKER_ARN	VARCHAR(20)  NULL
)   
 SET @SQL = ''  
 SET @SQL = @SQL + LOWER('BULK INSERT #MFSS_ORDER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')   
 EXEC (@SQL)  
  
 TRUNCATE TABLE MFSS_ORDER_TMP  
  
 INSERT INTO MFSS_ORDER_TMP  
 SELECT MEMBERCODE = ISNULL(MEMBERCODE,''),  
 ORDER_DATE = CONVERT(DATETIME,ORDER_DATE,103),  
 ORDER_TIME,  
 ORDER_NO,  
 SETT_NO,  
 PARTY_CODE,  
 PARTY_NAME,  
 SCRIP_CD,  
 SCHEME_NAME = REPLACE(SCHEME_NAME,'''',''),  
 ISIN,  
 SUB_RED_FLAG,  
 AMOUNT=ISNULL(AMOUNT,0),  
 QTY = ISNULL(QTY,0),  
 ALLOTMENT_MODE = ISNULL(ALLOTMENT_MODE,''),  
 DPCLT = ISNULL(DPCLT,''),  
 FOLIONO = ISNULL(FOLIONO,''),  
 User_ID = ISNULL(User_ID,''),  
 CONF_FLAG = ISNULL(CONF_FLAG,''),  
 REJECT_REASON = ISNULL(REJECT_REASON,''),  
 NAV_VALUE_ALLOTED = 0,  
 QTY_ALLOTED = 0,  
 AMOUNT_ALLOTED = 0,  
 INT_REF_NO = ISNULL(INT_REF_NO,''),  
 SETTLEMENT_TYPE = ISNULL(SETTLEMENT_TYPE,''),  
 ORDER_TYPE = ISNULL(ORDER_TYPE,''),  
 SIP_REGN_NO = ISNULL(SIP_REGN_NO,0),  
 SIP_REGN_DATE = CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,'01/01/1900'),103),
 SUBBRCODE,
 EUIN = ISNULL(EUIN,''),
 EUIN_DECL= ISNULL(EUIN_DECL,''),
 ALL_Units_Flag= ISNULL(ALL_Units_Flag,''),
 ORD_DPC_FLAG= ISNULL(ORD_DPC_FLAG,''),
 ORD_SUB_TYPE = ISNULL(ORD_SUB_TYPE,'') ,
 FIRST_ORDER_FLAG = ISNULL(FIRST_ORDER_FLAG,'') ,
 PUR_REDEEM_STATUS = ISNULL(PUR_REDEEM_STATUS,'') ,
 MEMBER_REMARKS = ISNULL(MEMBER_REMARKS,'') ,
 KYC_FLAG = ISNULL(KYC_FLAG,'') ,
 MIN_REDEEM_FLAG = ISNULL(MIN_REDEEM_FLAG,'') ,
 SUB_BROKER_ARN = ISNULL(SUB_BROKER_ARN,'') 
 FROM #MFSS_ORDER_TMP  
END  
  

  
IF @FILEFOR = 'FUND_OBL'  
BEGIN  
 DELETE FROM MFSS_FUNDS_OBLIGATION WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
  
 SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,  
     ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,INT_REF_NO=CONVERT(VARCHAR(100),''),  
     ORDER_TYPE,SIP_REGN_NO=CONVERT(VARCHAR(100),''),SIP_REGN_DATE=CONVERT(VARCHAR(10),''),FILLER1=CONVERT(VARCHAR(10),'')  
 INTO #MFSS_FUNDS_OBLIGATION  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_FUNDS_OBLIGATION FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 SET @SQL = @SQL + ' UPDATE #MFSS_FUNDS_OBLIGATION SET ORDER_DATE = ORDER_DATE + '' 23:59:59'' '  
 SET @SQL = @SQL + ' INSERT INTO MFSS_FUNDS_OBLIGATION '  
 SET @SQL = @SQL + ' SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,'  
 SET @SQL = @SQL + ' ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,AVAIL_AMOUNT=0,PROCESSDATE='''', '  
 SET @SQL = @SQL + ' INT_REF_NO=ISNULL(INT_REF_NO,''''),ORDER_TYPE,'  
 SET @SQL = @SQL + ' SIP_REGN_NO=ISNULL(SIP_REGN_NO,''0''),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''''),103) FROM #MFSS_FUNDS_OBLIGATION '  

 EXEC (@SQL)     
END  
  
IF @FILEFOR = 'FUND_OBL_FILE'  
BEGIN  
 CREATE TABLE #MARGINFILE  
 (  
  MRGFILEDATA VARCHAR(MAX),  
  SNO   BIGINT  
 )  
 DECLARE @SAUDA_DATE VARCHAR(11)  
 SET @SAUDA_DATE =CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
 EXEC PROC_MFSS_FUNDS_OBL_CALC @BUSINESS_DATE  
   
 INSERT INTO #MARGINFILE  
 SELECT   
 DATA = LEFT(CONVERT(VARCHAR,ORDER_DATE,120),10)   
 + '|' + LEFT(CONVERT(VARCHAR,SETTLEMENT_DATE,120),10)  
 + '|' + SETT_TYPE  
 + '|' + SETT_NO  
 + '|' + MEMBERCODE  
 + '|' + PARTY_CODE  
 + '|' + DP_ID  
 + '|' + CLTDPID  
 + '|' + CONVERT(VARCHAR,ORDER_NO)  
 + '|' + ORDER_INDICATOR  
 + '|' + SCRIP_CD  
 + '|' + ISIN  
 + '|' + CONVERT(VARCHAR,AMOUNT)  
 + '|' + (CASE WHEN AVAIL_AMOUNT >= AMOUNT THEN 'Y' ELSE 'N' END)  
 + '|' + ''  
 + '|' + ISNULL(INT_REF_NO,'')  
 + '|' + ISNULL(ORDER_TYPE,'')  
 + '|' + CONVERT(VARCHAR,ISNULL(SIP_REGN_NO,0))  
 + '|' + (CASE WHEN ISNULL(SIP_REGN_DATE,'') = '1900-01-01' THEN '' ELSE LEFT(CONVERT(VARCHAR,ISNULL(SIP_REGN_DATE,''),120),10) END)  
 + '|',  
 SNO  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
 ORDER BY SNO  
   
 DECLARE @TMPFOLDER VARCHAR(200)  
 DECLARE @CMD VARCHAR(1000)  
 DECLARE @MEMCODE VARCHAR(4)  
 DECLARE @SETTNO  VARCHAR(7)  
 DECLARE @BatchNo VARCHAR(2)   
  
 SELECT @BatchNo = RIGHT('00'+CONVERT(VARCHAR,ISNULL(MAX(fileno),0)+1),2) FROM DelFileNo WHERE FileDate Like @BUSINESS_DATE + '%' And FileType = 'SOBG'  
  
 IF @BatchNo <> '01'   
 BEGIN  
  Update DelFileNo Set FileNo = CONVERT(INT,@BatchNo)  
  Where FileType = 'SOBG' And FileDate Like @BUSINESS_DATE + '%'  
    END  
 Else  
 BEGIN  
  insert into DelFileNo (FileType,FileNo,FileDate)  
  Values('SOBG',CONVERT(INT,@BatchNo),@BUSINESS_DATE)  
 END  
  
 Select @MEMCODE = RIGHT('0000'+MemberCode,4), @SETTNO=sett_no From Owner, sett_mst where start_date like @BUSINESS_DATE + '%'   
  
 SET @TMPFOLDER = @FILENAME + 'MFSS_' + CONVERT(VARCHAR,@@SPID)  
 SET @FILENAME = @TMPFOLDER + '\' +  @SETTNO + '_' + @MEMCODE + '_CLIENTFUNDOBG_RET_' + @BatchNo + '.txt'  
  
 SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @TMPFOLDER + ''', NO_OUTPUT'    
 EXEC (@CMD)  
  
 DECLARE @FS INT,  @FILEID INT  
 EXECUTE MASTER..SP_OACREATE 'SCRIPTING.FILESYSTEMOBJECT', @FS OUT  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'CREATETEXTFILE', @FILEID OUT, @FILENAME,TRUE  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'OPENTEXTFILE', @FILEID OUT, @FILENAME, 8, 1  
  
 DECLARE          
 @MRGFILEDATA VARCHAR(1000),    
 @MRGDATACUR  CURSOR          
  
 SET @MRGFILEDATA = 'Order Date,Settlement Date,Settlement type,Settlement No.,TM Code,Client Code,Depository ID,DP Client ID,Order No.,Order Indicator,Symbol,Series,Amount,Confirmation Flag,Remark,Internal Ref No,Order Type,SIP Regn No,SIP Regn Date'  
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  
 SET @MRGDATACUR = CURSOR FOR  SELECT MRGFILEDATA FROM  #MARGINFILE    
 OPEN @MRGDATACUR          
 FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 WHILE @@FETCH_STATUS = 0           
 BEGIN  
  EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 END          
 CLOSE @MRGDATACUR          
 DEALLOCATE @MRGDATACUR  
  
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'CLOSE'   
 EXECUTE  MASTER..SP_OADESTROY @FILEID  
 EXECUTE  MASTER..SP_OADESTROY @FS  
  
 DROP TABLE #MARGINFILE  
  
 UPDATE TBL_AUTO_PROCESS_DETAIL SET   
 PROCESS_HALTED_REASON = 'MARGIN PROCESS COMPLETED SUCCESSFULLY.' ,  
 ATTACHEMENT_FILE_NAME = @FILENAME,   
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),  
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_COUNT = 0  
 WHERE SNO = @SNO AND PROCESS_STATUS = 99  
END  
  
IF @FILEFOR = 'VALAN'  
BEGIN  
 DELETE FROM TBL_MFSS_VALAN_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM MFSS_SETTLEMENT   
 WHERE ORDER_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  IF @STATUS <> ''  
  BEGIN  
   SET @STATUS = @STATUS + ', '  
  END  
  SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE  
  EXEC PROC_MFSS_VALAN @SETT_NO, @SETT_TYPE  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN GENERATED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_VALAN_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END  
  
IF @FILEFOR = 'ALLOTMENT'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,INT_REF_NO,  
 ORDER_TYPE,SIP_REGN_NO,SIP_REGN_DATE=CONVERT(VARCHAR(10),''),Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type,
 FILLER=CONVERT(VARCHAR(100),'')  ,ALT_STAMP_DUTY,ALT_EXIT_LOAD
 INTO #MFSS_ORDER_STATUS_LOG  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
 
  ALTER TABLE  #MFSS_ORDER_STATUS_LOG
 ALTER COLUMN SUB_BR_CODE VARCHAR(MAX)
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='A',STT,  
 INT_REF_NO=ISNULL(INT_REF_NO,0),ORDER_TYPE,SIP_REGN_NO=ISNULL(SIP_REGN_NO,0),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''),103),
 Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type,FILLER,ALT_STAMP_DUTY,'0','0'
 FROM #MFSS_ORDER_STATUS_LOG 
 
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG  
  
 EXEC PROC_MFSS_STATUS_UPDATE   
END  
  
IF @FILEFOR = 'REDEMPTION'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,
 DPC_Flag,DP_TRANS,ORDER_TYPE,Order_Sub_Type,FILLER=CONVERT(VARCHAR(100),'') ,  ALT_SCHEME_NAME,ALT_STAMP_DUTY,ALT_EXIT_LOAD
 INTO #MFSS_ORDER_STATUS_LOG_R  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG_R FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='R',STT,  
 INT_REF_NO=0,ORDER_TYPE,SIP_REGN_NO=0,SIP_REGN_DATE='',
 SUB_BR_CODE='',EUIN='',EUIN_DECL='',DPC_Flag,DP_TRANS,Order_Sub_Type,ALT_SCHEME_NAME=FILLER,'0',ALT_EXIT_LOAD,alt_stamp_duty
 FROM #MFSS_ORDER_STATUS_LOG_R   ---changes done 23 Jul 20
 --SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 --RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='R',STT,  
 --INT_REF_NO=0,ORDER_TYPE,SIP_REGN_NO=0,SIP_REGN_DATE='',
 --SUB_BR_CODE='',EUIN='',EUIN_DECL='',DPC_Flag,DP_TRANS,Order_Sub_Type,ALT_SCHEME_NAME,ALT_STAMP_DUTY,ALT_EXIT_LOAD,'0'
 --FROM #MFSS_ORDER_STATUS_LOG_R  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG_R  
  
 EXEC PROC_MFSS_STATUS_UPDATE  
END  
  
  
IF @FILEFOR = 'POSTING'  
BEGIN  
 DELETE FROM TBL_MFSS_POST_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM ACCBILL   
 WHERE START_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  EXEC BBO_FA.DBO.AUTOPROCESS_NEWPOSTBILL @SETT_NO, @SETT_TYPE, @BUSINESS_DATE, 'BSE', 'MFSS'  
  
  SET @VNO = 0  
  SELECT @VNO = VNO FROM BBO_FA.DBO.ACC_TBL1 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
    
  IF @VNO <> 0  
  BEGIN  
   IF @STATUS <> ''  
   BEGIN  
    SET @STATUS = @STATUS + ', '  
   END  
   SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE + '-' + CONVERT(VARCHAR,@VNO)  
  END  
  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN POSTED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_POST_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_FILEUPLOAD_17072017
-- --------------------------------------------------
create PROC [dbo].[BSEMFSS_FILEUPLOAD_17072017]    
(    
 @SNO   NUMERIC(18,0),    
 @BUSINESS_DATE VARCHAR(11),    
 @FILENAME  VARCHAR(200),    
 @FILEFOR  VARCHAR(200),    
 @UNAME   VARCHAR(50)    
)    
    
AS    
DECLARE @SQL VARCHAR(MAX)    
  
DECLARE @SETT_NO VARCHAR(7),    
  @SETT_TYPE VARCHAR(2),    
  @SETTCUR CURSOR,    
  @STATUS  VARCHAR(MAX),    
  @VNO  BIGINT,    
  @TDATE VARCHAR(10)   
  
SELECT @TDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
IF @FILEFOR = 'SCHEME_MASTER'    
BEGIN    
 TRUNCATE TABLE MFSS_SCRIP_MASTER_TMP     
       
 SET @SQL = LOWER('BULK INSERT MFSS_SCRIP_MASTER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'', firstrow=2)')     
 EXEC (@SQL)       
    
 UPDATE MFSS_SCRIP_MASTER_TMP SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
     
 DELETE FROM MFSS_SCRIP_MASTER WHERE SCRIP_CD IN ( SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER_TMP    
 Where MFSS_SCRIP_MASTER.SCRIP_CD = MFSS_SCRIP_MASTER_TMP.SCRIP_CD)    
       
INSERT INTO MFSS_SCRIP_MASTER
(
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
)
SELECT 
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
FROM MFSS_SCRIP_MASTER_TMP
   
 UPDATE MFSS_SCRIP_MASTER SET CATEGORYCODE = '' WHERE CATEGORYCODE IS NULL      
END    

IF @FILEFOR = 'SETT_MASTER'    
BEGIN    
 TRUNCATE TABLE Sett_MstTemp     
    
 SET @SQL = 'SELECT Sett_Type,Sett_No,Start_Date,Sec_Payin,Funds_Payin,Funds_Payout,Sec_Payout,FILLER=CONVERT(VARCHAR(10),'''') INTO #SETTMST_TEMP FROM Sett_MstTemp  '    
 SET @SQL = @SQL + LOWER('BULK INSERT #SETTMST_TEMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO Sett_MstTemp SELECT Exchange=''BSE'',Sett_Type,Sett_No,Start_Date,Start_Date + '' 23:59:59'',Funds_Payin,Funds_Payout+ '' 23:59:59'',Sec_Payin,Sec_Payout+ '' 23:59:59'' FROM #SETTMST_TEMP '    
 EXEC (@SQL)       
    
    select Sett_No, Sett_Type INTO #DATA From Sett_MstTemp     
    Group by Sett_No, Sett_Type     
    Having Count(1) > 1    
    
 IF (SELECT ISNULL(COUNT(1),0) FROM #DATA)> 0     
 BEGIN    
    UPDATE TBL_AUTO_PROCESS_DETAIL SET                
    PROCESS_HALTED_REASON = 'File is having some duplicate record. Please check the file and reimport.',                
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),                
    PROCESS_OUTPUT_QUERY = 'select Sett_No, Sett_Type From Sett_MstTemp Group by Sett_No, Sett_Type Having Count(1) > 1',      
    PROCESS_STATUS_ALERT_COUNT = 0                
    WHERE SNO = @SNO AND PROCESS_STATUS = 99     
     
    RETURN    
 END    
    
 Delete From Sett_Mst Where Sett_No In (Select Sett_No From Sett_MstTemp Where Sett_Mst.Sett_No = Sett_MstTemp.Sett_No And Sett_Mst.Sett_Type = Sett_MstTemp.Sett_Type )    
     
 Insert Into Sett_Mst    
 Select * From Sett_MstTemp    
    
END    
    
    
IF @FILEFOR = 'NAV_MASTER'    
BEGIN    
 DELETE FROM MFSS_NAV    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
    
 SET @SQL = 'SELECT *,FILLER1=CONVERT(VARCHAR(10),'''') INTO #NAV FROM MFSS_NAV WHERE 1 = 2 '    
 SET @SQL = @SQL + LOWER('BULK INSERT #NAV FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO MFSS_NAV SELECT NAV_DATE + '' 23:59:59'',SCRIP_CD,SCHEME_NAME,RTA_SCHEME_CODE,DIV_REINVEST_FLAG,ISIN,NAV_VALUE,RTA_CODE FROM #NAV '    
 EXEC (@SQL)       
    
 UPDATE MFSS_NAV SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
END    
  
if @FILEFOR = 'XSIPMASTER'  
BEGIN  
 DELETE FROM FILEDATA WHERE PROGID = @@SPID    
 SELECT FILE_DATA INTO #XSIPMASTER FROM FILEDATA  
 WHERE 1 = 2  
  
 SET @SQL = lower('BULK INSERT #XSIPMASTER FROM ''' + @FILENAME  + '''  WITH ( ROWTERMINATOR = ''\n'')')  
 EXEC(@SQL)      
   
    
 INSERT INTO FILEDATA  
 SELECT @@SPID, FILE_DATA, GETDATE(), 'AUTOPROCESS' FROM #XSIPMASTER  
   
 EXEC PROC_XSIP_REGN_MASTER @TDATE, '', '', @@spid, 'AUTOPROCESS', @FILENAME  
END  
    
IF @FILEFOR = 'ORDER_FILE'    
BEGIN      
 CREATE TABLE [dbo].[#MFSS_ORDER_TMP]  (     [MEMBERCODE] VARCHAR(10)     , [ORDER_DATE] VARCHAR(10) , [ORDER_TIME] VARCHAR(10)     , [ORDER_NO] VARCHAR(16)     , [SETT_NO] VARCHAR(100)     , [PARTY_CODE] VARCHAR(100)     , [PARTY_NAME] VARCHAR(100)   
  
  
    
    
   , [SCRIP_CD] VARCHAR(500)     , [SCHEME_NAME] VARCHAR(200)     , [ISIN] VARCHAR(12)     , [SUB_RED_FLAG] VARCHAR(100)     , [AMOUNT] VARCHAR(100)      , [QTY] VARCHAR(100)      , [ALLOTMENT_MODE] VARCHAR(100)     , [DPCLT] VARCHAR(16)     , [FOLIONO] 
VARCHAR(16)     , [User_ID] VARCHAR(20)  NULL   , [CONF_FLAG] VARCHAR(100)  NULL   , [REJECT_REASON] VARCHAR(200)  NULL   , [INT_REF_NO] VARCHAR(10)  NULL   , [SETTLEMENT_TYPE] VARCHAR(200)  NULL   , [ORDER_TYPE] VARCHAR(3)  NULL   , [SIP_REGN_NO] VARCHAR
(  
  
100)   NULL   , [SIP_REGN_DATE] VARCHAR(10)  NULL   , [FILLER] VARCHAR(10) NULL  )     
 SET @SQL = ''    
 SET @SQL = @SQL + LOWER('BULK INSERT #MFSS_ORDER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 EXEC (@SQL)    
    
 TRUNCATE TABLE MFSS_ORDER_TMP    
    
 INSERT INTO MFSS_ORDER_TMP    
 SELECT MEMBERCODE = ISNULL(MEMBERCODE,''),    
 ORDER_DATE = CONVERT(DATETIME,ORDER_DATE,103),    
 ORDER_TIME,    
 ORDER_NO,    
 SETT_NO,    
 PARTY_CODE,    
 PARTY_NAME,    
 SCRIP_CD,    
 SCHEME_NAME = REPLACE(SCHEME_NAME,'''',''),    
 ISIN,    
 SUB_RED_FLAG,    
 AMOUNT=ISNULL(AMOUNT,0),    
 QTY = ISNULL(QTY,0),    
 ALLOTMENT_MODE = ISNULL(ALLOTMENT_MODE,''),    
 DPCLT = ISNULL(DPCLT,''),    
 FOLIONO = ISNULL(FOLIONO,''),    
 User_ID = ISNULL(User_ID,''),    
 CONF_FLAG = ISNULL(CONF_FLAG,''),    
 REJECT_REASON = ISNULL(REJECT_REASON,''),    
 NAV_VALUE_ALLOTED = 0,    
 QTY_ALLOTED = 0,    
 AMOUNT_ALLOTED = 0,    
 INT_REF_NO = ISNULL(INT_REF_NO,''),    
 SETTLEMENT_TYPE = ISNULL(SETTLEMENT_TYPE,''),    
 ORDER_TYPE = ISNULL(ORDER_TYPE,''),    
 SIP_REGN_NO = ISNULL(SIP_REGN_NO,0),    
 SIP_REGN_DATE = CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,'01/01/1900'),103)    
 FROM #MFSS_ORDER_TMP    
END    
    
    
IF @FILEFOR = 'FUND_OBL'    
BEGIN    
 DELETE FROM MFSS_FUNDS_OBLIGATION WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'    
    
 SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,    
     ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,INT_REF_NO=CONVERT(VARCHAR(100),''),    
     ORDER_TYPE,SIP_REGN_NO=CONVERT(VARCHAR(100),''),SIP_REGN_DATE=CONVERT(VARCHAR(10),''),FILLER1=CONVERT(VARCHAR(10),'')    
 INTO #MFSS_FUNDS_OBLIGATION    
 FROM MFSS_FUNDS_OBLIGATION    
 WHERE 1 = 2     
    
 SET @SQL = LOWER('BULK INSERT #MFSS_FUNDS_OBLIGATION FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )    
 SET @SQL = @SQL + ' UPDATE #MFSS_FUNDS_OBLIGATION SET ORDER_DATE = ORDER_DATE + '' 23:59:59'' '    
 SET @SQL = @SQL + ' INSERT INTO MFSS_FUNDS_OBLIGATION '    
 SET @SQL = @SQL + ' SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,'    
 SET @SQL = @SQL + ' ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,AVAIL_AMOUNT=0,PROCESSDATE='''', '    
 SET @SQL = @SQL + ' INT_REF_NO=ISNULL(INT_REF_NO,''''),ORDER_TYPE,'    
 SET @SQL = @SQL + ' SIP_REGN_NO=ISNULL(SIP_REGN_NO,''0''),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''''),103) FROM #MFSS_FUNDS_OBLIGATION '    
  
 EXEC (@SQL)       
END    
    
IF @FILEFOR = 'FUND_OBL_FILE'    
BEGIN    
 CREATE TABLE #MARGINFILE    
 (    
  MRGFILEDATA VARCHAR(MAX),    
  SNO   BIGINT    
 )    
 DECLARE @SAUDA_DATE VARCHAR(11)    
 SET @SAUDA_DATE =CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)    
    
 EXEC PROC_MFSS_FUNDS_OBL_CALC @BUSINESS_DATE    
     
 INSERT INTO #MARGINFILE    
 SELECT     
 DATA = LEFT(CONVERT(VARCHAR,ORDER_DATE,120),10)     
 + '|' + LEFT(CONVERT(VARCHAR,SETTLEMENT_DATE,120),10)    
 + '|' + SETT_TYPE    
 + '|' + SETT_NO    
 + '|' + MEMBERCODE    
 + '|' + PARTY_CODE    
 + '|' + DP_ID    
 + '|' + CLTDPID    
 + '|' + CONVERT(VARCHAR,ORDER_NO)    
 + '|' + ORDER_INDICATOR    
 + '|' + SCRIP_CD    
 + '|' + ISIN    
 + '|' + CONVERT(VARCHAR,AMOUNT)    
 + '|' + (CASE WHEN AVAIL_AMOUNT >= AMOUNT THEN 'Y' ELSE 'N' END)   
 + '|' + ''    
 + '|' + ISNULL(INT_REF_NO,'')    
 + '|' + ISNULL(ORDER_TYPE,'')    
 + '|' + CONVERT(VARCHAR,ISNULL(SIP_REGN_NO,0))    
 + '|' + (CASE WHEN ISNULL(SIP_REGN_DATE,'') = '1900-01-01' THEN '' ELSE LEFT(CONVERT(VARCHAR,ISNULL(SIP_REGN_DATE,''),120),10) END)    
 + '|',    
 SNO    
 FROM MFSS_FUNDS_OBLIGATION    
 WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'    
 ORDER BY SNO    
     
 DECLARE @TMPFOLDER VARCHAR(200)    
 DECLARE @CMD VARCHAR(1000)    
 DECLARE @MEMCODE VARCHAR(4)    
 DECLARE @SETTNO  VARCHAR(7)    
 DECLARE @BatchNo VARCHAR(2)     
    
 SELECT @BatchNo = RIGHT('00'+CONVERT(VARCHAR,ISNULL(MAX(fileno),0)+1),2) FROM DelFileNo WHERE FileDate Like @BUSINESS_DATE + '%' And FileType = 'SOBG'    
    
 IF @BatchNo <> '01'     
 BEGIN    
  Update DelFileNo Set FileNo = CONVERT(INT,@BatchNo)    
  Where FileType = 'SOBG' And FileDate Like @BUSINESS_DATE + '%'    
    END    
 Else    
 BEGIN    
  insert into DelFileNo (FileType,FileNo,FileDate)    
  Values('SOBG',CONVERT(INT,@BatchNo),@BUSINESS_DATE)    
 END    
    
 Select @MEMCODE = RIGHT('0000'+MemberCode,4), @SETTNO=sett_no From Owner, sett_mst where start_date like @BUSINESS_DATE + '%'     
    
 SET @TMPFOLDER = @FILENAME + 'MFSS_' + CONVERT(VARCHAR,@@SPID)    
 SET @FILENAME = @TMPFOLDER + '\' +  @SETTNO + '_' + @MEMCODE + '_CLIENTFUNDOBG_RET_' + @BatchNo + '.txt'    
    
 SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @TMPFOLDER + ''', NO_OUTPUT'      
 EXEC (@CMD)    
    
 DECLARE @FS INT,  @FILEID INT    
 EXECUTE MASTER..SP_OACREATE 'SCRIPTING.FILESYSTEMOBJECT', @FS OUT    
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'CREATETEXTFILE', @FILEID OUT, @FILENAME,TRUE    
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'OPENTEXTFILE', @FILEID OUT, @FILENAME, 8, 1    
    
 DECLARE            
 @MRGFILEDATA VARCHAR(1000),      
 @MRGDATACUR  CURSOR            
    
 SET @MRGFILEDATA = 'Order Date,Settlement Date,Settlement type,Settlement No.,TM Code,Client Code,Depository ID,DP Client ID,Order No.,Order Indicator,Symbol,Series,Amount,Confirmation Flag,Remark,Internal Ref No,Order Type,SIP Regn No,SIP Regn Date'    
 
   
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA    
    
 SET @MRGDATACUR = CURSOR FOR  SELECT MRGFILEDATA FROM  #MARGINFILE      
 OPEN @MRGDATACUR            
 FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA      
 WHILE @@FETCH_STATUS = 0             
 BEGIN    
  EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA    
  FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA      
 END            
 CLOSE @MRGDATACUR            
 DEALLOCATE @MRGDATACUR    
    
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'CLOSE'     
 EXECUTE  MASTER..SP_OADESTROY @FILEID    
 EXECUTE  MASTER..SP_OADESTROY @FS    
    
 DROP TABLE #MARGINFILE    
    
 UPDATE TBL_AUTO_PROCESS_DETAIL SET     
 PROCESS_HALTED_REASON = 'MARGIN PROCESS COMPLETED SUCCESSFULLY.' ,    
 ATTACHEMENT_FILE_NAME = @FILENAME,     
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),    
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_COUNT = 0    
 WHERE SNO = @SNO AND PROCESS_STATUS = 99    
END    
    
IF @FILEFOR = 'VALAN'    
BEGIN    
 DELETE FROM TBL_MFSS_VALAN_STATUS    
 WHERE ORDER_DATE = @BUSINESS_DATE    
    
 SET @STATUS = ''    
 SET @SETTCUR = CURSOR FOR    
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM MFSS_SETTLEMENT     
 WHERE ORDER_DATE = @BUSINESS_DATE    
 ORDER BY SETT_NO, SETT_TYPE    
 OPEN @SETTCUR    
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE    
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
  IF @STATUS <> ''    
  BEGIN    
   SET @STATUS = @STATUS + ', '    
  END    
  SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE    
  EXEC PROC_MFSS_VALAN @SETT_NO, @SETT_TYPE    
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE    
 END    
 CLOSE @SETTCUR    
 DEALLOCATE @SETTCUR    
 IF @STATUS <> ''    
 BEGIN    
  SET @STATUS = 'VALAN GENERATED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS    
  INSERT INTO TBL_MFSS_VALAN_STATUS VALUES (@BUSINESS_DATE, @STATUS)    
 END    
END    
    
IF @FILEFOR = 'ALLOTMENT'    
BEGIN    
    
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG    
    
 SELECT       
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,    
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,INT_REF_NO,    
 ORDER_TYPE,SIP_REGN_NO,SIP_REGN_DATE=CONVERT(VARCHAR(10),''),FILLER1=CONVERT(VARCHAR(10),'')    
 INTO #MFSS_ORDER_STATUS_LOG    
 FROM MFSS_ORDER_STATUS_LOG    
 WHERE 1 = 2     
    
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )    
 EXEC (@SQL)       
   
 INSERT INTO MFSS_ORDER_STATUS_LOG    
 SELECT DISTINCT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,    
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='A',STT,    
 INT_REF_NO=ISNULL(INT_REF_NO,0),ORDER_TYPE,SIP_REGN_NO=ISNULL(SIP_REGN_NO,0),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''),103)  
 FROM #MFSS_ORDER_STATUS_LOG    
      
 DROP TABLE #MFSS_ORDER_STATUS_LOG    
    
 EXEC PROC_MFSS_STATUS_UPDATE     
END    
    
IF @FILEFOR = 'REDEMPTION'    
BEGIN    
    
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG    
    
 SELECT       
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,    
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,FILLER1=CONVERT(VARCHAR(10),'')    
 INTO #MFSS_ORDER_STATUS_LOG_R    
 FROM MFSS_ORDER_STATUS_LOG    
 WHERE 1 = 2     
    
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG_R FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )    
 EXEC (@SQL)       
    
 INSERT INTO MFSS_ORDER_STATUS_LOG    
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,    
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='R',STT,    
 INT_REF_NO=0,ORDER_TYPE='',SIP_REGN_NO=0,SIP_REGN_DATE=''    
 FROM #MFSS_ORDER_STATUS_LOG_R    
    
 DROP TABLE #MFSS_ORDER_STATUS_LOG_R    
    
 EXEC PROC_MFSS_STATUS_UPDATE    
END    
    
    
IF @FILEFOR = 'POSTING'    
BEGIN    
 DELETE FROM TBL_MFSS_POST_STATUS    
 WHERE ORDER_DATE = @BUSINESS_DATE    
    
    
 SET @STATUS = ''    
 SET @SETTCUR = CURSOR FOR    
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM ACCBILL     
 WHERE START_DATE = @BUSINESS_DATE    
 ORDER BY SETT_NO, SETT_TYPE    
 OPEN @SETTCUR    
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE    
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
  EXEC BBO_FA.DBO.AUTOPROCESS_NEWPOSTBILL @SETT_NO, @SETT_TYPE, @BUSINESS_DATE, 'BSE', 'MFSS'    
    
  SET @VNO = 0    
  SELECT @VNO = VNO FROM BBO_FA.DBO.ACC_TBL1 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
      
  IF @VNO <> 0    
  BEGIN    
   IF @STATUS <> ''    
   BEGIN    
    SET @STATUS = @STATUS + ', '    
   END    
   SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE + '-' + CONVERT(VARCHAR,@VNO)    
  END    
    
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE    
 END    
 CLOSE @SETTCUR    
 DEALLOCATE @SETTCUR    
 IF @STATUS <> ''    
 BEGIN    
  SET @STATUS = 'VALAN POSTED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS    
  INSERT INTO TBL_MFSS_POST_STATUS VALUES (@BUSINESS_DATE, @STATUS)    
 END    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_FILEUPLOAD_30062021
-- --------------------------------------------------
 CREATE  PROC [dbo].[BSEMFSS_FILEUPLOAD]    
(    
 @SNO   NUMERIC(18,0),    
 @BUSINESS_DATE VARCHAR(11),    
 @FILENAME  VARCHAR(200),    
 @FILEFOR  VARCHAR(200),    
 @UNAME   VARCHAR(50)    
)    
    
AS    
DECLARE @SQL VARCHAR(MAX)    
  
DECLARE @SETT_NO VARCHAR(7),    
  @SETT_TYPE VARCHAR(2),    
  @SETTCUR CURSOR,    
  @STATUS  VARCHAR(MAX),    
  @VNO  BIGINT,    
  @TDATE VARCHAR(10)   
  
SELECT @TDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
IF @FILEFOR = 'SCHEME_MASTER'    
BEGIN    
 TRUNCATE TABLE MFSS_SCRIP_MASTER_TMP     
       
 SET @SQL = LOWER('BULK INSERT MFSS_SCRIP_MASTER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'', firstrow=2)')     
 EXEC (@SQL)       
    
 UPDATE MFSS_SCRIP_MASTER_TMP SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
     
 DELETE FROM MFSS_SCRIP_MASTER WHERE SCRIP_CD IN ( SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER_TMP    
 Where MFSS_SCRIP_MASTER.SCRIP_CD = MFSS_SCRIP_MASTER_TMP.SCRIP_CD)    
       
INSERT INTO MFSS_SCRIP_MASTER
(
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
)
SELECT 
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
FROM MFSS_SCRIP_MASTER_TMP
   
 UPDATE MFSS_SCRIP_MASTER SET CATEGORYCODE = '' WHERE CATEGORYCODE IS NULL      
END    

IF @FILEFOR = 'SETT_MASTER'    
BEGIN    
 TRUNCATE TABLE Sett_MstTemp     
    
 SET @SQL = 'SELECT Sett_Type,Sett_No,Start_Date,Sec_Payin,Funds_Payin,Funds_Payout,Sec_Payout,FILLER=CONVERT(VARCHAR(10),'''') INTO #SETTMST_TEMP FROM Sett_MstTemp  '    
 SET @SQL = @SQL + LOWER('BULK INSERT #SETTMST_TEMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO Sett_MstTemp SELECT Exchange=''BSE'',Sett_Type,Sett_No,Start_Date,Start_Date + '' 23:59:59'',Funds_Payin,Funds_Payout+ '' 23:59:59'',Sec_Payin,Sec_Payout+ '' 23:59:59'' FROM #SETTMST_TEMP '    
 EXEC (@SQL)       
    
    select Sett_No, Sett_Type INTO #DATA From Sett_MstTemp     
    Group by Sett_No, Sett_Type     
    Having Count(1) > 1    
    
 IF (SELECT ISNULL(COUNT(1),0) FROM #DATA)> 0     
 BEGIN    
    UPDATE TBL_AUTO_PROCESS_DETAIL SET                
    PROCESS_HALTED_REASON = 'File is having some duplicate record. Please check the file and reimport.',                
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),                
    PROCESS_OUTPUT_QUERY = 'select Sett_No, Sett_Type From Sett_MstTemp Group by Sett_No, Sett_Type Having Count(1) > 1',      
    PROCESS_STATUS_ALERT_COUNT = 0                
    WHERE SNO = @SNO AND PROCESS_STATUS = 99     
     
    RETURN    
 END    
    
 Delete From Sett_Mst Where Sett_No In (Select Sett_No From Sett_MstTemp Where Sett_Mst.Sett_No = Sett_MstTemp.Sett_No And Sett_Mst.Sett_Type = Sett_MstTemp.Sett_Type )    
     
 Insert Into Sett_Mst    
 Select * From Sett_MstTemp    
    
END    
    
    
IF @FILEFOR = 'NAV_MASTER'    
BEGIN    
 DELETE FROM MFSS_NAV    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
    
 SET @SQL = 'SELECT *,FILLER1=CONVERT(VARCHAR(10),'''') INTO #NAV FROM MFSS_NAV WHERE 1 = 2 '    
 SET @SQL = @SQL + LOWER('BULK INSERT #NAV FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO MFSS_NAV SELECT NAV_DATE + '' 23:59:59'',SCRIP_CD,SCHEME_NAME,RTA_SCHEME_CODE,DIV_REINVEST_FLAG,ISIN,NAV_VALUE,RTA_CODE FROM #NAV '    
 EXEC (@SQL)       
    
 UPDATE MFSS_NAV SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
END    
  
if @FILEFOR = 'XSIPMASTER'  
BEGIN  
 DELETE FROM FILEDATA WHERE PROGID = @@SPID    
 SELECT FILE_DATA INTO #XSIPMASTER FROM FILEDATA  
 WHERE 1 = 2  
  
 SET @SQL = lower('BULK INSERT #XSIPMASTER FROM ''' + @FILENAME  + '''  WITH ( ROWTERMINATOR = ''\n'')')  
 EXEC(@SQL)      
   
    
 INSERT INTO FILEDATA  
 SELECT @@SPID, FILE_DATA, GETDATE(), 'AUTOPROCESS' FROM #XSIPMASTER  
   
 EXEC PROC_XSIP_REGN_MASTER @TDATE, '', '', @@spid, 'AUTOPROCESS', @FILENAME  
END  
    
IF @FILEFOR = 'ORDER_FILE'    
BEGIN      
 CREATE TABLE [dbo].[#MFSS_ORDER_TMP]  
  
  
    
    
(  
	[MEMBERCODE] VARCHAR(10), 
	[ORDER_DATE] VARCHAR(10), 
	[ORDER_TIME] VARCHAR(10), 
	[ORDER_NO] VARCHAR(16), 
	[SETT_NO] VARCHAR(100), 
	[PARTY_CODE] VARCHAR(100), 
	[PARTY_NAME] VARCHAR(100), 
	[SCRIP_CD] VARCHAR(500), 
	[SCHEME_NAME] VARCHAR(200), 
	[ISIN] VARCHAR(12), 
	[SUB_RED_FLAG] VARCHAR(100), 
	[AMOUNT] VARCHAR(100), 
	[QTY] VARCHAR(100), 
	[ALLOTMENT_MODE] VARCHAR(100), 
	[DPCLT] VARCHAR(16), 
	[FOLIONO] VARCHAR(16), 
	[User_ID] VARCHAR(20)  NULL, 
	[CONF_FLAG] VARCHAR(100)  NULL, 
	[REJECT_REASON] VARCHAR(200)  NULL, 
	[INT_REF_NO] VARCHAR(20)  NULL, 
	[SETTLEMENT_TYPE] VARCHAR(200)  NULL, 
	[ORDER_TYPE] VARCHAR(3)  NULL, 
	[SIP_REGN_NO] VARCHAR(100)   NULL, 
	[SIP_REGN_DATE] VARCHAR(10)  NULL, 
	[SUBBRCODE] VARCHAR(50)  NULL, 
	[EUIN] VARCHAR(10)  NULL, 
	[EUIN_DECL]		VARCHAR(1)  NULL, 
	[ALL_Units_Flag] VARCHAR(1)  NULL, 
	[ORD_DPC_FLAG] VARCHAR(1)  NULL, 
	[ORD_SUB_TYPE] VARCHAR(10)  NULL,
	FIRST_ORDER_FLAG	VARCHAR(1)  NULL,
    PUR_REDEEM_STATUS	VARCHAR(10)  NULL,
    MEMBER_REMARKS	VARCHAR(200)  NULL,
    KYC_FLAG	VARCHAR(1)  NULL,
    MIN_REDEEM_FLAG	VARCHAR(1)  NULL,
    SUB_BROKER_ARN	VARCHAR(20)  NULL
)   
 SET @SQL = ''  
 SET @SQL = @SQL + LOWER('BULK INSERT #MFSS_ORDER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')   
 EXEC (@SQL)  
  
 TRUNCATE TABLE MFSS_ORDER_TMP  
  
 INSERT INTO MFSS_ORDER_TMP  
 SELECT MEMBERCODE = ISNULL(MEMBERCODE,''),  
 ORDER_DATE = CONVERT(DATETIME,ORDER_DATE,103),  
 ORDER_TIME,  
 ORDER_NO,  
 SETT_NO,  
 PARTY_CODE,  
 PARTY_NAME,  
 SCRIP_CD,  
 SCHEME_NAME = REPLACE(SCHEME_NAME,'''',''),  
 ISIN,  
 SUB_RED_FLAG,  
 AMOUNT=ISNULL(AMOUNT,0),  
 QTY = ISNULL(QTY,0),  
 ALLOTMENT_MODE = ISNULL(ALLOTMENT_MODE,''),  
 DPCLT = ISNULL(DPCLT,''),  
 FOLIONO = ISNULL(FOLIONO,''),  
 User_ID = ISNULL(User_ID,''),  
 CONF_FLAG = ISNULL(CONF_FLAG,''),  
 REJECT_REASON = ISNULL(REJECT_REASON,''),  
 NAV_VALUE_ALLOTED = 0,  
 QTY_ALLOTED = 0,  
 AMOUNT_ALLOTED = 0,  
 INT_REF_NO = ISNULL(INT_REF_NO,''),  
 SETTLEMENT_TYPE = ISNULL(SETTLEMENT_TYPE,''),  
 ORDER_TYPE = ISNULL(ORDER_TYPE,''),  
 SIP_REGN_NO = ISNULL(SIP_REGN_NO,0),  
 SIP_REGN_DATE = CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,'01/01/1900'),103),
 SUBBRCODE,
 EUIN = ISNULL(EUIN,''),
 EUIN_DECL= ISNULL(EUIN_DECL,''),
 ALL_Units_Flag= ISNULL(ALL_Units_Flag,''),
 ORD_DPC_FLAG= ISNULL(ORD_DPC_FLAG,''),
 ORD_SUB_TYPE = ISNULL(ORD_SUB_TYPE,'') ,
 FIRST_ORDER_FLAG = ISNULL(FIRST_ORDER_FLAG,'') ,
 PUR_REDEEM_STATUS = ISNULL(PUR_REDEEM_STATUS,'') ,
 MEMBER_REMARKS = ISNULL(MEMBER_REMARKS,'') ,
 KYC_FLAG = ISNULL(KYC_FLAG,'') ,
 MIN_REDEEM_FLAG = ISNULL(MIN_REDEEM_FLAG,'') ,
 SUB_BROKER_ARN = ISNULL(SUB_BROKER_ARN,'') 
 FROM #MFSS_ORDER_TMP  
END  
  

  
IF @FILEFOR = 'FUND_OBL'  
BEGIN  
 DELETE FROM MFSS_FUNDS_OBLIGATION WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
  
 SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,  
     ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,INT_REF_NO=CONVERT(VARCHAR(100),''),  
     ORDER_TYPE,SIP_REGN_NO=CONVERT(VARCHAR(100),''),SIP_REGN_DATE=CONVERT(VARCHAR(10),''),FILLER1=CONVERT(VARCHAR(10),'')  
 INTO #MFSS_FUNDS_OBLIGATION  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_FUNDS_OBLIGATION FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 SET @SQL = @SQL + ' UPDATE #MFSS_FUNDS_OBLIGATION SET ORDER_DATE = ORDER_DATE + '' 23:59:59'' '  
 SET @SQL = @SQL + ' INSERT INTO MFSS_FUNDS_OBLIGATION '  
 SET @SQL = @SQL + ' SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,'  
 SET @SQL = @SQL + ' ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,AVAIL_AMOUNT=0,PROCESSDATE='''', '  
 SET @SQL = @SQL + ' INT_REF_NO=ISNULL(INT_REF_NO,''''),ORDER_TYPE,'  
 SET @SQL = @SQL + ' SIP_REGN_NO=ISNULL(SIP_REGN_NO,''0''),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''''),103) FROM #MFSS_FUNDS_OBLIGATION '  
print @SQL
 EXEC (@SQL)     
END  
  
IF @FILEFOR = 'FUND_OBL_FILE'  
BEGIN  
 CREATE TABLE #MARGINFILE  
 (  
  MRGFILEDATA VARCHAR(MAX),  
  SNO   BIGINT  
 )  
 DECLARE @SAUDA_DATE VARCHAR(11)  
 SET @SAUDA_DATE =CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
 EXEC PROC_MFSS_FUNDS_OBL_CALC @BUSINESS_DATE  
   
 INSERT INTO #MARGINFILE  
 SELECT   
 DATA = LEFT(CONVERT(VARCHAR,ORDER_DATE,120),10)   
 + '|' + LEFT(CONVERT(VARCHAR,SETTLEMENT_DATE,120),10)  
 + '|' + SETT_TYPE  
 + '|' + SETT_NO  
 + '|' + MEMBERCODE  
 + '|' + PARTY_CODE  
 + '|' + DP_ID  
 + '|' + CLTDPID  
 + '|' + CONVERT(VARCHAR,ORDER_NO)  
 + '|' + ORDER_INDICATOR  
 + '|' + SCRIP_CD  
 + '|' + ISIN  
 + '|' + CONVERT(VARCHAR,AMOUNT)  
 + '|' + (CASE WHEN AVAIL_AMOUNT >= AMOUNT THEN 'Y' ELSE 'N' END)  
 + '|' + ''  
 + '|' + ISNULL(INT_REF_NO,'')  
 + '|' + ISNULL(ORDER_TYPE,'')  
 + '|' + CONVERT(VARCHAR,ISNULL(SIP_REGN_NO,0))  
 + '|' + (CASE WHEN ISNULL(SIP_REGN_DATE,'') = '1900-01-01' THEN '' ELSE LEFT(CONVERT(VARCHAR,ISNULL(SIP_REGN_DATE,''),120),10) END)  
 + '|',  
 SNO  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
 ORDER BY SNO  
   
 DECLARE @TMPFOLDER VARCHAR(200)  
 DECLARE @CMD VARCHAR(1000)  
 DECLARE @MEMCODE VARCHAR(4)  
 DECLARE @SETTNO  VARCHAR(7)  
 DECLARE @BatchNo VARCHAR(2)   
  
 SELECT @BatchNo = RIGHT('00'+CONVERT(VARCHAR,ISNULL(MAX(fileno),0)+1),2) FROM DelFileNo WHERE FileDate Like @BUSINESS_DATE + '%' And FileType = 'SOBG'  
  
 IF @BatchNo <> '01'   
 BEGIN  
  Update DelFileNo Set FileNo = CONVERT(INT,@BatchNo)  
  Where FileType = 'SOBG' And FileDate Like @BUSINESS_DATE + '%'  
    END  
 Else  
 BEGIN  
  insert into DelFileNo (FileType,FileNo,FileDate)  
  Values('SOBG',CONVERT(INT,@BatchNo),@BUSINESS_DATE)  
 END  
  
 Select @MEMCODE = RIGHT('0000'+MemberCode,4), @SETTNO=sett_no From Owner, sett_mst where start_date like @BUSINESS_DATE + '%'   
  
 SET @TMPFOLDER = @FILENAME + 'MFSS_' + CONVERT(VARCHAR,@@SPID)  
 SET @FILENAME = @TMPFOLDER + '\' +  @SETTNO + '_' + @MEMCODE + '_CLIENTFUNDOBG_RET_' + @BatchNo + '.txt'  
  
 SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @TMPFOLDER + ''', NO_OUTPUT'    
 EXEC (@CMD)  
  
 DECLARE @FS INT,  @FILEID INT  
 EXECUTE MASTER..SP_OACREATE 'SCRIPTING.FILESYSTEMOBJECT', @FS OUT  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'CREATETEXTFILE', @FILEID OUT, @FILENAME,TRUE  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'OPENTEXTFILE', @FILEID OUT, @FILENAME, 8, 1  
  
 DECLARE          
 @MRGFILEDATA VARCHAR(1000),    
 @MRGDATACUR  CURSOR  
  
 SET @MRGFILEDATA = 'Order Date,Settlement Date,Settlement type,Settlement No.,TM Code,Client Code,Depository ID,DP Client ID,Order No.,Order Indicator,Symbol,Series,Amount,Confirmation Flag,Remark,Internal Ref No,Order Type,SIP Regn No,SIP Regn Date'  


 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  
 SET @MRGDATACUR = CURSOR FOR  SELECT MRGFILEDATA FROM  #MARGINFILE    
 OPEN @MRGDATACUR          
 FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 WHILE @@FETCH_STATUS = 0           
 BEGIN  
  EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 END          
 CLOSE @MRGDATACUR          
 DEALLOCATE @MRGDATACUR  
  
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'CLOSE'   
 EXECUTE  MASTER..SP_OADESTROY @FILEID  
 EXECUTE  MASTER..SP_OADESTROY @FS  
  
 DROP TABLE #MARGINFILE  
  
 UPDATE TBL_AUTO_PROCESS_DETAIL SET   
 PROCESS_HALTED_REASON = 'MARGIN PROCESS COMPLETED SUCCESSFULLY.' ,  
 ATTACHEMENT_FILE_NAME = @FILENAME,   
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),  
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_COUNT = 0  
 WHERE SNO = @SNO AND PROCESS_STATUS = 99  
END  
  
IF @FILEFOR = 'VALAN'  
BEGIN  
 DELETE FROM TBL_MFSS_VALAN_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM MFSS_SETTLEMENT   
 WHERE ORDER_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  IF @STATUS <> ''  
  BEGIN  
   SET @STATUS = @STATUS + ', '  
  END  
  SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE  
  EXEC PROC_MFSS_VALAN @SETT_NO, @SETT_TYPE  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN GENERATED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_VALAN_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END  
  
IF @FILEFOR = 'ALLOTMENT'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,INT_REF_NO,  
 ORDER_TYPE,SIP_REGN_NO,SIP_REGN_DATE=CONVERT(VARCHAR(10),''),Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type,
 FILLER=CONVERT(VARCHAR(100),'') ,ALT_SCHEME_NAME,ALT_STAMP_DUTY
 INTO #MFSS_ORDER_STATUS_LOG  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
-- print @SQL
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='A',STT,  
 INT_REF_NO=ISNULL(INT_REF_NO,0),ORDER_TYPE,SIP_REGN_NO=ISNULL(SIP_REGN_NO,0),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''),103),
 Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type ,FILLER=CONVERT(VARCHAR(100),'') ,ALT_SCHEME_NAME,ALT_STAMP_DUTY 
 FROM #MFSS_ORDER_STATUS_LOG  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG  
  
 EXEC PROC_MFSS_STATUS_UPDATE   
END  
  
IF @FILEFOR = 'REDEMPTION'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,
 DPC_Flag,DP_TRANS,ORDER_TYPE,Order_Sub_Type,FILLER=CONVERT(VARCHAR(100),'') ,ALT_SCHEME_NAME,ALT_STAMP_DUTY 
 INTO #MFSS_ORDER_STATUS_LOG_R  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG_R FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='R',STT,  
 INT_REF_NO=0,ORDER_TYPE,SIP_REGN_NO=0,SIP_REGN_DATE='',
 SUB_BR_CODE='',EUIN='',EUIN_DECL='',DPC_Flag,DP_TRANS,Order_Sub_Type,FILLER=CONVERT(VARCHAR(100),'') ,ALT_SCHEME_NAME,ALT_STAMP_DUTY 
 FROM #MFSS_ORDER_STATUS_LOG_R  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG_R  
  
 EXEC PROC_MFSS_STATUS_UPDATE  
END  
  
  
IF @FILEFOR = 'POSTING'  
BEGIN  
 DELETE FROM TBL_MFSS_POST_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM ACCBILL   
 WHERE START_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  EXEC BBO_FA.DBO.AUTOPROCESS_NEWPOSTBILL @SETT_NO, @SETT_TYPE, @BUSINESS_DATE, 'BSE', 'MFSS'  
  
  SET @VNO = 0  
  SELECT @VNO = VNO FROM BBO_FA.DBO.ACC_TBL1 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
    
  IF @VNO <> 0  
  BEGIN  
   IF @STATUS <> ''  
   BEGIN  
    SET @STATUS = @STATUS + ', '  
   END  
   SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE + '-' + CONVERT(VARCHAR,@VNO)  
  END  
  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN POSTED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_POST_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_FILEUPLOAD_bak_17jul2020
-- --------------------------------------------------
 create   PROC [dbo].[BSEMFSS_FILEUPLOAD_bak_17jul2020]    
(    
 @SNO   NUMERIC(18,0),    
 @BUSINESS_DATE VARCHAR(11),    
 @FILENAME  VARCHAR(200),    
 @FILEFOR  VARCHAR(200),    
 @UNAME   VARCHAR(50)    
)    
    
AS    
DECLARE @SQL VARCHAR(MAX)    
  
DECLARE @SETT_NO VARCHAR(7),    
  @SETT_TYPE VARCHAR(2),    
  @SETTCUR CURSOR,    
  @STATUS  VARCHAR(MAX),    
  @VNO  BIGINT,    
  @TDATE VARCHAR(10)   
  
SELECT @TDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
IF @FILEFOR = 'SCHEME_MASTER'    
BEGIN    
 TRUNCATE TABLE MFSS_SCRIP_MASTER_TMP     
       
 SET @SQL = LOWER('BULK INSERT MFSS_SCRIP_MASTER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'', firstrow=2)')     
 EXEC (@SQL)       
    
 UPDATE MFSS_SCRIP_MASTER_TMP SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
     
 DELETE FROM MFSS_SCRIP_MASTER WHERE SCRIP_CD IN ( SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER_TMP    
 Where MFSS_SCRIP_MASTER.SCRIP_CD = MFSS_SCRIP_MASTER_TMP.SCRIP_CD)    
       
INSERT INTO MFSS_SCRIP_MASTER
(
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
)
SELECT 
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
FROM MFSS_SCRIP_MASTER_TMP
   
 UPDATE MFSS_SCRIP_MASTER SET CATEGORYCODE = '' WHERE CATEGORYCODE IS NULL      
END    

IF @FILEFOR = 'SETT_MASTER'    
BEGIN    
 TRUNCATE TABLE Sett_MstTemp     
    
 SET @SQL = 'SELECT Sett_Type,Sett_No,Start_Date,Sec_Payin,Funds_Payin,Funds_Payout,Sec_Payout,FILLER=CONVERT(VARCHAR(10),'''') INTO #SETTMST_TEMP FROM Sett_MstTemp  '    
 SET @SQL = @SQL + LOWER('BULK INSERT #SETTMST_TEMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO Sett_MstTemp SELECT Exchange=''BSE'',Sett_Type,Sett_No,Start_Date,Start_Date + '' 23:59:59'',Funds_Payin,Funds_Payout+ '' 23:59:59'',Sec_Payin,Sec_Payout+ '' 23:59:59'' FROM #SETTMST_TEMP '    
 EXEC (@SQL)       
    
    select Sett_No, Sett_Type INTO #DATA From Sett_MstTemp     
    Group by Sett_No, Sett_Type     
    Having Count(1) > 1    
    
 IF (SELECT ISNULL(COUNT(1),0) FROM #DATA)> 0     
 BEGIN    
    UPDATE TBL_AUTO_PROCESS_DETAIL SET                
    PROCESS_HALTED_REASON = 'File is having some duplicate record. Please check the file and reimport.',                
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),                
    PROCESS_OUTPUT_QUERY = 'select Sett_No, Sett_Type From Sett_MstTemp Group by Sett_No, Sett_Type Having Count(1) > 1',      
    PROCESS_STATUS_ALERT_COUNT = 0                
    WHERE SNO = @SNO AND PROCESS_STATUS = 99     
     
    RETURN    
 END    
    
 Delete From Sett_Mst Where Sett_No In (Select Sett_No From Sett_MstTemp Where Sett_Mst.Sett_No = Sett_MstTemp.Sett_No And Sett_Mst.Sett_Type = Sett_MstTemp.Sett_Type )    
     
 Insert Into Sett_Mst    
 Select * From Sett_MstTemp    
    
END    
    
    
IF @FILEFOR = 'NAV_MASTER'    
BEGIN    
 DELETE FROM MFSS_NAV    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
    
 SET @SQL = 'SELECT *,FILLER1=CONVERT(VARCHAR(10),'''') INTO #NAV FROM MFSS_NAV WHERE 1 = 2 '    
 SET @SQL = @SQL + LOWER('BULK INSERT #NAV FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO MFSS_NAV SELECT NAV_DATE + '' 23:59:59'',SCRIP_CD,SCHEME_NAME,RTA_SCHEME_CODE,DIV_REINVEST_FLAG,ISIN,NAV_VALUE,RTA_CODE FROM #NAV '    
 EXEC (@SQL)       
    
 UPDATE MFSS_NAV SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
END    
  
if @FILEFOR = 'XSIPMASTER'  
BEGIN  
 DELETE FROM FILEDATA WHERE PROGID = @@SPID    
 SELECT FILE_DATA INTO #XSIPMASTER FROM FILEDATA  
 WHERE 1 = 2  
  
 SET @SQL = lower('BULK INSERT #XSIPMASTER FROM ''' + @FILENAME  + '''  WITH ( ROWTERMINATOR = ''\n'')')  
 EXEC(@SQL)      
   
    
 INSERT INTO FILEDATA  
 SELECT @@SPID, FILE_DATA, GETDATE(), 'AUTOPROCESS' FROM #XSIPMASTER  
   
 EXEC PROC_XSIP_REGN_MASTER @TDATE, '', '', @@spid, 'AUTOPROCESS', @FILENAME  
END  
    
IF @FILEFOR = 'ORDER_FILE'    
BEGIN      
 CREATE TABLE [dbo].[#MFSS_ORDER_TMP]  
  
  
    
    
(  
	[MEMBERCODE] VARCHAR(10), 
	[ORDER_DATE] VARCHAR(10), 
	[ORDER_TIME] VARCHAR(10), 
	[ORDER_NO] VARCHAR(16), 
	[SETT_NO] VARCHAR(100), 
	[PARTY_CODE] VARCHAR(100), 
	[PARTY_NAME] VARCHAR(100), 
	[SCRIP_CD] VARCHAR(500), 
	[SCHEME_NAME] VARCHAR(200), 
	[ISIN] VARCHAR(12), 
	[SUB_RED_FLAG] VARCHAR(100), 
	[AMOUNT] VARCHAR(100), 
	[QTY] VARCHAR(100), 
	[ALLOTMENT_MODE] VARCHAR(100), 
	[DPCLT] VARCHAR(16), 
	[FOLIONO] VARCHAR(16), 
	[User_ID] VARCHAR(20)  NULL, 
	[CONF_FLAG] VARCHAR(100)  NULL, 
	[REJECT_REASON] VARCHAR(200)  NULL, 
	[INT_REF_NO] VARCHAR(20)  NULL, 
	[SETTLEMENT_TYPE] VARCHAR(200)  NULL, 
	[ORDER_TYPE] VARCHAR(3)  NULL, 
	[SIP_REGN_NO] VARCHAR(100)   NULL, 
	[SIP_REGN_DATE] VARCHAR(10)  NULL, 
	[SUBBRCODE] VARCHAR(50)  NULL, 
	[EUIN] VARCHAR(10)  NULL, 
	[EUIN_DECL]		VARCHAR(1)  NULL, 
	[ALL_Units_Flag] VARCHAR(1)  NULL, 
	[ORD_DPC_FLAG] VARCHAR(1)  NULL, 
	[ORD_SUB_TYPE] VARCHAR(10)  NULL,
	FIRST_ORDER_FLAG	VARCHAR(1)  NULL,
    PUR_REDEEM_STATUS	VARCHAR(10)  NULL,
    MEMBER_REMARKS	VARCHAR(200)  NULL,
    KYC_FLAG	VARCHAR(1)  NULL,
    MIN_REDEEM_FLAG	VARCHAR(1)  NULL,
    SUB_BROKER_ARN	VARCHAR(20)  NULL
)   
 SET @SQL = ''  
 SET @SQL = @SQL + LOWER('BULK INSERT #MFSS_ORDER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')   
 EXEC (@SQL)  
  
 TRUNCATE TABLE MFSS_ORDER_TMP  
  
 INSERT INTO MFSS_ORDER_TMP  
 SELECT MEMBERCODE = ISNULL(MEMBERCODE,''),  
 ORDER_DATE = CONVERT(DATETIME,ORDER_DATE,103),  
 ORDER_TIME,  
 ORDER_NO,  
 SETT_NO,  
 PARTY_CODE,  
 PARTY_NAME,  
 SCRIP_CD,  
 SCHEME_NAME = REPLACE(SCHEME_NAME,'''',''),  
 ISIN,  
 SUB_RED_FLAG,  
 AMOUNT=ISNULL(AMOUNT,0),  
 QTY = ISNULL(QTY,0),  
 ALLOTMENT_MODE = ISNULL(ALLOTMENT_MODE,''),  
 DPCLT = ISNULL(DPCLT,''),  
 FOLIONO = ISNULL(FOLIONO,''),  
 User_ID = ISNULL(User_ID,''),  
 CONF_FLAG = ISNULL(CONF_FLAG,''),  
 REJECT_REASON = ISNULL(REJECT_REASON,''),  
 NAV_VALUE_ALLOTED = 0,  
 QTY_ALLOTED = 0,  
 AMOUNT_ALLOTED = 0,  
 INT_REF_NO = ISNULL(INT_REF_NO,''),  
 SETTLEMENT_TYPE = ISNULL(SETTLEMENT_TYPE,''),  
 ORDER_TYPE = ISNULL(ORDER_TYPE,''),  
 SIP_REGN_NO = ISNULL(SIP_REGN_NO,0),  
 SIP_REGN_DATE = CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,'01/01/1900'),103),
 SUBBRCODE,
 EUIN = ISNULL(EUIN,''),
 EUIN_DECL= ISNULL(EUIN_DECL,''),
 ALL_Units_Flag= ISNULL(ALL_Units_Flag,''),
 ORD_DPC_FLAG= ISNULL(ORD_DPC_FLAG,''),
 ORD_SUB_TYPE = ISNULL(ORD_SUB_TYPE,'') ,
 FIRST_ORDER_FLAG = ISNULL(FIRST_ORDER_FLAG,'') ,
 PUR_REDEEM_STATUS = ISNULL(PUR_REDEEM_STATUS,'') ,
 MEMBER_REMARKS = ISNULL(MEMBER_REMARKS,'') ,
 KYC_FLAG = ISNULL(KYC_FLAG,'') ,
 MIN_REDEEM_FLAG = ISNULL(MIN_REDEEM_FLAG,'') ,
 SUB_BROKER_ARN = ISNULL(SUB_BROKER_ARN,'') 
 FROM #MFSS_ORDER_TMP  
END  
  

  
IF @FILEFOR = 'FUND_OBL'  
BEGIN  
 DELETE FROM MFSS_FUNDS_OBLIGATION WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
  
 SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,  
     ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,INT_REF_NO=CONVERT(VARCHAR(100),''),  
     ORDER_TYPE,SIP_REGN_NO=CONVERT(VARCHAR(100),''),SIP_REGN_DATE=CONVERT(VARCHAR(10),''),FILLER1=CONVERT(VARCHAR(10),'')  
 INTO #MFSS_FUNDS_OBLIGATION  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_FUNDS_OBLIGATION FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 SET @SQL = @SQL + ' UPDATE #MFSS_FUNDS_OBLIGATION SET ORDER_DATE = ORDER_DATE + '' 23:59:59'' '  
 SET @SQL = @SQL + ' INSERT INTO MFSS_FUNDS_OBLIGATION '  
 SET @SQL = @SQL + ' SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,'  
 SET @SQL = @SQL + ' ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,AVAIL_AMOUNT=0,PROCESSDATE='''', '  
 SET @SQL = @SQL + ' INT_REF_NO=ISNULL(INT_REF_NO,''''),ORDER_TYPE,'  
 SET @SQL = @SQL + ' SIP_REGN_NO=ISNULL(SIP_REGN_NO,''0''),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''''),103) FROM #MFSS_FUNDS_OBLIGATION '  
print @SQL
 EXEC (@SQL)     
END  
  
IF @FILEFOR = 'FUND_OBL_FILE'  
BEGIN  
 CREATE TABLE #MARGINFILE  
 (  
  MRGFILEDATA VARCHAR(MAX),  
  SNO   BIGINT  
 )  
 DECLARE @SAUDA_DATE VARCHAR(11)  
 SET @SAUDA_DATE =CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
 EXEC PROC_MFSS_FUNDS_OBL_CALC @BUSINESS_DATE  
   
 INSERT INTO #MARGINFILE  
 SELECT   
 DATA = LEFT(CONVERT(VARCHAR,ORDER_DATE,120),10)   
 + '|' + LEFT(CONVERT(VARCHAR,SETTLEMENT_DATE,120),10)  
 + '|' + SETT_TYPE  
 + '|' + SETT_NO  
 + '|' + MEMBERCODE  
 + '|' + PARTY_CODE  
 + '|' + DP_ID  
 + '|' + CLTDPID  
 + '|' + CONVERT(VARCHAR,ORDER_NO)  
 + '|' + ORDER_INDICATOR  
 + '|' + SCRIP_CD  
 + '|' + ISIN  
 + '|' + CONVERT(VARCHAR,AMOUNT)  
 + '|' + (CASE WHEN AVAIL_AMOUNT >= AMOUNT THEN 'Y' ELSE 'N' END)  
 + '|' + ''  
 + '|' + ISNULL(INT_REF_NO,'')  
 + '|' + ISNULL(ORDER_TYPE,'')  
 + '|' + CONVERT(VARCHAR,ISNULL(SIP_REGN_NO,0))  
 + '|' + (CASE WHEN ISNULL(SIP_REGN_DATE,'') = '1900-01-01' THEN '' ELSE LEFT(CONVERT(VARCHAR,ISNULL(SIP_REGN_DATE,''),120),10) END)  
 + '|',  
 SNO  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
 ORDER BY SNO  
   
 DECLARE @TMPFOLDER VARCHAR(200)  
 DECLARE @CMD VARCHAR(1000)  
 DECLARE @MEMCODE VARCHAR(4)  
 DECLARE @SETTNO  VARCHAR(7)  
 DECLARE @BatchNo VARCHAR(2)   
  
 SELECT @BatchNo = RIGHT('00'+CONVERT(VARCHAR,ISNULL(MAX(fileno),0)+1),2) FROM DelFileNo WHERE FileDate Like @BUSINESS_DATE + '%' And FileType = 'SOBG'  
  
 IF @BatchNo <> '01'   
 BEGIN  
  Update DelFileNo Set FileNo = CONVERT(INT,@BatchNo)  
  Where FileType = 'SOBG' And FileDate Like @BUSINESS_DATE + '%'  
    END  
 Else  
 BEGIN  
  insert into DelFileNo (FileType,FileNo,FileDate)  
  Values('SOBG',CONVERT(INT,@BatchNo),@BUSINESS_DATE)  
 END  
  
 Select @MEMCODE = RIGHT('0000'+MemberCode,4), @SETTNO=sett_no From Owner, sett_mst where start_date like @BUSINESS_DATE + '%'   
  
 SET @TMPFOLDER = @FILENAME + 'MFSS_' + CONVERT(VARCHAR,@@SPID)  
 SET @FILENAME = @TMPFOLDER + '\' +  @SETTNO + '_' + @MEMCODE + '_CLIENTFUNDOBG_RET_' + @BatchNo + '.txt'  
  
 SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @TMPFOLDER + ''', NO_OUTPUT'    
 EXEC (@CMD)  
  
 DECLARE @FS INT,  @FILEID INT  
 EXECUTE MASTER..SP_OACREATE 'SCRIPTING.FILESYSTEMOBJECT', @FS OUT  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'CREATETEXTFILE', @FILEID OUT, @FILENAME,TRUE  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'OPENTEXTFILE', @FILEID OUT, @FILENAME, 8, 1  
  
 DECLARE          
 @MRGFILEDATA VARCHAR(1000),    
 @MRGDATACUR  CURSOR  
  
 SET @MRGFILEDATA = 'Order Date,Settlement Date,Settlement type,Settlement No.,TM Code,Client Code,Depository ID,DP Client ID,Order No.,Order Indicator,Symbol,Series,Amount,Confirmation Flag,Remark,Internal Ref No,Order Type,SIP Regn No,SIP Regn Date'  


 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  
 SET @MRGDATACUR = CURSOR FOR  SELECT MRGFILEDATA FROM  #MARGINFILE    
 OPEN @MRGDATACUR          
 FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 WHILE @@FETCH_STATUS = 0           
 BEGIN  
  EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 END          
 CLOSE @MRGDATACUR          
 DEALLOCATE @MRGDATACUR  
  
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'CLOSE'   
 EXECUTE  MASTER..SP_OADESTROY @FILEID  
 EXECUTE  MASTER..SP_OADESTROY @FS  
  
 DROP TABLE #MARGINFILE  
  
 UPDATE TBL_AUTO_PROCESS_DETAIL SET   
 PROCESS_HALTED_REASON = 'MARGIN PROCESS COMPLETED SUCCESSFULLY.' ,  
 ATTACHEMENT_FILE_NAME = @FILENAME,   
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),  
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_COUNT = 0  
 WHERE SNO = @SNO AND PROCESS_STATUS = 99  
END  
  
IF @FILEFOR = 'VALAN'  
BEGIN  
 DELETE FROM TBL_MFSS_VALAN_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM MFSS_SETTLEMENT   
 WHERE ORDER_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  IF @STATUS <> ''  
  BEGIN  
   SET @STATUS = @STATUS + ', '  
  END  
  SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE  
  EXEC PROC_MFSS_VALAN @SETT_NO, @SETT_TYPE  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN GENERATED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_VALAN_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END  
  
IF @FILEFOR = 'ALLOTMENT'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,INT_REF_NO,  
 ORDER_TYPE,SIP_REGN_NO,SIP_REGN_DATE=CONVERT(VARCHAR(10),''),Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type,
 FILLER=CONVERT(VARCHAR(50),'')  
 INTO #MFSS_ORDER_STATUS_LOG  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 print @SQL
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='A',STT,  
 INT_REF_NO=ISNULL(INT_REF_NO,0),ORDER_TYPE,SIP_REGN_NO=ISNULL(SIP_REGN_NO,0),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''),103),
 Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type  
 FROM #MFSS_ORDER_STATUS_LOG  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG  
  
 EXEC PROC_MFSS_STATUS_UPDATE   
END  
  
IF @FILEFOR = 'REDEMPTION'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,
 DPC_Flag,DP_TRANS,ORDER_TYPE,Order_Sub_Type,FILLER=CONVERT(VARCHAR(50),'')   
 INTO #MFSS_ORDER_STATUS_LOG_R  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG_R FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='R',STT,  
 INT_REF_NO=0,ORDER_TYPE,SIP_REGN_NO=0,SIP_REGN_DATE='',
 SUB_BR_CODE='',EUIN='',EUIN_DECL='',DPC_Flag,DP_TRANS,Order_Sub_Type
 FROM #MFSS_ORDER_STATUS_LOG_R  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG_R  
  
 EXEC PROC_MFSS_STATUS_UPDATE  
END  
  
  
IF @FILEFOR = 'POSTING'  
BEGIN  
 DELETE FROM TBL_MFSS_POST_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM ACCBILL   
 WHERE START_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  EXEC BBO_FA.DBO.AUTOPROCESS_NEWPOSTBILL @SETT_NO, @SETT_TYPE, @BUSINESS_DATE, 'BSE', 'MFSS'  
  
  SET @VNO = 0  
  SELECT @VNO = VNO FROM BBO_FA.DBO.ACC_TBL1 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
    
  IF @VNO <> 0  
  BEGIN  
   IF @STATUS <> ''  
   BEGIN  
    SET @STATUS = @STATUS + ', '  
   END  
   SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE + '-' + CONVERT(VARCHAR,@VNO)  
  END  
  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN POSTED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_POST_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSEMFSS_FILEUPLOAD_BKUP_06JUL20
-- --------------------------------------------------
CREATE  PROC [dbo].[BSEMFSS_FILEUPLOAD_BKUP_06JUL20]    
(    
 @SNO   NUMERIC(18,0),    
 @BUSINESS_DATE VARCHAR(11),    
 @FILENAME  VARCHAR(200),    
 @FILEFOR  VARCHAR(200),    
 @UNAME   VARCHAR(50)    
)    
    
AS    
DECLARE @SQL VARCHAR(MAX)    
  
DECLARE @SETT_NO VARCHAR(7),    
  @SETT_TYPE VARCHAR(2),    
  @SETTCUR CURSOR,    
  @STATUS  VARCHAR(MAX),    
  @VNO  BIGINT,    
  @TDATE VARCHAR(10)   
  
SELECT @TDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
IF @FILEFOR = 'SCHEME_MASTER'    
BEGIN    
 TRUNCATE TABLE MFSS_SCRIP_MASTER_TMP     
       
 SET @SQL = LOWER('BULK INSERT MFSS_SCRIP_MASTER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'', firstrow=2)')     
 EXEC (@SQL)       
    
 UPDATE MFSS_SCRIP_MASTER_TMP SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
     
 DELETE FROM MFSS_SCRIP_MASTER WHERE SCRIP_CD IN ( SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER_TMP    
 Where MFSS_SCRIP_MASTER.SCRIP_CD = MFSS_SCRIP_MASTER_TMP.SCRIP_CD)    
       
INSERT INTO MFSS_SCRIP_MASTER
(
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
)
SELECT 
	TOKEN,SCRIP_CD,RTSCHEMECODE,AMCSCHEMECODE,ISIN,AMC_CODE,CATEGORYCODE,SCHEME_PLAN,SCHEME_NAME,PUR_ALLOWED,PUR_TXNMMODE,
	PUR_AMT_MIN,PUT_AMT_MULTIPLE,PUR_AMT_MAX,PUR_AMT_MULTIPLIER,PUR_CUTOFF,RED_ALLOWED,RED_TXNMODE,RED_QTY_MIN,
	RED_QTY_MULTIPLE,RED_QTY_MAX,RED_AMT_MIN,RED_AMT_MAX,RED_AMT_MULTIPLE,RED_CUTOFF,RTAAGENTCODE,AMC_ACTIVE,
	DIV_REINVEST_FLAG,SIP_FLAG,STP_FLAG,SWP_FLAG,SWITCH_FLAG,SETTLEMENT_TYPE,AMC_IND,FACE_VALUE,SCHEME_START_DATE,
	SCHEME_END_DATE,EXIT_LOAD_FLAG,EXIT_LOAD,LOCKIN_PERIOD_FLAG,LOCKIN_PERIOD,CHANNEL_PARTNER_CODE,FILLER1
FROM MFSS_SCRIP_MASTER_TMP
   
 UPDATE MFSS_SCRIP_MASTER SET CATEGORYCODE = '' WHERE CATEGORYCODE IS NULL      
END    

IF @FILEFOR = 'SETT_MASTER'    
BEGIN    
 TRUNCATE TABLE Sett_MstTemp     
    
 SET @SQL = 'SELECT Sett_Type,Sett_No,Start_Date,Sec_Payin,Funds_Payin,Funds_Payout,Sec_Payout,FILLER=CONVERT(VARCHAR(10),'''') INTO #SETTMST_TEMP FROM Sett_MstTemp  '    
 SET @SQL = @SQL + LOWER('BULK INSERT #SETTMST_TEMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO Sett_MstTemp SELECT Exchange=''BSE'',Sett_Type,Sett_No,Start_Date,Start_Date + '' 23:59:59'',Funds_Payin,Funds_Payout+ '' 23:59:59'',Sec_Payin,Sec_Payout+ '' 23:59:59'' FROM #SETTMST_TEMP '    
 EXEC (@SQL)       
    
    select Sett_No, Sett_Type INTO #DATA From Sett_MstTemp     
    Group by Sett_No, Sett_Type     
    Having Count(1) > 1    
    
 IF (SELECT ISNULL(COUNT(1),0) FROM #DATA)> 0     
 BEGIN    
    UPDATE TBL_AUTO_PROCESS_DETAIL SET                
    PROCESS_HALTED_REASON = 'File is having some duplicate record. Please check the file and reimport.',                
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),                
    PROCESS_OUTPUT_QUERY = 'select Sett_No, Sett_Type From Sett_MstTemp Group by Sett_No, Sett_Type Having Count(1) > 1',      
    PROCESS_STATUS_ALERT_COUNT = 0                
    WHERE SNO = @SNO AND PROCESS_STATUS = 99     
     
    RETURN    
 END    
    
 Delete From Sett_Mst Where Sett_No In (Select Sett_No From Sett_MstTemp Where Sett_Mst.Sett_No = Sett_MstTemp.Sett_No And Sett_Mst.Sett_Type = Sett_MstTemp.Sett_Type )    
     
 Insert Into Sett_Mst    
 Select * From Sett_MstTemp    
    
END    
    
    
IF @FILEFOR = 'NAV_MASTER'    
BEGIN    
 DELETE FROM MFSS_NAV    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
    
 SET @SQL = 'SELECT *,FILLER1=CONVERT(VARCHAR(10),'''') INTO #NAV FROM MFSS_NAV WHERE 1 = 2 '    
 SET @SQL = @SQL + LOWER('BULK INSERT #NAV FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')     
 SET @SQL = @SQL + ' INSERT INTO MFSS_NAV SELECT NAV_DATE + '' 23:59:59'',SCRIP_CD,SCHEME_NAME,RTA_SCHEME_CODE,DIV_REINVEST_FLAG,ISIN,NAV_VALUE,RTA_CODE FROM #NAV '    
 EXEC (@SQL)       
    
 UPDATE MFSS_NAV SET SCHEME_NAME = REPLACE(SCHEME_NAME,'''','')    
 WHERE NAV_DATE = @BUSINESS_DATE + ' 23:59:59'    
END    
  
if @FILEFOR = 'XSIPMASTER'  
BEGIN  
 DELETE FROM FILEDATA WHERE PROGID = @@SPID    
 SELECT FILE_DATA INTO #XSIPMASTER FROM FILEDATA  
 WHERE 1 = 2  
  
 SET @SQL = lower('BULK INSERT #XSIPMASTER FROM ''' + @FILENAME  + '''  WITH ( ROWTERMINATOR = ''\n'')')  
 EXEC(@SQL)      
   
    
 INSERT INTO FILEDATA  
 SELECT @@SPID, FILE_DATA, GETDATE(), 'AUTOPROCESS' FROM #XSIPMASTER  
   
 EXEC PROC_XSIP_REGN_MASTER @TDATE, '', '', @@spid, 'AUTOPROCESS', @FILENAME  
END  
    
IF @FILEFOR = 'ORDER_FILE'    
BEGIN      
 CREATE TABLE [dbo].[#MFSS_ORDER_TMP]  
  
  
    
    
(  
	[MEMBERCODE] VARCHAR(10), 
	[ORDER_DATE] VARCHAR(10), 
	[ORDER_TIME] VARCHAR(10), 
	[ORDER_NO] VARCHAR(16), 
	[SETT_NO] VARCHAR(100), 
	[PARTY_CODE] VARCHAR(100), 
	[PARTY_NAME] VARCHAR(100), 
	[SCRIP_CD] VARCHAR(500), 
	[SCHEME_NAME] VARCHAR(200), 
	[ISIN] VARCHAR(12), 
	[SUB_RED_FLAG] VARCHAR(100), 
	[AMOUNT] VARCHAR(100), 
	[QTY] VARCHAR(100), 
	[ALLOTMENT_MODE] VARCHAR(100), 
	[DPCLT] VARCHAR(16), 
	[FOLIONO] VARCHAR(16), 
	[User_ID] VARCHAR(20)  NULL, 
	[CONF_FLAG] VARCHAR(100)  NULL, 
	[REJECT_REASON] VARCHAR(200)  NULL, 
	[INT_REF_NO] VARCHAR(20)  NULL, 
	[SETTLEMENT_TYPE] VARCHAR(200)  NULL, 
	[ORDER_TYPE] VARCHAR(3)  NULL, 
	[SIP_REGN_NO] VARCHAR(100)   NULL, 
	[SIP_REGN_DATE] VARCHAR(10)  NULL, 
	[SUBBRCODE] VARCHAR(50)  NULL, 
	[EUIN] VARCHAR(10)  NULL, 
	[EUIN_DECL]		VARCHAR(1)  NULL, 
	[ALL_Units_Flag] VARCHAR(1)  NULL, 
	[ORD_DPC_FLAG] VARCHAR(1)  NULL, 
	[ORD_SUB_TYPE] VARCHAR(10)  NULL,
	FIRST_ORDER_FLAG	VARCHAR(1)  NULL,
    PUR_REDEEM_STATUS	VARCHAR(10)  NULL,
    MEMBER_REMARKS	VARCHAR(200)  NULL,
    KYC_FLAG	VARCHAR(1)  NULL,
    MIN_REDEEM_FLAG	VARCHAR(1)  NULL,
    SUB_BROKER_ARN	VARCHAR(20)  NULL
)   
 SET @SQL = ''  
 SET @SQL = @SQL + LOWER('BULK INSERT #MFSS_ORDER_TMP FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')')   
 EXEC (@SQL)  
  
 TRUNCATE TABLE MFSS_ORDER_TMP  
  
 INSERT INTO MFSS_ORDER_TMP  
 SELECT MEMBERCODE = ISNULL(MEMBERCODE,''),  
 ORDER_DATE = CONVERT(DATETIME,ORDER_DATE,103),  
 ORDER_TIME,  
 ORDER_NO,  
 SETT_NO,  
 PARTY_CODE,  
 PARTY_NAME,  
 SCRIP_CD,  
 SCHEME_NAME = REPLACE(SCHEME_NAME,'''',''),  
 ISIN,  
 SUB_RED_FLAG,  
 AMOUNT=ISNULL(AMOUNT,0),  
 QTY = ISNULL(QTY,0),  
 ALLOTMENT_MODE = ISNULL(ALLOTMENT_MODE,''),  
 DPCLT = ISNULL(DPCLT,''),  
 FOLIONO = ISNULL(FOLIONO,''),  
 User_ID = ISNULL(User_ID,''),  
 CONF_FLAG = ISNULL(CONF_FLAG,''),  
 REJECT_REASON = ISNULL(REJECT_REASON,''),  
 NAV_VALUE_ALLOTED = 0,  
 QTY_ALLOTED = 0,  
 AMOUNT_ALLOTED = 0,  
 INT_REF_NO = ISNULL(INT_REF_NO,''),  
 SETTLEMENT_TYPE = ISNULL(SETTLEMENT_TYPE,''),  
 ORDER_TYPE = ISNULL(ORDER_TYPE,''),  
 SIP_REGN_NO = ISNULL(SIP_REGN_NO,0),  
 SIP_REGN_DATE = CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,'01/01/1900'),103),
 SUBBRCODE,
 EUIN = ISNULL(EUIN,''),
 EUIN_DECL= ISNULL(EUIN_DECL,''),
 ALL_Units_Flag= ISNULL(ALL_Units_Flag,''),
 ORD_DPC_FLAG= ISNULL(ORD_DPC_FLAG,''),
 ORD_SUB_TYPE = ISNULL(ORD_SUB_TYPE,'') ,
 FIRST_ORDER_FLAG = ISNULL(FIRST_ORDER_FLAG,'') ,
 PUR_REDEEM_STATUS = ISNULL(PUR_REDEEM_STATUS,'') ,
 MEMBER_REMARKS = ISNULL(MEMBER_REMARKS,'') ,
 KYC_FLAG = ISNULL(KYC_FLAG,'') ,
 MIN_REDEEM_FLAG = ISNULL(MIN_REDEEM_FLAG,'') ,
 SUB_BROKER_ARN = ISNULL(SUB_BROKER_ARN,'') 
 FROM #MFSS_ORDER_TMP  
END  
  

  
IF @FILEFOR = 'FUND_OBL'  
BEGIN  
 DELETE FROM MFSS_FUNDS_OBLIGATION WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
  
 SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,  
     ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,INT_REF_NO=CONVERT(VARCHAR(100),''),  
     ORDER_TYPE,SIP_REGN_NO=CONVERT(VARCHAR(100),''),SIP_REGN_DATE=CONVERT(VARCHAR(10),''),FILLER1=CONVERT(VARCHAR(10),'')  
 INTO #MFSS_FUNDS_OBLIGATION  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_FUNDS_OBLIGATION FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 SET @SQL = @SQL + ' UPDATE #MFSS_FUNDS_OBLIGATION SET ORDER_DATE = ORDER_DATE + '' 23:59:59'' '  
 SET @SQL = @SQL + ' INSERT INTO MFSS_FUNDS_OBLIGATION '  
 SET @SQL = @SQL + ' SELECT ORDER_DATE,SETTLEMENT_DATE,SETT_TYPE,SETT_NO,MEMBERCODE,PARTY_CODE,DP_ID,CLTDPID,'  
 SET @SQL = @SQL + ' ORDER_NO,ORDER_INDICATOR,SCRIP_CD,ISIN,AMOUNT,AVAIL_AMOUNT=0,PROCESSDATE='''', '  
 SET @SQL = @SQL + ' INT_REF_NO=ISNULL(INT_REF_NO,''''),ORDER_TYPE,'  
 SET @SQL = @SQL + ' SIP_REGN_NO=ISNULL(SIP_REGN_NO,''0''),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''''),103) FROM #MFSS_FUNDS_OBLIGATION '  
print @SQL
 EXEC (@SQL)     
END  
  
IF @FILEFOR = 'FUND_OBL_FILE'  
BEGIN  
 CREATE TABLE #MARGINFILE  
 (  
  MRGFILEDATA VARCHAR(MAX),  
  SNO   BIGINT  
 )  
 DECLARE @SAUDA_DATE VARCHAR(11)  
 SET @SAUDA_DATE =CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103)  
  
 EXEC PROC_MFSS_FUNDS_OBL_CALC @BUSINESS_DATE  
   
 INSERT INTO #MARGINFILE  
 SELECT   
 DATA = LEFT(CONVERT(VARCHAR,ORDER_DATE,120),10)   
 + '|' + LEFT(CONVERT(VARCHAR,SETTLEMENT_DATE,120),10)  
 + '|' + SETT_TYPE  
 + '|' + SETT_NO  
 + '|' + MEMBERCODE  
 + '|' + PARTY_CODE  
 + '|' + DP_ID  
 + '|' + CLTDPID  
 + '|' + CONVERT(VARCHAR,ORDER_NO)  
 + '|' + ORDER_INDICATOR  
 + '|' + SCRIP_CD  
 + '|' + ISIN  
 + '|' + CONVERT(VARCHAR,AMOUNT)  
 + '|' + (CASE WHEN AVAIL_AMOUNT >= AMOUNT THEN 'Y' ELSE 'N' END)  
 + '|' + ''  
 + '|' + ISNULL(INT_REF_NO,'')  
 + '|' + ISNULL(ORDER_TYPE,'')  
 + '|' + CONVERT(VARCHAR,ISNULL(SIP_REGN_NO,0))  
 + '|' + (CASE WHEN ISNULL(SIP_REGN_DATE,'') = '1900-01-01' THEN '' ELSE LEFT(CONVERT(VARCHAR,ISNULL(SIP_REGN_DATE,''),120),10) END)  
 + '|',  
 SNO  
 FROM MFSS_FUNDS_OBLIGATION  
 WHERE ORDER_DATE = @BUSINESS_DATE + ' 23:59:59'  
 ORDER BY SNO  
   
 DECLARE @TMPFOLDER VARCHAR(200)  
 DECLARE @CMD VARCHAR(1000)  
 DECLARE @MEMCODE VARCHAR(4)  
 DECLARE @SETTNO  VARCHAR(7)  
 DECLARE @BatchNo VARCHAR(2)   
  
 SELECT @BatchNo = RIGHT('00'+CONVERT(VARCHAR,ISNULL(MAX(fileno),0)+1),2) FROM DelFileNo WHERE FileDate Like @BUSINESS_DATE + '%' And FileType = 'SOBG'  
  
 IF @BatchNo <> '01'   
 BEGIN  
  Update DelFileNo Set FileNo = CONVERT(INT,@BatchNo)  
  Where FileType = 'SOBG' And FileDate Like @BUSINESS_DATE + '%'  
    END  
 Else  
 BEGIN  
  insert into DelFileNo (FileType,FileNo,FileDate)  
  Values('SOBG',CONVERT(INT,@BatchNo),@BUSINESS_DATE)  
 END  
  
 Select @MEMCODE = RIGHT('0000'+MemberCode,4), @SETTNO=sett_no From Owner, sett_mst where start_date like @BUSINESS_DATE + '%'   
  
 SET @TMPFOLDER = @FILENAME + 'MFSS_' + CONVERT(VARCHAR,@@SPID)  
 SET @FILENAME = @TMPFOLDER + '\' +  @SETTNO + '_' + @MEMCODE + '_CLIENTFUNDOBG_RET_' + @BatchNo + '.txt'  
  
 SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @TMPFOLDER + ''', NO_OUTPUT'    
 EXEC (@CMD)  
  
 DECLARE @FS INT,  @FILEID INT  
 EXECUTE MASTER..SP_OACREATE 'SCRIPTING.FILESYSTEMOBJECT', @FS OUT  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'CREATETEXTFILE', @FILEID OUT, @FILENAME,TRUE  
 EXECUTE  MASTER..SP_OAMETHOD @FS, 'OPENTEXTFILE', @FILEID OUT, @FILENAME, 8, 1  
  
 DECLARE          
 @MRGFILEDATA VARCHAR(1000),    
 @MRGDATACUR  CURSOR  
  
 SET @MRGFILEDATA = 'Order Date,Settlement Date,Settlement type,Settlement No.,TM Code,Client Code,Depository ID,DP Client ID,Order No.,Order Indicator,Symbol,Series,Amount,Confirmation Flag,Remark,Internal Ref No,Order Type,SIP Regn No,SIP Regn Date'  


 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  
 SET @MRGDATACUR = CURSOR FOR  SELECT MRGFILEDATA FROM  #MARGINFILE    
 OPEN @MRGDATACUR          
 FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 WHILE @@FETCH_STATUS = 0           
 BEGIN  
  EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA  
  FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA    
 END          
 CLOSE @MRGDATACUR          
 DEALLOCATE @MRGDATACUR  
  
 EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'CLOSE'   
 EXECUTE  MASTER..SP_OADESTROY @FILEID  
 EXECUTE  MASTER..SP_OADESTROY @FS  
  
 DROP TABLE #MARGINFILE  
  
 UPDATE TBL_AUTO_PROCESS_DETAIL SET   
 PROCESS_HALTED_REASON = 'MARGIN PROCESS COMPLETED SUCCESSFULLY.' ,  
 ATTACHEMENT_FILE_NAME = @FILENAME,   
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),  
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_COUNT = 0  
 WHERE SNO = @SNO AND PROCESS_STATUS = 99  
END  
  
IF @FILEFOR = 'VALAN'  
BEGIN  
 DELETE FROM TBL_MFSS_VALAN_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM MFSS_SETTLEMENT   
 WHERE ORDER_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  IF @STATUS <> ''  
  BEGIN  
   SET @STATUS = @STATUS + ', '  
  END  
  SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE  
  EXEC PROC_MFSS_VALAN @SETT_NO, @SETT_TYPE  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN GENERATED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_VALAN_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END  
  
IF @FILEFOR = 'ALLOTMENT'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,INT_REF_NO,  
 ORDER_TYPE,SIP_REGN_NO,SIP_REGN_DATE=CONVERT(VARCHAR(10),''),Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type,
 FILLER=CONVERT(VARCHAR(50),'')  
 INTO #MFSS_ORDER_STATUS_LOG  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 --print @SQL
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='A',STT,  
 INT_REF_NO=ISNULL(INT_REF_NO,0),ORDER_TYPE,SIP_REGN_NO=ISNULL(SIP_REGN_NO,0),SIP_REGN_DATE=CONVERT(DATETIME,ISNULL(SIP_REGN_DATE,''),103),
 Sub_BR_Code,EUIN,EUIN_DECL,DPC_Flag,DP_TRANS,Order_Sub_Type  
 FROM #MFSS_ORDER_STATUS_LOG  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG  
  
 EXEC PROC_MFSS_STATUS_UPDATE   
END  
  
IF @FILEFOR = 'REDEMPTION'  
BEGIN  
  
 TRUNCATE TABLE MFSS_ORDER_STATUS_LOG  
  
 SELECT     
 REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK,STT,
 DPC_Flag,DP_TRANS,ORDER_TYPE,Order_Sub_Type,FILLER=CONVERT(VARCHAR(50),'')   
 INTO #MFSS_ORDER_STATUS_LOG_R  
 FROM MFSS_ORDER_STATUS_LOG  
 WHERE 1 = 2   
  
 SET @SQL = LOWER('BULK INSERT #MFSS_ORDER_STATUS_LOG_R FROM ''' + @FILENAME + ''' WITH  (FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''\n'')' )  
 EXEC (@SQL)     
  
 INSERT INTO MFSS_ORDER_STATUS_LOG  
 SELECT REPORTDATE,ORDER_NO,SETT_TYPE,SETT_NO,ORDER_DATE,SCRIP_CD,ISIN,AMOUNT,QTY,MEMBERCODE,BRANCH_CODE,USERID,FOLIONO,RTA_SCHEME_CODE,  
 RTA_TRANS_NO,PARTY_CODE,F_CL_NAME,CLTDPID,NAV_VALUE_ALLOTED,QTY_ALLOTED,AMOUNT_ALLOTED,RECFLAG,REMARK=ISNULL(REMARK,''),RECFOR='R',STT,  
 INT_REF_NO=0,ORDER_TYPE,SIP_REGN_NO=0,SIP_REGN_DATE='',
 SUB_BR_CODE='',EUIN='',EUIN_DECL='',DPC_Flag,DP_TRANS,Order_Sub_Type
 FROM #MFSS_ORDER_STATUS_LOG_R  
  
 DROP TABLE #MFSS_ORDER_STATUS_LOG_R  
  
 EXEC PROC_MFSS_STATUS_UPDATE  
END  
  
  
IF @FILEFOR = 'POSTING'  
BEGIN  
 DELETE FROM TBL_MFSS_POST_STATUS  
 WHERE ORDER_DATE = @BUSINESS_DATE  
  
  
 SET @STATUS = ''  
 SET @SETTCUR = CURSOR FOR  
 SELECT DISTINCT SETT_NO, SETT_TYPE FROM ACCBILL   
 WHERE START_DATE = @BUSINESS_DATE  
 ORDER BY SETT_NO, SETT_TYPE  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  EXEC BBO_FA.DBO.AUTOPROCESS_NEWPOSTBILL @SETT_NO, @SETT_TYPE, @BUSINESS_DATE, 'BSE', 'MFSS'  
  
  SET @VNO = 0  
  SELECT @VNO = VNO FROM BBO_FA.DBO.ACC_TBL1 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
    
  IF @VNO <> 0  
  BEGIN  
   IF @STATUS <> ''  
   BEGIN  
    SET @STATUS = @STATUS + ', '  
   END  
   SET @STATUS = @STATUS + @SETT_NO + '-' + @SETT_TYPE + '-' + CONVERT(VARCHAR,@VNO)  
  END  
  
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO, @SETT_TYPE  
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 IF @STATUS <> ''  
 BEGIN  
  SET @STATUS = 'VALAN POSTED SUCCESSFULLY FOR SETTLEMENT : ' + @STATUS  
  INSERT INTO TBL_MFSS_POST_STATUS VALUES (@BUSINESS_DATE, @STATUS)  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_ACCESSIBLEUSER
-- --------------------------------------------------




CREATE PROC [dbo].[CBO_ACCESSIBLEUSER]
	@REPORTCODE INT,
	@USERCATEGORY VARCHAR(2000)
AS
/*
	CBO_ACCESSIBLEUSER 945, 388
*/

IF (SELECT COUNT(1) FROM TBLCATMENU WHERE FLDREPORTCODE = @REPORTCODE AND FLDCATEGORYCODE LIKE '%' + @USERCATEGORY + '%') > 0
	SELECT ALLOWED = 1
ELSE
	SELECT ALLOWED = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9S52WJ619S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_03032025
-- --------------------------------------------------

create PROC [dbo].[CHECKVERSION_03032025]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '7=!9U92WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_03052012
-- --------------------------------------------------
CREATE PROC [DBO].[CHECKVERSION_03052012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '7=99S52WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_04MAY2024_ORE_3655
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_04MAY2024_ORE_3655]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '7=99U62WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_07022014
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0=>9S62WJ739S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_07Oct2023
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '5,/9T62WJ649S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_08012018
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '0=>9S42WJ7Z9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_08082016
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '5,/9S22WJ719S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_09012010
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'
SET @ERRCODE2 = '0=>9U22WJ7X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.checkversion_11JAN2010
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'
SET @ERRCODE2 = '0=>9T02WJ7X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_12012019
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '0=>9S52WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_12072011
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_12072011]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '0/*9T52WJ769S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_12092020
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '1;$9S52WJ6X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_12FEB2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '/;,9T02WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_13012015
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0=>9T42WJ729S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_13042011
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_13042011]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '<<!9T52WJ769S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_14072015
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0/*9T32WJ729S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_15042015
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '<<!9T32WJ729S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16072014
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '<<!9S52WJ739S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16072018
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '</{9U72WJ7Z9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16102012
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_16102012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '5,/9S42WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16102014
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '5,/9T32WJ739S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16102019
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '5,/9S52WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17012020
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '0=>9T32WJ6X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17042010
-- --------------------------------------------------




  
CREATE PROC [DBO].[CHECKVERSION_17042010]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '<<!9T42WJ7X9S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17072012
-- --------------------------------------------------


  
CREATE PROC [DBO].[CHECKVERSION_17072012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '0/*9S32WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17072018
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@'
SET @ERRCODE2 = '5,/9S42WJ7Z9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17102015
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '5,/9S72WJ729S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_20042012
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_20042012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '<<!9S02WJ759S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_20042021
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '<<!9S72WJ669S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_21042017
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '<<!9S22WJ7 9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_21042025
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_21042025]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9S42WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_21082014
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '5,/9T32WJ739S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_22042019
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '7=99U72WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_22102013
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '5,/9S52WJ749S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_23042018
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '7=99U62WJ7Z9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_23Oct2018
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '5,/9S42WJ7Z9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_24042023
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '<<!9R12WJ649S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_24072013
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_24072013]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '0/*9S42WJ749S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_24072017
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '0/*9S22WJ7 9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_24102016
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '5,/9S22WJ719S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_25072020
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '0/*9S62WJ6X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_25102017
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@Z'
SET @ERRCODE2 = '6>.9U72WJ7 9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_26042013
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_26042013]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '<<!9S42WJ749S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_26072016
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0/*9R12WJ719S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_26082013
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_26082013]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '</{9R02WJ749S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_26102024
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_26102024]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '5,/9S42WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_27012016
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0=>9R12WJ719S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_28012021
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '0=>9R12WJ669S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_28042016
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '<<!9R12WJ719S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_28052013
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_28052013]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'  
SET @ERRCODE2 = '7=99R02WJ749S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '7''\@'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J267'  
SET @ERRCODE11 = 'N'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'SY'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_28052021
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '7=99S22WJ669S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_29102020
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '5,/9R02WJ6X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_29Jun2023
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '0/*9U92WJ649S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_30042020
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '7=99U92WJ6X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.checkversion_31122009
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'
SET @ERRCODE2 = '!;:9R02WJYY9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_31may2025
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_31may2025]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '0/>9U02WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_04Apr2022
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '<<!9R12WJ659S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_11MAR2024
-- --------------------------------------------------

CREATE PROC [dbo].[CHECKVERSION_BKUP_11MAR2024]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '7=!9T12WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_15Apr2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9T72WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_16DEC2023
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '0=>9S32WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_bkup_18Jun22
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '0/*9U82WJ659S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_20JAN2025
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '0=>9T22WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_24APR22
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '<<!9R12WJ659S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_26FEB2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '/;,9S62WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_28Jan2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '0=>9S32WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_MAY122011
-- --------------------------------------------------

CREATE PROC [dbo].[CHECKVERSION_MAY122011]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@5!W'
SET @ERRCODE2 = '7=99T72WJ769S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '7''\@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J267'
SET @ERRCODE11 = 'N'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SY'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Citrus_bank_migration
-- --------------------------------------------------

CREATE pROC [dbo].[Citrus_bank_migration]
AS
 
 SELECT PARTY_CODE,BANKID=MAX(P.BANKID),AC_NO,AC_TYPE = CASE WHEN AC_TYPE ='SAVING' THEN'SB' ELSE'CB' END,AC_NAME, DEF,
 EXCAHNGE ='BSE',SEGMENT ='MFSS'        
INTO #MF_MULTIBANKID        
FROM AngelNseCM.MSAJAG.DBO.MIG_CITRUS_MULTIBANK_TMP M With(NOLOCK) ,BSEMFSS.DBO.POBANK P (NOLOCK)        
WHERE P.BANK_NAME = M.BANK_NAME AND P.BRANCH_NAME = M.BRANCH_NAME        
AND NOT EXISTS (SELECT CLTCODE FROM BBO_FA.DBO.MULTIBANKID A WHERE A.CLTCODE = PARTY_CODE        
     /*AND A.BANKID =  CONVERT(VARCHAR,BANKID)*/ AND A.ACCNO = AC_NO)        
GROUP BY PARTY_CODE,AC_NO,CASE WHEN AC_TYPE ='SAVING' THEN'SB' ELSE'CB' END,AC_NAME, DEF        
     
          
INSERT INTO BBO_FA.DBO.MULTIBANKID(CLTCODE,BANKID, ACCNO, ACCTYPE, CHEQUENAME, DEFAULTBANK,EXCHANGE,SEGMENT)      
SELECT * FROM #MF_MULTIBANKID B       

 UPDATE M        
SET DEFAULTBANK = 0  
FROM AngelNseCM.MSAJAG.DBO.MIG_CITRUS_MULTIBANK_TMP A,        
BBO_FA.DBO.MULTIBANKID M   
WHERE  M.CLTCODE = A.PARTY_CODE And Accno<>AC_NO  And M.cltcode in (Select Party_code  from #MF_MULTIBANKID) and def<>1
and exchange='BSE'
 
    
 UPDATE M      
SET DEFAULTBANK = 1       
FROM AngelNseCM.MSAJAG.DBO.MIG_CITRUS_MULTIBANK_TMP A,       
BBO_FA.DBO.MULTIBANKID M       
WHERE  def=1 and M.CLTCODE = A.PARTY_CODE AND A.AC_NO = M.ACCNO       AND DEFAULTBANK <>1
And M.cltcode in (Select Party_code  from #MF_MULTIBANKID) and exchange='BSE'
          
 UPDATE M SET BANK_NAME = C.BANK_NAME, BANK_BRANCH = C.BRANCH_NAME, BANK_CITY = C.BRANCH_NAME, ACC_NO = AC_NO, MICR_NO = MICR  
FROM BSEMFSS.DBO.MFSS_CLIENT M, AngelNseCM.MSAJAG.DBO.MIG_CITRUS_MULTIBANK_TMP  C        
WHERE M.PARTY_CODE = C.PARTY_CODE   AND ACC_NO <> AC_NO  AND DEF = 1  
And M.PARTY_CODE in (Select Party_code  from #MF_MULTIBANKID)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_ADD_PROCESS_CONTROL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLASS_AUTO_ADD_PROCESS_CONTROL]  
(  
 @USERID VARCHAR(25),  
 @EXCH_SEGMENT VARCHAR(100),  
 @PROCESS_TYPE VARCHAR(500),  
 @EDIT_ON VARCHAR(500),  
 @ADDED_BY VARCHAR(50),  
 @SERVER  VARCHAR(500)  
)  
AS  
---exec CLASS_AUTO_ADD_PROCESS_CONTROL @USERID='A0001',@EXCH_SEGMENT='PRIMARY-NSE-CAPITAL',@PROCESS_TYPE='COLLATERAL~DELIVERY~SETTLEMENT~',@SERVER='[MTSRVR06\DEV].Msajag.dbo.',@ADDED_BY='123456'  
DECLARE @SQL VARCHAR(MAX)  
BEGIN   
  
 SET @SQL = " DELETE FROM TBL_AUTO_PROCESS_CONTROL_MASTER WHERE USERID='" + LTRIM(UPPER(@USERID)) + "' AND EXCH_SEGMENT = '" + LTRIM(UPPER(@EXCH_SEGMENT)) + "'"  
 EXEC(@SQL)  
   
 SET @SQL = " INSERT INTO TBL_AUTO_PROCESS_CONTROL_MASTER VALUES('"+ LTRIM(UPPER(@USERID)) + "','" + LTRIM(UPPER(@EXCH_SEGMENT))+ "','" + LTRIM(UPPER(@PROCESS_TYPE)) + "','" + @EDIT_ON + "','" + @ADDED_BY + "',GETDATE())"  
 EXEC(@SQL)  
   
 SET @SQL = " DELETE FROM " + @SERVER + "TBL_AUTO_PROCESS_CONTROL_MASTER WHERE USERID='" + LTRIM(UPPER(@USERID)) + "' AND EXCH_SEGMENT = '" + LTRIM(UPPER(@EXCH_SEGMENT)) + "'"  
 EXEC(@SQL)  
   
 SET @SQL = " INSERT INTO " + @SERVER + "TBL_AUTO_PROCESS_CONTROL_MASTER VALUES('"+ LTRIM(UPPER(@USERID)) + "','" + LTRIM(UPPER(@EXCH_SEGMENT))+ "','" + LTRIM(UPPER(@PROCESS_TYPE)) + "','" + @EDIT_ON + "','" + @ADDED_BY + "',GETDATE())"  
 EXEC(@SQL)  
   
 SELECT ERRCODE='0',MESSAGETEXT='Master Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_BLOCK_PROCESS
-- --------------------------------------------------
CREATE PROCEDURE CLASS_AUTO_BLOCK_PROCESS  
(  
 @BLOCK_PROCESS VARCHAR(500),  
 @USERID VARCHAR(25)  
)  
AS  
--exec CLASS_AUTO_BLOCK_PROCESS @BLOCK_PROCESS='COLLATERAL,1~TRADE,1~'   
BEGIN  
  CREATE TABLE #PROCESSDATA (FDATA VARCHAR(MAX))    
  INSERT INTO #PROCESSDATA     
  SELECT * FROM dbo.fnSplitString2Tbl(@BLOCK_PROCESS,'~')   
    
  INSERT INTO TBL_AUTO_PROCESS_BLOCK_DET_LOG  
  SELECT *,@USERID,GETDATE() FROM TBL_AUTO_PROCESS_BLOCK_DET  
    
  DELETE FROM TBL_AUTO_PROCESS_BLOCK_DET  
    
  INSERT INTO TBL_AUTO_PROCESS_BLOCK_DET   
  SELECT LTRIM(RTRIM(.dbo.PIECE(FDATA, ',', 1))),LTRIM(RTRIM(.dbo.PIECE(FDATA, ',', 2))),@USERID,GETDATE() FROM #PROCESSDATA WHERE FDATA<>''  
    
     
  SELECT ERRCODE='0',MESSAGETEXT='Process Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_GET_PROCESS_CONTROL
-- --------------------------------------------------
CREATE procedure CLASS_AUTO_GET_PROCESS_CONTROL  
(  
 @USERID VARCHAR(25)  
)  
AS  
BEGIN  
 SELECT * FROM TBL_AUTO_PROCESS_CONTROL_MASTER WHERE USERID=@USERID  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_ALERT
-- --------------------------------------------------

CREATE PROC [dbo].[CLASS_AUTO_PROCESS_ALERT]      
AS      
      
DECLARE @SNO NUMERIC(18,0),      
  @EXCHANGE VARCHAR(3),      
  @SEGMENT VARCHAR(7),      
  @BUSINESS_DATE VARCHAR(11),      
  @PROCESS_FOR VARCHAR(30),      
  @PROCESS_STATUS INT,      
  @PROCESS_START_DATE DATETIME,      
  @PROCESS_HALTED_REASON VARCHAR(500),      
  @PROCESS_FILE_NAME VARCHAR(500),      
  @SETT_NO  VARCHAR(10),      
  @SETT_TYPE  VARCHAR(10),      
  @TO_EMAIL_ID VARCHAR(500),      
  @CC_EMAIL_ID VARCHAR(500),      
  @BCC_EMAIL_ID VARCHAR(500),      
  @ALERT_CURSOR CURSOR,      
  @BODYTEXT  VARCHAR(MAX),      
  @SUBJECTTEXT    VARCHAR(MAX),      
  @PROCESS_OUTPUT_QUERY VARCHAR(MAX),      
  @XML NVARCHAR(MAX),      
  @INTERNAL_PROCESS_ID INT,      
  @ATTACHEMENT_FILE_NAME VARCHAR(200),      
  @FILE_DWLOAD_LOCATION VARCHAR(200),      
  @FILE_DWLOAD_NAME  VARCHAR(200),  
  @SQL VARCHAR(MAX),  
  @RECCOUNT INT     
  
  
DECLARE @PROCESS_GROUP VARCHAR(100),  
  @PROCESSCUR  CURSOR,  
  @PROCESS_CNT INT,  
  @PROCESS_STATUS_CNT INT  
    
DECLARE @PDATE DATETIME  
SET @PDATE = GETDATE()  
      
OPEN SYMMETRIC KEY   Key4CertAutoProcess      
     DECRYPTION BY   CERTIFICATE CertAutoProcess       
     
SET @ALERT_CURSOR = CURSOR FOR      
SELECT SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, D.PROCESS_FOR, PROCESS_STATUS, PROCESS_START_DATE,       
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(.DBO.FN_DATA_DECRYPT('MKTTECH.IN',D.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
PROCESS_HALTED_REASON = (CASE WHEN PROCESS_STATUS = 99       
         THEN (CASE WHEN PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME < @PDATE THEN 'PROCESS IS STILL GOING ON, PLEASE CHECK - STARTED AT - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE) + ' AND EXPECTED END - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME) + ' AND CHECKED AT ' + CONVERT(VARCHAR,@PDATE)   
         ELSE 'NOACTION' END)      
         WHEN PROCESS_STATUS = 0 AND PROCESS_HALTED_REASON = ''      
         THEN 'NOT YET STARTED'      
         ELSE PROCESS_HALTED_REASON END),    
TO_EMAIL_ID, CC_EMAIL_ID, BCC_EMAIL_ID,       
--TO_EMAIL_ID=CC_EMAIL_ID, CC_EMAIL_ID = '', BCC_EMAIL_ID = '',    
PROCESS_OUTPUT_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(D.PROCESS_OUTPUT_QUERY,BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
D.SETT_NO, LTRIM(RTRIM(D.SETT_TYPE)), INTERNAL_PROCESS_ID, ATTACHEMENT_FILE_NAME      
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL E, OWNER      
WHERE PROCESS_DATE = LEFT(@PDATE,11)      
AND D.EXCHANGE = E.EXCHANGE      
AND D.SEGMENT = E.SEGMENT      
AND D.PROCESS_FOR = E.PROCESS_FOR      
AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT       
AND @PDATE >= PROCESS_LAST_ALERT_DATE + ' ' + PROCESS_STATUS_ALERT_INTERVAL      
AND (D.PROCESS_START_DATE <= @PDATE + D.WAIT_PERIOD      
OR D.PROCESS_START_DATE <= @PDATE)      
AND 1 = (CASE WHEN PROCESS_STATUS = 0 AND PROCESS_HALTED_REASON = ''       
        THEN 0       
     ELSE 1      
   END)      
AND (CASE WHEN PROCESS_STATUS = 99       
         THEN (CASE WHEN PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME < @PDATE THEN 'PROCESS IS STILL GOING ON, PLEASE CHECK - STARTED AT - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE) + ' AND EXPECTED END - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME) + ' AND CHECKED AT ' + CONVERT(VARCHAR,@PDATE)   
         ELSE 'NOACTION' END)      
         ELSE PROCESS_HALTED_REASON END) <> 'NOACTION'      
AND IS_DEPEND_ON = ''      
AND EMAIL_SEND_FLAG = 1  
AND PROCESS_HALTED_REASON NOT LIKE 'CAN NOT START THE%'   
AND 1 = (CASE WHEN PROCESS_STATUS = 100 AND PROCESS_OUTPUT_QUERY = '' AND ATTACHEMENT_FILE_NAME = ''  
     THEN 0  
     ELSE 1   
   END)  
AND PROCESS_STARTED_DATE LIKE LEFT(@PDATE,11) + '%'  
ORDER BY SNO      
OPEN @ALERT_CURSOR      
FETCH NEXT FROM @ALERT_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FOR, @PROCESS_STATUS, @PROCESS_START_DATE, @PROCESS_FILE_NAME,       
       @PROCESS_HALTED_REASON, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID, @PROCESS_OUTPUT_QUERY, @SETT_NO, @SETT_TYPE, @INTERNAL_PROCESS_ID,       
    @ATTACHEMENT_FILE_NAME      
WHILE @@FETCH_STATUS = 0      
BEGIN      
/*  
 SET @TO_EMAIL_ID = 'animesh.jain@mkttech.in'  
 SET @CC_EMAIL_ID = ''  
 SET @BCC_EMAIL_ID = ''  
*/  
  SET @BODYTEXT = 'Live SERVER - ALERT STATUS OF ' + @PROCESS_FOR + ' FOR THE EXCHANGE ' + @EXCHANGE + ' AND SEGMENT ' + @SEGMENT           
 IF LEN(@SETT_NO) <> ''           
 BEGIN          
  SET @BODYTEXT = @BODYTEXT + ' SETT NO - ' + CONVERT(VARCHAR,@SETT_NO) + ' AND SETT TYPE - ' + CONVERT(VARCHAR,@SETT_TYPE)          
 END          
 --SET @BODYTEXT = @BODYTEXT + ' FOR THE PROCESS NO - ' + CONVERT(VARCHAR,@SNO)          
 SET @SUBJECTTEXT = @BODYTEXT          
 SET @BODYTEXT = @BODYTEXT + ' <BR> ' + @PROCESS_HALTED_REASON           
 IF LEN(@PROCESS_FILE_NAME) > 0           
 BEGIN           
  IF @PROCESS_FILE_NAME NOT LIKE '%#%'          
  BEGIN          
   SET @BODYTEXT = @BODYTEXT + ' AS PER THE FILE ' + @PROCESS_FILE_NAME          
  END          
  ELSE          
  BEGIN          
   SELECT           
   @FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),          
   @FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE)))          
   FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK),           
   TBL_AUTO_PROCESS_MASTER M,           
   OWNER O          
   WHERE PROCESS_DATE = LEFT(@PDATE,11)          
   AND D.PROCESS_FOR = M.PROCESS_FOR          
   AND D.SNO = @SNO          
   SET @BODYTEXT = @BODYTEXT + ' NO NEW FILE PRESENT IN LOCATION ' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME          
  END          
 END           
          
 IF (@PROCESS_OUTPUT_QUERY <> '' AND @PROCESS_STATUS <> 0) OR @ATTACHEMENT_FILE_NAME <> ''      
 BEGIN            
  --SET @PROCESS_OUTPUT_QUERY = 'EXECUTE SaveTableAsHTML @DBFetch = ''' + replace(@PROCESS_OUTPUT_QUERY,'''','''''') + ''''           
          
  --SET @PROCESS_OUTPUT_QUERY = ''''+replace(@PROCESS_OUTPUT_QUERY,'''','''''')+''''          
  --PRINT @PROCESS_OUTPUT_QUERY          
            
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO          
   AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT) > 0          
  BEGIN          
           
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS_ALERT_COUNT = PROCESS_STATUS_ALERT_COUNT + 1, PROCESS_LAST_ALERT_DATE = @PDATE          
   WHERE SNO = @SNO         
          
  SELECT @RECCOUNT = 1      
        
  IF @PROCESS_STATUS = 100 AND @ATTACHEMENT_FILE_NAME = ''      
  BEGIN      
 SET @SQL = ' DECLARE @RECCNT NUMERIC(18,0) '      
 SET @SQL = @SQL + ' SELECT @RECCNT = ISNULL(COUNT(1),0) FROM (' + @PROCESS_OUTPUT_QUERY + ' ) A '      
 SET @SQL = @SQL + ' IF (@RECCNT) <= 0 '                
    SET @SQL = @SQL + ' BEGIN '                
    SET @SQL = @SQL + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_OUTPUT_QUERY = '''' '                
    SET @SQL = @SQL + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100 '      
    SET @SQL = @SQL + ' END '                
 EXEC (@SQL)       
       
 SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO AND PROCESS_OUTPUT_QUERY <> ''      
  END      
  IF @RECCOUNT > 0      
  BEGIN      
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO          
   AND PROCESS_STATUS_ALERT >= PROCESS_STATUS_ALERT_COUNT) > 0       
  BEGIN          
    
   exec SpCustomTable2HTML @PROCESS_OUTPUT_QUERY, @XML OUTPUT, ' border="1" cellpadding="2" cellspacing="0" style="font-size:14px";', ' style="color:blue;background-color:yellow;"'          
   --SELECT ISNULL(@XML,'')          
   SET @BODYTEXT = @BODYTEXT + ISNULL(@XML,'')          
        
 EXEC MSDB.DBO.SP_SEND_DBMAIL           
    @profile_name= 'CLASS AUTO PROCESS Test Profile',          
    @RECIPIENTS=@TO_EMAIL_ID,          
    @BODY=@BODYTEXT,           
    @copy_recipients = @CC_EMAIL_ID,           
    @blind_copy_recipients = @BCC_EMAIL_ID,          
    @subject = @SUBJECTTEXT,          
    @body_format = 'HTML',          
    @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME       
   END        
  END      
  END          
 END          
 ELSE          
 BEGIN          
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO          
   AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT) > 0          
  BEGIN          
        
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS_ALERT_COUNT = PROCESS_STATUS_ALERT_COUNT + 1, PROCESS_LAST_ALERT_DATE = @PDATE          
 WHERE SNO = @SNO          
        
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO          
   AND PROCESS_STATUS_ALERT >= PROCESS_STATUS_ALERT_COUNT) > 0          
  BEGIN          
    EXEC MSDB.DBO.SP_SEND_DBMAIL           
    @profile_name= 'CLASS AUTO PROCESS Test Profile',          
    @RECIPIENTS=@TO_EMAIL_ID,          
    @BODY=@BODYTEXT,           
    @copy_recipients = @CC_EMAIL_ID,           
    @blind_copy_recipients = @BCC_EMAIL_ID,          
    @subject = @SUBJECTTEXT,          
    @body_format = 'HTML',          
    @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME       
 END        
  END          
 END          
         
 FETCH NEXT FROM @ALERT_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FOR, @PROCESS_STATUS, @PROCESS_START_DATE, @PROCESS_FILE_NAME,           
           @PROCESS_HALTED_REASON, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID, @PROCESS_OUTPUT_QUERY, @SETT_NO, @SETT_TYPE, @INTERNAL_PROCESS_ID,           
     @ATTACHEMENT_FILE_NAME           
END          
CLOSE @ALERT_CURSOR          
DEALLOCATE @ALERT_CURSOR          
      
SET @ATTACHEMENT_FILE_NAME = ''      
      
SET @PROCESSCUR = CURSOR FOR      
SELECT EXCHANGE, SEGMENT, PROCESS_GROUP,       
    TO_EMAIL_ID = MAX(TO_EMAIL_ID),       
    CC_EMAIL_ID = MAX(CC_EMAIL_ID),       
    BCC_EMAIL_ID = MAX(BCC_EMAIL_ID)      
FROM TBL_AUTO_PROCESS_EMAIL_GRP E      
WHERE NOT EXISTS (SELECT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG L      
      WHERE L.PROCESS_DATE = LEFT(@PDATE,11)      
      AND E.PROCESS_GROUP = L.PROCESS_GROUP )          
GROUP BY EXCHANGE, SEGMENT, PROCESS_GROUP      
ORDER BY 1      
OPEN @PROCESSCUR      
FETCH NEXT FROM @PROCESSCUR INTO @EXCHANGE, @SEGMENT, @PROCESS_GROUP, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID      
WHILE @@FETCH_STATUS = 0       
BEGIN      
/*      
 SET @TO_EMAIL_ID = 'animesh.jain@mkttech.in'      
 SET @CC_EMAIL_ID = ''      
 SET @BCC_EMAIL_ID = ''      
*/      
       
 SELECT @PROCESS_STATUS_CNT = ISNULL(SUM(CASE WHEN PROCESS_STATUS = 100 THEN 1 ELSE 0 END),0),       
     @PROCESS_CNT = ISNULL(COUNT(1),0)      
 FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL_GRP E, OWNER          
 WHERE PROCESS_DATE = LEFT(@PDATE,11)          
 AND D.EXCHANGE = E.EXCHANGE          
 AND D.SEGMENT = E.SEGMENT          
 AND D.PROCESS_FOR = E.PROCESS_FOR          
 AND PROCESS_GROUP = @PROCESS_GROUP       
 AND NOT EXISTS (SELECT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG L      
      WHERE D.PROCESS_DATE = L.PROCESS_DATE       
      AND E.PROCESS_GROUP = L.PROCESS_GROUP )      
            
 IF @PROCESS_CNT = @PROCESS_STATUS_CNT AND @PROCESS_CNT > 0        
 BEGIN      
  SELECT PROCESS_ORDER_ID, BUSINESS_DATE = CONVERT(VARCHAR,BUSINESS_DATE,103),       
  PROCESS_GROUP,D.PROCESS_FOR, D.SETT_NO, SETT_TYPE=LTRIM(RTRIM(D.SETT_TYPE)),       
  EXPECTED_START_TIME = CONVERT(VARCHAR,PROCESS_START_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_START_DATE,108),           
  ACTUAL_START_TIME = CONVERT(VARCHAR,PROCESS_STARTED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE,108),           
  EXPECTED_END_TIME = CONVERT(VARCHAR,PROCESS_END_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_END_DATE,108),           
  ACTUAL_END_TIME = CONVERT(VARCHAR,PROCESS_ENDED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_ENDED_DATE,108),           
  PROCESS_FILE_NAME = PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(.DBO.FN_DATA_DECRYPT('MKTTECH.IN',D.PROCESS_FILE_NAME),      
  BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),          
  PROCESS_HALTED_REASON,         
  ATTACHEMENT_FILE_NAME      
  INTO #TEMP          
  FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL_GRP E, OWNER          
  WHERE PROCESS_DATE = LEFT(@PDATE,11)          
  AND D.EXCHANGE = E.EXCHANGE          
  AND D.SEGMENT = E.SEGMENT          
  AND D.PROCESS_FOR = E.PROCESS_FOR          
  AND PROCESS_STATUS = 100      
  AND PROCESS_GROUP = @PROCESS_GROUP       
  AND NOT EXISTS (SELECT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG L      
        WHERE D.PROCESS_DATE = L.PROCESS_DATE       
        AND E.PROCESS_GROUP = L.PROCESS_GROUP )      
  ORDER BY PROCESS_ORDER_ID        
        
  SET @SUBJECTTEXT = @EXCHANGE + '-' + @SEGMENT + ' Live SERVER - ' + @PROCESS_GROUP + ' COMPLETE PROCESS STATUS FOR THE DAY ' +  CONVERT(VARCHAR,@PDATE,103)      
        
  SET @BODYTEXT = @SUBJECTTEXT + '<BR>'      
        
  SET @SQL = 'SELECT * FROM #TEMP '      
  exec SpCustomTable2HTML @SQL, @XML OUTPUT, ' border="1" cellpadding="2" cellspacing="0" style="font-size:14px";', ' style="color:blue;background-color:yellow;"'          
  SET @BODYTEXT = @BODYTEXT + ISNULL(@XML,'')          
      
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG       
   WHERE PROCESS_DATE = LEFT(@PDATE,11) AND PROCESS_GROUP = @PROCESS_GROUP ) = 0       
  BEGIN      
   INSERT INTO TBL_AUTO_PROCESS_EMAIL_GROUP_LOG       
   SELECT LEFT(@PDATE,11), @PROCESS_GROUP, GETDATE()      
          
   EXEC MSDB.DBO.SP_SEND_DBMAIL           
   @profile_name= 'CLASS AUTO PROCESS Test Profile',          
   @RECIPIENTS=@TO_EMAIL_ID,          
   @BODY=@BODYTEXT,           
   @copy_recipients = @CC_EMAIL_ID,           
   @blind_copy_recipients = @BCC_EMAIL_ID,          
   @subject = @SUBJECTTEXT,          
   @body_format = 'HTML',          
   @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME       
  END      
  DROP TABLE #TEMP      
 END      
       
 FETCH NEXT FROM @PROCESSCUR INTO @EXCHANGE, @SEGMENT, @PROCESS_GROUP, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID      
END      
CLOSE @PROCESSCUR      
DEALLOCATE @PROCESSCUR      
          
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_BULK_UPDATE
-- --------------------------------------------------

create PROCEDURE [dbo].[CLASS_AUTO_PROCESS_BULK_UPDATE]   
(  
 @UPD_DATA VARCHAR(MAX)  
)  
--NEWDATA~NEWDATA~NEWDATA~OLDDATA~OLDDATA~OLDDATA|  
AS  
--exec CLASS_AUTO_PROCESS_BULK_UPDATE @UPD_DATA='ftp.connect2nse.com~10412~Most@123~FTP.CONNECT2NSE.COM~10412~MOST@123|FTP.CONNECT2NSE.COM~10412~MOST@123~ftp.connect2nse.com~10412~Most@123|NEWDATA~NEWDATA~NEWDATA~OLDDATA~OLDDATA~OLDDATA|'  
BEGIN  
  
 DECLARE @RECNO INT,  
   @OLDFILE_DWLOAD_LOCATION VARCHAR(MAX),  
   @OLDFILE_DWLOAD_USERID  VARCHAR(MAX),  
   @OLDFILE_DWLOAD_PWD   VARCHAR(MAX),  
  
   @NEWFILE_DWLOAD_LOCATION VARCHAR(MAX),  
   @NEWFILE_DWLOAD_USERID  VARCHAR(MAX),  
   @NEWFILE_DWLOAD_PWD   VARCHAR(MAX)  
  
  
 SET @RECNO = 1  
  
 OPEN SYMMETRIC KEY   Key4CertAutoProcess            
   DECRYPTION BY   CERTIFICATE CertAutoProcess  
  
 WHILE ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),'') <> ''  
 BEGIN  
  SELECT      
   @NEWFILE_DWLOAD_LOCATION = .DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',1),  
   @NEWFILE_DWLOAD_USERID = .DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',2),  
   @NEWFILE_DWLOAD_PWD = .DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',3),  
   @OLDFILE_DWLOAD_LOCATION = ISNULL(.DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',4),''),  
   @OLDFILE_DWLOAD_USERID = ISNULL(.DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',5),''),  
   @OLDFILE_DWLOAD_PWD = ISNULL(.DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',6),'')  
  
  UPDATE TBL_AUTO_PROCESS_MASTER SET  
  FILE_DWLOAD_LOCATION=DBO.FN_DATA_ENCRYPT('MKTTECH.IN',@NEWFILE_DWLOAD_LOCATION),  
  FILE_DWLOAD_USERID=DBO.FN_DATA_ENCRYPT('MKTTECH.IN',@NEWFILE_DWLOAD_USERID),  
  FILE_DWLOAD_PWD=DBO.FN_DATA_ENCRYPT('MKTTECH.IN',@NEWFILE_DWLOAD_PWD)  
  WHERE DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION) = @OLDFILE_DWLOAD_LOCATION  
     AND DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID) = @OLDFILE_DWLOAD_USERID  
     AND DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD) = @OLDFILE_DWLOAD_PWD  
  
  SET @RECNO = @RECNO + 1   
 END  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;    
 SELECT ERRCODE='0',MESSAGETEXT='Process Completed Successfully'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EDIT_MASTER
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_EDIT_MASTER]   
(  
 @TYPE varchar(1),  
 @PROCESSFOR varchar(30),  
 @PROCESSTYPE varchar(30)  
)   
AS    
  
SELECT @PROCESSFOR = (CASE WHEN @PROCESSFOR = '' THEN '--SELECT--' ELSE @PROCESSFOR END)  
SELECT @PROCESSTYPE = (CASE WHEN @PROCESSTYPE = '' THEN '--SELECT--' ELSE @PROCESSTYPE END)  
-- EXEC CLASS_AUTO_PROCESS_EDIT_MASTER 'E', 'SELECT','SELECT'  
BEGIN    
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
 IF @TYPE='P'  
 BEGIN  
  SELECT     
   SNO,PROCESS_TYPE,PROCESS_FOR,    
   PROCESS_START_TIME = LEFT(PROCESS_START_TIME,5),      
   PROCESS_END_TIME = LEFT(PROCESS_END_TIME,5) ,    
   IS_FILE_BASED,  
   PROCESS_ORDER_ID,    
   FILE_DWLOAD_LOCATION=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION),    
   FILE_DWLOAD_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_NAME),    
   FILE_DWLOAD_USERID=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID),    
   FILE_DWLOAD_PWD=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),    
   FILE_DWLOAD_MAP_DRIVE,    
   PROCESS_FILE_PATH=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_PATH),    
   PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME),    
   PROCESS_FILE_MOVE_PATH =.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_MOVE_PATH)     
  FROM  TBL_AUTO_PROCESS_MASTER    
  WHERE PROCESS_FOR = (CASE WHEN @PROCESSFOR LIKE '%SELECT%' THEN PROCESS_FOR ELSE @PROCESSFOR END)  
  AND   PROCESS_TYPE = (CASE WHEN @PROCESSTYPE LIKE '%SELECT%' THEN PROCESS_TYPE ELSE @PROCESSTYPE END)  
  ORDER BY PROCESS_TYPE,PROCESS_ORDER_ID,IS_FILE_BASED    
 END  
 IF @TYPE='E'  
 BEGIN  
  SELECT E.PROCESS_FOR,TO_EMAIL_ID,CC_EMAIL_ID,BCC_EMAIL_ID,EMAIL_SEND_FLAG  FROM TBL_AUTO_PROCESS_EMAIL E,  
  TBL_AUTO_PROCESS_MASTER M  
  WHERE E.PROCESS_FOR = M.PROCESS_FOR  
  AND E.PROCESS_FOR = (CASE WHEN @PROCESSFOR LIKE '%SELECT%' THEN E.PROCESS_FOR ELSE @PROCESSFOR END)  
  AND PROCESS_TYPE = (CASE WHEN @PROCESSTYPE LIKE '%SELECT%' THEN PROCESS_TYPE ELSE @PROCESSTYPE END)  
 END  
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EDIT_MASTER_UPDATE
-- --------------------------------------------------
CREATE procedure [dbo].[CLASS_AUTO_PROCESS_EDIT_MASTER_UPDATE]  
(  
 @PROCESSDATA VARCHAR(MAX),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @UNAME VARCHAR(50),  
 @REQIP VARCHAR(200)  
)  
AS  
BEGIN  
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
 CREATE TABLE #DATA (FDATA VARCHAR(MAX))    
 INSERT INTO #DATA     
 SELECT * FROM dbo.fnSplitString2Tbl(@PROCESSDATA,'|')   
   
 UPDATE TBL_AUTO_PROCESS_MASTER SET     
  PROCESS_START_TIME = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 2))),  
  PROCESS_END_TIME = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 3))),  
  IS_FILE_BASED = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 4))),  
  FILE_DWLOAD_LOCATION = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 5)))),  
  FILE_DWLOAD_NAME = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 6)))),  
  FILE_DWLOAD_USERID = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 7)))),  
  FILE_DWLOAD_PWD = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 8)))),  
  FILE_DWLOAD_MAP_DRIVE = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 9))),  
  PROCESS_FILE_PATH  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 10)))),  
  PROCESS_FILE_NAME  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 11)))),  
  PROCESS_FILE_MOVE_PATH  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 12)))),  
  PROCESS_ORDER_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 13)))  
 FROM #DATA B    
 WHERE SNO = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 1)))  
 AND FDATA<>''  
  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;  
   
 SELECT ERRCODE='1',ERRDESC='Master Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EMAIL_MASTER_UPDATE
-- --------------------------------------------------
CREATE procedure CLASS_AUTO_PROCESS_EMAIL_MASTER_UPDATE  
(  
 @PROCESSDATA VARCHAR(MAX),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @UNAME VARCHAR(50),  
 @REQIP VARCHAR(200)  
)  
AS  
BEGIN  
 CREATE TABLE #DATA (FDATA VARCHAR(MAX))    
 INSERT INTO #DATA     
 SELECT * FROM dbo.fnSplitString2Tbl(@PROCESSDATA,'|')   
   
 UPDATE TBL_AUTO_PROCESS_EMAIL SET     
  TO_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 2))),  
  CC_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 3))),  
  BCC_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 4))),  
  EMAIL_SEND_FLAG = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 5)))  
 FROM #DATA B    
 WHERE PROCESS_FOR = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 1)))  
 AND FDATA<>''  
   
 SELECT ERRCODE='1',ERRDESC='Master Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_FILE
-- --------------------------------------------------
CREATE    PROC [dbo].[CLASS_AUTO_PROCESS_FILE] (@FILEPATH VARCHAR(200), @BUSINESS_DATE VARCHAR(11),
 @FLD_FILEDATE DATETIME OUTPUT, @FLD_FILENAME VARCHAR(200) OUTPUT)          

AS           

        

SET @FILEPATH = 'DIR "' +@FILEPATH + '" /C'     

    

CREATE TABLE #FILELIST           

( FILENAMELIST VARCHAR(200))          

INSERT INTO #FILELIST           

EXEC MASTER.DBO.XP_CMDSHELL @FILEPATH   

 
UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')    

WHERE FILENAMELIST IS NOT NULL    

AND FILENAMELIST LIKE '%'    

AND FILENAMELIST LIKE '%-%' 

 
SELECT FLD_FILEDATE=CONVERT(DATETIME,LEFT(CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),103),11) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',3))) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',4)))),    

FLD_FILENAME=LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1))))    

INTO #FILELISTNEW       

FROM #FILELIST     

WHERE FILENAMELIST IS NOT NULL    

AND FILENAMELIST LIKE '%'    

AND FILENAMELIST LIKE '%-%'    

AND LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1)))) LIKE '%.%' 





SELECT TOP 1 @FLD_FILEDATE = FLD_FILEDATE, @FLD_FILENAME = FLD_FILENAME FROM #FILELISTNEW N    

WHERE FLD_FILEDATE LIKE @BUSINESS_DATE + '%'    

AND FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE F    

       WHERE F.FLD_FILEDATE LIKE @BUSINESS_DATE + '%'    

       AND N.FLD_FILEDATE = F.FLD_FILEDATE)    

ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_FILE_test
-- --------------------------------------------------
CREATE    PROC [dbo].[CLASS_AUTO_PROCESS_FILE_test] (@FILEPATH VARCHAR(200), @BUSINESS_DATE VARCHAR(11),
 @FLD_FILEDATE DATETIME OUTPUT, @FLD_FILENAME VARCHAR(200) OUTPUT)          

AS      

SET @FILEPATH = 'DIR "' +@FILEPATH + '" /C'     

    

CREATE TABLE #FILELIST           

( FILENAMELIST VARCHAR(200))          

INSERT INTO #FILELIST           

EXEC MASTER.DBO.XP_CMDSHELL @FILEPATH   



UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')    

WHERE FILENAMELIST IS NOT NULL    

AND FILENAMELIST LIKE '%'    

AND FILENAMELIST LIKE '%/%' 


SELECT FLD_FILEDATE=CONVERT(DATETIME,LEFT(CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),101),11) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',3))) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',4)))),    

FLD_FILENAME=LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1))))    

INTO #FILELISTNEW       

FROM #FILELIST     

WHERE FILENAMELIST IS NOT NULL    

AND FILENAMELIST LIKE '%'    

AND FILENAMELIST LIKE '%/%'    

AND LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1)))) LIKE '%.%' 

select * from #FILELISTNEW



SELECT TOP 1 @FLD_FILEDATE = FLD_FILEDATE, @FLD_FILENAME = FLD_FILENAME FROM #FILELISTNEW N    

WHERE FLD_FILEDATE LIKE @BUSINESS_DATE + '%'    

AND FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE F    

       WHERE F.FLD_FILEDATE LIKE @BUSINESS_DATE + '%'    

       AND N.FLD_FILEDATE = F.FLD_FILEDATE)    

ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_LISNER
-- --------------------------------------------------









CREATE PROC [dbo].[CLASS_AUTO_PROCESS_LISNER] 
AS 

DECLARE 
  @SNO     NUMERIC(18,0),  
  @BUSINESS_DATE   VARCHAR(11),          
  @PROCESS_FOR   VARCHAR(30),          
  @FILE_DWLOAD_LOCATION VARCHAR(200),          
  @PROCESS_FILE_NAME  VARCHAR(200),          
  @PROCESS_FILE_NAME_NEW VARCHAR(200),          
  @FILE_DWLOAD_PATH VARCHAR(200),          
  @FILE_DWLOAD_USERID  VARCHAR(100),          
  @FILE_DWLOAD_PWD  VARCHAR(100), 
  @PROCESS_CURSOR   CURSOR, 
  @CMD                        VARCHAR(MAX), 
  @FLD_FILEDATE   DATETIME,          
  @FLD_FILENAME         VARCHAR(200), 
  @PROCESS_SET          VARCHAR(100), 
  @PROCESS_TYPE         VARCHAR(10), 
  @LST_CNT              INT, 
  @PRC_CNT              INT, 
  @MFSETT   VARCHAR(7), 
  @PREV_DATE   VARCHAR(11)       

SELECT * INTO #FILEDATA 
FROM TBL_AUTO_PROCESS_FILE 
WHERE PROCESS_ON LIKE LEFT(GETDATE(),11) + '%' 

UPDATE TBL_AUTO_PROCESS_LISNER_LOG SET PROCESS_FLAG = 2 
FROM #FILEDATA F 
WHERE TBL_AUTO_PROCESS_LISNER_LOG.BUSINESS_DATE = LEFT(FLD_FILEDATE,11) 
AND PROCESS_FILE_NAME = FLD_FILENAME 

OPEN SYMMETRIC KEY   KEY4CERTAUTOPROCESS          
     DECRYPTION BY   CERTIFICATE CERTAUTOPROCESS   
SET @PROCESS_CURSOR = CURSOR FOR 
SELECT D.SNO, L.PROCESS_FOR, L.PROCESS_TYPE, 
PROCESS_FILE_NAME = PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(L.PROCESS_FILE_NAME,BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))), 
BUSINESS_DATE = LEFT(BUSINESS_DATE,11), 
FILE_DWLOAD_LOCATION=PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(L.PROCESS_FILE_PATH,BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))), 
FILE_COPY_LOCATION=PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))), 
FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), 
FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD), 
PROCESS_SET 
FROM TBL_AUTO_PROCESS_LISNER L, TBL_AUTO_PROCESS_DETAIL D, TBL_AUTO_PROCESS_MASTER M, OWNER 
WHERE PROCESS_DATE = LEFT(GETDATE(),11) 
AND L.PROCESS_FOR = D.PROCESS_FOR 
AND L.PROCESS_FOR = M.PROCESS_FOR 
AND L.PROCESS_FOR NOT IN (SELECT P.PROCESS_FOR FROM TBL_AUTO_PROCESS_LISNER_LOG P WHERE P.BUSINESS_DATE = D.BUSINESS_DATE 
                                    AND P.PROCESS_FOR = D.PROCESS_FOR AND PROCESS_FLAG = 1) 
AND (D.IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100) 
AND GETDATE() BETWEEN CONVERT(DATETIME, LEFT(GETDATE(),11) + ' ' + L.PROCESS_START_TIME) AND CONVERT(DATETIME, LEFT(GETDATE(),11) + ' ' + L.PROCESS_END_TIME) 
AND L.PROCESS_TYPE IN ('F', 'C') AND PROCESS_FREQ = 'RECCUR' 
--AND D.sno = 79 
--and d.process_for = 'PREV ORDER FILE'


OPEN @PROCESS_CURSOR 
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET 
WHILE @@FETCH_STATUS = 0 
BEGIN 
      SELECT @LST_CNT = 0 
      SELECT @PRC_CNT = 0 

      SELECT @MFSETT = '' 
      -----PRINT  @PROCESS_FILE_NAME 
      
     
      IF (CASE WHEN (@PROCESS_FILE_NAME LIKE '%<MFSETT>%')  
                    THEN 1 ELSE 0 END) = 1 
      BEGIN 
            SELECT @MFSETT = SETT_NO FROM  SETT_MST WHERE START_DATE LIKE @BUSINESS_DATE + '%' 
            
            --PRINT @MFSETT
           

            SET @PROCESS_FILE_NAME = REPLACE(@PROCESS_FILE_NAME,'<MFSETT>',@MFSETT) 
            
            --PRINT  @PROCESS_FILE_NAME
       END    
      
      IF (CASE WHEN (@PROCESS_FILE_NAME LIKE '%<PMFSETT>%')  
                    THEN 1 ELSE 0 END) = 1 
      BEGIN 
            SELECT @PREV_DATE = LEFT(ISNULL(MAX(SYSDATE),@BUSINESS_DATE),11) FROM AngelNseCM.MSAJAG.DBO.CLOSING            
            WHERE SYSDATE < @BUSINESS_DATE   

            SELECT @MFSETT = SETT_NO FROM  SETT_MST WHERE START_DATE LIKE @PREV_DATE + '%' 

            SET @PROCESS_FILE_NAME = REPLACE(@PROCESS_FILE_NAME,'<PMFSETT>',@MFSETT) 
      END 

      --SELECT @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET 

      SELECT @LST_CNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_LISNER L WHERE PROCESS_SET = @PROCESS_SET AND PROCESS_TYPE = '' 

      SELECT @PRC_CNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_LISNER L, TBL_AUTO_PROCESS_DETAIL D 
      WHERE PROCESS_DATE = LEFT(GETDATE(),11) 
      AND L.PROCESS_FOR = D.PROCESS_FOR 
      AND PROCESS_SET = @PROCESS_SET AND L.PROCESS_TYPE = '' 
      AND (D.IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100) 
      --SELECT @LST_CNT , @PRC_CNT
      
      --PRINT  @LST_CNT 
      --PRINT @PRC_CNT
      
      
      IF @LST_CNT = @PRC_CNT 
      BEGIN 
    
            IF @PROCESS_TYPE = 'F' 
            BEGIN 
                
                  SET @FILE_DWLOAD_PATH = REPLACE(@FILE_DWLOAD_PATH, '\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-'),'') 

                  set @cmd = 'exec xp_cmdshell ''net use "' + @FILE_DWLOAD_PATH + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'          
                  exec (@cmd) 

                  SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @FILE_DWLOAD_PATH+'\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-') + ''', NO_OUTPUT'          
                  EXEC (@CMD)  



                  set @cmd = 'exec xp_cmdshell ''net use ' + @FILE_DWLOAD_PATH + ' /delete'', no_output'          
                  exec (@cmd)    

                  SET @FILE_DWLOAD_PATH = @FILE_DWLOAD_PATH+'\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-') 

                  set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_path + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'          
                  exec (@cmd) 
            END 
            
            IF RIGHT(LEFT(@file_dwload_location,2),1) <> ':' 
            BEGIN 
                  set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_location + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' ' --, no_output'          
                  exec (@cmd) 
            END 
            
            SET @PROCESS_FILE_NAME_NEW = @file_dwload_location + '\' + @PROCESS_FILE_NAME   

            set @FLD_FILENAME = '' 
            EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT               
            
            --SELECT @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE 
            --select @FLD_FILENAME, 'ani' 

            IF ISNULL(@FLD_FILENAME,'') <> '' 
            BEGIN 
                  IF @PROCESS_TYPE = 'F' 
                  BEGIN 
                        SET @CMD = 'EXEC XP_CMDSHELL ''Copy ' + @file_dwload_location + '\' + @FLD_FILENAME + ' ' + @file_dwload_path + '\' + @FLD_FILENAME + ''', NO_OUTPUT'          
                        EXEC (@CMD)  

                        INSERT INTO TBL_AUTO_PROCESS_LISNER_LOG VALUES (@BUSINESS_DATE, @PROCESS_FOR, @FLD_FILENAME, 1, GETDATE()) 
                  END 

                  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON_ORG,'#-1,',''), PROCESS_STATUS = 0, 
                  PROCESS_HALTED_REASON = '', SUB_PROCESS_ID = 0 
                  FROM TBL_AUTO_PROCESS_LISNER L 
                  WHERE PROCESS_DATE = LEFT(GETDATE(),11) AND (IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100) 
                  AND L.PROCESS_FOR = TBL_AUTO_PROCESS_DETAIL.PROCESS_FOR 
                  AND PROCESS_SET = @PROCESS_SET 
            END 

            set @cmd = 'exec xp_cmdshell ''net use ' + @file_dwload_location + ' /delete'', no_output'          
            exec (@cmd)    

            set @cmd = 'exec xp_cmdshell ''net use ' + @file_dwload_path + ' /delete'', no_output'          
            exec (@cmd)   
      END 

      FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET 
END 
CLOSE @PROCESS_CURSOR 
DEALLOCATE @PROCESS_CURSOR 
PRINT @PROCESS_FILE_NAME

CLOSE SYMMETRIC KEY   KEY4CERTAUTOPROCESS;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_PRM
-- --------------------------------------------------
--exec msajag.dbo.CLASS_AUTO_PROCESS_PRM @FOR='3' 
--exec ANGELFO.BSEMFSS.dbo.CLASS_AUTO_PROCESS_PRM @FOR='1'
CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_PRM]      
(      
 @FOR VARCHAR(2)      
)      
AS      
BEGIN      
 IF @FOR='1'      
  BEGIN      
   SELECT DISTINCT PROCESS_TYPE FROM TBL_AUTO_PROCESS_MASTER      
  END      
 IF @FOR='2'      
  BEGIN      
   SELECT DISTINCT PROCESS_FOR FROM TBL_AUTO_PROCESS_MASTER      
  END      
 IF @FOR='3'      
  BEGIN      
   SELECT DISTINCT  UPPER(LTRIM(RTRIM(EXCHANGE))) , UPPER(LTRIM(RTRIM(SEGMENT))),(CASE WHEN PRIMARYSERVER = 1 
   THEN 'PRIMARY-' ELSE 'DELIVERY-' END) + UPPER(LTRIM(RTRIM(EXCHANGE))) +'-'+ UPPER(LTRIM(RTRIM(SEGMENT)))
    AS SEGMENT,SERVERNAME = SHARESERVER+ '.'
  
 + SHAREDB + '.dbo.'  FROM PRADNYA.DBO.MULTICOMPANY       
 union all
     SELECT DISTINCT EXCHANGE = 'BSE', SEGMENT='MFSS',  
	'BSE-MFSS'
    AS SEGMENT,SERVERNAME = 'ANGELFO.BSEMFSS.dbo.'    
     ORDER BY 2,1 DESC        
    
  END      
END      
    
-- exec CLASS_AUTO_PROCESS_PRM 3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETTLEMENT
-- --------------------------------------------------
  
  
  
  
  
  
CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_SETTLEMENT]                    
(                     
 @PROCESS_DATE VARCHAR(11)                    
)                    
AS                    
                    
-- EXEC CLASS_AUTO_PROCESS_SETTLEMENT 'AUG 27 2015'                    
SET @PROCESS_DATE = LEFT(GETDATE(),11)                    
                    
DECLARE @SNO     NUMERIC(18,0),                    
  @EXCHANGE    VARCHAR(3),                    
  @SEGMENT    VARCHAR(7),                    
  @BUSINESS_DATE   VARCHAR(11),                    
  @PROCESS_FOR   VARCHAR(30),      
  @PROCESS_FREQ    VARCHAR(30),                 
  @INTERNAL_PROCESS_ID INT,                    
  @FILE_DWLOAD_LOCATION VARCHAR(200),                    
  @FILE_DWLOAD_NAME  VARCHAR(200),                    
  @FILE_DWLOAD_NAME_TEMP varchar(200),                    
  @FILE_DWLOAD_MAP_DRIVE VARCHAR(100),                    
  @FILE_DWLOAD_USERID  VARCHAR(100),                    
  @FILE_DWLOAD_PWD  VARCHAR(100),                    
  @PROCESS_FILE_PATH  VARCHAR(200),                    
  @PROCESS_FILE_NAME  VARCHAR(200),                    
  @PROCESS_FILE_NAME_NEW VARCHAR(200),                    
  @PROCESS_FILE_MOVE_PATH VARCHAR(200),                    
  @PROCESS_SP_NAME  VARCHAR(8000),                    
  @PROCESS_CHECK_QUERY VARCHAR(MAX),                    
  @PROCESS_HALTED_REASON VARCHAR(500),                    
  @FILE_INTERNET_LOCATION VARCHAR(500),                    
  @FILE_INTERNAL_ISS_PATH VARCHAR(500),                    
  @PROCESS_CURSOR   CURSOR,                    
  @IS_FILE_BASED   VARCHAR(1),                    
  @PROCESS_ID    INT,                    
  @SUB_PROCESS_ID   INT,                    
  @ISEXISTS    INT,                    
  @ERRFLAG    INT,                    
  @CMD     VARCHAR(8000),                    
  @TIME     VARCHAR(8),                    
  @CHKFLAG    INT,                    
  @MYOUTPUT    VARCHAR(MAX),                    
  @OTHER_DBDETAILS  VARCHAR(200),                     
  @OTHER_PROCESS_FOR  VARCHAR(200),                     
  @SETT_NO    VARCHAR(20),                     
  @SETT_TYPE    VARCHAR(20),                    
  @FLD_FILEDATE   DATETIME,                    
  @FLD_FILENAME   VARCHAR(200),              
  @PREV_DATE   VARCHAR(11),  
  @PREV_DATE_NEW   VARCHAR(11),  
  @MFSETT VARCHAR(7)                      
                    
SET NOCOUNT ON                    
SET @ERRFLAG = 0                    
SET @CHKFLAG = 1                    
  
SELECT @PREV_DATE = LEFT(ISNULL(MAX(SYSDATE),@BUSINESS_DATE),11) FROM [AngelNseCM].MSAJAG.DBO.CLOSING              
WHERE SYSDATE < @PROCESS_DATE         
--exec usp_getJobStatus '%auto process settlement%'      
EXEC CLASS_AUTO_PROCESS_LISNER            
                    
OPEN SYMMETRIC KEY   Key4CertAutoProcess                    
     DECRYPTION BY   CERTIFICATE CertAutoProcess                     
  
SET @PROCESS_CURSOR = CURSOR FOR                      
                    
SELECT                      
DISTINCT D.SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, PROCESS_FREQ, D.PROCESS_ID, D.INTERNAL_PROCESS_ID, D.PROCESS_FOR,                     
PROCESS_FILE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                    
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                    
PROCESS_FILE_MOVE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_MOVE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                    
PROCESS_SP_NAME = Replace(Replace(Replace(PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_SP_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),'<FileName>',                    
       '''' + PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) +                     
       PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + ''''),                    
       '<SNO>',D.Sno),'<SUBPROCESSID>',D.SUB_PROCESS_ID),                    
PROCESS_CHECK_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_CHECK_QUERY),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                    
IS_FILE_BASED,                    
FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                    
FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                    
FILE_DWLOAD_MAP_DRIVE, FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),                    
FILE_INTERNET_LOCATION, FILE_INTERNAL_ISS_PATH, SUB_PROCESS_ID, OTHER_DBDETAILS, OTHER_PROCESS_FOR, D.SETT_NO, D.SETT_TYPE                    
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK),                     
     TBL_AUTO_PROCESS_MASTER M (NOLOCK),                     
  OWNER O                    
WHERE PROCESS_DATE = LEFT(GETDATE(),11)                    
AND D.PROCESS_FOR = M.PROCESS_FOR                    
AND D.INTERNAL_PROCESS_ID = M.INTERNAL_PROCESS_ID                    
AND D.PROCESS_STATUS = 0                    
AND (D.PROCESS_START_DATE <= GETDATE() + D.WAIT_PERIOD                    
OR D.PROCESS_START_DATE <= GETDATE())                    
AND (D.PROCESS_END_DATE + D.WAIT_PERIOD >= GETDATE()                     
OR D.PROCESS_END_DATE >= GETDATE())                    
AND D.IS_DEPEND_ON = ''                    
AND IS_FILE_BASED <> ''      
--and d.process_for = 'ALLOTMENT'      
ORDER BY D.SNO                    
                    
OPEN @PROCESS_CURSOR                    
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FREQ, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                     
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                     
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                    
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                    
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                    
WHILE @@FETCH_STATUS = 0                    
BEGIN              
/*        
 select @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FREQ, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                     
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                     
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                    
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                    
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE    
*/            
 SELECT @MFSETT = ''  
 IF (CASE WHEN (@FILE_DWLOAD_NAME LIKE '%<MFSETT>%' OR @PROCESS_FILE_NAME LIKE '%<MFSETT>%' OR @PROCESS_SP_NAME LIKE '%<MFSETT>%')    
    THEN 1 ELSE 0 END) = 1  
 BEGIN  
  SELECT @MFSETT = SETT_NO FROM SETT_MST WHERE START_DATE LIKE @BUSINESS_DATE + '%'  
                   
  SET @FILE_DWLOAD_NAME = REPLACE(@FILE_DWLOAD_NAME,'<MFSETT>',@MFSETT)   
  SET @PROCESS_FILE_NAME = REPLACE(@PROCESS_FILE_NAME,'<MFSETT>',@MFSETT)  
  SET @PROCESS_SP_NAME  = REPLACE(@PROCESS_SP_NAME,'<MFSETT>',@MFSETT)  
 END   
  
 IF (CASE WHEN (@FILE_DWLOAD_NAME LIKE '%<PMFSETT>%' OR @PROCESS_FILE_NAME LIKE '%<PMFSETT>%' OR @PROCESS_SP_NAME LIKE '%<PMFSETT>%')    
    THEN 1 ELSE 0 END) = 1  
 BEGIN  
     
 SELECT @PREV_DATE_NEW = MAX(START_DATE) FROM  SETT_MST WHERE START_DATE < @BUSINESS_DATE  
  
  SELECT @MFSETT = SETT_NO FROM SETT_MST WHERE START_DATE LIKE @PREV_DATE_NEW + '%'  
                   
  SET @FILE_DWLOAD_NAME = REPLACE(@FILE_DWLOAD_NAME,'<PMFSETT>',@MFSETT)   
  SET @PROCESS_FILE_NAME = REPLACE(@PROCESS_FILE_NAME,'<PMFSETT>',@MFSETT)  
  SET @PROCESS_SP_NAME  = REPLACE(@PROCESS_SP_NAME,'<PMFSETT>',@MFSETT)  
 END     
             
 /*  
 SELECT @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                     
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                     
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                    
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                    
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                    
*/        
  
     print @PROCESS_FILE_NAME  
     print @PROCESS_SP_NAME           
 SET @PROCESS_FILE_NAME_NEW = ''                    
 SET @FLD_FILENAME = ''                    
                    
 SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)                    
 WHERE PROCESS_DATE = @PROCESS_DATE                     
 AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT                    
 AND PROCESS_FOR = @PROCESS_FOR                    
 AND PROCESS_STATUS NOT IN (0, 100)                    
 IF @CHKFLAG = 1                     
 BEGIN                    
  SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'                    
 END                     
                    
 IF @CHKFLAG = 0                     
 BEGIN                    
  SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)                    
  WHERE PROCESS_DATE = @PROCESS_DATE                  
  AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT                    
  AND INTERNAL_PROCESS_ID = (CASE WHEN @INTERNAL_PROCESS_ID = 0                     
          THEN -1                     
          ELSE @INTERNAL_PROCESS_ID           
           END)                    
  AND PROCESS_STATUS NOT IN (0, 100)                    
  IF @CHKFLAG = 1                     
  BEGIN                    
   SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'                    
  END                     
 END                    
             
 IF @CHKFLAG = 0                     
 BEGIN                    
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)                    
   WHERE SNO = @SNO                    
   AND PROCESS_STATUS = 0) = 0                    
  BEGIN                    
   SET @CHKFLAG = -1                     
  END                    
 END                    
 IF @CHKFLAG = 0                     
 BEGIN                    
  SET @ISEXISTS = 0                     
  IF (@IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'F' OR @IS_FILE_BASED = 'I') AND @SUB_PROCESS_ID = 0                    
  BEGIN                    
   IF @FILE_DWLOAD_LOCATION <> ''                    
   BEGIN             
  IF @IS_FILE_BASED = 'I'                    
    BEGIN                    
     SET @PROCESS_FILE_NAME_NEW = @FILE_INTERNAL_ISS_PATH + @FILE_INTERNET_LOCATION + '&FILENAME=' + @FILE_DWLOAD_NAME                    
     EXEC HTTP_REQUEST @PROCESS_FILE_NAME_NEW, @MYOUTPUT                     
    END                    
                        
    IF @IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'I'                    
    BEGIN                    
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'                    
  EXEC (@CMD)                    
     IF @FILE_DWLOAD_MAP_DRIVE <> ''                    
     BEGIN                    
      SET @CMD = 'EXEC XP_CMDSHELL ''net use "' + @FILE_DWLOAD_LOCATION + '" /USER:' + @FILE_DWLOAD_USERID + ' ' + @FILE_DWLOAD_PWD + ' /persistent:Y'' , NO_OUTPUT'                    
      EXEC (@CMD)                    
     END               
  
  IF @FILE_DWLOAD_NAME NOT LIKE '%*%' AND @PROCESS_FREQ = 'RECCUR'                   
  BEGIN  
  SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME  
  EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT                         
  
  --SELECT @PROCESS_FILE_NAME_NEW            
     SET @FILE_DWLOAD_NAME = ISNULL(@FLD_FILENAME,'')  
    
  SET @PROCESS_FILE_NAME = ISNULL(@FLD_FILENAME,'')   
  IF @FILE_DWLOAD_NAME = ''  
   SET @PROCESS_FILE_NAME_NEW = ''  
  END        
     IF @FILE_DWLOAD_NAME LIKE '%*%'                    
     BEGIN                    
      SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,@PROCESS_FILE_NAME,'#')                    
                
      IF @FILE_DWLOAD_MAP_DRIVE <> ''                    
      BEGIN                    
       SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME                    
      END                    
      ELSE                    
      BEGIN                    
       SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME                    
      END                    
        
      EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT                         
            
      SET @FILE_DWLOAD_NAME = @FLD_FILENAME                 
                  
      IF @FILE_DWLOAD_NAME <> ''                    
      BEGIN                    
       IF @PROCESS_FILE_NAME NOT LIKE '%#%'                     
       BEGIN                    
        SET @PROCESS_FILE_NAME = @FLD_FILENAME                    
       END                    
       ELSE                    
       BEGIN                      
        SET @PROCESS_FILE_NAME = LEFT(@FLD_FILENAME, LEN(@FILE_DWLOAD_NAME)-LEN(.DBO.PIECE(@PROCESS_FILE_NAME,'#',1))) + .DBO.PIECE(@PROCESS_FILE_NAME,'#',2)                    
       END                    
       SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,'#',@PROCESS_FILE_NAME)                     
                              
      END                    
      ELSE                    
      BEGIN                    
       SET @PROCESS_FILE_NAME = ''                    
      END                    
     END                    
                   
     IF @FILE_DWLOAD_NAME <> ''                    
     BEGIN                    
      IF @FILE_DWLOAD_MAP_DRIVE <> ''                    
      BEGIN                    
       SET @CMD = 'EXEC XP_CMDSHELL ''Copy "' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + '" "' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + '"'', NO_OUTPUT'                    
       EXEC (@CMD)                    
      END                    
      ELSE                    
      BEGIN                    
       SET @CMD = 'EXEC XP_CMDSHELL ''Copy "' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + '" "' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + '"'', NO_OUTPUT'                    
     --PRINT @CMD                    
       EXEC (@CMD)                    
      END                    
      IF @IS_FILE_BASED = 'I'                    
      BEGIN                    
       SET @CMD = 'EXEC XP_CMDSHELL ''DEL "' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + '"'', NO_OUTPUT '                    
       EXEC (@CMD)                    
      END                    
      IF @FILE_DWLOAD_MAP_DRIVE <> ''                    
      BEGIN                    
       SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_LOCATION + ' /delete'', NO_OUTPUT'                    
       EXEC (@CMD)               
      END                    
     END                     
    END                    
    ELSE                    
    IF @IS_FILE_BASED = 'F'                    
    BEGIN                    
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'                    
     EXEC (@CMD)                    
     --SELECT @FILE_DWLOAD_LOCATION, @PROCESS_FILE_PATH, @FILE_DWLOAD_NAME, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_DWLOAD_MAP_DRIVE                    
     SET @FILE_DWLOAD_NAME_TEMP = @FILE_DWLOAD_NAME + '_1'                    
     SELECT  @cmd = 'echo '+ 'open ' + @FILE_DWLOAD_LOCATION+ ' > ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                    
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                    
     SELECT  @cmd = 'echo '+ @FILE_DWLOAD_USERID+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                    
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                    
     SELECT  @cmd = 'echo '+ @FILE_DWLOAD_PWD+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                    
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                    
          select  @cmd = 'echo '+ 'dir ' + @file_dwload_map_drive + @file_dwload_name + ' >> ' + @process_file_path + @file_dwload_name_temp                    
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                    
     SELECT  @cmd = 'echo '+ 'get ' + @FILE_DWLOAD_MAP_DRIVE + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP               
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                    
     SELECT  @cmd = 'echo '+ 'quit'+ ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                    
     -- Executing steps from working file                    
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT    
       
                 
                    
     CREATE TABLE #FILELIST                           
     (                     
      FILENAMELIST VARCHAR(MAX)                    
     )                     
                    
     SELECT  @cmd = 'ftp -s:' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                    
         
     -- Executing final step                    
     INSERT INTO #FILELIST                    
     EXEC master..xp_cmdshell @cmd--, NO_OUTPUT                    
                      
     DELETE FROM #FILELIST                    
     WHERE FILENAMELIST IS  NULL                    
                    
     DELETE FROM #FILELIST                    
     WHERE FILENAMELIST NOT LIKE '%' + @FILE_DWLOAD_NAME + '%'                    
                    
     DELETE FROM #FILELIST                    
     WHERE FILENAMELIST LIKE 'DIR%'                    
                    
     DELETE FROM #FILELIST                    
     WHERE FILENAMELIST LIKE 'GET%'                    
                    
     UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')                    
                    
     SET @FLD_FILEDATE = '1900-01-01'                    
                    
     SELECT @FLD_FILEDATE = CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),1)                    
     FROM #FILELIST                    
         
   IF LEFT(@FLD_FILEDATE,11) <> @BUSINESS_DATE                
   BEGIN                
    IF (@PROCESS_FOR = 'EXCHANGE APP VAR' OR @PROCESS_FOR = 'IMPORT_CONTRACT_MASTER') AND @PREV_DATE = LEFT(@FLD_FILEDATE,11)               
    BEGIN                
     SET @CMD = ''                    
    END              
    ELSE               
    BEGIN                
     SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @process_file_path + @file_dwload_name + ''', NO_OUTPUT '                
     EXEC (@CMD)                      
    END                
   END         
                  
   SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP + ''', NO_OUTPUT '                
   EXEC (@CMD)                
            
   DROP TABLE #FILELIST                
  END     
 END                           
   IF @PROCESS_FILE_NAME <> ''                    
   BEGIN                    
    SET @PROCESS_FILE_NAME_NEW = @PROCESS_FILE_PATH + @PROCESS_FILE_NAME                    
    IF PRADNYA.DBO.CHECKZIPFILE(@FILE_DWLOAD_NAME) > 0                    
    BEGIN                    
     SET @CMD = 'EXEC XP_CMDSHELL ''"C:\program files\Winzip\WZUNZIP.exe" -yb -o ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'                    
     EXEC (@CMD)                    
                    
     SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '                    
     EXEC (@CMD)                    
    END                    
   END                    
           
   EXEC MASTER.DBO.XP_FILEEXIST @PROCESS_FILE_NAME_NEW, @ISEXISTS OUTPUT                    
   IF @ISEXISTS = 0                     
   BEGIN                    
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = 'FILE NOT AVAILABLE IN THE SPECIFIED LOCATION.',                    
    PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()                    
    WHERE SNO = @SNO                    
   END                    
   ELSE                    
   BEGIN                       
    SET @ERRFLAG = 0     
 --print @PROCESS_SP_NAME  
 --return  
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))                    
    WHERE SNO = @SNO             
                 
    BEGIN                    
   IF @INTERNAL_PROCESS_ID <= 1000                     
   BEGIN            
     BEGIN TRAN                    
   END            
      BEGIN TRY                    
       SET @CMD = @PROCESS_SP_NAME                     
       --PRINT @CMD                    
       EXEC (@CMD)                           
      END TRY                    
   BEGIN CATCH                 
  IF @INTERNAL_PROCESS_ID <= 1000                     
  BEGIN               
   ROLLBACK TRAN                    
  END            
       UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),                    
       PROCESS_STATUS = 0                    
       WHERE SNO = @SNO                    
       SET @ERRFLAG = 1                    
      END CATCH                    
  
  EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT   
                          
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_MOVE_PATH + ''', NO_OUTPUT'                    
     EXEC (@CMD)                    
     SELECT @TIME = REPLACE(CONVERT(VARCHAR,GETDATE(),108),':','')                    
     IF LEN(@PROCESS_FILE_MOVE_PATH) > 0                     
     BEGIN                    
      SET @CMD = 'EXEC XP_CMDSHELL ''MOVE ' + @PROCESS_FILE_NAME_NEW + ' ' + @PROCESS_FILE_MOVE_PATH + @PROCESS_FILE_NAME + @TIME + ''', NO_OUTPUT'                    
     END                    
     ELSE                    
     BEGIN                    
      SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_NAME_NEW + ''', NO_OUTPUT'                    
     END                    
     EXEC (@CMD)                    
                    
     IF @ERRFLAG = 0                 
  BEGIN                     
   IF ISNULL(@FLD_FILENAME,'') <> ''            
   BEGIN            
  INSERT INTO TBL_AUTO_PROCESS_FILE VALUES (@FLD_FILENAME, @FLD_FILEDATE, GETDATE())                    
   END        
  
   IF @INTERNAL_PROCESS_ID <= 1000                     
   BEGIN            
      COMMIT TRAN                    
   END            
                       
      IF LEN(@PROCESS_CHECK_QUERY) > 0                     
      BEGIN                    
       SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''                    
       SET @CMD = @CMD + ' IF (@RECCNT) > 0 '                           SET @CMD = @CMD + ' BEGIN '                    
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','                    
       SET @CMD = @CMD + '  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '                    
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                    
                           
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                    
       SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
       SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
       SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                
    SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                    
                           
       IF @OTHER_DBDETAILS <> ''                    
       BEGIN                    
        SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                    
        SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
        SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
        SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
        SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                    
        SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                    
       END                    
       SET @CMD = @CMD + ' END '                    
       SET @CMD = @CMD + ' ELSE '                     
       SET @CMD = @CMD + ' BEGIN '                     
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET '                    
       SET @CMD = @CMD + '  PROCESS_HALTED_REASON = @MSG,'                    
       SET @CMD = @CMD + '  PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '                    
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                    
       SET @CMD = @CMD + ' END '                    
       EXEC (@CMD)                    
      END                    
      ELSE                    
      BEGIN                    
       SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '                    
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '                    
       SET @CMD = @CMD + ' BEGIN '                    
                    
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                    
       SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
       SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
       SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
       SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                    
       IF @OTHER_DBDETAILS <> ''                    
       BEGIN                    
     SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                    
        SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
        SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
        SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
        SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                    
        SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                    
       END                    
       SET @CMD = @CMD + ' END '                    
       EXEC (@CMD)                    
      END                    
 END                        
    END                    
   END                    
  END                    
 ELSE                    
  BEGIN                    
   SET @ERRFLAG = 0                    
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))            
WHERE SNO = @SNO            
   IF @INTERNAL_PROCESS_ID <= 1000                     
   BEGIN            
  BEGIN TRAN                      
   END            
    BEGIN TRY                    
     SET @CMD = @PROCESS_SP_NAME                     
     PRINT @CMD                    
     EXEC (@CMD)                    
    END TRY                    
    BEGIN CATCH                    
 IF @INTERNAL_PROCESS_ID <= 1000                     
 BEGIN            
   ROLLBACK TRAN                    
 END            
--print ERROR_MESSAGE()                    
     UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),                    
     PROCESS_STATUS = 0                    
     WHERE SNO = @SNO                    
     SET @ERRFLAG = 1                    
    END CATCH                    
   IF @ERRFLAG = 0                          
   BEGIN                    
 IF @INTERNAL_PROCESS_ID <= 1000                     
    BEGIN            
  COMMIT TRAN                    
    END            
                
    IF LEN(@PROCESS_CHECK_QUERY) > 0                     
    Begin                    
  SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''                    
     SET @CMD = @CMD + ' IF (@RECCNT) > 0 '                    
     SET @CMD = @CMD + ' BEGIN '                    
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','                    
     SET @CMD = @CMD + '  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '                    
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                    
                    
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                    
     SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
     SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
     SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
     SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                    
     IF @OTHER_DBDETAILS <> ''                    
     BEGIN                    
      SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                    
      SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
      SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
      SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
      SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                    
      SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                    
     END                    
                    
     SET @CMD = @CMD + ' END '                    
     SET @CMD = @CMD + ' ELSE '                     
     SET @CMD = @CMD + ' BEGIN '                     
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET '                    
     SET @CMD = @CMD + '  PROCESS_HALTED_REASON = @MSG,'                    
     SET @CMD = @CMD + '  PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '                    
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                    
     SET @CMD = @CMD + ' END '                    
     EXEC (@CMD)                    
    END                    
    ELSE                    
    BEGIN                    
     SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '                    
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '                    
     SET @CMD = @CMD + ' BEGIN '               
                 
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                    
     SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
     SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
     SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
     SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                    
     IF @OTHER_DBDETAILS <> ''                    
     BEGIN                    
      SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                    
      SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                    
      SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                     
      SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                    
      SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                    
      SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                    
     END                    
     SET @CMD = @CMD + ' END '                    
     EXEC (@CMD)                    
    END                    
   END                    
  END                    
 END                    
 ELSE                    
 BEGIN                    
  IF @CHKFLAG = 1                     
  BEGIN                    
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @PROCESS_HALTED_REASON,                    
   PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()                    
   WHERE SNO = @SNO AND PROCESS_STATUS = 0                    
  END                  
 END                    
 FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FREQ, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                     
              @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                    
           @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                
           @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                    
              @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                    
END                    
CLOSE @PROCESS_CURSOR                    
DEALLOCATE @PROCESS_CURSOR                    
                    
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;                    
                    
EXEC CLASS_AUTO_PROCESS_ALERT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETTLEMENT_29062021
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_SETTLEMENT]                  
(                   
 @PROCESS_DATE VARCHAR(11)                  
)                  
AS                  
                  
-- EXEC CLASS_AUTO_PROCESS_SETTLEMENT 'AUG 27 2015'                  
SET @PROCESS_DATE = LEFT(GETDATE(),11)                  
                  
DECLARE @SNO     NUMERIC(18,0),                  
  @EXCHANGE    VARCHAR(3),                  
  @SEGMENT    VARCHAR(7),                  
  @BUSINESS_DATE   VARCHAR(11),                  
  @PROCESS_FOR   VARCHAR(30),    
  @PROCESS_FREQ    VARCHAR(30),               
  @INTERNAL_PROCESS_ID INT,                  
  @FILE_DWLOAD_LOCATION VARCHAR(200),                  
  @FILE_DWLOAD_NAME  VARCHAR(200),                  
  @FILE_DWLOAD_NAME_TEMP varchar(200),                  
  @FILE_DWLOAD_MAP_DRIVE VARCHAR(100),                  
  @FILE_DWLOAD_USERID  VARCHAR(100),                  
  @FILE_DWLOAD_PWD  VARCHAR(100),                  
  @PROCESS_FILE_PATH  VARCHAR(200),                  
  @PROCESS_FILE_NAME  VARCHAR(200),                  
  @PROCESS_FILE_NAME_NEW VARCHAR(200),                  
  @PROCESS_FILE_MOVE_PATH VARCHAR(200),                  
  @PROCESS_SP_NAME  VARCHAR(8000),                  
  @PROCESS_CHECK_QUERY VARCHAR(MAX),                  
  @PROCESS_HALTED_REASON VARCHAR(500),                  
  @FILE_INTERNET_LOCATION VARCHAR(500),                  
  @FILE_INTERNAL_ISS_PATH VARCHAR(500),                  
  @PROCESS_CURSOR   CURSOR,                  
  @IS_FILE_BASED   VARCHAR(1),                  
  @PROCESS_ID    INT,                  
  @SUB_PROCESS_ID   INT,                  
  @ISEXISTS    INT,                  
  @ERRFLAG    INT,                  
  @CMD     VARCHAR(8000),                  
  @TIME     VARCHAR(8),                  
  @CHKFLAG    INT,                  
  @MYOUTPUT    VARCHAR(MAX),                  
  @OTHER_DBDETAILS  VARCHAR(200),                   
  @OTHER_PROCESS_FOR  VARCHAR(200),                   
  @SETT_NO    VARCHAR(20),                   
  @SETT_TYPE    VARCHAR(20),                  
  @FLD_FILEDATE   DATETIME,                  
  @FLD_FILENAME   VARCHAR(200),            
  @PREV_DATE   VARCHAR(11),
  @PREV_DATE_NEW   VARCHAR(11),
  @MFSETT	VARCHAR(7)                    
                  
SET NOCOUNT ON                  
SET @ERRFLAG = 0                  
SET @CHKFLAG = 1                  

SELECT @PREV_DATE = LEFT(ISNULL(MAX(SYSDATE),@BUSINESS_DATE),11) FROM [196.1.115.196].MSAJAG.DBO.CLOSING            
WHERE SYSDATE < @PROCESS_DATE       
--exec usp_getJobStatus '%auto process settlement%'    
EXEC CLASS_AUTO_PROCESS_LISNER          
                  
OPEN SYMMETRIC KEY   Key4CertAutoProcess                  
     DECRYPTION BY   CERTIFICATE CertAutoProcess                   

SET @PROCESS_CURSOR = CURSOR FOR                    
                  
SELECT                    
DISTINCT D.SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, PROCESS_FREQ, D.PROCESS_ID, D.INTERNAL_PROCESS_ID, D.PROCESS_FOR,                   
PROCESS_FILE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                  
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                  
PROCESS_FILE_MOVE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_MOVE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                  
PROCESS_SP_NAME = Replace(Replace(Replace(PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_SP_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),'<FileName>',                  
       '''' + PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) +                   
       PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + ''''),                  
       '<SNO>',D.Sno),'<SUBPROCESSID>',D.SUB_PROCESS_ID),                  
PROCESS_CHECK_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_CHECK_QUERY),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                  
IS_FILE_BASED,                  
FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                  
FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),                  
FILE_DWLOAD_MAP_DRIVE, FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),                  
FILE_INTERNET_LOCATION, FILE_INTERNAL_ISS_PATH, SUB_PROCESS_ID, OTHER_DBDETAILS, OTHER_PROCESS_FOR, D.SETT_NO, D.SETT_TYPE                  
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK),                   
     TBL_AUTO_PROCESS_MASTER M (NOLOCK),                   
  OWNER O                  
WHERE PROCESS_DATE = LEFT(GETDATE(),11)                  
AND D.PROCESS_FOR = M.PROCESS_FOR                  
AND D.INTERNAL_PROCESS_ID = M.INTERNAL_PROCESS_ID                  
AND D.PROCESS_STATUS = 0                  
AND (D.PROCESS_START_DATE <= GETDATE() + D.WAIT_PERIOD                  
OR D.PROCESS_START_DATE <= GETDATE())                  
AND (D.PROCESS_END_DATE + D.WAIT_PERIOD >= GETDATE()                   
OR D.PROCESS_END_DATE >= GETDATE())                  
AND D.IS_DEPEND_ON = ''                  
AND IS_FILE_BASED <> ''    
--and d.process_for = 'ALLOTMENT'    
ORDER BY D.SNO                  
                  
OPEN @PROCESS_CURSOR                  
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FREQ, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                   
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                   
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                  
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                  
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                  
WHILE @@FETCH_STATUS = 0                  
BEGIN            
/*      
 select @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FREQ, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                   
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                   
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                  
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                  
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE  
*/          
 SELECT @MFSETT = ''
 IF (CASE WHEN (@FILE_DWLOAD_NAME LIKE '%<MFSETT>%' OR @PROCESS_FILE_NAME LIKE '%<MFSETT>%' OR @PROCESS_SP_NAME LIKE '%<MFSETT>%')  
		  THEN 1 ELSE 0 END) = 1
 BEGIN
	 SELECT @MFSETT = SETT_NO FROM SETT_MST WHERE START_DATE LIKE @BUSINESS_DATE + '%'
		               
	 SET @FILE_DWLOAD_NAME = REPLACE(@FILE_DWLOAD_NAME,'<MFSETT>',@MFSETT) 
	 SET @PROCESS_FILE_NAME = REPLACE(@PROCESS_FILE_NAME,'<MFSETT>',@MFSETT)
	 SET @PROCESS_SP_NAME  = REPLACE(@PROCESS_SP_NAME,'<MFSETT>',@MFSETT)
 END 

 IF (CASE WHEN (@FILE_DWLOAD_NAME LIKE '%<PMFSETT>%' OR @PROCESS_FILE_NAME LIKE '%<PMFSETT>%' OR @PROCESS_SP_NAME LIKE '%<PMFSETT>%')  
		  THEN 1 ELSE 0 END) = 1
 BEGIN
	  
	SELECT @PREV_DATE_NEW = MAX(START_DATE) FROM  SETT_MST WHERE START_DATE < @BUSINESS_DATE

	 SELECT @MFSETT = SETT_NO FROM SETT_MST WHERE START_DATE LIKE @PREV_DATE_NEW + '%'
		               
	 SET @FILE_DWLOAD_NAME = REPLACE(@FILE_DWLOAD_NAME,'<PMFSETT>',@MFSETT) 
	 SET @PROCESS_FILE_NAME = REPLACE(@PROCESS_FILE_NAME,'<PMFSETT>',@MFSETT)
	 SET @PROCESS_SP_NAME  = REPLACE(@PROCESS_SP_NAME,'<PMFSETT>',@MFSETT)
 END   
           
 /*
 SELECT @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                   
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                   
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,                  
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                  
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                  
*/      

     print @PROCESS_FILE_NAME
     print @PROCESS_SP_NAME         
 SET @PROCESS_FILE_NAME_NEW = ''                  
 SET @FLD_FILENAME = ''                  
                  
 SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)                  
 WHERE PROCESS_DATE = @PROCESS_DATE                   
 AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT                  
 AND PROCESS_FOR = @PROCESS_FOR                  
 AND PROCESS_STATUS NOT IN (0, 100)                  
 IF @CHKFLAG = 1                   
 BEGIN                  
  SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'                  
 END                   
                  
 IF @CHKFLAG = 0                   
 BEGIN                  
  SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)                  
  WHERE PROCESS_DATE = @PROCESS_DATE                
  AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT                  
  AND INTERNAL_PROCESS_ID = (CASE WHEN @INTERNAL_PROCESS_ID = 0                   
          THEN -1                   
          ELSE @INTERNAL_PROCESS_ID         
           END)                  
  AND PROCESS_STATUS NOT IN (0, 100)                  
  IF @CHKFLAG = 1                   
  BEGIN                  
   SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'                  
  END                   
 END                  
           
 IF @CHKFLAG = 0                   
 BEGIN                  
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)                  
   WHERE SNO = @SNO                  
   AND PROCESS_STATUS = 0) = 0                  
  BEGIN                  
   SET @CHKFLAG = -1                   
  END                  
 END                  
 IF @CHKFLAG = 0                   
 BEGIN                  
  SET @ISEXISTS = 0                   
  IF (@IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'F' OR @IS_FILE_BASED = 'I') AND @SUB_PROCESS_ID = 0                  
  BEGIN                  
   IF @FILE_DWLOAD_LOCATION <> ''                  
   BEGIN           
  IF @IS_FILE_BASED = 'I'                  
    BEGIN                  
     SET @PROCESS_FILE_NAME_NEW = @FILE_INTERNAL_ISS_PATH + @FILE_INTERNET_LOCATION + '&FILENAME=' + @FILE_DWLOAD_NAME                  
     EXEC HTTP_REQUEST @PROCESS_FILE_NAME_NEW, @MYOUTPUT                   
    END                  
                      
    IF @IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'I'                  
    BEGIN                  
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'                  
	 EXEC (@CMD)                  
     IF @FILE_DWLOAD_MAP_DRIVE <> ''                  
     BEGIN                  
      SET @CMD = 'EXEC XP_CMDSHELL ''net use "' + @FILE_DWLOAD_LOCATION + '" /USER:' + @FILE_DWLOAD_USERID + ' ' + @FILE_DWLOAD_PWD + ' /persistent:Y'' , NO_OUTPUT'                  
      EXEC (@CMD)                  
     END             

	 IF @FILE_DWLOAD_NAME NOT LIKE '%*%' AND @PROCESS_FREQ = 'RECCUR'                 
	 BEGIN
		SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME
		EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT                       

		--SELECT @PROCESS_FILE_NAME_NEW          
	    SET @FILE_DWLOAD_NAME = ISNULL(@FLD_FILENAME,'')
		
		SET @PROCESS_FILE_NAME = ISNULL(@FLD_FILENAME,'') 
		IF @FILE_DWLOAD_NAME = ''
			SET @PROCESS_FILE_NAME_NEW = ''
	 END      
     IF @FILE_DWLOAD_NAME LIKE '%*%'                  
     BEGIN                  
      SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,@PROCESS_FILE_NAME,'#')                  
              
      IF @FILE_DWLOAD_MAP_DRIVE <> ''                  
      BEGIN                  
       SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME                  
      END                  
      ELSE                  
      BEGIN                  
       SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME                  
      END                  
      
      EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT                       
          
      SET @FILE_DWLOAD_NAME = @FLD_FILENAME               
                
      IF @FILE_DWLOAD_NAME <> ''                  
      BEGIN                  
       IF @PROCESS_FILE_NAME NOT LIKE '%#%'                   
       BEGIN                  
        SET @PROCESS_FILE_NAME = @FLD_FILENAME                  
       END                  
       ELSE                  
       BEGIN                    
        SET @PROCESS_FILE_NAME = LEFT(@FLD_FILENAME, LEN(@FILE_DWLOAD_NAME)-LEN(.DBO.PIECE(@PROCESS_FILE_NAME,'#',1))) + .DBO.PIECE(@PROCESS_FILE_NAME,'#',2)                  
       END                  
       SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,'#',@PROCESS_FILE_NAME)                   
                            
      END                  
      ELSE                  
      BEGIN                  
       SET @PROCESS_FILE_NAME = ''                  
      END                  
     END                  
	 		             
     IF @FILE_DWLOAD_NAME <> ''                  
     BEGIN                  
      IF @FILE_DWLOAD_MAP_DRIVE <> ''                  
      BEGIN                  
       SET @CMD = 'EXEC XP_CMDSHELL ''Copy "' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + '" "' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + '"'', NO_OUTPUT'                  
       EXEC (@CMD)                  
      END                  
      ELSE                  
      BEGIN                  
       SET @CMD = 'EXEC XP_CMDSHELL ''Copy "' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + '" "' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + '"'', NO_OUTPUT'                  
     --PRINT @CMD                  
       EXEC (@CMD)                  
      END                  
      IF @IS_FILE_BASED = 'I'                  
      BEGIN                  
       SET @CMD = 'EXEC XP_CMDSHELL ''DEL "' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + '"'', NO_OUTPUT '                  
       EXEC (@CMD)                  
      END                  
      IF @FILE_DWLOAD_MAP_DRIVE <> ''                  
      BEGIN                  
       SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_LOCATION + ' /delete'', NO_OUTPUT'                  
       EXEC (@CMD)                  
      END                  
     END                   
    END                  
    ELSE                  
    IF @IS_FILE_BASED = 'F'                  
    BEGIN                  
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'                  
     EXEC (@CMD)                  
     --SELECT @FILE_DWLOAD_LOCATION, @PROCESS_FILE_PATH, @FILE_DWLOAD_NAME, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_DWLOAD_MAP_DRIVE                  
     SET @FILE_DWLOAD_NAME_TEMP = @FILE_DWLOAD_NAME + '_1'                  
     SELECT  @cmd = 'echo '+ 'open ' + @FILE_DWLOAD_LOCATION+ ' > ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                  
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                  
     SELECT  @cmd = 'echo '+ @FILE_DWLOAD_USERID+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                  
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                  
     SELECT  @cmd = 'echo '+ @FILE_DWLOAD_PWD+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                  
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                  
          select  @cmd = 'echo '+ 'dir ' + @file_dwload_map_drive + @file_dwload_name + ' >> ' + @process_file_path + @file_dwload_name_temp                  
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                  
     SELECT  @cmd = 'echo '+ 'get ' + @FILE_DWLOAD_MAP_DRIVE + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP             
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT                  
     SELECT  @cmd = 'echo '+ 'quit'+ ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                  
     -- Executing steps from working file                  
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT  
     
               
                  
     CREATE TABLE #FILELIST                         
     (                   
      FILENAMELIST VARCHAR(MAX)                  
     )                   
                  
     SELECT  @cmd = 'ftp -s:' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP                  
       
     -- Executing final step                  
     INSERT INTO #FILELIST                  
     EXEC master..xp_cmdshell @cmd--, NO_OUTPUT                  
                    
     DELETE FROM #FILELIST                  
     WHERE FILENAMELIST IS  NULL                  
                  
     DELETE FROM #FILELIST                  
     WHERE FILENAMELIST NOT LIKE '%' + @FILE_DWLOAD_NAME + '%'                  
                  
     DELETE FROM #FILELIST                  
     WHERE FILENAMELIST LIKE 'DIR%'                  
                  
     DELETE FROM #FILELIST                  
     WHERE FILENAMELIST LIKE 'GET%'                  
                  
     UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')                  
                  
     SET @FLD_FILEDATE = '1900-01-01'                  
                  
     SELECT @FLD_FILEDATE = CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),1)                  
     FROM #FILELIST                  
       
   IF LEFT(@FLD_FILEDATE,11) <> @BUSINESS_DATE              
   BEGIN              
    IF (@PROCESS_FOR = 'EXCHANGE APP VAR' OR @PROCESS_FOR = 'IMPORT_CONTRACT_MASTER') AND @PREV_DATE = LEFT(@FLD_FILEDATE,11)             
    BEGIN              
     SET @CMD = ''                  
    END            
    ELSE             
    BEGIN              
     SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @process_file_path + @file_dwload_name + ''', NO_OUTPUT '              
     EXEC (@CMD)                    
    END              
   END       
                
   SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP + ''', NO_OUTPUT '              
   EXEC (@CMD)              
          
   DROP TABLE #FILELIST              
  END              
 END                         
   IF @PROCESS_FILE_NAME <> ''                  
   BEGIN                  
    SET @PROCESS_FILE_NAME_NEW = @PROCESS_FILE_PATH + @PROCESS_FILE_NAME                  
    IF PRADNYA.DBO.CHECKZIPFILE(@FILE_DWLOAD_NAME) > 0                  
    BEGIN                  
     SET @CMD = 'EXEC XP_CMDSHELL ''"C:\program files\Winzip\WZUNZIP.exe" -yb -o ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'                  
     EXEC (@CMD)                  
                  
     SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '                  
     EXEC (@CMD)                  
    END                  
   END                  
         
   EXEC MASTER.DBO.XP_FILEEXIST @PROCESS_FILE_NAME_NEW, @ISEXISTS OUTPUT                  
   IF @ISEXISTS = 0                   
   BEGIN                  
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = 'FILE NOT AVAILABLE IN THE SPECIFIED LOCATION.',                  
    PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()                  
    WHERE SNO = @SNO                  
   END                  
   ELSE                  
   BEGIN                     
    SET @ERRFLAG = 0   
	--print @PROCESS_SP_NAME
	--return
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))                  
    WHERE SNO = @SNO           
               
    BEGIN                  
   IF @INTERNAL_PROCESS_ID <= 1000                   
   BEGIN          
     BEGIN TRAN                  
   END          
      BEGIN TRY                  
       SET @CMD = @PROCESS_SP_NAME                   
       --PRINT @CMD                  
       EXEC (@CMD)                         
      END TRY                  
   BEGIN CATCH               
  IF @INTERNAL_PROCESS_ID <= 1000                   
  BEGIN             
   ROLLBACK TRAN                  
  END          
       UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),                  
       PROCESS_STATUS = 0                  
       WHERE SNO = @SNO                  
       SET @ERRFLAG = 1                  
      END CATCH                  

	 EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT 
                        
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_MOVE_PATH + ''', NO_OUTPUT'                  
     EXEC (@CMD)                  
     SELECT @TIME = REPLACE(CONVERT(VARCHAR,GETDATE(),108),':','')                  
     IF LEN(@PROCESS_FILE_MOVE_PATH) > 0                   
     BEGIN                  
      SET @CMD = 'EXEC XP_CMDSHELL ''MOVE ' + @PROCESS_FILE_NAME_NEW + ' ' + @PROCESS_FILE_MOVE_PATH + @PROCESS_FILE_NAME + @TIME + ''', NO_OUTPUT'                  
     END                  
     ELSE                  
     BEGIN                  
      SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_NAME_NEW + ''', NO_OUTPUT'                  
     END                  
     EXEC (@CMD)                  
                  
     IF @ERRFLAG = 0               
  BEGIN                   
   IF ISNULL(@FLD_FILENAME,'') <> ''          
   BEGIN          
		INSERT INTO TBL_AUTO_PROCESS_FILE VALUES (@FLD_FILENAME, @FLD_FILEDATE, GETDATE())                  
   END      

   IF @INTERNAL_PROCESS_ID <= 1000                   
   BEGIN          
      COMMIT TRAN                  
   END          
                     
      IF LEN(@PROCESS_CHECK_QUERY) > 0                   
      BEGIN                  
       SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''                  
       SET @CMD = @CMD + ' IF (@RECCNT) > 0 '                  
       SET @CMD = @CMD + ' BEGIN '                  
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','                  
       SET @CMD = @CMD + '  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '                  
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                  
                         
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                  
       SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
       SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
       SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'              
    SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                  
                         
       IF @OTHER_DBDETAILS <> ''                  
       BEGIN                  
        SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                  
        SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
        SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
        SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
        SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                  
        SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                  
       END                  
       SET @CMD = @CMD + ' END '                  
       SET @CMD = @CMD + ' ELSE '                   
       SET @CMD = @CMD + ' BEGIN '                   
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET '                  
       SET @CMD = @CMD + '  PROCESS_HALTED_REASON = @MSG,'                  
       SET @CMD = @CMD + '  PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '                  
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                  
       SET @CMD = @CMD + ' END '                  
       EXEC (@CMD)                  
      END                  
      ELSE                  
      BEGIN                  
       SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '                  
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '                  
       SET @CMD = @CMD + ' BEGIN '                  
                  
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                  
       SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
       SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
       SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
       SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                  
       IF @OTHER_DBDETAILS <> ''                  
       BEGIN                  
     SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                  
        SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
        SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
        SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
        SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                  
        SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                  
       END                  
       SET @CMD = @CMD + ' END '                  
       EXEC (@CMD)                  
      END                  
 END                      
    END                  
   END                  
  END                  
 ELSE                  
  BEGIN                  
   SET @ERRFLAG = 0                  
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))          
WHERE SNO = @SNO          
   IF @INTERNAL_PROCESS_ID <= 1000                   
   BEGIN          
  BEGIN TRAN                    
   END          
    BEGIN TRY                  
     SET @CMD = @PROCESS_SP_NAME                   
     PRINT @CMD                  
     EXEC (@CMD)                  
    END TRY                  
    BEGIN CATCH                  
 IF @INTERNAL_PROCESS_ID <= 1000                   
 BEGIN          
   ROLLBACK TRAN                  
 END          
--print ERROR_MESSAGE()                  
     UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),                  
     PROCESS_STATUS = 0                  
     WHERE SNO = @SNO                  
     SET @ERRFLAG = 1                  
    END CATCH                  
   IF @ERRFLAG = 0                        
   BEGIN                  
 IF @INTERNAL_PROCESS_ID <= 1000                   
    BEGIN          
  COMMIT TRAN                  
    END          
              
    IF LEN(@PROCESS_CHECK_QUERY) > 0                   
    Begin                  
  SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''                  
     SET @CMD = @CMD + ' IF (@RECCNT) > 0 '                  
     SET @CMD = @CMD + ' BEGIN '                  
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','                  
     SET @CMD = @CMD + '  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '                  
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                  
                  
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                  
     SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
     SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
     SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
     SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                  
     IF @OTHER_DBDETAILS <> ''                  
     BEGIN                  
      SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                  
      SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
      SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
      SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
      SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                  
      SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                  
     END                  
                  
     SET @CMD = @CMD + ' END '                  
     SET @CMD = @CMD + ' ELSE '                   
     SET @CMD = @CMD + ' BEGIN '                   
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET '                  
     SET @CMD = @CMD + '  PROCESS_HALTED_REASON = @MSG,'                  
     SET @CMD = @CMD + '  PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '                  
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '                  
     SET @CMD = @CMD + ' END '                  
     EXEC (@CMD)                  
    END                  
    ELSE                  
    BEGIN                  
     SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '                  
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '                  
     SET @CMD = @CMD + ' BEGIN '             
               
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '                  
     SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
     SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
     SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
     SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''                  
     IF @OTHER_DBDETAILS <> ''                  
     BEGIN                  
      SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '                  
      SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '                  
      SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '                   
      SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'                  
      SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''                  
      SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''                  
     END                  
     SET @CMD = @CMD + ' END '                  
     EXEC (@CMD)                  
    END                  
   END                  
  END                  
 END                  
 ELSE                  
 BEGIN                  
  IF @CHKFLAG = 1                   
  BEGIN                  
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @PROCESS_HALTED_REASON,                  
   PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()                  
   WHERE SNO = @SNO AND PROCESS_STATUS = 0                  
  END                
 END                  
 FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FREQ, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,                   
              @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,                  
           @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,              
           @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,                  
              @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                  
END                  
CLOSE @PROCESS_CURSOR                  
DEALLOCATE @PROCESS_CURSOR                  
                  
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;                  
                  
EXEC CLASS_AUTO_PROCESS_ALERT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETUP
-- --------------------------------------------------
  
CREATE PROC [dbo].[CLASS_AUTO_PROCESS_SETUP]          
(          
 @BUSINESS_DATE VARCHAR(11)          
)          
AS          
          
DECLARE @PROCESSCURSOR CURSOR,          
  @SETT_NO  VARCHAR(7),           
  @SETT_TYPE  VARCHAR(2),          
  @NEWPROCESS_ID INT          
          
IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST        
 WHERE START_DATE = LEFT(GETDATE(),11)) > 0        
BEGIN          
 SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)           
 FROM   TBL_AUTO_PROCESS_MASTER          
           
 CREATE TABLE #MASTER_SETUP          
 (          
  [PROCESS_ID]  [INT] ,          
  [SETT_NO]   [VARCHAR](20) ,          
  [SETT_TYPE]   [VARCHAR](20) ,          
  [PROCESS_FOR]  [VARCHAR](30) ,          
  [IS_DEPEND_ON]  [VARCHAR](20) ,          
  [NEWPROCESS_ID]  [INT]  ,          
  [BUSINESS_DATE]  [VARCHAR](11)  ,          
  [PROCESS_START_DATE][DATETIME] ,          
  [PROCESS_END_DATE] [DATETIME]           
 )          
           
 IF (SELECT DISTINCT SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = DB_NAME()) ='CAPITAL'          
 BEGIN          
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
            
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M           
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS', 'I', 'Q')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'TRADE'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND PROCESS_FOR <> 'DAILYOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M           
   WHERE LEFT(SEC_PAYIN,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS', 'I', 'Q')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'SETTLEMENT'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M           
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'TRADE'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND PROCESS_FOR = 'DAILYOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M, (SELECT START_DATE = MAX(START_DATE) FROM SETT_MST M1           
     WHERE CONVERT(DATETIME,LEFT(START_DATE,11)) < @BUSINESS_DATE          
     AND SETT_TYPE IN ('N', 'D')) M1          
   WHERE LEFT(M.START_DATE,11) = LEFT(M1.START_DATE,11)          
   AND M.SETT_TYPE NOT IN ('O', 'Z')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'SETTLEMENT'          
   AND PROCESS_FOR = 'FINOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)           
  FROM TBL_AUTO_PROCESS_MASTER T          
  WHERE PROCESS_TYPE <> 'SETTLEMENT'          
  AND PROCESS_FREQ = 'ONCE'          
  AND T.SETT_TYPE = ''          
  ORDER BY 1          
 END          
 ELSE          
 BEGIN          
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)           
  FROM TBL_AUTO_PROCESS_MASTER T          
  WHERE PROCESS_TYPE = 'TRADE'          
  AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
 END          
           
 DECLARE @PROCESS_ID     INT,          
   @STARTDATE     DATETIME,          
   @ENDDATE     DATETIME,          
   @PROCESS_REPEAT_INTERVAL INT,          
   @PROCESS_CURSOR    CURSOR,          
   @TEMPPROCESS_ID    INT,          
   @NEWSTARTDATE    DATETIME,          
   @NEWENDDATE     DATETIME          
           
           
 CREATE TABLE #DATA          
 (          
  PROCESS_ID INT,          
  STARTDATE DATETIME,          
  ENDDATE  DATETIME          
 )          
           
 SET @PROCESS_CURSOR = CURSOR FOR          
 SELECT PROCESS_ID,          
  STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,           
  ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,          
  PROCESS_REPEAT_INTERVAL          
 FROM TBL_AUTO_PROCESS_MASTER          
 WHERE PROCESS_FREQ = 'MULTIPLE'          
 ORDER BY PROCESS_ID          
 OPEN @PROCESS_CURSOR          
 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL          
 WHILE @@FETCH_STATUS = 0          
 BEGIN          
  SET @TEMPPROCESS_ID = @PROCESS_ID          
  SET @NEWSTARTDATE = @STARTDATE          
  WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0          
  BEGIN           
   SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)          
   IF @NEWENDDATE > @ENDDATE          
   BEGIN          
    SET @NEWENDDATE = @ENDDATE          
   END          
   INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)          
   SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)          
  END          
  FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL          
 END          
 CLOSE @PROCESS_CURSOR          
 DEALLOCATE @PROCESS_CURSOR          
           
 INSERT INTO #MASTER_SETUP          
 SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
  PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
  BUSINESS_DATE = @BUSINESS_DATE,          
  PROCESS_START_DATE=STARTDATE,          
  PROCESS_END_DATE=ENDDATE          
  FROM TBL_AUTO_PROCESS_MASTER M, #DATA D          
 WHERE M.PROCESS_ID = D.PROCESS_ID          
           
 TRUNCATE TABLE #DATA          
 DROP TABLE #DATA          
           
 ALTER TABLE #MASTER_SETUP          
 ADD SNO INT IDENTITY(1,1)          
           
 UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO          
        
 DECLARE @INTLOOP INT          
 DECLARE @INTLOOP_MAX INT          
 SET @INTLOOP = 1          
 SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP          
           
 WHILE @INTLOOP <= @INTLOOP_MAX          
 BEGIN          
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')          
  FROM #MASTER_SETUP M1, #MASTER_SETUP          
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'          
  AND #MASTER_SETUP.SETT_NO = M1.SETT_NO          
  AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE          
  AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE          
  AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2          
    WHERE M1.PROCESS_ID = M2.PROCESS_ID          
    AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)          
  SET @INTLOOP = @INTLOOP + 1          
 END          
           
 ALTER TABLE #MASTER_SETUP          
 ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)          
           
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON        
           
 SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP          
 SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP          
           
 WHILE @INTLOOP <= @INTLOOP_MAX          
 BEGIN          
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP =         
  REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',        
  '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')            
  FROM #MASTER_SETUP M1, #MASTER_SETUP          
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'          
  AND M1.NEWPROCESS_ID = @INTLOOP           
           
  SET @INTLOOP = @INTLOOP + 1          
 END            
        
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP          
 WHERE IS_DEPEND_ON_ORG_TEMP <> ''          
           
 DELETE TBL_AUTO_PROCESS_DETAIL          
 WHERE PROCESS_DATE = LEFT(GETDATE(),11)          
 --AND PROCESS_FOR <> 'COLLATERAL'  
           
 INSERT INTO TBL_AUTO_PROCESS_DETAIL          
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),          
  EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,          
  SETT_NO,          
  SETT_TYPE,          
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,          
  PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',          
  PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',          
  PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,          
  PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,           
  PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',          
  PROCESS_OUTPUT_QUERY,'',    
  PROCESS_ORDER_ID          
 FROM TBL_AUTO_PROCESS_MASTER          
 WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)          
 AND SETT_NO <> '<SETNO>'          
 --AND PROCESS_FOR <> 'COLLATERAL'  
           
 INSERT INTO TBL_AUTO_PROCESS_DETAIL          
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),          
  EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,          
  S.SETT_NO,          
  S.SETT_TYPE,          
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,          
  S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,          
  PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,          
  WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,          
  PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,           
  PROCESS_STATUS_ALERT_INTERVAL, '',          
  PROCESS_OUTPUT_QUERY,'',    
  PROCESS_ORDER_ID          
 FROM TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S          
 WHERE M.PROCESS_ID = S.PROCESS_ID          
 AND S.SETT_NO <> '<SETNO>'          
 --AND M.PROCESS_FOR <> 'COLLATERAL'  
           
 TRUNCATE TABLE #MASTER_SETUP          
 DROP TABLE #MASTER_SETUP      
END        
          
/*          
SET @PROCESSCURSOR = CURSOR FOR          
 SELECT SETT_NO, SETT_TYPE FROM SETT_MST WHERE START_DATE = @BUSINESS_DATE          
 AND SETT_TYPE NOT IN ('O', 'Z')          
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)          
 ORDER BY SETT_NO, SETT_TYPE          
OPEN @PROCESSCURSOR          
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE          
WHILE @@FETCH_STATUS = 0          
BEGIN          
 SELECT @SETT_NO, @SETT_TYPE          
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE          
END          
CLOSE @PROCESSCURSOR          
DEALLOCATE @PROCESSCURSOR          
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETUP_29062021
-- --------------------------------------------------
  
CREATE PROC [dbo].[CLASS_AUTO_PROCESS_SETUP]          
(          
 @BUSINESS_DATE VARCHAR(11)          
)          
AS          
          
DECLARE @PROCESSCURSOR CURSOR,          
  @SETT_NO  VARCHAR(7),           
  @SETT_TYPE  VARCHAR(2),          
  @NEWPROCESS_ID INT          
          
IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST        
 WHERE START_DATE = LEFT(GETDATE(),11)) > 0        
BEGIN          
 SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)           
 FROM   TBL_AUTO_PROCESS_MASTER          
           
 CREATE TABLE #MASTER_SETUP          
 (          
  [PROCESS_ID]  [INT] ,          
  [SETT_NO]   [VARCHAR](20) ,          
  [SETT_TYPE]   [VARCHAR](20) ,          
  [PROCESS_FOR]  [VARCHAR](30) ,          
  [IS_DEPEND_ON]  [VARCHAR](20) ,          
  [NEWPROCESS_ID]  [INT]  ,          
  [BUSINESS_DATE]  [VARCHAR](11)  ,          
  [PROCESS_START_DATE][DATETIME] ,          
  [PROCESS_END_DATE] [DATETIME]           
 )          
           
 IF (SELECT DISTINCT SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = DB_NAME()) ='CAPITAL'          
 BEGIN          
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
            
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M           
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS', 'I', 'Q')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'TRADE'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND PROCESS_FOR <> 'DAILYOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M           
   WHERE LEFT(SEC_PAYIN,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS', 'I', 'Q')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'SETTLEMENT'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M           
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'TRADE'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND PROCESS_FOR = 'DAILYOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M, (SELECT START_DATE = MAX(START_DATE) FROM SETT_MST M1           
     WHERE CONVERT(DATETIME,LEFT(START_DATE,11)) < @BUSINESS_DATE          
     AND SETT_TYPE IN ('N', 'D')) M1          
   WHERE LEFT(M.START_DATE,11) = LEFT(M1.START_DATE,11)          
   AND M.SETT_TYPE NOT IN ('O', 'Z')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'SETTLEMENT'          
   AND PROCESS_FOR = 'FINOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)           
  FROM TBL_AUTO_PROCESS_MASTER T          
  WHERE PROCESS_TYPE <> 'SETTLEMENT'          
  AND PROCESS_FREQ = 'ONCE'          
  AND T.SETT_TYPE = ''          
  ORDER BY 1          
 END          
 ELSE          
 BEGIN          
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)           
  FROM TBL_AUTO_PROCESS_MASTER T          
  WHERE PROCESS_TYPE = 'TRADE'          
  AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
 END          
           
 DECLARE @PROCESS_ID     INT,          
   @STARTDATE     DATETIME,          
   @ENDDATE     DATETIME,          
   @PROCESS_REPEAT_INTERVAL INT,          
   @PROCESS_CURSOR    CURSOR,          
   @TEMPPROCESS_ID    INT,          
   @NEWSTARTDATE    DATETIME,          
   @NEWENDDATE     DATETIME          
           
           
 CREATE TABLE #DATA          
 (          
  PROCESS_ID INT,          
  STARTDATE DATETIME,          
  ENDDATE  DATETIME          
 )          
           
 SET @PROCESS_CURSOR = CURSOR FOR          
 SELECT PROCESS_ID,          
  STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,           
  ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,          
  PROCESS_REPEAT_INTERVAL          
 FROM TBL_AUTO_PROCESS_MASTER          
 WHERE PROCESS_FREQ = 'MULTIPLE'          
 ORDER BY PROCESS_ID          
 OPEN @PROCESS_CURSOR          
 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL          
 WHILE @@FETCH_STATUS = 0          
 BEGIN          
  SET @TEMPPROCESS_ID = @PROCESS_ID          
  SET @NEWSTARTDATE = @STARTDATE          
  WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0          
  BEGIN           
   SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)          
   IF @NEWENDDATE > @ENDDATE          
   BEGIN          
    SET @NEWENDDATE = @ENDDATE          
   END          
   INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)          
   SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)          
  END          
  FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL          
 END          
 CLOSE @PROCESS_CURSOR          
 DEALLOCATE @PROCESS_CURSOR          
           
 INSERT INTO #MASTER_SETUP          
 SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
  PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
  BUSINESS_DATE = @BUSINESS_DATE,          
  PROCESS_START_DATE=STARTDATE,          
  PROCESS_END_DATE=ENDDATE          
  FROM TBL_AUTO_PROCESS_MASTER M, #DATA D          
 WHERE M.PROCESS_ID = D.PROCESS_ID          
           
 TRUNCATE TABLE #DATA          
 DROP TABLE #DATA          
           
 ALTER TABLE #MASTER_SETUP          
 ADD SNO INT IDENTITY(1,1)          
           
 UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO          
        
 DECLARE @INTLOOP INT          
 DECLARE @INTLOOP_MAX INT          
 SET @INTLOOP = 1          
 SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP          
           
 WHILE @INTLOOP <= @INTLOOP_MAX          
 BEGIN          
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')          
  FROM #MASTER_SETUP M1, #MASTER_SETUP          
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'          
  AND #MASTER_SETUP.SETT_NO = M1.SETT_NO          
  AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE          
  AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE          
  AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2          
    WHERE M1.PROCESS_ID = M2.PROCESS_ID          
    AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)          
  SET @INTLOOP = @INTLOOP + 1          
 END          
           
 ALTER TABLE #MASTER_SETUP          
 ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)          
           
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON        
           
 SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP          
 SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP          
           
 WHILE @INTLOOP <= @INTLOOP_MAX          
 BEGIN          
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP =         
  REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',        
  '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')            
  FROM #MASTER_SETUP M1, #MASTER_SETUP          
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'          
  AND M1.NEWPROCESS_ID = @INTLOOP           
           
  SET @INTLOOP = @INTLOOP + 1          
 END            
        
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP          
 WHERE IS_DEPEND_ON_ORG_TEMP <> ''          
           
 DELETE TBL_AUTO_PROCESS_DETAIL          
 WHERE PROCESS_DATE = LEFT(GETDATE(),11)          
 --AND PROCESS_FOR <> 'COLLATERAL'  
           
 INSERT INTO TBL_AUTO_PROCESS_DETAIL          
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),          
  EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,          
  SETT_NO,          
  SETT_TYPE,          
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,          
  PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',          
  PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',          
  PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,          
  PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,           
  PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',          
  PROCESS_OUTPUT_QUERY,'',    
  PROCESS_ORDER_ID          
 FROM TBL_AUTO_PROCESS_MASTER          
 WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)          
 AND SETT_NO <> '<SETNO>'          
 --AND PROCESS_FOR <> 'COLLATERAL'  
           
 INSERT INTO TBL_AUTO_PROCESS_DETAIL          
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),          
  EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,          
  S.SETT_NO,          
  S.SETT_TYPE,          
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,          
  S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,          
  PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,          
  WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,          
  PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,           
  PROCESS_STATUS_ALERT_INTERVAL, '',          
  PROCESS_OUTPUT_QUERY,'',    
  PROCESS_ORDER_ID          
 FROM TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S          
 WHERE M.PROCESS_ID = S.PROCESS_ID          
 AND S.SETT_NO <> '<SETNO>'          
 --AND M.PROCESS_FOR <> 'COLLATERAL'  
           
 TRUNCATE TABLE #MASTER_SETUP          
 DROP TABLE #MASTER_SETUP      
END        
          
/*          
SET @PROCESSCURSOR = CURSOR FOR          
 SELECT SETT_NO, SETT_TYPE FROM SETT_MST WHERE START_DATE = @BUSINESS_DATE          
 AND SETT_TYPE NOT IN ('O', 'Z')          
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)          
 ORDER BY SETT_NO, SETT_TYPE          
OPEN @PROCESSCURSOR          
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE          
WHILE @@FETCH_STATUS = 0          
BEGIN          
 SELECT @SETT_NO, @SETT_TYPE          
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE          
END          
CLOSE @PROCESSCURSOR          
DEALLOCATE @PROCESSCURSOR          
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_UPDATE
-- --------------------------------------------------

    
CREATE PROCEDURE [DBO].[CLASS_AUTO_PROCESS_UPDATE]    
(    
 @PROCESSDATE VARCHAR(11),    
 @PROCESSFLAG VARCHAR(2),    
 @PROCESSID VARCHAR(MAX),    
 @TIME VARCHAR(5),    
 @UNAME VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @REQIP VARCHAR(100),    
 @STATUSID VARCHAR(25)    
)    
AS    
--EXEC CLASS_AUTO_PROCESS_UPDATE @PROCESSDATE='19/12/2014',@PROCESSFLAG='RS',@PROCESSID='51~63~55~59~',@TIME='15:52',@STATUSID='BROKER',@STATUSNAME='BROKER',@UNAME='YATINN',@REQIP='::1'    
    
    
/*    
 @PROCESSFLAG  : RS - RE SCHEDULE PROCESS    
 @PROCESSFLAG  : RM - MARK TO RESUMING A PROCESS    
 @PROCESSFLAG  : CM - MARK TO PROCESS COMPLETED    
    
 PROCESS_STATUS = 0  - 'PENDING'     
 PROCESS_STATUS = 100 - 'COMPLETTED'     
 PROCESS_STATUS = 99  - 'IN - PROCESS'     
 ELSE     -'HALT DUE TO SOME ISSUE'    
     
*/    
    
SET @PROCESSDATE = LEFT(CONVERT(DATETIME,@PROCESSDATE,103),11)    
    
DECLARE @NEWSTART_TIME DATETIME    
DECLARE @ERRCODE INT    
DECLARE @ERRSDESC VARCHAR(100)    
    
CREATE TABLE #PROCESSID (PSNO INT IDENTITY(1,1), PROCID INT)    
INSERT INTO #PROCESSID     
SELECT * FROM DBO.FNSPLITSTRING2TBL(@PROCESSID,'~')    
    
--------------------------------- RE SCHEDULE ----------------------------------    
IF @PROCESSFLAG='RS'      
BEGIN    
 SET @NEWSTART_TIME = LEFT(CONVERT(DATETIME, @PROCESSDATE),11) + ' ' + @TIME  
  
 IF @NEWSTART_TIME < GETDATE()    
 BEGIN    
  SET @ERRCODE = -1    
  SET @ERRSDESC = 'INVALID PROCESS START NEW TIME'    
  SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
  RETURN    
 END    
      
 UPDATE TBL_AUTO_PROCESS_DETAIL SET     
 PROCESS_START_DATE = @NEWSTART_TIME,     
 PROCESS_STARTED_DATE = '',     
 PROCESS_ENDED_DATE = '',     
 PROCESS_END_DATE  = (CASE WHEN PROCESS_END_DATE <= @NEWSTART_TIME   
         THEN DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)    
         ELSE PROCESS_END_DATE  
       END),  
 PROCESS_STATUS = 0,  
 PROCESS_HALTED_REASON = '',  
 IS_DEPEND_ON = (CASE WHEN B.PSNO = 1 THEN IS_DEPEND_ON ELSE IS_DEPEND_ON_ORG END)  
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND PROCESS_START_DATE < @NEWSTART_TIME    
    
 DROP TABLE #PROCESSID    
     
 SET @ERRCODE = 0    
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'    
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
 RETURN    
END    
    
    
--------------------------------- MARK TO RESUMING A PROCESS ---------------------------------    
IF @PROCESSFLAG='RM'      
BEGIN    
 SET @NEWSTART_TIME = CONVERT(DATETIME, @PROCESSDATE + ' ' + CONVERT(VARCHAR(5),GETDATE(),114))    
     
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 0    
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
     
 -- RE SCHEDULING TO NEW TIMING     
 UPDATE TBL_AUTO_PROCESS_DETAIL SET     
 PROCESS_START_DATE = @NEWSTART_TIME,     
 PROCESS_END_DATE  = (CASE WHEN PROCESS_END_DATE <= @NEWSTART_TIME   
         THEN DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)    
         ELSE PROCESS_END_DATE  
       END)  
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND PROCESS_START_DATE < @NEWSTART_TIME    
    
 DROP TABLE #PROCESSID    
     
 SET @ERRCODE = 0    
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'    
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
 RETURN    
    
END    
     
--------------------------------- MARK TO COMPLETE ---------------------------------    
IF @PROCESSFLAG='CM'       
BEGIN    
     
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 100,  
 PROCESS_HALTED_REASON = 'MARKED SUCCESS BY THE USER ' + UPPER(@UNAME),  
 PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 1,  
 PROCESS_ENDED_DATE = GETDATE()  
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND B.PSNO = 1   
  
UPDATE TBL_AUTO_PROCESS_DETAIL SET  IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,'#'+CONVERT(VARCHAR,C.PROCID)+',','')   
 FROM #PROCESSID B, #PROCESSID C    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND B.PSNO <> 1   
 AND C.PSNO = 1  
    
 DROP TABLE #PROCESSID    
     
 SET @ERRCODE = 0    
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'    
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
 RETURN    
END    
    
/*------------------------------------------ END OF THE PROC ---------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_VIEW
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_VIEW]      
(       
 @PROCESSDATE VARCHAR(11),      
 @PROCESSON VARCHAR(30),      
 @PROCESSTYPE VARCHAR(30),      
 @PROCESSFOR VARCHAR(30),      
 @UNAME VARCHAR(25),      
 @STATUSNAME VARCHAR(25),      
 @REQIP VARCHAR(100),      
 @STATUSID VARCHAR(25),      
 @PROCESSID BIGINT,      
 @LEVEL VARCHAR(1)       
)      
AS      
      
OPEN SYMMETRIC KEY   Key4CertAutoProcess      
     DECRYPTION BY   CERTIFICATE CertAutoProcess       

DECLARE @PROCESSON_FROM INT
DECLARE @PROCESSON_TO INT

IF @PROCESSON = ''
BEGIN
	SET @PROCESSON_FROM = 0
	SET @PROCESSON_TO = 100
END
IF @PROCESSON = '0'
BEGIN
	SET @PROCESSON_FROM = 0
	SET @PROCESSON_TO = 99
END
IF @PROCESSON IN (98,99,100)
BEGIN
	SET @PROCESSON_FROM = @PROCESSON
	SET @PROCESSON_TO = @PROCESSON
END
	
SET @PROCESSDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @PROCESSDATE, 103), 109)       
BEGIN       
        
 IF @LEVEL='1'---summary      
 BEGIN       
  SELECT SNO      
  ,PROCESS_TYPE     
  , PROCESS_ORDER_ID               
  ,PROCESS_FOR      
  ,PROCESS_ID      
  ,SETT_NO      
  ,SETT_TYPE      
  ,PROCESS_START_DATE = CONVERT(VARCHAR(5),(CASE WHEN PROCESS_STARTED_DATE NOT LIKE 'JAN  1 1900%' THEN PROCESS_STARTED_DATE ELSE PROCESS_START_DATE END),114)      
  ,PROCESS_END_DATE = CONVERT(VARCHAR(5),(CASE WHEN PROCESS_ENDED_DATE NOT LIKE 'JAN  1 1900%' THEN PROCESS_ENDED_DATE ELSE PROCESS_END_DATE END),114)      
  ,PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME)      
  ,WAIT_PERIOD = LEFT(WAIT_PERIOD,5)      
  ,APPROX_END_TIME = LEFT(APPROX_END_TIME,5)      
  ,PROCESS_STATUS = (CASE WHEN PROCESS_STATUS = 0 THEN 'PENDING' WHEN PROCESS_STATUS = 100 THEN 'COMPLETTED'       
       WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS' ELSE 'HALT DUE TO SOME ISSUE' END)       
  ,PROCESS_HALTED_REASON = REPLACE(REPLACE(PROCESS_HALTED_REASON, '<FONT COLOR=''RED''>',''),'</FONT>','')    
  FROM .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK)      
  WHERE       
  PROCESS_DATE = @PROCESSDATE      
  AND PROCESS_FOR LIKE CASE WHEN @PROCESSFOR='-----SELECT-----' THEN '' ELSE @PROCESSFOR END + '%'      
  AND PROCESS_TYPE LIKE CASE WHEN @PROCESSTYPE='-----SELECT-----' THEN '' ELSE @PROCESSTYPE END + '%'      
  AND PROCESS_STATUS BETWEEN @PROCESSON_FROM AND @PROCESSON_TO 
  ORDER BY PROCESS_ORDER_ID                 
 END      
       
 IF @LEVEL='2'---detail      
 BEGIN       
        
  DECLARE @PROCESSCUR CURSOR       
  DECLARE @IS_DEPEND_ON_ORG VARCHAR(20)      
  DECLARE @PROCESS_ID BIGINT         
        
  CREATE TABLE #PROCESSID (PROCID BIGINT,DEPEND_ON BIGINT)      
      
  SET @PROCESSCUR = CURSOR FOR          
      SELECT PROCESS_ID,IS_DEPEND_ON_ORG=REPLACE(IS_DEPEND_ON_ORG,'#','')       
      FROM .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK)      
      WHERE PROCESS_DATE = @PROCESSDATE      
      AND IS_DEPEND_ON_ORG <> ''      
      --AND IS_DEPEND_ON_ORG LIKE '%#' + CONVERT(VARCHAR,@PROCESSID) + ',%'      
  OPEN @PROCESSCUR      
        
  FETCH NEXT FROM @PROCESSCUR INTO @PROCESS_ID, @IS_DEPEND_ON_ORG      
  WHILE @@FETCH_STATUS = 0      
  BEGIN      
   INSERT INTO #PROCESSID      
   SELECT @PROCESS_ID,* FROM dbo.fnSplitString2Tbl(@IS_DEPEND_ON_ORG,',')      
         
   FETCH NEXT FROM @PROCESSCUR INTO @PROCESS_ID, @IS_DEPEND_ON_ORG      
  END      
  CLOSE @PROCESSCUR      
  DEALLOCATE @PROCESSCUR      
  delete from #processid where DEPEND_ON = 0       
      
  INSERT INTO #PROCESSID      
  SELECT PROCESS_ID,IS_DEPEND_ON_ORG=REPLACE(REPLACE(IS_DEPEND_ON_ORG,'#',''),',','')       
  FROM  .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK) WHERE PROCESS_DATE = @PROCESSDATE       
  AND PROCESS_ID NOT IN(SELECT PROCID FROM #PROCESSID)      
  --AND IS_DEPEND_ON_ORG LIKE '%#' + CONVERT(VARCHAR,@PROCESSID) + ',%'      
      
  CREATE TABLE #PROC(PROCID BIGINT,DPND BIGINT,FLAG BIGINT)      
  INSERT INTO #PROC VALUES(@PROCESSID,0,1)      
        
  DECLARE @EXITLOOP BIGINT      
  SET @EXITLOOP = 0      
      
  DECLARE @I BIGINT      
  SET @I = 1      
  --exec CLASS_AUTO_PROCESS_VIEW '18/12/2014','','','','','','','','12','2'      
  WHILE @EXITLOOP = 0      
  BEGIN      
   SET @I = @I + 1      
         
   INSERT INTO #PROC      
   SELECT PROCID,DEPEND_ON,@I FROM #PROCESSID WHERE DEPEND_ON IN (SELECT PROCID FROM #PROC WHERE FLAG=@I-1)      
         
   IF (SELECT COUNT(1) FROM #PROC WHERE FLAG=@I) =0      
   BEGIN      
    SET @EXITLOOP = 1      
   END      
      
  END      
         
  SELECT SNO      
  ,PROCESS_TYPE     
  , PROCESS_ORDER_ID               
  ,PROCESS_FOR      
  ,PROCESS_ID      
  ,SETT_NO      
  ,SETT_TYPE      
  ,PROCESS_START_DATE = CONVERT(VARCHAR(5),PROCESS_START_DATE,114)      
  ,PROCESS_END_DATE = CONVERT(VARCHAR(5),PROCESS_END_DATE,114)      
  ,PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME)      
  ,WAIT_PERIOD = LEFT(WAIT_PERIOD,5)      
  ,APPROX_END_TIME = LEFT(APPROX_END_TIME,5)      
  ,PROCESS_STATUS = (CASE WHEN PROCESS_STATUS = 0 THEN 'PENDING' WHEN PROCESS_STATUS = 100 THEN 'COMPLETTED'       
       WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS' ELSE 'HALT DUE TO SOME ISSUE' END)       
  ,PROCESS_HALTED_REASON        
  FROM .DBO.TBL_AUTO_PROCESS_DETAIL D (NOLOCK),#PROC       
  WHERE       
  PROCESS_DATE = @PROCESSDATE      
  --AND PROCESS_FOR LIKE CASE WHEN @PROCESSFOR='-----SELECT-----' THEN '' ELSE @PROCESSFOR END + '%'      
  --AND PROCESS_TYPE LIKE CASE WHEN @PROCESSTYPE='-----SELECT-----' THEN '' ELSE @PROCESSTYPE END + '%'      
  --AND PROCESS_STATUS  = CASE WHEN @PROCESSON <> '' THEN @PROCESSON ELSE PROCESS_STATUS END      
  AND PROCESS_ID = #PROC.PROCID      
  ORDER BY FLAG, PROCESS_ORDER_ID      
        
  DROP TABLE #PROCESSID      
  DROP TABLE #PROC      
      
 END       
END      
      
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_GET_AUTO_PROCESS_FOR_BULK
-- --------------------------------------------------

CREATE PROCEDURE CLASS_GET_AUTO_PROCESS_FOR_BULK  
AS  
BEGIN  
 OPEN SYMMETRIC KEY   Key4CertAutoProcess            
   DECRYPTION BY   CERTIFICATE CertAutoProcess       
  
 SELECT DISTINCT   
 FILE_DWLOAD_LOCATION=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION),  
 FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID),  
 FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD)  
 FROM TBL_AUTO_PROCESS_MASTER  
 WHERE DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION) <> ''  
   /* OR DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID) <> ''   
    OR DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD) <> ''*/  
  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_ADMIN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLASS_VALIDATE_ADMIN]      
(      
    @ADMINID     VARCHAR(50),      
    @IPADDRESS  VARCHAR(20),      
    @RETCODE    INT  OUTPUT,      
    @RETMSG     VARCHAR(200)  OUTPUT,      
    @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,      
    @LASTLOGIN VARCHAR(40) OUTPUT      
)      
AS      
  
  DECLARE  @@USER_COUNT TINYINT      
  DECLARE  @@LASTLOGIN VARCHAR(40)        
  DECLARE  @@USER_SESSION VARCHAR(200)      
      
                                
  SELECT @@USER_COUNT = COUNT(1)      
  FROM   TBLCLASSADMINLOGINS (NOLOCK)      
  WHERE  FLDADMINNAME = @ADMINID      
                          
  IF ISNULL(@@USER_COUNT,0) = 0      
    BEGIN      
      INSERT INTO TBLCLASSADMINLOGINS      
   (      
    FLDAUTO,      
    FLDADMINNAME,      
    FLDSTATUS,      
    FLDSTNAME,      
    FLDSESSION,      
    FLDIPADDRESS,      
    FLDLASTVISIT,      
    FLDTIMEOUTPRD      
   )    
   SELECT A.FLDAUTO_ADMIN,      
  A.FLDNAME,      
  A.FLDSTATUS,      
  A.FLDSTNAME,      
  '',      
  '',      
  GETDATE(),      
  ''     
   FROM   TBLADMIN A (NOLOCK)      
   WHERE  A.FLDNAME = @ADMINID     
                                   
   IF @@ERROR <> 0      
  BEGIN      
   SET @RETCODE = 0      
   SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'      
   RETURN      
  END      
 END      
          
      
 SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)      
 FROM TBLCLASSADMINLOGINS      
 WHERE FLDADMINNAME = @ADMINID      
      
      
 SET @@USER_SESSION = NEWID()      
                             
 UPDATE TBLCLASSADMINLOGINS      
 SET    FLDIPADDRESS = @IPADDRESS,      
   FLDSESSION = @@USER_SESSION,      
   FLDLASTVISIT = GETDATE(),      
   FLDLASTLOGIN = GETDATE()      
 WHERE  FLDADMINNAME = @ADMINID      
                              
  IF @@ERROR <> 0      
    BEGIN      
  SET @RETCODE = 0      
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'      
  RETURN      
    END      
          
  SET @RETCODE = 1      
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'      
  SET @UM_SESSION = @@USER_SESSION      
  SET @LASTLOGIN = @@LASTLOGIN                      
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_USER
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[CLASS_VALIDATE_USER]    
(    
                @USERID     VARCHAR(50),    
                @IPADDRESS  VARCHAR(20),    
                @RETCODE    INT  OUTPUT,    
                @RETMSG     VARCHAR(200)  OUTPUT,    
                @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,    
    @LASTLOGIN VARCHAR(40) OUTPUT    
)    
AS    
    
  DECLARE  @@USER_COUNT TINYINT    
  DECLARE  @@LASTLOGIN VARCHAR(40)      
  DECLARE  @@USER_SESSION VARCHAR(200)    
    
                              
  SELECT @@USER_COUNT = COUNT(1)    
  FROM   TBLCLASSUSERLOGINS (NOLOCK)    
  WHERE  FLDUSERNAME = @USERID    
                           
  IF ISNULL(@@USER_COUNT,0) = 0    
    BEGIN    
        
  INSERT INTO TBLCLASSUSERLOGINS    
  (    
   FLDAUTO,    
   FLDUSERNAME,    
   FLDSTATUS,    
   FLDSTNAME,    
   FLDSESSION,    
   FLDIPADDRESS,    
   FLDLASTVISIT,    
   FLDTIMEOUTPRD    
  )    
  SELECT P.FLDAUTO,    
     P.FLDUSERNAME,    
     A.FLDSTATUS,    
     P.FLDSTNAME,    
     '',    
     '',    
     GETDATE(),    
     ISNULL(M.FLDTIMEOUT,1)    
  FROM   TBLPRADNYAUSERS P (NOLOCK)    
     LEFT OUTER JOIN TBLUSERCONTROLMASTER M (NOLOCK)    
    ON (M.FLDUSERID = P.FLDAUTO)    
     INNER JOIN TBLADMIN A (NOLOCK)    
    ON (P.FLDADMINAUTO = A.FLDAUTO_ADMIN)    
  WHERE  P.FLDUSERNAME = @USERID    
                                 
  IF @@ERROR <> 0    
    BEGIN    
   SET @RETCODE = 0    
               
   SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'    
               
   RETURN    
    END    
            
    END    
        
    
     SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)    
 FROM TBLCLASSUSERLOGINS    
 WHERE FLDUSERNAME = @USERID    
    
    
 SET @@USER_SESSION = NEWID()    
                           
 UPDATE TBLCLASSUSERLOGINS    
 SET    FLDIPADDRESS = @IPADDRESS,    
   FLDSESSION = @@USER_SESSION,    
   FLDLASTVISIT = GETDATE(),    
   FLDLASTLOGIN = GETDATE()    
 WHERE  FLDUSERNAME = @USERID    
                            
  IF @@ERROR <> 0    
    BEGIN    
  SET @RETCODE = 0    
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'    
  RETURN    
    END    
        
  SET @RETCODE = 1    
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'    
  SET @UM_SESSION = @@USER_SESSION    
  SET @LASTLOGIN = @@LASTLOGIN                    
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_USER_21042011
-- --------------------------------------------------
    
   CREATE PROCEDURE [DBO].[CLASS_VALIDATE_USER_21042011]      
(      
                @USERID     VARCHAR(50),      
                @IPADDRESS  VARCHAR(20),      
                @RETCODE    INT  OUTPUT,      
                @RETMSG     VARCHAR(200)  OUTPUT,      
                @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,      
    @LASTLOGIN VARCHAR(40) OUTPUT      
)      
AS      
      
  DECLARE  @@USER_COUNT TINYINT      
  DECLARE  @@LASTLOGIN VARCHAR(40)        
  DECLARE  @@USER_SESSION VARCHAR(200)      
      
                                
  SELECT @@USER_COUNT = COUNT(1)      
  FROM   TBLCLASSUSERLOGINS (NOLOCK)      
  WHERE  FLDUSERNAME = @USERID      
                             
  IF ISNULL(@@USER_COUNT,0) = 0      
    BEGIN      
          
  INSERT INTO TBLCLASSUSERLOGINS      
  (      
   FLDAUTO,      
   FLDUSERNAME,      
   FLDSTATUS,      
   FLDSTNAME,      
   FLDSESSION,      
   FLDIPADDRESS,      
   FLDLASTVISIT,      
   FLDTIMEOUTPRD      
  )      
  SELECT P.FLDAUTO,      
     P.FLDUSERNAME,      
     A.FLDSTATUS,      
     P.FLDSTNAME,      
     '',      
     '',      
     GETDATE(),      
     ISNULL(M.FLDTIMEOUT,1)      
  FROM   TBLPRADNYAUSERS P (NOLOCK)      
     LEFT OUTER JOIN TBLUSERCONTROLMASTER M (NOLOCK)      
    ON (M.FLDUSERID = P.FLDAUTO)      
     INNER JOIN TBLADMIN A (NOLOCK)      
    ON (P.FLDADMINAUTO = A.FLDAUTO_ADMIN)      
  WHERE  P.FLDUSERNAME = @USERID      
                                   
  IF @@ERROR <> 0      
    BEGIN      
   SET @RETCODE = 0      
                 
   SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'      
                 
   RETURN      
    END      
              
    END      
          
      
     SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)      
 FROM TBLCLASSUSERLOGINS      
 WHERE FLDUSERNAME = @USERID      
      
      
 SET @@USER_SESSION = NEWID()      
                             
 UPDATE TBLCLASSUSERLOGINS      
 SET    FLDIPADDRESS = @IPADDRESS,      
   FLDSESSION = @@USER_SESSION,      
   FLDLASTVISIT = GETDATE(),      
   FLDLASTLOGIN = GETDATE()      
 WHERE  FLDUSERNAME = @USERID      
                              
  IF @@ERROR <> 0      
    BEGIN      
  SET @RETCODE = 0      
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'      
  RETURN      
    END      
          
  SET @RETCODE = 1      
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'      
  SET @UM_SESSION = @@USER_SESSION      
  SET @LASTLOGIN = @@LASTLOGIN                      
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEMENU
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DIRFILE
-- --------------------------------------------------
CREATE PROCEDURE DIRFILE 

AS -- EXEC DIRFILE

TRUNCATE TABLE PATHFROMFULLNAME

INSERT INTO PATHFROMFULLNAME
EXEC xp_dirtree 'F:\BACKOFFICE\IMPORT', 1, 1

SELECT FAYEAR=UPPER(SUBDIRECTORY),FAYEAR1=UPPER(SUBDIRECTORY) FROM PATHFROMFULLNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DIYMF_ACTIVATION
-- --------------------------------------------------
CREATE   PROC  [dbo].[DIYMF_ACTIVATION] (@CL_CODE VARCHAR(11))
AS 

DECLARE @CLTCOUNT INT        



SELECT @CLTCOUNT=COUNT(PARTY_CODE) FROM DBO.MFSS_CLIENT WITH(NOLOCK)  WHERE PAN_NO IN (
SELECT PANNO 
FROM ABVSCITRUS.CRMDB_A.DBO.API_KYC_MF WHERE BOPARTYCODE= @CL_CODE)AND INACTIVE_FROM>GETDATE()

IF ( @CLTCOUNT >=1)
  BEGIN 
    PRINT 'PAN NO ALREADY EXIST '
    Return
  END

SET @CLTCOUNT=0
        
  SELECT @CLTCOUNT =COUNT(PARTY_CODE) FROM         
  (SELECT PARTY_CODE FROM DBO.MFSS_CLIENT WITH(NOLOCK)  WHERE PARTY_CODE =  @CL_CODE     ) A  

IF ( @CLTCOUNT >=1)
  BEGIN 
    PRINT 'Client Already Registered'
    Return
  END

ELSE 
 

   BEGIN
   INSERT INTO MFSS_CLIENT ( PARTY_CODE,PARTY_NAME,CL_TYPE,CL_BALANCE,CL_STATUS,BRANCH_CD,SUB_BROKER,TRADER,AREA,REGION,SBU,FAMILY,GENDER,OCCUPATION_CODE,TAX_STATUS,PAN_NO,KYC_FLAG,ADDR1,ADDR2,ADDR3,
CITY,STATE,ZIP,NATION,OFFICE_PHONE,RES_PHONE,MOBILE_NO,EMAIL_ID,BANK_NAME,BANK_BRANCH,BANK_CITY,ACC_NO,PAYMODE,MICR_NO,DOB,GAURDIAN_NAME,GAURDIAN_PAN_NO,NOMINEE_NAME,
NOMINEE_RELATION,BANK_AC_TYPE,STAT_COMM_MODE,DP_TYPE,DPID,CLTDPID,MODE_HOLDING,HOLDER2_CODE,HOLDER2_NAME,HOLDER2_PAN_NO,HOLDER2_KYC_FLAG,HOLDER3_CODE,
HOLDER3_NAME,HOLDER3_PAN_NO,HOLDER3_KYC_FLAG,BUY_BROK_TABLE_NO,SELL_BROK_TABLE_NO,BROK_EFF_DATE,
NEFTCODE,CHEQUENAME,RESIFAX,OFFICEFAX,MAPINID,REMARK,UCC_STATUS,ADDEDBY,ADDEDON,ACTIVE_FROM,INACTIVE_FROM,POAFLAG,DEACTIVE_REMARKS,DEACTIVE_VALUE )
	SELECT BOPARTYCODE,LONG_NAME=REPLACE(((ISNULL(FNAME,'')+' '+ISNULL(MNAME,'')+' '+ISNULL(LNAME,''))),'  ',' '),CL_TYPE ='CLI',
	CL_BALANCE='E',CL_STATUS =(CASE WHEN CLIENT_TAX_STATUS ='IN' THEN 'IND' ELSE 'OTH' END),
	BRANCH_CD =ISNULL(RELATIONSHIP_BRANCH,''),SUB_BROKER =ISNULL(RELATIONSHIP_SUBBROKER,''),TRADER =ISNULL(RELATIONSHIP_BRANCH,''),AREA=ISNULL(RELATIONSHIP_BRANCH,''),
	REGION =ISNULL(RELATIONSHIP_REGION,''),SBU ='HO',FAMILY=BOPARTYCODE,GENDER,OCCUPATION ='',TAX_STATUS =(CASE WHEN CLIENT_TAX_STATUS ='IN' THEN '1' ELSE '0' END),
	PAN_NO =PANNO,KYC_FLAG ='Y',ADDR1= UPPER(CORRES_ADD1),ADDR2=UPPER(ISNULL(CORRES_ADD2,'')),ADDR3=UPPER(ISNULL(LEFT(CORRES_ADD3,50),'')),CITY =UPPER(ISNULL(CORRES_CITY,'')),
	STATE =UPPER(ISNULL(CORRES_STATE,'')),ZIP=CORRES_PIN_CODE,NATION=UPPER(ISNULL(CORRES_COUNTRY,'')),OFFICE_PHONE =ISNULL(CORRES_TEL_OFFICE,''),OFFICE_PHONE =ISNULL(CORRES_TEL_RESIDENT,''),
	MOBILE_NO=ISNULL(CORRES_MOBILE_NO,''),EMAIL_ID =ISNULL(CORRES_EMAIL_ID,''),BANK_NAME,BANK_BRANCH,BANK_CITY=BANK_BRANCH,ACC_NO=BANK_ACC_NO,PAYMODE ='4',
	MICR_NO =ISNULL(BANK_MICR_CODE,''),DOB=DATE_OF_BIRTH, GAURDIAN_NAME='',	GAURDIAN_PAN_NO ='',	
	NOMINEE_NAME =LEFT(ISNULL(NOMINEE_FNAME,'')+' '+ISNULL(NOMINEE_MNAME,' ')+ISNULL(NOMINEE_LNAME,''),50),	NOMINEE_RELATION='',
	BANK_AC_TYPE =(CASE WHEN BANK_AC_TYPE ='SAVINGS' THEN 'SB' ELSE 'CB' END),STAT_COMM_MODE='E',DP_TYPE='PHY',DPID='',CLTDPID='',MODE_HOLDING ='SI',
	HOLDER2_CODE ='',	HOLDER2_NAME ='',	HOLDER2_PAN_NO ='',	HOLDER2_KYC_FLAG ='',	HOLDER3_CODE ='',	HOLDER3_NAME='',	HOLDER3_PAN_NO ='',	HOLDER3_KYC_FLAG='',
	BUY_BROK_TABLE_NO='1',SELL_BROK_TABLE_NO='1',BROK_EFF_DATE=CONVERT(VARCHAR(11),GETDATE(),120) ,IFSC_CODE =BANK_IFSC_CODE,CHQUENAME='',RESIFAX='',OFFICEFAX='',
	MAPINID='',REMARK='',UCC_STATUS='1',ADDEDBY ='DIYMF',
	ADDEDON =GETDATE(),ACTIVE_FROM=GETDATE(),INACTIVE_FROM ='2049-12-31 23:59:00.000',POAFLAG='',
	DEACTIVE_REMARKS='',DEACTIVE_VALUE=''
	FROM ABVSCITRUS.CRMDB_A.DBO.API_KYC_MF WHERE BOPARTYCODE= @CL_CODE
    
	DECLARE @CNT INT
	SELECT @CNT =COUNT(1) FROM MFSS_CLIENT WHERE PARTY_CODE= @CL_CODE

	IF (@CNT = 0)
	  BEGIN 
	    Print 'Client Not Registered due to master Issue'
       Return
     end
   else

	INSERT INTO BBO_FA.DBO.ACMAST           
	SELECT PARTY_NAME,PARTY_NAME,'ASSET',4,'',PARTY_CODE,'','A0307000000','','',BRANCH_CD,0,'C','','','','BSE','MFSS' FROM           
	MFSS_CLIENT WHERE PARTY_CODE=@CL_CODE    

 
	INSERT INTO MFSS_BROKERAGE_MASTER          
	SELECT @CL_CODE,1,1,CONVERT(VARCHAR(11),GETDATE(),120) ,'2049-12-31 23:59'  WHERE @CL_CODE NOT IN (SELECT PARTY_CODE FROM  MFSS_BROKERAGE_MASTER)   
 	
	INSERT INTO POBANK        
	SELECT  M.BANK_NAME, BANK_BRANCH,'','','','','','','','','','','' FROM MFSS_CLIENT M        
	LEFT OUTER         
	JOIN POBANK        
	ON M.BANK_NAME= POBANK.BANK_NAME AND BANK_BRANCH=BRANCH_NAME        
	WHERE BANKID IS NULL      AND PARTY_CODE = @CL_CODE   
	GROUP BY M.BANK_NAME, BANK_BRANCH
   
	INSERT INTO BBO_FA.DBO.MULTIBANKID(Cltcode,Bankid,Accno,Acctype,Chequename,Defaultbank,exchange,segment)        
	SELECT PARTY_CODE,MAX(P.BANKID),ACC_NO,BANK_AC_TYPE,PARTY_NAME ,1,'BSE','MFSS'        
	FROM   MFSS_CLIENT M , POBANK P        
	WHERE M.BANK_NAME= P.BANK_NAME AND M.BANK_BRANCH=P.BRANCH_NAME  AND PARTY_CODE =@CL_CODE      
	GROUP BY PARTY_CODE,ACC_NO,BANK_AC_TYPE,PARTY_NAME   	
	
	
	UPDATE MF SET B_FLAG ='S' ,UPD_ON =GETDATE() 
	FROM ABVSCITRUS.CRMDB_A.DBO.API_KYC_MF	 MF	 WHERE BOPARTYCODE = @CL_CODE	 

	Exec [CSOKYC-6].General.DBO.Prc_RealTimeMFClient @CL_CODE
	
	Print 'Client Data Pushed in Backoffice'
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ExecuteSQL_ByAgentJob_usp
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[ExecuteSQL_ByAgentJob_usp](  
    @SqlStatemet            VARCHAR(4000),  
    @SPNameOrStmntTitle     VARCHAR(100),  
    @JobRunningUser         VARCHAR(100) = NULL,  
    @JobIdOut               UNIQUEIDENTIFIER OUTPUT  
)  
AS  
BEGIN  
   
 SET NOCOUNT ON  
   
 DECLARE @JobId          UNIQUEIDENTIFIER,  
   @JobName        VARCHAR(250),  
   @DBName         VARCHAR(100),  
   @ServerName     VARCHAR(100)   
   
 SET @JOBNAME = NULL  
 SET @DBName = DB_NAME()  
 SET @ServerName = @@SERVERNAME  
  
 --Creating Unique Job Name by combining @SPNameOrStmntTitle and a GUID.    
 SET @JobName = @SPNameOrStmntTitle + '_' + CONVERT(VARCHAR(64), NEWID())   
   
 --Currently logged user name will be used to execute the job if not provided one.  
 IF @JobRunningUser IS NULL  
  SET @JobRunningUser = SUSER_NAME()  
   
 --Adds a new job executed by the SQLServerAgent service  
 EXECUTE msdb..sp_add_job @job_name = @JobName, @owner_login_name = @JobRunningUser,   
 @job_id = @JobId OUTPUT   
   
 --Targets the specified job at the specified server   
 EXECUTE msdb..sp_add_jobserver @job_id = @JobId, @server_name = @ServerName   
   
 --Tell job for its about its first step.  
 EXECUTE msdb..sp_add_jobstep @job_id = @JobId, @step_name = 'Step1', @command   
 = @SqlStatemet,@database_name = @DBName, @on_success_action = 3   
   
 --Preparing the command to delete the job immediately after executing the statements   
 DECLARE @sql VARCHAR(250)   
   
 SET @SQL = 'execute msdb..sp_delete_job @job_name=''' + @JobName + ''''  
   
 EXECUTE msdb..sp_add_jobstep @job_id = @JobId, @step_name = 'Step2', @command = @sql   
   
 --Run the job  
 EXECUTE msdb..sp_start_job @job_id = @JobId  
   
 --Return the Job via output param.  
 SET @JobIdOut = @JobId  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FILELISTPROC
-- --------------------------------------------------
CREATE  PROC [DBO].[FILELISTPROC] (@FILEPATH VARCHAR(100) )        
AS         
      
DECLARE @NEWFILEPATH VARCHAR(100)      
      
SET @NEWFILEPATH = REPLACE(@FILEPATH, '*.TXT', '*.*')      
CREATE TABLE #FILELIST         
( FILENAMELIST VARCHAR(100))        
INSERT INTO #FILELIST         
EXEC MASTER.DBO.XP_CMDSHELL @NEWFILEPATH        
  
SELECT * FROM #FILELIST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fun
-- --------------------------------------------------

CREATE PROC Fun @fun VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @fun + '%' and xtype='FN' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_PWD_EXPIRY
-- --------------------------------------------------
CREATE PROC GET_PWD_EXPIRY  
(  
  @UNAME VARCHAR(100)  
)  
AS  
SELECT LTRIM(RTRIM(T.FLDFIRSTNAME)) AS FIRSTNAME,     
 CASE WHEN DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 2  THEN  'THE DAY AFTER TOMORROW'    
 ELSE    
  CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 1  THEN  'TOMORROW'    
 ELSE    
 CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 0  THEN  '<U>TODAY</U>'    
 ELSE    
 'ON ' + LEFT(CONVERT(VARCHAR, T.PWD_EXPIRY_DATE, 109), 11)    
END   
END   
END    
 AS PWD_EXPIRY_DATE    
 FROM    
 TBLPRADNYAUSERS T, TBLADMIN A   
 WHERE    
 T.FLDADMINAUTO = A.FLDAUTO_ADMIN    
 AND T.FLDUSERNAME = @UNAME   
 AND GETDATE() <= T.PWD_EXPIRY_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_CATEGORY
-- --------------------------------------------------

CREATE PROC GET_USER_CATEGORY  
(  
  @FLDCATEGORY INT  
)  
AS  
SELECT FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @FLDCATEGORY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetNomineeForBSE
-- --------------------------------------------------
-- =============================================
-- Author:		<Sonu prajapati>
-- Create date: <07 march 2023>
-- Description:	get nominee details for BSE
-- =============================================
CREATE PROCEDURE [dbo].[GetNomineeForBSE]
AS
BEGIN
	SET NOCOUNT ON;
    Select distinct SpaceCount,PARTY_CODE,v.DP_TYPE,Party_Name,v.Param 
	from (select NOMINEE_NAME,NOMINEE_RELATION,NOMINEEDOB,NOMINEEPHONE,NOMINEEPER,LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ','')) - 1 SpaceCount,PARTY_CODE,DP_TYPE,PARTY_NAME as 'Party_Name',  
isnull(PARTY_CODE,'') + '|' + --Client Code  
--case when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=3 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 4),'')  
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=2 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 3),'')   
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=1 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 2),'')   
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=0 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 1),'')  
--end + '|' + --Primary Holder First Name  
--case when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=3 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 3),'') + ' ' + isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ',
-- '.'), 2),'')  
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=2 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 2),'')   
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=1 then ''  
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=0 then ''   
--end + '|' + --Primary Holder Second Name  
--case when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=3 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 1),'')  
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=2 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 1),'')   
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=1 then isnull(parsename(replace(isnull(LTRIM(RTRIM(PARTY_NAME)),''), ' ', '.'), 1),'')  
--when LEN(Rtrim(Ltrim(PARTY_NAME)) + ';')-LEN(REPLACE(Rtrim(Ltrim(PARTY_NAME)),' ',''))-1=0 then ''  
--end + '|' +  --Primary Holder third Name
nameList.PrimaryHolderFirstName + '|' + --Primary Holder First Name
nameList.PrimaryHolderMiddleName  + '|' + --Primary Holder Second Name
nameList.PrimaryHolderLastName + '|' + --Primary Holder Third Name
'0' + cast(isnull(TAX_STATUS,'') as varchar(2)) + '|' + --Tax Status  
isnull(GENDER,'') + '|' + --Gender  
convert(varchar, isnull(dob,''), 103) + '|'+ --Primary Holder DOB/Incorporation  
case when OCCUPATION_CODE is null OR OCCUPATION_CODE = '0' then '02'  
when OCCUPATION_CODE is not null then '0'+cast(isnull(OCCUPATION_CODE,'2') as varchar(2))  
end  + '|' + --occupation code  
case when isnull(DP_TYPE,'')='PHY' then 'SI' else Mode_Holding end + '|' +  
--isnull(Mode_Holding,'') + '|' + --Holding Nature   
'' + '|' + --only in demmat mode Second Holder First Name  
'' + '|' + --only in demmat mode Second Holder Middle Name  
'' + '|' + --only in demmat mode Second Holder Last Name  
'' + '|' + --only in demmat mode Third Holder First Name  
'' + '|' + --only in demmat mode Third Holder Middle Name  
'' + '|' + --only in demmat mode Third Holder Last Name  
'' + '|' + --only in demmat mode Second Holder DOB  
'' + '|' + --only in demmat mode Third Holder DOB  
'' + '|' + --only in demmat mode Guardian First Name  
'' + '|' + --only in demmat mode Guardian Middle Name  
'' + '|' + --only in demmat mode Guardian Last Name  
'' + '|' + --GUARDIAN_DOB  
'N' + '|' + --Primary Holder PAN Exempt  
'' + '|' + --only in demmat mode Second Holder PAN Exempt  
'' + '|' + --only in demmat mode Third Holder PAN Exempt  
'' + '|' + --only in demmat mode Guardian PAN Exempt  
isnull(PAN_NO,'') + '|' + --only in demmat mode Primary Holder PAN  
'' + '|' + --only in demmat mode Second Holder PAN  
'' + '|' + --only in demmat mode Third Holder PAN  
'' + '|' + --only in demmat mode Guardian PAN  
'' + '|' + --only in demmat mode Primary Holder-Exempt Category  
'' + '|' + --only in demmat mode Second Holder Exempt Category  
'' + '|' + --only in demmat mode Third Holder Exempt Category  
'' + '|' + --only in demmat mode Guardian Exempt Category  
case when isnull(DP_TYPE,'')='CDSL' then 'D' else 'P' end + '|' + --only in demmat mode Client Type  
case when isnull(DP_TYPE,'')='CDSL' then 'N' else '' end + '|' + --PMS  
case when isnull(DP_TYPE,'')='CDSL' then isnull(DP_TYPE,'') else '' end + '|' +--Default DP  
isnull(DPID,'') + '|' + --CDSL DPID  
case when isnull(DP_TYPE,'')='CDSL' then isnull(right(CLTDPID, 8),'') else isnull(CLTDPID,'') end + '|' + --CDSLCLTID  
''  + '|' + --CMBP Id  
'' + '|' + --NSDLDPID  
'' + '|' + --NSDLCLTID  
--case when isnull(DP_TYPE,'')='PHY' then isnull(BANK_AC_TYPE,'') else '' end + '|' + --CDSL Account type 1  
--case when isnull(DP_TYPE,'')='PHY' then isnull(ACC_NO,'') else '' end + '|' + --Account No 1
--case when isnull(DP_TYPE,'')='PHY' then isnull(MICR_NO,'') else '' end + '|' + --MICR No 1
--case when isnull(DP_TYPE,'')='PHY' then isnull(ifsc.New_code,neftcode) else '' end + '|' + --IFSC Code 1
--case when isnull(DP_TYPE,'')='PHY' then 'Y' else '' end + '|' + --Default Bank Flag
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_Type_1,'') else '' end + '|' + --CDSL Account type 1  
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_No_1,'') else '' end + '|' + --Account No 1 
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.MICR_No_1,'') else '' end + '|' + --MICR No 1
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.IFSC_Code_1,'') else '' end + '|' + --IFSC Code 1  
bank.Default_Bank_Flag + '|' + --Default Bank Flag
--'' + '|' + --Account Type 2  
--'' + '|' + --Physial Account No 2  
--'' + '|' + --MICR No 2  
--'' + '|' + --IFSC Code 2  
--'' + '|' + --Default Bank Flag  
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_Type_2,'') else '' end + '|' + --CDSL Account type 2  
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_No_2,'') else '' end + '|' + --Account No 2
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.MICR_No_2,'') else '' end + '|' + --MICR No 2
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.IFSC_Code_2,'') else '' end + '|' + --IFSC Code 2  
bank.Default_Bank_Flag_2 + '|' + --Default Bank Flag 2
--'' + '|' + --Physial Account type 3  
--'' + '|' + --Account No 3  
--'' + '|' + --MICR No 3   
--'' + '|' + --IFSC Code 3  
--'' + '|' + --Default Bank Flag
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_Type_3,'') else '' end + '|' + --CDSL Account type 3  
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_No_3,'') else '' end + '|' + --Account No 3
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.MICR_No_3,'') else '' end + '|' + --MICR No 3
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.IFSC_Code_3,'') else '' end + '|' + --IFSC Code 3
bank.Default_Bank_Flag_3 + '|' + --Default Bank Flag 3
--case when isnull(DP_TYPE,'')='CDSL' then isnull(BANK_AC_TYPE,'') else '' end + '|' + --CDSL Account type 4  
--case when isnull(DP_TYPE,'')='CDSL' then isnull(ACC_NO,'') else '' end + '|' + --Account No 4  
--case when isnull(DP_TYPE,'')='CDSL' then isnull(MICR_NO,'') else '' end + '|' + --MICR No 4  
--case when isnull(DP_TYPE,'')='CDSL' then isnull(neftcode,IFSCCODE) else '' end + '|' + --IFSC Code 4  
--case when isnull(DP_TYPE,'')='CDSL' then 'Y' else '' end + '|' + --Default Bank Flag 4
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_Type_4,'') else '' end + '|' + --CDSL Account type 4
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_No_4,'') else '' end + '|' + --Account No 4
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.MICR_No_4,'') else '' end + '|' + --MICR No 4
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.IFSC_Code_4,'') else '' end + '|' + --IFSC Code 4
bank.Default_Bank_Flag_4 + '|' + --Default Bank Flag 4
--'' + '|' + -- NSDL Account type 5  
--'' + '|' + --NSDL   Account No 5  
--'' + '|' + --MICR No 5  
--'' + '|' + --IFSC Code 5  
--'' + '|' + --Default Bank Flag
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_Type_5,'') else '' end + '|' + --CDSL Account type 5
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.Account_No_5,'') else '' end + '|' + --Account No 5
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.MICR_No_5,'') else '' end + '|' + --MICR No 5
case when isnull(DP_TYPE,'')='PHY' then isnull(bank.IFSC_Code_5,'') else '' end + '|' + --IFSC Code 5
bank.Default_Bank_Flag_5 + '|' + --Default Bank Flag 5
'' + '|' + --Cheque name  
'01' + '|' + --Div pay mode  
isnull(ADDR1,'') + '|' + --Address 1  
isnull(ADDR2,'') + '|' + --Address 2  
isnull(ADDR3,'') + '|' + --Address 3  
isnull(CITY,'') + '|' + --CITY  
--case when misscode.STATE =' Andaman & Nicobar' then 'AN'  
--when misscode.STATE='Andaman & Nicobar' then 'AN'  
--when misscode.STATE='Arunachal Pradesh' then 'AR'  
--when misscode.STATE='Andhra Pradesh' then 'AP'  
--when misscode.STATE='Assam' then 'AS'  
--when misscode.STATE='Bihar' then 'BH'  
--when misscode.STATE='Chandigarh' then 'CH'  
--when misscode.STATE='Chhattisgarh' then 'CG'  
--when misscode.STATE='GOA' then 'GO'  
--when misscode.STATE='Gujarat' then 'GU'  
--when misscode.STATE='Haryana' then 'HA'  
--when misscode.STATE='Himachal Pradesh' then 'HP'  
--when misscode.STATE='Jammu & Kashmir' then 'JM'  
--when misscode.STATE='Jharkhand' then 'JK'  
--when misscode.STATE='Karnataka' then 'KA'  
--when misscode.STATE='Kerala' then 'KE'  
--when misscode.STATE='Madhya Pradesh' then 'MP'  
--when misscode.STATE='Maharashtra' then 'MA'  
--when misscode.STATE='Manipur' then 'MN'  
--when misscode.STATE='Meghalaya' then 'ME'  
--when misscode.STATE='Mizoram' then 'MI'  
--when misscode.STATE='Nagaland' then 'NA'  
--when misscode.STATE='New Delhi' then 'ND'  
--when misscode.STATE='Orissa' then 'OR'  
--when misscode.STATE='Pondicherry' then 'PO'  
--when misscode.STATE='Punjab' then 'PU'  
--when misscode.STATE='Rajasthan' then 'RA'  
--when misscode.STATE='Sikkim' then 'SI'  
--when misscode.STATE='Telangana' then 'TG'  
--when misscode.STATE='Tamil Nadu' then 'TN'  
--when misscode.STATE='Tripura' then 'TR'  
--when misscode.STATE='Uttar Pradesh' then 'UP'  
--when misscode.STATE='Uttaranchal' then 'UC'  
--when misscode.STATE='West Bengal' then 'WB'  
--when misscode.STATE='Dadra and Nagar Haveli' then 'DN'  
--when misscode.STATE='Daman and Diu' then 'DD'  
--when misscode.STATE='Lakshadweep' then 'LD'
	 
--when misscode.STATE='New Delhi' then 'ND'
--when misscode.STATE='Uttaranchal' then 'UC'
--when misscode.STATE='Orissa' then 'OR'
--when misscode.STATE='Jammu & Kashmir' then 'JM'
--when misscode.STATE='TAMIL NADU' then 'TN'
--when misscode.STATE='TELANGANA' then 'TG'
--when misscode.STATE='CHANDIGARH' then 'CH'
--when misscode.STATE='Andaman & Nicobar' then 'AN'
--when misscode.STATE='ANDHRA PRADESH' then 'AP'
--when misscode.STATE='Madhya Pradesh' then 'MP'
--when misscode.STATE='PUNJAB' then 'PU'
--when misscode.STATE='UTTAR PRADESH' then 'UP'
--when misscode.STATE='Others' then 'OH' else ''


case when STATE =' Andaman & Nicobar' then 'AN'  
when STATE='Andaman & Nicobar' then 'AN'  
when STATE='Arunachal Pradesh' then 'AR'  
when STATE='Andhra Pradesh' then 'AP'  
when STATE='Assam' then 'AS'  
when STATE='Bihar' then 'BH'  
when STATE='Chandigarh' then 'CH'  
when STATE='Chhattisgarh' then 'CG'  
when STATE='GOA' then 'GO'  
when STATE='Gujarat' then 'GU'  
when STATE='Haryana' then 'HA'  
when STATE='Himachal Pradesh' then 'HP'  
when STATE='Jammu & Kashmir' then 'JM'  
when STATE='Jharkhand' then 'JK'  
when STATE='Karnataka' then 'KA'  
when STATE='Kerala' then 'KE'  
when STATE='Madhya Pradesh' then 'MP'  
when STATE='Maharashtra' then 'MA'  
when STATE='Manipur' then 'MN'  
when STATE='Meghalaya' then 'ME'  
when STATE='Mizoram' then 'MI'  
when STATE='Nagaland' then 'NA'  
when STATE='New Delhi' then 'ND'  
when STATE='Orissa' then 'OR'  
when STATE='Pondicherry' then 'PO'  
when STATE='Punjab' then 'PU'  
when STATE='Rajasthan' then 'RA'  
when STATE='Sikkim' then 'SI'  
when STATE='Telangana' then 'TG'  
when STATE='Tamil Nadu' then 'TN'  
when STATE='Tripura' then 'TR'  
when STATE='Uttar Pradesh' then 'UP'  
when STATE='Uttaranchal' then 'UC'  
when STATE='West Bengal' then 'WB'  
when STATE='Dadra and Nagar Haveli' then 'DN'  
when STATE='Daman and Diu' then 'DD'  
when STATE='Lakshadweep' then 'LD'
	 
when STATE='New Delhi' then 'ND'
when STATE='Uttaranchal' then 'UC'
when STATE='Orissa' then 'OR'
when STATE='Jammu & Kashmir' then 'JM'
when STATE='TAMIL NADU' then 'TN'
when STATE='TELANGANA' then 'TG'
when STATE='CHANDIGARH' then 'CH'
when STATE='Andaman & Nicobar' then 'AN'
when STATE='ANDHRA PRADESH' then 'AP'
when STATE='Madhya Pradesh' then 'MP'
when STATE='PUNJAB' then 'PU'
when STATE='UTTAR PRADESH' then 'UP'
when STATE='Others' then 'OH' else ''
	 


end + '|' + --STATE  
isnull(ZIP,'') + '|' + --PIN  
isnull(NATION,'') + '|' + --NATION  
'' + '|' + --Resi. Phone  
'' + '|' + --Resi. Fax  
'' + '|' + --Office Phone  
'' + '|' + --Office Fax  
isnull(EMAIL_ID,'') + '|' +  
isnull(STAT_COMM_MODE,'') + '|' +  
'' + '|' + --Foreign Address 1  
'' + '|' + --Foreign Address 2  
'' + '|' + --Foreign Address 3  
'' + '|' + --Foreign Address City  
'' + '|' + --Foreign Address Pincode  
'' + '|' + --Foreign Address State  
'' + '|' + --Foreign Address Country  
'' + '|' + --Foreign Address Resi Phone  
'' + '|' + --Foreign Address Fax  
'' + '|' + --Foreign Address Off. Phone  
'' + '|' + --Foreign Address Off. Fax
isnull(MOBILE_NO,'') + '|' +  
Rtrim(replace(translate(NOMINEE_NAME, '$#@.', '$$$$'), '$', '')) + '|' + --Nominee 1 Name  
isnull(NOMINEE_RELATION,'') + '|' + --Nominee 1 Relationship  
isnull(NOMINEEPER,'100') + '|' + --Nominee 1 Applicable(%)  
'N' + '|' + --Nominee 1 Minor Flag  
isnull(NOMINEEDOB,'') + '|' + --Nominee 1 DOB  
'' + '|' + --Nominee 1 Guardian  
isnull(NOMINEE_NAME2,'') + '|' + --Nominee 2 Name  
isnull(NOMINEE_RELATION2,'') + '|' + --Nominee 2 Relationship  
isnull(NOMINEEPER2,'') + '|' + --Nominee 2 Applicable(%)  
'' + '|' + --Nominee 2 Minor Flag  
isnull(NOMINEEDOB2,'') + '|' + --Nominee 2 DOB  
'' + '|' + --Nominee 2 Guardian  
isnull(NOMINEE_NAME3,'') + '|' + --Nominee 3 Name  
isnull(NOMINEE_RELATION3,'') + '|' + --Nominee 3 Relationship  
isnull(NOMINEEPER3,'') + '|' + --Nominee 3 Applicable(%)  
'' + '|' + --Nominee3 Minor Flag 
isnull(NOMINEEDOB3,'') + '|' + --Nominee 3 DOB 
'' + '|' + --Nominee3 Guardian  
--'K' + '|' + --Primary Holder KYC Type  
--'' + '|' + --Primary Holder cKYC Number  
nameList.Primary_Holder_KYC_Type + '|' + --Primary Holder KYC Type
nameList.Primary_Holder_CKYC_Number + '|' + --Primary Holder cKYC Number 
'' + '|' + --Primary Holder CKYC Number  
'' + '|' + --Second Holder KYC Type  
'' + '|' + --Second Holder CKYC Number  
'' + '|' + --Third Holder KYC Type  
'' + '|' + --Third Holder CKYC Number  
'' + '|' + --Guardian KYC Type  
'' + '|' + --Guardian CKYC Number  
'' + '|' +  
'' + '|' +  
'' + '|' + --Guardian Exempt Ref. No  
'N' + '|' + --Aadhaar Updated  
'' + '|' + --Mapin Id.  
'P' + '|' + --paperless  
'' + '|' +  
'' + '|' +   
'SE' + '|' +  
'SE' + '|' as 'Param'  
from ANGELFO.BSEMFSS.dbo.MFSS_client mfss With(Nolock)  right join tblIFSCCodeUpdate ifsc on mfss.PARTY_CODE = ifsc.client_code
--right join tblMissingStateCode misscode on misscode.clientcode = mfss.PARTY_CODE
right join tblNameIssue_list nameList  With(Nolock) on nameList.Client_Code=mfss.PARTY_CODE
right join tblBankdetails bank  With(Nolock) on bank.clientcode=mfss.PARTY_CODE
where  ISNULL(Party_Code,'') in (
'A129460',
'A129518',
'A129559',
'A129812',
'A129898',
'A130615',
'A131101',
'A131204',
'A131645',
'A131824',
'A131829',
'A131930',
'A131944',
'A132042',
'A132071',
'A132160',
'A132220',
'A132401',
'A132589',
'A132636',
'A132751',
'A132764',
'A132791',
'A133174',
'A133328',
'A133644',
'A133994',
'A134286',
'A134450',
'A134461',
'A134466',
'A134544',
'A134583',
'A134913',
'A135236',
'A135272',
'A135340',
'A135393',
'A135586',
'A135658',
'A135752',
'A136002',
'A136185',
'A136316',
'A136508',
'A136648',
'A136806',
'A137346',
'A137508',
'A137567',
'A137632',
'A139824',
'A139829',
'A139852',
'A143268',
'A147718',
'A148115',
'A148202',
'A150092',
'A150485',
'A151105',
'A152356',
'A153072',
'A212505',
'A430252',
'ASMR1005',
'B57685',
'B57824',
'B57920',
'B57937',
'B58016',
'B58031',
'B58106',
'B58266',
'B58793',
'B58864',
'B59664',
'B59727',
'B59749',
'B60021',
'B61085',
'B64586',
'BKNR4973',
'C29472',
'C29681',
'C29950',
'C30248',
'C30375',
'C76673',
'D67859',
'D68074',
'D68523',
'D68827',
'D69267',
'D69396',
'D69422',
'D69519',
'D69635',
'D69801',
'D69909',
'D70045',
'D70185',
'D70785',
'D71912',
'D73052',
'D74587',
'D76695',
'E2722',
'F4823',
'F4862',
'G129370',
'G38801',
'G39245',
'G39268',
'G39344',
'G39629',
'G39733',
'G41677',
'H44146',
'H44591',
'H44704',
'H45073',
'H48311',
'I9578',
'I9742',
'I9758',
'J127087',
'J55748',
'J55760',
'J55846',
'J55955',
'J56187',
'J56594',
'J57313',
'J62368',
'K231206',
'K83979',
'K84955',
'K84970',
'K85904',
'K87265',
'K87920',
'K88092',
'K89073',
'K89214',
'K90397',
'K90667',
'K94492',
'K94739',
'K94848',
'L16044',
'L16237',
'L16301',
'L16420',
'L16422',
'L17113',
'L17995',
'L18029',
'M117050',
'M117062',
'M117605',
'M118236',
'M118330',
'M118335',
'M118378',
'M118412',
'M118816',
'M118840',
'M118853',
'M118915',
'M118977',
'M119009',
'M119346',
'M119551',
'M119718',
'M119738',
'M120009',
'M120546',
'M120683',
'M120818',
'M121514',
'M121958',
'M122385',
'M122561',
'M123044',
'M123697',
'M124061',
'M125193',
'M125742',
'M127723',
'M132814',
'M132853',
'M133771',
'M134310',
'M155662',
'M320341',
'M328180',
'MMRDE1012',
'N69554',
'N69561',
'N69563',
'N69632',
'N69685',
'N69693',
'N70711',
'N70778',
'N71014',
'N71307',
'N71356',
'N72408',
'N73235',
'N74350',
'N80715',
'N96415',
'O2729',
'P102308',
'P102346',
'P102533',
'P102989',
'P103744',
'P103758',
'P103772',
'P103838',
'P103864',
'P103998',
'P104001',
'P104772',
'P104862',
'P105302',
'P105388',
'P105661',
'P106336',
'P106354',
'P106541',
'P107029',
'P107071',
'P107510',
'P108350',
'P109197',
'P111569',
'P116210',
'P117083',
'P118111',
'P301929',
'PATK1029',
'POOR1009',
'R117691',
'R117816',
'R118044',
'R118414',
'R118513',
'R118689',
'R118806',
'R119021',
'R119045',
'R119207',
'R119347',
'R119379',
'R119390',
'R119420',
'R119511',
'R119555',
'R119569',
'R119720',
'R119746',
'R119758',
'R120470',
'R120585',
'R120895',
'R121120',
'R121310',
'R121648',
'R121770',
'R121806',
'R122472',
'R127729',
'R128136',
'R133095',
'R133295',
'R133544',
'R133590',
'R134152',
'R134887',
'R138856',
'R139408',
'R168656',
'R256549',
'S209510',
'S210118',
'S210709',
'S210897',
'S211120',
'S211537',
'S212041',
'S212060',
'S212513',
'S212521',
'S212621',
'S212841',
'S212996',
'S213056',
'S213196',
'S213260',
'S213275',
'S213288',
'S213363',
'S213725',
'S213729',
'S213742',
'S213762',
'S213772',
'S213815',
'S213867',
'S213974',
'S214008',
'S214222',
'S214357',
'S214711',
'S214720',
'S214737',
'S214965',
'S215208',
'S215213',
'S215655',
'S215989',
'S216155',
'S216262',
'S216270',
'S216744',
'S216780',
'S217281',
'S217297',
'S217788',
'S217929',
'S218338',
'S218839',
'S219378',
'S220123',
'S220153',
'S220717',
'S221823',
'S221988',
'S222296',
'S222683',
'S225877',
'S226211',
'S227776',
'S227953',
'S228208',
'S230423',
'S231704',
'S232440',
'S235747',
'S237803',
'S237934',
'S238356',
'S240773',
'S241295',
'S241646',
'S242736',
'S242766',
'S247084',
'S260868',
'S318251',
'SIHR1017',
'SULU004',
'T20114',
'T20349',
'T20564',
'T20645',
'T20685',
'T21776',
'T22084',
'TTSI1016',
'U14029',
'U14035',
'U14282',
'U14382',
'V76134',
'V76427',
'V76531',
'V76864',
'V76894',
'V76956',
'V77298',
'V77767',
'V77791',
'V77903',
'V78452',
'V78686',
'V78772',
'V78899',
'V78946',
'V78950',
'V79275',
'V79544',
'V80754',
'V81043',
'V84688',
'V85858',
'V88585',
'W1048',
'Y11733',
'Y11880',
'Y11905',
'Y11918',
'Y12168',
'Y12220',
'Z3170',
'Z3178'
)
and DP_TYPE = 'PHY') as v inner join BSEPush_ErrorLog error on v.PARTY_CODE = error.Clientcode
where v.Param is not null and error.Flag=0 and error.Status=1;
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.HTTP_REQUEST
-- --------------------------------------------------
  
  
/*  
declare  @myurl varchar(max), @myoutput varchar(max)  
set @myurl ='http://10.228.50.11:8081/rnd/test.asp'  
  
exec HTTP_REQUEST @myurl, @myoutput  
  
print @myoutput  
  
  
*/  
  
CREATE PROCEDURE [dbo].[HTTP_REQUEST]  
(   
@URI varchar(max),   
@response varchar(8000) OUT  
)  
AS  
  
DECLARE  
@xhr INT  
,@result INT  
,@httpStatus INT  
,@msg VARCHAR(255)  
  
  
EXEC @result = sp_OACreate 'MSXML2.XMLHttp.5.0', @xhr OUT  
  
IF @result <> 0 BEGIN RAISERROR('sp_OACreate on MSXML2.XMLHttp.5.0 failed', 16,1) RETURN   
END  
  
EXEC @result = sp_OAMethod @xhr, 'open', NULL, 'GET', @URI, false  
IF @result <>0 BEGIN RAISERROR('sp_OAMethod Open failed', 16,1) RETURN   
END  
  
EXEC @result = sp_OAMethod @xhr, SEND, NULL, ''  
IF @result <>0 BEGIN RAISERROR('sp_OAMethod SEND failed', 16,1) RETURN   
END  
  
EXEC @result = sp_OAGetProperty @xhr, 'status', @httpStatus OUT  
  
IF @result <>0   
    BEGIN RAISERROR('sp_OAMethod read status failed', 16,1) RETURN   
    END  
  
IF @httpStatus <> 200 BEGIN RAISERROR('sp_OAMethod http status bad', 16,1) RETURN   
END  
  
EXEC @result = sp_OAGetProperty @xhr, 'responseText', @response OUT  
IF @result <>0 BEGIN RAISERROR('sp_OAMethod read response failed', 16,1) RETURN   
END  
  
EXEC @result = sp_OADestroy @xhr  
  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INSCLTDELWISE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.INSCLTDELWISE    SCRIPT DATE: 12/09/2004 4:50:00 PM ******/                
                
CREATE PROC [dbo].[INSCLTDELWISE] ( @SETT_NO VARCHAR(7),@SETT_TYPE VARCHAR(2),@REFNO INT) AS                
DECLARE @@SCRIP_CD VARCHAR(12),                
 @@SERIES VARCHAR(3),                
 @@PARTY_CODE VARCHAR(10),                
 @@DELQTY NUMERIC(18,4),                
 @@QTY NUMERIC(18,4),                
 @@QTY1 NUMERIC(18,4),                
 @@TRADEQTY NUMERIC(18,4),                
 @@CERTNO VARCHAR(15),                
 @@FROMNO VARCHAR(15),                
 @@FOLIONO VARCHAR(15),                
 @@REASON VARCHAR(25),                
 @@TCODE NUMERIC(18,0),                
 @@CERTPARTY VARCHAR(10),                
 @@ORGQTY NUMERIC(18,4),                
 @@SDATE VARCHAR(11),                
 @@SNO NUMERIC(18,0),                
 @@PCOUNT NUMERIC(18,4),                
 @@REMQTY NUMERIC(18,4),                
 @@OLDQTY NUMERIC(18,4),                
 @@FLAG VARCHAR(1),                
 @@QTYCUR CURSOR,                
 @@DELCLT CURSOR,                
 @@CERTCUR CURSOR,  
 @@DPCLT VARCHAR(16)  
          
SET @@DELCLT = CURSOR FOR                            
 SELECT DT.SCRIP_CD,DT.SERIES,DT.PARTY_CODE,QTY,DPCLT,FLAG='N' FROM DELIVERYCLT DT   
 WHERE INOUT = 'O'                
 AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE                 
 ORDER BY DT.SCRIP_CD,DT.SERIES,FLAG,DT.QTY ASC,DT.PARTY_CODE                
OPEN @@DELCLT                
FETCH NEXT FROM @@DELCLT INTO @@SCRIP_CD,@@SERIES,@@PARTY_CODE,@@DELQTY,@@DPCLT,@@FLAG                
WHILE @@FETCH_STATUS = 0                 
BEGIN                
                     
       SET @@QTYCUR = CURSOR FOR                 
       SELECT ISNULL(SUM(QTY),0) FROM DELTRANS                 
       WHERE SETT_NO = @SETT_NO                 
       AND SETT_TYPE = @SETT_TYPE                 
       AND REFNO = @REFNO                
       AND PARTY_CODE = @@PARTY_CODE                
       AND SCRIP_CD  = @@SCRIP_CD                 
       AND SERIES = @@SERIES                 
       AND DRCR = 'D' AND FILLER2 = 1  
       AND CLTDPID = (CASE WHEN LEN(CLTDPID) = 16 THEN @@DPCLT ELSE RIGHT(@@DPCLT,8) END)  
       OPEN @@QTYCUR                 
       FETCH NEXT FROM @@QTYCUR INTO @@QTY                   
                       
       IF @@DELQTY > @@QTY                
       BEGIN                  
  SELECT @@DELQTY = @@DELQTY - @@QTY                
  SET @@CERTCUR = CURSOR FOR                
  SELECT QTY,CERTNO, FROMNO,FOLIONO,TDATE=LEFT(CONVERT(VARCHAR,TRANSDATE,109),11),ORGQTY,SNO,TCODE                
  FROM DELTRANS                 
  WHERE SETT_NO = @SETT_NO                 
  AND SETT_TYPE = @SETT_TYPE                 
  AND REFNO = @REFNO                
  AND PARTY_CODE = 'BROKER'                
  AND SCRIP_CD  = @@SCRIP_CD                 
  AND SERIES = @@SERIES                 
  AND DRCR = 'D' AND TRTYPE = 904 AND FILLER2 = 1                    
  ORDER BY TRANSDATE ASC,QTY DESC                 
   OPEN @@CERTCUR                
   FETCH NEXT FROM @@CERTCUR INTO @@TRADEQTY,@@CERTNO,@@FROMNO,@@FOLIONO,@@SDATE,@@ORGQTY,@@SNO,@@TCODE                
   IF @@FETCH_STATUS = 0                 
   BEGIN                
     SELECT @@PCOUNT = 0                
     WHILE @@PCOUNT < @@DELQTY AND @@FETCH_STATUS = 0                 
     BEGIN                
    SELECT @@PCOUNT = @@PCOUNT + @@TRADEQTY                
    IF @@PCOUNT <= @@DELQTY                 
    BEGIN                    
     UPDATE DELTRANS SET PARTY_CODE = @@PARTY_CODE, REASON=(CASE WHEN @@FLAG='E' THEN 'EXCESS RECEIVED TRANSFER' ELSE 'PAY-OUT' END),  
     DPID = LEFT(@@DPCLT,8), CLTDPID = (CASE WHEN LEFT(@@DPCLT,2) = 'IN' THEN RIGHT(@@DPCLT, 8) ELSE @@DPCLT END),  
     DPTYPE = (CASE WHEN LEFT(@@DPCLT,2) = 'IN' THEN 'NSDL' ELSE 'CDSL' END)  
     WHERE SNO = @@SNO                
    END                    
       ELSE                  
    BEGIN                
      SELECT @@PCOUNT = @@PCOUNT - @@TRADEQTY                
    SELECT @@REMQTY = @@DELQTY - @@PCOUNT                
      SELECT @@OLDQTY = @@TRADEQTY - @@REMQTY                
      SELECT @@PCOUNT = @@PCOUNT + @@REMQTY                  
                      
     INSERT INTO DELTRANS(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SCRIP_CD,SERIES,QTY,FROMNO,TONO,CERTNO,FOLIONO,  
     HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5)                
     SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SCRIP_CD,SERIES,QTY=@@OLDQTY,FROMNO,TONO,CERTNO,FOLIONO,  
     HOLDERNAME,REASON,'D',DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,1,FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5                
     FROM DELTRANS WHERE SNO = @@SNO          
                
     UPDATE DELTRANS SET PARTY_CODE = @@PARTY_CODE, REASON=(CASE WHEN @@FLAG='E' THEN 'EXCESS RECEIVED TRANSFER' ELSE 'PAY-OUT' END),  
     DPID = LEFT(@@DPCLT,8), CLTDPID = (CASE WHEN LEFT(@@DPCLT,2) = 'IN' THEN RIGHT(@@DPCLT, 8) ELSE @@DPCLT END),   
     DPTYPE = (CASE WHEN LEFT(@@DPCLT,2) = 'IN' THEN 'NSDL' ELSE 'CDSL' END),   
     QTY = @@REMQTY            
     WHERE SNO = @@SNO           
                  
    END                
    FETCH NEXT FROM @@CERTCUR INTO @@TRADEQTY,@@CERTNO,@@FROMNO,@@FOLIONO,@@SDATE,@@ORGQTY,@@SNO,@@TCODE                
     END                
   END                
   CLOSE @@CERTCUR                
   DEALLOCATE @@CERTCUR                 
      END                
      CLOSE @@QTYCUR                
      DEALLOCATE @@QTYCUR                
      FETCH NEXT FROM @@DELCLT INTO @@SCRIP_CD,@@SERIES,@@PARTY_CODE,@@DELQTY,@@DPCLT,@@FLAG                
END                
CLOSE @@DELCLT                
DEALLOCATE @@DELCLT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsDelAccCheck
-- --------------------------------------------------
  
        
  
CREATE PROC [dbo].[InsDelAccCheck] AS             
  
TRUNCATE TABLE DELACCBALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsDelCheckPos
-- --------------------------------------------------
CREATE Proc [dbo].[InsDelCheckPos] (@RefNo int) As                    
Declare                    
@@SNo Numeric(18,0),                    
@@Sett_No Varchar(7),                    
@@Sett_Type Varchar(2),                    
@@Party_Code Varchar(10),                    
@@Scrip_Cd varchar(12),                    
@@Series Varchar(3),                    
@@DematQty numeric(18, 4),                    
@@CertQty numeric(18, 4),                    
@@DelQty numeric(18, 4),                    
@@DQty numeric(18, 4),                    
@@RemQty numeric(18, 4),                    
@@CltAccNo Varchar(16),                    
@@BankCode Varchar(16),                    
@@TransNo Varchar(16),                    
@@DematCur Cursor,                    
@@DelCur Cursor,                    
@@MCur Cursor,                    
@@DCur Cursor,                    
@@CertCur Cursor                    
                    
Set NoCount On                     
              
UPDATE DEMATTRANS SET SERIES = 'MF'    
    
UPDATE DEMATTRANS SET SCRIP_CD = M.SCRIP_CD, SETT_TYPE = M.SETT_TYPE,     
PARTY_CODE = M.PARTY_CODE    
FROM MFSS_SETTLEMENT M     
WHERE DEMATTRANS.SETT_NO = M.SETT_NO     
AND M.DPCLT = DEMATTRANS.CLTACCNO    
AND M.ISIN = DEMATTRANS.ISIN     
AND TRTYPE <> 906     
    
UPDATE DEMATTRANS SET SCRIP_CD = M.SCRIP_CD, SETT_TYPE = M.SETT_TYPE     
FROM MFSS_SETTLEMENT M     
WHERE DEMATTRANS.SETT_NO = M.SETT_NO     
AND M.ISIN = DEMATTRANS.ISIN     
AND TRTYPE = 906     
                   
Update DematTrans Set DpType = 'CDSL' Where Len(CltAccNo) = 16                    
                    
Update DematTrans Set DpId = Left(CltAccNo,8) Where DpId = '' and DpType = 'CDSL'                    
              
Set @@DematCur = Cursor for                    
Select Sett_No,Sett_Type,CltAccno,DpId,Qty,Scrip_Cd,Series,TransNo,SNo from DematTrans                    
where Party_Code = 'Party' and DrCr = 'C' and DpId <> '' and RefNo = @RefNo                     
And CltAccNo In ( Select CltDpNo From MultiCltId Where DpId = DematTrans.DpId And CltDpNo = CltAccNo                     
    Group By CltDpNo                     
           Having Count(CltDpNo) > 1 )                     
Open @@DematCur                    
Fetch Next from @@DematCur into @@Sett_No,@@Sett_Type,@@CltAccno,@@BankCode,@@DematQty,@@Scrip_Cd,@@Series,@@TransNo,@@SNo                     
if @@Fetch_Status = 0                     
Begin              
 While @@Fetch_Status = 0                     
 Begin                     
  Set @@MCur = Cursor for                    
  Select Distinct Party_Code From MultiCltId Where DpId = @@BankCode and CltDpNo = @@CltAccNo              Open @@MCur                     
  Fetch Next from @@MCur into @@Party_Code                     
  if @@Fetch_Status = 0                     
  Begin                     
   While @@Fetch_Status = 0 and @@DematQty > 0                     
   Begin                    
    Set @@DelCur = Cursor for                    
    Select IsNull(Sum(Qty),0) from DeliveryClt Where Sett_No = @@Sett_No                     
    and Sett_Type = @@Sett_Type and Party_Code = @@Party_Code                     
    and Scrip_Cd = @@Scrip_Cd and Series = @@Series and InOut = 'I'                    
    Open @@DelCur                    
    Fetch Next from @@DelCur into @@DelQty                    
    Close @@DelCur                    
                        
    set @@CertCur = Cursor For                            
    select IsNull(Sum(Qty),0) from DelTrans                   
    Where sett_no = @@sett_no and sett_type = @@sett_type                    
    and Party_Code = @@Party_Code                       
    and Scrip_Cd = @@Scrip_Cd and Series = @@Series                   
    and DrCr = 'C' and RefNo = @RefNo                       
    And Filler2 = 1                   
    Open @@CertCur                      
    Fetch NExt From @@CertCur into @@CertQty                      
    Close @@CertCur                    
                        
                        
    set @@DCur = Cursor For                      
    select IsNull(Sum(Qty),0) from DematTrans Where Party_Code = @@Party_Code                     
    and Scrip_Cd = @@Scrip_Cd and Series = @@Series and                  
    sett_no = @@sett_no and sett_type = @@sett_type and DrCr = 'C' and RefNo = @RefNo                     
    Open @@DCur                    
    Fetch NExt From @@DCur into @@DQty                    
    Close @@DCur                      
                    
    Select @@RemQty = @@DelQty - @@CertQty - @@DQty                     
                     
    if @@DematQty <= @@RemQty and @@RemQty > 0                    
    Begin                    
     Update DematTrans Set Party_Code = @@Party_Code                     
     where Sett_No = @@Sett_No and Sett_Type = @@Sett_Type and Party_Code = 'Party'                     
     and Scrip_Cd = @@Scrip_Cd and Series = @@Series and DrCr = 'C' and Sno = @@Sno                    
     and TransNo = @@TransNo and CltAccNo = @@CltAccNo and DpId = @@BankCode and RefNo = @RefNo                     
             and Qty = @@DematQty                    
     Select @@DematQty = 0                     
    end                    
    else if @@DematQty > @@RemQty and @@RemQty > 0                    
    Begin                    
     Insert into DematTrans ( Sett_No,Sett_Type,RefNo,TCode,TrType,Party_Code,Scrip_Cd,Series,Qty,TrDate,CltAccNo,DpId,DpName,IsIn,Branch_Cd,PartiPantCode,DpType,TransNo,DrCr,BDpType,BDpId,BCltAccNo,Filler1,Filler2,Filler3,Filler4,Filler5 )              
  
    
      
     select Sett_No,Sett_Type,RefNo,TCode,TrType,Party_Code,Scrip_Cd,Series,@@DematQty-@@RemQty,TrDate,CltAccNo,DpId,DpName,IsIn,Branch_Cd,PartiPantCode,DpType,TransNo,DrCr,BDpType,BDpId,BCltAccNo,Filler1,Filler2,Filler3,Filler4,Filler5                   
 
     from DematTrans Where Sett_No = @@Sett_No and                    
     Sett_Type = @@Sett_Type and Scrip_cd = @@Scrip_cd and Series = @@Series and                    
     Party_Code = 'Party' and DrCr = 'C' and Sno = @@Sno and TransNo = @@TransNo                    
       and CltAccNo = @@CltAccNo and DpId = @@BankCode and Qty = @@DematQty and RefNo = @RefNo                      
                          
     Update DematTrans Set Party_Code = @@Party_Code,Qty = @@RemQty                      
     where Sett_No = @@Sett_No and Sett_Type = @@Sett_Type and                     
     Party_Code = 'Party' and Scrip_Cd = @@Scrip_Cd and Series = @@Series                     
     and DrCr = 'C' and Sno = @@Sno and TransNo = @@TransNo and CltAccNo = @@CltAccNo and                     
     DpId = @@BankCode and Qty = @@DematQty and RefNo = @RefNo                    
     Select @@DematQty = @@DematQty-@@RemQty                    
    End                    
    Fetch Next from @@MCur into @@Party_Code                     
   End                         
  End                    
  close @@MCur                   
                      
  Fetch Next from @@DematCur into @@Sett_No,@@Sett_Type,@@CltAccno,@@BankCode,@@DematQty,@@Scrip_Cd,@@Series,@@TransNo,@@SNo                    
 End                    
End                    
Close @@DematCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INSDELTRANSPRINTPOOL
-- --------------------------------------------------
CREATE PROC [dbo].[INSDELTRANSPRINTPOOL] (@OPTFLAG INT, @BDPTYPE VARCHAR(4), @BDPID VARCHAR(8), @BCLTDPID VARCHAR(16),    
@CATEGORY VARCHAR(10), @BRANCHCODE VARCHAR(10))     
AS    
DECLARE     
@SETT_NO VARCHAR(7),    
@SETT_TYPE VARCHAR(2),    
@SNO NUMERIC,    
@QTY NUMERIC(18, 4),    
@DIFFQTY NUMERIC(18, 4),    
@SLIPNO INT,    
@BATCHNO INT,    
@TRANSDATE VARCHAR(11),    
@HOLDERNAME VARCHAR(30),    
@FOLIONO VARCHAR(20),    
@PARTY_CODE VARCHAR(10),    
@CERTNO VARCHAR(12),    
@TRTYPE INT,    
@DPID VARCHAR(8),    
@CLTDPID VARCHAR(16),    
@DELBDPID VARCHAR(8),    
@DELBCLTDPID VARCHAR(16),    
@ALLQTY INT,    
@DELCUR CURSOR,    
@BENCUR CURSOR    
    
IF @OPTFLAG = 1     
BEGIN    
UPDATE DELTRANS SET DELIVERED = 'G', SLIPNO = D.SLIPNO,     
BATCHNO = D.BATCHNO, FOLIONO = D.FOLIONO,    
TRANSDATE = D.TRANSDATE, HOLDERNAME = D.HOLDERNAME    
FROM DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = '0'    
AND DELTRANS.ISETT_NO = D.ISETT_NO    
AND DELTRANS.ISETT_TYPE = D.ISETT_TYPE    
AND OPTIONFLAG = 1  AND DELTRANS.PARTY_CODE <> 'BROKER'    
END    
    
IF @OPTFLAG = 3    
BEGIN    
UPDATE DELTRANS SET DELIVERED = 'G', SLIPNO = D.SLIPNO,     
BATCHNO = D.BATCHNO, FOLIONO = D.FOLIONO,    
TRANSDATE = D.TRANSDATE, HOLDERNAME = D.HOLDERNAME    
FROM DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.PARTY_CODE = D.PARTY_CODE    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = '0'    
AND DELTRANS.DPID = D.DPID    
AND DELTRANS.CLTDPID = D.CLTDPID    
AND OPTIONFLAG = 3    
AND D.QTY = NEWQTY     
AND DELTRANS.PARTY_CODE <> 'BROKER'    
    
INSERT INTO DELTRANSTEMP    
SELECT DELTRANS.SNO,DELTRANS.SETT_NO,DELTRANS.SETT_TYPE,DELTRANS.REFNO,DELTRANS.TCODE,DELTRANS.TRTYPE,    
DELTRANS.PARTY_CODE,DELTRANS.SCRIP_CD,DELTRANS.SERIES,DELTRANS.QTY,DELTRANS.FROMNO,DELTRANS.TONO,    
DELTRANS.CERTNO,DELTRANS.FOLIONO,DELTRANS.HOLDERNAME,DELTRANS.REASON,DELTRANS.DRCR,'D',DELTRANS.ORGQTY,    
DELTRANS.DPTYPE,DELTRANS.DPID,DELTRANS.CLTDPID,DELTRANS.BRANCHCD,DELTRANS.PARTIPANTCODE,DELTRANS.SLIPNO,    
DELTRANS.BATCHNO,DELTRANS.ISETT_NO,DELTRANS.ISETT_TYPE,DELTRANS.SHARETYPE,DELTRANS.TRANSDATE,DELTRANS.FILLER1,    
DELTRANS.FILLER2,DELTRANS.FILLER3,DELTRANS.BDPTYPE,DELTRANS.BDPID,DELTRANS.BCLTDPID,DELTRANS.FILLER4,DELTRANS.FILLER5    
FROM DELTRANS, DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.PARTY_CODE = D.PARTY_CODE    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = 'G'    
AND DELTRANS.DPID = D.DPID    
AND DELTRANS.CLTDPID = D.CLTDPID    
AND DELTRANS.FOLIONO = D.FOLIONO    
AND DELTRANS.SLIPNO = D.SLIPNO    
AND DELTRANS.BATCHNO = D.BATCHNO    
AND OPTIONFLAG = 3    
AND D.QTY = NEWQTY     
AND DELTRANS.PARTY_CODE <> 'BROKER'    
    
SET @BENCUR = CURSOR FOR    
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, CERTNO, TRTYPE, DPID, CLTDPID, SLIPNO, BATCHNO, FOLIONO,     
HOLDERNAME, QTY , TRANSDATE = LEFT(CONVERT(VARCHAR,TRANSDATE,109),11), BDPID, BCLTDPID    
FROM DELTRANSPRINTPOOL WHERE OPTIONFLAG = 3 AND QTY <> NEWQTY     
ORDER BY PARTY_CODE, CERTNO    
OPEN @BENCUR    
FETCH NEXT FROM @BENCUR INTO @SETT_NO, @SETT_TYPE, @PARTY_CODE, @CERTNO, @TRTYPE, @DPID, @CLTDPID, @SLIPNO, @BATCHNO, @FOLIONO,     
@HOLDERNAME, @ALLQTY , @TRANSDATE, @DELBDPID, @DELBCLTDPID    
WHILE @@FETCH_STATUS = 0     
BEGIN    
 SELECT @DIFFQTY = @ALLQTY    
 SET @DELCUR = CURSOR FOR    
 SELECT SNO, QTY FROM DELTRANS    
 WHERE PARTY_CODE = @PARTY_CODE    
 AND CERTNO = @CERTNO    
 AND TRTYPE = @TRTYPE    
 AND DRCR = 'D'    
 AND DELIVERED = '0'    
 AND FILLER2 = 1     
 AND DPID = @DPID    
 AND CLTDPID = @CLTDPID    
 AND BDPID = @DELBDPID    
 AND BCLTDPID = @DELBCLTDPID    
 ORDER BY SETT_NO, SETT_TYPE, QTY DESC    
 OPEN @DELCUR    
 FETCH NEXT FROM @DELCUR INTO @SNO, @QTY     
 WHILE @@FETCH_STATUS = 0 AND @DIFFQTY > 0     
 BEGIN    
  IF @DIFFQTY >= @QTY    
  BEGIN    
   UPDATE DELTRANS SET SLIPNO = @SLIPNO, BATCHNO = @BATCHNO, FOLIONO = @FOLIONO,    
   HOLDERNAME = @HOLDERNAME, TRANSDATE = @TRANSDATE, DELIVERED = 'G'    
   WHERE SETT_NO = @SETT_NO    
   AND SETT_TYPE = @SETT_TYPE    
   AND SNO = @SNO    
   SELECT @DIFFQTY = @DIFFQTY - @QTY    
  END    
  ELSE    
  BEGIN    
   INSERT INTO DELTRANS    
   SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SCRIP_CD,SERIES,@QTY-@DIFFQTY,FROMNO,TONO,    
   CERTNO,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,    
   PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,    
   FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5 FROM DELTRANS    
   WHERE SETT_NO = @SETT_NO    
   AND SETT_TYPE = @SETT_TYPE    
   AND SNO = @SNO    
    
   UPDATE DELTRANS SET SLIPNO = @SLIPNO, BATCHNO = @BATCHNO, FOLIONO = @FOLIONO,    
   HOLDERNAME = @HOLDERNAME, TRANSDATE = @TRANSDATE, DELIVERED = 'G', QTY = @DIFFQTY    
   WHERE SETT_NO = @SETT_NO    
   AND SETT_TYPE = @SETT_TYPE    
   AND SNO = @SNO    
    
   SELECT @DIFFQTY = 0     
  END    
  FETCH NEXT FROM @DELCUR INTO @SNO, @QTY     
 END    
 FETCH NEXT FROM @BENCUR INTO @SETT_NO, @SETT_TYPE,@PARTY_CODE, @CERTNO, @TRTYPE, @DPID, @CLTDPID, @SLIPNO, @BATCHNO, @FOLIONO,     
 @HOLDERNAME, @ALLQTY , @TRANSDATE, @DELBDPID, @DELBCLTDPID    
END    
    
INSERT INTO DELTRANSTEMP    
SELECT DELTRANS.SNO,DELTRANS.SETT_NO,DELTRANS.SETT_TYPE,DELTRANS.REFNO,DELTRANS.TCODE,DELTRANS.TRTYPE,    
DELTRANS.PARTY_CODE,DELTRANS.SCRIP_CD,DELTRANS.SERIES,DELTRANS.QTY,DELTRANS.FROMNO,DELTRANS.TONO,    
DELTRANS.CERTNO,DELTRANS.FOLIONO,DELTRANS.HOLDERNAME,DELTRANS.REASON,DELTRANS.DRCR,'D',DELTRANS.ORGQTY,    
DELTRANS.DPTYPE,DELTRANS.DPID,DELTRANS.CLTDPID,DELTRANS.BRANCHCD,DELTRANS.PARTIPANTCODE,DELTRANS.SLIPNO,    
DELTRANS.BATCHNO,DELTRANS.ISETT_NO,DELTRANS.ISETT_TYPE,DELTRANS.SHARETYPE,DELTRANS.TRANSDATE,DELTRANS.FILLER1,    
DELTRANS.FILLER2,DELTRANS.FILLER3,DELTRANS.BDPTYPE,DELTRANS.BDPID,DELTRANS.BCLTDPID,DELTRANS.FILLER4,DELTRANS.FILLER5    
FROM DELTRANS, DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.PARTY_CODE = D.PARTY_CODE    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = 'G'    
AND DELTRANS.DPID = D.DPID    
AND DELTRANS.CLTDPID = D.CLTDPID    
AND DELTRANS.FOLIONO = D.FOLIONO    
AND DELTRANS.SLIPNO = D.SLIPNO    
AND DELTRANS.BATCHNO = D.BATCHNO    
AND OPTIONFLAG = 3    
AND D.QTY <> NEWQTY    
    
END    
    
IF @OPTFLAG = 2    
BEGIN    
UPDATE DELTRANS SET DELIVERED = 'G', SLIPNO = D.SLIPNO,     
BATCHNO = D.BATCHNO, FOLIONO = D.FOLIONO,    
TRANSDATE = D.TRANSDATE, HOLDERNAME = D.HOLDERNAME    
FROM DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = '0'    
AND OPTIONFLAG = 2    
AND DELTRANS.PARTY_CODE <> 'BROKER'    
 AND EXISTS (SELECT PARTY_CODE FROM CLIENT2 C2, CLIENT1 C1     
    WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = DELTRANS.PARTY_CODE     
    AND C1.BRANCH_CD = (CASE WHEN @BRANCHCODE = 'ALL' THEN C1.BRANCH_CD ELSE @BRANCHCODE END)    
    )     
    
INSERT INTO DELTRANSTEMP    
SELECT DELTRANS.SNO,DELTRANS.SETT_NO,DELTRANS.SETT_TYPE,DELTRANS.REFNO,DELTRANS.TCODE,DELTRANS.TRTYPE,    
DELTRANS.PARTY_CODE,DELTRANS.SCRIP_CD,DELTRANS.SERIES,DELTRANS.QTY,DELTRANS.FROMNO,DELTRANS.TONO,    
DELTRANS.CERTNO,DELTRANS.FOLIONO,DELTRANS.HOLDERNAME,DELTRANS.REASON,DELTRANS.DRCR,'0',DELTRANS.ORGQTY,    
DELTRANS.DPTYPE,DELTRANS.DPID,DELTRANS.CLTDPID,DELTRANS.BRANCHCD,DELTRANS.PARTIPANTCODE,DELTRANS.SLIPNO,    
DELTRANS.BATCHNO,DELTRANS.ISETT_NO,DELTRANS.ISETT_TYPE,DELTRANS.SHARETYPE,DELTRANS.TRANSDATE,DELTRANS.FILLER1,    
DELTRANS.FILLER2,DELTRANS.FILLER3,@BDPTYPE,@BDPID,@BCLTDPID,DELTRANS.FILLER4,DELTRANS.FILLER5    
FROM DELTRANS, DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = 'G'    
AND OPTIONFLAG = 2    
AND DELTRANS.FOLIONO = D.FOLIONO    
AND DELTRANS.SLIPNO = D.SLIPNO    
AND DELTRANS.BATCHNO = D.BATCHNO    
AND DELTRANS.PARTY_CODE <> 'BROKER'    
 AND EXISTS (SELECT PARTY_CODE FROM CLIENT2 C2, CLIENT1 C1     
    WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = DELTRANS.PARTY_CODE     
    AND C1.BRANCH_CD = (CASE WHEN @BRANCHCODE = 'ALL' THEN C1.BRANCH_CD ELSE @BRANCHCODE END)    
    )     
END    
  
IF @OPTFLAG = 4    
BEGIN    
UPDATE DELTRANS SET DELIVERED = 'G', SLIPNO = D.SLIPNO,     
BATCHNO = D.BATCHNO, FOLIONO = D.FOLIONO,    
TRANSDATE = D.TRANSDATE, HOLDERNAME = D.HOLDERNAME    
FROM DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.PARTY_CODE = D.PARTY_CODE    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = '0'    
AND OPTIONFLAG = 4  
AND D.QTY = NEWQTY     
AND DELTRANS.PARTY_CODE <> 'BROKER'    
    
INSERT INTO DELTRANSTEMP    
SELECT DELTRANS.SNO,DELTRANS.SETT_NO,DELTRANS.SETT_TYPE,DELTRANS.REFNO,DELTRANS.TCODE,DELTRANS.TRTYPE,    
DELTRANS.PARTY_CODE,DELTRANS.SCRIP_CD,DELTRANS.SERIES,DELTRANS.QTY,DELTRANS.FROMNO,DELTRANS.TONO,    
DELTRANS.CERTNO,DELTRANS.FOLIONO,DELTRANS.HOLDERNAME,DELTRANS.REASON,DELTRANS.DRCR,'0',DELTRANS.ORGQTY,    
DELTRANS.DPTYPE,DELTRANS.DPID,DELTRANS.CLTDPID,DELTRANS.BRANCHCD,DELTRANS.PARTIPANTCODE,DELTRANS.SLIPNO,    
DELTRANS.BATCHNO,DELTRANS.ISETT_NO,DELTRANS.ISETT_TYPE,DELTRANS.SHARETYPE,DELTRANS.TRANSDATE,DELTRANS.FILLER1,    
DELTRANS.FILLER2,DELTRANS.FILLER3,@BDPTYPE,@BDPID,@BCLTDPID,DELTRANS.FILLER4,DELTRANS.FILLER5    
FROM DELTRANS, DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.PARTY_CODE = D.PARTY_CODE    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = 'G'    
AND DELTRANS.FOLIONO = D.FOLIONO    
AND DELTRANS.SLIPNO = D.SLIPNO    
AND DELTRANS.BATCHNO = D.BATCHNO    
AND OPTIONFLAG = 4   
AND D.QTY = NEWQTY     
AND DELTRANS.PARTY_CODE <> 'BROKER'    
    
SET @BENCUR = CURSOR FOR    
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, CERTNO, TRTYPE, SLIPNO, BATCHNO, FOLIONO,     
HOLDERNAME, QTY , TRANSDATE = LEFT(CONVERT(VARCHAR,TRANSDATE,109),11), BDPID, BCLTDPID    
FROM DELTRANSPRINTPOOL WHERE OPTIONFLAG = 4 AND QTY <> NEWQTY     
ORDER BY PARTY_CODE, CERTNO    
OPEN @BENCUR    
FETCH NEXT FROM @BENCUR INTO @SETT_NO, @SETT_TYPE, @PARTY_CODE, @CERTNO, @TRTYPE, @SLIPNO, @BATCHNO, @FOLIONO,     
@HOLDERNAME, @ALLQTY , @TRANSDATE, @DELBDPID, @DELBCLTDPID    
WHILE @@FETCH_STATUS = 0     
BEGIN    
 SELECT @DIFFQTY = @ALLQTY    
 SET @DELCUR = CURSOR FOR    
 SELECT SNO, QTY FROM DELTRANS    
 WHERE PARTY_CODE = @PARTY_CODE    
 AND CERTNO = @CERTNO    
 AND TRTYPE = @TRTYPE    
 AND DRCR = 'D'    
 AND DELIVERED = '0'    
 AND FILLER2 = 1     
 AND BDPID = @DELBDPID    
 AND BCLTDPID = @DELBCLTDPID    
 ORDER BY SETT_NO, SETT_TYPE, QTY DESC    
 OPEN @DELCUR    
 FETCH NEXT FROM @DELCUR INTO @SNO, @QTY     
 WHILE @@FETCH_STATUS = 0 AND @DIFFQTY > 0     
 BEGIN    
  IF @DIFFQTY >= @QTY    
  BEGIN    
   UPDATE DELTRANS SET SLIPNO = @SLIPNO, BATCHNO = @BATCHNO, FOLIONO = @FOLIONO,    
   HOLDERNAME = @HOLDERNAME, TRANSDATE = @TRANSDATE, DELIVERED = 'G'    
   WHERE SETT_NO = @SETT_NO    
   AND SETT_TYPE = @SETT_TYPE    
   AND SNO = @SNO    
   SELECT @DIFFQTY = @DIFFQTY - @QTY    
  END    
  ELSE    
  BEGIN    
   INSERT INTO DELTRANS    
   SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SCRIP_CD,SERIES,@QTY-@DIFFQTY,FROMNO,TONO,    
   CERTNO,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,    
   PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,    
   FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5 FROM DELTRANS    
   WHERE SETT_NO = @SETT_NO    
   AND SETT_TYPE = @SETT_TYPE    
   AND SNO = @SNO    
    
   UPDATE DELTRANS SET SLIPNO = @SLIPNO, BATCHNO = @BATCHNO, FOLIONO = @FOLIONO,    
   HOLDERNAME = @HOLDERNAME, TRANSDATE = @TRANSDATE, DELIVERED = 'G', QTY = @DIFFQTY    
   WHERE SETT_NO = @SETT_NO    
   AND SETT_TYPE = @SETT_TYPE    
   AND SNO = @SNO    
    
   SELECT @DIFFQTY = 0     
  END    
  FETCH NEXT FROM @DELCUR INTO @SNO, @QTY     
 END    
 FETCH NEXT FROM @BENCUR INTO @SETT_NO, @SETT_TYPE,@PARTY_CODE, @CERTNO, @TRTYPE, @SLIPNO, @BATCHNO, @FOLIONO,     
 @HOLDERNAME, @ALLQTY , @TRANSDATE, @DELBDPID, @DELBCLTDPID    
END    
    
INSERT INTO DELTRANSTEMP    
SELECT DELTRANS.SNO,DELTRANS.SETT_NO,DELTRANS.SETT_TYPE,DELTRANS.REFNO,DELTRANS.TCODE,DELTRANS.TRTYPE,    
DELTRANS.PARTY_CODE,DELTRANS.SCRIP_CD,DELTRANS.SERIES,DELTRANS.QTY,DELTRANS.FROMNO,DELTRANS.TONO,    
DELTRANS.CERTNO,DELTRANS.FOLIONO,DELTRANS.HOLDERNAME,DELTRANS.REASON,DELTRANS.DRCR,'0',DELTRANS.ORGQTY,    
DELTRANS.DPTYPE,DELTRANS.DPID,DELTRANS.CLTDPID,DELTRANS.BRANCHCD,DELTRANS.PARTIPANTCODE,DELTRANS.SLIPNO,    
DELTRANS.BATCHNO,DELTRANS.ISETT_NO,DELTRANS.ISETT_TYPE,DELTRANS.SHARETYPE,DELTRANS.TRANSDATE,DELTRANS.FILLER1,    
DELTRANS.FILLER2,DELTRANS.FILLER3,@BDPTYPE,@BDPID,@BCLTDPID,DELTRANS.FILLER4,DELTRANS.FILLER5    
FROM DELTRANS, DELTRANSPRINTPOOL D    
WHERE DELTRANS.SETT_NO = D.SETT_NO    
AND DELTRANS.SETT_TYPE = D.SETT_TYPE    
AND DELTRANS.PARTY_CODE >= D.FROMPARTY    
AND DELTRANS.PARTY_CODE <= D.TOPARTY    
AND DELTRANS.PARTY_CODE = D.PARTY_CODE    
AND DELTRANS.SCRIP_CD LIKE '%'    
AND DELTRANS.SERIES LIKE '%'    
AND DELTRANS.CERTNO = D.CERTNO    
AND DELTRANS.TRTYPE = D.TRTYPE    
AND FILLER2 = 1    
AND DRCR = 'D'    
AND DELTRANS.BDPTYPE = D.BDPTYPE    
AND DELTRANS.BDPID = D.BDPID    
AND DELTRANS.BCLTDPID = D.BCLTDPID    
AND DELIVERED = 'G'    
AND DELTRANS.FOLIONO = D.FOLIONO    
AND DELTRANS.SLIPNO = D.SLIPNO    
AND DELTRANS.BATCHNO = D.BATCHNO    
AND OPTIONFLAG = 4    
AND D.QTY <> NEWQTY    
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Insdematnsecursor
-- --------------------------------------------------
CREATE Proc [dbo].[Insdematnsecursor] ( @Refno Int) As      
      
Insert Into Deltrans      
Select Sett_No, Sett_Type, Refno, Tcode, Trtype, Party_Code, D.Scrip_Cd, D.Series, Qty, Transno, Transno, D.Isin, Transno, '',       
'Pay-Out', 'C', '0', Qty, Dptype, Dpid, Cltaccno, Branch_Cd, Partipantcode, 0, '', '', '', 'Demat',       
Trdate, Filler1, 1, Filler3, Bdptype, Bdpid, Bcltaccno, Filler4, Filler5      
From Demattrans D Where Drcr = 'C'       
And D.Scrip_Cd In ( Select Distinct Scrip_Cd From Deliveryclt De       
                       Where DE.Sett_No = D.Sett_No And DE.Sett_Type = D.Sett_Type      
        And De.Scrip_Cd = D.Scrip_Cd And De.Series = D.Series )             
      
Insert Into Deltrans      
Select Sett_No, Sett_Type, Refno, Tcode, (CASE WHEN TRTYPE = 906 THEN 904 ELSE 906 END),   
(CASE WHEN TRTYPE = 906 THEN 'BROKER' ELSE 'EXE' END), D.Scrip_Cd, D.Series, Qty, Transno, Transno, D.Isin, Transno, '',       
'Pay-Out', 'D', (CASE WHEN TRTYPE = 906 THEN '0' ELSE 'D' END), Qty, Dptype, Dpid, Cltaccno, Branch_Cd, Partipantcode, 0, '', '', '', 'Demat',       
Trdate, Filler1, 1, Filler3, Bdptype, Bdpid, Bcltaccno, Filler4, Filler5      
From Demattrans D Where Drcr = 'C'       
And D.Scrip_Cd In ( Select Distinct Scrip_Cd From Deliveryclt De       
                       Where DE.Sett_No = D.Sett_No And DE.Sett_Type = D.Sett_Type      
        And De.Scrip_Cd = D.Scrip_Cd And De.Series = D.Series )      
      
Delete From Demattrans Where Drcr = 'C'       
And Scrip_Cd In ( Select Distinct Scrip_Cd From Deliveryclt De       
                       Where DE.Sett_No = Demattrans.Sett_No And DE.Sett_Type = Demattrans.Sett_Type      
        And De.Scrip_Cd = Demattrans.Scrip_Cd And De.Series = Demattrans.Series )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Insertdematspeed
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.Insertdematspeed    Script Date: 12/16/2003 2:21:08 Pm ******/  
  
CREATE Procedure [dbo].[Insertdematspeed]   
  
       @Sett_No                  Varchar(7)          ,           
       @Sett_Type                Varchar(2)          ,           
       @Refno                    Int                 ,           
       @Tcode                    Numeric(18, 0)       ,           
       @Trtype                   Numeric(18, 0)       ,           
       @Party_Code               Varchar(10)         ,           
       @Scrip_Cd                 Varchar(12)         = Null,     
       @Series                   Varchar(3)          = Null,     
       @Qty                      Numeric(18, 4)       ,           
       @Trdate                   Datetime            ,           
       @Cltaccno                 Varchar(16)         = Null,     
       @Dpid                     Varchar(16)         = Null,     
       @Dpname                   Varchar(50)         = Null,     
       @Isin                     Varchar(12)         = Null,     
       @Branch_Cd                Varchar(10)         = Null,     
       @Partipantcode            Varchar(10)         = Null,     
       @Dptype                 Varchar(4)         = Null,     
       @Transno                Varchar(15)         ,           
       @Drcr                       Varchar(1)    ,   
       @Bdptype               Varchar(4)         = Null,     
       @Bdpid                     Varchar(16)         = Null,     
       @Bcltaccno             Varchar(50)         = Null,   
       @Filler1  Varchar(100),         
       @Filler2  Int,   
       @Filler3  Int,   
       @Filler4  Int,   
       @Filler5  Int  
  
As  
  
       Declare @Procname Varchar(50)  
       Select @Procname = Object_Name(@@Procid)  
  
       Begin Transaction Trninsans  
  
              Begin  
                     Insert Into Demattransspeed(  
                                          Sett_No,   
                                          Sett_Type,   
                                          Refno,   
                                          Tcode,   
                                          Trtype,   
                                          Party_Code,   
                                          Scrip_Cd,   
                                          Series,   
                                          Qty,   
                                          Trdate,   
                                          Cltaccno,   
                                          Dpid,   
                                          Dpname,   
                                          Isin,   
                                          Branch_Cd,   
                                          Partipantcode,   
                                          Dptype,   
                                          Transno,   
                                          Drcr,   
               Bdptype,                 
               Bdpid,   
                      Bcltaccno,   
               Filler1,           
               Filler2,   
                                          Filler3,   
                                          Filler4,   
               Filler5  
                                          )  
                     Select  
                                          @Sett_No,   
                                          @Sett_Type,   
                                          @Refno,   
                                          @Tcode,   
                                          @Trtype,   
                                          @Party_Code,   
                                          @Scrip_Cd,   
                                          @Series,   
                                          @Qty,   
                                          @Trdate,   
                                          @Cltaccno,   
                                          @Dpid,   
                                          @Dpname,   
                                          @Isin,    
                                          @Branch_Cd,   
                                          @Partipantcode,   
                                          @Dptype,   
                                          @Transno,   
                                          @Drcr,   
               @Bdptype,                 
               @Bdpid,   
                      @Bcltaccno,   
               @Filler1,           
               @Filler2,   
                                          @Filler3,   
                                          @Filler4,   
               @Filler5  
  
                     If @@Error ! = 0  
                            Begin  
                                   Rollback Transaction Trninsans  
                                   Raiserror('Error Inserting Into Table Demattrans.  Error Occurred In Procedure %s.  Rolling Back Transaction...', 16, 1, @Procname)  
                                   Return  
                            End  
                     Else  
                            Begin  
                                   Commit Transaction Trninsans  
                            End  
              End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MF_CLIENT_EMAIL_MOB_MOD
-- --------------------------------------------------
  
  
CREATE PROCEDURE [dbo].[MF_CLIENT_EMAIL_MOB_MOD]  
(@PARTYCODE VARCHAR(10),@EMAIL VARCHAR(50),@MOBILE VARCHAR(50))  
AS  
  
/* VALIDATIONS */  
DECLARE @CNT  INT  
  
SELECT  @CNT=COUNT(1) FROM MFSS_CLIENT (NOLOCK) WHERE PARTY_CODE =@PARTYCODE --AND DP_TYPE='PHY'  
  
IF @CNT=0  
  BEGIN   
  
  INSERT INTO EMAIL_MOBILE_MOD_DETAILS (PARTY_CODE,EMAIL,MOBILE,FLAG,REMARKS)   
  SELECT @PARTYCODE ,@EMAIL,@MOBILE,'R','NORMAL CLIENT'  
  
  RETURN   
  END  
  
  SELECT  @CNT=COUNT(1) FROM MFSS_CLIENT (NOLOCK) WHERE PARTY_CODE =@PARTYCODE AND DP_TYPE='PHY'  
  AND (ISNULL(EMAIL_ID,'')=ISNULL(@EMAIL,'')  OR ISNULL(MOBILE_NO,'') =ISNULL(@MOBILE,'')   )  
  
    
IF @CNT<>0  
  BEGIN   
  
  INSERT INTO EMAIL_MOBILE_MOD_DETAILS (PARTY_CODE,EMAIL,MOBILE,FLAG,REMARKS)   
  SELECT @PARTYCODE ,@EMAIL,@MOBILE,'R','EMAIL ID OR MOBILE NUMBER SAME'  
  
  RETURN   
  END  
  
  
  UPDATE MFSS_CLIENT  SET EMAIL_ID =@EMAIL WHERE PARTY_CODE =@PARTYCODE  AND @EMAIL <>''  
    
  UPDATE NSEMFSS.DBO.MFSS_CLIENT  SET EMAIL_ID =@MOBILE WHERE PARTY_CODE =@PARTYCODE  AND @EMAIL <>''  
    
   UPDATE MFSS_CLIENT  SET MOBILE_NO =@MOBILE WHERE PARTY_CODE =@PARTYCODE  AND @MOBILE <>''  
    
  UPDATE NSEMFSS.DBO.MFSS_CLIENT  SET MOBILE_NO =@MOBILE WHERE PARTY_CODE =@PARTYCODE  AND @MOBILE <>''  
  
   INSERT INTO EMAIL_MOBILE_MOD_DETAILS (PARTY_CODE,EMAIL,MOBILE,FLAG,REMARKS)   
  SELECT @PARTYCODE ,@EMAIL,@MOBILE,'S','DATA UPDATED'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MF_DETACTIVATION
-- --------------------------------------------------


CREATE PROC [dbo].[MF_DETACTIVATION] 
(@PARTY_CODE VARCHAR(10) ,@flag varchar(1) )
AS


IF @FLAG NOT IN ('D','A')
  BEGIN 
   SELECT 'Provide a Vaild Flag ' As RESULT
   RETURN
 END



DECLARE @CNT INT	
SELECT @CNT=COUNT(1) FROM MFSS_CLIENT WHERE PARTY_CODE =@PARTY_CODE 

IF ( @CNT =0)
  BEGIN 
    SELECT  'Client Not exist'  AS  RESULT
	RETURN 
  end 



IF @FLAG ='D'
 BEGIN 
	SELECT @CNT=COUNT(1) FROM MFSS_CLIENT WHERE PARTY_CODE =@PARTY_CODE  AND INACTIVE_FROM < =GETDATE() 
 
 IF ( @CNT =0)
  BEGIN 
    SELECT 'Client Already Inactive' AS  RESULT
	RETURN 
  end 

	UPDATE  M SET INACTIVE_FROM = GETDATE(),ADDEDBY='EKYC'  FROM MFSS_CLIENT M WHERE PARTY_CODE =@PARTY_CODE  AND INACTIVE_FROM >= GETDATE() 
	UPDATE  M SET INACTIVE_FROM = GETDATE(),ADDEDBY='EKYC'  FROM NSEMFSS.DBO.MFSS_CLIENT M WHERE PARTY_CODE =@PARTY_CODE  AND INACTIVE_FROM >= GETDATE() 

    SELECT 'Client Code Inactivated' AS  RESULT

  END
 
 IF @FLAG ='A'
    BEGIN 
     	SELECT @CNT=COUNT(1) FROM MFSS_CLIENT WHERE PARTY_CODE =@PARTY_CODE  AND INACTIVE_FROM  >=GETDATE() 
 
	IF ( @CNT =0)
		BEGIN 
			SELECT 'Client Already Active' AS  RESULT
			RETURN 
		end 

	UPDATE  M SET INACTIVE_FROM = '2049-12-31' ,ADDEDBY='EKYC'  FROM MFSS_CLIENT M WHERE PARTY_CODE =@PARTY_CODE  AND INACTIVE_FROM <= GETDATE() 
	UPDATE  M SET INACTIVE_FROM = '2049-12-31' ,ADDEDBY='EKYC'  FROM NSEMFSS.DBO.MFSS_CLIENT M WHERE PARTY_CODE =@PARTY_CODE  AND INACTIVE_FROM <= GETDATE() 

    SELECT 'Client Code Activated' AS  RESULT	
 	
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_BROKERAGE_MASTER_DUPLICATE
-- --------------------------------------------------

CREATE PROC MFSS_BROKERAGE_MASTER_DUPLICATE
AS
SELECT M.* INTO #MFSS FROM MFSS_BROKERAGE_MASTER M ,(
select party_code,CONVERT(VARCHAR(11),TODATE,120) TODATE from MFSS_BROKERAGE_MASTER 
GROUP BY  party_code,CONVERT(VARCHAR(11),TODATE,120)
HAVING COUNT(*)>1 ) S
WHERE M.party_code=  S.party_code

BEGIN TRAN
DELETE R FROM MFSS_BROKERAGE_MASTER R WHERE SRNO   IN   (
SELECT SRNO FROM (
SELECT party_code,MIN(SRNO)SRNO FROM #MFSS S 
GROUP BY party_code  )s)
COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_CLIENT_RPT
-- --------------------------------------------------



CREATE PROCEDURE MFSS_CLIENT_RPT
(
@FROMDATE VARCHAR(20),
@TODATE VARCHAR(20)
)
AS 
BEGIN

SELECT PARTY_CODE,PARTY_NAME,BRANCH_CD,SUB_BROKER,REGION,PAN_NO,EMAIL_ID,MOBILE_NO,CL_STATUS,CL_TYPE
,BANK_NAME,BANK_BRANCH,BANK_CITY,ACC_NO,DP_TYPE,CLTDPID,ACTIVE_FROM,INACTIVE_FROM,DEACTIVE_REMARKS,DEACTIVE_VALUE
 FROM MFSS_CLIENT WITH(NOLOCK)
WHERE ACTIVE_FROM>=@FROMDATE AND ACTIVE_FROM<=@TODATE
AND DP_TYPE='PHY'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_DEACTIVATION
-- --------------------------------------------------
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE MFSS_DEACTIVATION 
	-- Add the parameters for the stored procedure here
	(@PARTY_CODE VARCHAR(10))
AS
BEGIN
 
  declare @cnt varchar(10)
   SET @cnt = (SELECT COUNT(*) FROM MFSS_CLIENT WHERE PARTY_CODE =@PARTY_CODE)
   If  @cnt =0 
        BEGIN 
	     SELECT 'Client Not Available'
		 
		END 
  IF @CNT >0
    BEGIN 
	  UPDATE MFSS_CLIENT SET INACTIVE_FROM = GETDATE() WHERE PARTY_CODE =@PARTY_CODE

	  SELECT @PARTY_CODE  ': Account Deactivated'
      
   END 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_ORDER_CLIENT_MISS
-- --------------------------------------------------

CREATE PROC MFSS_ORDER_CLIENT_MISS( @REPORT_DATE VARCHAR(11))
AS
SELECT *,REMARK='NOT PRESENT IN TRADE FILE' FROM 
(
SELECT DISTINCT PARTY_CODE FROM TDAYMFORDER WHERE REPORT_DATE = @REPORT_DATE
UNION ALL
SELECT DISTINCT PARTY_CODE FROM TDAYMFORDER_LOG WHERE REPORT_DATE = @REPORT_DATE ) A
WHERE  PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE FROM MFSS_SETTLEMENT WHERE ORDER_DATE = @REPORT_DATE)
ORDER BY  PARTY_CODE ASC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_POA_Mapping
-- --------------------------------------------------


CREATE proc [dbo].[MFSS_POA_Mapping]
as 

BEGIN 
create table #TEMP 
(PARTY_CODE varchar(15))


insert into #TEMP 
SELECT cast(RTRIM(LTRIM(PARTY_CODE)) as varchar(15)) PARTY_CODE FROM MFSS_CLIENT M,[172.31.16.94].DMAT.DBO.TBL_CLIENT_MASTER T
WHERE ISNULL(POAFLAG,'') ='NO' AND CLTDPID =CLIENT_CODE  AND STATUS ='ACTIVE' AND ISNULL(POA_VER,'') IN (1,2) 


insert into #TEMP 
SELECT cast(RTRIM(LTRIM(PARTY_CODE)) as varchar(15)) PARTY_CODE FROM MFSS_CLIENT M,[172.31.16.108].DMAT.citrus_usr.TBL_CLIENT_MASTER T
WHERE ISNULL(POAFLAG,'') ='NO' AND CLTDPID =CLIENT_CODE  AND STATUS ='ACTIVE' AND ISNULL(POA_VER,'') IN (1,2) 
and client_code >='1203320100000000'


--If (SELECT COUNT(*) FROM #TEMP ) >=1

--BEGIN 

--select * from MFSS_CLIENT WHERE PARTY_CODE IN ( SELECT PARTY_CODE FROM #TEMP)
--select * from #TEMP
BEGIN TRAN 
UPDATE MFSS_CLIENT SET POAFLAG ='YES' WHERE PARTY_CODE IN ( SELECT PARTY_CODE FROM #TEMP)
UPDATE MFSS_DPMASTER  SET POAFLAG ='YES' WHERE PARTY_CODE IN ( SELECT PARTY_CODE FROM #TEMP)
COMMIT


Truncate table testyo 
insert into testyo SELECT * FROM #TEMP
--end
/*
DECLARE @CNT INT 
	SELECT @CNT = COUNT(*) FROM #TEMP

IF @CNT =0

BEGIN 
--SELECT 'No Data Available For Mapping' as Result
Truncate table testyo 
Insert into testyo values ('NA')
end


else 


begin 
Truncate table testyo 
insert into testyo(PARTY_CODE) SELECT Party_code FROM MFSS_CLIENT WHERE PARTY_CODE IN ( SELECT * FROM #TEMP)
end



end

*/


EXEC msdb.dbo.sp_send_dbmail

@profile_name = 'SQLALERTs',

@recipients = 'deepak.redekar@angelbroking.com;suresh.k@angelbroking.com;hyd-kycsouth@angelbroking.com',

--@copy_recipients = 'bi.dba@angelbroking.com',

@subject = 'MFSS_POA_Mapping_REPORT',

@query = N'SELECT * FROM BSEMFSS.DBO.TESTYO',

@attach_query_result_as_file = 1,

@query_attachment_filename = 'PartyCodeList.csv'

End




/*

DECLARE @Emp_name as varchar(100),@emp_email as varchar(100)              
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                        
SELECT @emailto='deepak.redekar@angelbroking.com;ajay.gupta@angelbroking.com'              


DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                                  
                       
select @filename1='F:\Party_code\Party_Code_List'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.xls'                                                      

declare @s1 as varchar(max)                          
set @s1 = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT * FROM BSEMFSS.DBO.TESTYO" queryout '+@filename1+' -c -SANGELFO\ANGELFO -Uinhouse -Pinh6014'                                                                                       
set @s1= @s1+''''                              
Exec (@s1)                                          

SET @MESS='Dear All,<br><Br>Please refer to the attached spread sheet for the report.<Br><Br>'                                                            
set @sub ='MFSS_POA_Mapping_REPORT'  

 DECLARE @s varchar(500)                
 SET @s = @filename1 
                  
 EXEC MSDB.DBO.SP_SEND_DBMAIL                            
 @RECIPIENTS = @emailto,                            
 @COPY_RECIPIENTS = 'bi.dba@angelbroking.com',                            
 --@blind_copy_recipients=@emailto,                  
 @PROFILE_NAME = 'SQLALERTs',                            
 @BODY_FORMAT ='HTML',                            
 @SUBJECT = @sub ,                            
 @FILE_ATTACHMENTS =@s,                            
 @BODY =@MESS       

End

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_POA_Mapping_10Feb2018
-- --------------------------------------------------
CREATE proc [dbo].[MFSS_POA_Mapping_10Feb2018]

as 

BEGIN 
create table #TEMP 
(PARTY_CODE varchar(15))


insert into #TEMP
SELECT cast(RTRIM(LTRIM(PARTY_CODE)) as varchar(15)) PARTY_CODE FROM MFSS_CLIENT M,[172.31.16.94].DMAT.DBO.TBL_CLIENT_MASTER T

WHERE ISNULL(POAFLAG,'') ='NO' AND CLTDPID =CLIENT_CODE  AND STATUS ='ACTIVE'

AND ISNULL(POA_VER,'') IN (1,2) 



--If (SELECT COUNT(*) FROM #TEMP ) >=1

--BEGIN 



BEGIN TRAN 

UPDATE  MFSS_CLIENT SET POAFLAG ='YES' WHERE PARTY_CODE IN ( SELECT PARTY_CODE FROM #TEMP)



UPDATE MFSS_DPMASTER  SET POAFLAG ='YES' WHERE PARTY_CODE IN ( SELECT PARTY_CODE FROM #TEMP)

 

COMMIT



--END



DECLARE @CNT INT 



 SELECT @CNT = COUNT(*) FROM #TEMP

IF @CNT =0



BEGIN 

--SELECT 'No Data Available For Mapping' as Result

Truncate table testyo 

Insert into testyo values ('NA')

end

else 

begin 

Truncate table testyo 

insert into testyo(PARTY_CODE) SELECT Party_code FROM MFSS_CLIENT WHERE PARTY_CODE IN ( SELECT * FROM #TEMP)

end


DECLARE @sub VARCHAR(100);
--DECLARE @qry VARCHAR(1000);
DECLARE @msg VARCHAR(250);
DECLARE @query NVARCHAR(1000);
DECLARE @query_attachment_filename NVARCHAR(520);
SELECT @sub = 'MFSS_POA_Mapping_REPORT';
SELECT @msg = 'Please refer to the attached spread sheet for the report.';
SELECT @query = 'SELECT * FROM BSEMFSS.DBO.TESTYO';
SELECT @query_attachment_filename = 'Party Code List.csv';
EXEC msdb.dbo.sp_send_dbmail
     @profile_name = 'SQLALERTs',
     @recipients = 'deepak.redekar@angelbroking.com;ajay.gupta@angelbroking.com',
     @copy_recipients = 'bi.dba@angelbroking.com',
     @body = @msg,
     @subject = @sub,
     @query = @query,
     @query_attachment_filename = @query_attachment_filename,
     @attach_query_result_as_file = 1,
     @query_result_header = 1,
--     @query_result_width = 256,
     @query_result_separator = '',
     @query_result_no_padding = 1;
END



/*

EXEC msdb.dbo.sp_send_dbmail

@profile_name = 'SQLALERTs',

@recipients = 'deepak.redekar@angelbroking.com;ajay.gupta@angelbroking.com',

@copy_recipients = 'bi.dba@angelbroking.com',

@subject = 'MFSS_POA_Mapping_REPORT',

@query = N'SELECT * FROM BSEMFSS.DBO.TESTYO',

@attach_query_result_as_file = 1,

@query_attachment_filename = 'Party Code List.csv'

*/

--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_POA_Mapping_test
-- --------------------------------------------------
CREATE proc [dbo].[MFSS_POA_Mapping_test]    
as     
    
BEGIN     
    
EXEC msdb.dbo.sp_send_dbmail      
      
@profile_name = 'SQLALERTs',      
      
@recipients = 'mihir.kansara@angelbroking.com',
--'deepak.redekar@angelbroking.com;ajay.gupta@angelbroking.com',      
      
@copy_recipients = 'bi.dba@angelbroking.com',      
      
@subject = 'MFSS_POA_Mapping_REPORT',      
      
@query = N'SELECT * FROM BSEMFSS.DBO.TESTYO',      
      
@attach_query_result_as_file = 1,      
      
@query_attachment_filename = 'Party_Code_List.csv'      
      
      
End     
    
    
    
    
/*    
    
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100)                  
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                            
SELECT @emailto='deepak.redekar@angelbroking.com;ajay.gupta@angelbroking.com'                  
    
    
DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                                      
                           
select @filename1='F:\Party_code\Party_Code_List'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.xls'                                                          
    
declare @s1 as varchar(max)                              
set @s1 = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT * FROM BSEMFSS.DBO.TESTYO" queryout '+@filename1+' -c -SANGELFO\ANGELFO -Uinhouse -Pinh6014'                                                                                           
set @s1= @s1+''''                                  
Exec (@s1)                                              
    
SET @MESS='Dear All,<br><Br>Please refer to the attached spread sheet for the report.<Br><Br>'                                                                
set @sub ='MFSS_POA_Mapping_REPORT'      
    
 DECLARE @s varchar(500)                    
 SET @s = @filename1     
                      
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                
 @RECIPIENTS = @emailto,                                
 @COPY_RECIPIENTS = 'bi.dba@angelbroking.com',                                
 --@blind_copy_recipients=@emailto,                      
 @PROFILE_NAME = 'SQLALERTs',                                
 @BODY_FORMAT ='HTML',                                
 @SUBJECT = @sub ,                                
 @FILE_ATTACHMENTS =@s,                                
 @BODY =@MESS           
    
End    
    
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_POA_PAYIN
-- --------------------------------------------------
  
  
  
CREATE PROC [dbo].[MFSS_POA_PAYIN]  
(  
 @SETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(2),  
 @DPTYPE  VARCHAR(4)  
)  
  
AS  
  
SELECT *, POAID = CONVERT(VARCHAR(16),'')   
INTO #DELPAYOUT  
FROM MFSS_POAPAYIN D  
WHERE SETT_NO = @SETT_NO  
AND SETT_TYPE = @SETT_TYPE  
AND DPTYPE = @DPTYPE  
  
  
  
UPDATE #DELPAYOUT SET POAID = MASTER_POA_ID  
FROM TBL_DEL_MASTER_POAID T  
WHERE 
--#DELPAYOUT.DPID = T.DPID  
--AND #DELPAYOUT.CLTDPID = T.CLTDPID  AND
 POAID = ''  
AND POA_TYPE = 'ALL'  
AND GETDATE() BETWEEN FROM_DATE AND TO_DATE   
  
UPDATE #DELPAYOUT SET POAID = MASTER_POA_ID  
FROM TBL_DEL_MASTER_POAID T  
WHERE #DELPAYOUT.DPID = T.DPID  
AND #DELPAYOUT.CLTDPID = T.CLTDPID  
AND POAID = ''  
AND POA_TYPE = 'PAY-IN'  
AND GETDATE() BETWEEN FROM_DATE AND TO_DATE   
  
UPDATE #DELPAYOUT SET POAID = MASTER_POA_ID  
FROM TBL_DEL_MASTER_POAID T  
WHERE #DELPAYOUT.DPID = T.DPID  
AND T.CLTDPID = ''  
AND POAID = ''  
AND POA_TYPE = 'ALL'  
AND GETDATE() BETWEEN FROM_DATE AND TO_DATE   
    
UPDATE #DELPAYOUT SET POAID = MASTER_POA_ID  
FROM TBL_DEL_MASTER_POAID T  
WHERE #DELPAYOUT.DPID = T.DPID  
AND T.CLTDPID = ''  
AND POAID = ''  
AND POA_TYPE = 'PAY-IN'  
AND GETDATE() BETWEEN FROM_DATE AND TO_DATE   
  
SELECT * FROM #DELPAYOUT D  
Order By D.Sett_No,D.Sett_Type,POAID,d.Party_Code,ScripName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NOMINEE_DATA
-- --------------------------------------------------



CREATE PROC NOMINEE_DATA (@PARTY_CODE VARCHAR(10))
AS 
SELECT PARTY_CODE,PARTY_NAME,NOMINEE_NAME FROM MFSS_CLIENT WHERE ISNULL(NOMINEE_NAME,'')<>''
AND PARTY_CODE =@PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NON_Cash_Client_ACTIVATION
-- --------------------------------------------------
CREATE  PROC  [dbo].[NON_Cash_Client_ACTIVATION] (@CL_CODE VARCHAR(11))
AS 

DECLARE @CLTCOUNT INT        
        
  SELECT @CLTCOUNT =COUNT(PARTY_CODE) FROM         
  (SELECT PARTY_CODE FROM DBO.MFSS_CLIENT WITH(NOLOCK)  WHERE PARTY_CODE =  @CL_CODE     ) A  

IF ( @CLTCOUNT >=1)
  BEGIN 
    PRINT 'Client Already Registered'
    Return
  END

ELSE 

SET @CLTCOUNT=0

  SELECT @CLTCOUNT =COUNT(CL_CODE) FROM         
  (SELECT CL_CODE FROM MSAJAG.DBO.CLIENT_BROK_DETAILS  WITH(NOLOCK)  WHERE CL_CODE =  @CL_CODE AND SEGMENT ='CAPITAL'     ) A  

IF ( @CLTCOUNT >=1)
  BEGIN 
    PRINT 'Client Activate as per normal process'
    Return
  END

ELSE 




   BEGIN

    Create table #bank 
	(PARTY_CODE	varchar(10),
ACNUM	varchar(64),
BANK_NAME	varchar(50),
BANK_BRANCH	varchar(50),
MICR_CODE	varchar(12),
IFSC_CODE	varchar(11),
AC_NUM varchar(40),
DEFAULT_ID VARCHAR(10))

 

	INSERT INTO #bank
    EXEC ABVSCITRUS.CRMDB_A.DBO.CLI_BANK @CL_CODE



   INSERT INTO MFSS_CLIENT 
	SELECT CL_CODE BOPARTYCODE,LONG_NAME=REPLACE(((LONG_NAME)),'  ',' '),CL_TYPE ='CLI',
	CL_BALANCE='E',CL_STATUS  ,	BRANCH_CD  ,SUB_BROKER ,TRADER  ,AREA ,	REGION ,SBU ='HO',FAMILY=CL_CODE,GENDER=SEX,OCCUPATION ='',
	TAX_STATUS =(CASE WHEN cl_status ='IND' THEN '1' ELSE '0' END),	PAN_NO =pan_gir_no,KYC_FLAG ='Y',ADDR1= UPPER(l_address1),ADDR2=UPPER(ISNULL(l_address2,'')),
	ADDR3=UPPER(ISNULL(LEFT(l_address3,50),'')),CITY =UPPER(ISNULL(l_city,'')),
	STATE =UPPER(ISNULL(l_state,'')),ZIP=l_zip,NATION=UPPER(ISNULL(l_nation,'')),OFFICE_PHONE =ISNULL(res_phone1,''),OFFICE_PHONE =ISNULL(res_phone2,''),
	MOBILE_NO=ISNULL(mobile_pager,''),EMAIL_ID =ISNULL(email,''),B.BANK_NAME,BANK_BRANCH=B.BANK_BRANCH,BANK_CITY=Branch_Name,ACC_NO=B.AC_Num,PAYMODE ='4',
	MICR_NO =ISNULL(MICR_CODE,''),DOB=DOB, GAURDIAN_NAME='',	GAURDIAN_PAN_NO ='',	NOMINEE_NAME ='',	NOMINEE_RELATION='',
	BANK_AC_TYPE =(CASE WHEN AC_Type ='SAVINGS' THEN 'SB' ELSE 'CB' END),STAT_COMM_MODE='E',DP_TYPE='PHY',DPID='',CLTDPID='',MODE_HOLDING ='SI',
	HOLDER2_CODE ='',	HOLDER2_NAME ='',	HOLDER2_PAN_NO ='',	HOLDER2_KYC_FLAG ='',	HOLDER3_CODE ='',	HOLDER3_NAME='',	HOLDER3_PAN_NO ='',	HOLDER3_KYC_FLAG='',
	BUY_BROK_TABLE_NO='1',SELL_BROK_TABLE_NO='1',BROK_EFF_DATE=CONVERT(VARCHAR(11),GETDATE(),120) ,
	IFSC_CODE =IFSC_CODE,CHQUENAME='',RESIFAX='',OFFICEFAX='',
	MAPINID='',REMARK='',UCC_STATUS='1',ADDEDBY ='DIYMF',
	ADDEDON =GETDATE(),ACTIVE_FROM=GETDATE(),INACTIVE_FROM ='2049-12-31 23:59:00.000',POAFLAG='',
	DEACTIVE_REMARKS='',DEACTIVE_VALUE=''
	FROM  MSAJAG.DBO.CLIENT_DETAILS N,(SELECT TOP 1 * FROM #bank) B
	WHERE CL_CODE= @CL_CODE AND CL_CODE =B.party_code
    
	DECLARE @CNT INT
	SELECT @CNT =COUNT(1) FROM MFSS_CLIENT WHERE PARTY_CODE= @CL_CODE

	IF (@CNT = 0)
	  BEGIN 
	    Print 'Client Not Registered due to master Issue'
       Return
     end
   else

	INSERT INTO BBO_FA.DBO.ACMAST           
	SELECT PARTY_NAME,PARTY_NAME,'ASSET',4,'',PARTY_CODE,'','A0307000000','','',BRANCH_CD,0,'C','','','','BSE','MFSS' FROM           
	MFSS_CLIENT WHERE PARTY_CODE=@CL_CODE    

 
	INSERT INTO MFSS_BROKERAGE_MASTER          
	SELECT @CL_CODE,1,1,CONVERT(VARCHAR(11),GETDATE(),120) ,'2049-12-31 23:59'  WHERE @CL_CODE NOT IN (SELECT PARTY_CODE FROM  MFSS_BROKERAGE_MASTER)   
 	
	INSERT INTO POBANK        
	SELECT  M.BANK_NAME, BANK_BRANCH,'','','','','','','','','','','' FROM MFSS_CLIENT M        
	LEFT OUTER         
	JOIN POBANK        
	ON M.BANK_NAME= POBANK.BANK_NAME AND BANK_BRANCH=BRANCH_NAME        
	WHERE BANKID IS NULL      AND PARTY_CODE = @CL_CODE   
	GROUP BY M.BANK_NAME, BANK_BRANCH
   
	INSERT INTO BBO_FA.DBO.MULTIBANKID(Cltcode,Bankid,Accno,Acctype,Chequename,Defaultbank,exchange,segment)        
	SELECT PARTY_CODE,MAX(P.BANKID),ACC_NO,BANK_AC_TYPE,PARTY_NAME ,1,'BSE','MFSS'        
	FROM   MFSS_CLIENT M , POBANK P        
	WHERE M.BANK_NAME= P.BANK_NAME AND M.BANK_BRANCH=P.BRANCH_NAME  AND PARTY_CODE =@CL_CODE      
	GROUP BY PARTY_CODE,ACC_NO,BANK_AC_TYPE,PARTY_NAME   	
	


	
	Print 'Client Data Pushed in Backoffice'
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NSEMFSS_SCRIPUPLOAD
-- --------------------------------------------------

CREATE PROC NSEMFSS_SCRIPUPLOAD
(
	@FilePath Varchar(100), 
	@ROWTERMINATOR VARCHAR(10)='\n'
)
AS

DECLARE @SQL VARCHAR(2000)

TRUNCATE TABLE MFSS_SCRIP_MASTER_TMP

SELECT TOKEN,SCRIP_CD,SERIES,INTRUMENTTYPE,QUANTITY_LIMIT,RTSCHEMECODE,
AMCSCHEMECODE,ISIN,FOLIO_LENGHT,SEC_STATUS_NRM,ELIGIBILITY_NRM,
SEC_STATUS_ODDLOT,ELIGIBILITY_ODDLOT,SEC_STATUS_SPOT,ELIGIBILITY_SPOT,
SEC_STATUS_AUCTION,ELIGIBILITY_AUCTION,AMCCODE,CATEGORYCODE,SEC_NAME,
ISSUE_RATE,MINSUBSCRADDL,BUYNAVPRICE,SELLNAVPRICE,RTAGENTCODE,VALDECINDICATOR,
CATSTARTTIME,QTYDECINDICATOR,CATENDTIME,MINSUBSCRFRESH,VALUE_LIMIT,
RECORD_DATE=0,EX_DATE=0,NAVDATE=0,NO_DELIVERY_END_DATE=0,ST_ELIGIBLE_IDX,ST_ELIGIBLE_AON,ST_ELIGIBLE_MIN_FILL,
SECDEPMANDATORY,SEC_DIVIDEND,SECALLOWDEP,SECALLOWSELL,SECMODCXL,SECALLOWBUY,BOOK_CL_START_DT=0,
BOOK_CL_END_DT=0,DIVIDEND,RIGHTS,BONUS,INTEREST,AGM,EGM,OTHER,LOCAL_DTTIME=0,DELETEFLAG,REMARK
INTO #MFSS_SCRIP_MASTER_TMP FROM MFSS_SCRIP_MASTER_TMP
WHERE 1 = 2 

SET @SQL = 'BULK INSERT #MFSS_SCRIP_MASTER_TMP FROM ''' + @FilePath + ''' WITH  ( FIELDTERMINATOR = ''|'', ROWTERMINATOR = '''+ @ROWTERMINATOR +''', FirstRow = 2 )'
EXEC (@SQL)

INSERT INTO MFSS_SCRIP_MASTER_TMP
SELECT TOKEN,SCRIP_CD,SERIES,INTRUMENTTYPE,QUANTITY_LIMIT,RTSCHEMECODE,
AMCSCHEMECODE,ISIN,FOLIO_LENGHT,SEC_STATUS_NRM,ELIGIBILITY_NRM,
SEC_STATUS_ODDLOT,ELIGIBILITY_ODDLOT,SEC_STATUS_SPOT,ELIGIBILITY_SPOT,
SEC_STATUS_AUCTION,ELIGIBILITY_AUCTION,AMCCODE,CATEGORYCODE,SEC_NAME,
ISSUE_RATE,MINSUBSCRADDL,BUYNAVPRICE,SELLNAVPRICE,RTAGENTCODE,VALDECINDICATOR,
CATSTARTTIME,QTYDECINDICATOR,CATENDTIME,MINSUBSCRFRESH,VALUE_LIMIT,
RECORD_DATE=DATEADD(SS, RECORD_DATE, CONVERT(DATETIME,'JAN  1 1980')),
EX_DATE=DATEADD(SS, EX_DATE, CONVERT(DATETIME,'JAN  1 1980')),
NAVDATE=DATEADD(SS, NAVDATE, CONVERT(DATETIME,'JAN  1 1980')),
NO_DELIVERY_END_DATE=DATEADD(SS, NO_DELIVERY_END_DATE, CONVERT(DATETIME,'JAN  1 1980')),
ST_ELIGIBLE_IDX,ST_ELIGIBLE_AON,ST_ELIGIBLE_MIN_FILL,
SECDEPMANDATORY,SEC_DIVIDEND,SECALLOWDEP,SECALLOWSELL,SECMODCXL,SECALLOWBUY,
BOOK_CL_START_DT=DATEADD(SS, BOOK_CL_START_DT, CONVERT(DATETIME,'JAN  1 1980')),
BOOK_CL_END_DT=DATEADD(SS, BOOK_CL_END_DT, CONVERT(DATETIME,'JAN  1 1980')),
DIVIDEND,RIGHTS,BONUS,INTEREST,AGM,EGM,OTHER,LOCAL_DTTIME=0,DELETEFLAG,REMARK
FROM #MFSS_SCRIP_MASTER_TMP

DELETE FROM MFSS_SCRIP_MASTER WHERE SCRIP_CD IN ( SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER_TMP 
WHERE MFSS_SCRIP_MASTER.SCRIP_CD = MFSS_SCRIP_MASTER_TMP.SCRIP_CD 
AND MFSS_SCRIP_MASTER.SERIES = MFSS_SCRIP_MASTER_TMP.SERIES) 

INSERT INTO MFSS_SCRIP_MASTER 
SELECT * FROM MFSS_SCRIP_MASTER_TMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_UpdMFSSSB
-- --------------------------------------------------
CREATE Procedure [dbo].[Prc_UpdMFSSSB]    
As    
Begin    
    
update m    
set m.SUB_BROKER=convert(varchar(10),cd.sub_broker)    
from mfss_client m inner join [AngelNseCM].MSAJAG.dbo.client_details cd with(nolock)    
on convert(varchar(10),m.party_code)=cd.party_code    
where m.sub_broker<>cd.sub_broker    
and isnull(cd.sub_broker,'')<>''    
    
    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_UpdMFSSSB_01feb2022
-- --------------------------------------------------
CREATE Procedure [dbo].[Prc_UpdMFSSSB_01feb2022]  
As  
Begin  
  
update m  
set m.SUB_BROKER=convert(varchar(10),cd.sub_broker)  
from mfss_client m inner join [196.1.115.132].risk.dbo.client_details cd with(nolock)  
on convert(varchar(10),m.party_code)=cd.party_code  
where m.sub_broker<>cd.sub_broker  
and isnull(cd.sub_broker,'')<>''  
  
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_acc_GetCompanyName_FA
-- --------------------------------------------------
create PROCEDURE proc_acc_GetCompanyName_FA      
 @AccoundDBName VarChar (50)      
AS      
      
SELECT * FROM      
 pradnya.dbo.multicompany      
      
WHERE      
 sharedb = @AccoundDBName AND      
 primaryserver = 1      
      
ORDER BY      
 companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_BSEMFSS_TRADEIMPORT
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_BSEMFSS_TRADEIMPORT]             
(            
 @SNO   NUMERIC(18,0),            
 @SUBPROCESSID INT,            
 @FILETYPE  VARCHAR(20),            
 @SAUDA_DATE  VARCHAR(11),            
 @FILEPATH  VARCHAR(200)            
)            
AS            
-- EXEC PROC_NSE_TRADEIMPORT 7,0,'NOTIS','Nov  3 2014','c:\temp\20141103\03112014_09900.txt'            
DECLARE @SQL  VARCHAR(MAX),            
  @TRADEQTY NUMERIC(18,0),            
  @CONFIRMQTY NUMERIC(18,0),            
  @TRADEAMT NUMERIC(18,4),            
  @CONFIRMAMT NUMERIC(18,4),            
  @RECCNT  NUMERIC(18,0),          
  @PREVDATE VARCHAR(11)            
            
SELECT @PREVDATE = MAX(START_DATE) FROM SETT_MST WHERE SETT_TYPE = 'N' AND START_dATE < @SAUDA_DATE          
            
IF @SUBPROCESSID = 0             
BEGIN            
 TRUNCATE TABLE MFSS_ORDER_TMP         
 TRUNCATE TABLE MFSS_TRADE            

EXEC BSEMFSS_FILEUPLOAD @SNO, @SAUDA_DATE, @FILEPATH, @FILETYPE, 'AUTO_PROCESS'
            
 IF @FILETYPE = 'ORDER_FILE'             
 BEGIN            
  BEGIN TRY            
	EXEC BSEMFSS_FILEUPLOAD @SNO, @SAUDA_DATE, @FILEPATH, @FILETYPE, 'AUTO_PROCESS'    
  END TRY            
  BEGIN CATCH            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 0,            
   PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = '',     
   PROCESS_STATUS_ALERT_COUNT = 0            
   WHERE SNO = @SNO AND PROCESS_STATUS = 99              
   RETURN            
  END CATCH            
         
 END            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM MFSS_ORDER_TMP WHERE LEFT(ORDER_DATE,11) <> @SAUDA_DATE) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET             
  PROCESS_HALTED_REASON = 'SELECTED FILE IS HAVING SOME OTHER DATE DATA THAN THE BUSINESS DATE.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),     
   PROCESS_STATUS_ALERT_COUNT = 0                     
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
   --TRUNCATE TABLE MFSS_TRADE            
   --TRUNCATE TABLE MFSS_ORDER_TMP	              
  RETURN            
 END            
 ELSE            
 BEGIN   
 print 'suresh'         
   EXEC BSEMFSS_DUPRECCHECK @SAUDA_DATE         
	           
   INSERT INTO STAT_TRD VALUES ('I10', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
   SET @SUBPROCESSID = 1            
 END            
END            
            
IF @SUBPROCESSID = 1 OR @SUBPROCESSID = 0            
BEGIN            
             
 EXEC BSEMFSS_DUPRECSETTCHECK @SAUDA_DATE       
            
 INSERT INTO STAT_TRD VALUES ('I20', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
            
 if (Select isnull(count(1),0) from MFSS_TRADE ) <= 0
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 1,            
  PROCESS_HALTED_REASON = 'ALL TRADES ARE DELETED BECAUSE OF DUPLICATION.',            
  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT_INTERVAL = '00:00:00',     
   PROCESS_STATUS_ALERT_COUNT = 0                    
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  DELETE FROM STAT_TRD WHERE Filedate = @SAUDA_DATE            
            
  RETURN            
 END            
 SET @SUBPROCESSID = 2            
END            
            
IF @SUBPROCESSID = 2 OR @SUBPROCESSID = 0            
BEGIN            
 UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 2            
 WHERE SNO = @SNO AND PROCESS_STATUS = 99            

 INSERT INTO STAT_TRD VALUES ('I21', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
 SET @SUBPROCESSID = 3            
            
END            
            
IF @SUBPROCESSID = 3 OR @SUBPROCESSID = 0            
BEGIN            
 SET @SUBPROCESSID = 4  
END           
            
IF @SUBPROCESSID = 4 OR @SUBPROCESSID = 0            
BEGIN            
 -- FOR SKIPPING OF TRADE IN CASE OF MISSING CLIENT AND SCRIP            
 SET @SUBPROCESSID = 5            
END            
            
IF @SUBPROCESSID = 5 OR @SUBPROCESSID = 0            
BEGIN            
 INSERT INTO STAT_TRD VALUES ('I40', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
            
 EXEC PROC_MFSS_ClientMaster            
            
 IF (Select isnull(count(1),0) from MFSS_Client WHERE InActive_From <= GetDate() And Party_Code in (Select Party_Code From MFSS_TRADE )) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'TRADES CONTAINS THE INACTIVE CLIENT DATA, PLEASE CORRECT.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = 'Select Party_code from MFSS_Client WHERE InActive_From <= GetDate() And Party_Code in (Select Party_Code From MFSS_TRADE ) ',     
   PROCESS_STATUS_ALERT_COUNT = 0                    
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM MFSS_TRADE WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MFSS_Client)) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'TRADES CONTAINS THE MISSING CLIENT DATA, PLEASE CORRECT.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = 'SELECT DISTINCT PARTY_CODE, TERMINAL = USER_ID FROM MFSS_TRADE WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MFSS_Client) ',     
   PROCESS_STATUS_ALERT_COUNT = 0            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM MFSS_TRADE WHERE  NOT EXISTS (SELECT SCRIP_CD    
                     FROM   MFSS_SCRIP_MASTER M  
                     WHERE  MFSS_TRADE.SCRIP_CD = M.SCRIP_CD )) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'TRADES CONTAINS THE MISSING SCRIP DATA, PLEASE CORRECT.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = 'SELECT DISTINCT SCRIP_CD, SCHEME_NAME FROM MFSS_TRADE WHERE  NOT EXISTS (SELECT SCRIP_CD FROM MFSS_SCRIP_MASTER M WHERE  MFSS_TRADE.SCRIP_CD = M.SCRIP_CD ) ' ,     
  PROCESS_STATUS_ALERT_COUNT = 0                   
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 SELECT @TRADEAMT = ISNULL(SUM(AMOUNT),0)            
 FROM MFSS_TRADE            
            
 SELECT @CONFIRMAMT = ISNULL(SUM(AMOUNT),0)            
 FROM MFSS_confirmview            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM MFSS_TRADE)  = 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'NO DATA PRESENT IN THE TRADE.',            
  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),     
   PROCESS_STATUS_ALERT_COUNT = 0                    
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 IF (@TRADEAMT - @CONFIRMAMT) <> 0
 BEGIN            
  IF @TRADEAMT > @CONFIRMAMT
  BEGIN            
   IF @CONFIRMAMT = 0            
   BEGIN            
    UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
    PROCESS_HALTED_REASON = 'SEEMS TO BE ISSUE IN SETTLEMENT MASTER.',            
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),     
    PROCESS_STATUS_ALERT_COUNT = 0                    
    WHERE SNO = @SNO AND PROCESS_STATUS = 99
   END          
   ELSE            
   BEGIN                
    UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
    PROCESS_HALTED_REASON = 'SOME OF PARTY ARE HAVING PROBLEM IN THE MASTER.',            
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
    PROCESS_OUTPUT_QUERY = 'SELECT PARTY_CODE, SCRIP_CD, SCHEME_NAME, ORDER_NO, QTY FROM MFSS_TRADE T            
    WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MFSS_confirmview C            
    WHERE T.PARTY_CODE = C.PARTY_CODE AND T.SCRIP_CD = C.SCRIP_CD            
    AND T.ORDER_NO = C.ORDER_NO)',     
    PROCESS_STATUS_ALERT_COUNT = 0                    
    WHERE SNO = @SNO AND PROCESS_STATUS = 99
   END            
  END            
  ELSE            
  BEGIN            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
   PROCESS_HALTED_REASON = 'SOME OF PARTY ARE HAVING PROBLEM IN THE MASTER. DUPLICATE DATA IS COMING FROM THE CONFIRMATION.',            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = 'SELECT PARTY_CODE, SCRIP_CD, SCHEME_NAME, ORDER_NO FROM MFSS_confirmview C            
   GROUP BY PARTY_CODE, SCRIP_CD, SCHEME_NAME, ORDER_NO            
   HAVING COUNT(1) > 1',     
   PROCESS_STATUS_ALERT_COUNT = 0                    
   WHERE SNO = @SNO AND PROCESS_STATUS = 99            
  END            
  RETURN            
 END            
 ELSE            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 6            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  INSERT INTO STAT_TRD VALUES ('I70', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
              
  SET @SUBPROCESSID = 6            
 END            
END            
            
IF @SUBPROCESSID = 6 OR @SUBPROCESSID = 0            
BEGIN            
 EXEC Proc_mfss_ClientMaster            
             
 UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7            
 WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
 INSERT INTO STAT_TRD VALUES ('I80', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
 SET @SUBPROCESSID = 7            
END            
            
IF @SUBPROCESSID = 7 OR @SUBPROCESSID = 0            
BEGIN            
 IF (SELECT ISNULL(COUNT(1),0) FROM MFSS_TRADE)  = 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
  PROCESS_HALTED_REASON = 'NO DATA PRESENT IN THE TRADE.',            
  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),     
   PROCESS_STATUS_ALERT_COUNT = 0                    
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 IF (Select IsNull(Count(*),0) From ContGen, MFSS_TRADE Where Order_Date >= Start_Date and Order_Date <= End_Date) <= 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
  PROCESS_HALTED_REASON = 'Please Enter The Contract No in the Table for the Current Year.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = '',     
   PROCESS_STATUS_ALERT_COUNT = 0                    
  WHERE SNO = @SNO AND PROCESS_STATUS = 99                     
  RETURN            
 END            
 BEGIN TRAN            
  SELECT @TRADEAMT = 0            
  SELECT @TRADEAMT = ISNULL(SUM(AMOUNT),0), @RECCNT = ISNULL(COUNT(1),0) FROM MFSS_TRADE            
  SELECT @TRADEAMT = @TRADEAMT + ISNULL(SUM(AMOUNT),0) FROM MFSS_SETTLEMENT WHERE Order_Date LIKE @SAUDA_DATE + '%'      
             
  BEGIN TRY   
  print 'suresh1'         
   EXEC proc_mfss_ContractAllTrade @SAUDA_DATE            
  END TRY            
  BEGIN CATCH            
   ROLLBACK TRAN  
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
   PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = ''            
   WHERE SNO = @SNO AND PROCESS_STATUS = 99              
   RETURN            
  END CATCH            
  SELECT @CONFIRMAMT = 0            
  SELECT @CONFIRMAMT = @CONFIRMAMT + ISNULL(SUM(AMOUNT),0) FROM MFSS_SETTLEMENT WHERE Order_Date LIKE @SAUDA_DATE + '%'       
            
  IF @TRADEAMT <> @CONFIRMAMT             
  BEGIN            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
   PROCESS_HALTED_REASON = 'QTY BEFORE CONTRACT AND AFTER CONTRACT NOT MATCHING.',            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = '',     
   PROCESS_STATUS_ALERT_COUNT = 0                    
   WHERE SNO = @SNO AND PROCESS_STATUS = 99            
              
   RETURN            
  END            
            
  SET @SUBPROCESSID = 8            
 COMMIT             
            
 UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 8,            
 PROCESS_HALTED_REASON = 'TRADE IMPORTED SUCCESSFULLY WITH TOTAL NO OF RECORDS ' + CONVERT(VARCHAR,@RECCNT),            
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),            
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_INTERVAL = '00:00:00',     
   PROCESS_STATUS_ALERT_COUNT = 0                    
 WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
 INSERT INTO STAT_TRD VALUES ('I95', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
END            
            
IF @SUBPROCESSID = 8 OR @SUBPROCESSID = 0            
BEGIN            
 DELETE FROM STAT_TRD WHERE FILEDATE = @SAUDA_DATE            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CUSTOM_UPLOAD
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_CUSTOM_UPLOAD] 
(
	@TDATE VARCHAR(10), @FILEFOR VARCHAR(20), @FILETYPE VARCHAR(50), 
	@PROGID VARCHAR(50), @UNAME VARCHAR(50),@FILENAME VARCHAR(100) = ''
)
AS

DECLARE @RECCNT	INT

TRUNCATE TABLE IMPORT_PARTY_CODE

INSERT INTO IMPORT_PARTY_CODE
SELECT .DBO.PIECE(FILE_DATA,',',1) AS PARTY_CODE FROM FILEDATA WHERE PROGID = @PROGID

SELECT @RECCNT = ISNULL(COUNT(1),0) FROM IMPORT_PARTY_CODE

DELETE FROM FILEDATA WHERE PROGID = @PROGID

IF @RECCNT > 0 
BEGIN
	SELECT STRMSGCODE = 1, STRMSG = 'FILE UPLOADED SUCCESSFULLY WITH NO OF RECORD(S) ' + CONVERT(VARCHAR,@RECCNT)
END
ELSE
BEGIN
	SELECT STRMSGCODE = -1, STRMSG = 'PLEASE CHECK AND IMPORT CORRECT FILE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_ClientMaster
-- --------------------------------------------------
CREATE PROC PROC_MFSS_ClientMaster 
AS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_CONTRACTALLTRADE
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MFSS_CONTRACTALLTRADE] (@SAUDA_DATE VARCHAR(11))
AS

DECLARE @CNTNO VARCHAR(7)

SELECT @CNTNO = CONTRACTNO FROM CONTGEN
WHERE @SAUDA_DATE >= Start_Date and @SAUDA_DATE <= End_Date

SELECT DISTINCT SETT_NO, SETT_TYPE, PARTY_CODE, CONTRACTNO
INTO #CNTNO FROM MFSS_SETTLEMENT M
WHERE M.ORDER_DATE = @SAUDA_DATE

SELECT * INTO #CONF
FROM MFSS_CONFIRMVIEW

UPDATE #CONF SET CONTRACTNO = C.CONTRACTNO
FROM #CNTNO C
WHERE C.PARTY_CODE = #CONF.PARTY_CODE
AND C.SETT_NO = #CONF.SETT_NO
AND C.SETT_TYPE = #CONF.SETT_TYPE

SELECT DISTINCT SETT_NO, SETT_TYPE, PARTY_CODE, CONTRACTNO
INTO #CNTNO_1 FROM #CONF M
WHERE M.ORDER_DATE = @SAUDA_DATE
AND CONTRACTNO = '0'
ORDER BY SETT_NO, SETT_TYPE, PARTY_CODE

ALTER TABLE #CNTNO_1
ADD SNO Int IDENTITY (1, 1) NOT NULL 

UPDATE #CNTNO_1 SET CONTRACTNO = RIGHT('0000000' + CONVERT(VARCHAR,SNO + CONVERT(INT,@CNTNO)),7)

UPDATE #CONF SET CONTRACTNO = C.CONTRACTNO
FROM #CNTNO_1 C
WHERE C.PARTY_CODE = #CONF.PARTY_CODE
AND C.SETT_NO = #CONF.SETT_NO
AND C.SETT_TYPE = #CONF.SETT_TYPE

SELECT @CNTNO = MAX(CONVERT(INT,CONTRACTNO)) FROM #CONF

UPDATE CONTGEN SET CONTRACTNO = @CNTNO
WHERE @SAUDA_DATE >= Start_Date and @SAUDA_DATE <= End_Date

SELECT * FROM #CONF

INSERT INTO MFSS_SETTLEMENT
SELECT * FROM #CONF

TRUNCATE TABLE MFSS_TRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_DPMASTER
-- --------------------------------------------------

CREATE PROC PROC_MFSS_DPMASTER
(
	@Party_Code		VARCHAR(10),
	@DP_TYPE		VARCHAR(4),
	@DPID			VARCHAR(8),
	@CLTDPID		VARCHAR(16)
)

AS

	DELETE FROM MFSS_DPMASTER 
	WHERE PARTY_CODE = @Party_Code
	AND DP_TYPE = @DP_TYPE
	AND DPID = @DPID
	AND CLTDPID = @CLTDPID
	AND DEFAULTDP = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_FUNDS_OBL_CALC
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_MFSS_FUNDS_OBL_CALC]
(
	@TRADE_DATE VARCHAR(11)
)

AS
/*
	PROC_MFSS_FUNDS_OBL_CALC 'DEC  5 2009'
	
*/
DECLARE
		@SNO		NUMERIC(18,0), 
		@PARTY_CODE	VARCHAR(10), 
		@AMOUNT		NUMERIC(18, 4),
		@LEDCUR		CURSOR,
		@SDTCUR		DATETIME

SELECT @SDTCUR = SDTCUR FROM BBO_FA.dbo.PARAMETER WHERE @TRADE_DATE BETWEEN SDTCUR AND LDTCUR

CREATE TABLE #CLCODES
(
	CLTCODE VARCHAR(10),
	CL_BALANCE VARCHAR(1)
)
/*---------GETTING CLIENT MASTER SETTIING FOR BALANCE TYPE------------------------*/
INSERT INTO #CLCODES
	(CLTCODE, CL_BALANCE)
SELECT
	M.PARTY_CODE,
	CL_BALANCE = CASE WHEN M.CL_BALANCE <> 'E' THEN 'V' ELSE 'E' END
FROM
	MFSS_CLIENT M
WHERE
	EXISTS (SELECT PARTY_CODE FROM MFSS_FUNDS_OBLIGATION O 
			WHERE O.ORDER_DATE LIKE @TRADE_DATE + '%' AND M.PARTY_CODE = O.PARTY_CODE)
------------------------------------------------------------------------------------
CREATE TABLE #LEDBAL
(
	CLTCODE VARCHAR(10),
	BALAMT NUMERIC(18, 4)
)
/*---------------------CALCULATING BALANCE VOUCHER DATE WISE------------------------*/
INSERT INTO #LEDBAL (CLTCODE, BALAMT)
SELECT
	L.CLTCODE,
	BALAMT = SUM(L.CRAMOUNT-L.DRAMOUNT)
FROM
	BBO_FA.dbo.ACC_LEDGER_PL L,
	#CLCODES C
WHERE
	L.EXCHANGE = 'BSE'
	AND L.SEGMENT = 'MFSS'
	AND L.CLTCODE = C.CLTCODE
	AND C.CL_BALANCE = 'V'
	AND L.VDT >= @SDTCUR AND L.VDT < @TRADE_DATE
GROUP BY
	L.CLTCODE

INSERT INTO #LEDBAL (CLTCODE, BALAMT)
SELECT
	L.CLTCODE,
	BALAMT = SUM(L.CRAMOUNT-L.DRAMOUNT)
FROM
	BBO_FA.dbo.ACC_LEDGER_PL L,
	#CLCODES C
WHERE
	L.EXCHANGE = 'BSE'
	AND L.SEGMENT = 'MFSS'
	AND L.CLTCODE = C.CLTCODE
	AND C.CL_BALANCE = 'V'
	AND L.VDT >= @TRADE_DATE AND L.VDT <= @TRADE_DATE + ' 23:59:59'
	AND L.VTYPE <> 15
GROUP BY
	L.CLTCODE

-------------------------------------------------------------------------------------
/*---------------------CALCULATING BALANCE EFFECTIVE DATE WISE------------------------*/

INSERT INTO #LEDBAL (CLTCODE, BALAMT)
SELECT
	CLTCODE,
	BALAMT = SUM(BALAMT)
FROM
	(
	SELECT
		L.CLTCODE,
		BALAMT = SUM(L.CRAMOUNT-L.DRAMOUNT)
	FROM
		BBO_FA.dbo.ACC_LEDGER_PL L,
		#CLCODES C
	WHERE
		L.EXCHANGE = 'BSE'
		AND L.SEGMENT = 'MFSS'
		AND L.CLTCODE = C.CLTCODE
		AND C.CL_BALANCE = 'E'
		AND L.EDT BETWEEN CONVERT(VARCHAR(11), @SDTCUR, 109) AND @TRADE_DATE + ' 23:59'
	GROUP BY
		L.CLTCODE
	UNION ALL
	SELECT
		L.CLTCODE,
		BALAMT = SUM(L.DRAMOUNT-L.CRAMOUNT)
	FROM
		BBO_FA.dbo.ACC_LEDGER_PL L,
		#CLCODES C
	WHERE
		L.EXCHANGE = 'BSE'
		AND L.SEGMENT = 'MFSS'
		AND L.CLTCODE = C.CLTCODE
		AND C.CL_BALANCE = 'E'
		AND L.EDT >= CONVERT(VARCHAR(11), @SDTCUR, 109)
		AND L.VDT < @SDTCUR
	GROUP BY
		L.CLTCODE
	) A
GROUP BY
	CLTCODE
	
----select * from	#LEDBAL
----return
	
--------------------------OLD CODE----------------------------------
--SELECT CLTCODE, BALAMT = SUM(CRAMOUNT-DRAMOUNT)
--INTO #LEDBAL 
--FROM BBO_FA.DBO.ACC_LEDGER_PL
--WHERE EXCHANGE = 'BSE' AND SEGMENT = 'MFSS'
--AND EDT <= @TRADE_DATE + ' 23:59:59'
--AND @TRADE_DATE BETWEEN LDTCUR AND SDTCUR
--AND CLTCODE IN (SELECT PARTY_CODE FROM MFSS_FUNDS_OBLIGATION
--				WHERE ORDER_DATE = @TRADE_DATE + ' 23:59:59')
--GROUP BY CLTCODE

SET @LEDCUR = CURSOR FOR
SELECT SNO, PARTY_CODE, AMOUNT FROM MFSS_FUNDS_OBLIGATION
WHERE ORDER_DATE = @TRADE_DATE + ' 23:59:59'
ORDER BY SNO
OPEN @LEDCUR
FETCH NEXT FROM @LEDCUR INTO @SNO, @PARTY_CODE, @AMOUNT
WHILE @@FETCH_STATUS = 0
BEGIN
	UPDATE MFSS_FUNDS_OBLIGATION SET AVAIL_AMOUNT = BALAMT
	FROM #LEDBAL
	WHERE SNO = @SNO
	AND upper(CLTCODE) = upper(PARTY_CODE)

  
	UPDATE #LEDBAL SET BALAMT = (CASE WHEN @AMOUNT > BALAMT THEN 0 ELSE BALAMT - @AMOUNT END)
	WHERE CLTCODE = @PARTY_CODE
	--UPDATE #LEDBAL SET BALAMT = (CASE WHEN @AMOUNT > BALAMT THEN BALAMT ELSE BALAMT - @AMOUNT END)
	--WHERE CLTCODE = @PARTY_CODE

	FETCH NEXT FROM @LEDCUR INTO @SNO, @PARTY_CODE, @AMOUNT
END
CLOSE @LEDCUR
DEALLOCATE @LEDCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_FUNDS_OBL_CALC_bak
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MFSS_FUNDS_OBL_CALC_bak]  
(  
 @TRADE_DATE VARCHAR(11)  
)  
  
AS  
/*  
 PROC_MFSS_FUNDS_OBL_CALC 'DEC  5 2009'  
   
*/  
DECLARE  
  @SNO  NUMERIC(18,0),   
  @PARTY_CODE VARCHAR(10),   
  @AMOUNT  NUMERIC(18, 4),  
  @LEDCUR  CURSOR,  
  @SDTCUR  DATETIME  
  
SELECT @SDTCUR = SDTCUR FROM BBO_FA.dbo.PARAMETER WHERE @TRADE_DATE BETWEEN SDTCUR AND LDTCUR  
  
CREATE TABLE #CLCODES  
(  
 CLTCODE VARCHAR(10),  
 CL_BALANCE VARCHAR(1)  
)  
/*---------GETTING CLIENT MASTER SETTIING FOR BALANCE TYPE------------------------*/  
INSERT INTO #CLCODES  
 (CLTCODE, CL_BALANCE)  
SELECT  
 M.PARTY_CODE,  
 CL_BALANCE = CASE WHEN M.CL_BALANCE <> 'E' THEN 'V' ELSE 'E' END  
FROM  
 MFSS_CLIENT M  
WHERE  
 EXISTS (SELECT PARTY_CODE FROM MFSS_FUNDS_OBLIGATION O WHERE O.ORDER_DATE LIKE @TRADE_DATE + '%' AND M.PARTY_CODE = O.PARTY_CODE)  
------------------------------------------------------------------------------------  
CREATE TABLE #LEDBAL  
(  
 CLTCODE VARCHAR(10),  
 BALAMT NUMERIC(18, 4)  
)  
/*---------------------CALCULATING BALANCE VOUCHER DATE WISE------------------------*/  
INSERT INTO #LEDBAL (CLTCODE, BALAMT)  
SELECT  
 L.CLTCODE,  
 BALAMT = SUM(L.CRAMOUNT-L.DRAMOUNT)  
FROM  
 BBO_FA.dbo.ACC_LEDGER_PL L,  
 #CLCODES C  
WHERE  
 L.EXCHANGE = 'NSE'  
 AND L.SEGMENT = 'MFSS'  
 AND L.CLTCODE = C.CLTCODE  
 AND C.CL_BALANCE = 'V'  
 AND L.VDT BETWEEN @SDTCUR AND @TRADE_DATE + ' 23:59'  
GROUP BY  
 L.CLTCODE  
-------------------------------------------------------------------------------------  
/*---------------------CALCULATING BALANCE EFFECTIVE DATE WISE------------------------*/  
  
INSERT INTO #LEDBAL (CLTCODE, BALAMT)  
SELECT  
 CLTCODE,  
 BALAMT = SUM(BALAMT)  
FROM  
 (  
 SELECT  
  L.CLTCODE,  
  BALAMT = SUM(L.CRAMOUNT-L.DRAMOUNT)  
 FROM  
  BBO_FA.dbo.ACC_LEDGER_PL L,  
  #CLCODES C  
 WHERE  
  L.EXCHANGE = 'NSE'  
  AND L.SEGMENT = 'MFSS'  
  AND L.CLTCODE = C.CLTCODE  
  AND C.CL_BALANCE = 'E'  
  AND L.EDT BETWEEN CONVERT(VARCHAR(11), @SDTCUR, 109) AND @TRADE_DATE + ' 23:59'  
 GROUP BY  
  L.CLTCODE  
 UNION ALL  
 SELECT  
  L.CLTCODE,  
  BALAMT = SUM(L.DRAMOUNT-L.CRAMOUNT)  
 FROM  
  BBO_FA.dbo.ACC_LEDGER_PL L,  
  #CLCODES C  
 WHERE  
  L.EXCHANGE = 'NSE'  
  AND L.SEGMENT = 'MFSS'  
  AND L.CLTCODE = C.CLTCODE  
  AND C.CL_BALANCE = 'E'  
  AND L.EDT >= CONVERT(VARCHAR(11), @SDTCUR, 109)  
  AND L.VDT < @SDTCUR  
 GROUP BY  
  L.CLTCODE  
 ) A  
GROUP BY  
 CLTCODE  
--------------------------OLD CODE----------------------------------  
--SELECT CLTCODE, BALAMT = SUM(CRAMOUNT-DRAMOUNT)  
--INTO #LEDBAL   
--FROM BBO_FA.DBO.ACC_LEDGER_PL  
--WHERE EXCHANGE = 'NSE' AND SEGMENT = 'MFSS'  
--AND EDT <= @TRADE_DATE + ' 23:59:59'  
--AND @TRADE_DATE BETWEEN LDTCUR AND SDTCUR  
--AND CLTCODE IN (SELECT PARTY_CODE FROM MFSS_FUNDS_OBLIGATION  
--    WHERE ORDER_DATE = @TRADE_DATE + ' 23:59:59')  
--GROUP BY CLTCODE  
  
SET @LEDCUR = CURSOR FOR  
SELECT SNO, PARTY_CODE, AMOUNT FROM MFSS_FUNDS_OBLIGATION  
WHERE ORDER_DATE = @TRADE_DATE + ' 23:59:59'  
ORDER BY SNO  
OPEN @LEDCUR  
FETCH NEXT FROM @LEDCUR INTO @SNO, @PARTY_CODE, @AMOUNT  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 UPDATE MFSS_FUNDS_OBLIGATION SET AVAIL_AMOUNT = BALAMT  
 FROM #LEDBAL  
 WHERE SNO = @SNO  
 AND CLTCODE = PARTY_CODE  
  
 UPDATE #LEDBAL SET BALAMT = (CASE WHEN @AMOUNT > BALAMT THEN 0 ELSE BALAMT - @AMOUNT END)  
 WHERE CLTCODE = @PARTY_CODE  
  
 FETCH NEXT FROM @LEDCUR INTO @SNO, @PARTY_CODE, @AMOUNT  
END  
CLOSE @LEDCUR  
DEALLOCATE @LEDCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_MISSINGSCRIP
-- --------------------------------------------------
CREATE PROC PROC_MFSS_MISSINGSCRIP AS        
SET NOCOUNT ON       
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
      
CREATE TABLE #MFSS_TRADE  
(    
 SCRIP_CD VARCHAR (20)
)    
    
INSERT INTO #MFSS_TRADE   
  SELECT     
 DISTINCT SCRIP_CD  
  FROM   MFSS_TRADE (NOLOCK)    
    
SELECT * FROM #MFSS_TRADE MFSS_TRADE    
  WHERE  NOT EXISTS (SELECT SCRIP_CD    
                     FROM   MFSS_SCRIP_MASTER M  
                     WHERE  MFSS_TRADE.SCRIP_CD = M.SCRIP_CD )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_STATUS_UPDATE
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MFSS_STATUS_UPDATE]        
        
AS        
        
DELETE FROM MFSS_ORDER_STATUS  
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG L  
WHERE L.SETT_NO = MFSS_ORDER_STATUS.SETT_NO   
AND L.SETT_TYPE = MFSS_ORDER_STATUS.SETT_TYPE  
AND L.ORDER_NO = MFSS_ORDER_STATUS.ORDER_NO
AND L.PARTY_CODE = MFSS_ORDER_STATUS.PARTY_CODE)  
  
INSERT INTO MFSS_ORDER_STATUS  
SELECT * FROM MFSS_ORDER_STATUS_LOG  

UPDATE MFSS_ORDER SET NAV_VALUE_ALLOTED = M.NAV_VALUE_ALLOTED,         
QTY_ALLOTED = M.QTY_ALLOTED,         
AMOUNT_ALLOTED = M.AMOUNT_ALLOTED,      
FOLIONO = M.FOLIONO    
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD  
AND M.PARTY_CODE = MFSS_ORDER.PARTY_CODE    
AND M.RECFLAG IN ('Y', 'V')      
      
UPDATE MFSS_SETTLEMENT SET 
QTY = (CASE WHEN M.QTY_ALLOTED <> 0 
			THEN M.QTY_ALLOTED 
			ELSE MFSS_SETTLEMENT.QTY 
	   END),         
AMOUNT = (CASE WHEN M.AMOUNT_ALLOTED <> 0 
			   THEN M.AMOUNT_ALLOTED 
			   ELSE MFSS_SETTLEMENT.AMOUNT 
		  END), 
--BROKER_CHRG = (CASE WHEN MFSS_SETTLEMENT.ORDER_DATE <='AUG 22 2021' THEN ISNULL(ALT_STAMP_DUTY,0) ELSE 0 END),    
BROKER_CHRG = ISNULL(ALT_STAMP_DUTY,0),
FOLIONO = M.FOLIONO       
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD        
AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE
AND M.RECFLAG IN ('Y', 'V')    


/*
UPDATE MFSS_ORDER SET CONF_FLAG = 'N', REJECT_REASON = M.REMARK        
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD        
AND M.RECFLAG NOT IN ('Y', 'V')    
      
INSERT INTO MFSS_SETTLEMENT_DELETED      
SELECT * FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )       
      
DELETE FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_STATUS_UPDATE_bak_02112018
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_MFSS_STATUS_UPDATE_bak_02112018]        
        
AS        
        
DELETE FROM MFSS_ORDER_STATUS  
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG L  
       WHERE L.SETT_NO = MFSS_ORDER_STATUS.SETT_NO   
       AND L.SETT_TYPE = MFSS_ORDER_STATUS.SETT_TYPE  
       AND L.ORDER_NO = MFSS_ORDER_STATUS.ORDER_NO
       AND L.PARTY_CODE = MFSS_ORDER_STATUS.PARTY_CODE)  
  
INSERT INTO MFSS_ORDER_STATUS  
SELECT * FROM MFSS_ORDER_STATUS_LOG  

UPDATE MFSS_ORDER SET NAV_VALUE_ALLOTED = M.NAV_VALUE_ALLOTED,         
    QTY_ALLOTED = M.QTY_ALLOTED,         
    AMOUNT_ALLOTED = M.AMOUNT_ALLOTED,      
 FOLIONO = M.FOLIONO    
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD  
AND M.PARTY_CODE = MFSS_ORDER.PARTY_CODE    
AND M.RECFLAG IN ('Y', 'V')      
      
UPDATE MFSS_SETTLEMENT SET QTY = (CASE WHEN MFSS_SETTLEMENT.QTY = 0 THEN M.QTY_ALLOTED ELSE MFSS_SETTLEMENT.QTY END),         
    AMOUNT = (CASE WHEN MFSS_SETTLEMENT.AMOUNT = 0 THEN M.AMOUNT_ALLOTED ELSE MFSS_SETTLEMENT.AMOUNT END),      
 FOLIONO = M.FOLIONO/*,     
 INS_CHRG = ISNULL(STT,0)*/       
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD        
AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE
AND M.RECFLAG IN ('Y', 'V')    

/*
UPDATE MFSS_ORDER SET CONF_FLAG = 'N', REJECT_REASON = M.REMARK        
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD        
AND M.RECFLAG NOT IN ('Y', 'V')    
      
INSERT INTO MFSS_SETTLEMENT_DELETED      
SELECT * FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )       
      
DELETE FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_STATUS_UPDATE_BKUP_02NOV2018
-- --------------------------------------------------


Create PROC [dbo].[PROC_MFSS_STATUS_UPDATE_BKUP_02NOV2018]        
        
AS        
        
DELETE FROM MFSS_ORDER_STATUS  
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG L  
       WHERE L.SETT_NO = MFSS_ORDER_STATUS.SETT_NO   
       AND L.SETT_TYPE = MFSS_ORDER_STATUS.SETT_TYPE  
       AND L.ORDER_NO = MFSS_ORDER_STATUS.ORDER_NO
       AND L.PARTY_CODE = MFSS_ORDER_STATUS.PARTY_CODE)  
  
INSERT INTO MFSS_ORDER_STATUS  
SELECT * FROM MFSS_ORDER_STATUS_LOG  

UPDATE MFSS_ORDER SET NAV_VALUE_ALLOTED = M.NAV_VALUE_ALLOTED,         
    QTY_ALLOTED = M.QTY_ALLOTED,         
    AMOUNT_ALLOTED = M.AMOUNT_ALLOTED,      
 FOLIONO = M.FOLIONO    
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD  
AND M.PARTY_CODE = MFSS_ORDER.PARTY_CODE    
AND M.RECFLAG IN ('Y', 'V')      
      
UPDATE MFSS_SETTLEMENT SET QTY = (CASE WHEN M.QTY_ALLOTED <> 0 THEN M.QTY_ALLOTED ELSE MFSS_SETTLEMENT.QTY END),         
    AMOUNT = (CASE WHEN M.AMOUNT_ALLOTED <> 0 THEN M.AMOUNT_ALLOTED ELSE MFSS_SETTLEMENT.AMOUNT END),     
 FOLIONO = M.FOLIONO/*,     
 INS_CHRG = ISNULL(STT,0)*/       
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD        
AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE
AND M.RECFLAG IN ('Y', 'V')    

/*
UPDATE MFSS_ORDER SET CONF_FLAG = 'N', REJECT_REASON = M.REMARK        
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD        
AND M.RECFLAG NOT IN ('Y', 'V')    
      
INSERT INTO MFSS_SETTLEMENT_DELETED      
SELECT * FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )       
      
DELETE FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_STATUS_UPDATE_BKUP_24MAR2021
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MFSS_STATUS_UPDATE_BKUP_24MAR2021]        
        
AS        
        
DELETE FROM MFSS_ORDER_STATUS  
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG L  
WHERE L.SETT_NO = MFSS_ORDER_STATUS.SETT_NO   
AND L.SETT_TYPE = MFSS_ORDER_STATUS.SETT_TYPE  
AND L.ORDER_NO = MFSS_ORDER_STATUS.ORDER_NO
AND L.PARTY_CODE = MFSS_ORDER_STATUS.PARTY_CODE)  
  
INSERT INTO MFSS_ORDER_STATUS  
SELECT * FROM MFSS_ORDER_STATUS_LOG  

UPDATE MFSS_ORDER SET NAV_VALUE_ALLOTED = M.NAV_VALUE_ALLOTED,         
QTY_ALLOTED = M.QTY_ALLOTED,         
AMOUNT_ALLOTED = M.AMOUNT_ALLOTED,      
FOLIONO = M.FOLIONO    
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD  
AND M.PARTY_CODE = MFSS_ORDER.PARTY_CODE    
AND M.RECFLAG IN ('Y', 'V')      
      
UPDATE MFSS_SETTLEMENT SET 
QTY = (CASE WHEN M.QTY_ALLOTED <> 0 
			THEN M.QTY_ALLOTED 
			ELSE MFSS_SETTLEMENT.QTY 
	   END),         
AMOUNT = (CASE WHEN M.AMOUNT_ALLOTED <> 0 
			   THEN M.AMOUNT_ALLOTED 
			   ELSE MFSS_SETTLEMENT.AMOUNT 
		  END), 
BROKER_CHRG = ISNULL(ALT_STAMP_DUTY,0),    
FOLIONO = M.FOLIONO       
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD        
AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE
AND M.RECFLAG IN ('Y', 'V')    

/*
UPDATE MFSS_ORDER SET CONF_FLAG = 'N', REJECT_REASON = M.REMARK        
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD        
AND M.RECFLAG NOT IN ('Y', 'V')    
      
INSERT INTO MFSS_SETTLEMENT_DELETED      
SELECT * FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )       
      
DELETE FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_STATUS_UPDATE_BKUP_28JUL20
-- --------------------------------------------------



CREATE PROC [dbo].[PROC_MFSS_STATUS_UPDATE_BKUP_28JUL20]        
        
AS        
        
DELETE FROM MFSS_ORDER_STATUS  
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG L  
       WHERE L.SETT_NO = MFSS_ORDER_STATUS.SETT_NO   
       AND L.SETT_TYPE = MFSS_ORDER_STATUS.SETT_TYPE  
       AND L.ORDER_NO = MFSS_ORDER_STATUS.ORDER_NO
       AND L.PARTY_CODE = MFSS_ORDER_STATUS.PARTY_CODE)  
  
INSERT INTO MFSS_ORDER_STATUS  
SELECT * FROM MFSS_ORDER_STATUS_LOG  

UPDATE MFSS_ORDER SET NAV_VALUE_ALLOTED = M.NAV_VALUE_ALLOTED,         
    QTY_ALLOTED = M.QTY_ALLOTED,         
    AMOUNT_ALLOTED = M.AMOUNT_ALLOTED,      
 FOLIONO = M.FOLIONO    
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD  
AND M.PARTY_CODE = MFSS_ORDER.PARTY_CODE    
AND M.RECFLAG IN ('Y', 'V')      
      
UPDATE MFSS_SETTLEMENT SET QTY = (CASE WHEN M.QTY_ALLOTED <> 0 THEN M.QTY_ALLOTED ELSE MFSS_SETTLEMENT.QTY END),         
    AMOUNT = (CASE WHEN M.AMOUNT_ALLOTED <> 0 THEN M.AMOUNT_ALLOTED ELSE MFSS_SETTLEMENT.AMOUNT END),     
 FOLIONO = M.FOLIONO/*,     
 INS_CHRG = ISNULL(STT,0)*/       
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD        
AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE
AND M.RECFLAG IN ('Y', 'V')    

/*
UPDATE MFSS_ORDER SET CONF_FLAG = 'N', REJECT_REASON = M.REMARK        
FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_ORDER.SETT_NO      
AND M.SETT_TYPE = MFSS_ORDER.SETTLEMENT_TYPE      
--AND M.ORDER_DATE = MFSS_ORDER.ORDER_DATE        
AND M.ORDER_NO = MFSS_ORDER.ORDER_NO        
AND M.SCRIP_CD = MFSS_ORDER.SCRIP_CD        
AND M.RECFLAG NOT IN ('Y', 'V')    
      
INSERT INTO MFSS_SETTLEMENT_DELETED      
SELECT * FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )       
      
DELETE FROM MFSS_SETTLEMENT        
WHERE ORDER_NO IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS_LOG M        
WHERE M.SETT_NO = MFSS_SETTLEMENT.SETT_NO      
AND M.SETT_TYPE = MFSS_SETTLEMENT.SETT_TYPE      
--AND M.ORDER_DATE = MFSS_SETTLEMENT.ORDER_DATE        
AND M.ORDER_NO = MFSS_SETTLEMENT.ORDER_NO        
AND M.SCRIP_CD = MFSS_SETTLEMENT.SCRIP_CD      
AND M.RECFLAG NOT IN ('Y', 'V') )        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN
-- --------------------------------------------------

 ---PROC_MFSS_VALAN '2223063','T1'

CREATE PROC [dbo].[PROC_MFSS_VALAN]              
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)    


              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE          

-- ANIMESH
SELECT * INTO #MFSS_SETTLEMENT FROM MFSS_SETTLEMENT S         
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE 

UPDATE #MFSS_SETTLEMENT SET AMOUNT = 0, INS_CHRG = 0, BROKER_CHRG = 0 WHERE ORDER_DATE >= 'Jul  1 2022'

DELETE FROM #MFSS_SETTLEMENT WHERE  ORDER_DATE >= 'Jul  1 2022' AND BROKERAGE+SERVICE_TAX <= 0
-- ANIMESH 


              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
STAMP_DUTY =  SUM(ISNULL(BROKER_CHRG,0)),
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, #MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, #MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, #MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,
STAMP_DUTY = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, #MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT- (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE  S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
STAMP_DUTY = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, #MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE  S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              

INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
             
INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_10092014
-- --------------------------------------------------
--SELECT * FROM MFSS_SETTLEMENT  
CREATE PROC [dbo].[PROC_MFSS_VALAN_10092014]  
(  
 @SETT_NO   VARCHAR(7),  
    @SETT_TYPE VARCHAR(2)  
)  
AS  
  
UPDATE MFSS_SETTLEMENT SET   
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),  
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100  
FROM MFSS_CLIENT C, MFSS_BROKERAGE_MASTER M, BROKTABLE B, GLOBALS G  
WHERE MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE     
AND MFSS_SETTLEMENT.PARTY_CODE = M.PARTY_CODE    
AND B.TABLE_NO = (CASE WHEN SUB_RED_FLAG = 'P'   
           THEN M.BUY_BROK_TABLE_NO   
        ELSE M.SELL_BROK_TABLE_NO   
      END)  
AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE    
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM   
AND MFSS_SETTLEMENT.AMOUNT <= B.UPPER_LIM  
  
DELETE FROM ACCBILL  
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
  
SELECT SETT_NO, SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(ORDER_DATE, 11),   
BRANCHCD = BRANCH_CD,  
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'   
      THEN AMOUNT + BROKERAGE + SERVICE_TAX   
      ELSE BROKERAGE + SERVICE_TAX  
       END),2),  
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'   
      THEN AMOUNT   
      ELSE 0  
       END),  
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'   
      THEN BROKERAGE   
      ELSE BROKERAGE  
       END),  
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'   
      THEN SERVICE_TAX  
      ELSE SERVICE_TAX  
       END)  
INTO #VALAN   
FROM MFSS_SETTLEMENT S, MFSS_CLIENT C  
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
AND S.PARTY_CODE = C.PARTY_CODE  
GROUP BY SETT_NO, SETT_TYPE, S.PARTY_CODE, LEFT(ORDER_DATE, 11), BRANCH_CD  


  
INSERT INTO ACCBILL  
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=1,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=PARTY_AMOUNT,  
BRANCHCD,NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  


  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(EXCHG_AMOUNT),2),  
BRANCHCD,NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M, VALANACCOUNT V  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  
AND V.ACNAME = 'CLEARING HOUSE'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD  
  


INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),  
BRANCHCD,NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M, VALANACCOUNT V  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  
AND V.ACNAME = 'BROKERAGE REALISED'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD  
  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(SERVICE_TAX),2),  
BRANCHCD,NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M, VALANACCOUNT V  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  
AND V.ACNAME = 'SERVICE TAX'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD  
  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(EXCHG_AMOUNT),2),  
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M, VALANACCOUNT V  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  
AND V.ACNAME = 'CLEARING HOUSE'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT  
  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),  
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M, VALANACCOUNT V  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  
AND V.ACNAME = 'BROKERAGE REALISED'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT  
  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(SERVICE_TAX),2),  
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'  
FROM #VALAN S, SETT_MST M, VALANACCOUNT V  
WHERE S.SETT_NO = M.SETT_NO  
AND S.SETT_TYPE = M.SETT_TYPE  
AND V.ACNAME = 'SERVICE TAX'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT  
  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',  
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),  
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE,PAYOUT_DATE,  
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),  
BRANCHCD,NARRATION = 'MFSS BILL POSTED'  
FROM ACCBILL S, VALANACCOUNT V  
WHERE S.SETT_NO = @SETT_NO  
AND S.SETT_TYPE = @SETT_TYPE  
AND V.ACNAME = 'ROUNDING OFF'  
AND BRANCHCD <> 'ZZZ'  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD  
  
INSERT INTO ACCBILL  
SELECT ACCODE,BILL_NO='0',  
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),  
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,  
PAYIN_DATE,PAYOUT_DATE,  
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),  
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'  
FROM ACCBILL S, VALANACCOUNT V  
WHERE S.SETT_NO = @SETT_NO  
AND S.SETT_TYPE = @SETT_TYPE  
AND V.ACNAME = 'ROUNDING OFF'  
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')  
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_BAK_12102021
-- --------------------------------------------------

Create PROC [dbo].[PROC_MFSS_VALAN_BAK_12102021]             
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)              
              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
STAMP_DUTY =  SUM(ISNULL(BROKER_CHRG,0)),
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,
STAMP_DUTY = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   
		ELSE S.AMOUNT 
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
STAMP_DUTY = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              

INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
             
INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_BAKXSIPRELESE_AUG282015
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MFSS_VALAN]            
(            
 @SETT_NO   VARCHAR(7),            
    @SETT_TYPE VARCHAR(2)            
)            
AS            
        
DECLARE         
 @RECCOUNT INT,        
 @ACCOUNT  INT        
         
SET @RECCOUNT = 0        
SET @ACCOUNT = 0        
        
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER         
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE           
        
UPDATE MFSS_ORDER_STATUS SET STT = 0            
WHERE ORDER_DATE <= 'DEC 23 2010'            
AND ( STT > 0 OR STT IS NULL)            
            
IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST             
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE            
 AND START_DATE <= 'DEC 23 2010 23:59') > 0             
BEGIN            
 EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE          
 SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL         
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE            
 IF @RECCOUNT > 0 AND @ACCOUNT = 0         
 BEGIN        
  INSERT INTO ACCBILL        
  SELECT ACCODE,BILL_NO='0',            
  SELL_BUY=1,        
  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
  FUNDS_PAYIN,FUNDS_PAYOUT,            
  AMOUNT=0,        
  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'            
  FROM SETT_MST S, VALANACCOUNT V            
  WHERE S.SETT_NO = @SETT_NO        
  AND S.SETT_TYPE = @SETT_TYPE        
  AND V.ACNAME = 'ROUNDING OFF'            
  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT        
 END           
 RETURN            
END              
            
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0             
BEGIN            
 UPDATE MFSS_SETTLEMENT            
 SET FILLER1 = B.TABLE_NO            
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M            
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
        THEN M.BUY_BROK_TABLE_NO             
        ELSE M.SELL_BROK_TABLE_NO             
      END)            
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
           THEN 1            
           ELSE 2            
         END)            
 AND B.AMC_CODE = 'ALL'            
 AND B.CATEGORYCODE = 'ALL'            
 AND B.SCRIP_CD = 'ALL'            
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE            
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE            
 AND FILLER1 <> 'E'
            
 UPDATE MFSS_SETTLEMENT            
 SET FILLER1 = B.TABLE_NO            
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S            
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
        THEN M.BUY_BROK_TABLE_NO             
        ELSE M.SELL_BROK_TABLE_NO             
      END)            
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
           THEN 1            
           ELSE 2            
         END)            
 AND B.AMC_CODE = 'ALL'            
 AND B.SCRIP_CD = 'ALL'            
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE            
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE            
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD            
 AND S.CATEGORYCODE = B.CATEGORYCODE            
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'
            
 UPDATE MFSS_SETTLEMENT            
 SET FILLER1 = B.TABLE_NO            
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S            
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
        THEN M.BUY_BROK_TABLE_NO             
ELSE M.SELL_BROK_TABLE_NO             
      END)            
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
           THEN 1            
           ELSE 2            
         END)            
 AND B.AMC_CODE = S.AMC_CODE            
 AND B.SCRIP_CD = 'ALL'            
 AND B.CATEGORYCODE = 'ALL'            
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE            
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE            
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD            
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'
            
 UPDATE MFSS_SETTLEMENT            
 SET FILLER1 = B.TABLE_NO            
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S            
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
    THEN M.BUY_BROK_TABLE_NO             
        ELSE M.SELL_BROK_TABLE_NO             
      END)            
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
           THEN 1            
           ELSE 2            
         END)            
 AND B.SCRIP_CD = 'ALL'            
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE            
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE            
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD            
 AND S.CATEGORYCODE = B.CATEGORYCODE            
 AND S.AMC_CODE = B.AMC_CODE            
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'
            
 UPDATE MFSS_SETTLEMENT            
 SET FILLER1 = B.TABLE_NO            
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S            
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
        THEN M.BUY_BROK_TABLE_NO             
        ELSE M.SELL_BROK_TABLE_NO             
      END)            
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'             
           THEN 1            
     ELSE 2            
         END)            
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE            
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE            
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD            
 AND B.SCRIP_CD = S.SCRIP_CD 
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'
            
END            
ELSE            
BEGIN            
 UPDATE MFSS_SETTLEMENT            
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'            
      THEN M.BUY_BROK_TABLE_NO            
      ELSE M.SELL_BROK_TABLE_NO            
       END)            
 FROM MFSS_BROKERAGE_MASTER M            
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE            
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE     
 AND FILLER1 <> 'E'       
END            
            
UPDATE MFSS_SETTLEMENT SET             
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),            
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100            
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G            
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE               
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1             
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT              
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)         
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P' 
AND FILLER1 <> 'E'
           
UPDATE MFSS_SETTLEMENT SET                     
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100            
FROM MFSS_CLIENT C, GLOBALS G            
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO            
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE            
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT              
AND FILLER1 = 'E'
            
DELETE FROM ACCBILL            
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE            
            
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'             
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0)             
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0)            
       END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'             
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)            
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)            
       END),            
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'             
      THEN BROKERAGE             
      ELSE BROKERAGE            
       END),            
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'             
      THEN SERVICE_TAX            
      ELSE SERVICE_TAX            
       END),SUB_RED_FLAG            
INTO #VALAN             
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE            
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD,SUB_RED_FLAG            
            
INSERT INTO ACCBILL            
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),            
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),            
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M            
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),            
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),            
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V            
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'CLEARING HOUSE'            
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,SUB_RED_FLAG            
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),            
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V            
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'BROKERAGE REALISED'            
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD            
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,  
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),            
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
AND CESS_TAX+EDUCESSTAX = 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD            
  
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,  
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,           
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'SERVICE TAX'    
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX  
      
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,      
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),            
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'CESS TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT        
AND CESS_TAX+EDUCESSTAX > 0      
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX       
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0      
      
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,      
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),      
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'EDU CESS TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT        
AND CESS_TAX+EDUCESSTAX > 0      
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX       
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0      
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),            
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),            
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V            
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'CLEARING HOUSE'            
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,SUB_RED_FLAG            
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),            
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V            
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'BROKERAGE REALISED'            
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT            
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,  
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),            
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
AND CESS_TAX+EDUCESSTAX = 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT            
  
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,  
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),            
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX           
      
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,      
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),            
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'CESS TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT        
AND CESS_TAX+EDUCESSTAX > 0      
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX       
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0      
      
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,      
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),      
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G          
WHERE S.SETT_NO = M.SETT_NO            
AND S.SETT_TYPE = M.SETT_TYPE            
AND V.ACNAME = 'EDU CESS TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT        
AND CESS_TAX+EDUCESSTAX > 0      
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX       
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0      
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',            
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),            
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE,PAYOUT_DATE,            
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),            
BRANCHCD,NARRATION = 'MFSS BILL POSTED'            
FROM ACCBILL S, VALANACCOUNT V            
WHERE S.SETT_NO = @SETT_NO            
AND S.SETT_TYPE = @SETT_TYPE            
AND V.ACNAME = 'ROUNDING OFF'            
AND BRANCHCD <> 'ZZZ'            
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD            
            
INSERT INTO ACCBILL            
SELECT ACCODE,BILL_NO='0',            
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),            
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
PAYIN_DATE,PAYOUT_DATE,            
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),            
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'            
FROM ACCBILL S, VALANACCOUNT V            
WHERE S.SETT_NO = @SETT_NO            
AND S.SETT_TYPE = @SETT_TYPE            
AND V.ACNAME = 'ROUNDING OFF'            
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')            
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE            
            
        
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL         
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE            
IF @RECCOUNT > 0 AND @ACCOUNT = 0         
BEGIN        
 INSERT INTO ACCBILL        
 SELECT ACCODE,BILL_NO='0',            
 SELL_BUY=1,        
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,            
 FUNDS_PAYIN,FUNDS_PAYOUT,            
 AMOUNT=0,        
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'            
 FROM SETT_MST S, VALANACCOUNT V            
 WHERE S.SETT_NO = @SETT_NO        
 AND S.SETT_TYPE = @SETT_TYPE        
 AND V.ACNAME = 'ROUNDING OFF'            
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_bkp01072022
-- --------------------------------------------------

Create PROC [dbo].[PROC_MFSS_VALAN_bkp01072022]              
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)              
              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
STAMP_DUTY =  SUM(ISNULL(BROKER_CHRG,0)),
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,
STAMP_DUTY = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT- (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE  S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
STAMP_DUTY = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE  S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              

INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
             
INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_BKUP_28JUL20
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MFSS_VALAN_BKUP_28JUL20]              
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)              
              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   
		ELSE S.AMOUNT 
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_BKUP_30MAR2021
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MFSS_VALAN_BKUP_30MAR2021]              
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)              
              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
STAMP_DUTY =  SUM(ISNULL(BROKER_CHRG,0)),
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,
STAMP_DUTY = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   
		ELSE S.AMOUNT 
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
STAMP_DUTY = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              

INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
             
INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_OLD
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MFSS_VALAN_OLD]              
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)              
              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0) + ISNULL(BROKER_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
STAMP_DUTY =  SUM(ISNULL(BROKER_CHRG,0)),
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END) - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0, 
STAMP_DUTY = 0, 
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT  7 2020') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)  
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,
STAMP_DUTY = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT- (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE  S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
STAMP_DUTY = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT - (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		ELSE  S.AMOUNT + (CASE WHEN S.ORDER_DATE >= CONVERT(DATETIME,'OCT 12 2021') THEN ISNULL(BROKER_CHRG,0) ELSE 0 END)
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              

INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
             
INSERT INTO ACCBILL        
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,        
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(STAMP_DUTY),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'        
FROM #VALAN S, SETT_MST M, VALANACCOUNT V        
WHERE S.SETT_NO = M.SETT_NO        
AND S.SETT_TYPE = M.SETT_TYPE        
AND V.ACNAME = 'STAMP DUTY'        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT 
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MFSS_VALAN_TEST
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MFSS_VALAN_TEST]              
(              
 @SETT_NO   VARCHAR(7),              
    @SETT_TYPE VARCHAR(2)              
)              
AS              
          
DECLARE           
 @RECCOUNT INT,          
 @ACCOUNT  INT          
           
SET @RECCOUNT = 0          
SET @ACCOUNT = 0          
          
SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM MFSS_ORDER           
WHERE SETT_NO = @SETT_NO AND SETTLEMENT_TYPE = @SETT_TYPE             
          
UPDATE MFSS_ORDER_STATUS SET STT = 0              
WHERE ORDER_DATE <= 'DEC 23 2010'              
AND ( STT > 0 OR STT IS NULL)              
              
--IF (SELECT ISNULL(COUNT(1),0) FROM SETT_MST               
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- AND START_DATE <= 'DEC 23 2010 23:59') > 0               
--BEGIN              
-- EXEC PROC_MFSS_VALAN_OLD @SETT_NO, @SETT_TYPE            
-- SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
-- WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
-- IF @RECCOUNT > 0 AND @ACCOUNT = 0           
-- BEGIN          
--  INSERT INTO ACCBILL          
--  SELECT ACCODE,BILL_NO='0',              
--  SELL_BUY=1,          
--  S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
--  FUNDS_PAYIN,FUNDS_PAYOUT,              
--  AMOUNT=0,          
--  BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
--  FROM SETT_MST S, VALANACCOUNT V              
--  WHERE S.SETT_NO = @SETT_NO          
--  AND S.SETT_TYPE = @SETT_TYPE          
--  AND V.ACNAME = 'ROUNDING OFF'              
--  GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
-- END             
-- RETURN              
--END                
              
IF (SELECT ISNULL(PROFILE_BROK_FLAG,0) FROM OWNER) > 0               
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = 'ALL'              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.AMC_CODE = S.AMC_CODE              
 AND B.SCRIP_CD = 'ALL'              
 AND B.CATEGORYCODE = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
    THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
           ELSE 2              
         END)              
 AND B.SCRIP_CD = 'ALL'              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND S.CATEGORYCODE = B.CATEGORYCODE              
 AND S.AMC_CODE = B.AMC_CODE              
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = B.TABLE_NO              
 FROM MFSS_BROK_PROFILE B, MFSS_BROKERAGE_MASTER M, MFSS_SCRIP_MASTER S              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND PROFILE_ID = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
        THEN M.BUY_BROK_TABLE_NO               
        ELSE M.SELL_BROK_TABLE_NO               
      END)              
 AND B.SELL_BUY_FLAG = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'               
           THEN 1              
     ELSE 2              
         END)              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE              
 AND MFSS_SETTLEMENT.SCRIP_CD = S.SCRIP_CD              
 AND B.SCRIP_CD = S.SCRIP_CD   
 AND MFSS_SETTLEMENT.FILLER1 <> 'E'  
              
END              
ELSE              
BEGIN              
 UPDATE MFSS_SETTLEMENT              
 SET FILLER1 = (CASE WHEN MFSS_SETTLEMENT.SUB_RED_FLAG = 'P'              
      THEN M.BUY_BROK_TABLE_NO              
      ELSE M.SELL_BROK_TABLE_NO              
       END)              
 FROM MFSS_BROKERAGE_MASTER M              
 WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
 AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
 AND M.PARTY_CODE = MFSS_SETTLEMENT.PARTY_CODE              
 AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE       
 AND FILLER1 <> 'E'         
END              
              
UPDATE MFSS_SETTLEMENT SET               
BROKERAGE = (CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),              
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, BROKTABLE B, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND B.TABLE_NO = MFSS_SETTLEMENT.FILLER1               
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND MFSS_SETTLEMENT.AMOUNT > B.LOWER_LIM AND MFSS_SETTLEMENT.AMOUNT <= (CASE WHEN B.UPPER_LIM = 99999999999.00 THEN MFSS_SETTLEMENT.AMOUNT ELSE B.UPPER_LIM END)           
AND MFSS_SETTLEMENT.SUB_RED_FLAG <> 'P'   
AND FILLER1 <> 'E'  
             
UPDATE MFSS_SETTLEMENT SET                       
SERVICE_TAX=BROKERAGE*G.SERVICE_TAX/100              
FROM MFSS_CLIENT C, GLOBALS G              
WHERE MFSS_SETTLEMENT.SETT_NO = @SETT_NO              
AND MFSS_SETTLEMENT.SETT_TYPE = @SETT_TYPE              
AND MFSS_SETTLEMENT.PARTY_CODE = C.PARTY_CODE                 
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT                
AND FILLER1 = 'E'  
              
DELETE FROM ACCBILL              
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
              
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0)               
      ELSE - S.AMOUNT + BROKERAGE + SERVICE_TAX + ISNULL(INS_CHRG,0)              
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN   S.AMOUNT + ISNULL(INS_CHRG,0)              
      ELSE - S.AMOUNT + ISNULL(INS_CHRG,0)              
       END),              
BROKERAGE    = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN BROKERAGE               
      ELSE BROKERAGE              
       END),              
SERVICE_TAX  = SUM(CASE WHEN SUB_RED_FLAG = 'P'               
      THEN SERVICE_TAX              
      ELSE SERVICE_TAX              
       END),  
    FLAG = 'NORMAL'              
INTO #VALAN               
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S               
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE              
AND S.PARTY_CODE = C.PARTY_CODE              
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD              
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT - X.BROKERAGE   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT - X.BROKERAGE          
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O,   
(SELECT DISTINCT PARTY_CODE,XSIP_REGN_DATE,END_DATE,BROKERAGE,XSIP_REGN_NO FROM TBL_XSIP_REGSTR) X                
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')  
AND S.PARTY_CODE = X.PARTY_CODE  
--AND S.SCHEME_NAME = X.SCHEME_NAME  
AND O.SIP_REGN_NO = X.XSIP_REGN_NO  
AND O.ORDER_DATE BETWEEN XSIP_REGN_DATE AND END_DATE  
AND S.ORDER_DATE <= 'MAR 21 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE   
  
  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'MAR 21 2017 23:59'
AND S.ORDER_DATE <= 'JUL 18 2017 23:59'  
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

  
INSERT INTO #VALAN               
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),               
BRANCHCD = BRANCH_CD,              
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN - S.AMOUNT   
      ELSE  0  
       END),2),              
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'               
      THEN  - S.AMOUNT       
      ELSE 0  
       END),              
BROKERAGE = 0,              
SERVICE_TAX = 0,  
FLAG = O.ORDER_TYPE              
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O              
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE    
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE            
AND S.PARTY_CODE = C.PARTY_CODE              
AND S.ORDER_NO = O.ORDER_NO  
AND O.ORDER_TYPE IN ('XSP', 'ISP')    
AND S.ORDER_DATE > 'JUL 18 2017 23:59'  
AND isnull(O.FIRST_ORDER_FLAG,'') <> 'Y'
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD, O.ORDER_TYPE    

SELECT * FROM #VALAN             
WHERE SETT_NO = '1920035'
AND PARTY_CODE = 'M133703'

INSERT INTO #VALAN             
SELECT S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, ORDER_DATE=LEFT(S.ORDER_DATE, 11),             
BRANCHCD = BRANCH_CD,            
PARTY_AMOUNT = ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2),            
EXCHG_AMOUNT = SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN  - S.AMOUNT   
		ELSE S.AMOUNT 
		END),            
BROKERAGE = 0,            
SERVICE_TAX = 0,
FLAG = 'SISO'            
FROM MFSS_CLIENT C, MFSS_SETTLEMENT S, MFSS_ORDER O             
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND O.SETT_NO = @SETT_NO AND O.SETTLEMENT_TYPE = @SETT_TYPE          
AND S.PARTY_CODE = C.PARTY_CODE            
AND S.ORDER_NO = O.ORDER_NO
AND O.ORDER_TYPE IN ('SI','SO')
AND S.PARTY_CODE = O.PARTY_CODE 
GROUP BY S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, LEFT(S.ORDER_DATE, 11), BRANCH_CD--, S.SUB_RED_FLAG 
HAVING ROUND(SUM(CASE WHEN S.SUB_RED_FLAG = 'P'             
		THEN - S.AMOUNT
		ELSE  S.AMOUNT 
		END),2) <> 0 

INSERT INTO ACCBILL              
SELECT S.PARTY_CODE,BILL_NO='0',SELL_BUY=(CASE WHEN PARTY_AMOUNT > 0 THEN 1 ELSE 2 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(PARTY_AMOUNT),              
BRANCHCD,NARRATION = (CASE WHEN FLAG = 'NORMAL' THEN 'MFSS BILL POSTED'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS XSIP DIRECT PAYMENT TO EXCHG'   
         ELSE CASE WHEN FLAG = 'XSP' THEN 'MFSS ISIP DIRECT PAYMENT TO EXCHG'  
         ELSE CASE WHEN FLAG = 'SISO' THEN 'MFSS SI AND SO REVERSAL ENTRY' 
		 ELSE 'MFSS BILL POSTED'   
		 END END END END)             
FROM #VALAN S, SETT_MST M              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE         
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD             
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2) ,             
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'      
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,CESS_TAX,EDUCESSTAX    
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,BRANCHCD,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=(CASE WHEN ROUND(SUM(EXCHG_AMOUNT),2) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ABS(ROUND(SUM(EXCHG_AMOUNT),2)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CLEARING HOUSE'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,AMOUNT=ROUND(SUM(BROKERAGE),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V              
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'BROKERAGE REALISED'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(SUM(S.SERVICE_TAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX = 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT              
    
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,    
AMOUNT=ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'SERVICE TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
AND CESS_TAX+EDUCESSTAX > 0          
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,CESS_TAX,EDUCESSTAX             
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(CESS_TAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
        
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',SELL_BUY=2,S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE=FUNDS_PAYIN,PAYOUT_DATE=FUNDS_PAYOUT,        
AMOUNT=ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2),        
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM #VALAN S, SETT_MST M, VALANACCOUNT V, GLOBALS G            
WHERE S.SETT_NO = M.SETT_NO              
AND S.SETT_TYPE = M.SETT_TYPE              
AND V.ACNAME = 'EDU CESS TAX'        
AND START_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT          
AND CESS_TAX+EDUCESSTAX > 0        
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT,EDUCESSTAX,CESS_TAX         
HAVING ROUND(EDUCESSTAX*(ROUND(SUM(S.SERVICE_TAX),2)-ROUND(ROUND(SUM(S.SERVICE_TAX),2)*100/(100+(CESS_TAX+EDUCESSTAX)),2))/(CESS_TAX+EDUCESSTAX),2) > 0        
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD,NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND BRANCHCD <> 'ZZZ'              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,BRANCHCD              
              
INSERT INTO ACCBILL              
SELECT ACCODE,BILL_NO='0',              
SELL_BUY=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 2 ELSE 1 END),              
S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
PAYIN_DATE,PAYOUT_DATE,              
AMOUNT=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),              
BRANCHCD='ZZZ',NARRATION = 'MFSS BILL POSTED'              
FROM ACCBILL S, VALANACCOUNT V              
WHERE S.SETT_NO = @SETT_NO              
AND S.SETT_TYPE = @SETT_TYPE              
AND V.ACNAME = 'ROUNDING OFF'              
AND ( PARTY_CODE IN (SELECT PARTY_CODE FROM MFSS_CLIENT) OR BRANCHCD = 'ZZZ')              
GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE              
              
          
SELECT @ACCOUNT = ISNULL(COUNT(1),0) FROM ACCBILL           
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE              
IF @RECCOUNT > 0 AND @ACCOUNT = 0           
BEGIN          
 INSERT INTO ACCBILL          
 SELECT ACCODE,BILL_NO='0',              
 SELL_BUY=1,          
 S.SETT_NO,S.SETT_TYPE,START_DATE,END_DATE,              
 FUNDS_PAYIN,FUNDS_PAYOUT,              
 AMOUNT=0,          
 BRANCHCD='HO',NARRATION = 'MFSS BILL POSTED'              
 FROM SETT_MST S, VALANACCOUNT V              
 WHERE S.SETT_NO = @SETT_NO          
 AND S.SETT_TYPE = @SETT_TYPE          
 AND V.ACNAME = 'ROUNDING OFF'              
 GROUP BY S.SETT_NO,S.SETT_TYPE,ACCODE,START_DATE,END_DATE,FUNDS_PAYIN,FUNDS_PAYOUT          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_XSIP_REGN_MASTER
-- --------------------------------------------------
  
          
-- Exec PROC_XSIP_REGN_MASTER'16/06/2015','XSIP','XSIP REGISTRATION MASTER','1234567890', 'BROKER', 'C:\Users\animesh.jain\Desktop\xsip.txt'          
          
CREATE PROC [dbo].[PROC_XSIP_REGN_MASTER]           
(          
 @TDATE VARCHAR(10),           
 @FILEFOR VARCHAR(20),           
 @FILETYPE VARCHAR(50),           
 @PROGID VARCHAR(50),           
 @UNAME VARCHAR(50),          
 @FILENAME VARCHAR(100) = ''          
)          
AS          
          
-- EXEC PROC_XSIP_REGN_MASTER '', '', '', '1234567890', ''          
          
DECLARE @RECCNT NUMERIC(18,0)          
/*        
UPDATE TBL_XSIP_REGSTR SET END_DATE = LEFT(CONVERT(DATETIME,@TDATE,103) -1,11) + ' 23:59:59',        
REC_STATUS = .DBO.PIECE(FILE_DATA,'|',1)        
FROM FILEDATA            
WHERE PROGID = @PROGID           
AND .DBO.PIECE(FILE_DATA,'|',6) = XSIP_REGN_NO        
AND .DBO.PIECE(FILE_DATA,'|',3) = PARTY_CODE          
AND .DBO.PIECE(FILE_DATA,'|',10) = SCHEME_NAME        
AND .DBO.PIECE(FILE_DATA,'|',1) = 'CXL'        
--AND END_DATE > CONVERT(DATETIME,@TDATE,103)  + ' 23:59:59'        
*/        
      
TRUNCATE TABLE TBL_XSIP_REGSTR_TMP      

--select * into FILEDATA_09012017 from FILEDATA WHERE PROGID = 117        


      
INSERT INTO TBL_XSIP_REGSTR_TMP          
SELECT           
 .DBO.PIECE(FILE_DATA,'|',1),          
 .DBO.PIECE(FILE_DATA,'|',2),          
 .DBO.PIECE(FILE_DATA,'|',3),          
 .DBO.PIECE(FILE_DATA,'|',4),          
 .DBO.PIECE(FILE_DATA,'|',5),          
 .DBO.PIECE(FILE_DATA,'|',6),          
 CONVERT(DATETIME,.DBO.PIECE(FILE_DATA,'|',7),103),          
 .DBO.PIECE(FILE_DATA,'|',8),          
 .DBO.PIECE(FILE_DATA,'|',9),          
 .DBO.PIECE(FILE_DATA,'|',10),          
 .DBO.PIECE(FILE_DATA,'|',11),          
 .DBO.PIECE(FILE_DATA,'|',12),          
 .DBO.PIECE(FILE_DATA,'|',13),          
  DBO.PIECE(FILE_DATA,'|',14),   
 .DBO.PIECE(FILE_DATA,'|',15),          
 .DBO.PIECE(FILE_DATA,'|',16),          
 .DBO.PIECE(FILE_DATA,'|',17)          
FROM FILEDATA            
WHERE PROGID = 117 

   
      
INSERT INTO TBL_XSIP_REGSTR          
SELECT           
 .DBO.PIECE(FILE_DATA,'|',1),          
 .DBO.PIECE(FILE_DATA,'|',2),          
 .DBO.PIECE(FILE_DATA,'|',3),          
 .DBO.PIECE(FILE_DATA,'|',4),          
 .DBO.PIECE(FILE_DATA,'|',5),          
 .DBO.PIECE(FILE_DATA,'|',6),          
 CONVERT(DATETIME,.DBO.PIECE(FILE_DATA,'|',7),103),          
 .DBO.PIECE(FILE_DATA,'|',8),          
 .DBO.PIECE(FILE_DATA,'|',9),          
 .DBO.PIECE(FILE_DATA,'|',10),          
 .DBO.PIECE(FILE_DATA,'|',11),          
 .DBO.PIECE(FILE_DATA,'|',12),          
 .DBO.PIECE(FILE_DATA,'|',13),          
 .DBO.PIECE(FILE_DATA,'|',14),          
 .DBO.PIECE(FILE_DATA,'|',15),          
 .DBO.PIECE(FILE_DATA,'|',16),          
 .DBO.PIECE(FILE_DATA,'|',17)          
FROM FILEDATA            
WHERE PROGID = @PROGID           
AND .DBO.PIECE(FILE_DATA,'|',3) NOT IN (SELECT PARTY_CODE FROM TBL_XSIP_REGSTR           
             WHERE .DBO.PIECE(FILE_DATA,'|',3) = PARTY_CODE          
          AND .DBO.PIECE(FILE_DATA,'|',10) = SCHEME_NAME        
          AND .DBO.PIECE(FILE_DATA,'|',6) = XSIP_REGN_NO )          
        
SELECT @RECCNT = ISNULL(COUNT(1),0) FROM FILEDATA            
WHERE PROGID = @PROGID           
          
SELECT STRMSGCODE = 1, STRMSG = CONVERT(VARCHAR,@RECCNT) + ' RECORD(S) IMPORTED SUCCESSFULLY.'            
          
DELETE FROM FILEDATA          
WHERE PROGID = @PROGID          
          
SELECT STRMSGCODE = 1, STRMSG = ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_XSIP_REGN_MASTER_NEWTEST
-- --------------------------------------------------

        
-- Exec PROC_XSIP_REGN_MASTER'16/06/2015','XSIP','XSIP REGISTRATION MASTER','1234567890', 'BROKER', 'C:\Users\animesh.jain\Desktop\xsip.txt'        
        
CREATE PROC [dbo].[PROC_XSIP_REGN_MASTER]         
(        
 @TDATE VARCHAR(10),         
 @FILEFOR VARCHAR(20),         
 @FILETYPE VARCHAR(50),         
 @PROGID VARCHAR(50),         
 @UNAME VARCHAR(50),        
 @FILENAME VARCHAR(100) = ''        
)        
AS        
        
-- EXEC PROC_XSIP_REGN_MASTER '', '', '', '1234567890', ''        
        
DECLARE @RECCNT NUMERIC(18,0)        
/*      
UPDATE TBL_XSIP_REGSTR SET END_DATE = LEFT(CONVERT(DATETIME,@TDATE,103) -1,11) + ' 23:59:59',      
REC_STATUS = .DBO.PIECE(FILE_DATA,'|',1)      
FROM FILEDATA          
WHERE PROGID = @PROGID         
AND .DBO.PIECE(FILE_DATA,'|',6) = XSIP_REGN_NO      
AND .DBO.PIECE(FILE_DATA,'|',3) = PARTY_CODE        
AND .DBO.PIECE(FILE_DATA,'|',10) = SCHEME_NAME      
AND .DBO.PIECE(FILE_DATA,'|',1) = 'CXL'      
--AND END_DATE > CONVERT(DATETIME,@TDATE,103)  + ' 23:59:59'      
*/      
    
TRUNCATE TABLE TBL_XSIP_REGSTR_TMP    
    
--INSERT INTO TBL_XSIP_REGSTR_TMP        
SELECT         
 .DBO.PIECE(FILE_DATA,'|',1)AS REC_STATUS,        
 .DBO.PIECE(FILE_DATA,'|',2)AS MEMBERCODE,        
 .DBO.PIECE(FILE_DATA,'|',3)AS PARTY_CODE,        
 .DBO.PIECE(FILE_DATA,'|',4)AS PARTY_NAME,        
 .DBO.PIECE(FILE_DATA,'|',5)AS INT_REF_NO,        
 .DBO.PIECE(FILE_DATA,'|',6)AS XSIP_REGN_NO,        
 CONVERT(DATETIME,.DBO.PIECE(FILE_DATA,'|',7),103)AS XSIP_REGN_DATE,        
 .DBO.PIECE(FILE_DATA,'|',8)AS AMC_NAME,        
 .DBO.PIECE(FILE_DATA,'|',9)AS RTA_SCHEME_CODE,        
 .DBO.PIECE(FILE_DATA,'|',10)AS SCHEME_NAME,        
 .DBO.PIECE(FILE_DATA,'|',11)AS FERQ_TYPE,        
 .DBO.PIECE(FILE_DATA,'|',12)AS START_DATE,        
 .DBO.PIECE(FILE_DATA,'|',13)AS END_DATE,        
 .DBO.PIECE(FILE_DATA,'|',14)AS INSTALL_AMT,     
 .DBO.PIECE(FILE_DATA,'|',15)AS BROKERAGE,        
 .DBO.PIECE(FILE_DATA,'|',16)AS ENTRY_BY,        
 .DBO.PIECE(FILE_DATA,'|',17)AS BSE_MANDATE_ID
 INTO #TEMP

FROM FILEDATA          
WHERE PROGID= @PROGID



UPDATE #TEMP
SET  INSTALL_AMT ='0.0000'
WHERE INSTALL_AMT=''
 
 INSERT INTO TBL_XSIP_REGSTR_TMP  
 SELECT * FROM #TEMP 
    
--INSERT INTO TBL_XSIP_REGSTR        
SELECT         
.DBO.PIECE(FILE_DATA,'|',1)AS REC_STATUS,        
 .DBO.PIECE(FILE_DATA,'|',2)AS MEMBERCODE,        
 .DBO.PIECE(FILE_DATA,'|',3)AS PARTY_CODE,        
 .DBO.PIECE(FILE_DATA,'|',4)AS PARTY_NAME,        
 .DBO.PIECE(FILE_DATA,'|',5)AS INT_REF_NO,        
 .DBO.PIECE(FILE_DATA,'|',6)AS XSIP_REGN_NO,        
 CONVERT(DATETIME,.DBO.PIECE(FILE_DATA,'|',7),103)AS XSIP_REGN_DATE,        
 .DBO.PIECE(FILE_DATA,'|',8)AS AMC_NAME,        
 .DBO.PIECE(FILE_DATA,'|',9)AS RTA_SCHEME_CODE,        
 .DBO.PIECE(FILE_DATA,'|',10)AS SCHEME_NAME,        
 .DBO.PIECE(FILE_DATA,'|',11)AS FERQ_TYPE,        
 .DBO.PIECE(FILE_DATA,'|',12)AS START_DATE,        
 .DBO.PIECE(FILE_DATA,'|',13)AS END_DATE,        
 .DBO.PIECE(FILE_DATA,'|',14)AS INSTALL_AMT,     
 .DBO.PIECE(FILE_DATA,'|',15)AS BROKERAGE,        
 .DBO.PIECE(FILE_DATA,'|',16)AS ENTRY_BY,        
 .DBO.PIECE(FILE_DATA,'|',17)AS BSE_MANDATE_ID  
 INTO #TEMP1  
FROM FILEDATA          
WHERE PROGID = @PROGID         
AND .DBO.PIECE(FILE_DATA,'|',3) NOT IN (SELECT PARTY_CODE FROM TBL_XSIP_REGSTR         
             WHERE .DBO.PIECE(FILE_DATA,'|',3) = PARTY_CODE        
          AND .DBO.PIECE(FILE_DATA,'|',10) = SCHEME_NAME      
          AND .DBO.PIECE(FILE_DATA,'|',6) = XSIP_REGN_NO ) 
          
          
UPDATE #TEMP1
SET  INSTALL_AMT ='0.0000'
WHERE INSTALL_AMT=''  

INSERT INTO TBL_XSIP_REGSTR  
 SELECT * FROM #TEMP1              
      
SELECT @RECCNT = ISNULL(COUNT(1),0) FROM FILEDATA          
WHERE PROGID = @PROGID         
        
SELECT STRMSGCODE = 1, STRMSG = CONVERT(VARCHAR,@RECCNT) + ' RECORD(S) IMPORTED SUCCESSFULLY.'          
        
DELETE FROM FILEDATA        
WHERE PROGID = @PROGID        
        
SELECT STRMSGCODE = 1, STRMSG = '' 


SELECT * FROM FILEDATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSEMFSS_MISSING_CLIENT
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[RPT_BSEMFSS_MISSING_CLIENT]     
AS    
    
    
BEGIN    
    
DECLARE @RECORDCOUNT INT     
    
    
SELECT @RECORDCOUNT = ISNULL(COUNT(*), 0)    
FROM BSEMFSS..MFSS_CLIENT M  WHERE INACTIVE_FROM >GETDATE()
AND NOT EXISTS (SELECT PARTY_CODE FROM BSEMFSS..MFSS_DPMASTER  D WHERE M.PARTY_CODE=D.PARTY_CODE AND
M.DPID=D.DPID AND M.CLTDPID =D.CLTDPID  )
AND DP_TYPE <>'PHY'
AND M.DPID='12033200'   
   
    
IF (@RECORDCOUNT > 0)    
BEGIN    
    
    
    
EXEC MSDB.DBO.SP_SEND_DBMAIL    
    @PROFILE_NAME = 'CLASS AUTO PROCESS TEST PROFILE',    
    @RECIPIENTS = 'ANIL.WANDRE@ANGELBROKING.COM',    
      
	
	@QUERY = 'SELECT PARTY_CODE ,DP_TYPE,DPID,CLTDPID FROM BSEMFSS..MFSS_CLIENT M 
	WHERE INACTIVE_FROM >GETDATE()
AND NOT EXISTS (SELECT PARTY_CODE FROM BSEMFSS..MFSS_DPMASTER  D WHERE M.PARTY_CODE=D.PARTY_CODE AND
M.DPID=D.DPID AND M.CLTDPID =D.CLTDPID  )
AND DP_TYPE <>''PHY''
AND M.DPID IN (''12033200'') ',    
      @SUBJECT = 'MISSING PARTY EMAIL BSEMFSS ',    
       @BODY = 'MISSING PARTY_CODE..... ' ,    
    @ATTACH_QUERY_RESULT_AS_FILE = 1 ;    
    
END    
ELSE    
BEGIN    
    
      EXEC MSDB.DBO.SP_SEND_DBMAIL    
      @PROFILE_NAME = 'CLASS AUTO PROCESS TEST PROFILE',    
       @RECIPIENTS = 'ANIL.WANDRE@ANGELBROKING.COM',     
            @BODY = 'NO DATA RETURNED BSEMFSS ',     
            @SUBJECT = 'MISSING PARTY EMAIL BSEMFSS'    
    
END    
END;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BTB_BTC
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_BTB_BTC] (@RUNDATE VARCHAR(11))

AS ---- EXEC RPT_BTC_BTC 'APR 22 2022'

SELECT CL_CODE,B.LONG_NAME,B.SUB_BROKER,B.BRANCH_CD,
(CASE WHEN B2C='Y'THEN 'B2C'ELSE 'B2B'END)AS B2B_B2C INTO #BTB
FROM INTRANET.RISK.DBO.CLIENT_DETAILS B WITH (NOLOCK) 
WHERE CL_CODE IN (SELECT * FROM IMPORT_PARTY_CODE)

SELECT * FROM #BTB ORDER BY CL_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTLISTING
-- --------------------------------------------------
--RPT_CLIENTLISTING ,'','','','','','','broker','broker'

CREATE   PROC RPT_CLIENTLISTING
	(
	@FROMPARTY VARCHAR(15),
	@TOPARTY VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15),
	@FROMSUBBROKER VARCHAR(15),
	@TOSUBBROKER VARCHAR(15),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
	)
	
	AS

	IF LEN(@TOPARTY) = 0
	BEGIN
		SET @TOPARTY = 'zzzzzzzzzz'
	END

	IF LEN(@TOBRANCH) = 0 
	BEGIN
		SET @TOBRANCH = 'zzzzzzzzzz'
	END

	IF LEN(@TOSUBBROKER) = 0 
	BEGIN
		SET @TOSUBBROKER = 'zzzzzzzzzz'
	END

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SELECT
		PARTY_CODE ,
		PARTY_NAME,
		ADDR1,
		ADDR2,
		ADDR3,
		CITY,
		STATE,
		ZIP,
		PHONE = (CASE 
				WHEN OFFICE_PHONE <> '' THEN OFFICE_PHONE + ', '
				WHEN RES_PHONE <> '' THEN RES_PHONE
				ELSE ''
			END), 
		EMAIL_ID,
		PAN_NO,
		BRANCH_CD,
		SUB_BROKER,
		TRADER,
		AREA,
		REGION,
		SBU,
		FAMILY,
		BANK_NAME,
		BANK_BRANCH,
		BANK_CITY,
		ACC_NO,
		DP_TYPE,
		DPID,
		CLTDPID
	FROM
		MFSS_CLIENT (NOLOCK)
	WHERE
		PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
		AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER
		AND @STATUSNAME = (         
		CASE         
			WHEN @STATUSID = 'BRANCH'
			THEN BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'
			THEN SUB_BROKER
			WHEN @STATUSID = 'TRADER'
			THEN TRADER
			WHEN @STATUSID = 'FAMILY'
			THEN FAMILY
			WHEN @STATUSID = 'AREA'
			THEN AREA
			WHEN @STATUSID = 'REGION'
			THEN REGION
			WHEN @STATUSID = 'CLIENT'
			THEN PARTY_CODE
			ELSE 'BROKER' 
		END)

	
	ORDER BY
		1,2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_DELIVERYPAYOUT
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_DELIVERYPAYOUT]          
(@SETT_NO VARCHAR(7),              
 @SETT_TYPE VARCHAR(2),              
 @FROMPARTY VARCHAR(10),              
 @TOPARTY VARCHAR(10),              
 @FROMSCRIP VARCHAR(12),              
 @TOSCRIP VARCHAR(12),              
 @DPTYPE VARCHAR(4),              
 @DPID VARCHAR(8),              
 @CLTDPID VARCHAR(16),    
 @CATEGORY VARCHAR(10),     
 @BRANCHCODE VARCHAR(10),    
 @chkflag Varchar(20))              
AS              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
          
EXEC INSDELACCCHECK    
    
/*INSERT INTO DELACCBALANCE      
SELECT PARTY_CODE, 0, PAYFLAG = 0      
FROM DELPARTYFLAG      
WHERE PARTY_CODE NOT IN (SELECT CLTCODE FROM DELACCBALANCE)      
*/  
      
--UPDATE DELACCBALANCE SET AMOUNT = 0, PAYFLAG=1 WHERE CLTCODE IN ( SELECT PARTY_CODE FROM DELPARTYFLAG WHERE DEBITFLAG = 1 )              
--UPDATE DELACCBALANCE SET AMOUNT = -1, PAYFLAG=2 WHERE CLTCODE IN ( SELECT PARTY_CODE FROM DELPARTYFLAG WHERE DEBITFLAG = 2 )              
    
if @ChkFlag = 'Branch Marking'     
Begin    
 SELECT D.SCRIP_CD,SERIES=D.SCRIP_CD,D.PARTY_CODE,LONG_NAME=ISNULL(PARTY_NAME,''),TRTYPE,D.DPTYPE,D.CLTDPID,              
 D.DPID,CERTNO,QTY=CONVERT(NUMERIC(18,3),SUM(QTY)),BDPTYPE,BDPID,BCLTDPID,AMOUNT=ISNULL(AMOUNT,0),              
 ISETT_NO,ISETT_TYPE,FLAG=(CASE WHEN TRTYPE = 907 THEN 1 WHEN TRTYPE = 908 THEN 2 ELSE 3 END),              
 INEXC=0, PAYFLAG = ISNULL(A.PAYFLAG,0) FROM MFSS_DPMASTER M, DELTRANS D LEFT OUTER JOIN DELACCBALANCE A               
 ON ( A.CLTCODE = D.PARTY_CODE )               
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND TRTYPE <> 906              
 AND D.PARTY_CODE = M.PARTY_CODE AND M.DPID = D.DPID AND M.CLTDPID = D.CLTDPID AND M.DP_TYPE = D.DPTYPE              
 AND DELIVERED = '0' AND D.PARTY_CODE <> 'BROKER'               
 AND BDPTYPE = @DPTYPE AND BDPID = @DPID AND BCLTDPID = @CLTDPID AND DRCR = 'D' AND FILLER2 = 1               
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SCRIP_CD >= @FROMSCRIP AND D.SCRIP_CD <= @TOSCRIP AND TRTYPE IN (904,905)    
 AND EXISTS (SELECT PARTY_CODE FROM CLIENT2 C2, CLIENT1 C1     
      WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE     
      AND C1.BRANCH_CD = (CASE WHEN @BRANCHCODE = 'ALL' THEN C1.BRANCH_CD ELSE @BRANCHCODE END))    
 AND TRTYPE = 905    
 GROUP BY D.SCRIP_CD,D.SERIES,D.PARTY_CODE,PARTY_NAME,TRTYPE,D.CLTDPID,D.DPID,               
 CERTNO, BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,D.DPTYPE,PAYFLAG       
 ORDER BY FLAG,ISETT_NO,ISETT_TYPE,D.DPTYPE,D.PARTY_CODE,D.SCRIP_CD              
End    
Else if @ChkFlag = 'Always Payout'     
Begin    
 SELECT D.SCRIP_CD,SERIES=D.SCRIP_CD,D.PARTY_CODE,LONG_NAME=ISNULL(PARTY_NAME,''),TRTYPE,D.DPTYPE,D.CLTDPID,              
 D.DPID,CERTNO,QTY=CONVERT(NUMERIC(18,3),SUM(QTY)),BDPTYPE,BDPID,BCLTDPID,AMOUNT=ISNULL(AMOUNT,0),              
 ISETT_NO,ISETT_TYPE,FLAG=(CASE WHEN TRTYPE = 907 THEN 1 WHEN TRTYPE = 908 THEN 2 ELSE 3 END),              
 INEXC=0, PAYFLAG = ISNULL(A.PAYFLAG,0) FROM MFSS_DPMASTER M, DELTRANS D LEFT OUTER JOIN DELACCBALANCE A               
 ON ( A.CLTCODE = D.PARTY_CODE )               
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND TRTYPE <> 906              
 AND D.PARTY_CODE = M.PARTY_CODE AND M.DPID = D.DPID AND M.CLTDPID = D.CLTDPID AND M.DP_TYPE = D.DPTYPE              
 AND DELIVERED = '0' AND D.PARTY_CODE <> 'BROKER'               
 AND BDPTYPE = @DPTYPE AND BDPID = @DPID AND BCLTDPID = @CLTDPID AND DRCR = 'D' AND FILLER2 = 1               
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SCRIP_CD >= @FROMSCRIP AND D.SCRIP_CD <= @TOSCRIP AND TRTYPE IN (904,905)    
 AND EXISTS (SELECT PARTY_CODE FROM CLIENT2 C2, CLIENT1 C1     
      WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE     
      AND C1.BRANCH_CD = (CASE WHEN @BRANCHCODE = 'ALL' THEN C1.BRANCH_CD ELSE @BRANCHCODE END)    
      )    
 AND ISNULL(A.PAYFLAG,0) = 1    
 GROUP BY D.SCRIP_CD,D.SERIES,D.PARTY_CODE,PARTY_NAME,TRTYPE,D.CLTDPID,D.DPID,               
 CERTNO, BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,D.DPTYPE,PAYFLAG       
 ORDER BY FLAG,ISETT_NO,ISETT_TYPE,D.DPTYPE,D.PARTY_CODE,D.SCRIP_CD              
End    
Else    
Begin    
 SELECT D.SCRIP_CD,SERIES=D.SCRIP_CD,D.PARTY_CODE,LONG_NAME=ISNULL(PARTY_NAME,''),TRTYPE,D.DPTYPE,D.CLTDPID,              
 D.DPID,CERTNO,QTY=CONVERT(NUMERIC(18,3),SUM(QTY)),BDPTYPE,BDPID,BCLTDPID,AMOUNT=ISNULL(AMOUNT,0),              
 ISETT_NO,ISETT_TYPE,FLAG=(CASE WHEN TRTYPE = 907 THEN 1 WHEN TRTYPE = 908 THEN 2 ELSE 3 END),              
 INEXC=0, PAYFLAG = ISNULL(A.PAYFLAG,0) FROM MFSS_DPMASTER M, DELTRANS D LEFT OUTER JOIN DELACCBALANCE A               
 ON ( A.CLTCODE = D.PARTY_CODE )               
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND TRTYPE <> 906              
 AND D.PARTY_CODE = M.PARTY_CODE AND M.DPID = D.DPID AND M.CLTDPID = D.CLTDPID AND M.DP_TYPE = D.DPTYPE              
 AND DELIVERED = '0' AND D.PARTY_CODE <> 'BROKER'               
 AND BDPTYPE = @DPTYPE AND BDPID = @DPID AND BCLTDPID = @CLTDPID AND DRCR = 'D' AND FILLER2 = 1               
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SCRIP_CD >= @FROMSCRIP AND D.SCRIP_CD <= @TOSCRIP AND TRTYPE IN (904,905)    
 AND EXISTS (SELECT PARTY_CODE FROM CLIENT2 C2, CLIENT1 C1     
      WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE     
      AND C1.BRANCH_CD = (CASE WHEN @BRANCHCODE = 'ALL' THEN C1.BRANCH_CD ELSE @BRANCHCODE END)    
      )    
 GROUP BY D.SCRIP_CD,D.SERIES,D.PARTY_CODE,PARTY_NAME,TRTYPE,D.CLTDPID,D.DPID,               
 CERTNO, BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,D.DPTYPE,PAYFLAG       
 ORDER BY FLAG,ISETT_NO,ISETT_TYPE,D.DPTYPE,D.PARTY_CODE,D.SCRIP_CD              
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_BILL
-- --------------------------------------------------
CREATE   PROC [dbo].[RPT_MFSS_BILL]
	(
		@FROMDATE VARCHAR(11),
		@TODATE VARCHAR(11),
		@FROMPARTY VARCHAR(15),
		@TOPARTY VARCHAR(15),
		@FROMBRANCH VARCHAR(15),
		@TOBRANCH VARCHAR(15),
		@FROMSUBBROKER VARCHAR(15),
		@TOSUBBROKER VARCHAR(15),
		@STATUSID VARCHAR(15),
		@STATUSNAME VARCHAR(25)
	)
	
	AS

	IF LEN(@TOPARTY) = 0
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZ'
	END

	IF LEN(@TOBRANCH) = 0 
	BEGIN
		SET @TOBRANCH = 'ZZZZZZZZZZ'
	END

	IF LEN(@TOSUBBROKER) = 0 
	BEGIN
		SET @TOSUBBROKER = 'ZZZZZZZZZZ'
	END


	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SELECT
		PARTY_CODE = MS.PARTY_CODE,
		MC.PARTY_NAME,
		ADDR1,
		ADDR2,
		ADDR3,
		CITY,
		STATE,
		ZIP,
		PHONE = (CASE 
				WHEN OFFICE_PHONE <> '' THEN OFFICE_PHONE + ', '
				WHEN RES_PHONE <> '' THEN RES_PHONE
				ELSE ''
			END), 
		EMAIL_ID,
		PAN_NO,
		ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),
		SETT_NO = MS.SETT_NO,
		SETT_TYPE = MS.SETT_TYPE,
		MS.ORDER_NO,
		MS.ISIN,
		MS.SCRIP_CD,
		SEC_NAME = S.SCHEME_NAME + DBO.FN_SERIES_NAME(S.DIV_REINVEST_FLAG) ,
		SELL_BUY = (CASE WHEN SUB_RED_FLAG = 'P' THEN 'PURCHASE' ELSE 'REDEEM' END),
		CR_AMOUNT = (CASE WHEN SUB_RED_FLAG <> 'P' THEN SUM(AMOUNT) ELSE 0 END),
		DR_AMOUNT = (CASE WHEN SUB_RED_FLAG = 'P' THEN SUM(AMOUNT) ELSE 0 END),
		BROKERAGE = SUM(BROKERAGE),
		SERVICE_TAX = SUM(SERVICE_TAX),
		ORDDATE = CONVERT(VARCHAR,ORDER_DATE,112),
		QTY = SUM(QTY),
		NETAMOUNT = SUM(
		CASE WHEN SUB_RED_FLAG = 'P' 
			THEN (AMOUNT + BROKERAGE + SERVICE_TAX)
			ELSE (BROKERAGE - SERVICE_TAX)
		END),
		TODATE = REPLACE(CONVERT(VARCHAR,GETDATE(),103),'/',''),
		BILLNO = CONTRACTNO,
		FOLIONO		
	FROM
		MFSS_SETTLEMENT MS (NOLOCK),
		MFSS_CLIENT MC (NOLOCK),
		SETT_MST SM (NOLOCK),
		MFSS_SCRIP_MASTER S (NOLOCK)
	WHERE
		MS.PARTY_CODE = MC.PARTY_CODE
		AND S.SCRIP_CD = MS.SCRIP_CD
		AND MS.SETT_NO = SM.SETT_NO
		AND MS.SETT_TYPE = SM.SETT_TYPE
		AND MS.ORDER_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
		AND MS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND MC.BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
		AND MC.SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER
		AND @STATUSNAME = (         
		CASE         
			WHEN @STATUSID = 'BRANCH'
			THEN MC.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'
			THEN MC.SUB_BROKER
			WHEN @STATUSID = 'TRADER'
			THEN MC.TRADER
			WHEN @STATUSID = 'FAMILY'
			THEN MC.FAMILY
			WHEN @STATUSID = 'AREA'
			THEN MC.AREA
			WHEN @STATUSID = 'REGION'
			THEN MC.REGION
			WHEN @STATUSID = 'CLIENT'
			THEN MC.PARTY_CODE
			ELSE 'BROKER' 
		END)

	GROUP BY	
		MS.PARTY_CODE,
		MC.PARTY_NAME,
		ADDR1,
		ADDR2,
		ADDR3,
		CITY,
		STATE,
		ZIP,
		OFFICE_PHONE,
		RES_PHONE, 
		EMAIL_ID,
		PAN_NO,
		CONVERT(VARCHAR,ORDER_DATE,103),
		MS.SETT_NO,
		MS.SETT_TYPE,
		MS.SCRIP_CD,
		SUB_RED_FLAG,
		CONVERT(VARCHAR,ORDER_DATE,112),
		CONTRACTNO,S.SCHEME_NAME,
		MS.ORDER_NO,
		MS.ISIN, DIV_REINVEST_FLAG, FOLIONO	
	ORDER BY
		CONVERT(VARCHAR,ORDER_DATE,112),
		MS.PARTY_CODE,
		S.SCHEME_NAME,
		SUB_RED_FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_CONFIRMATION
-- --------------------------------------------------
CREATE   PROC [dbo].[RPT_MFSS_CONFIRMATION]
	(
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@FROMPARTY VARCHAR(15),
	@TOPARTY VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15),
	@FROMSUBBROKER VARCHAR(15),
	@TOSUBBROKER VARCHAR(15),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
	)
	
	AS

	IF LEN(@TOPARTY) = 0
	BEGIN
		SET @TOPARTY = 'zzzzzzzzzz'
	END

	IF LEN(@TOBRANCH) = 0 
	BEGIN
		SET @TOBRANCH = 'zzzzzzzzzz'
	END

	IF LEN(@TOSUBBROKER) = 0 
	BEGIN
		SET @TOSUBBROKER = 'zzzzzzzzzz'
	END



	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SELECT
		PARTY_CODE = MS.PARTY_CODE,
		MC.PARTY_NAME,
		ADDR1,
		ADDR2,
		ADDR3,
		CITY,
		STATE,
		ZIP,
		PHONE = (CASE 
				WHEN OFFICE_PHONE <> '' THEN OFFICE_PHONE + ', '
				WHEN RES_PHONE <> '' THEN RES_PHONE
				ELSE ''
			END), 
		EMAIL_ID,
		PAN_NO,
		ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),
		ORDER_TIME = CONVERT(VARCHAR,ORDER_TIME,108),	
		CONTRACTNO,
		ORDER_NO,
		SETT_NO = MS.SETT_NO,
		SETT_TYPE = MS.SETT_TYPE,
		S.SCRIP_CD,
		SEC_NAME = S.SCHEME_NAME + DBO.FN_SERIES_NAME(S.DIV_REINVEST_FLAG) ,
		SELL_BUY = (CASE WHEN SUB_RED_FLAG = 'P' THEN 'Pur.' ELSE 'Redm.' END),
		AMOUNT,
		BROKERAGE,
		SERVICE_TAX,
		ORDDATE = CONVERT(VARCHAR,ORDER_DATE,112),
		QTY = QTY,
		NETAMOUNT = (
		CASE WHEN SUB_RED_FLAG = 'P' 
			THEN (AMOUNT + BROKERAGE + SERVICE_TAX)
			ELSE (AMOUNT - BROKERAGE - SERVICE_TAX)
		END),
		TODATE = REPLACE(CONVERT(VARCHAR,GETDATE(),103),'/',''),
		FOLIONO
	FROM
		MFSS_SETTLEMENT MS (NOLOCK),
		MFSS_CLIENT MC (NOLOCK),
		SETT_MST SM (NOLOCK),
		MFSS_SCRIP_MASTER S (NOLOCK)
	WHERE
		MS.PARTY_CODE = MC.PARTY_CODE
		AND S.SCRIP_CD = MS.SCRIP_CD
		AND MS.SETT_NO = SM.SETT_NO
		AND MS.SETT_TYPE = SM.SETT_TYPE
		AND MS.ORDER_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
		AND MS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND MC.BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
		AND MC.SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER
		AND @STATUSNAME = (         
		CASE         
			WHEN @STATUSID = 'BRANCH'
			THEN MC.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'
			THEN MC.SUB_BROKER
			WHEN @STATUSID = 'TRADER'
			THEN MC.TRADER
			WHEN @STATUSID = 'FAMILY'
			THEN MC.FAMILY
			WHEN @STATUSID = 'AREA'
			THEN MC.AREA
			WHEN @STATUSID = 'REGION'
			THEN MC.REGION
			WHEN @STATUSID = 'CLIENT'
			THEN MC.PARTY_CODE
			ELSE 'BROKER' 
		END)

	ORDER BY
		CONVERT(VARCHAR,ORDER_DATE,112),
		MS.PARTY_CODE,
		CONTRACTNO,
		ORDER_NO,
		S.SCHEME_NAME,
		SUB_RED_FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_FUND_OBL_MATCH
-- --------------------------------------------------
  
CREATE PROC RPT_MFSS_FUND_OBL_MATCH  
(  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(30),  
 @SETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(2)  
)  
AS  
SELECT S.PARTY_CODE, C.PARTY_NAME, ORDER_DATE = CONVERT(VARCHAR,S.ORDER_DATE,103),   
S.ORDER_NO, S.SCRIP_CD, SEC_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG),  
S.ISIN, S.AMOUNT, EX_AMOUNT = ISNULL(O.AMOUNT, 0)  
FROM MFSS_CLIENT C, MFSS_SCRIP_MASTER M, MFSS_SETTLEMENT S  
FULL OUTER JOIN MFSS_FUNDS_OBLIGATION O  
ON   
 (  
  S.SETT_NO = O.SETT_NO AND S.SETT_TYPE = O.SETT_TYPE  
  AND S.PARTY_CODE = O.PARTY_CODE AND S.SCRIP_CD = O.SCRIP_CD AND S.SCRIP_CD = O.SCRIP_CD  
  AND S.ORDER_NO = O.ORDER_NO  
 )  
WHERE S.SETT_NO = @SETT_NO AND S.SETT_TYPE = @SETT_TYPE  
AND S.PARTY_CODE = C.PARTY_CODE  
AND SUB_RED_FLAG = 'P'  
AND S.SCRIP_CD = M.SCRIP_CD  
AND @STATUSNAME =               
                  (CASE               
                        WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD              
                        WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER              
                        WHEN @STATUSID = 'TRADER' THEN C.TRADER              
                        WHEN @STATUSID = 'FAMILY' THEN C.FAMILY              
                        WHEN @STATUSID = 'AREA' THEN C.AREA              
                        WHEN @STATUSID = 'REGION' THEN C.REGION              
                        WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE              
                  ELSE               
                        'BROKER'              
                  END)  
ORDER BY PARTY_CODE, M.SCHEME_NAME, S.SCRIP_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_NAVDATA
-- --------------------------------------------------
  
CREATE PROC RPT_MFSS_NAVDATA  
(  
 @NAV_DATE VARCHAR(11)  
)  
AS  
SELECT NAV_DATE = CONVERT(VARCHAR,NAV_DATE,103), SCRIP_CD,
SCHEME_NAME = SCHEME_NAME + DBO.FN_SERIES_NAME(DIV_REINVEST_FLAG),
RTA_SCHEME_CODE, RTA_CODE, ISIN, NAV_VALUE  
FROM MFSS_NAV  
WHERE NAV_DATE = @NAV_DATE + ' 23:59:59'  
ORDER BY 3, 1, 2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_ORDERCONFIRMATION
-- --------------------------------------------------
    
CREATE  PROC [dbo].[RPT_MFSS_ORDERCONFIRMATION]    
 (    
 @FROMDATE VARCHAR(11),    
 @TODATE VARCHAR(11),    
 @FROMPARTY VARCHAR(15),    
 @TOPARTY VARCHAR(15),    
 @FROMBRANCH VARCHAR(15),    
 @TOBRANCH VARCHAR(15),    
 @FROMSUBBROKER VARCHAR(15),    
 @TOSUBBROKER VARCHAR(15),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),    
 @RPT_TYPE INT = 1    
 )    
     
 AS    
    
 IF LEN(@TOPARTY) = 0    
 BEGIN    
  SET @TOPARTY = 'zzzzzzzzzz'    
 END    
    
 IF LEN(@TOBRANCH) = 0     
 BEGIN    
  SET @TOBRANCH = 'zzzzzzzzzz'    
 END    
    
 IF LEN(@TOSUBBROKER) = 0     
 BEGIN    
  SET @TOSUBBROKER = 'zzzzzzzzzz'    
 END    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 SELECT     
  PARTY_CODE = MS.PARTY_CODE,    
  PARTY_NAME = MC.PARTY_NAME,    
  ADDR1,    
  ADDR2,    
  ADDR3,    
  CITY,    
  STATE,    
  ZIP,    
  PHONE = (CASE     
    WHEN OFFICE_PHONE <> '' THEN OFFICE_PHONE + ', '    
    WHEN RES_PHONE <> '' THEN RES_PHONE    
    ELSE ''    
   END),     
  EMAIL_ID,    
  PAN_NO,    
  ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),    
  ORDER_TIME = CONVERT(VARCHAR,ORDER_TIME,108),     
  BILLNO = CONTRACTNO,    
  ORDER_NO,    
  SETT_NO = MS.SETT_NO,    
  SETT_TYPE = MS.SETT_TYPE,    
  SCRIP_CD = S.AMC_CODE + ' ' + '-' + MS.SCRIP_CD,    
  SCRIP_NAME =  S.SCHEME_NAME ,    
  SELL_BUY = SUB_RED_FLAG,    
  ORDDATE = CONVERT(VARCHAR,ORDER_DATE,112),    
  QTY,    
  PQTY  = (CASE WHEN SUB_RED_FLAG = 'P' THEN QTY ELSE 0 END),    
  SQTY  = (CASE WHEN SUB_RED_FLAG <> 'P' THEN QTY ELSE 0 END),    
  RATE  = (CASE WHEN (QTY)> 0 THEN  (AMOUNT)/(QTY) ELSE 0 END),    
  PRATE = (CASE WHEN SUB_RED_FLAG = 'P' AND (QTY)> 0 THEN (AMOUNT)/(QTY) ELSE 0 END),    
  SRATE = (CASE WHEN SUB_RED_FLAG <> 'P' AND (QTY)> 0  THEN (AMOUNT)/(QTY) ELSE 0 END),    
  AMOUNT,    
  PAMOUNT  = (CASE WHEN SUB_RED_FLAG = 'P' THEN (AMOUNT) ELSE 0 END),    
  SAMOUNT  = (CASE WHEN SUB_RED_FLAG <> 'P' THEN (AMOUNT) ELSE 0 END),    
  BROKERAGE,    
  PBROKERAGE  = (CASE WHEN SUB_RED_FLAG = 'P' THEN (BROKERAGE) ELSE 0 END),    
  SBROKERAGE  = (CASE WHEN SUB_RED_FLAG <> 'P' THEN (BROKERAGE) ELSE 0 END),    
  INS_CHRG,    
  TURN_TAX,    
  OTHER_CHRG,    
  SEBI_TAX,    
  BROKER_CHRG,    
  SERVICE_TAX,    
  NETAMOUNT = (    
  CASE WHEN SUB_RED_FLAG = 'P'     
   THEN (AMOUNT + BROKERAGE)    
   ELSE (AMOUNT - BROKERAGE)    
  END),    
  PNETAMOUNT = (    
  CASE WHEN SUB_RED_FLAG = 'P'     
   THEN (AMOUNT + BROKERAGE)    
   ELSE 0    
  END),    
  SNETAMOUNT = (    
  CASE WHEN SUB_RED_FLAG = 'P'     
   THEN 0    
   ELSE (AMOUNT - BROKERAGE)    
  END),    
  FOLIONO       
 FROM    
  MFSS_SETTLEMENT MS (NOLOCK),    
  MFSS_CLIENT MC (NOLOCK),    
  SETT_MST SM (NOLOCK),    
  MFSS_SCRIP_MASTER S (NOLOCK)    
 WHERE    
  MS.PARTY_CODE = MC.PARTY_CODE    
  AND S.SCRIP_CD = MS.SCRIP_CD    
  AND MS.SETT_NO = SM.SETT_NO    
  AND MS.SETT_TYPE = SM.SETT_TYPE    
  AND MS.ORDER_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'    
  AND MS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
  AND MC.BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH    
  AND MC.SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER    
  AND @STATUSNAME = (             
  CASE             
   WHEN @STATUSID = 'BRANCH'    
   THEN MC.BRANCH_CD    
   WHEN @STATUSID = 'SUBBROKER'    
   THEN MC.SUB_BROKER    
   WHEN @STATUSID = 'TRADER'    
   THEN MC.TRADER    
   WHEN @STATUSID = 'FAMILY'    
   THEN MC.FAMILY    
   WHEN @STATUSID = 'AREA'    
   THEN MC.AREA    
   WHEN @STATUSID = 'REGION'    
   THEN MC.REGION    
   WHEN @STATUSID = 'CLIENT'    
   THEN MC.PARTY_CODE    
   ELSE 'BROKER'     
  END)    
 ORDER BY    
  CONVERT(VARCHAR,ORDER_DATE,112),    
  MS.PARTY_CODE,    
  CONTRACTNO,    
  ORDER_NO,    
  S.SCHEME_NAME,    
  SUB_RED_FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_ORDERCONFIRMATION_Mailer
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_MFSS_ORDERCONFIRMATION_Mailer]        
 (        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @FROMPARTY VARCHAR(15),        
 @TOPARTY VARCHAR(15),        
 @FROMBRANCH VARCHAR(15),        
 @TOBRANCH VARCHAR(15),        
 @FROMSUBBROKER VARCHAR(15),        
 @TOSUBBROKER VARCHAR(15),        
 @STATUSID VARCHAR(15),        
 @STATUSNAME VARCHAR(25),        
 @RPT_TYPE INT = 1        
 )        
         
 AS        
        
 IF LEN(@TOPARTY) = 0        
 BEGIN        
  SET @TOPARTY = 'zzzzzzzzzz'        
 END        
        
 IF LEN(@TOBRANCH) = 0         
 BEGIN        
  SET @TOBRANCH = 'zzzzzzzzzz'        
 END        
        
 IF LEN(@TOSUBBROKER) = 0         
 BEGIN        
  SET @TOSUBBROKER = 'zzzzzzzzzz'        
 END        
        
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
 SELECT
 MS.PARTY_CODE,         
   IssuerName =  S.SCHEME_NAME,      
  SCRIP_NAME =  S.SCHEME_NAME ,   
  S.ISIN,       
   FOLIONO  ,  
  SELL_BUY =case when SUB_RED_FLAG='P' then 'PUR' else 'Redeem' end,                
  NAV=case when QTY>0 then Amount/QTY else 0 end,        
   AMOUNT,      
  QTY  
          
 FROM        
  MFSS_SETTLEMENT MS (NOLOCK),        
  MFSS_CLIENT MC (NOLOCK),        
  SETT_MST SM (NOLOCK),        
  MFSS_SCRIP_MASTER S (NOLOCK)  --where SCHEME_NAME like '%birla%su%'      
 WHERE        
  MS.PARTY_CODE = MC.PARTY_CODE        
  AND S.SCRIP_CD = MS.SCRIP_CD        
  AND MS.SETT_NO = SM.SETT_NO        
  AND MS.SETT_TYPE = SM.SETT_TYPE        
  AND MS.ORDER_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'        
  AND MS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND MC.BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH        
  AND MC.SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER        
  AND @STATUSNAME = (                 
  CASE                 
   WHEN @STATUSID = 'BRANCH'        
   THEN MC.BRANCH_CD        
   WHEN @STATUSID = 'SUBBROKER'        
   THEN MC.SUB_BROKER        
   WHEN @STATUSID = 'TRADER'        
   THEN MC.TRADER        
   WHEN @STATUSID = 'FAMILY'        
   THEN MC.FAMILY        
   WHEN @STATUSID = 'AREA'        
   THEN MC.AREA        
   WHEN @STATUSID = 'REGION'        
   THEN MC.REGION        
   WHEN @STATUSID = 'CLIENT'        
   THEN MC.PARTY_CODE        
   ELSE 'BROKER'         
  END)        
 ORDER BY        
  CONVERT(VARCHAR,ORDER_DATE,112),        
  MS.PARTY_CODE,        
  CONTRACTNO,        
  ORDER_NO,        
  S.SCHEME_NAME,        
  SUB_RED_FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_STATUSREPORT
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_MFSS_STATUSREPORT]      
 (      
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(30),  
 @FROMSETT_NO VARCHAR(7),  
 @TOSETT_NO VARCHAR(7),  
 @FROMPARTY VARCHAR(15),  
 @TOPARTY VARCHAR(15),  
 @SETT_TYPE VARCHAR(3),  
 @STATUS      VARCHAR(3)  
 )      
   
 AS      
  
 IF @TOSETT_NO = ''  
 BEGIN  
  SET @TOSETT_NO = '9999999'  
 END  
  
 IF @TOPARTY = ''  
 BEGIN  
  SET @TOPARTY = 'zzzzzzzzzz'  
 END  
 
  SELECT  * INTO #MFSS_ORDER FROM MFSS_ORDER 
  WHERE ORDER_NO NOT IN (SELECT ORDER_NO FROM MFSS_ORDER_STATUS)
      
 IF @STATUS = 'AC'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO,  
  DP_FOLIO = S.CLTDPID,       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Allotment Confirmation'        
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'A'  
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD    
 END      
       
       
 IF @STATUS = 'AR'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Allotment Rejection'    
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
     AND S.RECFLAG = 'N' AND S.RECFOR = 'A'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD     
 END      
       
       
 IF @STATUS = 'RC'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = S.CLTDPID,    
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Redeem Confirmation'       
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD    
 END      
       
       
 IF @STATUS = 'RR'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Purchase Rejection'  
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'N' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD    
 END   
  
 IF @STATUS = 'ALL'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO,  
  DP_FOLIO = S.CLTDPID,       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Allotment Confirmation'      
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'A'  
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY    
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)      
    
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Allotment Rejection'    
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
     AND S.RECFLAG = 'N' AND S.RECFOR = 'A'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)       
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = S.CLTDPID,       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Redeem Confirmation'      
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)      
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Purchase Rejection'  
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'N' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)   
  
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,S.ORDER_DATE,103), S.SETT_NO, S.SETTLEMENT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REJECT_REASON, FLAG = ''  
  FROM #MFSS_ORDER S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETTLEMENT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETTLEMENT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        --AND S.RECFLAG = 'N' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END) 
  
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, 8, S.SCRIP_CD    
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_STATUSREPORT_BAKMAR222017
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_MFSS_STATUSREPORT_BAKMAR222017]        
 (        
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(30),    
 @FROMSETT_NO VARCHAR(7),    
 @TOSETT_NO VARCHAR(7),    
 @FROMPARTY VARCHAR(15),    
 @TOPARTY VARCHAR(15),    
 @SETT_TYPE VARCHAR(3),    
 @STATUS      VARCHAR(3)    
 )        
     
 AS        
    
 IF @TOSETT_NO = ''    
 BEGIN    
  SET @TOSETT_NO = '9999999'    
 END    
    
 IF @TOPARTY = ''    
 BEGIN    
  SET @TOPARTY = 'zzzzzzzzzz'    
 END    
        
 IF @STATUS = 'AC'         
 BEGIN        
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO,    
  DP_FOLIO = S.CLTDPID,         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,        
  s.REMARK, FLAG = 'Allotment Confirmation'          
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'A'    
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
   (CASE                     
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
    WHEN @STATUSID = 'AREA' THEN C.AREA                    
    WHEN @STATUSID = 'REGION' THEN C.REGION                    
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
   ELSE                     
   'BROKER'                    
   END)        
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD      
 END        
         
         
 IF @STATUS = 'AR'         
 BEGIN        
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO, DP_FOLIO = '-',         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,        
  S.REMARK, FLAG = 'Allotment Rejection'      
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
     AND S.RECFLAG = 'N' AND S.RECFOR = 'A'       
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
   (CASE                     
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
    WHEN @STATUSID = 'AREA' THEN C.AREA                    
    WHEN @STATUSID = 'REGION' THEN C.REGION                    
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
   ELSE                     
   'BROKER'                    
   END)        
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD       
 END        
         
         
 IF @STATUS = 'RC'         
 BEGIN        
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO, DP_FOLIO = S.CLTDPID,      
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,        
  s.REMARK, FLAG = 'Redeem Confirmation'         
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'R'       
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
  (CASE                     
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
   WHEN @STATUSID = 'AREA' THEN C.AREA                    
   WHEN @STATUSID = 'REGION' THEN C.REGION                    
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
  ELSE                     
   'BROKER'                    
  END)        
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD      
 END        
         
         
 IF @STATUS = 'RR'         
 BEGIN        
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO, DP_FOLIO = '-',         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,        
  S.REMARK, FLAG = 'Redeem Rejection'    
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
        AND S.RECFLAG = 'N' AND S.RECFOR = 'R'       
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
  (CASE                     
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
   WHEN @STATUSID = 'AREA' THEN C.AREA                    
   WHEN @STATUSID = 'REGION' THEN C.REGION                    
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
  ELSE                     
   'BROKER'                    
  END)        
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD      
 END     
    
 IF @STATUS = 'ALL'         
 BEGIN        
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO,    
  DP_FOLIO = S.CLTDPID,         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,        
  s.REMARK, FLAG = 'Allotment Confirmation'        
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE          AND S.SCRIP_CD = M.SCRIP_CD    
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'A'    
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
   (CASE                     
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY      
    WHEN @STATUSID = 'AREA' THEN C.AREA                    
    WHEN @STATUSID = 'REGION' THEN C.REGION                    
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
   ELSE                     
   'BROKER'                    
   END)        
      
  UNION ALL    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO, DP_FOLIO = '-',         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,        
  S.REMARK, FLAG = 'Allotment Rejection'      
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
     AND S.RECFLAG = 'N' AND S.RECFOR = 'A'       
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
   (CASE                     
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
    WHEN @STATUSID = 'AREA' THEN C.AREA                    
    WHEN @STATUSID = 'REGION' THEN C.REGION                    
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
   ELSE                     
   'BROKER'                    
   END)         
  UNION ALL    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO, DP_FOLIO = S.CLTDPID,         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,        
  s.REMARK, FLAG = 'Redeem Confirmation'        
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'R'       
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
  (CASE                     
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
   WHEN @STATUSID = 'AREA' THEN C.AREA                    
   WHEN @STATUSID = 'REGION' THEN C.REGION                    
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
  ELSE                     
   'BROKER'                    
  END)        
  UNION ALL    
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,         
  S.PARTY_CODE, C.PARTY_NAME,         
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),         
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,         
  FOLIONO = FOLIONO, DP_FOLIO = '-',         
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,        
  S.REMARK, FLAG = 'Redeem Rejection'    
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C        
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO    
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)    
  AND S.PARTY_CODE = C.PARTY_CODE        
  AND S.SCRIP_CD = M.SCRIP_CD    
        AND S.RECFLAG = 'N' AND S.RECFOR = 'R'       
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY        
  AND @STATUSNAME =                     
  (CASE                     
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                    
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                    
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                    
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                    
   WHEN @STATUSID = 'AREA' THEN C.AREA                    
   WHEN @STATUSID = 'REGION' THEN C.REGION                    
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                    
  ELSE                     
   'BROKER'                    
  END)     
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, 8, S.SCRIP_CD      
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_STATUSREPORT_BAKORIMAR232017
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_MFSS_STATUSREPORT]      
 (      
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(30),  
 @FROMSETT_NO VARCHAR(7),  
 @TOSETT_NO VARCHAR(7),  
 @FROMPARTY VARCHAR(15),  
 @TOPARTY VARCHAR(15),  
 @SETT_TYPE VARCHAR(3),  
 @STATUS      VARCHAR(3)  
 )      
   
 AS      
  
 IF @TOSETT_NO = ''  
 BEGIN  
  SET @TOSETT_NO = '9999999'  
 END  
  
 IF @TOPARTY = ''  
 BEGIN  
  SET @TOPARTY = 'zzzzzzzzzz'  
 END  
      
 IF @STATUS = 'AC'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO,  
  DP_FOLIO = S.CLTDPID,       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Allotment Confirmation'        
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'A'  
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD    
 END      
       
       
 IF @STATUS = 'AR'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Allotment Rejection'    
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
     AND S.RECFLAG = 'N' AND S.RECFOR = 'A'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD     
 END      
       
       
 IF @STATUS = 'RC'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = S.CLTDPID,    
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Redeem Confirmation'       
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD    
 END      
       
       
 IF @STATUS = 'RR'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Redeem Rejection'  
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'N' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)      
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, M.SCHEME_NAME, S.SCRIP_CD    
 END   
  
 IF @STATUS = 'ALL'       
 BEGIN      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO,  
  DP_FOLIO = S.CLTDPID,       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Allotment Confirmation'      
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'A'  
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY    
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)      
    
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Allotment Rejection'    
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
     AND S.RECFLAG = 'N' AND S.RECFOR = 'A'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
   (CASE                   
    WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
    WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
    WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
    WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
    WHEN @STATUSID = 'AREA' THEN C.AREA                  
    WHEN @STATUSID = 'REGION' THEN C.REGION                  
    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
   ELSE                   
   'BROKER'                  
   END)       
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = S.CLTDPID,       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = QTY_ALLOTED, ALLOT_AMT = AMOUNT_ALLOTED, NAV_VALUE_ALLOTED,      
  s.REMARK, FLAG = 'Redeem Confirmation'      
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'Y' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)      
  UNION ALL  
  SELECT REPORT_DATE = CONVERT(VARCHAR,REPORTDATE,103), SETT_NO, SETT_TYPE,       
  S.PARTY_CODE, C.PARTY_NAME,       
  ORDER_NO, ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),       
  SCHEME_NAME = M.SCHEME_NAME + DBO.FN_SERIES_NAME(M.DIV_REINVEST_FLAG), S.SCRIP_CD, S.ISIN,       
  FOLIONO = FOLIONO, DP_FOLIO = '-',       
  ORDQTY = QTY, ORDAMT = AMOUNT, ALLOT_QTY = 0, ALLOT_AMT = 0, NAV_VALUE_ALLOTED=0,      
  S.REMARK, FLAG = 'Redeem Rejection'  
  FROM MFSS_ORDER_STATUS S, MFSS_SCRIP_MASTER M, MFSS_CLIENT C      
  WHERE S.SETT_NO BETWEEN @FROMSETT_NO AND @TOSETT_NO  
  AND S.SETT_TYPE = (case WHEN @SETT_TYPE = 'ALL' THEN S.SETT_TYPE ELSE @SETT_TYPE END)  
  AND S.PARTY_CODE = C.PARTY_CODE      
  AND S.SCRIP_CD = M.SCRIP_CD  
        AND S.RECFLAG = 'N' AND S.RECFOR = 'R'     
  AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  AND @STATUSNAME =                   
  (CASE                   
   WHEN @STATUSID = 'BRANCH' THEN C.BRANCH_CD                  
   WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER                  
   WHEN @STATUSID = 'TRADER' THEN C.TRADER                  
   WHEN @STATUSID = 'FAMILY' THEN C.FAMILY                  
   WHEN @STATUSID = 'AREA' THEN C.AREA                  
   WHEN @STATUSID = 'REGION' THEN C.REGION                  
   WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE                  
  ELSE                   
   'BROKER'                  
  END)   
  ORDER BY S.PARTY_CODE, C.PARTY_NAME, 8, S.SCRIP_CD    
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_TRADEBOOK
-- --------------------------------------------------
 --EXEC RPT_MFSS_TRADEBOOK 'Aug 26 2015','Aug 26 2015','','B32429','','','','','VALID','broker','broker' 

CREATE   PROC [dbo].[RPT_MFSS_TRADEBOOK]  
 (  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @FROMPARTY VARCHAR(15),  
 @TOPARTY VARCHAR(15),  
 @FROMBRANCH VARCHAR(15),  
 @TOBRANCH VARCHAR(15),  
 @FROMSUBBROKER VARCHAR(15),  
 @TOSUBBROKER VARCHAR(15),  
 @CONF_FLAG VARCHAR(10),  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25)  
 )  
   
 AS  
  
 IF LEN(@TOPARTY) = 0 
 
 
 BEGIN  
  SET @TOPARTY = 'zzzzzzzzzz'  
 END  
  
 IF LEN(@TOBRANCH) = 0   
 BEGIN  
  SET @TOBRANCH = 'zzzzzzzzzz'  
 END  
  
 IF LEN(@TOSUBBROKER) = 0   
 BEGIN  
  SET @TOSUBBROKER = 'zzzzzzzzzz'  
 END  
  
   
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
 SELECT  
  PARTY_CODE = MS.PARTY_CODE,  
  MC.PARTY_NAME,  
  ADDR1,  
  ADDR2,  
  ADDR3,  
  CITY,  
  STATE,  
  ZIP,  
  PHONE = (CASE   
    WHEN OFFICE_PHONE <> '' THEN OFFICE_PHONE + ', '  
    WHEN RES_PHONE <> '' THEN RES_PHONE  
    ELSE ''  
    END),   
  EMAIL_ID = MC.EMAIL_ID,  
  PAN_NO,  
  ORDER_NO,  
  SETT_NO = MS.SETT_NO,  
  SETT_TYPE = SM.SETT_TYPE,  
  SELL_BUY = (CASE   
    WHEN SUB_RED_FLAG = 'P' THEN 'Purchase'   
    ELSE 'Redeem'   
    END),  
  ALLOTMENT_MODE,  
  ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),  
  ORDER_TIME = CONVERT(VARCHAR,ORDER_TIME,108),  
  S.SCRIP_CD,  
  SERIES=S.SCHEME_NAME + DBO.FN_SERIES_NAME(S.DIV_REINVEST_FLAG),  
  QTY,  
  AMOUNT,  
  CONF_FLAG,  
  REJECT_REASON,  
  NAV_VALUE_ALLOTED,  
  AMOUNT_ALLOTED,  
  ORDDATE = CONVERT(VARCHAR,ORDER_DATE,112),  
  TODATE = REPLACE(CONVERT(VARCHAR,GETDATE(),103),'/',''),  
  FOLIONO  
 FROM  
  MFSS_ORDER MS (NOLOCK),  
  MFSS_CLIENT MC (NOLOCK),  
  SETT_MST SM (NOLOCK),  
  MFSS_SCRIP_MASTER S (NOLOCK)  
 WHERE  
  MS.PARTY_CODE = MC.PARTY_CODE  
  AND MS.SETT_NO = SM.SETT_NO 
  AND MS.SETTLEMENT_TYPE = SM.SETT_TYPE 
  AND S.SCRIP_CD = MS.SCRIP_CD  
  AND MS.ORDER_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'  
  AND MS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
  AND MC.BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH  
  AND MC.SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER  
  AND CONF_FLAG BETWEEN @CONF_FLAG AND @CONF_FLAG  
  AND @STATUSNAME = (           
  CASE           
   WHEN @STATUSID = 'BRANCH'  
   THEN MC.BRANCH_CD  
   WHEN @STATUSID = 'SUBBROKER'  
   THEN MC.SUB_BROKER  
   WHEN @STATUSID = 'TRADER'  
   THEN MC.TRADER  
   WHEN @STATUSID = 'FAMILY'  
   THEN MC.FAMILY  
   WHEN @STATUSID = 'AREA'  
   THEN MC.AREA  
   WHEN @STATUSID = 'REGION'  
   THEN MC.REGION  
   WHEN @STATUSID = 'CLIENT'  
   THEN MC.PARTY_CODE  
   ELSE 'BROKER'   
  END)  
  
 ORDER BY  
  CONVERT(VARCHAR,ORDER_DATE,112),  
  MS.PARTY_CODE,  
  ORDER_NO,  
  SCRIP_CD,  
  SUB_RED_FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MFSS_TRADEBOOK_1
-- --------------------------------------------------
 --EXEC RPT_MFSS_TRADEBOOK 'Aug 26 2015','Aug 26 2015','','B32429','','','','','VALID','broker','broker'   
  
CREATE   PROC [dbo].[RPT_MFSS_TRADEBOOK_1]    
 (    
 @FROMDATE VARCHAR(11),    
 @TODATE VARCHAR(11),    
 @FROMPARTY VARCHAR(15),    
 @TOPARTY VARCHAR(15),    
 @FROMBRANCH VARCHAR(15),    
 @TOBRANCH VARCHAR(15),    
 @FROMSUBBROKER VARCHAR(15),    
 @TOSUBBROKER VARCHAR(15),    
 @CONF_FLAG VARCHAR(10),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25)    
 )    
     
 AS    
    
 --IF LEN(@TOPARTY) = 0   
   
   
 --BEGIN    
 -- SET @TOPARTY = 'zzzzzzzzzz'    
 --END    
 
  BEGIN    
  SET @FROMPARTY = @TOPARTY   
 END
    
 IF LEN(@TOBRANCH) = 0     
 BEGIN    
  SET @TOBRANCH = 'zzzzzzzzzz'    
 END    
    
 IF LEN(@TOSUBBROKER) = 0     
 BEGIN    
  SET @TOSUBBROKER = 'zzzzzzzzzz'    
 END    
    
     
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 SELECT    
  PARTY_CODE = MS.PARTY_CODE,    
  MC.PARTY_NAME,    
  ADDR1,    
  ADDR2,    
  ADDR3,    
  CITY,    
  STATE,    
  ZIP,    
  PHONE = (CASE     
    WHEN OFFICE_PHONE <> '' THEN OFFICE_PHONE + ', '    
    WHEN RES_PHONE <> '' THEN RES_PHONE    
    ELSE ''    
    END),     
  EMAIL_ID = MC.EMAIL_ID,    
  PAN_NO,    
  ORDER_NO,    
  SETT_NO = MS.SETT_NO,    
  SETT_TYPE = SM.SETT_TYPE,    
  SELL_BUY = (CASE     
    WHEN SUB_RED_FLAG = 'P' THEN 'Purchase'     
    ELSE 'Redeem'     
    END),    
  ALLOTMENT_MODE,    
  ORDER_DATE = CONVERT(VARCHAR,ORDER_DATE,103),    
  ORDER_TIME = CONVERT(VARCHAR,ORDER_TIME,108),    
  S.SCRIP_CD,    
  SERIES=S.SCHEME_NAME + DBO.FN_SERIES_NAME(S.DIV_REINVEST_FLAG),    
  QTY,    
  AMOUNT,    
  CONF_FLAG,    
  REJECT_REASON,    
  NAV_VALUE_ALLOTED,    
  AMOUNT_ALLOTED,    
  ORDDATE = CONVERT(VARCHAR,ORDER_DATE,112),    
  TODATE = REPLACE(CONVERT(VARCHAR,GETDATE(),103),'/',''),    
  FOLIONO    
 FROM    
  MFSS_ORDER MS (NOLOCK),    
  MFSS_CLIENT MC (NOLOCK),    
  SETT_MST SM (NOLOCK),    
  MFSS_SCRIP_MASTER S (NOLOCK)    
 WHERE    
  MS.PARTY_CODE = MC.PARTY_CODE    
  AND MS.SETT_NO = SM.SETT_NO   
  AND MS.SETTLEMENT_TYPE = SM.SETT_TYPE   
  AND S.SCRIP_CD = MS.SCRIP_CD    
  AND MS.ORDER_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'    
  AND MS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
  AND MC.BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH    
  AND MC.SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER    
  AND CONF_FLAG BETWEEN @CONF_FLAG AND @CONF_FLAG    
  AND @STATUSNAME = (             
  CASE             
   WHEN @STATUSID = 'BRANCH'    
   THEN MC.BRANCH_CD    
   WHEN @STATUSID = 'SUBBROKER'    
   THEN MC.SUB_BROKER    
   WHEN @STATUSID = 'TRADER'    
   THEN MC.TRADER    
   WHEN @STATUSID = 'FAMILY'    
   THEN MC.FAMILY    
   WHEN @STATUSID = 'AREA'    
   THEN MC.AREA    
   WHEN @STATUSID = 'REGION'    
   THEN MC.REGION    
   WHEN @STATUSID = 'CLIENT'    
   THEN MC.PARTY_CODE    
   ELSE 'BROKER'     
  END)    
    
 ORDER BY    
  CONVERT(VARCHAR,ORDER_DATE,112),    
  MS.PARTY_CODE,    
  ORDER_NO,    
  SCRIP_CD,    
  SUB_RED_FLAG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TBL_XSIP_REGSTR
-- --------------------------------------------------



CREATE PROC RPT_TBL_XSIP_REGSTR
(
 @STATUSID VARCHAR(50),      
 @STATUSNAME VARCHAR(50),      
 @FROMDATE VARCHAR(11),      
 @TODATE  VARCHAR(11),      
 @FROMPARTY VARCHAR(10),      
 @TOPARTY VARCHAR(10),      
 @FROMSCRIP VARCHAR(12)='',      
 @TOSCRIP VARCHAR(12)='',      
 @OPT VARCHAR(20)=''    
)     
AS

SELECT T.PARTY_CODE,T.PARTY_NAME,REC_STATUS,INT_REF_NO,XSIP_REGN_NO,XSIP_REGN_DATE = CONVERT(VARCHAR,XSIP_REGN_DATE,103),
AMC_NAME,RTA_SCHEME_CODE,SCHEME_NAME,FERQ_TYPE,
START_DATE=CONVERT(VARCHAR,START_DATE,103),
END_DATE=CONVERT(VARCHAR,END_DATE,103),
INSTALL_AMT,BROKERAGE,ENTRY_BY,BSE_MANDATE_ID 
FROM TBL_XSIP_REGSTR T, MFSS_CLIENT C
WHERE T.PARTY_CODE = C.PARTY_CODE
And @StatusName =           
                  (case           
                        when @StatusId = 'BRANCH' then C.branch_cd          
                        when @StatusId = 'SUBBROKER' then C.sub_broker          
                        when @StatusId = 'Trader' then C.Trader          
                        when @StatusId = 'Family' then C.Family          
                        when @StatusId = 'Area' then C.Area          
                        when @StatusId = 'Region' then C.Region          
                        when @StatusId = 'Client' then C.party_code          
                  else           
                        'BROKER'          
                  End)  
ORDER BY T.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[RPT_UCCFILEGENERATION]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@PARTYFROM VARCHAR(10),
	@PARTYTO VARCHAR(10),
	@BRANCHFROM VARCHAR(10),
	@BRANCHTO VARCHAR(10),
	@CLTYPE VARCHAR(3),
	@OPTIONVAL VARCHAR(2)
)

	AS

	--EXEC RPT_UCCFILEGENERATION 'JAN  1 2010','DEC 31 2012','','ZZZZZZ','','ZZZZZZ','','A'


	CREATE TABLE #CLIENTLIST  
	(PARTY_CODE VARCHAR(10))  

	CREATE INDEX [INDXCL2] ON #CLIENTLIST ([PARTY_CODE])
	
	/*-----------------------------------------------------------------------------  
	FETCHING TRADED CLIENT LIST TO #CLIENTLIS  
	-----------------------------------------------------------------------------*/  
  
	IF @OPTIONVAL = 'T'  
	BEGIN  
		INSERT INTO #CLIENTLIST  
		SELECT  
			DISTINCT PARTY_CODE  
		FROM 
			MFSS_SETTLEMENT (NOLOCK)  
		WHERE  
			ORDER_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
			--AND TRADETYPE NOT IN ( 'SCF','ICF','IR' )  
	END
	ELSE IF @OPTIONVAL = 'M'
	BEGIN
		INSERT INTO #CLIENTLIST  
		SELECT  
			PARTY_CODE  
		FROM  
			MFSS_CLIENT_LOG M
		WHERE
			PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
			AND BRANCH_CD BETWEEN @BRANCHFROM AND @BRANCHTO
			AND CL_TYPE = CASE WHEN @CLTYPE ='' THEN CL_TYPE ELSE @CLTYPE END 
			AND EDITEDON BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			AND ADDEDON <> EDITEDON
	END
	ELSE  
	BEGIN  
		INSERT INTO #CLIENTLIST  
		SELECT  
			PARTY_CODE  
		FROM  
			MFSS_CLIENT (NOLOCK)
		WHERE  
			PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
	END
	
	
	SELECT
		PARTY_CODE,
		MODE_HOLDING,
		TAX_STATUS = '0'+ CONVERT(VARCHAR,TAX_STATUS),
		OCCUPATION_CODE ='0' + CONVERT(VARCHAR,OCCUPATION_CODE),
		APPNAME1 = LEFT(PARTY_NAME,70),
		APPNAME2 = LEFT(HOLDER2_NAME,35),
		APPNAME3 = LEFT(HOLDER3_NAME,35),
		DOB = CASE WHEN DOB ='' THEN '' ELSE CONVERT(VARCHAR,DOB,103) END,
		GENDER,
		GAURDIAN_NAME = LEFT(GAURDIAN_NAME,35),
		PAN_NO,
		NOMINEE_NAME = LEFT(NOMINEE_NAME,35),
		NOMINEE_RELATION = LEFT(NOMINEE_RELATION,20),
		GAURDIAN_PAN_NO = LEFT(GAURDIAN_PAN_NO,10),
		DP_TYPE,
		CDSLDPID = CASE WHEN DP_TYPE ='CDSL' THEN DPID ELSE '' END,
		CDSLCLTID = CASE WHEN DP_TYPE ='CDSL' THEN CLTDPID ELSE '' END,
		NSDLDPID = CASE WHEN DP_TYPE ='NSDL' THEN DPID ELSE '' END,
		NSDLCLTID = CASE WHEN DP_TYPE ='NSDL' THEN CLTDPID ELSE '' END,
		BANK_NAME = LEFT(BANK_NAME,40),
		BANK_BRANCH = LEFT(BANK_BRANCH,40),
		BANK_CITY = LEFT(BANK_CITY,35),
		BANK_AC_TYPE,
		ACC_NO = LEFT(ACC_NO,16),
		MICR_NO = LEFT(MICR_NO,9),
		NEFTCODE = LEFT(NEFTCODE,11),
		CHEQUENAME = LEFT(CHEQUENAME,35),
		ADDR1 = LEFT(ADDR1,40),
		ADDR2 = LEFT(ADDR2,40),
		ADDR3 = LEFT(ADDR3,40),
		CITY = LEFT(CITY,35),
		STATE_CODE,
		ZIP = LEFT(ZIP,6),
		NATION = LEFT(NATION,35),
		RES_PHONE = LEFT(RES_PHONE,15),
		RESIFAX = LEFT(RESIFAX,15),
		OFFICE_PHONE = LEFT(OFFICE_PHONE,15),
		OFFICEFAX = LEFT(OFFICEFAX,15),
		EMAIL_ID = LEFT(EMAIL_ID,50),
		STAT_COMM_MODE,
		PAYMODE = '0' + CONVERT(VARCHAR,PAYMODE),
		HOLDER2_PAN_NO = LEFT(HOLDER2_PAN_NO,10),
		HOLDER3_PAN_NO = LEFT(HOLDER3_PAN_NO,10),
		MAPINID = LEFT(MAPINID,16),
		CM_FORADD1 = LEFT(ISNULL(CM_FORADD1,''),40),
		CM_FORADD2 = LEFT(ISNULL(CM_FORADD2,''),40),
		CM_FORADD3 = LEFT(ISNULL(CM_FORADD3,''),40),
		CM_FORCITY = LEFT(ISNULL(CM_FORCITY,''),35),
		CM_FORPINCODE = LEFT(ISNULL(CM_FORPINCODE,''),10),
		CM_FORSTATE = LEFT(ISNULL(CM_FORPINCODE,''),35),
		CM_FORCOUNTRY = LEFT(ISNULL(CM_FORCOUNTRY,''),3),
		CM_FORRESIPHONE = LEFT(ISNULL(CM_FORRESIPHONE,''),15),
		CM_FORRESIFAX = LEFT(ISNULL(CM_FORRESIFAX,''),15),
		CM_FOROFFPHONE = LEFT(ISNULL(CM_FOROFFPHONE,''),15),
		CM_FOROFFFAX = LEFT(ISNULL(CM_FOROFFFAX,''),15)
	FROM 
		MFSS_CLIENT (NOLOCK), STATE_MASTER (NOLOCK)
	WHERE 
		MFSS_CLIENT.STATE = STATE_MASTER.STATE
		AND ADDEDON BETWEEN @DATEFROM AND @DATETO + ' 23:59'
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND BRANCH_CD BETWEEN @BRANCHFROM AND @BRANCHTO
		AND CL_TYPE = CASE WHEN @CLTYPE ='' THEN CL_TYPE ELSE @CLTYPE END 
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #CLIENTLIST WHERE #CLIENTLIST.PARTY_CODE = MFSS_CLIENT.PARTY_CODE)
		AND ADDEDON BETWEEN   
			CASE WHEN @OPTIONVAL = 'A' THEN @DATEFROM ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'A' THEN @DATETO + ' 23:59' ELSE 'DEC 31 2049 23:59' END  
		AND ACTIVE_FROM BETWEEN  
			CASE WHEN @OPTIONVAL = 'S' THEN @DATEFROM ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'S' THEN @DATETO + ' 23:59' ELSE 'DEC 31 2049 23:59' END
		AND INACTIVE_FROM NOT BETWEEN  
			CASE WHEN @OPTIONVAL = 'S' THEN @DATEFROM ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'S' THEN @DATETO + ' 23:59' ELSE '' END  
		AND INACTIVE_FROM BETWEEN  
			CASE WHEN @OPTIONVAL = 'I' THEN @DATEFROM ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'I' THEN @DATETO + ' 23:59' ELSE 'DEC 31 2049 23:59' END
	ORDER BY
		PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION_30052016
-- --------------------------------------------------
CREATE PROCEDURE RPT_UCCFILEGENERATION_30052016
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@PARTYFROM VARCHAR(10),
	@PARTYTO VARCHAR(10),
	@BRANCHFROM VARCHAR(10),
	@BRANCHTO VARCHAR(10),
	@CLTYPE VARCHAR(3)
)
AS

SELECT
	PARTY_CODE,
	MODE_HOLDING,
	TAX_STATUS = '0'+ CONVERT(VARCHAR,TAX_STATUS),
	OCCUPATION_CODE ='0' + CONVERT(VARCHAR,OCCUPATION_CODE),
	APPNAME1 = LEFT(PARTY_NAME,70),
	APPNAME2 = LEFT(HOLDER2_NAME,35),
	APPNAME3 = LEFT(HOLDER3_NAME,35),
	DOB = CASE WHEN DOB ='' THEN '' ELSE CONVERT(VARCHAR,DOB,103) END,
	GENDER,
	GAURDIAN_NAME = LEFT(GAURDIAN_NAME,35),
	PAN_NO,
	NOMINEE_NAME = LEFT(NOMINEE_NAME,35),
	NOMINEE_RELATION = LEFT(NOMINEE_RELATION,20),
	GAURDIAN_PAN_NO = LEFT(GAURDIAN_PAN_NO,10),
	DP_TYPE,
	CDSLDPID = CASE WHEN DP_TYPE ='CDSL' THEN DPID ELSE '' END,
	CDSLCLTID = CASE WHEN DP_TYPE ='CDSL' THEN CLTDPID ELSE '' END,
	NSDLDPID = CASE WHEN DP_TYPE ='NSDL' THEN DPID ELSE '' END,
	NSDLCLTID = CASE WHEN DP_TYPE ='NSDL' THEN CLTDPID ELSE '' END,
	BANK_NAME = LEFT(BANK_NAME,40),
	BANK_BRANCH = LEFT(BANK_BRANCH,40),
	BANK_CITY = LEFT(BANK_CITY,35),
	BANK_AC_TYPE,
	ACC_NO = LEFT(ACC_NO,16),
	MICR_NO = LEFT(MICR_NO,9),
	NEFTCODE = LEFT(NEFTCODE,11),
	CHEQUENAME = LEFT(CHEQUENAME,35),
	ADDR1 = LEFT(ADDR1,40),
	ADDR2 = LEFT(ADDR2,40),
	ADDR3 = LEFT(ADDR3,40),
	CITY = LEFT(CITY,35),
	STATE_CODE,
	ZIP = LEFT(ZIP,6),
	NATION = LEFT(NATION,35),
	RES_PHONE = LEFT(RES_PHONE,15),
	RESIFAX = LEFT(RESIFAX,15),
	OFFICE_PHONE = LEFT(OFFICE_PHONE,15),
	OFFICEFAX = LEFT(OFFICEFAX,15),
	EMAIL_ID = LEFT(EMAIL_ID,50),
	STAT_COMM_MODE,
	PAYMODE = '0' + CONVERT(VARCHAR,PAYMODE),
	HOLDER2_PAN_NO = LEFT(HOLDER2_PAN_NO,10),
	HOLDER3_PAN_NO = LEFT(HOLDER3_PAN_NO,10),
	MAPINID = LEFT(MAPINID,16)
FROM 
	MFSS_CLIENT (NOLOCK), STATE_MASTER (NOLOCK)
WHERE 
	MFSS_CLIENT.STATE = STATE_MASTER.STATE
	AND ADDEDON BETWEEN @DATEFROM AND @DATETO + ' 23:59'
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
	AND BRANCH_CD BETWEEN @BRANCHFROM AND @BRANCHTO
	AND CL_TYPE = CASE WHEN @CLTYPE ='' THEN CL_TYPE ELSE @CLTYPE END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Searchinall
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Searchinall]       
(@strFind AS VARCHAR(MAX))
AS
BEGIN
    SET NOCOUNT ON; 
    --TO FIND STRING IN ALL PROCEDURES        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) SP_Name
              ,OBJECT_DEFINITION(OBJECT_ID) SP_Definition
        FROM   sys.procedures
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@strFind+'%'
    END 

    --TO FIND STRING IN ALL VIEWS        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) View_Name
              ,OBJECT_DEFINITION(OBJECT_ID) View_Definition
        FROM   sys.views
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@strFind+'%'
    END 

    --TO FIND STRING IN ALL FUNCTION        
    BEGIN
        SELECT ROUTINE_NAME           Function_Name
              ,ROUTINE_DEFINITION     Function_definition
        FROM   INFORMATION_SCHEMA.ROUTINES
        WHERE  ROUTINE_DEFINITION LIKE '%'+@strFind+'%'
               AND ROUTINE_TYPE = 'FUNCTION'
        ORDER BY
               ROUTINE_NAME
    END

    --TO FIND STRING IN ALL TABLES OF DATABASE.    
    BEGIN
        SELECT t.name      AS Table_Name
              ,c.name      AS COLUMN_NAME
        FROM   sys.tables  AS t
               INNER JOIN sys.columns c
                    ON  t.OBJECT_ID = c.OBJECT_ID
        WHERE  c.name LIKE '%'+@strFind+'%'
        ORDER BY
               Table_Name
    END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
CREATE PROC SP @spName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDBRANCH_EXECUTE
-- --------------------------------------------------
CREATE PROC SP_ADDBRANCH_EXECUTE    
@STRSQL VARCHAR(8000)    
AS    
PRINT @STRSQL    
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDCLIENT_EXECUTE
-- --------------------------------------------------
CREATE PROC SP_ADDCLIENT_EXECUTE    
@STRSQL VARCHAR(8000)    
AS    
PRINT @STRSQL    
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDEDITSCRIP_EXECUTE
-- --------------------------------------------------
-- Alter this sp under SRE-34143
CREATE PROC [dbo].[SP_ADDEDITSCRIP_EXECUTE]  
@STRSQL VARCHAR(8000)  
AS  
SET NOCOUNT ON;
PRINT @STRSQL  
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_BSEPush_ErrorLog
-- --------------------------------------------------

-- =============================================
-- Author:		<sonu prajapati>
-- Create date: <08 march 2023>
-- Description:	<BSE push log>
--exec sp_BSEPush_ErrorLog 'Z5005','',0,'','PHY'
-- =============================================
CREATE PROCEDURE [dbo].[sp_BSEPush_ErrorLog]
	@Clientcode varchar(20),
	@Param varchar(max),
	@Status char(1),
	@Error_messages varchar(200),
	@DP_Type varchar(10)

AS
BEGIN

	SET NOCOUNT ON;
	declare @iterate int =0;
	declare @flag int =0;
	Select @flag = (case when @Status = '0' then 1 else 0 end)
	Select @iterate=isnull(max(iterate),0) + 1 from BSEPush_ErrorLog with(nolock) where Clientcode = @Clientcode;
	insert into BSEPush_ErrorLog(Clientcode,Param,Status,Error_messages,DP_Type,Flag,iterate) values(@Clientcode,@Param,@Status,@Error_messages,@DP_Type,@flag,@iterate);
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLASS_ADD_EDIT_PROCESS_GROUP
-- --------------------------------------------------


CREATE PROCEDURE SP_CLASS_ADD_EDIT_PROCESS_GROUP  
(  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(20),  
 @GROUP VARCHAR(100),  
 @EMAILTO VARCHAR(500),  
 @EMAILCC VARCHAR(500),  
 @EMAILBCC VARCHAR(500),  
 @PROCESS_FOR VARCHAR(MAX)  
)  
--exec msajag.dbo.SP_CLASS_ADD_EDIT_PROCESS_GROUP @EXCHANGE='NSE',@SEGMENT='CAPITAL',@GROUP='sdasd',@EMAILTO='asdas@aasas.com',@EMAILCC='asdas@aasas.com',@EMAILBCC='asdas@aasas.com',@PROCESS_FOR='BILLING^CLOSING^CONTRACTPOP^FINOBL^'  
AS  
BEGIN  
 DECLARE @RECNO INT  
 SET @RECNO = 1    
   
 WHILE ISNULL(.DBO.PIECE(@PROCESS_FOR,'|',@RECNO),'') <> ''  
 BEGIN  
  IF .DBO.PIECE(ISNULL(.DBO.PIECE(@PROCESS_FOR,'|',@RECNO),''),',',2)='ADD'      
   BEGIN  
    INSERT INTO TBL_AUTO_PROCESS_EMAIL_GRP  
    SELECT UPPER(@EXCHANGE),UPPER(@SEGMENT),UPPER(@GROUP),UPPER(.DBO.PIECE(ISNULL(.DBO.PIECE(@PROCESS_FOR,'|',@RECNO),''),',',1)),  
    @EMAILTO,@EMAILCC,@EMAILBCC,1  
   END  
  ELSE  
   BEGIN  
    DELETE FROM TBL_AUTO_PROCESS_EMAIL_GRP WHERE PROCESS_GROUP=@GROUP  
    AND PROCESS_FOR=UPPER(.DBO.PIECE(ISNULL(.DBO.PIECE(@PROCESS_FOR,'|',@RECNO),''),',',1))  
   END  
  SET @RECNO = @RECNO + 1   
 END  
   
 UPDATE TBL_AUTO_PROCESS_EMAIL_GRP   
 SET   TO_EMAIL_ID = @EMAILTO,  
    CC_EMAIL_ID = @EMAILCC,  
    BCC_EMAIL_ID = @EMAILBCC  
 WHERE PROCESS_GROUP=@GROUP  
   
 SELECT ERRCODE='0',MESSAGETEXT='Process Completed Sucessfully'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLASS_GET_PROCESS_GROUP
-- --------------------------------------------------

CREATE PROCEDURE SP_CLASS_GET_PROCESS_GROUP    
(    
 @FOR VARCHAR(1),    
 @GROUP VARCHAR(100)    
)    
AS    
BEGIN    
 IF @FOR='A'     
 BEGIN    
  SELECT DISTINCT PROCESS_FOR FROM TBL_AUTO_PROCESS_MASTER    
  WHERE PROCESS_FOR NOT IN (SELECT DISTINCT PROCESS_FOR FROM TBL_AUTO_PROCESS_EMAIL_GRP)    
  ORDER BY PROCESS_FOR    
 END    
 IF @FOR='S'     
 BEGIN    
  SELECT DISTINCT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GRP    
 END    
     
 IF @FOR='D'     
 BEGIN    
  SELECT * FROM TBL_AUTO_PROCESS_EMAIL_GRP WHERE PROCESS_GROUP=@GROUP    
  UNION    
  SELECT DISTINCT '','','',PROCESS_FOR,'','','',1 FROM TBL_AUTO_PROCESS_MASTER    
  WHERE PROCESS_FOR NOT IN (SELECT DISTINCT PROCESS_FOR FROM TBL_AUTO_PROCESS_EMAIL_GRP)    
  ORDER BY 1    
 END    
     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------- 
-- http://vyaskn.tripod.com/code.htm#inserts 
------------------------------------------------------------------------------------------------------------------------ 
--SET NOCOUNT ON 
--GO 
-- 
--PRINT 'Using Master database' 
--USE master 
--GO 
-- 
--PRINT 'Checking for the existence of this procedure' 
--IF (SELECT OBJECT_ID('sp_generate_inserts','P')) IS NOT NULL --means, the procedure already exists 
-- BEGIN 
-- PRINT 'Procedure already exists. So, dropping it' 
-- DROP PROC sp_generate_inserts 
-- END 
--GO 
-- 
----Turn system object marking on 
--EXEC master.dbo.sp_MS_upd_sysobj_category 1 
--GO 
CREATE PROC [dbo].[sp_generate_inserts] 
( 
@table_name varchar(776), -- The table/view for which the INSERT statements will be generated using the existing data 
@target_table varchar(776) = NULL, -- Use this parameter to specify a different table name into which the data will be inserted 
@include_column_list bit = 1, -- Use this parameter to include/ommit column list in the generated INSERT statement 
@from varchar(800) = NULL, -- Use this parameter to filter the rows based on a filter condition (using WHERE) 
@include_timestamp bit = 0, -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement 
@debug_mode bit = 0, -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination 
@owner varchar(64) = NULL, -- Use this parameter if you are not the owner of the table 
@ommit_images bit = 0, -- Use this parameter to generate INSERT statements by omitting the 'image' columns 
@ommit_identity bit = 0, -- Use this parameter to ommit the identity columns 
@top int = NULL, -- Use this parameter to generate INSERT statements only for the TOP n rows 
@cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement 
@cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement 
@disable_constraints bit = 0, -- When 1, disables foreign key constraints and enables them after the INSERT statements 
@ommit_computed_cols bit = 0 -- When 1, computed columns will not be included in the INSERT statement 
) 
AS 
BEGIN 
/*********************************************************************************************************** 
Procedure: sp_generate_inserts (Build 22) 
(Copyright  2002 Narayana Vyas Kondreddi. All rights reserved.) 
Purpose: To generate INSERT statements from existing data. 
These INSERTS can be executed to regenerate the data at some other location. 
This procedure is also useful to create a database setup, where in you can 
script your data along with your table definitions. 
Written by: Narayana Vyas Kondreddi 
http://vyaskn.tripod.com 
Acknowledgements: 
Divya Kalra -- For beta testing 
Mark Charsley -- For reporting a problem with scripting uniqueidentifier columns with NULL values 
Artur Zeygman -- For helping me simplify a bit of code for handling non-dbo owned tables 
Joris Laperre -- For reporting a regression bug in handling text/ntext columns 
Tested on: SQL Server 7.0 and SQL Server 2000 
Date created: January 17th 2001 21:52 GMT 
Date modified: May 1st 2002 19:50 GMT 
Email: vyaskn@hotmail.com 
NOTE: This procedure may not work with tables with too many columns. 
Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types 
Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results 
IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed 
you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts 
like nchar and nvarchar 
Example 1: To generate INSERT statements for table 'titles': 
EXEC sp_generate_inserts 'titles' 
Example 2: To ommit the column list in the INSERT statement: (Column list is included by default) 
IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below, 
to avoid erroneous results 
EXEC sp_generate_inserts 'titles', @include_column_list = 0 
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table: 
EXEC sp_generate_inserts 'titles', 'titlesCopy' 
Example 4: To generate INSERT statements for 'titles' table for only those titles 
which contain the word 'Computer' in them: 
NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter 
EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'" 
Example 5: To specify that you want to include TIMESTAMP column's data as well in the INSERT statement: 
(By default TIMESTAMP column's data is not scripted) 
EXEC sp_generate_inserts 'titles', @include_timestamp = 1 
Example 6: To print the debug information: 
EXEC sp_generate_inserts 'titles', @debug_mode = 1 
Example 7: If you are not the owner of the table, use @owner parameter to specify the owner name 
To use this option, you must have SELECT permissions on that table 
EXEC sp_generate_inserts Nickstable, @owner = 'Nick' 
Example 8: To generate INSERT statements for the rest of the columns excluding images 
When using this otion, DO NOT set @include_column_list parameter to 0. 
EXEC sp_generate_inserts imgtable, @ommit_images = 1 
Example 9: To generate INSERT statements excluding (ommiting) IDENTITY columns: 
(By default IDENTITY columns are included in the INSERT statement) 
EXEC sp_generate_inserts mytable, @ommit_identity = 1 
Example 10: To generate INSERT statements for the TOP 10 rows in the table: 
EXEC sp_generate_inserts mytable, @top = 10 
Example 11: To generate INSERT statements with only those columns you want: 
EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'" 
Example 12: To generate INSERT statements by omitting certain columns: 
EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'" 
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements: 
EXEC sp_generate_inserts titles, @disable_constraints = 1 
Example 14: To exclude computed columns from the INSERT statement: 
EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1 
***********************************************************************************************************/ 
SET NOCOUNT ON 
--Making sure user only uses either @cols_to_include or @cols_to_exclude 
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL)) 
BEGIN 
RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1) 
RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified 
END 
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format 
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0)) 
BEGIN 
RAISERROR('Invalid use of @cols_to_include property',16,1) 
PRINT 'Specify column names surrounded by single quotes and separated by commas' 
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"' 
RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property 
END 
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0)) 
BEGIN 
RAISERROR('Invalid use of @cols_to_exclude property',16,1) 
PRINT 'Specify column names surrounded by single quotes and separated by commas' 
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"' 
RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property 
END 
--Checking to see if the database name is specified along wih the table name 
--Your database context should be local to the table for which you want to generate INSERT statements 
--specifying the database name is not allowed 
IF (PARSENAME(@table_name,3)) IS NOT NULL 
BEGIN 
RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1) 
RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed 
END 
--Checking for the existence of 'user table' or 'view' 
--This procedure is not written to work on system tables 
--To script the data in system tables, just create a view on the system tables and script the view instead 
IF @owner IS NULL 
BEGIN 
IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL)) 
BEGIN 
RAISERROR('User table or view not found.',16,1) 
PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.' 
PRINT 'Make sure you have SELECT permission on that table or view.' 
RETURN -1 --Failure. Reason: There is no user table or view with this name 
END 
END 
ELSE 
BEGIN 
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner) 
BEGIN 
RAISERROR('User table or view not found.',16,1) 
PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.' 
PRINT 'Make sure you have SELECT permission on that table or view.' 
RETURN -1 --Failure. Reason: There is no user table or view with this name 
END 
END 
--Variable declarations 
DECLARE @Column_ID int, 
@Column_List varchar(8000), 
@Column_Name varchar(128), 
@Start_Insert varchar(786), 
@Data_Type varchar(128), 
@Actual_Values varchar(8000), --This is the string that will be finally executed to generate INSERT statements 
@IDN varchar(128) --Will contain the IDENTITY column's name in the table 
--Variable Initialization 
SET @IDN = '' 
SET @Column_ID = 0 
SET @Column_Name = '' 
SET @Column_List = '' 
SET @Actual_Values = '' 
IF @owner IS NULL 
BEGIN 
SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' 
END 
ELSE 
BEGIN 
SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' 
END 
--To get the first column's ID 
SELECT @Column_ID = MIN(ORDINAL_POSITION) 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE TABLE_NAME = @table_name AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
--Loop through all the columns of the table, to get the column names and their data types 
WHILE @Column_ID IS NOT NULL 
BEGIN 
SELECT @Column_Name = QUOTENAME(COLUMN_NAME), 
@Data_Type = DATA_TYPE 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE ORDINAL_POSITION = @Column_ID AND 
TABLE_NAME = @table_name AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
IF @cols_to_include IS NOT NULL --Selecting only user specified columns 
BEGIN 
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns 
BEGIN 
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column 
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1 
BEGIN 
IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column 
SET @IDN = @Column_Name 
ELSE 
GOTO SKIP_LOOP 
END 
--Making sure whether to output computed columns or not 
IF @ommit_computed_cols = 1 
BEGIN 
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Tables with columns of IMAGE data type are not supported for obvious reasons 
IF(@Data_Type in ('image')) 
BEGIN 
IF (@ommit_images = 0) 
BEGIN 
RAISERROR('Tables with image columns are not supported.',16,1) 
PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.' 
PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.' 
RETURN -1 --Failure. Reason: There is a column with image data type 
END 
ELSE 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Determining the data type of the column and depending on the data type, the VALUES part of 
--the INSERT statement is generated. Care is taken to handle columns with NULL values. Also 
--making sure, not to lose any data from flot, real, money, smallmomey, datetime columns 
SET @Actual_Values = @Actual_Values + 
CASE 
WHEN @Data_Type IN ('char','varchar','nchar','nvarchar') 
THEN 
'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('datetime','smalldatetime') 
THEN 
'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')' 
WHEN @Data_Type IN ('uniqueidentifier') 
THEN 
'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('text','ntext') 
THEN 
'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('binary','varbinary') 
THEN 
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')' 
WHEN @Data_Type IN ('timestamp','rowversion') 
THEN 
CASE 
WHEN @include_timestamp = 0 
THEN 
'''DEFAULT''' 
ELSE 
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')' 
END 
WHEN @Data_Type IN ('float','real','money','smallmoney') 
THEN 
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ',2)' + ')),''NULL'')' 
ELSE 
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ')' + ')),''NULL'')' 
END + '+' + ''',''' + ' + ' 
--Generating the column list for the INSERT statement 
SET @Column_List = @Column_List + @Column_Name + ',' 
SKIP_LOOP: --The label used in GOTO 
SELECT @Column_ID = MIN(ORDINAL_POSITION) 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE TABLE_NAME = @table_name AND 
ORDINAL_POSITION > @Column_ID AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
--Loop ends here! 
END 
--To get rid of the extra characters that got concatenated during the last run through the loop 
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1) 
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6) 
IF LTRIM(@Column_List) = '' 
BEGIN 
RAISERROR('No columns to select. There should at least be one column to generate the output',16,1) 
RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter 
END 
--Forming the final string that will be executed, to output the INSERT statements 
IF (@include_column_list <> 0) 
BEGIN 
SET @Actual_Values = 
'SELECT ' + 
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END + 
'''' + RTRIM(@Start_Insert) + 
' ''+' + '''(' + RTRIM(@Column_List) + '''+' + ''')''' + 
' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' + 
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)') 
END 
ELSE IF (@include_column_list = 0) 
BEGIN 
SET @Actual_Values = 
'SELECT ' + 
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END + 
'''' + RTRIM(@Start_Insert) + 
' '' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' + 
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)') 
END 
--Determining whether to ouput any debug information 
IF @debug_mode =1 
BEGIN 
PRINT '/*****START OF DEBUG INFORMATION*****' 
PRINT 'Beginning of the INSERT statement:' 
PRINT @Start_Insert 
PRINT '' 
PRINT 'The column list:' 
PRINT @Column_List 
PRINT '' 
PRINT 'The SELECT statement executed to generate the INSERTs' 
PRINT @Actual_Values 
PRINT '' 
PRINT '*****END OF DEBUG INFORMATION*****/' 
PRINT '' 
END 
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas' 
PRINT '--Build number: 22' 
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com' 
PRINT '--http://vyaskn.tripod.com' 
PRINT '' 
PRINT 'SET NOCOUNT ON' 
PRINT '' 
--Determining whether to print IDENTITY_INSERT or not 
IF (@IDN <> '') 
BEGIN 
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON' 
PRINT 'GO' 
PRINT '' 
END 
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL) 
BEGIN 
IF @owner IS NULL 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily' 
END 
ELSE 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily' 
END 
PRINT 'GO' 
END 
PRINT '' 
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + '''' 
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes! 
EXEC (@Actual_Values) 
PRINT 'PRINT ''Done''' 
PRINT '' 
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL) 
BEGIN 
IF @owner IS NULL 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints' 
END 
ELSE 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints' 
END 
PRINT 'GO' 
END 
PRINT '' 
IF (@IDN <> '') 
BEGIN 
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF' 
PRINT 'GO' 
END 
PRINT 'SET NOCOUNT OFF' 
SET NOCOUNT OFF 
RETURN 0 --Success. We are done! 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MENU_RIGHTS
-- --------------------------------------------------
   CREATE PROC SP_MENU_RIGHTS   
(  
 @NOPT INT,   
 @VALIDDATE VARCHAR(20)='',  
 @NALERT INT=0  
)  
as   
  
CREATE TABLE #VERSION  
(  
  ERRCODE1 VARCHAR(100),    
  ERRCODE2 VARCHAR(20),    
  ERRCODE3 VARCHAR(2),    
  ERRCODE4 VARCHAR(10),    
  ERRCODE5 VARCHAR(10),    
  ERRCODE6 VARCHAR(100),    
  ERRCODE7 VARCHAR(100),    
  ERRCODE8 VARCHAR(100),    
  ERRCODE9 VARCHAR(100),    
  ERRCODE10 VARCHAR(10),    
  ERRCODE11 VARCHAR(100),   
  ERRCODE12 VARCHAR(100),  
  ERRCODE13 VARCHAR(100),    
  ERRCODE14 VARCHAR(100)    
)  
  
INSERT INTO #VERSION EXEC CHECKVERSION  
  
IF @NOPT =1  
BEGIN  
 SELECT ERRCODE2,ERRCODE3 FROM #VERSION  
END  
ELSE  
BEGIN  
  
 SELECT CASE  
  WHEN DATEDIFF(D,GETDATE(),@VALIDDATE)- @NALERT < 0  
  THEN ERRCODE7 + ' ' + @VALIDDATE  
  WHEN  CONVERT(VARCHAR,GETDATE(),112) >= CONVERT(VARCHAR,CONVERT(DATETIME,@VALIDDATE,112),112)  
  THEN ERRCODE6  
  ELSE ''   
 END AS USERMSG  
 FROM #VERSION   
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spCustomTable2HTML
-- --------------------------------------------------
  
  
CREATE PROCEDURE [dbo].[spCustomTable2HTML] (  
@TABLENAME  NVARCHAR(MAX),  
@OUTPUT   NVARCHAR(MAX) OUTPUT,  
@TBL_STYLE NVARCHAR(1024) = '',  
@HDR_STYLE NVARCHAR(1024) = '')  
AS  
  
  
-- Author:  Ian Atkin (ian.atkin@ict.ox.ac.uk)  
  
-- Description   
--    Stored Procedure to take an arbitraty temporary table and return   
--    the equivalent HTML string .  
  
-- Version History  
--   1.0 - Initial Release For Symantec Connect (Sept 2011)  
  
  
  
-- @exec_str stores the dynamic SQL Query  
-- @ParmDefinition stores the parameter definition for the dynamic SQL  
DECLARE @exec_str  NVARCHAR(MAX)  
DECLARE @ParmDefinition NVARCHAR(500)  
  
  
--We need to use Dynamic SQL at this point so we can expand the input table name parameter  
SET @exec_str= N'  
DECLARE @exec_str  NVARCHAR(MAX)  
DECLARE @ParmDefinition NVARCHAR(500)  
  
--Make a copy of the original table adding an indexing columnWe need to add an index column to the table to facilitate sorting so we can maintain the  
--original table order as we iterate through adding HTML tags to the table fields.  
--New column called CustColHTML_ID (unlikely to be used by someone else!)  
--  
  
select CustColHTML_ID=0,* INTO #CustomTable2HTML FROM (' + @TABLENAME + ') A   
  
--Now alter the table to add the auto-incrementing index. This will facilitate row finding  
DECLARE @COUNTER INT  
SET @COUNTER=0  
UPDATE #CustomTable2HTML SET @COUNTER = CustColHTML_ID=@COUNTER+1   
  
-- @HTMLROWS will store all the rows in HTML format  
-- @ROW will store each HTML row as fields on each row are iterated through   
-- using dymamic SQL and a cursor  
-- @FIELDS will store the header row for the HTML Table  
  
DECLARE @HTMLROWS NVARCHAR(MAX) DECLARE @FIELDS NVARCHAR(MAX)   
SET @HTMLROWS='''' DECLARE @ROW NVARCHAR(MAX)   
  
-- Create the first HTML row for the table (the table header). Ignore our indexing column!  
SET @FIELDS=''<tr ' + @HDR_STYLE + '>''  
SELECT @FIELDS=COALESCE(@FIELDS, '' '','''')+''<td>'' + name + ''</td>''  
FROM tempdb.sys.Columns  
WHERE object_id=object_id(''tempdb..#CustomTable2HTML'')  
AND name not like ''CustColHTML_ID''  
SET @FIELDS=@FIELDS + ''</tr>''  
  
-- @ColumnName stores the column name as found by the table cursor  
-- @maxrows is a count of the rows in the table, and @rownum is for marking the  
-- ''current'' row whilst processing  
  
DECLARE @ColumnName  NVARCHAR(500)  
DECLARE @maxrows INT  
DECLARE @rownum INT  
  
--Find row count of our temporary table  
SELECT @maxrows=count(*) FROM  #CustomTable2HTML  
  
  
--Create a cursor which will look through all the column names specified in the temporary table  
--but exclude the index column we added (CustColHTML_ID)  
DECLARE col CURSOR FOR  
SELECT name FROM tempdb.sys.Columns  
WHERE object_id=object_id(''tempdb..#CustomTable2HTML'')  
AND name not like ''CustColHTML_ID''  
ORDER BY column_id ASC  
  
--For each row, generate dymanic SQL which requests the each column name in turn by   
--iterating through a cursor  
SET @rowNum=0  
SET @ParmDefinition=N''@ROWOUT NVARCHAR(MAX) OUTPUT,@rowNum_IN INT''  
  
While @rowNum < @maxrows  
BEGIN  
  SET @HTMLROWS=@HTMLROWS + ''<tr>''  
  
  SET @rowNum=@rowNum +1  
  OPEN col  
  FETCH NEXT FROM col INTO @ColumnName  
  WHILE @@FETCH_STATUS=0  
    BEGIN  
      --Get nth row from table  
      --SET @exec_str=''SELECT @ROWOUT=(select top 1 ['' + @ColumnName + ''] from (select top '' + cast(@rownum as varchar) + '' * from #CustomTable2HTML order by CustColHTML_ID ASC) xxx order by CustColHTML_ID DESC)''  
      SET @exec_str=''SELECT @ROWOUT=(select ['' + @ColumnName + ''] from #CustomTable2HTML where CustColHTML_ID=@rowNum_IN)''  
  
   EXEC sp_executesql   
   @exec_str,  
   @ParmDefinition,  
   @ROWOUT=@ROW OUTPUT,  
            @rowNum_IN=@rownum  
  
      SET @HTMLROWS =@HTMLROWS +  ''<td>'' + @ROW + ''</td>''  
      FETCH NEXT FROM col INTO @ColumnName  
    END  
  CLOSE col  
  SET @HTMLROWS=@HTMLROWS + ''</tr>''  
END  
  
SET @OUTPUT=''''  
IF @maxrows>0  
SET @OUTPUT= ''<table ' + @TBL_STYLE + '>'' + @FIELDS + @HTMLROWS + ''</table>''  
  
DEALLOCATE col  
'  
  
DECLARE @ParamDefinition nvarchar(max)  
SET @ParamDefinition=N'@OUTPUT NVARCHAR(MAX) OUTPUT'  
  
--PRINT @exec_str  
--Execute Dynamic SQL. HTML table is stored in @OUTPUT which is passed back up (as it's  
--a parameter to this SP)  
EXEC sp_executesql @exec_str,  
@ParamDefinition,  
@OUTPUT=@OUTPUT OUTPUT  
  
RETURN 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spx_mf_to_demat_getclient_Details
-- --------------------------------------------------
-- =============================================
-- Author:		mitesh parmar
-- Create date: 2023-01-03
-- Description:	get client mf details 
-- spx_mf_to_demat_getclient_Details 'B'
-- spx_mf_to_demat_getclient_Details 'P234402'
-- =============================================
CREATE PROCEDURE [dbo].[spx_mf_to_demat_getclient_Details]
(
	@client_code varchar(50) = null,
	@mobile_no varchar(50) = null
)
AS
BEGIN
	--- ===========================================================
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	--- ===========================================================
	SET NOCOUNT ON;
	

	if (isnull(@client_code,'')  <> '')
		begin

			select	top 1 
					PAN_NO as pan,
					MOBILE_NO as mobile,
					EMAIL_ID as email,
					case	when isnull(DOB,'') <> ''
							then convert(varchar(10),DOB,121) 
							else ''
							end as dob,
					BANK_NAME as bank_name,
					ACC_NO as bank_account_no, 
					NEFTCODE as  bank_ifsc_code,
					
					SUB_BROKER as sb_tag,
					party_name as client_name,
					Party_code as client_code,
					BRANCH_CD as branch_code
			from	dbo.MFSS_client With(Nolock)
			where	Party_code = @client_code

		end

	else if (isnull(@mobile_no,'')  <> '')
		begin
			select	top 1 
					PAN_NO as pan,
					MOBILE_NO as mobile,
					EMAIL_ID as email,
					case	when isnull(DOB,'') <> ''
							then convert(varchar(10),DOB,121) 
							else ''
							end as dob,
					BANK_NAME as bank_name,
					ACC_NO as bank_account_no, 
					NEFTCODE as  bank_ifsc_code,
					
					SUB_BROKER as sb_tag,
					party_name as client_name,
					Party_code as client_code,
					BRANCH_CD as branch_code
			from	dbo.MFSS_client With(Nolock)
			where	MOBILE_NO = @mobile_no

		end


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------

CREATE PROC Tbl @TblName VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_AUTO_PROCESS_FOR_BULK
-- --------------------------------------------------
CREATE PROCEDURE UPD_AUTO_PROCESS_FOR_BULK  
(  
 @UPD_DATE VARCHAR(MAX)  
)  
AS  
BEGIN  
 SELECT ERRCODE='0',MESSAGETEXT='DONE'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_NOMINEE_DETAILS_MF
-- --------------------------------------------------

CREATE PROC [dbo].[UPD_NOMINEE_DETAILS_MF]

AS 

SELECT   * INTO #NOMINEE_DATA FROM  [172.31.16.108].INHOUSE.DBO.NOMINEE_MULTI WITH(NOLOCK)  
 
 DECLARE @PROCESSDATE DATETIME
 SET @PROCESSDATE =CONVERT(DATE,GETDATE()-25,120)
 PRINT @PROCESSDATE
 
 SELECT * INTO #NOMINEE
  FROM #NOMINEE_DATA
  WHERE CONVERT(DATE,RIGHT(DATEOFSETUP,4)+'-'+LEFT(RIGHT(DATEOFSETUP,6),2)+'-'+LEFT(DATEOFSETUP,2)) >=@PROCESSDATE AND TYPEOFTRANS <>3




SELECT BOID,NOM_NAME=LTRIM(RTRIM(NAME))+' '+ LTRIM(RTRIM(MIDDLENAME))+' '+LTRIM(RTRIM(SEARCHNAME)) ,ADDR1,ADDR2,ADDR3,CITY,STATE,PINCODE,PRIPHIND, NOM_SR_NO,
REL_WITH_BO =(CASE WHEN REL_WITH_BO =1 THEN 'SPOUSE'
				WHEN REL_WITH_BO =2 THEN 'SON'
				WHEN REL_WITH_BO =3 THEN 'DAUGHTER'
				WHEN REL_WITH_BO =4 THEN 'FATHER'
				WHEN REL_WITH_BO =5 THEN 'MOTHER'
				WHEN REL_WITH_BO =6 THEN 'BROTHER'
				WHEN REL_WITH_BO =7 THEN 'SISTER'
				WHEN REL_WITH_BO =8 THEN 'GRAND SON'
				WHEN REL_WITH_BO =9 THEN 'GRAND DAUGHTER'
				WHEN REL_WITH_BO =10 THEN 'GRAND FATHER'
				WHEN REL_WITH_BO =11 THEN 'GRAND MOTHER'
				WHEN REL_WITH_BO =12 THEN 'NOT PROVIDED'
				WHEN REL_WITH_BO =13 THEN 'OTHERS' END),
PERC_OF_SHARES,STATECODE,PANGIR,DATEOFBIRTH =(CASE WHEN DATEOFBIRTH ='' THEN '' ELSE RIGHT(DATEOFBIRTH,4)+'-'+LEFT(RIGHT(DATEOFBIRTH,6),2)+'-'+LEFT(DATEOFBIRTH,2) END) INTO #FINAL
 FROM #NOMINEE

 --ALTER TABLE #FINAL
 --ADD BOPARTYCODE VARCHAR(15)
 CREATE INDEX #CLIENT ON #FINAL(BOID)
   
 SELECT D.* INTO #FIN_UPD FROM   #FINAL D (NOLOCK) ,MFSS_CLIENT M (NOLOCK)
 WHERE    BOID=CLTDPID AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T')
 AND NOM_SR_NO =1 AND ISNULL(NOMINEE_NAME,'' )=''


 SELECT  * INTO #FINUPD FROM #FINAL WHERE BOID IN (SELECT BOID FROM #FIN_UPD )  

 BEGIN TRAN 
 UPDATE M SET NOMINEE_NAME3 =NOM_NAME ,NOMINEE_RELATION3=REL_WITH_BO,NOMINEEPER3=PERC_OF_SHARES,NOMINEEDOB2=CONVERT(VARCHAR(11),DATEOFBIRTH,103),
 ADDRESS13=D.ADDR1,ADDRESS23=D.ADDR2 ,PIN3 =PINCODE,NOMINEEPANNO3=PANGIR, NOMREQ ='N',NOMINEEMINORFLAG3='N'
  FROM #FINUPD D (NOLOCK) ,MFSS_CLIENT M (NOLOCK)
 WHERE    BOID=CLTDPID AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T')
 AND NOM_SR_NO =3 AND ISNULL(NOMINEE_NAME3,'' )=''


  UPDATE M SET NOMINEE_NAME2 =NOM_NAME ,NOMINEE_RELATION2=REL_WITH_BO,NOMINEEPER2=PERC_OF_SHARES,NOMINEEDOB2=CONVERT(VARCHAR(11),DATEOFBIRTH,103),
 ADDRESS12=D.ADDR1,ADDRESS22=D.ADDR2 ,PIN2 =PINCODE,NOMINEEPANNO2=PANGIR ,NOMREQ ='N',NOMINEEMINORFLAG2='N'
 FROM #FINUPD  D (NOLOCK) ,MFSS_CLIENT M (NOLOCK)
 WHERE  BOID=CLTDPID AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T')
   AND NOM_SR_NO =2  AND ISNULL(NOMINEE_NAME2,'' )=''

  UPDATE M SET  NOMINEE_NAME =NOM_NAME, NOMINEE_RELATION=REL_WITH_BO,NOMINEEPER=PERC_OF_SHARES,NOMINEEDOB=CONVERT(VARCHAR(11),DATEOFBIRTH,103),
 ADDRESS1=D.ADDR1,ADDRESS2=D.ADDR2 ,PIN =PINCODE,NOMINEEPANNO=PANGIR, NOMREQ ='N',NOMINEEMINORFLAG='N'
 FROM #FINAL D (NOLOCK) ,MFSS_CLIENT M (NOLOCK)
 WHERE  BOID=CLTDPID AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T')
 AND NOM_SR_NO =1  

COMMIT
 
 
INSERT INTO  NOMINEE_DATA_MIG_LOG
SELECT BOID,NOM_NAME  ,ADDR1,ADDR2,ADDR3,CITY,STATE,PINCODE,PRIPHIND, NOM_SR_NO,
REL_WITH_BO ,
PERC_OF_SHARES,STATECODE,PANGIR,DATEOFBIRTH ,PARTY_CODE	='',ACC_STATUS='',PROCESS_DATE =GETDATE()
 FROM #FINUPD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------

Create Procedure usp_findinJobs(@Str as varchar(500))  
as  
  
select b.name,  
Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,  
date_created,date_modified,a.step_id,a.step_name,a.command  
from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b  
where command like '%'+@Str+'%'  
and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------
CREATE PROCEDURE USP_FINDINUSP                
 @DBNAME VARCHAR(500),              
 @SRCSTR VARCHAR(500)                
AS                
                
 SET NOCOUNT ON              
 SET @SRCSTR  = '%' + @SRCSTR + '%'                
              
 DECLARE @STR AS VARCHAR(1000)              
 SET @STR=''              
 IF @DBNAME <>''              
 BEGIN              
 SET @DBNAME=@DBNAME+'.DBO.'              
 END              
 ELSE              
 BEGIN              
 SET @DBNAME=DB_NAME()+'.DBO.'              
 END              
 ----PRINT @DBNAME              
              
 SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '               
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '               
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                
 --PRINT @STR              
  EXEC(@STR)              
      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getJobStatus
-- --------------------------------------------------


CREATE PROCEDURE  usp_getJobStatus 
                          @JobName NVARCHAR (1000)

    AS

DECLARE @DEL_JOB_NAME NVARCHAR (1000)

DECLARE @JOBCURSOR CURSOR,
		@SQL	VARCHAR(MAX)

        IF OBJECT_ID('TempDB..#JobResults','U') IS NOT NULL DROP TABLE #JobResults
        CREATE TABLE #JobResults ( Job_ID   UNIQUEIDENTIFIER NOT NULL, 
                                   Last_Run_Date         INT NOT NULL, 
                                   Last_Run_Time         INT NOT NULL, 
                                   Next_Run_date         INT NOT NULL, 
                                   Next_Run_Time         INT NOT NULL, 
                                   Next_Run_Schedule_ID  INT NOT NULL, 
                                   Requested_to_Run      INT NOT NULL,
                                   Request_Source        INT NOT NULL, 
                                   Request_Source_id     SYSNAME 
                                   COLLATE Database_Default      NULL, 
                                   Running               INT NOT NULL,
                                   Current_Step          INT NOT NULL, 
                                   Current_Retry_Attempt INT NOT NULL, 
                                   Job_State             INT NOT NULL ) 

        INSERT  #JobResults 
        EXECUTE master.dbo.xp_sqlagent_enum_jobs 1, '';

        SELECT  job.name                                                AS [Job_Name], 
             CASE 
                WHEN r.running = 0 THEN
                    CASE 
                        WHEN jobInfo.lASt_run_outcome = 0 THEN 'Failed'
                        WHEN jobInfo.lASt_run_outcome = 1 THEN 'Success'
                        WHEN jobInfo.lASt_run_outcome = 3 THEN 'Canceled'
                        ELSE 'Unknown'
                    END
                        WHEN r.job_state = 0 THEN 'Success'
                        WHEN r.job_state = 4 THEN 'Success'
                        WHEN r.job_state = 5 THEN 'Success'
                        WHEN r.job_state = 1 THEN 'In Progress'
                        WHEN r.job_state = 2 THEN 'In Progress'
                        WHEN r.job_state = 3 THEN 'In Progress'
                        WHEN r.job_state = 7 THEN 'In Progress'
                     ELSE 'Unknown' END                                 AS [Run_Status_Description]
		INTO #DELJOB
        FROM    #JobResults AS r 
            LEFT OUTER JOIN msdb.dbo.sysjobservers AS jobInfo 
               ON r.job_id = jobInfo.job_id 
            INNER JOIN msdb.dbo.sysjobs AS job 
               ON r.job_id = job.job_id 
        WHERE   job.[enabled] = 1
                AND job.name LIKE '%' + @JobName + '%'
				and jobInfo.lASt_run_outcome = 0

		SET @JOBCURSOR = CURSOR FOR
		SELECT Job_Name FROM #DELJOB
		OPEN @JOBCURSOR
		FETCH NEXT FROM @JOBCURSOR INTO @DEL_JOB_NAME
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @SQL = 'execute msdb..sp_delete_job @job_name=''' + @DEL_JOB_NAME + ''''
			EXEC (@SQL)

			FETCH NEXT FROM @JOBCURSOR INTO @DEL_JOB_NAME
		END
		CLOSE @JOBCURSOR
		DEALLOCATE @JOBCURSOR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_PASSWORD
-- --------------------------------------------------



CREATE  PROC V2_UPDATE_PASSWORD
(
	@PASSWORD VARCHAR(15),
	@USERID VARCHAR(25),
	@DAYCOUNT INT	
)

AS


SET NOCOUNT ON

DECLARE @@FLDOLDPASSWORD TINYINT
DECLARE @@FLDAUTO INT
DECLARE @@PASSAUTO BIGINT
DECLARE @@OLDPASSSTRING VARCHAR(2000)
DECLARE @@OLDPASSCOUNT INT
DECLARE @@NEWPASSSTRING VARCHAR(2000)


/*
CREATE TABLE TBLUSERPASSHIST
(
	FLDAUTO BIGINT IDENTITY(1,1),
	FLDUSERID INT,
	FLDOLDPASSLISTING VARCHAR(2000)
)
*/


SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS

IF ISNULL(@@FLDOLDPASSWORD,0) = 0
BEGIN
	SET @@FLDOLDPASSWORD = 1
END



SELECT @@FLDAUTO = ISNULL(FLDAUTO,0) FROM TBLPRADNYAUSERS
WHERE FLDUSERNAME = @USERID

IF ISNULL(@@FLDAUTO,0) = 0
BEGIN
	SELECT MSG = 'USER NOT FOUND'
	RETURN
END



SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLUSERPASSHIST
WHERE FLDUSERID = @@FLDAUTO

IF ISNULL(@@OLDPASSSTRING,'') = ''
BEGIN
	SET @@OLDPASSSTRING = ''
END

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	SET @@PASSAUTO = 0
END


SELECT 
	@@OLDPASSCOUNT = COUNT(1)
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE 
	SPLITTED_VALUE = @PASSWORD
	AND SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)


IF ISNULL(@@OLDPASSCOUNT,0) > 0
BEGIN
	SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'
	RETURN
END



UPDATE TBLPRADNYAUSERS 
SET 
	FLDPASSWORD = @PASSWORD,
	PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT)
WHERE 
	FLDAUTO = @@FLDAUTO

								
UPDATE TBLUSERCONTROLMASTER 
SET 
	FLDATTEMPTCNT = 0,
	FLDFIRSTLOGIN = 'N'
WHERE 
	TBLUSERCONTROLMASTER.FLDUSERID = @@FLDAUTO 



SET @@NEWPASSSTRING = ''


DECLARE @@STRING VARCHAR(100)

DECLARE vendor_cursor CURSOR FOR 

SELECT SPLITTED_VALUE
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE  SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)
OPEN vendor_cursor

FETCH NEXT FROM vendor_cursor 
INTO @@STRING

WHILE @@FETCH_STATUS = 0
BEGIN
	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''
FETCH NEXT FROM vendor_cursor 
INTO @@STRING
END 

CLOSE vendor_cursor
DEALLOCATE vendor_cursor

	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD 

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	INSERT INTO TBLUSERPASSHIST 
	(FLDUSERID, FLDOLDPASSLISTING) 
	VALUES
	(@@FLDAUTO, @@NEWPASSSTRING)
END
ELSE
BEGIN
	UPDATE TBLUSERPASSHIST
	SET FLDOLDPASSLISTING = @@NEWPASSSTRING
	WHERE FLDAUTO = @@PASSAUTO
	AND FLDUSERID = @@FLDAUTO 
END

SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------

CREATE PROC Vw @VwName VARCHAR(25)AS                 
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- TABLE dbo.AAA
-- --------------------------------------------------
CREATE TABLE [dbo].[AAA]
(
    [P] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACCBILL
-- --------------------------------------------------
CREATE TABLE [dbo].[ACCBILL]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] DATETIME NOT NULL,
    [End_Date] DATETIME NOT NULL,
    [Payin_Date] DATETIME NOT NULL,
    [Payout_Date] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACCBILL_BKUP_28JUL20
-- --------------------------------------------------
CREATE TABLE [dbo].[ACCBILL_BKUP_28JUL20]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] DATETIME NOT NULL,
    [End_Date] DATETIME NOT NULL,
    [Payin_Date] DATETIME NOT NULL,
    [Payout_Date] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_missing
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_missing]
(
    [Acname] VARCHAR(100) NOT NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] VARCHAR(5) NOT NULL,
    [Accat] INT NOT NULL,
    [Familycd] VARCHAR(1) NOT NULL,
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [Accdtls] VARCHAR(1) NOT NULL,
    [Grpcode] VARCHAR(11) NOT NULL,
    [Booktype] VARCHAR(1) NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [Btobpayment] INT NOT NULL,
    [Paymode] VARCHAR(1) NOT NULL,
    [Pobankname] VARCHAR(1) NOT NULL,
    [Pobranch] VARCHAR(1) NOT NULL,
    [Pobankcode] VARCHAR(1) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_RJVB1001
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_RJVB1001]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AREA
-- --------------------------------------------------
CREATE TABLE [dbo].[AREA]
(
    [AREACODE] VARCHAR(20) NULL,
    [DESCRIPTION] VARCHAR(50) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [DUMMY1] VARCHAR(1) NULL,
    [DUMMY2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.awsdms_truncation_safeguard
-- --------------------------------------------------
CREATE TABLE [dbo].[awsdms_truncation_safeguard]
(
    [latchTaskName] VARCHAR(128) NOT NULL,
    [latchMachineGUID] VARCHAR(40) NOT NULL,
    [LatchKey] CHAR(1) NOT NULL,
    [latchLocker] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_CONTGEN_31032020
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_CONTGEN_31032020]
(
    [Contractno] VARCHAR(7) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_CONTGEN_31032022
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_CONTGEN_31032022]
(
    [Contractno] VARCHAR(7) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_LOF
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_LOF]
(
    [REPORTDATE] DATETIME NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [USERID] VARCHAR(20) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [RTA_TRANS_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [F_CL_NAME] VARCHAR(100) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [RECFLAG] VARCHAR(1) NULL,
    [REMARK] VARCHAR(100) NULL,
    [RECFOR] VARCHAR(1) NULL,
    [STT] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_MFSS_ORDERtest1
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_MFSS_ORDERtest1]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANK
-- --------------------------------------------------
CREATE TABLE [dbo].[BANK]
(
    [BankId] VARCHAR(16) NOT NULL,
    [BankName] VARCHAR(60) NULL,
    [address1] VARCHAR(60) NULL,
    [address2] VARCHAR(60) NULL,
    [city] VARCHAR(40) NULL,
    [pincode] VARCHAR(20) NULL,
    [phone1] VARCHAR(20) NULL,
    [phone2] VARCHAR(20) NULL,
    [phone3] VARCHAR(20) NULL,
    [phone4] VARCHAR(20) NULL,
    [fax1] VARCHAR(40) NULL,
    [fax2] VARCHAR(20) NULL,
    [email] VARCHAR(50) NULL,
    [BankType] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCH
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCH]
(
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [BRANCH] VARCHAR(80) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [ADDRESS1] VARCHAR(100) NULL,
    [ADDRESS2] VARCHAR(100) NULL,
    [CITY] VARCHAR(40) NULL,
    [STATE] VARCHAR(30) NULL,
    [NATION] VARCHAR(30) NULL,
    [ZIP] VARCHAR(30) NULL,
    [PHONE1] VARCHAR(30) NULL,
    [PHONE2] VARCHAR(30) NULL,
    [FAX] VARCHAR(30) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [REMOTE] BIT NOT NULL,
    [SECURITY_NET] BIT NOT NULL,
    [MONEY_NET] BIT NOT NULL,
    [EXCISE_REG] VARCHAR(60) NULL,
    [CONTACT_PERSON] VARCHAR(150) NULL,
    [PREFIX] VARCHAR(3) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCHES
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCHES]
(
    [BRANCH_CD] VARCHAR(50) NOT NULL,
    [SHORT_NAME] VARCHAR(20) NOT NULL,
    [LONG_NAME] VARCHAR(50) NULL,
    [ADDRESS1] VARCHAR(25) NULL,
    [ADDRESS2] VARCHAR(25) NULL,
    [CITY] VARCHAR(20) NULL,
    [STATE] CHAR(15) NULL,
    [NATION] CHAR(15) NULL,
    [ZIP] CHAR(15) NULL,
    [PHONE1] CHAR(15) NULL,
    [PHONE2] CHAR(15) NULL,
    [FAX] CHAR(15) NULL,
    [EMAIL] CHAR(50) NULL,
    [REMOTE] BIT NOT NULL,
    [SECURITY_NET] BIT NOT NULL,
    [MONEY_NET] BIT NOT NULL,
    [EXCISE_REG] CHAR(30) NULL,
    [CONTACT_PERSON] CHAR(25) NULL,
    [COM_PERC] MONEY NULL,
    [TERMINAL_ID] VARCHAR(10) NULL,
    [DEFTRADER] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(18, 4) NULL,
    [Day_Sales] NUMERIC(18, 4) NULL,
    [Sett_Purch] NUMERIC(18, 4) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(18, 4) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] NUMERIC(18, 9) NULL,
    [NoZero] INT NULL,
    [Branch_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEMF_ORDER_TDAY
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEMF_ORDER_TDAY]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [ORDAMT] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEMF_REPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEMF_REPORT]
(
    [SRNO] INT NOT NULL,
    [RPT_NAME] VARCHAR(50) NULL,
    [RPT_NAME_DESC] VARCHAR(150) NULL,
    [RPT_FILENAME] VARCHAR(100) NULL,
    [RPT_FILE_GROUP] VARCHAR(20) NULL,
    [RPT_SEPARATOR] CHAR(1) NULL,
    [RPT_PROC_NAME] VARCHAR(100) NULL,
    [NO_OF_PARAMETER] VARCHAR(20) NULL,
    [FLDSELECTION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEMF_Transactions
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEMF_Transactions]
(
    [Trans_ID] INT NOT NULL,
    [Amount] FLOAT NOT NULL,
    [InternalRef_No] NVARCHAR(50) NOT NULL,
    [status] NVARCHAR(50) NOT NULL,
    [CreatedOn] DATETIME2 NOT NULL,
    [Client_Code] NVARCHAR(50) NOT NULL,
    [BankRef_No] NVARCHAR(50) NOT NULL,
    [TPV] NVARCHAR(1) NULL,
    [TransReq_dtm] DATETIME2 NOT NULL,
    [TransResp_dtm] DATETIME2 NOT NULL,
    [ProductName] NVARCHAR(50) NOT NULL,
    [SegmentName] NVARCHAR(50) NOT NULL,
    [BankName] NVARCHAR(50) NOT NULL,
    [AggregatorName] NVARCHAR(50) NOT NULL,
    [ReqSource] NVARCHAR(50) NOT NULL,
    [RequestType] NVARCHAR(50) NOT NULL,
    [RespAccountNo] NVARCHAR(50) NULL,
    [RespBankName] NVARCHAR(50) NULL,
    [IsReconciliation] NVARCHAR(50) NOT NULL,
    [PG_ERRORCODE] NVARCHAR(50) NULL,
    [ErrorCode_ID] NVARCHAR(50) NULL,
    [ErrorCode_Name] NVARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEPush_ErrorLog
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEPush_ErrorLog]
(
    [Clientcode] VARCHAR(20) NULL,
    [Param] VARCHAR(MAX) NULL,
    [Status] CHAR(1) NULL,
    [Error_messages] VARCHAR(200) NULL,
    [DP_Type] VARCHAR(10) NULL,
    [CreatedDate] DATETIME NULL DEFAULT (getdate()),
    [Flag] INT NULL DEFAULT ((0)),
    [iterate] INT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_DETAIL_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_DETAIL_SETTING]
(
    [OBJNAME] VARCHAR(30) NULL,
    [BLANK_ALLOWED] INT NULL,
    [FIELD_WIDTH] INT NULL,
    [enable_disable] INT NULL,
    [CLIENT_TYPE] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_detail_setting_BKUP_30Nov2022
-- --------------------------------------------------
CREATE TABLE [dbo].[client_detail_setting_BKUP_30Nov2022]
(
    [OBJNAME] VARCHAR(30) NULL,
    [BLANK_ALLOWED] INT NULL,
    [FIELD_WIDTH] INT NULL,
    [enable_disable] INT NULL,
    [CLIENT_TYPE] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTSTATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTSTATUS]
(
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [DESCRIPTION] VARCHAR(35) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttype
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttype]
(
    [Cl_Type] VARCHAR(3) NOT NULL,
    [Description] VARCHAR(50) NULL,
    [GROUP_CODE] VARCHAR(10) NULL,
    [prefix] VARCHAR(3) NOT NULL,
    [priority] INT NULL,
    [MarginFlag] VARCHAR(1) NULL,
    [DEBITBALPERCENTAGE] DECIMAL(18, 4) NULL,
    [FutBalPercentage] DECIMAL(18, 4) NULL,
    [FUNDS_FNO_IM] VARCHAR(1) NULL,
    [FUNDS_FNO_EXP] VARCHAR(1) NULL,
    [FUNDS_ADHOC_PAYOUT] VARCHAR(1) NULL,
    [FUNDS_SETT_PAYOUT] VARCHAR(1) NULL,
    [FAMILY_BALANCE] VARCHAR(1) NULL,
    [CREATEBY] VARCHAR(20) NULL,
    [CREATEDATE] DATETIME NULL,
    [UPDATEBY] VARCHAR(20) NULL,
    [UPDATEDATE] DATETIME NULL,
    [InstFlag] VARCHAR(1) NULL,
    [PANVALIDATION] VARCHAR(1) NULL,
    [CREDITAMOUNT] NUMERIC(18, 4) NULL,
    [CASHMARGINMARKUP] NUMERIC(18, 4) NULL,
    [FOMARGINMARKUP] NUMERIC(18, 4) NULL,
    [NLRSell] NUMERIC(18, 4) NULL,
    [NLRMCall] NUMERIC(18, 4) NULL,
    [NLRHold] NUMERIC(18, 4) NULL,
    [SPANMARKUP] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_TBLUSERGROUPMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_TBLUSERGROUPMASTER]
(
    [fldAuto] INT IDENTITY(1,1) NOT NULL,
    [fldUserID] INT NULL,
    [Group_Code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_TBLUSERGROUPMASTER_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_TBLUSERGROUPMASTER_LOG]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] INT NULL,
    [FLDUSERID] INT NULL,
    [GROUP_CODE] VARCHAR(20) NULL,
    [FLAG] CHAR(1) NULL,
    [ADDED_DT] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTGEN
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTGEN]
(
    [Contractno] VARCHAR(7) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delaccbalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Delaccbalance]
(
    [Cltcode] VARCHAR(10) NOT NULL,
    [Amount] MONEY NULL,
    [Payflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[DELCODE]
(
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Nsdlno] NUMERIC(18, 0) NULL,
    [Cdslno] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELFILENO
-- --------------------------------------------------
CREATE TABLE [dbo].[DELFILENO]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [FileType] VARCHAR(10) NOT NULL,
    [FileNo] INT NOT NULL,
    [FileDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DeliveryDp
-- --------------------------------------------------
CREATE TABLE [dbo].[DeliveryDp]
(
    [SNo] DECIMAL(18, 0) NOT NULL,
    [DpType] VARCHAR(4) NULL,
    [DpId] VARCHAR(16) NULL,
    [DpCltNo] VARCHAR(16) NULL,
    [Description] VARCHAR(65) NULL,
    [ACCOUNTTYPE] VARCHAR(4) NULL,
    [LICENCENO] VARCHAR(10) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delsegment
-- --------------------------------------------------
CREATE TABLE [dbo].[delsegment]
(
    [Refno] INT NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(10) NULL,
    [Company] VARCHAR(50) NULL,
    [Db] VARCHAR(20) NULL,
    [Pdptype] VARCHAR(5) NULL,
    [Pdpid] VARCHAR(16) NULL,
    [Pcltid] VARCHAR(16) NULL,
    [Bdptype] VARCHAR(5) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltid] VARCHAR(16) NULL,
    [Pdptype1] VARCHAR(5) NULL,
    [Pdpid1] VARCHAR(16) NULL,
    [Pcltid1] VARCHAR(16) NULL,
    [Bdptype1] VARCHAR(5) NULL,
    [Bdpid1] VARCHAR(16) NULL,
    [Bcltid1] VARCHAR(16) NULL,
    [Fileread] INT NULL,
    [Auctionper] DECIMAL(18, 2) NULL,
    [Nsecmbpid] VARCHAR(8) NULL,
    [Bsecmbpid] VARCHAR(8) NULL,
    [Nsdltocdsl] VARCHAR(8) NULL,
    [Auctionparty] VARCHAR(10) NULL,
    [Auctionchrg] MONEY NULL,
    [Allocationtype] INT NULL,
    [Noofslip] INT NULL,
    [Insettex] INT NULL,
    [Inbenex] INT NULL,
    [Brokerid] VARCHAR(8) NULL,
    [Brokerfileid] VARCHAR(2) NULL,
    [AuctionFlag] INT NULL,
    [AuctionFlagDesc] VARCHAR(100) NULL,
    [RMSPAYOUT] INT NULL,
    [COLLCALCULATIONFLAG] INT NULL,
    [LOANPARTY] VARCHAR(10) NULL,
    [AUCTIONFINAL] DECIMAL(18, 4) NULL,
    [SETTPOCKETFLAG] INT NULL,
    [NSECMID] VARCHAR(8) NULL,
    [BSECMID] VARCHAR(8) NULL,
    [SENDERPOAID] VARCHAR(16) NULL,
    [WITH_ROOT_FLAG] INT NULL,
    [THIRDPARTY_CODE] VARCHAR(10) NULL,
    [ConsiderationFlag] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELSEGMENT_bak_27062020
-- --------------------------------------------------
CREATE TABLE [dbo].[DELSEGMENT_bak_27062020]
(
    [Refno] INT NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(10) NULL,
    [Company] VARCHAR(50) NULL,
    [Db] VARCHAR(20) NULL,
    [Pdptype] VARCHAR(5) NULL,
    [Pdpid] VARCHAR(16) NULL,
    [Pcltid] VARCHAR(16) NULL,
    [Bdptype] VARCHAR(5) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltid] VARCHAR(16) NULL,
    [Pdptype1] VARCHAR(5) NULL,
    [Pdpid1] VARCHAR(16) NULL,
    [Pcltid1] VARCHAR(16) NULL,
    [Bdptype1] VARCHAR(5) NULL,
    [Bdpid1] VARCHAR(16) NULL,
    [Bcltid1] VARCHAR(16) NULL,
    [Fileread] INT NULL,
    [Auctionper] DECIMAL(18, 2) NULL,
    [Nsecmbpid] VARCHAR(8) NULL,
    [Bsecmbpid] VARCHAR(8) NULL,
    [Nsdltocdsl] VARCHAR(8) NULL,
    [Auctionparty] VARCHAR(10) NULL,
    [Auctionchrg] MONEY NULL,
    [Allocationtype] INT NULL,
    [Noofslip] INT NULL,
    [Insettex] INT NULL,
    [Inbenex] INT NULL,
    [Brokerid] VARCHAR(8) NULL,
    [Brokerfileid] VARCHAR(2) NULL,
    [AuctionFlag] INT NULL,
    [AuctionFlagDesc] VARCHAR(100) NULL,
    [RMSPAYOUT] INT NULL,
    [COLLCALCULATIONFLAG] INT NULL,
    [LOANPARTY] VARCHAR(10) NULL,
    [AUCTIONFINAL] DECIMAL(18, 4) NULL,
    [SETTPOCKETFLAG] INT NULL,
    [NSECMID] VARCHAR(8) NULL,
    [BSECMID] VARCHAR(8) NULL,
    [SENDERPOAID] VARCHAR(16) NULL,
    [WITH_ROOT_FLAG] INT NULL,
    [THIRDPARTY_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delslipformat
-- --------------------------------------------------
CREATE TABLE [dbo].[delslipformat]
(
    [FormatProvider] VARCHAR(10) NOT NULL,
    [FromDp] VARCHAR(4) NOT NULL,
    [ToDp] VARCHAR(4) NOT NULL,
    [Detail] VARCHAR(10) NOT NULL,
    [PoolOrBen] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELSLIPMST
-- --------------------------------------------------
CREATE TABLE [dbo].[DELSLIPMST]
(
    [Dptype] CHAR(4) NULL,
    [Sliptype] VARCHAR(2) NULL,
    [Slipno] NUMERIC(18, 0) NULL,
    [Slflag] INT NULL,
    [Checksum] VARCHAR(5) NULL,
    [Dpid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [SLIPSERIES] VARCHAR(6) NULL,
    [SLIPSTATUS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Deltrans
-- --------------------------------------------------
CREATE TABLE [dbo].[Deltrans]
(
    [Sno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(20) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [Fromno] VARCHAR(16) NULL,
    [Tono] VARCHAR(16) NULL,
    [Certno] VARCHAR(16) NULL,
    [Foliono] VARCHAR(16) NULL,
    [Holdername] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [Orgqty] NUMERIC(18, 4) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [Branchcd] VARCHAR(10) NOT NULL,
    [Partipantcode] VARCHAR(10) NOT NULL,
    [Slipno] NUMERIC(18, 0) NULL,
    [Batchno] VARCHAR(10) NULL,
    [Isett_No] VARCHAR(7) NULL,
    [Isett_Type] VARCHAR(2) NULL,
    [Sharetype] VARCHAR(8) NULL,
    [Transdate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Bdptype] VARCHAR(10) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltdpid] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Deltranspi
-- --------------------------------------------------
CREATE TABLE [dbo].[Deltranspi]
(
    [Sno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [Fromno] VARCHAR(16) NULL,
    [Tono] VARCHAR(16) NULL,
    [Certno] VARCHAR(16) NULL,
    [Foliono] VARCHAR(16) NULL,
    [Holdername] VARCHAR(35) NULL,
    [Reason] VARCHAR(30) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [Orgqty] NUMERIC(18, 4) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [Branchcd] VARCHAR(10) NOT NULL,
    [Partipantcode] VARCHAR(10) NOT NULL,
    [Slipno] NUMERIC(18, 0) NULL,
    [Batchno] VARCHAR(10) NULL,
    [Isett_No] VARCHAR(7) NULL,
    [Isett_Type] VARCHAR(2) NULL,
    [Sharetype] VARCHAR(8) NULL,
    [Transdate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Bdptype] VARCHAR(10) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltdpid] VARCHAR(16) NULL,
    [Filler4] INT NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelTransPrintPool
-- --------------------------------------------------
CREATE TABLE [dbo].[DelTransPrintPool]
(
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [FromParty] VARCHAR(10) NOT NULL,
    [ToParty] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [CertNo] VARCHAR(12) NOT NULL,
    [TrType] INT NOT NULL,
    [BDpType] VARCHAR(4) NOT NULL,
    [BDpId] VARCHAR(8) NOT NULL,
    [BCltDpId] VARCHAR(16) NOT NULL,
    [ISett_No] VARCHAR(7) NOT NULL,
    [ISett_Type] VARCHAR(2) NOT NULL,
    [DpId] VARCHAR(8) NOT NULL,
    [CltDpId] VARCHAR(16) NOT NULL,
    [SlipNo] NUMERIC(18, 0) NOT NULL,
    [Batchno] VARCHAR(10) NOT NULL,
    [FolioNo] VARCHAR(16) NOT NULL,
    [TransDate] DATETIME NOT NULL,
    [HolderName] VARCHAR(100) NOT NULL,
    [OptionFlag] INT NOT NULL,
    [Qty] NUMERIC(18, 4) NULL,
    [NewQty] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Deltranstemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Deltranstemp]
(
    [Sno] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [Fromno] VARCHAR(16) NULL,
    [Tono] VARCHAR(16) NULL,
    [Certno] VARCHAR(16) NULL,
    [Foliono] VARCHAR(16) NULL,
    [Holdername] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [Orgqty] NUMERIC(18, 4) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [Branchcd] VARCHAR(10) NOT NULL,
    [Partipantcode] VARCHAR(10) NOT NULL,
    [Slipno] NUMERIC(18, 0) NULL,
    [Batchno] VARCHAR(10) NULL,
    [Isett_No] VARCHAR(7) NULL,
    [Isett_Type] VARCHAR(2) NULL,
    [Sharetype] VARCHAR(8) NULL,
    [Transdate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Bdptype] VARCHAR(10) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltdpid] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Demattrans
-- --------------------------------------------------
CREATE TABLE [dbo].[Demattrans]
(
    [Sno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(20) NULL,
    [Series] VARCHAR(3) NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [Trdate] DATETIME NOT NULL,
    [Cltaccno] VARCHAR(16) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Dpname] VARCHAR(50) NULL,
    [Isin] VARCHAR(12) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [Partipantcode] VARCHAR(10) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Transno] VARCHAR(15) NOT NULL,
    [Drcr] VARCHAR(1) NOT NULL,
    [Bdptype] VARCHAR(4) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltaccno] VARCHAR(16) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Filler4] INT NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Demattransout
-- --------------------------------------------------
CREATE TABLE [dbo].[Demattransout]
(
    [Sno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [Trdate] DATETIME NOT NULL,
    [Cltaccno] VARCHAR(16) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Dpname] VARCHAR(50) NULL,
    [Isin] VARCHAR(12) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [Partipantcode] VARCHAR(10) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Transno] VARCHAR(15) NOT NULL,
    [Drcr] VARCHAR(1) NOT NULL,
    [Bdptype] VARCHAR(4) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltaccno] VARCHAR(16) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Filler4] INT NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Demattransspeed
-- --------------------------------------------------
CREATE TABLE [dbo].[Demattransspeed]
(
    [Sno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [Trdate] DATETIME NOT NULL,
    [Cltaccno] VARCHAR(16) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Dpname] VARCHAR(50) NULL,
    [Isin] VARCHAR(12) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [Partipantcode] VARCHAR(10) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Transno] VARCHAR(15) NOT NULL,
    [Drcr] VARCHAR(1) NOT NULL,
    [Bdptype] VARCHAR(4) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltaccno] VARCHAR(16) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Filler4] INT NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_MObile_MOd_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_MObile_MOd_Details]
(
    [Sr_no] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Email] VARCHAR(50) NULL,
    [Mobile] VARCHAR(50) NULL,
    [Create_Date] DATETIME NULL DEFAULT (getdate()),
    [Flag] VARCHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ErrorLog
-- --------------------------------------------------
CREATE TABLE [dbo].[ErrorLog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILEDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FILEDATA]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROGID] VARCHAR(30) NULL,
    [FILE_DATA] VARCHAR(MAX) NULL,
    [UploadDateTime] DATETIME NULL,
    [UploadBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILELIST_suresh
-- --------------------------------------------------
CREATE TABLE [dbo].[FILELIST_suresh]
(
    [FILENAMELIST] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_after_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_after_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_before_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_before_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GLOBALS
-- --------------------------------------------------
CREATE TABLE [dbo].[GLOBALS]
(
    [Year] VARCHAR(4) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Service_Tax] NUMERIC(10, 4) NULL,
    [Service_Tax_Ac] VARCHAR(30) NULL,
    [Turnover_Ac] VARCHAR(30) NULL,
    [Sebi_Turn_Ac] VARCHAR(30) NULL,
    [Broker_Note_Ac] VARCHAR(30) NULL,
    [Other_Chrg_Ac] VARCHAR(30) NULL,
    [Exchange_Gl_Ac] VARCHAR(30) NULL,
    [Year_Start_Dt] DATETIME NULL,
    [Year_End_Dt] DATETIME NULL,
    [Cess_Tax] NUMERIC(10, 4) NULL,
    [Trdbuytrans] NUMERIC(18, 4) NULL,
    [Trdselltrans] NUMERIC(18, 4) NULL,
    [Delbuytrans] NUMERIC(18, 4) NULL,
    [Delselltrans] NUMERIC(18, 4) NULL,
    [EDUCESSTAX] NUMERIC(18, 4) NULL,
    [STT_TAX_AC] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.iaccbill
-- --------------------------------------------------
CREATE TABLE [dbo].[iaccbill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [Payin_Date] SMALLDATETIME NOT NULL,
    [Payout_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IMP_FilePath
-- --------------------------------------------------
CREATE TABLE [dbo].[IMP_FilePath]
(
    [File_Type] VARCHAR(20) NULL,
    [File_Path] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IMPORT_PARTY_CODE
-- --------------------------------------------------
CREATE TABLE [dbo].[IMPORT_PARTY_CODE]
(
    [PARTY_CODE] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MF_BANK
-- --------------------------------------------------
CREATE TABLE [dbo].[MF_BANK]
(
    [BANK_NAME] VARCHAR(50) NULL,
    [BANK_STATUS] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(100) NULL,
    [BANKCODE] VARCHAR(25) NULL,
    [SR_NO] INT IDENTITY(1,1) NOT NULL,
    [CREATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MfMissingclient
-- --------------------------------------------------
CREATE TABLE [dbo].[MfMissingclient]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(50) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(50) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] NUMERIC(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Ac_Type] VARCHAR(10) NULL,
    [Ac_Num] VARCHAR(30) NULL,
    [PrintF] VARCHAR(2) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] NUMERIC(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] VARCHAR(50) NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [Mobilevalidatedby] VARCHAR(20) NULL,
    [MobilevalidatedOn] DATETIME NULL,
    [pan_gir_no] VARCHAR(25) NULL,
    [trader] VARCHAR(20) NOT NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(10) NULL,
    [PerDay] MONEY NULL,
    [TradeDays] INT NULL,
    [ActiveFrom] DATETIME NULL,
    [InActiveFrom] DATETIME NULL,
    [ActiveFromEq] DATETIME NULL,
    [InactiveFromEq] DATETIME NULL,
    [ActiveFromComm] DATETIME NULL,
    [InactiveFromComm] DATETIME NULL,
    [CTActiveFrom] DATETIME NULL,
    [CTInactiveFrom] DATETIME NULL,
    [FirstTrade] DATETIME NULL,
    [LastTrade] DATETIME NULL,
    [FirstTradeComm] DATETIME NULL,
    [LastTradeComm] DATETIME NULL,
    [Clrating] VARCHAR(10) NULL,
    [AngelClRating] CHAR(10) NULL,
    [YearBrok] MONEY NULL,
    [Trend] CHAR(10) NULL,
    [RmDealer] VARCHAR(20) NULL,
    [CommDealer1] VARCHAR(20) NULL,
    [Commdealer2] VARCHAR(20) NULL,
    [Service] VARCHAR(10) NULL,
    [LastCommunication] DATETIME NULL,
    [ECN] VARCHAR(10) NULL,
    [B2C] CHAR(1) NULL,
    [FirstLedger] MONEY NULL,
    [FirstLedgerDate] DATETIME NULL,
    [EbrokingClient] CHAR(1) NULL,
    [NbFcClient] CHAR(1) NULL,
    [NbFcActivefrom] DATETIME NULL,
    [NbFcInactiveFrom] DATETIME NULL,
    [EbrokingTerminal] VARCHAR(20) NULL,
    [PastClient] VARCHAR(10) NULL,
    [ClientFlag] CHAR(1) NULL,
    [BlockSms] CHAR(1) NULL,
    [PureRisk] MONEY NOT NULL,
    [ProjectedRisk] MONEY NOT NULL,
    [PanInactiveFrom] DATETIME NULL,
    [BOBranch] VARCHAR(10) NULL,
    [Birthdate] DATETIME NULL,
    [Gender] VARCHAR(2) NULL,
    [TradingPlatform] VARCHAR(10) NULL,
    [ActiveFromCurr] DATETIME NULL,
    [InactiveFromCurr] DATETIME NULL,
    [FirstTradeCurr] DATETIME NULL,
    [LastTradeCurr] DATETIME NULL,
    [CurrencyDealer] VARCHAR(20) NULL,
    [ActiveFromMcxNcx] DATETIME NULL,
    [InActiveFromMcxNcx] DATETIME NULL,
    [FirstTradeMcxNcx] DATETIME NULL,
    [LastTradeMcxNcx] DATETIME NULL,
    [DPIDs] VARCHAR(200) NULL,
    [DPIDWithPOA] VARCHAR(100) NULL,
    [DPIDForPayout] VARCHAR(100) NULL,
    [IsActiveForEbrokingProduct] VARCHAR(1) NULL,
    [RiskCategory] VARCHAR(10) NULL,
    [FirstledgerdateEq] DATETIME NULL,
    [FirstledgerdateComm] DATETIME NULL,
    [FirstledgerdateCurr] DATETIME NULL,
    [BSEMFSSActiveFrom] DATETIME NULL,
    [BSEMFSSInActiveFrom] DATETIME NULL,
    [BSEMFSSFirstTrade] DATETIME NULL,
    [BSEMFSSLastTrade] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_09
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_09]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_A1102623
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_A1102623]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_A175211
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_A175211]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_B
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_B]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_L21793
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_L21793]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_p25177
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_p25177]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_P251771
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_P251771]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_S546057
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_S546057]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BROKERAGE_MASTER_S828849
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BROKERAGE_MASTER_S828849]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_BULK
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_BULK]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLIEN_TEMP_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLIEN_TEMP_TEST]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL,
    [FILLER1] VARCHAR(2) NULL,
    [FILLER2] VARCHAR(2) NULL,
    [AADHAR_UID] VARCHAR(20) NULL,
    [THIRDEXEMPT] VARCHAR(20) NULL,
    [THIRDEXEMPTCAT] VARCHAR(20) NULL,
    [THIRDHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [THIRDHOLDERCKYCNO] VARCHAR(20) NULL,
    [THIRDHOLDERKYCTYPE] VARCHAR(20) NULL,
    [SECOND_HOLDER_DOB] VARCHAR(10) NULL,
    [THIRD_HOLDER_DOB] VARCHAR(10) NULL,
    [GUARDIAN_DOB] VARCHAR(10) NULL,
    [CM_FORADD1] VARCHAR(50) NULL,
    [CM_FORADD3] VARCHAR(50) NULL,
    [CM_FORCITY] VARCHAR(50) NULL,
    [CM_FORPINCODE] VARCHAR(50) NULL,
    [CM_FORSTATE] VARCHAR(50) NULL,
    [CM_FORCOUNTRY] VARCHAR(50) NULL,
    [CM_FORRESIPHONE] VARCHAR(50) NULL,
    [CM_FORRESIFAX] VARCHAR(50) NULL,
    [CM_FOROFFPHONE] VARCHAR(50) NULL,
    [CM_FOROFFFAX] VARCHAR(50) NULL,
    [CM_FORADD2] VARCHAR(50) NULL,
    [PRIMARYEXEMPT] VARCHAR(20) NULL,
    [PRIMARYEXEMPTCAT] VARCHAR(20) NULL,
    [SECONDEXEMPT] VARCHAR(20) NULL,
    [SECONDEXEMPTCAT] VARCHAR(20) NULL,
    [GUARDIANEXEMPT] VARCHAR(20) NULL,
    [GUARDIANEXEMPTCAT] VARCHAR(20) NULL,
    [LEINO] VARCHAR(20) NULL,
    [LEIVALIDITY] VARCHAR(20) NULL,
    [PMS] VARCHAR(20) NULL,
    [PID] VARCHAR(20) NULL,
    [PAPERLESSFLAG] VARCHAR(20) NULL,
    [NOMINEEPER] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG] VARCHAR(20) NULL,
    [NOMINEEDOB] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN] VARCHAR(20) NULL,
    [PRIMARYHOLDERKYCTYPE] VARCHAR(20) NULL,
    [GUARDIANHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [SECONDHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [PRIMARYHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [GUARDIANHOLDERCKYCNO] VARCHAR(20) NULL,
    [GUARDIANHOLDERKYCTYPE] VARCHAR(20) NULL,
    [SECONDHOLDERCKYCNO] VARCHAR(20) NULL,
    [SECONDHOLDERKYCTYPE] VARCHAR(20) NULL,
    [PRIMARYHOLDERCKYCNO] VARCHAR(20) NULL,
    [AADHARUPDATED] VARCHAR(20) NULL,
    [IFSCCODE] VARCHAR(20) NULL,
    [PD_CLTYPE] VARCHAR(1) NULL,
    [NOMINEE_NAME2] VARCHAR(50) NULL,
    [NOMINEE_RELATION2] VARCHAR(50) NULL,
    [NOMINEEPER2] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG2] VARCHAR(20) NULL,
    [NOMINEEDOB2] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN2] VARCHAR(20) NULL,
    [NOMINEE_NAME3] VARCHAR(50) NULL,
    [NOMINEE_RELATION3] VARCHAR(50) NULL,
    [NOMINEEPER3] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG3] VARCHAR(20) NULL,
    [NOMINEEDOB3] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN3] VARCHAR(20) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [ADDRESS12] VARCHAR(50) NULL,
    [ADDRESS22] VARCHAR(50) NULL,
    [ADDRESS13] VARCHAR(50) NULL,
    [ADDRESS23] VARCHAR(50) NULL,
    [NOMINEEPHONE] VARCHAR(20) NULL,
    [NOMINEEPHONE2] VARCHAR(20) NULL,
    [NOMINEEPHONE3] VARCHAR(20) NULL,
    [PIN] VARCHAR(20) NULL,
    [PIN2] VARCHAR(20) NULL,
    [PIN3] VARCHAR(20) NULL,
    [NOMINEEPANNO] VARCHAR(20) NULL,
    [NOMINEEPANNO2] VARCHAR(20) NULL,
    [NOMINEEPANNO3] VARCHAR(20) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [EMAIL2] VARCHAR(100) NULL,
    [EMAIL3] VARCHAR(100) NULL,
    [GAURDPAN] VARCHAR(12) NULL,
    [GAURDPAN2] VARCHAR(12) NULL,
    [GAURDPAN3] VARCHAR(12) NULL,
    [GUARDIANPHONE] VARCHAR(20) NULL,
    [GUARDIANPHONE2] VARCHAR(20) NULL,
    [GUARDIANPHONE3] VARCHAR(20) NULL,
    [NOBANKAC] VARCHAR(20) NULL,
    [NODMAT] VARCHAR(20) NULL,
    [NOAADHAR] VARCHAR(20) NULL,
    [GARBANKAC] VARCHAR(20) NULL,
    [GARDMAT] VARCHAR(20) NULL,
    [GARAADHAR] VARCHAR(20) NULL,
    [NOBANKAC2] VARCHAR(20) NULL,
    [NODMAT2] VARCHAR(20) NULL,
    [NOAADHAR2] VARCHAR(20) NULL,
    [GARBANKAC2] VARCHAR(20) NULL,
    [GARDMAT2] VARCHAR(20) NULL,
    [GARAADHAR2] VARCHAR(20) NULL,
    [NOBANKAC3] VARCHAR(20) NULL,
    [NODMAT3] VARCHAR(20) NULL,
    [NOAADHAR3] VARCHAR(20) NULL,
    [GARBANKAC3] VARCHAR(20) NULL,
    [GARDMAT3] VARCHAR(20) NULL,
    [GARAADHAR3] VARCHAR(20) NULL,
    [GARADDRESS1] VARCHAR(50) NULL,
    [GARADDRESS2] VARCHAR(50) NULL,
    [GARPHONE] VARCHAR(20) NULL,
    [GARPIN] VARCHAR(20) NULL,
    [GAREMAIL] VARCHAR(50) NULL,
    [GARRELATION] VARCHAR(50) NULL,
    [GARADDRESS12] VARCHAR(50) NULL,
    [GARADDRESS22] VARCHAR(50) NULL,
    [GARPHONE2] VARCHAR(20) NULL,
    [GARPIN2] VARCHAR(20) NULL,
    [GAREMAIL2] VARCHAR(50) NULL,
    [GARRELATION2] VARCHAR(50) NULL,
    [GARADDRESS13] VARCHAR(50) NULL,
    [GARADDRESS23] VARCHAR(50) NULL,
    [GARPHONE3] VARCHAR(20) NULL,
    [GARPIN3] VARCHAR(20) NULL,
    [GAREMAIL3] VARCHAR(50) NULL,
    [GARRELATION3] VARCHAR(50) NULL,
    [NOMREQ] VARCHAR(1) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLIENT]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL,
    [FILLER1] VARCHAR(2) NULL,
    [FILLER2] VARCHAR(2) NULL,
    [AADHAR_UID] VARCHAR(20) NULL,
    [THIRDEXEMPT] VARCHAR(20) NULL,
    [THIRDEXEMPTCAT] VARCHAR(20) NULL,
    [THIRDHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [THIRDHOLDERCKYCNO] VARCHAR(20) NULL,
    [THIRDHOLDERKYCTYPE] VARCHAR(20) NULL,
    [SECOND_HOLDER_DOB] VARCHAR(10) NULL,
    [THIRD_HOLDER_DOB] VARCHAR(10) NULL,
    [GUARDIAN_DOB] VARCHAR(10) NULL,
    [CM_FORADD1] VARCHAR(50) NULL,
    [CM_FORADD3] VARCHAR(50) NULL,
    [CM_FORCITY] VARCHAR(50) NULL,
    [CM_FORPINCODE] VARCHAR(50) NULL,
    [CM_FORSTATE] VARCHAR(50) NULL,
    [CM_FORCOUNTRY] VARCHAR(50) NULL,
    [CM_FORRESIPHONE] VARCHAR(50) NULL,
    [CM_FORRESIFAX] VARCHAR(50) NULL,
    [CM_FOROFFPHONE] VARCHAR(50) NULL,
    [CM_FOROFFFAX] VARCHAR(50) NULL,
    [CM_FORADD2] VARCHAR(50) NULL,
    [PRIMARYEXEMPT] VARCHAR(20) NULL,
    [PRIMARYEXEMPTCAT] VARCHAR(20) NULL,
    [SECONDEXEMPT] VARCHAR(20) NULL,
    [SECONDEXEMPTCAT] VARCHAR(20) NULL,
    [GUARDIANEXEMPT] VARCHAR(20) NULL,
    [GUARDIANEXEMPTCAT] VARCHAR(20) NULL,
    [LEINO] VARCHAR(20) NULL,
    [LEIVALIDITY] VARCHAR(20) NULL,
    [PMS] VARCHAR(20) NULL,
    [PID] VARCHAR(20) NULL,
    [PAPERLESSFLAG] VARCHAR(20) NULL,
    [NOMINEEPER] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG] VARCHAR(20) NULL,
    [NOMINEEDOB] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN] VARCHAR(20) NULL,
    [PRIMARYHOLDERKYCTYPE] VARCHAR(20) NULL,
    [GUARDIANHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [SECONDHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [PRIMARYHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [GUARDIANHOLDERCKYCNO] VARCHAR(20) NULL,
    [GUARDIANHOLDERKYCTYPE] VARCHAR(20) NULL,
    [SECONDHOLDERCKYCNO] VARCHAR(20) NULL,
    [SECONDHOLDERKYCTYPE] VARCHAR(20) NULL,
    [PRIMARYHOLDERCKYCNO] VARCHAR(20) NULL,
    [AADHARUPDATED] VARCHAR(20) NULL,
    [IFSCCODE] VARCHAR(20) NULL,
    [PD_CLTYPE] VARCHAR(1) NULL,
    [NOMINEE_NAME2] VARCHAR(50) NULL,
    [NOMINEE_RELATION2] VARCHAR(50) NULL,
    [NOMINEEPER2] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG2] VARCHAR(20) NULL,
    [NOMINEEDOB2] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN2] VARCHAR(20) NULL,
    [NOMINEE_NAME3] VARCHAR(50) NULL,
    [NOMINEE_RELATION3] VARCHAR(50) NULL,
    [NOMINEEPER3] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG3] VARCHAR(20) NULL,
    [NOMINEEDOB3] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN3] VARCHAR(20) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [ADDRESS12] VARCHAR(50) NULL,
    [ADDRESS22] VARCHAR(50) NULL,
    [ADDRESS13] VARCHAR(50) NULL,
    [ADDRESS23] VARCHAR(50) NULL,
    [NOMINEEPHONE] VARCHAR(20) NULL,
    [NOMINEEPHONE2] VARCHAR(20) NULL,
    [NOMINEEPHONE3] VARCHAR(20) NULL,
    [PIN] VARCHAR(20) NULL,
    [PIN2] VARCHAR(20) NULL,
    [PIN3] VARCHAR(20) NULL,
    [NOMINEEPANNO] VARCHAR(20) NULL,
    [NOMINEEPANNO2] VARCHAR(20) NULL,
    [NOMINEEPANNO3] VARCHAR(20) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [EMAIL2] VARCHAR(100) NULL,
    [EMAIL3] VARCHAR(100) NULL,
    [GAURDPAN] VARCHAR(12) NULL,
    [GAURDPAN2] VARCHAR(12) NULL,
    [GAURDPAN3] VARCHAR(12) NULL,
    [GUARDIANPHONE] VARCHAR(20) NULL,
    [GUARDIANPHONE2] VARCHAR(20) NULL,
    [GUARDIANPHONE3] VARCHAR(20) NULL,
    [NOBANKAC] VARCHAR(20) NULL,
    [NODMAT] VARCHAR(20) NULL,
    [NOAADHAR] VARCHAR(20) NULL,
    [GARBANKAC] VARCHAR(20) NULL,
    [GARDMAT] VARCHAR(20) NULL,
    [GARAADHAR] VARCHAR(20) NULL,
    [NOBANKAC2] VARCHAR(20) NULL,
    [NODMAT2] VARCHAR(20) NULL,
    [NOAADHAR2] VARCHAR(20) NULL,
    [GARBANKAC2] VARCHAR(20) NULL,
    [GARDMAT2] VARCHAR(20) NULL,
    [GARAADHAR2] VARCHAR(20) NULL,
    [NOBANKAC3] VARCHAR(20) NULL,
    [NODMAT3] VARCHAR(20) NULL,
    [NOAADHAR3] VARCHAR(20) NULL,
    [GARBANKAC3] VARCHAR(20) NULL,
    [GARDMAT3] VARCHAR(20) NULL,
    [GARAADHAR3] VARCHAR(20) NULL,
    [GARADDRESS1] VARCHAR(50) NULL,
    [GARADDRESS2] VARCHAR(50) NULL,
    [GARPHONE] VARCHAR(20) NULL,
    [GARPIN] VARCHAR(20) NULL,
    [GAREMAIL] VARCHAR(50) NULL,
    [GARRELATION] VARCHAR(50) NULL,
    [GARADDRESS12] VARCHAR(50) NULL,
    [GARADDRESS22] VARCHAR(50) NULL,
    [GARPHONE2] VARCHAR(20) NULL,
    [GARPIN2] VARCHAR(20) NULL,
    [GAREMAIL2] VARCHAR(50) NULL,
    [GARRELATION2] VARCHAR(50) NULL,
    [GARADDRESS13] VARCHAR(50) NULL,
    [GARADDRESS23] VARCHAR(50) NULL,
    [GARPHONE3] VARCHAR(20) NULL,
    [GARPIN3] VARCHAR(20) NULL,
    [GAREMAIL3] VARCHAR(50) NULL,
    [GARRELATION3] VARCHAR(50) NULL,
    [NOMREQ] VARCHAR(1) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_client_15092022
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_client_15092022]
(
    [MFSS_INACTIVE_FROM] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [196_MSJAG_INACTIVE_FROM] DATETIME NULL,
    [cl_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfss_client_18122015_oreg
-- --------------------------------------------------
CREATE TABLE [dbo].[mfss_client_18122015_oreg]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_client_28AUG18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_client_28AUG18]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [INACTIVE_FROM] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLIENT_bank_Merger
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLIENT_bank_Merger]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLIENT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLIENT_LOG]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [EDITEDBY] VARCHAR(50) NOT NULL,
    [EDITEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL,
    [FILLER1] VARCHAR(2) NULL,
    [FILLER2] VARCHAR(2) NULL,
    [SECOND_HOLDER_DOB] VARCHAR(10) NULL,
    [THIRD_HOLDER_DOB] VARCHAR(10) NULL,
    [GUARDIAN_DOB] VARCHAR(10) NULL,
    [AADHAR_UID] VARCHAR(20) NULL,
    [CM_FORADD1] VARCHAR(50) NULL,
    [CM_FORADD3] VARCHAR(50) NULL,
    [CM_FORCITY] VARCHAR(50) NULL,
    [CM_FORPINCODE] VARCHAR(50) NULL,
    [CM_FORSTATE] VARCHAR(50) NULL,
    [CM_FORCOUNTRY] VARCHAR(50) NULL,
    [CM_FORRESIPHONE] VARCHAR(50) NULL,
    [CM_FORRESIFAX] VARCHAR(50) NULL,
    [CM_FOROFFPHONE] VARCHAR(50) NULL,
    [CM_FOROFFFAX] VARCHAR(50) NULL,
    [CM_FORADD2] VARCHAR(50) NULL,
    [PRIMARYEXEMPT] VARCHAR(20) NULL,
    [PRIMARYEXEMPTCAT] VARCHAR(20) NULL,
    [SECONDEXEMPT] VARCHAR(20) NULL,
    [SECONDEXEMPTCAT] VARCHAR(20) NULL,
    [GUARDIANEXEMPT] VARCHAR(20) NULL,
    [GUARDIANEXEMPTCAT] VARCHAR(20) NULL,
    [LEINO] VARCHAR(20) NULL,
    [LEIVALIDITY] VARCHAR(20) NULL,
    [PMS] VARCHAR(20) NULL,
    [PID] VARCHAR(20) NULL,
    [PAPERLESSFLAG] VARCHAR(20) NULL,
    [NOMINEEPER] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG] VARCHAR(20) NULL,
    [NOMINEEDOB] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN] VARCHAR(20) NULL,
    [PRIMARYHOLDERKYCTYPE] VARCHAR(20) NULL,
    [GUARDIANHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [SECONDHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [PRIMARYHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [GUARDIANHOLDERCKYCNO] VARCHAR(20) NULL,
    [GUARDIANHOLDERKYCTYPE] VARCHAR(20) NULL,
    [SECONDHOLDERCKYCNO] VARCHAR(20) NULL,
    [SECONDHOLDERKYCTYPE] VARCHAR(20) NULL,
    [PRIMARYHOLDERCKYCNO] VARCHAR(20) NULL,
    [AADHARUPDATED] VARCHAR(20) NULL,
    [IFSCCODE] VARCHAR(20) NULL,
    [PD_CLTYPE] VARCHAR(1) NULL,
    [NOMINEE_NAME2] VARCHAR(50) NULL,
    [NOMINEE_RELATION2] VARCHAR(50) NULL,
    [NOMINEEPER2] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG2] VARCHAR(20) NULL,
    [NOMINEEDOB2] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN2] VARCHAR(20) NULL,
    [NOMINEE_NAME3] VARCHAR(50) NULL,
    [NOMINEE_RELATION3] VARCHAR(50) NULL,
    [NOMINEEPER3] VARCHAR(20) NULL,
    [NOMINEEMINORFLAG3] VARCHAR(20) NULL,
    [NOMINEEDOB3] VARCHAR(20) NULL,
    [NOMINEEGUARDIAN3] VARCHAR(20) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [ADDRESS12] VARCHAR(50) NULL,
    [ADDRESS22] VARCHAR(50) NULL,
    [ADDRESS13] VARCHAR(50) NULL,
    [ADDRESS23] VARCHAR(50) NULL,
    [NOMINEEPHONE] VARCHAR(20) NULL,
    [NOMINEEPHONE2] VARCHAR(20) NULL,
    [NOMINEEPHONE3] VARCHAR(20) NULL,
    [PIN] VARCHAR(20) NULL,
    [PIN2] VARCHAR(20) NULL,
    [PIN3] VARCHAR(20) NULL,
    [NOMINEEPANNO] VARCHAR(20) NULL,
    [NOMINEEPANNO2] VARCHAR(20) NULL,
    [NOMINEEPANNO3] VARCHAR(20) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [EMAIL2] VARCHAR(100) NULL,
    [EMAIL3] VARCHAR(100) NULL,
    [GAURDPAN] VARCHAR(12) NULL,
    [GAURDPAN2] VARCHAR(12) NULL,
    [GAURDPAN3] VARCHAR(12) NULL,
    [GUARDIANPHONE] VARCHAR(20) NULL,
    [GUARDIANPHONE2] VARCHAR(20) NULL,
    [GUARDIANPHONE3] VARCHAR(20) NULL,
    [NOBANKAC] VARCHAR(20) NULL,
    [NODMAT] VARCHAR(20) NULL,
    [NOAADHAR] VARCHAR(20) NULL,
    [GARBANKAC] VARCHAR(20) NULL,
    [GARDMAT] VARCHAR(20) NULL,
    [GARAADHAR] VARCHAR(20) NULL,
    [NOBANKAC2] VARCHAR(20) NULL,
    [NODMAT2] VARCHAR(20) NULL,
    [NOAADHAR2] VARCHAR(20) NULL,
    [GARBANKAC2] VARCHAR(20) NULL,
    [GARDMAT2] VARCHAR(20) NULL,
    [GARAADHAR2] VARCHAR(20) NULL,
    [NOBANKAC3] VARCHAR(20) NULL,
    [NODMAT3] VARCHAR(20) NULL,
    [NOAADHAR3] VARCHAR(20) NULL,
    [GARBANKAC3] VARCHAR(20) NULL,
    [GARDMAT3] VARCHAR(20) NULL,
    [GARAADHAR3] VARCHAR(20) NULL,
    [GARADDRESS1] VARCHAR(50) NULL,
    [GARADDRESS2] VARCHAR(50) NULL,
    [GARPHONE] VARCHAR(20) NULL,
    [GARPIN] VARCHAR(20) NULL,
    [GAREMAIL] VARCHAR(50) NULL,
    [GARRELATION] VARCHAR(50) NULL,
    [GARADDRESS12] VARCHAR(50) NULL,
    [GARADDRESS22] VARCHAR(50) NULL,
    [GARPHONE2] VARCHAR(20) NULL,
    [GARPIN2] VARCHAR(20) NULL,
    [GAREMAIL2] VARCHAR(50) NULL,
    [GARRELATION2] VARCHAR(50) NULL,
    [GARADDRESS13] VARCHAR(50) NULL,
    [GARADDRESS23] VARCHAR(50) NULL,
    [GARPHONE3] VARCHAR(20) NULL,
    [GARPIN3] VARCHAR(20) NULL,
    [GAREMAIL3] VARCHAR(50) NULL,
    [GARRELATION3] VARCHAR(50) NULL,
    [NOMREQ] VARCHAR(1) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(50) NULL,
    [THIRDEXEMPTCAT] VARCHAR(20) NULL,
    [THIRDHOLDERKRAEXEMPTNO] VARCHAR(20) NULL,
    [THIRDHOLDERCKYCNO] VARCHAR(20) NULL,
    [THIRDHOLDERKYCTYPE] VARCHAR(20) NULL,
    [THIRDEXEMPT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLIENT_mob
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLIENT_mob]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLIENT_trig
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLIENT_trig]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL,
    [Action] VARCHAR(15) NULL,
    [USER_IP] VARCHAR(20) NULL,
    [APPNAME] VARCHAR(200) NULL,
    [MODIFIED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CLMST_VALUES
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CLMST_VALUES]
(
    [V_TYPE] VARCHAR(10) NULL,
    [V_CODE] VARCHAR(10) NULL,
    [V_VALUE] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_CONFIRMVIEW_bkup_14Jul20
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_CONFIRMVIEW_bkup_14Jul20]
(
    [CONTRACTNO] VARCHAR(7) NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] DECIMAL(33, 14) NULL,
    [INS_CHRG] NUMERIC(3, 2) NOT NULL,
    [TURN_TAX] NUMERIC(3, 2) NOT NULL,
    [OTHER_CHRG] NUMERIC(3, 2) NOT NULL,
    [SEBI_TAX] NUMERIC(3, 2) NOT NULL,
    [BROKER_CHRG] NUMERIC(3, 2) NOT NULL,
    [SERVICE_TAX] NUMERIC(38, 12) NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DFDS
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DFDS]
(
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Series] VARCHAR(2) NOT NULL,
    [IsIn] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(50) NOT NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [DpId] VARCHAR(8) NOT NULL,
    [CltDpId] VARCHAR(16) NOT NULL,
    [TransNo] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DONODELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DONODELETE]
(
    [CL_CODE] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DPMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DPMASTER]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [DEFAULTDP] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [POAFLAG] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DPMASTER_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DPMASTER_LOG]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [DEFAULTDP] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [EDITEDBY] VARCHAR(50) NOT NULL,
    [EDITEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DPMASTER_MFSS_DPMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DPMASTER_MFSS_DPMASTER]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [DEFAULTDP] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [POAFLAG] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DUMP1
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DUMP1]
(
    [PARTY_CODE] CHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [SBU] VARCHAR(2) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] CHAR(1) NOT NULL,
    [OCCUPATION_CODE] VARCHAR(1) NOT NULL,
    [TAX_STATUS] VARCHAR(1) NOT NULL,
    [PAN_NO] VARCHAR(20) NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(40) NOT NULL,
    [ADDR2] VARCHAR(40) NULL,
    [ADDR3] VARCHAR(40) NULL,
    [CITY] VARCHAR(40) NULL,
    [STATE] VARCHAR(50) NULL,
    [ZIP] VARCHAR(10) NULL,
    [NATION] VARCHAR(15) NULL,
    [OFFICE_PHONE] VARCHAR(15) NULL,
    [RES_PHONE] VARCHAR(15) NULL,
    [MOBILE_NO] VARCHAR(40) NULL,
    [EMAIL_ID] VARCHAR(50) NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(40) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [ACC_NO] VARCHAR(20) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(10) NOT NULL,
    [DOB] DATETIME NULL,
    [GAURDIAN_NAME] VARCHAR(100) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(1) NOT NULL,
    [NOMINEE_NAME] VARCHAR(1) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(1) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(2) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(7) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(20) NOT NULL,
    [MODE_HOLDING] VARCHAR(3) NULL,
    [HOLDER2_CODE] VARCHAR(1) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(25) NOT NULL,
    [HOLDER2_KYC_FLAG] VARCHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(1) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(25) NOT NULL,
    [HOLDER3_KYC_FLAG] VARCHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(1) NOT NULL,
    [CHEQUENAME] VARCHAR(1) NOT NULL,
    [RESIFAX] VARCHAR(1) NOT NULL,
    [OFFICEFAX] VARCHAR(1) NOT NULL,
    [MAPINID] VARCHAR(1) NOT NULL,
    [REMARK] VARCHAR(1) NOT NULL,
    [UCC_STATUS] VARCHAR(1) NOT NULL,
    [ADDEDBY] VARCHAR(4) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NOT NULL,
    [INACTIVE_FROM] DATETIME NOT NULL,
    [POAFLAG] INT NOT NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NOT NULL,
    [DEACTIVE_REMARK] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_DUMP11
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_DUMP11]
(
    [STATUS] VARCHAR(40) NULL,
    [PARTY_CODE] CHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [SBU] VARCHAR(2) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NULL,
    [OCCUPATION_CODE] VARCHAR(1) NOT NULL,
    [TAX_STATUS] VARCHAR(1) NOT NULL,
    [PAN_NO] VARCHAR(20) NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(40) NOT NULL,
    [ADDR2] VARCHAR(40) NULL,
    [ADDR3] VARCHAR(40) NULL,
    [CITY] VARCHAR(40) NULL,
    [STATE] VARCHAR(50) NULL,
    [ZIP] VARCHAR(10) NULL,
    [NATION] VARCHAR(15) NULL,
    [OFFICE_PHONE] VARCHAR(15) NULL,
    [RES_PHONE] VARCHAR(15) NULL,
    [MOBILE_NO] VARCHAR(40) NULL,
    [EMAIL_ID] VARCHAR(50) NULL,
    [BANK_NAME] VARCHAR(40) NULL,
    [BANK_BRANCH] VARCHAR(30) NOT NULL,
    [BANK_CITY] VARCHAR(30) NOT NULL,
    [ACC_NO] VARCHAR(20) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [NEFTCODE] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NULL,
    [GAURDIAN_NAME] VARCHAR(100) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(1) NOT NULL,
    [NOMINEE_NAME] VARCHAR(100) NULL,
    [NOMINEE_RELATION] VARCHAR(1) NOT NULL,
    [BANK_AcC_TYPE] NUMERIC(18, 0) NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(7) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(20) NOT NULL,
    [MODE_HOLDING] CHAR(2) NULL,
    [HOLDER2_CODE] VARCHAR(1) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(25) NOT NULL,
    [HOLDER2_KYC_FLAG] VARCHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(1) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(25) NOT NULL,
    [HOLDER3_KYC_FLAG] VARCHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [CHEQUENAME] VARCHAR(1) NOT NULL,
    [RESIFAX] VARCHAR(1) NOT NULL,
    [OFFICEFAX] VARCHAR(1) NOT NULL,
    [MAPINID] VARCHAR(1) NOT NULL,
    [REMARK] VARCHAR(1) NOT NULL,
    [UCC_STATUS] VARCHAR(1) NOT NULL,
    [ADDEDBY] VARCHAR(4) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NOT NULL,
    [INACTIVE_FROM] DATETIME NOT NULL,
    [POAFLAG] INT NOT NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NOT NULL,
    [DEACTIVE_REMARK] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_FINAL_LIST
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_FINAL_LIST]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(50) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(50) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] NUMERIC(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Ac_Type] VARCHAR(10) NULL,
    [Ac_Num] VARCHAR(30) NULL,
    [PrintF] VARCHAR(2) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] NUMERIC(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] VARCHAR(50) NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [Mobilevalidatedby] VARCHAR(20) NULL,
    [MobilevalidatedOn] DATETIME NULL,
    [pan_gir_no] VARCHAR(25) NULL,
    [trader] VARCHAR(20) NOT NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(10) NULL,
    [PerDay] MONEY NULL,
    [TradeDays] INT NULL,
    [ActiveFrom] DATETIME NULL,
    [InActiveFrom] DATETIME NULL,
    [ActiveFromEq] DATETIME NULL,
    [InactiveFromEq] DATETIME NULL,
    [ActiveFromComm] DATETIME NULL,
    [InactiveFromComm] DATETIME NULL,
    [CTActiveFrom] DATETIME NULL,
    [CTInactiveFrom] DATETIME NULL,
    [FirstTrade] DATETIME NULL,
    [LastTrade] DATETIME NULL,
    [FirstTradeComm] DATETIME NULL,
    [LastTradeComm] DATETIME NULL,
    [Clrating] VARCHAR(10) NULL,
    [AngelClRating] CHAR(10) NULL,
    [YearBrok] MONEY NULL,
    [Trend] CHAR(10) NULL,
    [RmDealer] VARCHAR(20) NULL,
    [CommDealer1] VARCHAR(20) NULL,
    [Commdealer2] VARCHAR(20) NULL,
    [Service] VARCHAR(10) NULL,
    [LastCommunication] DATETIME NULL,
    [ECN] VARCHAR(10) NULL,
    [B2C] CHAR(1) NULL,
    [FirstLedger] MONEY NULL,
    [FirstLedgerDate] DATETIME NULL,
    [EbrokingClient] CHAR(1) NULL,
    [NbFcClient] CHAR(1) NULL,
    [NbFcActivefrom] DATETIME NULL,
    [NbFcInactiveFrom] DATETIME NULL,
    [EbrokingTerminal] VARCHAR(20) NULL,
    [PastClient] VARCHAR(10) NULL,
    [ClientFlag] CHAR(1) NULL,
    [BlockSms] CHAR(1) NULL,
    [PureRisk] MONEY NOT NULL,
    [ProjectedRisk] MONEY NOT NULL,
    [PanInactiveFrom] DATETIME NULL,
    [BOBranch] VARCHAR(10) NULL,
    [Birthdate] DATETIME NULL,
    [Gender] VARCHAR(2) NULL,
    [TradingPlatform] VARCHAR(10) NULL,
    [ActiveFromCurr] DATETIME NULL,
    [InactiveFromCurr] DATETIME NULL,
    [FirstTradeCurr] DATETIME NULL,
    [LastTradeCurr] DATETIME NULL,
    [CurrencyDealer] VARCHAR(20) NULL,
    [ActiveFromMcxNcx] DATETIME NULL,
    [InActiveFromMcxNcx] DATETIME NULL,
    [FirstTradeMcxNcx] DATETIME NULL,
    [LastTradeMcxNcx] DATETIME NULL,
    [DPIDs] VARCHAR(200) NULL,
    [DPIDWithPOA] VARCHAR(100) NULL,
    [DPIDForPayout] VARCHAR(100) NULL,
    [IsActiveForEbrokingProduct] VARCHAR(1) NULL,
    [RiskCategory] VARCHAR(10) NULL,
    [FirstledgerdateEq] DATETIME NULL,
    [FirstledgerdateComm] DATETIME NULL,
    [FirstledgerdateCurr] DATETIME NULL,
    [BSEMFSSActiveFrom] DATETIME NULL,
    [BSEMFSSInActiveFrom] DATETIME NULL,
    [BSEMFSSFirstTrade] DATETIME NULL,
    [BSEMFSSLastTrade] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_FUNDS_OBLIGATION
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_FUNDS_OBLIGATION]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SETTLEMENT_DATE] DATETIME NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [DP_ID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [ORDER_NO] NUMERIC(18, 0) NOT NULL,
    [ORDER_INDICATOR] VARCHAR(1) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [AVAIL_AMOUNT] NUMERIC(18, 4) NOT NULL,
    [PROCESSDATE] DATETIME NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_NAV
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_NAV]
(
    [NAV_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [DIV_REINVEST_FLAG] VARCHAR(5) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [NAV_VALUE] NUMERIC(18, 4) NOT NULL,
    [RTA_CODE] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_03DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_03DEC18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_04DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_04DEC18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_05Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_05Dec18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_05Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_05Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_06dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_06dec18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_07DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_07DEC18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_09Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_09Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_10Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_10Dec18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_10Nov2021
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_10Nov2021]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_11Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_11Dec18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_12Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_12Dec18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_12Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_12Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_13Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_13Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_15042021
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_15042021]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_15Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_15Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_16Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_16Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_1712017_84
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_1712017_84]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_17Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_17Dec18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_17Dec18_1
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_17Dec18_1]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_19DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_19DEC18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_20Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_20Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_20Nov18_1
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_20Nov18_1]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_23DEC19
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_23DEC19]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_26Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_26Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_27Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_27Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_28Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_28Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_30Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_30Nov18]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_B311360_14FEB22
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_B311360_14FEB22]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_order_backup29July2022
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_order_backup29July2022]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_BKUP_14JUL20
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_BKUP_14JUL20]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_BKUP_28JUL20
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_BKUP_28JUL20]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_Daily
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_Daily]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_M10001
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_M10001]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_STATUS]
(
    [REPORTDATE] DATETIME NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [USERID] VARCHAR(20) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [RTA_TRANS_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [F_CL_NAME] VARCHAR(100) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [RECFLAG] VARCHAR(1) NULL,
    [REMARK] VARCHAR(100) NULL,
    [RECFOR] VARCHAR(1) NULL,
    [STT] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [Sub_BR_Code] VARCHAR(50) NULL,
    [EUIN] VARCHAR(20) NULL,
    [EUIN_DECL] VARCHAR(20) NULL,
    [DPC_Flag] VARCHAR(25) NULL,
    [DP_TRANS] VARCHAR(20) NULL,
    [ORD_SUB_TYPE] VARCHAR(20) NULL,
    [ALT_SCHEME_NAME] VARCHAR(200) NULL,
    [ALT_STAMP_DUTY] NUMERIC(18, 4) NULL,
    [ALT_EXIT_LOAD] NUMERIC(18, 4) NULL,
    [ALT_TAX] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_STATUS_BKUP_28JUL20
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_STATUS_BKUP_28JUL20]
(
    [REPORTDATE] DATETIME NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [USERID] VARCHAR(20) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [RTA_TRANS_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [F_CL_NAME] VARCHAR(100) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [RECFLAG] VARCHAR(1) NULL,
    [REMARK] VARCHAR(100) NULL,
    [RECFOR] VARCHAR(1) NULL,
    [STT] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [Sub_BR_Code] VARCHAR(50) NULL,
    [EUIN] VARCHAR(20) NULL,
    [EUIN_DECL] VARCHAR(20) NULL,
    [DPC_Flag] VARCHAR(25) NULL,
    [DP_TRANS] VARCHAR(20) NULL,
    [ORD_SUB_TYPE] VARCHAR(20) NULL,
    [ALT_SCHEME_NAME] VARCHAR(200) NULL,
    [ALT_STAMP_DUTY] NUMERIC(18, 4) NULL,
    [ALT_EXIT_LOAD] NUMERIC(18, 4) NULL,
    [ALT_TAX] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_STATUS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_STATUS_LOG]
(
    [REPORTDATE] DATETIME NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [USERID] VARCHAR(20) NOT NULL,
    [FOLIONO] VARCHAR(20) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [RTA_TRANS_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [F_CL_NAME] VARCHAR(150) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [RECFLAG] VARCHAR(1) NULL,
    [REMARK] VARCHAR(150) NULL,
    [RECFOR] VARCHAR(1) NULL,
    [STT] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(15) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [Sub_BR_Code] VARCHAR(20) NULL,
    [EUIN] VARCHAR(20) NULL,
    [EUIN_DECL] VARCHAR(20) NULL,
    [DPC_Flag] VARCHAR(20) NULL,
    [DP_TRANS] VARCHAR(20) NULL,
    [Order_Sub_Type] VARCHAR(20) NULL,
    [ALT_SCHEME_NAME] VARCHAR(200) NULL,
    [ALT_STAMP_DUTY] NUMERIC(18, 4) NULL,
    [ALT_EXIT_LOAD] NUMERIC(18, 4) NULL,
    [ALT_TAX] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_STATUS_LOG_30062021
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_STATUS_LOG_30062021]
(
    [REPORTDATE] DATETIME NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [USERID] VARCHAR(20) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [RTA_TRANS_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [F_CL_NAME] VARCHAR(100) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [RECFLAG] VARCHAR(1) NULL,
    [REMARK] VARCHAR(100) NULL,
    [RECFOR] VARCHAR(1) NULL,
    [STT] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [SUB_BR_CODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(20) NULL,
    [EUIN_DECL] VARCHAR(20) NULL,
    [DPC_FLAG] VARCHAR(20) NULL,
    [DP_TRANS] VARCHAR(20) NULL,
    [ORDER_SUB_TYPE] VARCHAR(20) NULL,
    [ALT_SCHEME_NAME] VARCHAR(200) NULL,
    [ALT_STAMP_DUTY] NUMERIC(18, 4) NULL,
    [ALT_EXIT_LOAD] NUMERIC(18, 4) NULL,
    [ALT_TAX] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_STATUS_test
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_STATUS_test]
(
    [REPORTDATE] DATETIME NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [MEMBERCODE] VARCHAR(15) NOT NULL,
    [BRANCH_CODE] VARCHAR(20) NOT NULL,
    [USERID] VARCHAR(20) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [RTA_SCHEME_CODE] VARCHAR(20) NOT NULL,
    [RTA_TRANS_NO] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [F_CL_NAME] VARCHAR(100) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [RECFLAG] VARCHAR(1) NULL,
    [REMARK] VARCHAR(100) NULL,
    [STT] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] BIGINT NULL,
    [SIP_REGN_DATE] VARCHAR(10) NULL,
    [Sub_BR_Code] VARCHAR(50) NULL,
    [EUIN] VARCHAR(20) NULL,
    [EUIN_DECL] VARCHAR(20) NULL,
    [DPC_Flag] VARCHAR(20) NULL,
    [DP_TRANS] VARCHAR(20) NULL,
    [Order_Sub_Type] VARCHAR(20) NULL,
    [FILLER] VARCHAR(100) NULL,
    [ALT_SCHEME_NAME] VARCHAR(200) NULL,
    [ALT_STAMP_DUTY] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_TMP]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_ID] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(200) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [SUBBRCODE] VARCHAR(15) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_ORDER_TMP_null1001
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_ORDER_TMP_null1001]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_ID] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(200) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [SUBBRCODE] VARCHAR(15) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_Order1_backup29July2022
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_Order1_backup29July2022]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [User_Id] VARCHAR(20) NULL,
    [CONF_FLAG] VARCHAR(10) NULL,
    [REJECT_REASON] VARCHAR(125) NULL,
    [NAV_VALUE_ALLOTED] NUMERIC(18, 4) NULL,
    [QTY_ALLOTED] NUMERIC(18, 4) NULL,
    [AMOUNT_ALLOTED] NUMERIC(18, 4) NULL,
    [INT_REF_NO] VARCHAR(20) NULL,
    [SETTLEMENT_TYPE] VARCHAR(2) NULL,
    [ORDER_TYPE] VARCHAR(3) NULL,
    [SIP_REGN_NO] INT NULL,
    [SIP_REGN_DATE] DATETIME NULL,
    [FIRST_ORDER_FLAG] VARCHAR(1) NULL,
    [PUR_REDEEM_STATUS] VARCHAR(10) NULL,
    [MEMBER_REMARKS] VARCHAR(200) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [MIN_REDEEM_FLAG] VARCHAR(1) NULL,
    [SUB_BROKER_ARN] VARCHAR(20) NULL,
    [SUBBRCODE] VARCHAR(50) NULL,
    [EUIN] VARCHAR(15) NULL,
    [EUIN_DECL] VARCHAR(1) NULL,
    [ALL_Units_Flag] VARCHAR(1) NULL,
    [ORD_DPC_FLAG] VARCHAR(1) NULL,
    [ORD_SUB_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SCRIP_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SCRIP_MASTER]
(
    [TOKEN] VARCHAR(5) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [RTSCHEMECODE] VARCHAR(10) NULL,
    [AMCSCHEMECODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMC_CODE] VARCHAR(50) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [PUR_TXNMMODE] VARCHAR(50) NOT NULL,
    [PUR_AMT_MIN] NUMERIC(18, 4) NOT NULL,
    [PUT_AMT_MULTIPLE] NUMERIC(18, 4) NOT NULL,
    [PUR_AMT_MAX] VARCHAR(50) NULL,
    [PUR_ALLOWED] VARCHAR(20) NOT NULL,
    [PUR_CUTOFF] VARCHAR(20) NOT NULL,
    [RED_TXNMODE] VARCHAR(50) NOT NULL,
    [RED_QTY_MIN] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MULTIPLE] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MAX] VARCHAR(50) NULL,
    [RED_ALLOWED] VARCHAR(20) NOT NULL,
    [RED_CUTOFF] VARCHAR(20) NOT NULL,
    [RTAAGENTCODE] VARCHAR(50) NOT NULL,
    [AMC_ACTIVE] INT NOT NULL,
    [DIV_REINVEST_FLAG] VARCHAR(5) NOT NULL,
    [SIP_FLAG] VARCHAR(20) NULL,
    [STP_FLAG] VARCHAR(1) NULL,
    [SWP_FLAG] VARCHAR(1) NULL,
    [SETTLEMENT_TYPE] VARCHAR(3) NULL,
    [CATEGORYCODE] VARCHAR(20) NULL,
    [PUR_AMT_MULTIPLIER] NUMERIC(18, 4) NULL,
    [FILLER1] VARCHAR(50) NULL,
    [SCHEME_PLAN] VARCHAR(20) NULL,
    [RED_AMT_MIN] MONEY NULL,
    [RED_AMT_MAX] MONEY NULL,
    [RED_AMT_MULTIPLE] MONEY NULL,
    [SWITCH_FLAG] VARCHAR(1) NULL,
    [AMC_IND] VARCHAR(3) NULL,
    [FACE_VALUE] NUMERIC(18, 2) NULL,
    [SCHEME_START_DATE] DATETIME NULL,
    [SCHEME_END_DATE] DATETIME NULL,
    [EXIT_LOAD_FLAG] VARCHAR(1) NULL,
    [EXIT_LOAD] VARCHAR(600) NULL,
    [LOCKIN_PERIOD_FLAG] VARCHAR(1) NULL,
    [LOCKIN_PERIOD] INT NULL,
    [CHANNEL_PARTNER_CODE] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SCRIP_MASTER_test
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SCRIP_MASTER_test]
(
    [TOKEN] VARCHAR(5) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [RTSCHEMECODE] VARCHAR(10) NULL,
    [AMCSCHEMECODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMC_CODE] VARCHAR(50) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [PUR_TXNMMODE] VARCHAR(50) NOT NULL,
    [PUR_AMT_MIN] MONEY NULL,
    [PUT_AMT_MULTIPLE] MONEY NULL,
    [PUR_AMT_MAX] MONEY NULL,
    [PUR_ALLOWED] VARCHAR(20) NOT NULL,
    [PUR_CUTOFF] VARCHAR(20) NOT NULL,
    [RED_TXNMODE] VARCHAR(50) NOT NULL,
    [RED_QTY_MIN] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MULTIPLE] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MAX] VARCHAR(50) NULL,
    [RED_ALLOWED] VARCHAR(20) NOT NULL,
    [RED_CUTOFF] VARCHAR(20) NOT NULL,
    [RTAAGENTCODE] VARCHAR(50) NOT NULL,
    [AMC_ACTIVE] INT NOT NULL,
    [DIV_REINVEST_FLAG] VARCHAR(5) NOT NULL,
    [CATEGORYCODE] VARCHAR(20) NULL,
    [SIP_FLAG] VARCHAR(1) NULL,
    [STP_FLAG] VARCHAR(1) NULL,
    [SWP_FLAG] VARCHAR(1) NULL,
    [SETTLEMENT_TYPE] VARCHAR(3) NULL,
    [PUR_AMT_MULTIPLIER] MONEY NULL,
    [FILLER1] VARCHAR(50) NULL,
    [SCHEME_PLAN] VARCHAR(20) NULL,
    [RED_AMT_MIN] MONEY NULL,
    [RED_AMT_MAX] MONEY NULL,
    [RED_AMT_MULTIPLE] MONEY NULL,
    [SWITCH_FLAG] VARCHAR(1) NULL,
    [AMC_IND] VARCHAR(3) NULL,
    [FACE_VALUE] NUMERIC(18, 2) NULL,
    [SCHEME_START_DATE] DATETIME NULL,
    [SCHEME_END_DATE] DATETIME NULL,
    [EXIT_LOAD_FLAG] VARCHAR(1) NULL,
    [EXIT_LOAD] VARCHAR(600) NULL,
    [LOCKIN_PERIOD_FLAG] VARCHAR(1) NULL,
    [LOCKIN_PERIOD] INT NULL,
    [CHANNEL_PARTNER_CODE] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SCRIP_MASTER_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SCRIP_MASTER_TMP]
(
    [TOKEN] VARCHAR(5) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [RTSCHEMECODE] VARCHAR(10) NULL,
    [AMCSCHEMECODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMC_CODE] VARCHAR(50) NOT NULL,
    [CATEGORYCODE] VARCHAR(20) NULL,
    [SCHEME_PLAN] VARCHAR(20) NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [PUR_ALLOWED] VARCHAR(20) NOT NULL,
    [PUR_TXNMMODE] VARCHAR(50) NOT NULL,
    [PUR_AMT_MIN] MONEY NULL,
    [PUT_AMT_MULTIPLE] MONEY NULL,
    [PUR_AMT_MAX] MONEY NULL,
    [PUR_AMT_MULTIPLIER] MONEY NULL,
    [PUR_CUTOFF] VARCHAR(20) NOT NULL,
    [RED_ALLOWED] VARCHAR(20) NOT NULL,
    [RED_TXNMODE] VARCHAR(50) NOT NULL,
    [RED_QTY_MIN] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MULTIPLE] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MAX] VARCHAR(50) NULL,
    [RED_AMT_MIN] MONEY NULL,
    [RED_AMT_MAX] MONEY NULL,
    [RED_AMT_MULTIPLE] MONEY NULL,
    [RED_CUTOFF] VARCHAR(20) NOT NULL,
    [RTAAGENTCODE] VARCHAR(50) NOT NULL,
    [AMC_ACTIVE] INT NOT NULL,
    [DIV_REINVEST_FLAG] VARCHAR(5) NOT NULL,
    [SIP_FLAG] VARCHAR(1) NULL,
    [STP_FLAG] VARCHAR(1) NULL,
    [SWP_FLAG] VARCHAR(1) NULL,
    [SWITCH_FLAG] VARCHAR(1) NULL,
    [SETTLEMENT_TYPE] VARCHAR(3) NULL,
    [AMC_IND] VARCHAR(3) NULL,
    [FACE_VALUE] NUMERIC(18, 2) NULL,
    [SCHEME_START_DATE] DATETIME NULL,
    [SCHEME_END_DATE] DATETIME NULL,
    [EXIT_LOAD_FLAG] VARCHAR(1) NULL,
    [EXIT_LOAD] VARCHAR(600) NULL,
    [LOCKIN_PERIOD_FLAG] VARCHAR(1) NULL,
    [LOCKIN_PERIOD] INT NULL,
    [CHANNEL_PARTNER_CODE] VARCHAR(20) NULL,
    [FILLER1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SCRIP_MASTER_TMP_test
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SCRIP_MASTER_TMP_test]
(
    [TOKEN] VARCHAR(5) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [RTSCHEMECODE] VARCHAR(10) NULL,
    [AMCSCHEMECODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [AMC_CODE] VARCHAR(50) NOT NULL,
    [CATEGORYCODE] VARCHAR(20) NULL,
    [SCHEME_PLAN] VARCHAR(20) NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [PUR_ALLOWED] VARCHAR(20) NOT NULL,
    [PUR_TXNMMODE] VARCHAR(50) NOT NULL,
    [PUR_AMT_MIN] MONEY NULL,
    [PUT_AMT_MULTIPLE] MONEY NULL,
    [PUR_AMT_MAX] MONEY NULL,
    [PUR_AMT_MULTIPLIER] MONEY NULL,
    [PUR_CUTOFF] VARCHAR(20) NOT NULL,
    [RED_ALLOWED] VARCHAR(20) NOT NULL,
    [RED_TXNMODE] VARCHAR(50) NOT NULL,
    [RED_QTY_MIN] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MULTIPLE] NUMERIC(18, 4) NOT NULL,
    [RED_QTY_MAX] VARCHAR(50) NULL,
    [RED_AMT_MIN] MONEY NULL,
    [RED_AMT_MAX] MONEY NULL,
    [RED_AMT_MULTIPLE] MONEY NULL,
    [RED_CUTOFF] VARCHAR(20) NOT NULL,
    [RTAAGENTCODE] VARCHAR(50) NOT NULL,
    [AMC_ACTIVE] INT NOT NULL,
    [DIV_REINVEST_FLAG] VARCHAR(5) NOT NULL,
    [SIP_FLAG] VARCHAR(1) NULL,
    [STP_FLAG] VARCHAR(1) NULL,
    [SWP_FLAG] VARCHAR(1) NULL,
    [SWITCH_FLAG] VARCHAR(1) NULL,
    [SETTLEMENT_TYPE] VARCHAR(3) NULL,
    [AMC_IND] VARCHAR(3) NULL,
    [FACE_VALUE] NUMERIC(18, 2) NULL,
    [SCHEME_START_DATE] DATETIME NULL,
    [SCHEME_END_DATE] DATETIME NULL,
    [EXIT_LOAD_FLAG] VARCHAR(1) NULL,
    [EXIT_LOAD] VARCHAR(600) NULL,
    [LOCKIN_PERIOD_FLAG] VARCHAR(1) NULL,
    [LOCKIN_PERIOD] INT NULL,
    [CHANNEL_PARTNER_CODE] VARCHAR(20) NULL,
    [FILLER1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_03DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_03DEC18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_04DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_04DEC18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_05DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_05DEC18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFss_settlement_05Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFss_settlement_05Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_06dEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_06dEC18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_07DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_07DEC18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_09Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_09Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_10Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_10Dec18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_11Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_11Dec18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_12Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_12Dec18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_12Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_12Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_13Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_13Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_15Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_15Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_16Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_16Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_17Dec18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_17Dec18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_17Dec18_1
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_17Dec18_1]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_19DEC18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_19DEC18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_20Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_20Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_20Nov18_
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_20Nov18_]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_26Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_26Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_27Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_27Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_28Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_28Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_30Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_30Nov18]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_BKUP_28JUL20
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_BKUP_28JUL20]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_Daily
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_Daily]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_DELETED
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_DELETED]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(1) NOT NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_SETTLEMENT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_SETTLEMENT_LOG]
(
    [CONTRACTNO] VARCHAR(7) NOT NULL,
    [BILLNO] INT NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [BROKERAGE] NUMERIC(18, 4) NOT NULL,
    [INS_CHRG] NUMERIC(18, 4) NOT NULL,
    [TURN_TAX] NUMERIC(18, 4) NOT NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SEBI_TAX] NUMERIC(18, 4) NOT NULL,
    [BROKER_CHRG] NUMERIC(18, 4) NOT NULL,
    [SERVICE_TAX] NUMERIC(18, 4) NOT NULL,
    [FILLER1] VARCHAR(10) NULL,
    [FILLER2] VARCHAR(1) NOT NULL,
    [FILLER3] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRADE]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRADE__B311360_14FEB22
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRADE__B311360_14FEB22]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRADE_01082020
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRADE_01082020]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRADE_14Jul20
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRADE_14Jul20]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRADE_backup29July2022
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRADE_backup29July2022]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_Trade_M10001
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_Trade_M10001]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRADE1_backup29July2022
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRADE1_backup29July2022]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [MEMBERCODE] VARCHAR(10) NOT NULL,
    [ORDER_DATE] DATETIME NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [SCRIP_CD] VARCHAR(20) NOT NULL,
    [SCHEME_NAME] VARCHAR(200) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [SUB_RED_FLAG] VARCHAR(1) NOT NULL,
    [SETTFLAG] INT NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ALLOTMENT_MODE] VARCHAR(10) NOT NULL,
    [DPCLT] VARCHAR(16) NOT NULL,
    [FOLIONO] VARCHAR(16) NOT NULL,
    [USER_ID] VARCHAR(20) NOT NULL,
    [CONF_FLAG] VARCHAR(10) NOT NULL,
    [REJECT_REASON] VARCHAR(100) NOT NULL,
    [FILLER1] VARCHAR(20) NULL,
    [FILLER2] VARCHAR(20) NULL,
    [FILLER3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multicltid
-- --------------------------------------------------
CREATE TABLE [dbo].[Multicltid]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Cltdpno] VARCHAR(16) NOT NULL,
    [Dpid] VARCHAR(16) NOT NULL,
    [Introducer] VARCHAR(100) NULL,
    [Dptype] VARCHAR(4) NULL,
    [Def] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nominee_data_MIG_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[nominee_data_MIG_LOG]
(
    [BOID] CHAR(16) NULL,
    [Nom_Name] VARCHAR(142) NULL,
    [addr1] VARCHAR(55) NULL,
    [addr2] VARCHAR(55) NULL,
    [addr3] VARCHAR(55) NULL,
    [city] CHAR(25) NULL,
    [state] CHAR(25) NULL,
    [pincode] CHAR(10) NULL,
    [priphind] VARCHAR(6) NULL,
    [nom_sr_no] CHAR(2) NULL,
    [rel_WITH_BO] VARCHAR(14) NULL,
    [perc_OF_SHARES] VARCHAR(10) NULL,
    [statecode] VARCHAR(6) NULL,
    [pangir] CHAR(25) NULL,
    [DateOfBirth] VARCHAR(10) NULL,
    [Party_Code] VARCHAR(13) NULL,
    [ACC_Status] VARCHAR(15) NULL,
    [Process_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.owner
-- --------------------------------------------------
CREATE TABLE [dbo].[owner]
(
    [Company] VARCHAR(80) NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(25) NULL,
    [Zip] VARCHAR(6) NULL,
    [City] VARCHAR(20) NULL,
    [Membercode] VARCHAR(15) NULL,
    [Bankname] VARCHAR(50) NULL,
    [Bankadd] VARCHAR(50) NULL,
    [Csdlid] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [Dpid] VARCHAR(10) NULL,
    [Cltaccno] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [Std_Rate] SMALLINT NULL,
    [P_To_P] SMALLINT NULL,
    [Demat_Tableno] SMALLINT NULL,
    [Albmcf_Tableno] SMALLINT NULL,
    [Mf_Tableno] SMALLINT NULL,
    [Sb_Tableno] SMALLINT NULL,
    [Brok1_Tableno] SMALLINT NULL,
    [Brok2_Tableno] SMALLINT NULL,
    [Brok3_Tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [Tscheme] TINYINT NULL,
    [Dispcharge] TINYINT NULL,
    [Brok_Inc_Stax] TINYINT NULL,
    [Def_Scheme] CHAR(1) NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontcharge] TINYINT NULL,
    [Marginmultiplier] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [Style] INT NULL,
    [Exchangecode] VARCHAR(3) NULL,
    [Brokersebiregno] VARCHAR(15) NULL,
    [Counterparty] VARCHAR(15) NULL,
    [Cp_Sebiregno] VARCHAR(15) NULL,
    [Panno] VARCHAR(50) NULL,
    [Fax] VARCHAR(25) NULL,
    [State] VARCHAR(50) NULL,
    [AutoGenPartyCode] INT NULL,
    [EMAIL] VARCHAR(100) NULL,
    [SMTP_SRV_NAME] VARCHAR(100) NULL,
    [ExchangeSegment] VARCHAR(10) NULL,
    [LEVEL] INT NULL,
    [KEEPINST] TINYINT NULL,
    [PROFILE_BROK_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PATHFROMFULLNAME
-- --------------------------------------------------
CREATE TABLE [dbo].[PATHFROMFULLNAME]
(
    [SUBDIRECTORY] VARCHAR(1000) NULL,
    [DEPTH] INT NULL,
    [FILESR] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PEDING_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[PEDING_ENTRIES]
(
    [FIMPORT_DATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [VAMT] MONEY NULL,
    [EXCHANGE] VARCHAR(50) NULL,
    [PMODE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PEDING_ENTRIES_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[PEDING_ENTRIES_LOG]
(
    [FIMPORT_DATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [VAMT] MONEY NULL,
    [EXCHANGE] VARCHAR(50) NULL,
    [PMODE] VARCHAR(50) NULL,
    [LOG_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PEDING_ENTRIES_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[PEDING_ENTRIES_TEMP]
(
    [CLTCODE] VARCHAR(10) NULL,
    [VAMT] MONEY NULL,
    [EXCHANGE] VARCHAR(50) NULL,
    [PMODE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PK_MFSS_BROKERAGE_MASTER_S385200
-- --------------------------------------------------
CREATE TABLE [dbo].[PK_MFSS_BROKERAGE_MASTER_S385200]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [FROMDATE] DATETIME NOT NULL,
    [TODATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POBANK
-- --------------------------------------------------
CREATE TABLE [dbo].[POBANK]
(
    [BANKID] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BRANCH_NAME] VARCHAR(50) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [CITY] VARCHAR(25) NULL,
    [STATE] VARCHAR(25) NULL,
    [NATION] VARCHAR(25) NULL,
    [ZIP] VARCHAR(15) NULL,
    [PHONE1] VARCHAR(15) NULL,
    [PHONE2] VARCHAR(15) NULL,
    [FAX] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pobank_13122010_bank_standerd_phaseII
-- --------------------------------------------------
CREATE TABLE [dbo].[pobank_13122010_bank_standerd_phaseII]
(
    [BANKID] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BRANCH_NAME] VARCHAR(50) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [CITY] VARCHAR(25) NULL,
    [STATE] VARCHAR(25) NULL,
    [NATION] VARCHAR(25) NULL,
    [ZIP] VARCHAR(15) NULL,
    [PHONE1] VARCHAR(15) NULL,
    [PHONE2] VARCHAR(15) NULL,
    [FAX] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POBANK_bank_merger
-- --------------------------------------------------
CREATE TABLE [dbo].[POBANK_bank_merger]
(
    [BANKID] NUMERIC(18, 0) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BRANCH_NAME] VARCHAR(50) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [CITY] VARCHAR(25) NULL,
    [STATE] VARCHAR(25) NULL,
    [NATION] VARCHAR(25) NULL,
    [ZIP] VARCHAR(15) NULL,
    [PHONE1] VARCHAR(15) NULL,
    [PHONE2] VARCHAR(15) NULL,
    [FAX] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pratham_bulk_update
-- --------------------------------------------------
CREATE TABLE [dbo].[pratham_bulk_update]
(
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NOT NULL,
    [CL_TYPE] VARCHAR(3) NOT NULL,
    [CL_BALANCE] VARCHAR(1) NOT NULL,
    [CL_STATUS] VARCHAR(3) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(10) NOT NULL,
    [SBU] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [GENDER] VARCHAR(1) NOT NULL,
    [OCCUPATION_CODE] INT NOT NULL,
    [TAX_STATUS] INT NOT NULL,
    [PAN_NO] VARCHAR(10) NOT NULL,
    [KYC_FLAG] VARCHAR(1) NOT NULL,
    [ADDR1] VARCHAR(50) NOT NULL,
    [ADDR2] VARCHAR(50) NOT NULL,
    [ADDR3] VARCHAR(50) NOT NULL,
    [CITY] VARCHAR(35) NOT NULL,
    [STATE] VARCHAR(50) NOT NULL,
    [ZIP] VARCHAR(6) NOT NULL,
    [NATION] VARCHAR(50) NOT NULL,
    [OFFICE_PHONE] VARCHAR(15) NOT NULL,
    [RES_PHONE] VARCHAR(15) NOT NULL,
    [MOBILE_NO] VARCHAR(50) NOT NULL,
    [EMAIL_ID] VARCHAR(50) NOT NULL,
    [BANK_NAME] VARCHAR(50) NOT NULL,
    [BANK_BRANCH] VARCHAR(50) NOT NULL,
    [BANK_CITY] VARCHAR(50) NOT NULL,
    [ACC_NO] VARCHAR(40) NOT NULL,
    [PAYMODE] INT NOT NULL,
    [MICR_NO] VARCHAR(12) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [GAURDIAN_NAME] VARCHAR(35) NOT NULL,
    [GAURDIAN_PAN_NO] VARCHAR(10) NOT NULL,
    [NOMINEE_NAME] VARCHAR(50) NOT NULL,
    [NOMINEE_RELATION] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(10) NOT NULL,
    [STAT_COMM_MODE] VARCHAR(1) NOT NULL,
    [DP_TYPE] VARCHAR(4) NOT NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [MODE_HOLDING] CHAR(2) NOT NULL,
    [HOLDER2_CODE] VARCHAR(20) NOT NULL,
    [HOLDER2_NAME] VARCHAR(100) NOT NULL,
    [HOLDER2_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER2_KYC_FLAG] CHAR(1) NOT NULL,
    [HOLDER3_CODE] VARCHAR(20) NOT NULL,
    [HOLDER3_NAME] VARCHAR(100) NOT NULL,
    [HOLDER3_PAN_NO] VARCHAR(10) NOT NULL,
    [HOLDER3_KYC_FLAG] CHAR(1) NOT NULL,
    [BUY_BROK_TABLE_NO] INT NOT NULL,
    [SELL_BROK_TABLE_NO] INT NOT NULL,
    [BROK_EFF_DATE] DATETIME NOT NULL,
    [NEFTCODE] VARCHAR(11) NOT NULL,
    [CHEQUENAME] VARCHAR(35) NOT NULL,
    [RESIFAX] VARCHAR(15) NOT NULL,
    [OFFICEFAX] VARCHAR(15) NOT NULL,
    [MAPINID] VARCHAR(16) NOT NULL,
    [REMARK] VARCHAR(100) NOT NULL,
    [UCC_STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] DATETIME NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [POAFLAG] VARCHAR(3) NULL,
    [DEACTIVE_REMARKS] VARCHAR(100) NULL,
    [DEACTIVE_VALUE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.REGION
-- --------------------------------------------------
CREATE TABLE [dbo].[REGION]
(
    [REGIONCODE] VARCHAR(20) NULL,
    [DESCRIPTION] VARCHAR(50) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [DUMMY1] VARCHAR(1) NULL,
    [DUMMY2] VARCHAR(1) NULL,
    [REG_SUBBROKER] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.S_ACTIVE
-- --------------------------------------------------
CREATE TABLE [dbo].[S_ACTIVE]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [CLTDPID] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SBU_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[SBU_MASTER]
(
    [SBU_CODE] VARCHAR(10) NOT NULL,
    [SBU_NAME] VARCHAR(50) NOT NULL,
    [SBU_ADDR1] VARCHAR(40) NOT NULL,
    [SBU_ADDR2] VARCHAR(40) NULL,
    [SBU_ADDR3] VARCHAR(40) NULL,
    [SBU_CITY] VARCHAR(20) NULL,
    [SBU_STATE] VARCHAR(20) NULL,
    [SBU_ZIP] VARCHAR(10) NULL,
    [SBU_PHONE1] VARCHAR(15) NULL,
    [SBU_PHONE2] VARCHAR(15) NULL,
    [SBU_TYPE] VARCHAR(10) NOT NULL,
    [SBU_PARTY_CODE] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETT_MST
-- --------------------------------------------------
CREATE TABLE [dbo].[SETT_MST]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETT_MST_1920142
-- --------------------------------------------------
CREATE TABLE [dbo].[SETT_MST_1920142]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_sures
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_sures]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETT_MSTTEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[SETT_MSTTEMP]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1$]
(
    [cl_code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STAT_TRD
-- --------------------------------------------------
CREATE TABLE [dbo].[STAT_TRD]
(
    [Actioncode] VARCHAR(3) NULL,
    [Sysdate] SMALLDATETIME NULL,
    [Filedate] SMALLDATETIME NULL,
    [Com_Date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STATE_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[STATE_MASTER]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [State] VARCHAR(50) NOT NULL,
    [State_Code] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SUBBROKERS
-- --------------------------------------------------
CREATE TABLE [dbo].[SUBBROKERS]
(
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [NAME] VARCHAR(50) NULL,
    [ADDRESS1] CHAR(100) NULL,
    [ADDRESS2] CHAR(100) NULL,
    [CITY] CHAR(20) NULL,
    [STATE] CHAR(15) NULL,
    [NATION] CHAR(15) NULL,
    [ZIP] CHAR(10) NULL,
    [FAX] CHAR(15) NULL,
    [PHONE1] CHAR(15) NULL,
    [PHONE2] CHAR(15) NULL,
    [REG_NO] CHAR(30) NULL,
    [REGISTERED] BIT NOT NULL,
    [MAIN_SUB] CHAR(1) NULL,
    [EMAIL] CHAR(50) NULL,
    [COM_PERC] MONEY NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [CONTACT_PERSON] VARCHAR(100) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SUBBROKERS_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[SUBBROKERS_BAK]
(
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [NAME] VARCHAR(50) NULL,
    [ADDRESS1] CHAR(100) NULL,
    [ADDRESS2] CHAR(100) NULL,
    [CITY] CHAR(20) NULL,
    [STATE] CHAR(15) NULL,
    [NATION] CHAR(15) NULL,
    [ZIP] CHAR(10) NULL,
    [FAX] CHAR(15) NULL,
    [PHONE1] CHAR(15) NULL,
    [PHONE2] CHAR(15) NULL,
    [REG_NO] CHAR(30) NULL,
    [REGISTERED] BIT NOT NULL,
    [MAIN_SUB] CHAR(1) NULL,
    [EMAIL] CHAR(50) NULL,
    [COM_PERC] MONEY NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [CONTACT_PERSON] VARCHAR(100) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_EDIT_ON_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_EDIT_ON_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SELECTEDTEXT] VARCHAR(50) NULL,
    [TEXTVAL] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_BLOCK_DET
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_BLOCK_DET]
(
    [PROCESS_TYPE] VARCHAR(50) NULL,
    [BLOCK] VARCHAR(1) NULL,
    [USERID] VARCHAR(25) NULL,
    [BLOCKON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_BLOCK_DET_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_BLOCK_DET_LOG]
(
    [PROCESS_TYPE] VARCHAR(50) NULL,
    [BLOCK] VARCHAR(1) NULL,
    [USERID] VARCHAR(25) NULL,
    [BLOCKON] DATETIME NULL,
    [LOG_BY] VARCHAR(25) NULL,
    [LOG_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_CONTROL_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_CONTROL_MASTER]
(
    [USERID] VARCHAR(25) NULL,
    [EXCH_SEGMENT] VARCHAR(100) NULL,
    [PROCESS_TYPE] VARCHAR(500) NULL,
    [EDIT_ON] VARCHAR(500) NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_DETAIL]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(MAX) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_DETAIL_29062021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_DETAIL_29062021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(MAX) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_DETAIL_30062021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_DETAIL_30062021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(MAX) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_DETAIL_30062021_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_DETAIL_30062021_BAK]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(MAX) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [TO_EMAIL_ID] VARCHAR(500) NULL,
    [CC_EMAIL_ID] VARCHAR(500) NULL,
    [BCC_EMAIL_ID] VARCHAR(500) NULL,
    [EMAIL_SEND_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL_GROUP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL_GROUP_LOG]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NULL,
    [PROCESS_GROUP] VARCHAR(100) NULL,
    [EMAIL_SEND_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL_GRP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL_GRP]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_GROUP] VARCHAR(100) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [TO_EMAIL_ID] VARCHAR(500) NULL,
    [CC_EMAIL_ID] VARCHAR(500) NULL,
    [BCC_EMAIL_ID] VARCHAR(500) NULL,
    [EMAIL_SEND_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_FILE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_FILE]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FLD_FILENAME] VARCHAR(200) NULL,
    [FLD_FILEDATE] DATETIME NULL,
    [PROCESS_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_LISNER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_LISNER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_FOR] VARCHAR(50) NULL,
    [PROCESS_FILE_PATH] VARCHAR(200) NULL,
    [PROCESS_FILE_NAME] VARCHAR(100) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_TYPE] VARCHAR(1) NULL,
    [PROCESS_SET] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_auto_process_lisner_29062021
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_auto_process_lisner_29062021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_FOR] VARCHAR(50) NULL,
    [PROCESS_FILE_PATH] VARCHAR(200) NULL,
    [PROCESS_FILE_NAME] VARCHAR(100) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_TYPE] VARCHAR(1) NULL,
    [PROCESS_SET] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_LISNER_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_LISNER_LOG]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [BUSINESS_DATE] DATETIME NULL,
    [PROCESS_FOR] VARCHAR(50) NULL,
    [PROCESS_FILE_NAME] VARCHAR(50) NULL,
    [PROCESS_FLAG] INT NULL,
    [PROCESS_SETUP_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_LISNER_LOG_30062021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_LISNER_LOG_30062021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [BUSINESS_DATE] DATETIME NULL,
    [PROCESS_FOR] VARCHAR(50) NULL,
    [PROCESS_FILE_NAME] VARCHAR(50) NULL,
    [PROCESS_FLAG] INT NULL,
    [PROCESS_SETUP_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER_09082021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER_09082021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER_29062021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER_29062021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER_30062021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER_30062021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLASS_IMPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLASS_IMPORT]
(
    [FLDFILENO] VARCHAR(2) NOT NULL,
    [FLDFILETYPE] VARCHAR(50) NULL,
    [FLDFILENAME] VARCHAR(10) NULL,
    [FLDPROCNAME] VARCHAR(50) NOT NULL,
    [FLDFILEFOR] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DEL_HOLD_SEC
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DEL_HOLD_SEC]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(30) NULL,
    [SERIES] VARCHAR(5) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [TRANSDATE] DATETIME NULL,
    [CRQTY] INT NULL,
    [DRQTY] INT NULL,
    [DPID] VARCHAR(20) NULL,
    [CLTDPID] VARCHAR(20) NULL,
    [BCLTDPID] VARCHAR(20) NULL,
    [BDPID] VARCHAR(20) NULL,
    [REMARK] VARCHAR(100) NULL,
    [MEMBER_ACC_TYPE] VARCHAR(20) NULL,
    [PLEDGED_BAL_QTY] INT NULL,
    [FREE_BAL_QTY] INT NULL,
    [TRF_REF_NO] VARCHAR(20) NULL,
    [TRANSACTION_TYPE] VARCHAR(20) NULL,
    [PURPOSE] VARCHAR(100) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DEL_MASTER_POAID
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DEL_MASTER_POAID]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [POA_TYPE] VARCHAR(10) NULL,
    [MASTER_POA_ID] VARCHAR(16) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL,
    [EDITED_BY] VARCHAR(16) NULL,
    [EDITED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DEL_MASTER_USER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DEL_MASTER_USER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_TYPE] VARCHAR(10) NULL,
    [DEF_FLAG] INT NULL,
    [USERCODE] VARCHAR(12) NULL,
    [USERNAME] VARCHAR(50) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL,
    [EDITED_BY] VARCHAR(16) NULL,
    [EDITED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GENERIC_REPORT_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GENERIC_REPORT_SETTING]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [RPT_NAME] VARCHAR(50) NULL,
    [RPT_NAME_DESC] VARCHAR(150) NULL,
    [RPT_FILENAME] VARCHAR(100) NULL,
    [RPT_FILE_GROUP] VARCHAR(20) NULL,
    [RPT_SEPARATOR] CHAR(1) NULL,
    [RPT_PROC_NAME] VARCHAR(30) NULL,
    [NO_OF_PARAMETER] VARCHAR(20) NULL,
    [FLDSELECTION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MFSS_POST_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MFSS_POST_STATUS]
(
    [ORDER_DATE] DATETIME NULL,
    [STATUS] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MFSS_VALAN_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MFSS_VALAN_STATUS]
(
    [ORDER_DATE] DATETIME NULL,
    [STATUS] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_XSIP_REGSTR
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_XSIP_REGSTR]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_STATUS] VARCHAR(10) NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [XSIP_REGN_NO] VARCHAR(10) NULL,
    [XSIP_REGN_DATE] DATETIME NULL,
    [AMC_NAME] VARCHAR(50) NULL,
    [RTA_SCHEME_CODE] VARCHAR(5) NULL,
    [SCHEME_NAME] VARCHAR(200) NULL,
    [FERQ_TYPE] VARCHAR(20) NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [INSTALL_AMT] NUMERIC(18, 4) NULL,
    [BROKERAGE] NUMERIC(18, 4) NULL,
    [ENTRY_BY] VARCHAR(50) NULL,
    [BSE_MANDATE_ID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_XSIP_REGSTR_suresh
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_XSIP_REGSTR_suresh]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_STATUS] VARCHAR(10) NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [XSIP_REGN_NO] VARCHAR(10) NULL,
    [XSIP_REGN_DATE] DATETIME NULL,
    [AMC_NAME] VARCHAR(50) NULL,
    [RTA_SCHEME_CODE] VARCHAR(5) NULL,
    [SCHEME_NAME] VARCHAR(200) NULL,
    [FERQ_TYPE] VARCHAR(20) NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [INSTALL_AMT] NUMERIC(18, 4) NULL,
    [BROKERAGE] NUMERIC(18, 4) NULL,
    [ENTRY_BY] VARCHAR(50) NULL,
    [BSE_MANDATE_ID] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_XSIP_REGSTR_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_XSIP_REGSTR_TMP]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_STATUS] VARCHAR(10) NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [XSIP_REGN_NO] VARCHAR(10) NULL,
    [XSIP_REGN_DATE] DATETIME NULL,
    [AMC_NAME] VARCHAR(50) NULL,
    [RTA_SCHEME_CODE] VARCHAR(5) NULL,
    [SCHEME_NAME] VARCHAR(200) NULL,
    [FERQ_TYPE] VARCHAR(20) NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [INSTALL_AMT] NUMERIC(18, 4) NULL,
    [BROKERAGE] NUMERIC(18, 4) NULL,
    [ENTRY_BY] VARCHAR(50) NULL,
    [BSE_MANDATE_ID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_XSIP_REGSTR_TMP_suresh
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_XSIP_REGSTR_TMP_suresh]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_STATUS] VARCHAR(10) NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [INT_REF_NO] VARCHAR(10) NULL,
    [XSIP_REGN_NO] VARCHAR(10) NULL,
    [XSIP_REGN_DATE] DATETIME NULL,
    [AMC_NAME] VARCHAR(50) NULL,
    [RTA_SCHEME_CODE] VARCHAR(5) NULL,
    [SCHEME_NAME] VARCHAR(200) NULL,
    [FERQ_TYPE] VARCHAR(20) NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [INSTALL_AMT] NUMERIC(18, 4) NULL,
    [BROKERAGE] NUMERIC(18, 4) NULL,
    [ENTRY_BY] VARCHAR(50) NULL,
    [BSE_MANDATE_ID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblAdmin
-- --------------------------------------------------
CREATE TABLE [dbo].[TblAdmin]
(
    [Fldauto_Admin] INT IDENTITY(1,1) NOT NULL,
    [Fldname] VARCHAR(30) NOT NULL,
    [Fldpassword] VARCHAR(50) NULL,
    [Fldcompany] VARCHAR(50) NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Fldstatus] VARCHAR(25) NOT NULL,
    [Flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMIN_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMIN_LOG]
(
    [Fldauto_Admin] INT NOT NULL,
    [Fldname] VARCHAR(30) NOT NULL,
    [Fldpassword] VARCHAR(30) NOT NULL,
    [Fldcompany] VARCHAR(50) NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Fldstatus] VARCHAR(25) NOT NULL,
    [Flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblAdminconfig
-- --------------------------------------------------
CREATE TABLE [dbo].[TblAdminconfig]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldadmin] VARCHAR(50) NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMINPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMINPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDADMINID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblBankdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tblBankdetails]
(
    [ClientCode] VARCHAR(20) NULL,
    [Account_Type_1] VARCHAR(50) NULL,
    [Account_No_1] VARCHAR(50) NULL,
    [MICR_No_1] VARCHAR(20) NULL,
    [IFSC_Code_1] VARCHAR(20) NULL,
    [Default_Bank_Flag] VARCHAR(1) NULL,
    [Account_Type_2] VARCHAR(50) NULL,
    [Account_No_2] VARCHAR(50) NULL,
    [MICR_No_2] VARCHAR(20) NULL,
    [IFSC_Code_2] VARCHAR(20) NULL,
    [Default_Bank_Flag_2] VARCHAR(1) NULL,
    [Account_Type_3] VARCHAR(50) NULL,
    [Account_No_3] VARCHAR(50) NULL,
    [MICR_No_3] VARCHAR(20) NULL,
    [IFSC_Code_3] VARCHAR(20) NULL,
    [Default_Bank_Flag_3] VARCHAR(1) NULL,
    [Account_Type_4] VARCHAR(50) NULL,
    [Account_No_4] VARCHAR(50) NULL,
    [MICR_No_4] VARCHAR(20) NULL,
    [IFSC_Code_4] VARCHAR(20) NULL,
    [Default_Bank_Flag_4] VARCHAR(1) NULL,
    [Account_Type_5] VARCHAR(50) NULL,
    [Account_No_5] VARCHAR(50) NULL,
    [MICR_No_5] VARCHAR(20) NULL,
    [IFSC_Code_5] VARCHAR(20) NULL,
    [Default_Bank_Flag_5] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblCategory
-- --------------------------------------------------
CREATE TABLE [dbo].[TblCategory]
(
    [Fldcategorycode] INT IDENTITY(1,1) NOT NULL,
    [Fldcategoryname] VARCHAR(50) NOT NULL,
    [Fldadminauto] INT NULL,
    [Flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATEGORY_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATEGORY_LOG]
(
    [Fldcategorycode] INT NOT NULL,
    [Fldcategoryname] VARCHAR(50) NOT NULL,
    [Fldadminauto] INT NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblCatmenu
-- --------------------------------------------------
CREATE TABLE [dbo].[TblCatmenu]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldcategorycode] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATMENU_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldcategorycode_OLD] VARCHAR(2000) NULL,
    [Fldcategorycode_NEW] VARCHAR(2000) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINE_IP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSADMINLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSADMINLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDADMINNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSUSERLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDUSERNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblglobalparams
-- --------------------------------------------------
CREATE TABLE [dbo].[tblglobalparams]
(
    [FLDPWDMINLENGTH] SMALLINT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NULL,
    [FLDSPCLCHAR] CHAR(1) NULL,
    [FLDENCRYPTION] CHAR(1) NULL,
    [FLDBLOCKPWD] VARCHAR(255) NULL,
    [FLDDELBLOCK] CHAR(1) NULL,
    [fldlastins] BIGINT NULL,
    [fldlastdel] BIGINT NULL,
    [fldlastupdt] BIGINT NULL,
    [fldupdtdate] DATETIME NULL,
    [fldclientMakerCheker] INT NULL,
    [fldAutoCodeGenerate] INT NULL,
    [fldflag] VARCHAR(3) NULL,
    [fldreportflag] VARCHAR(3) NULL,
    [fldCheckClientProcess] VARCHAR(1) NULL,
    [fldBranchAdd] TINYINT NULL,
    [BranchFlag] CHAR(1) NULL,
    [FldPwdAlphaNumOnly] INT NULL,
    [FLDOLDPASSWORD] TINYINT NULL,
    [FLDPANVALIDATION] CHAR(1) NULL,
    [FLDPARTYCODEBY] VARCHAR(10) NULL,
    [ALLOW_MULTI_LOGIN] INT NULL,
    [MAX_REJECTION_ALLOW] SMALLINT NULL,
    [MKCKFLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblIFSCCodeUpdate
-- --------------------------------------------------
CREATE TABLE [dbo].[tblIFSCCodeUpdate]
(
    [Client_Code] VARCHAR(50) NULL,
    [Old_Code] VARCHAR(50) NULL,
    [New_Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblMenuHead
-- --------------------------------------------------
CREATE TABLE [dbo].[TblMenuHead]
(
    [Fldmenucode] VARCHAR(20) NULL,
    [Fldmenuname] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblMissingStateCode
-- --------------------------------------------------
CREATE TABLE [dbo].[tblMissingStateCode]
(
    [Clientcode] VARCHAR(50) NULL,
    [STATE] VARCHAR(100) NULL,
    [CODE] VARCHAR(50) NULL,
    [PINCODE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblNameIssue_list
-- --------------------------------------------------
CREATE TABLE [dbo].[tblNameIssue_list]
(
    [Client_Code] VARCHAR(50) NULL,
    [PrimaryHolderFirstName] VARCHAR(100) NULL,
    [PrimaryHolderMiddleName] VARCHAR(100) NULL,
    [PrimaryHolderLastName] VARCHAR(100) NULL,
    [Primary_Holder_KYC_Type] VARCHAR(50) NULL,
    [Primary_Holder_CKYC_Number] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblPradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[TblPradnyausers]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldusername] VARCHAR(25) NULL,
    [Fldpassword] VARCHAR(50) NULL,
    [Fldfirstname] VARCHAR(25) NULL,
    [Fldmiddlename] VARCHAR(25) NULL,
    [Fldlastname] VARCHAR(25) NULL,
    [Fldsex] VARCHAR(8) NULL,
    [Fldaddress1] VARCHAR(100) NULL,
    [Fldaddress2] VARCHAR(100) NULL,
    [Fldphone1] VARCHAR(10) NULL,
    [Fldphone2] VARCHAR(10) NULL,
    [Fldcategory] VARCHAR(10) NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [MODIFIED_BY] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLPRADNYAUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLPRADNYAUSERS_LOG]
(
    [Fldauto] INT NOT NULL,
    [Fldusername] VARCHAR(25) NULL,
    [Fldpassword] VARCHAR(15) NULL,
    [Fldfirstname] VARCHAR(25) NULL,
    [Fldmiddlename] VARCHAR(25) NULL,
    [Fldlastname] VARCHAR(25) NULL,
    [Fldsex] VARCHAR(8) NULL,
    [Fldaddress1] VARCHAR(100) NULL,
    [Fldaddress2] VARCHAR(100) NULL,
    [Fldphone1] VARCHAR(10) NULL,
    [Fldphone2] VARCHAR(10) NULL,
    [Fldcategory] VARCHAR(10) NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MachineIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReportgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReportgrp]
(
    [Fldreportgrp] INT IDENTITY(1,1) NOT NULL,
    [Fldgrpname] VARCHAR(35) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTGRP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTGRP_LOG]
(
    [Fldreportgrp] INT NOT NULL,
    [Fldgrpname] VARCHAR(35) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReports
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReports]
(
    [Fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [Fldreportname] VARCHAR(200) NULL,
    [Fldpath] VARCHAR(500) NULL,
    [Fldtarget] VARCHAR(25) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [Fldreportgrp] VARCHAR(10) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Fldstatus] VARCHAR(20) NULL,
    [Fldorder] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReports_Blocked]
(
    [fldusername] VARCHAR(25) NOT NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [Block_Flag] INT NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [fldpath] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldreportname] VARCHAR(35) NULL,
    [Fldpath] VARCHAR(500) NULL,
    [Fldtarget] VARCHAR(25) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [Fldreportgrp] VARCHAR(10) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Fldstatus] VARCHAR(20) NULL,
    [Fldorder] INT NOT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlGlobals]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_23082022
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_23082022]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_Jrnl]
(
    [FLDAUTO] BIGINT NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(64) NULL,
    [FLDUPDTDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS_LOG]
(
    [FLDAUTO] INT NOT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(20) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTYNAME] VARCHAR(250) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SUBBROKER] VARCHAR(50) NULL,
    [BROKING_VDT_LEDGER] MONEY NULL,
    [UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_BROKING_LEDGER] MONEY NULL,
    [MF_VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_PENDING_RECEIPTS] MONEY NULL,
    [MF_UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_MF_LEDGER] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [ORDER_STAUS] VARCHAR(250) NULL,
    [TDAY_ORDERS_COUNT] INT NULL DEFAULT ((0)),
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_13042022
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_13042022]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTY_NAME] VARCHAR(250) NULL,
    [EDT_LEDGER] MONEY NULL,
    [VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_OPEN_BALANCE] MONEY NULL,
    [COLLATERALS] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_LOG]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTYNAME] VARCHAR(250) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SUBBROKER] VARCHAR(50) NULL,
    [BROKING_VDT_LEDGER] MONEY NULL,
    [UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_BROKING_LEDGER] MONEY NULL,
    [MF_VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_PENING_RECEIPTS] MONEY NULL,
    [MF_UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_MF_LEDGER] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [ORDER_STAUS] VARCHAR(250) NULL,
    [TDAY_ORDERS_COUNT] INT NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_LOG_13042022
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_LOG_13042022]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTY_NAME] VARCHAR(250) NULL,
    [EDT_LEDGER] MONEY NULL,
    [VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_OPEN_BALANCE] MONEY NULL,
    [COLLATERALS] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_NEW_13042022
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_NEW_13042022]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTYNAME] VARCHAR(250) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SUBBROKER] VARCHAR(50) NULL,
    [BROKING_VDT_LEDGER] MONEY NULL,
    [UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_BROKING_LEDGER] MONEY NULL,
    [MF_VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_MF_LEDGER] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [ORDER_STAUS] VARCHAR(250) NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_NEW_LOG_13042022
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_NEW_LOG_13042022]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTYNAME] VARCHAR(250) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SUBBROKER] VARCHAR(50) NULL,
    [BROKING_VDT_LEDGER] MONEY NULL,
    [UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_BROKING_LEDGER] MONEY NULL,
    [MF_VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_MF_LEDGER] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [ORDER_STAUS] VARCHAR(250) NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_NEW_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_NEW_TEMP]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTYNAME] VARCHAR(250) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SUBBROKER] VARCHAR(50) NULL,
    [BROKING_VDT_LEDGER] MONEY NULL,
    [UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_BROKING_LEDGER] MONEY NULL,
    [MF_VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_PENDING_RECEIPTS] MONEY NULL,
    [MF_UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_MF_LEDGER] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [ORDER_STAUS] VARCHAR(250) NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TDAYMFORDER_NEW_TEMP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TDAYMFORDER_NEW_TEMP_LOG]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [PARTYNAME] VARCHAR(250) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SUBBROKER] VARCHAR(50) NULL,
    [BROKING_VDT_LEDGER] MONEY NULL,
    [UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_BROKING_LEDGER] MONEY NULL,
    [MF_VDT_LEDGER] MONEY NULL,
    [MF_TDAY_RECEIPTS] MONEY NULL,
    [MF_PENING_RECEIPTS] MONEY NULL,
    [MF_UNSETTLED_CR_BILLS] MONEY NULL,
    [NET_MF_LEDGER] MONEY NULL,
    [TOTAL_FUNDS] MONEY NULL,
    [TDAY_ORDER] MONEY NULL,
    [NET_BALANCE] MONEY NULL,
    [ORDER_STAUS] VARCHAR(250) NULL,
    [REPORT_DATE] DATETIME NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_SIVA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_SIVA]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [CL_BALANCE] VARCHAR(1) NULL,
    [CL_STATUS] VARCHAR(3) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [SBU] VARCHAR(2) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [GENDER] VARCHAR(1) NULL,
    [OCCUPATION_CODE] VARCHAR(1) NULL,
    [TAX_STATUS] VARCHAR(1) NULL,
    [PAN_NO] VARCHAR(20) NULL,
    [KYC_FLAG] VARCHAR(1) NULL,
    [ADDR1] VARCHAR(40) NULL,
    [ADDR2] VARCHAR(40) NULL,
    [ADDR3] VARCHAR(40) NULL,
    [CITY] VARCHAR(40) NULL,
    [STATE] VARCHAR(50) NULL,
    [ZIP] VARCHAR(10) NULL,
    [NATION] VARCHAR(15) NULL,
    [OFFICE_PHONE] VARCHAR(15) NULL,
    [RES_PHONE] VARCHAR(15) NULL,
    [MOBILE_NO] VARCHAR(40) NULL,
    [EMAIL_ID] VARCHAR(50) NULL,
    [BANK_NAME] VARCHAR(50) NULL,
    [BANK_BRANCH] VARCHAR(40) NULL,
    [BANK_CITY] VARCHAR(40) NULL,
    [ACC_NO] VARCHAR(20) NULL,
    [PAYMODE] VARCHAR(12) NULL,
    [MICR_NO] VARCHAR(10) NULL,
    [DOB] VARCHAR(40) NULL,
    [GAURDIAN_NAME] VARCHAR(202) NULL,
    [GAURDIAN_PAN_NO] VARCHAR(15) NULL,
    [NOMINEE_NAME] VARCHAR(1) NULL,
    [NOMINEE_RELATION] VARCHAR(1) NULL,
    [BANK_AC_TYPE] VARCHAR(2) NULL,
    [STAT_COMM_MODE] VARCHAR(1) NULL,
    [DP_TYPE] VARCHAR(7) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(20) NULL,
    [MODE_HOLDING] VARCHAR(2) NULL,
    [HOLDER2_CODE] VARCHAR(1) NULL,
    [HOLDER2_NAME] VARCHAR(202) NULL,
    [HOLDER2_PAN_NO] VARCHAR(50) NULL,
    [HOLDER2_KYC_FLAG] VARCHAR(1) NULL,
    [HOLDER3_CODE] VARCHAR(1) NULL,
    [HOLDER3_NAME] VARCHAR(202) NULL,
    [HOLDER3_PAN_NO] VARCHAR(50) NULL,
    [HOLDER3_KYC_FLAG] VARCHAR(1) NULL,
    [BUY_BROK_TABLE_NO] VARCHAR(12) NULL,
    [SELL_BROK_TABLE_NO] VARCHAR(12) NULL,
    [BROK_EFF_DATE] VARCHAR(40) NULL,
    [NEFTCODE] VARCHAR(1) NULL,
    [CHEQUENAME] VARCHAR(1) NULL,
    [RESIFAX] VARCHAR(1) NULL,
    [OFFICEFAX] VARCHAR(1) NULL,
    [MAPINID] VARCHAR(1) NULL,
    [REMARK] VARCHAR(1) NULL,
    [UCC_STATUS] VARCHAR(1) NULL,
    [ADDEDBY] VARCHAR(11) NULL,
    [ADDEDON] DATETIME NOT NULL,
    [ACTIVE_FROM] VARCHAR(10) NOT NULL,
    [INACTIVE_FROM] VARCHAR(10) NOT NULL,
    [POAFLAG] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMPYO1
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMPYO1]
(
    [party_Code] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestYO
-- --------------------------------------------------
CREATE TABLE [dbo].[TestYO]
(
    [PARTY_CODE] VARCHAR(40) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Update_Inactive_FROM
-- --------------------------------------------------
CREATE TABLE [dbo].[Update_Inactive_FROM]
(
    [inactive_from] DATETIME NULL,
    [cl_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Digital_File_Name
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Digital_File_Name]
(
    [SrNo] INT NOT NULL,
    [D_Type] NVARCHAR(8) NOT NULL,
    [D_Name] NVARCHAR(10) NULL,
    [D_Description] NVARCHAR(30) NULL,
    [D_Value] NVARCHAR(10) NULL,
    [D_Order] INT NOT NULL,
    [D_Seprater] NVARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Digital_File_Name_new
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Digital_File_Name_new]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [D_Type] VARCHAR(15) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(40) NULL,
    [D_Value] VARCHAR(40) NULL,
    [D_Order] INT NULL,
    [D_Seprater] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LOGIN_ERR_LOG]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [LOGIN_ID] VARCHAR(20) NULL,
    [LOGIN_PWD] VARCHAR(20) NULL,
    [IPADD] VARCHAR(20) NULL,
    [ERR_TYPE] VARCHAR(20) NULL,
    [LOGIN_TYPE] VARCHAR(10) NULL,
    [LOGIN_DT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Login_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Login_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(64) NULL,
    [Category] VARCHAR(64) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusId] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [Action] VARCHAR(6) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Report_Access_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [RepPath] VARCHAR(4000) NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(50) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusID] VARCHAR(32) NULL,
    [IPAdd] VARCHAR(20) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VALANACCOUNT
-- --------------------------------------------------
CREATE TABLE [dbo].[VALANACCOUNT]
(
    [Accode] VARCHAR(10) NULL,
    [Acname] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [Revcode] VARCHAR(10) NULL,
    [Oppcode] VARCHAR(10) NULL,
    [Effdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.MFSS_CLIENT_U
-- --------------------------------------------------
CREATE TRIGGER [dbo].[MFSS_CLIENT_U]
ON [dbo].[MFSS_CLIENT] FOR UPDATE

/**************************************************************
* Update trigger for CLIENT_BROK_DETAILS
*
* MODIFICATIONS
* 01/01/2000 xxx New
**************************************************************/
AS 


		SET NOCOUNT ON;          
		DECLARE @IPADDRESS AS VARCHAR(20)          
		    
		SELECT @IPADDRESS = CLIENT_NET_ADDRESS          
		FROM SYS.DM_EXEC_CONNECTIONS          
		WHERE SESSION_ID = @@SPID 


IF (SELECT COUNT(1) FROM inserted) > 0 
BEGIN 
	IF (SELECT COUNT(*) FROM deleted) > 0 
	BEGIN 
	INSERT INTO dbo.mfss_client_trig(
		PARTY_CODE,PARTY_NAME,CL_TYPE,CL_BALANCE,CL_STATUS,BRANCH_CD,SUB_BROKER,TRADER,AREA,REGION,SBU,FAMILY,GENDER,
		OCCUPATION_CODE,TAX_STATUS,PAN_NO,KYC_FLAG,ADDR1,ADDR2,ADDR3,CITY,STATE,ZIP,NATION,OFFICE_PHONE,RES_PHONE,
		MOBILE_NO,EMAIL_ID,BANK_NAME,BANK_BRANCH,BANK_CITY,ACC_NO,PAYMODE,MICR_NO,DOB,GAURDIAN_NAME,GAURDIAN_PAN_NO,
		NOMINEE_NAME,NOMINEE_RELATION,BANK_AC_TYPE,STAT_COMM_MODE,DP_TYPE,DPID,CLTDPID,MODE_HOLDING,HOLDER2_CODE,HOLDER2_NAME,
		HOLDER2_PAN_NO,HOLDER2_KYC_FLAG,HOLDER3_CODE,HOLDER3_NAME,HOLDER3_PAN_NO,HOLDER3_KYC_FLAG,BUY_BROK_TABLE_NO,SELL_BROK_TABLE_NO,
		BROK_EFF_DATE,NEFTCODE,CHEQUENAME,RESIFAX,OFFICEFAX,MAPINID,REMARK,UCC_STATUS,ADDEDBY,ADDEDON,ACTIVE_FROM,INACTIVE_FROM,POAFLAG,DEACTIVE_REMARKS,
		DEACTIVE_VALUE,Action,USER_IP,APPNAME,MODIFIED_ON )
		SELECT PARTY_CODE,PARTY_NAME,CL_TYPE,CL_BALANCE,CL_STATUS,BRANCH_CD,SUB_BROKER,TRADER,AREA,REGION,SBU,FAMILY,GENDER,
		OCCUPATION_CODE,TAX_STATUS,PAN_NO,KYC_FLAG,ADDR1,ADDR2,ADDR3,CITY,STATE,ZIP,NATION,OFFICE_PHONE,RES_PHONE,
		MOBILE_NO,EMAIL_ID,BANK_NAME,BANK_BRANCH,BANK_CITY,ACC_NO,PAYMODE,MICR_NO,DOB,GAURDIAN_NAME,GAURDIAN_PAN_NO,
		NOMINEE_NAME,NOMINEE_RELATION,BANK_AC_TYPE,STAT_COMM_MODE,DP_TYPE,DPID,CLTDPID,MODE_HOLDING,HOLDER2_CODE,HOLDER2_NAME,
		HOLDER2_PAN_NO,HOLDER2_KYC_FLAG,HOLDER3_CODE,HOLDER3_NAME,HOLDER3_PAN_NO,HOLDER3_KYC_FLAG,BUY_BROK_TABLE_NO,SELL_BROK_TABLE_NO,
		BROK_EFF_DATE,NEFTCODE,CHEQUENAME,RESIFAX,OFFICEFAX,MAPINID,REMARK,UCC_STATUS,ADDEDBY,GETDATE(),ACTIVE_FROM,INACTIVE_FROM,POAFLAG,DEACTIVE_REMARKS,
		DEACTIVE_VALUE,'UPDATED',@IPADDRESS,APP_NAME(),GETDATE()  FROM INSERTED
		END 
     ELSE 
	    BEGIN 
		 	INSERT INTO dbo.mfss_client_trig(
		PARTY_CODE,PARTY_NAME,CL_TYPE,CL_BALANCE,CL_STATUS,BRANCH_CD,SUB_BROKER,TRADER,AREA,REGION,SBU,FAMILY,GENDER,
		OCCUPATION_CODE,TAX_STATUS,PAN_NO,KYC_FLAG,ADDR1,ADDR2,ADDR3,CITY,STATE,ZIP,NATION,OFFICE_PHONE,RES_PHONE,
		MOBILE_NO,EMAIL_ID,BANK_NAME,BANK_BRANCH,BANK_CITY,ACC_NO,PAYMODE,MICR_NO,DOB,GAURDIAN_NAME,GAURDIAN_PAN_NO,
		NOMINEE_NAME,NOMINEE_RELATION,BANK_AC_TYPE,STAT_COMM_MODE,DP_TYPE,DPID,CLTDPID,MODE_HOLDING,HOLDER2_CODE,HOLDER2_NAME,
		HOLDER2_PAN_NO,HOLDER2_KYC_FLAG,HOLDER3_CODE,HOLDER3_NAME,HOLDER3_PAN_NO,HOLDER3_KYC_FLAG,BUY_BROK_TABLE_NO,SELL_BROK_TABLE_NO,
		BROK_EFF_DATE,NEFTCODE,CHEQUENAME,RESIFAX,OFFICEFAX,MAPINID,REMARK,UCC_STATUS,ADDEDBY,ADDEDON,ACTIVE_FROM,INACTIVE_FROM,POAFLAG,DEACTIVE_REMARKS,
		DEACTIVE_VALUE,Action,USER_IP,APPNAME,MODIFIED_ON )
		SELECT PARTY_CODE,PARTY_NAME,CL_TYPE,CL_BALANCE,CL_STATUS,BRANCH_CD,SUB_BROKER,TRADER,AREA,REGION,SBU,FAMILY,GENDER,
		OCCUPATION_CODE,TAX_STATUS,PAN_NO,KYC_FLAG,ADDR1,ADDR2,ADDR3,CITY,STATE,ZIP,NATION,OFFICE_PHONE,RES_PHONE,
		MOBILE_NO,EMAIL_ID,BANK_NAME,BANK_BRANCH,BANK_CITY,ACC_NO,PAYMODE,MICR_NO,DOB,GAURDIAN_NAME,GAURDIAN_PAN_NO,
		NOMINEE_NAME,NOMINEE_RELATION,BANK_AC_TYPE,STAT_COMM_MODE,DP_TYPE,DPID,CLTDPID,MODE_HOLDING,HOLDER2_CODE,HOLDER2_NAME,
		HOLDER2_PAN_NO,HOLDER2_KYC_FLAG,HOLDER3_CODE,HOLDER3_NAME,HOLDER3_PAN_NO,HOLDER3_KYC_FLAG,BUY_BROK_TABLE_NO,SELL_BROK_TABLE_NO,
		BROK_EFF_DATE,NEFTCODE,CHEQUENAME,RESIFAX,OFFICEFAX,MAPINID,REMARK,UCC_STATUS,ADDEDBY,ADDEDON,ACTIVE_FROM,INACTIVE_FROM,POAFLAG,DEACTIVE_REMARKS,
		DEACTIVE_VALUE,'INSERTED',@IPADDRESS,APP_NAME(),GETDATE()  FROM INSERTED
		END

END

GO

-- --------------------------------------------------
-- VIEW dbo.ANG_BSEMFSS_ORDER_BOOK
-- --------------------------------------------------
CREATE VIEW ANG_BSEMFSS_ORDER_BOOK AS 

select

MO.*,L.RTA_SCHEME_CODE,L.RTA_TRANS_NO,L.RECFLAG,L.REMARK,L.RECFOR
from

MFSS_ORDER MO LEFT OUTER JOIN MFSS_ORDER_STATUS_LOG L
ON

MO.ORDER_DATE=L.ORDER_DATE
AND

MO.ORDER_NO=L.ORDER_NO
AND

MO.PARTY_CODE=L.PARTY_CODE
AND

MO.ISIN=L.ISIN
AND

MO.SETT_NO=L.SETT_NO

GO

-- --------------------------------------------------
-- VIEW dbo.BSEMFSS_ACCORDVIEW
-- --------------------------------------------------



CREATE  VIEW  [dbo].[BSEMFSS_ACCORDVIEW]  
AS  
SELECT *,(CASE WHEN MfEnabled_Flag='Y' AND Bank_Allowed_Flag='Y' THEN 'Y' ELSE 'N' END) OverAll_Flag  FROM (  
SELECT A.*,(CASE WHEN ISNULL(PARTY_CODE,'')='' THEN 'N' ELSE 'Y' END) MfEnabled_Flag ,  
(CASE WHEN ISNULL(MB.BANK_NAME,'')='' THEN 'N' ELSE 'Y' END)  Bank_Allowed_Flag FROM (  
SELECT  C.PARTY_CODE AS CLIENT_CODE,PARTY_NAME AS ClientName,  
ADDR1 AS ADDRESS1,ADDR2 AS ADDRESS2,ADDR3 AS ADDRESS3,CITY AS CITY,  
CONVERT(VARCHAR(15),'NA') AS OtherCity,STATE State,CONVERT(VARCHAR(15),'') OtherState,NATION AS Country,  
CONVERT(VARCHAR(15),'NA') AS OtherCountry,PAN_NO  PinCode,EMAIL_ID AS EMAILID,  
'NA'OfficePhoneNo,'NA' OfficeExtensionNo,'NA' OfficeFaxNo,RES_PHONE HomePhonoNo,'NA'HomeFaxNo, MOBILE_NO MobileNo,--T.Description Occupation,  
(CASE WHEN ISNULL(OCCUPATION_CODE,'') IN ('1','2','3','4','5','6','7') THEN OCCUPATION_CODE  
  ELSE '8' END)  AS Occupation,  
'' AnnualIncome,ACC_NO AccountNo,(CASE WHEN BANK_AC_TYPE='SB' THEN 'SB' ELSE 'CA' END) AccountType,  
--REPLACE(REPLACE(ISNULL(C.BANK_NAME,''),'HDFC BANK','HDFC'),'ICICI BANK','ICICI') BANKNAME
BANKNAME = (CASE WHEN  C.BANK_NAME LIKE 'HDFC BANK%' THEN 'HDFC' 
				 WHEN  C.BANK_NAME LIKE 'ICICI BA%' THEN 'ICICI'
				 WHEN  C.BANK_NAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'
				 WHEN  C.BANK_NAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'
				 WHEN  C.BANK_NAME ='YES' THEN 'YES BANK'
				 WHEN  C.BANK_NAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'
				 ELSE C.BANK_NAME END)

,BANK_BRANCH BankBranch,''BankBranchCode,BANK_CITY BankCity,C.CL_TYPE AS PersonalStatus,  
TaxStatus =(CASE WHEN C.CL_STATUS IN ('IND','ROR') THEN '01'    
                 WHEN C.CL_STATUS IN ('HUF') THEN '03'   
     WHEN C.CL_STATUS IN ('PF') THEN '06'   
     WHEN C.CL_STATUS IN ('BCP') THEN '07'    
     WHEN C.CL_STATUS IN ('TS') THEN '08'  
     WHEN C.CL_STATUS IN ('COM','DFI','NOR','OTH','QFI','SB') THEN '10'  
     WHEN C.CL_STATUS IN ('BA','BNK') THEN '14'  
     WHEN C.CL_STATUS IN ('NRE','NRI','NRO') THEN '21'  
     WHEN C.CL_STATUS IN ('MF','MFF') THEN '36'  
     ELSE '10' END)  
,'' Category,'CDSL'DepositoryName,  
'ANGEL BROKING PVT LTD' DPName ,'12032000' DPID,CLTDPID BeneficiaryAccountNo,HOLDER2_NAME SecondAppName,HOLDER3_NAME ThirdAppName,DOB DOB1,  
'' DOB2,'' DOB3,PAN_NO PANNo1,HOLDER2_PAN_NO  PANNo2,HOLDER3_PAN_NO PANNo3,  
''MINNo1,'' MINNo2,'' MINNo3,'NA'EcsNo,'NA' UINNo,'' Father_HusbandName,  
LTRIM(RTRIM(ISNULL(GAURDIAN_NAME,''))) GuardianName,  
'' GuardianRelationship, '' GuardianDOB,GAURDIAN_PAN_NO GaurdianPANNo,'' GaurdianMINNo,  
LTRIM(RTRIM(ISNULL(NOMINEE_NAME ,''))) NomineeName,  
'' NomineeRelation,'' NomineeDOB,(CASE WHEN ISNULL(POAFLAG,'') IN ('YES','1') THEN 'Y' ELSE 'N' END)POA,''SubBroker,'' CreatedBy,  
(CASE WHEN ISNULL(ACTIVE_FROM,'') ='' THEN ADDEDON ELSE ACTIVE_FROM END) CreatedOn,  
'' LastModifiedBy,'' LastModifiedOn,C.BRANCH_CD BranchID,'NA'OtherBankName,'NA' BankCode,NEFTCODE IFSCCODE,'Y' KYCflag ,  
(CASE WHEN INACTIVE_FROM > GETDATE() THEN 'ACTIVE' ELSE 'INACTIVE' END) ACTIVE_STATUS  
FROM MFSS_CLIENT   C  
--LEFT OUTER JOIN  
--AngelNseCM.MSAJAG.DBO.CLIENT_DETAILS CD ON CD.CL_CODE=PARTY_CODE    
--WHERE  C.PARTY_CODE IN ('V49038','A85012','KOLK9200','K50251','NOR317','K46795','P14438',  
--'R47022','R6540','A23214','K17733','M53706','H10651','A99423','S158131','R68750','VL002',  
--'VL001','J41740','V45643')     
)A  
LEFT OUTER JOIN (SELECT DISTINCT PARTY_CODE FROM INTRANET.Risk.DBO.BSEmfss_incrmtinsert)B ON CLIENT_CODE =B.party_code  
LEFT OUTER JOIN (SELECT * FROM MF_BANK WHERE BANK_STATUS ='Live') MB 
ON MB.BANK_NAME=(CASE WHEN  BANKNAME LIKE 'HDFC BANK%' THEN 'HDFC' 
				 WHEN  BANKNAME LIKE 'ICICI BA%' THEN 'ICICI'
				 WHEN  BANKNAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'
				 WHEN  BANKNAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'
				 WHEN  BANKNAME ='YES' THEN 'YES BANK'
				 WHEN  BANKNAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'
				 ELSE BANKNAME END)
)A

GO

-- --------------------------------------------------
-- VIEW dbo.BSEMFSS_ACCORDVIEW_BKP22022017
-- --------------------------------------------------

CREATE  VIEW  [dbo].[BSEMFSS_ACCORDVIEW_BKP22022017]  
AS  
SELECT *,(CASE WHEN MfEnabled_Flag='Y' AND Bank_Allowed_Flag='Y' THEN 'Y' ELSE 'N' END) OverAll_Flag  FROM (  
SELECT A.*,(CASE WHEN ISNULL(PARTY_CODE,'')='' THEN 'N' ELSE 'Y' END) MfEnabled_Flag ,  
(CASE WHEN ISNULL(MB.BANK_NAME,'')='' THEN 'N' ELSE 'Y' END)  Bank_Allowed_Flag FROM (  
SELECT  C.PARTY_CODE AS CLIENT_CODE,PARTY_NAME AS ClientName,  
ADDR1 AS ADDRESS1,ADDR2 AS ADDRESS2,ADDR3 AS ADDRESS3,CITY AS CITY,  
CONVERT(VARCHAR(15),'NA') AS OtherCity,STATE State,CONVERT(VARCHAR(15),'') OtherState,NATION AS Country,  
CONVERT(VARCHAR(15),'NA') AS OtherCountry,PAN_NO  PinCode,EMAIL_ID AS EMAILID,  
'NA'OfficePhoneNo,'NA' OfficeExtensionNo,'NA' OfficeFaxNo,RES_PHONE HomePhonoNo,'NA'HomeFaxNo, MOBILE_NO MobileNo,--T.Description Occupation,  
(CASE WHEN ISNULL(OCCUPATION_CODE,'') IN ('1','2','3','4','5','6','7') THEN OCCUPATION_CODE  
  ELSE '8' END)  AS Occupation,  
'' AnnualIncome,ACC_NO AccountNo,(CASE WHEN BANK_AC_TYPE='SB' THEN 'SB' ELSE 'CA' END) AccountType,  
REPLACE(REPLACE(ISNULL(C.BANK_NAME,''),'HDFC BANK','HDFC'),'ICICI BANK','ICICI') BANKNAME,BANK_BRANCH BankBranch,''BankBranchCode,BANK_CITY BankCity,C.CL_TYPE AS PersonalStatus,  
TaxStatus =(CASE WHEN C.CL_STATUS IN ('IND','ROR') THEN '01'    
                 WHEN C.CL_STATUS IN ('HUF') THEN '03'   
     WHEN C.CL_STATUS IN ('PF') THEN '06'   
     WHEN C.CL_STATUS IN ('BCP') THEN '07'    
     WHEN C.CL_STATUS IN ('TS') THEN '08'  
     WHEN C.CL_STATUS IN ('COM','DFI','NOR','OTH','QFI','SB') THEN '10'  
     WHEN C.CL_STATUS IN ('BA','BNK') THEN '14'  
     WHEN C.CL_STATUS IN ('NRE','NRI','NRO') THEN '21'  
     WHEN C.CL_STATUS IN ('MF','MFF') THEN '36'  
     ELSE '10' END)  
,'' Category,'CDSL'DepositoryName,  
'ANGEL BROKING PVT LTD' DPName ,'12032000' DPID,CLTDPID BeneficiaryAccountNo,HOLDER2_NAME SecondAppName,HOLDER3_NAME ThirdAppName,DOB DOB1,  
'' DOB2,'' DOB3,PAN_NO PANNo1,HOLDER2_PAN_NO  PANNo2,HOLDER3_PAN_NO PANNo3,  
''MINNo1,'' MINNo2,'' MINNo3,'NA'EcsNo,'NA' UINNo,'' Father_HusbandName,  
LTRIM(RTRIM(ISNULL(GAURDIAN_NAME,''))) GuardianName,  
'' GuardianRelationship, '' GuardianDOB,GAURDIAN_PAN_NO GaurdianPANNo,'' GaurdianMINNo,  
LTRIM(RTRIM(ISNULL(NOMINEE_NAME ,''))) NomineeName,  
'' NomineeRelation,'' NomineeDOB,(CASE WHEN ISNULL(POAFLAG,'') IN ('YES','1') THEN 'Y' ELSE 'N' END)POA,''SubBroker,'' CreatedBy,  
(CASE WHEN ISNULL(ACTIVE_FROM,'') ='' THEN ADDEDON ELSE ACTIVE_FROM END) CreatedOn,  
'' LastModifiedBy,'' LastModifiedOn,C.BRANCH_CD BranchID,'NA'OtherBankName,'NA' BankCode,NEFTCODE IFSCCODE,'Y' KYCflag ,  
(CASE WHEN INACTIVE_FROM > GETDATE() THEN 'ACTIVE' ELSE 'INACTIVE' END) ACTIVE_STATUS  
FROM MFSS_CLIENT   C  
--LEFT OUTER JOIN  
--ANAND1.MSAJAG.DBO.CLIENT_DETAILS CD ON CD.CL_CODE=PARTY_CODE    
--WHERE  C.PARTY_CODE IN ('V49038','A85012','KOLK9200','K50251','NOR317','K46795','P14438',  
--'R47022','R6540','A23214','K17733','M53706','H10651','A99423','S158131','R68750','VL002',  
--'VL001','J41740','V45643')     
)A  
LEFT OUTER JOIN (SELECT DISTINCT PARTY_CODE FROM [196.1.115.132].Risk.DBO.BSEmfss_incrmtinsert)B ON CLIENT_CODE =B.party_code  
LEFT OUTER JOIN (SELECT * FROM MF_BANK WHERE BANK_STATUS ='Live') MB ON MB.BANK_NAME=(CASE WHEN BANKNAME ='HDFC BANK' THEN 'HDFC'   
                         WHEN BANKNAME ='ICICI BANK' THEN 'ICICI'   
                         ELSE BANKNAME END)  
)A

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_OTHER_SEGMENT_VIEW
-- --------------------------------------------------



CREATE VIEW [dbo].[CLIENT_OTHER_SEGMENT_VIEW] AS                
                
SELECT                 
 C2.PARTY_CODE,PARTY_NAME=LONG_NAME,CL_TYPE,--CL_BALANCE='',       
 CL_BALANCE='E',             
 CL_STATUS=C1.CL_STATUS ,         
 --CL_STATUS= ( CASE WHEN CL_STATUS='PPB'OR CL_STATUS='BCP'THEN 'Company'ELSE           
  --   CASE WHEN CL_STATUS='HUF' THEN 'HUF' ELSE           
    --  CASE WHEN CL_STATUS='IND' THEN 'Individual' END END END),      
    BRANCH_CD,                
 SUB_BROKER,TRADER,AREA,REGION,            
 --SBU=DUMMY9,            
 SBU='HO',   FAMILY,                
 GENDER=ISNULL(C5.SEX,''),          
 --OCCUPATION_CODE='',          
 OCCUPATION_CODE= ( CASE WHEN U.OCCUPATION IN ('01','02')THEN '2' ELSE          
         CASE WHEN U.OCCUPATION = '03' THEN '1' ELSE          
      CASE WHEN U.OCCUPATION = '04' THEN '3' ELSE          
      CASE WHEN U.OCCUPATION = '05' THEN '4' ELSE          
      CASE WHEN U.OCCUPATION = '06' THEN '5' ELSE          
      CASE WHEN U.OCCUPATION = '07' THEN '6' ELSE          
      CASE WHEN U.OCCUPATION = '08' THEN '7' ELSE          
      CASE WHEN U.OCCUPATION IN ('09','99')THEN '8'  END END END END END END END END ) ,          
 TAX_STATUS=( CASE WHEN CL_STATUS='PPB'OR CL_STATUS='BCP'THEN '4'ELSE           
     CASE WHEN CL_STATUS='HUF' THEN '3' ELSE           
      CASE WHEN CL_STATUS='IND' THEN '1' END END END),          
 PAN_NO=PAN_GIR_NO,            
 --KYC_FLAG='',               
 KYC_FLAG='Y',              
 ADDR1=L_ADDRESS1,ADDR2=L_ADDRESS2,ADDR3=L_ADDRESS3,CITY=L_CITY,STATE=L_STATE,ZIP=L_ZIP,NATION=L_NATION,                
 OFFICE_PHONE = OFF_PHONE1,RES_PHONE= RES_PHONE1,MOBILE_NO=MOBILE_PAGER,EMAIL_ID=EMAIL,                
 --BANK_NAME'',          
 BANK_NAME=ISNULL(c4.BANK_NAME,CD.BANK_NAME),          
 --BANK_BRANCH='',          
 BANK_BRANCH=ISNULL(c4.BRANCH_NAME,CD.BRANCH_NAME),BANK_CITY='',                
 ACC_NO=ISNULL(ISNULL(C4.CLTDPID,CD.AC_Num),''),        
 --PAYMODE='',            
 PAYMODE=1,           
 --MICR_NO=''           
 MICR_NO=CD.MICR_NO,                
 DOB=BIRTHDATE,GAURDIAN_NAME='',GAURDIAN_PAN_NO='',NOMINEE_NAME='',NOMINEE_RELATION='',                
 BANK_AC_TYPE = CASE WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'SB'   
 WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'CB'  
 WHEN ISNULL(CD.AC_Type,'')='S' THEN 'SB' WHEN ISNULL(CD.AC_Type,'')='C' THEN 'CB'  
  ELSE '' END  
  ,                
 --STAT_COMM_MODE='',            
 STAT_COMM_MODE='P',            
 DP_TYPE = ISNULL(C44.DEPOSITORY,''),DPID= ISNULL(C44.BANKID,''),                
 CLTDPID=ISNULL(C44.CLTDPID,''),MODE_HOLDING='',HOLDER2_CODE='',HOLDER2_NAME='',                
 HOLDER2_PAN_NO='',HOLDER2_KYC_FLAG='',HOLDER3_CODE='',                
 HOLDER3_NAME='',HOLDER3_PAN_NO='',HOLDER3_KYC_FLAG='',            
 --BUY_BROK_TABLE_NO='',            
 --SELL_BROK_TABLE_NO='',              
 BUY_BROK_TABLE_NO=1,            
 SELL_BROK_TABLE_NO=1,              
 BROK_EFF_DATE=CONVERT(VARCHAR,GETDATE(),103),REMARK='',UCC_STATUS='',                
 NEFTCODE='',CHEQUENAME='',RESIFAX='',OFFICEFAX='',MAPINID='',POAFLAG =''                
FROM                
 ANGELBSECM.BSEDB_AB.DBO.CLIENT1 C1 , ANGELBSECM.BSEDB_AB.DBO.CLIENT2 C2          
 LEFT OUTER JOIN AngelNseCM.ACCOUNT.DBO.ACMAST               
 ON (CLTCODE = C2.PARTY_CODE)            
 LEFT OUTER JOIN (SELECT PARTY_CODE,c.BANKID,BANK_NAME,BRANCH_NAME,CLTDPID,DEPOSITORY FROM ANGELBSECM.BSEDB_AB.DBO.CLIENT4 C            
     LEFT OUTER JOIN ANGELBSECM.BSEDB_AB.DBO.POBANK PO           
     ON PO.BANKID=C.BANKID          
     WHERE C.DEPOSITORY IN ('SAVING','CURRENT')) C4                
 ON (C2.PARTY_CODE = C4.PARTY_CODE)                
 LEFT OUTER JOIN ANGELBSECM.BSEDB_AB.DBO.CLIENT5 C5                 
 ON (C5.CL_CODE = C2.PARTY_CODE)                
 LEFT OUTER JOIN AngelNseCM.MSAJAG.DBO.CLIENT_MASTER_UCC_DATA U             
 ON (U.Party_code = C2.PARTY_CODE)          
 --LEFT OUTER JOIN (SELECT PARTY_CODE,BANK_NAME,BRANCH_NAME,DEPOSITORY FROM ANGELBSECM.BSEDB_AB.DBO.CLIENT4 C4            
 --    LEFT OUTER JOIN ANGELBSECM.BSEDB_AB.DBO.POBANK PO           
 --    ON PO.BANKID=C4.BANKID          
 --    WHERE C4.DEPOSITORY IN ('SAVING','CURRENT'))P          
 --ON (P.Party_code=C2.PARTY_CODE)          
 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM ANGELBSECM.BSEDB_AB.DBO.CLIENT4  WHERE DEPOSITORY IN ('CDSL','NDSL') AND DEFDP = 1) C44                
 ON (C2.PARTY_CODE = C44.PARTY_CODE)          
 LEFT OUTER JOIN (SELECT PARTY_CODE,Bank_Name,Branch_Name,AC_Type,AC_Num,MICR_NO FROM AngelNseCM.MSAJAG.DBO.CLIENT_DETAILS )CD    --WHERE Micr_No <>''      
 ON (C2.PARTY_CODE = CD.PARTY_CODE)          
WHERE                
 C1.CL_CODE = C2.CL_CODE                
 AND NOT EXISTS (SELECT PARTY_CODE FROM MFSS_CLIENT MC (NOLOCK) WHERE MC.PARTY_CODE = C2.PARTY_CODE)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_OTHER_SEGMENT_VIEW_01032011
-- --------------------------------------------------
	  
CREATE  VIEW [dbo].[CLIENT_OTHER_SEGMENT_VIEW_01032011] AS  
  
SELECT   
 C2.PARTY_CODE,PARTY_NAME=LONG_NAME,CL_TYPE,CL_BALANCE='',CL_STATUS,BRANCH_CD,  
 SUB_BROKER,TRADER,AREA,REGION,SBU=DUMMY9,FAMILY,  
 GENDER=ISNULL(C5.SEX,''),OCCUPATION_CODE='',TAX_STATUS='',PAN_NO=PAN_GIR_NO,KYC_FLAG='',  
 ADDR1=L_ADDRESS1,ADDR2=L_ADDRESS2,ADDR3=L_ADDRESS3,CITY=L_CITY,STATE=L_STATE,ZIP=L_ZIP,NATION=L_NATION,  
 OFFICE_PHONE = OFF_PHONE1,RES_PHONE= RES_PHONE1,MOBILE_NO=MOBILE_PAGER,EMAIL_ID=EMAIL,  
 BANK_NAME='',BANK_BRANCH='',BANK_CITY='',  
 ACC_NO=ISNULL(C4.CLTDPID,''),PAYMODE='',MICR_NO='',  
 DOB=BIRTHDATE,GAURDIAN_NAME='',GAURDIAN_PAN_NO='',NOMINEE_NAME='',NOMINEE_RELATION='',  
 BANK_AC_TYPE = CASE WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'SB' WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'CB' ELSE '' END,  
 STAT_COMM_MODE='',DP_TYPE = ISNULL(C44.DEPOSITORY,''),DPID= ISNULL(C44.BANKID,''),  
 CLTDPID=ISNULL(C44.CLTDPID,''),MODE_HOLDING='',HOLDER2_CODE='',HOLDER2_NAME='',  
 HOLDER2_PAN_NO='',HOLDER2_KYC_FLAG='',HOLDER3_CODE='',  
 HOLDER3_NAME='',HOLDER3_PAN_NO='',HOLDER3_KYC_FLAG='',BUY_BROK_TABLE_NO='',SELL_BROK_TABLE_NO='',  
 BROK_EFF_DATE=CONVERT(VARCHAR,GETDATE(),103),REMARK='',UCC_STATUS='',  
 NEFTCODE='',CHEQUENAME='',RESIFAX='',OFFICEFAX='',MAPINID=''  
FROM  
 ANAND.BSEDB_AB.DBO.CLIENT1 C1 , ANAND.BSEDB_AB.DBO.CLIENT2 C2 
 LEFT OUTER JOIN ANAND.ACCOUNT_AB.DBO.ACMAST 
  ON (CLTCODE = C2.PARTY_CODE)  
 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4  WHERE DEPOSITORY IN ('SAVING','CURRENT')) C4  
 ON (C2.PARTY_CODE = C4.PARTY_CODE)  
 LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.CLIENT5 C5 
 ON (C5.CL_CODE = C2.PARTY_CODE)  
 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4  WHERE DEPOSITORY IN ('CDSL','NDSL') AND DEFDP = 1) C44  
 ON (C2.PARTY_CODE = C44.PARTY_CODE)  
WHERE  
 C1.CL_CODE = C2.CL_CODE  
 AND NOT EXISTS (SELECT PARTY_CODE FROM MFSS_CLIENT MC (NOLOCK) WHERE MC.PARTY_CODE = C2.PARTY_CODE)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_OTHER_SEGMENT_VIEW_02JAN2010
-- --------------------------------------------------


CREATE VIEW CLIENT_OTHER_SEGMENT_VIEW AS

SELECT 
	C2.PARTY_CODE,PARTY_NAME=LONG_NAME,CL_TYPE,CL_BALANCE='',CL_STATUS,BRANCH_CD,
	SUB_BROKER,TRADER,AREA,REGION,SBU=DUMMY9,FAMILY,
	GENDER=ISNULL(C5.SEX,''),OCCUPATION_CODE='',TAX_STATUS='',PAN_NO=PAN_GIR_NO,KYC_FLAG='',
	ADDR1=L_ADDRESS1,ADDR2=L_ADDRESS2,ADDR3=L_ADDRESS3,CITY=L_CITY,STATE=L_STATE,ZIP=L_ZIP,NATION=L_NATION,
	OFFICE_PHONE = OFF_PHONE1,RES_PHONE= RES_PHONE1,MOBILE_NO=MOBILE_PAGER,EMAIL_ID=EMAIL,
	 BANK_NAME='',BANK_BRANCH='',BANK_CITY='',      
	ACC_NO=ISNULL(C4.CLTDPID,''),PAYMODE='',MICR_NO=ISNULL(MICRNO,''),
	DOB=BIRTHDATE,GAURDIAN_NAME='',GAURDIAN_PAN_NO='',NOMINEE_NAME='',NOMINEE_RELATION='',
	BANK_AC_TYPE = CASE WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'SB' WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'CB' ELSE '' END,
	STAT_COMM_MODE='',DP_TYPE = ISNULL(C44.DEPOSITORY,''),DPID= ISNULL(C44.BANKID,''),
	CLTDPID=ISNULL(C44.CLTDPID,''),MODE_HOLDING='',HOLDER2_CODE='',HOLDER2_NAME='',
	HOLDER2_PAN_NO='',HOLDER2_KYC_FLAG='',HOLDER3_CODE='',
	HOLDER3_NAME='',HOLDER3_PAN_NO='',HOLDER3_KYC_FLAG='',BUY_BROK_TABLE_NO='',SELL_BROK_TABLE_NO='',
	BROK_EFF_DATE=CONVERT(VARCHAR,GETDATE(),103),REMARK='',UCC_STATUS=''
FROM
	NSEFO.DBO.CLIENT1 C1 (NOLOCK), NSEFO.DBO.CLIENT2 C2 (NOLOCK)
	LEFT OUTER JOIN ACCOUNTFO.DBO.ACMAST (NOLOCK)
 	ON (CLTCODE = C2.PARTY_CODE)
	LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM NSEFO.DBO.CLIENT4 (NOLOCK) WHERE DEPOSITORY IN ('SAVING','CURRENT')) C4
	ON (C2.PARTY_CODE = C4.PARTY_CODE)
	LEFT OUTER JOIN NSEFO.DBO.CLIENT5 C5 (NOLOCK)
	ON (C5.CL_CODE = C2.PARTY_CODE)
	LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM NSEFO.DBO.CLIENT4 (NOLOCK) WHERE DEPOSITORY IN ('CDSL','NDSL') AND DEFDP = 1) C44
	ON (C2.PARTY_CODE = C44.PARTY_CODE)
WHERE
	C1.CL_CODE = C2.CL_CODE
	AND NOT EXISTS (SELECT PARTY_CODE FROM MFSS_CLIENT MC (NOLOCK) WHERE MC.PARTY_CODE = C2.PARTY_CODE)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_OTHER_SEGMENT_VIEW_BAK
-- --------------------------------------------------
CREATE VIEW CLIENT_OTHER_SEGMENT_VIEW_BAK AS      
      
SELECT       
 C2.PARTY_CODE,PARTY_NAME=LONG_NAME,CL_TYPE,CL_BALANCE='',CL_STATUS,BRANCH_CD,      
 SUB_BROKER,TRADER,AREA,REGION,SBU=DUMMY9,FAMILY,      
 GENDER=ISNULL(C5.SEX,''),OCCUPATION_CODE='',TAX_STATUS='',PAN_NO=PAN_GIR_NO,KYC_FLAG='',      
 ADDR1=L_ADDRESS1,ADDR2=L_ADDRESS2,ADDR3=L_ADDRESS3,CITY=L_CITY,STATE=L_STATE,ZIP=L_ZIP,NATION=L_NATION,      
 OFFICE_PHONE = OFF_PHONE1,RES_PHONE= RES_PHONE1,MOBILE_NO=MOBILE_PAGER,EMAIL_ID=EMAIL,      
 BANK_NAME='',BANK_BRANCH='',BANK_CITY='',      
 ACC_NO=ISNULL(C4.CLTDPID,''),PAYMODE='',MICR_NO=ISNULL(MICRNO,''),      
 DOB=BIRTHDATE,GAURDIAN_NAME='',GAURDIAN_PAN_NO='',NOMINEE_NAME='',NOMINEE_RELATION='',      
 BANK_AC_TYPE = CASE WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'SB' WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'CB' ELSE '' END,      
 STAT_COMM_MODE='',DP_TYPE = ISNULL(C44.DEPOSITORY,''),DPID= ISNULL(C44.BANKID,''),      
 CLTDPID=ISNULL(C44.CLTDPID,''),MODE_HOLDING='',HOLDER2_CODE='',HOLDER2_NAME='',      
 HOLDER2_PAN_NO='',HOLDER2_KYC_FLAG='',HOLDER3_CODE='',      
 HOLDER3_NAME='',HOLDER3_PAN_NO='',HOLDER3_KYC_FLAG='',BROK_TABLE_NO='',      
 BROK_EFF_DATE=CONVERT(VARCHAR,GETDATE(),103),REMARK='',UCC_STATUS='',      
 NEFTCODE='',CHEQUENAME='',RESIFAX='',OFFICEFAX='',MAPINID=''      
FROM      
 NSEFO.DBO.CLIENT1 C1 (NOLOCK), NSEFO.DBO.CLIENT2 C2 (NOLOCK)      
 LEFT OUTER JOIN ACCOUNTfo.DBO.ACMAST (NOLOCK)      
  ON (CLTCODE = C2.PARTY_CODE)      
 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM NSEFO.DBO.CLIENT4 (NOLOCK) WHERE DEPOSITORY IN ('SAVING','CURRENT')) C4      
 ON (C2.PARTY_CODE = C4.PARTY_CODE)      
 LEFT OUTER JOIN NSEFO.DBO.CLIENT5 C5 (NOLOCK)      
 ON (C5.CL_CODE = C2.PARTY_CODE)      
 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM NSEFO.DBO.CLIENT4 (NOLOCK) WHERE DEPOSITORY IN ('CDSL','NDSL') AND DEFDP = 1) C44      
 ON (C2.PARTY_CODE = C44.PARTY_CODE)      
WHERE      
 C1.CL_CODE = C2.CL_CODE      
 AND NOT EXISTS (SELECT PARTY_CODE FROM MFSS_CLIENT MC (NOLOCK) WHERE MC.PARTY_CODE = C2.PARTY_CODE)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_OTHER_SEGMENT_VIEW_BKP_15032023
-- --------------------------------------------------



CREATE VIEW [dbo].[CLIENT_OTHER_SEGMENT_VIEW_BKP_15032023] AS                
                
SELECT                 
 C2.PARTY_CODE,PARTY_NAME=LONG_NAME,CL_TYPE,--CL_BALANCE='',       
 CL_BALANCE='E',             
 CL_STATUS=C1.CL_STATUS ,         
 --CL_STATUS= ( CASE WHEN CL_STATUS='PPB'OR CL_STATUS='BCP'THEN 'Company'ELSE           
  --   CASE WHEN CL_STATUS='HUF' THEN 'HUF' ELSE           
    --  CASE WHEN CL_STATUS='IND' THEN 'Individual' END END END),      
    BRANCH_CD,                
 SUB_BROKER,TRADER,AREA,REGION,            
 --SBU=DUMMY9,            
 SBU='HO',   FAMILY,                
 GENDER=ISNULL(C5.SEX,''),          
 --OCCUPATION_CODE='',          
 OCCUPATION_CODE= ( CASE WHEN U.OCCUPATION IN ('01','02')THEN '2' ELSE          
         CASE WHEN U.OCCUPATION = '03' THEN '1' ELSE          
      CASE WHEN U.OCCUPATION = '04' THEN '3' ELSE          
      CASE WHEN U.OCCUPATION = '05' THEN '4' ELSE          
      CASE WHEN U.OCCUPATION = '06' THEN '5' ELSE          
      CASE WHEN U.OCCUPATION = '07' THEN '6' ELSE          
      CASE WHEN U.OCCUPATION = '08' THEN '7' ELSE          
      CASE WHEN U.OCCUPATION IN ('09','99')THEN '8'  END END END END END END END END ) ,          
 TAX_STATUS=( CASE WHEN CL_STATUS='PPB'OR CL_STATUS='BCP'THEN '4'ELSE           
     CASE WHEN CL_STATUS='HUF' THEN '3' ELSE           
      CASE WHEN CL_STATUS='IND' THEN '1' END END END),          
 PAN_NO=PAN_GIR_NO,            
 --KYC_FLAG='',               
 KYC_FLAG='Y',              
 ADDR1=L_ADDRESS1,ADDR2=L_ADDRESS2,ADDR3=L_ADDRESS3,CITY=L_CITY,STATE=L_STATE,ZIP=L_ZIP,NATION=L_NATION,                
 OFFICE_PHONE = OFF_PHONE1,RES_PHONE= RES_PHONE1,MOBILE_NO=MOBILE_PAGER,EMAIL_ID=EMAIL,                
 --BANK_NAME'',          
 BANK_NAME=ISNULL(c4.BANK_NAME,CD.BANK_NAME),          
 --BANK_BRANCH='',          
 BANK_BRANCH=ISNULL(c4.BRANCH_NAME,CD.BRANCH_NAME),BANK_CITY='',                
 ACC_NO=ISNULL(ISNULL(C4.CLTDPID,CD.AC_Num),''),        
 --PAYMODE='',            
 PAYMODE=1,           
 --MICR_NO=''           
 MICR_NO=CD.MICR_NO,                
 DOB=BIRTHDATE,GAURDIAN_NAME='',GAURDIAN_PAN_NO='',NOMINEE_NAME='',NOMINEE_RELATION='',                
 BANK_AC_TYPE = CASE WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'SB'   
 WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'CB'  
 WHEN ISNULL(CD.AC_Type,'')='S' THEN 'SB' WHEN ISNULL(CD.AC_Type,'')='C' THEN 'CB'  
  ELSE '' END  
  ,                
 --STAT_COMM_MODE='',            
 STAT_COMM_MODE='P',            
 DP_TYPE = ISNULL(C44.DEPOSITORY,''),DPID= ISNULL(C44.BANKID,''),                
 CLTDPID=ISNULL(C44.CLTDPID,''),MODE_HOLDING='',HOLDER2_CODE='',HOLDER2_NAME='',                
 HOLDER2_PAN_NO='',HOLDER2_KYC_FLAG='',HOLDER3_CODE='',                
 HOLDER3_NAME='',HOLDER3_PAN_NO='',HOLDER3_KYC_FLAG='',            
 --BUY_BROK_TABLE_NO='',            
 --SELL_BROK_TABLE_NO='',              
 BUY_BROK_TABLE_NO=1,            
 SELL_BROK_TABLE_NO=1,              
 BROK_EFF_DATE=CONVERT(VARCHAR,GETDATE(),103),REMARK='',UCC_STATUS='',                
 NEFTCODE='',CHEQUENAME='',RESIFAX='',OFFICEFAX='',MAPINID='',POAFLAG =''                
FROM                
 ANAND.BSEDB_AB.DBO.CLIENT1 C1 , ANAND.BSEDB_AB.DBO.CLIENT2 C2          
 LEFT OUTER JOIN AngelNseCM.ACCOUNT.DBO.ACMAST               
 ON (CLTCODE = C2.PARTY_CODE)            
 LEFT OUTER JOIN (SELECT PARTY_CODE,c.BANKID,BANK_NAME,BRANCH_NAME,CLTDPID,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4 C            
     LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.POBANK PO           
     ON PO.BANKID=C.BANKID          
     WHERE C.DEPOSITORY IN ('SAVING','CURRENT')) C4                
 ON (C2.PARTY_CODE = C4.PARTY_CODE)                
 LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.CLIENT5 C5                 
 ON (C5.CL_CODE = C2.PARTY_CODE)                
 LEFT OUTER JOIN AngelNseCM.MSAJAG.DBO.CLIENT_MASTER_UCC_DATA U             
 ON (U.Party_code = C2.PARTY_CODE)          
 --LEFT OUTER JOIN (SELECT PARTY_CODE,BANK_NAME,BRANCH_NAME,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4 C4            
 --    LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.POBANK PO           
 --    ON PO.BANKID=C4.BANKID          
 --    WHERE C4.DEPOSITORY IN ('SAVING','CURRENT'))P          
 --ON (P.Party_code=C2.PARTY_CODE)          
 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4  WHERE DEPOSITORY IN ('CDSL','NDSL') AND DEFDP = 1) C44                
 ON (C2.PARTY_CODE = C44.PARTY_CODE)          
 LEFT OUTER JOIN (SELECT PARTY_CODE,Bank_Name,Branch_Name,AC_Type,AC_Num,MICR_NO FROM AngelNseCM.MSAJAG.DBO.CLIENT_DETAILS )CD    --WHERE Micr_No <>''      
 ON (C2.PARTY_CODE = CD.PARTY_CODE)          
WHERE                
 C1.CL_CODE = C2.CL_CODE                
 AND NOT EXISTS (SELECT PARTY_CODE FROM MFSS_CLIENT MC (NOLOCK) WHERE MC.PARTY_CODE = C2.PARTY_CODE)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_OTHER_SEGMENT_VIEW_pratham
-- --------------------------------------------------



CREATE VIEW [dbo].[CLIENT_OTHER_SEGMENT_VIEW_pratham] AS                

                

SELECT                 

 C2.PARTY_CODE,PARTY_NAME=LONG_NAME,CL_TYPE,--CL_BALANCE='',       

 CL_BALANCE='E',             

 CL_STATUS=C1.CL_STATUS ,         

 --CL_STATUS= ( CASE WHEN CL_STATUS='PPB'OR CL_STATUS='BCP'THEN 'Company'ELSE           

  --   CASE WHEN CL_STATUS='HUF' THEN 'HUF' ELSE           

    --  CASE WHEN CL_STATUS='IND' THEN 'Individual' END END END),      

    BRANCH_CD,                

 SUB_BROKER,TRADER,AREA,REGION,            

 --SBU=DUMMY9,            

 SBU='HO',   FAMILY,                

 GENDER=ISNULL(C5.SEX,''),          

 --OCCUPATION_CODE='',          

 OCCUPATION_CODE= ( CASE WHEN U.OCCUPATION IN ('01','02')THEN '2' ELSE          

         CASE WHEN U.OCCUPATION = '03' THEN '1' ELSE          

      CASE WHEN U.OCCUPATION = '04' THEN '3' ELSE          

      CASE WHEN U.OCCUPATION = '05' THEN '4' ELSE          

      CASE WHEN U.OCCUPATION = '06' THEN '5' ELSE          

      CASE WHEN U.OCCUPATION = '07' THEN '6' ELSE          

      CASE WHEN U.OCCUPATION = '08' THEN '7' ELSE          

      CASE WHEN U.OCCUPATION IN ('09','99')THEN '8'  END END END END END END END END ) ,          

 TAX_STATUS=( CASE WHEN CL_STATUS='PPB'OR CL_STATUS='BCP'THEN '4'ELSE           

     CASE WHEN CL_STATUS='HUF' THEN '3' ELSE           

      CASE WHEN CL_STATUS='IND' THEN '1' END END END),          

 PAN_NO=PAN_GIR_NO,            

 --KYC_FLAG='',               

 KYC_FLAG='Y',              

 ADDR1=L_ADDRESS1,ADDR2=L_ADDRESS2,ADDR3=L_ADDRESS3,CITY=L_CITY,STATE=L_STATE,ZIP=L_ZIP,NATION=L_NATION,                

 OFFICE_PHONE = OFF_PHONE1,RES_PHONE= RES_PHONE1,MOBILE_NO=MOBILE_PAGER,EMAIL_ID=EMAIL,                

 --BANK_NAME'',          

 BANK_NAME=ISNULL(c4.BANK_NAME,CD.BANK_NAME),          

 --BANK_BRANCH='',          

 BANK_BRANCH=ISNULL(c4.BRANCH_NAME,CD.BRANCH_NAME),BANK_CITY='',                

 ACC_NO=ISNULL(ISNULL(C4.CLTDPID,CD.AC_Num),''),        

 --PAYMODE='',            

 PAYMODE=1,           

 --MICR_NO=''           

 MICR_NO=CD.MICR_NO,                

 DOB=BIRTHDATE,GAURDIAN_NAME='',GAURDIAN_PAN_NO='',NOMINEE_NAME='',NOMINEE_RELATION='',                

 BANK_AC_TYPE = CASE WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'SB'   

 WHEN ISNULL(C4.DEPOSITORY,'') ='SAVING' THEN 'CB'  

 WHEN ISNULL(CD.AC_Type,'')='S' THEN 'SB' WHEN ISNULL(CD.AC_Type,'')='C' THEN 'CB'  

  ELSE '' END  

  ,                

 --STAT_COMM_MODE='',            

 STAT_COMM_MODE='P',            

 DP_TYPE = ISNULL(C44.DEPOSITORY,''),DPID= ISNULL(C44.BANKID,''),                

 CLTDPID=ISNULL(C44.CLTDPID,''),MODE_HOLDING='',HOLDER2_CODE='',HOLDER2_NAME='',                

 HOLDER2_PAN_NO='',HOLDER2_KYC_FLAG='',HOLDER3_CODE='',                

 HOLDER3_NAME='',HOLDER3_PAN_NO='',HOLDER3_KYC_FLAG='',            

 --BUY_BROK_TABLE_NO='',            

 --SELL_BROK_TABLE_NO='',              

 BUY_BROK_TABLE_NO=1,            

 SELL_BROK_TABLE_NO=1,              

 BROK_EFF_DATE=CONVERT(VARCHAR,GETDATE(),103),REMARK='',UCC_STATUS='',                

 NEFTCODE='',CHEQUENAME='',RESIFAX='',OFFICEFAX='',MAPINID='',POAFLAG =''                

FROM                

 ANAND.BSEDB_AB.DBO.CLIENT1 C1 , ANAND.BSEDB_AB.DBO.CLIENT2 C2          

 LEFT OUTER JOIN AngelNseCM.ACCOUNT.DBO.ACMAST               

 ON (CLTCODE = C2.PARTY_CODE)            

 LEFT OUTER JOIN (SELECT PARTY_CODE,c.BANKID,BANK_NAME,BRANCH_NAME,CLTDPID,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4 C            

     LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.POBANK PO           

     ON PO.BANKID=C.BANKID          

     WHERE C.DEPOSITORY IN ('SAVING','CURRENT')) C4                

 ON (C2.PARTY_CODE = C4.PARTY_CODE)                

 LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.CLIENT5 C5                 

 ON (C5.CL_CODE = C2.PARTY_CODE)                

 LEFT OUTER JOIN AngelNseCM.MSAJAG.DBO.CLIENT_MASTER_UCC_DATA U             

 ON (U.Party_code = C2.PARTY_CODE)  

 --LEFT OUTER JOIN (SELECT PARTY_CODE,BANK_NAME,BRANCH_NAME,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4 C4            

 --    LEFT OUTER JOIN ANAND.BSEDB_AB.DBO.POBANK PO           

 --    ON PO.BANKID=C4.BANKID          

 --    WHERE C4.DEPOSITORY IN ('SAVING','CURRENT'))P          

 --ON (P.Party_code=C2.PARTY_CODE)          

 LEFT OUTER JOIN (SELECT PARTY_CODE,BANKID,CLTDPID,DEPOSITORY FROM ANAND.BSEDB_AB.DBO.CLIENT4  WHERE DEPOSITORY IN ('CDSL','NDSL') AND DEFDP = 1) C44                

 ON (C2.PARTY_CODE = C44.PARTY_CODE)          

 LEFT OUTER JOIN (SELECT PARTY_CODE,Bank_Name,Branch_Name,AC_Type,AC_Num,MICR_NO FROM AngelNseCM.MSAJAG.DBO.CLIENT_DETAILS )CD    --WHERE Micr_No <>''      

 ON (C2.PARTY_CODE = CD.PARTY_CODE)          

WHERE                

 C1.CL_CODE = C2.CL_CODE                

 AND NOT EXISTS (SELECT PARTY_CODE FROM MFSS_CLIENT MC (NOLOCK) WHERE MC.PARTY_CODE = C2.PARTY_CODE)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT1
-- --------------------------------------------------
CREATE VIEW [dbo].[CLIENT1]    
AS    
SELECT   
 CL_CODE = PARTY_CODE,   
 SHORT_NAME = PARTY_NAME,   
 LONG_NAME = PARTY_NAME,  
 L_ADDRESS1 = ADDR1,  
 L_ADDRESS2 = ADDR2,  
 L_ADDRESS3 = ADDR3,  
 L_CITY = CITY,    
 L_STATE = [STATE],    
 L_NATION = NATION,  
 L_ZIP = ZIP,    
 FAX = '',    
 RES_PHONE1 = OFFICE_PHONE,    
 RES_PHONE2 = RES_PHONE,    
 MOBILE_PAGER = MOBILE_NO,    
 PAN_GIR_NO = PAN_NO,    
 EMAIL = EMAIL_ID,    
 FAMILY,   
 TRADER,   
 SUB_BROKER,   
 BRANCH_CD,   
 AREA,   
 REGION,   
 CL_TYPE,
 BANK_NAME,
 ACC_NO    
FROM BSEMFSS.DBO.MFSS_CLIENT

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT1_org
-- --------------------------------------------------
CREATE VIEW [dbo].[CLIENT1_org]  
AS  
SELECT 
	CL_CODE = PARTY_CODE, 
	SHORT_NAME = PARTY_NAME, 
	LONG_NAME = PARTY_NAME,
	L_ADDRESS1 = ADDR1,
	L_ADDRESS2 = ADDR2,
	L_ADDRESS3 = ADDR3,
	L_CITY = CITY,  
	L_STATE = [STATE],  
	L_NATION = NATION,
	L_ZIP = ZIP,  
	FAX = '',  
	RES_PHONE1 = OFFICE_PHONE,  
	RES_PHONE2 = RES_PHONE,  
	MOBILE_PAGER = MOBILE_NO,  
	PAN_GIR_NO = PAN_NO,  
	EMAIL = EMAIL_ID,  
	FAMILY, 
	TRADER, 
	SUB_BROKER, 
	BRANCH_CD, 
	AREA, 
	REGION, 
	CL_TYPE  
FROM BSEMFSS.DBO.MFSS_CLIENT

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT2
-- --------------------------------------------------

CREATE VIEW CLIENT2
AS
SELECT
	CL_CODE = PARTY_CODE,
	PARTY_CODE
FROM
	BSEMFSS.dbo.MFSS_CLIENT

GO

-- --------------------------------------------------
-- VIEW dbo.DELIVERYCLT
-- --------------------------------------------------
    
CREATE VIEW DELIVERYCLT          
AS          
          

SELECT SETT_NO, SETT_TYPE, SCRIP_CD, SERIES = 'MF', SCHEME_NAME, ISIN, PARTY_CODE, QTY = SUM(QTY),           
INOUT = (CASE WHEN SUB_RED_FLAG = 'P' THEN 'O' ELSE 'I' END), BRANCH_CD = 'HO',       
PARTIPANTCODE = MEMBERCODE, DPCLT      
FROM MFSS_SETTLEMENT WHERE ORDER_DATE >= '2010-12-24' AND ALLOTMENT_MODE = 'DEMAT'       
GROUP BY SETT_NO, SETT_TYPE, SCRIP_CD, SCHEME_NAME, ISIN, PARTY_CODE, SUB_RED_FLAG, MEMBERCODE, DPCLT

GO

-- --------------------------------------------------
-- VIEW dbo.DELNET
-- --------------------------------------------------
  
CREATE VIEW DELNET      
AS      
      
  SELECT SETT_NO, SETT_TYPE, SCRIP_CD, SERIES = 'MF', SCHEME_NAME, ISIN, QTY = SUM(QTY),       
  INOUT = (CASE WHEN SUB_RED_FLAG = 'P' THEN 'O' ELSE 'I' END)      
  FROM MFSS_SETTLEMENT WHERE ORDER_DATE >= '2010-12-24' AND ALLOTMENT_MODE = 'DEMAT'   
  GROUP BY SETT_NO, SETT_TYPE, SCRIP_CD, SCHEME_NAME, ISIN, SUB_RED_FLAG

GO

-- --------------------------------------------------
-- VIEW dbo.Fragmentaion_details
-- --------------------------------------------------
create view Fragmentaion_details
as 

SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent > 0

GO

-- --------------------------------------------------
-- VIEW dbo.MF_ACTIVE_LIST_FORSB
-- --------------------------------------------------
CREATE VIEW MF_ACTIVE_LIST_FORSB  
AS  
SELECT PARTY_CODE,ACTIVE_FROM =(CASE WHEN ACTIVE_FROM ='' THEN ADDEDON  ELSE ACTIVE_FROM END)  
,Status =(CASE WHEN IsNULL(INACTIVE_FROM,GETDATE() + 1 ) >=GETDATE() THEN 'ACTIVE' ELSE 'INACTIVE' END),  
Account_Type =( CASE WHEN DP_TYPE ='PHY' THEN 'Physical' ELSE 'Demat' End),BRANCH_CD,SUB_BROKER    
FROM MFSS_CLIENT WITH(NOLOCK)   
WHERE PARTY_CODE >='A' AND PARTY_CODE <='ZZZZZ'

GO

-- --------------------------------------------------
-- VIEW dbo.MF_CLIENT
-- --------------------------------------------------


CREATE VIEW MF_CLIENT
AS 
SELECT DISTINCT PARTY_CODE   FROM MFSS_CLIENT (Nolock) WHERE DP_TYPE ='PHY'

GO

-- --------------------------------------------------
-- VIEW dbo.MF_MULTIBANK
-- --------------------------------------------------

CREATE view [dbo].[MF_MULTIBANK]   
---WITH ENCRYPTION   
AS  
SELECT DISTINCT D.PARTY_CODE, PARTY_NAME,  
BANKNAME =(CASE WHEN  D.BANKNAME LIKE 'HDFC BANK%' THEN 'HDFC'   
     WHEN  D.BANKNAME LIKE 'ICICI BA%' THEN 'ICICI'  
     WHEN  D.BANKNAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'  
     WHEN  D.BANKNAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'  
     WHEN  D.BANKNAME ='YES' THEN 'YES BANK'  
     WHEN  D.BANKNAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'  
     ELSE D.BANKNAME END)  
     ,D.BRANCH ,D.ACNUM,BANKIFSC=CONVERT(VARCHAR(50),''),bankmicr =CONVERT(VARCHAR(50),'')  
FROM MFSS_CLIENT M WITH(NOLOCK),ANAND1.MSAJAG.DBO.PARTY_BANK_DETAILS D WITH(NOLOCK)  
WHERE M.PARTY_CODE =D.PARTY_CODE AND D.BANKNAME NOT LIKE 'UNKN%'  
AND ACNUM <>'0'     
UNION    
SELECT DISTINCT  PARTY_CODE, PARTY_NAME,  
BANKNAME =(CASE WHEN  BANK_NAME  LIKE 'HDFC BANK%' THEN 'HDFC'   
     WHEN  BANK_NAME LIKE 'ICICI BA%' THEN 'ICICI'  
     WHEN  BANK_NAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'  
     WHEN  BANK_NAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'  
     WHEN  BANK_NAME ='YES' THEN 'YES BANK'  
     WHEN  BANK_NAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'  
     ELSE BANK_NAME END)  
     , BANK_BRANCH AS BRANCH ,ACC_NO ACNUM,BANKIFSC=NEFTCODE ,bankmicr=MICR_NO   
FROM MFSS_CLIENT M WITH(NOLOCK)   
WHERE DP_TYPE ='PHY'   
UNION    
SELECT DISTINCT CLTCODE PARTY_CODE, Chequename PARTY_NAME,  
BANKNAME =(CASE WHEN  BANK_NAME  LIKE 'HDFC BANK%' THEN 'HDFC'   
     WHEN  BANK_NAME LIKE 'ICICI BA%' THEN 'ICICI'  
     WHEN  BANK_NAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'  
     WHEN  BANK_NAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'  
     WHEN  BANK_NAME ='YES' THEN 'YES BANK'  
     WHEN  BANK_NAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'  
     ELSE BANK_NAME END)  
     , BRANCH_NAME AS BRANCH ,ACCNO ACNUM,BANKIFSC=IFSCCODE ,bankmicr=''
FROM POBANK P WITH(NOLOCK)   ,BBO_FA.DBO.Multibankid_Other  M WITH(NOLOCK)   
WHERE   P.BANKID =M.Bankid

GO

-- --------------------------------------------------
-- VIEW dbo.MF_MULTIBANK_05122017_bak
-- --------------------------------------------------


CREATE view [dbo].[MF_MULTIBANK_05122017_bak]
---WITH ENCRYPTION 
AS
SELECT DISTINCT D.PARTY_CODE, PARTY_NAME,
BANKNAME =(CASE WHEN  D.BANKNAME LIKE 'HDFC BANK%' THEN 'HDFC' 
				 WHEN  D.BANKNAME LIKE 'ICICI BA%' THEN 'ICICI'
				 WHEN  D.BANKNAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'
				 WHEN  D.BANKNAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'
				 WHEN  D.BANKNAME ='YES' THEN 'YES BANK'
				 WHEN  D.BANKNAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'
				 ELSE D.BANKNAME END)
				 ,D.BRANCH ,D.ACNUM
FROM MFSS_CLIENT M WITH(NOLOCK),ANAND1.MSAJAG.DBO.PARTY_BANK_DETAILS D WITH(NOLOCK)
WHERE M.PARTY_CODE =D.PARTY_CODE AND D.BANKNAME NOT LIKE 'UNKN%'
AND ACNUM <>'0'   --AND ACNUM <>ACC_NO

GO

-- --------------------------------------------------
-- VIEW dbo.MF_MULTIBANK_bak_05122017
-- --------------------------------------------------
CREATE view MF_MULTIBANK_bak_05122017
---WITH ENCRYPTION 
AS
SELECT DISTINCT D.PARTY_CODE, PARTY_NAME,
BANKNAME =(CASE WHEN  D.BANKNAME LIKE 'HDFC BANK%' THEN 'HDFC' 
				 WHEN  D.BANKNAME LIKE 'ICICI BA%' THEN 'ICICI'
				 WHEN  D.BANKNAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'
				 WHEN  D.BANKNAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'
				 WHEN  D.BANKNAME ='YES' THEN 'YES BANK'
				 WHEN  D.BANKNAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'
				 ELSE D.BANKNAME END)
				 ,D.BRANCH ,D.ACNUM
FROM MFSS_CLIENT M WITH(NOLOCK),ANAND1.MSAJAG.DBO.PARTY_BANK_DETAILS D WITH(NOLOCK)
WHERE M.PARTY_CODE =D.PARTY_CODE AND D.BANKNAME NOT LIKE 'UNKN%'
AND ACNUM <>'0'   
UNION  
SELECT DISTINCT  PARTY_CODE, PARTY_NAME,
BANKNAME =(CASE WHEN  BANK_NAME  LIKE 'HDFC BANK%' THEN 'HDFC' 
				 WHEN  BANK_NAME LIKE 'ICICI BA%' THEN 'ICICI'
				 WHEN  BANK_NAME LIKE 'AXIS BANK %' THEN 'AXIS BANK'
				 WHEN  BANK_NAME LIKE 'STATE BANK OF INDIA%' THEN 'SBI'
				 WHEN  BANK_NAME ='YES' THEN 'YES BANK'
				 WHEN  BANK_NAME LIKE 'Bank of Baroda%' THEN 'BANK OF BARODA'
				 ELSE BANK_NAME END)
				 , BANK_BRANCH AS BRANCH ,ACC_NO ACNUM
FROM MFSS_CLIENT M WITH(NOLOCK) 
WHERE DP_TYPE ='PHY'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_CLIENT_BSEMFSS
-- --------------------------------------------------
CREATE VIEW MFSS_CLIENT_BSEMFSS  
AS  
SELECT PARTY_CODE,PARTY_NAME,ACTIVE_FROM   
from BSEMFSS..MFSS_CLIENT

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_CLIENT_MODIF
-- --------------------------------------------------

CREATE VIEW MFSS_CLIENT_MODIF
AS 
SELECT DISTINCT PARTY_CODE ,MAX(MODIFIED_ON) MODIFIED_ON 
FROM MFSS_CLIENT_trig WITH(NOLOCK) WHERE MODIFIED_ON >= CONVERT(VARCHAR(11),GETDATE()-7,120)
GROUP BY PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_Client_Status
-- --------------------------------------------------
Create View MFSS_Client_Status
as
select PARTY_CODE,ACC_STATUS =(CASE WHEN INACTIVE_FROM >GETDATE() THEN 'ACTIVE' ELSE 'INACTIVE' END)
FROM MFSS_CLIENT  WITH(NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_CONFIRMVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[MFSS_CONFIRMVIEW] 

AS      

SELECT CONTRACTNO=CONVERT(VARCHAR(7),'0'),BILLNO=0,MEMBERCODE,ORDER_DATE,
ORDER_TIME,ORDER_NO,SETT_NO,SETT_TYPE,T.PARTY_CODE,T.PARTY_NAME,SCRIP_CD,SCHEME_NAME,
ISIN,SUB_RED_FLAG,SETTFLAG,AMOUNT,QTY,ALLOTMENT_MODE,DPCLT,FOLIONO,USER_ID,CONF_FLAG,REJECT_REASON,
BROKERAGE=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END),
INS_CHRG=0.00,TURN_TAX=0.00,OTHER_CHRG=0.00,SEBI_TAX=0.00,BROKER_CHRG=0.00,
SERVICE_TAX=(CASE WHEN VAL_PERC = 'V' THEN NORMAL ELSE AMOUNT*NORMAL/100 END)*G.SERVICE_TAX/100,
FILLER1=' ',FILLER2=' ',FILLER3=' '
FROM MFSS_TRADE T, MFSS_CLIENT C, MFSS_BROKERAGE_MASTER M, BROKTABLE B, GLOBALS G
WHERE T.PARTY_CODE = C.PARTY_CODE 
AND T.PARTY_CODE = M.PARTY_CODE
AND B.TABLE_NO = (CASE WHEN SUB_RED_FLAG = 'P' 
				       THEN M.BUY_BROK_TABLE_NO 
					   ELSE M.SELL_BROK_TABLE_NO 
				  END)
AND ORDER_DATE BETWEEN M.FROMDATE AND M.TODATE
AND ORDER_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
AND T.AMOUNT > B.LOWER_LIM AND T.AMOUNT <= B.UPPER_LIM
AND T.SETT_NO <> ''
UNION ALL
SELECT CONTRACTNO=CONVERT(VARCHAR(7),'0'),BILLNO='0',MEMBERCODE,ORDER_DATE,
ORDER_TIME,ORDER_NO,SETT_NO,SETT_TYPE,T.PARTY_CODE,T.PARTY_NAME,SCRIP_CD,SCHEME_NAME,
ISIN,SUB_RED_FLAG,SETTFLAG,AMOUNT,QTY,ALLOTMENT_MODE,DPCLT,FOLIONO,USER_ID,CONF_FLAG,REJECT_REASON,
BROKERAGE=0,
INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,
SERVICE_TAX=0,
FILLER1='',FILLER2='',FILLER3=''
FROM MFSS_TRADE T, MFSS_CLIENT C
WHERE T.PARTY_CODE = C.PARTY_CODE 
AND T.AMOUNT = 0
AND T.SETT_NO <> ''

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_POAPAYIN
-- --------------------------------------------------

CREATE VIEW [DBO].[MFSS_POAPAYIN] AS          
SELECT SETT_NO, SETT_TYPE=SETTLEMENT_TYPE, S.PARTY_CODE, SCRIPNAME=SCHEME_NAME,CERTNO=ISIN, ORDER_NO,           
QTY=CONVERT(NUMERIC(18,3),QTY), 
DPTYPE = DP_TYPE, DPID, CLTDPID, 
--DPTYPE = 'NSDL', DPID='IN300126', CLTDPID='12345678', 
LONG_NAME = S.PARTY_NAME,          
SCRIP_CD, SERIES = 'MF', TRTYPE = 904, NEWQTY = CONVERT(NUMERIC(18,0),CONVERT(NUMERIC(18,3),QTY)*1000)          
FROM MFSS_ORDER S, MFSS_DPMASTER D      
WHERE S.PARTY_CODE = D.PARTY_CODE          
AND S.DPCLT = (CASE WHEN DP_TYPE = 'CDSL' THEN D.CLTDPID ELSE DPID + CLTDPID END)
AND DP_TYPE IN ('CDSL', 'NSDL')
AND SUB_RED_FLAG = 'R'          
AND POAFLAG = 'YES'        
AND CONF_FLAG = 'VALID'

GO

