-- DDL Export
-- Server: 10.253.50.28
-- Database: ACCOUNTNCDX
-- Exported: 2026-02-03T02:30:08.031537

USE ACCOUNTNCDX;
GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_PIECE
-- --------------------------------------------------
 
 
CREATE FUNCTION [dbo].[CLS_PIECE] ( @CharacterExpression VARCHAR(8000), @Delimiter CHAR(1), @Position INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
       If @Position<1 return null
       if len(@Delimiter)<>1 return null
       declare @Start integer
       set @Start=1
       while @Position>1
              BEGIN
                     Set @Start=ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
                     IF @Start=0 return null
                     set @position= @position-1
                     set @Start=@Start+1
              END
       Declare @End INTEGER
       Set @End= ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
       If @End=0 Set @End=LEN(@CharacterExpression)+1
       RETURN SUBSTRING(@CharacterExpression, @Start, @End-@Start)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_REMOVE_SPACE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[CLS_REMOVE_SPACE]
(
	@CLIENTNAME VARCHAR(100)
)
RETURNS VARCHAR(100)
AS
BEGIN

DECLARE @FIRST_NAME VARCHAR(100)
SET @FIRST_NAME =  LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(@CLIENTNAME, CHAR(10), ''), CHAR(13), ''), CHAR(9), '')))

RETURN @FIRST_NAME

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_Split
-- --------------------------------------------------


create FUNCTION [dbo].[CLS_Split]
(
	@RowData nvarchar(2000),
	@SplitOn nvarchar(5)
)  
RETURNS @RtnValue table 
(
	Id int identity(1,1),
	ITEMS nvarchar(100)
) 
AS  
BEGIN 
	Declare @Cnt int
	Set @Cnt = 1

	While (Charindex(@SplitOn,@RowData)>0)
	Begin
		Insert Into @RtnValue (ITEMS)
		Select 
			Data = ltrim(rtrim(Substring(@RowData,1,Charindex(@SplitOn,@RowData)-1)))

		Set @RowData = Substring(@RowData,Charindex(@SplitOn,@RowData)+1,len(@RowData))
		Set @Cnt = @Cnt + 1
	End
	
	Insert Into @RtnValue (ITEMS)
	Select ITEMS = ltrim(rtrim(@RowData))

	Return
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.F_TABLE_NUMBER_RANGE
-- --------------------------------------------------
create function dbo.F_TABLE_NUMBER_RANGE
(
	@START_NUMBER		int,
	@END_NUMBER		int
)
/*
This function returns an integer table containing all integers
in the range of@START_NUMBER through @END_NUMBER, inclusive.
The maximum number of rows that this function can return
is 16777216.
*/

returns table 
as

return
(
select	top 100 percent
	NUMBER = (a.NUMBER+b.NUMBER)+
	-- Add the starting number for the final result set
	-- The case is needed, because the start and end 
	-- numbers can be passed in any order
	case
	when @START_NUMBER <= @END_NUMBER
	then @START_NUMBER
	else @END_NUMBER
	end
from
	(
	Select	top 100 percent
		NUMBER = convert(int,N01+N02+N03)
	From
		-- Cross rows from 3 tables based on powers of 16
		-- Maximum number of rows from cross join is 4096, 0 to 4095
		( select N01 = 0 union all select  1 union all select  2 union all
		  select       3 union all select  4 union all select  5 union all
		  select       6 union all select  7 union all select  8 union all
		  select       9 union all select 10 union all select 11 union all
		  select      12 union all select 13 union all select 14 union all
		  select      15 ) n01
		cross join
		( select N02 = 0 union all select  16 union all select  32 union all
		  select      48 union all select  64 union all select  80 union all
		  select      96 union all select 112 union all select 128 union all
		  select     144 union all select 160 union all select 176 union all
		  select     192 union all select 208 union all select 224 union all
		  select     240 ) n02
		cross join
		( select N03 = 0 union all select  256 union all select  512 union all
		  select     768 union all select 1024 union all select 1280 union all
		  select    1536 union all select 1792 union all select 2048 union all
		  select    2304 union all select 2560 union all select 2816 union all
		  select    3072 union all select 3328 union all select 3584 union all
		  select    3840 ) n03
	where
		-- Minimize the number of rows crossed by selecting only rows
		-- with a value less the the square root of rows needed.
		N01+N02+N03 <
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
	order by
		1
	) a
	cross join
	(
	Select	top 100 percent
		NUMBER = 
		convert(int,
		(N01+N02+N03) *
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
		)
	From 
		-- Cross rows from 3 tables based on powers of 16
		-- Maximum number of rows from cross join is 4096, 0 to 4095
		( select N01 = 0 union all select  1 union all select  2 union all
		  select       3 union all select  4 union all select  5 union all
		  select       6 union all select  7 union all select  8 union all
		  select       9 union all select 10 union all select 11 union all
		  select      12 union all select 13 union all select 14 union all
		  select      15 ) n01
		cross join
		( select N02 = 0 union all select  16 union all select  32 union all
		  select      48 union all select  64 union all select  80 union all
		  select      96 union all select 112 union all select 128 union all
		  select     144 union all select 160 union all select 176 union all
		  select     192 union all select 208 union all select 224 union all
		  select     240 ) n02
		cross join
		( select N03 = 0 union all select  256 union all select  512 union all
		  select     768 union all select 1024 union all select 1280 union all
		  select    1536 union all select 1792 union all select 2048 union all
		  select    2304 union all select 2560 union all select 2816 union all
		  select    3072 union all select 3328 union all select 3584 union all
		  select    3840 ) n03
	where
		-- Minimize the number of rows crossed by selecting only rows
		-- with a value less the the square root of rows needed.
		N01+N02+N03 <
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
	order by
		1
	) b
where
	a.NUMBER+b.NUMBER < 
	-- Total number of rows
	abs(@START_NUMBER-@END_NUMBER)+1	and
	-- Check that the number of rows to be returned
	-- is less than or equal to the maximum of 16777216
	case
	when abs(@START_NUMBER-@END_NUMBER)+1 <= 16777216
	then 1
	else 0
	end = 1
order by
	1
)

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GET_DPC_CLIENTS
-- --------------------------------------------------
CREATE FUNCTION [dbo].[GET_DPC_CLIENTS]  
(  
 @FR_PARTY_CODE VARCHAR(10),  
 @TO_PARTY_CODE VARCHAR(10),  
 @REPORTDATE VARCHAR(11)  
)  
RETURNS @DPC_CLIENTS TABLE  
(  
 PARTY_CODE VARCHAR(10),   
 LONG_NAME VARCHAR(100),  
 BRANCH_CD VARCHAR(20),   
 SUB_BROKER VARCHAR(25),   
 TRADER VARCHAR(25),  
 AREA VARCHAR(25),  
 REGION VARCHAR(25),  
 CL_TYPE VARCHAR(10),  
 CREDIT_INT MONEY,   
 DEBIT_INT MONEY,   
 FROMDATE DATETIME,   
 TODATE DATETIME,   
 EXEMPT_NOOFDAYS TINYINT,   
 EXEMPT_NOOFDAYS_CR TINYINT,   
 MIN_INTEREST MONEY,   
 MIN_BALANCE MONEY  
)  
AS  
BEGIN   
  
DECLARE @V2_CLIENTPROFILES_NEW table   
(   
 PARTY_CODE VARCHAR(10),  
 LONG_NAME VARCHAR(100),  
 ACCOUNT_LEVEL VARCHAR(15),  
 ACCOUNT_CODE VARCHAR(10),  
 CREDIT_INT MONEY,  
 DEBIT_INT MONEY,  
 FROMDATE SMALLDATETIME,  
 TODATE SMALLDATETIME,  
 EXEMPT_NOOFDAYS INT,  
 EXEMPT_NOOFDAYS_CR INT,  
 MIN_INTEREST MONEY,  
 MIN_BALANCE MONEY  
)  
  
  
 INSERT INTO @V2_CLIENTPROFILES_NEW  
 SELECT V2.PARTY_CODE, LONG_NAME, ACCOUNT_LEVEL, ACCOUNT_CODE, CREDIT_INT, DEBIT_INT, FROMDATE, TODATE, EXEMPT_NOOFDAYS, EXEMPT_NOOFDAYS_CR, MIN_INTEREST, MIN_BALANCE   
 FROM V2_CLIENTPROFILES_NEW C,  
 (  
  SELECT PARTY_CODE, LONG_NAME = LONG_NAME, AREA, REGION, BRANCH_CD, SUB_BROKER, TRADER, CL_TYPE, LEVEL_FLAG = MAX(LEVEL_FLAG) FROM (SELECT * FROM MSAJAG.DBO.CLIENT_DETAILS WHERE PARTY_CODE >= @FR_PARTY_CODE AND PARTY_CODE <= @TO_PARTY_CODE ) C    
  , V2_CLIENTPROFILES_NEW V2  
  WHERE ((AREA = CASE WHEN ACCOUNT_LEVEL = 'AREA' THEN ACCOUNT_CODE ELSE '' END  
  OR REGION = CASE WHEN ACCOUNT_LEVEL = 'REGION' THEN ACCOUNT_CODE ELSE '' END  
  OR BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END  
  OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END  
  OR TRADER = CASE WHEN ACCOUNT_LEVEL = 'TRADER' THEN ACCOUNT_CODE ELSE '' END  
  OR CL_TYPE = CASE WHEN ACCOUNT_LEVEL = 'CL_TYPE' THEN ACCOUNT_CODE ELSE '' END  
  OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) AND @REPORTDATE BETWEEN FROMDATE AND TODATE)  
  GROUP BY PARTY_CODE, LONG_NAME, AREA, REGION, BRANCH_CD, SUB_BROKER, TRADER, CL_TYPE  
 ) V2  
 WHERE   
  (AREA = CASE WHEN ACCOUNT_LEVEL = 'AREA' THEN ACCOUNT_CODE ELSE '' END  
  OR REGION = CASE WHEN ACCOUNT_LEVEL = 'REGION' THEN ACCOUNT_CODE ELSE '' END  
  OR BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END  
  OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END  
  OR TRADER = CASE WHEN ACCOUNT_LEVEL = 'TRADER' THEN ACCOUNT_CODE ELSE '' END  
  OR CL_TYPE = CASE WHEN ACCOUNT_LEVEL = 'CL_TYPE' THEN ACCOUNT_CODE ELSE '' END  
  OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END)   
  AND @REPORTDATE BETWEEN FROMDATE AND TODATE AND V2.LEVEL_FLAG = C.LEVEL_FLAG  
    
  
 INSERT INTO @DPC_CLIENTS  
 SELECT   
  C.PARTY_CODE, C.LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, AREA, REGION, CL_TYPE,  
  CREDIT_INT = ISNULL(V2.CREDIT_INT, V.CREDIT_INT),   
  DEBIT_INT = ISNULL(V2.DEBIT_INT, V.DEBIT_INT),   
  FROMDATE = ISNULL(V2.FROMDATE, V.FROMDATE),   
  TODATE = ISNULL(V2.TODATE, V.TODATE),   
  EXEMPT_NOOFDAYS = ISNULL(V2.EXEMPT_NOOFDAYS, V.EXEMPT_NOOFDAYS),   
  EXEMPT_NOOFDAYS_CR = ISNULL(V2.EXEMPT_NOOFDAYS_CR, V.EXEMPT_NOOFDAYS_CR),   
  MIN_INTEREST = ISNULL(V2.MIN_INTEREST, V.MIN_INTEREST),   
  MIN_BALANCE = ISNULL(V2.MIN_BALANCE, V.MIN_BALANCE)  
 FROM MSAJAG.DBO.CLIENT_DETAILS C  
 LEFT OUTER JOIN @V2_CLIENTPROFILES_NEW V2  
 ON C.PARTY_CODE = V2.PARTY_CODE  
 ,(SELECT * FROM V2_CLIENTPROFILES_NEW WHERE ACCOUNT_LEVEL = 'ALL') V  
 /*ON ((BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END  
 OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END  
 OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) AND @REPORTDATE BETWEEN FROMDATE AND TODATE)*/  
 WHERE C.PARTY_CODE >= @FR_PARTY_CODE AND C.PARTY_CODE <= @TO_PARTY_CODE  
  
  
 RETURN  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GET_SETT_CALENDER
-- --------------------------------------------------

/*  
SELECT * FROM .DBO.GET_SETT_CALENDER('APR  1 2011', 'APR 30 2011', 4)  
  
WHERE START_DATE >= DATEADD(DAY, -30, 'APR  1 2011') AND SETT_TYPE = 'N'    
AND START_DATE <= DATEADD(DAY, 10, 'APR 30 2011')    
*/  
CREATE FUNCTION [dbo].[GET_SETT_CALENDER] (@SDATE VARCHAR(11), @TDATE VARCHAR(11), @NODAYS INT)            
RETURNS @SETTDATE TABLE (            
[START_DATE]    [DATETIME] NOT NULL,            
[END_DATE]    [DATETIME] NOT NULL,          
[PAYIN_DATE]    [DATETIME] NOT NULL,    
[SNO] INT IDENTITY(1, 1)    
)            
AS            
            
BEGIN             
            
INSERT INTO @SETTDATE            
SELECT DISTINCT START_DATE = VDT, END_DATE = VDT, PAYIN_DATE = VDT
FROM BILLPOSTED
WHERE VDT >= DATEADD(DAY, -30, @SDATE)
AND VDT <= DATEADD(DAY, 10, @TDATE)    
ORDER BY VDT
       
        
UPDATE S SET END_DATE = S1.END_DATE FROM @SETTDATE S, (SELECT SNO, END_DATE = START_DATE FROM @SETTDATE) S1    
WHERE S.SNO + @NODAYS = S1.SNO    
    
            
RETURN            
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Piece
-- --------------------------------------------------
CREATE FUNCTION [dbo].[Piece] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.PrepareNCDXData
-- --------------------------------------------------

Create FUNCTION PrepareNCDXData 
(	
	@SDTCUR DATETIME,
	@SDTNXT DATETIME
)
RETURNS @NCDXDataForCMS table 
(
	cltcode varchar(50),
	Ledger money default 0,
	processdatetime datetime
)
as
begin
	Declare @vdt varchar(11)    
	set @vdt=convert(varchar(11),getdate())   
	
	insert into @NCDXDataForCMS
	select cltcode, sum(Case when drcr='C' then -vamt else vamt end),getdate()
	from ledger a with (nolock)    
	where vdt >= @SDTCUR
	and vdt <= @vdt+' 23:59:59'    
	and exists (select cltcode from [196.1.115.182].general.dbo.client_Details b (nolock)    
	where a.cltcode=b.party_Code)and not (vtyp = 18 and vdt >= @SDTNXT)
	group by cltcode

	return
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.REMOVE_ZERO
-- --------------------------------------------------
create FUNCTION [dbo].[REMOVE_ZERO]        
(          
 @STRING NVARCHAR(4000),           
 @DELIMITER CHAR(1)        
)          
          
RETURNS VARCHAR(100)          
          
AS          
          
/*          
 RETURNS SPECIFIC ITEM          
 SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)          
*/          
          
BEGIN          
 DECLARE @INDEX INT          
 DECLARE @COUNTER TINYINT      
      
 SELECT @INDEX = 1      
 SELECT @COUNTER = LEN(@STRING)       
         
 IF @STRING IS NULL RETURN '0'          
      
 WHILE @COUNTER > 0      
 BEGIN      
  -- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER          
  SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)          
  -- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE          
  IF @INDEX = 1      
  BEGIN      
   SELECT @STRING = RIGHT(@STRING, LEN(@STRING) - 1)      
  END      
  ELSE      
  BEGIN      
   RETURN @STRING          
   BREAK               
  END      
  SELECT @COUNTER = @COUNTER - 1      
 END      
 RETURN '0'       
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.REMOVE_ZERO1
-- --------------------------------------------------

--SELECT .DBO.REMOVE_ZERO('00009', '0')  
CREATE FUNCTION [dbo].[REMOVE_ZERO1]            
(              
 @STRING NVARCHAR(4000),               
 @DELIMITER CHAR(1)            
)              
              
RETURNS VARCHAR(100)              
              
AS              
              
/*              
 RETURNS SPECIFIC ITEM              
 SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)              
*/              
              
BEGIN              
 DECLARE @INDEX INT              
 DECLARE @COUNTER TINYINT          
          
 SELECT @INDEX = 1          
 SELECT @COUNTER = LEN(@STRING)           
             
 IF @STRING IS NULL RETURN '0'              
          
 WHILE @COUNTER > 0          
 BEGIN          
  -- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER              
  SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)              
  -- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE              
  IF @INDEX = 1          
  BEGIN          
   SELECT @STRING = RIGHT(@STRING, LEN(@STRING) - 1)          
  END          
  ELSE          
  BEGIN          
   RETURN @STRING              
   BREAK                   
  END          
  SELECT @COUNTER = @COUNTER - 1          
 END          
 RETURN '0'           
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.RemoveSplChar
-- --------------------------------------------------
CREATE function RemoveSplChar (
	@var1 nvarchar(200)
)RETURNS nvarchar(200)
AS
BEGIN

DECLARE @cnt int
DECLARE @cnt1 int
DECLARE @str1 nvarchar(200)

SET @cnt = LEN(@var1)
SET @cnt1 = 1
SET @str1 = ''

	WHILE @cnt1 <= @cnt
	BEGIN
		if ascii((substring(@var1, @cnt1, 1))) >= 48 AND ascii((substring(@var1, @cnt1, 1))) <= 57
		BEGIN
			SET @str1 = @str1 + substring(@var1, @cnt1, 1)
		END

		SET @cnt1 = @cnt1 + 1
	END

RETURN @Str1

END

GO

-- --------------------------------------------------
-- INDEX dbo.FUND_TRF_CLIENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDX_FUND_CL] ON [dbo].[FUND_TRF_CLIENT] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger1_19012018
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [led2] ON [dbo].[ledger1_19012018] ([vtyp], [vno], [lno], [ddno], [reldt], [refno], [BookType])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Offline_Ledger_Entries
-- --------------------------------------------------
CREATE CLUSTERED INDEX [V2_Offline_Ledger_Entries1] ON [dbo].[V2_Offline_Ledger_Entries] ([ApprovalFlag], [RowState], [VoucherNo])

GO

-- --------------------------------------------------
-- INDEX dbo.vmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxvmst] ON [dbo].[vmast] ([Vtype])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_DELETION_LOGS
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_DELETION_LOGS] ADD CONSTRAINT [PK__RECON_BA__54ECADF53951907F] PRIMARY KEY ([SRNO], [UPLOADID], [MATCHEDFLAG])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_FILEUPLOAD_LOGS] ADD CONSTRAINT [PK_UPLOADMASTER] PRIMARY KEY ([UPLOADID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_UPLOAD_PROCESS_INFO
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_UPLOAD_PROCESS_INFO] ADD CONSTRAINT [PK_UPLOADMASTERPROCESS] PRIMARY KEY ([UPLOADID], [SEGMENT], [BANKNAME], [FILETYPE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Recon_CMS_Data
-- --------------------------------------------------
ALTER TABLE [dbo].[Recon_CMS_Data] ADD CONSTRAINT [PK__Recon_CM__C3A4D3AC606B5DA0] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__34AA74EE] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.abc
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.abc    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.abc    Script Date: 02/04/2002 9:59:35 PM ******/
/****** Object:  Stored Procedure dbo.abc    Script Date: 01/18/2002 1:38:00 PM ******/
/****** Object:  Stored Procedure dbo.abc    Script Date: 12/26/2001 1:26:50 PM ******/
/****** Object:  Stored Procedure dbo.abc    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE abc AS
SELECT DISTINCT "<option value=" +SUBSTRING(convert(varchar,sauda_date,109),1,11)+">" + SUBSTRING(convert(varchar,sauda_date,109),1,11)+"</option>"  FROM settlement 
union all
SELECT DISTINCT "<option value=" +SUBSTRING(convert(varchar,sauda_date,109),1,11)+">" + SUBSTRING(convert(varchar,sauda_date,109),1,11)+"</option>"  FROM history
order by "<option value=" +SUBSTRING(convert(varchar,sauda_date,109),1,11)+">" + SUBSTRING(convert(varchar,sauda_date,109),1,11)+"</option>"

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_acwisereport
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.acc_acwisereport    Script Date: 03/10/2003 11:35:35 AM ******/
CREATE proc acc_acwisereport
@reptype varchar(7),
@grplen tinyint,
@grpcode varchar(10),
@fdate varchar(11),
@tdate varchar(11),
@faccode varchar(10),
@taccode varchar(10),
@costcode smallint

as

declare 
@@grpchars as int

select @@grpchars = (select len(rtrim(@grpcode)) )
if len(rtrim(@faccode)) = 0
begin
   select @faccode = ( select min(cltcode) from acmast )
end

if len(rtrim(@taccode)) = 0
begin
   select @taccode = ( select max(cltcode) from acmast )
end

if rtrim(@reptype) = 'ACCOUNT'
begin
   if @grplen = 0 
      begin
	select l2.cltcode, a.acname, bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59' and accat = 3
        and l2.cltcode >= @faccode and l2.cltcode <= @taccode
	group by l2.cltcode, a.acname
	order by l2.cltcode, a.acname
      end
   else
   if @grplen = 2
   begin
	select category, grpcode=left(grpcode,@grplen), bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c, category cc
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and c.catcode = cc.catcode and l2.cltcode = rtrim(@faccode)
	group by category, left(grpcode,@grplen)
	order by category, left(grpcode,@grplen)
   end
   else
   if @grplen = 10
      begin
	select l2.costcode, costname, bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and c.grpcode like rtrim(@grpcode)+'%'
        and l2.cltcode >= @faccode and l2.cltcode <= @taccode
	group by l2.costcode, costname
	order by l2.costcode, costname
      end
   else   
      begin
	select category, grpcode=left(grpcode,@grplen), bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c, category cc
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and c.catcode = cc.catcode and left(grpcode,2) = rtrim(@grpcode)
	and l2.cltcode = rtrim(@faccode)
	group by category, left(grpcode,@grplen)
	order by category, left(grpcode,@grplen)
     end
end
else
begin
	select vdate = convert(varchar,l.vdt,103) , shortdesc, l2.vtype, l2.booktype, l2.vno, l2.lno, 
	l2.cltcode, a.acname, l2.drcr, l2.camt, l.narration,
	chqno=isnull((select ddno from ledger1 l1 where l1.vtyp = l2.vtype and l1.booktype = l2.booktype and l1.vno = l2.vno and l1.lno = l2.lno),'')
	from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l, vmast v
	where l2.cltcode = rtrim(@faccode) and  l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate + ' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = @costcode and l2.vtype = v.vtype
	order by l2.cltcode, a.acname
end

/*

else
   begin
	select category, grpcode=left(grpcode,@grplen), bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c, category cc
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and c.catcode = cc.catcode and left(grpcode,2) = rtrim(@grpcode)
	group by category, left(grpcode,@grplen)
	order by category, left(grpcode,@grplen)
   end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_addacmast1
-- --------------------------------------------------




/****** Object:  Stored Procedure dbo.acc_addacmast1    Script Date: 04/11/2002 7:26:29 PM ******/


create procedure acc_addacmast1 as 
select grpname,grpcode ,grpmain ,
maingrpname =(case 
		when  left(grpmain,2)='A0' then (select grpname from grpmast where grpcode ='A0000000000') 
	        else
	        	(case when  left(grpmain,2)='L0' then (select grpname from grpmast where grpcode ='L0000000000')  
			else 
				(case when  left(grpmain,2)='N0' then (select grpname from grpmast where grpcode ='N0000000000')
				else 
					(case when  left(grpmain,2)='X0' then (select grpname from grpmast where grpcode ='X0000000000')
						end)
					 end) 		
				end ) 
	 		  end)
from grpmast order by grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_bankslipreprint
-- --------------------------------------------------

/*cahnged By Amit To Display The Acname And Accode */ 
Create Proc Acc_bankslipreprint
@Cltcode  Varchar(10), 
@Booktype Varchar(2), 
@Startslip Int, 
@Endslip Int
As
/*
Select  Slipno, Ddno, Slipdate, Acname, Bnkname, Brnname, Relamt, Cltcode, L1.Vno, L1.Lno
From Ledger L , Ledger1 L1 
Where L.Vtyp = L1.Vtyp And L.Vno = L1.Vno And L.Booktype = L1.Booktype  And L.Vtyp In ( '2', '19')
And L.Booktype = @Booktype And Slipno > = @Startslip And Slipno < = @Endslip And L.Cltcode = @Cltcode
Order By Slipno, Slipdate, L1.Vno, L1.Lno
*/
Select  Slipno, Ddno, Slipdate, Acname, Bnkname, Brnname, Relamt, Cltcode, L1.Vno, L1.Lno
From Ledger L , Ledger1 L1 
Where L.Vtyp = L1.Vtyp And L.Vno = L1.Vno And L.Booktype = L1.Booktype  And L.Vtyp In ( '2', '19')
And L.Booktype = @Booktype And Slipno > = @Startslip And Slipno < = @Endslip And L.Cltcode <> @Cltcode
And L.Vno In  (Select Vno From Ledger L2 Where  Cltcode = @Cltcode And L.Vtyp = L2.Vtyp And L.Booktype = L2.Booktype )
Order By Slipno, Slipdate, L1.Vno, L1.Lno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_catcostwise
-- --------------------------------------------------


create proc acc_catcostwise
@fdate varchar(11),
@tdate varchar(11)

as
select category, l2.costcode, costname, sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
from ledger2 l2, ledger l, costmast c, category cc
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
and l2.costcode = c.costcode and c.catcode = cc.catcode
group by category, l2.costcode, costname
order by category, l2.costcode, costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_costaccodewisedtl
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.acc_costaccodewisedtl    Script Date: 03/06/2003 1:15:07 PM ******/
CREATE proc acc_costaccodewisedtl
@costcode smallint,
@accode   varchar(10),
@fdate varchar(11),
@tdate varchar(11)

as

select vdate = convert(varchar,l.vdt,103) , shortdesc, l2.vtype, l2.booktype, l2.vno, l2.lno, 
l2.cltcode, a.acname, l2.drcr, l2.camt, l.narration,
chqno=isnull((select ddno from ledger1 l1 where l1.vtyp = l2.vtype and l1.booktype = l2.booktype and l1.vno = l2.vno and l1.lno = l2.lno),'')
from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l, vmast v
where l2.cltcode = rtrim(@accode) and  l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
and l.vdt >= @fdate + ' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
and l2.costcode = @costcode and l2.vtype = v.vtype
order by l2.cltcode, a.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_costaccodewisesum
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.acc_costaccodewisesum    Script Date: 03/06/2003 2:38:18 PM ******/
CREATE proc acc_costaccodewisesum
@costcode smallint,
@fdate varchar(11),
@tdate varchar(11)

as

select l2.costcode, costname, l2.cltcode, a.acname, bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
from ledger2 l2, ledger l, costmast c, acmast a
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
and l2.costcode = c.costcode and l2.costcode = @costcode and l2.cltcode = a.cltcode
group by l2.costcode, costname, l2.cltcode, a.acname
order by l2.costcode, costname, l2.cltcode, a.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_costwisereport
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.acc_costwisereport    Script Date: 03/06/2003 1:15:07 PM ******/
CREATE proc acc_costwisereport
@grplen tinyint,
@grpcode varchar(10),
@fdate varchar(11),
@tdate varchar(11)

as

declare 
@@grpchars as int

select @@grpchars = (select len(rtrim(@grpcode)) )

if @grplen = 2
   begin
	select category, grpcode=left(grpcode,@grplen), bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c, category cc
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and c.catcode = cc.catcode
	group by category, left(grpcode,@grplen)
	order by category, left(grpcode,@grplen)
   end
else
if @grplen = 10
   begin
	select l2.costcode, costname, bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and left(grpcode,@@grpchars) = rtrim(@grpcode)
	group by l2.costcode, costname
	order by l2.costcode, costname
   end
else
   begin
	select category, grpcode=left(grpcode,@grplen), bal=sum(case when upper(l2.drcr) = 'D' then camt else -camt end)
	from ledger2 l2, ledger l, costmast c, category cc
	where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno
	and l.vdt >= @fdate +' 00:00:00' and l.vdt <= @tdate + ' 23:59:59'
	and l2.costcode = c.costcode and c.catcode = cc.catcode and left(grpcode,2) = rtrim(@grpcode)
	group by category, left(grpcode,@grplen)
	order by category, left(grpcode,@grplen)
   end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_DelVoucher
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[acc_DelVoucher]    
@vno varchar(12),    
@vtyp  smallint,    
@booktype varchar(2),    
@emode char(1),    
@status char(6),    
@editname varchar(15),    
@vdt varchar(11)    
AS    
    
declare    
@@vdt1 as datetime    

    
select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))    
    
insert into ledger_log     
select *, @emode,@@vdt1,@editname,@status from ledger where vtyp = @vtyp and vno = @vno and booktype = @booktype    
    
insert into ledger1_log    
select bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode, @emode from ledger1  where vtyp = @vtyp and vno = @vno and booktype = @booktype    
    
insert into ledger2_log     
select *, @emode from ledger2  where vtype = @vtyp and vno = @vno and booktype = @booktype    
    
insert into ledger3_log    
select *, @emode from ledger3  where vtyp = @vtyp and vno = @vno and booktype = @booktype    
    
insert into matchdetails_log    
select *, @emode from matchdetails where lvtype = @Vtyp and lbooktype = @booktype and lvno = @Vno     
    
insert into marginledger_log    
select *, @emode from marginledger where vtyp = @vtyp and vno = @vno and booktype = @booktype    
    
delete from ledger    where vtyp = @vtyp and vno = @vno and booktype = @booktype    
delete from ledger1  where vtyp = @vtyp and vno = @vno and booktype = @booktype    
delete from ledger2  where vtype = @vtyp and vno = @vno and booktype = @booktype    
delete from ledger3  where vtyp = @vtyp and vno = @vno and booktype = @booktype    
delete from marginledger where vtyp = @vtyp and vno = @vno and booktype = @booktype    
delete from matchdetails where lvtype = @Vtyp and lbooktype = @booktype and lvno = @Vno     
delete from payadv where vtyp = @Vtyp and booktype = @booktype and vno = @Vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DIAGNOSTICS
-- --------------------------------------------------



CREATE PROCEDURE ACC_DIAGNOSTICS
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@SELECTION VARCHAR(100),
	@UNAME VARCHAR(25),
	@CSV VARCHAR(1) = 'N'
AS

/*
	SP CREATED BY	:	YATIN
	SP CREATED ON	:	AUG 1, 2006
	SP CREATED TO GET VARIOUS MISMATCHES IN ACCOUNT DATABASE.
	MAINLY RELATED TO LEDGER, LEDGER1, LEDGER2, COSTMAST, BRANCHACCOUNTS, ACMAST
	TRUNCATE TABLE DIAG_RESULT
	TRUNCATE TABLE DIAG_LOG
	EXEC ACC_DIAGNOSTICS 'APR  1 2006', 'MAR 31 2007', 'Y,N,N,N,N,N,N,N,N,N', 'SYSTEM', 'Y'
	SELECT * FROM DIAG_LOG
	TABLES REQUIRED DIAG_RESULT AND DIAG_LOG
	DROP TABLE SYSTEM_20060907141734870
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'Y,N,N,N,N,N,N,N,N', 'nirupamah', 'Y'
BEGIN TRAN
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'N,N,N,N,N,N,N,Y,N', 'nirupamah', 'N'
Exec ACC_DIAGNOSTICS 'Apr  1 2006', 'Mar 31 2007', 'N,N,N,N,N,Y,N,N,N', 'jaydeep', 'N'
ROLLBACK


*/

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @@ERROR_COUNT AS INT, @@SQL AS VARCHAR(2000), @@SHAREDB AS VARCHAR(25), @TNAME AS VARCHAR(50)
/*------------------------FIND DUPLICATE VOUCHERS----------------------------------*/
IF SUBSTRING(@SELECTION, 1, 1) = 'Y'
	BEGIN
		SELECT 
			RESULT = 'VNO :' + VNO + ', VTYP :' + CONVERT(VARCHAR, VTYP) + ', BOOKTYPE :' + BOOKTYPE + ', NOS = ' + CONVERT(VARCHAR, COUNT(1))
		INTO
			#LEDGER
		FROM 
			LEDGER 
		WHERE 
			LNO = 2 
		GROUP BY 
			VNO, 
			VTYP, 
			BOOKTYPE 
		HAVING 
			COUNT(1) > 1
		
		SELECT @@ERROR_COUNT = 0
		SELECT @@ERROR_COUNT = COUNT(1) FROM #LEDGER
		IF @@ERROR_COUNT > 0
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'DUPLICATE VOUCHER NOS. FOUND~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT, PROCID = @@SPID FROM #LEDGER
			END
		ELSE
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID) VALUES ('NO VOUCHER FOUND AS DUPLICATED~', @@SPID)
			END
		DROP TABLE #LEDGER
	END
/*------------------------FIND DIFFERENT VOUCHERS WITH SAMEDATA----------------------------------*/

IF SUBSTRING(@SELECTION, 3, 1) = 'Y'
	BEGIN
		SELECT
			RESULT = 'CLTCODE :' + (L.CLTCODE + ', VDT :' + CONVERT(VARCHAR(10), L.VDT, 103) + ', VNO :' + L.VNO + ', VTYP :' + CONVERT(VARCHAR, L.VTYP) + ', BOOKTYPE :' + L.BOOKTYPE + ', DRCR :' + L.DRCR + ', ' + 'Rs.' + CONVERT(VARCHAR, L.VAMT) + ', NARRATION :' + REPLACE(L.NARRATION, '~', '`'))
		INTO #LEDGER1
		FROM LEDGER L (NOLOCK),
			(
				SELECT  LED.VTYP, LED.BOOKTYPE, LED.CLTCODE, VDT = CONVERT(VARCHAR(11), VDT), DDNO, NARRATION, LED.DRCR, LED.VAMT
				FROM LEDGER LED (NOLOCK),
				LEDGER1 LED1 (NOLOCK),
				ACMAST A (NOLOCK)
				WHERE LED.VNO = LED1.VNO AND LED.VTYP = LED1.VTYP AND LED.BOOKTYPE = LED1.BOOKTYPE AND LED.LNO = LED1.LNO
				AND LED.CLTCODE = A.CLTCODE
				AND ACCAT = 4
				AND DDNO <> '0' AND DDNO <> ''
				GROUP BY VAMT, LED.VTYP, LED.BOOKTYPE, LED.CLTCODE, CONVERT(VARCHAR(11), VDT), DDNO, NARRATION, LED.DRCR
				HAVING COUNT(1) > 1
			) DUP
		WHERE
		L.VAMT = DUP.VAMT
		AND L.VTYP = DUP.VTYP
		AND L.BOOKTYPE = DUP.BOOKTYPE
		AND L.DRCR = DUP.DRCR
		AND LEFT(CONVERT(VARCHAR, L.VDT,109),11) =  DUP.VDT
		AND L.CLTCODE = DUP.CLTCODE
		ORDER BY L.CLTCODE, L.VDT, L.DRCR, L.VAMT, L.VNO, L.BOOKTYPE, L.NARRATION
		
		SELECT @@ERROR_COUNT = 0
		SELECT @@ERROR_COUNT = COUNT(1) FROM #LEDGER1
		IF @@ERROR_COUNT > 0
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'VOUCHERS FOUND WITH DIFFERENT VNOs. BUT SAME KIND OF DATA.(USER NEEDS TO VERIFY THIS DATA)~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT = 'COLUMNS SERIES = CLTCODE, VDT, VNO, VTYP, BOOKTYPE, DRCR, AMOUNT, NARRATION~', PROCID = @@SPID
				INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT RESULT, PROCID = @@SPID FROM #LEDGER1
			END
		ELSE
			BEGIN
				INSERT INTO DIAG_RESULT (RESULT, PROCID) VALUES ('NO VOUCHER FOUND AS DIFFERENT VNOs BUT SAME KIND OF DATA~', @@SPID)
			END
		DROP TABLE #LEDGER1
	END

/*------------------------------------------------TRIAL BALANCE MISMATCH QUERIES------------------------------------------*/
/*------------------------FIND DRCR MISMATCH----------------------------------*/
	IF SUBSTRING(@SELECTION, 5, 1) = 'Y'
		BEGIN
			DECLARE
				@@DIFF AS MONEY,
				@@COUNTER AS INT
			CREATE TABLE #LEDGERMISMATCH
				(
					PARTICULARS VARCHAR(30),
					DIFF MONEY,
					REMARK VARCHAR(100)
				)
			
			INSERT INTO #LEDGERMISMATCH
			SELECT 
				PARTICULARS = 'LEDGER TOTALS', 
				DIFF = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),
				REMARK = ''
			FROM
				LEDGER
			WHERE 
				VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
			
			SELECT @@DIFF = DIFF FROM #LEDGERMISMATCH
			
			IF ISNULL(@@DIFF, 0) <> 0
				BEGIN
					CREATE TABLE #MISSVNO
						(
							VNO VARCHAR(12),
							VTYP SMALLINT,
							BOOKTYPE VARCHAR(2)
						)
					INSERT INTO #MISSVNO
					SELECT 
						VNO, 
						VTYP, 
						BOOKTYPE
					FROM
						LEDGER
					WHERE 
						VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
					GROUP BY
						VNO, 
						VTYP, 
						BOOKTYPE
					HAVING
						SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) <> 0
			
					SELECT 
						@@COUNTER = COUNT(1) 
					FROM 
						#MISSVNO
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT 
								RESULT = 'VOUCHERS WITH DEBIT AND CREDIT MISMATCHES~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT 
								RESULT = 'VNO :' + VNO + ', VTYP :' + CONVERT(VARCHAR, VTYP) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
							FROM 
								#MISSVNO
						END
					DROP TABLE #MISSVNO
				END
			
				DROP TABLE #LEDGERMISMATCH
			
			/*------------------------FIND MULTIPLE VDTs----------------------------------*/
				CREATE TABLE #MISSDATES
					(
						VNO VARCHAR(12),
						VTYP SMALLINT,
						BOOKTYPE VARCHAR(2)
					)
				INSERT INTO #MISSDATES
					(	
						VNO,
						VTYP,
						BOOKTYPE
					)
				SELECT
					VNO,
					VTYP,
					BOOKTYPE
				FROM
					(
						SELECT
							VNO,
							VTYP,
							BOOKTYPE
						FROM
							LEDGER
						WHERE
							VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
						GROUP BY
							VNO,
							VTYP,
							BOOKTYPE,
							CONVERT(VARCHAR(11), VDT, 109)
					) A
				GROUP BY
					VNO,
					VTYP,
					BOOKTYPE
				HAVING
					COUNT(1) > 1
			
			
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSDATES
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'VOUCHER(S) FOUND WITH DIFFERENT VOUCHER DATES~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT 
							RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSDATES
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'NO VOUCHER(S) FOUND WITH MULTIPLE VOUCHER DATES~', PROCID = @@SPID
					END
			
			
				TRUNCATE TABLE #MISSDATES
			/*------------------------FIND MULTIPLE EDTs----------------------------------*/
			
				INSERT INTO #MISSDATES
					(	
						VNO,
						VTYP,
						BOOKTYPE
					)
				SELECT
					VNO,
					VTYP,
					BOOKTYPE
				FROM
					(
						SELECT
							VNO,
							VTYP,
							BOOKTYPE
						FROM
							LEDGER
						WHERE
							EDT BETWEEN @FDATE AND @TDATE + ' 23:59'
						GROUP BY
							VNO,
							VTYP,
							BOOKTYPE,
							CONVERT(VARCHAR(11), EDT, 109)
					) A
				GROUP BY
					VNO,
					VTYP,
					BOOKTYPE
				HAVING
					COUNT(1) > 1
			
			
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSDATES
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'VOUCHER(S) FOUND WITH DIFFERENT EFFECTIVE DATES~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT 
							RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSDATES
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'NO VOUCHER(S) FOUND WITH MULTIPLE EFFECTIVE DATES~', PROCID = @@SPID
					END
				DROP TABLE #MISSDATES
			
			/*------------------------FIND MISSING CLIENT CODES FROM ACMAST----------------------------------*/
			
				SELECT @@COUNTER = 0
				CREATE TABLE #MISSCLTS
					(
						CLTCODE VARCHAR(10),
						VNO VARCHAR(12),
						VTYP SMALLINT,
						BOOKTYPE VARCHAR(2)
					)
				INSERT INTO #MISSCLTS (CLTCODE, VNO, VTYP, BOOKTYPE)
				SELECT L.CLTCODE, L.VNO, L.VTYP, L.BOOKTYPE FROM LEDGER L WHERE NOT EXISTS (SELECT CLTCODE FROM ACMAST A WHERE L.CLTCODE = A.CLTCODE)
				
				SELECT
					@@COUNTER = COUNT(1)
				FROM
					#MISSCLTS
			
				IF @@COUNTER > 0
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'FOLLOWING CLTCODEs DO NOT EXIST IN ACMAST.~', PROCID = @@SPID
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT DISTINCT
							RESULT = 'CLTCODE :' + CLTCODE + ', VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
						FROM
							#MISSCLTS
					END
				ELSE
					BEGIN
						INSERT INTO DIAG_RESULT (RESULT, PROCID)
						SELECT
							RESULT = 'CLTCODE MISMATCH NOT FOUND.~', PROCID = @@SPID
					END
				DROP TABLE #MISSCLTS
		END
/*------------------------FIND MISSING ENTRIES FROM LEDGER2----------------------------------*/

	IF SUBSTRING(@SELECTION, 7, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSL2
				(
					VNO VARCHAR(12),
					VTYP SMALLINT,
					BOOKTYPE VARCHAR(2)
				)
		
			INSERT INTO #MISSL2
				(
					VNO,
					VTYP,
					BOOKTYPE
				)
			SELECT
				VNO,
				VTYP,
				BOOKTYPE
			FROM
				LEDGER L
			WHERE
				VDT BETWEEN @FDATE AND @TDATE + ' 23:59'
				AND
				NOT EXISTS
				(
					SELECT
						VNO,
						VTYPE,
						BOOKTYPE
					FROM
						LEDGER2 L2
					WHERE
						L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE
						AND L.BOOKTYPE = L2.BOOKTYPE
				)
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSL2
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING VOUCHERS DO NOT EXIST IN LEDGER2 BUT POSTED IN LEDGER.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT DISTINCT
						RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE, PROCID = @@SPID
					FROM
						#MISSL2
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO VOUCHERS FOUND AS MISSING IN LEDGER2.~', PROCID = @@SPID
				END
			DROP TABLE #MISSL2
		END

/*------------------------FIND BILLS YET TO BE POSTED----------------------------------*/

	IF SUBSTRING(@SELECTION, 9, 1) = 'Y'
		BEGIN
			SELECT TOP 1
				@@SHAREDB = SHAREDB
			FROM
				OWNER
		
			CREATE TABLE #ACCBILL
				(
					SETT_NO VARCHAR(7),
					SETT_TYPE VARCHAR(2)
				)
		
			CREATE TABLE #BILLMATCH
				(
					SETT_NO VARCHAR(7),
					SETT_TYPE VARCHAR(2)
				)
		
			SELECT @@SQL = "INSERT INTO #ACCBILL (SETT_NO, SETT_TYPE) "
			SELECT @@SQL = @@SQL + "SELECT DISTINCT "
			SELECT @@SQL = @@SQL + "	SETT_NO, "
			SELECT @@SQL = @@SQL + "	SETT_TYPE "
			SELECT @@SQL = @@SQL + "FROM "
			SELECT @@SQL = @@SQL + "	" + @@SHAREDB + ".DBO.ACCBILL "
		
			EXEC(@@SQL)
		
			INSERT INTO #BILLMATCH (SETT_NO, SETT_TYPE)
			SELECT DISTINCT
				SETT_NO,
				SETT_TYPE
			FROM
				BILLMATCH
		
			SELECT
				A.SETT_NO,
				A.SETT_TYPE
			INTO
				#MISSBILLS
			FROM
				#ACCBILL A
			WHERE
				NOT EXISTS
				(
					SELECT
						SETT_NO,
						SETT_TYPE
					FROM
						#BILLMATCH B
					WHERE
						A.SETT_NO = B.SETT_NO
						AND A.SETT_TYPE = B.SETT_TYPE
				)
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSBILLS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BILLS FOR THE FOLLOWING SETTLEMENTS ARE NOT YET POSTED IN LEDGER.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'SETT.NO.:-' + SETT_NO + ', SETT. TYPE.:' + SETT_TYPE, PROCID = @@SPID
					FROM
						#MISSBILLS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO BILLS FOUND AS UNPOSTED.~', PROCID = @@SPID
				END
			DROP TABLE #MISSBILLS
		END
	
/*------------------------FIND BRANCH AND COSTMASTER MISMATCHES----------------------------------*/

	IF SUBSTRING(@SELECTION, 11, 1) = 'Y'
		BEGIN
			SELECT TOP 1
				@@SHAREDB=SHAREDB
			FROM
				OWNER
			CREATE TABLE #BRANCHES
			(
				BRANCH_CODE VARCHAR(20)
			)
			SELECT @@SQL = ''
			SELECT @@SQL = "INSERT INTO #BRANCHES (BRANCH_CODE) "
			SELECT @@SQL = @@SQL + "SELECT DISTINCT "
			SELECT @@SQL = @@SQL + "	BRANCH_CODE "
			SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.BRANCH B "
			SELECT @@SQL = @@SQL + "WHERE "
			SELECT @@SQL = @@SQL + "	NOT EXISTS "
			SELECT @@SQL = @@SQL + "	( "
			SELECT @@SQL = @@SQL + "		SELECT DISTINCT COSTNAME FROM COSTMAST C "
			SELECT @@SQL = @@SQL + "		WHERE B.BRANCH_CODE = C.COSTNAME "
			SELECT @@SQL = @@SQL + "	) "
			PRINT @@SQL
			EXEC(@@SQL)
		
			SELECT @@COUNTER = 0
		
			SELECT @@COUNTER = COUNT(1) FROM #BRANCHES
		
			IF @@COUNTER > 0
				BEGIN
					DECLARE @@MAXCOST AS INT
					SELECT @@MAXCOST = ISNULL(MAX(COSTCODE), 0) FROM COSTMAST
					IF ISNULL(@@MAXCOST, 0 ) = 0
						BEGIN
							SELECT @@MAXCOST = 1
						END
					ELSE
						BEGIN
							SELECT @@MAXCOST = @@MAXCOST + 1
						END
					CREATE TABLE #COSTMAST
					(
						COSTNAME VARCHAR(20),
						CATCODE SMALLINT,
						GRPCODE VARCHAR(20)
					)
					SELECT @@SQL = "ALTER TABLE #COSTMAST "
					SELECT @@SQL = @@SQL + "ADD COSTCODE INT IDENTITY (" + CONVERT(VARCHAR, @@MAXCOST) + ", 1) "
					EXEC (@@SQL)
					INSERT INTO #COSTMAST (COSTNAME, CATCODE, GRPCODE)
					SELECT
						BRANCH_CODE,
						CATCODE = 1,
						GRPCODE = 'A0000000000'
					FROM
						#BRANCHES
					INSERT INTO COSTMAST (COSTNAME, COSTCODE, CATCODE, GRPCODE)
					SELECT COSTNAME, COSTCODE, CATCODE, GRPCODE FROM #COSTMAST
		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING COST MAST ENTRIES HAVE BEEN UPDATED...~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BRANCHNAME : ' + COSTNAME + ', COSTCODE : ' + LTRIM(RTRIM(CONVERT(VARCHAR, COSTCODE))), PROCID = @@SPID
					FROM
						#COSTMAST
					DROP TABLE #COSTMAST
				END
		
			TRUNCATE TABLE #BRANCHES


			INSERT INTO #BRANCHES (BRANCH_CODE)
			SELECT DISTINCT
				COSTNAME
			FROM
				COSTMAST C
			WHERE
				NOT EXISTS
				(
					SELECT DISTINCT
						BRANCHNAME
					FROM
						BRANCHACCOUNTS B
					WHERE
						C.COSTNAME = B.BRANCHNAME
				)
		
			SELECT @@COUNTER = 0
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#BRANCHES
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO
						BRANCHACCOUNTS (BRANCHNAME, BRCONTROLAC, MAINCONTROLAC, DEFAULTAC)
					SELECT
						BRANCH_CODE,
						BRCONTROLAC = LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10),
						MAINCONTROLAC = 'HOCTRL',
						DEFAULTAC = 0
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) <= 10
						AND LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') <= 10

		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING BRANCHACCOUNTS ENTRIES HAVE BEEN UPDATED...~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'BRANCHNAME : ' + BRANCH_CODE + ', BRCONTROLAC : ' + LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10), PROCID = @@SPID
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) <= 10
					SELECT @@COUNTER = 0
					SELECT
						@@COUNTER = COUNT(1)
					FROM
						#BRANCHES
					WHERE
						LEN(LTRIM(RTRIM(BRANCH_CODE))) > 10
						OR LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') > 10
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'FOLLOWING BRANCHACCOUNTS ENTRIES HAVE NOT BEEN UPDATED AS LENGTH OF BRANCH CODE OR BRANCHCONTROL ACCOUNTS IS EXCEEDING ...~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'BRANCHNAME : ' + BRANCH_CODE + ', BRCONTROLAC : ' + LEFT(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL', 10), PROCID = @@SPID
							FROM
								#BRANCHES
							WHERE
								LEN(LTRIM(RTRIM(BRANCH_CODE))) > 10
								OR LEN(LTRIM(RTRIM(BRANCH_CODE)) + 'CTRL') > 10
						END
				END
			DROP TABLE #BRANCHES
		
		/*------------------------FIND BRANCHACCOUNTS AND ACMAST MISMATCHES----------------------------------*/
			CREATE TABLE #BRANCHES1
			(
				BRANCH_CODE VARCHAR(10),
				BRCONTROLAC VARCHAR(10)
			)
		
			INSERT INTO #BRANCHES1 (BRANCH_CODE, BRCONTROLAC)
			SELECT DISTINCT
				BRANCHNAME,
				BRCONTROLAC
			FROM
				BRANCHACCOUNTS B
			WHERE
				NOT EXISTS
				(
					SELECT DISTINCT
						CLTCODE
					FROM
						ACMAST A
					WHERE
						B.BRCONTROLAC = A.CLTCODE
				)
		
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#BRANCHES1
		
			IF @@COUNTER > 0
				BEGIN
					CREATE TABLE #DUPLICATEBRS
					(
						BRCONTROLAC VARCHAR(10),
						ACNAME VARCHAR(100)
					)
					CREATE TABLE #DUPLICATEBRS1
					(
						BRCONTROLAC VARCHAR(10)
					)

					INSERT INTO
						#DUPLICATEBRS
					SELECT
						CLTCODE,
						LONGNAME
					FROM
						ACMAST A
					WHERE
						EXISTS
							(SELECT DISTINCT
								BRCONTROLAC
							FROM
								#BRANCHES1 B
							WHERE
								B.BRCONTROLAC = A.CLTCODE
							)

					INSERT INTO
						#DUPLICATEBRS
						(BRCONTROLAC)
					SELECT
						BRCONTROLAC
					FROM
						#BRANCHES1
					GROUP BY
						BRCONTROLAC
					HAVING
						COUNT(1) > 1

					DELETE B
					FROM
						#BRANCHES1 B,
						#DUPLICATEBRS D
					WHERE
						B.BRCONTROLAC = D.BRCONTROLAC

					INSERT INTO ACMAST (ACNAME, LONGNAME, ACTYP, ACCAT, FAMILYCD, CLTCODE, ACCDTLS, GRPCODE, BOOKTYPE, MICRNO, BRANCHCODE, BTOBPAYMENT, PAYMODE, POBANKNAME, POBRANCH, POBANKCODE)
					SELECT
						ACNAME = BRANCH_CODE + 'CONTROL A/C',
						LONGNAME = BRANCH_CODE + 'CONTROL A/C',
						ACTYP = 'ASSETS',
						ACCAT = 3,
						FAMILYCD = '',
						CLTCODE = BRCONTROLAC,
						ACCDTLS = '',
						GRPCODE = 'A0000000001',
						BOOKTYPE = '',
						MICRNO = 0,
						BRANCHCODE = BRANCH_CODE,
						BTOBPAYMENT = 0,
						PAYMODE = 'P',
						POBANKNAME = '',
						POBRANCH = '',
						POBANKCODE = ''
					FROM
						#BRANCHES1
		
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING CONTROL ACCOUNT ENTRIES HAVE BEEN UPDATED IN ACMAST~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'CLTCODE : ' + BRCONTROLAC + ', BRANCH : ' + BRANCH_CODE, PROCID = @@SPID
					FROM
						#BRANCHES1
					SELECT @@COUNTER = 0
					SELECT
						@@COUNTER = COUNT(1)
					FROM
						#DUPLICATEBRS
					IF @@COUNTER > 0
						BEGIN
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'FOLLOWING CONTROL ACCOUNT ENTRIES HAVE NOT BEEN ADDED IN ACMAST AS FOLLOWING ENTRIES FOUND OR MIGHT BE DUPLICATE ENTRIES WITH SAME CODE~', PROCID = @@SPID
							INSERT INTO DIAG_RESULT (RESULT, PROCID)
							SELECT
								RESULT = 'CLTCODE : ' + ISNULL(BRCONTROLAC, '') + ', LONG NAME : ' + ISNULL(ACNAME, ''), PROCID = @@SPID
							FROM
								#DUPLICATEBRS
						END
					DROP TABLE #DUPLICATEBRS
				END
			DROP TABLE #BRANCHES1
		END

/*------------------------VALIDATING LEDGER AND LASTVNO CONSISTANCY----------------------------------*/
	IF SUBSTRING(@SELECTION, 13, 1) = 'Y'
		BEGIN
			DECLARE @@PARA AS CURSOR, @@SDTCUR AS VARCHAR(11), @@LDTCUR AS VARCHAR(11), @@VNOFLAG AS SMALLINT
			CREATE TABLE #LDVNO
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				VNO VARCHAR(12)
			)
		
			CREATE TABLE #LTVNO
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				VNO VARCHAR(12)
			)
		
			CREATE TABLE #MISSVNOS
			(
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				LDVNO VARCHAR(12),
				LTVNO VARCHAR(12),
				FINYEAR VARCHAR(30)
			)
		
			SET @@PARA = CURSOR FOR
				SELECT
					SDTCUR	= CONVERT(VARCHAR(11), SDTCUR, 109),
					LDTCUR		= CONVERT(VARCHAR(11), LDTCUR, 109),
					VNOFLAG	= VNOFLAG
				FROM
					PARAMETER
				ORDER BY
					SDTCUR
			OPEN @@PARA
			FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			WHILE @@FETCH_STATUS = 0
				BEGIN
					SELECT @@SQL = "INSERT INTO #LDVNO (VTYP, BOOKTYPE, VNO) "
					SELECT @@SQL = @@SQL + "SELECT VTYP, BOOKTYPE, VNO = MAX(VNO) "
					SELECT @@SQL = @@SQL + "FROM LEDGER "
					SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @@SDTCUR + "' AND '" + @@LDTCUR + " 23:59' "
					SELECT @@SQL = @@SQL + "GROUP BY VTYP, BOOKTYPE"
					IF @@VNOFLAG = 1
						BEGIN
							SELECT @@SQL = @@SQL + ", CONVERT(VARCHAR(11), VDT, 109) "
						END
					ELSE IF @@VNOFLAG = 2
						BEGIN
							SELECT @@SQL = @@SQL + ", MONTH(VDT), YEAR(VDT)"
						END
					EXEC (@@SQL)
		
					SELECT @@SQL = "INSERT INTO #LTVNO (VTYP, BOOKTYPE, VNO) "
					SELECT @@SQL = @@SQL + "SELECT VTYP, BOOKTYPE, VNO = MAX(LASTVNO) "
					SELECT @@SQL = @@SQL + "FROM LASTVNO "
					SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @@SDTCUR + "' AND '" + @@LDTCUR + " 23:59' "
					SELECT @@SQL = @@SQL + "GROUP BY VTYP, BOOKTYPE"
					IF @@VNOFLAG = 1
						BEGIN
							SELECT @@SQL = @@SQL + ", CONVERT(VARCHAR(11), VDT, 109) "
						END
					ELSE IF @@VNOFLAG = 2
						BEGIN
							SELECT @@SQL = @@SQL + ", MONTH(VDT), YEAR(VDT)"
						END
					EXEC (@@SQL)
		
					INSERT INTO #MISSVNOS (VTYP, BOOKTYPE, LTVNO, LDVNO, FINYEAR)
					SELECT LT.VTYP, LT.BOOKTYPE, LT.VNO, LDVNO = ISNULL(LD.VNO, '000000000000'), FINYEAR = @@SDTCUR + ' - ' + @@LDTCUR
					FROM #LTVNO LT LEFT JOIN #LDVNO LD ON LT.VTYP = LD.VTYP AND LT.BOOKTYPE = LD.BOOKTYPE
					WHERE CONVERT(NUMERIC, LT.VNO) < CONVERT(NUMERIC, ISNULL(LD.VNO, '000000000000'))
					TRUNCATE TABLE #LDVNO
					TRUNCATE TABLE #LTVNO
					FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
				END
			CLOSE @@PARA
			DEALLOCATE @@PARA

			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSVNOS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FOLLOWING VTYPEs AND BOOKTYPEs ARE HAVING MISMATCH IN VNO GENERATION INTO LEDGER AND LASTVNO~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE + 'LASTVNO : ' + LTVNO + ', LEDGER VNO : ' + LDVNO + ', FINANCIAL YEAR : ' + FINYEAR,
						PROCID = @@SPID
					FROM
						#MISSVNOS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN VNO GENERATION INTO LEDGER AND LASTVNO.~', PROCID = @@SPID
				END
			DROP TABLE #MISSVNOS
			DROP TABLE #LDVNO
			DROP TABLE #LTVNO
		END

/*------------------------VALIDATING VALID VNO SERIES IN YEARLY VNO GENERATION----------------------------------*/

	IF SUBSTRING(@SELECTION, 15, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSSRS
			(
				FINYEAR VARCHAR(30),
				PROPERSR VARCHAR(4),
				INVALIDSR VARCHAR(4)
			)
			SET @@PARA = CURSOR FOR
				SELECT
					SDTCUR	= CONVERT(VARCHAR(11), SDTCUR, 109),
					LDTCUR		= CONVERT(VARCHAR(11), LDTCUR, 109),
					VNOFLAG	= VNOFLAG
				FROM
					PARAMETER
				ORDER BY
					SDTCUR
			OPEN @@PARA
			FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
			WHILE @@FETCH_STATUS = 0
				BEGIN
					IF @@VNOFLAG = 0
						BEGIN
							INSERT INTO #MISSSRS (FINYEAR, PROPERSR, INVALIDSR)
							SELECT DISTINCT
								FINYEAR = @@SDTCUR + ' - ' + @@LDTCUR,
								PROPERSR = CONVERT(VARCHAR(4), YEAR(CONVERT(DATETIME, @@SDTCUR, 109))),
								INVALIDSR = LEFT(VNO, 4)
							FROM
								LEDGER
							WHERE
								VDT BETWEEN @@SDTCUR AND @@LDTCUR + ' 23:59'
								AND LEFT(VNO, 4) <> CONVERT(VARCHAR(4), YEAR(CONVERT(DATETIME, @@SDTCUR, 109)))
						END
					FETCH NEXT FROM @@PARA INTO @@SDTCUR, @@LDTCUR, @@VNOFLAG
				END
			CLOSE @@PARA
			DEALLOCATE @@PARA
		
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSSRS
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'IN FOLLOWING FINANCIAL YEAR(S), THE VNO SERIES IS MISMATCHED.~', PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'FINANCIAL YEAR :' + FINYEAR + ', ' + 'PROPER SERIES SHOULD START FROM :' + PROPERSR + ', SERIES STARTING WITH :' + INVALIDSR,
						PROCID = @@SPID
					FROM
						#MISSSRS
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN VNO SERIES GENERATION.~', PROCID = @@SPID
				END
		END

/*------------------------VALIDATING EFFECTIVE DATE WITH REALISATION DATE IN RECEIPT VOUCHERS----------------------------------*/

	IF SUBSTRING(@SELECTION, 17, 1) = 'Y'
		BEGIN
			CREATE TABLE #MISSEFFDT
			(
				VNO VARCHAR(12),
				VTYP SMALLINT,
				BOOKTYPE VARCHAR(2),
				EDT DATETIME,
				RELDT DATETIME
			)
		
			INSERT INTO #MISSEFFDT (VNO, VTYP, BOOKTYPE, EDT, RELDT)
			SELECT
				VNO = L.VNO,
				VTYP = L.VTYP,
				BOOKTYPE = L.BOOKTYPE,
				EDT = CONVERT(VARCHAR(11), L.EDT, 109),
				RELDT = CONVERT(VARCHAR(11), L1.RELDT, 109)
			FROM
				LEDGER L,
				LEDGER1 L1
			WHERE
				L.VNO = L1.VNO
				AND L.VTYP = L1.VTYP
				AND L.BOOKTYPE = L1.BOOKTYPE
				AND L.LNO = L1.LNO
				AND L.VTYP = 2
				AND (L1.RELDT IS NOT NULL AND L1.RELDT <> '')
				AND CONVERT(VARCHAR(11), L.EDT, 109) = 'DEC 31 2049'
		
			SELECT @@COUNTER = 0
			SELECT
				@@COUNTER = COUNT(1)
			FROM
				#MISSEFFDT
		
			IF @@COUNTER > 0
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'THE CHEQUES/DDs ARE REALISED BUT EFFECTIVE DATE IS NOT UPDATED FROM DEC 31 2049 IN FOLLOWING VOUCHERS~',
						PROCID = @@SPID
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'VNO :' + VNO + ', VTYP :' + LTRIM(RTRIM(CONVERT(VARCHAR, VTYP))) + ', BOOKTYPE :' + BOOKTYPE + ', REALISED ON :' + CONVERT(VARCHAR(10), RELDT, 103) + ', EFFECTIVE ON :' + CONVERT(VARCHAR(10), EDT, 103),
						PROCID = @@SPID
					FROM
						#MISSEFFDT
				END
			ELSE
				BEGIN
					INSERT INTO DIAG_RESULT (RESULT, PROCID)
					SELECT
						RESULT = 'NO MISMATCH FOUND IN REALISATION AND EFFECTIVE DATES IN RECEIPT VOUCHERS.~', PROCID = @@SPID
				END
		END

	INSERT INTO DIAG_LOG (ACTIONDATE, COMP_NAME, APPLICATION, USERNAME, OPTIONS, PERIOD, RESULT, PROCID)
	SELECT
		ACTIONDATE = GETDATE(),
		COMP_NAME = HOST_NAME(),
		APPLICATION = APP_NAME(),
		USERNAME = @UNAME,
		OPTIONS = REPLACE(REPLACE(REPLACE(@SELECTION, 'Y', '1'), 'N', '0'), ',', ''),
		PERIOD = @FDATE + ' - ' + @TDATE,
		RESULT,
		PROCID = @@SPID
	FROM
		DIAG_RESULT
	WHERE
		PROCID = @@SPID
	ORDER BY
		SNO
	INSERT INTO DIAG_RESULT (RESULT, PROCID)
	SELECT
		RESULT = '*^*REPORT EXECUTED ON : ' + CONVERT(VARCHAR, GETDATE(), 121) + ' WITH PROCESS ID :' + CONVERT(VARCHAR, @@SPID), PROCID = @@SPID

	IF @CSV = 'N'
		BEGIN
			SELECT RESULT FROM DIAG_RESULT WHERE PROCID = @@SPID ORDER BY SNO
			DELETE FROM DIAG_RESULT WHERE PROCID = @@SPID
		END
	ELSE
		BEGIN
			SELECT @TNAME = @UNAME + '_' + REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, GETDATE(), 121), '-', ''), ':', ''), '.', ''), ' ', '')
			SELECT @@SQL = "CREATE TABLE " + @TNAME
			SELECT @@SQL = @@SQL + "( "
			SELECT @@SQL = @@SQL + "	RESULT VARCHAR(2000), SNO INT IDENTITY(1,1) "
			SELECT @@SQL = @@SQL + ") "
			EXEC (@@SQL)
			SELECT @@SQL = "INSERT INTO " + @TNAME
			SELECT @@SQL = @@SQL + "(RESULT) "
			SELECT @@SQL = @@SQL + "SELECT RESULT FROM DIAG_RESULT WHERE PROCID = " + LTRIM(RTRIM(CONVERT(VARCHAR, @@SPID))) + " ORDER BY SNO"
			EXEC (@@SQL)
			DELETE FROM DIAG_RESULT WHERE PROCID = @@SPID
			SELECT SUCCESS = 1, TABLENAME = @TNAME
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_EditVoucher
-- --------------------------------------------------
CREATE PROCEDURE acc_EditVoucher
@vno varchar(12),
@vtyp  smallint,
@booktype varchar(2),
@emode char(1),
@status char(6),
@editname varchar(15),
@vdt varchar(11)
AS

declare
@@vdt1 as datetime
  

select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))

select * from ledger_log

insert into ledger_log 
select *, @emode,@@vdt1,@editname,@status from ledger where vtyp = @vtyp and vno = @vno and booktype = @booktype

insert into ledger1_log
select bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode, @emode from ledger1  where vtyp = @vtyp and vno = @vno and booktype = @booktype

insert into ledger2_log 
select *, @emode from ledger2  where vtype = @vtyp and vno = @vno and booktype = @booktype

insert into ledger3_log
select *, @emode from ledger3  where vtyp = @vtyp and vno = @vno and booktype = @booktype

insert into matchdetails_log
select *, @emode from matchdetails where lvtype = @Vtyp and lbooktype = @booktype and lvno = @Vno 

insert into marginledger_log
select *, @emode from marginledger where vtyp = @vtyp and vno = @vno and booktype = @booktype



delete from ledger    where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from ledger1  where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from ledger2  where vtype = @vtyp and vno = @vno and booktype = @booktype
delete from ledger3  where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from marginledger where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from matchdetails where lvtype = @Vtyp and lbooktype = @booktype and lvno = @Vno 
delete from payadv where vtyp = @Vtyp and booktype = @booktype and vno = @Vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_genvno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.acc_genvno    Script Date: 1/17/2004 11:39:08 PM ******/

CREATE PROC acc_genvno
@vdt      varchar(11),  /* dd/mm/yyyy */
@vtyp     smallint,
@booktype varchar(2),
@sdtcur   varchar(11),
@ldtcur   varchar(11)
/* @vnoflag  int */
as
declare
@@voudt  as datetime,
@@maxvno as numeric(12,0),
@@vnoflag as tinyint,
@@vno as varchar(12),
@@rcnt as int
select @@vnoflag = (Select vnoflag from parameter where  sdtcur like @sdtcur + '%' and ldtcur like @ldtcur + '%')
select @@voudt = (select convert(datetime,@vdt))
if @@vnoflag = 0
   begin
      select @@maxvno = isnull(max(convert(NUMERIC,lastvno)),0) from lastvno WITH (TABLOCKX,HOLDLOCK) where vtyp = @vtyp and booktype = @booktype and vdt >= @sdtcur + ' 00:00:00' 
      and vdt <= @ldtcur + ' 23:59'
      if @@maxvno = 0
         begin
           select @@vno = right(rtrim(@sdtcur),4)+'00000001'
         end
      else
         begin
           select @@vno = rtrim(convert(varchar,@@maxvno + 1))
         end
   end
else if @@vnoflag = 1
        begin
          select @@maxvno = isnull(max(convert(NUMERIC,lastvno)),0) from lastvno WITH (TABLOCKX,HOLDLOCK) where vtyp = @vtyp and booktype = @booktype and vdt like @vdt + '%'
          if @@maxvno = 0
             begin
                select @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'
             end
          else
             begin
               select @@vno = rtrim(convert(varchar,@@maxvno + 1))
             end
        end
else if @@vnoflag = 2
        begin
          select @@maxvno = isnull(max(convert(NUMERIC,lastvno)),0) from lastvno WITH (TABLOCKX,HOLDLOCK) where vtyp = @vtyp and booktype = @booktype and year(vdt) = year(@@voudt) and month(vdt) = month(@@voudt)
          if @@maxvno = 0
             begin
                select @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001'
             end
         else
             begin
               select @@vno = rtrim(convert(varchar,@@maxvno + 1))
             end
        end
/*  
select @@rcnt = ( select count(*) from lastvno where vtyp = @vtyp and booktype = @booktype and vdt like @vdt + '%')
if @@rcnt = 0
   begin
     insert into lastvno values(@vtyp,@booktype,@vdt,@@vno)
   end
else
   begin
*/
/*     Update lastvno WITH (TABLOCKX, HOLDLOCK) set lastvno = @@Vno where vtyp = @vtyp and booktype = @booktype and vdt like @vdt+'%' */
/*     Update lastvno set lastvno = @@Vno where vtyp = @vtyp and booktype = @booktype and vdt like @vdt+'%' 
   end
*/
select vno = @@vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_GENVNO_NEW
-- --------------------------------------------------




CREATE   PROC ACC_GENVNO_NEW
@VDT      VARCHAR(11),
@VTYP     SMALLINT,
@BOOKTYPE VARCHAR(2),
@SDTCUR   VARCHAR(11),
@LDTCUR   VARCHAR(11),
@NOREC INT = 0

AS
/*
	EXEC ACC_GENVNO_NEW 'APR  1 2006', 8, '01', 'APR  1 2006', 'MAR 31 2007', 3
	EXEC Acc_GenVno_New  'APR  1 2005',8,'01','apr  1 2005','mar 31 2006',2
	SELECT * FROM LASTVNO WHERE VTYP = 8
*/
DECLARE
@@VOUDT  AS DATETIME,
@@MAXVNO AS NUMERIC(12,0),
@@VNOFLAG AS TINYINT,
@@VNO AS VARCHAR(12),
@@RCNT AS INT

SET XACT_ABORT ON

BEGIN  TRANSACTION

IF @NOREC = 0
	BEGIN
		SELECT @NOREC = @NOREC + 1
	END


SELECT 
	@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), 
	@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109), 
	@@VNOFLAG = VNOFLAG,
	@@VOUDT = (SELECT CONVERT(DATETIME,@VDT))
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR

IF @@VNOFLAG = 0
	BEGIN
		SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0) FROM LASTVNO WITH (TABLOCKX,HOLDLOCK) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00'
		AND VDT <= @LDTCUR + ' 23:59'
		IF @@MAXVNO = 0
			BEGIN
				SELECT @@VNO = RIGHT(RTRIM(@SDTCUR),4)+'00000001'
			END
		ELSE
			BEGIN
				SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
			END
		SELECT @@RCNT = ( SELECT COUNT(*) FROM LASTVNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00' AND VDT <= @LDTCUR + ' 23:59')
	END
ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0) FROM LASTVNO WITH (TABLOCKX,HOLDLOCK) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT LIKE @VDT+'%'
		IF @@MAXVNO = 0
			BEGIN
				SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@VOUDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
			END
		SELECT @@RCNT = ( SELECT COUNT(*) FROM LASTVNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00' AND VDT LIKE @VDT+'%')
	END
ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0) FROM LASTVNO WITH (TABLOCKX,HOLDLOCK) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND YEAR(VDT) = YEAR(@@VOUDT) AND MONTH(VDT) = MONTH(@@VOUDT)
		IF @@MAXVNO = 0
			BEGIN
				SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2))+'000001'
			END
		ELSE
			BEGIN
				SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
			END
		SELECT @@RCNT = ( SELECT COUNT(*) FROM LASTVNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND YEAR(VDT) = YEAR(@@VOUDT) AND MONTH(VDT) = MONTH(@@VOUDT))
	END
IF @@RCNT = 0
	BEGIN
		INSERT INTO LASTVNO VALUES(@VTYP,@BOOKTYPE,@VDT,CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1))
	END
ELSE
	BEGIN
		IF @@VNOFLAG = 0
			BEGIN
				UPDATE LASTVNO WITH (TABLOCKX, HOLDLOCK) SET LASTVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00' AND VDT <= @LDTCUR + ' 23:59'
			END
		ELSE IF @@VNOFLAG = 1
			BEGIN
				UPDATE LASTVNO WITH (TABLOCKX, HOLDLOCK) SET LASTVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT LIKE @VDT+'%'
			END
		ELSE IF @@VNOFLAG = 2
			BEGIN
				UPDATE LASTVNO WITH (TABLOCKX, HOLDLOCK) SET LASTVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND YEAR(VDT) = YEAR(@VDT) AND MONTH(VDT) = MONTH(@VDT)
			END
	END

IF @@ERROR <> 0
	BEGIN
		ROLLBACK TRANSACTION
		SELECT VNO = ''
	END
ELSE
	BEGIN
		COMMIT TRANSACTION
		SELECT VNO = @@VNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_GetSlipNo
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.acc_GetSlipNo    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE PROCEDURE  acc_GetSlipNo
@cltcode varchar(10),
@booktype varchar(2),
@flag integer
AS
/*
select distinct convert(integer,slipno) slipno from slipreceipt order by slipno 
*/

if @flag = 1
begin
	select distinct slipno 
	from ledger1 l1, ledger l
	where l1.vtyp = l.vtyp and l1.booktype= l.booktype and l1.vno = l.vno 
	and l.cltcode = @cltcode and l1.vtyp in (2,19) and l1.booktype = @booktype and slipno <> 0
	order by slipno
end
else
begin
	select distinct convert(varchar,slipdate,103)  slipdate from ledger1 l
	where l.vtyp in (2,19) and l.booktype =@booktype  and slipno <> 0
	order by convert(varchar,slipdate,103)
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_NCX_LIVE2UAT
-- --------------------------------------------------
CREATE PROC ACC_NCX_LIVE2UAT
AS
TRUNCATE TABLE ACMAST
INSERT INTO ACMAST
SELECT * FROM [196.1.115.204].ACCOUNTNCDX.DBO.ACMAST

TRUNCATE TABLE costmast
INSERT INTO costmast
SELECT * FROM [196.1.115.204].ACCOUNTNCDX.DBO.costmast


TRUNCATE TABLE BranchAccounts
INSERT INTO BranchAccounts
SELECT * FROM [196.1.115.204].ACCOUNTNCDX.DBO.BranchAccounts

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_opbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.acc_opbal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.acc_opbal    Script Date: 03/29/2003 11:42:00 AM ******/
/****** Object:  Stored Procedure dbo.acc_opbal    Script Date: 02/18/2003 10:22:36 AM ******/
/****** Object:  Stored Procedure dbo.acc_opbal    Script Date: Feb 03 2003 17:29:22 ******/
/****** Object:  Stored Procedure dbo.acc_opbal    Script Date: 11/12/2002 3:16:18 PM ******/
CREATE procedure acc_opbal
@sdate varchar(11),            /* As mmm dd yyyy */
@edate varchar(11),            /* As mmm dd yyyy */
@fdate varchar(11),            /* As mmm dd yyyy */
@tdate varchar(11),            /* As mmm dd yyyy */
@fcode varchar(10),
@tcode varchar(10),
@statusId varchar(30),
@statusname varchar(30),
@branch varchar(10),
@selectionby varchar(3),
@GroupBy varchar(10),
@Sortby varchar(50),
@reportname varchar(30),
@reportopt varchar(10),
@fld1 varchar(10),
@fld2 varchar(10),
@fld3 varchar(10)
as
declare
@@opendate   as varchar(11)
/* -------------------------------------------------------------------------- */
if len(rtrim(@fdate)) = 10 
begin
   select @fdate = left(@fdate,3) + ' ' + substring(@fdate,4,7)
end
if len(rtrim(@sdate)) = 10 
begin
   select @sdate = left(@sdate,3) + ' ' + substring(@sdate,4,7)
end
if len(rtrim(@tdate)) = 10 
begin
   select @tdate = left(@tdate,3) + ' ' + substring(@tdate,4,7)
end
if len(rtrim(@edate)) = 10 
begin
   select @edate = left(@edate,3) + ' ' + substring(@edate,4,7)
end
if @fdate =''
begin
   select @fdate = @sdate
end
if @tdate = ''
begin
   select @tdate = @edate
end
if @Reportname <> 'MarginLedger'
begin
/* Get Opendate from sdate, fdate received as parameter */
   if upper(@selectionby) = 'VDT'
      begin
         select @@opendate = ( select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger where vtyp = 18 and vdt <= @fdate )
      end
   else
      begin
         select @@opendate = ( select left(convert(varchar,isnull(max(edt),0),109),11) from ledger where vtyp = 18 and edt <= @fdate )
   end
/* -------------------------------------------------------------------------- */     
   if upper(@selectionby) = 'VDT'
      begin
         if @sdate = @fdate
            begin
		if @@opendate = @fdate 
		begin
	               select cltcode, opbal = sum( case when upper(drcr) = 'D' then vamt else -vamt end)
        	       from ledger 
	               where cltcode = @fcode and vdt like @@opendate + '%' and vtyp = 18
        	       group by cltcode
		end
		else
		begin
	               select cltcode, opbal = sum( case when upper(drcr) = 'D' then vamt else -vamt end)
        	       from ledger 
	               where cltcode = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate 
        	       group by cltcode
		end
            end
         else
            begin
               select cltcode, opbal = sum( case when upper(drcr) = 'D' then vamt else -vamt end)
               from ledger 
               where cltcode = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate 
               group by cltcode
            end
      end
   else
      begin
         if @sdate = @fdate and @@opendate = @fdate
            begin
               select cltcode, opbal = sum(balamt)
               from ledger 
               where cltcode = @fcode and edt like @@opendate + '%' and vtyp = 18
               group by cltcode
            end
         else
            begin
               select cltcode, opbal=sum(opbal)
               from
               ( select cltcode, opbal = sum(balamt)
                 from ledger 
                 where cltcode = @fcode and edt like @@opendate + '%' and vtyp = 18
                 group by cltcode
                 union all
                 select cltcode, opbal = sum( case when upper(drcr) = 'D' then vamt else -vamt end)
                 from ledger 
                 where cltcode = @fcode and edt >= @@opendate + ' 00:00:00' and edt < @fdate and vtyp <> 18
                 group by cltcode ) t
               group by cltcode
            end
      end
end
if @Reportname = 'MarginLedger'
begin
/* Get Opendate from sdate, fdate received as parameter */
   if upper(@selectionby) = 'VDT'
      begin
         select @@opendate = ( select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger where vtyp = 18 and vdt <= @fdate )
      end
   else
      begin
         select @@opendate = ( select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger where vtyp = 18 and vdt <= @fdate )
   end
/* -------------------------------------------------------------------------- */     
   if upper(@selectionby) = 'VDT'
      begin
         if @sdate = @fdate
            begin
		if @@opendate = @fdate 
		begin
	               select cltcode=party_code, opbal = sum( case when upper(drcr) = 'D' then amount else -amount end)
        	       from marginledger 
	               where party_code = @fcode and vdt like @@opendate + '%' and vtyp = 18
        	       group by party_code
		end
		else
		begin
	   		select cltcode=party_code, opbal = sum( case when upper(drcr) = 'D' then amount else -amount end)
        	       from marginledger 
	               where party_code = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate 
        	       group by party_code
		end
            end
         else
            begin
   		select cltcode=party_code, opbal = sum( case when upper(drcr) = 'D' then amount else -amount end)
               from marginledger 
               where party_code = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate 
               group by party_code
            end
      end
   else
      begin
         if @sdate = @fdate and @@opendate = @fdate
            begin
               select cltcode=party_code, opbal = sum(sett_no)
               from marginledger 
               where party_code = @fcode and vdt LIKE @@opendate + '%' and vtyp = 18
               group by party_code
            end
         else
            begin
               select cltcode, opbal=sum(opbal)
               from
               ( select cltcode=party_code, opbal = sum(sett_no)
                 from marginledger 
                 where party_code = @fcode and vdt LIKE @@opendate + '%' and vtyp = 18
                 group by party_code
                 union all
                 select cltcode=party_code, opbal = sum( case when upper(drcr) = 'D' then amount else -amount end)
                 from marginledger 
                 where party_code = @fcode and vdt >= @@opendate + ' 00:00:00' and vdt < @fdate and vtyp <> 18
                 group by party_code) t
               group by cltcode
            end
      end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_partybalance
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.acc_partybalance    Script Date: 05/13/2003 6:08:54 PM ******/
/* 
Exec acc_partybalance 'May 19 2003', 'vdt','Partywise','Normal','Apr 1 2003', 'Apr 1 2003', 1,'Apr 1 2003', 'BROKER', '%', 'vdt', 'A06075', 'A06075' 
*/
CREATE PROCEDURE acc_partybalance

/* report : consolidated trial balance        
file : trialbal.asp
displays consolidated trial balance */


@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3),          /* Whether report is based on VDT or EDT */
@fparty varchar(10),
@tparty varchar(10)
AS

declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@mwherepart1 as varchar(500),
@@mwherepart2 as varchar(500),
@@mwherepart3 as varchar(500),
@@addwhere    as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3)

if upper(@statusid) = 'BROKER'
begin
	select @@Groupby    = " group by l.Cltcode , l.acname, branchcode"
end
else
begin
	select @@Groupby    = " group by l.Cltcode , l.acname, branchcode"
end

if upper(@statusid) = 'BROKER'
begin
	if @flag = 'codewise'
	begin
	   select @@sortby = " order by  l.Cltcode, l.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  l.acname, l.Cltcode, branchcode"
	end
end
else
begin
	if @flag = 'codewise'
	begin
	   select @@sortby = " order by  l.Cltcode, l.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  l.acname, l.Cltcode, branchcode"
	end
end

if @viewoption = 'Partywise'  /* Only Party accounts to be displayed */
begin
   select @@addwhere  = " and a.accat in (4,104) and a.cltcode >= '" + @fparty + "' and a.cltcode <= '" + @tparty + "' "
end
else if @viewoption = 'GL'  /* Only Party accounts to be displayed */
     begin
        select @@addwhere  = " and a.accat not in (4,104) " 
     end
     else
     begin
        select @@addwhere  = " " 
     end

if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end
else if @statusid = 'branch'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end

/*  -- FOR BROKER --  */
/* ------------------ */

if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > getdate() then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > getdate() then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
	   select @@selectqury = "   select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury + " Amount = sum( case when l.vtyp = 18 then balamt else (case when upper(drcr) = 'D' then vamt else -vamt end) end)," 
	   select @@selectqury = @@selectqury + " unrealamt = sum(case when edt > getdate() then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end),"
	   select @@selectqury = @@selectqury + " margin = isnull(( select sum( case when m.vtyp = 18 then sett_no else (case when upper(m.drcr) = 'D' then amount else -amount end) end) "
	   select @@selectqury = @@selectqury + " from marginledger m, ledger l1  left outer join acmast a on l1.cltcode=  a.cltcode "
	   select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere
	   select @@selectqury = @@selectqury + " and l1.vtyp = m.vtyp and l1.booktype = m.booktype and l1.vno = m.vno and m.party_code = l1.cltcode and l.cltcode = l1.cltcode),0) "
	   select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode "
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > getdate() then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
         end
      else
         begin
	   select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > getdate() then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
/*             select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
*/
         end
   end
end
end
/*  -- FOR BRANCH SELECTION --  */
/* -------------
--------------- */

if @statusid = 'Branch'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > getdate() then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > getdate() then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else         
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > getdate() then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
           select @@fromtables = " "
           select @@wherepart  = " "
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > getdate() then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
         end
      else
         begin
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > getdate() then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
         end
   end
end
end
--exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby) 

print @@selectqury + @@fromtables + @@wherepart + @@groupby
--exec (@@selectqury + @@fromtables + @@wherepart + @@groupby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_partybalanceTest
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.acc_partybalance    Script Date: 05/13/2003 6:08:54 PM ******/
/* 
Exec acc_partybalance 'May 19 2003', 'vdt','Partywise','Normal','Apr 1 2003', 'Apr 1 2003', 1,'Apr 1 2003', 'BROKER', '%', 'vdt', 'A06075', 'A06075' 

Exec acc_partybalanceTest 'Nov 13 2003', 'vdt','Partywise','Normal','Apr 1 2003', 'Apr 1 2003', 1,'Apr 1 2003', 'BROKER', '%', 'vdt', 'H06604', 'H07033' 

*/
CREATE PROCEDURE acc_partybalanceTest

/* report : consolidated trial balance        
file : trialbal.asp
displays consolidated trial balance */


@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3),          /* Whether report is based on VDT or EDT */
@fparty varchar(10),
@tparty varchar(10),
@sortacnamecode varchar(10)
AS

declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@mwherepart1 as varchar(500),
@@mwherepart2 as varchar(500),
@@mwherepart3 as varchar(500),
@@addwhere    as varchar(200),
@@addwhere1   as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@TEST      as varchar(8000),
@@wherepart_new   as varchar(2000),
@@costcode    as varchar(3)

if upper(@statusid) = 'BROKER'
begin
	select @@Groupby    = " group by l.Cltcode , l.acname, branchcode"
end
else
begin
	select @@Groupby    = " group by l.Cltcode , l.acname, branchcode"
end


if @statusid <>  'Broker'
begin
/*Set @@wherepart = @@wherepart + " and region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "*/
Set @@wherepart_new =   " and branch_cd LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart_new= @@wherepart_new + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart_new = @@wherepart_new + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart_new =@@wherepart_new + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "
Set @@wherepart_new = @@wherepart_new + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "
end 


if upper(@statusid) = 'BROKER'
begin
	if @sortacnamecode = 'ACCODE'
	begin
	   select @@sortby = " order by  l.Cltcode, l.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  l.acname, l.Cltcode, branchcode"
	end
end
else
begin
	if @sortacnamecode = 'codewise'
	begin
	   select @@sortby = " order by  l.Cltcode, l.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  l.acname, l.Cltcode, branchcode"
	end
end

if @viewoption = 'Partywise'  /* Only Party accounts to be displayed */
begin
   select @@addwhere  = "  and  a.accat in (4,104) and a.cltcode >= '" + @fparty + "' and a.cltcode <= '" + @tparty + "' "
   select @@addwhere1  = " and a.cltcode=c2.party_code and c1.cl_code=c2.cl_code "
end
else if @viewoption = 'GL'  /* Only Party accounts to be displayed */
     begin
        select @@addwhere  = " and a.accat not in (4,104) " 
     end
    else
     begin
        select @@addwhere  = " " 
     end

if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end

 if @statusid = 'branch'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end
end 

 if @statusid = 'Client'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end

end
if @statusid = 'trader'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@mwherepart2 = @@wherepart2 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
      select @@mwherepart3 = @@wherepart3 + " and l.vtyp = m.vtyp and l.booktype = m.booktype and l.vno = m.vno " 
   end

end


/*  -- FOR BROKER --  */
/* ------------------ */

if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin

 
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
      select @@wherepart  = @@wherepart2 + @@addwhere + @@addwhere1

 

           	 
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="A"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart2 + @@addwhere +  @@addwhere1
         end
      else
         begin
	select @@test ="B"
	   select @@selectqury = "   select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury + " Amount = sum( case when l.vtyp = 18 then balamt else (case when upper(drcr) = 'D' then vamt else -vamt end) end)," 
	   select @@selectqury = @@selectqury + " unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end),"
	   select @@selectqury = @@selectqury + " margin = isnull(( select sum( case when m.vtyp = 18 then sett_no else (case when upper(m.drcr) = 'D' then amount else -amount end) end) "
	   select @@selectqury = @@selectqury + " from marginledger m, ledger l1  left outer join acmast a on l1.cltcode=  a.cltcode  "
	   select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere
	   select @@selectqury = @@selectqury + " and l1.vtyp = m.vtyp and l1.booktype = m.booktype and l1.vno = m.vno and m.party_code = l1.cltcode and l.cltcode = l1.cltcode),0) "
	   select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 "
           select @@wherepart  = @@wherepart2 + @@addwhere +   @@addwhere1
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="C"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3 + @@addwhere + @@addwhere1
         end
      else
         begin
		select @@test ="D"
	   select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 + @@addwhere + @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
            select @@fromtables = " "
            select @@wherepart  = " "
/*             select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
*/
         end
   end
end
end
/*  -- FOR BRANCH SELECTION --  */
/* -------------
--------------- */

if @statusid = 'Branch'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1 + @@addwhere +  @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="E"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2+@@wherepart_new + @@addwhere+  @@addwhere1
         end
      else         
         begin
/* FFFFFFFFFFFFF
	select @@test =@@mwherepart2 */
                  select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2+@@wherepart_new  + @@addwhere+ @@addwhere1
          	   select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
	select @@test = @@selectqury + @@fromtables + @@wherepart+ @@groupby + @@sortby

Print @@test 
       /*  select @@fromtables = " "
           select @@wherepart  = " " */ 
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="G"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3+@@wherepart_new  + @@addwhere+ @@addwhere1
         end
      else
         begin
	select @@test ="H"
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 +@@wherepart_new + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
     /*       select @@fromtables = " "
            select @@wherepart  = " "*/
         end
   end
end
end

if @statusid = 'Client'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1+@@wherepart_new  + @@addwhere+ @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="I"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2 +@@wherepart_new + @@addwhere  + @@addwhere1
         end
      else         
         begin
		select @@test ="J"
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2 +@@wherepart_new + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
        /*   select @@fromtables = " "
           select @@wherepart  = " "*/
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="K"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3+@@wherepart_new + @@addwhere  + @@addwhere1  
         end
      else
        begin
	select @@test ="L"
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt >  CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')   then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 +@@wherepart_new  + @@addwhere +  @@addwhere1 
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
     /*       select @@fromtables = " "
            select @@wherepart  = " "*/
         end
   end
end
end
 
if @statusid = 'trader'
begin
/*---- If user wants to
 see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then (case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(drcr) = 'D' then amount else -amount end) from marginledger m "
      select @@fromtables = @@wherepart + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 " 
      select @@wherepart  = @@wherepart1+@@wherepart_new  + @@addwhere+ @@addwhere1
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="I"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart2 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2 " 
            select @@wherepart  = @@wherepart2 +@@wherepart_new + @@addwhere  + @@addwhere1
         end
      else         
         begin
		select @@test ="J"
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2   " 
      	   select @@wherepart  = @@wherepart2 +@@wherepart_new + @@addwhere+ @@addwhere1
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "
/*           select @@selectqury = @@selectqury + @@wherepart*/
        /*   select @@fromtables = " "
           select @@wherepart  = " "*/
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
	select @@test ="K"
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end), unrealamt = sum(case when edt > CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')  then ( case when upper(drcr) = 'D' then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' then amount else -amount end) from marginledger m "
            select @@fromtables = @@wherepart3 + " and m.party_code = l.cltcode ),0) " +" from ledger l left outer join acmast a on l.cltcode=  a.cltcode, ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
            select @@wherepart  = @@wherepart3+@@wherepart_new + @@addwhere  + @@addwhere1  
         end
      else
        begin
	select @@test ="L"
           select @@selectqury = "  select cltcode, acname, branchcode, amount=sum(amount), unrealamt = sum(unrealamt), "
	   select @@selectqury = @@selectqury  + " margin=sum(margin) from ( select l.cltcode , acname=isnull(l.acname,''), branchcode, "
	   select @@selectqury = @@selectqury  + " Amount = sum(Case When DrCr = 'C' then -Vamt Else Vamt End), unrealamt = sum(case when l.edt >  CONVERT(DATETIME,LEFT(CONVERT(VARCHAR, GETDATE(),109),11) + ' 23:59:59')   then ( case when upper(drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then vamt else -vamt end)else 0 end), margin = isnull(( select sum(case when upper(m.drcr) = 'D' "
	   select @@selectqury = @@selectqury  + " then amount else -amount end) from marginledger m "
	   select @@fromtables = @@mwherepart2 + " and m.party_code = l.cltcode ),0) " + "from ledger l left outer join acmast a on l.cltcode=  a.cltcode , ncdx.dbo.client1 c1  ,ncdx.dbo.client2 c2  " 
      	   select @@wherepart  = @@wherepart2 +@@wherepart_new  + @@addwhere +  @@addwhere1 
           select @@wherepart  = @@wherepart + " group by l.Cltcode , l.acname, branchcode , l.vno,l.vtyp,l.booktype,edt ) l "

/*           select @@selectqury = @@selectqury + @@wherepart*/
     /*       select @@fromtables = " "
            select @@wherepart  = " "*/
         end
   end
end
end

 
Print (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby) 
 
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_PrintReconcile
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[acc_PrintReconcile]                        
@code varchar(10),                      
@reporttype varchar(10),                      
@tdate  datetime,                      
@fdate  datetime                      
AS                      
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                 
                    
if upper(@reporttype) = 'STATEMENT'                      
begin                      
/*set transaction isolation level read uncommitted                    
                  
select distinct vtyp, booktype, vno, lno into #tblbankreco from ledger where cltcode = @code             
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#tblbankreco] ([vno], [vtyp], [BookType])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
select l.* Into #Ledger          
From Ledger L, #tblbankreco T          
Where L.VNo = T.Vno           
And L.Vtyp = T.Vtyp          
And L.BookType = T.BookType          
--And L.Lno = T.LNo          
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#Ledger] ([vno], [vtyp], [BookType], [LNO])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
select l.* Into #Ledger1          
From Ledger1 L, #tblbankreco T          
Where L.VNo = T.Vno           
And L.Vtyp = T.Vtyp          
And L.BookType = T.BookType          
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#Ledger1] ([vno], [vtyp], [BookType], [LNO])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
                  
 select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,                       
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then relamt  else 0 end ),                      
 Cramt= (case when upper(l.drcr) = 'C' then relamt else 0 end ),                       
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno                      
 From #Ledger l, #Ledger1 L1 ,                      
 #tblbankreco t                       
 WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype                       
 and l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno          
 and cltcode <> @code and vdt <=@tdate --and l.vtyp not in ( 16, 17) and l1.clear_mode not in ('C', 'R')                      
 and rtrim(l1.ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109)               
 not in(select rtrim(ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109) from #Ledger1 l12, #Ledger l2           
 where l12.vno=l2.vno and l12.vtyp=l2.vtyp                                                 
 and l12.booktype=l2.booktype and l12.vtyp='16' and l2.vdt < @tdate and cltcode= @code)                                              
 and (reldt ='1900-01-01 00:00:00.000' or reldt > @tdate )                       
 order by l.drcr, vdt, l.vtyp, l.vno                      
          
 DROP TABLE #tblbankreco          
 DROP TABLE #Ledger          
 DROP TABLE #Ledger1    */      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT       
 L.VTYP, L.BOOKTYPE, L.VNO, VDT, TDATE=CONVERT(VARCHAR,L.VDT,103), ISNULL(DDNO,'') DDNO, ISNULL(CLTCODE ,'') CLTCODE ,                       
 ISNULL( ACNAME ,'') ACNAME, L.DRCR, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN RELAMT  ELSE 0 END ),                      
 CRAMT= (CASE WHEN UPPER(L.DRCR) = 'C' THEN RELAMT ELSE 0 END ),                       
 TRELDT=ISNULL(CONVERT(VARCHAR, RELDT , 103),''), L1.REFNO                      
FROM       
 LEDGER L,       
 LEDGER1 L1 ,                      
 (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @code AND VDT <= @tdate ) L2      
WHERE       
 L.VTYP = L2.VTYP AND L.VNO= L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE                       
 AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO          
 AND CLTCODE <> @code       AND NOT EXISTS      
  (SELECT L3.DDNO FROM LEDGER1 L3, (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @code AND VDT <= @tdate AND VTYP = 16) L4      
  WHERE L1.DDNO = L3.DDNO AND CONVERT(VARCHAR(11),L1.DDDT,109) = CONVERT(VARCHAR(11),L3.DDDT,109) AND L1.RELAMT = L3.RELAMT      
  AND L3.VNO = L4.VNO AND L3.VTYP = L4.VTYP AND L3.BOOKTYPE = L4.BOOKTYPE AND L1.BOOKTYPE = L3.BOOKTYPE )      
 AND (RELDT ='1900-01-01 00:00:00.000' OR RELDT >  @tdate )      
ORDER BY       
 L.DRCR, VDT, L.VTYP, L.VNO      
          
end                      
else                      
begin                      
          
select distinct vtyp, booktype, vno, lno into #tblbankreco_TMP from ledger where cltcode = @code             
and vdt >= @fdate and vdt <= @tdate           
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#tblbankreco_TMP] ([vno], [vtyp], [BookType])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
select l.* Into #Ledger_TMP          
From Ledger L, #tblbankreco_tmp T          
Where L.VNo = T.Vno           
And L.Vtyp = T.Vtyp          
And L.BookType = T.BookType          
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#Ledger_TMP] ([vno], [vtyp], [BookType], [LNO])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
select l.* Into #Ledger1_TMP          
From Ledger1 L, #tblbankreco_tmp T          
Where L.VNo = T.Vno           
And L.Vtyp = T.Vtyp          
And L.BookType = T.BookType          
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#Ledger1_TMP] ([vno], [vtyp], [BookType], [LNO])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
 select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,                       
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then relamt  else 0 end ),                      
 Cramt= (case when upper(l.drcr) = 'C' then relamt else 0 end ),                       
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno                      
 From #Ledger_TMP l, #Ledger1_TMP L1, #tblbankreco_TMP T          
 WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype                       
 AND l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno          
 and cltcode <> @code and vdt >= @fdate and vdt <= @tdate                      
 order by l.drcr, vdt, l.vtyp, l.vno          
          
DROP TABLE #tblbankreco_TMP          
DROP TABLE #Ledger_TMP          
DROP TABLE #Ledger1_TMP          
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_reports
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[acc_reports]                          
@SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@EDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@FCODE VARCHAR(10),                          
@TCODE VARCHAR(10),                          
@STATUSID VARCHAR(30),                          
@STATUSNAME VARCHAR(30),                          
@BRANCH VARCHAR(10),                          
@SELECTIONBY VARCHAR(3),                          
@GROUPBY VARCHAR(10),                          
@SORTBY VARCHAR(50),                          
@REPORTNAME VARCHAR(30),                          
@REPORTOPT VARCHAR(10),                          
@FLD1 VARCHAR(50),  /*  TO BE USED FOR SHAREDB IN CASE OF PARTY LEDGER */                          
@FLD2 VARCHAR(10),                          
@FLD3 VARCHAR(10)                          
                          
AS
DECLARE                          
@@OPENDATE   AS VARCHAR(11),                                   
@@SELECTQURY AS VARCHAR(8000),                          
@@FROMTABLES AS VARCHAR(2000),                          
@@WHEREPART  AS VARCHAR(8000),                          
@@GROUPBY    AS VARCHAR(200),                          
@@SORTBY     AS VARCHAR(200),                          
@@UALL       AS VARCHAR(20),                          
@@USELECTQURY AS VARCHAR(8000),                          
@@UFROMTABLES AS VARCHAR(2000),                          
@@UWHEREPART  AS VARCHAR(8000),                          
@@UGROUPBY    AS VARCHAR(200),                          
@@USORTBY     VARCHAR(200),                          
@@DATEFILTER AS VARCHAR(500),                          
@@DATEFILTER1 AS VARCHAR(500),                          
@@REPORTFROM AS VARCHAR(1)                          
                          
/* -------------------------------------------------------------------------- */                          
IF @FDATE = " "                           
BEGIN                          
   SELECT @FDATE = @SDATE                          
END                          
                          
IF @TDATE = " "                          
BEGIN                          
   SELECT @TDATE = @EDATE                          
END                          
                          
/* GET FILTER CONDITION ON DATES BASED ON THE VALUE OF @SELECTIONBY */                          
                          
IF @SELECTIONBY = 'VDT'                          
BEGIN                          
   SELECT @@DATEFILTER = " WHERE L.VDT >= '" + @FDATE + " 00:00:00' AND L.VDT <= '" + @TDATE +" 23:59:59'"                          
   SELECT @@DATEFILTER1 = "  VDT >= '" + @FDATE + " 00:00:00' AND VDT <= '" + @TDATE +" 23:59:59'"                          
END                          
ELSE IF @SELECTIONBY = 'EDT'                          
BEGIN                          
   SELECT @@DATEFILTER = " WHERE L.EDT >= '" + @FDATE + " 00:00:00' AND L.EDT <= '" + @TDATE +" 23:59:59'"                          
   SELECT @@DATEFILTER1 = " EDT >= '" + @FDATE + " 00:00:00' AND EDT <= '" + @TDATE +" 23:59:59'"                          
END                          
/* -------------------------------------------------------------------------- */                               
                          
IF @REPORTNAME = 'CASH BOOK'                           
BEGIN                          
                          
   IF UPPER(@SORTBY) = 'VDT'                          
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'EDT'                          
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"                          
    ELSE IF UPPER(@SORTBY) = 'VTYPE'                          
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"                          
  ELSE IF UPPER(@SORTBY) = 'ACCODE'                      
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'ACNAME'                          
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"                          
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'                          
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"                          
       ELSE IF UPPER(@SORTBY) = 'VNO'                          
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"                          
        ELSE IF UPPER(@SORTBY) = 'DRCR'                          
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"                          
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'                          
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"                          
                          
                          
                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN 

print 'vin111'                         
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), l.CLTCODE, ACNAME=ISNULL(ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L.DRCR) = 'D' THEN  VAMT  ELSE  0 END),CREDIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"     
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK) WHERE CLTCODE = '" + @FCODE + "' AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER L "    
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "'  AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "SELECT @@GROUPBY = " " END  --ELSE                          
 ELSE IF UPPER(@STATUSID) = 'REGION'                      
      BEGIN                          
                     
PRINT UPPER(@STATUSNAME) 
print 'vin222'                     
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), L.CLTCODE, ACNAME=ISNULL(L.ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT  ELSE  0 END),CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"                          
        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM NCDX.DBO.REGION WHERE UPPER(REGIONCODE) = '" + @STATUSNAME + "') R "                          
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "                          
        SELECT @@GROUPBY = " "                           
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                            
		PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                 
      END                        
ELSE                
      BEGIN                          
               

print 'vin333'
PRINT @@SELECTQURY           
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE=L2.CLTCODE, ACNAME=ISNULL(L.ACNAME,''),VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L2.DRCR"                          
  SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE, LNO FROM LEDGER (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER2 L2, COSTMAST C, LEDGER L "       
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = '" + @FCODE + "' AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "'  AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L.LNO = T.LNO AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE= L.BOOKTYPE AND L2.LNO = L.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "     
SELECT @@GROUPBY = " "  
PRINT @@SELECTQURY + @@FROMTABLES+ @@WHEREPART+@@GROUPBY                     
      END                          
END                          
                          
IF @REPORTNAME = 'BANK BOOK'                           
BEGIN                          
   IF UPPER(@SORTBY) = 'VDT'                          
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'EDT'                          
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"                          
    ELSE IF UPPER(@SORTBY) = 'VTYPE'                          
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"                          
  ELSE IF UPPER(@SORTBY) = 'ACCODE'                          
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'ACNAME'                          
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"                          
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'                      
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"                          
       ELSE IF UPPER(@SORTBY) = 'VNO'                          
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"                          
        ELSE IF UPPER(@SORTBY) = 'DRCR'                          
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"                          
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'                          
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"                          
                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L.DRCR) ='D' THEN  VAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')  "    
  
    
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER L "                          
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "                          
         SELECT @@GROUPBY = " "                          
      END                          
   ELSE                          
      BEGIN                          
/*         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTY
                     
P=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), L.NARRATION "                          
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER WHERE CLTCODE = '" + @FCODE + "') T, LEDGER2 L2, COSTMAST C, LEDGER L " */                          
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE
   
    
                        
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */                          
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
        
                          
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE =L.CLTCODE "                           
         SELECT @@GROUPBY = " " */                          
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')"
  
    
    
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYPE, VNO, BOOKTYPE FROM LEDGER2 (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "' ) T, LEDGER2 L2 (NOLOCK) , COSTMAST C (NOLOCK) , LEDGER L  (NOLOCK) "         
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
                           
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */                          
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE<> 'HOCTRL' AND L2.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYPE AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE " SELECT @@GROUPBY = " "  END        
END                          
                           
IF @REPORTNAME = 'GL'                           
BEGIN                          
                          
/* ASSIGN FROM AND TO ACCOUNT CODES. */                          
   IF @FCODE = ""                           
      BEGIN                          
         SELECT @FCODE = (SELECT MIN(CLTCODE) FROM ACMAST WHERE ACCAT <> 4)                          
END         
                          
   IF @TCODE = ""                           
      BEGIN                          
         SELECT @TCODE = (SELECT MAX(CLTCODE) FROM ACMAST WHERE ACCAT <> 4)                          
END        
                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO, NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), ACCAT "                          
SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE ,VMAST V  (NOLOCK) "        
SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND VTYP = VTYPE AND A.CLTCODE = L.CLTCODE AND A.ACCAT <> '4' "                          
SELECT @@GROUPBY = " "                          
SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                            
      END                        
 ELSE IF UPPER(@STATUSID) = 'REGION'                      
      BEGIN                          
PRINT 'VIN'           
PRINT UPPER(@STATUSNAME)                      
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), ACCAT "                          
SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM NCDX.DBO.REGION WHERE UPPER(REGIONCODE) = '" + @STATUSNAME + "') R   "        
SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "                      

SELECT @@GROUPBY = " "    
        
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                            
  PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                 
      END                        
   ELSE                          
      BEGIN                          
                          
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT= CONVERT(VARCHAR,L.EDT,103), ACCAT "                          
        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "                          
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                      SELECT @@GROUPBY = " "                          SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"            

  
    
          PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                 
      END                          
END                          
                          
IF @REPORTNAME = 'PARTYLEDGER'                          
BEGIN                          
                          
 SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"                           
 IF UPPER(@SORTBY) = 'VDT'                          
    SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"           
   ELSE IF UPPER(@SORTBY) = 'EDT'                          
           SELECT @@SORTBY = " EFFDT, L.VTYP DESC, L.VNO"                           
                          
 IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
 SELECT @@SORTBY = " L.CLTCODE," + @@SORTBY                          
 ELSE                          
 SELECT @@SORTBY = " L2.CLTCODE," + @@SORTBY                          
                          
 IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'                          
    SELECT @@SORTBY = " ORDER BY CM.FAMILY, " + @@SORTBY                          
 ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'                          
       SELECT @@SORTBY = " ORDER BY C1.SUB_BROKER, " + @@SORTBY                          
                          
 IF LEFT(@@SORTBY,6) <> ' ORDER'                           
    SELECT @@SORTBY = " ORDER BY " + @@SORTBY                          
                                
   IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'                          
   BEGIN                          
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
         BEGIN                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                               SELECT @@FROMTABLES = " FROM LEDGER L (NOLOCK)  LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, MSAJAG.DBO.CLIENTMASTER CM "  
   
    
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = CM.PARTY_CODE"                          
            SELECT @@GROUPBY = " "                          
         END                          
      ELSE                          
         BEGIN                          
                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK) , MSAJAG.DBO.CLIENTMASTER CM   (NOLOCK)  "                            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = CM.PARTY_CODE "                                 
          SELECT @@GROUPBY = " "                           
                          
         END                            
   END                          
   ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'                          
   BEGIN                          
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                              SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "                          
           SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE " 
  
   
             SELECT @@GROUPBY = " "                          
         END                          
      ELSE                          
         BEGIN                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                    SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK) ,  " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "                    SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE "                          
           SELECT @@GROUPBY = " "                          
         END                            
   END                          
   ELSE                          
   BEGIN                          
   IF UPPER(@STATUSID) = 'BROKER' OR UPPER(@STATUSID) = 'BRANCH'                           
   BEGIN                          
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
         BEGIN                          
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "                              
    
  SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "                          
            SELECT @@GROUPBY = " "                          
         END                          
      ELSE                          
         BEGIN                          
                          
           SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "                          
    
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                                     SELECT @@GROUPBY = " "                          
            SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                          
                          
                          
         END                          
   END                          
   ELSE                          
   IF UPPER(@STATUSID) = 'SUB_BROKER'                          
   BEGIN                          
      SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                      SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST (NOLOCK) , MSAJAG.DBO.CLIENT1 C1 (NOLOCK) , MSAJAG.DBO.CLIENT2 C2  (NOLOCK) "                 
  
    
         
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE AND UPPER(SUB_BROKER) = UPPER(@STATUSNAME) AND L.VTYP = VTYPE "              SELECT @@GROUPBY = " "                END                     ELSE                     BEGIN                        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                               SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "                          
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "                          
      SELECT @@GROUPBY = " "             
   END                          
   END                          
END                          
                          
IF @REPORTNAME = 'MARGINLEDGER'                          
BEGIN                          
   IF @SELECTIONBY = 'VDT'                          
      BEGIN                          
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                          
      END                          
   ELSE                          
      BEGIN                          
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, EFFDT, L.VTYP DESC, L.VNO"                          
      END                    
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ),  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "    
         SELECT @@FROMTABLES = " FROM MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER L  (NOLOCK) ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A  (NOLOCK) ON M.PARTY_CODE = A.CLTCODE , VMAST V  (NOLOCK) "                          SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE "                          
         SELECT @@GROUPBY = " "                          
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, M.VTYP DESC, M.VNO"                          
      END                          
   ELSE                          
      BEGIN                          
                          
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ), M.VNO, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "
  
    
    SELECT @@FROMTABLES = " FROM LEDGER L, COSTMAST C, MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER2 L2  (NOLOCK) ON M.VTYP = L2.VTYPE AND M.BOOKTYPE = L2.BOOKTYPE AND M.VNO = L2.VNO AND M.LNO = L2.LNO LEFT OUTER JOIN ACMAST A  (NOLOCK) ON M.PARTY_CODE = A.CLTCODE , VMAST  V (NOLOCK)  "                        SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                               
SELECT @@GROUPBY = " "                          
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, L.VTYP DESC, L.VNO"                          
                          
                                    
      END                          
END                          
                          
--PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY                           
--SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP IN (15,21) "                          
                          
                          
--IF @STATUSID = 'BROKER'                           
--PRINT ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )                        
EXEC ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )   
  
  
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_REPORTS_17032011
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[ACC_REPORTS_17032011]            
@SDATE VARCHAR(11),            /* AS MMM DD YYYY */            
@EDATE VARCHAR(11),            /* AS MMM DD YYYY */            
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */            
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */            
@FCODE VARCHAR(10),            
@TCODE VARCHAR(10),            
@STATUSID VARCHAR(30),            
@STATUSNAME VARCHAR(30),            
@BRANCH VARCHAR(10),            
@SELECTIONBY VARCHAR(3),            
@GROUPBY VARCHAR(10),            
@SORTBY VARCHAR(50),            
@REPORTNAME VARCHAR(30),            
@REPORTOPT VARCHAR(10),            
@FLD1 VARCHAR(50),  /*  TO BE USED FOR SHAREDB IN CASE OF PARTY LEDGER */            
@FLD2 VARCHAR(10),            
@FLD3 VARCHAR(10)            
            
AS        
DECLARE            
@@OPENDATE   AS VARCHAR(11),                     
@@SELECTQURY AS VARCHAR(8000),            
@@FROMTABLES AS VARCHAR(2000),            
@@WHEREPART  AS VARCHAR(8000),            
@@GROUPBY    AS VARCHAR(200),            
@@SORTBY     AS VARCHAR(200),            
@@UALL       AS VARCHAR(20),            
@@USELECTQURY AS VARCHAR(8000),            
@@UFROMTABLES AS VARCHAR(2000),            
@@UWHEREPART  AS VARCHAR(8000),            
@@UGROUPBY    AS VARCHAR(200),            
@@USORTBY     VARCHAR(200),            
@@DATEFILTER AS VARCHAR(500),            
@@DATEFILTER1 AS VARCHAR(500),            
@@REPORTFROM AS VARCHAR(1)            
            
/* -------------------------------------------------------------------------- */            
IF @FDATE = " "             
BEGIN            
   SELECT @FDATE = @SDATE            
END            
            
IF @TDATE = " "            
BEGIN            
   SELECT @TDATE = @EDATE            
END            
            
/* GET FILTER CONDITION ON DATES BASED ON THE VALUE OF @SELECTIONBY */            
            
IF @SELECTIONBY = 'VDT'            
BEGIN            
   SELECT @@DATEFILTER = " WHERE L.VDT >= '" + @FDATE + " 00:00:00' AND L.VDT <= '" + @TDATE +" 23:59:59'"            
   SELECT @@DATEFILTER1 = "  VDT >= '" + @FDATE + " 00:00:00' AND VDT <= '" + @TDATE +" 23:59:59'"            
END            
ELSE IF @SELECTIONBY = 'EDT'            
BEGIN            
   SELECT @@DATEFILTER = " WHERE L.EDT >= '" + @FDATE + " 00:00:00' AND L.EDT <= '" + @TDATE +" 23:59:59'"            
   SELECT @@DATEFILTER1 = " EDT >= '" + @FDATE + " 00:00:00' AND EDT <= '" + @TDATE +" 23:59:59'"            
END            
/* -------------------------------------------------------------------------- */                 
            
IF @REPORTNAME = 'CASH BOOK'             
BEGIN            
            
   IF UPPER(@SORTBY) = 'VDT'            
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"            
   ELSE IF UPPER(@SORTBY) = 'EDT'            
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"            
    ELSE IF UPPER(@SORTBY) = 'VTYPE'            
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"            
  ELSE IF UPPER(@SORTBY) = 'ACCODE'            
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"            
   ELSE IF UPPER(@SORTBY) = 'ACNAME'            
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"            
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'            
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"            
       ELSE IF UPPER(@SORTBY) = 'VNO'            
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"            
        ELSE IF UPPER(@SORTBY) = 'DRCR'            
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"            
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'            
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"            
            
            
            
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
      BEGIN            
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE, ACNAME=ISNULL(ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT  ELSE  0 END), 
CREDIT = (CASE WHEN UPPER(L.DRCR) = 'D' THEN  VAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"            
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK) WHERE CLTCODE = '" + @FCODE + "' AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER L "            
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "            
         SELECT @@GROUPBY = " "             
      END            
   ELSE            
      BEGIN            
            
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE=L2.CLTCODE, ACNAME=ISNULL(L.ACNAME,''),VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT E
LSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L2.DRCR"            
           SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER2 L2, COSTMAST C, LEDGER L "            
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L2.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE
 = L.BOOKTYPE AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "            
                  SELECT @@GROUPBY = " "             
            
      END            
END            
            
IF @REPORTNAME = 'BANK BOOK'             
BEGIN            
   IF UPPER(@SORTBY) = 'VDT'            
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"            
   ELSE IF UPPER(@SORTBY) = 'EDT'            
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"            
    ELSE IF UPPER(@SORTBY) = 'VTYPE'            
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"            
  ELSE IF UPPER(@SORTBY) = 'ACCODE'            
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"            
   ELSE IF UPPER(@SORTBY) = 'ACNAME'            
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"            
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'            
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"            
       ELSE IF UPPER(@SORTBY) = 'VNO'            
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"            
        ELSE IF UPPER(@SORTBY) = 'DRCR'            
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"            
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'            
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"            
            
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
      BEGIN            
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTY
P=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L.DRCR) ='D' THEN  VAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')  "    
  
    
      
        
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER L "            
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "            
         SELECT @@GROUPBY = " "            
      END            
   ELSE            
      BEGIN            
/*         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTY
  
    
      
        
          
            
P=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), L.NARRATION "            
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER WHERE CLTCODE = '" + @FCODE + "') T, LEDGER2 L2, COSTMAST C, LEDGER L " */            
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
     
         
          
          
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */            
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
      
        
          
            
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE =L.CLTCODE "             
         SELECT @@GROUPBY = " " */            
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.
VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') 
"            
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYPE, VNO, BOOKTYPE FROM LEDGER2 (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "' ) T, LEDGER2 L2 (NOLOCK) , COSTMAST C (NOLOCK) , LEDGER L  (NOLOCK) "             
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
      
        
          
            
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */            
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYPE AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "             
                  SELECT @@GROUPBY = " "             
      END            
END            
            
IF @REPORTNAME = 'GL'             
BEGIN            
            
/* ASSIGN FROM AND TO ACCOUNT CODES. */            
   IF @FCODE = ""             
      BEGIN            
         SELECT @FCODE = (SELECT MIN(CLTCODE) FROM ACMAST WHERE ACCAT <> 4)            
      END            
            
   IF @TCODE = ""             
      BEGIN            
         SELECT @TCODE = (SELECT MAX(CLTCODE) FROM ACMAST WHERE ACCAT <> 4)            
   END            
            
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
      BEGIN            
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO, NARRATION = REPLACE
(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT =
 CONVERT(VARCHAR,L.EDT,103), ACCAT "            
        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE ,VMAST V  (NOLOCK) "            
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND VTYP = VTYPE AND A.CLTCODE = L.CLTCODE AND A.ACCAT <> '4' "            
        SELECT @@GROUPBY = " "            
        SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"              
      END          
 ELSE IF UPPER(@STATUSID) = 'REGION'        
      BEGIN            
PRINT 'VIN'        
PRINT UPPER(@STATUSNAME)        
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLAC
E(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT
 = CONVERT(VARCHAR,L.EDT,103), ACCAT "            
     SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM BSEDB_AB.DBO.REGION WHERE UPPER(REGIONCODE) = '" + @STATUSNAME + "') R   "            
             SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTY
PE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "            
                     SELECT @@GROUPBY = " "             
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"              
  PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                   
      END          
   ELSE            
      BEGIN            
            
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLAC
E(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT
 = CONVERT(VARCHAR,L.EDT,103), ACCAT "            
        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "            
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AN
D L.VNO = L2.VNO AND L.LNO = L2.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "            
                SELECT @@GROUPBY = " "             
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"              
  PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                   
      END            
END            
            
IF @REPORTNAME = 'PARTYLEDGER'            
BEGIN            
            
 SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"             
 IF UPPER(@SORTBY) = 'VDT'            
    SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"             
   ELSE IF UPPER(@SORTBY) = 'EDT'            
           SELECT @@SORTBY = " EFFDT, L.VTYP DESC, L.VNO"             
            
 IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
 SELECT @@SORTBY = " L.CLTCODE," + @@SORTBY            
 ELSE            
 SELECT @@SORTBY = " L2.CLTCODE," + @@SORTBY            
            
 IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'            
    SELECT @@SORTBY = " ORDER BY CM.FAMILY, " + @@SORTBY            
 ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'            
       SELECT @@SORTBY = " ORDER BY C1.SUB_BROKER, " + @@SORTBY            
            
 IF LEFT(@@SORTBY,6) <> ' ORDER'             
    SELECT @@SORTBY = " ORDER BY " + @@SORTBY            
                  
   IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'            
   BEGIN            
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
         BEGIN            
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((S
ELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, 
CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "            
            SELECT @@FROMTABLES = " FROM LEDGER L (NOLOCK)  LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, MSAJAG.DBO.CLIENTMASTER CM "             
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = CM.PARTY_CODE"            
            SELECT @@GROUPBY = " "            
         END            
      ELSE            
         BEGIN            
            
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "            
                        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK) , MSAJAG.DBO.CLIENTMASTER CM   (NOLOCK)  "            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE A
ND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = CM.PARTY_CODE "            
            SELECT @@GROUPBY = " "             
            
         END              
   END            
   ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'            
   BEGIN            
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
         BEGIN            
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "            
            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE "
  
    
      
        
          
            
            SELECT @@GROUPBY = " "            
         END            
      ELSE            
         BEGIN            
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "            
            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK) ,  " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2
 C2  (NOLOCK) "            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE A
ND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE "            
            SELECT @@GROUPBY = " "            
         END              
   END            
   ELSE            
   BEGIN            
   IF UPPER(@STATUSID) = 'BROKER' OR UPPER(@STATUSID) = 'BRANCH'             
   BEGIN            
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
         BEGIN            
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELEC
T MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVE
RT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "            
            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "            
            SELECT @@GROUPBY = " "            
         END            
      ELSE            
         BEGIN            
            
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "            
            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE A
ND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "            
            SELECT @@GROUPBY = " "            
            SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"            
            
            
         END            
   END            
   ELSE            
   IF UPPER(@STATUSID) = 'SUBBROKER'            
   BEGIN            
      SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT M
AX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDI
FF(D,L.EDT,GETDATE()) "            
      SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST (NOLOCK) , MSAJAG.DBO.CLIENT1 C1 (NOLOCK) , MSAJAG.DBO.CLIENT2 C2  (NOLOCK) "            
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE AND UPPER(SUB_BROKER) = UPPER('" + @STATUSNAME + "')
AND L.VTYP = VTYPE "            
            SELECT @@GROUPBY = " "            
   END            
   ELSE            
   BEGIN            
      SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT M
AX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDI
FF(D,L.EDT,GETDATE()) "            
            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "            
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "            
      SELECT @@GROUPBY = " "            
   END            
   END            
END            
            
IF @REPORTNAME = 'MARGINLEDGER'            
BEGIN            
   IF @SELECTIONBY = 'VDT'            
      BEGIN            
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"            
      END            
   ELSE            
      BEGIN            
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, EFFDT, L.VTYP DESC, L.VNO"            
      END            
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'             
      BEGIN            
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ), 
 M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "
  
           
     
      
        
          
           
         SELECT @@FROMTABLES = " FROM MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER L  (NOLOCK) ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A  (NOLOCK) ON M.PARTY_CODE = A.CLTCODE , VMAST V  
(NOLOCK) "            
         SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE "            
         SELECT @@GROUPBY = " "            
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, M.VTYP DESC, M.VNO"            
      END            
   ELSE            
      BEGIN            
            
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ),M
.VNO, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT " 
 
      
        
                    
         SELECT @@FROMTABLES = " FROM LEDGER L, COSTMAST C, MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER2 L2  (NOLOCK) ON M.VTYP = L2.VTYPE AND M.BOOKTYPE = L2.BOOKTYPE AND M.VNO = L2.VNO AND M.LNO = L2.LNO LEFT OUTER JOIN ACMAST A  (NOLOCK) ON M.PARTY
_CODE = A.CLTCODE , VMAST  V (NOLOCK)  "            
         SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.
LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "            
         SELECT @@GROUPBY = " "            
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, L.VTYP DESC, L.VNO"            
            
                      
      END            
END            
            
--PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY             
--SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP IN (15,21) "            
            
            
--IF @STATUSID = 'BROKER'             
--PRINT ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )          
EXEC ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_valansum
-- --------------------------------------------------
  CREATE PROC acc_valansum  
@branchcd as varchar(10),  
@opendate as varchar(11),  
@closdate as varchar(11),  
@vtyp as varchar(2),  
@booktype varchar(2),  
@vno  varchar(12),  
@reportoption char(1),  
@baloption char(1),  
@sortby varchar(10)  
as  
  
declare   
@@opbaldt as varchar(11),  
@@wherepart as varchar(200),  
@@frompart  as varchar(300),  
@@selectpart as varchar(1000),  
@@clbalpart  as varchar(1000),  
@@addwhere   as varchar(100),  
@@orderbypart as varchar(100)  
  
select @@opbaldt = (select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l   
                    where vtyp = 18 and vdt <= @opendate)  
  
if @reportoption = 'P'  
   begin  
      select @@addwhere = " and a.accat in ( '4', '104')"  
   end  
else if @reportoption = 'O'  
   begin  
      select @@addwhere = " and a.accat not in ( '4', '104')"  
   end  
else  
   begin  
      select @@addwhere = " "  
   end  
  
if rtrim(@branchcd) = '%'   
   begin  
 select @@selectpart = "select l.cltcode, a.acname, dramt = isnull((case when upper(drcr) = 'D' then vamt else 0 end ),0), cramt = isnull((case when upper(drcr) = 'C' then vamt else 0 end ),0), left(convert(varchar,vdt,103),10) vdt, "  
 select @@clbalpart = " clbal =  ( select sum( case when upper(drcr) = 'D' then vamt else -vamt end) from ledger where vdt >= '" + rtrim(@@opbaldt) + " 00:00:00' and vdt <= '" + rtrim(@closdate) + " 23:59:59' and cltcode = l.cltcode )"  
 select @@frompart = " from ledger l left outer join acmast a on l.cltcode = a.cltcode "  
 select @@wherepart = " where l.vtyp = " + @vtyp + " and l.booktype = '" + @booktype + "' and l.vno = '" + @vno + "'"  
        if upper(rtrim(@sortby)) = 'ACCODE'  
       select @@orderbypart = " Order by l.cltcode "  
        else if upper(rtrim(@sortby)) = 'ACNAME'  
        select @@orderbypart = " Order by a.acname "  
             else if upper(rtrim(@sortby)) = 'DRCR'  
        select @@orderbypart = " Order by l.drcr "  
   end  
else  
   begin  
 select @@selectpart = " select l2.cltcode, a.acname, dramt = isnull((case when upper(drcr) = 'D' then camt else 0 end ),0),cramt = isnull((case when upper(drcr) = 'C' then camt else 0 end ),0), "  
 select @@clbalpart = " clbal =  ( select sum( case when upper(ll2.drcr) = 'D' then camt else -camt end) from ledger2 ll2 left outer join ledger l on ll2.vtype = l.vtyp and ll2.booktype = l.booktype and ll2.vno = l.vno and ll2.lno = l.lno where l.vdt >= '
" + rtrim(@@opbaldt) + " 00:00:00' and l.vdt <= '" + rtrim(@closdate) + " 23:59:59' and ll2.cltcode = l2.cltcode )"  
 select @@frompart = " from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, costmast c "  
 select @@wherepart = " where l2.vtype = " + @vtyp + " and l2.booktype = '" + @booktype + "' and l2.vno = '" + @vno + "'"  
 select @@addwhere = @@addwhere + " and l2.costcode = c.costcode and c.costname = '" + rtrim(@branchcd) + "' "  
        if upper(rtrim(@sortby)) = 'ACCODE'  
       select @@orderbypart = " Order by l2.cltcode "  
        else if upper(rtrim(@sortby)) = 'ACNAME'  
        select @@orderbypart = " Order by a.acname "  
             else if upper(rtrim(@sortby)) = 'DRCR'  
        select @@orderbypart = " Order by l2.drcr "  
   end  
  
print @@selectpart + @@clbalpart + @@frompart + @@wherepart + @@addwhere + @@orderbypart  
  
exec ( @@selectpart + @@clbalpart + @@frompart + @@wherepart + @@addwhere + @@orderbypart )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AccountDrCrEdtSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AccountDrCrEdtSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AccountDrCrEdtSp    Script Date: 03/20/2002 11:33:45 AM ******/
/****** Object:  Stored Procedure dbo.AccountDrCrEdtSp    Script Date: 03/12/02 3:10:20 PM ******/
/************************************************************************************************************************************************************************************************
Created by vaishali on 28/02/2001 Calculated the debit and credit amount for client
Recent Changes are done by Vaishali on 19/11/2001 This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE AccountDrCrEdtSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
--COMMENTED BY SHEETAL ON 15-02-2002  ADDED FROM DATE AND TO DATE AS PARAMETERS 
/*
@tdate as varchar(21),
@fromparty varchar(10),
@toparty varchar(10),
@fromamt money,
@toamt money,
@flag tinyint
AS
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit) - Sum(credit),2) ) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
Check On AcNAme
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag =13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AccountDrCrSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AccountDrCrSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AccountDrCrSp    Script Date: 03/20/2002 11:33:45 AM ******/
/****** Object:  Stored Procedure dbo.AccountDrCrSp    Script Date: 03/12/02 3:10:20 PM ******/
/************************************************************************************************************************************************************************************************
Created by vaishali on 28/02/2001 Calculated the debit and credit amount for client
Recent Changes are done by Vaishali on 19/11/2001 This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE AccountDrCrSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit))
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
--COMMENTED BY SHEETAL ON 15-02-2002  ADDED FROM DATE AND TO DATE AS PARAMETERS 
/*
@tdate as varchar(21),
@fromparty varchar(10),
@toparty varchar(10),
@fromamt money,
@toamt money,
@flag tinyint
AS
if @flag = 1
begin
	
end
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat <> '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AcmastMultiCompSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 01/04/1980 1:40:34 AM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 29-Sep-01 8:12:01 PM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.AcmastMultiCompSp    Script Date: 20-Mar-01 11:43:32 PM ******/
/*Created by vaishali  on 26/12/2000
Used in Acmastadd control to check the validity of entered account database
*/
CREATE PROCEDURE AcmastMultiCompSp 
@accdatabase as varchar(10)
 AS
select * from msajag.dbo.multicompany where accountdb = @accdatabase

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.acname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.acname    Script Date: 01/04/1980 1:40:34 AM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 29-Sep-01 8:12:01 PM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.acname    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE acname
@clcode varchar(6)
AS
select distinct acname from ledger, ncdx.dbo.client1
where cl_code= @clcode  and acname=short_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AcNameCodeSelect
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AcNameCodeSelect    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AcNameCodeSelect    Script Date: 02/22/2002 1:56:02 PM ******/
CREATE Proc AcNameCodeSelect
@branch varchar(20)
AS
select distinct cltcode,acname from ledger, msajag.dbo.clientmaster
where cltcode = party_code and branch_cd = @branch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AcnameSelect
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 02/26/1980 1:57:20 AM ******/
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 11/24/2001 10:30:11 AM ******/
/* Modified by Vaishali on 05/11/2001 Added flags from 4 to 6*/
/****** Object:  Stored Procedure dbo.AcnameSelect    Script Date: 10/08/2001 3:11:54 AM ******/
CREATE Proc AcnameSelect
@flag integer
As
If @flag = 1 
begin 	
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        catmast c where c.accat = a.accat and c.accat not in  ('1','2','14') 
        order by acname 
end
else if @flag = 2
begin
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat not in  ('14') 
        	order by acname 
end  
else if @flag = 3
begin
        Select acname,a.accat,actyp,catname,cltcode from acmast a,
        catmast c where c.accat = a.accat and c.accat  in  ('4') 
        order by acname 
end  
else if @flag = 4  /* For selecting Cash name and code*/
begin
	Select acname,cltcode from acmast 
        	where  accat  =  '1'         	
end
else if @flag = 5 /* For selecting Bank name and code*/
begin
	Select acname,cltcode from acmast 
        	where  accat  =  '2'         	
end
else if @flag = 6   /* For selecting Party name and code*/
begin
	Select acname,cltcode from acmast 
        	where  accat  =  '4'         	
end
else if @flag = 7   /* For selecting all accounts other than party */
begin
	Select acname,cltcode from acmast 
        	where  accat <> '4'         	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Insert
-- --------------------------------------------------

CREATE Proc Add_Client_Account_Proc_Insert (
@Exchange Varchar(3), 
@Segment Varchar(7), 
@Branch_Cd Varchar(10), 
@FromParty Varchar(10),
@ToParty Varchar(10),
@MainDate Varchar(30),
@DetDate Varchar(30)
) As

Update Owner Set Companyname = companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update
-- --------------------------------------------------
CREATE  Proc Add_Client_Account_Proc_Update (      
@Exchange Varchar(3),       
@Segment Varchar(7),       
@Branch_Cd Varchar(10),       
@FromParty Varchar(10),      
@ToParty Varchar(10),      
@MainDate Varchar(30),      
@DetDate Varchar(30)      
) As      
      
Delete From AcMast      
Where CltCode In ( Select Party_Code       
                   From NCDX.DBO.Client_Details_Tmp C, NCDX.DBO.Client_Brok_Details_Tmp D      
                   Where D.Exchange = @Exchange And D.Segment = @Segment        
     And C.Cl_Code = D.Cl_Code)      
      
Insert into AcMast      
Select ACName = Long_Name, LongName = Long_Name,   
ACTyp = (Case When Cl_Type ='SBD' Then 'LIABILITIE' Else 'ASSET' End),       
ACCat = (Case When Cl_Type ='SBD' Then '3' Else '4' End),   
FamilyCd = '', CltCode = Party_Code, AccDtls = '',   
GrpCode = (Case When Cl_Type ='SBD' Then 'L0704000000' Else 'A0307000000' End),       
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,       
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No      
From NCDX.DBO.Client_Details_Tmp C, NCDX.DBO.Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code   
   
Insert into MultiBankId  
SELECT Party_code,BankID=P.BankID,CltDpId=AC_Num,        
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'         
                        When Ac_Type = 'C' Then 'CURRENT'         
                        Else 'OTHER' End), 'OTHER'),  
Long_Name, DEF=1  
From NCDX.DBO.Client_Details_Tmp C, NCDX.DBO.Client_Brok_Details_Tmp D, NCDX.DBO.POBank P        
Where D.Exchange = @Exchange And D.Segment = @Segment          
And C.Cl_Code = D.Cl_Code        
And Ac_Type <> ''        
And C.Party_Code Not In (Select CltCode From MultiBankId )  
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update_new
-- --------------------------------------------------
 /****** Object:  Stored Procedure dbo.Add_Client_Account_Proc_Update    Script Date: 01/18/2006 13:34:59 ******/  
CREATE  Proc Add_Client_Account_Proc_Update (    
@Exchange Varchar(3),     
@Segment Varchar(7),     
@Branch_Cd Varchar(10),     
@FromParty Varchar(10),    
@ToParty Varchar(10),    
@MainDate Varchar(30),    
@DetDate Varchar(30)    
) As    
    
Delete From AcMast    
Where CltCode In ( Select Party_Code     
                   From NCDX.DBO.Client_Details_Tmp C, ncdx.DBO.Client_Brok_Details_Tmp D    
                   Where D.Exchange = @Exchange And D.Segment = @Segment      
     And C.Cl_Code = D.Cl_Code)    
    
Insert into AcMast    
Select ACName = Long_Name, LongName = Long_Name, ACTyp = 'ASSET',     
ACCat = '4', FamilyCd = '', CltCode = Party_Code, AccDtls = '', GrpCode = 'A0307000000',     
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,     
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No    
From ncdx.DBO.Client_Details_Tmp C, ncdx.DBO.Client_Brok_Details_Tmp D    
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code     
    
  
  
  
Insert into MultiBankId
SELECT Party_code,BankID=P.BankID,CltDpId=AC_Num,      
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'       
                        When Ac_Type = 'C' Then 'CURRENT'       
                        Else 'OTHER' End), 'OTHER'),
Long_Name, DEF=1
From ncdx.DBO.Client_Details_Tmp C, ncdx.DBO.Client_Brok_Details_Tmp D, ncdx.DBO.POBank P      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code      
And Ac_Type <> ''      
And C.Party_Code Not In (Select CltCode From MultiBankId )
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_client_proc_account_acmast_insert
-- --------------------------------------------------

Create   Proc Add_client_proc_account_acmast_insert As
/* Acmast Query */
 Insert Into Acmast
  Select
   Tmplongname, Tmplongname, Actyp = 'Asset', Accat = '4', Familycd = '', Tmppartycode, Accdtls = '', 
   Grpcode = 'A0307000000', Booktype = '', Micrno = '0', Tmpbranchcode, 
   Tmpb2bpayment, Tmppaymentmode, 
   Tmppaymentbankname = 
   /*bank Name Fixed For Anagram - Nse*/
    (Select Ltrim(Rtrim(Acname)) From Account.Dbo.Acmast
    Where
     Charindex('&', Acname) = 0 And 
     Cltcode = '995116' And
     Accat = 2), 
   Tmppaymentbranchname, 
   Tmppaymentacno = 
   /*bank Code Fixed For Anagram - Nse*/
    (Select Ltrim(Rtrim(Cltcode)) From Account.Dbo.Acmast
    Where
     Charindex('&', Acname) = 0 And 
     Cltcode = '995116' And
     Accat = 2)
 From
  Msajag.Dbo.Tmp_client_details
 Where
  Tmppartycode Not In (Select Party_code From Msajag.Dbo.Clientmaster)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AdjDaysCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 29-Sep-01 8:12:01 PM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.AdjDaysCursor    Script Date: 20-Mar-01 11:43:32 PM ******/
/* this procedure is used to adjust the balances of the parties datewise  */
CREATE PROCEDURE  AdjDaysCursor AS
declare    @@code varchar(12),
@@tcltcodecur cursor    
set @@tcltcodecur = cursor for 
                 select distinct cltcode from ledger 
                 open @@tcltcodecur
fetch next  from @@tcltcodecur into   @@code
while   @@fetch_status =0
begin
         exec spadjDaysCursor @@code
         fetch next  from @@tcltcodecur into   @@code
end
close @@tcltcodecur
deallocate @@tcltcodecur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AdjNextBalCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.AdjNextBalCursor    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.AdjNextBalCursor    Script Date: 01/04/1980 1:40:35 AM ******/
/* This procedure is used to adjust the balance amount of  all the parties according to the dates 
   After 
*/
CREATE PROCEDURE AdjNextBalCursor    
@code varchar(10),
@sdtcur datetime
 AS
declare @@tbalamt numeric(17,4)   ,
@@tdrcr varchar(1),
@@vtyp as smallint,
@@vno as numeric(12,0),
@@tvdt datetime  ,
@@tvamt numeric(17,4),
@@tcur cursor    
                 
	select @@tbalamt=0
        	set @@tcur = cursor for 
	
	/*Get balance amount of the opening entry*/	
	select  isnull(balamt,0) from ledger 
	where cltcode= @code and vdt >= @sdtcur  
	and vtyp = 18
	open @@tcur
	fetch next  from @@tcur into   @@tbalamt
	if @@fetch_status <> 0 
	begin
		select @@tbalamt=0
	end	
	close @@tcur
	deallocate @@tcur
	
	
	/*get all the accounts transactions except opening entry*/
	
	set @@tcur = cursor for 
	select drcr,vamt ,vtyp,vno, vdt  from ledger 
        	where cltcode= @code and vdt >= @sdtcur 
	and vtyp <> 18
	order by vdt,vtyp, vno
	open @@tcur
	fetch next  from @@tcur into   @@tdrcr ,@@tvamt  , @@vtyp,@@vno ,@@tvdt
	
	while   @@fetch_status =0
	begin
                		
		if  @@tdrcr='c' 
                		begin
                			select  @@tvamt  = 0  -   @@tvamt
                		end
                		Select   @@tbalamt =   @@tbalamt   +   @@tvamt 
           		
		
           		update ledger set balamt =   @@tbalamt   
	 	where  vtyp = @@vtyp and vno = @@vno and drcr = @@tdrcr  AND VDT = @@tvdt and cltcode = @code/*current of  @@tcur*/
   		fetch next  from @@tcur into   @@tdrcr ,@@tvamt  ,@@vtyp,@@vno,  @@tvdt 
	end
	
	close @@tcur
	deallocate @@tcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Ageingcursor    Script Date: 1/17/2004 11:39:07 PM ******/  
  
/****** Object:  Stored Procedure dbo.Ageingcursor    Script Date: 04/24/2003 5:37:46 PM ******/  
/****** Object:  Stored Procedure dbo.Ageingcursor    Script Date: 04/07/2003 11:54:17 AM ******/  
--exec Ageingcursor 'HB00', 'HB34', 'Apr  1 2005', 'Oct 14 2005', 'party' , '%','','963279163', 'A'  
CREATE Procedure Ageingcursor   
@fromparty varchar(10),  
@toparty varchar(10),   
@opendate varchar(11),  
@todate varchar(11),  
@Reporttype varchar(15),  
@Branch varchar(10),  
@family varchar(10),  
@sessionid varchar(30),  
@ageoption varchar(1)  
as  
declare   
@@balcur as cursor,  
@@baldate as varchar(11),  
@@openbaldt as varchar(11),  
@@balamt as money,  
@@ocltcode as varchar(10),  
@@vtyp as smallint,  
@@vno varchar(12),  
@@vdt as DATETIME,  
@@vamt as money,  
@@closbal as money,  
@@cltcode as varchar(10),  
@@Branchcode as varchar(10),  
@@drcr    as varchar(1),  
@@startdt as datetime  
Set nocount on  
/*select @@startdt = ( select left(convert(varchar,dateadd(mm,-6,convert(datetime,@todate)),109),11) )*/  
select @@startdt = @opendate  
if upper(@Branch) = 'ALL'  
begin   
   select @@branchcode = '%'  
end  
else  
begin  
   select @@branchcode = rtrim(@branch)  
end  
--if exists (select * from sysobjects where id = object_id(N'[dbo].[tempageing]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)  
--drop table [dbo].[tempageing]  
/*truncate table  tempageing  
truncate table  fintempageing  
*/  
delete from tempageing where rtrim(sessionid) = rtrim(@sessionid)  
delete from fintempageing where rtrim(sessionid) = rtrim(@sessionid)  
/* to Get O/p balance date */  
-- Print 'Truncated tables '  
  set @@balcur = cursor for  
  select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l  
  where vtyp = 18 and vdt < = @opendate  
  open @@balcur  
  fetch next from @@balcur into  @@openbaldt  
  close @@balcur  
  deallocate @@balcur  
select @@openbaldt  
if upper(@Reporttype) = 'PARTY'  
begin  
   insert into tempageing  
   select l.cltcode, baldate=@todate, closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0, @sessionid  
   from ledger l left outer join acmast on l.cltcode = acmast.cltcode  
   where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'   
   and l.cltcode >= @fromparty and l.cltcode <= @toparty and acmast.branchcode like @@branchcode+'%' and acmast.accat = 4  
   group by l.cltcode  
   order by l.cltcode  
end  
else if upper(@Reporttype) = 'FAMILY'  
begin  
/*   select family as cltcode, baldate=@todate, closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0  
   into tempageing  
   from ledger l left outer join acmast on l.cltcode = acmast.cltcode, msajag.dbo.clientmaster c  
   where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'  
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty and acmast.accat = 4  
   and acmast.branchcode like @@branchcode+'%'     
   group by family   
   order by family  */  
   Insert into  tempageing   
   Select Family as cltcode, baldate=@todate, closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0, @sessionid  
   /* into tempageing */  
   from ledger l left outer join acmast on l.cltcode = acmast.cltcode, msajag.dbo.clientmaster c  
   where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'  
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty and acmast.accat = 4  
   and acmast.branchcode like @@branchcode+'%'     
   group by family   
   order by family   
end  
else if upper(@Reporttype) = 'FAMILYPARTY'  
begin  
   insert into tempageing  
   select l.cltcode, baldate=@todate, closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0, @sessionid  
   from ledger l left outer join acmast on l.cltcode = acmast.cltcode, msajag.dbo.clientmaster c  
   where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'   
   and l.cltcode >= @fromparty and l.cltcode <= @toparty and acmast.branchcode like @@branchcode+'%' and acmast.accat = 4  
   and l.cltcode = c.party_code and family = @family   
   group by l.cltcode  
   order by l.cltcode  
end  
if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'  
begin  
  if upper(rtrim(@ageoption)) = 'D'  
     begin  
 set @@balcur = cursor for  
 select l.cltcode, vtyp, vno, vdt, vamt, closbal  
 from ledger l, tempageing a  
 where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end ) and l.cltcode = a.cltcode  
 and vdt >= @@startdt + ' 00:00:00' and vdt <= @todate  + ' 23:59:59' and a.sessionid = @sessionid  
 and vtyp <> 18  
 order by l.cltcode, vdt desc, vtyp, vno   
     end  
  else if upper(rtrim(@ageoption)) = 'C'  
     begin  
 set @@balcur = cursor for  
 select l.cltcode, vtyp, vno, vdt, vamt, closbal  
 from ledger l, tempageing a  
 where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end ) and l.cltcode = a.cltcode  
 and vdt >= @@startdt + ' 00:00:00' and vdt <= @todate  + ' 23:59:59' and a.sessionid = @sessionid  
 and vtyp <> 18  
 order by l.cltcode, vdt desc, vtyp, vno   
     end  
  else  
     begin  
 set @@balcur = cursor for  
 select l.cltcode, vtyp, vno, vdt, vamt, closbal  
 from ledger l, tempageing a  
 where drcr = ( case when closbal >= 0 then 'd' else 'c' end ) and l.cltcode = a.cltcode  
 and vdt >= @@startdt + ' 00:00:00' and vdt <= @todate  + ' 23:59:59' and a.sessionid = @sessionid  
 and vtyp <> 18  
 order by l.cltcode, vdt desc, vtyp, vno   
     end  
end  
else  
begin  
  if upper(rtrim(@ageoption)) = 'D'   
     begin  
 set @@balcur = cursor for  
 select cltcode=family, vtyp, vno, vdt, vamt, closbal  
 from ledger l, msajag.dbo.clientmaster c left outer join tempageing a on a.cltcode = family  
 where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
 and vdt >= @@startdt + ' 00:00:00' and vdt <= @todate  + ' 23:59:59'   
 and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty   
 and a.sessionid = @sessionid  
 and vtyp <> 18  
 order by cltcode, vdt desc, vtyp, vno  
     end  
   else if upper(rtrim(@ageoption)) = 'C'  
     begin  
 set @@balcur = cursor for  
 select cltcode=family, vtyp, vno, vdt, vamt, closbal  
 from ledger l, msajag.dbo.clientmaster c left outer join tempageing a on a.cltcode = family  
 where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
 and vdt >= @@startdt + ' 00:00:00' and vdt <= @todate  + ' 23:59:59'   
 and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty   
 and a.sessionid = @sessionid  
 and vtyp <> 18  
 order by cltcode, vdt desc, vtyp, vno  
     end  
   else  
     begin  
 set @@balcur = cursor for  
 select cltcode=family, vtyp, vno, vdt, vamt, closbal  
 from ledger l, msajag.dbo.clientmaster c left outer join tempageing a on a.cltcode = family  
 where drcr = ( case when closbal >= 0 then 'd' else 'c' end )   
 and vdt >= @@startdt + ' 00:00:00' and vdt <= @todate  + ' 23:59:59'   
 and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty   
 and a.sessionid = @sessionid  
 and vtyp <> 18  
 order by cltcode, vdt desc, vtyp, vno  
     end  
end  
  open @@balcur  
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@vdt, @@vamt, @@closbal  
  while @@fetch_status = 0  
 begin  
--                Select @@cltcode, @@vtyp, @@vno, @@vdt, @@vamt, @@closbal    
  select @@ocltcode = @@cltcode   
  select @@balamt = abs(@@closbal)  
  if @@closbal >= 0   
     begin  
     select @@drcr = 'd'  
     end  
  else  
     begin  
     select @@drcr = 'c'  
     end  
    
  while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0  
   begin  
    if @@balamt >= @@vamt   
     begin  
      insert into fintempageing   
      select @@cltcode, @@vamt, datediff(day,@@vdt,@todate), @@drcr, @sessionid  
      select @@balamt = @@balamt - @@vamt  
     end  
    else  
     begin  
      insert into fintempageing   
      select @@cltcode, @@balamt, datediff(day,@@vdt,@todate), @@drcr, @sessionid  
      select @@balamt = @@balamt - @@vamt  
     end  
      fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@vdt, @@vamt, @@closbal  
                 
   end  
                if @@balamt > 0  
                   begin  
   insert into fintempageing   
   select @@ocltcode, @@balamt, 181, @@drcr, @sessionid  
   select @@balamt = @@balamt - @@vamt  
                   end  
  while @@fetch_status = 0 and @@ocltcode = @@cltcode    
  begin  
    fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@vdt, @@vamt, @@closbal  
  end  
 end  
  close @@balcur  
  deallocate @@balcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB
-- --------------------------------------------------

--exec Ageingcursor_NEW1_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'  
--exec Ageingcursor 'A372', 'A372', 'Apr  1 2004', 'Mar 31 2005',	'party' , '%','','1015343858', 'D'
CREATE Procedure Ageingcursor_NEW1_SB
@fromparty varchar(10),      
@toparty varchar(10),       
@opendate varchar(11),      
@todate varchar(11),      
@Reporttype varchar(15),      
@family varchar(10),      
@amoutgtthan money,      
@ageoption varchar(1),      
@dttype varchar(3),  
@statusid varchar(10),  
@statusname varchar(25),  
@Days1 Int = 6,  
@Days2 Int = 29,  
@Days3 Int = 90,  
@Days4 Int = 180,  
@Days5 Int = 181,  
@FrSb Varchar(10) = '0',  
@ToSb Varchar(10) = 'ZZZZ'  
  
  
  
as  
  
declare  
@@balcur as cursor,      
@@baldate as varchar(11),      
@@openbaldt as varchar(11),      
@@balamt as money,      
@@ocltcode as varchar(10),      
@@vtyp as smallint,      
@@vno varchar(12),      
@@EVdt as DATETIME,      
@@vamt as money,      
@@closbal as money,      
@@cltcode as varchar(10),      
@@Branchcode as varchar(25),      
@@area as varchar(25),  
@@drcr    as varchar(1),      
@@startdt as datetime  
    
Print 'Strated '     
Print convert(datetime,getdate(),113)    
    
Set nocount on      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )      
      
      
if upper(@statusid) = 'BROKER'      
begin       
 select @@branchcode = '%'       
 select @@area = '%'       
end      
else if upper(@statusid) = 'BRANCH'      
begin      
 select @@branchcode = rtrim(@statusname)      
 select @@area = '%'       
end   
else if upper(@statusid) = 'AREA'      
begin      
 select @@branchcode = '%'  
 select @@area = rtrim(@statusname)  
end   
      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from Ledger where 1=2    
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from Ledger where 1=2    
  
Select * into #Ledger from Ledger where 1=2  
  
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from Ledger where 1=2  
      
if @dttype='vdt'  
begin  
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from Ledger where vtyp = '18' and vdt < = @opendate   
   
 if upper(@Reporttype) = 'PARTY'  
 begin  
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, NCDX.dbo.client1 c1, NCDX.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
/*    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where l.cltcode = c2.party_code  
  and c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode       
*/    
    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode       
 end  
  
 else if upper(@Reporttype) = 'FAMILY'  
 begin  
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l,  NCDX.dbo.client1 c1, NCDX.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
/*    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l,  nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by family       
  order by family  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
   closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode       
  order by cltcode  
    
 end  
  
 else if upper(@Reporttype) = 'FAMILYPARTY'  
 begin  
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, NCDX.dbo.client1 c1, NCDX.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
/*    
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
    
  insert   into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c1, nsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'  
  and l.cltcode = c2.party_code and c1.family = @family  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
   closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode      
    
 end  
  
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)       */
 END      
  
 else      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from NCDX.dbo.client2 c2, NCDX.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)       
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'  
  and cltcode in (select party_code from nsefo.dbo.client2 c2, nsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */
 END      
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode     
   and vdt <= @todate  + ' 23:59:59'       
   --  
   and vtyp <> '18'      
   order by l.cltcode, vdt desc, vtyp, vno  
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and vdt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'    
   order by l.cltcode, vdt desc, vtyp, vno       
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, #tempageing a  
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and vdt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'   
   order by l.cltcode, vdt desc, vtyp, vno       
  end  
 end  
   
 else      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, NCDX.dbo.clientmaster c,  #tempageing a where a.cltcode = family      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal   
   from #Ledger l, NCDX.dbo.clientmaster c, #tempageing a where  a.cltcode = family      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal      
   from #Ledger l, NCDX.dbo.clientmaster c, #tempageing a where a.cltcode = family      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and vdt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, vdt desc, vtyp, vno      
  end  
 end  
  
end  
  
else  
begin  
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from Ledger where vtyp = '18' and edt < = @opendate  
  
 if upper(@Reporttype) = 'PARTY'  
 begin  
  insert   into #tempageing1   
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, acmast a, NCDX.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
/*       
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, accountbse.dbo.acmast a, bsedb.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
    
  insert   into #tempageing1       
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, accountfo.dbo.acmast a, nsefo.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'       
  and a.accat = 4  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
    
 end  
  
 else if upper(@Reporttype) = 'FAMILY'  
 begin  
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l,  NCDX.dbo.client1 c --NCDX.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
/*    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c--bsedb.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
    
  insert   into #tempageing1      
  Select Family as cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l,  nsefo.dbo.client1 c--nsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty      
  and c.Branch_cd like @@branchcode+'%'   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by family       
  order by family  
*/    
    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
    
 end  
   
 else if upper(@Reporttype) = 'FAMILYPARTY'  
 begin  
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Ledger l, NCDX.dbo.client1 c--NCDX.dbo.clientmaster c    
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'  
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode      
/*    
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c--bsedb.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode           
    
  insert into #tempageing1  
  select l.cltcode, baldate=@todate,       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0      
  from Accountfo.dbo.Ledger l, nsefo.dbo.client1 c--nsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty   
  and c.Branch_cd like @@branchcode+'%'  
  and l.cltcode = c.cl_code and c.family = @family       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb  
  group by l.cltcode      
  order by l.cltcode  
*/    
  insert   into #tempageing    
  select cltcode, baldate=@todate,       
  closbal = sum(closbal),agedays=0      
  from #tempageing1      
  group by cltcode      
  order by cltcode   
   
 end  
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)      
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)      
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (Select distinct cltcode from #tempageing)     */
 END  
       
 else      
 BEGIN      
  insert into #Ledger   
  select * from Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from NCDX.dbo.client2 c2, NCDX.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
/*    
  insert into #Ledger   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from NCDX.dbo.client2 c2, NCDX.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  
    
  insert into #Ledger   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'   
  and cltcode in (select party_code from NCDX.dbo.client2 c2, NCDX.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */
 END      
   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'      
 begin      
  if upper(rtrim(@ageoption)) = 'D'  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode     
   and edt <= @todate  + ' 23:59:59'       
   --  
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledgeredt l, #tempageing a      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and edt <= @todate  + ' 23:59:59'      
   --  
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno    
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select l.cltcode, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, #tempageing a      
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and l.cltcode = a.cltcode      
   and edt <= @todate  + ' 23:59:59'      
   --   
   and vtyp <> '18'      
   order by l.cltcode, edt desc, vtyp, vno   
  end  
 end  
   
 else      
 begin      
  if upper(rtrim(@ageoption)) = 'D'       
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, NCDX.dbo.clientmaster c,  #tempageing a where a.cltcode = family      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
   
  else if upper(rtrim(@ageoption)) = 'C'  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal   
   from #Ledger l, NCDX.dbo.clientmaster c, #tempageing a where  a.cltcode = family      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
   
  else  
  begin  
   insert into #LedgerCursor     
   select cltcode=family, vtyp, vno, edt, vamt, closbal      
   from #Ledger l, NCDX.dbo.clientmaster c, #tempageing a where a.cltcode = family      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )       
   and edt <= @todate  + ' 23:59:59'       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty       
   --  
   and vtyp <> '18'      
   order by cltcode, edt desc, vtyp, vno      
  end  
 end  
end  
      
      
Print 'Filled LedgerCursor'     
Print convert(datetime,getdate(),113)    
    
set @@balcur = cursor for      
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno    
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2      
      
print 'opening cursor'      
      
open @@balcur  
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal       
  
while @@fetch_status = 0     
begin       
 select @@ocltcode = @@cltcode       
  select @@balamt = abs(@@closbal)      
 if @@closbal >= 0       
 begin      
  select @@drcr = 'd'      
 end   
     else      
 begin      
       select @@drcr = 'c'      
 end  
  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0      
 begin      
  if @@balamt >= @@vamt       
  begin    
   insert into #fintempageing      
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr       
   select @@balamt = @@balamt - @@vamt     
  end      
  
  else      
  begin      
   insert into #fintempageing      
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr       
   select @@balamt = @@balamt - @@vamt       
  end      
  
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal       
 end      
  
 if @@balamt > 0      
 begin    
   insert into #fintempageing      
   select @@ocltcode, @@balamt, 181, @@drcr       
   select @@balamt = @@balamt - @@vamt      
 end      
  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  
 begin    
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal      
 end      
end  
      
close @@balcur      
deallocate @@balcur      
      
print 'cursor closed'      
Print convert(datetime,getdate(),113)    
      
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist      
from #fintempageing   
where agedays >= 0 and agedays <= @Days1  
group by cltcode, drcr      
order by cltcode, drcr      
      
insert into #ageinglist     
select cltcode, balance=sum(balamt), agedays = @Days2, drcr       
from #fintempageing      
where agedays >= @Days1+1 and agedays <= @Days2  
group by cltcode, drcr       
order by cltcode, drcr      
      
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days3, drcr       
from #fintempageing      
where agedays >= @Days2+1 and agedays <= @Days3  
group by cltcode, drcr       
order by cltcode, drcr       
  
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days4, drcr       
from #fintempageing      
where agedays >= @Days3+1 and agedays <= @Days4  
group by cltcode, drcr       
order by cltcode, drcr       
      
insert into #ageinglist      
select cltcode, balance=sum(balamt), agedays = @Days5, drcr       
from #fintempageing      
where agedays >= @Days5  
group by cltcode, drcr       
order by cltcode, drcr       
  
print 'done'      
Print convert(datetime,getdate(),113)    
      
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, b.branch, s.name  
from #ageinglist a1, NCDX.dbo.client1 a2, NCDX.dbo.subbrokers s, NCDX.dbo.branch b--NCDX.dbo.clientmaster a2--account.dbo.acmast  a2       
where balance >= @amoutgtthan and       
a1.cltcode = a2.cl_code  
and a2.branch_cd = b.branch_code  
and a2.sub_broker = s.sub_broker  
order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name  
      
drop table #tempageing      
drop table #Ledger      
drop table #LedgerCursor       
drop table #ageinglist      
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB_angel
-- --------------------------------------------------


CREATE Procedure Ageingcursor_NEW1_SB_angel                
@fromparty varchar(10),                      
@toparty varchar(10),                       
@opendate varchar(11),                      
@todate varchar(11),                      
@Reporttype varchar(15),                      
@family varchar(10),                      
@amoutgtthan money,                      
@ageoption varchar(1),                      
@dttype varchar(3),                  
@statusid varchar(10) ,                  
@statusname varchar(25),                  
@Days1 Int = 29,                  
@Days2 Int = 60,                  
@Days3 Int = 90,                  
@Days4 Int = 180,                  
@Days5 Int = 360,                  
@FrSb Varchar(10) = '0',                  
@ToSb Varchar(10) = 'ZZZZ'                  
                  
                  
                  
as                  
                
------------------------------------------------                
/*                
declare                
@fromparty varchar(10),                      
@toparty varchar(10),                       
@opendate varchar(11),                      
@todate varchar(11),                      
@Reporttype varchar(15),                      
@family varchar(10),                      
@amoutgtthan money,                      
@ageoption varchar(1),                      
@dttype varchar(3),                  
@statusid varchar(10) ,                  
@statusname varchar(25),                  
@Days1 Int,                  
@Days2 Int,                  
@Days3 Int,                  
@Days4 Int,                  
@Days5 Int,                  
@FrSb Varchar(10),                  
@ToSb Varchar(10)                
                
set @fromparty ='K9550'                
set @toparty ='K9550'                
set @opendate='Apr  1 2006'                
set @todate = 'Mar 31 2007'                
set @Reporttype ='party'                
set @family =''                
set @amoutgtthan =0                
set @ageoption='D'                
set @dttype ='vdt'                
set @statusid= 'broker'                
set @statusname = 'broker'                
set @Days1=29                
set @Days2=60                
set @Days3=90                
set @Days4=180                
set @Days5=360                
set @FrSb ='0'                
set @ToSb  = 'ZZZZ'                
                
*/                
                
                  
declare                  
@@balcur as cursor,                      
@@baldate as varchar(11),                      
@@openbaldt as varchar(11),                      
@@balamt as money,                      
@@ocltcode as varchar(10),                      
@@vtyp as smallint,                      
@@vno varchar(12),                      
@@EVdt as DATETIME,                      
@@vamt as money,                      
@@closbal as money,                      
@@cltcode as varchar(10),                      
@@Branchcode as varchar(25),                      
@@area as varchar(25),                  
@@drcr    as varchar(1),                      
@@startdt as datetime                  
                    
                
--PRINT 'Strated '                     
--PRINT convert(datetime,getdate(),113)                    
                    
Set nocount on                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                     
                    
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )                      
                      
                      
if upper(@statusid) = 'BROKER'                      
begin                       
 select @@branchcode = '%'                       
 select @@area = '%'                       
end                      
else if upper(@statusid) = 'BRANCH'                      
begin                      
 select @@branchcode = rtrim(@statusname)                      
 select @@area = '%'                       
end                   
else if upper(@statusid) = 'AREA'                      
begin                      
 select @@branchcode = '%'                  
 select @@area = rtrim(@statusname)                  
end                   
                      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from intranet.risk.dbo.ncdx_ledger where 1=2                    
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from intranet.risk.dbo.ncdx_ledger where 1=2                    
                  
Select * into #Ledger from intranet.risk.dbo.ncdx_ledger where 1=2                  
                  
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from intranet.risk.dbo.ncdx_ledger where 1=2                  
                      
if @dttype='vdt'                  
begin                  
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from intranet.risk.dbo.ncdx_ledger where vtyp = '18' and vdt < = @opendate                   
                   
 if upper(@Reporttype) = 'PARTY'                  
 begin                  
  insert   into #tempageing1                       
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from intranet.risk.dbo.ncdx_ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where l.cltcode = c2.party_code                  
  and c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' --and area like @@area+'%'                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                       
/*                    
  insert   into #tempageing1                       
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where l.cltcode = c2.party_code                  
  and c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                       
                    
  insert   into #tempageing1                       
  select l.cltcode, baldate=@todate,                 
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountfo.dbo.Ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where l.cltcode = c2.party_code                  
  and c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                       
*/                    
                    
  insert   into #tempageing                    
  select cltcode, baldate=@todate,                       
  closbal = sum(closbal),agedays=0                      
  from #tempageing1                      
  group by cltcode                      
  order by cltcode                       
 end                  
                  
 else if upper(@Reporttype) = 'FAMILY'                  
 begin                  
  insert   into #tempageing1                      
  Select Family as cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from intranet.risk.dbo.ncdx_ledger l,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty                      
  and c1.Branch_cd like @@branchcode+'%' --and area like @@area+'%'                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by family     
  order by family                  
/*                    
  insert   into #tempageing1                      
  Select Family as cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty                      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by family                       
  order by family                  
                    
  insert   into #tempageing1                      
  Select Family as cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountfo.dbo.Ledger l,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                      
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty                      
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by family                       
  order by family                  
*/                    
  insert   into #tempageing                    
  select cltcode, baldate=@todate,                       
   closbal = sum(closbal),agedays=0                      
  from #tempageing1                      
  group by cltcode                       
  order by cltcode                  
                    
 end                  
                  
 else if upper(@Reporttype) = 'FAMILYPARTY'                  
 begin                  
  insert   into #tempageing1                  
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from intranet.risk.dbo.ncdx_ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                   
  and c1.Branch_cd like @@branchcode+'%' --and area like @@area+'%'                  
  and l.cltcode = c2.party_code and c1.family = @family                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                      
/*                    
  insert   into #tempageing1                  
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                  
  and l.cltcode = c2.party_code and c1.family = @family                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode    
                    
  insert   into #tempageing1                  
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountfo.dbo.Ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 where c1.cl_code = c2.cl_code                  
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                   
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'                  
  and l.cltcode = c2.party_code and c1.family = @family                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                      
*/                    
  insert   into #tempageing                    
  select cltcode, baldate=@todate,                       
   closbal = sum(closbal),agedays=0                      
  from #tempageing1                      
  group by cltcode                      
  order by cltcode                      
                    
 end                  
                  
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                      
 BEGIN                      
  insert into #Ledger                   
  select * from intranet.risk.dbo.ncdx_ledger where vdt <= @todate  + ' 23:59:59'                   
  and cltcode in (Select distinct cltcode from #tempageing)                       
/*                    
  insert into #Ledger         
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                   
  and cltcode in (Select distinct cltcode from #tempageing)                       
                    
  insert into #Ledger                   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                   
  and cltcode in (Select distinct cltcode from #tempageing)       */                
 END                      
                  
 else                      
 BEGIN                      
  insert into #Ledger                   
  select * from intranet.risk.dbo.ncdx_ledger where vdt <= @todate  + ' 23:59:59'            
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                       
/*                    
  insert into #Ledger                   
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                   
  and cltcode in (select party_code from bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                  
                    
  insert into #Ledger                   
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'                  
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */                
 END                      
                   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                      
 begin                      
  if upper(rtrim(@ageoption)) = 'D'                       
  begin                  
   insert into #LedgerCursor                    
   select l.cltcode, vtyp, vno, vdt, vamt, closbal                      
   from #Ledger l, #tempageing a                      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and l.cltcode = a.cltcode                     
   and vdt <= @todate  + ' 23:59:59'                       
   --                  
   --and vtyp <> '18'                      
   order by l.cltcode, vdt desc, vtyp, vno                  
  end                  
                   
  else if upper(rtrim(@ageoption)) = 'C'                  
  begin                  
   insert into #LedgerCursor                     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal                      
   from #Ledger l, #tempageing a                      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and l.cltcode = a.cltcode                      
   and vdt <= @todate  + ' 23:59:59'                      
   --                  
   --and vtyp <> '18'                    
   order by l.cltcode, vdt desc, vtyp, vno                       
  end                  
           
  else                  
  begin                  
   insert into #LedgerCursor                     
   select l.cltcode, vtyp, vno, vdt, vamt, closbal                      
   from #Ledger l, #tempageing a                  
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and l.cltcode = a.cltcode                      
   and vdt <= @todate  + ' 23:59:59'                      
   --                  
   --and vtyp <> '18'                   
   order by l.cltcode, vdt desc, vtyp, vno                       
  end                  
 end                  
                   
 else                      
 begin                      
  if upper(rtrim(@ageoption)) = 'D'                       
  begin                  
   insert into #LedgerCursor                     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal                      
   from #Ledger l, ncdx.dbo.clientmaster c,  #tempageing a where a.cltcode = family                      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and vdt <= @todate  + ' 23:59:59'                       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                       
   --                  
   --and vtyp <> '18'                      
   order by cltcode, vdt desc, vtyp, vno                      
  end                  
                   
  else if upper(rtrim(@ageoption)) = 'C'                  
  begin                  
   insert into #LedgerCursor                     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal                   
   from #Ledger l, ncdx.dbo.clientmaster c, #tempageing a where  a.cltcode = family                      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and vdt <= @todate  + ' 23:59:59'                       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                       
   --                  
   --and vtyp <> '18'                      
   order by cltcode, vdt desc, vtyp, vno                      
  end                  
                   
  else                  
  begin                  
   insert into #LedgerCursor                     
   select cltcode=family, vtyp, vno, vdt, vamt, closbal                      
   from #Ledger l, ncdx.dbo.clientmaster c, #tempageing a where a.cltcode = family                      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and vdt <= @todate  + ' 23:59:59'                       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                       
   --                  
   --and vtyp <> '18'                      
   order by cltcode, vdt desc, vtyp, vno                      
  end                  
 end                  
                  
end                  
                  
else                  
begin                  
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from intranet.risk.dbo.ncdx_ledger where vtyp = '18' and edt < = @opendate                  
                  
 if upper(@Reporttype) = 'PARTY'                  
 begin                  
  insert   into #tempageing1                   
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from intranet.risk.dbo.ncdx_ledger l, acmast a, ncdx.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code                  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'                       
  and a.accat = 4                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                  
/*                       
  insert   into #tempageing1                       
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountbse.dbo.Ledger l, accountbse.dbo.acmast a, bsedb.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code                  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'                       
  and a.accat = 4                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                  
                    
  insert   into #tempageing1                       
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountfo.dbo.Ledger l, accountfo.dbo.acmast a, ncdx.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code                  
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'                       
  and a.accat = 4                  
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                  
*/                    
  insert   into #tempageing                    
  select cltcode, baldate=@todate,                       
  closbal = sum(closbal),agedays=0                      
  from #tempageing1                      
  group by cltcode                      
  order by cltcode                   
                    
 end                  
                  
 else if upper(@Reporttype) = 'FAMILY'                  
 begin         
  insert   into #tempageing1                      
  Select Family as cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from intranet.risk.dbo.ncdx_ledger l,  ncdx.dbo.client1 c --ncdx.dbo.clientmaster c                      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty                      
  and c.Branch_cd like @@branchcode+'%'                   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                  
  group by family                       
  order by family                  
/*                    
  insert   into #tempageing1                      
  Select Family as cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c--bsedb.dbo.clientmaster c                      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty                      
  and c.Branch_cd like @@branchcode+'%'                   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                  
  group by family                       
  order by family                  
                    
  insert   into #tempageing1                      
  Select Family as cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountfo.dbo.Ledger l,  ncdx.dbo.client1 c--ncdx.dbo.clientmaster c                      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                      
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty                      
  and c.Branch_cd like @@branchcode+'%'                   
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                  
  group by family                       
  order by family                  
*/                    
                    
  insert   into #tempageing                    
  select cltcode, baldate=@todate,                       
  closbal = sum(closbal),agedays=0                      
  from #tempageing1                      group by cltcode                      
  order by cltcode                   
                    
 end                  
                   
 else if upper(@Reporttype) = 'FAMILYPARTY'                  
 begin                  
  insert into #tempageing1                  
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from intranet.risk.dbo.ncdx_ledger l, ncdx.dbo.client1 c--ncdx.dbo.clientmaster c                    
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                  
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                   
  and c.Branch_cd like @@branchcode+'%'                  
  and l.cltcode = c.cl_code and c.family = @family                       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                      
/*                    
  insert into #tempageing1                  
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c--bsedb.dbo.clientmaster c                      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                   
  and c.Branch_cd like @@branchcode+'%'                  
  and l.cltcode = c.cl_code and c.family = @family                       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                           
                    
  insert into #tempageing1                  
  select l.cltcode, baldate=@todate,                       
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0                      
  from Accountfo.dbo.Ledger l, ncdx.dbo.client1 c--ncdx.dbo.clientmaster c                 
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'                       
  and l.cltcode >= @fromparty and l.cltcode <= @toparty                   
  and c.Branch_cd like @@branchcode+'%'                  
  and l.cltcode = c.cl_code and c.family = @family                       
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb                  
  group by l.cltcode                      
  order by l.cltcode                  
*/                    
  insert   into #tempageing                    
  select cltcode, baldate=@todate,                       
  closbal = sum(closbal),agedays=0                      
  from #tempageing1                      
  group by cltcode                      
  order by cltcode                   
                   
 end                  
                   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                      
 BEGIN                      
  insert into #Ledger                   
  select * from intranet.risk.dbo.ncdx_ledger where edt <= @todate  + ' 23:59:59'                   
  and cltcode in (Select distinct cltcode from #tempageing)                      
/*                    
  insert into #Ledger                   
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'                   
  and cltcode in (Select distinct cltcode from #tempageing)                      
                    
  insert into #Ledger                   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'                   
  and cltcode in (Select distinct cltcode from #tempageing)     */                
 END                  
                       
 else                      
 BEGIN                      
  insert into #Ledger                   
  select * from intranet.risk.dbo.ncdx_ledger where edt <= @todate  + ' 23:59:59'                   
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                  
/*                    
  insert into #Ledger                   
select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'                   
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)                  
                    
  insert into #Ledger                   
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'                   
  and cltcode in (select party_code from ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */                
 END                      
                   
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'                      
 begin                      
  if upper(rtrim(@ageoption)) = 'D'                  
  begin                  
   insert into #LedgerCursor                     
   select l.cltcode, vtyp, vno, edt, vamt, closbal                      
   from #Ledger l, #tempageing a                      
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and l.cltcode = a.cltcode                     
   and edt <= @todate  + ' 23:59:59'                       
   --                  
   --and vtyp <> '18'                      
   order by l.cltcode, edt desc, vtyp, vno                      
  end                  
                   
  else if upper(rtrim(@ageoption)) = 'C'                  
  begin                  
   insert into #LedgerCursor                      
   select l.cltcode, vtyp, vno, edt, vamt, closbal                      
   from #Ledgeredt l, #tempageing a                      
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and l.cltcode = a.cltcode                      
   and edt <= @todate  + ' 23:59:59'                      
   --                  
   --and vtyp <> '18'                      
   order by l.cltcode, edt desc, vtyp, vno                    
  end                  
                   
  else                  
  begin                  
   insert into #LedgerCursor                     
   select l.cltcode, vtyp, vno, edt, vamt, closbal                      
   from #Ledger l, #tempageing a                 
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and l.cltcode = a.cltcode                      
   and edt <= @todate  + ' 23:59:59'                      
   --                   
   --and vtyp <> '18'                      
   order by l.cltcode, edt desc, vtyp, vno                   
  end                  
 end                  
                   
 else                      
 begin                      
  if upper(rtrim(@ageoption)) = 'D'                       
  begin                  
   insert into #LedgerCursor                     
   select cltcode=family, vtyp, vno, edt, vamt, closbal                      
   from #Ledger l, ncdx.dbo.clientmaster c,  #tempageing a where a.cltcode = family                      
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and edt <= @todate  + ' 23:59:59'                       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                       
   --                  
   --and vtyp <> '18'                      
   order by cltcode, edt desc, vtyp, vno                      
  end                  
                   
  else if upper(rtrim(@ageoption)) = 'C'                  
  begin                  
   insert into #LedgerCursor                     
   select cltcode=family, vtyp, vno, edt, vamt, closbal                   
   from #Ledger l, ncdx.dbo.clientmaster c, #tempageing a where  a.cltcode = family                      
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and edt <= @todate  + ' 23:59:59'                       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                       
   --       
   --and vtyp <> '18'                      
   order by cltcode, edt desc, vtyp, vno                      
  end                  
                   
  else                  
  begin                  
   insert into #LedgerCursor                     
   select cltcode=family, vtyp, vno, edt, vamt, closbal                      
   from #Ledger l, ncdx.dbo.clientmaster c, #tempageing a where a.cltcode = family                      
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )                       
   and edt <= @todate  + ' 23:59:59'                       
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty                       
   --                  
   --and vtyp <> '18'                      
   order by cltcode, edt desc, vtyp, vno                      
  end                  
 end                  
end                  
                      
                      
--PRINT 'Filled LedgerCursor'                     
--PRINT convert(datetime,getdate(),113)                    
                    
set @@balcur = cursor for                      
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno                    
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2                      
                      
--PRINT 'opening cursor'                      
                      
open @@balcur                  
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal                       
                  
while @@fetch_status = 0                     
begin                       
 select @@ocltcode = @@cltcode                       
  select @@balamt = abs(@@closbal)                      
 if @@closbal >= 0                       
 begin                      
  select @@drcr = 'd'                      
 end                   
     else                      
 begin                      
       select @@drcr = 'c'                      
 end                  
                  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0                      
 begin                      
  if @@balamt >= @@vamt                       
  begin                    
   insert into #fintempageing                      
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr                       
   select @@balamt = @@balamt - @@vamt                     
  end                      
                  
  else                      
  begin                      
   insert into #fintempageing                      
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr                       
   select @@balamt = @@balamt - @@vamt                       
  end                      
                  
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal                       
 end                      
                  
 if @@balamt > 0                      
 begin                    
   insert into #fintempageing                      
   select @@ocltcode, @@balamt, 181, @@drcr                       
   select @@balamt = @@balamt - @@vamt                      
 end                      
                  
 while @@fetch_status = 0 and @@ocltcode = @@cltcode                  
 begin                    
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal                      
 end                      
end                  
                      
close @@balcur                      
deallocate @@balcur                      
                      
--PRINT 'cursor closed'                      
--PRINT convert(datetime,getdate(),113)                    
                      
                
                
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist                      
from #fintempageing                   
where agedays >= 0 and agedays <= @Days1                  
group by cltcode, drcr                      
--order by cltcode, drcr                      
                      
insert into #ageinglist                     
select cltcode, balance=sum(balamt), agedays = @Days2, drcr                       
from #fintempageing                      
where agedays >= @Days1+1 and agedays <= @Days2                  
group by cltcode, drcr                       
--order by cltcode, drcr                      
                      
insert into #ageinglist                      
select cltcode, balance=sum(balamt), agedays = @Days3, drcr                       
from #fintempageing                      
where agedays >= @Days2+1 and agedays <= @Days3                  
group by cltcode, drcr                       
--order by cltcode, drcr                       
                  
insert into #ageinglist                      
select cltcode, balance=sum(balamt), agedays = @Days4, drcr                       
from #fintempageing                      
where agedays >= @Days3+1 and agedays <= @Days4                  
group by cltcode, drcr                       
--order by cltcode, drcr                       
                      
                
insert into #ageinglist                      
select cltcode, balance=sum(balamt), agedays = @Days5, drcr                       
from #fintempageing                      
--where agedays >= @Days5                  
where agedays >= @Days4+1 and agedays <= @Days5                  
group by cltcode, drcr                       
--order by cltcode, drcr                       
                
                  
--PRINT 'done'                      
--PRINT convert(datetime,getdate(),113)                    
                
                
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, branch=' ', name=' '                  
into #filex                
from #ageinglist a1, ncdx.dbo.client1 a2              
--, ncdx.dbo.subbrokers s, ncdx.dbo.branch b              
--ncdx.dbo.clientmaster a2--account.dbo.acmast  a2                       
where balance >= @amoutgtthan and                       
a1.cltcode = a2.cl_code                  
--and a2.branch_cd = b.branch_code                  
--and a2.sub_broker = s.sub_broker                  
--order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name                  
                
--truncate table Angel_Ageing                      
--insert into Angel_Ageing                      
                
select party_code=a.cltcode,a.baldate,a.closbal,b.* into #AgeFinal                 
from (select * from #tempageing where closbal <> 0 )a left outer join #filex b on a.cltcode=b.cltcode                     
                
                
select PARTY_cODE,branch_cd,branch,sub_Broker,name,cltcode,short_name,balDate,ClosBal,                
Day_30=sum(case                 
when agedays=29 and drcr='d' then balance                 
when agedays=29 and drcr='c' then -balance                 
else 0 end),                
Day_60=sum(case                
when agedays=60 and drcr='d' then balance                 
when agedays=60 and drcr='c' then -balance                 
else 0 end),                
Day_90=sum(case                
when agedays=90 and drcr='d' then balance                 
when agedays=90 and drcr='c' then -balance                 
else 0 end),                
Day_180=sum(case                 
when agedays=180 and drcr='d' then balance                 
when agedays=180 and drcr='c' then -balance                 
else 0 end),                
Day_360=sum(case                 
when agedays=360 and drcr='d' then balance                 
when agedays=360 and drcr='c' then -balance                 
else 0 end)                
into #fINAL                
from #AgeFinal                 
group by PARTY_cODE,branch_cd,branch,sub_Broker,name,cltcode,short_name,balDate,ClosBal                
--order by cltcode          
        
select a.*,last_trade_date=isnull(convert(varchar(11),vdt),'-') into #fINAL1 from #fINAL a        
left outer join        
(    
--select cltcode,vdt=max(vdt) from intranet.risk.dbo.ncdx_ledger (nolock) group by cltcode    
 select cltcode,vdt=max(vdt) from intranet.risk.dbo.ncdx_ledger 
 where vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59' and vtyp=15                
 group by cltcode    
) b        
on a.party_code=b.cltcode                       
            
update #fINAL1 set branch_cd=b.branch_Cd,sub_Broker=b.sub_broker from             
(select party_code,branch_cd,sub_broker from ncdx.dbo.client1 a, ncdx.dbo.client2 b where a.cl_code=b.cl_code) b            
where #fINAL1.party_code=b.party_code            
            
if @ageoption='D'                
begin                 
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)                 
 FROM #fINAL1                 
 where closBal > 0                
 order by cltcode                
end                
if @ageoption='C'                
begin                 
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)                 
 FROM #fINAL1                 
 where closBal < 0                
 order by cltcode                
end                
if @ageoption='A'                
begin                 
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)                 
 FROM #fINAL1                 
 order by cltcode                
end                
                
                
drop table #tempageing                      
drop table #tempageing1                      
drop table #Ledger                      
drop table #LedgerCursor                       
drop table #ageinglist            
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.allpartybal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 29-Sep-01 8:12:01 PM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.allpartybal    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE  allpartybal
@cname  varchar(35),
@fromdt datetime
AS
select  dramt=isnull((case drcr when 'd' then sum(vamt) end),0),
cramt=isnull((case drcr when 'c' then sum(vamt) end),0)  
from ledger l,  ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 where 
l.acname = c1.short_Name  and c2.party_code=l.cltcode 
and l.acname = @cname  and vdt<  @fromdt  
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.allpartyledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.allpartyledger    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE allpartyledger
@cname varchar(35),
@fromdt datetime,
@todt datetime
AS
select convert(varchar,l.vdt,103), c2.party_code, 
vdesc,dramt=isnull((case drcr when 'd' then vamt end),0),
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt,
l.vno,l.lno,l.drcr, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where /*l3.refno=left(l.refno,7)*/ l3.vno=l.vno and l3.vtyp=l.vtyp), '') from ledger l, 
vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@cname and vdt>= @fromdt and vdt<=@todt +  " 11:59pm" 
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.allpartyshortname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.allpartyshortname    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE allpartyshortname
@clcode varchar(6)
 AS
select distinct short_name from  ncdx.dbo.client1 where cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_BrsAutoRecon
-- --------------------------------------------------


--exec Angel_BrsAutoRecon convert(varchar(12),getdate(),107),1  
  
CREATE proc Angel_BrsAutoRecon(@Segment int)    
as    
    
--set @relDate = convert(datetime,@relDate,107)    
    
select Vno,vtyp,lno,bookType,Reldt,RefNo into #x from [196.1.115.235].brs.dbo.ledger1 where     
/*dddt>='apr 01 2008' and dddt<='mar 31 2009' and */    
reldt <> '1900-01-01' and B_Seg_Code = @Segment    
    
    
update ledger1 set RefNo =  #x.RefNo, RelDt = #x.Reldt from    
#x where  #x.Vno  = ledger1.vno and #x.vtyp = ledger1.vtyp and #x.bookType = ledger1.bookType    
and #x.lno = ledger1.lno and ledger1.reldt='jan 01 1900'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_CheckDuplicateReceiptEntry
-- --------------------------------------------------
create procedure Angel_CheckDuplicateReceiptEntry  
as  
  
select * into #bse_cr from ledger where vdt >='Jan 19 2008 00:00' and vtyp=2 and drcr='C'  
select * into #bse_dr from ledger where vdt >='Jan 19 2008 00:00' and vtyp=3 and drcr='D'  
  
select ddno,vno,lno into #chqnodr from ledger1 where vtyp=3 and vno >='200801190000'  
select ddno,vno,lno into #chqno from ledger1 where vtyp=2 and vno >='200801190000'  
  
select a.*,b.ddno into #bse1dr from #bse_dr a, #chqnodr b where a.vno=b.vno and a.lno=b.lno  
select a.*,b.ddno into #bse1 from #bse_cr a, #chqno b where a.vno=b.vno and a.lno=b.lno  
  
--where cltcode+'|'+convert(varchar(15),vamt)+'|'+convert(varchar(25),ddno)   
--in (select cltcode+'|'+convert(varchar(15),vamt)+'|'+convert(varchar(25),ddno)  from #bse1dr)  
  
  
delete from #bse1   
where cltcode+'|'+convert(varchar(25),ddno)   
in (select cltcode+'|'+convert(varchar(25),ddno)  from #bse1dr)  
  
  
select a.*,bvno=b.vno,bcltcode=b.cltcode,bvamt=b.vamt ,bddno=b.ddno   
into #bse_kand  
from  
(select vno=min(vno),cltcode,vamt,ddno,lno from #bse1 where ddno <> '0' group by cltcode,vamt,ddno,lno) a,  
(select vno=max(vno),cltcode,vamt,ddno,lno from #bse1 where ddno <> '0' group by cltcode,vamt,ddno,lno) b  
where a.ddno=b.ddno and a.vno <> b.vno  
and a.cltcode=b.cltcode and a.lno=b.lno   
and a.vamt=b.vamt  
  
delete from ledger where vno in (select bvno from #bse_kand where cltcode >='A0001' and cltcode <='ZZZZZ') and vtyp=2   
delete from ledger1 where vno in (select bvno from #bse_kand where cltcode >='A0001' and cltcode <='ZZZZZ') and vtyp=2   
delete from ledger2 where vno in (select bvno from #bse_kand where cltcode >='A0001' and cltcode <='ZZZZZ') and vtype=2   
delete from ledger3 where vno in (select bvno from #bse_kand where cltcode >='A0001' and cltcode <='ZZZZZ') and vtyp=2   
  
delete from ledger where vno in (select bvno from #bse_kand where cltcode ='5100000001' ) and vtyp=2   
delete from ledger1 where vno in (select bvno from #bse_kand where cltcode ='5100000001' ) and vtyp=2   
delete from ledger2 where vno in (select bvno from #bse_kand where cltcode ='5100000001' ) and vtype=2   
delete from ledger3 where vno in (select bvno from #bse_kand where cltcode ='5100000001' ) and vtyp=2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_checkSuspFundsTrfClient
-- --------------------------------------------------


create procedure Angel_checkSuspFundsTrfClient(@fdate as varchar(11))
as

SET NOCOUNT ON

declare @fvno as varchar(12)
--set @fdate = 'Jan 25 2008'
select @fvno=replace(convert(varchar(11),convert(Datetime,@fdate),111),'/','')+'0000'


select * into #bse_cr from ledger (nolock) where vdt >=@fdate+' 00:00' and vtyp=2 and drcr='C' and  cltcode='5100000001'
select * into #bse_dr from ledger (nolock) where vdt >=@fdate+' 00:00' and vtyp=3 and drcr='D' and  cltcode='5100000001'

select ddno,vno,lno,refno into #chqno from ledger1 (nolock) where vtyp=2 and vno >=@fvno  
select ddno,vno,lno,refno into #chqnodr from ledger1 (nolock) where vtyp=3 and vno >=@fvno      


select a.*,b.ddno,crn=b.refno into #bse1 from #bse_cr a, #chqno b where a.vno=b.vno and a.lno=b.lno      
select a.*,b.ddno,crn=b.refno into #bse1dr from #bse_dr a, #chqnodr b where a.vno=b.vno and a.lno=b.lno      


delete from #bse1       
where cltcode+'|'+convert(varchar(25),ddno)       
in (select cltcode+'|'+convert(varchar(25),ddno)  from #bse1dr)      


select Accno=reverse(substring(reverse(description),1,charindex('-',reverse(description))-1)),crossreferenceno,
BankCode=Cltcode,valueDate,chqno=referenceno,status,amount,drcr
into #file1
from bankreco (nolock) where description like 'FUNDS TRAN%'
and crossreferenceno in (select crn from #bse1)


select * into #file2 from 
(select * from #file1  where isnumeric(accno)=1) a, 
(
select branch_cd,Sub_broker,party_Code,long_name,AC_num from intranet.risk.dbo.client_Details 
where isnumeric(ac_num)=1 and ac_num <> '0'
)
b where convert(float,a.accno)=convert(float,b.ac_num)

select BankCode,Chqno,Status,BankAmt=a.amount,CliAccno=a.accno,
party_code,party_name=Long_name,Vno,vdt,vamt,narration,ddno,Crn
from #file2 a, #bse1 b where b.crn=a.crossreferenceno


SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_checkUnpostedReceiptEntry
-- --------------------------------------------------
create procedure Angel_checkUnpostedReceiptEntry
as

select * into #bse_cr from ledger where vdt >='Jan 21 2008 00:00' and vtyp=2 and drcr='C'
select ddno,vno,lno into #chqno from ledger1 where vtyp=2 and vno >='200801210000'
select a.*,b.ddno into #bse1 from #bse_cr a, #chqno b where a.vno=b.vno and a.lno=b.lno

select * into #aa from intranet.testdb.dbo.payin where posted_status='Y' and segment='NCDEX' 
and vdate >='Jan 21 2008 00:00'

update #aa set ddno=REPLACE(DDNO,' ','')
update #aa set ddno=REPLACE(DDNO,'A','4')
update #aa set ddno=REPLACE(DDNO,'','/')
update #aa set ddno=REPLACE(DDNO,'O','0')

update #BSE1 set ddno=REPLACE(DDNO,' ','')
update #BSE1 set ddno=REPLACE(DDNO,'A','4')
update #BSE1 set ddno=REPLACE(DDNO,'','/')
update #BSE1 set ddno=REPLACE(DDNO,'O','0')




select * from (select * from #aa where len(ddno)<= 7 )a 
left outer join (
select * from #bse1 where len(ddno)<= 7
) b 
on a.cltcode=b.cltcode and  convert(int,a.ddno)=convert(int,b.ddno)
where isnull(b.ddno,0)=0 



update intranet.testdb.dbo.payin 
set posted_status='N'
where srno in
(
select srno
from (select * from #aa where len(ddno)<= 7 )a 
left outer join (select * from #bse1 where len(ddno)<= 7) b 
on a.cltcode=b.cltcode and  convert(int,a.ddno)=convert(int,b.ddno)
where isnull(b.ddno,0)=0 
) and segment='NCDEX'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_receipt_reco
-- --------------------------------------------------
CREATE procedure angel_Client_receipt_reco
as  
  
Set Transaction isolation level read uncommitted  
declare @tdate as datetime,@daysbefore as int,@prodate as varchar(11)  
select @tdate = getdate()+1  
--set @prodate = convert(varchar(11),getdate()-1)  
set @prodate = convert(varchar(11),getdate())  
select @daysbefore=datediff(dd,@prodate,getdate())+1  
  
select t.accno,l.vtyp, l.booktype, l.vno, l.vdt, tdate=convert(varchar,l.vdt,103), isnull(l1.ddno,'') ddno, isnull(l.cltcode ,'') cltcode ,  
isnull( l.acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then l.vamt else 0 end ),  
Cramt= (case when upper(l.drcr) = 'C' then l.vamt else 0 end ),  
treldt=isnull(convert(varchar, l1.reldt , 103),''), l1.refno,last_Date=getdate()  
into #recodet  
From ledger l (nolock) left outer join LEDGER1 L1 (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno  
inner join   
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists  
(Select accno from angel_BANK_Accno  abc (nolock) where l.cltcode=abc.accno)  
and not (l.narration like 'BEING AMT RECD TECH PROCESS%' or l.narration like 'BEING AMT RECD ING%')  
group by vtyp, booktype, vno, lno,cltcode   
) t  
on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype  
-- and (cltcode <> @code  
where l.cltcode >='A0001' and l.cltcode <='ZZZZZ' and l.drcr='C' and l.vdt <=@tdate-@daysbefore  
/* Commented By Shweta On 05/01/2010 --Start  
and clear_mode not in ( 'R', 'C')  
--END*/  
and l.vtyp not in ( 16, 17)  
and (l1.reldt ='1900-01-01 00:00:00.000' or l1.reldt > @tdate )  
  
--declare @lastdt as datetime  
--select lastdt=max(reldt) from ledger1  
create nonclustered index ix_recodet on #recodet(accno)  
  
update #recodet set last_Date=b.updt from  
(  
SELECT l1.accno,updt=max(l.reldt) FROM ledger1 l (nolock)  
inner join   
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists  
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)  
group by vtyp, booktype, vno, lno,cltcode   
) L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno  
group by l1.accno  
) b where #recodet.accno=b.accno  
  
 

delete from Angel_client_deposit_recno  
insert into Angel_client_deposit_recno select * from #recodet (nolock) --where ddno<>0  

  
  
  
--EXEC ANGEL_KNOCKOFF_CANCEL_RECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_receipt_reco_25102012
-- --------------------------------------------------
CREATE procedure angel_Client_receipt_reco_25102012                      
as                        
                        
Set Transaction isolation level read uncommitted                                             
declare @tdate as datetime,@daysbefore as int,@prodate as varchar(11)                        
select @tdate = getdate()+1                                                  
--set @prodate = convert(varchar(11),getdate()-1)                        
set @prodate = convert(varchar(11),getdate())                        
select @daysbefore=datediff(dd,@prodate,getdate())+1                                                  
                      
 select t.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,                           
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),                          
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),                           
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()                        
into #recodet                        
 From ledger l (nolock) left outer join LEDGER1 L1  (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno,                          
 (select distinct vtyp, booktype, vno, lno,accno=cltcode from ledger  (nolock) where cltcode in        
(Select accno from angel_BANK_Accno (nolock))           
and not (narration like 'BEING AMT RECD TECH PROCESS%' or narration like 'BEING AMT RECD ING%')          
) t                           
 WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype                           
-- and (cltcode <> @code                         
and cltcode >='A0001' and cltcode <='ZZZZZ' and l.drcr='C' and vdt <=@tdate-@daysbefore             
/* Commented By Shweta On 05/01/2010 --Start            
and clear_mode not in ( 'R', 'C')            
--END*/            
and l.vtyp not in ( 16, 17)                          
and (reldt ='1900-01-01 00:00:00.000' or reldt > @tdate )                          
                        
--declare @lastdt as datetime                        
--select lastdt=max(reldt) from ledger1                          
                        
update #recodet set last_Date=b.updt from                        
(                        
SELECT l1.accno,updt=max(l.reldt) FROM ledger1 l (nolock),                        
(select distinct vtyp, booktype, vno, lno,accno=cltcode from ledger (nolock) where cltcode in                         
 (Select accno from angel_BANK_Accno (nolock))                        
) L1 WHERE l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno                        
group by l1.accno                        
) b where #recodet.accno=b.accno                        
                        
delete from Angel_client_deposit_recno                         
insert into Angel_client_deposit_recno select * from #recodet  (nolock)      --where ddno<>0                  
      
    
      
                    
--EXEC ANGEL_KNOCKOFF_CANCEL_RECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_receipt_reco_optimized
-- --------------------------------------------------
CREATE procedure angel_Client_receipt_reco_optimized
as

Set Transaction isolation level read uncommitted
declare @tdate as datetime,@daysbefore as int,@prodate as varchar(11)
select @tdate = getdate()+1
--set @prodate = convert(varchar(11),getdate()-1)
set @prodate = convert(varchar(11),getdate())
select @daysbefore=datediff(dd,@prodate,getdate())+1

select t.accno,l.vtyp, l.booktype, l.vno, l.vdt, tdate=convert(varchar,l.vdt,103), isnull(l1.ddno,'') ddno, isnull(l.cltcode ,'') cltcode ,
isnull( l.acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then l.vamt else 0 end ),
Cramt= (case when upper(l.drcr) = 'C' then l.vamt else 0 end ),
treldt=isnull(convert(varchar, l1.reldt , 103),''), l1.refno,last_Date=getdate()
into #recodet
From ledger l (nolock) left outer join LEDGER1 L1 (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno
inner join 
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists
(Select accno from angel_BANK_Accno  abc (nolock) where l.cltcode=abc.accno)
and not (l.narration like 'BEING AMT RECD TECH PROCESS%' or l.narration like 'BEING AMT RECD ING%')
group by vtyp, booktype, vno, lno,cltcode 
) t
on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype
-- and (cltcode <> @code
where l.cltcode >='A0001' and l.cltcode <='ZZZZZ' and l.drcr='C' and l.vdt <=@tdate-@daysbefore
/* Commented By Shweta On 05/01/2010 --Start
and clear_mode not in ( 'R', 'C')
--END*/
and l.vtyp not in ( 16, 17)
and (l1.reldt ='1900-01-01 00:00:00.000' or l1.reldt > @tdate )

--declare @lastdt as datetime
--select lastdt=max(reldt) from ledger1
create nonclustered index ix_recodet on #recodet(accno)

update #recodet set last_Date=b.updt from
(
SELECT l1.accno,updt=max(l.reldt) FROM ledger1 l (nolock)
inner join 
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)
group by vtyp, booktype, vno, lno,cltcode 
) L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno
group by l1.accno
) b where #recodet.accno=b.accno

---NEED TO REMOVE AND REPLACE #Angel_client_deposit_recno  TO Angel_client_deposit_recno 
/*******************************************************************************/
select top 0 * into #Angel_client_deposit_recno  from Angel_client_deposit_recno 
insert into #Angel_client_deposit_recno   select * from #recodet (nolock) --where ddno<>0
/*==============================================================================*/

/*
delete from Angel_client_deposit_recno
insert into Angel_client_deposit_recno select * from #recodet (nolock) --where ddno<>0
*/



--EXEC ANGEL_KNOCKOFF_CANCEL_RECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_GetBAnkReceiptDetails
-- --------------------------------------------------
CREATE procedure Angel_GetBAnkReceiptDetails(@tdate as varchar(10))  
as  
set nocount on  
set transaction isolation level read uncommitted  
select * into #file1 from ledger (nolock) where vdt >=@tdate+' 00:00:00' and vdt <=@tdate+' 23:59:59' and vtyp=2 and drcr='C'  
  
select b.branch_cd,a.*,RecoStatus=(case when reldt='Jan  1 1900 00:00:00' then 'Pending' else 'Reconsiled' end) from   
(select a.ddno,vdt,reldt=replace(convert(varchar(10),reldt,101),'01/01/1900',''),vamt,cltcode,acname from ledger1 a (nolock) , #file1 b where a.vno=b.vno and a.lno=b.lno) a,  
(select branch_Cd,party_code from anand1.msajag.dbo.client_Details ) b where a.cltcode=b.party_Code  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost
-- --------------------------------------------------
create procedure angel_getledger_cost(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))
as

set transaction isolation level read uncommitted

set nocount on

select a.*,b.camt,b.costname from 
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'
) a left outer join
(select l2.camt,l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'') from ledger2 l2 left outer join costmast cm 
on l2.costcode=cm.costcode) b on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode
order by a.vno,a.lno
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost1
-- --------------------------------------------------
CREATE procedure angel_getledger_cost1(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(11))      
as      
      
set transaction isolation level read uncommitted      
      
set nocount on      
      
/*      
Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'      
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)      
set @cltcode='a108'      
set @fdate='Apr 01 2004'      
set @tdate='Jan 05 2006'      
*/      
      
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')      
into #abl_cost      
from       
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
) a left outer join      
(select l2.camt,l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')       
from ledger2 l2       
left outer join costmast cm       
on l2.costcode=cm.costcode) b       
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode      
      
      
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],       
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=(case when drcr = 'C' then n.vamt else 0 end),       
balamt=convert(money,0.00),n.camt,n.costname,Segment=@segment,n.acname,@cltcode as accountcode,n.lno as [LineNo]   from #abl_cost n left outer join       
vmast v on vtyp=vtype      
order by n.vno,n.lno      
      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost2
-- --------------------------------------------------
CREATE procedure angel_getledger_cost2(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))  
as  
  
set transaction isolation level read uncommitted  
  
set nocount on  
  

--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'  
/*
drop table #abl_cost_a
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)  
set @cltcode='70000014 '  
set @fdate='Apr 01 2004'  
set @tdate='Dec 30 2004'  
*/

set transaction isolation level read uncommitted  
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')  
into #abl_cost_a  
from   
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'  
) a left outer join  
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')   
from ledger2 l2 (nolock)  
left outer join costmast cm (nolock)  
on l2.costcode=cm.costcode) b   
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode  

set transaction isolation level read uncommitted
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname
into #file1
from ledger (nolock)
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'  
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%') 
and vno in (select vno from #abl_cost_a) and vtyp<>18



set transaction isolation level read uncommitted
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)
into #abl_cost
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp 

set transaction isolation level read uncommitted 
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],   
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),   
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt
from #abl_cost n left outer join   
vmast v (nolock) on vtyp=vtype  
order by n.vno,n.lno  
  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost2_test
-- --------------------------------------------------

CREATE procedure angel_getledger_cost2_test(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))      
as      
      
set transaction isolation level read uncommitted      
      
set nocount on      
      
    
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'      
/*    
drop table #abl_cost_a    
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)      
set @cltcode='70000014 '      
set @fdate='Apr 01 2004'      
set @tdate='Dec 30 2004'      
*/    
    
set transaction isolation level read uncommitted      
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')      
into #abl_cost_a      
from       
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
) a left outer join      
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')       
from ledger2 l2 (nolock)      
left outer join costmast cm (nolock)      
on l2.costcode=cm.costcode) b       
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode      
    
set transaction isolation level read uncommitted    
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname    
into #file1    
from ledger (nolock)    
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%')     
and vno in (select vno from #abl_cost_a) and vtyp<>18    
    
    
  
set transaction isolation level read uncommitted    
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)    
into #abl_cost    
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp     
    
set transaction isolation level read uncommitted     
select n.costname,r.regioncode,alt_acname,       
Debit=(case when drcr = 'D' then n.vamt else 0 end)--Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),  
from #abl_cost n left outer join       
vmast v (nolock)on vtyp=vtype     left outer join NCDX.dbo.region  r on n.costname = r.branch_code  

order by n.narration,n.vno,n.lno
      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost3
-- --------------------------------------------------
CREATE procedure angel_getledger_cost3(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))              
as              
              
set transaction isolation level read uncommitted              
              
set nocount on              
              
            
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'              
/*          
drop table #abl_cost_a            
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)              
set @cltcode='26100010'              
set @fdate='Jun 01 2007'              
set @tdate='Jun 30 2007'              
*/          
            
set transaction isolation level read uncommitted              
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')              
into #abl_cost_a              
from               
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'              
) a left outer join              
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')               
from ledger2 l2 (nolock)              
left outer join costmast cm (nolock)              
on l2.costcode=cm.costcode) b               
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode              
            
set transaction isolation level read uncommitted            
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname            
into #file1            
from ledger (nolock)            
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'              
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%' or cltcode like '35%'or cltcode like '31%' or cltcode like '32%' or cltcode like '38%')             
and vno in (select vno from #abl_cost_a) and vtyp<>18            
            
            
            
set transaction isolation level read uncommitted            
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)            
into #abl_cost            
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp             
            
set transaction isolation level read uncommitted             
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],               
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),               
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt            
into #temp1          
from #abl_cost n left outer join               
vmast v (nolock) on vtyp=vtype              
          
delete from #temp1 where credit <= 0          
          
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,          
narration=          
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN          
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))           
ELSE          
NARR          
END          
into #tempa          
from #temp1          
where alt_vamt < 0          
          
          
insert into #tempa          
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,          
narration=          
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN          
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))           
ELSE          
NARR          
END          
from #temp1          
where vno not in (select vno from #tempa)          
          
select a.*,state=isnull(b.state,''),Pan_no=isnull(b.pan_no,'')          
from #tempa a left outer join mis.sb_comp.dbo.SB_State_pan b on a.costname=b.sub_BRoker order by vno          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost4
-- --------------------------------------------------





CREATE procedure [dbo].[angel_getledger_cost4](@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11), @segment as varchar(10))      
as  

set transaction isolation level read uncommitted      
set nocount on      

 /*  
drop table #abl_cost_a  
drop table #file1
drop table #abl_cost
drop table #temp1
drop table #tempa
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(10)      
set @cltcode='26100010'      
set @fdate='Aug 01 2007'      
set @tdate='Aug 30 2007'      
set @segment='NSECM'
*/

set transaction isolation level read uncommitted      

select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')      
into #abl_cost_a      
from       
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'      
) a left outer join      
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')       
from ledger2 l2 (nolock)      
left outer join costmast cm (nolock)      
on l2.costcode=cm.costcode) b       
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode      


--select * from #abl_cost_a    


set transaction isolation level read uncommitted    
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname    
into #file1    
from ledger (nolock)    
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'    
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%')     
and vno in (select vno from #abl_cost_a) and vtyp<>18    


set transaction isolation level read uncommitted    

select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)    
into #abl_cost    
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp     

    


set transaction isolation level read uncommitted     

select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],       
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),       
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt    
into #temp1  
from #abl_cost n left outer join       
vmast v (nolock) on vtyp=vtype      

  
delete from #temp1 where credit <= 0  


select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,  
narration=  
(CASE 
WHEN NARR LIKE 'TDS on remisier share of%' THEN  
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))   

WHEN NARR LIKE 'TDS on share of%' THEN  
SUBSTRING(replace(narr,'TDS on share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on share of ',''),1))  

WHEN NARR LIKE 'TDS on  share of%' THEN  
SUBSTRING(replace(narr,'TDS on  share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on  share of ',''),1))  

WHEN NARR LIKE 'Being TDS on share of%' THEN  
SUBSTRING(replace(narr,'Being TDS on share of ',''),1,CHARINDEX(' ',replace(narr,'Being TDS on share of ',''),1))  
ELSE  
NARR  
END  
)
into #tempa  
from #temp1  
where alt_vamt < 0  
  

insert into #tempa  
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,  
narration=  
(CASE 
WHEN NARR LIKE 'TDS on remisier share of%' THEN  
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))   

WHEN NARR LIKE 'TDS on share of%' THEN  
SUBSTRING(replace(narr,'TDS on share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on share of ',''),1))  


WHEN NARR LIKE 'TDS on  share of%' THEN  
SUBSTRING(replace(narr,'TDS on  share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on  share of ',''),1))  


WHEN NARR LIKE 'Being TDS on share of%' THEN  
SUBSTRING(replace(narr,'Being TDS on share of ',''),1,CHARINDEX(' ',replace(narr,'Being TDS on share of ',''),1))  

ELSE  
NARR  
END  
)
from #temp1  
where vno not in (select vno from #tempa)  
  


--select * from #tempa
--select * from #file1

if(@cltcode = '26100009' or @cltcode = '26100010')
begin
select a.*,state=isnull(b.state,''),Pan_no=isnull(b.pan_no,'')  
from #tempa a left outer join mis.sb_comp.dbo.SB_State_pan b on a.narration=b.sub_BRoker order by vno 
end 
else
begin
select a.*,state=isnull(b.state,''),Pan_no=isnull(b.pan_no,'') 
--from #tempa a mis.sb_comp.dbo.VendorMaster b where b.cltcode = a.alt_cltcode and b.segment = 'BSECM' order by a.vno
from #tempa a left outer join mis.sb_comp.dbo.VendorMaster b on (b.cltcode = a.alt_cltcode and b.segment = @segment ) order by vno 
end


set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing
-- --------------------------------------------------
CREATE procedure ANGEL_GLAgeing  
(  
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),  
@fromdate as varchar(11),@todate as varchar(11)  
)  
as  
  
set nocount on  
  
declare @fdate as datetime,@tdate as datetime  
set @fdate=convert(datetime,@fromdate+' 00:00')  
set @tdate=convert(datetime,@todate+' 23:59')  
  
  
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),  
Bal0to30=convert(money,0),  
Bal31to60=convert(money,0),  
Bal61to90=convert(money,0),  
Bal90to180=convert(money,0),  
Bal181to360=convert(money,0),  
Bal361above=convert(money,0)  
into #ageing  
from ledger where vdt >=@fdate and vdt <=@tdate  
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto  
group by cltcode  
  
  
  
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),  
value=sum(Case when drcr='D' then vamt else -vamt end)  
into #file1  
from ledger where vdt >=@fdate and vdt <=@tdate  
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto  
group by cltcode,convert(datetime,convert(varchar(11),vdt))  
  
--print @tdate-30  
update #ageing set Bal0to30=b.bal30days from  
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30  
group by cltcode) b where #ageing.cltcode=b.cltcode  
  
  
update #ageing set Bal31to60=b.bal60days from  
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60  
group by cltcode) b where #ageing.cltcode=b.cltcode  
  
  
update #ageing set Bal61to90=b.bal90days from  
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90  
group by cltcode) b where #ageing.cltcode=b.cltcode  
  
  
update #ageing set Bal90to180=b.bal180days from  
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180  
group by cltcode) b where #ageing.cltcode=b.cltcode  
  
  
update #ageing set Bal181to360=b.bal360days from  
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360  
group by cltcode) b where #ageing.cltcode=b.cltcode  
  
  
update #ageing set Bal361above=b.bal361days from  
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360   
group by cltcode) b where #ageing.cltcode=b.cltcode  
  

update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0
update #ageing set bal31to60=0 where value < 0 and bal0to30 <=0 and bal31to60 > 0
update #ageing set bal61to90=0 where value < 0 and (bal0to30+BAL31TO60) <=0 and bal61to90 > 0
update #ageing set bal90to180=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90) <=0 and bal90to180 > 0
update #ageing set bal181to360=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90+BAL90TO180) <=0 and bal181to360 > 0
update #ageing set bal361above=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90+BAL90TO180+bal181to360) <=0 and bal361above > 0

update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0
where value < 0 and bal0to30 < value

update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0
where value < 0 and (bal0to30+bal31to60) < value 

update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0
where value < 0 and (bal0to30+bal31to60+bal61to90) < value 

update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) < value 

update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) < value 

update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) < value 

------------------- Debit Balance

update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0
update #ageing set bal361above=0 where value > 0 and bal361above < 0



update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0
where value > 0 and bal0to30 >= value and bal0to30 > 0

update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0

update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0

update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0


update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value 
and bal181to360 > 0

update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value 
and bal361above > 0



select x.*,SBcode=isnull(y.sbcode,'') from  
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x  
left outer join   
(select * from mis.remisior.dbo.remi_ledcode where coname='ACDLNCDX') y   
on x.cltcode=y.ledgercode  
  

  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing_New
-- --------------------------------------------------
create procedure ANGEL_GLAgeing_New        
(        
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),        
@fromdate as varchar(11),@todate as varchar(11)        
)        
as        
 --This is the rectified query by sachin dewoolkar  & alok Jain on 12/06/2009 (cr Caluclation logic has been change to reverse of dr.)  
--before any modification contact to Sachin dewoolkar or alok jain.
set nocount on        
        
declare @fdate as datetime,@tdate as datetime        
set @fdate=convert(datetime,@fromdate+' 00:00')        
set @tdate=convert(datetime,@todate+' 23:59')        
        
        
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),        
Bal0to30=convert(money,0),        
Bal31to60=convert(money,0),        
Bal61to90=convert(money,0),        
Bal90to180=convert(money,0),        
Bal181to360=convert(money,0),        
Bal361above=convert(money,0)        
into #ageing        
from ledger where vdt >=@fdate and vdt <=@tdate        
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto        
group by cltcode        
        
        
        
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),        
value=sum(Case when drcr='D' then vamt else -vamt end)        
into #file1        
from ledger where vdt >=@fdate and vdt <=@tdate        
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto        
group by cltcode,convert(datetime,convert(varchar(11),vdt))        
        
--print @tdate-30        
update #ageing set Bal0to30=b.bal30days from        
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal31to60=b.bal60days from        
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal61to90=b.bal90days from        
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal90to180=b.bal180days from        
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal181to360=b.bal360days from        
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal361above=b.bal361days from        
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360         
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
      
update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0      
update #ageing set bal31to60=0 where value < 0 and bal31to60 > 0      
update #ageing set bal61to90=0 where value < 0 and bal61to90 > 0      
update #ageing set bal90to180=0 where value < 0 and bal90to180 > 0      
update #ageing set bal181to360=0 where value < 0 and bal181to360 > 0      
update #ageing set bal361above=0 where value < 0 and bal361above > 0      



update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value < 0 and bal0to30 <= value and bal0to30 < 0      

update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value < 0 and bal0to30+bal31to60 <= value and bal31to60 < 0      

update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0      
where value < 0 and (bal0to30+bal31to60+bal61to90) <= value and bal61to90 < 0      

update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0      
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) <= value and bal90to180 < 0      

update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0      
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) <= value       
and bal181to360 < 0      

update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)      
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) <= value       
and bal361above < 0   
      
      
------------------- Debit Balance      
      
update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0      
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0      
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0      
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0      
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0      
update #ageing set bal361above=0 where value > 0 and bal361above < 0      
      
      
      
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value > 0 and bal0to30 >= value and bal0to30 > 0      
      
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0      
      
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0      
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0      
      
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0      
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0      
      
      
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0      
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value       
and bal181to360 > 0      
      
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)      
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value       
and bal361above > 0      
      
      
      
select x.*,SBcode=isnull(y.sbcode,'') from        
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x        
left outer join         
(select  top 1 * from mis.remisior.dbo.remi_ledcode where coname='ACDLNCDX' ) y         
on x.cltcode=y.ledgercode        
          
        
      
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_KNOCKOFF_CANCEL_RECO
-- --------------------------------------------------
CREATE PROCEDURE ANGEL_KNOCKOFF_CANCEL_RECO
AS

select * into #bse_dr from ledger where vdt >='Aug  1 2007 00:00' and vtyp=3 and drcr='D' 
and cltcode>='A0001' and cltcode<='ZZZZZ'

select ddno,vno,lno into #chqnodr from ledger1 where vtyp=3 and vno >='200708010000'  
  
select a.*,b.ddno into #bse1dr from #bse_dr a, #chqnodr b where a.vno=b.vno and a.lno=b.lno  


DELETE FROM Angel_client_deposit_recno WHERE ACCNO+'|'+VNO+'|'+DDNO+'|'+CLTCODE IN
(
select A.ACCNO+'|'+A.VNO+'|'+A.DDNO+'|'+A.CLTCODE from Angel_client_deposit_recno a, #bse1dr b 
where a.cltcode=b.cltcode and a.ddno=b.ddno and a.Cramt=b.vamt
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_reco_acc
-- --------------------------------------------------
CREATE procedure angel_reco_acc(@brcode as varchar(10))  
as  
set nocount on  
  
set transaction isolation level read uncommitted  
select * into #brcli from intranet.risk.dbo.finmast where sbtag=@brcode  
  
set transaction isolation level read uncommitted  
select accno,longname, last_date,amount=sum(cramt) from angel_client_deposit_recno a (nolock), acmast b (nolock), #brcli c (nolock)  
where a.accno=b.cltcode and c.party_code=a.cltcode   
group by accno,last_date,longname order by amount desc  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_reco_acc1
-- --------------------------------------------------
CREATE procedure angel_reco_acc1(@brcode as varchar(10))      
as      
set nocount on      
      
set transaction isolation level read uncommitted      
select * into #brcli from intranet.risk.dbo.finmast where sbtag=@brcode   
      
set transaction isolation level read uncommitted      
select accno,longname, last_date,amount=sum(cramt) from angel_client_deposit_recno a (nolock), acmast b (nolock), #brcli c (nolock)      
where a.accno=b.cltcode and c.party_code=a.cltcode  
and a.vdt <= convert(varchar(11),getdate()-6)+' 23:59:59'       
group by accno,last_date,longname order by amount desc      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_reco_acc2
-- --------------------------------------------------
CREATE procedure angel_reco_acc2
as      
set nocount on      
      
set transaction isolation level read uncommitted      
select accno,longname, last_date,amount=sum(cramt) from angel_client_deposit_recno a (nolock), acmast b (nolock)    
where a.accno=b.cltcode 
and a.vdt <= convert(varchar(11),getdate()-6)+' 23:59:59'       
group by accno,last_date,longname order by amount desc      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_update_sb_glcode
-- --------------------------------------------------
CREATE procedure angel_update_sb_glcode    
as    
    
set transaction isolation level read uncommitted    
set nocount on    
    
select * into #file1 from mis.remisior.dbo.remi_ledcode where coname='ACDLNCDX' AND LEDGERCODE <> '' 
    
insert into acmast    
select     
name,name,'LIABILITIE',3,'BOI01',ledgercode,name,'L0303000000','',0,branch_Code,0,'P','HDFC BANK','',''    
from #file1 a, (select distinct sub_Broker, Name, branch_code from ncdx.dbo.subbrokers )b where a.sbcode=b.sub_Broker     
and ledgercode not in (select cltcode from acmast)     
    
select distinct subbrokercode,srname,calctype,c.branch_Code 
into #abc
from 
(
select distinct subbrokercode,calctype from mis.remisior.dbo.angelsubbrok where company='ACPLNCDX' and calctype<>''
) a,
(SELECT srcode,srname from mis.remisior.dbo.srmast where company='ACPLNCDX') b,
(select sub_Broker,branch_code from ncdx.dbo.subbrokers ) c
where a.subbrokercode=b.srcode and c.sub_Broker=a.calctype

select distinct subbrokercode,srname,branch_code into #fff from #abc

--- audit system required
/*
update #abc set branch_code = b.branch_code from #fff b where #abc.subbrokercode=b.subbrokercode
drop table #fff

select subbrokercode,srname,branch_Code from #abc

update #fff set branch_code='XF' where subbrokercode = 'MJJ1'
update #fff set branch_code='HO' where subbrokercode = 'MRU1'
update #fff set branch_code='BVI' where subbrokercode = 'RMK1'
update #fff set branch_code='YB' where subbrokercode = 'VCM1'
update #fff set branch_code='XD' where subbrokercode = 'VSG1'

select * from #fff where subbrokercode in 
(select subbrokercode  from #fff group by subbrokercode having count(*) > 1)

select * from #abc where subbrokercode in 
(select subbrokercode  from #fff group by subbrokercode having count(*) > 1)
*/
--------------------------------

insert into acmast  
select   
name,name,'LIABILITIE',3,'BOI01',ledgercode,name,'L0303000000','',0,branch_Code,0,'P','HDFC BANK','',''
from #file1 a, 
(
select sub_Broker=subbrokercode,name=srname,branch_code from #fff
)b where a.sbcode=b.sub_Broker   
and ledgercode not in (select cltcode from acmast)   

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTOJV_BULK
-- --------------------------------------------------
-- select  convert(varchar,getdate(),103), convert(varchar,getdate(),12)+right(replace(convert(varchar,getdate(),114),':',''),6) From Owner  
CREATE PROC [dbo].[AUTOJV_BULK]    
(    
 @PROCESS_ID VARCHAR(25),    
 @UNAME VARCHAR(25),    
 @VTYP SMALLINT,    
 @BOOKTYPE VARCHAR(2),    
 @USERCAT INT    
)    
    
AS    
 /*    
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV'    
 EXEC DRCRNOTEUPLOAD_BULK 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV', 'TEST', 6, '01'    
 EXEC DRCRNOTEUPLOAD_BULK 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV', 'TEST', 6, '01'    
 */    
 SET NOCOUNT ON    
    
 DECLARE    
  @@ERROR_COUNT AS INT,    
  @@SQL AS VARCHAR(2000),    
  @@BACKDAYS INT,    
  @@BACKDATE DATETIME    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE_TMP]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_RECPAY_TABLE_TMP]    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_RECPAY_TABLE]    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE_LNO]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_RECPAY_TABLE_LNO]    
      
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_VNO]') AND TYPE IN (N'U'))    
  DROP TABLE [DBO].[TMP_VNO]    
      
 CREATE TABLE TMP_RECPAY_TABLE_TMP    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  GL_CODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(500),    
  BRANCHCODE VARCHAR(10)    
 )    
    
 CREATE TABLE [TMP_RECPAY_TABLE]    
 (    
  SRNO INT,    
  VVDT VARCHAR(10),    
  EEDT VARCHAR(10),    
  CLTCODE VARCHAR(10),    
  DRCR VARCHAR(1),    
  AMOUNT MONEY,    
  NARRATION VARCHAR(500),    
  BRANCHCODE VARCHAR(10),    
  SNO INT IDENTITY (1, 1) NOT NULL ,    
  VDT DATETIME NULL ,    
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),    
  EDT DATETIME NULL ,    
  VNO VARCHAR (12)  NULL ,    
  ACNAME VARCHAR (100)  NULL ,    
  FYSTART DATETIME NULL,    
  FYEND DATETIME NULL,    
  COSTCODE SMALLINT NULL,    
  LNO SMALLINT NOT NULL DEFAULT(0)    
 ) ON [PRIMARY]    
    
 CREATE TABLE [TMP_RECPAY_TABLE_LNO]    
 (    
  SNO INT,    
  LNO INT IDENTITY (1, 1) NOT NULL    
 ) ON [PRIMARY]    
     
 INSERT INTO     
  TMP_RECPAY_TABLE_TMP    
 SELECT  
  FLDAUTO,     
  VVDT = CONVERT(VARCHAR(10), GETDATE(), 103),    
  EEDT = CONVERT(VARCHAR(10), GETDATE(), 103),    
  CLTCODE = PARTYCODE,    
  GL_CODE = CASE WHEN EXCHANGEFR = ACCOUNTDB THEN GLCODEFR ELSE GLCODETO END,    
  DRCR = CASE WHEN EXCHANGEFR = ACCOUNTDB THEN 'D' ELSE 'C' END ,    
  AMOUNT = JVAMT,    
  NARRATION /*= 'FUND TRNASFER'*/,    
  BRANCHCODE = 'ALL'    
 FROM     
  ACCOUNT_AB.DBO.OFFLINE_JV_ENTRIES J WITH (NOLOCK), OWNER O WITH (NOLOCK)    
 WHERE     
  (J.EXCHANGEFR = O.ACCOUNTDB OR EXCHANGETO = O.ACCOUNTDB) AND PROCESS_ID = @PROCESS_ID  
  AND (VCHNOFR IS NULL OR VCHNOTO IS NULL)  
      
 INSERT INTO     
  TMP_RECPAY_TABLE    
 (    
  SRNO,    
  VVDT,    
  EEDT,    
  CLTCODE,    
  DRCR,    
  AMOUNT,    
  NARRATION,    
  BRANCHCODE    
 )    
 SELECT    
  SRNO,    
  VVDT,    
  EEDT,    
  UPPER(CLTCODE),    
  DRCR,    
  AMOUNT,    
  LEFT(NARRATION, 234),    
  BRANCHCODE    
 FROM     
  TMP_RECPAY_TABLE_TMP    
    
 INSERT INTO     
  TMP_RECPAY_TABLE    
 (    
  SRNO,    
  VVDT,    
  EEDT,    
  CLTCODE,    
  DRCR,    
  AMOUNT,    
  NARRATION,    
  BRANCHCODE    
 )    
 SELECT    
  SRNO,    
  VVDT,    
  EEDT,    
  GL_CODE,    
  DRCR = CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END,    
  AMOUNT,    
  LEFT(NARRATION, 234),    
  BRANCHCODE    
 FROM     
  TMP_RECPAY_TABLE_TMP    
    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET    
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
  FYSTART = P.SDTCUR,    
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,    
  TMP_RECPAY_TABLE.COSTCODE = C.COSTCODE    
 FROM     
  ACMAST A,     
  PARAMETER P,     
  COSTMAST C    
 WHERE     
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE    
  AND P.CURYEAR = 1    
  AND A.ACCAT IN ('3','4','104')    
  AND A.BRANCHCODE = C.COSTNAME    
  AND A.BRANCHCODE <> 'ALL'    
    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET    
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
  FYSTART = P.SDTCUR,    
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,    
  TMP_RECPAY_TABLE.COSTCODE = C.COSTCODE    
 FROM     
  ACMAST A,     
  PARAMETER P,     
  COSTMAST C    
 WHERE     
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE    
  AND P.CURYEAR = 1    
  AND A.ACCAT IN ('3','4','104')    
  AND TMP_RECPAY_TABLE.BRANCHCODE = C.COSTNAME    
  AND A.BRANCHCODE = 'ALL'    
  AND TMP_RECPAY_TABLE.BRANCHCODE <> 'ALL'    
  AND TMP_RECPAY_TABLE.COSTCODE IS NULL    
    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET    
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),    
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),    
  FYSTART = P.SDTCUR,    
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,    
  TMP_RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
 FROM     
  ACMAST A,     
  PARAMETER P    
 WHERE     
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE    
  AND P.CURYEAR = 1    
  AND A.ACCAT IN ('3','4','104')    
  AND A.BRANCHCODE = 'ALL'    
  AND TMP_RECPAY_TABLE.BRANCHCODE = 'ALL'    
  AND TMP_RECPAY_TABLE.COSTCODE IS NULL    
    
 ---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------    
 UPDATE    
  TMP_RECPAY_TABLE    
 SET     
  UPDFLAG = 'N'    
 FROM    
 (    
 SELECT    
  PARTY_CODE,    
  INACTIVEFROM    
 FROM     
  MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK),    
  MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)    
 WHERE     
  C2.CL_CODE = C5.CL_CODE    
  AND C2.PARTY_CODE IN (SELECT CLTCODE FROM TMP_RECPAY_TABLE)    
  AND INACTIVEFROM <= GETDATE()    
 ) C    
 WHERE     
  CLTCODE = C.PARTY_CODE    
    
 /* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/    
    
 DECLARE    
  @@STD_DATE VARCHAR(11),    
  @@LST_DATE VARCHAR(11),    
  @@VNOMETHOD INT,    
  @@ACNAME CHAR(100),    
  @@MICRNO VARCHAR(10),    
  @@DRCR VARCHAR(1)    
    
 /* '--------------------------UPDATE OF COST CODE ------------------------*/    
    
 UPDATE     
  TMP_RECPAY_TABLE    
 SET     
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')    
 WHERE     
  COSTCODE IS NULL    
    
 DECLARE    
  @@NEWVNO AS VARCHAR(12),    
  @@VDT AS VARCHAR(11),    
  @@LNOCUR AS CURSOR,    
  @@LNOVNO AS INT,    
  @@NOREC AS INT    
    
 /* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/    
 DECLARE    
  @@MAXVNO AS VARCHAR(12),    
  @@VNO AS VARCHAR(12),    
  @@RCOUNT AS INT    
      
 SELECT TOP 1    
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)    
 FROM    
  TMP_RECPAY_TABLE    
    
 SELECT TOP 1    
  @@VNOMETHOD = VNOFLAG,    
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),    
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)    
 FROM    
  PARAMETER    
 WHERE    
  @@VDT BETWEEN SDTCUR AND LDTCUR    
    
 SELECT    
  @@NOREC = COUNT(DISTINCT SRNO)    
 FROM    
  TMP_RECPAY_TABLE    
    
 CREATE TABLE TMP_VNO    
 (    
  LASTVNO VARCHAR(12)    
 )    
    
 INSERT INTO TMP_VNO    
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC    
    
 SELECT @@VNO = LASTVNO FROM TMP_VNO    
   
 CREATE TABLE #VNO_GEN  
 (  
 SNO INT IDENTITY(1, 1),  
 SRNO INT  
)  
  
INSERT INTO #VNO_GEN  
SELECT SRNO  FROM TMP_RECPAY_TABLE ORDER BY SRNO  
  
  
 UPDATE    
  TMP_RECPAY_TABLE    
 SET     
  VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + V.SNO - 1)    
  FROM #VNO_GEN V  
  WHERE V.SRNO  = TMP_RECPAY_TABLE.SRNO  
    
 /* '--------------------------AUTO GENERATION OF LNO ------------------------*/    
    
 SET @@LNOCUR = CURSOR FOR    
  SELECT DISTINCT SRNO FROM TMP_RECPAY_TABLE    
  OPEN @@LNOCUR    
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
  WHILE @@FETCH_STATUS = 0    
  BEGIN    
   INSERT INTO TMP_RECPAY_TABLE_LNO    
   (SNO)    
   SELECT SNO FROM TMP_RECPAY_TABLE WHERE SRNO = @@LNOVNO    
   UPDATE RP    
   SET LNO = RL.LNO    
   FROM TMP_RECPAY_TABLE RP, TMP_RECPAY_TABLE_LNO RL    
   WHERE RP.SNO = RL.SNO    
   TRUNCATE TABLE TMP_RECPAY_TABLE_LNO    
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO    
  END    
 CLOSE @@LNOCUR    
 DEALLOCATE @@LNOCUR    
     
 DROP TABLE TMP_RECPAY_TABLE_LNO    
 --SELECT * FROM TMP_RECPAY_TABLE    
 --RETURN    
    
 /* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/    
 /*==============================    
 LEDGER RECORD    
 ==============================*/    
    
 INSERT INTO    
  LEDGER    
 SELECT    
  VTYP = @VTYP,    
  VNO,    
  EDT,    
  LNO,    
  ACNAME,    
  DRCR,    
  VAMT = SUM(AMOUNT),    
  VDT,    
  VNO1 = VNO,    
  REFNO = 0,    
  BALAMT = SUM(AMOUNT),    
  NODAYS = 0,    
  CDT = GETDATE(),    
  CLTCODE,    
  BOOKTYPE = @BOOKTYPE,    
  ENTEREDBY = @UNAME,    
  PDT = GETDATE(),    
  CHECKEDBY = @UNAME,    
  ACTNODAYS = 0,    
  NARRATION    
 FROM    
  TMP_RECPAY_TABLE    
 GROUP BY    
  VNO,    
  EDT,    
  LNO,    
  ACNAME,    
  DRCR,    
  VDT,    
  CLTCODE,    
  NARRATION    
    
 /*==============================    
 LEDGER3 RECORD    
 ==============================*/    
 INSERT INTO    
  LEDGER3    
 SELECT    
  NARATNO = LNO,    
  NARRATION,    
  REFNO = 0,    
  VTYP = @VTYP,    
  VNO,    
  BOOKTYPE = @BOOKTYPE    
 FROM    
  TMP_RECPAY_TABLE    
    
 DELETE    
  TEMPLEDGER2    
 WHERE     
  SESSIONID = '9999999999'    
    
 INSERT INTO     
  TEMPLEDGER2    
 SELECT    
  'BRANCH',    
  C.COSTNAME,    
  AMOUNT,    
  VTYP = @VTYP,    
  VNO,    
  LNO,    
  DRCR,    
  '0',    
  BOOKTYPE = @BOOKTYPE,    
  SESSIONID = '9999999999',    
  CLIENT_CODE = CLTCODE,    
  'A',    
  '0'    
 FROM    
  TMP_RECPAY_TABLE RP,    
  COSTMAST C    
 WHERE    
  RP.COSTCODE = C.COSTCODE    
    
 DECLARE @@L2CUR AS CURSOR,    
  @@L2VNO AS VARCHAR(12)    
  SET @@L2CUR = CURSOR FOR    
  SELECT DISTINCT VNO FROM TMP_RECPAY_TABLE ORDER BY VNO    
  OPEN @@L2CUR    
  FETCH NEXT FROM @@L2CUR INTO @@L2VNO    
  WHILE @@FETCH_STATUS = 0    
  BEGIN    
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'    
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO    
  END    
  DELETE FROM TEMPLEDGER2    
  WHERE SESSIONID = '9999999999'    
 CLOSE @@L2CUR    
 DEALLOCATE @@L2CUR    
    
 SELECT     
  RESULT = 'DATA UPLOADED SUCCESSFULLY'    
 UNION ALL    
 SELECT     
  RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO     
 FROM     
  TMP_RECPAY_TABLE    
    
 --UPDATE     
 -- J     
 --SET    
 -- VCHNOFR = CASE WHEN O.ACCOUNTDB = J.EXCHANGEFR THEN R.VNO ELSE VCHNOFR END,    
 -- VCHNOTO = CASE WHEN O.ACCOUNTDB = J.EXCHANGETO THEN R.VNO ELSE VCHNOTO END    
 --FROM     
 -- ACCOUNT_AB.DBO.OFFLINE_JV_ENTRIES J, OWNER O,    
 -- TMP_RECPAY_TABLE R    
 --WHERE     
 -- SRNO = FLDAUTO     
 -- AND (O.ACCOUNTDB = EXCHANGEFR OR O.ACCOUNTDB = EXCHANGETO)    
    
 DROP TABLE TMP_RECPAY_TABLE_TMP    
 DROP TABLE TMP_RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ALLBANKS
-- --------------------------------------------------
CREATE PROC AUTORECOUPDATE_HDFC_ALLBANKS(      
           @FILENAME       VARCHAR(100),      
           @UNAME          VARCHAR(100),      
           @BANKCODE       VARCHAR(10),      
           @STATUSID       VARCHAR(10),      
           @STATUSNAME     VARCHAR(100),      
           @BANK_TYPE      VARCHAR(10),      
           @STAT_TYPE      VARCHAR(10),      
           @LOGIN          VARCHAR(10),      
           @PWD            VARCHAR(15),      
           @PROCESS_STATUS BIT  = 0)      
      
AS      
      
  DECLARE  @@SQL_QUERY         AS VARCHAR(1000),      
           @@CROSSREFERENCENO INT,      
           @@TABLE_EXIST      VARCHAR(20),      
           @@RECORD_COUNT     TINYINT,      
           @@RECO_STATUS      CHAR(1),      
           @@FILE_EXIST       INT,      
           @@CLTCODE_EXIST    INT,      
           @@MICRNO           VARCHAR(20)      
                                  
  SET NOCOUNT ON      
        
  SELECT @@CLTCODE_EXIST = COUNT(1)      
  FROM   ACMAST WITH(NOLOCK)       
  WHERE  CLTCODE = @BANKCODE      
         AND ACCAT = 2      
                           
  IF @@CLTCODE_EXIST = 0      
    BEGIN      
      SELECT 'BANK CODE DOSE NOT EXIST.'      
            
      RETURN      
    END      
  
         
  SELECT @@MICRNO = ISNULL(MICRNO,0)      
  FROM   ACMAST WITH(NOLOCK)       
  WHERE  CLTCODE = @BANKCODE      
         AND ACCAT = 2      
                           
  /*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
  DECLARE  @@ERROR_COUNT        SMALLINT,      
           @@EXIST_COUNT_BEFORE SMALLINT,      
           @@EXIST_COUNT_AFTER  SMALLINT      
        
  SELECT @@ERROR_COUNT = COUNT(1)      
  FROM   (SELECT U_FILENAME      
          FROM   V2_UPLOADED_FILES WITH(NOLOCK)       
          WHERE  U_FILENAME = @FILENAME      
                 AND U_MODULE = 'HDFC_RECO UPLOAD') A      
        
  SELECT @@CROSSREFERENCENO = ISNULL(MAX(CONVERT(NUMERIC,CROSSREFERENCENO)),0)      
  FROM   BANKRECO WITH(NOLOCK)       
               
  CREATE TABLE #HDFCRECO (      
    BOOKDATE VARCHAR(11))      
        
  CREATE TABLE #ICICIRECO (      
    SR_NO    INT,      
    TXN_ID   VARCHAR(25),      
    BOOKDATE VARCHAR(11))      
        
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'   
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"      
  END      
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'       
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"        
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"      
  END      
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'      
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"      
  END      
  ELSE IF @BANK_TYPE = 'ICICIRECO'       
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"      
       
  END      
        
  EXEC (@@SQL_QUERY)         
        
  IF @BANK_TYPE = 'ICICIRECO'       
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"      
        
   EXEC (@@SQL_QUERY)      
  END      
        
  CREATE TABLE [#BANKRECOSAVE_TEMP]            
   (            
    CLTCODE VARCHAR(10),            
    BOOKDATE DATETIME,            
    [DESCRIPTION] VARCHAR(50),            
    AMOUNT VARCHAR(20),            
    DRCR VARCHAR(1),            
    VALUEDATE DATETIME,            
    REFERENCENO VARCHAR(30),            
    STATUSID VARCHAR(15),            
    STATUSNAME VARCHAR(25),            
    LOGINNAME VARCHAR(25),            
    STATUS VARCHAR(9),            
    MICRNO INT,            
    DUMMY1 VARCHAR(15) ,            
    DUMMY2 VARCHAR(15),            
    AMOUNTLEDGR1 VARCHAR(20),            
    CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL            
   )            
  ON [PRIMARY]            
              
  CREATE TABLE [#BANKRECOSAVE]            
   (            
    CLTCODE VARCHAR(10),            
    BOOKDATE DATETIME,            
    [DESCRIPTION] VARCHAR(50),            
    AMOUNT MONEY,            
    DRCR VARCHAR(1),            
    VALUEDATE DATETIME,            
    REFERENCENO VARCHAR(30),            
    STATUSID VARCHAR(15),            
    STATUSNAME VARCHAR(25),            
    LOGINNAME VARCHAR(25),            
    CROSSREFERENCENO [INT],            
    STATUS VARCHAR(9),            
    MICRNO INT,            
    DUMMY1 VARCHAR(15) ,            
    DUMMY2 VARCHAR(15),            
    AMOUNTLEDGR1 MONEY,       
    L1_SNO INT,       
    VTYP SMALLINT,       
    BOOKTYPE CHAR(2),       
    VNO VARCHAR(12),       
    SLIPNO INT       
   )            
  ON [PRIMARY]           
        
  CREATE TABLE #TESTIMPORT                      
  (                      
   OneRow Varchar(2000),                    
   SNO INT IDENTITY(1,1)                    
  )         
        
  IF @BANK_TYPE = 'ICICIRECO'      
  BEGIN      
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"      
         
  END      
  ELSE IF @BANK_TYPE <> 'CANARARECO'      
  BEGIN      
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"      
  END      
        
  --PRINT @@SQL_QUERY      
  EXEC (@@SQL_QUERY)       
        
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'     
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"      
  END      
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'       
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "      
  END      
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'      
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"      
  END      
  ELSE IF @BANK_TYPE = 'ICICIRECO'      
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "      
  END      
  ELSE      
  BEGIN      
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "      
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "      
  END      
        
        
  EXEC (@@SQL_QUERY)      
        
  SELECT *      
  INTO   HDFCRECO      
  FROM   #HDFCRECO      
               
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'    
    BEGIN      
      UPDATE HDFCRECO      
      SET    [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE',      
             VALUEDATE = BOOKDATE      
    END      
  ELSE      
    IF (@BANK_TYPE = 'HDFCRECO'      
        AND @STAT_TYPE = 'TAB')      
        OR @BANK_TYPE = 'UTIRECO'      
      BEGIN      
        UPDATE HDFCRECO      
        SET    AMOUNT = CASE       
                          WHEN (DEBIT IS NULL       
                                 OR CONVERT(MONEY,DEBIT) = 0) THEN CREDIT      
                          ELSE DEBIT      
                        END,      
               DRCR = CASE       
                        WHEN (DEBIT IS NULL       
                               OR CONVERT(MONEY,DEBIT) = 0) THEN 'C'      
                        ELSE 'D'      
                      END      
      END      
    ELSE      
      IF @BANK_TYPE = 'ICICIRECO'      
        BEGIN      
          UPDATE HDFCRECO      
          SET    VALUEDATE = BOOKDATE,      
                 DRCR = (CASE       
                           WHEN DRCR = 'DR' THEN 'D'      
                           ELSE 'C'      
                         END)      
        END      
        
  IF @BANK_TYPE = 'CANARARECO'      
    BEGIN      
   SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"      
     EXEC(@@SQL_QUERY)                      
        
      DELETE FROM #TESTIMPORT      
      WHERE       ONEROW IS NULL      
                        
      DELETE FROM #TESTIMPORT      
      WHERE       ONEROW LIKE '****%'      
                                    
      INSERT INTO #BANKRECOSAVE_TEMP      
      SELECT @BANKCODE,      
             BOOKDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),      
                                103),      
             [DESCRIPTION] = SUBSTRING(ONEROW,18,23),      
             AMOUNT = SUBSTRING(ONEROW,41,14),      
             DRCR = SUBSTRING(ONEROW,17,1),      
             VALUEDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),      
                                 103),      
             REFERENCE_NO = SUBSTRING(ONEROW,9,8),      
             @STATUSID,      
             @STATUSNAME,      
             @UNAME,      
             'UNMATCHED',      
             @@MICRNO,      
             '',      
             '',      
             ''                   
      FROM   #TESTIMPORT      
                   
    END      
  ELSE      
    IF @BANK_TYPE = 'ICICIRECO'      
      BEGIN      
        INSERT INTO #BANKRECOSAVE_TEMP      
        SELECT @BANKCODE,      
               BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),      
                              101),      
               [DESCRIPTION],      
               AMOUNT,      
               DRCR,      
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE,2) + '-' + SUBSTRING(VALUEDATE,4,2)),      
               REFERENCE_NO,      
               @STATUSID,      
               @STATUSNAME,      
               @UNAME,      
               'UNMATCHED',      
               @@MICRNO,      
               '',      
               '',      
               ''      
        FROM   HDFCRECO      
                     
      END      
    ELSE      
      BEGIN      
        INSERT INTO #BANKRECOSAVE_TEMP      
        SELECT @BANKCODE,      
               BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),      
                                  103),      
               [DESCRIPTION],      
               AMOUNT,      
               DRCR,      
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE,4,2) + '-' + LEFT(VALUEDATE,2)),      
               REFERENCE_NO,      
               @STATUSID,      
               @STATUSNAME,      
               @UNAME,      
               'UNMATCHED',      
               @@MICRNO,      
               '',      
               '',      
               ''      
        FROM   HDFCRECO      
      END      
            
  DROP TABLE HDFCRECO      
        
  INSERT INTO #BANKRECOSAVE      
  SELECT @BANKCODE,      
         BOOKDATE,      
         [DESCRIPTION],      
         AMOUNT = CASE       
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))      
                    ELSE CONVERT(MONEY,AMOUNT)      
                  END,      
         DRCR,      
         VALUEDATE,      
         REFERENCENO = CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),      
         @STATUSID,      
         @STATUSNAME,      
         @UNAME,      
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),      
         'UNMATCHED',      
         @@MICRNO,      
         '',      
         '',      
         0,       
         0,       
         0,       
         '',       
         '',       
         0       
  FROM   #BANKRECOSAVE_TEMP      
  WHERE  REFERENCENO NOT LIKE '%[A-Z]%'      
                                    
  INSERT INTO #BANKRECOSAVE      
  SELECT @BANKCODE,      
         BOOKDATE,      
         [DESCRIPTION],      
         AMOUNT = CASE       
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))      
                    ELSE CONVERT(MONEY,AMOUNT)      
                  END,      
         DRCR,      
         VALUEDATE,      
         REFERENCENO,      
         @STATUSID,      
         @STATUSNAME,      
         @UNAME,      
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),      
         'UNMATCHED',      
         @@MICRNO,      
         '',      
         '',      
         0,       
         0,       
         0,       
         '',       
         '',       
         0       
  FROM   #BANKRECOSAVE_TEMP      
  WHERE  REFERENCENO LIKE '%[A-Z]%'      
                                
  INSERT INTO #BANKRECOSAVE      
  SELECT @BANKCODE,      
         BOOKDATE,      
         [DESCRIPTION],      
         AMOUNT = CASE       
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))      
                    ELSE CONVERT(MONEY,AMOUNT)      
                  END,      
         DRCR,      
         VALUEDATE,      
         REFERENCENO = ISNULL(CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),      
                              0),      
         @STATUSID,      
         @STATUSNAME,      
         @UNAME,      
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),      
         'UNMATCHED',      
         @@MICRNO,      
         '',      
         '',      
         0,       
         0,       
         0,       
         '',       
         '',       
         0       
  FROM   #BANKRECOSAVE_TEMP      
  WHERE  REFERENCENO IS NULL      
               
  IF @BANK_TYPE = 'CANARARECO'      
    BEGIN      
      UPDATE #BANKRECOSAVE      
      SET    AMOUNT = CONVERT(MONEY,AMOUNT / 100)      
    END      
          
  /*CREATE TABLE #BANKRECOSAVE_DELETE            
  (            
   [DESCRIPTION] VARCHAR(250),            
   AMOUNT MONEY,            
   DRCR CHAR(1),            
   REFERENCENO VARCHAR(25),            
  CROSSREFERENCENO INT            
  ) */      
  DECLARE  @@AMOUNTDIFF   MONEY,      
           @@STAMOUNTDIFF MONEY,      
           @@BOOKDATE_MIN DATETIME,      
           @@BOOKDATE_MAX DATETIME      
                                
  SELECT @@BOOKDATE_MIN = MIN(BOOKDATE)      
  FROM   #BANKRECOSAVE      
               
  SELECT @@BOOKDATE_MAX = MAX(BOOKDATE)      
  FROM   #BANKRECOSAVE      
               
  CREATE TABLE #RECODUPS (      
    BOOKDATE         VARCHAR(11),      
    REFERENCENO      VARCHAR(25),      
    AMOUNT           MONEY,      
    DESCRIPTION      VARCHAR(200),      
    STATUS           VARCHAR(10),      
    CROSSREFERENCENO INT)      
        
  SET @@EXIST_COUNT_BEFORE = 0      
                                   
  SET @@EXIST_COUNT_AFTER = 0      
                                  
  DECLARE  @CLTCODE     VARCHAR(10),      
           @BOOKDATE    DATETIME,      
           @AMOUNT      MONEY,      
           @DRCR        CHAR(1),      
           @VALUEDATE   DATETIME,      
           @REFERENCENO VARCHAR(20),      
           @DESCRIPTION VARCHAR(200)      
                              
  DECLARE CUR_CHECCK CURSOR  FOR      
  SELECT CLTCODE,      
         BOOKDATE,      
         AMOUNT,      
         DRCR,      
         VALUEDATE,      
         REFERENCENO,      
         [DESCRIPTION]      
  FROM   #BANKRECOSAVE      
  WHERE  AMOUNT < 0      
                        
  OPEN CUR_CHECCK      
        
  FETCH NEXT FROM CUR_CHECCK      
  INTO @CLTCODE,      
       @BOOKDATE,      
       @AMOUNT,      
       @DRCR,      
       @VALUEDATE,      
       @REFERENCENO,      
       @DESCRIPTION      
             
  WHILE @@FETCH_STATUS = 0      
    BEGIN      
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
      IF @PROCESS_STATUS = 0      
        BEGIN      
          SELECT @@ERROR_COUNT = 0      
                                       
          SELECT @@EXIST_COUNT_BEFORE = COUNT(1)      
          FROM   BANKRECO WITH(NOLOCK)      
          WHERE  CLTCODE = @CLTCODE      
                 AND BOOKDATE = @BOOKDATE      
                 AND AMOUNT = ABS(@AMOUNT)      
                 AND DRCR = @DRCR      
                 AND VALUEDATE = @VALUEDATE      
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')      
        END      
              
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
      SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)      
      FROM   #BANKRECOSAVE      
      WHERE  [DESCRIPTION] = @DESCRIPTION      
             AND AMOUNT = ABS(@AMOUNT)      
             AND DRCR = @DRCR      
             AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')      
             AND AMOUNT > 0      
                                
      DELETE BR      
      FROM   #BANKRECOSAVE BR      
      WHERE  BR.CROSSREFERENCENO = @@CROSSREFERENCENO      
                                         
      IF @PROCESS_STATUS = 0      
        BEGIN      
          SELECT @@EXIST_COUNT_AFTER = COUNT(1)      
          FROM   #BANKRECOSAVE      
          WHERE  [DESCRIPTION] = @DESCRIPTION      
                 AND AMOUNT = ABS(@AMOUNT)      
                 AND DRCR = @DRCR      
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')      
                 AND AMOUNT > 0      
                                    
          IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER      
            BEGIN      
              INSERT INTO #RECODUPS      
              SELECT BOOKDATE = CONVERT(VARCHAR(11),BR.BOOKDATE,103),      
                     BR.REFERENCENO,    
                     BR.AMOUNT,      
                     BR.[DESCRIPTION],      
                     BR.STATUS,      
                     BR.CROSSREFERENCENO      
              FROM   (SELECT *      
                      FROM   BANKRECO WITH(NOLOCK)      
                      WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'      
                             AND CLTCODE = @BANKCODE) BR      
              WHERE  CLTCODE = @CLTCODE      
                     AND BOOKDATE = @BOOKDATE      
                     AND AMOUNT = ABS(@AMOUNT)      
                     AND DRCR = @DRCR      
                     AND VALUEDATE = @VALUEDATE      
                     AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')      
            END      
                  
          SET @@EXIST_COUNT_BEFORE = 0      
                                           
          SET @@EXIST_COUNT_AFTER = 0      
        END      
              
      FETCH NEXT FROM CUR_CHECCK      
      INTO @CLTCODE,      
           @BOOKDATE,      
           @AMOUNT,      
           @DRCR,      
           @VALUEDATE,      
           @REFERENCENO,      
           @DESCRIPTION      
    END      
          
  DELETE FROM #BANKRECOSAVE      
  WHERE       AMOUNT < 0      
                             
  SELECT @@ERROR_COUNT = COUNT(1)      
  FROM   #RECODUPS      
               
  IF @@ERROR_COUNT > 0      
    BEGIN      
      SELECT *      
      FROM   #RECODUPS      
                   
      RETURN      
    END      
          
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
  DELETE BR      
  FROM   BANKRECO B WITH(ROWLOCK),      
         #BANKRECOSAVE BR      
  WHERE  LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE))      
         AND CONVERT(VARCHAR(11),B.BOOKDATE,109) = CONVERT(VARCHAR(11),BR.BOOKDATE,109)      
         AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))      
         AND B.AMOUNT = BR.AMOUNT      
         AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR))      
         AND CONVERT(VARCHAR(11),B.VALUEDATE,109) = CONVERT(VARCHAR(11),BR.VALUEDATE,109)      
         AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)),'') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)),'')      
                                                            
  SELECT @@ERROR_COUNT = COUNT(1)      
  FROM   #BANKRECOSAVE      
  WHERE  VALUEDATE IS NOT NULL      
               
  IF @@ERROR_COUNT = 0      
    BEGIN      
      SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'      
          
      RETURN      
    END      
          
  SELECT @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)      
  FROM   (SELECT AMOUNT      
          FROM   #BANKRECOSAVE      
          WHERE  [DESCRIPTION] = 'OPENING BALANCE') BR,  
         (SELECT AMOUNT      
          FROM   #BANKRECOSAVE      
          WHERE  [DESCRIPTION] = 'CLOSING BALANCE') BR1      
               
  IF @PROCESS_STATUS = 1      
    BEGIN      
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))      
      FROM   (SELECT AMOUNT = (CASE DRCR       
                                    WHEN 'D' THEN SUM(AMOUNT)      
                                    ELSE -SUM(AMOUNT)      
                                  END)      
              FROM   BANKRECO B WITH (NOLOCK)      
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX      
                     AND CLTCODE = @BANKCODE      
                     AND NOT EXISTS (SELECT CROSSNO      
                                                  FROM   RECODUPS1 R WHERE R.CROSSNO = B.CROSSREFERENCENO)      
              GROUP BY DRCR       
              UNION ALL      
              SELECT AMOUNT = (CASE DRCR       
                                    WHEN 'D' THEN SUM(AMOUNT)      
                                    ELSE -SUM(AMOUNT)      
                                  END)      
              FROM   #BANKRECOSAVE      
              WHERE  VALUEDATE IS NOT NULL      
              GROUP BY DRCR) B      
 END      
  ELSE      
    BEGIN      
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))      
      FROM   (SELECT AMOUNT = (CASE DRCR       
                                    WHEN 'D' THEN SUM(AMOUNT)      
                                    ELSE -SUM(AMOUNT)      
                                  END)      
              FROM   BANKRECO B WITH (NOLOCK)      
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX      
                     AND CLTCODE = @BANKCODE      
              GROUP BY DRCR       
              UNION ALL      
              SELECT AMOUNT = (CASE DRCR       
                                    WHEN 'D' THEN SUM(AMOUNT)      
                                    ELSE -SUM(AMOUNT)      
                                  END)      
              FROM   #BANKRECOSAVE      
              WHERE  VALUEDATE IS NOT NULL      
              GROUP BY DRCR) B      
    END      
          
  IF @@AMOUNTDIFF <> @@STAMOUNTDIFF      
    BEGIN      
      SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'      
                   
      RETURN      
    END      
          
  DELETE FROM #BANKRECOSAVE      
  WHERE       VALUEDATE IS NULL      
                    
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */      
  SET @@TABLE_EXIST = ''      
                            
  SELECT @@TABLE_EXIST = NAME      
  FROM   SYSOBJECTS      
  WHERE  NAME = 'RECOPROCESS'      
                      
  IF @@TABLE_EXIST = ''      
    BEGIN      
      CREATE TABLE RECOPROCESS (      
        INPROCESS VARCHAR(1))      
            
      INSERT INTO RECOPROCESS      
                 (INPROCESS)      
      VALUES     ('N')      
    END      
          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED      
        
    SELECT @@RECORD_COUNT = COUNT(* )      
  FROM   RECOPROCESS      
               
  IF @@RECORD_COUNT = 0      
    BEGIN      
      INSERT INTO RECOPROCESS      
                 (INPROCESS)      
      VALUES     ('N')      
    END      
          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED      
        
  SELECT TOP 1 @@RECO_STATUS = INPROCESS      
  FROM   RECOPROCESS WITH (NOLOCK)      
               
  IF @@RECO_STATUS = 'N'      
    BEGIN      
      BEGIN TRAN      
            
      UPDATE RECOPROCESS      
      SET    INPROCESS = 'Y'      
    END      
  ELSE      
    BEGIN      
      SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'      
                   
      RETURN      
    END      
          
  INSERT INTO V2_UPLOADED_FILES      
  SELECT @FILENAME,      
         @FILENAME,      
         COUNT(1),      
         'B',      
         GETDATE(),      
         @UNAME,      
         'HDFC_RECO UPLOAD'      
               
  UPDATE #BANKRECOSAVE      
  SET    STATUS = 'MATCHED',       
         L1_SNO = LEDGER1.L1_SNO,       
         VTYP = LEDGER1.VTYP,       
         BOOKTYPE = LEDGER1.BOOKTYPE,       
         VNO = LEDGER1.VNO       
  FROM   LEDGER1 WITH (NOLOCK)      
  WHERE  (LEDGER1.VTYP = 2      
           OR LEDGER1.VTYP = 3      
           OR LEDGER1.VTYP = 5      
           OR LEDGER1.VTYP = 17      
           OR LEDGER1.VTYP = 19      
           OR LEDGER1.VTYP = 20)      
         AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
         AND RTRIM(DDNO) = RTRIM(REFERENCENO)      
         AND CLTCODE = @BANKCODE      
         AND #BANKRECOSAVE.MICRNO = @@MICRNO    
         AND LEDGER1.RELDT = ''  
		 AND #BANKRECOSAVE.AMOUNT = LEDGER1.RELAMT
         AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT)      
                                     FROM   LEDGER1 L1 WITH(NOLOCK),      
                                            LEDGER L2 WITH(NOLOCK)      
                                     WHERE  L2.VNO = L1.VNO      
                                            AND L2.VTYP = L1.VTYP      
                                            AND L2.BOOKTYPE = L1.BOOKTYPE      
                                            AND RELDT = ''      
                                            AND CLTCODE = @BANKCODE      
                                            AND #BANKRECOSAVE.REFERENCENO = DDNO      
                                            AND #BANKRECOSAVE.DRCR = L1.DRCR      
                                            AND CONVERT(DATETIME, CONVERT(VARCHAR(11),#BANKRECOSAVE.VALUEDATE,101)) >= CONVERT(DATETIME, CONVERT(VARCHAR(11),VDT,101)))      
         AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO,0)      
         AND REFERENCENO <> '0'      
                                  
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
          
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
      
  UPDATE LEDGER1 WITH (ROWLOCK)      
  SET    RELDT = VALUEDATE,      
         REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
  FROM   #BANKRECOSAVE        
  WHERE  #BANKRECOSAVE.L1_SNO <> 0       
         AND LEDGER1.L1_SNO = #BANKRECOSAVE.L1_SNO       
      
                                                          
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
          
  UPDATE #BANKRECOSAVE      
  SET    AMOUNTLEDGR1 = BANKRECOCOMP.AMOUNT,      
         STATUS = 'MATCHED',       
         SLIPNO = BANKRECOCOMP.SLIPNO       
  FROM   (SELECT   SUM(RELAMT)   AS AMOUNT,      
                   SLIPNO        AS SLIPNO,      
                   UPPER(DRCR)   AS DRCR,      
                   MICRNO      
          FROM     LEDGER1 WITH(NOLOCK)      
          WHERE    MICRNO = @@MICRNO      
                   AND (VTYP = 2      
                         OR VTYP = 19      
                         OR VTYP = 5)      
                   AND SLIPNO <> ''      
                   AND RELDT = ''       
          GROUP BY SLIPNO,DRCR,MICRNO) BANKRECOCOMP      
  WHERE  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)      
         AND RTRIM(BANKRECOCOMP.SLIPNO) = RTRIM(REFERENCENO)      
         AND #BANKRECOSAVE.MICRNO = @@MICRNO      
         AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
   AND #BANKRECOSAVE.MICRNO = BANKRECOCOMP.MICRNO      
         AND REFERENCENO <> '0'      
                                  
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
      
  SELECT L1.VTYP,       
         L1.BOOKTYPE,       
         L1.VNO,       
         L1.L1_SNO,       
         #BANKRECOSAVE.VALUEDATE,       
         #BANKRECOSAVE.CROSSREFERENCENO       
  INTO   #LEDGER_UPDATES_FOR_SLIPS       
  FROM   #BANKRECOSAVE,       
         LEDGER1 L1 WITH(NOLOCK)       
  WHERE  L1.MICRNO = @@MICRNO         
         AND L1.SLIPNO = #BANKRECOSAVE.SLIPNO       
         AND #BANKRECOSAVE.SLIPNO <> 0       
      
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
          
  UPDATE LEDGER1 WITH (ROWLOCK)      
  SET    RELDT = VALUEDATE,      
         REFNO = #LEDGER_UPDATES_FOR_SLIPS.CROSSREFERENCENO      
  FROM   #LEDGER_UPDATES_FOR_SLIPS      
  WHERE  #LEDGER_UPDATES_FOR_SLIPS.L1_SNO <> 0       
         AND LEDGER1.L1_SNO = #LEDGER_UPDATES_FOR_SLIPS.L1_SNO       
                                    
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
          
  UPDATE L      
  SET    EDT = (CASE       
                  WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),VDT,109))) THEN VDT      
                  ELSE VALUEDATE      
                END)      
  FROM   LEDGER L WITH (ROWLOCK),      
         (SELECT VTYP,      
                 BOOKTYPE,      
                 VNO,      
                 VALUEDATE      
          FROM   #BANKRECOSAVE      
          WHERE  VNO <> ''      
          UNION       
          SELECT VTYP,      
                 BOOKTYPE,      
                 VNO,      
                 VALUEDATE      
          FROM   #LEDGER_UPDATES_FOR_SLIPS      
          WHERE  VNO <> '') LU      
  WHERE  LU.VNO = L.VNO      
         AND LU.VTYP = L.VTYP      
         AND LU.BOOKTYPE = L.BOOKTYPE      
         AND EDT LIKE 'DEC 31 2049%'      
                            
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
          
  IF @@ERROR <> 0      
    BEGIN      
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'      
                   
      ROLLBACK TRAN      
            
      RETURN      
    END      
          
  IF @PROCESS_STATUS = 1      
    BEGIN      
      DELETE FROM BANKRECO WITH (ROWLOCK)      
      WHERE       CLTCODE = @BANKCODE      
                  AND CROSSREFERENCENO IN (SELECT CROSSNO      
                                           FROM   RECODUPS1)      
    END      
          
  INSERT INTO BANKRECO      
             (CLTCODE,      
              BOOKDATE,      
              DESCRIPTION,      
              AMOUNT,      
              DRCR,      
              VALUEDATE,      
              REFERENCENO,      
              STATUSID,      
              STATUSNAME,      
              LOGINNAME,      
              CROSSREFERENCENO,      
              STATUS,      
              MICRNO,      
              DUMMY1,      
              DUMMY2)      
  SELECT B.CLTCODE,      
         B.BOOKDATE,      
         B.DESCRIPTION,      
         B.AMOUNT,      
         B.DRCR,      
         B.VALUEDATE,      
         B.REFERENCENO,      
         B.STATUSID,      
         B.STATUSNAME,   
         B.LOGINNAME,      
         B.CROSSREFERENCENO,      
         B.STATUS,      
         @@MICRNO,      
         '0',      
         '0'      
  FROM   #BANKRECOSAVE B      
               
  INSERT INTO BANKRECO_LOG      
  SELECT B.CLTCODE,      
         B.BOOKDATE,      
         B.DESCRIPTION,      
         B.AMOUNT,      
         B.DRCR,      
         B.VALUEDATE,      
         B.REFERENCENO,      
         B.STATUSID,      
         B.STATUSNAME,      
         B.LOGINNAME,      
         B.CROSSREFERENCENO,      
         B.STATUS,      
         @@MICRNO,      
         '0',      
         '0',      
         0,      
         'AUTO',      
         GETDATE(),      
         'MATCHED'      
  FROM   #BANKRECOSAVE B      
  WHERE  B.STATUS = 'MATCHED'      
                          
  INSERT INTO LEDGER1_BANKRECO_LOG      
  SELECT L1.*,      
         'AUTO',      
         GETDATE(),      
         'MATCHED'      
  FROM   LEDGER1 L1 WITH (NOLOCK),      
         (SELECT VTYP,      
                 BOOKTYPE,      
                 VNO      
          FROM   #BANKRECOSAVE      
          WHERE  VNO <> ''      
          UNION       
          SELECT VTYP,      
                 BOOKTYPE,      
                 VNO      
          FROM   #LEDGER_UPDATES_FOR_SLIPS      
          WHERE  VNO <> '') LU      
  WHERE  L1.VNO = LU.VNO      
         AND L1.VTYP = LU.VTYP      
         AND L1.BOOKTYPE = LU.BOOKTYPE      
                                 
  UPDATE RECOPROCESS      
  SET    INPROCESS = 'N'      
                           
  COMMIT TRAN      
        
  SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANK_FUNDS_REPORTING
-- --------------------------------------------------



--EXEC BANK_FUNDS_REPORTING 'APR  1 2013', 'NOV 27 2013', 'BANK01'

CREATE PROCEDURE BANK_FUNDS_REPORTING
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@BANK_CODE VARCHAR(10)
AS

CREATE TABLE #LEDGER_PL
(
	VDT DATETIME,
	EDT DATETIME,
	LONG_NAME VARCHAR(100),
	BANK_ACC_NO VARCHAR(30),
	UCC_CODE VARCHAR(10),
	CLTCODE VARCHAR(10),
	CLIENT_PAN VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	PDT DATETIME,
	OPBAL MONEY
)

INSERT INTO #LEDGER_PL
SELECT
	VDT, EDT, LONG_NAME, ACCNO, UCC_CODE, CL_CODE, PAN_GIR_NO, NARRATION = L.NARRATION, VNO, SETT_NO = '', CHQ_NO = '',  
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, EXCHANGE, SEGMENT, L.VTYP, L.BOOKTYPE, PDT, OPBAL = 0
FROM
	MSAJAG..CLIENT_DETAILS C, (SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59') L, VMAST V, OWNER O, MULTIBANKID M
WHERE
	C.CL_CODE = L.CLTCODE
	AND C.CL_CODE = M.CLTCODE
	AND L.VTYP = V.VTYPE
	AND EXISTS(SELECT VNO FROM LEDGER LL WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND CLTCODE = @BANK_CODE AND L.VNO = LL.VNO AND L.VTYP = LL.VTYP AND L.BOOKTYPE = LL.BOOKTYPE)
	AND L.CLTCODE <> @BANK_CODE
ORDER BY L.CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET BANK_ACC_NO = ACCNO FROM #LEDGER_PL L, MULTIBANKID L1
WHERE L.CLTCODE = L1.CLTCODE AND DEFAULTBANK = 1 


CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, PARAMETER P
	WHERE L.CLTCODE = @BANK_CODE AND L.VDT >= SDTCUR AND VDT < @FR_DATE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, PARAMETER P
	WHERE L.CLTCODE = @BANK_CODE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR
	AND VDT BETWEEN SDTCUR AND LDTCUR AND VTYP = 18
	GROUP BY L.CLTCODE
) L
GROUP BY CLTCODE

UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O


SELECT VDT,
	EDT,
	LONG_NAME,
	BANK_ACC_NO,
	UCC_CODE,
	CLTCODE,
	CLIENT_PAN,
	NARRATION,
	VNO,
	SETT_NO,
	CHQ_NO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankDetAcNmPsP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BankDetAcNmPsP    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE BankDetAcNmPsP
 AS
select distinct acname
 from acmast  
 where accat= '2'
order by acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankDetCltCodeSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BankDetCltCodeSpP    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE BankDetCltCodeSpP  
@acname varchar(35)
AS
select  distinct cltcode from acmast where acname =@acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankDetDrCrSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BankDetDrCrSpP    Script Date: 20-Mar-01 11:43:32 PM ******/
/*this sp is used in bank detail printing to get total debit and credit*/
/*variable acname,enddate*/
CREATE PROCEDURE BankDetDrCrSpP 
@cltcode varchar(10),
@enddate varchar(11)
AS
  SELECT DISTINCT DEBIT=(SELECT SUM(L.VAMT)
 FROM LEDGER L WHERE L.DRCR='D' AND
 L.CLTCODE=@cltcode),     CREDIT=(SELECT SUM(L.VAMT) 
FROM LEDGER L WHERE L.DRCR='C' AND L.CLTCODE=@cltcode)
 FROM  ledger WHERE convert(varchar,vdt,101) <= @enddate and CLTCODE=@cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankDetPrintSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BankDetPrintSpP    Script Date: 20-Mar-01 11:43:32 PM ******/
/* Procedure modified by manisha 
Changes : removed refno 
*/
CREATE PROCEDURE BankDetPrintSpP
(@cltcode varchar(10),
@startdate varchar(12),
@enddate varchar(12))
 AS
select convert(varchar,l.vdt ,103),l.acname,l.vno1,l.vno,l.refno, 
party_name = (select l1.acname from ledger l1 where  l.vtyp = l1.vtyp and  l.vno = l1.vno and 
l1.cltcode <> @cltcode  /* and substring(l1.refno,1,11) = substring(l.refno,1,11)*/ 
and l1.vtyp = l.vtyp and l1.vno=l.vno and l1.lno =l.lno and l1.drcr=l.drcr), 
Debit = (Case When l.DRCR = 'D' Then  Vamt  Else  0     End), 
Credit = (Case When l.DRCR='C' Then  Vamt   Else  0   End),  
Narration = (select l3.narr from ledger3 l3 where /*left(l.refno,7)=left(l3.refno,7)*/ l.vtyp =l3.vtyp and l.vno =l3.vno and cltcode =@cltcode)  
from ledger l where  l.cltcode =@cltcode  and convert(varchar,l.vdt ,101) >=@startdate
and convert(varchar,l.vdt,101) <=@enddate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankDisplay
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankDisplay    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankDisplay    Script Date: 01/11/2003 3:42:03 PM ******/
/****** Object:  Stored Procedure dbo.BankDisplay    Script Date: 01/28/2002 3:46:44 PM ******/
/**************************************************************************************************************************************************************************************************
THIS SP  IS USED IN THE BANK DISPLAY REPORT 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Modification Done By Sheetal On 25/01/2002
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added two new parameters viz: @flag and @costcode. 
These are used to display the bank transactions either for all the branches or for a particular branch 
Depending on the @flag value 
If @flag = 0  then show bank transaction for all the branches
If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )
***************************************************************************************************************************************************************************************************/
CREATE Procedure BankDisplay
@tstrtDate   datetime,
@tEndDate   datetime,
@tCode  varchar(10),
@vdtedtflag tinyint,
@flag integer,
@costcode smallint
As
if @vdtedtflag = 0 
begin
	if @flag = 0 
	begin
		select vdt =l.vdt,vtyp,l.vno,acname ,cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		chequeno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype) is not null
				          then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype)
				          else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype = l.booktype) end),''),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype) is not null 
	    		                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype)
    	    		                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.booktype = l.booktype and l3.naratno = 0) end ),'')
		from ledger l 
		where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and cltcode not like @tCode and l.booktype = ( select booktype from acmast a where a.cltcode = @tcode ) 
		and vdt >= @tstrtDate  and vdt <= @tEndDate	and vtyp <> 18  
		order by vdt,vtyp ,vno
	end
	Else if @flag = 1 
	begin
		select vdt =l.vdt,vtyp,l.vno,acname ,l.cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		chequeno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype) is not null
			                            then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype)
			                            else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype = l.booktype)	end),''),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype) is not null 
	    		                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype)
    	    	                                  else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno  and l3.booktype = l.booktype and l3.naratno = 0) end ),'')
		from ledger l , ledger2 l2
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.booktype = l2.booktype and l.lno = l2.lno 
		and l.vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and l.cltcode not like @tCode and l.booktype = ( select booktype from acmast a where a.cltcode = @tcode ) 
		and vdt >= @tstrtDate  and vdt <= @tEndDate	and costcode = @costcode
		and vtyp <> 18  
		order by vdt,vtyp ,l.vno
	end
end
if @vdtedtflag = 1
begin
	if @flag = 0 
	begin
		select vdt = l.edt ,vtyp,l.vno,acname ,cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		chequeno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype) is not null
				          then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype)
				          else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype = l.booktype)	end),''),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype) is not null 
	    	 	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype)
    	    		                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno  and l3.booktype = l.booktype and l3.naratno = 0) end ),'')
		from ledger l  
		where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and cltcode not like @tCode and l.booktype = ( select booktype from acmast a where a.cltcode = @tcode ) 
		and edt >= @tstrtDate  and edt <= @tEndDate	and vtyp <> 18  
		order by edt,vtyp ,vno
	end 
	Else if @flag = 1 
	begin
		select vdt = l.edt ,vtyp,l.vno,acname ,l.cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		chequeno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype) is not null
				          then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype)
				          else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype = l.booktype)	end),''),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype) is not null 
	    	 	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l3.booktype = l.booktype)
    	    		                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.booktype = l.booktype and l3.naratno = 0) end ),'')
		from ledger l ,ledger2 l2 
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.booktype = l2.booktype and l.lno = l2.lno 
		and l.vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
		and l.cltcode not like @tCode and l.booktype = ( select booktype from acmast a where a.cltcode = @tcode ) 
		and edt >= @tstrtDate  and edt <= @tEndDate	and costcode = @costcode
		and vtyp <> 18  
		order by edt,vtyp ,l.vno
	
	end 
end
/*
if @vdtedtflag = 0 
begin
	select vdt =l.vdt,vtyp,l.vno,acname ,cltcode ,vamt ,
	drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l.lno = l1.lno  and l.booktype = l1.booktype),
	balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ), 
	chequeno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype) is not null
			then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype)
			else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype = l.booktype)
			end),''),
	narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l1.booktype = l.booktype) is not null 
	    	then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l1.booktype = l.booktype)
    	    	else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l1.booktype = l.booktype ) end ),'')
	from ledger l  
	where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
	and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
	and cltcode not like @tCode and booktype = ( select booktype from acmast a where a.cltcode = @tcode ) 
	and vdt >= @tstrtDate  
	and vdt <= @tEndDate
	and vtyp <> 18  
	order by vdt,vtyp ,vno
end
if @vdtedtflag = 1
begin
	select vdt = l.edt ,vtyp,l.vno,acname ,cltcode ,vamt ,
	drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ), 
	chequeno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype) is not null
			          then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.lno = l.lno and l1.booktype = l.booktype)
			          else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype = l.booktype)
			end),''),
	narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l1.booktype = l.booktype) is not null 
	    	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno and l1.booktype = l.booktype)
    	    	                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno  and l1.booktype = l.booktype) end ),'')
	from ledger l  
	where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
	and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp and l1.booktype = l.booktype)   
	and cltcode not like @tCode and booktype = ( select booktype from acmast a where a.cltcode = @tcode ) 
	and edt >= @tstrtDate  and edt <= @tEndDate	and vtyp <> 18  
	order by edt,vtyp ,vno
end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bankname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bankname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bankname    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 7/8/01 3:22:47 PM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.bankname    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE bankname
 AS
select acname,cltcode from acmast where accat='2'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankSlipReprint
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankSlipReprint    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankSlipReprint    Script Date: 10/16/2002 4:40:54 PM ******/
CREATE proc BankSlipReprint
@startslip int,
@endslip int
As
select  SlipNo, ddno, slipdate, acname, bnkname, brnname, relamt, cltcode, l1.vno, l1.lno
from ledger l , ledger1 l1 
where l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype = l1.booktype and l.lno = l1.lno and l.vtyp in ( '2', '19')
and slipno >= @startslip and slipno <= @endslip
order By SlipNo, Slipdate, l1.vno, l1.lno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankSlipsum
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankSlipsum    Script Date: 1/17/2004 11:39:07 PM ******/

CREATE PROCEDURE BankSlipsum
@booktype varchar(2),
@slipno   decimal(12,0)
As
select  sum(relamt) from ledger1  
where ( vtyp = '2' or vtyp = '19' ) and booktype = @booktype and slipno = @slipno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BankSlVSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BankSlVSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BankSlVSp    Script Date: 02/04/2002 9:59:36 PM ******/
CREATE  proc BankSlVSp
@FromNo varchar(4),
@ToNo varchar(4)
As
select distinct B.* , l.CltCode from BankSlipView B, ledger l 
where b.acname = l.acname and  B.slipNo >= @FromNo and B.slipNo <= @ToNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGAdjBalCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 20-Mar-01 11:43:32 PM ******/
/* this procedure is used to adjust the balances of the parties datewise  */
CREATE PROCEDURE  BBGAdjBalCursor AS
declare    @@code varchar(12),
@@tcltcodecur cursor    
set @@tcltcodecur = cursor for 
                 select distinct cltcode from ledger 
                 open @@tcltcodecur
fetch next  from @@tcltcodecur into   @@code
while   @@fetch_status =0
begin
         exec spadjbalcursor @@code
         fetch next  from @@tcltcodecur into   @@code
end
close @@tcltcodecur
deallocate @@tcltcodecur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGAdjBalCursor2000
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2000    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2000    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2000    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2000    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2000    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2000    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 20-Mar-01 11:43:32 PM ******/
/* this procedure is used to adjust the balances of the parties datewise  */
CREATE PROCEDURE  BBGAdjBalCursor2000 AS
declare    @@code varchar(12),
@@tcltcodecur cursor    
set @@tcltcodecur = cursor for 
                 select distinct cltcode from ledger 
                 open @@tcltcodecur
fetch next  from @@tcltcodecur into   @@code
while   @@fetch_status =0
begin
         exec spadjbalcursor2000 @@code
         fetch next  from @@tcltcodecur into   @@code
end
close @@tcltcodecur
deallocate @@tcltcodecur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGAdjBalCursor2001
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2001    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2001    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2001    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2001    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2001    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor2001    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BBGAdjBalCursor    Script Date: 20-Mar-01 11:43:32 PM ******/
/* this procedure is used to adjust the balances of the parties datewise  */
CREATE PROCEDURE  BBGAdjBalCursor2001 AS
declare    @@code varchar(12),
@@tcltcodecur cursor    
set @@tcltcodecur = cursor for 
                 select distinct cltcode from ledger 
                 open @@tcltcodecur
fetch next  from @@tcltcodecur into   @@code
while   @@fetch_status =0
begin
         exec spadjbalcursor2001 @@code
         fetch next  from @@tcltcodecur into   @@code
end
close @@tcltcodecur
deallocate @@tcltcodecur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.bdrcr    Script Date: 20-Mar-01 11:43:32 PM ******/
/* calculates balances of all parties of all branches */
CREATE PROCEDURE bdrcr
AS
select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name
group by  b.branch_cd,l.Cltcode
ORDER BY b.branch_cd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bfoaccbilldrcrproc1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.bfoaccbilldrcrproc1    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE proc bfoaccbilldrcrproc1
(@settno varchar(10),@setttype varchar(2),@bdate as varchar(11)) as 
select sett_no ,sett_type,sell_buy,totalamount=sum(abs(amount))  from bsedb.dbo.bfoaccbill 
where sett_no =@settno
and sett_type =@setttype 
and left(convert(varchar,billdate,109),11)=@bdate 
group by sett_no ,sett_type,sell_buy 
order by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bfoGetCumulativeBalBill
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.bfoGetCumulativeBalBill    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE  bfoGetCumulativeBalBill   @tsettno  varchar(7) ,
@tsetttype as varchar(2),@bdate as varchar(11)
AS
 select  clientdrcr  =isnull((select isnull(sum(amount),0) from bsedb.dbo.bfoaccbill s 
 			   where s.sett_no=     @tsettno      and sett_type=  @tsetttype   and left(convert(varchar,billdate,109),11)=@bdate    and sell_buy =1  
		   	   and  party_code not in ('99690' ,'99685' ,'99688','400')) - 
			  (select sum(amount) from bsedb.dbo.bfoaccbill s 
			  where s.sett_no=      @tsettno       and sett_type= @tsetttype   and left(convert(varchar,billdate,109),11)=@bdate  and sell_buy =2
			  and  party_code not in ('99690' ,'99685' ,'99688','400')),0), 
	 tenddate  = (select distinct billdate from bsedb.dbo.bfoaccbill s 
		     where s.sett_no=      @tsettno    and sett_type= @tsetttype and left(convert(varchar,billdate,109),11)=@bdate   ),  
	 tpayout  =  (select  max(payout_date) from bsedb.dbo.bfoaccbill sm 
		     where sm.sett_no=         @tsettno   and sett_type=    @tsetttype and left(convert(varchar,billdate,109),11)=@bdate     ), 
	 tstartdate = (select distinct max(start_date) from bsedb.dbo.bfosett_mst s
		     where s.sett_no=     @tsettno    and sett_type=    @tsetttype  and left(convert(varchar,billdate,109),11)=@bdate      )
  from bsedb.dbo.bfoaccbill s1  where s1.sett_no=     @tsettno  and s1.sett_type=  @tsetttype and left(convert(varchar,billdate,109),11)=@bdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.billdetails
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.billdetails    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.billdetails    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 11/28/2001 12:23:40 PM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.billdetails    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE billdetails
@ourrefno varchar(12),
@partycode varchar(10)
AS
SELECT BNKNAME, L.REFNO, L.CLTCODE FROM LEDGER L, LEDGER1 L1 
WHERE l1.REFNO=@ourrefno and l.vtyp='15' and cltcode=@partycode
and left(l.refno,7)=left(l1.refno,7)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BILLPOSTING
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[BILLPOSTING]  
(  
 @BILL_DATE VARCHAR(11)  
)  
AS  
  
DECLARE  
 @VNO VARCHAR(12),  
 @VDT VARCHAR(11),  
 @EDTDR VARCHAR(11),                        
    @EDTCR VARCHAR(11),                        
    @CDT VARCHAR(11),                        
    @PDT VARCHAR(11),                        
    @UNAME VARCHAR(25),                         
    @EXCHANGE VARCHAR(10),                       
    @OVNO VARCHAR(12),                  
 @NARR VARCHAR(20),  
 @REC_COUNT INT  
   
 SELECT @CDT = CONVERT(VARCHAR(11), GETDATE(), 109), @PDT = CONVERT(VARCHAR(11), GETDATE(), 109)  
   
 SELECT @EXCHANGE = EXCHANGE FROM OWNER  
   
 IF LEN(@BILL_DATE) = 10  
 BEGIN  
  SELECT @BILL_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @BILL_DATE, 103), 109)  
 END  
   
SET @OVNO = ''  
  
SELECT @OVNO = VNO, @VNO = VNO, @EDTDR = @BILL_DATE, @EDTCR = @BILL_DATE  
FROM BILLPOSTED WHERE BILLDATE LIKE @BILL_DATE + '%'  
  
IF @OVNO = ''  
BEGIN  
  
 DECLARE  
  @@SDTCUR VARCHAR(11),  
  @@LDTCUR VARCHAR(11)  
    
 SELECT @@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), @@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109)  
 FROM PARAMETER WHERE @BILL_DATE BETWEEN SDTCUR AND LDTCUR  
  
 CREATE TABLE #VNO  
 (  
  LASTVNO VARCHAR(12)  
 )  
  
 INSERT INTO #VNO  
 EXEC ACC_GENVNO_NEW @BILL_DATE, 15, '01', @@SDTCUR, @@LDTCUR --, 1  
  
 SELECT @VNO = LASTVNO FROM #VNO  
   
 --SELECT DISTINCT @EDTDR = CONVERT(VARCHAR(11), BILLDATE, 109), @EDTCR = CONVERT(VARCHAR(11), BILLDATE, 109)   
 --FROM MCDX.DBO.FOACCBILL  
 --WHERE BILLDATE LIKE @BILL_DATE + '%' 
 
 SET @EDTDR = @BILL_DATE      
 SET @EDTCR = @BILL_DATE    
 
 SELECT @EDTDR = ISNULL(MIN(SEC_PAYIN),@EDTDR), @EDTCR = ISNULL(MIN(SEC_PAYIN),@EDTCR)   
 FROM ANAND1.MSAJAG.DBO.SETT_MST   
 WHERE SEC_PAYIN > @BILL_DATE + ' 23:59:59'  
 AND Sett_Type = 'N' 
  
END  
  
  
EXEC [NEWPOSTBILL]     
      15,                        
      '01',                        
      @VNO,                        
      @BILL_DATE,                        
      @EDTDR,                        
      @EDTCR,                        
      @CDT,                        
      @PDT,                        
      @UNAME,                        
      @UNAME,                        
      '',                        
      '',                        
      @UNAME,                         
      @EXCHANGE,                       
      @BILL_DATE,  
      @OVNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BillSerTaxCalSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.BillSerTaxCalSp    Script Date: 20-Mar-01 11:43:32 PM ******/
/*
report :billwise service tax (modification of vb control)
file : printingcontroll/billwiseservicetax/Bsertaxdetails.asp
**/
CREATE PROCEDURE BillSerTaxCalSp
@settno as varchar(7),
@settype as varchar(2),
@enddate as varchar(2),
@startdate as varchar(2)
 AS
 select settno=(substring(l3.narr,8,8)),l.vamt ,
 tstart_date =(select start_date
   from ncdx.dbo.sett_mst
  where Sett_No= @settno and sett_type=@settype), 
 tend_date = l.VDT , L.CLTCODE 
 from ledger l, ledger3 l3
 where  substring(l.refno, 1, 7) = substring(l3.refno, 1, 7)  and
 cltcode in('99988' ,'99990','61310') and l.vtyp='15'  AND
 convert(varchar,VDT,103) >=@enddate And 
 convert(varchar,VDT,103) <=@startdate  
 order by tstart_date,VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_YEAREND
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[BR_YEAREND]
 @SDTCUR VARCHAR(11),      
 @LDTCUR VARCHAR(11),      
 @VTYP   SMALLINT,      
 @VNO VARCHAR(12),      
 @BOOKTYPE CHAR(2),      
 @VDT    DATETIME,
 @PNLCODE VARCHAR(10)      
      
AS      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
      
DECLARE      
 @@MAINCTRLAC AS VARCHAR(10),      
 @@MAINACNAME AS VARCHAR(100),      
 @@MAINCOSTCODE AS INT,      
 @@LNO AS INT,      
 @@COSTCODE AS SMALLINT,      
 @@AMT AS MONEY,      
 @@RCURSOR AS CURSOR
  
    
      
SELECT       
 @@LNO =       
 (       
 SELECT       
  LNO       
 FROM LEDGER       
 WHERE VTYP = @VTYP       
  AND BOOKTYPE = @BOOKTYPE       
  AND VNO = @VNO       
  AND CLTCODE = @PNLCODE       
 )      
      
SELECT       
 @@MAINCTRLAC =       
 (       
 SELECT       
  MAINCONTROLAC       
 FROM BRANCHACCOUNTS       
 WHERE DEFAULTAC = 1      
 )      
      
SELECT @@MAINCOSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME IN(SELECT BRANCHNAME FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)      
      
SELECT       
 @@MAINACNAME =       
 (       
 SELECT       
  ACNAME       
 FROM ACMAST       
 WHERE CLTCODE = @@MAINCTRLAC       
 )    

TRUNCATE TABLE LEDGER_BRANCHBREAKUP

INSERT INTO LEDGER_BRANCHBREAKUP
SELECT VNO, VTYPE, BOOKTYPE, LNO, CLTCODE, CAMT, COSTCODE, DRCR 
FROM LEDGER2 L2 WITH (NOLOCK) WHERE CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE) 
AND EXISTS(SELECT VNO FROM LEDGER L WITH (NOLOCK) WHERE VDT > = @SDTCUR + ' 00:00:00'           
 AND VDT <= @LDTCUR + ' 23:59:59' AND L2.VTYPE = L.VTYP           
AND L2.BOOKTYPE = L.BOOKTYPE           
 AND L2.VNO = L.VNO           
 AND L2.LNO = L.LNO   )  
      
TRUNCATE TABLE BRANCHWISECLBAL 

INSERT INTO BRANCHWISECLBAL
SELECT   
 L2.CLTCODE,           
 A.ACNAME ,           
 COSTCODE,           
 BALANCE=SUM(           
 CASE           
  WHEN UPPER(L2.DRCR) = 'D'           
  THEN CAMT           
  ELSE -CAMT           
 END          
 )           
FROM LEDGER_BRANCHBREAKUP L2,           
 ACMAST A           
  
WHERE 
L2.CLTCODE = A.CLTCODE
 AND           
 (          
  A.ACTYP LIKE 'ASS%'           
  OR A.ACTYP LIKE 'LIAB%'          
 )           
          
GROUP BY COSTCODE,           
 L2.CLTCODE,           
 A.ACNAME        
      
/*
INSERT       
INTO BRANCHWISECLBAL       
SELECT       
 L2.CLTCODE,       
 A.ACNAME ,       
 COSTCODE,       
 BALANCE=SUM(       
 CASE       
  WHEN UPPER(L2.DRCR) = 'D'       
  THEN CAMT       
  ELSE -CAMT       
 END      
 )       
FROM LEDGER2 L2       
LEFT OUTER JOIN       
 ACMAST A       
 ON L2.CLTCODE = A.CLTCODE,       
 LEDGER L       
WHERE L2.VTYPE = L.VTYP       
 AND L2.BOOKTYPE = L.BOOKTYPE       
 AND L2.VNO = L.VNO       
 AND L2.LNO = L.LNO       
 AND L.VDT > = @SDTCUR + ' 00:00:00'       
 AND L.VDT <= @LDTCUR + ' 23:59:59'       
 AND       
 (      
  A.ACTYP LIKE 'ASS%'       
  OR A.ACTYP LIKE 'LIAB%'      
 )       
 AND L2.CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)       
GROUP BY COSTCODE,       
 L2.CLTCODE,       
 A.ACNAME
*/
INSERT       
  INTO BRANCHWISECLBAL       
	SELECT      
	  @@MAINCTRLAC,       
	  @@MAINACNAME,       
	  COSTCODE,      
	  -(SUM(BALANCE))
	 FROM      
	  BRANCHWISECLBAL      
	 GROUP BY      
	  COSTCODE 

    

/*      
SET @@RCURSOR = CURSOR FOR      
 SELECT      
  COSTCODE,      
  SUM(BALANCE)      
 FROM      
  BRANCHWISECLBAL      
 GROUP BY      
  COSTCODE      
      
OPEN @@RCURSOR      
 FETCH NEXT FROM      
  @@RCURSOR       
 INTO      
  @@COSTCODE,      
  @@AMT      
      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  INSERT       
  INTO BRANCHWISECLBAL VALUES      
   (       
    @@MAINCTRLAC,       
    @@MAINACNAME,       
    @@COSTCODE,       
    -(@@AMT)       
   )      
      
  FETCH NEXT FROM      
   @@RCURSOR       
  INTO      
   @@COSTCODE,      
   @@AMT      
 END      
      
CLOSE @@RCURSOR      
DEALLOCATE @@RCURSOR     
*/ 
      
INSERT       
INTO LEDGER2       
SELECT       
 L.VTYP,       
 L.VNO,       
 L.LNO,       
 (      
 CASE       
  WHEN (CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END) >= 0       
  THEN 'D'       
  ELSE 'C'       
 END      
 ),       
 ABS(CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END),       
 COSTCODE,       
 L.BOOKTYPE,       
 B.CLTCODE       
FROM LEDGER L,       
 BRANCHWISECLBAL B       
WHERE L.VTYP = @VTYP       
 AND L.BOOKTYPE = @BOOKTYPE       
 AND L.VNO = @VNO       
 AND L.CLTCODE = B.CLTCODE      
 AND L.CLTCODE NOT IN       
 (       
 SELECT       
  BRCONTROLAC       
 FROM BRANCHACCOUNTS       
 )      
      
INSERT       
INTO LEDGER2       
SELECT       
 @VTYP,       
 @VNO,       
 @@LNO,       
 (      
 CASE       
  WHEN BALANCE >= 0       
  THEN 'D'       
  ELSE 'C'       
 END      
 ),       
 ABS(BALANCE),       
 COSTCODE,       
 @BOOKTYPE,       
 CLTCODE       
FROM BRANCHWISECLBAL B       
WHERE CLTCODE IN       
 (       
 SELECT       
  BRCONTROLAC       
 FROM BRANCHACCOUNTS       
 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrAccountDrCrEdtSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrAccountDrCrEdtSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrAccountDrCrEdtSp    Script Date: 03/20/2002 11:33:45 AM ******/
/****** Object:  Stored Procedure dbo.BrAccountDrCrEdtSp    Script Date: 03/12/02 3:10:21 PM ******/
/************************************************************************************************************************************************************************************************
Created by Sheetal on 21/02/2002 Calculated the debit and credit amount for client
This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE BrAccountDrCrEdtSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint,
@costcode smallint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4' 
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrAccountDrCrSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrAccountDrCrSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrAccountDrCrSp    Script Date: 03/20/2002 11:33:46 AM ******/
/****** Object:  Stored Procedure dbo.BrAccountDrCrSp    Script Date: 03/12/02 3:10:21 PM ******/
/************************************************************************************************************************************************************************************************
Created by Sheetal 21/02/2002  Calculated the debit and credit amount for client
This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE BrAccountDrCrSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint,
@costcode smallint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate 	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate  and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4'  
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit))  
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate and costcode = @costcode
	and p.cltcode = a.cltcode and a.accat <> '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bracname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bracname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bracname    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.bracname    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE bracname
@acname varchar(35)
AS
select convert(varchar,l.vdt,103), c2.party_code, 
vdesc,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, 
/*l.refno*/l.vtyp,l.vno,l.lno,l.drcr, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where /*l3.refno=left(l.refno,7)*/ l3.vno =l.vno and l3.vtyp =l.vtyp), '')
from ledger l, vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode and vtyp=vtype 
and l.acname = @acname
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrAcnameSelect
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrAcnameSelect    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrAcnameSelect    Script Date: 04/26/2002 3:14:50 PM ******/
/****** Object:  Stored Procedure dbo.BrAcnameSelect    Script Date: 02/28/2002 6:47:58 PM ******/
CREATE Proc BrAcnameSelect
@flag integer,
@branchcode varchar (10)
As
If @flag = 1 		/*Used in Cash and Bank Entries Control */
begin 	
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat not in  ('1','2','14') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end
else if @flag = 2      	 /*Used in Margin Entry ( JV ) Control*/
begin
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat  in   ('3','4','14')
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end  
else if @flag = 3		/*Used in Margin Entry and Margin Entries Control*/	
begin
        	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat  in   ('4')
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end  
else if @flag = 4  		/* For selecting Cash name and code in Cash entries  and Margin Entries control*/
begin
	Select acname,cltcode ,accat from acmast 
        	where  accat  =  '1'  and( branchcode like @branchcode or branchcode = 'ALL' )      	
end
else if @flag = 5 		/* For selecting Bank name and code in Bank entries and  Margin Entries control*/
begin
	Select acname,cltcode ,accat from acmast 
        	where  accat  =  '2'  and (branchcode like @branchcode or branchcode = 'ALL' )
end
else if @flag = 6 		/*For selecting everything except margin a/c Used in Ledger Entry Control*/
begin			
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat not in  ('14') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end
else if @flag = 7 		/*Used in Ledger Edit when vtyp = 1 or 4 casg received and paid*/
begin				
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat in  ('1','3','4') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end
else if @flag = 8 		/*Used in Ledger Edit when vtyp = 2 or 3 bank received and paid */
begin
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat  in  ('2','3','4') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end
else if @flag = 9 		/*Used in Ledger Edit when vtyp = 5 contra entry */
begin
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat  in  ('1','2') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end
else if @flag = 10 		/*Used in Margin Edit when vtyp = 19 or 20  contra entry */
begin
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat  in  ('2','14') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end
else if @flag = 11 		/*Used in Margin Edit when vtyp = 22 or 23  contra entry */
begin
	Select acname,a.accat,actyp,catname,cltcode from acmast a,
        	catmast c where c.accat = a.accat and c.accat  in  ('1','14') 
	and (branchcode like @branchcode or branchcode = 'ALL')
        	order by acname 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brallname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brallname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brallname    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.brallname    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brallname
@br varchar(3),
@short_name varchar(21)
AS
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM ncdx.dbo.CLIENT1 C1, ncdx.dbo.CLIENT2 C2,ncdx.dbo.branches b, ledger l 
WHERE c1.short_name like @short_name+'%' 
and C1.CL_CODE=C2.CL_CODE 
and c2.party_code=l.cltcode 
and b.short_name = c1.trader
and b.branch_cd = @br
order by c1.short_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.branchdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 11/28/2001 12:23:39 PM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 2/17/01 3:34:13 PM ******/
/****** Object:  Stored Procedure dbo.branchdrcr    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE  branchdrcr
AS
select b.branch_cd,amt=sum(vamt),drcr from ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name
group by b.branch_cd,drcr
order by b.branch_cd,drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brcheq1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brcheq1    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brcheq1
@cltcode varchar(10),
@vdt varchar(10),
@br varchar(3)
AS
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''),
ddno=isnull((select ddno from ledger1 le1 where 
le1.refno=l1.refno),''), nar=isnull((select l3.narr from ledger3 l3 where 
l3.refno=left(l1.refno,7)),'') from ledger l1,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.branches b 
where  left(l1.refno,7) in ( 
select left(refno,7) from ledger l where convert(varchar,l.vdt,103) = @vdt
and l.vtyp=3 and l.cltcode=@cltcode) 
and l1.cltcode <> @cltcode 
and c2.party_code=l1.cltcode and c1.cl_code=c2.cl_code and b.short_name=c1.trader and b.branch_cd=@br
order by l1.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brcheq2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brcheq2    Script Date: 20-Mar-01 11:43:32 PM ******/
cREATE PROCEDURE brcheq2
@cltcode varchar(10),
@vdt varchar(10),
@br varchar(3)
 AS
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''),
ddno=isnull((select ddno from ledger1 le1 where 
le1.refno=l1.refno),''), nar=isnull((select l3.narr from ledger3 l3 where 
l3.refno=left(l1.refno,7)),'') from ledger l1,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.branches b 
where  left(l1.refno,7) in ( 
select left(refno,7) from ledger l where convert(varchar,l.vdt,103) = @vdt
and l.vtyp=2 and l.cltcode=@cltcode) 
and l1.cltcode <> @cltcode 
and c2.party_code=l1.cltcode and c1.cl_code=c2.cl_code and b.short_name=c1.trader and b.branch_cd=@br
order by l1.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClientBalanceEdtSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrClientBalanceEdtSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrClientBalanceEdtSP    Script Date: 03/20/2002 11:33:46 AM ******/
/****** Object:  Stored Procedure dbo.BrClientBalanceEdtSP    Script Date: 03/12/02 3:10:21 PM ******/
/************************************************************************************************************************************************************************************************
Created by Sheetal 21/02/2002 Calculated the debit and credit amount for client
This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE Procedure BrClientBalanceEdtSP
@fromdate as varchar(21),
@todate as varchar(21),
@fromamt money,
@toamt money,
@flag tinyint,
@costcode smallint 
AS
If @flag = 1
begin 
	SELECT bal = (Sum(debit) - Sum(credit))
        	FROM partydrcredtbranchwise p, ACMAST a
        	where p.edt >= @fromdate and p.edt <= @todate  and a.accat = '4' and p.cltcode = a.cltcode	
	and costcode = @costcode
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt	
	and Abs(Sum(debit) - Sum(credit)) <= @toamt
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClientBalanceSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrClientBalanceSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrClientBalanceSP    Script Date: 03/20/2002 11:33:46 AM ******/
/****** Object:  Stored Procedure dbo.BrClientBalanceSP    Script Date: 03/12/02 3:10:21 PM ******/
/************************************************************************************************************************************************************************************************
Created by Sheetal 21/02/2002 Calculated the debit and credit amount for client
This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE Procedure BrClientBalanceSP
@fromdate as varchar(21),
@todate as varchar(21),
@fromamt money,
@toamt money,
@flag tinyint,
@costcode smallint 
AS
If @flag = 1
begin 
	SELECT bal = (Sum(debit) - Sum(credit))
        	FROM partydrcrbranchwise p, ACMAST a
        	where p.vdt >= @fromdate and p.vdt <= @todate  and a.accat = '4' and p.cltcode = a.cltcode	
	and costcode = @costcode	
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt 
	and Abs(Sum(debit) - Sum(credit)) <= @toamt
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClientDrCrEdtSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrClientDrCrEdtSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrClientDrCrEdtSp    Script Date: 03/20/2002 11:33:46 AM ******/
/****** Object:  Stored Procedure dbo.BrClientDrCrEdtSp    Script Date: 03/12/02 3:10:21 PM ******/
/************************************************************************************************************************************************************************************************
Created by Sheetal on 21/02/2002 Calculated the debit and credit amount for client
Used In TrialBalance printing Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE BrClientDrCrEdtSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint,
@costcode smallint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtbranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat = '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from PartyDrcrEdtBranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat = '4' 
	and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from PartyDrcrEdtBranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat = '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from PartyDrcrEdtBranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat = '4'
	and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from PartyDrcrEdtBranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from PartyDrcrEdtBranchwise p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClientDrCrSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrClientDrCrSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrClientDrCrSp    Script Date: 03/20/2002 11:33:46 AM ******/
/****** Object:  Stored Procedure dbo.BrClientDrCrSp    Script Date: 03/12/02 3:10:22 PM ******/
/************************************************************************************************************************************************************************************************
Created by Sheetal 21/02/2002 Calculated the debit and credit amount for client 
Used In TrialBalance printing Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE BrClientDrCrSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint,
@costcode smallint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate 	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate 	and p.cltcode = a.cltcode and a.accat = '4' 
	and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate 	and p.cltcode = a.cltcode and a.accat = '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate 	and p.cltcode = a.cltcode and a.accat = '4'
	and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate 	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrbranchwise p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty and costcode = @costcode
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brclientlist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brclientlist    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brclientlist
@br varchar(3)
as
SELECT distinct l.cltcode FROM ncdx.dbo.CLIENT1 C1, ncdx.dbo.CLIENT2 C2, ncdx.dbo.BRANCHES B, ledger l
WHERE B.SHORT_NAME=C1.TRADER AND C1.CL_CODE=C2.CL_CODE AND
B.BRANCH_CD=@br and l.cltcode=c2.party_code
order by l.cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClosingBalance
-- --------------------------------------------------

/**************************************************************************************************************************************************************************************************      
	THIS SP  IS USED TO FIND THE CLOSING BALANCE OF A PARTICULAR A/C CODE       
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~      
	Copy of BrOpeningbalance with change in condition.      
	      
	Added two new parameters viz: @flag and @costcode.       
	These are used to display the bank transactions either for all the branches or for a particular branch       
	Depending on the @flag value       
	If @flag = 0  then show bank transaction for all the branches      
	If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )      

	Version modified by Deepak Maharishi ON Apr 3 2007
		1. Removed Cursors and used simple assignments for all values
		2. Made changes to get the Balance in one query instead of seperate queries for Opening Balance
		2. Corrected the Balance Computation to get Opening Balance as on Reconciliation Date - 1


exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 22 2007 23:59:59', 0,0,0
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 23 2007 23:59:59', 0,0,0
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 28 2007 23:59:59', 0,0,0
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 31 2007 23:59:59', 0,0,0


exec acc_PrintReconcile '103','STATEMENT', 'Mar 23 2007 23:59:59', 'Mar 23 2007 23:59:59'
***************************************************************************************************************************************************************************************************/      
    
  
CREATE  Procedure BrClosingBalance 
(
	@cltcode  varchar(10),      
	@sdtcur  varchar(11),      
	@fromdate varchar(11),      
	@vdtedtflag tinyint,      
	@flag   smallint,      
	@costcode  smallint      
)
     
AS      
      
Declare      
	@@openbaldt   varchar(11),      
	@@openentry   money,      
	@@openingbal   money,      
	@@startdate  datetime,      
	@@enddate  datetime 
  
	select @@startdate = sdtcur, @@enddate = ldtcur from parameter where @fromdate between sdtcur  and ldtcur  
  
	If @vdtedtflag = 0      
	begin      
	/*===============================================================================================================*/
		/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */      
	/*===============================================================================================================*/
		if @flag = 0       
		begin      
			select @@openingbal = 0      

			select 
				@@openingbal = isnull(sum(case drcr when 'd' then isnull(vamt,0) else isnull(-vamt,0) end),0) 
			from 
				ledger 
			where 
				vdt >= @@startdate 
				and vdt <= @fromdate + ' 23:59:59'
				and cltcode = @cltcode      

			Select @@Openingbal       
		end      
		/*===============================================================================================================*/
			/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/      
		/*===============================================================================================================*/
		else if @flag = 1        
		begin       
			select @@openingbal = 0      
				
			select 
				@@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0) 
			from 
				ledger l,
				ledger2 l2      
			where 
				l.vtyp = l2.vtype 
				and l.vno = l2.vno 
				and l.lno = l2.lno 
				and vdt > = @@openbaldt   
				and vdt >= @@startdate 
				and vdt <= @fromdate + ' 23:59:59'
				and l.cltcode = @cltcode 
				and costcode = @costcode      
				
			select @@openingbal      
		end      

	end      
	else if @vdtedtflag = 1      
	begin      
	/*===============================================================================================================*/
		/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */      
	/*===============================================================================================================*/
		if @flag = 0       
		begin      
			select @@openingbal = 0      

			select 
				@@openingbal = isnull(sum(case drcr when 'd' then isnull(vamt,0) else isnull(-vamt,0) end),0) 
			from 
				ledger 
			where 
				vdt between @@startdate and @fromdate + ' 23:59:59'
				and edt <= @fromdate + ' 23:59:59'
				and cltcode = @cltcode 
				
			select @@openingbal      
		end       
		/*===============================================================================================================*/
			/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/      
		/*===============================================================================================================*/
		else if @flag = 1        
		begin       
			select @@openingbal = 0      
				
			select 
				@@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0) 
			from 
				ledger l,
				ledger2 l2      
			where  
				l.vtyp = l2.vtype 
				and l.vno = l2.vno 
				and l.lno = l2.lno 
				and vdt between @@startdate and @fromdate + ' 23:59:59' 
				and edt <= @fromdate + ' 23:59:59'
				and l.cltcode = @cltcode 
				and costcode = @costcode      

			select @@openingbal      
		end       
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brdramt
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brdramt    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brdramt    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brdramt    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brdramt
@clcode varchar(6)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0),
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) 
from ledger,ncdx.dbo.client2 c2,ncdx.dbo.client1 c1
where cltcode in 
(SELECT DISTINCT PARTY_CODE 
FROM ncdx.dbo.CLIENT2  
WHERE CL_CODE=@clcode)
and c1.cl_code = c2.cl_code 
and cltcode=party_code
 group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brdrlist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brdrlist    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brdrlist 
@vdt smalldatetime,
@br varchar(3)
AS
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 
c2 where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <=@vdt  +  '11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt + '11:59pm') From Ledger l , acmast a , ncdx.dbo.client2 c2, 
ncdx.dbo.branches b, ncdx.dbo.client1 c1
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code and b.short_name=c1.trader 
and c1.cl_code=c2.cl_code and b.branch_cd=@br
group by l.Cltcode,l.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brnet
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brnet    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brnet    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 8/7/01 6:03:47 PM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brnet    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brnet
@br varchar(3)
AS
select distinct USER_ID , pqty=isnull((select sum(tradeqty) 
from trade4432 
where sell_buy =1 AND trade4432.user_id=t1.user_id),0), 
sqty=isnull((select sum(tradeqty) from trade4432 where sell_buy =2 AND trade4432.
user_id=t1.user_id),0), 
pamt=isnull((select sum(tradeqty*marketrate) from trade4432 
where sell_buy =1 AND trade4432.user_id=t1.user_id ),0), 
samt=isnull((select sum(tradeqty*marketrate) from trade4432 
where sell_buy =2 AND trade4432.user_id=t1.user_id ),0), 
NetAmt= isnull((select sum(tradeqty*marketrate) from trade4432 
where sell_buy =2 AND trade4432.user_id=t1.user_id ),0) - 
isnull((select sum(tradeqty*marketrate) from trade4432 
where sell_buy =1 AND trade4432.user_id=t1.user_id ),0) 
From trade4432 t1, client1 c1, client2 c2, branches b
where c1.cl_code = c2.cl_code 
and b.short_name = c1.trader
and b.branch_cd = @br
group by USER_ID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrOpeningBalance
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BrOpeningBalance    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.BrOpeningBalance    Script Date: 01/11/2003 3:42:03 PM ******/
/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 01/28/2002 3:46:43 PM ******/
/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 01/24/2002 12:11:47 PM ******/
/**************************************************************************************************************************************************************************************************
THIS SP  IS USED TO FIND THE OPENING BALANCE OF A PARTICULAR A/C CODE 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Modification Done By Sheetal On 28/01/2002
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added two new parameters viz: @flag and @costcode. 
These are used to display the bank transactions either for all the branches or for a particular branch 
Depending on the @flag value 
If @flag = 0  then show bank transaction for all the branches
If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )
***************************************************************************************************************************************************************************************************/
CREATE Procedure BrOpeningBalance
@cltcode 	varchar(10),
@sdtcur		varchar(11),
@fromdate	varchar(11),
@vdtedtflag	tinyint,
@flag 		smallint,
@costcode 	smallint
AS
Declare
@@openbaldt 	 varchar(11),
@@openentry 	 money,
@@openingbal 	 money,
@@dramt 	 money,
@@cramt 	 money,
@@opendt 	  cursor,
@@openbalcursor cursor
If @vdtedtflag = 0
begin
	/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */
	if @flag = 0 
	begin
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l
		where vtyp = 18 
		and vdt < = @sdtcur  
		open @@opendt
 		fetch next from @@opendt into  @@openbaldt
	
		while @@fetch_status = 0
		begin
			
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			set @@openbalcursor = cursor  for 
			select dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
			cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
			from ledger where vtyp = 18 and vdt like @@openbaldt + '%'
    			and cltcode = @cltcode group by drcr
    			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
  
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end			
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
			
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			
			
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
			crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
			from ledger where vdt > = @@openbaldt 
    			and vdt < @fromdate  and vtyp <> 18 and cltcode = @cltcode
    			group by drcr 
			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openingbal = @@openingbal - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end
	/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/
	else if @flag = 1  
	begin	
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l , ledger2 l2 
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno  and vtyp = 18
		and vdt < = @sdtcur   and costcode = @costcode
		open @@opendt
 		fetch next from @@opendt into  @@openbaldt
	
		while @@fetch_status = 0
		begin
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			set @@openbalcursor = cursor  for 
			select dramt = isnull((case when l.drcr = 'd' then sum(vamt) else 0 end),0),
			cramt = isnull((case when l.drcr = 'c' then sum(vamt) else 0 end),0)
			from ledger  l , ledger2 l2
			where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno  and vtyp = 18 
			and vdt like @@openbaldt + '%'  and l.cltcode = @cltcode  and costcode = @costcode
			group by l.drcr
    			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
  
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end			
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case l.drcr when 'd' then sum(vamt) end),0), 
			crtotal=isnull((case l.drcr when 'c' then sum(vamt) end),0) 
			from ledger l,ledger2 l2
			where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp <> 18 
			and vdt > = @@openbaldt   and vdt < @fromdate  and l.cltcode = @cltcode and costcode = @costcode
    			group by l.drcr 
			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
  			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openingbal = @@openingbal - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end
end
else if @vdtedtflag = 1
begin
	/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */
	if @flag = 0 
	begin
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger
		where vtyp = 18 and edt < = @sdtcur  
		open @@opendt
	 	fetch next from @@opendt into  @@openbaldt
		
		while @@fetch_status = 0
		begin
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			
			set @@openbalcursor = cursor  for 
			select 	dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
			cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
			from ledger where vtyp = 18 and edt like @@openbaldt + '%'
	    		and cltcode = @cltcode group by drcr
	    		open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
		
			close @@openbalcursor
			deallocate @@openbalcursor
	
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
			crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
			from ledger where edt > = @@openbaldt  and edt < @fromdate  
			and vtyp <> 18 and cltcode = @cltcode group by drcr 
			open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
	  		while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin	
					select @@openingbal = @@openingbal - @@cramt
				end
				
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end 
	/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/
	else if @flag = 1  
	begin	
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger l ,ledger2 l2
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp = 18 
		and edt < = @sdtcur  and costcode = @costcode
		open @@opendt
	 	fetch next from @@opendt into  @@openbaldt
		
		while @@fetch_status = 0
		begin
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			
			set @@openbalcursor = cursor  for 
			select dramt = isnull((case when l.drcr = 'd' then sum(vamt) else 0 end),0),
			             cramt  = isnull((case when l.drcr = 'c' then sum(vamt) else 0 end),0)
			from ledger l ,ledger2 l2
			 where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp = 18  
			and edt like @@openbaldt + '%' and l.cltcode = @cltcode and costcode = @costcode
			group by l.drcr
	    		open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
		
			close @@openbalcursor
			deallocate @@openbalcursor
	
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case l.drcr when 'd' then sum(vamt) end),0), 
			             crtotal=isnull((case l.drcr when 'c' then sum(vamt) end),0) 
			from ledger l,ledger2 l2
			where  l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp <> 18
			and edt > = @@openbaldt  and edt < @fromdate and l.cltcode = @cltcode and costcode = @costcode
			group by l.drcr 
			open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
	  		while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin	
					select @@openingbal = @@openingbal - @@cramt
				end
				
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end 
end 
/*Commented on 28 Jan 2002*/
/*
If @vdtedtflag = 0
begin
	set @@opendt = cursor for
	select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger
	where vtyp = 18 and cltcode = @cltcode
	and vdt < = @sdtcur  
	open @@opendt
 	fetch next from @@opendt into  @@openbaldt
	
	while @@fetch_status = 0
	begin
		
		select @@dramt = 0
		select @@cramt = 0
		select @@openentry =0
		set @@openbalcursor = cursor  for 
		select 	dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
		cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
		from ledger where vtyp = 18 and vdt like @@openbaldt + '%'
    		and cltcode = @cltcode group by drcr
    		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  
		
		while @@fetch_status = 0
		begin
			
			if @@dramt <> 0  
			begin
				select @@openentry = @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openentry = 0 - @@cramt
			end
			
			
			fetch next from @@openbalcursor into @@dramt,@@cramt	
		end
		
		close @@openbalcursor
		deallocate @@openbalcursor
		
		select @@dramt = 0
		select @@cramt = 0
		select @@openingbal = 0
		set @@openbalcursor = cursor for 
		select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
		crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
		from ledger where vdt > = @@openbaldt 
    		and vdt < @fromdate  and vtyp <> 18 and cltcode = @cltcode
    		group by drcr 
		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  		while @@fetch_status = 0
		begin
			if @@dramt <> 0  
			begin
				select @@openingbal = @@openingbal + @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openingbal = @@openingbal - @@cramt
			end
			
			fetch next from @@openbalcursor into @@dramt,@@cramt					
		end
		select @@openingbal = @@openingbal + @@openentry
		close @@openbalcursor
		deallocate @@openbalcursor
		select @@openingbal
		fetch next from @@opendt into  @@openbaldt
	end	
	close @@opendt
	deallocate @@opendt
end
else if @vdtedtflag = 1
begin
	set @@opendt = cursor for
	select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger
	where vtyp = 18 and cltcode = @cltcode and edt < = @sdtcur  
	open @@opendt
 	fetch next from @@opendt into  @@openbaldt
	
	while @@fetch_status = 0
	begin
		
		select @@dramt = 0
		select @@cramt = 0
		select @@openentry =0
		
		set @@openbalcursor = cursor  for 
		select 	dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
		cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
		from ledger where vtyp = 18 and edt like @@openbaldt + '%'
    		and cltcode = @cltcode group by drcr
    		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  
		
		while @@fetch_status = 0
		begin
			if @@dramt <> 0  
			begin
				select @@openentry = @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openentry = 0 - @@cramt
			end
			
			
			fetch next from @@openbalcursor into @@dramt,@@cramt	
		end
		
		close @@openbalcursor
		deallocate @@openbalcursor
		
		select @@dramt = 0
		select @@cramt = 0
		select @@openingbal = 0
		set @@openbalcursor = cursor for 
		select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
		crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
		from ledger where edt > = @@openbaldt  and edt < @fromdate  
		and vtyp <> 18 and cltcode = @cltcode group by drcr 
		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  		while @@fetch_status = 0
		begin
			if @@dramt <> 0  
			begin
				select @@openingbal = @@openingbal + @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openingbal = @@openingbal - @@cramt
			end
			
			fetch next from @@openbalcursor into @@dramt,@@cramt					
		end
		select @@openingbal = @@openingbal + @@openentry
		
		close @@openbalcursor
		deallocate @@openbalcursor
		
		select @@openingbal
		fetch next from @@opendt into  @@openbaldt
	end	
	close @@opendt
	deallocate @@opendt
end 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brsettbr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brsettbr    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brsettbr
@br varchar(3)
AS
select distinct sett_no 
from settlement s, client1 c1,client2 c2,branches b 
where c1.cl_code = c2.cl_code
and b.short_name = c1.trader
and s.party_code = c2.party_code
and b.branch_cd = @br
group by sett_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brsettle
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brsettle    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brsettle    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brsettle    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brsettle
@br varchar(3)
AS
select distinct sett_no 
from settlement s,client1 c1, client2 c2,branches b
where c1.cl_code = c2.cl_code and b.short_name = c1.trader 
and s.party_code = c2.party_code and b.branch_cd =@br
group by sett_no 
order by sett_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brsettno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brsettno    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brsettno    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brsettno    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brsettno
@br varchar(3)
AS
select distinct sett_no from history  h,  CLIENT1 C1, CLIENT2 C2, BRANCHES B
WHERE B.SHORT_NAME=C1.TRADER AND h.party_code=c2.party_code and C1.CL_CODE=C2.CL_CODE AND 
B.BRANCH_CD=@br
group by sett_no 
order by sett_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brtradparty
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 01/04/1980 1:40:35 AM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brtradparty    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brtradparty
@br varchar(3),
@trader varchar(15)
AS
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE 
FROM ncdx.dbo.CLIENT1 C1, ncdx.dbo.CLIENT2 C2, ncdx.dbo.branches b, ledger l 
WHERE C1.TRADER=@trader
AND C1.CL_CODE=C2.CL_CODE 
and b.short_name = c1.trader
and b.branch_cd = @br
and c2.party_code=l.cltcode 
ORDER BY C2.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brtradwise
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brtradwise    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE brtradwise
@br varchar(3),
@trader varchar(15)
AS
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM ncdx.dbo.CLIENT1 C1, ncdx.dbo.CLIENT2 C2,ncdx.dbo.branches b, ledger l 
WHERE C1.TRADER=@trader
AND C1.CL_CODE=C2.CL_CODE 
and b.short_name = c1.trader
and b.branch_cd = @br
and c2.party_code=l.cltcode 
ORDER BY C1.SHORT_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.brtranclient
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.brtranclient    Script Date: 20-Mar-01 11:43:32 PM ******/
/* Report : client transaction
    File : newclients.asp
displays new client */
CREATE PROCEDURE brtranclient
@br varchar(3)
AS
select distinct t.party_code 
from trade4432 t, client1 c1,client2 c2, branches b 
where t.party_code not in (select party_code from client2)
and c1.cl_code = c2.cl_code
and b.short_name = c1.trader
and b.branch_cd =@br

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bryearend
-- --------------------------------------------------
 /****** Object:  Stored Procedure dbo.Bryearend    Script Date: 1/17/2004 11:39:07 PM ******/  
  
CREATE Procedure Bryearend  
@sdtcur varchar(11),  
@ldtcur varchar(11),  
@vtyp   smallint,  
@vno varchar(12),  
@BookType char(2),  
@vdt    datetime  
AS  
declare  
@@mainctrlac as varchar(10),  
@@mainacname as varchar(35),  
@@lno        as int,  
@@costcode   as int,  
@@amt        as money,  
@@rcursor    as cursor  
select @@lno = ( select lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '99999' )  
select @@mainctrlac = ( select MainControlAc from branchaccounts where defaultac = 1)  
select @@mainacname = ( select acname from acmast where cltcode = @@mainctrlac )  
truncate table branchwiseclbal  
insert into branchwiseclbal  
select l2.cltcode, a.acname , costcode, balance=sum( case when upper(l2.drcr) = 'D' then camt else -camt end)  
from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l  
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno  
and l.vdt >= @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'  
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l2.cltcode not in (@@mainctrlac, '99999')  
group by costcode, l2.cltcode, a.acname  
set @@rcursor = cursor for  
select costcode, sum(balance)  
from branchwiseclbal  
group by costcode  
open @@rcursor  
fetch next from @@rcursor   
into @@costcode, @@amt  
while @@fetch_status = 0  
begin  
  insert into branchwiseclbal values( @@mainctrlac, @@mainacname, @@costcode, -(@@amt) )  
  fetch next from @@rcursor   
  into @@costcode, @@amt  
end  
close @@rcursor  
deallocate @@rcursor  
insert into ledger2   
select l.vtyp, l.vno, l.lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, l.booktype, b.cltcode  
from ledger l, branchwiseclbal b  
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and l.cltcode = b.cltcode   
insert into ledger2   
select @vtyp, @vno, @@lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, @booktype, cltcode  
from branchwiseclbal b  
where cltcode in ( select brcontrolac from branchaccounts )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bseGetCumulativeBalBill
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 11/28/2001 12:23:41 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBill    Script Date: 20-Mar-01 11:43:32 PM ******/
/*change done by sheetal on 06 feb 2001*/
/*  gets the cumulative balance amount of all the parties of the selected settlement  .  used in transferbill project     22/03/2000  */
CREATE PROCEDURE  bseGetCumulativeBalBill   @tsettno  varchar(7) ,
@tsetttype as varchar(2)
AS
/*removd  the hard coding done for the service tax, delivery,brokerage charge and clearing house codes*/
 select  clientdrcr  =isnull((select isnull(sum(amount),0) from BSEDB.dbo.accbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ( select cltcode from acmast where accat <> 4 ) ) - 			
     (select isnull(sum(amount),0) from BSEDB.dbo.accbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( select cltcode from acmast where accat <> 4 ) ),0), 
  tenddate  = (select distinct max(end_date) from BSEDB.dbo.accbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from BSEDB.dbo.accbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from BSEDB.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )
/* select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.accbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ('99990' ,'61310', '99985' ,'99988','100')) - 
     (select sum(amount) from ncdx.dbo.accbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( '99990' , '61310','99985', '99988','100')),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.accbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.accbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )*/
/*  from ncdx.dbo.accbill s1  where s1.sett_no=     @tsettno  and s1.sett_type=  @tsetttype*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bseGetCumulativeBalBillIns
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.bseGetCumulativeBalBillIns    Script Date: 20-Mar-01 11:43:32 PM ******/
/*change done by sheetal on 06 feb 2001*/
/*  gets the cumulative balance amount of all the parties of the selected settlement  .  used in transferbill project     22/03/2000  */
CREATE PROCEDURE  bseGetCumulativeBalBillIns   @tsettno  varchar(7) ,
@tsetttype as varchar(2)
AS
/*removd  the hard coding done for the service tax, delivery,brokerage charge and clearing house codes*/
 select  clientdrcr  =isnull((select isnull(sum(amount),0) from BSEDB.dbo.iaccbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ( select cltcode from acmast where accat <> 4 ) ) - 			
     (select isnull(sum(amount),0) from BSEDB.dbo.iaccbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( select cltcode from acmast where accat <> 4 ) ),0), 
  tenddate  = (select distinct max(end_date) from BSEDB.dbo.iaccbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from BSEDB.dbo.iaccbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from BSEDB.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )
/* select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.accbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ('99990' ,'61310', '99985' ,'99988','100')) - 
     (select sum(amount) from ncdx.dbo.accbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( '99990' , '61310','99985', '99988','100')),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.accbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.accbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )*/
/*  from ncdx.dbo.accbill s1  where s1.sett_no=     @tsettno  and s1.sett_type=  @tsetttype*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK
-- --------------------------------------------------

CREATE PROC [dbo].[BULKCOPYRECO_ALLBANK](
           @FILENAME  VARCHAR(200),
           @TABLE     VARCHAR(50),
           @BANK_TYPE VARCHAR(10),
           @STAT_TYPE VARCHAR(10),
           @LOGIN     VARCHAR(10),
           @PWD       VARCHAR(15))

AS
  DECLARE  @@SQL  AS VARCHAR(4000)
  
  DECLARE  @@FNAME  AS VARCHAR(200)
                       
  SELECT @@FNAME = 'C:\TESTIMPORT.TXT'
  
  CREATE TABLE #TESTIMPORT (
    ONEROW VARCHAR(2000),
    SNO    INT   IDENTITY ( 1,1 ))
  
  SET NOCOUNT ON
  
  SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"              
  PRINT @@SQL
  EXEC(@@SQL)     

  IF @BANK_TYPE = 'ICICIRECO'
    BEGIN
      DELETE FROM #TESTIMPORT
      WHERE       SNO <= (SELECT SNO
                          FROM   #TESTIMPORT
                          WHERE  LEFT(ONEROW,8) = 'TXN_DATE')
    END
    
  DELETE FROM #TESTIMPORT
  WHERE       SNO = 1
                    
  DELETE FROM #TESTIMPORT
  WHERE       ONEROW IS NULL
              
  DELETE FROM #TESTIMPORT
  WHERE       RTRIM(LEFT(ONEROW,1)) = CHAR(9)
                                      
  SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW,')',''),'(',''),'"',
                          '')
  INTO   #TESTIMPORT1
  FROM   #TESTIMPORT
         
  DROP TABLE #TESTIMPORT
  
  SELECT *
  INTO   TESTIMPORT
  FROM   #TESTIMPORT1
         
  DROP TABLE #TESTIMPORT1

  SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "', no_output"
  PRINT @@SQL
  EXEC (@@SQL)

  DROP TABLE TESTIMPORT
  
  IF @BANK_TYPE = 'CITYRECO'
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ';', KEEPNULLS)"
    END
    ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB'
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
    END
    ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV') OR @BANK_TYPE = 'UTIRECO' 
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"
    END
    ELSE IF @BANK_TYPE = 'ICICIRECO' 
    BEGIN
      SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
  END

  PRINT @@SQL
  EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalEffectiveAmt
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 29-Sep-01 8:12:02 PM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.CalEffectiveAmt    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE   CalEffectiveAmt   @advicedate   datetime ,
@effdate datetime,
@LimitAmt    money
 AS
 select  l.cltcode, l.acname, EffCrAmt  =  abs( balamt),
 creditAmt= isNULL( (SELECT ISNULL(SUM(VAMT),0)
   FROM LEDGER L1
   WHERE  L.CLTCODE=L1.CLTCODE  AND DRCR='C'   
    AND    EDT  > =  @effdate   
    and   vdt   <= @advicedate  ),0)
 from ledger l ,acmast a
 where   
vdt  =  (select    max(vdt)     from ledger l1 where l1.cltcode=l.cltcode 
  and  vdt  <=  @advicedate  )  
 and l.cltcode=a.cltcode and a.accat= '4'
and  l.balamt<0  
/* commented on 03/11/200
and l.acname not like  'M-%'  and  l.cltcode between '11000'  and '60000'
and l.cltcode not in ( 'CLI','30','40')*/
  and   abs( l.balamt) > = @limitamt
 order by l.cltcode,vdt,vtyp,vno1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CashDisplay
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.CashDisplay    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.CashDisplay    Script Date: 01/11/2003 3:42:03 PM ******/
/****** Object:  Stored Procedure dbo.CashDisplay    Script Date: 01/28/2002 6:31:42 PM ******/
/**********************************************************************************************************************************************************************************************
THIS SP  IS USED IN THE CASH DISPLAY REPORT 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Modification Done By Sheetal On 25/01/2002
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added two new parameters viz: @flag and @costcode. 
These are used to display the Cash transactions either for all the branches or for a particular branch 
Depending on the @flag value 
If @flag = 0  then show Cash transaction for all the branches
If @flag = 1 then show Cash transaction for a selected branch (i.e for the passed costcode )
************************************************************************************************************************************************************************************************/
CREATE Procedure CashDisplay
@tstrtDate   datetime,
@tEndDate   datetime,
@tCode  varchar(10),
@vdtedtflag tinyint,
@flag int,
@costcode smallint
As
if @vdtedtflag = 0 
begin
	if @flag = 0 
	begin
		select vdt = l.vdt,vtyp,l.vno,acname ,cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		   	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    	                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0) end ),'')
		from ledger l  
		where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and cltcode not like @tCode   and vdt >= @tstrtDate  and vdt <= @tEndDate  and vtyp <> 18 
		order by vdt,vtyp ,vno
	end 
	Else if @flag = 1
	begin
		select vdt = l.vdt,vtyp,l.vno,acname ,l.cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		    	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    	                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0) end ),'')
		from ledger l  , ledger2 l2
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.booktype = l2.booktype and l.lno = l2.lno 
		and l. vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and l.cltcode not like @tCode   and vdt >= @tstrtDate  and vdt <= @tEndDate and costcode = @costcode
		and vtyp <> 18 
		order by vdt,vtyp ,l.vno
	end 
end
if @vdtedtflag = 1 
begin
	if @flag = 0 
	begin
		select vdt = l.edt,vtyp,l.vno,acname ,cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		   	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    	                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 ) end ),'')
		from ledger l  
		where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and cltcode not like @tCode   and edt >= @tstrtDate  and edt <= @tEndDate  and vtyp <> 18 
		order by vdt,vtyp ,vno
	end 
	Else if @flag = 1
	begin
		select vdt = l.edt,vtyp,l.vno,acname , l.cltcode ,vamt ,
		drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		    	                then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    	                else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 ) end ),'')
		from ledger l  , ledger2 l2
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.booktype = l2.booktype and l.lno = l2.lno 
		and l. vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
		and l.cltcode not like @tCode   and edt >= @tstrtDate  and edt <= @tEndDate and costcode = @costcode
		and vtyp <> 18 
		order by vdt,vtyp ,l.vno
	end 
end
/*
if @vdtedtflag = 0 
begin
	select vdt = l.vdt,vtyp,l.vno,acname ,cltcode ,vamt ,
	drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno ) end ),'')
	from ledger l  
	where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
	and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
	and cltcode not like @tCode   
	and vdt >= @tstrtDate  
	and vdt <= @tEndDate
	and vtyp <> 18 
	order by vdt,vtyp ,vno
end
if @vdtedtflag = 1 
begin
	select vdt = l.edt,vtyp,l.vno,acname ,cltcode ,vamt ,
	drcr = (select drcr from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	balamt= (select sum(balamt) from ledger l1 where cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno ) end ),'')
	from ledger l  
	where vno in(select vno from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
	and vtyp in(select vtyp from ledger l1 where  cltcode=@tCode and l.vno=l1.vno and l.vtyp=l1.vtyp)   
	and cltcode not like @tCode   
	and edt >= @tstrtDate  
	and edt <= @tEndDate
	and vtyp <> 18  
	order by vdt,vtyp ,vno
end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_tb_diff
-- --------------------------------------------------


create procedure check_tb_diff
as
set nocount on
set transaction isolation level read uncommitted

select cltcode,vamt=sum(case when drcr='D' then vamt else -vamt end)
into #file1
from ledger 
where vdt >='Apr 1 2005 00:00:00' and vdt <= 'Mar 31 2006 23:59:59'
group by cltcode

select cltcode,vamt=sum(case when drcr='D' then vamt else -vamt end)
into #file2
from ledger 
where vdt >='Apr 1 2006 00:00:00' and vdt <= 'Mar 31 2007 23:59:59' and vtyp=18
group by cltcode

select cltcode=isnull(a.cltcode,b.cltcode),Cls_amt=isnull(a.vamt,0),
Opn_amt=isnull(b.vamt,0),Diff_amt=isnull(a.vamt,0)-isnull(b.vamt,0)
from #file1 a full outer join #file2 b on a.cltcode=b.cltcode
where isnull(a.vamt,0)-isnull(b.vamt,0) <> 0
order by isnull(a.cltcode,b.cltcode)

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CheckMarginopbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 03/28/2003 4:33:12 PM ******/
CREATE Procedure CheckMarginopbal
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime
as
select l.lno, l.cltcode, amt=(case when upper(drcr) = 'D' then vamt else -vamt end), t.bal
from ledger l left outer join acmast a on l.cltcode = a.cltcode,
(select mcltcode, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)
from marginledger where vdt >= @sdtcur + ' 00:00:00'  and vdt <= @ldtcur +' 23:59:59'
group by mcltcode) t
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno
and a.accat = 14 and t.mcltcode = l.cltcode and 
(case when upper(drcr) = 'D' then vamt else -vamt end) <> bal

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ChequeAck
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.ChequeAck    Script Date: 20-Mar-01 11:43:32 PM ******/
/*
control name  : ChqAckPrintCtl
Use : To get all chequet details  in order to print receipt
Written by : Kalpana
Date : 14/02/2001
*/
CREATE PROCEDURE ChequeAck
@ReceiptNo integer
AS
select l1.receiptno, acname ,vamt ,bnkname ,dddt ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,narr
from ledger1 l1,ledger l , ledger3 l3
where receiptno = @ReceiptNo and l.vno = l1.vno and l.vtyp = l1.vtyp and l.lno = l1.lno and  l.drcr = 'c'  and l.vtyp = '2'
 and l.vno = l3.vno 
 and l.vtyp = l3.vtyp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ChequeDetailsSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ChequeDetailsSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ChequeDetailsSP    Script Date: 10/16/2002 4:39:40 PM ******/
CREATE Proc ChequeDetailsSP 
@cltcode varchar(10),
@option varchar(2),
@vdt varchar(11)
As
select acname ,bnkname,brnname,vamt=relamt,ddno,l.vtyp,l.vno,l.lno,l.drcr,l.vdt ,l.booktype, l.cltcode
from ledger l, ledger1 l1 
where  l1.vtyp=l.vtyp and l1.vno=l.vno and l.lno = l1.lno
and l.vtyp in (select vtyp from ledger 
where l.vtyp = vtyp and l.vno = vno and l.booktype = booktype and vtyp ='2' and cltcode =@cltcode) 
 and l.vno in (select vno from ledger where l.vtyp = vtyp and l.vno = vno and l.booktype = booktype and ( vtyp = '2' or vtyp = '5' ) and cltcode =@cltcode) 
 and clear_mode like @option and l.cltcode <> @cltcode and l.vdt like @vdt + '%' and l.booktype=l1.booktype and (slipno =0 or slipno = '')
union all
select a.acname ,bnkname,brnname,vamt=relamt,ddno,l.vtyp,l.vno,l.lno,l.drcr,l.vdt ,l.booktype, m.party_code
from ledger l, ledger1 l1, marginledger m, acmast a
where  l1.vtyp=l.vtyp and l1.vno=l.vno and l.lno = l1.lno
and l.vtyp in (select vtyp from ledger where
 l.vtyp = vtyp and l.vno = vno and l.booktype = booktype and vtyp ='19' and cltcode =@cltcode) 
and l.vno in (select vno from ledger where l.vtyp = vtyp and l.vno = vno and l.booktype = booktype and vtyp ='19'  and cltcode =@cltcode) 
and clear_mode like @option and l.cltcode <> @cltcode and l.vdt like @vdt+ '%'
and m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno 
and m.lno = l.lno and a.cltcode = m.party_code and l.booktype=l1.booktype and (slipno =0 or slipno = '')
order by l.vno, l.lno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Chequedetailssp_New
-- --------------------------------------------------
--EXEC CHEQUEDETAILSSP_NEW '02014', '', 'OCT  1 2008', ''      
CREATE PROC [dbo].[Chequedetailssp_New]         
@CLTCODE VARCHAR(10),                     
@OPTION VARCHAR(2),                     
@VDT VARCHAR(11),                     
@STATUSNAME VARCHAR(25)                    
AS                    
      
SELECT * INTO #LEDGER FROM LEDGER WHERE VTYP IN (2, 19) AND VDT LIKE @VDT + '%'      
               
IF @OPTION = ''              
BEGIN    
 IF @STATUSNAME = 'BROKER'    
 BEGIN    
  SELECT DISTINCT ACNAME, CLTCODE, BNKNAME, BRNNAME, VAMT, DDNO, L.VTYP, L.VNO, L.LNO, L.DRCR, L.VDT , L.BOOKTYPE, CITY = ''                    
  FROM #LEDGER L, LEDGER1 L1         
  WHERE  L1.VTYP = L.VTYP AND L1.VNO = L.VNO                  
  AND EXISTS (SELECT VNO FROM LEDGER L2 WHERE L.VTYP = L2.VTYP AND L.VNO = L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE AND VTYP IN (2, 19)  AND CLTCODE = @CLTCODE AND L2.VDT LIKE @VDT + '%')                     
  AND CLEAR_MODE IN ('X','L','N','S','H') AND L.CLTCODE <> @CLTCODE               
 END    
 ELSE    
 BEGIN    
  SELECT DISTINCT L.ACNAME, L.CLTCODE, BNKNAME, BRNNAME, VAMT, DDNO, L.VTYP, L.VNO, L.LNO, L.DRCR, L.VDT , L.BOOKTYPE, CITY = ''                    
  FROM #LEDGER L, LEDGER1 L1, ACMAST A         
  WHERE  L1.VTYP = L.VTYP AND L1.VNO = L.VNO                  
  AND EXISTS (SELECT VNO FROM LEDGER L2 WHERE L.VTYP = L2.VTYP AND L.VNO = L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE AND VTYP IN (2, 19)  AND CLTCODE = @CLTCODE AND L2.VDT LIKE @VDT + '%')                     
  AND CLEAR_MODE IN ('X','L','N','S','H') AND L.CLTCODE <> @CLTCODE AND A.CLTCODE = L.CLTCODE    
  AND A.BRANCHCODE = @STATUSNAME    
 END    
END              
              
ELSE              
BEGIN     
 IF @STATUSNAME = 'BROKER'    
 BEGIN         
  SELECT DISTINCT ACNAME, CLTCODE, BNKNAME, BRNNAME, VAMT, DDNO, L.VTYP, L.VNO, L.LNO, L.DRCR, L.VDT , L.BOOKTYPE, CITY = ''                    
  FROM #LEDGER L, LEDGER1 L1         
  WHERE  L1.VTYP = L.VTYP AND L1.VNO = L.VNO                  
  AND EXISTS (SELECT VNO FROM LEDGER L2 WHERE L.VTYP = L2.VTYP AND L.VNO = L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE AND VTYP IN (2, 19)  AND CLTCODE = @CLTCODE AND L2.VDT LIKE @VDT + '%')                     
  AND CLEAR_MODE IN (@OPTION) AND L.CLTCODE <> @CLTCODE               
 END    
 ELSE    
 BEGIN    
  SELECT DISTINCT L.ACNAME, L.CLTCODE, BNKNAME, BRNNAME, VAMT, DDNO, L.VTYP, L.VNO, L.LNO, L.DRCR, L.VDT , L.BOOKTYPE, CITY = ''                    
  FROM #LEDGER L, LEDGER1 L1, ACMAST A         
  WHERE  L1.VTYP = L.VTYP AND L1.VNO = L.VNO                  
  AND EXISTS (SELECT VNO FROM LEDGER L2 WHERE L.VTYP = L2.VTYP AND L.VNO = L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE AND VTYP IN (2, 19)  AND CLTCODE = @CLTCODE AND L2.VDT LIKE @VDT + '%')                     
  AND CLEAR_MODE IN (@OPTION) AND L.CLTCODE <> @CLTCODE AND A.CLTCODE = L.CLTCODE    
  AND A.BRANCHCODE = @STATUSNAME     
 END    
END                  
                
--EXEC CHEQUEDETAILSSP_NEW '995116','','JUN  2 2005','BROKER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ChqAckPartySelectSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ChqAckPartySelectSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ChqAckPartySelectSp    Script Date: 01/04/1980 1:40:36 AM ******/
Create Proc ChqAckPartySelectSp 
@Vdt varchar(11)
As
Select Distinct Acname, Cltcode 
from Ledger 
where Vtyp = '2' and drcr = 'c' and Vdt like @Vdt+'%'
union
Select Distinct Acname, party_code 
from acmast,marginledger 
where Vtyp = '19' and party_code = cltcode and Vdt like @Vdt+'%'
order by acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ChqAckPrint
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ChqAckPrint    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ChqAckPrint    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ChqAckPrint    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ChqAckPrint    Script Date: 09/21/2001 2:39:20 AM ******/
/****** Object:  Stored Procedure dbo.ChqAckPrint    Script Date: 09/14/2001 2:57:00 AM ******/
CREATE Procedure ChqAckPrint
@vdt varchar(11),
@cltcode varchar(10),
@vamt money,
@chqno varchar(15),
@Flag integer
As
If @flag = 1
begin
	if @vamt = 0
	begin		
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = l.acname ,
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			 then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			 else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '2' and  l.drcr = 'c'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%' and ddno like rtrim(@chqno) + '%'
		Union
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr, l.vdt,
		acname = isnull((select acname from marginledger m, acmast a where vtyp = l1.vtyp and vno = l1.vno and m.booktype=l1.booktype and a.cltcode = m.party_code),''),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			 then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			 else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '19'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%' and ddno like rtrim(@chqno) + '%'
		order by acname, l.vdt
	end
	
	else if @vamt > 0 
	Begin
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = l.acname ,
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			 then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			 else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '2' and  l.drcr = 'c'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%'
		and vamt = @vamt and ddno like @chqno + '%'		
		Union
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr, l.vdt,
		acname = isnull((select acname from marginledger m, acmast a where vtyp = l1.vtyp and vno = l1.vno and m.booktype=l1.booktype and a.cltcode = m.party_code),''),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			 then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			 else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '19' and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%' and vamt = @vamt and ddno like @chqno + '%'
		order by acname, l.vdt
	End
end
else If @flag = 2
begin
	if @vamt = 0
	begin
		select l1.receiptno, vamt ,bnkname, dddt =left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = l.acname,
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
		      then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
		      else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '2' and  l.drcr = 'c'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.cltcode = @cltcode and ddno like @chqno + '%'
		Union
		select l1.receiptno, vamt ,bnkname, dddt =left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = isnull((select acname from marginledger m, acmast a where vtyp = l1.vtyp and vno = l1.vno and m.booktype=l1.booktype and a.cltcode = m.party_code),''),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
		      then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
		      else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '19' and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.cltcode = @cltcode and ddno like @chqno + '%'
		order by acname, l.vdt
	end
	else if @vamt > 0 
	begin
		select l1.receiptno, vamt ,bnkname, dddt =left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = l.acname,
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
		      then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
		      else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp='2' and  l.drcr = 'c'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.cltcode = @cltcode
		and vamt = @vamt and ddno like @chqno + '%'
		Union
		select l1.receiptno, vamt ,bnkname, dddt =left(convert(varchar,dddt,103),11) ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = isnull((select acname from marginledger m, acmast a where vtyp = l1.vtyp and vno = l1.vno and m.booktype=l1.booktype and a.cltcode = m.party_code),''),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
		      then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
		      else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp='19'  and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.cltcode = @cltcode
		and vamt = @vamt and ddno like @chqno + '%'
		order by acname, l.vdt
	end
	
end
else If @flag = 3
begin
	if @vamt = 0
	begin
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11)  ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname =  l.acname,
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '2' and  l.drcr = 'c'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%'
		and l.cltcode = @cltcode and ddno like @chqno + '%'
		Union
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11)  ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = isnull((select acname from marginledger m, acmast a where vtyp = l1.vtyp and vno = l1.vno and m.booktype=l1.booktype and a.cltcode = m.party_code),''),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '19'  and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%'
		and l.cltcode = @cltcode and ddno like @chqno + '%'
		order by acname, l.vdt
	end
	else if @vamt > 0 
	begin
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11)  ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname =  l.acname,
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp = '2' and  l.drcr = 'c'
		and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%'
		and l.cltcode = @cltcode and vamt = @vamt and ddno like @chqno + '%'
		Union
		select l1.receiptno, vamt ,bnkname ,dddt = left(convert(varchar,dddt,103),11)  ,ddno,brnname ,l.vno,l.vtyp, l.lno,l.drcr ,l.vdt,
		acname = isnull((select acname from marginledger m, acmast a where vtyp = l1.vtyp and vno = l1.vno and m.booktype=l1.booktype and a.cltcode = m.party_code),''),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L1.VTYP = L3.VTYP AND L1.VNO = L3.VNO and l1.booktype = l3.booktype AND  l3.naratno = l1.lno ) ,'') 
/*
		narr = isnull((case when (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) is not null
			then (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype and naratno = l1.lno) 
			else (select narr from ledger3 where vtyp = l1.vtyp and vno = l1.vno and booktype=l1.booktype ) end ),'')
*/
		from ledger1 l1,ledger l 
		where l1.vtyp ='19' and l.vtyp = l1.vtyp and l.vno = l1.vno and l.booktype=l1.booktype and l.lno = l1.lno  
		and l.vdt like @vdt + '%'
		and l.cltcode = @cltcode and vamt = @vamt and ddno like @chqno + '%'
		order by acname, l.vdt
	end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ChqAckVdtSelectSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ChqAckVdtSelectSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ChqAckVdtSelectSp    Script Date: 01/04/1980 1:40:36 AM ******/
Create Proc ChqAckVdtSelectSp 
@Cltcode varchar(10)
As
Select Distinct  Convert(varchar,vdt,103) vdt
from Ledger 
where Vtyp = '2' and drcr = 'c' and cltcode like @Cltcode +'%'
union
Select distinct Convert(varchar,vdt,103) vdt
from acmast,marginledger 
where Vtyp = '19' and party_code = @Cltcode+'%' and party_code = cltcode 
Order By vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.clcode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.clcode    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.clcode    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.clcode    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE clcode
@cltcode varchar(10)
 AS
select distinct cl_code from ncdx.dbo.client2 where party_code=@cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENT_FUND_BALANCE_NCDEX
-- --------------------------------------------------


CREATE PROC [dbo].[CLIENT_FUND_BALANCE_NCDEX]

AS

declare @acyearfrom as datetime,@acyearto as datetime

select @acyearfrom=sdtcur,@acyearto=ldtcur from parameter (nolock) 
where sdtcur <=getdate() and ldtcur >=getdate()

select a.* into
#temp
from
(

select a.cltcode,b.acname,Fund_balance=sum(case when drcr='D' then -vamt else vamt end)  
from ledger a (nolock) 
left outer join 
acmast b
on a.cltcode=b.cltcode
where vdt >=@acyearfrom and vdt<=getdate()
and a.cltcode in 
(select cltcode from acmast where grpcode in (select grpcode from intranet.roe.dbo.ff_bank_grpcode where segment='NCDX')
and cltcode not in (select cltcode from intranet.roe.dbo.ff_bank_details where segment='NCDEX' and cltcode <> 0)
and cltcode not in (SELECT CLTCODE FROM intranet.roe.dbo.FF_REJ_BANK_DETAILS WHERE SEGMENT='NCDEX')  
) 
group by a.cltcode,b.acname
) a

select * from #temp
union all
select 'TOTAL','' ,sum(fund_balance) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENT_FUNDS_REPORTING
-- --------------------------------------------------


--EXEC CLIENT_FUNDS_REPORTING 'APR  1 2018', 'NOV 27 2018'

CREATE PROCEDURE [dbo].[CLIENT_FUNDS_REPORTING]
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@FR_CODE VARCHAR(10) = '0',
	@TO_CODE VARCHAR(10) = 'ZZZZZ'
AS

CREATE TABLE #CLIENT_DETAILS
(
	UCC_CODE VARCHAR(15), 
	CL_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(100), 
	PAN_GIR_NO VARCHAR(20)
)

INSERT INTO #CLIENT_DETAILS
SELECT UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
FROM MSAJAG..CLIENT_DETAILS WHERE CL_CODE BETWEEN @FR_CODE AND @TO_CODE



CREATE TABLE #LEDGER_PL
(
	UCC_CODE VARCHAR(10),
	CLTCODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	CLIENT_PAN VARCHAR(30),
	VDT DATETIME,
	EDT DATETIME,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	VTYPE VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	OPBAL MONEY,
	PDT DATETIME,
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #LEDGER_PL
SELECT
	UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO, VDT, EDT, EXCHANGE, SEGMENT, SETT_NO = '', CHQ_NO = '', VDESC, NARRATION = L.NARRATION, VNO, 
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, L.VTYP, L.BOOKTYPE, 0, PDT
FROM
	#CLIENT_DETAILS C, 
	(SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND CLTCODE BETWEEN @FR_CODE AND @TO_CODE) L, 
	VMAST V, OWNER O
WHERE
	C.CL_CODE = CLTCODE
	AND L.VTYP = V.VTYPE
ORDER BY CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE


CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CLTCODE FROM #LEDGER_PL) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CLTCODE AND L.VDT >= SDTCUR AND VDT < @FR_DATE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CLTCODE FROM #LEDGER_PL) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CLTCODE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR
	AND VDT BETWEEN SDTCUR AND LDTCUR AND VTYP = 18
	GROUP BY L.CLTCODE
) L
GROUP BY CLTCODE

UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O WHERE L.CLTCODE = O.CLTCODE

--UPDATE L SET RUNNING_BALANCE = (SELECT SUM(CRAMOUNT - DRAMOUNT) FROM #LEDGER_PL L1 WHERE O.CLTCODE = L1.CLTCODE AND L.CLTCODE = L1.CLTCODE AND L1.SNO < L.SNO) FROM #LEDGER_PL L, #OPBAL O
--WHERE L.CLTCODE = O.CLTCODE

SELECT 
	UCC_CODE, 
	CLTCODE, 
	LONG_NAME, 
	CLIENT_PAN, 
	VDT,
	EDT,
	EXCHANGE,
	SEGMENT,
	SETT_NO,
	CHQ_NO,
	VTYPE,
	NARRATION,
	VNO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT 
FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientBalanceEdtSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClientBalanceEdtSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClientBalanceEdtSP    Script Date: 03/20/2002 11:33:47 AM ******/
/****** Object:  Stored Procedure dbo.ClientBalanceEdtSP    Script Date: 03/12/02 3:10:23 PM ******/
/************************************************************************************************************************************************************************************************
Created by vaishali on 28/02/2001 Calculated the debit and credit amount for client
Recent Changes are done by Vaishali on 19/11/2001 This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE Procedure ClientBalanceEdtSP
@fromdate as varchar(21),
@todate as varchar(21),
@fromamt money,
@toamt money,
@flag tinyint 
AS
If @flag = 1
begin 
	SELECT bal = (Sum(debit) - Sum(credit))
        	FROM partydrcredtview p, ACMAST a
        	where p.edt >= @fromdate and p.edt <= @todate  and a.accat = '4' and p.cltcode = a.cltcode	
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt	
	and Abs(Sum(debit) - Sum(credit)) <= @toamt
end 
--COMMENTED BY SHEETAL ON 15-02-2002  ADDED FROM DATE AND TO DATE AS PARAMETERS 
/*
@tdate as varchar(21),
@fromamt money,
@toamt money,
@flag tinyint 
As
*/
/*already commented 
If @flag = 1
begin 
	SELECT bal = (Sum(debit) - Sum(credit) )
        FROM partydrcredtview p, ACMAST a,PARAMETER
        where p.edt >= sdtcur and p.edt <= @tdate
        and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode
end 
If @flag = 2
begin 
	SELECT bal = (Sum(debit) - Sum(credit) )
        FROM partydrcredtview p, ACMAST a,PARAMETER
        where p.edt >= sdtcur and p.edt <= @tdate
        and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt
end 
If @flag = 3
begin 
	SELECT bal = (Sum(debit) - Sum(credit) )
        FROM partydrcredtview p, ACMAST a,PARAMETER
        where p.edt >= sdtcur and p.edt <= @tdate
        and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode
	Having Abs(Sum(debit) - Sum(credit)) <= @toamt
end 
already commented */
/*
If @flag = 1
begin 
	SELECT bal = round(Sum(debit) - Sum(credit) ,2)
        	FROM partydrcredtview p, ACMAST a,PARAMETER
       	 where p.edt >= sdtcur and p.edt <= @tdate
       	 and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode	
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt	
	and Abs(Sum(debit) - Sum(credit)) <= @toamt
end 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientBalanceSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClientBalanceSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClientBalanceSP    Script Date: 03/20/2002 11:33:47 AM ******/
/****** Object:  Stored Procedure dbo.ClientBalanceSP    Script Date: 03/12/02 3:10:23 PM ******/
/************************************************************************************************************************************************************************************************
Created by vaishali on 28/02/2001 Calculated the debit and credit amount for client
Recent Changes are done by Vaishali on 19/11/2001 This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE Procedure ClientBalanceSP
@fromdate as varchar(21),
@todate as varchar(21),
@fromamt money,
@toamt money,
@flag tinyint 
AS
If @flag = 1
begin 
	SELECT bal = (Sum(debit) - Sum(credit) )
        	FROM partydrcrview p, ACMAST a
        	where p.vdt >= @fromdate and p.vdt <= @todate  and a.accat = '4' and p.cltcode = a.cltcode	
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt	
	and Abs(Sum(debit) - Sum(credit)) <= @toamt
end 
--COMMENTED BY SHEETAL ON 15-02-2002  ADDED FROM DATE AND TO DATE AS PARAMETERS 
/*
@tdate as varchar(21),
@fromamt money,
@toamt money,
@flag tinyint 
As
*/
/*already commented
If @flag = 1
begin 
	SELECT bal =( Sum(debit) - Sum(credit) )
        	FROM partydrcrview p, ACMAST a,PARAMETER
       	 where p.vdt >= sdtcur and p.vdt <= @tdate
	 and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode
end 
If @flag = 2
begin 
	SELECT bal = ( Sum(debit) - Sum(credit) )
        FROM partydrcrview p, ACMAST a,PARAMETER
        where p.vdt >= sdtcur and p.vdt <= @tdate
        and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt
end 
If @flag = 3
begin 
	SELECT bal =( Sum(debit) - Sum(credit) )
        FROM partydrcrview p, ACMAST a,PARAMETER
        where p.vdt >= sdtcur and p.vdt <= @tdate
        and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode
	Having Abs(Sum(debit) - Sum(credit)) <= @toamt
end 
already commented*/
/*
If @flag = 1
begin 
	SELECT bal = round(Sum(debit) - Sum(credit) ,2)
        	FROM partydrcrview p, ACMAST a,PARAMETER
        	where p.vdt >= sdtcur and p.vdt <= @tdate
       	 and a.accat = '4' and curyear = '1' and p.cltcode = a.cltcode	
	Having Abs(Sum(debit) - Sum(credit)) >= @fromamt	
	and Abs(Sum(debit) - Sum(credit)) <= @toamt
end 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.clientdetails
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.clientdetails    Script Date: 20-Mar-01 11:43:32 PM ******/
CREATE PROCEDURE clientdetails
@clcode varchar(6)
AS
select c1.Res_Phone1,Off_Phone1, c1.short_name,c2.tran_cat from ncdx.dbo.client1
c1,ncdx.dbo.client2 c2 
where c1.cl_code=@clcode and c2.cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientdetailsSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.ClientdetailsSP    Script Date: 07/24/2001 11:35:22 AM ******/
Create Proc ClientdetailsSP 
@cltcode varchar(10)
AS
select taddr1= isnull(l_address1,'') , taddr2= isnull(l_address2 ,''), tcity =isnull(l_city ,''),tzip= isnull(l_zip ,'') 
from ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
where  c1.cl_code=c2.cl_code and c2.party_code= @cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientDrCrEdtSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClientDrCrEdtSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClientDrCrEdtSp    Script Date: 03/20/2002 11:33:47 AM ******/
/****** Object:  Stored Procedure dbo.ClientDrCrEdtSp    Script Date: 03/12/02 3:10:23 PM ******/
/************************************************************************************************************************************************************************************************
Created by vaishali on 28/02/2001 Calculated the debit and credit amount for client
Recent Changes are done by Vaishali on 19/11/2001 This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE ClientDrCrEdtSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcredtview p,acmast a  
	where p.edt >= @fromdate and p.edt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
--COMMENTED BY SHEETAL ON 15-02-2002  ADDED FROM DATE AND TO DATE AS PARAMETERS 
/*
@tdate as varchar(21),
@fromparty varchar(10),
@toparty varchar(10),
@fromamt money,
@toamt money,
@flag tinyint
AS
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
Check for acname
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcredtview p,parameter,acmast a  
	where edt >= sdtcur and p.edt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientDrCrSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClientDrCrSp    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClientDrCrSp    Script Date: 03/20/2002 11:33:47 AM ******/
/****** Object:  Stored Procedure dbo.ClientDrCrSp    Script Date: 03/12/02 3:10:23 PM ******/
/************************************************************************************************************************************************************************************************
Created by vaishali on 28/02/2001 Calculated the debit and credit amount for client
Recent Changes are done by Vaishali on 19/11/2001 This sp is used in TrialBalancePrint Control
*************************************************************************************************************************************************************************************************/
CREATE PROCEDURE ClientDrCrSp
@fromdate as varchar(21),
@todate as varchar(21),
@fromparty varchar(36),
@toparty varchar(36),
@fromamt money,
@toamt money,
@flag tinyint
AS
/* If from party and to party are selected and if order by partyname is selected*/
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
/* If from party and to party are not selected and if order by partyname is selected*/
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit)) 
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit))
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/* If from party and to party are not selected and if order by cltcode is selected*/
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit))
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4'
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
/*Check on ac name*/
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit))
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
/* If from party and to party are selected and if order by cltcode is selected*/
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =(Sum(debit) - Sum(credit))
	from partydrcrview p,acmast a  
	where vdt >= @fromdate and p.vdt <= @todate
	and p.cltcode = a.cltcode and a.accat = '4' 
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
--COMMENTED BY SHEETAL ON 15-02-2002  ADDED FROM DATE AND TO DATE AS PARAMETERS 
/*
@tdate as varchar(21),
@fromparty varchar(10),
@toparty varchar(10),
@fromamt money,
@toamt money,
@flag tinyint
AS
 If from party and to party are selected and if order by partyname is selected
if @flag = 1
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  	
	order by p.acname
end
 If from party and to party are not selected and if order by partyname is selected
if @flag = 2
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'		
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.acname
end
 If from party and to party are selected and if order by cltcode is selected
if @flag = 3
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.cltcode >= @fromparty and p.cltcode <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
 If from party and to party are not selected and if order by cltcode is selected
if @flag = 4
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'	
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
Check on ac name
if @flag = 11
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt  
	order by p.acname
end
 If from party and to party are selected and if order by cltcode is selected
if @flag = 13
begin
	select isnull(p.cltcode,''),isnull(p.acname,''),bal =round(Sum(debit) - Sum(credit),2) 
	from partydrcrview p,parameter,acmast a  
	where vdt >= sdtcur and p.vdt <= @tdate
	and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
	and p.acname >= @fromparty and p.acname <= @toparty
	group by p.cltcode,p.acname 
	Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
	order by p.cltcode
end
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClPositionPartyCdP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionPartyCdP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE ClPositionPartyCdP 
@shortname varchar(21)
AS
SELECT  party_code from ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
where c1.cl_code = c2.cl_code and c1.short_name like @shortname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClPositionResPhoneP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionResPhoneP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE ClPositionResPhoneP 
@shortname varchar(21)
 AS
SELECT  Res_Phone1 from ncdx.dbo.client1
 where short_name like @shortname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClPositionSettTypeP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionSettTypeP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE ClPositionSettTypeP
@settno varchar(7)
 AS
SELECT DISTINCT SETT_type FROM ncdx.dbo.SETTLEMENT 
where sett_no like @settno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClPositionShortNmP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.ClPositionShortNmP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE ClPositionShortNmP
@shortname varchar(21)
 AS
SELECT DISTINCT SHORT_NAME, Res_Phone1 
FROM ncdx.dbo.CLIENT1 where trader like @shortname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH]
(
	@FCLTCODE VARCHAR(10),
	@TCLTCODE VARCHAR(10)
	,@DATE_FROM VARCHAR(11)
	,@DATE_TO VARCHAR(11)
	,@BANKCODE VARCHAR(30)
	,@DRCR CHAR(1)
	,@REFNO VARCHAR(30)
	,@CHEQUE_NO VARCHAR(30)
	,@AMOUNT NUMERIC(18,2)
	,@STATUS CHAR(1) = ''
	,@FLAG CHAR(2)
	,@SortBy NVARCHAR(50)
	,@BB_DATE_FROM VARCHAR(11)
	,@BB_DATE_TO VARCHAR(11)
	,@FILETYPE NVARCHAR(20)
)
AS 
/*
EXEC CLS_BANKRECO_FETCH '','','01/03/2010','01/12/2015','BANK01','D','','0','',''
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','','0','','L'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BS'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BB'
exec CLS_BANKRECO_FETCH @FCLTCODE='0A143',@TCLTCODE='0A147',@DATE_FROM='01/01/2010',@DATE_TO ='01/01/2015',@BANKCODE='bank01',@DRCR='D',@REFNO='',@STATUS=' ',@FLAG=''
*/
BEGIN
--SET @AMOUNT = (CASE WHEN @AMOUNT = 0 THEN 999999999 ELSE @AMOUNT END)
	IF @FLAG ='' OR @FLAG ='L'  /****BOTH BANK STAAND BANK BOOK AS WELL AS FOR LEDGER ENTRY****/
	BEGIN
	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT /*TOP 15*/ 
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,B.VALUEDATE,DESCRIPTION,AMOUNT,DRCR,CROSSREFERENCENO,BR_SNO,BOOKDATE) AS "RNO",	
				REFERENCENO
				,VALUEDATE = CONVERT(VARCHAR(11)
				,CONVERT(DATETIME,B.ValueDate),103)
				, LEFT (DESCRIPTION,20) AS 'DESCRIPTION'
				/*,CASE	WHEN FILETYPE = 'CMS' THEN '<FONT COLOR="RED">' +LEFT (DESCRIPTION,20) +'</FONT>'
				ELSE '<FONT COLOR="BLUE">'+LEFT (DESCRIPTION,20)+'</FONT>'
				END 	AS 'DESCRIPTION'	*/		
				, DESCRIPTION AS 'TDESCRIPTION'
				, AMOUNT = ROUND(AMOUNT,2)
				,AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2)
				,DRCR
				,CROSSREFERENCENO
				,BR_SNO
				,BOOKDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,BOOKDATE),103)
				,MATCH_FLAG =''
				,COLOR='' 
				FROM BANKRECO B WITH (NOLOCK) 
				,RECON_BANK_FILEUPLOAD_LOGS S
			WHERE 
				--MICRNO = '123456' AND 
				--DUMMY1 = '0' AND	
				B.DUMMY2=S.UPLOADID
				AND CLTCODE = @BANKCODE 	
				AND BOOKDATE BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'
				AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				AND STATUS = 'UNMATCHED' 
				AND LTRIM(RTRIM(DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND FILETYPE=@FILETYPE
			ORDER BY --RNO,AMOUNT,VALUEDATE 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,				
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.VALUEDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
			
		IF @FLAG =''	
			BEGIN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				SELECT /*TOP 15*/ 	
					L.ACNAME
					,L1.DRCR
					,L.CLTCODE
					, ISNULL(L1.DDNO,'0')AS DDNO --.DBO.REMOVE_ZERO(DDNO, '0')
					,DDDT = CONVERT(VARCHAR(10),DDDT,103)
					,RELAMT
					,RELAMTWITH_SIGN  = ROUND(CASE WHEN L1.DRCR = 'C' THEN RELAMT ELSE -RELAMT END,2)
					,VDT = CONVERT(VARCHAR(10),VDT,103)
					,L1.VNO
					,L1.VTYP
					,L1.BOOKTYPE
					,L1.LNO
					,RELDT
					,SHORTDESC
					,L1_SNO
					,ACCNO=''
					,MATCH_FLAG =''
					,COLOR='' 
					,VALUEDT = ''
					,A.BRANCHCODE AS BRANCHCODE--'Test'/*A.Pobranch*/ AS BRANCHCODE
					,L.Acname
					,L.Narration
				FROM 
					LEDGER L WITH (NOLOCK),LEDGER1 L1 WITH (NOLOCK)
					--,MULTIBANKID M WITH (NOLOCK)
					, 	VMAST V 
					,ACMAST A
				WHERE 
					ISNULL(L1.DDNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L1.DDNO,'0') ELSE @CHEQUE_NO  END)
					AND L1.VTYP IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					--AND L.CLTCODE=M.CLTCODE
					--AND DEFAULTBANK = 1 
					AND L.VNO=L1.VNO AND L.VTYP=L1.VTYP AND L.LNO=L1.LNO
					AND L.BOOKTYPE=L1.BOOKTYPE 	
					AND LTRIM(RTRIM(L1.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L1.DRCR))ELSE @DRCR END)
					AND EXISTS (SELECT VNO FROM LEDGER L2 WITH (NOLOCK) WHERE CLTCODE = @BANKCODE 
								AND L.VTYP=L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO 	
								AND L2.VDT >= ( CASE WHEN @BB_DATE_FROM='' THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00' ELSE CONVERT(VARCHAR(11),CONVERT(DATETIME,@BB_DATE_FROM,103),109)+ ' 00:00:00' END )
								AND L2.VDT <= (CASE WHEN @BB_DATE_TO='' THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109) + ' 23:59:59' ELSE CONVERT(VARCHAR(11),CONVERT(DATETIME,@BB_DATE_TO,103),109) + ' 23:59:59' END )) 	
					AND L.CLTCODE <> @BANKCODE AND RELDT LIKE 'JAN  1 1900%' 
					AND V.VTYPE =L.VTYP AND UPPER(CLEAR_MODE) <> 'C' 
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.CLTCODE=A.CLTCODE
				ORDER BY --RELAMT,VDT,L1.VTYP,L1.VNO
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L1.DDNO END, 
				CASE WHEN @SortBy ='Date' THEN DDDT END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
			END
			
	END
	ELSE IF @FLAG ='BS' /****BANK STATEMENT****/
	BEGIN
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
            SELECT
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,b.VALUEDATE,DESCRIPTION,AMOUNT,B.DRCR,CROSSREFERENCENO,BR_SNO) AS "RNO",
				REFERENCENO,
				VALUEDATE = CONVERT(VARCHAR(11),
				CONVERT(DATETIME,B.VALUEDATE),103),
				LEFT (DESCRIPTION,15)DESCRIPTION,
				DESCRIPTION AS 'TDESCRIPTION',
				AMOUNT = ROUND(AMOUNT,2),
				AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2),
				B.DRCR,
				CROSSREFERENCENO,
				BR_SNO ,DUMMY1,MATCH_FLAG = ''
            FROM
				BANKRECO B WITH (NOLOCK) ,RECON_BANK_FILEUPLOAD_LOGS s
            WHERE 
			B.DUMMY2=S.UPLOADID
			AND FILETYPE=@FILETYPE
				AND CROSSREFERENCENO = (CASE WHEN @REFNO = '' THEN CROSSREFERENCENO ELSE @REFNO END)
				--AND DUMMY1 = '0' 
				AND CLTCODE = @BANKCODE AND [STATUS] = (CASE WHEN @STATUS = 'M' THEN 'MATCHED' ELSE [STATUS] END)
				AND LTRIM(RTRIM(B.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(B.DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND B.VALUEDATE  BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)
            ORDER BY --RNO,VALUEDATE, 	AMOUNT, 	B.DRCR
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.ValueDate END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
	END
	ELSE IF @FLAG ='BB' AND @REFNO = ''/****BANK BOOK****/
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L1.DRCR,
			L.CLTCODE,L.VNO,
			ISNULL(L1.DDNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
			DDDT = CONVERT(VARCHAR(10),DDDT,103),
			RELAMT = ROUND(RELAMT,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),RELDT,103),
			L1.REFNO,MATCH_FLAG ='' 
        FROM 
			LEDGER L WITH (NOLOCK), 	LEDGER1 L1 WITH (NOLOCK), 	VMAST V 
        WHERE 
			L1.VTYP IN ( '2','3' ,'5', '19','17', '20' )
			AND ISNULL(L1.DDNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L1.DDNO,'0') ELSE @CHEQUE_NO  END)
			AND L1.REFNO = (CASE WHEN @REFNO = '' THEN L1.REFNO ELSE @REFNO END)
			AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
			AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
			AND L.VNO=L1.VNO 	AND L.VTYP=L1.VTYP
			AND L.LNO=L1.LNO 	AND L.BOOKTYPE=L1.BOOKTYPE
			AND EXISTS 	( SELECT VNO FROM LEDGER L2 WITH (NOLOCK) WHERE CLTCODE = @BANKCODE AND L.VTYP=L2.VTYP 
			AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L2.VDT >=CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) + ' 00:00:00'
			AND L2.VDT <= CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59' ) AND L.CLTCODE <> @BANKCODE AND RELDT NOT LIKE 'JAN  1 1900%'
			AND LTRIM(RTRIM(L1.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L1.DRCR))ELSE @DRCR END)
			AND V.VTYPE =L.VTYP 	AND UPPER(CLEAR_MODE) <> 'C' 
			AND L1.REFNO NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
	END
	
	ELSE IF @FLAG ='BB' AND @REFNO <> ''/****BANK BOOK FOR CHECKEDEDIT****/
	BEGIN

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L1.DRCR,
			L.CLTCODE,L.VNO,
			ISNULL(L1.DDNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
			DDDT = CONVERT(VARCHAR(10),DDDT,103),
			RELAMT = ROUND(RELAMT,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),RELDT,103),
			L1.REFNO,MATCH_FLAG ='' 
			,A.BRANCHCODE AS BRANCHCODE--'Test_BB'/*A.Pobranch*/ AS BRANCHCODE
        FROM 
			LEDGER L WITH (NOLOCK), 	LEDGER1 L1 WITH (NOLOCK), 	VMAST V ,ACMAST A
        WHERE 
			L1.VTYP IN ( '2','3' ,'5', '19','17', '20' )			
			AND L1.REFNO = @REFNO			
			AND L.VNO=L1.VNO 	AND L.VTYP=L1.VTYP
			AND L.LNO=L1.LNO 	AND L.BOOKTYPE=L1.BOOKTYPE
			AND EXISTS 	( SELECT VNO FROM LEDGER L2 WITH (NOLOCK) WHERE CLTCODE = @BANKCODE AND L.VTYP=L2.VTYP 
			AND L.BOOKTYPE = L2.BOOKTYPE 
			AND L.VNO = L2.VNO 
			--AND L2.VDT >=CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) + ' 00:00:00'
			--AND L2.VDT <= CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59' 
			) 
			--AND L.CLTCODE <> @BANKCODE 
			AND RELDT NOT LIKE 'JAN  1 1900%'
			--AND LTRIM(RTRIM(L1.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L1.DRCR))ELSE @DRCR END)
			AND V.VTYPE =L.VTYP 	
			--AND UPPER(CLEAR_MODE) <> 'C' 
			AND L1.REFNO NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
			AND L.CLTCODE=A.CLTCODE
	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH_DETAILS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH_DETAILS]
(
	@FLAG CHAR(20)
	,@BRSNO NVARCHAR(50)
	,@L1SNO NVARCHAR(50)
)
AS 

BEGIN
DECLARE @FLAGVALUE NVARCHAR(50)
SELECT @FLAGVALUE= .DBO.PIECE(@BRSNO,'|',2)

	IF(@FLAGVALUE='L')
	BEGIN
	SET @FLAG='LEDGER'
	SELECT @L1SNO=.DBO.PIECE(@BRSNO,'|',1)
	SET @BRSNO=''
	END

	IF(@FLAGVALUE='B')
	BEGIN
	SET @FLAG = 'BANKRECO'
	SELECT @BRSNO=.DBO.PIECE(@BRSNO,'|',1)
	END

	--SELECT @FLAG,@BRSNO,@L1SNO	RETURN

	IF @FLAG ='BANKRECO'   
	BEGIN	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		SELECT TOP 1 
		CLTCODE,BOOKDATE,DESCRIPTION,AMOUNT,DRCR,VALUEDATE,REFERENCENO,CROSSREFERENCENO AS CROSSNO,STATUS
		FROM BANKRECO B WITH (NOLOCK) 				
		WHERE B.BR_SNO=@BRSNO
	END			
			
	IF @FLAG ='LEDGER'	
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT	L.VNO,L.VTYP,L.BOOKTYPE,CLTCODE,DDNO,RELAMT,L1.DRCR,L.ACNAME AS 'CLIENTNAME' ,L.NARRATION
			FROM	LEDGER L,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND EXISTS (SELECT	VNO	FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO	AND L11.VTYP = L1.VTYP	AND L11.BOOKTYPE = L1.BOOKTYPE)
			AND L1.L1_SNO = @L1SNO			
	END			
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_UPDATE
-- --------------------------------------------------









CREATE PROCEDURE [dbo].[CLS_BANKRECO_UPDATE]
(

	@PARAM_VAL1 VARCHAR(MAX)
	,@PARAM_VAL2 VARCHAR(MAX)
	,@PARAM_VAL3 VARCHAR(MAX)
	,@FLAG VARCHAR(3)
	,@USERID VARCHAR(30) 
	,@STATUSID VARCHAR(30) 
	,@STATUSNAME VARCHAR(25) 
	,@REFNO VARCHAR(MAX)
	)
	AS
	BEGIN
--	SET @PARAM_VAL1='26757|'
--	SET @PARAM_VAL2=''
--	SET @PARAM_VAL3=''
--SET @FLAG='E  '
--SET @USERID='broker'
--SET @STATUSID='Broker'
--SET @STATUSNAME='Broker'
--SET @REFNO=''

--SET @PARAM_VAL1='471^828^20/08/2007^10/09/2008|'
--SET @PARAM_VAL2=''
--SET @PARAM_VAL3=''
--SET @FLAG='U'
--SET @USERID='broker'
--SET @STATUSID='Broker'
--SET @STATUSNAME='Broker'
--SET @REFNO = '459,471,'

CREATE TABLE #REFNO 
( CROSSREFNO VARCHAR(12),
UPDATED_CROSSREFNO VARCHAR(12)
)
INSERT INTO #REFNO
		SELECT
		.DBO.CLS_PIECE(ITEMS, ',', 1)
		,.DBO.CLS_PIECE(ITEMS, ',', 2)

	FROM.DBO.CLS_SPLIT(@REFNO, ',')
	WHERE.DBO.CLS_PIECE(ITEMS, ',', 1) <> ''

	
CREATE TABLE #TEMP_DATA
		(
			CROSSREFNO VARCHAR(12)
			,LNO BIGINT
			,RELDT VARCHAR(11)
			,VDT VARCHAR(11)
			--,FINAL_DT  AS (CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109)  THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109) ELSE  CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) END)
			,FINAL_DT  AS (CASE WHEN CONVERT(DATETIME,VDT,103) < CONVERT(DATETIME,RELDT,103)  THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109) ELSE  CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) END)
		)

INSERT INTO #TEMP_DATA
	SELECT
		.DBO.CLS_PIECE(ITEMS, '^', 1)
		,.DBO.CLS_PIECE(ITEMS, '^', 2)
		,.DBO.CLS_PIECE(ITEMS, '^', 3)
		,.DBO.CLS_PIECE(ITEMS, '^', 4)
	FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
	WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''


	
ALTER TABLE #TEMP_DATA
ADD VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3)

UPDATE T
SET	T.VNO = L1.VNO
	,T.VTYP = L1.VTYP
	,T.BOOKTYPE = L1.BOOKTYPE
FROM #TEMP_DATA T, LEDGER1 L1
WHERE L1_SNO = T.LNO

UPDATE R 
SET R.UPDATED_CROSSREFNO = T.CROSSREFNO
FROM
#REFNO R, #TEMP_DATA T

IF @REFNO <> ''
BEGIN
UPDATE B 
SET B.Dummy1 = B.Crossreferenceno
, B.Crossreferenceno = R.UPDATED_CROSSREFNO
 FROM Bankreco B,  #REFNO R
 WHERE B.Crossreferenceno = R.CROSSREFNO

UPDATE RC
SET RC.CROSS_NO = R.UPDATED_CROSSREFNO
FROM RECON_CMS_DATA RC,  #REFNO R
WHERE RC.CROSS_NO = R.CROSSREFNO

UPDATE RNC
SET RNC.CROSS_NO = R.UPDATED_CROSSREFNO
FROM Recon_NONCMS_Data RNC,  #REFNO R
WHERE RNC.CROSS_NO = R.CROSSREFNO
END

IF @FLAG = 'U' 
BEGIN

SELECT
	*
FROM #TEMP_DATA

/*******LEDGER1 UPDATE************/
INSERT INTO [CLS_LEDGER1_BANKRECO_LOG] (BNKNAME, BRNNAME, DD, DDNO, DDDT, RELDT, RELAMT, REFNO, RECEIPTNO, VTYP, VNO, LNO, DRCR, BOOKTYPE, MICRNO, SLIPNO, SLIPDATE, CHEQUEINNAME, CHQPRINTED, CLEAR_MODE, L1_SNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		L1.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'MATCHED'
	FROM	LEDGER1 L1
			,#TEMP_DATA T
	WHERE L1_SNO = T.LNO
	SELECT * from CLS_LEDGER1_BANKRECO_LOG
--AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE		

UPDATE L1
SET	RESET_EDT =
				CASE
					WHEN L.EDT LIKE 'DEC 31 2049%' THEN 1
					ELSE 0
				END
	,L1.REFNO = T.CROSSREFNO
FROM LEDGER L, [CLS_LEDGER1_BANKRECO_LOG] L1, #TEMP_DATA T
WHERE L1_SNO = T.LNO
--AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP
AND L.VNO = L1.VNO
AND L.VTYP = L1.VTYP
AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET	L1.REFNO = T.CROSSREFNO
	,L1.RELDT = FINAL_DT --(CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,T.VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,T.RELDT,103),109)  THEN T.RELDT ELSE  T.VDT END)
FROM LEDGER1 L1, #TEMP_DATA T
WHERE L1_SNO = T.LNO

/*******LEDGER UPDATE************/
UPDATE L
SET L.EDT = FINAL_DT --(CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,T.VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,T.RELDT,103),109)  THEN T.RELDT ELSE  T.VDT END)
FROM LEDGER L/*,LEDGER1 L1*/, #TEMP_DATA T
WHERE
/*L1_SNO = T.LNO AND */ L.EDT LIKE 'DEC 31 2049%'
AND L.VNO = T.VNO
AND L.VTYP = T.VTYP
AND L.BOOKTYPE = T.BOOKTYPE --AND L.LNO = L1.LNO


--SELECT L.* FROM LEDGER L,LEDGER1 L1, #TEMP_DATA T  
--WHERE L1_SNO = T.LNO
--AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE 


/*******BANK RECO UPDATE************/

INSERT INTO [CLS_BANKRECO_LOG] (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, BR_SNO, CMS_SRNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		B.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'MATCHED'
	FROM	BANKRECO B
			,#TEMP_DATA T
	WHERE B.CROSSREFERENCENO = T.CROSSREFNO
	SELECT * FROM CLS_BANKRECO_LOG
UPDATE B
SET	VALUEDATE = FINAL_DT --(CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,T.VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,T.RELDT,103),109)  THEN T.RELDT ELSE  T.VDT END),
	,STATUS = 'MATCHED'
FROM BANKRECO B, #TEMP_DATA T
WHERE B.CROSSREFERENCENO = T.CROSSREFNO


IF EXISTS (SELECT
		*
	FROM	RECON_CMS_DATA RC
			,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN

UPDATE RC
SET	MATCHEDFLAG = '1'
	,UPLOADSTATUS = 'MANUAL RECO'
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
FROM RECON_CMS_DATA RC, #TEMP_DATA T
WHERE RC.CROSS_NO = T.CROSSREFNO

END

IF EXISTS (SELECT
		*
	FROM	RECON_NONCMS_DATA RC
			,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN
UPDATE RC
SET	MATCHEDFLAG = '1'
	,UPLOADSTATUS = 'MANUAL RECO'
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
FROM RECON_NONCMS_DATA RC, #TEMP_DATA T
WHERE RC.CROSS_NO = T.CROSSREFNO

END


/*******************************/
END 
ELSE IF 
@FLAG = 'E' 
BEGIN
INSERT INTO [CLS_BANKRECO_LOG] (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, BR_SNO, CMS_SRNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		B.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'UNMATCHED'
	FROM	BANKRECO B
			,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
	WHERE B.CROSSREFERENCENO = C.ITEMS

IF @REFNO <> ''
BEGIN
		
		
UPDATE B
SET STATUS = 'UNMATCHED'
,B.CROSSREFERENCENO = CASE WHEN B.DUMMY1 <> '0' THEN B.DUMMY1 ELSE B.CROSSREFERENCENO END 
--, B.Crossreferenceno = B.Dummy1
FROM BANKRECO B
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
WHERE B.CROSSREFERENCENO = C.ITEMS
-------------------------------UPDATE CMSBANKRECO---------------------------
IF EXISTS (SELECT	*	FROM	RECON_CMS_DATA RC		,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN

UPDATE RC
SET	MATCHEDFLAG = 0
	,UPLOADSTATUS = 'PENDING'
	,CROSS_NO = R.CROSSREFNO
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
	,MATCHCODE = 0
FROM RECON_CMS_DATA RC, #TEMP_DATA T, #REFNO R
WHERE RC.CROSS_NO = T.CROSSREFNO AND T.CROSSREFNO = R.CROSSREFNO

END

-------------------------------UPDATE NONCMSBANKRECO---------------------------
IF EXISTS (SELECT		*	FROM	RECON_NONCMS_DATA RC
			,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN
UPDATE RC
SET	MATCHEDFLAG = 0
	,UPLOADSTATUS = 'PENDING'
	,CROSS_NO = R.CROSSREFNO
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
	,MATCHCODE = 0
FROM RECON_NONCMS_DATA RC, #TEMP_DATA T, #REFNO R
WHERE RC.CROSS_NO = T.CROSSREFNO AND T.CROSSREFNO = R.CROSSREFNO

END

/*-------------------------------------*/
END 

ELSE IF @REFNO = ''
BEGIN
		DECLARE @TEMPDATA TABLE(AMOUNT MONEY,CROSSREFERENCENO NVARCHAR(50),REFERENCENO NVARCHAR(50)
								,DUMMY1 NVARCHAR(50), REFCOUNT INT)
		INSERT INTO @TEMPDATA
		SELECT AMOUNT,CROSSREFERENCENO,REFERENCENO,DUMMY1,COUNT(CROSSREFERENCENO )REFCOUNT 
		FROM BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C 
		WHERE DUMMY1<>0 AND  B.CROSSREFERENCENO = C.ITEMS
		GROUP BY AMOUNT,CROSSREFERENCENO,REFERENCENO,DUMMY1 
		
		IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC	,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
		BEGIN
		UPDATE R
		SET 
		--R.CROSS_NO= B.DUMMY1,
		R.UPLOADSTATUS='PENDING'
		,MATCHEDFLAG=0
		,VNO=NULL
		,VTYP=NULL
		,BOOKTYPE=NULL
		--,CROSS_NO=B.Dummy1
		,MATCHCODE = 0
		FROM RECON_CMS_DATA R ,BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS
		AND B.CROSSREFERENCENO=R.CROSS_NO
		AND B.AMOUNT=R.INST_AMT
		END
		
		IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC ,#TEMP_DATA T WHERE RC.CROSS_NO = T.CROSSREFNO) 
	BEGIN
		UPDATE R
		SET 
		--R.CROSS_NO= B.DUMMY1,
		R.UPLOADSTATUS='PENDING'
		,MATCHEDFLAG=0
		,VNO=NULL
		,VTYP=NULL
		,BOOKTYPE=NULL
		--,CROSS_NO=B.Dummy1
		,MATCHCODE = 0
		FROM RECON_NONCMS_DATA R ,BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS
		AND B.CROSSREFERENCENO=R.CROSS_NO
		AND B.AMOUNT=R.AMT
		END
		
		UPDATE B
		SET STATUS = 'UNMATCHED'
		, B.Crossreferenceno = CASE WHEN B.DUMMY1 <> '0' THEN B.DUMMY1 ELSE B.CROSSREFERENCENO END
		, B.Dummy1=0
		FROM BANKRECO B
		,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS

		IF EXISTS(SELECT * FROM  @TEMPDATA)
		 BEGIN
		    IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC ,#TEMP_DATA T WHERE RC.CROSS_NO = T.CROSSREFNO) 
			BEGIN
			 UPDATE R SET CROSS_NO=T.DUMMY1
			 FROM RECON_NONCMS_DATA R,@TEMPDATA T
			 WHERE R.AMT=T.AMOUNT
			 AND R.REFERENCENO=T.REFERENCENO
			 AND R.CROSS_NO=T.CROSSREFERENCENO
			END 
			IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC	,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
			BEGIN
			 UPDATE R SET CROSS_NO=T.DUMMY1
			 FROM RECON_CMS_DATA R,@TEMPDATA T
			 WHERE R.INST_AMT=T.AMOUNT
			 AND R.INST_NO_CHECK=T.REFERENCENO
			 AND R.CROSS_NO=T.CROSSREFERENCENO
			 ENd
		 
		 END

END

INSERT INTO [CLS_LEDGER1_BANKRECO_LOG] (BNKNAME, BRNNAME, DD, DDNO, DDDT, RELDT, RELAMT, REFNO, RECEIPTNO, VTYP, VNO, LNO, DRCR, BOOKTYPE, MICRNO, SLIPNO, SLIPDATE, CHEQUEINNAME, CHQPRINTED, CLEAR_MODE, L1_SNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		L1.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'UNMATCHED'
	FROM	LEDGER1 L1
			,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
	WHERE L1.REFNO = C.ITEMS
	AND C.ITEMS <> ''
	AND C.ITEMS IS NOT NULL

UPDATE L
SET EDT =
			CASE
				WHEN RESET_EDT = 1 THEN '2049-12-31 00:00:00'
				ELSE EDT
			END
FROM LEDGER L
, LEDGER1 L1
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
, [CLS_LEDGER1_BANKRECO_LOG] CL
WHERE RECO_STATUS = 'MATCHED' --L1.REFNO = C.ITEMS 
AND L1.L1_SNO = CL.L1_SNO
AND L.VNO = L1.VNO
AND L.VTYP = L1.VTYP
AND L.BOOKTYPE = L1.BOOKTYPE
AND C.ITEMS = L1.REFNO
AND C.ITEMS <> ''
AND C.ITEMS IS NOT NULL


UPDATE L1
SET	RELDT = ''
	,REFNO = ''
FROM LEDGER1 L1
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
WHERE L1.REFNO = C.ITEMS
AND C.ITEMS <> ''
AND C.ITEMS IS NOT NULL


END 
ELSE IF @FLAG = 'L' 
BEGIN

DECLARE @BANKCODE VARCHAR(10)
, @CLTCODE VARCHAR(10)
, @VDT VARCHAR(10)
, @NARRATION VARCHAR(300)
, @DATA_STRING VARCHAR(MAX)
, @BOOKTYPE CHAR(2)
, @@SESSIONID VARCHAR(500)
, @BANK_NAME VARCHAR(100)
, @CLIENT_NAME VARCHAR(100)
, @BNK_NAME VARCHAR(100)
, @BNKBR_NAME VARCHAR(50)
, @ACCNO VARCHAR(20)
, @VTYPE INT
SET @@SESSIONID = (SELECT
		NEWID())

SELECT
	@BANKCODE =.DBO.CLS_PIECE(ITEMS, '^', 1)
	,@CLTCODE =.DBO.CLS_PIECE(ITEMS, '^', 2)
	,@VDT =.DBO.CLS_PIECE(ITEMS, '^', 3)
	,@NARRATION =.DBO.CLS_PIECE(ITEMS, '^', 4)
	,@ACCNO =.DBO.CLS_PIECE(ITEMS, '^', 5)
	,@BNK_NAME =.DBO.CLS_PIECE(ITEMS, '^', 6)
	,@BNKBR_NAME =.DBO.CLS_PIECE(ITEMS, '^', 7)
	,@VTYPE = CONVERT(INT,.DBO.CLS_PIECE(ITEMS, '^', 8))
FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '~')
WHERE ID = 1




SELECT
	@BOOKTYPE = BOOKTYPE
	,@BANK_NAME = LONGNAME
FROM ACMAST
WHERE CLTCODE = @BANKCODE
SELECT
	@CLIENT_NAME = LONGNAME
FROM ACMAST
WHERE CLTCODE = @CLTCODE
IF (@ACCNO = '' AND @VTYPE <> '5') BEGIN
SELECT
	@BNK_NAME = BANK_NAME
	,@ACCNO = ACCNO
	,@BNKBR_NAME = BRANCH_NAME
FROM	MSAJAG..POBANK P
		,MULTIBANKID M
		,ACMAST A
WHERE P.BANKID = M.BANKID
AND A.CLTCODE = M.CLTCODE
AND DEFAULTBANK = 1
AND A.CLTCODE = @CLTCODE
END
IF @VTYPE = '5' SET @BNK_NAME = @CLIENT_NAME


SET @DATA_STRING = (SELECT
		.DBO.CLS_PIECE(@PARAM_VAL1, '~', 2))

SELECT
	ID
	,VDT = @VDT
	,VTYPE =
			CASE
				WHEN @VTYPE = '5' THEN '5'
				ELSE (CASE
						WHEN DRCR = 'C' THEN '2'
						ELSE '3'
					END)
			END
	,BOOKTYPE = @BOOKTYPE
	,REFNO =.DBO.CLS_PIECE(ITEMS, '^', 1)
	,AMOUNT = B.AMOUNT
	,DRCR = B.DRCR
	,VALUEDATE
	,DDNO = REFERENCENO INTO #TEMPDATA
FROM.DBO.CLS_SPLIT(@DATA_STRING, '|') A
	,BANKRECO B
WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) = B.CROSSREFERENCENO




/************VNO GENERATION PART***************/
--EXEC CLS_GENMULTI_VNO @@SESSIONID	
--SELECT  * FROM CLS_TBL_VNOGENDATA WHERE SESSIONID = @@SESSIONID
/************VNO GENERATION PART***************/
DECLARE @VOUCHERNO VARCHAR(12)
SELECT
	@VOUCHERNO = CONVERT(VARCHAR, GETDATE(), 12) + RIGHT(REPLACE(CONVERT(VARCHAR, GETDATE(), 114), ':', ''), 6)


INSERT INTO CLS_OFFLINE_LEDGER_ENTRIES (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME
, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT, ADDBY, STATUSID
, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME
, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, RESERVED1, RESERVED2, RESERVED3, RESERVED4, RESERVED5
, RESERVED6, RESERVED7, RESERVED8, RESERVED9, RESERVED10)
	SELECT
		VOUCHERTYPE = T.VTYPE
		,BOOKTYPE = T.BOOKTYPE
		,SNO = ID
		,VDATE = CONVERT(DATETIME, T.VDT, 103)
		,EDATE = CONVERT(DATETIME, T.VDT, 103)
		,CLTCODE = @CLTCODE
		,CREDITAMT =
					CASE
						WHEN T.DRCR = 'C' THEN T.AMOUNT
						ELSE 0
					END
		,DEBITAMT =
					CASE
						WHEN T.DRCR = 'D' THEN T.AMOUNT
						ELSE 0
					END
		,NARRATION = @NARRATION
		,OPPCODE =
					CASE
						WHEN VTYPE = '5' THEN @CLTCODE
						ELSE @BANKCODE
					END
		,MARGINCODE = ''
		,BANKNAME = @BNK_NAME --CASE WHEN T.VTYPE = '2' THEN @BNK_NAME ELSE '' END
		,BRANCHNAME =
						CASE
							WHEN T.VTYPE = '2' THEN @BNKBR_NAME
							ELSE ''
						END/*DOUBT*/
		,BRANCHCODE = '' /*DOUBT*/
		,DDNO = DDNO
		,CHEQUEMODE = '' /*DOUBT*/
		,CHEQUEDATE = '' /*DOUBT*/
		,CHEQUENAME = '' /*DOUBT*/
		,CLEAR_MODE = 'L'
		,TPACCOUNTNUMBER = ''-- @ACCNO/*DOUBT*/
		,EXCHANGE = ''
		,SEGMENT = ''
		,TPFLAG = ''
		,ADDDT = GETDATE()
		,ADDBY = @USERID
		,STATUSID = @STATUSID
		,STATUSNAME = @STATUSNAME
		,ROWSTATE = '0'
		,APPROVALFLAG = '1'
		,APPROVALDATE = ''
		,APPROVEDBY = ''
		,VOUCHERNO = @VOUCHERNO  /* SET NO*/
		,UPLOADDT = ''
		,LEDGERVNO = ''
		,CLIENTNAME = @CLIENT_NAME
		,OPPCODENAME = @BANK_NAME
		,MARGINCODENAME = ''
		,SETT_NO = ''
		,SETT_TYPE = ''
		,PRODUCTTYPE = ''
		,REVAMT = ''
		,REVCODE = ''
		,MICR = ''
		,REL_DATE = CONVERT(DATETIME, T.VALUEDATE, 103)
		,DISPLAY_FLAG = ''
		,RESERVED1 = ''
		,RESERVED2 =
					CASE
						WHEN VTYPE = '5' THEN '1'
						ELSE ''
					END
		,RESERVED3 = @@SESSIONID /*PROG ID*/
		,RESERVED4 = T.REFNO
		,RESERVED5 = ''
		,RESERVED6 = ''
		,RESERVED7 = ''
		,RESERVED8 = ''
		,RESERVED9 = ''
		,RESERVED10 = ''
	FROM #TEMPDATA T


INSERT INTO CLS_OFFLINE_LEDGER_ENTRIES (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME
, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT, ADDBY, STATUSID
, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME
, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, RESERVED1, RESERVED2, RESERVED3, RESERVED4, RESERVED5
, RESERVED6, RESERVED7, RESERVED8, RESERVED9, RESERVED10)
	SELECT
		VOUCHERTYPE = T.VTYPE
		,BOOKTYPE = T.BOOKTYPE
		,SNO = ID
		,VDATE = CONVERT(DATETIME, T.VDT, 103)
		,EDATE = CONVERT(DATETIME, T.VDT, 103)
		,CLTCODE = B.CLTCODE
		,CREDITAMT =
					CASE
						WHEN T.DRCR = 'D' THEN T.AMOUNT
						ELSE 0
					END
		,DEBITAMT =
					CASE
						WHEN T.DRCR = 'C' THEN T.AMOUNT
						ELSE 0
					END
		,NARRATION = @NARRATION
		,OPPCODE =
					CASE
						WHEN VTYPE = '5' THEN B.CLTCODE
						ELSE @BANKCODE
					END
		,MARGINCODE = ''
		,BANKNAME = @BANK_NAME
		,BRANCHNAME =
						CASE
							WHEN T.VTYPE = '2' THEN @BNKBR_NAME
							ELSE ''
						END/*DOUBT*/
		,BRANCHCODE = '' /*DOUBT*/
		,DDNO = B.REFERENCENO
		,CHEQUEMODE = '' /*DOUBT*/
		,CHEQUEDATE = '' /*DOUBT*/
		,CHEQUENAME = '' /*DOUBT*/
		,CLEAR_MODE = 'L'
		,TPACCOUNTNUMBER = ''-- @ACCNO/*DOUBT*/
		,EXCHANGE = ''
		,SEGMENT = ''
		,TPFLAG = ''
		,ADDDT = GETDATE()
		,ADDBY = @USERID
		,STATUSID = @STATUSID
		,STATUSNAME = @STATUSNAME
		,ROWSTATE = '0'
		,APPROVALFLAG = '1'
		,APPROVALDATE = ''
		,APPROVEDBY = ''
		,VOUCHERNO = @VOUCHERNO  /* SET NO*/
		,UPLOADDT = ''
		,LEDGERVNO = ''
		,CLIENTNAME = @CLIENT_NAME
		,OPPCODENAME = @BANK_NAME
		,MARGINCODENAME = ''
		,SETT_NO = ''
		,SETT_TYPE = ''
		,PRODUCTTYPE = ''
		,REVAMT = ''
		,REVCODE = ''
		,MICR = ''
		,REL_DATE = CONVERT(DATETIME, T.VALUEDATE, 103)
		,DISPLAY_FLAG = ''
		,RESERVED1 = ''
		,RESERVED2 = '2'
		,RESERVED3 = @@SESSIONID /*PROG ID*/
		,RESERVED4 = T.REFNO
		,RESERVED5 = ''
		,RESERVED6 = ''
		,RESERVED7 = ''
		,RESERVED8 = ''
		,RESERVED9 = ''
		,RESERVED10 = ''
	FROM	#TEMPDATA T
			,BANKRECO B
	WHERE T.VTYPE = 5
	AND T.REFNO = B.CROSSREFERENCENO


---SELECT * FROM CLS_OFFLINE_LEDGER_ENTRIES WHERE RESERVED3 = @@SESSIONID 
EXEC CLS_COMMON_LEDGERPOSTING @@SESSIONID
--SELECT LEDGERVNO1=LEDGERVNO,* FROM CLS_OFFLINE_LEDGER_ENTRIES WHERE RESERVED3 = @@SESSIONID ORDER BY LEDGERVNO,RESERVED2
--SELECT * FROM CLS_OFFLINE_LEDGER_ENTRIES WHERE RESERVED3 = @@SESSIONID 
--SELECT * FROM LEDGER1 L, CLS_OFFLINE_LEDGER_ENTRIES  C WHERE L.REFNO = C.RESERVED4 AND RESERVED3 = @@SESSIONID 



UPDATE B
SET [STATUS] = 'MATCHED'
FROM BANKRECO B, #TEMPDATA T
WHERE B.CROSSREFERENCENO = T.REFNO
DROP TABLE #TEMPDATA
DROP TABLE #REFNO
END
	DROP TABLE #TEMP_DATA
	DROP TABLE #REFNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_LEDGER_FORMULA_BALANCES
-- --------------------------------------------------


--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  

/*
SELECT * FROM FORMULA_CLIENT_MASTER WHERE CLTCODE = '0A147'

INSERT INTO FORMULA_CLIENT_MASTER
SELECT PARTY_CODE, LONG_NAME, '', '', '9999999999', GETDATE() FROM MSAJAG.DBO.CLIENT_DETAILS
EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2009','9999999999', 'PAR_SUMVDT', 'VDTBAL_OPBAL + VDTBAL, T_DAY_BILL, FDT_RECEIPT'  
*/
CREATE PROCEDURE [dbo].[CLS_GET_LEDGER_FORMULA_BALANCES]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10) = '',
 @SEGMENT VARCHAR(50) = ''

AS

 SELECT @REPORT_FORMULA = FORMULANAME FROM FORMULA_MASTER WHERE PROCESSCODE = @PROCESS_CODE    
    

IF @EXCHANGE = ''
BEGIN
	SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER
END

DECLARE    
 @START_DATE VARCHAR(11)    

IF LEN(@EFFDATE) = 10    
BEGIN    
	SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    

SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    

 

CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL_OPBAL MONEY,  
 EDTBAL_OPBAL MONEY,    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 VDTBAL_RECEIPT MONEY,     
 T_DAY_BILL MONEY,     
 VDTBAL_BILL_DR MONEY,     
 VDTBAL_BILL_CR MONEY,    
 VDTBAL_NONBILL MONEY,     
 EDTBAL_RECEIPT MONEY,    
 EDTBAL_BILL_DR MONEY,    
 EDTBAL_BILL_CR MONEY,    
 EDTBAL_NONBILL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_CR MONEY,     
 FDT_DR MONEY,
 MARGIN_BAL MONEY  
)  

DECLARE  
 @@SQL VARCHAR(MAX)  

INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = SUM(VDTBAL_OPBAL),    
 EDTBAL_OPBAL = SUM(EDTBAL_OPBAL),    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT),     
 T_DAY_BILL = SUM(T_DAY_BILL),     
 VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR),     
 VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR),    
 VDTBAL_NONBILL = SUM(VDTBAL_NONBILL),     
 EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT),    
 EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR),    
 EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR),    
 EDTBAL_NONBILL = SUM(EDTBAL_NONBILL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_CR = SUM(FDT_CR),     
 FDT_DR = SUM(FDT_DR),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = CASE WHEN VDT >= @START_DATE AND VDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL_OPBAL = CASE WHEN EDT >= @START_DATE AND EDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL_RECEIPT = CASE WHEN VDT >= @START_DATE AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,     
 T_DAY_BILL = CASE WHEN VDT LIKE @EFFDATE + '%' AND VTYP = 15 THEN SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 VDTBAL_BILL_DR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END,     
 VDTBAL_BILL_CR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END ,    
 VDTBAL_NONBILL = CASE WHEN VDT >= @START_DATE AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 EDTBAL_RECEIPT = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 2 THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_DR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_CR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_NONBILL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_CR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'C' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END,     
 FDT_DR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'D' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END
FROM     
 LEDGER L,  
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 AND (VDT >= @START_DATE OR EDT >= @START_DATE)    
 AND VDT <= @EFFDATE + ' 23:59'    
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  VDT, EDT, VTYP, DRCR    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  

  

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_LEDGER2_FORMULA_BALANCES
-- --------------------------------------------------

--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  

/*
SELECT * FROM FORMULA_CLIENT_MASTER WHERE CLTCODE = '0A147'

INSERT INTO FORMULA_CLIENT_MASTER
SELECT PARTY_CODE, LONG_NAME, '', '', '9999999999', GETDATE() FROM MSAJAG.DBO.CLIENT_DETAILS
EXEC CLS_GET_LEDGER2_FORMULA_BALANCES 'MAR 31 2014', '', 'VDTBAL', 'NSE', 'CAPITAL'  
*/
CREATE PROCEDURE [dbo].[CLS_GET_LEDGER2_FORMULA_BALANCES]
 @EFFDATE VARCHAR(11),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10) = '',
 @SEGMENT VARCHAR(50) = '',
 @REPORT_COLUMN  VARCHAR(1000) = '',
 @REPORT_GROUPING VARCHAR(1000) = ''

AS

 SELECT @REPORT_FORMULA = FORMULANAME FROM FORMULA_MASTER WHERE PROCESSCODE = @PROCESS_CODE    
    

IF @EXCHANGE = ''
BEGIN
	SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER
END

DECLARE    
 @START_DATE VARCHAR(11)    

IF LEN(@EFFDATE) = 10    
BEGIN    
	SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    

SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    

 

CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 /*PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),   */ 
 VDTBAL_OPBAL MONEY,  
 EDTBAL_OPBAL MONEY,    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 VDTBAL_RECEIPT MONEY,     
 T_DAY_BILL MONEY,     
 VDTBAL_BILL_DR MONEY,     
 VDTBAL_BILL_CR MONEY,    
 VDTBAL_NONBILL MONEY,     
 EDTBAL_RECEIPT MONEY,    
 EDTBAL_BILL_DR MONEY,    
 EDTBAL_BILL_CR MONEY,    
 EDTBAL_NONBILL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_CR MONEY,     
 FDT_DR MONEY,
 MARGIN_BAL MONEY  
)  

DECLARE  
 @@SQL VARCHAR(MAX)  

INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 VDTBAL_OPBAL = SUM(VDTBAL_OPBAL),    
 EDTBAL_OPBAL = SUM(EDTBAL_OPBAL),    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT),     
 T_DAY_BILL = SUM(T_DAY_BILL),     
 VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR),     
 VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR),    
 VDTBAL_NONBILL = SUM(VDTBAL_NONBILL),     
 EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT),    
 EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR),    
 EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR),    
 EDTBAL_NONBILL = SUM(EDTBAL_NONBILL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_CR = SUM(FDT_CR),     
 FDT_DR = SUM(FDT_DR),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 VDTBAL_OPBAL = CASE WHEN VDT >= @START_DATE AND VDT < @EFFDATE THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 EDTBAL_OPBAL = CASE WHEN EDT >= @START_DATE AND EDT < @EFFDATE THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 VDTBAL_RECEIPT = CASE WHEN VDT >= @START_DATE AND VTYPE = 2 THEN SUM(CAMT) ELSE 0 END,     
 T_DAY_BILL = CASE WHEN VDT LIKE @EFFDATE + '%' AND VTYPE = 15 THEN SUM(CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,     
 VDTBAL_BILL_DR = CASE WHEN VDT >= @START_DATE AND VTYPE = 15 AND L2.DRCR = 'D' THEN SUM(CAMT) ELSE 0 END,     
 VDTBAL_BILL_CR = CASE WHEN VDT >= @START_DATE AND VTYPE = 15 AND L2.DRCR = 'C' THEN SUM(CAMT) ELSE 0 END ,    
 VDTBAL_NONBILL = CASE WHEN VDT >= @START_DATE AND VTYPE NOT IN (15, 2) THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,  
 EDTBAL_RECEIPT = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE = 2 THEN SUM(CAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYPE = 2 THEN SUM(-CAMT) ELSE 0 END,    
 EDTBAL_BILL_DR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE = 15 AND L2.DRCR = 'D' THEN SUM(CAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYPE = 15 AND L2.DRCR = 'D' THEN SUM(-CAMT) ELSE 0 END,    
 EDTBAL_BILL_CR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE = 15 AND L2.DRCR = 'C' THEN SUM(CAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYPE = 15 AND L2.DRCR = 'C' THEN SUM(-CAMT) ELSE 0 END,    
 EDTBAL_NONBILL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE NOT IN (15, 2) THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND VTYPE = 2 THEN SUM(CAMT) ELSE 0 END,    
 FDT_CR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND L2.DRCR = 'C' AND VTYPE <> 2 THEN SUM(CAMT) ELSE 0 END,     
 FDT_DR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND L2.DRCR = 'D' AND VTYPE <> 2 THEN SUM(CAMT) ELSE 0 END
FROM     
 LEDGER L,
 LEDGER2 L2,  
 #FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L2.CLTCODE --AND SESSION_ID = @SESSIONID
 AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
 AND (VDT >= @START_DATE OR EDT >= @START_DATE)    
 AND VDT <= @EFFDATE + ' 23:59'
 GROUP BY     
 L.CLTCODE, VDT, EDT, VTYPE, L2.DRCR    
) A    
GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/
	SET @@SQL = " SELECT "  
	IF @REPORT_COLUMN <> ''
		SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
	SET @@SQL = @@SQL + @REPORT_FORMULA  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
	IF @REPORT_GROUPING <> ''
		SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING
--END

  
--PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GLLEDGER
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLS_GLLEDGER]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@FROM_GL_CODE VARCHAR(10),
	@TO_GL_CODE VARCHAR(10),
	@VIEWOPTION VARCHAR(10),
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)


CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE ,COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE ,COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE ,COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END

CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL,VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = ' -AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL, EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = '-AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
SET @@SQL = @@SQL + "WHERE CLTCODE >= '" + @FROM_GL_CODE + "' AND CLTCODE <= '" + @TO_GL_CODE + "'"
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + " AND ACCAT = 3 "
ELSE IF UPPER(@VIEWOPTION) = 'BANK'
	SET @@SQL = @@SQL + " AND ACCAT = 2 "	
ELSE IF UPPER(@VIEWOPTION) = 'CASH'
	SET @@SQL = @@SQL + " AND ACCAT = 1 "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "

EXEC(@@SQL)	

IF UPPER(@STATUSID) = 'BROKER'
BEGIN

	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
END
ELSE
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
END

DROP TABLE #FORMULA_CLIENT_MASTER

SET @@SQL = "INSERT INTO ACCOUNT.." + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_BANK_FILEUPLOAD_LOGS] (
  @UPLOADID         NVARCHAR(50)
, @SEGMENT        NVARCHAR(50)
, @BANKCODE       NVARCHAR(50)
, @BANKNAME       NVARCHAR(50)
, @FILETYPE       NVARCHAR(50)
, @BANKACCOUNT    NVARCHAR(100)
, @UPLOADFILENAME NVARCHAR(150)
, @UPLOADEDDATE   NVARCHAR(50)
, @MODIFIEDDATE   NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1) = 'N'
, @FILE_PATH VARCHAR(500) = ''
, @UNAME VARCHAR(50)=''
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
)
AS
BEGIN
		DECLARE @@SQL           VARCHAR(MAX),
				@@ACCOUNTDB     VARCHAR(20),
				@@ACCOUNTSERVER VARCHAR(20),
				@COMBINEFILE NVARCHAR(2)
				
	SELECT @UPLOADEDDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),101))--CONVERT(DATETIME, @UPLOADEDDATE, 103)
	SELECT @MODIFIEDDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),101))--CONVERT(DATETIME, @MODIFIEDDATE, 103)
	--SELECT @UPLOADEDDATE,@MODIFIEDDATE,'P' RETURN
	
	IF(@BANKCODE='')
	SET @BANKCODE='0'
	IF(@BANKACCOUNT='')
	SET @BANKACCOUNT='0'
	
	IF(ISNULL(@BANKCODE,'0')='0' AND ISNULL(@BANKACCOUNT,'0')='0' AND @REPROCESS_FLAG='N' )
	SET @COMBINEFILE='0'
	ELSE
	SET @COMBINEFILE='1'
		
	SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
	AND PRIMARYSERVER = 1

IF (@BANKNAME = 'YES BANK' AND @FILETYPE = 'NON-CMS') AND @SEGMENT <> 'NSE-CAPITAL' 
BEGIN
SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY) "
SET @@SQL = @@SQL + " SELECT  PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY FROM MSAJAG.DBO.FILEDATA WHERE PROGID = '" + @UPLOADID + "'"

EXEC (@@SQL)

SET @@SQL = " EXEC " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS "
SET @@SQL = @@SQL + "'" + @UPLOADID + "'"
SET @@SQL = @@SQL + ",'" + @SEGMENT + "'"
SET @@SQL = @@SQL + ",'" + @BANKCODE + "'"
SET @@SQL = @@SQL + ",'" + @BANKNAME + "'"
SET @@SQL = @@SQL + ",'" + @FILETYPE + "'"
SET @@SQL = @@SQL + ",'" + @BANKACCOUNT + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADFILENAME + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADEDDATE + "'"
SET @@SQL = @@SQL + ",'" + @MODIFIEDDATE + "'"
SET @@SQL = @@SQL + ",'" + @UPLOAD_FLAG + "'"
SET @@SQL = @@SQL + ",'" + @FILE_PATH + "'"
SET @@SQL = @@SQL + ",'" + @UNAME + "'"
SET @@SQL = @@SQL + ",'" + @REPROCESS_FLAG + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADDATE + "'"

EXEC (@@SQL)

RETURN
END


DECLARE @PROCESS NVARCHAR(1)
SET @PROCESS = 'N'

CREATE TABLE #TEMP(FILE_DATA VARCHAR(MAX))

IF NOT EXISTS(SELECT * FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE  FILETYPE=@FILETYPE
AND BANKNAME=@BANKNAME AND UPLOADFILENAME=@UPLOADFILENAME)
BEGIN
	INSERT INTO RECON_BANK_UPLOAD_PROCESS_INFO (UPLOADID, SEGMENT, BANKCODE
	, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
	, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
	VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', 
	@UNAME, GETDATE(), GETDATE(), GETDATE())

IF (@REPROCESS_FLAG <> 'R') 
BEGIN
--SELECT 'SS',@COMBINEFILE RETURN
IF(@COMBINEFILE<>'0') 
BEGIN
	IF (CHARINDEX(@BANKACCOUNT, @UPLOADFILENAME) = 1)
	BEGIN
	
	IF( @UPLOAD_FLAG <> 'B' )
			BEGIN
			
				--IF ((@BANKNAME = 'HDFC BANK') OR (@BANKNAME = 'YES BANK' AND @FILETYPE = 'NON-CMS')OR (@BANKNAME = 'KOTAK BANK') ) 
				IF(@COMBINEFILE<>'0')
				BEGIN	
									
								SET @PROCESS = 'Y'
								INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
								, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
								, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
								 VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
							
				END 
				ELSE 
				--IF ((@BANKNAME = 'YES BANK' AND @FILETYPE = 'CMS') OR @BANKNAME = 'STANDARD CHARTERED BANK') 
				IF(@COMBINEFILE='0')
					BEGIN
					
						SET @PROCESS = 'Y'
						INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
						VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
					END
				END
		ELSE
			BEGIN
				
				IF(@SEGMENT='NSE-CAPITAL')
				BEGIN
				DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
				END

				DECLARE @CMD VARCHAR(MAX),@FILENAME NVARCHAR(MAX)
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				--PRINT @@SQL

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " +
				+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID, SEGMENT, BANKCODE
				, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
				, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
				VALUES('" + @UPLOADID + "',"
				+ "'" + @SEGMENT + "',"
				+ "'" + @BANKCODE + "',"
				+ "'" + @BANKNAME + "',"
				+ "'" + @FILETYPE + "',"
				+ "'" + @BANKACCOUNT + "',"
				+ "'" + @UPLOADFILENAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "'SUCCESS'" + ","
				+ "'" + @UNAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103))"

				EXEC (@@SQL)
				PRINT @@SQL
				SET @UPLOAD_FLAG='N'

				SET @@SQL = ''
				SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
				+ ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS '" + @UPLOADID + "','" + @SEGMENT + "','" + @BANKCODE + "','" + @BANKNAME + "','"
				+ @FILETYPE + "','" + @BANKACCOUNT + "','" 
				+ @UPLOADFILENAME + "','" 
				+ @UploadedDate + "','" 
				+ @MODIFIEDDATE + "','" 
				+@UPLOAD_FLAG + "','" 
				+@FILE_PATH + "','" +@UNAME + "','" + @REPROCESS_FLAG + "','" + @UPLOADDATE + "'"
				
				EXEC (@@SQL)
				PRINT @@SQL	
				SET @PROCESS = 'Y'
				RETURN
			END
		END 
		ELSE
 
		BEGIN
			--DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
			SELECT		'YOU HAVE SELECTED WRONG SEGMENT FILE'
			DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
			RETURN
		END
	END
	ELSE
	
		IF (@COMBINEFILE=0) 
		BEGIN
		
		SET @PROCESS = 'Y'
		INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
		VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
		

		IF ((@PROCESS = 'Y' OR @REPROCESS_FLAG = 'N' ) AND @UPLOAD_FLAG = 'B' )	
		BEGIN
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				PRINT @@SQL

				EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE,@UPLOADFILENAME
		END
	END
END

IF (@PROCESS = 'Y'  AND @UPLOAD_FLAG <> 'B' )
BEGIN

EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE,@UPLOADFILENAME
END
END

ELSE
	BEGIN 
	SELECT 'FILE YOU TRY TO UPLOAD IS ALREADY IN PROCESS PLEASE WAIT ...' 
	--DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
	END
IF( @REPROCESS_FLAG = 'R' )
BEGIN

--SELECT @PROCESS,@UPLOAD_FLAG,@REPROCESS_FLAG RETURN
DECLARE @TEMPREPROCESS TABLE(Report_Name NVARCHAR(500))
DECLARE @TEMPBANKMASTER TABLE(
SEGMENT NVARCHAR(50),
BANKNAME NVARCHAR(50),
BANKCODE NVARCHAR(50),
BANKACCOUNT NVARCHAR(50),
FILETYPE NVARCHAR(50))

INSERT INTO @TEMPBANKMASTER (SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE)
SELECT SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE FROM RECON_BANK_MASTER(NOLOCK) 
WHERE BANKNAME=@BANKNAME AND FILETYPE<>'ENCRYPTION'

DECLARE @MBANKACCOUNT NVARCHAR(50)

--SELECT * FROM @TEMPBANKMASTER
	WHILE (SELECT COUNT(*)	FROM @TEMPBANKMASTER)> 0 
	BEGIN

		SET @SEGMENT = ''
		SET @BANKNAME=''		
		SET @BANKCODE = ''
		SET @MBANKACCOUNT = ''
		SET @FILETYPE=''
		SET @@ACCOUNTDB = ''
		SET @@ACCOUNTSERVER = ''

		SELECT TOP 1 @SEGMENT=SEGMENT,@BANKNAME=BANKNAME,@BANKCODE=BANKCODE,@MBANKACCOUNT=BANKACCOUNT,@FILETYPE=FILETYPE FROM @TEMPBANKMASTER


		SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY
		WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT	AND PRIMARYSERVER = 1

		--EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@SEGMENT
		
			SET @@SQL = ''
			SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
			+ ".DBO.CLS_RECON_INSERT_PROCESS '"	+ @UPLOADID + "','" + @FILETYPE + "','" + @BANKNAME + "','" + @UPLOAD_FLAG + "','"+ @REPROCESS_FLAG + "','" 
			+ @UPLOADDATE + "','" + @BANKCODE + "','"+ @BANKACCOUNT + "','" + @SEGMENT 	+ "','" + @UNAME 	+ "','" + @FILE_PATH	+ "','" + @COMBINEFILE	+ "','" 
			+ @UPLOADFILENAME + "'"
			INSERT INTO @TEMPREPROCESS (Report_Name)
			EXEC (@@SQL)
			PRINT @@SQL
			
			DECLARE @@ERRORVALUE NVARCHAR(MAX),@SPNAME NVARCHAR(50)
			
			SET @@SQL=''
			SET @@ERRORVALUE=''
			SET @@ERRORVALUE=@@SQL
			
			/*SET @SPNAME='CLS_RECON_INSERT_PROCESS'
			SET @@SQL = ''
			SET @@SQL = "INSERT INTO " +
			+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_LOGS(SERVERNAME,DATABASENAME,USERNAME,LOGDATE,ERRORLOGS,SOURCENAME)
			VALUES('" + @@ACCOUNTSERVER + "',"
			+ "'" + @@ACCOUNTDB + "',"
			+ "'" + @UNAME + "',"
			+ "'" + @UPLOADDATE + "',"
			+ "'" + @@ERRORVALUE + "',"
			+ "'" + @SPNAME + "')"
			SET @SPNAME=''
			
			--EXEC (@@SQL)			
			PRINT @@SQL*/
			
			--SELECT @SEGMENT,@BANKNAME,@BANKCODE,@MBANKACCOUNT,@FILETYPE
			
			DELETE FROM @TEMPBANKMASTER WHERE
			SEGMENT=ISNULL(@SEGMENT,'')	
			AND BANKNAME=ISNULL(@BANKNAME,'')								
			AND BANKCODE=ISNULL(@BANKCODE,'')			
			AND BANKACCOUNT=ISNULL(@MBANKACCOUNT,'')
			AND FILETYPE=ISNULL(@FILETYPE,'')
	END
	--SELECT TOP 1 * FROM @TEMPREPROCESS
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BANK_FILEUPLOAD_LOGS_bak_30042018
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_BANK_FILEUPLOAD_LOGS_bak_30042018] (
  @UPLOADID         NVARCHAR(50)
, @SEGMENT        NVARCHAR(50)
, @BANKCODE       NVARCHAR(50)
, @BANKNAME       NVARCHAR(50)
, @FILETYPE       NVARCHAR(50)
, @BANKACCOUNT    NVARCHAR(100)
, @UPLOADFILENAME NVARCHAR(150)
, @UPLOADEDDATE   NVARCHAR(50)
, @MODIFIEDDATE   NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1) = 'N'
, @FILE_PATH VARCHAR(500) = ''
, @UNAME VARCHAR(50)=''
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
)
AS
BEGIN
		DECLARE @@SQL           VARCHAR(MAX),
				@@ACCOUNTDB     VARCHAR(20),
				@@ACCOUNTSERVER VARCHAR(20),
				@COMBINEFILE NVARCHAR(2)
	
	
	IF(ISNULL(@BANKCODE,'0')='0' AND ISNULL(@BANKACCOUNT,'0')='0' AND @REPROCESS_FLAG='N' )
	SET @COMBINEFILE='0'
	ELSE
	SET @COMBINEFILE='1'

	
SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1


SET @UPLOADEDDATE = CONVERT(DATETIME, @UPLOADEDDATE, 120)
SET @MODIFIEDDATE = CONVERT(DATETIME, @MODIFIEDDATE, 120)
DECLARE @PROCESS NVARCHAR(1)
SET @PROCESS = 'N'

CREATE TABLE #TEMP(FILE_DATA VARCHAR(MAX))

IF NOT EXISTS(SELECT * FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE  FILETYPE=@FILETYPE
AND BANKNAME=@BANKNAME AND UPLOADFILENAME=@UPLOADFILENAME)
BEGIN
	INSERT INTO RECON_BANK_UPLOAD_PROCESS_INFO (UPLOADID, SEGMENT, BANKCODE
	, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
	, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
	VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', 
	@UNAME, GETDATE(), GETDATE(), GETDATE())
IF (@REPROCESS_FLAG <> 'R') 
BEGIN
--SELECT 'SS',@COMBINEFILE RETURN
IF(@COMBINEFILE<>'0') 
BEGIN

	IF (CHARINDEX(@BANKACCOUNT, @UPLOADFILENAME) = 1)
	BEGIN
	
	IF( @UPLOAD_FLAG <> 'B' )
			BEGIN
			
				--IF ((@BANKNAME = 'HDFC BANK') OR (@BANKNAME = 'YES BANK' AND @FILETYPE = 'NON-CMS')OR (@BANKNAME = 'KOTAK BANK') ) 
				IF(@COMBINEFILE<>'0')
				BEGIN	
									
								SET @PROCESS = 'Y'
								INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
								, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
								, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
								 VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
							
				END 
				ELSE 
				--IF ((@BANKNAME = 'YES BANK' AND @FILETYPE = 'CMS') OR @BANKNAME = 'STANDARD CHARTERED BANK') 
				IF(@COMBINEFILE='0') 
					BEGIN
						SET @PROCESS = 'Y'
						INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
						VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
					END
				END
		ELSE
			BEGIN
				
				IF(@SEGMENT='NSE-CAPITAL')
				BEGIN
				DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
				END

				DECLARE @CMD VARCHAR(MAX),@FILENAME NVARCHAR(MAX)
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				----PRINT @@SQL

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " +
				+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID, SEGMENT, BANKCODE
				, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
				, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
				VALUES('" + @UPLOADID + "',"
				+ "'" + @SEGMENT + "',"
				+ "'" + @BANKCODE + "',"
				+ "'" + @BANKNAME + "',"
				+ "'" + @FILETYPE + "',"
				+ "'" + @BANKACCOUNT + "',"
				+ "'" + @UPLOADFILENAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "'SUCCESS'" + ","
				+ "'" + @UNAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103))"

				
				SET @@SQL = ''
				SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
				+ ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS '" + @UPLOADID + "','" + @SEGMENT + "','" + @BANKCODE + "','" + @BANKNAME + "','"
				+ @FILETYPE + "','" + @BANKACCOUNT + "','" 
				+ @UPLOADFILENAME + "','" 
				+ @UploadedDate + "','" 
				+ @MODIFIEDDATE + "','" 
				+@UPLOAD_FLAG + "','" 
				+@FILE_PATH + "','" +@UNAME + "','" + @REPROCESS_FLAG + "','" + @UPLOADDATE + "'"
				
				EXEC (@@SQL)
				PRINT @@SQL	
				SET @PROCESS = 'Y'
				RETURN
			END
		END 
		ELSE
 
		BEGIN
			DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
			SELECT		'YOU HAVE SELECTED WRONG SEGMENT FILE'
			DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
			RETURN
		END
	END
	ELSE
	
		IF (@COMBINEFILE=0) 
		BEGIN
		
		SET @PROCESS = 'Y'
		INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
		VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
		

		IF ((@PROCESS = 'Y' OR @REPROCESS_FLAG = 'N' ) AND @UPLOAD_FLAG = 'B' )	
		BEGIN
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				--PRINT @@SQL

				EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE
		END
	END
END

IF (@PROCESS = 'Y'  AND @UPLOAD_FLAG <> 'B' )
BEGIN

EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE
END
END

ELSE
	BEGIN 
	SELECT 'FILE YOU TRY TO UPLOAD IS ALREADY IN PROCESS PLEASE WAIT ...' 
	--DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
END
IF( @REPROCESS_FLAG = 'R' )
BEGIN

--SELECT @PROCESS,@UPLOAD_FLAG,@REPROCESS_FLAG RETURN

DECLARE @TEMPBANKMASTER TABLE(
SEGMENT NVARCHAR(50),
BANKNAME NVARCHAR(50),
BANKCODE NVARCHAR(50),
BANKACCOUNT NVARCHAR(50),
FILETYPE NVARCHAR(50))

INSERT INTO @TEMPBANKMASTER (SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE)
SELECT SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE FROM RECON_BANK_MASTER(NOLOCK) 
WHERE BANKNAME=@BANKNAME AND FILETYPE<>'ENCRYPTION'

DECLARE @MBANKACCOUNT NVARCHAR(50)

--SELECT * FROM @TEMPBANKMASTER
	WHILE (SELECT COUNT(*)	FROM @TEMPBANKMASTER)> 0 
	BEGIN

		SET @SEGMENT = ''
		SET @BANKNAME=''		
		SET @BANKCODE = ''
		SET @MBANKACCOUNT = ''
		SET @FILETYPE=''
		SET @@ACCOUNTDB = ''
		SET @@ACCOUNTSERVER = ''

		SELECT TOP 1 @SEGMENT=SEGMENT,@BANKNAME=BANKNAME,@BANKCODE=BANKCODE,@MBANKACCOUNT=BANKACCOUNT,@FILETYPE=FILETYPE FROM @TEMPBANKMASTER


		SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY
		WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT	AND PRIMARYSERVER = 1

		--EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@SEGMENT
		
			SET @@SQL = ''
			SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
			+ ".DBO.CLS_RECON_INSERT_PROCESS '"	+ @UPLOADID + "','" + @FILETYPE + "','" + @BANKNAME + "','" + @UPLOAD_FLAG + "','"+ @REPROCESS_FLAG + "','" 
			+ @UPLOADDATE + "','" + @BANKCODE + "','"+ @BANKACCOUNT + "','" + @SEGMENT 	+ "','" + @UNAME 	+ "','" + @FILE_PATH	+ "','" + @COMBINEFILE + "'"

			EXEC (@@SQL)
			PRINT @@SQL
			
			DECLARE @@ERRORVALUE NVARCHAR(MAX),@SPNAME NVARCHAR(50)
			
			SET @@SQL=''
			SET @@ERRORVALUE=''
			SET @@ERRORVALUE=@@SQL
			
			/*SET @SPNAME='CLS_RECON_INSERT_PROCESS'
			SET @@SQL = ''
			SET @@SQL = "INSERT INTO " +
			+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_LOGS(SERVERNAME,DATABASENAME,USERNAME,LOGDATE,ERRORLOGS,SOURCENAME)
			VALUES('" + @@ACCOUNTSERVER + "',"
			+ "'" + @@ACCOUNTDB + "',"
			+ "'" + @UNAME + "',"
			+ "'" + @UPLOADDATE + "',"
			+ "'" + @@ERRORVALUE + "',"
			+ "'" + @SPNAME + "')"
			SET @SPNAME=''
			
			EXEC (@@SQL)
			--PRINT @@SQL*/
			DELETE FROM @TEMPBANKMASTER WHERE
			SEGMENT=ISNULL(@SEGMENT,'')	
			AND BANKNAME=ISNULL(@BANKNAME,'')								
			AND BANKCODE=ISNULL(@BANKCODE,'')			
			AND BANKACCOUNT=ISNULL(@MBANKACCOUNT,'')
			AND FILETYPE=ISNULL(@FILETYPE,'')
	END

END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BULKUPLOAD_ENCRYPTION_FILES
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_BULKUPLOAD_ENCRYPTION_FILES]
(
@UPLOADID NVARCHAR(50),
@SEGMENT NVARCHAR(50),
@BANKCODE NVARCHAR(50),
@BANKNAME NVARCHAR(50),
@FILETYPE NVARCHAR(50),
@BANKACCOUNT NVARCHAR(50),
@UPLOADFILENAME NVARCHAR(200),
@FILEPATH NVARCHAR(200),
@UPLOADBY NVARCHAR(50),
@UPLOAD_FLAG NVARCHAR(20)
)
AS
BEGIN
DECLARE @@ENCRYPTIONCODE NVARCHAR(50)

SELECT @@ENCRYPTIONCODE=ENCRYPTIONCODE FROM RECON_BANK_MASTER_VW WHERE SEGMENT=@SEGMENT
AND BANKCODE=@BANKCODE
AND FILETYPE=@FILETYPE
AND BANKACCOUNT=@BANKACCOUNT 

IF (CHARINDEX(@@ENCRYPTIONCODE, @UPLOADFILENAME) = 1) 
BEGIN
IF(@UPLOAD_FLAG='B')
	BEGIN
		CREATE TABLE #TEMP
		(
			FILE_DATA VARCHAR(MAX)
		)
		
		DECLARE @CMD VARCHAR(MAX),@FILENAME NVARCHAR(MAX)
		SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILEPATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
		EXEC (@CMD)

			INSERT INTO MSAJAG.DBO.FILEDATA
			SELECT	@UPLOADID,FILE_DATA,GETDATE(),@UPLOADBY FROM #TEMP

			EXEC CLS_RECON_ENCRYPTFILE_PROCESS @UPLOADID,@SEGMENT,@BANKCODE,@BANKNAME,@FILETYPE,@BANKACCOUNT,@UPLOADFILENAME
			,@FILEPATH,@UPLOADBY,@UPLOAD_FLAG

			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
			, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
			, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
			VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'Success', @UPLOADBY, GETDATE(), GETDATE(), GETDATE())

			SELECT 'UPLOAD SUCCESSFULLY'
	END

	IF(@UPLOAD_FLAG='NORMAL')
	BEGIN
	DECLARE @SEP VARCHAR(1)
	SET @SEP = ''	

			EXEC CLS_RECON_ENCRYPTFILE_PROCESS @UPLOADID,@SEGMENT,@BANKCODE,@BANKNAME,@FILETYPE,@BANKACCOUNT,@UPLOADFILENAME
			,@FILEPATH,@UPLOADBY,@UPLOAD_FLAG

			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
			, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
			, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
			VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'Success', @UPLOADBY, GETDATE(), GETDATE(), GETDATE())

			SELECT 'UPLOAD SUCCESSFULLY'
	END
 END
 ELSE
 BEGIN
 SELECT 'YOU HAVE SELECTED WORNG SEGMENT FILE'

 END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BULKUPLOD_FILES
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_BULKUPLOD_FILES]
(@UPLOADID NVARCHAR(25),
@FILENAME NVARCHAR(MAX),
@UPLOADBY NVARCHAR(100),
@SEGMENT NVARCHAR(50),
@COMBINEFILE NVARCHAR(2)
)

AS 
BEGIN

CREATE TABLE #TEMP
(
	FILE_DATA VARCHAR(MAX)
)
DECLARE @CMD VARCHAR(MAX)

SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILENAME + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
EXEC (@CMD)
PRINT (@CMD)

IF(@COMBINEFILE='0')
BEGIN
	DECLARE @@SQL    VARCHAR(MAX),
			@@ACCOUNTDB     VARCHAR(20),
			@@ACCOUNTSERVER VARCHAR(20)

	SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY
	WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
	AND PRIMARYSERVER = 1

	BEGIN TRY
		SET @@SQL = ''
		SET @@SQL = "INSERT INTO " +@@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UploadDateTime,	UploadBy)
												SELECT  '" + @UPLOADID + "'
												, FILE_DATA
												, GETDATE() 
												, '" + @UPLOADBY + "'
												FROM   #TEMP "

		EXEC (@@SQL)
		PRINT (@@SQL)
	END TRY
	BEGIN CATCH
		SELECT 'YOU HAVE NOT SELECTED COMBINE FILE CHECK BOX'
		RETURN;
	END CATCH
	
END
ELSE
BEGIN
INSERT INTO MSAJAG.DBO.FILEDATA
	SELECT
		@UPLOADID
		,FILE_DATA
		,GETDATE()
		,@UPLOADBY
	FROM #TEMP
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CHECK_TABLE
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CHECK_TABLE] (
@SQLQUERY NVARCHAR(3000) ) 
AS
BEGIN

EXEC(@SQLQUERY)

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_HDFC_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_HDFC_PROCESS] (
@UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(20) ) 
AS
BEGIN


INSERT INTO #CMS_DATA
	SELECT
		U.UPLOADID
		, @BANKCODE BANKCODE
		,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1))) ROWTYPE
		--,RTRIM(LTRIM(CONVERT(DATETIME, RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 4) + SUBSTRING(.DBO.PIECE(F.FILE_DATA, ',', 6), 3, 2) + LEFT(.DBO.PIECE(F.FILE_DATA, ',', 6), 2), 112))) VALUEDATE
		,RTRIM(LTRIM(CONVERT(DATETIME, RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 4) --year
		+ SUBSTRING(RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 6), 1, 2) + --month
		CASE WHEN LEN(.DBO.PIECE(F.FILE_DATA, ',', 6))=8 THEN LEFT(.DBO.PIECE(F.FILE_DATA, ',', 6), 2) ELSE --date
		LEFT(STUFF(.DBO.PIECE(F.FILE_DATA, ',', 6),1,0,'0'), 2) END, 112))) VALUEDATE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) DRCR
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 18))) INST_NO_CHECK
		,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, ',', 5) AS DECIMAL(20, 2)))) AS INST_AMT
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 10))) DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, ',', 26), ' ', ''))) CLTCODE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 24))) CLTACCNO
		,''
		,''
		,''
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND FILE_DATA <> ''
	AND.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1) = 'D'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_ICICI_PROCESS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLS_RECON_CMS_ICICI_PROCESS] ( @UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(50) ) 
AS
BEGIN
          

	INSERT INTO #CMS_DATA
	SELECT
	U.UPLOADID
	,@BANKCODE BANKCODE
	,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '|', 1))) ROWTYPE
	,CONVERT(DATETIME, DBO.PIECE(FILE_DATA, '|', 6), 105) AS VALUEDATE
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 4))) DRCR
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA, '|', 17))) INST_NO_CHECK
	,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, '|', 20) AS DECIMAL(20, 2)))) AS INST_AMT
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 27))) DRAWER_NAME
	,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, '|', 24), ' ', ''))) CLTCODE
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 28))) CLTACCNO
	,''
	,''
	,''
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND FILE_DATA <> ''	
	AND RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '|', 1)))<>'ROW_TYPE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_IDFC_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_IDFC_PROCESS] (

@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS

BEGIN
INSERT INTO #CMS_DATA

SELECT
			RTRIM(LTRIM(U.UPLOADID))
			,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
			,REPLACE(REPLACE(RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',1) )), CHAR(13), ''), CHAR(10), '') AS ROWTYPE
			,RTRIM(LTRIM(CONVERT(DATETIME,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',4) )),  105))) AS VALUEDATE
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) )) AS DRCR
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',5) )) AS INST_NO_CHECK
			,RTRIM(LTRIM(CAST(REPLACE(.DBO.Piece(FILE_DATA,'',3), '''', '') AS DECIMAL(20, 2)))) AMT
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',7))) AS DRAWER_NAME
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) ))  AS CLTCODE
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',9) )) AS CLTACC
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0 AS MATCHEDFLAG
			,U.UPLOADSTATUS
			,U.FILEUPLOAD_SDATE
			,GETDATE()
			,F.UPLOADBY
			FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
			INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
			ON U.UPLOADID = F.PROGID
			WHERE F.PROGID = @UPLOADID
	AND RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) ))  <> ''


END
--SELECT REPLACE(REPLACE(RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',1) )), CHAR(13), ''), CHAR(10), '') AS 'CLIENT_CODE ' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) )) AS 'DEBIT_CREDIT_FLAG' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',3) )) AS 'INSTRUMENT_AMNT' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',4) )) AS 'VALUE_DATE' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',5) )) AS 'INSTRUMENT_NMBR' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',6) )) AS 'DRAWEE_BANK_DESCRIPTION' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',7) )) AS 'DRAWER_DESCRIPTION' 
----,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) )) AS 'CLTCODE' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) )) AS 'REF' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',9) )) AS 'REM' 
--FROM  MSAJAG..FILEDATA 
--WHERE PROGID='82a91859'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_KOTAK_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_KOTAK_PROCESS] (
@UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(20) ) 
AS
BEGIN


INSERT INTO #CMS_DATA
	SELECT
		U.UPLOADID
		,@BANKCODE AS 'BANKCODE'
		,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1))) ROWTYPE
		,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',5),105)  AS VALUEDATE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) DRCR
		,RTRIM(LTRIM(DBO.PIECE(FILE_DATA, ',', 14))) INST_NO_CHECK
		,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, ',', 15) AS DECIMAL(20, 2)))) AS INST_AMT
		,'' AS  'DRAWER_NAME'
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, ',', 32), ' ', ''))) CLTCODE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 31))) CLTACCNO
		,''
		,''
		,''
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) IS NOT NULL
	AND RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) NOT IN('DEBIT_CREDIT_FLAG')

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_SBI_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_SBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @SRNO INT
SELECT * INTO #TEMP FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

SELECT @SRNO=SRNO  FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
AND FILE_DATA LIKE '%TXN DATE%'AND RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2)))='VALUE DATE'


DELETE FROM MSAJAG..FILEDATA WHERE SRNO<=@SRNO AND PROGID=@UPLOADID

INSERT INTO #CMS_DATA
	SELECT
	U.UPLOADID
	,@BANKCODE BANKCODE
	,'' ROWTYPE
	,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2))) AS DATETIME ) AS 'VALUEDATE'
	,CASE WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6)))='' THEN 'C' 
	  WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7)))='' THEN 'D' ELSE '' END AS 'DRCR'	
	,RTRIM(LTRIM(.DBO.PIECE(.DBO.PIECE(FILE_DATA,'	',4),'/',2))) AS 'INST_NO_CHECK'
	,CASE WHEN DBO.PIECE(FILE_DATA,'	',6) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7))) AS MONEY)
	  WHEN DBO.PIECE(FILE_DATA,'	',7) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ELSE 0 END AS 'AMOUNT'
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) AS 'DRAWER_NAME'
	,'' AS 'CLTCODE'
	,'' AS 'CLTACCNO'
	,''
	,''
	,''
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND .DBO.PIECE(FILE_DATA,'	',2) <> ''
	--SELECT * FROM #CMS_DATA RETURN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_YES_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_CMS_YES_PROCESS] (
--DECLARE
@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS
BEGIN
DECLARE @FILENAME NVARCHAR(MAX)
SELECT @FILENAME=UPLOADFILENAME FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
IF CHARINDEX('YESCMSBUSINESS', @FILENAME)=0
BEGIN
	IF(@UPLOAD_FLAG ='B')
BEGIN
UPDATE FILEDATA_BANKRECO
SET FILE_DATA = FILE_DATA + '@'
WHERE PROGID = @UPLOADID

INSERT INTO #CMS_DATA
	SELECT
		RTRIM(LTRIM(U.UPLOADID))
		,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1), '''', ''))) AS ROWTYPE
		,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', ''), 105))) AS VALUEDATE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), '''', ''))) AS DRCR
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 15), '''', ''))) AS INST_NO_CHECK
		,RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 4), '''', '') AS DECIMAL(20, 2)))) AMT
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 7), '''', '')))AS DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''))) AS CLIENTID
		,CASE WHEN ISNUMERIC(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))))=1 THEN RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))
		ELSE SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))), 0, LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))) - 1) END AS CLTACC
		--,SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))), 0, LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))) - 1) AS CLTACC
		--, RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))) AS CLTACC            
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,F.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 5), '''', '') NOT IN ('VALUE_DATE', '')

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT
		RTRIM(LTRIM(U.UPLOADID))
		,@BANKCODE AS BANKCODE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1), '''', ''))) AS ROWTYPE
		,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', ''), 105))) AS VALUEDATE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), '''', ''))) AS DRCR
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 15), '''', ''))) AS INST_NO_CHECK
		,RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 4), '''', '') AS DECIMAL(20, 2)))) AMT
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 7), '''', ''))) AS DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''))) AS CLIENTID
		--, SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))),0,LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))))-1) AS CLTACC  
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))) AS CLTACC
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,F.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 5), '''', '') NOT IN ('VALUE_DATE', '')

END

PRINT 'INSERTED TEMP TABLE'
END
ELSE
	BEGIN
	SELECT 'YOU HAVE SELECTED YESBANK_BUSINESS FILE ' 
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID			
	RETURN
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS] (
--DECLARE
@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS
BEGIN

DECLARE @FILENAME NVARCHAR(MAX)
SELECT @FILENAME=UPLOADFILENAME FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
IF CHARINDEX('YESCMSBUSINESS', @FILENAME)=1
	BEGIN
	
		UPDATE MSAJAG..FILEDATA
		SET FILE_DATA =.dbo.Piece(FILE_DATA, '"', 1)
		+.dbo.Piece(FILE_DATA, '"', 2)
		+.dbo.Piece(FILE_DATA, '"', 3)
		+.dbo.Piece(FILE_DATA, '"', 4)
		+.dbo.Piece(FILE_DATA, '"', 5)
		+.dbo.Piece(FILE_DATA, '"', 6)
		+.dbo.Piece(FILE_DATA, '"', 7)
		+.dbo.Piece(FILE_DATA, '"', 8)
		+.dbo.Piece(FILE_DATA, '"', 9)
		+.dbo.Piece(FILE_DATA, '"', 10)
		+.dbo.Piece(FILE_DATA, '"', 11)
		+.dbo.Piece(FILE_DATA, '"', 12)
		+.dbo.Piece(FILE_DATA, '"', 13)
		+.dbo.Piece(FILE_DATA, '"', 14)
		+.dbo.Piece(FILE_DATA, '"', 15)
		+.dbo.Piece(FILE_DATA, '"', 16)
		+.dbo.Piece(FILE_DATA, '"', 17)
		+.dbo.Piece(FILE_DATA, '"', 18)
		+.dbo.Piece(FILE_DATA, '"', 13)
		+.dbo.Piece(FILE_DATA, '"', 20)
		+.dbo.Piece(FILE_DATA, '"', 21)
		+.dbo.Piece(FILE_DATA, '"', 22)
		+.dbo.Piece(FILE_DATA, '"', 23)
		+.dbo.Piece(FILE_DATA, '"', 24)
		+.dbo.Piece(FILE_DATA, '"', 25)
		+.dbo.Piece(FILE_DATA, '"', 26)
		+.dbo.Piece(FILE_DATA, '"', 27)
		+.dbo.Piece(FILE_DATA, '"', 28)
		+.dbo.Piece(FILE_DATA, '"', 29)
		+.dbo.Piece(FILE_DATA, '"', 30)
		+.dbo.Piece(FILE_DATA, '"', 31)
		+.dbo.Piece(FILE_DATA, '"', 32)
		+.dbo.Piece(FILE_DATA, '"', 33)
		+.dbo.Piece(FILE_DATA, '"', 34)
		+.dbo.Piece(FILE_DATA, '"', 35)
		+.dbo.Piece(FILE_DATA, '"', 36)
		+.dbo.Piece(FILE_DATA, '"', 37)
		+.dbo.Piece(FILE_DATA, '"', 38)
		+.dbo.Piece(FILE_DATA, '"', 39)
		+.dbo.Piece(FILE_DATA, '"', 40)
		+.dbo.Piece(FILE_DATA, '"', 41)
		+.dbo.Piece(FILE_DATA, '"', 42)
		+.dbo.Piece(FILE_DATA, '"', 43)
		+.dbo.Piece(FILE_DATA, '"', 44)
		+.dbo.Piece(FILE_DATA, '"', 45)
		+.dbo.Piece(FILE_DATA, '"', 46)
		WHERE PROGID = @UPLOADID
		AND .dbo.Piece(FILE_DATA,'"',1)<>''
		
			INSERT INTO #CMS_DATA
			SELECT
			RTRIM(LTRIM(U.UPLOADID))
			,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '''', ''), ',', 2), '''', ''))) AS ROWTYPE
			,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''), 105))) AS VALUEDATE
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 10), '''', ''))) AS DRCR
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 17), '''', ''))) AS INST_NO_CHECK
			,ABS(RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', '') AS DECIMAL(20, 2))))) AMT
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))) AS DRAWER_NAME
			,'' AS CLIENTID
			,'' AS CLTACC
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0 AS MATCHEDFLAG
			,U.UPLOADSTATUS
			,U.FILEUPLOAD_SDATE
			,GETDATE()
			,F.UPLOADBY
			FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
			INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
			ON U.UPLOADID = F.PROGID
			WHERE F.PROGID = @UPLOADID
			AND .dbo.Piece(FILE_DATA, ',', 1) <> ''
			AND.DBO.PIECE(FILE_DATA, ',', 22) <> 'VALUE_DATE'
			AND (.DBO.PIECE(FILE_DATA, ',', 2) LIKE '%CAP360%'
			OR.DBO.PIECE(FILE_DATA, ',', 2) LIKE '%NCDEX384%')
			

	END
	ELSE
	BEGIN
	SELECT 'FILE NAME SHOULD START WITH YESCMSBUSINESS ' 
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID			
	RETURN
	END

PRINT 'INSERTED TEMP TABLE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_DELETION_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_DELETION_PROCESS]
( @UPLOADID NVARCHAR(50)
,@LOGINNAME NVARCHAR(50))
AS
BEGIN

DECLARE @BANKCODE NVARCHAR(50)
          ,@BANKACCOUNT NVARCHAR(50)
          ,@SEGMENT NVARCHAR(50)
          ,@FILETYPE NVARCHAR(50)

SELECT
	@BANKCODE = BANKCODE
	,@BANKACCOUNT = BANKACCOUNT
	,@SEGMENT = SEGMENT
	,@FILETYPE = FILETYPE
FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK)
WHERE UPLOADID = @UPLOADID





			IF(@FILETYPE='CMS')
			BEGIN

				DELETE FROM BANKRECO WHERE Dummy2=@UPLOADID

				--UPDATE L1
				--SET EDT = ''
				--FROM RECON_CMS_DATA N
				--, LEDGER L1
				--WHERE N.VNO = L1.VNO
				--AND N.VTYP = L1.VTYP
				--AND N.BOOKTYPE = L1.BOOKTYPE
				--AND N.VALUEDATE = L1.EDT
				--AND N.UPLOADID = @UPLOADID

				UPDATE L1
				SET RELDT = '' ,refno=''
				FROM RECON_CMS_DATA N
				, LEDGER1 L1
				WHERE N.VNO = L1.VNO
				AND N.VTYP = L1.VTYP
				AND N.BOOKTYPE = L1.BOOKTYPE
				AND N.VALUEDATE = L1.RELDT
				AND N.UPLOADID = @UPLOADID

				--DELETE FROM RECON_CMS_DATA	WHERE UPLOADID = @UPLOADID
				UPDATE RECON_CMS_DATA SET ROWTYPE='DR',MODIFIEDDATE=GETDATE()  
				WHERE UPLOADID = @UPLOADID

			END

			IF(@FILETYPE='NON-CMS' OR @FILETYPE='TECHPROCESS')
			BEGIN

				DELETE FROM BANKRECO WHERE Dummy2=@UPLOADID

				--UPDATE L1
				--SET EDT = ''
				--FROM RECON_NONCMS_DATA N
				--, LEDGER L1
				--WHERE N.VNO = L1.VNO
				--AND N.VTYP = L1.VTYP
				--AND N.BOOKTYPE = L1.BOOKTYPE
				--AND N.VALUEDATE = L1.EDT
				--AND N.UPLOADID = @UPLOADID

				UPDATE L1
				SET RELDT = '',refno=''
				FROM RECON_NONCMS_DATA N
				, LEDGER1 L1
				WHERE N.VNO = L1.VNO
				AND N.VTYP = L1.VTYP
				AND N.BOOKTYPE = L1.BOOKTYPE
				AND N.VALUEDATE = L1.RELDT
				AND N.UPLOADID = @UPLOADID


				UPDATE E SET MATCH_STATUS=0
				FROM RECON_ENCRYPTION_DETAILS E, Recon_NONCMS_Data RN
				WHERE E.CROSS_NO=RN.CROSS_NO
				AND RN.UPLOADID=@UPLOADID
				
				--DELETE FROM RECON_NONCMS_DATA
				--WHERE UPLOADID = @UPLOADID
				UPDATE RECON_NONCMS_DATA SET LedgerBalance='DR', ModifiedDate=GETDATE()
				WHERE UPLOADID = @UPLOADID
			END
			
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE ,MatchedFlag, USERNAME, PERFORMDATE)

			SELECT UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY
			, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE,0,@LOGINNAME,GETDATE()
			FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK)
			WHERE UPLOADID = @UPLOADID

			DELETE FROM RECON_BANK_FILEUPLOAD_LOGS
			WHERE UPLOADID = @UPLOADID	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_DELETION_PROCESS_FEB_082017
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_DELETION_PROCESS_FEB_082017]
( @UPLOADID NVARCHAR(50)
,@LOGINNAME NVARCHAR(50))
AS
BEGIN

DECLARE @BANKCODE NVARCHAR(50)
          ,@BANKACCOUNT NVARCHAR(50)
          ,@SEGMENT NVARCHAR(50)
          ,@FILETYPE NVARCHAR(50)

SELECT
	@BANKCODE = BANKCODE
	,@BANKACCOUNT = BANKACCOUNT
	,@SEGMENT = SEGMENT
	,@FILETYPE = FILETYPE
FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK)
WHERE UPLOADID = @UPLOADID





			IF(@FILETYPE='CMS')
			BEGIN

				DELETE FROM BANKRECO WHERE Dummy2=@UPLOADID

				--UPDATE L1
				--SET EDT = ''
				--FROM RECON_CMS_DATA N
				--, LEDGER L1
				--WHERE N.VNO = L1.VNO
				--AND N.VTYP = L1.VTYP
				--AND N.BOOKTYPE = L1.BOOKTYPE
				--AND N.VALUEDATE = L1.EDT
				--AND N.UPLOADID = @UPLOADID

				UPDATE L1
				SET RELDT = '',refno=''
				FROM RECON_CMS_DATA N
				, LEDGER1 L1
				WHERE N.VNO = L1.VNO
				AND N.VTYP = L1.VTYP
				AND N.BOOKTYPE = L1.BOOKTYPE
				AND N.VALUEDATE = L1.RELDT
				AND N.UPLOADID = @UPLOADID

				--DELETE FROM RECON_CMS_DATA	WHERE UPLOADID = @UPLOADID
				UPDATE RECON_CMS_DATA SET ROWTYPE='DR',MODIFIEDDATE=GETDATE()  
				WHERE UPLOADID = @UPLOADID

			END

			IF(@FILETYPE='NON-CMS')
			BEGIN

				DELETE FROM BANKRECO WHERE Dummy2=@UPLOADID

				--UPDATE L1
				--SET EDT = ''
				--FROM RECON_NONCMS_DATA N
				--, LEDGER L1
				--WHERE N.VNO = L1.VNO
				--AND N.VTYP = L1.VTYP
				--AND N.BOOKTYPE = L1.BOOKTYPE
				--AND N.VALUEDATE = L1.EDT
				--AND N.UPLOADID = @UPLOADID

				UPDATE L1
				SET RELDT = '',refno=''
				FROM RECON_NONCMS_DATA N
				, LEDGER1 L1
				WHERE N.VNO = L1.VNO
				AND N.VTYP = L1.VTYP
				AND N.BOOKTYPE = L1.BOOKTYPE
				AND N.VALUEDATE = L1.RELDT
				AND N.UPLOADID = @UPLOADID


				UPDATE E SET MATCH_STATUS=0
				FROM RECON_ENCRYPTION_DETAILS E, Recon_NONCMS_Data RN
				WHERE E.CROSS_NO=RN.CROSS_NO
				AND RN.UPLOADID=@UPLOADID
				
				--DELETE FROM RECON_NONCMS_DATA
				--WHERE UPLOADID = @UPLOADID
				UPDATE RECON_NONCMS_DATA SET LedgerBalance='DR', ModifiedDate=GETDATE()
				WHERE UPLOADID = @UPLOADID
			END
			
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE ,MatchedFlag, USERNAME, PERFORMDATE)

			SELECT UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY
			, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE,0,@LOGINNAME,GETDATE()
			FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK)
			WHERE UPLOADID = @UPLOADID

			DELETE FROM RECON_BANK_FILEUPLOAD_LOGS
			WHERE UPLOADID = @UPLOADID	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_DELETION_PROCESS_WRAPPER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_DELETION_PROCESS_WRAPPER]
( @UPLOADID NVARCHAR(50)
,@LOGINNAME NVARCHAR(50))

AS
BEGIN

		DECLARE @@ACCOUNTSERVER NVARCHAR(100),@@ACCOUNTDB NVARCHAR(100),@@SQL NVARCHAR(MAX)

		DECLARE  @TEMP_SEGMENT TABLE(SEGMENT NVARCHAR(50),FILETYPE NVARCHAR(50),ACCOUNTDB NVARCHAR(100),ACCOUNTSERVER NVARCHAR(100))

		INSERT INTO @TEMP_SEGMENT
		SELECT L.SEGMENT,L.FILETYPE,ACCOUNTDB,ACCOUNTSERVER 
		FROM RECON_BANK_FILEUPLOAD_LOGS_VW L ,ANAND1.PRADNYA.DBO.MULTICOMPANY P
		WHERE  P.EXCHANGE + '-' + P.SEGMENT=L.SEGMENT
		AND PRIMARYSERVER = 1
		AND UPLOADID=@UPLOADID


		WHILE (SELECT COUNT(*)	FROM @TEMP_SEGMENT) > 0 
		BEGIN
			SELECT TOP 1 @@ACCOUNTDB=ACCOUNTDB,@@ACCOUNTSERVER=ACCOUNTSERVER FROM @TEMP_SEGMENT

			SET @@SQL = ''
			SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".DBO.CLS_RECON_DELETION_PROCESS '" + @UPLOADID + "','" +  @LOGINNAME + "'"
			--SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.CLS_RECON_DELETION_PROCESS'"+ @UPLOADID  + "'"
			--SET @@SQL = "EXEC  " + @@ACCOUNTDB+ ".DBO.CLS_RECON_DELETION_PROCESS'"+ @UPLOADID  + "'"
			
			EXEC (@@SQL)
			print @@SQL
			DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB=@@ACCOUNTDB
		END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_ENCRYPTFILE_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_ENCRYPTFILE_PROCESS]
(
@UPLOADID NVARCHAR(50),
@SEGMENT NVARCHAR(50),
@BANKCODE NVARCHAR(50),
@BANKNAME NVARCHAR(50),
@FILETYPE NVARCHAR(50),
@BANKACCOUNT NVARCHAR(50),
@UPLOADFILENAME NVARCHAR(200),
@FILEPATH NVARCHAR(200),
@UPLOADBY NVARCHAR(50),
@UPLOAD_FLAG NVARCHAR(20)
)
AS
BEGIN
BEGIN TRY
CREATE  TABLE #TEMP_RECON_ENCRYPTION_DETAILS(
	[ENCRY_SRNO] [INT] IDENTITY(1,1) NOT NULL,
	[ENCRY_NUMBER] [NVARCHAR](50) NULL,
	[REFERENCESNUMBER] [NVARCHAR](50) NULL,
	[INCRYPTIONDATE] [DATETIME] NULL,
	[ENCRY_DESCRIPTION] [NVARCHAR](200) NULL,
	[ENCRY_AMOUNT] [MONEY] NULL,
	[ENCRY_STATUS] [NVARCHAR](25) NULL,
	[ENCRY_CHEQUENUMBER] [NVARCHAR](25) NULL,
	[UPLOADDATE] [DATETIME] NULL,
	[UPLOADBY] [NVARCHAR](50) NULL,
	[MATCH_STATUS] [INT] NULL,
	[UPLOADTYPE] [NVARCHAR](20) NULL,
	[UPLOADID] [NVARCHAR](50))

	INSERT INTO #TEMP_RECON_ENCRYPTION_DETAILS(ENCRY_NUMBER,REFERENCESNUMBER,INCRYPTIONDATE,ENCRY_DESCRIPTION,ENCRY_AMOUNT,ENCRY_STATUS
	,ENCRY_CHEQUENUMBER,UPLOADDATE,UPLOADBY,MATCH_STATUS,UPLOADTYPE,UPLOADID)

	SELECT RTRIM(LTRIM(.DBO.PIECE(REPLACE(FILE_DATA, '''', ''), '	', 1)))ENCRY_NUMBER,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) REFERENCESNUMBER,
	CONVERT(DATETIME,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',4))),105) INCRYPTIONDATE,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',5))) ENCRY_DESCRIPTION,
	CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ENCRY_AMOUNT,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',8))) ENCRY_STATUS,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',12)))ENCRY_CHEQUENUMBER,
	GETDATE(),
	@UPLOADBY,
	0,
	@UPLOAD_FLAG,
	@UPLOADID
	FROM MSAJAG..FILEDATA (NOLOCK)
	WHERE PROGID=@UPLOADID
	AND FILE_DATA !=''

	IF NOT EXISTS(SELECT TOP 1 * FROM #TEMP_RECON_ENCRYPTION_DETAILS T,RECON_ENCRYPTION_DETAILS E
					WHERE T.REFERENCESNUMBER=E.REFERENCESNUMBER
					AND T.ENCRY_NUMBER=E.ENCRY_NUMBER
					AND T.INCRYPTIONDATE=E.INCRYPTIONDATE
					AND T.ENCRY_AMOUNT=E.ENCRY_AMOUNT
					AND T.ENCRY_STATUS=E.ENCRY_STATUS
					AND T.INCRYPTIONDATE=E.INCRYPTIONDATE
					AND T.ENCRY_CHEQUENUMBER=E.ENCRY_CHEQUENUMBER)
		BEGIN
			INSERT INTO RECON_ENCRYPTION_DETAILS(ENCRY_NUMBER,REFERENCESNUMBER,INCRYPTIONDATE,ENCRY_DESCRIPTION,ENCRY_AMOUNT,ENCRY_STATUS
			,ENCRY_CHEQUENUMBER,UPLOADDATE,UPLOADBY,MATCH_STATUS,UPLOADTYPE,UPLOADID,SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE,CROSS_NO)
			SELECT ENCRY_NUMBER,REFERENCESNUMBER,INCRYPTIONDATE,ENCRY_DESCRIPTION,ENCRY_AMOUNT,ENCRY_STATUS
			,ENCRY_CHEQUENUMBER,UPLOADDATE,UPLOADBY,MATCH_STATUS,
			CASE WHEN UPLOADTYPE='B' THEN 'BULK' ELSE UPLOADTYPE END,
			@UPLOADID,@SEGMENT,@BANKNAME,@BANKCODE,@BANKACCOUNT,@FILETYPE,''
			FROM #TEMP_RECON_ENCRYPTION_DETAILS 
			WHERE UPLOADID=@UPLOADID
		END
	ELSE
		BEGIN
		SELECT 'File already uploaded'
		END		

	DELETE FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
	END TRY
	BEGIN CATCH
		DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
		SELECT 'PLEASE CHECK WRONG FILE FORMATE '
		RETURN

	END CATCH
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_GET_BANKMASTER
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_GET_BANKMASTER]
AS
BEGIN

SELECT * FROM RECON_BANK_MASTER_VW

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_INSERT_BANK_MASTER
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_INSERT_BANK_MASTER] (
--DECLARE
@SEGMENT NVARCHAR(100)
,@BANKNAME NVARCHAR(100) 
,@BANKCODE NVARCHAR(30) 
,@BANKACCOUNT NVARCHAR(30) 
,@CLIENT NVARCHAR(100) 
,@FILETYPE NVARCHAR(25) 
,@ACTION VARCHAR(10)) 

AS
BEGIN
  IF @ACTION = 'ADD'
          BEGIN
                    IF EXISTS (SELECT TOP 1
		*
	FROM RECON_BANK_MASTER_VW(NOLOCK)
	WHERE SEGMENT = @SEGMENT
	AND BANKCODE = @BANKCODE
	AND BANKACCOUNT = @BANKACCOUNT
	AND FILETYPE = @FILETYPE) BEGIN
SELECT
	'ALREADY EXIST YOU HAVE INSERTED FOR ' + @SEGMENT + '-' + @BANKNAME + '-' + @BANKCODE + '-' + @BANKACCOUNT + '-' + @FILETYPE
END ELSE BEGIN
INSERT INTO RECON_BANK_MASTER ([SEGMENT]
, [BANKNAME]
, [BANKCODE]
, [BANKACCOUNT]
, [CLIENT]
, [FILETYPE]
, [INSERTEDDATETIME]
, [LASTUPDATE])
	VALUES (@SEGMENT, @BANKNAME, @BANKCODE, @BANKACCOUNT, @CLIENT, @FILETYPE, GETDATE(), GETDATE())
SELECT
	'SUCCESSFULLY YOU HAVE INSERTED FOR ' + @SEGMENT + '-' + @BANKNAME + '-' + @BANKCODE + '-' + @BANKACCOUNT + '-' + @FILETYPE
END
END

IF @ACTION = 'FETCH' BEGIN
SELECT
	SEGMENT
	,BANKNAME
	,BANKCODE
	,BANKACCOUNT
	,CLIENT
	,FILETYPE
	,INSERTEDDATETIME
	,LASTUPDATE
FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE SEGMENT = @SEGMENT
AND BANKNAME = @BANKNAME
AND FILETYPE = @FILETYPE
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_INSERT_PROCESS
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[CLS_RECON_INSERT_PROCESS] (@UPLOADID   NVARCHAR(50)
, @FILETYPE NVARCHAR(50)
, @BANKNAME NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1)
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
, @BANKCODE NVARCHAR(20)
, @BANKACCOUNT NVARCHAR(50)
, @SEGMENT NVARCHAR(20)
, @UNAME NVARCHAR(50)
, @FILE_PATH NVARCHAR(150)
, @COMBINEFILE NVARCHAR(5)
, @UPLOADFILENAME NVARCHAR(150))
AS
  BEGIN
  DECLARE @VALUEDATE DATETIME
  
  
  
		IF(@REPROCESS_FLAG<>'R')
			BEGIN

		IF(	@BANKCODE='0' AND @BANKACCOUNT='0')				
		SET @COMBINEFILE='0'		
		ELSE
		SET @COMBINEFILE='1'
				
IF(@COMBINEFILE='0')
	BEGIN
		SELECT	@BANKCODE = BANKCODE
		FROM RECON_BANK_MASTER_VW 
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE

		UPDATE RECON_BANK_FILEUPLOAD_LOGS
		SET BANKCODE=@BANKCODE
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE
	END
END
DECLARE @TOTALFILERECORD INT, @TOTALINSERTRECORD INT, @LOOPINSERTRECORD NVARCHAR(20)



DECLARE @TEMPBANKACCOUNTMASTER TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @TEMPBANKACCOUNT TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @@SQL VARCHAR(MAX),
@@ACCOUNTDB VARCHAR(20),
@@ACCOUNTSERVER VARCHAR(20)
DECLARE @@CROSS_NO INT



IF (@FILETYPE = 'CMS') 
BEGIN
CREATE TABLE #CMS_DATA(SNO INT IDENTITY (1, 1)
, UPLOADID NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, ROWTYPE NVARCHAR(50)
, VALUEDATE DATETIME
, DRCR NVARCHAR(50)
, INST_NO_CHECK NVARCHAR(50)
, INST_AMT DECIMAL(20, 2)
, DRAWER_NAME NVARCHAR(250)
, CLTCODE NVARCHAR(50)
, CLTACCNO NVARCHAR(50)
, VNO NVARCHAR(20)
, VTYP NVARCHAR(20)
, BOOKTYPE NVARCHAR(20)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE NVARCHAR(50)
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))
CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))



IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_CMS_HDFC_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'ICICI BANK') EXEC CLS_RECON_CMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_CMS_KOTAK_PROCESS	@UPLOADID,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') PRINT 'EXEC CLS_RECON_CMS_SCB_PROCESS @UPLOADID'
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_CMS_IDFC_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_CMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_CMS_YES_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'YESBANK BUSINESS') EXEC CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

PRINT 'PROCESS CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT		
		UPLOADID
		,R.BANKCODE
		,ROWTYPE
		,R.VALUEDATE
		,R.DRCR
		,R.INST_NO_CHECK
		,R.INST_AMT
		,DRAWER_NAME
		,R.CLTCODE
		,R.CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY		
	FROM RECON_CMS_DATA R (NOLOCK)
	WHERE VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND MATCHEDFLAG = 0
	AND BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=R.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND RowType<>'DR'
END

IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN

IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
		INSERT INTO #LEDGER_TO_MAP
		SELECT
			L.VNO
			,L.VTYP
			,L.BOOKTYPE
			,CLTCODE
			,DDNO
			,RELAMT
			,L1.DRCR
			,L.Edt
			,L.Vdt
			,L.NARRATION
		FROM	LEDGER L
				,LEDGER1 L1
		WHERE L.VNO = L1.VNO
		AND L.VTYP = L1.VTYP
		AND L.LNO = L1.LNO
		AND L.BOOKTYPE = L1.BOOKTYPE
		AND L1.RELDT = ''
		AND EXISTS (SELECT
				VNO
			FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO
			AND L11.VTYP = L1.VTYP
			AND L11.BOOKTYPE = L1.BOOKTYPE
			AND L11.CLTCODE = @BANKCODE
			AND L11.VTYP IN (2, 3, 17)
		--AND L11.Vdt<=@VALUEDATE
		)
	END
END
IF(@COMBINEFILE<>0) 
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
	--AND L11.Vdt<=@VALUEDATE
	)
		END
							
END
IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF @REPROCESS_FLAG <> 'R'
BEGIN
				DELETE FROM T 
				FROM #CMS_DATA T,RECON_CMS_DATA R
				WHERE  ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 30),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 30),'')
				------AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(T.BANKCODE,'')=ISNULL(R.BANKCODE,'')
				AND R.ROWTYPE<>'DR'

END				

IF EXISTS(SELECT * FROM  #CMS_DATA)
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
	ELSE
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)

	SELECT @VALUEDATE = MAX(VALUEDATE) FROM #CMS_DATA 
	
ALTER TABLE #CMS_DATA
ADD  MATCHCODE INT

SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE INTO #CMS_DATA_DUPLICATE FROM #CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE
HAVING COUNT(*)>1

IF(@FILETYPE='CMS' AND @BANKNAME='SBI')
BEGIN
	UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
	WHERE L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT
	AND C.INST_NO_CHECK=RTRIM(LTRIM(.DBO.PIECE(L.NARRATION,':',2)))
	--AND M.CLTCODE = C.CLTCODE
	--AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)	
	AND M.CLTCODE = L.CLTCODE
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
IF(@FILETYPE='CMS' AND @BANKNAME<>'SBI')
BEGIN
IF @REPROCESS_FLAG = 'R' AND @BANKNAME='YESBANK BUSINESS'
BEGIN
print 'bb'
			UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
	AND L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT	
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
ELSE
BEGIN 
UPDATE C
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,C.VNO = L.VNO
	,C.VTYP = L.VTYP
	,C.BOOKTYPE = L.BOOKTYPE
	,C.MATCHCODE=1
	,CLTCODE=L.CLTCODE
FROM #CMS_DATA C (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
AND L.DDNO<>''
AND C.DRCR = L.DRCR
AND C.INST_AMT = L.RELAMT
--AND M.CLTCODE = C.CLTCODE
AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
AND M.CLTCODE = L.CLTCODE
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
WHERE E.BANKCODE=C.BANKCODE
--AND E.CLTACCNO=C.CLTACCNO
AND E.CLTCODE=C.CLTCODE
AND E.DRCR=C.DRCR
AND E.INST_AMT=C.INST_AMT
AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END 
END


SELECT UPLOADID ,VNO,VTYP,BOOKTYPE INTO #DUPLICATE_CMS_DATA
FROM #CMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE C
	SET	MATCHEDFLAG =0
		,MODIFIEDDATE = ''
		,C.VNO = ''
		,C.VTYP = ''
		,C.BOOKTYPE = ''
		,C.MATCHCODE=''
		,CLTCODE=''
	FROM #CMS_DATA C 
	, #DUPLICATE_CMS_DATA L 
	WHERE C.VNO = L.VNO
	AND C.VTYP = L.VTYP		
	AND C.BOOKTYPE = L.BOOKTYPE	
	AND C.UPLOADID=L.UPLOADID


IF @REPROCESS_FLAG <> 'R' 
BEGIN
SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0) FROM BANKRECO(NOLOCK)				
				
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
, MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY 
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM #CMS_DATA
	
UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO --UPLOADSTATUS
FROM #CMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #CMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
	
END 
ELSE 
BEGIN

UPDATE RECON_CMS_DATA
SET	VNO = C.VNO
	,VTYP = C.VTYP
	,BOOKTYPE = C.BOOKTYPE
	,MATCHEDFLAG = C.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = C.MODIFIEDDATE
	,MATCHCODE=C.MATCHCODE
	,CLTCODE=C.CLTCODE
FROM #CMS_DATA C, RECON_CMS_DATA R
WHERE C.UPLOADSTATUS = R.CROSS_NO
AND C.MATCHEDFLAG = 1

UPDATE B SET STATUS =CASE WHEN BR.MATCHEDFLAG = 1 THEN 'MATCHED' ELSE 'UNMATCHED' END
			FROM #CMS_DATA BR, BANKRECO B
			WHERE BANKCODE = B.CLTCODE
			AND B.CROSSREFERENCENO = BR.UPLOADSTATUS

UPDATE L1 SET RELDT = VALUEDATE	,REFNO = UPLOADSTATUS
			FROM #CMS_DATA N , LEDGER1 L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1 SET EDT = VALUEDATE
			FROM #CMS_DATA N, LEDGER L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE
			AND EDT LIKE 'DEC 31 2049%'
			
END


SELECT	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD>=1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE
DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END


IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO @TEMPBANKACCOUNTMASTER
	SELECT DISTINCT	BANKACCOUNT	FROM RECON_BANK_MASTER_VW WHERE BANKNAME=@BANKNAME AND FILEFORMATE=0 AND FILETYPE=@FILETYPE

INSERT INTO @TEMPBANKACCOUNT
SELECT  DISTINCT BANKACCOUNT  FROM @TEMPBANKACCOUNTMASTER BM,#CMS_DATA T
WHERE LTRIM(RTRIM(T.ROWTYPE))= BM.BANKACCOUNT AND UPLOADID=@UPLOADID

WHILE (SELECT		COUNT(*)	FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE
FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT AND BANKNAME =@BANKNAME

SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_CMS_DATA (UPLOADID,
BANKCODE,
ROWTYPE,
VALUEDATE,
DRCR,
INST_NO_CHECK,
INST_AMT,
DRAWER_NAME,
CLTCODE,
CLTACCNO,
VNO,
VTYP,
BOOKTYPE,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY,
CROSS_NO,
MATCHCODE)
										SELECT UPLOADID
										, "+@BANKCODE+"
										, ROWTYPE
										, VALUEDATE
										, DRCR
										, INST_NO_CHECK
										, INST_AMT
										, DRAWER_NAME
										, CLTCODE
										, CLTACCNO
										, VNO
										, VTYP
										, BOOKTYPE
										, MATCHEDFLAG
										, UPLOADSTATUS
										, UPLOADEDDATE
										, MODIFIEDDATE
										, UPLOADBY
										, 0
										, 0
										FROM   #CMS_DATA WHERE ROWTYPE='" + @BANKACCOUNT + "'"

EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "'" + ",'" + @SEGMENT + "'"

EXEC (@@SQL)
--PRINT @@SQL

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_CMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)
END
SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #CMS_DATA
WHERE ROWTYPE = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END
SELECT	@TOTALFILERECORD = COUNT(*)
FROM RECON_CMS_DATA
WHERE UPLOADID = @UPLOADID

END


IF @REPROCESS_FLAG <> 'R' 
BEGIN
IF (@COMBINEFILE<>'0')
BEGIN
/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS
	SET	FILEUPLOAD_EDATE = GETDATE(),VALUEDATE = @VALUEDATE
	WHERE UPLOADID = @UPLOADID

END

END

DROP TABLE #CMS_DATA

END 
ELSE 
IF (@FILETYPE = 'NON-CMS' OR @FILETYPE = 'TECHPROCESS' OR  @FILETYPE = 'BILLDESK') 
BEGIN

CREATE TABLE #NONCMS_DATA(SRNONCMS INT IDENTITY (1, 1) NOT NULL
, UPLOADID NVARCHAR(50)
, BANKACCOUNT NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, DESCRIPTION NVARCHAR(150)
, LEDGERBALANCE NVARCHAR(50)
, DRCR NVARCHAR(50)
, AMT DECIMAL(20, 2)
, VALUEDATE NVARCHAR(50)
, REFERENCENO NVARCHAR(50)
, CLTACCOUNT NVARCHAR(50)
, CUSTOMERREFERENCE NVARCHAR(300) NULL
, TRANSACTIONDETAIL NVARCHAR(800) NULL
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE DATETIME
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))

CREATE TABLE #LEDGER_TO_MAP_NON(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_HDFC(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)



CREATE TABLE #NONCMS_DATA_DUPLICATE(SRNONCMS INT
, UPLOADID NVARCHAR(50)
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3))

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_NONCMS_HDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME

IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS') EXEC CLS_RECON_NONCMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_NONCMS_KOTAK_PROCESS @UPLOADID ,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') EXEC CLS_RECON_NONCMS_SCB_PROCESS	@UPLOADID ,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_NONCMS_IDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME	

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_NONCMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME

IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_NONCMS_YES_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS') EXEC CLS_RECON_TECHPROCESS_ICICI_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'INDUSIND BANK') EXEC CLS_RECON_NONCMS_INDUSIND_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'AXIS BANK') EXEC CLS_RECON_NONCMS_AXIS_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@FILETYPE = 'BILLDESK') EXEC CLS_RECON_NONCMS_BILLDESK_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME



PRINT 'PROCESS NON CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #NONCMS_DATA
	SELECT		
		UPLOADID
		,BANKACCOUNT
		,BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		
	FROM RECON_NONCMS_DATA(NOLOCK) C
	WHERE C.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND C.MATCHEDFLAG = 0
	AND C.BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=C.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND LedgerBalance<>'DR'
END

ALTER TABLE #NONCMS_DATA
ADD  MATCHCODE INT

IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END
IF(@COMBINEFILE<>0) 
BEGIN
	IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END

INSERT INTO #LEDGER_TO_MAP_NON
	SELECT
		MAX(VNO)
		,MAX(VTYP)
		,MAX(BOOKTYPE)
		,MAX(CLTCODE)
		,DDNO
		,RELAMT
		,DRCR
		,Edt
		,Vdt
		,NARRATION
	FROM #LEDGER_TO_MAP_NON_HDFC
	GROUP BY	DDNO
				,RELAMT
				,DRCR
				,EDT
				,VDT
				,NARRATION
	HAVING COUNT(1) = 1

IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

	DELETE FROM T
	FROM #NONCMS_DATA T ,RECON_NONCMS_DATA R
	WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
	AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
	AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
	AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
	AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
	AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
	AND R.LEDGERBALANCE <>'DR'

END
	
	IF EXISTS(SELECT * FROM  #NONCMS_DATA)
	BEGIN	
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)	
	END
	ELSE
	BEGIN
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
	END
	SELECT @VALUEDATE =MAX(CONVERT(DATETIME, VALUEDATE, 105)) FROM #NONCMS_DATA 				
	
	SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)FROM BANKRECO(NOLOCK)

IF(@BANKNAME<>'INDUSIND BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) <= 15

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE	
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) > 15

--HDFC BANK FOR CLTACCOUNT
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
--, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE=.DBO.PIECE(REPLACE(DESCRIPTION,' ','|'),'|',2)
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)

AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

--HDFC BANK FOR CLTCODE
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
WHERE L.CLTCODE=RTRIM(LTRIM(SUBSTRING(DESCRIPTION,CHARINDEX('Angel to',DESCRIPTION )+8,len(DESCRIPTION))))
AND Description LIKE '%Angel to%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG=0

		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',3), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',3)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG=0
	END

END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='YES BANK')
BEGIN

INSERT INTO #LEDGER_TO_MAP_NON_YES
SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION FROM 
#LEDGER_TO_MAP_NON  WHERE NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION 
HAVING COUNT(*)=1

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=5
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE DESCRIPTION LIKE'%NEFT-RETURN-%'
AND NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='AXIS BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE = .dbo.piece(N.DESCRIPTION,'/',5)
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='KOTAK BANK')
BEGIN


UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0


END

IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE '%ATOM %')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = SUBSTRING(REPLACE(DESCRIPTION,'ATOM ',''),0,CHARINDEX(' ',REPLACE(DESCRIPTION,'ATOM ',''))) 
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND MATCHEDFLAG=0
AND DESCRIPTION LIKE '%ATOM %'
AND N.MATCHEDFLAG=0


END
/*COMPARE WITH ENCRYPTION FILE */
IF(@FILETYPE='NON-CMS' AND @BANKNAME='HDFC BANK')
BEGIN

UPDATE N
SET MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = T.VNO
	,N.VTYP = T.VTYP
	,N.BOOKTYPE = T.BOOKTYPE
	,N.MATCHCODE=4
	,N.CUSTOMERREFERENCE=T.CLTCODE
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND T.DDNO<>''
AND N.AMT = T.RELAMT
AND N.MATCHEDFLAG=0

UPDATE E
SET MATCH_STATUS = 1,CROSS_NO=@@CROSS_NO + SRNONCMS
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND N.AMT = T.RELAMT
--AND E.MATCH_STATUS = 0

END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='INDUSIND BANK')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND MATCHEDFLAG=0


END

INSERT INTO #NONCMS_DATA_DUPLICATE (UPLOADID ,VNO,VTYP,BOOKTYPE)
SELECT UPLOADID ,VNO,VTYP,BOOKTYPE FROM #NONCMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE N SET MATCHEDFLAG = 0
			,MODIFIEDDATE = ''
			,N.VNO = ''
			,N.VTYP = ''
			,N.BOOKTYPE = ''
			,N.MATCHCODE = ''
			FROM #NONCMS_DATA N	,#NONCMS_DATA_DUPLICATE ND
			WHERE N.VNO=ND.VNO
			AND N.VTYP=ND.VTYP
			AND N.BOOKTYPE=ND.BOOKTYPE
			AND N.UPLOADID=ND.UPLOADID
			
IF (@REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE])
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,@@CROSS_NO + SRNONCMS
		,MATCHCODE
	FROM #NONCMS_DATA

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = @@CROSS_NO + SRNONCMS--UPLOADSTATUS
FROM #NONCMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'	
	
END 

IF (@REPROCESS_FLAG = 'R') 
BEGIN
UPDATE B
SET	VNO = NR.VNO
	,VTYP = NR.VTYP
	,BOOKTYPE = NR.BOOKTYPE
	,MATCHEDFLAG = NR.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = NR.MODIFIEDDATE
	,MATCHCODE = NR.MATCHCODE
	,CUSTOMERREFERENCE=NR.CUSTOMERREFERENCE
FROM #NONCMS_DATA NR, RECON_NONCMS_DATA B
WHERE b.BANKCODE = @BANKCODE
AND NR.UPLOADSTATUS = B.CROSS_NO
AND NR.MATCHEDFLAG = 1


UPDATE B
SET STATUS =CASE WHEN MATCHEDFLAG = 1 THEN 'MATCHED'	ELSE 'UNMATCHED' END
FROM #NONCMS_DATA NR,BANKRECO B
WHERE B.CLTCODE=@BANKCODE
AND BANKCODE = CLTCODE
AND NR.UPLOADSTATUS = B.CROSSREFERENCENO

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = N.UPLOADSTATUS
FROM #NONCMS_DATA N, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'

END


SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA(NOLOCK)

IF (@TOTALFILERECORD>0) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE

DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID


END

IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN

INSERT INTO @TEMPBANKACCOUNT
	SELECT DISTINCT
		BANKACCOUNT
	FROM #NONCMS_DATA
DELETE FROM  @TEMPBANKACCOUNT WHERE BANKACCOUNT IS NULL
WHILE (SELECT COUNT(*)FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

IF(@FILETYPE<>'TECHPROCESS')
SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT

IF(@FILETYPE='TECHPROCESS')

SELECT	@SEGMENT = RT.SEGMENT
,@BANKCODE = RB.BANKCODE FROM RECON_BANK_MASTER_VW RB(NOLOCK),RECON_TECH_PROCESS_MASTER_VW RT(NOLOCK)
WHERE  RB.SEGMENT=RT.SEGMENT AND  RB.FILETYPE=@FILETYPE AND RB.BANKNAME=@BANKNAME 
AND RT.ACCOUNTTYPE=@BANKACCOUNT


SELECT
	@@ACCOUNTDB = ACCOUNTDB
	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_NONCMS_DATA (UPLOADID
	,BANKACCOUNT
	,BANKCODE
	,DESCRIPTION
	,LEDGERBALANCE
	,DRCR
	,AMT
	,VALUEDATE
	,REFERENCENO
	,CLTACCOUNT
	,CUSTOMERREFERENCE
	,TRANSACTIONDETAIL
	,VNO
	,VTYP
	,BOOKTYPE
	,MATCHEDFLAG
	,UPLOADSTATUS
	,UPLOADEDDATE
	,MODIFIEDDATE
	,UPLOADBY
	,BOOKDATE
	,CROSS_NO
	,MATCHCODE) 
	SELECT UPLOADID
	 , BANKACCOUNT
	 , "+@BANKCODE+"
	 , DESCRIPTION
	 , LEDGERBALANCE
	 , DRCR
	 , AMT
	 , VALUEDATE
	 , REFERENCENO
	 , CLTACCOUNT
	 , CUSTOMERREFERENCE
	 , TRANSACTIONDETAIL
	 , VNO
	 , VTYP
	 , BOOKTYPE
	 , MATCHEDFLAG
	 , UPLOADSTATUS
	 , UPLOADEDDATE 
	 , MODIFIEDDATE
	 , UPLOADBY
	 , VALUEDATE
	 ,0
	 ,0
	FROM   #NONCMS_DATA  WHERE  BANKACCOUNT='" + @BANKACCOUNT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "','" + @BANKNAME + "'" + ",'" + @FILETYPE + "'" + ",'" + @SEGMENT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_NONCMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)

END

SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #NONCMS_DATA
WHERE BANKACCOUNT = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END

SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD >1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
END



/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */
IF (@COMBINEFILE<>'0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CAST(CROSS_NO AS NVARCHAR(20))
		,CASE WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'	ELSE 'UNMATCHED' END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR ,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2
	AND   CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE	AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1
	AND UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS 
	SET FILEUPLOAD_EDATE=GETDATE(),VALUEDATE=@VALUEDATE  WHERE UPLOADID=@UPLOADID

	END
	DROP TABLE #NONCMS_DATA


END 
ELSE 
BEGIN
PRINT 'PLEASE CHECK SUPPLY PARAMETERS'
DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
END


IF @REPROCESS_FLAG <> 'R'
BEGIN

	IF NOT EXISTS(SELECT * FROM EXISTS_RECORDS_VW WHERE RECORDSTATUS=0 AND UPLOADID=@UPLOADID )
	BEGIN	
	SELECT 'UPLOADED RECORDS ALREADY EXISTS'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END
	ELSE
	BEGIN
	SELECT 'FILE UPLOAD SUCCESSFULLY'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END

END
ELSE
BEGIN
		SELECT 'REPROCESS SUCCESSFULLY'
END

DELETE FROM EXISTS_RECORDS WHERE UPLOADID=@UPLOADID

DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID

DELETE FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_INSERT_PROCESS_bkup_27aPR2018
-- --------------------------------------------------






cREATE  PROCEDURE [dbo].[CLS_RECON_INSERT_PROCESS_bkup_27aPR2018] (@UPLOADID   NVARCHAR(50)
, @FILETYPE NVARCHAR(50)
, @BANKNAME NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1)
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
, @BANKCODE NVARCHAR(20)
, @BANKACCOUNT NVARCHAR(50)
, @SEGMENT NVARCHAR(20)
, @UNAME NVARCHAR(50)
, @FILE_PATH NVARCHAR(150)
, @COMBINEFILE NVARCHAR(5)
, @UPLOADFILENAME NVARCHAR(150))
AS
  BEGIN
  DECLARE @VALUEDATE DATETIME
  
  

		IF(@REPROCESS_FLAG<>'R')
			BEGIN

		IF(	@BANKCODE='0' AND @BANKACCOUNT='0')				
		SET @COMBINEFILE='0'		
		ELSE
		SET @COMBINEFILE='1'
				
IF(@COMBINEFILE='0')
	BEGIN
		SELECT	@BANKCODE = BANKCODE
		FROM RECON_BANK_MASTER_VW 
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE

		UPDATE RECON_BANK_FILEUPLOAD_LOGS
		SET BANKCODE=@BANKCODE
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE
	END
END
DECLARE @TOTALFILERECORD INT, @TOTALINSERTRECORD INT, @LOOPINSERTRECORD NVARCHAR(20)



DECLARE @TEMPBANKACCOUNTMASTER TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @TEMPBANKACCOUNT TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @@SQL VARCHAR(MAX),
@@ACCOUNTDB VARCHAR(20),
@@ACCOUNTSERVER VARCHAR(20)
DECLARE @@CROSS_NO INT

BEGIN TRY

IF (@FILETYPE = 'CMS') 
BEGIN
CREATE TABLE #CMS_DATA(SNO INT IDENTITY (1, 1)
, UPLOADID NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, ROWTYPE NVARCHAR(50)
, VALUEDATE DATETIME
, DRCR NVARCHAR(50)
, INST_NO_CHECK NVARCHAR(50)
, INST_AMT DECIMAL(20, 2)
, DRAWER_NAME NVARCHAR(250)
, CLTCODE NVARCHAR(50)
, CLTACCNO NVARCHAR(50)
, VNO NVARCHAR(20)
, VTYP NVARCHAR(20)
, BOOKTYPE NVARCHAR(20)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE NVARCHAR(50)
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))
CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))



IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_CMS_HDFC_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'ICICI BANK') EXEC CLS_RECON_CMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_CMS_KOTAK_PROCESS	@UPLOADID,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') PRINT 'EXEC CLS_RECON_CMS_SCB_PROCESS @UPLOADID'
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_CMS_IDFC_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_CMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_CMS_YES_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'YESBANK BUSINESS') EXEC CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

PRINT 'PROCESS CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT		
		UPLOADID
		,R.BANKCODE
		,ROWTYPE
		,R.VALUEDATE
		,R.DRCR
		,R.INST_NO_CHECK
		,R.INST_AMT
		,DRAWER_NAME
		,R.CLTCODE
		,R.CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY		
	FROM RECON_CMS_DATA R (NOLOCK)
	WHERE VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND MATCHEDFLAG = 0
	AND BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=R.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND RowType<>'DR'
END

IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN

IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
		INSERT INTO #LEDGER_TO_MAP
		SELECT
			L.VNO
			,L.VTYP
			,L.BOOKTYPE
			,CLTCODE
			,DDNO
			,RELAMT
			,L1.DRCR
			,L.Edt
			,L.Vdt
			,L.NARRATION
		FROM	LEDGER L
				,LEDGER1 L1
		WHERE L.VNO = L1.VNO
		AND L.VTYP = L1.VTYP
		AND L.LNO = L1.LNO
		AND L.BOOKTYPE = L1.BOOKTYPE
		AND L1.RELDT = ''
		AND EXISTS (SELECT
				VNO
			FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO
			AND L11.VTYP = L1.VTYP
			AND L11.BOOKTYPE = L1.BOOKTYPE
			AND L11.CLTCODE = @BANKCODE
			AND L11.VTYP IN (2, 3, 17)
		--AND L11.Vdt<=@VALUEDATE
		)
	END
END
IF(@COMBINEFILE<>0) 
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
	--AND L11.Vdt<=@VALUEDATE
	)
		END
							
END
IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF @REPROCESS_FLAG <> 'R'
BEGIN
				DELETE FROM T 
				FROM #CMS_DATA T,RECON_CMS_DATA R
				WHERE  ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 30),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 30),'')
				------AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(T.BANKCODE,'')=ISNULL(R.BANKCODE,'')
				AND R.ROWTYPE<>'DR'

END				

IF EXISTS(SELECT * FROM  #CMS_DATA)
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
	ELSE
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)

	SELECT @VALUEDATE = MAX(VALUEDATE) FROM #CMS_DATA 
	
ALTER TABLE #CMS_DATA
ADD  MATCHCODE INT

SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE INTO #CMS_DATA_DUPLICATE FROM #CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE
HAVING COUNT(*)>1

IF(@FILETYPE='CMS' AND @BANKNAME='SBI')
BEGIN
	UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
	WHERE L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT
	AND C.INST_NO_CHECK=RTRIM(LTRIM(.DBO.PIECE(L.NARRATION,':',2)))
	--AND M.CLTCODE = C.CLTCODE
	--AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)	
	AND M.CLTCODE = L.CLTCODE
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
IF(@FILETYPE='CMS' AND @BANKNAME<>'SBI')
BEGIN
IF @REPROCESS_FLAG = 'R' AND @BANKNAME='YESBANK BUSINESS'
BEGIN
print 'bb'
			UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
	AND L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT	
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
ELSE
BEGIN 
UPDATE C
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,C.VNO = L.VNO
	,C.VTYP = L.VTYP
	,C.BOOKTYPE = L.BOOKTYPE
	,C.MATCHCODE=1
	,CLTCODE=L.CLTCODE
FROM #CMS_DATA C (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
AND L.DDNO<>''
AND C.DRCR = L.DRCR
AND C.INST_AMT = L.RELAMT
--AND M.CLTCODE = C.CLTCODE
AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
AND M.CLTCODE = L.CLTCODE
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
WHERE E.BANKCODE=C.BANKCODE
--AND E.CLTACCNO=C.CLTACCNO
AND E.CLTCODE=C.CLTCODE
AND E.DRCR=C.DRCR
AND E.INST_AMT=C.INST_AMT
AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END 
END


SELECT UPLOADID ,VNO,VTYP,BOOKTYPE INTO #DUPLICATE_CMS_DATA
FROM #CMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE C
	SET	MATCHEDFLAG =0
		,MODIFIEDDATE = ''
		,C.VNO = ''
		,C.VTYP = ''
		,C.BOOKTYPE = ''
		,C.MATCHCODE=''
		,CLTCODE=''
	FROM #CMS_DATA C 
	, #DUPLICATE_CMS_DATA L 
	WHERE C.VNO = L.VNO
	AND C.VTYP = L.VTYP		
	AND C.BOOKTYPE = L.BOOKTYPE	
	AND C.UPLOADID=L.UPLOADID


IF @REPROCESS_FLAG <> 'R' 
BEGIN
SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0) FROM BANKRECO(NOLOCK)				
				
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
, MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY 
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM #CMS_DATA
	
UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO --UPLOADSTATUS
FROM #CMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #CMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
	
END 
ELSE 
BEGIN

UPDATE RECON_CMS_DATA
SET	VNO = C.VNO
	,VTYP = C.VTYP
	,BOOKTYPE = C.BOOKTYPE
	,MATCHEDFLAG = C.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = C.MODIFIEDDATE
	,MATCHCODE=C.MATCHCODE
	,CLTCODE=C.CLTCODE
FROM #CMS_DATA C, RECON_CMS_DATA R
WHERE C.UPLOADSTATUS = R.CROSS_NO
AND C.MATCHEDFLAG = 1

UPDATE B SET STATUS =CASE WHEN BR.MATCHEDFLAG = 1 THEN 'MATCHED' ELSE 'UNMATCHED' END
			FROM #CMS_DATA BR, BANKRECO B
			WHERE BANKCODE = B.CLTCODE
			AND B.CROSSREFERENCENO = BR.UPLOADSTATUS

UPDATE L1 SET RELDT = VALUEDATE	,REFNO = UPLOADSTATUS
			FROM #CMS_DATA N , LEDGER1 L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1 SET EDT = VALUEDATE
			FROM #CMS_DATA N, LEDGER L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE
			AND EDT LIKE 'DEC 31 2049%'
			
END


SELECT	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD>=1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE
DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END


IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO @TEMPBANKACCOUNTMASTER
	SELECT DISTINCT	BANKACCOUNT	FROM RECON_BANK_MASTER_VW WHERE BANKNAME=@BANKNAME AND FILEFORMATE=0 AND FILETYPE=@FILETYPE

INSERT INTO @TEMPBANKACCOUNT
SELECT  DISTINCT BANKACCOUNT  FROM @TEMPBANKACCOUNTMASTER BM,#CMS_DATA T
WHERE LTRIM(RTRIM(T.ROWTYPE))= BM.BANKACCOUNT AND UPLOADID=@UPLOADID

WHILE (SELECT		COUNT(*)	FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE
FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT AND BANKNAME =@BANKNAME

SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_CMS_DATA (UPLOADID,
BANKCODE,
ROWTYPE,
VALUEDATE,
DRCR,
INST_NO_CHECK,
INST_AMT,
DRAWER_NAME,
CLTCODE,
CLTACCNO,
VNO,
VTYP,
BOOKTYPE,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY,
CROSS_NO,
MATCHCODE)
										SELECT UPLOADID
										, "+@BANKCODE+"
										, ROWTYPE
										, VALUEDATE
										, DRCR
										, INST_NO_CHECK
										, INST_AMT
										, DRAWER_NAME
										, CLTCODE
										, CLTACCNO
										, VNO
										, VTYP
										, BOOKTYPE
										, MATCHEDFLAG
										, UPLOADSTATUS
										, UPLOADEDDATE
										, MODIFIEDDATE
										, UPLOADBY
										, 0
										, 0
										FROM   #CMS_DATA WHERE ROWTYPE='" + @BANKACCOUNT + "'"

EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "'" + ",'" + @SEGMENT + "'"

EXEC (@@SQL)
--PRINT @@SQL

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_CMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)
END
SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #CMS_DATA
WHERE ROWTYPE = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END
SELECT	@TOTALFILERECORD = COUNT(*)
FROM RECON_CMS_DATA
WHERE UPLOADID = @UPLOADID

END


IF @REPROCESS_FLAG <> 'R' 
BEGIN
IF (@COMBINEFILE<>'0')
BEGIN
/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS
	SET	FILEUPLOAD_EDATE = GETDATE(),VALUEDATE = @VALUEDATE
	WHERE UPLOADID = @UPLOADID

END

END

DROP TABLE #CMS_DATA

END 
ELSE 
IF (@FILETYPE = 'NON-CMS' OR @FILETYPE = 'TECHPROCESS') 
BEGIN

CREATE TABLE #NONCMS_DATA(SRNONCMS INT IDENTITY (1, 1) NOT NULL
, UPLOADID NVARCHAR(50)
, BANKACCOUNT NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, DESCRIPTION NVARCHAR(150)
, LEDGERBALANCE NVARCHAR(50)
, DRCR NVARCHAR(50)
, AMT DECIMAL(20, 2)
, VALUEDATE NVARCHAR(50)
, REFERENCENO NVARCHAR(50)
, CLTACCOUNT NVARCHAR(50)
, CUSTOMERREFERENCE NVARCHAR(300) NULL
, TRANSACTIONDETAIL NVARCHAR(800) NULL
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE DATETIME
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50)
, CLOSINGBALANCE DECIMAL(20,2))

CREATE TABLE #LEDGER_TO_MAP_NON(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_HDFC(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)



CREATE TABLE #NONCMS_DATA_DUPLICATE(SRNONCMS INT
, UPLOADID NVARCHAR(50)
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3))

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_NONCMS_HDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME

IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS') EXEC CLS_RECON_NONCMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_NONCMS_KOTAK_PROCESS @UPLOADID ,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') EXEC CLS_RECON_NONCMS_SCB_PROCESS	@UPLOADID ,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_NONCMS_IDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME	

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_NONCMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME

IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_NONCMS_YES_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS') EXEC CLS_RECON_TECHPROCESS_ICICI_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'INDUSIND BANK') EXEC CLS_RECON_NONCMS_INDUSIND_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'AXIS BANK') EXEC CLS_RECON_NONCMS_AXIS_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME


PRINT 'PROCESS NON CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #NONCMS_DATA
	SELECT		
		UPLOADID
		,BANKACCOUNT
		,BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		,CLOSINGBALANCE
		
	FROM RECON_NONCMS_DATA(NOLOCK) C
	WHERE C.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND C.MATCHEDFLAG = 0
	AND C.BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=C.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND LedgerBalance<>'DR'
END

ALTER TABLE #NONCMS_DATA
ADD  MATCHCODE INT


IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END
IF(@COMBINEFILE<>0) 
BEGIN
	IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END

INSERT INTO #LEDGER_TO_MAP_NON
	SELECT
		MAX(VNO)
		,MAX(VTYP)
		,MAX(BOOKTYPE)
		,MAX(CLTCODE)
		,DDNO
		,RELAMT
		,DRCR
		,Edt
		,Vdt
		,NARRATION
	FROM #LEDGER_TO_MAP_NON_HDFC
	GROUP BY	DDNO
				,RELAMT
				,DRCR
				,EDT
				,VDT
				,NARRATION
	HAVING COUNT(1) = 1

IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

	DELETE FROM T
	FROM #NONCMS_DATA T ,RECON_NONCMS_DATA R
	WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
	AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
	AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
	AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
	AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
	AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
	AND R.LEDGERBALANCE <>'DR'

END
	
	IF EXISTS(SELECT * FROM  #NONCMS_DATA)
	BEGIN	
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)	
	END
	ELSE
	BEGIN
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
	END
	SELECT @VALUEDATE =MAX(CONVERT(DATETIME, VALUEDATE, 105)) FROM #NONCMS_DATA 				
	
	SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)FROM BANKRECO(NOLOCK)

IF(@BANKNAME<>'INDUSIND BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) <= 15

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE	
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) > 15

--HDFC BANK FOR CLTACCOUNT
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
--, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE=.DBO.PIECE(REPLACE(DESCRIPTION,' ','|'),'|',2)
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)

AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

--HDFC BANK FOR CLTCODE
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
WHERE L.CLTCODE=RTRIM(LTRIM(SUBSTRING(DESCRIPTION,CHARINDEX('Angel to',DESCRIPTION )+8,len(DESCRIPTION))))
AND Description LIKE '%Angel to%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0
END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='YES BANK')
BEGIN

INSERT INTO #LEDGER_TO_MAP_NON_YES
SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION FROM 
#LEDGER_TO_MAP_NON  WHERE NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION 
HAVING COUNT(*)=1

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=5
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE DESCRIPTION LIKE'%NEFT-RETURN-%'
AND NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='AXIS BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE = .dbo.piece(N.DESCRIPTION,'/',5)
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='KOTAK BANK')
BEGIN


UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0


END

IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE '%ATOM %')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = SUBSTRING(REPLACE(DESCRIPTION,'ATOM ',''),0,CHARINDEX(' ',REPLACE(DESCRIPTION,'ATOM ',''))) 
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND MATCHEDFLAG=0
AND DESCRIPTION LIKE '%ATOM %'
AND N.MATCHEDFLAG=0


END
/*COMPARE WITH ENCRYPTION FILE */
IF(@FILETYPE='NON-CMS' AND @BANKNAME='HDFC BANK')
BEGIN

UPDATE N
SET MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = T.VNO
	,N.VTYP = T.VTYP
	,N.BOOKTYPE = T.BOOKTYPE
	,N.MATCHCODE=4
	,N.CUSTOMERREFERENCE=T.CLTCODE
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND T.DDNO<>''
AND N.AMT = T.RELAMT
AND N.MATCHEDFLAG=0

UPDATE E
SET MATCH_STATUS = 1,CROSS_NO=@@CROSS_NO + SRNONCMS
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND N.AMT = T.RELAMT
--AND E.MATCH_STATUS = 0

END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='INDUSIND BANK')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND MATCHEDFLAG=0


END

INSERT INTO #NONCMS_DATA_DUPLICATE (UPLOADID ,VNO,VTYP,BOOKTYPE)
SELECT UPLOADID ,VNO,VTYP,BOOKTYPE FROM #NONCMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE N SET MATCHEDFLAG = 0
			,MODIFIEDDATE = ''
			,N.VNO = ''
			,N.VTYP = ''
			,N.BOOKTYPE = ''
			,N.MATCHCODE = ''
			FROM #NONCMS_DATA N	,#NONCMS_DATA_DUPLICATE ND
			WHERE N.VNO=ND.VNO
			AND N.VTYP=ND.VTYP
			AND N.BOOKTYPE=ND.BOOKTYPE
			AND N.UPLOADID=ND.UPLOADID
			
IF (@REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE]
, CLOSINGBALANCE)
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,@@CROSS_NO + SRNONCMS
		,MATCHCODE
		,CLOSINGBALANCE
	FROM #NONCMS_DATA

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = @@CROSS_NO + SRNONCMS--UPLOADSTATUS
FROM #NONCMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'	
	
END 

IF (@REPROCESS_FLAG = 'R') 
BEGIN
UPDATE B
SET	VNO = NR.VNO
	,VTYP = NR.VTYP
	,BOOKTYPE = NR.BOOKTYPE
	,MATCHEDFLAG = NR.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = NR.MODIFIEDDATE
	,MATCHCODE = NR.MATCHCODE
	,CUSTOMERREFERENCE=NR.CUSTOMERREFERENCE
FROM #NONCMS_DATA NR, RECON_NONCMS_DATA B
WHERE b.BANKCODE = @BANKCODE
AND NR.UPLOADSTATUS = B.CROSS_NO
AND NR.MATCHEDFLAG = 1


UPDATE B
SET STATUS =CASE WHEN MATCHEDFLAG = 1 THEN 'MATCHED'	ELSE 'UNMATCHED' END
FROM #NONCMS_DATA NR,BANKRECO B
WHERE B.CLTCODE=@BANKCODE
AND BANKCODE = CLTCODE
AND NR.UPLOADSTATUS = B.CROSSREFERENCENO

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = N.UPLOADSTATUS
FROM #NONCMS_DATA N, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'

END


SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA(NOLOCK)

IF (@TOTALFILERECORD>0) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE

DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID


END

IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN

INSERT INTO @TEMPBANKACCOUNT
	SELECT DISTINCT
		BANKACCOUNT
	FROM #NONCMS_DATA
DELETE FROM  @TEMPBANKACCOUNT WHERE BANKACCOUNT IS NULL
WHILE (SELECT COUNT(*)FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

IF(@FILETYPE<>'TECHPROCESS')
SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT

IF(@FILETYPE='TECHPROCESS')

SELECT	@SEGMENT = RT.SEGMENT
,@BANKCODE = RB.BANKCODE FROM RECON_BANK_MASTER_VW RB(NOLOCK),RECON_TECH_PROCESS_MASTER_VW RT(NOLOCK)
WHERE  RB.SEGMENT=RT.SEGMENT AND  RB.FILETYPE=@FILETYPE AND RB.BANKNAME=@BANKNAME 
AND RT.ACCOUNTTYPE=@BANKACCOUNT


SELECT
	@@ACCOUNTDB = ACCOUNTDB
	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_NONCMS_DATA (UPLOADID
	,BANKACCOUNT
	,BANKCODE
	,DESCRIPTION
	,LEDGERBALANCE
	,DRCR
	,AMT
	,VALUEDATE
	,REFERENCENO
	,CLTACCOUNT
	,CUSTOMERREFERENCE
	,TRANSACTIONDETAIL
	,VNO
	,VTYP
	,BOOKTYPE
	,MATCHEDFLAG
	,UPLOADSTATUS
	,UPLOADEDDATE
	,MODIFIEDDATE
	,UPLOADBY
	,BOOKDATE
	,CROSS_NO
	,MATCHCODE
	,CLOSINGBALANCE) 
	SELECT UPLOADID
	 , BANKACCOUNT
	 , "+@BANKCODE+"
	 , DESCRIPTION
	 , LEDGERBALANCE
	 , DRCR
	 , AMT
	 , VALUEDATE
	 , REFERENCENO
	 , CLTACCOUNT
	 , CUSTOMERREFERENCE
	 , TRANSACTIONDETAIL
	 , VNO
	 , VTYP
	 , BOOKTYPE
	 , MATCHEDFLAG
	 , UPLOADSTATUS
	 , UPLOADEDDATE 
	 , MODIFIEDDATE
	 , UPLOADBY
	 , VALUEDATE
	 ,0
	 ,0
	 ,CLOSINGBALANCE
	FROM   #NONCMS_DATA  WHERE  BANKACCOUNT='" + @BANKACCOUNT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "','" + @BANKNAME + "'" + ",'" + @FILETYPE + "'" + ",'" + @SEGMENT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_NONCMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)

END

SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #NONCMS_DATA
WHERE BANKACCOUNT = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END

SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD >1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
END



/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */
IF (@COMBINEFILE<>'0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CAST(CROSS_NO AS NVARCHAR(20))
		,CASE WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'	ELSE 'UNMATCHED' END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR ,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2
	AND   CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE	AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1
	AND UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS 
	SET FILEUPLOAD_EDATE=GETDATE(),VALUEDATE=@VALUEDATE  WHERE UPLOADID=@UPLOADID

	END
	DROP TABLE #NONCMS_DATA


END 
ELSE 
BEGIN
PRINT 'PLEASE CHECK SUPPLY PARAMETERS'
DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
END


IF @REPROCESS_FLAG <> 'R'
BEGIN

	IF NOT EXISTS(SELECT * FROM EXISTS_RECORDS_VW WHERE RECORDSTATUS=0 AND UPLOADID=@UPLOADID )
	BEGIN	
	SELECT 'UPLOADED RECORDS ALREADY EXISTS'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END
	ELSE
	BEGIN
	SELECT 'FILE UPLOAD SUCCESSFULLY'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END

END
ELSE
BEGIN
		SELECT 'REPROCESS SUCCESSFULLY'
END

DELETE FROM EXISTS_RECORDS WHERE UPLOADID=@UPLOADID

DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID

--DELETE FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
END TRY
BEGIN CATCH

SELECT 'ERROR :LINE ' + CONVERT (NVARCHAR(50) ,ERROR_LINE())+ ' MESSAGE: '+ERROR_MESSAGE()

END CATCH
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT
-- --------------------------------------------------





CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT]
		(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

BEGIN         
IF @FILETYPE='0'
SET @FILETYPE=''

DECLARE @CMS_MATCHBY NVARCHAR(100),
@NONCMS_MATCHBY NVARCHAR(35)

SET @CMS_MATCHBY='CHQNO+AMT+DRCR+CLTCODE+ACCNO'
SET @NONCMS_MATCHBY='CHQNO + AMT'

			CREATE TABLE #TEMP_DATA
			(
			CROSSREFNO VARCHAR(12)			
			,FINAL_DT  VARCHAR(25)
			,VNO VARCHAR(12)
			,VTYP INT
			,BOOKTYPE VARCHAR(3)
			,BANKCODE NVARCHAR(20)
			)

			IF(@MATCHEDFLAG='D')
			BEGIN
			INSERT INTO #TEMP_DATA
			SELECT
			.DBO.CLS_PIECE(ITEMS, '^', 1)
			,.DBO.CLS_PIECE(ITEMS, '^', 2)
			,''
			,''
			,''
			,.DBO.CLS_PIECE(ITEMS, '^', 3)
			FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
			WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''

			UPDATE T
			SET	T.VNO = L1.VNO
			,T.VTYP = L1.VTYP
			,T.BOOKTYPE = L1.BOOKTYPE
			FROM #TEMP_DATA T, LEDGER1 L1
			WHERE L1.REFNO = T.CROSSREFNO

			END

			CREATE TABLE #TEMP_REPORT
			(
			ROWID     INT          NOT NULL  IDENTITY(1,1)
			, FILEUPLOADID        NVARCHAR(50)
			, UPLOADDATE          DATETIME							
			, VALUEDATE           DATETIME
			, SDATE				  DATETIME
			, EDATE				  DATETIME
			, MATCHEDDATE		  DATETIME
			, SEGMENT             NVARCHAR(50)
			, BANK                NVARCHAR(50)
			, ARRANGEMENTTYPE     NVARCHAR(50)
			, BANKCODE            NVARCHAR(50)
			, BANKACCOUNT         NVARCHAR(50)
			, ACCOUNTNO           NVARCHAR(70)
			, NARRATION           NVARCHAR(MAX)
			, CHEQUENO            NVARCHAR(50)
			, DRCR                NVARCHAR(5)
			, BANKSTATEMENTAMOUNT MONEY
			, VOUCHERAMOUNT       MONEY
			, BANKLOCATION        NVARCHAR(50)
			, ANGELLOCATION       NVARCHAR(50)
			, CLIENTCODE          NVARCHAR(50)
			, CLIENTNAME          NVARCHAR(50)
			, STATUS              NVARCHAR(50)
			, CROSSREFNO          NVARCHAR(50)
			, VOUCHERNO           NVARCHAR(50)
			, MATCHEDBY           NVARCHAR(100)
			, VOUCHERDATE         DATETIME
			, DEPOSITDATE         DATETIME
			, MATCHEDFLAG         BIT
			, VNO                 VARCHAR(15)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, TRAN_STATUS         VARCHAR(12)
			, REPORT_FLAG		  NVARCHAR(100)
			, USERNAME			  NVARCHAR(100)
			--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)
			)
						

			CREATE TABLE #LEDGER_TO_MAP
			(
			VNO                 VARCHAR(12)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, CLTCODE             VARCHAR(10)
			, DDNO                VARCHAR(30)
			, RELAMT              MONEY
			, DRCR                CHAR(1)
			, BANKSTATEMENTAMOUNT MONEY
			, NARRATION           NVARCHAR(250)
			, CLIENTNAME          NVARCHAR(100)
			, VOUCHERNO           NVARCHAR(15)
			, VOUCHERDATE         DATETIME
			)
				
			IF(@FILETYPE ='NON-CMS' OR @FILETYPE='TECHPROCESS' OR @FILETYPE='' OR @FILETYPE='BILLDESK')
			BEGIN			
					INSERT INTO #TEMP_REPORT
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE 
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,RC.BANKACCOUNT
						,RC.CLTACCOUNT
						,DESCRIPTION AS NARRATION
						,REFERENCENO AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.LEDGERBALANCE AS REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_NONCMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
					ON RC.UPLOADID = RBL.UPLOADID
					AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END										
					LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
					ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105)
                                                AND CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.LEDGERBALANCE<>'DR'
					
			END
				IF(@FILETYPE ='CMS' OR @FILETYPE='')
				BEGIN
				
					INSERT INTO #TEMP_REPORT				
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,'' AS BANKACCOUNT
						,RC.CLTACCNO
						,'' AS NARRATION
						,RC.INST_NO_CHECK AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,INST_AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.ROWTYPE  REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_CMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
						ON RC.UPLOADID = RBL.UPLOADID
						AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END						
						LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
							ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN CONVERT(DATETIME, @FROM_DATE, 105)	AND		CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.ROWTYPE<>'DR'
					
					
				END
				
				SELECT @BANKCODE=F.BANKCODE 
				FROM RECON_BANK_FILEUPLOAD_LOGS F(NOLOCK),#TEMP_REPORT T
				WHERE F.UPLOADID=T.FILEUPLOADID 
				AND F.BANKNAME=@BANKNAME AND F.SEGMENT= @SEGMENT AND F.FILETYPE=@FILETYPE

IF(@MATCHEDFLAG='R' AND @PARAM_VAL1='')
BEGIN
	
		IF(@MATCHEDFLAG='R')
		BEGIN
		
			SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, BANKACCOUNT
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS
							, REPORT_FLAG
							,''
							,''
							,''
							,'' 
							,USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG<>'DR'
			         
		END
		
END
IF (@MATCHEDFLAG = 'D')
BEGIN 


				IF(@BULKDELETE='BULK')
				BEGIN
				
			ALTER TABLE #TEMP_REPORT
			ADD UPLOADFILENAME VARCHAR(100) ,			
			 UPLOADSTATUS VARCHAR(50) ,			
			 FILEUPLOAD_SDATE VARCHAR(100),		
			 FILEUPLOAD_EDATE VARCHAR(100)


				UPDATE TR SET UPLOADFILENAME=RL.UPLOADFILENAME,UPLOADSTATUS=RL.UPLOADSTATUS
				,FILEUPLOAD_SDATE=RL.FILEUPLOAD_SDATE,FILEUPLOAD_EDATE=RL.FILEUPLOAD_EDATE
				FROM RECON_BANK_FILEUPLOAD_LOGS RL,#TEMP_REPORT TR
				WHERE TR.FILEUPLOADID = RL.UPLOADID
				AND RL.FILETYPE=@FILETYPE
				AND RL.BANKNAME=@BANKNAME
				AND( RL.SEGMENT=@SEGMENT OR @SEGMENT='')
				
				
				SELECT 
				ISNULL(FILEUPLOADID, '') AS UPLOADID
				,ISNULL(SEGMENT,'') AS SEGMENT
				,ISNULL(BANK,'') AS 'BANKNAME'
				,ISNULL(BANKACCOUNT,'') AS BANKACCOUNT 
				,ISNULL(ARRANGEMENTTYPE,'') AS FILETYPE
				,CONVERT(VARCHAR(10), ISNULL(VALUEDATE,''), 105) VALUEDATE --R.VALUEDATE
				,ISNULL(UPLOADFILENAME,'') AS UPLOADFILENAME
				,ISNULL(UPLOADSTATUS,'') AS UPLOADSTATUS
				,MIN(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_SDATE,''), 120)) FILEUPLOAD_SDATE
				,MAX(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_EDATE,''), 120)) FILEUPLOAD_EDATE
				FROM #TEMP_REPORT
				WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			
				GROUP BY ISNULL(FILEUPLOADID, ''),ISNULL(SEGMENT,''),ISNULL(BANK,''),ISNULL(BANKACCOUNT,''),ISNULL(ARRANGEMENTTYPE,''),ISNULL(VALUEDATE,'')
				,ISNULL(UPLOADFILENAME,''),ISNULL(UPLOADSTATUS,''),ISNULL(FILEUPLOAD_SDATE,''),ISNULL(FILEUPLOAD_EDATE,'')

					SELECT
					FILEUPLOADID
					,CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
					,EDATE UPLOADENDDATE
					,CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
					--, SDATE
					,MATCHEDDATE
					,SEGMENT
					,BANK
					,ARRANGEMENTTYPE
					,BANKCODE
					,ACCOUNTNO
					,NARRATION
					,CHEQUENO
					,DRCR
					,BANKSTATEMENTAMOUNT
					,VOUCHERAMOUNT
					,BANKLOCATION
					,ANGELLOCATION
					,CLIENTCODE
					,CLIENTNAME
					,STATUS
					,CROSSREFNO
					,VOUCHERNO
					,MATCHEDBY
					,VOUCHERDATE
					,DEPOSITDATE
					,MATCHEDFLAG
					,VNO
					,VTYP
					,BOOKTYPE
					,TRAN_STATUS
					,USERNAME
				FROM #TEMP_REPORT WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			

				END
			ELSE			
				BEGIN			
							SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS 
							, USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG <>'DR'
							 AND MATCHEDFLAG=0
							 AND (SEGMENT=@SEGMENT OR @SEGMENT='')
							 AND (ARRANGEMENTTYPE=@FILETYPE OR @FILETYPE='')
							 AND (BANK =@BANKNAME OR @BANKNAME='')
							 

		
		IF(@PARAM_VAL1<>'')
		BEGIN
	BEGIN TRY

	BEGIN TRAN
		/*******BANK RECO DELETE************/
		DELETE B
		FROM BANKRECO B, #TEMP_DATA T	WHERE B.CROSSREFERENCENO = T.CROSSREFNO	
		AND B.VALUEDATE=T.FINAL_DT 
		AND B.CLTCODE=T.BANKCODE	
		
				

		IF(@FILETYPE='CMS')
		BEGIN
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
			, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
			, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)

			SELECT UPLOADID,'',C.BANKCODE,'','CMS '+@BANKNAME,'','',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY
			,'','',VALUEDATE,ROWTYPE,DRCR,INST_NO_CHECK,INST_AMT,DRAWER_NAME,CLTCODE,CLTACCNO,C.VNO
			,C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,'','','',
			'',@LOGINNAME,GETDATE(),'','','' 
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.Valuedate=T.FINAL_DT
			
		
			UPDATE C 
			SET ROWTYPE='DR'
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
		END

		IF(@FILETYPE='NON-CMS' OR @FILETYPE='TECHPROCESS' OR  @FILETYPE='BILLDESK')
		BEGIN
		INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
		, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
		, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
		, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)
		SELECT UPLOADID,'',C.BANKCODE,'','NONCMS '+@BANKNAME,BANKACCOUNT,'',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,
		'','',VALUEDATE,'',DRCR,REFERENCENO,AMT,'','',CLTACCOUNT,C.VNO,
		C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,DESCRIPTION,LEDGERBALANCE,CUSTOMERREFERENCE,
		TRANSACTIONDETAIL,@LOGINNAME,GETDATE(),'','',''
		FROM RECON_NONCMS_DATA C,#TEMP_DATA T
		WHERE C.CROSS_NO=T.CROSSREFNO
		AND C.BANKCODE=T.BANKCODE
		AND C.ValueDate=T.FINAL_DT
			
			UPDATE C 
			SET LEDGERBALANCE='DR'
			FROM RECON_NONCMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
			
			UPDATE E
			SET MATCH_STATUS = 0
			FROM RECON_ENCRYPTION_DETAILS E, #TEMP_DATA T
			WHERE E.CROSS_NO = T.CROSSREFNO
			
		END

		COMMIT

END TRY

BEGIN CATCH

	ROLLBACK

END CATCH
		END
		---
		END
		
END

	DROP TABLE #TEMP_DATA
	DROP TABLE #TEMP_REPORT
	DROP TABLE #LEDGER_TO_MAP
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT_FEB082017
-- --------------------------------------------------


CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT_FEB082017]
		(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS


--SET @FROM_DATE = '01/05/2016'
--SET @TO_DATE = '01/07/2016'
--SET @BANKCODE = '0101'--'02020'
--SET @MATCHEDFLAG = 'D'
--SET @FILETYPE = 'CMS'
--SET @BANKNAME = 'HDFC BANK'
--SET @SEGMENT = 'NSE-CAPITAL'
--SET @PARAM_VAL1='23914^11/07/2013|23914^11/09/2014|'

BEGIN         

DECLARE @CMS_MATCHBY NVARCHAR(100),
@NONCMS_MATCHBY NVARCHAR(35)

SET @CMS_MATCHBY='CHQNO+AMT+DRCR+CLTCODE+ACCNO'
SET @NONCMS_MATCHBY='CHQNO + AMT'

			CREATE TABLE #TEMP_DATA
			(
			CROSSREFNO VARCHAR(12)			
			,FINAL_DT  VARCHAR(25)
			,VNO VARCHAR(12)
			,VTYP INT
			,BOOKTYPE VARCHAR(3)
			,BANKCODE NVARCHAR(20)
			)

			IF(@MATCHEDFLAG='D')
			BEGIN
			INSERT INTO #TEMP_DATA
			SELECT
			.DBO.CLS_PIECE(ITEMS, '^', 1)
			,.DBO.CLS_PIECE(ITEMS, '^', 2)
			,''
			,''
			,''
			,.DBO.CLS_PIECE(ITEMS, '^', 3)
			FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
			WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''

			UPDATE T
			SET	T.VNO = L1.VNO
			,T.VTYP = L1.VTYP
			,T.BOOKTYPE = L1.BOOKTYPE
			FROM #TEMP_DATA T, LEDGER1 L1
			WHERE L1.REFNO = T.CROSSREFNO

			END

          CREATE TABLE #TEMP_REPORT
                    (
							ROWID     INT          NOT NULL  IDENTITY(1,1)
                            , FILEUPLOADID        NVARCHAR(50)
                            , UPLOADDATE          DATETIME							
							, VALUEDATE           DATETIME
							, SDATE				  DATETIME
							, EDATE				  DATETIME
							, MATCHEDDATE		  DATETIME
                            , SEGMENT             NVARCHAR(50)
                            , BANK                NVARCHAR(50)
                            , ARRANGEMENTTYPE     NVARCHAR(50)
                            , BANKCODE            NVARCHAR(50)
                            , BANKACCOUNT         NVARCHAR(50)
                            , ACCOUNTNO           NVARCHAR(70)
                            , NARRATION           NVARCHAR(MAX)
                            , CHEQUENO            NVARCHAR(50)
                            , DRCR                NVARCHAR(5)
                            , BANKSTATEMENTAMOUNT MONEY
                            , VOUCHERAMOUNT       MONEY
                            , BANKLOCATION        NVARCHAR(50)
                            , ANGELLOCATION       NVARCHAR(50)
                            , CLIENTCODE          NVARCHAR(50)
                            , CLIENTNAME          NVARCHAR(50)
                            , STATUS              NVARCHAR(50)
                            , CROSSREFNO          NVARCHAR(50)
                            , VOUCHERNO           NVARCHAR(50)
                            , MATCHEDBY           NVARCHAR(100)
                            , VOUCHERDATE         DATETIME
                            , DEPOSITDATE         DATETIME
                            , MATCHEDFLAG         BIT
                            , VNO                 VARCHAR(15)
                            , VTYP                INT
                            , BOOKTYPE            VARCHAR(3)
							, TRAN_STATUS         VARCHAR(12)
							, REPORT_FLAG		  NVARCHAR(100)
							, USERNAME			  NVARCHAR(100)
							--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)							
                    )
						

					CREATE TABLE #LEDGER_TO_MAP
                    (
                              VNO                 VARCHAR(12)
                            , VTYP                INT
                            , BOOKTYPE            VARCHAR(3)
                            , CLTCODE             VARCHAR(10)
                            , DDNO                VARCHAR(30)
                            , RELAMT              MONEY
                            , DRCR                CHAR(1)
                            , BANKSTATEMENTAMOUNT MONEY
                            , NARRATION           NVARCHAR(250)
                            , CLIENTNAME          NVARCHAR(100)
                            , VOUCHERNO           NVARCHAR(15)
                            , VOUCHERDATE         DATETIME
                    )
				

					INSERT INTO #TEMP_REPORT
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE 
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,RC.BANKACCOUNT
						,RC.CLTACCOUNT
						,DESCRIPTION AS NARRATION
						,REFERENCENO AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.LEDGERBALANCE AS REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_NONCMS_DATA(NOLOCK) RC
					LEFT OUTER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
					ON RC.UPLOADID = RBL.UPLOADID
					LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
					ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105)
                                                AND
                                                CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.LEDGERBALANCE<>'DR'
				
					INSERT INTO #TEMP_REPORT				
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,'' AS BANKACCOUNT
						,RC.CLTACCNO
						,'' AS NARRATION
						,RC.INST_NO_CHECK AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,INST_AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.ROWTYPE  REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_CMS_DATA(NOLOCK) RC
					LEFT OUTER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
						ON RC.UPLOADID = RBL.UPLOADID
						LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
							ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN CONVERT(DATETIME, @FROM_DATE, 105)
					AND
					CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.ROWTYPE<>'DR'

				SELECT @BANKCODE=F.BANKCODE 
				FROM RECON_BANK_FILEUPLOAD_LOGS F(NOLOCK),#TEMP_REPORT T
				WHERE F.UPLOADID=T.FILEUPLOADID 
				AND F.BANKNAME=@BANKNAME AND F.SEGMENT= @SEGMENT AND F.FILETYPE=@FILETYPE

IF(@MATCHEDFLAG='R' AND @PARAM_VAL1='')
BEGIN
	
		IF(@MATCHEDFLAG='R')
		BEGIN
		
			SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, BANKACCOUNT
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS
							, REPORT_FLAG
							,''
							,''
							,''
							,'' 
							,USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG<>'DR'
			         
		END
		
END
IF (@MATCHEDFLAG = 'D')
BEGIN 


				IF(@BULKDELETE='BULK')
				BEGIN
				
			ALTER TABLE #TEMP_REPORT
			ADD UPLOADFILENAME VARCHAR(100) ,			
			 UPLOADSTATUS VARCHAR(50) ,			
			 FILEUPLOAD_SDATE VARCHAR(100),		
			 FILEUPLOAD_EDATE VARCHAR(100)


				UPDATE TR SET UPLOADFILENAME=RL.UPLOADFILENAME,UPLOADSTATUS=RL.UPLOADSTATUS
				,FILEUPLOAD_SDATE=RL.FILEUPLOAD_SDATE,FILEUPLOAD_EDATE=RL.FILEUPLOAD_EDATE
				FROM RECON_BANK_FILEUPLOAD_LOGS RL,#TEMP_REPORT TR
				WHERE TR.FILEUPLOADID = RL.UPLOADID
				AND RL.FILETYPE=@FILETYPE
				AND RL.BANKNAME=@BANKNAME
				AND( RL.SEGMENT=@SEGMENT OR @SEGMENT='')
				
				
				SELECT 
				ISNULL(FILEUPLOADID, '') AS UPLOADID
				,ISNULL(SEGMENT,'') AS SEGMENT
				,ISNULL(BANK,'') AS 'BANKNAME'
				,ISNULL(BANKACCOUNT,'') AS BANKACCOUNT 
				,ISNULL(ARRANGEMENTTYPE,'') AS FILETYPE
				,CONVERT(VARCHAR(10), ISNULL(VALUEDATE,''), 105) VALUEDATE --R.VALUEDATE
				,ISNULL(UPLOADFILENAME,'') AS UPLOADFILENAME
				,ISNULL(UPLOADSTATUS,'') AS UPLOADSTATUS
				,MIN(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_SDATE,''), 120)) FILEUPLOAD_SDATE
				,MAX(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_EDATE,''), 120)) FILEUPLOAD_EDATE
				FROM #TEMP_REPORT
				WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			
				GROUP BY ISNULL(FILEUPLOADID, ''),ISNULL(SEGMENT,''),ISNULL(BANK,''),ISNULL(BANKACCOUNT,''),ISNULL(ARRANGEMENTTYPE,''),ISNULL(VALUEDATE,'')
				,ISNULL(UPLOADFILENAME,''),ISNULL(UPLOADSTATUS,''),ISNULL(FILEUPLOAD_SDATE,''),ISNULL(FILEUPLOAD_EDATE,'')

					SELECT
					FILEUPLOADID
					,CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
					,EDATE UPLOADENDDATE
					,CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
					--, SDATE
					,MATCHEDDATE
					,SEGMENT
					,BANK
					,ARRANGEMENTTYPE
					,BANKCODE
					,ACCOUNTNO
					,NARRATION
					,CHEQUENO
					,DRCR
					,BANKSTATEMENTAMOUNT
					,VOUCHERAMOUNT
					,BANKLOCATION
					,ANGELLOCATION
					,CLIENTCODE
					,CLIENTNAME
					,STATUS
					,CROSSREFNO
					,VOUCHERNO
					,MATCHEDBY
					,VOUCHERDATE
					,DEPOSITDATE
					,MATCHEDFLAG
					,VNO
					,VTYP
					,BOOKTYPE
					,TRAN_STATUS
					,USERNAME
				FROM #TEMP_REPORT WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			

				END
			ELSE			
				BEGIN			
							SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS 
							, USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG <>'DR'
							 AND MATCHEDFLAG=0
							 AND (SEGMENT=@SEGMENT OR @SEGMENT='')
							 AND (ARRANGEMENTTYPE=@FILETYPE OR @FILETYPE='')
							 AND (BANK =@BANKNAME OR @BANKNAME='')
							 

		
		IF(@PARAM_VAL1<>'')
		BEGIN

		/*******BANK RECO DELETE************/
		DELETE B
		FROM BANKRECO B, #TEMP_DATA T	WHERE B.CROSSREFERENCENO = T.CROSSREFNO	
		AND B.VALUEDATE=T.FINAL_DT 
		AND B.CLTCODE=T.BANKCODE	
		
		--UPDATE L SET RELDT='' ,REFNO=''
		--FROM LEDGER1 L ,#TEMP_DATA T
		--WHERE L.REFNO=T.CROSSREFNO
		--AND L.RELDT=T.FINAL_DT 
		

		IF(@FILETYPE='CMS')
		BEGIN
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
			, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
			, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)

			SELECT UPLOADID,'',C.BANKCODE,'','CMS '+@BANKNAME,'','',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY
			,'','',VALUEDATE,ROWTYPE,DRCR,INST_NO_CHECK,INST_AMT,DRAWER_NAME,CLTCODE,CLTACCNO,C.VNO
			,C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,'','','',
			'',@LOGINNAME,GETDATE(),'','','' 
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.Valuedate=T.FINAL_DT
			
		
			UPDATE C 
			SET ROWTYPE='DR'
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
		END

		IF(@FILETYPE='NON-CMS')
		BEGIN
		INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
		, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
		, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
		, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)
		SELECT UPLOADID,'',C.BANKCODE,'','NONCMS '+@BANKNAME,BANKACCOUNT,'',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,
		'','',VALUEDATE,'',DRCR,REFERENCENO,AMT,'','',CLTACCOUNT,C.VNO,
		C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,DESCRIPTION,LEDGERBALANCE,CUSTOMERREFERENCE,
		TRANSACTIONDETAIL,@LOGINNAME,GETDATE(),'','',''
		FROM RECON_NONCMS_DATA C,#TEMP_DATA T
		WHERE C.CROSS_NO=T.CROSSREFNO
		AND C.BANKCODE=T.BANKCODE
		AND C.ValueDate=T.FINAL_DT
			
			UPDATE C 
			SET LEDGERBALANCE='DR'
			FROM RECON_NONCMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
			
			UPDATE E
			SET MATCH_STATUS = 0
			FROM RECON_ENCRYPTION_DETAILS E, #TEMP_DATA T
			WHERE C.CROSS_NO = T.CROSSREFNO
			
		END
		END
		END
		
END

	DROP TABLE #TEMP_DATA
	DROP TABLE #TEMP_REPORT
	DROP TABLE #LEDGER_TO_MAP
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT_WRAPPER
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT_WRAPPER]
(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE  NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

IF @SEGMENT='0'
SET @SEGMENT = ''
IF (@FILETYPE = 'ALL'  OR @FILETYPE = '0') 
SET @FILETYPE = ''

IF UPPER(@FILETYPE)='ENCRYPTION'
BEGIN 
	SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK)
	WHERE (SEGMENT=@SEGMENT OR @SEGMENT='')
	AND (BANKNAME=@BANKNAME OR @BANKNAME='')
	AND INCRYPTIONDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105) AND CONVERT(DATETIME, @TO_DATE, 105)
	 
END
ELSE
BEGIN
CREATE TABLE #TEMP_REPORT_WRAPPER(ROWID INT NOT NULL IDENTITY (1, 1)
, FILEUPLOADID NVARCHAR(50)
, UPLOADDATE DATETIME
, EDATE DATETIME
, VALUEDATE DATETIME
, MATCHEDDATE DATETIME
--, SDATE				  DATETIME	
, SEGMENT NVARCHAR(50)
, BANK NVARCHAR(50)
, ARRANGEMENTTYPE NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, BANKACCOUNT NVARCHAR(75)
, ACCOUNTNO NVARCHAR(75)
, NARRATION NVARCHAR(MAX)
, CHEQUENO NVARCHAR(70)
, DRCR NVARCHAR(5)
, BANKSTATEMENTAMOUNT MONEY
, VOUCHERAMOUNT MONEY
, BANKLOCATION NVARCHAR(50)
, ANGELLOCATION NVARCHAR(150)
, CLIENTCODE NVARCHAR(50)
, CLIENTNAME NVARCHAR(150)
, STATUS NVARCHAR(50)
, CROSSREFNO NVARCHAR(50)
, VOUCHERNO NVARCHAR(50)
, MATCHEDBY NVARCHAR(250)
, VOUCHERDATE NVARCHAR(50)
, DEPOSITDATE NVARCHAR(50)
, MATCHEDFLAG BIT
, VNO VARCHAR(15)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, TRAN_STATUS VARCHAR(20)
, REPORT_FLAG NVARCHAR(100)
, UPLOADFILENAME NVARCHAR(100)
, UPLOADSTATUS NVARCHAR(15)
, FILEUPLOAD_SDATE DATETIME
, FILEUPLOAD_EDATE DATETIME
, USERNAME NVARCHAR(100)
--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)							
)

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, CLTCODE VARCHAR(10)
, DDNO VARCHAR(30)
, RELAMT MONEY
, DRCR CHAR(1)
, BANKSTATEMENTAMOUNT MONEY
, NARRATION NVARCHAR(250)
, CLIENTNAME NVARCHAR(150)
, VOUCHERNO NVARCHAR(15)
, VOUCHERDATE DATETIME
, SEGMENT VARCHAR(20))

IF @SEGMENT <> '' 
BEGIN


INSERT INTO #TEMP_REPORT_WRAPPER
EXEC [CLS_RECON_MATCH_UNMATCH_REPORT]	@FROM_DATE
										,@TO_DATE
										,@BANKCODE
										,@MATCHEDFLAG
										,@FILETYPE
										,@BANKNAME
										,@SEGMENT
										,@PARAM_VAL1
										,@BULKDELETE
										,@LOGINNAME




UPDATE TRW
SET	UPLOADFILENAME = RL.UPLOADFILENAME
	,UPLOADSTATUS = RL.UPLOADSTATUS
	,FILEUPLOAD_SDATE = RL.FILEUPLOAD_SDATE
	,FILEUPLOAD_EDATE = RL.FILEUPLOAD_EDATE
	,TRW.BANKACCOUNT = RBM.BANKACCOUNT
FROM RECON_BANK_FILEUPLOAD_LOGS RL, #TEMP_REPORT_WRAPPER TRW, RECON_BANK_MASTER_VW RBM
WHERE TRW.FILEUPLOADID = RL.UPLOADID
AND RBM.SEGMENT = RL.SEGMENT
AND RBM.FILETYPE = RL.FILETYPE
AND RBM.BankName = RL.BANKNAME
AND RBM.BANKCODE = RL.BANKCODE
AND (RL.FILETYPE = @FILETYPE OR @FILETYPE = '')
AND (RL.BANKNAME = @BANKNAME OR @BANKNAME = '')
AND (RL.SEGMENT = @SEGMENT OR @SEGMENT = '')

SELECT
	FILEUPLOADID AS UPLOADID
	,MAX(SEGMENT) SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
FROM #TEMP_REPORT_WRAPPER
WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
AND (BANK = @BANKNAME OR @BANKNAME = '')
AND (SEGMENT = @SEGMENT OR @SEGMENT = '')
GROUP BY	FILEUPLOADID
			,SEGMENT
			,BANK
			,BANKACCOUNT
			,ARRANGEMENTTYPE
			,UPLOADFILENAME
			,UPLOADSTATUS

			IF(@BULKDELETE<>'BULK' OR @BULKDELETE<>'SummaryReport' OR @BULKDELETE='')
			BEGIN

					INSERT INTO #LEDGER_TO_MAP
						SELECT
							L.VNO
							,L.VTYP
							,L.BOOKTYPE
							,L.CLTCODE
							,L1.DDNO
							,L1.RELAMT
							,L1.DRCR
							,L1.RELAMT
							,L.NARRATION
							,L.ACNAME
							,L1.VNO
							,L.VDT
							,SEGMENT = @SEGMENT
						FROM	LEDGER L
								,LEDGER1 L1
								,#TEMP_REPORT_WRAPPER T
						WHERE L.VNO = L1.VNO
						AND L.VTYP = L1.VTYP
						AND L.LNO = L1.LNO
						AND L.BOOKTYPE = L1.BOOKTYPE
						AND L1.VNO = T.VNO
						AND L1.VTYP = T.VTYP
						AND L1.BOOKTYPE = T.BOOKTYPE
						AND EXISTS (SELECT VNO	FROM #TEMP_REPORT_WRAPPER L11 
							WHERE L11.VNO = L.VNO
							AND L11.VTYP = L.VTYP
							AND L11.BOOKTYPE = L.BOOKTYPE	
						)

					UPDATE T
					SET	BANKSTATEMENTAMOUNT = T.VOUCHERAMOUNT--L.BANKSTATEMENTAMOUNT
						,CLIENTCODE = L.CLTCODE
						,CLIENTNAME = L.CLIENTNAME
						,VOUCHERNO = L.VOUCHERNO
						,VOUCHERDATE = L.VOUCHERDATE
						,STATUS =CASE WHEN T.MATCHEDFLAG = 1 THEN 'RECONCILED'ELSE 'UNRECONCILED' END
						FROM #TEMP_REPORT_WRAPPER T
						, #LEDGER_TO_MAP L
						WHERE T.VNO = L.VNO
						AND T.VTYP = L.VTYP
						AND T.BOOKTYPE = L.BOOKTYPE
						AND T.DRCR = L.DRCR
						AND T.SEGMENT = L.SEGMENT
				END

	SELECT	* FROM #TEMP_REPORT_WRAPPER RL
	WHERE (RL.ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
	AND (RL.BANK = @BANKNAME OR @BANKNAME = '')
	AND (RL.SEGMENT = @SEGMENT OR @SEGMENT = '')
	ORDER BY CROSSREFNO

	SELECT
	FILEUPLOADID AS UPLOADID
	,MAX(SEGMENT) SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
	,DRCR
	,COUNT(DRCR) AS 'TOTALENTRIES'
	,SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) AS 'RECONCILED'
	,SUM(CASE WHEN MATCHEDFLAG = 0 THEN 1 ELSE 0 END) AS 'UNRECONCILED'
	,(SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) * 100 / COUNT(DRCR)) 'RECONCILED %'
	FROM #TEMP_REPORT_WRAPPER
	WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
	AND (BANK = @BANKNAME OR @BANKNAME = '')
	AND (SEGMENT = @SEGMENT OR @SEGMENT = '')
	GROUP BY	FILEUPLOADID
				,SEGMENT
				,BANK
				,BANKACCOUNT
				,ARRANGEMENTTYPE
				,UPLOADFILENAME
				,UPLOADSTATUS
				,DRCR

END 

ELSE 

BEGIN
		DECLARE @@ACCOUNTSERVER NVARCHAR(100),@@ACCOUNTDB NVARCHAR(100),@@SQL NVARCHAR(MAX),@@SEGMENT  NVARCHAR(50)
		DECLARE  @TEMP_SEGMENT TABLE(SEGMENT NVARCHAR(50), ACCOUNTDB NVARCHAR(100),ACCOUNTSERVER NVARCHAR(100))

		INSERT INTO @TEMP_SEGMENT
		SELECT DISTINCT  L.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
		FROM	RECON_BANK_FILEUPLOAD_LOGS_VW L
		,PRADNYA.DBO.MULTICOMPANY P
		WHERE P.EXCHANGE + '-' + P.SEGMENT = L.SEGMENT
		AND PRIMARYSERVER = 1
		AND  L.SEGMENT    NOT IN ('MCD-FUTURES','NCX-FUTURES','MCX-FUTURES')

			INSERT INTO @TEMP_SEGMENT
			SELECT DISTINCT  P.EXCHANGE + '-' + P.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
			FROM	PRADNYA.DBO.MULTICOMPANY_ALL P
			WHERE  P.SEGMENT LIKE'%MFSS%'
			AND PRIMARYSERVER = 1

		--DELETE FROM @TEMP_SEGMENT WHERE SEGMENT='MCD-FUTURES'
		--SELECT * FROM @TEMP_SEGMENT RETURN
		
WHILE (SELECT	COUNT(*)	FROM @TEMP_SEGMENT) > 0 
	BEGIN
	
		SELECT TOP 1	@@SEGMENT=SEGMENT, @@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM @TEMP_SEGMENT
	
		DECLARE @@REORDCOUNT INT
		SET @@SQL = '' 
		SET @@SQL="SELECT @@REORDCOUNT=COUNT(*) FROM "+@@ACCOUNTSERVER+"."+@@ACCOUNTDB+"."+"[DBO].RECON_BANK_FILEUPLOAD_LOGS 
					WHERE VALUEDATE BETWEEN CONVERT(DATETIME,'" +@FROM_DATE +"',103) AND CONVERT(DATETIME,'"+ @TO_DATE +"',103)AND SEGMENT= '"+@@SEGMENT+"'"
		
		EXEC SP_EXECUTESQL @@SQL, N'@@REORDCOUNT INT OUT', @@REORDCOUNT OUT
		
		PRINT @@SQL
		
		IF(@@REORDCOUNT=0 )
		DELETE FROM @TEMP_SEGMENT WHERE SEGMENT=@@SEGMENT
					
        IF (@@REORDCOUNT>0 )
        BEGIN	
		IF ( (@@ACCOUNTSERVER +( CASE WHEN REPLACE(@@SERVICENAME,'MSSQLSERVER', '') ='' THEN '' ELSE '\'+@@SERVICENAME  END ))<> @@SERVERNAME  )
		BEGIN
		SET @@SQL = ''
		SET @@SQL ="INSERT INTO #TEMP_REPORT_WRAPPER EXEC " 
		+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.CLS_RECON_MATCH_UNMATCH_REPORT '"+ @FROM_DATE + "','" + @TO_DATE + "','" + @BANKCODE+ "','" 
		+ @MATCHEDFLAG + "','" + @FILETYPE + "','" + @BANKNAME + "','" +@@SEGMENT + "','" + @PARAM_VAL1 + "','" +  @BULKDELETE + "','" +  @LOGINNAME + "'"				
		END
	ELSE
		BEGIN
		SET @@SQL = ''
		SET @@SQL ="INSERT INTO #TEMP_REPORT_WRAPPER EXEC " 
		+ @@ACCOUNTDB+ ".DBO.CLS_RECON_MATCH_UNMATCH_REPORT '"+ @FROM_DATE + "','" + @TO_DATE + "','" + @BANKCODE+ "','" 
		+ @MATCHEDFLAG + "','" + @FILETYPE + "','" + @BANKNAME + "','" +@@SEGMENT + "','" + @PARAM_VAL1 + "','" +  @BULKDELETE + "','" +  @LOGINNAME + "'"				
		END
		
		PRINT  @@SQL	
		EXEC (@@SQL)		
		SET @@SQL = ''
		SET @@SQL ="UPDATE TRW SET	UPLOADFILENAME = RL.UPLOADFILENAME
					,UPLOADSTATUS = RL.UPLOADSTATUS
					,FILEUPLOAD_SDATE = RL.FILEUPLOAD_SDATE
					,FILEUPLOAD_EDATE = RL.FILEUPLOAD_EDATE
					,TRW.BANKACCOUNT = RL.BANKACCOUNT FROM "
					 + @@ACCOUNTSERVER + "." + @@ACCOUNTDB	+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS RL, #TEMP_REPORT_WRAPPER TRW
					WHERE TRW.FILEUPLOADID = RL.UPLOADID
					AND TRW.SEGMENT = RL.SEGMENT
					AND TRW.ARRANGEMENTTYPE = RL.FILETYPE
					AND TRW.Bank = RL.BANKNAME
					AND TRW.BANKCODE = RL.BANKCODE"
					--AND (RL.FILETYPE = @FILETYPE OR @FILETYPE='')
					--AND (RL.BANKNAME = @BANKNAME OR @BANKNAME='')
					--AND (RL.SEGMENT = @SEGMENT OR @SEGMENT='')
					EXEC (@@SQL)
					PRINT @@SQL
	

		DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB = @@ACCOUNTDB AND SEGMENT=@@SEGMENT
		END
	END
	
		CREATE CLUSTERED INDEX IDX_VALUEDATE ON #TEMP_REPORT_WRAPPER
		(
		ROWID,
		VALUEDATE
		)
			SELECT
			FILEUPLOADID AS UPLOADID
			,CASE WHEN BANK='STANDARD CHARTERED BANK' THEN '' -- MAX(SEGMENT)
			WHEN BANK='YES BANK' THEN '' ELSE MAX(SEGMENT) END SEGMENT
			--SELECT
			--FILEUPLOADID AS UPLOADID
			--,'' AS SEGMENT --MAX(SEGMENT)
			,BANK AS 'BANKNAME'
			,MAX(BANKACCOUNT)BANKACCOUNT
			,ARRANGEMENTTYPE AS FILETYPE
			,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
			,UPLOADFILENAME
			,UPLOADSTATUS
			,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
			,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
			FROM #TEMP_REPORT_WRAPPER
			WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='') AND (BANK = @BANKNAME OR @BANKNAME='') AND (SEGMENT = @SEGMENT OR @SEGMENT='')
			GROUP BY	FILEUPLOADID
			,BANK
			--,BANKACCOUNT
			,ARRANGEMENTTYPE
			,UPLOADFILENAME
			,UPLOADSTATUS

		IF(@BULKDELETE<>'BULK' OR @BULKDELETE<>'SummaryReport' OR @BULKDELETE='')
		BEGIN

			INSERT INTO @TEMP_SEGMENT
		SELECT DISTINCT  L.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
		FROM	RECON_BANK_FILEUPLOAD_LOGS_VW L
		,PRADNYA.DBO.MULTICOMPANY P
		WHERE P.EXCHANGE + '-' + P.SEGMENT = L.SEGMENT
		AND PRIMARYSERVER = 1

			WHILE (SELECT	COUNT(*)	FROM @TEMP_SEGMENT) > 0 
			BEGIN
			SELECT TOP 1	@@SEGMENT=SEGMENT, @@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM @TEMP_SEGMENT
			
			SET @@SQL = ''
			SET @@SQL ="INSERT INTO #LEDGER_TO_MAP 
			SELECT L.VNO
			,L.VTYP	,L.BOOKTYPE	,L.CLTCODE,L1.DDNO,L1.RELAMT,L1.DRCR,L1.RELAMT,L.NARRATION,L.ACNAME,L1.VNO,L.VDT,'" + @@SEGMENT + "' FROM " 
			+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.LEDGER L ,"
			+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.LEDGER1 L1 ,
			#TEMP_REPORT_WRAPPER T
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.VNO = T.VNO
			AND L1.VTYP = T.VTYP
			AND L1.BOOKTYPE = T.BOOKTYPE
			AND EXISTS (SELECT
			VNO
			FROM #TEMP_REPORT_WRAPPER L11 (NOLOCK)
			WHERE L11.VNO = L.VNO
			AND L11.VTYP = L.VTYP
			AND L11.BOOKTYPE = L.BOOKTYPE			
			) "
			
			EXEC (@@SQL)
			PRINT @@SQL
			
			
			
			DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB = @@ACCOUNTDB AND SEGMENT=@@SEGMENT
			END
             
			CREATE CLUSTERED INDEX IDX_LEDGER_TO_MAP ON #LEDGER_TO_MAP
			(
				SEGMENT
			) 
  
			
			UPDATE T
			SET	BANKSTATEMENTAMOUNT = T.VOUCHERAMOUNT--L.BANKSTATEMENTAMOUNT
			,CLIENTCODE = L.CLTCODE
			,CLIENTNAME = L.CLIENTNAME
			,VOUCHERNO = L.VOUCHERNO
			,VOUCHERDATE = L.VOUCHERDATE
			,STATUS =CASE WHEN T.MATCHEDFLAG = 1 THEN 'RECONCILED' ELSE 'UNRECONCILED' END
			FROM #TEMP_REPORT_WRAPPER T, #LEDGER_TO_MAP L
			WHERE T.VNO = L.VNO
			AND T.VTYP = L.VTYP
			AND T.BOOKTYPE = L.BOOKTYPE
			AND T.DRCR = L.DRCR
			AND T.SEGMENT = L.SEGMENT
			
			
END

	SELECT	* FROM #TEMP_REPORT_WRAPPER RL
	WHERE (RL.ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='')
	AND (RL.BANK = @BANKNAME OR @BANKNAME='')
	AND (RL.SEGMENT = @SEGMENT OR @SEGMENT='')
	ORDER BY CROSSREFNO

SELECT
	FILEUPLOADID AS UPLOADID
	,SEGMENT SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
	,DRCR
	,COUNT(DRCR) AS 'TOTALENTRIES'
	,SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0  END) AS 'RECONCILED'
	,SUM(CASE WHEN MATCHEDFLAG = 0 THEN 1 ELSE 0 END) AS 'UNRECONCILED'
	,(SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) * 100 / COUNT(DRCR)) 'RECONCILED %'
	FROM #TEMP_REPORT_WRAPPER
	WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='')
	AND (BANK = @BANKNAME OR @BANKNAME='')
	AND (SEGMENT = @SEGMENT OR @SEGMENT='')
	GROUP BY	FILEUPLOADID
				,SEGMENT
				,BANK
				,BANKACCOUNT
				,ARRANGEMENTTYPE
				,UPLOADFILENAME
				,UPLOADSTATUS
				,DRCR

END

DROP TABLE #LEDGER_TO_MAP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_MULTIBANK_CMS_INNER_PROCESS]
(@UPLOADID NVARCHAR(50)
,@BANKACCOUNT NVARCHAR(50)
,@BANKCODE NVARCHAR(50)
,@SEGMENT NVARCHAR(50))

AS
BEGIN
	DECLARE @@CROSS_NO INT
	DECLARE @VALUEDATE DATETIME

SELECT
	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)--ISNULL(MAX(CROSSREFERENCENO), 0)
FROM BANKRECO(NOLOCK)

				DELETE FROM T 
				FROM TEMP_CMS_DATA T,RECON_CMS_DATA R
				WHERE ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 10),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 10),'')
				----AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 10),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 10),'')
				AND R.ROWTYPE<>'DR'

				IF EXISTS(SELECT * FROM  TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID)			
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
				ELSE
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
				
				

				SELECT @VALUEDATE=MAX(VALUEDATE) FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))

CREATE TABLE #LEDGER_TO_MAP_DUPLICATE(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME
)

IF EXISTS(SELECT TOP 1 * FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID)
BEGIN
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
		AND L11.Vdt<=@VALUEDATE)

END

	CREATE CLUSTERED INDEX IDXR_LEDGER_TO_MAP ON #LEDGER_TO_MAP
	(   
		--VDT,
		VNO,
		VTYP,
		BOOKTYPE	
	)
		INSERT INTO #LEDGER_TO_MAP_DUPLICATE
		SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT FROM 
		#LEDGER_TO_MAP
		GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
		HAVING COUNT(*)=1
		
		
SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE, CLTACCNO INTO #CMS_DATA_DUPLICATE FROM TEMP_CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE, CLTACCNO
HAVING COUNT(*)>1

IF(@BANKACCOUNT LIKE '%CAP360%'	OR @BANKACCOUNT LIKE '%NCDEX384%')
		BEGIN
			UPDATE C
			SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,C.VNO = L.VNO
			,C.VTYP = L.VTYP
			,C.BOOKTYPE = L.BOOKTYPE
			,C.MATCHCODE = 7
			,C.CLTCODE=L.CLTCODE			
			FROM TEMP_CMS_DATA C (NOLOCK)
			, #LEDGER_TO_MAP_DUPLICATE L (NOLOCK)			
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= C.VALUEDATE
			AND C.UPLOADID = @UPLOADID
			AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
			WHERE E.BANKCODE=C.BANKCODE
			AND E.CLTACCNO=C.CLTACCNO
			AND E.CLTCODE=C.CLTCODE
			AND E.DRCR=C.DRCR
			AND E.INST_AMT=C.INST_AMT
			AND E.INST_NO_CHECK=C.INST_NO_CHECK)
			

		END
		ELSE
		
		BEGIN
			UPDATE C
			SET	MATCHEDFLAG = 1
				,MODIFIEDDATE = GETDATE()
				,C.VNO = L.VNO
				,C.VTYP = L.VTYP
				,C.BOOKTYPE = L.BOOKTYPE
				,C.MATCHCODE=1
				,C.CLTCODE=L.CLTCODE
			--, C.BANKCODE = @BANKCODE
			FROM TEMP_CMS_DATA C (NOLOCK)
			, #LEDGER_TO_MAP L (NOLOCK)
			,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			--AND M.CLTCODE = C.CLTCODE
			AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
			AND M.CLTCODE = L.CLTCODE
			AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
			AND C.UPLOADID=@UPLOADID
			AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
			WHERE E.BANKCODE=C.BANKCODE
			AND E.CLTACCNO=C.CLTACCNO
			AND E.CLTCODE=C.CLTCODE
			AND E.DRCR=C.DRCR
			AND E.INST_AMT=C.INST_AMT
			AND E.INST_NO_CHECK=C.INST_NO_CHECK)
	 END
	 
UPDATE C SET C.MATCHEDFLAG = 0
,C.MODIFIEDDATE = ''
,C.VNO = ''
,C.VTYP = ''
,C.BOOKTYPE = ''
,C.MATCHCODE=''
,C.CLTCODE=''
FROM TEMP_CMS_DATA C
WHERE EXISTS (SELECT R.VNO FROM TEMP_CMS_DATA R 
WHERE C.VNO=R.VNO
AND C.VTYP=R.VTYP AND C.BOOKTYPE=R.BOOKTYPE
GROUP BY R.VNO HAVING COUNT(*)>1)
AND C.UPLOADID=@UPLOADID 

				 
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
,MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM TEMP_CMS_DATA(NOLOCK)
	WHERE UPLOADID=@UPLOADID

UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO
FROM TEMP_CMS_DATA N (NOLOCK)
, LEDGER1 L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND N.UPLOADID=@UPLOADID

UPDATE L1
SET EDT = VALUEDATE
FROM TEMP_CMS_DATA N (NOLOCK)
, LEDGER L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
AND UPLOADID=@UPLOADID

/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID = @UPLOADID

DECLARE @TOTALFILERECORD INT

SELECT 	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD > 0) 
BEGIN
				
	IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
		BEGIN
				
				UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

		END
	ELSE
		BEGIN
		
			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE)
			SELECT  UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE
			FROM RECON_BANK_FILEUPLOAD_LOGS_VW
			WHERE UPLOADID=@UPLOADID

			UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

		END

END
ELSE
BEGIN
IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
			DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END

DELETE FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS]
(@UPLOADID NVARCHAR(50)
,@BANKACCOUNT NVARCHAR(50)
,@BANKCODE NVARCHAR(50)
,@BANKNAME NVARCHAR(50)
,@FILETYPE NVARCHAR(50)
,@SEGMENT NVARCHAR(50))

AS

BEGIN
	DECLARE @@CROSS_NO INT
	DECLARE @VALUEDATE DATETIME

SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)
FROM BANKRECO(NOLOCK)

				DELETE FROM T
				FROM TEMP_NONCMS_DATA T ,RECON_NONCMS_DATA R
				WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
				AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
				AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
				AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
				AND R.LEDGERBALANCE <>'DR'
				
				IF EXISTS(SELECT * FROM  TEMP_NONCMS_DATA)
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)--EXISTS_RECORDS(RECORDSTATUS)VALUES(0)
				ELSE
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)--EXISTS_RECORDS(RECORDSTATUS)VALUES(1)
				
				SELECT @VALUEDATE=MAX(CONVERT(DATETIME, VALUEDATE, 109)) FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME)

IF EXISTS(SELECT TOP 1 * FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID)
BEGIN
INSERT INTO #LEDGER_TO_MAP
	SELECT
		MAX(L.VNO)
		,MAX(L.VTYP)
		,MAX(L.BOOKTYPE)
		,MAX(CLTCODE)
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND L1.VTYP<>'5'
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.DRCR <> L1.DRCR
		AND L11.CLTCODE = @BANKCODE
		AND L11.Vdt<=@VALUEDATE)
	GROUP BY	DDNO
				,RELAMT
				,L1.DRCR
				,Edt
				,Vdt
	HAVING COUNT(1) = 1
END

CREATE CLUSTERED INDEX IDXR_LEDGER_TO_MAP ON #LEDGER_TO_MAP
(   
    --VDT,
	VNO,
	VTYP,
	BOOKTYPE	
)
CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME
)

IF(@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS')
BEGIN 
 
	INSERT INTO #LEDGER_TO_MAP_NON_YES
	SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT FROM 
	#LEDGER_TO_MAP
	GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	HAVING COUNT(*)=1
	 
	 
	UPDATE N
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,N.VNO = L.VNO
		,N.VTYP = L.VTYP
		,N.BOOKTYPE = L.BOOKTYPE
		,N.MATCHCODE=6
		,N.CUSTOMERREFERENCE=L.CLTCODE
	--, N.BANKCODE = @BANKCODE /* ADD*/
	FROM TEMP_NONCMS_DATA N (NOLOCK)
	, #LEDGER_TO_MAP_NON_YES L (NOLOCK)	
	WHERE L.DDNO = N.REFERENCENO
	AND L.DDNO<>''
	--L.CLTCODE = N.REFERENCENO
	AND L.RELAMT = CONVERT(MONEY, N.AMT)
	AND N.DRCR = L.DRCR
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
	AND MATCHEDFLAG = 0
END
IF(@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS')
BEGIN

	INSERT INTO #LEDGER_TO_MAP_NON_YES
	SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	FROM #LEDGER_TO_MAP
	GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	HAVING COUNT(*)=1

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE LEFT(L.DDNO ,15)= LEFT(N.REFERENCENO,15)
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEFT(N.REFERENCENO,15)<>''
AND N.UPLOADID=@UPLOADID
IF EXISTS(SELECT * FROM TEMP_NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM TEMP_NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
	END
END


IF(@BANKNAME <> 'ICICI BANK' )
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
WHERE LEFT(L.DDNO ,15)= LEFT(N.REFERENCENO,15)
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEN(L.DDNO)<=15
AND N.UPLOADID=@UPLOADID

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
WHERE L.DDNO = N.REFERENCENO
AND  L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEN(L.DDNO)>15
AND N.UPLOADID=@UPLOADID
END

UPDATE C SET C.MATCHEDFLAG = 0
,C.MODIFIEDDATE = ''
,C.VNO = ''
,C.VTYP = ''
,C.BOOKTYPE = ''
,C.MATCHCODE=''
,CUSTOMERREFERENCE=''
FROM TEMP_NONCMS_DATA C
WHERE EXISTS (SELECT R.VNO FROM TEMP_NONCMS_DATA R 
WHERE C.VNO=R.VNO
AND C.VTYP=R.VTYP AND C.BOOKTYPE=R.BOOKTYPE
GROUP BY R.VNO HAVING COUNT(*)>1)
AND C.UPLOADID=@UPLOADID 

INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE])
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,CONVERT(INT, @@CROSS_NO) + SRNONCMS
		,MATCHCODE
	FROM TEMP_NONCMS_DATA(NOLOCK)
	WHERE UPLOADID=@UPLOADID

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = @@CROSS_NO + SRNONCMS
FROM TEMP_NONCMS_DATA N (NOLOCK)
, LEDGER1 L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND N.UPLOADID=@UPLOADID

UPDATE L1
SET EDT = VALUEDATE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, LEDGER L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
AND N.UPLOADID=@UPLOADID


/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */

INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR 
			,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2	
	AND UPLOADID = @UPLOADID
	AND BANKACCOUNT=@BANKACCOUNT
	AND CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1


		DECLARE @TOTALFILERECORD INT

		SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
		WHERE UPLOADID = @UPLOADID

		IF (@TOTALFILERECORD > 0) 
		BEGIN
			IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
				BEGIN

					UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT,BANKCODE=@BANKCODE
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VIEW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

				END
			ELSE
				BEGIN

					INSERT INTO RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
					SELECT  UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE
					FROM RECON_BANK_FILEUPLOAD_LOGS_VIEW
					WHERE UPLOADID=@UPLOADID

					UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VIEW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

				END

		END
		ELSE
		BEGIN
		IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
					--DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID
					print 'nodata'

		END

		DELETE FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_AXIS_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_AXIS_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',4) , ''))) AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',6) , '')))='CR' THEN 'C'
		WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',6) , '')))='DR' THEN 'D' ELSE '' END AS 'DRCR'
	
	,CAST (RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',5))) AS DECIMAL(20,2)) AS 'AMT'
	--,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',2))) AS DATETIME) AS 'VALUEDATE'
	,CONVERT(DATETIME, RTRIM(LTRIM(.DBO.PIECE(FILE_DATA,'',2))), 103) AS 'VALUEDATE'
	,CASE WHEN  DBO.PIECE(FILE_DATA,'',4) LIKE '%ICONN/%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,'',4),'/',2)
		  WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='' OR ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='-'  THEN '' 	        
		  ELSE ISNULL(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',3))) , '')  END AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')<>''
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'VALUE DATE'

	--SELECT * FROM #NONCMS_DATA RETURN
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_BILLDESK_PROCESS
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_BILLDESK_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN
INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
	UPLOADID
	,BANKACCOUNT
	, BANKCODE
	,LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,'',6)))+'_'+LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,'',8)))  AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'
	,'C' AS 'DRCR'
	,CAST(DBO.PIECE(FILE_DATA,'',13) AS DECIMAL(18,2)) AS 'AMT'
	,CONVERT( DATETIME,.DBO.PIECE(FILE_DATA,'',12),103) AS 'VALUEDATE'
	,LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,'',11))) AS 'REFERENCENO'
	,' '
	,' '
	,' '
	,' '
	,' '
	,' '
	,0 AS 'MATCHEDFLAG'
	,UPLOADSTATUS
	,GETDATE()
	,MODIFIEDDATE
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',15) , '')<>''
AND ISNULL(DBO.PIECE(FILE_DATA,'',11) , '')<>'Ref 4'


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_HDFC_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_HDFC_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @D VARCHAR(50),@VALUEDATE VARCHAR(11)
SELECT  @D=.DBO.PIECE(@UPLOADFILENAME,'_',2)
 
SELECT @VALUEDATE= STUFF(STUFF( @D, 5, 0, '/'), 3, 0, '/')-- DD/MM/YYYY

IF(@VALUEDATE='' OR @VALUEDATE IS NULL)
BEGIN
	DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
	SELECT		'PLEASE ADD DATE IN THE FILE NAME'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
END
--select @VALUEDATE
CREATE TABLE #NONCMS_HDFC (
	UPLOADID NVARCHAR(50),
	BANKACCOUNT NVARCHAR(50),
	BANKCODE NVARCHAR(50),	
	BOOKDATE NVARCHAR(50),
	DESCRIPTION NVARCHAR(500),
	LEDGERBALANCE NVARCHAR (500) ,
	CREDITAMT NVARCHAR (50),
	DEBITAMT NVARCHAR(50),
	VALUEDATE NVARCHAR(50),
	REFERENCENO NVARCHAR (50),
	TRANSACTIONBRANCH NVARCHAR(500),
	MATCHEDFLAG BIT,
	UPLOADSTATUS NVARCHAR(50),
	UPLOADEDDATE DATETIME,
	MODIFIEDDATE DATETIME,
	UPLOADBY NVARCHAR(50))

INSERT INTO #NONCMS_HDFC (UPLOADID,
BANKACCOUNT,
BANKCODE,
BOOKDATE,
DESCRIPTION,
LEDGERBALANCE,
CREDITAMT,
DEBITAMT,
VALUEDATE,
REFERENCENO,
TRANSACTIONBRANCH,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY)
	SELECT
		U.UPLOADID
		,U.BANKACCOUNT
		--,'' AS BANKACCOUNT
		, @BANKCODE 
		,.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '	', 1) BookType
		,.DBO.PIECE(FILE_DATA, '	', 2) Description
		,.DBO.PIECE(FILE_DATA, '	', 3) LedgerBalance
		,.DBO.PIECE(FILE_DATA, '	', 4) Credit
		,.DBO.PIECE(FILE_DATA, '	', 5) Debit
		--,.DBO.PIECE(FILE_DATA, '	', 6) ValueDate
		,@VALUEDATE AS VALUEDATE
		,.DBO.PIECE(FILE_DATA, '	', 7) ReferenceNo
		,.DBO.PIECE(FILE_DATA, '	', 8) TransactionBranch
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.DBO.PIECE(FILE_DATA, '	', 2) <> ''



INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CustomerReference
, TransaCtionDetail
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		UPLOADID
		,BANKACCOUNT
		, BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,CASE
			WHEN CREDITAMT <> '' THEN 'C'
			WHEN DEBITAMT <> '' THEN 'D'
			ELSE ' '
		END AS DRCR
		,CASE
			WHEN CREDITAMT <> '' THEN REPLACE(REPLACE(REPLACE(CREDITAMT, '(', ''), ')', ''), ',', '')
			WHEN DEBITAMT <> '' THEN REPLACE(REPLACE(REPLACE(DEBITAMT, '(', ''), ')', ''), ',', '')
			ELSE '0'
		END AS AMT
		,REPLACE(VALUEDATE, '/', '-')
		,REFERENCENO
		,' '
		,' '
		,' '
		,' '
		,' '
		,' '
		,MATCHEDFLAG
		,UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
	FROM #NONCMS_HDFC
	WHERE LEDGERBALANCE = ''
PRINT 'INSERTED INTO TEMP TABLE'
DROP TABLE #NONCMS_HDFC

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_ICICI_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_ICICI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
) 
AS

BEGIN

UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA = REPLACE (.DBO.PIECE(FILE_DATA,'"',1),'''','') +
.DBO.PIECE(FILE_DATA,'"',2)+
.DBO.PIECE(FILE_DATA,'"',3)+
.DBO.PIECE(FILE_DATA,'"',4)+
.DBO.PIECE(FILE_DATA,'"',5)+
REPLACE (.DBO.PIECE(FILE_DATA,'"',6),',','')+
.DBO.PIECE(FILE_DATA,'"',7)+
.DBO.PIECE(FILE_DATA,'"',8)+
.DBO.PIECE(FILE_DATA,'"',9)+
.DBO.PIECE(FILE_DATA,'"',10)+
.DBO.PIECE(FILE_DATA,'"',11)+
.DBO.PIECE(FILE_DATA,'"',12)+
.DBO.PIECE(FILE_DATA,'"',13)+
.DBO.PIECE(FILE_DATA,'"',14)+
.DBO.PIECE(FILE_DATA,'"',15)+
.DBO.PIECE(FILE_DATA,'"',16)+
.DBO.PIECE(FILE_DATA,'"',17)+
.DBO.PIECE(FILE_DATA,'"',18)+
.DBO.PIECE(FILE_DATA,'"',19)+
.DBO.PIECE(FILE_DATA,'"',21)+
.DBO.PIECE(FILE_DATA,'"',22)+
.DBO.PIECE(FILE_DATA,'"',23)
FROM MSAJAG.DBO.FILEDATA
WHERE DBO.PIECE(FILE_DATA,'"',2) IS NOT NULL

CREATE TABLE #TEMP_ICICI(UPLOADID NVARCHAR(50),ACCOUNTNUMBER NVARCHAR(50),BANKCODE NVARCHAR(50),TRANDATE DATETIME,InstNum NVARCHAR(100),TRANPARTICULAR NVARCHAR(150),TRANREMARKS NVARCHAR(150)
,DRTRANAMT  MONEY,CRTRANAMT MONEY,DEPOSITBRANCH NVARCHAR(150),MATCHEDFLAG BIT,
	UPLOADSTATUS NVARCHAR(50),
	UPLOADEDDATE DATETIME,
	MODIFIEDDATE DATETIME,
	UPLOADBY NVARCHAR(50))

INSERT INTO #TEMP_ICICI
SELECT
	U.UPLOADID
	,.DBO.PIECE(DBO.PIECE(FILE_DATA, ',', 1),':',2)
	, @BANKCODE 
	,CONVERT(DATETIME, DBO.PIECE(FILE_DATA, ',', 2), 105) 'VALUEDATE' 
	,DBO.PIECE(FILE_DATA, ',', 5) 'INSTNUM'
	,DBO.PIECE(FILE_DATA, ',', 3) 'DESCRIPTION'
	,DBO.PIECE(FILE_DATA, ',', 4) 'DESCRIPTION2'
	,CAST(DBO.PIECE(FILE_DATA, ',', 8) AS DECIMAL(20, 2)) 'DRTRANAMT'
	,CAST(DBO.PIECE(FILE_DATA, ',', 9) AS DECIMAL(20, 2)) 'CRTRANAMT'
	,DBO.PIECE(FILE_DATA, ',', 11) 'DEPOSITBRANCH'
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID = @UPLOADID
		AND DBO.PIECE(FILE_DATA, ',', 2) IS NOT NULL
		AND REPLACE(.DBO.PIECE(FILE_DATA, ',', 1), '''', '') NOT IN ('ACCOUNT NUMBER', '','--------------')
		AND DBO.PIECE(FILE_DATA, ',', 3) NOT IN ('B/F')

INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)

SELECT 
UPLOADID
,ACCOUNTNUMBER
,BANKCODE
,TRANPARTICULAR
,''
,CASE WHEN CRTRANAMT <>'' THEN 'C' WHEN DRTRANAMT <> '' THEN 'D'		ELSE ' 'END AS DRCR
,CASE WHEN DRTRANAMT <> '' THEN REPLACE(DRTRANAMT,',','') WHEN CRTRANAMT <> '' THEN REPLACE(CRTRANAMT,',','') ELSE '0' END AS AMT
,TRANDATE
,INSTNUM AS 'REFERENCENO'
,'' AS 'CLTACCOUNT'
, '' AS 'CUSTOMERREFERENCE'
, TRANPARTICULAR+ '|'+DEPOSITBRANCH AS 'TRANSACTIONDETAIL'
,'' AS  VNO
,'' AS  VTYP
,'' AS  BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
 FROM #TEMP_ICICI

 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_IDBI_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_IDBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',3) , ''))) AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')))='CR' THEN 'C'
		WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')))='DR' THEN 'D' ELSE '' END AS 'DRCR'
	
	,CAST (RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',7))) AS DECIMAL(20,2)) AS 'AMT'	
	,CONVERT(DATETIME, RTRIM(LTRIM(.DBO.PIECE(FILE_DATA,'',2))), 103) AS 'VALUEDATE'
	,CASE WHEN  DBO.PIECE(FILE_DATA,'',3) LIKE '%IPAY/%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,'',3),'/',4)
		  --WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='' OR ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='-'  THEN '' 	        
		  ELSE ''  END AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',7) , '')<>''
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'VALUE DATE'

	--SELECT * FROM #NONCMS_DATA RETURN
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_IDFC_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_IDFC_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN
INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		UPLOADID
		,BANKACCOUNT
		, BANKCODE
		,CASE WHEN .DBO.PIECE(FILE_DATA,'',3) LIKE '%MUMBAI|IDLCC|%' THEN .DBO.PIECE(.DBO.PIECE(FILE_DATA,'',3),'|',4) ELSE .DBO.PIECE(FILE_DATA,'',3)END  AS 'DESCRIPTION'
		,'' AS 'LEDGERBALANCE'
		, CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN 'D'
			   WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN 'C' ELSE '' END AS 'DRCR'
		,CASE  WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5))
			   WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6)) ELSE '0.00' END AS 'AMT'
		, CONVERT( DATETIME,.DBO.PIECE(FILE_DATA,'',2),103) AS 'VALUEDATE'
		,.DBO.PIECE(FILE_DATA,'',4) AS 'REFERENCENO'
		,' '
		,' '
		,' '
		,' '
		,' '
		,' '
		,0 AS 'MATCHEDFLAG'
		,UPLOADSTATUS
		,GETDATE()
		,MODIFIEDDATE
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>''
AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'Value Date'

--SELECT * FROM #NONCMS_DATA RETURN

END

--SELECT DRCR= CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN 'D'
--WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN 'C' ELSE '' END ,
--AMOUNT=CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5))
--WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6)) ELSE '0.00' END 

--FROM MSAJAG..FILEDATA
--WHERE ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>''
--AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'Value Date'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_INDUSIND_PROCESS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_INDUSIND_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

IF(@FILE_PATH<>'')
	BEGIN
--SELECT @FILE_PATH RETURN
DECLARE @SQL NVARCHAR(MAX)
SET @SQL="SELECT * INTO XLImport FROM OPENDATASOURCE('Microsoft.Ace.OLEDB.12.0',
'Data Source="+@FILE_PATH +";Extended Properties=Excel 8.0')...[Sheet1$]"
EXEC (@SQL)
PRINT @SQL


			INSERT INTO #NONCMS_DATA 
			SELECT
			@UPLOADID
			,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
			,@BANKCODE AS BANKCODE
			,F5 AS DESCRIPTION
			,'' AS LEDGERBALANCE
			,CASE WHEN ISNULL(F4 , '')='Credit' THEN 'C' ELSE 'D' END AS DRCR
			,CASE WHEN F6<>'' THEN CAST (F6 AS DECIMAL(20,2))  ELSE CAST (F7 AS DECIMAL(20,2)) END  --CAST (DBO.PIECE(FILE_DATA,',',5) AS DECIMAL(20,2)) AS AMT
			,CONVERT(DATETIME,F2,105)  AS VALUEDATE
			,CASE WHEN F5 LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (F5,CHARINDEX('/TRF TO',F5)+8,LEN(F5)),'/',1)))
			WHEN F5 LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (F5,CHARINDEX('/TRF FRM',F5)+8,LEN(F5)),'///',1)))
			WHEN F5 LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(F5,', ',3),'C/NO ',''),'///','')))
			--REPLACE(REPLACE(DBO.PIECE('PURCHASE DT 200117, ZR1130R, C/NO 1391762///',', ',3),'C/NO ',''),'///','')
			ELSE '' END	 AS REFERENCENO
			,'' AS CLTACCOUNT
			,'' AS CUSTOMERREFERENCE
			,'' AS TRANSACTIONDETAIL
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0
			,'PENDING' AS 'UPLOADSTATUS'
			,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
			,GETDATE()
			,@UNAME	
			FROM XLImport 
			WHERE F2<>''
			AND F1 NOT IN ('CustomerName','Bank Reference')
			AND F4 NOT IN('ToDate')
				
		DROP TABLE XLImport
		
	END
	IF(@FILE_PATH='')
	BEGIN
	--SELECT .dbo.piece(DBO.PIECE(FILE_DATA,'',4),':',2) FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID  and DBO.PIECE(FILE_DATA,'',4) like '%Account No :%'

				INSERT INTO #NONCMS_DATA 
				SELECT
				@UPLOADID
				,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
				,@BANKCODE AS BANKCODE
				,ISNULL(DBO.PIECE(FILE_DATA,'',4) , '') AS DESCRIPTION
				,'' AS LEDGERBALANCE
				,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='CREDIT' THEN 'C' ELSE 'D' END AS DRCR
				,CAST (DBO.PIECE(FILE_DATA,'',5) AS DECIMAL(20,2))  AS AMT
				,CONVERT(DATETIME,CONVERT(VARCHAR(11),CONVERT(DATETIME,.DBO.CLS_REMOVE_SPACE(DBO.PIECE(FILE_DATA,'',1)),103),101))
				,CASE WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',4),CHARINDEX('/TRF TO',DBO.PIECE(FILE_DATA,'',4))+8,LEN(DBO.PIECE(FILE_DATA,'',4))),'/',1)))
				WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',4),CHARINDEX('/TRF FRM',DBO.PIECE(FILE_DATA,'',4))+8,LEN(DBO.PIECE(FILE_DATA,'',4))),'///',1)))
				WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(DBO.PIECE(FILE_DATA,'',4),', ',3),'C/NO ',''),'///','')))
				ELSE '' END  AS REFERENCENO
				,'' AS CLTACCOUNT
				,'' AS CUSTOMERREFERENCE
				,'' AS TRANSACTIONDETAIL
				,'' AS VNO
				,'' AS VTYP
				,'' AS BOOKTYPE
				,0
				,'PENDING' AS 'UPLOADSTATUS'
				,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
				,GETDATE()
				,@UNAME	
				FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
				INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
					ON U.UPLOADID = F.PROGID
					WHERE F.PROGID = @UPLOADID
					AND DBO.PIECE(FILE_DATA,'',3) IN('DEBIT','CREDIT')
					AND DBO.PIECE(FILE_DATA,'',3)<>''
					
			
	END
	/* OLD FORMAT
	BEGIN

				INSERT INTO #NONCMS_DATA 
				SELECT
				@UPLOADID
				,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
				,@BANKCODE AS BANKCODE
				,ISNULL(DBO.PIECE(FILE_DATA,'',5) , '') AS DESCRIPTION
				,'' AS LEDGERBALANCE
				,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',4) , '')='CREDIT' THEN 'C' ELSE 'D' END AS DRCR
				,CASE WHEN DBO.PIECE(FILE_DATA,'',6)<>'' THEN CAST (DBO.PIECE(FILE_DATA,'',6) AS DECIMAL(20,2))  ELSE CAST (DBO.PIECE(FILE_DATA,'',7) AS DECIMAL(20,2)) END   AS AMT
				,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,'',2),105)  AS VALUEDATE
				,CASE WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',5),CHARINDEX('/TRF TO',DBO.PIECE(FILE_DATA,'',5))+8,LEN(DBO.PIECE(FILE_DATA,'',5))),'/',1)))
			WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',5),CHARINDEX('/TRF FRM',DBO.PIECE(FILE_DATA,'',5))+8,LEN(DBO.PIECE(FILE_DATA,'',5))),'///',1)))
			WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(DBO.PIECE(FILE_DATA,'',5),', ',3),'C/NO ',''),'///','')))
			--REPLACE(REPLACE(DBO.PIECE('PURCHASE DT 200117, ZR1130R, C/NO 1391762///',', ',3),'C/NO ',''),'///','')
			ELSE '' END AS REFERENCE
				,'' AS CLTACCOUNT
				,'' AS CUSTOMERREFERENCE
				,'' AS TRANSACTIONDETAIL
				,'' AS VNO
				,'' AS VTYP
				,'' AS BOOKTYPE
				,0
				,'PENDING' AS 'UPLOADSTATUS'
				,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
				,GETDATE()
				,@UNAME	
				FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
				INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
					ON U.UPLOADID = F.PROGID
					WHERE F.PROGID = @UPLOADID
					AND DBO.PIECE(FILE_DATA,'',4) in('Debit','Credit')
	END
	*/
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_KOTAK_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_KOTAK_PROCESS]
(@UPLOADID NVARCHAR(50), @BANKCODE NVARCHAR(50) ) 
AS
BEGIN

UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA =.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 1)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 2)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 3)	
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 4)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 5)
	+REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 6), ',', '')
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 7)
	+ISNULL(REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 8), ',', ''), '')
	+isnull(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 9), '')
	+isnull(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 10), '')
WHERE PROGID = @UPLOADID
----AND .DBO.PIECE(FILE_DATA, '"=""', 4) LIKE '%FF %'

		INSERT INTO #NONCMS_DATA 
		SELECT
		U.UPLOADID
		,U.BANKACCOUNT
		,@BANKCODE AS BANKCODE
		,LEFT (RIGHT(DBO.PIECE(FILE_DATA,',',3),LEN(DBO.PIECE(FILE_DATA,',',3)) - 1) ,50)AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',',6) , '')='CR' THEN 'C' ELSE 'D' END AS DRCR
		,CAST (DBO.PIECE(FILE_DATA,',',5) AS DECIMAL(20,2)) AS AMT
		,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',2),105)  AS VALUEDATE
		--,DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', '_'), '_', 2) AS REFERENCENO
		,CASE WHEN .DBO.PIECE(FILE_DATA, ',', 4) LIKE '=GBM%' THEN .DBO.PIECE (.DBO.PIECE(FILE_DATA, ',', 4),'-',2) 
			  ELSE .DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', '_'), '_', 2)  END AS REFERENCENO
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY		
		FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
		INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID = @UPLOADID
		AND DBO.PIECE(FILE_DATA,',',6) IN ('DR','CR')
		AND DBO.PIECE(FILE_DATA,',',6) IS NOT NULL

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_RAZORPAY_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_RAZORPAY_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN
DECLARE @SQL NVARCHAR(800)
SET @SQL = ''
SET @SQL = @SQL + ' SELECT * INTO ##CLSRECONTABLE FROM CLSRECONTABLE_'+@UPLOADID
SET @SQL = @SQL + ' DROP TABLE CLSRECONTABLE_'+@UPLOADID

PRINT @SQL
EXEC(@SQL)

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)

	SELECT
	(SELECT UPLOADID FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'UPLOADID'
	,SEGMENT_NAME AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,REF_NO+'_'+CLIENT_CODE +'_'+ SETTLEMENT_UTR+'_'+SEGMENT_NAME AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,'C' AS 'DRCR'	
	,CAST (RTRIM(LTRIM(AMOUNT)) AS DECIMAL(20,2)) AS 'AMOUNT'
	,CONVERT(DATETIME, RTRIM(LTRIM(SETTLEMENT_INITIATED_ON)), 103) AS 'VALUEDATE'
	, REF_NO AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM ##CLSRECONTABLE
	WHERE ISNULL(AMOUNT , '')<>''
	
	DROP TABLE ##CLSRECONTABLE
	--DELETE FROM #NONCMS_DATA WHERE BANKACCOUNT<>'NSE'
	--SELECT * FROM #NONCMS_DATA WHERE BANKACCOUNT='NSE'
	--return
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_SBI_PROCESS
-- --------------------------------------------------







CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_SBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @SRNO INT
SELECT * INTO #TEMP FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

SELECT @SRNO=SRNO  FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
AND FILE_DATA LIKE '%TXN DATE%'AND RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2)))='VALUE DATE'


DELETE FROM MSAJAG..FILEDATA WHERE SRNO<=@SRNO AND PROGID=@UPLOADID

--SELECT * INTO #TEMP2 FROM  #TEMP  WHERE DBO.PIECE(FILE_DATA,'	',2) <> ''
DECLARE @CLOSINGBALANCE NVARCHAR(50)
SELECT TOP 1 @CLOSINGBALANCE= CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',8))) AS MONEY) FROM MSAJAG..FILEDATA 
WHERE .DBO.PIECE(FILE_DATA,'	',2) <> ''
AND PROGID=@UPLOADID 
ORDER BY SRNO DESC

INSERT INTO #NONCMS_DATA (
	UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG

, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE BANKCODE
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) 
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6)))='' THEN 'C' 
	  WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7)))='' THEN 'D' ELSE '' END AS 'DRCR'	
	,CASE WHEN DBO.PIECE(FILE_DATA,'	',6) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7))) AS MONEY)
	  WHEN DBO.PIECE(FILE_DATA,'	',7) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ELSE 0 END AS 'AMT'
	,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2))) AS DATETIME ) AS 'VALUEDATE'
	--,RTRIM(LTRIM(.DBO.PIECE(.DBO.PIECE(FILE_DATA,'	',4),'/',2))) AS 'REFERENCENO'
	--, SUBSTRING (SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))),CHARINDEX('IGACV',SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4)))),LEN(SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))))) AS 'REFERENCENO'
	--, CASE WHEN .DBO.PIECE(FILE_DATA,'	',4) like '%IGA%' THEN
	 --SUBSTRING (SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))),CHARINDEX('IGA',SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4)))),LEN(SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))))) 
	--WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%' THEN SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGAD',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
	---	ELSE '' END AS 'REFERENCENO'
	,CASE WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%'  THEN
	  SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGA',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
	WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%' THEN SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGAD',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
		ELSE '' END   AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',4))) AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME
	--,@CLOSINGBALANCE	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND .DBO.PIECE(FILE_DATA,'	',2) <> ''
	--SELECT * FROM #NONCMS_DATA RETURN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_Recon_NONCMS_SCB_Process
-- --------------------------------------------------




 CREATE PROCEDURE [dbo].[CLS_Recon_NONCMS_SCB_Process] (@UPLOADID nvarchar(50), @UPLOAD_FLAG CHAR(1),@BANKCODE NVARCHAR(50) ) 
AS
BEGIN
       

--DECLARE @UPLOADID NVARCHAR(50) 
--SET @UPLOADID='35CBA453'


IF @UPLOAD_FLAG = 'B'
BEGIN
UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA = ISNULL(.DBO.PIECE(FILE_DATA, '"', 1), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 2), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 3), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 4), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 5), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 6), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 7), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 8), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 9), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 10), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 11), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 12), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 13), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 14), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 15), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 16), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 17), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 18), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 19), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 20), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 21), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 22), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 23), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 24), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 25), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 26), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 27), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 28), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 29), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 30), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 31), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 32), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 33), '')
WHERE PROGID = @UPLOADID
END

INSERT INTO #NONCMS_DATA
	SELECT
		U.UPLOADID
		,.dbo.piece(FILE_DATA, ',', 2) AS BANKACCOUNT
		, @BANKCODE AS BANKCODE
		,LEFT(.DBO.PIECE(FILE_DATA, ',', 38),50) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,CASE
			WHEN.dbo.piece(FILE_DATA, ',', 16) = 'Credit' THEN 'C'
			ELSE 'D'
		END AS DRCR
		,CAST(.dbo.piece(FILE_DATA, ',', 32) AS DECIMAL(20, 2)) AS AMT
		,CONVERT(DATETIME,.DBO.PIECE(FILE_DATA, ',', 60), 105) AS VALUEDATE
		--,.dbo.piece(FILE_DATA, ',', 30) AS REFERENCENO
		, CASE WHEN LEFT(.DBO.PIECE(FILE_DATA, ',', 38),5)='IMPS/' THEN .DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 38), '/', 3)
		WHEN LEFT(.DBO.PIECE(FILE_DATA, ',', 38),5)='IMPS|' THEN   .DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 38), '|', 3)
		ELSE .DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 38), '|', 1)END AS 'REFERENCENO'
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UploadStatus
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM Recon_bank_FileUpload_logs U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.dbo.piece(FILE_DATA, ',', 32) NOT IN (''
	, 'Transaction Amount')
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_YES_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_YES_PROCESS]
( @UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(50) ) 

AS 
BEGIN

--UPDATE MSAJAG.DBO.FILEDATA
--SET FILE_DATA = ISNULL(.DBO.PIECE(FILE_DATA, ',', 1), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 3), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 4), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 5), '') + ',' +
----REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), 'NET TXN: ', '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 6), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 7), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 8), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 9), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 10), '')
--WHERE PROGID = @UPLOADID
--AND .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NET TXN:%'
--AND  .DBO.PIECE(FILE_DATA, ',', 5) NOT LIKE '% to %'


INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		U.UPLOADID
		,U.BANKACCOUNT AS BANKACCOUNT
		, @BANKCODE AS BANKCODE
		,LEFT(.DBO.PIECE(FILE_DATA, ',', 5), 149) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,.DBO.PIECE(FILE_DATA, ',', 4) AS DRCR
		,CAST(.DBO.PIECE(FILE_DATA, ',', 3) AS DECIMAL(20, 2)) AS AMT
		, CONVERT (DATETIME ,REPLACE(.DBO.PIECE(FILE_DATA, ',', 2),'/','-'),105) AS VALUEDATE
		,CASE WHEN  .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%RTGS-%' THEN DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5), '-', 3)
		WHEN  .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NEFT-%' THEN DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5), '-', 3)
		WHEN  (.DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NET TXN:%' AND .DBO.PIECE(FILE_DATA, ',', 4)='D') THEN LEFT(.DBO.CLS_REMOVE_SPACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5),':',2)), CHARINDEX(' ', .DBO.CLS_REMOVE_SPACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5),':',2))))
		ELSE .DBO.PIECE(FILE_DATA, ',', 6)
		END AS REFERENCENO
		,.DBO.PIECE(FILE_DATA, ',', 7) AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.DBO.PIECE(FILE_DATA, ',', 2) <> ''
	AND.DBO.PIECE(FILE_DATA, ',', 6) IS NOT NULL
	AND.DBO.PIECE(FILE_DATA, ',', 6) <> 'REFERENCE NO.'

--DROP TABLE #NONCMS_DATA
PRINT 'INSERTED INTO TEMP TABLE'


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_Recon_Reprocess_Data
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_Recon_Reprocess_Data]
( 
 @Segment NVARCHAR(30), 
 @BankName NVARCHAR(50), 
 @FileType NVARCHAR(50),
 @BankCode NVARCHAR(50),
 @UploadDate NVARCHAR(50)
)
 AS
BEGIN
		IF (@FILETYPE = 'CMS') 

			BEGIN
				CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
				VTYP INT,
				BOOKTYPE VARCHAR(3),
				CLTCODE VARCHAR(10),
				DDNO VARCHAR(30),
				RELAMT MONEY,
				DRCR CHAR(1))

		INSERT INTO #LEDGER_TO_MAP
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.vno
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.reldt = ''
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.CLTCODE = @BANKCODE
				AND L11.VTYP IN (2, 3, 17))

		UPDATE RECON_CMS_DATA
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
		FROM RECON_CMS_DATA(NOLOCK) C
		, #LEDGER_TO_MAP L (NOLOCK)
		, [MULTIBANKID] M (NOLOCK)
		WHERE L.DDNO = C.INST_NO_CHECK
		AND C.DRCR = L.DRCR
		AND C.INST_AMT = L.RELAMT
		AND M.CLTCODE = C.CLTCODE
		AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
		AND M.Cltcode = L.CLTCODE
		--AND CONVERT(DATETIME, STUFF(STUFF(C.VALUEDATE, 3, 0, '-'), 6, 0, '-'), 105) = CONVERT(DATETIME, @UPLOADDATE, 103)
		AND C.Valuedate = CONVERT(DATETIME, @UPLOADDATE, 103)
		AND MATCHEDFLAG = 0
		AND C.BANKCODE=@BankCode


		SELECT
			'TOTAL RECORD UPDATE :' + CAST(@@ROWCOUNT AS CHAR(20))

		UPDATE L1
		SET	RELDT = VALUEDATE
			,REFNO = CROSS_NO
		FROM RECON_CMS_DATA N
		, LEDGER1 L1
		WHERE N.VNO = L1.VNO
		AND N.VTYP = L1.VTYP
		AND N.BOOKTYPE = L1.BOOKTYPE
		AND MATCHEDFLAG = 1
		AND N.BANKCODE=@BankCode

		UPDATE L1
		SET EDT = VALUEDATE
		FROM RECON_CMS_DATA N
		, LEDGER L1
		WHERE N.VNO = L1.VNO
		AND N.VTYP = L1.VTYP
		AND N.BOOKTYPE = L1.BOOKTYPE
		AND EDT LIKE 'DEC 31 2049%'
		AND MATCHEDFLAG = 1
		AND N.BANKCODE=@BankCode
		END
ELSE
	BEGIN
			 CREATE TABLE #LEDGER_TO_MAP_NON
			 (
				VNO VARCHAR(12),
				VTYP INT,
				BOOKTYPE VARCHAR(3),
				CLTCODE VARCHAR(10),
				DDNO VARCHAR(30),
				RELAMT MONEY,
				DRCR CHAR(1)
			  )

			 INSERT INTO #LEDGER_TO_MAP_NON
				SELECT
				MAX(L.VNO)
				,MAX(L.VTYP)
				,MAX(L.BOOKTYPE)
				,MAX(CLTCODE)
				,DDNO
				,RELAMT
				,L1.DRCR
				FROM	LEDGER L
					,LEDGER1 L1
				WHERE L.VNO = L1.VNO
				AND L.VTYP = L1.VTYP
				AND L.LNO = L1.LNO
				AND L.BOOKTYPE = L1.BOOKTYPE
				AND L1.RELDT = ''
				AND EXISTS (SELECT
						VNO
					FROM LEDGER L11 (NOLOCK)
					WHERE L11.VNO = L1.VNO
					AND L11.VTYP = L1.VTYP
					AND L11.BOOKTYPE = L1.BOOKTYPE
					AND L11.DRCR <> L1.DRCR
					AND L11.CLTCODE = @BANKCODE)
				GROUP BY	DDNO
							,RELAMT
							,L1.DRCR
				HAVING COUNT(1) = 1

				UPDATE RECON_NONCMS_DATA
				SET	MATCHEDFLAG = 1
					,MODIFIEDDATE = GETDATE()
				FROM RECON_NONCMS_DATA(NOLOCK) C
				, #LEDGER_TO_MAP_NON L (NOLOCK)
				WHERE L.DDNO = C.REFERENCENO
				AND L.RELAMT = CONVERT(MONEY, C.AMT)
				AND C.DRCR = L.DRCR
				AND C.ValueDate=CONVERT(DATETIME, @UPLOADDATE, 103)
				AND C.MATCHEDFLAG = 0
				AND C.BANKCODE=@BankCode
				SELECT 'TOTAL RECORD UPDATE :' + CAST(@@ROWCOUNT AS CHAR(20))

				UPDATE L1
                  SET    RELDT = CONVERT(DATETIME, VALUEDATE, 105)
                         , REFNO = CROSS_NO
                  FROM   RECON_NONCMS_DATA N
                         , LEDGER1 L1
                  WHERE  N.VNO = L1.VNO
                         AND N.VTYP = L1.VTYP
                         AND N.BOOKTYPE = L1.BOOKTYPE
						 AND N.MATCHEDFLAG=1
						 AND N.BANKCODE=@BankCode

                  UPDATE L1
                  SET    EDT = VALUEDATE
                  FROM   RECON_NONCMS_DATA N
                         , LEDGER L1
                  WHERE  N.VNO = L1.VNO
                         AND N.VTYP = L1.VTYP
                         AND N.BOOKTYPE = L1.BOOKTYPE
                         AND EDT LIKE 'DEC 31 2049%'
						 AND N.MATCHEDFLAG=1
						 AND N.BANKCODE=@BankCode

		END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_TECHPROCESS_ICICI_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_TECHPROCESS_ICICI_PROCESS]
(@UPLOADID NVARCHAR(50), @BANKCODE NVARCHAR(50) ) 
AS
BEGIN


DECLARE @VALUEDATE VARCHAR(10)
SELECT TOP 1 @VALUEDATE=.DBO.PIECE(.DBO.PIECE(FILE_DATA, ':', 2),',',1) FROM MSAJAG..FILEDATA 
WHERE PROGID=@UPLOADID
ORDER BY SRNO ASC



UPDATE MSAJAG.DBO.FILEDATA SET FILE_DATA=ISNULL(.DBO.PIECE(FILE_DATA, ',', 1), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 3), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 4), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 5), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 6), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 7), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 8), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 9), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 10), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 11), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 12), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 13), '') + ',' +
ISNULL(REPLACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 14),':',3),'}',''), '') 
WHERE .DBO.PIECE(FILE_DATA, ',', 14) LIKE '%ITC:ABC_123%'

INSERT INTO #NONCMS_DATA 
		SELECT
		U.UPLOADID
		--,CASE WHEN  .DBO.PIECE(FILE_DATA,',',14) NOT LIKE '%EQ_%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',2)+'_'+.DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',3) 
		--WHEN .DBO.PIECE(FILE_DATA,',',14)  LIKE '%EQ_%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',3)+'_'+.DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',4) ELSE '' END
		--AS 'BANKACCOUNT'
		, CASE WHEN FILE_DATA LIKE '%B_EQ_B%' THEN RIGHT(.DBO.PIECE(FILE_DATA,',',14) ,4) ELSE .DBO.PIECE(.DBO.PIECE(FILE_DATA,',',14),'_',2) END AS 'BANKACCOUNT'
		,@BANKCODE AS BANKCODE
		,.DBO.PIECE(FILE_DATA, ',', 14) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,'C'  AS DRCR
		,CAST(.DBO.PIECE(FILE_DATA, ',', 7) AS DECIMAL(20,2)) AS AMT
		,CONVERT(DATETIME,RTRIM(LTRIM(@VALUEDATE)),126)  AS VALUEDATE
		,.DBO.PIECE(FILE_DATA, ',', 4) AS REFERENCENO		
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY		
		FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
		INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID=@UPLOADID
		AND ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') <>''
		AND ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') <>'Bank_ID'		
	
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACC_PARTYLEDGER
-- --------------------------------------------------

--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE
 PROCEDURE [DBO].[CLS_RPT_ACC_PARTYLEDGER]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),     
           
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @STATUSID VARCHAR(15),                
 @STATUSNAME VARCHAR(15),                
 @STRBRANCH VARCHAR(10),
 @ENTITY VARCHAR(20),
 @ENTITY_LIST VARCHAR(MAX),
 @FORPDF
 VARCHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6)  
  
  
SELECT @@REPTYPE = .DBO.PIECE(@STRORDER, '~', 2)  
SELECT @@STRORDER = .DBO.PIECE(@STRORDER, '~', 1)  
  /*
IF @@REPTYP
E = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*=====================================================================
===          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
    
        'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),   
       
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(40),           
	L_ADDRESS2  VARCHAR(40),           
	L_ADDRESS3 VARCHAR(40),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20), 
          
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50)
)



CREATE TABLE #CL_LIST
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #CL_LIST
 ADD PRIMARY KEY (CLTCODE)

DECLARE
	@@SQL VARCHAR(MAX),
	@ENTITY_FIELD VARCHAR(20)
	

 SELECT @ENTITY_FIELD =    
  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
  CASE WHEN @STATUSID = 'CLIENT' THEN 'CL_CODE' ELSE 	 
  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
 END END END END END END  END   

SET @@SQL = "INSERT INTO #CL_LIST "
SET @@SQL = @@SQL + "SELECT CL_CODE FROM MSAJAG.DBO.CLIENT1 "
SET @@SQL = @@SQL + "
WHERE CL_CODE >= '" + @FCODE + "' AND CL_CODE <= '" + @TCODE + "'"
IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
BEGIN 
 SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
 
--SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
END  
PRINT @@SQL
EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME
,          
            BANK_NAME = ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,          
            CLTDPID = ISNULL(CLTDPID, '') ,
            EMAIL,
        
    MOBILE_PAGER          
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON       
    
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				  AND DEFDP = 1          
--                  AND DEFDP = 0      
            )           
    
  WHERE C1.CL_CODE = C2.CL_CODE 
			AND C1.AREA LIKE (          
            CASE           
                  WHEN @STATUSID = 'AREA'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          

            ) 
			AND C1.REGION LIKE (          
            CASE           
                  WHEN @STATUSID = 'REGION'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            
)            
            AND C1.BRANCH_CD LIKE (          
            CASE           
                  WHEN @STATUSID = 'BRANCH'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
  
          )           
            AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUB_BROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END  
        
            )           
     AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUBBROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND TRADER LIKE (          
            CASE           
                  WHEN @STATUSID = 'TRADER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
           
 END          
            )           
            AND C1.FAMILY LIKE (          
            CASE           
                  WHEN @STATUSID = 'FAMILY'           
                  THEN @STATUSNAME           
                  ELSE '%'           
     
       END          
            )           
            AND C2.PARTY_CODE LIKE (          
            CASE           
                  WHEN @STATUSID = 'CLIENT'           
                  THEN @STATUSNAME           
                  ELSE '%'       
    
            END          
         )           
        AND C1.BRANCH_CD LIKE @STRBRANCH +'%'           
        AND EXISTS(SELECT CLTCODE FROM #CL_LIST C WHERE C2.PARTY_CODE = C.CLTCODE)            


          
DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
   
         SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =    
       
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                    
    WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                 
     
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
   
                     CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
       
                 ), 0)           
                  FROM LEDGER B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
               
         AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE     
      
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
           
            THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM LEDGER B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END 
               
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE  
         
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
          
                          CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
              
                            THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND 
VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
  OPPBAL = ISNULL(SUM
(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE 
-B.VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM
 #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
   
                     )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
         
         INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
             
                 SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'        
   
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                           
         AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                   
                 OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                       
                   ELSE -VAMT         
                                    END          
                                    )           
                              FROM LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                 
                   OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
									
		ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
               AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                
        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */               
 
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            
INTO #LEDGERDATA           
            FROM LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2           
  
                     
                
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'      
          
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,
CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00' 
          
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'           
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                
 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'           
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END
                
          
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
   
    [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       [EMAIL] VARCHAR(500),
       [MOBILE_PAGER] VARCHAR(50)
      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
  
    INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
 VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
  
          CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15)
,           
            L.NARRATION,           
            C.PARTY_CODE CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,         
  
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           

            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			EMAIL,
			MOBILE_PAGER
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )           
          
          

                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE  
         
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM LEDGER B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBA
NK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
                
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT
'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
    AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
         
   END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END              
  
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
            
      FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')       
                  ORDER BY L.ACNAME
,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.ACNAME,       
   
                        EFFDT, PDT        
            END                
      END                
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RPT_ACCALLPARTYLEDVOUCHERDISP]            
 @VTYP SMALLINT ,            
 @VNO VARCHAR (12),            
 @VDT VARCHAR(12) ,            
 @BOOKTYPE VARCHAR(2),            
 @BRANCH VARCHAR(10),            
 @CLTCODE VARCHAR(10)            
            
AS   

 IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0  
  BEGIN  
   SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)  
  END  
 
      
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'            
BEGIN            
 SELECT    
  VAMT, L.VTYP, L.VNO, L.VDT, L.DRCR, CLTCODE, ACNAME,  L.LNO,   
  DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103), PARTY_CODE
 FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO LEFT OUTER JOIN MARGINLEDGER ML ON ML.VTYP = L.VTYP AND ML.BOOKTYPE = L.BOOKTYPE AND ML.VNO = L.VNO         
  AND L.LNO = ML.LNO 
 WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(L.VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
 ORDER BY   
  L.DRCR DESC , L.LNO             
END            
ELSE            
BEGIN            
  SELECT    
  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,             
  DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103)              
  FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO,            
  LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE            
  WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
  AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO            
  AND COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))            
  ORDER BY   
  L2.DRCR DESC , L2.LNO             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TRIALBALANCE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLS_TRIALBALANCE]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VIEWOPTION VARCHAR(10), /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)

CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BROKER' AND @BRANCHCODE <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @BRANCHCODE
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT,VDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT, EDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
	END
END


IF UPPER(@VIEWOPTION) = 'GL'
BEGIN
	IF UPPER(@STATUSID) = 'BROKER'
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
	
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @NET_AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
	ELSE
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
		AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE)
		
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @NET_AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
END	


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + "WHERE ACCAT <> 4 "
ELSE IF UPPER(@VIEWOPTION) = 'PARTY'
	SET @@SQL = @@SQL + "WHERE ACCAT = 4 "	
ELSE IF UPPER(@VIEWOPTION) = 'ALL'
	SET @@SQL = @@SQL + "WHERE ACCAT = ACCAT "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
	
EXEC(@@SQL)	




IF UPPER(@STATUSID) = 'BROKER'
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', ''
END
ELSE
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE', ''
END

DROP TABLE #FORMULA_CLIENT_MASTER

SET @@SQL = "INSERT INTO ACCOUNT.." + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CMSPAYMENT_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[CMSPAYMENT_BULK]        
  
 @FNAME VARCHAR(100),        
 @UNAME VARCHAR(25),        
 @BANK_CODE VARCHAR(10),        
 @USERCAT SMALLINT        
        
AS        
/*        
 CMSPAYMENT_BULK 'D:\BACKOFFICE\CMSPAYMENT\TEST_SAMPLE.CSV', 'SAMPLE', '03036', 1        
*/        
SET NOCOUNT ON        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@STD_DATE VARCHAR(11),        
 @@LST_DATE VARCHAR(11),        
 @@BRANCHFLAG AS TINYINT,        
 @@VNOFLAG AS TINYINT,        
 @@VNOMETHOD INT,        
 @@ACNAME CHAR(100),        
 @@BOOKTYPE CHAR(2),        
 @@MICRNO VARCHAR(10),        
 @@DRCR VARCHAR(1),        
 @@VTYP SMALLINT,        
 @@BANK_CODE VARCHAR(100),        
 @@BACKDAYS INT,        
 @@BACKDATE VARCHAR(11),        
 @@BRNCOUNT   TINYINT,        
 @@MonthlyVdt VARCHAR(11),        
 @@SERIAL_NO INT,        
 @@COSTCODECOUNT TINYINT,        
 @@COSTCODEUPDATES CURSOR,        
 @@NEWVNO AS VARCHAR(12),        
 @@MAXCOUNT AS INT,        
 @@VDT AS VARCHAR(11),        
 @@COUNTER AS INT,        
 @@BANKBRANCH AS VARCHAR(10),        
 @@BANKCOST AS NUMERIC,        
 @@LNOCUR AS CURSOR,        
 @@VNOCUR AS CURSOR,        
 @@LNOVNO AS VARCHAR(12),        
 @@MAXVNO AS INT,        
 @@L2CUR AS CURSOR,        
 @@L2VNO AS VARCHAR(12),        
 @@ERROR_COUNT AS INT,        
 @@FILEEXISTS AS INT,        
 @@SQL AS VARCHAR(2000)        
        
/*--------------------------VALIDATION BASED ON VALID BANK CODE ------------------------*/        
SELECT        
 @@ERROR_COUNT = ISNULL(COUNT(1), 0)        
FROM        
 ACMAST        
WHERE        
 CLTCODE = @BANK_CODE        
 AND ACCAT = 2        
        
IF @@ERROR_COUNT = 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS SUPPLIED BANK CODE DOES NOT EXIST AS BANK', 'NA','NA'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
IF LEFT(@FNAME, 25) <> 'D:\BackOffice\CMSPayment\'        
 BEGIN        
  SELECT 'THE FILE YOU ARE UPLOADING MUST BE LOCATED IN D:\BackOffice\CMSPayment OF DATA SERVER', 'NA', 'NA'        
  RETURN        
 END        
        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'        
  RETURN        
 END        
CREATE TABLE #FEXIST        
(        
 F1 SMALLINT,        
 F2 SMALLINT,        
 F3 SMALLINT        
)        
SELECT @@SQL = "INSERT INTO "        
SELECT @@SQL = @@SQL + " #FEXIST "        
SELECT @@SQL = @@SQL + " (F1, F2, F3) "        
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "        
        
EXEC(@@SQL)        
        
SELECT        
 @@FILEEXISTS = F1        
FROM        
 #FEXIST        
        
IF @@FILEEXISTS = 0        
 BEGIN        
  DROP TABLE #FEXIST        
  SELECT        
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'        
  RETURN        
 END        
DROP TABLE #FEXIST        
        
BEGIN TRAN        
        
INSERT INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FNAME,        
 @FNAME,        
 CNT = COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'RECEIPT/PAYMENT UPLOAD'        
        
        
CREATE TABLE #CMSFILE        
(        
 PRODUCT_CO VARCHAR(20),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 BENEF_DESCRIPTION VARCHAR(100),        
 AMOUNT MONEY,        
 LOC_DESCRIPTION VARCHAR(50),        
 STATUS VARCHAR(20),        
 CLTCODE VARCHAR(10),        
 NARRATION VARCHAR(234)        
)        
CREATE TABLE #RECPAY_TABLE_TMP        
(        
 SERIAL_NO INT IDENTITY(1,1),        
 EDATE VARCHAR(20),        
 VOUCHER_DATE VARCHAR(20),        
 CLIENT_CODE VARCHAR(50),        
 AMOUNT MONEY,        
 DRCR VARCHAR(1),        
 NARRATION VARCHAR(234),        
 BANK_CODE VARCHAR(10),        
 BANK_NAME VARCHAR(100),        
 REF_NO VARCHAR(15),        
 BRANCHCODE VARCHAR(20),        
 BRANCH_NAME VARCHAR(50),        
 CHQ_MODE VARCHAR(1),        
 CHQ_DATE VARCHAR(20),        
 CHQ_NAME VARCHAR(100),        
 CL_MODE VARCHAR(1)        
)        
CREATE TABLE [#RECPAY_TABLE]        
(        
 SERIAL_NO INT,        
 EDATE VARCHAR(20),        
 VOUCHER_DATE VARCHAR(20),        
 CLIENT_CODE VARCHAR(50),        
 AMOUNT MONEY,        
 DRCR VARCHAR(1),        
 NARRATION VARCHAR(234),        
 BANK_CODE VARCHAR(10),        
 BANK_NAME VARCHAR(100),        
 REF_NO VARCHAR(15),        
 BRANCHCODE VARCHAR(20),        
 BRANCH_NAME VARCHAR(50),        
 CHQ_MODE VARCHAR(1),        
 CHQ_DATE VARCHAR(20),        
 CHQ_NAME VARCHAR(100),        
 CL_MODE VARCHAR(1),        
 SNO INT IDENTITY (1, 1) NOT NULL ,        
 VDT DATETIME NULL ,        
 FYSTART DATETIME NULL ,        
 FYEND DATETIME NULL ,        
 UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),        
 EDT DATETIME NULL ,        
 DDDT DATETIME NULL ,        
 VNO VARCHAR (12) NULL ,        
 VTYP SMALLINT NULL ,        
 ACNAME VARCHAR (100) NULL ,        
 COSTCODE SMALLINT NULL,        
 BANKCOST SMALLINT NULL,        
 LNO SMALLINT NOT NULL DEFAULT(0),        
 BANKNAME VARCHAR(100) NULL,        
 MICRNO INT NULL,        
 BOOKTYPE VARCHAR(2) NULL,        
) ON [PRIMARY]        
        
SELECT @@SQL = "BULK INSERT #CMSFILE FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "        
EXEC (@@SQL)        
        
IF @@ERROR <> 0        
 BEGIN        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRANSACTION        
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'        
  RETURN        
 END        
INSERT INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FNAME,        
 @FNAME,        
 CNT = COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'RECEIPT/PAYMENT UPLOAD'        
INSERT INTO        
 #RECPAY_TABLE        
 (        
  EDATE,        
  VOUCHER_DATE,        
  CLIENT_CODE,        
  AMOUNT,        
  DRCR,        
  NARRATION,        
  BANK_CODE,        
  REF_NO,        
  CHQ_MODE,        
  CHQ_DATE,        
  CL_MODE        
 )        
SELECT        
 DDDT,        
 DDDT,        
 UPPER(LTRIM(RTRIM(CLTCODE))),        
 AMOUNT,        
 DRCR = 'D',        
 NARRATION,        
 BANK_CODE = @BANK_CODE,        
 REF_NO = DDNO,        
 CHQ_MODE = 'C',        
 CHQ_DATE = DDDT,        
 CL_MODE = 'O'        
FROM        
 #CMSFILE        
        
UPDATE #RECPAY_TABLE SET SERIAL_NO = SNO        
        
UPDATE        
 #RECPAY_TABLE        
SET        
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))        
        
SELECT TOP 1        
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)        
FROM        
 #RECPAY_TABLE        
        
SELECT        
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),        
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),        
 @@BRANCHFLAG = BRANCHFLAG,        
 @@VNOFLAG = VNOFLAG        
FROM        
 PARAMETER        
WHERE        
 @@VDT BETWEEN SDTCUR AND LDTCUR        
        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = A.BRANCHCODE,        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   COSTCODE = C.COSTCODE,        
   BANK_NAME = B.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = COSTNAME        
          
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = 'HO',        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'),        
   BANK_NAME = B.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = 'ALL'        
        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = 'HO',        
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,        
   BANKNAME = B.LONGNAME,        
   BANK_NAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
   AND #RECPAY_TABLE.UPDFLAG = 'N'        
 END        
ELSE        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   FYSTART = @@STD_DATE,        
   FYEND = @@LST_DATE + ' 23:59:59',        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BANK_NAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
 END        
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */        
        
 SELECT        
  @@ERROR_COUNT = COUNT(DISTINCT VDT)        
 FROM        
  #RECPAY_TABLE        
 IF @@ERROR_COUNT > 1        
  BEGIN        
   SELECT        
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
 SELECT @@ERROR_COUNT = 0        
        
/* -------------- VALIDATION FOR DEFAULT FINANCIAL YEAR-------------------------- */        
        
 SELECT        
  @@ERROR_COUNT = COUNT(1)        
 FROM        
  #RECPAY_TABLE R, PARAMETER P        
 WHERE R.VDT NOT BETWEEN SDTCUR AND LDTCUR AND CURYEAR = 1        
        
 IF @@ERROR_COUNT > 1        
  BEGIN        
   SELECT        
    'SOME OF THE VOUCHERS ARE NOT FALLING IN DEFAULT FINANCIAL YEAR.', 'NA', 'NA'        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
 SELECT @@ERROR_COUNT = 0        
        
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   DDNO  = RP.REF_NO        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.REF_NO <> '0'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   RP.REF_NO, 'NA','NA'        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.CHQ_MODE <> 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   CLIENT_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   CLIENT_CODE, 'NA','NA'        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
/*--------------------------VALIDATION BASED ON VDTs OUTSIDE FINANCIAL YEAR ------------------------*/        
SELECT        
 @@ERROR_COUNT = ISNULL(COUNT(1), 0)        
FROM        
 #RECPAY_TABLE        
WHERE        
 VDT NOT BETWEEN FYSTART AND FYEND        
        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS SOME OF THE DATES ARE NOT FALLING IN CURRENT FINANCIAL YEAR.', 'NA','NA'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
        
/*----------------VNO GENERATION--------------------------*/        
CREATE TABLE #VNO (VNO VARCHAR(12))        
SELECT @@BOOKTYPE = BOOKTYPE, @@VDT = CONVERT(VARCHAR(11), VDT, 109), @@COUNTER = COUNT(1) FROM #RECPAY_TABLE GROUP BY BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)        
INSERT INTO #VNO EXEC ACC_GENVNO_NEW @@VDT, 3, @@BOOKTYPE, @@STD_DATE, @@LST_DATE, @@COUNTER        
SELECT @@NEWVNO = VNO FROM #VNO        
UPDATE #RECPAY_TABLE SET VNO = CONVERT(VARCHAR(12), (CONVERT(NUMERIC, @@NEWVNO) + SERIAL_NO) - 1)        
DROP TABLE #VNO        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  UPDATE #RECPAY_TABLE        
  SET BANKCOST = C.COSTCODE        
  FROM ACMAST A, COSTMAST C        
  WHERE         
   #RECPAY_TABLE.BANK_CODE = A.CLTCODE        
   AND A.ACCAT = 2        
   AND A.BRANCHCODE = C.COSTNAME        
   AND A.BRANCHCODE <> 'ALL'        
        
  UPDATE #RECPAY_TABLE      
  SET BANKCOST = COSTCODE        
  FROM ACMAST A        
  WHERE         
   #RECPAY_TABLE.BANK_CODE = A.CLTCODE        
   AND A.ACCAT = 2        
   AND A.BRANCHCODE = 'ALL'        
 END        
        
        
        
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */        
INSERT INTO        
 LEDGER1        
  (        
   BNKNAME,        
   BRNNAME,        
   DD,        
   DDNO,        
   DDDT,        
   RELDT,        
   RELAMT,        
   REFNO,        
   RECEIPTNO,        
   VTYP,        
   VNO,        
   LNO,        
   DRCR,        
   BOOKTYPE,        
   MICRNO,        
   SLIPNO,        
   SLIPDATE,        
   CHEQUEINNAME,        
   CHQPRINTED,        
   CLEAR_MODE        
  )        
SELECT        
 BNKNAME = MAX(BANK_NAME),        
 BRNNAME = MAX(BRANCH_NAME),        
 DD = MAX(CHQ_MODE),        
 DDNO = MAX(REF_NO),        
 DDDT = MAX(DDDT),        
 RELDT = '',        
 RELAMT = SUM(AMOUNT),        
 REFNO = 0,        
 RECEIPTNO = 0,        
 VTYP,        
 VNO,        
 LNO = 2,        
 DRCR,        
 BOOKTYPE = BOOKTYPE,        
 MICRNO = MICRNO,        
 SLIPNO = 0,        
 SLIPDATE = '',        
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),        
 CHQPRINTED = 0,      
 CLEAR_MODE = MAX(CL_MODE)        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 DRCR,        
 BOOKTYPE,        
 MICRNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
        
/*================================        
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK        
=================================*/        
CREATE TABLE #LEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 EDT DATETIME,        
 LNO SMALLINT,        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 VAMT MONEY,        
 VDT DATETIME,        
 VNO1 VARCHAR(12),        
 REFNO CHAR(12),        
 BALAMT MONEY,        
 NODAYS INT,        
 CDT DATETIME,        
 CLTCODE VARCHAR(10),        
 BOOKTYPE VARCHAR(2),        
 ENTEREDBY VARCHAR(25),        
 PDT DATETIME,        
 CHECKEDBY VARCHAR(25),        
 ACTNODAYS INT,        
 NARRATION VARCHAR(234)        
)        
CREATE TABLE #LEDGER3        
(        
 NARATNO INT,        
 NARR VARCHAR(234),        
 REFNO CHAR(12),        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 BOOKTYPE VARCHAR(2)        
)            
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
 (        
  VTYP,        
  VNO,        
  EDT,        
  LNO,        
  ACNAME,        
  DRCR,        
  VAMT,        
  VDT,        
  VNO1,        
  REFNO,        
  BALAMT,        
  NODAYS,        
  CDT,        
  CLTCODE,        
  BOOKTYPE,        
  ENTEREDBY,        
  PDT,        
  CHECKEDBY,        
  ACTNODAYS,        
  NARRATION        
 )        
SELECT        
 VTYP,        
 VNO,        
 EDT,        
 LNO = 2,        
 ACNAME,        
 DRCR,        
 VAMT = AMOUNT,        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = AMOUNT,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = CLIENT_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION        
FROM        
 #RECPAY_TABLE        
        
        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
SELECT        
 VTYP,        
 VNO,        
 EDT,        
 LNO = 1,        
 BANKNAME,        
 DRCR =        
  (        
   CASE        
    WHEN DRCR = 'D'        
    THEN 'C'        
    ELSE 'D'   
   END        
  ),        
 VAMT = SUM(AMOUNT),        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = SUM(AMOUNT),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = BANK_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION = MAX(NARRATION)        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 EDT,        
 DRCR,        
 VDT,        
 BANK_CODE,        
 BOOKTYPE,        
 BANKNAME        
        
/*==============================        
INSERTING ALL LEDGER RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER        
SELECT        
 *        
FROM        
 #LEDGER        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 LNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER        
        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = 1,        
 NARRATION = MAX(NARRATION),        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM       
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 BOOKTYPE        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = 2,        
 NARR = NARRATION,        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM        
 #RECPAY_TABLE        
        
        
        
        
/*==============================        
INSERTING ALL LEDGER3 RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER3        
SELECT        
 *        
FROM        
 #LEDGER3        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 NARATNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER3        
        
IF @@BRANCHFLAG = 1    
    
       
 BEGIN        
  INSERT INTO LEDGER2        
   (VTYPE, VNO, LNO, DRCR, CAMT, COSTCODE, BOOKTYPE, CLTCODE)        
  SELECT        
   VTYPE = 3,        
   VNO,        
   LNO = 1,        
   DRCR = 'C',        
   CAMT = AMOUNT,        
   COSTCODE,        
   BOOKTYPE,        
   BANK_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   COSTCODE = BANKCOST        
        
      
  INSERT INTO LEDGER2        
   (VTYPE, VNO, LNO, DRCR, CAMT, COSTCODE, BOOKTYPE, CLTCODE)        
  SELECT        
   VTYPE = 3,        
   VNO,        
   LNO = 2,        
   DRCR = 'D',        
   CAMT = AMOUNT,        
   COSTCODE,        
   BOOKTYPE,        
   CLIENT_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   COSTCODE = BANKCOST        
        
        
        
  SET @@L2CUR = CURSOR FOR        
   SELECT DISTINCT VNO FROM #RECPAY_TABLE WHERE COSTCODE <> BANKCOST        
  OPEN @@L2CUR        
  FETCH NEXT FROM @@L2CUR INTO @@L2VNO        
  WHILE @@FETCH_STATUS = 0        
   BEGIN        
    DELETE FROM        
     TEMPLEDGER2        
    WHERE        
     SESSIONID = '9999999999'        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     AMOUNT,        
     VTYP = 3,        
     VNO,        
     LNO = 2,        
     DRCR = 'D',        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     CLIENT_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.COSTCODE = C.COSTCODE        
     AND VNO = @@L2VNO        
        
/*==============================        
BANK SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     SUM(AMOUNT),        
     VTYP = 3,        
     VNO,        
     LNO = 1,        
     DRCR = 'C',        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     BANK_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.BANKCOST = C.COSTCODE        
     AND VNO = @@L2VNO        
    GROUP BY        
     C.COSTNAME,        
     VNO,        
     BANK_CODE,        
     BOOKTYPE     
    
        
        
    EXEC INSERTTOLEDGER2        
     '9999999999',        
     @@L2VNO,        
     '1',        
     '1',        
     '1',        
     'BROKER',        
     'BROKER'        
    FETCH NEXT FROM @@L2CUR INTO @@L2VNO        
   END        
  DELETE FROM        
   TEMPLEDGER2        
  WHERE        
   SESSIONID = '9999999999'        
 END        
COMMIT TRAN     
    
      
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE        
DROP TABLE #RECPAY_TABLE_TMP        
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CMSRECO_BULK_YES
-- --------------------------------------------------







CREATE PROC [dbo].[CMSRECO_BULK_YES]
 @BANKCODE VARCHAR(10),      
 @FNAME VARCHAR(500),      
 @UNAME VARCHAR(100)      
      
AS      
      
SET NOCOUNT ON       
/*--------------------------VALIDATION FOR SINVOUCHER TYPE BASED ON DRCR ------------------------*/      
      
DECLARE        
 @@ERROR_COUNT INT,       
 @@CMSRECOCOUNT AS INT,       
 @@MICRNO AS VARCHAR(10),      
 @@FROMDATE AS DATETIME,      
 @@SQL VARCHAR(8000)      
      
      
/*        SELECT @@ERROR_COUNT = COUNT(1) FROM (SELECT U_FILENAME FROM V2_UPLOADED_FILES        
WHERE U_FILENAME = '" & UCASE(FNAME) &' AND U_MODULE = 'CMS AUTO-RECONCILIATION') A       
      
IF @@ERROR_COUNT > 0       
BEGIN       
SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + '" & UCASE(FNAME) &'       
RETURN       
END */      
      
/*--        DROP TABLE #CMS_TABLE        
--        DROP TABLE #CMS_TABLE_TMP  */      
CREATE TABLE #CMS_TABLE_TMP       
(       
 STRLINETEXT VARCHAR(8000)       
)       
      
CREATE TABLE [DBO].[#CMS_TABLE_TEST] (       
	CORPORATION_CODE VARCHAR(15),
	CLIENT_CODE VARCHAR(20),
	PICKUP_LOC_CODE VARCHAR(50),
	PICKUP_POINT_CODE VARCHAR(50),
	ACCT_ENTRY_AMNT VARCHAR(25),
	DEPOSIT_SLIP_AMT VARCHAR(25),
	DRAWEE_BANK_DESCRIPTION VARCHAR(50),
	ACT_CLIENT_VALUE_DATE VARCHAR(30),
	CLEARING_LOC_DESC VARCHAR(50),
	DEBIT_CREDIT_FLAG VARCHAR(50),
	DEPOSIT_DATE VARCHAR(20),
	DEPOSIT_ENTRY_DATE VARCHAR(20),
	DEPOSIT_NMBR VARCHAR(25),
	DRAWER_DESCRIPTION VARCHAR(100),
	INPUT_DEPOSIT_NMBR VARCHAR(25),
	INSTRUMENT_DATE VARCHAR(25),
	INSTRUMENT_NMBR VARCHAR(30),
	PRODUCT_CODE VARCHAR(25),
	PRODUCT_DESCRIPTION VARCHAR(50),
	REMARKS VARCHAR(50),
	RETURN_REASON VARCHAR(100),
	VALUE_DATE VARCHAR(25),
	ENRICHMENT VARCHAR(500),
	ENRICHMENT1 VARCHAR(500),
	ENRICHMENT2 VARCHAR(500),
	ENRICHMENT3 VARCHAR(500),
	ENRICHMENT4 VARCHAR(500),
	ENRICHMENT5 VARCHAR(500),
	ENRICHMENT6 VARCHAR(500),
	ENRICHMENT7 VARCHAR(500),
	ENRICHMENT8 VARCHAR(500),      
	ENRICHMENT9 VARCHAR(500)
) ON [PRIMARY]       
      
CREATE TABLE [DBO].[#CMS_TABLE] (       
	[SNO] [INT] NOT NULL IDENTITY(1,1),       
	CORPORATION_CODE VARCHAR(15),
	CLIENT_CODE VARCHAR(20),
	PICKUP_LOC_CODE VARCHAR(50),
	PICKUP_POINT_CODE VARCHAR(50),
	ACCT_ENTRY_AMNT VARCHAR(25),
	DEPOSIT_SLIP_AMT VARCHAR(25),
	DRAWEE_BANK_DESCRIPTION VARCHAR(50),
	ACT_CLIENT_VALUE_DATE VARCHAR(20),
	CLEARING_LOC_DESC VARCHAR(50),
	DEBIT_CREDIT_FLAG VARCHAR(5),
	DEPOSIT_DATE VARCHAR(20),
	DEPOSIT_ENTRY_DATE VARCHAR(20),
	DEPOSIT_NMBR VARCHAR(25),
	DRAWER_DESCRIPTION VARCHAR(100),
	INPUT_DEPOSIT_NMBR VARCHAR(25),
	INSTRUMENT_DATE VARCHAR(25),
	INSTRUMENT_NMBR VARCHAR(25),
	PRODUCT_CODE VARCHAR(25),
	PRODUCT_DESCRIPTION VARCHAR(50),
	REMARKS VARCHAR(50),
	RETURN_REASON VARCHAR(50),
	VALUE_DATE VARCHAR(25),
	ENRICHMENT VARCHAR(500),
	ENRICHMENT1 VARCHAR(25),
	ENRICHMENT2 VARCHAR(25),
	ENRICHMENT3 VARCHAR(25),
	ENRICHMENT4 VARCHAR(25),
	ENRICHMENT5 VARCHAR(25),
	ENRICHMENT6 VARCHAR(25),
	ENRICHMENT7 VARCHAR(25),
	ENRICHMENT8 VARCHAR(25),      
	ENRICHMENT9 VARCHAR(25),  
	[STRBANKCODE] [VARCHAR] (10) NOT NULL,       
	[STRSTATUS] [VARCHAR] (8) NOT NULL,
	[E3] [VARCHAR] (20) NULL,
	[CROSSREFERENCENO] INT NULL, 
) ON [PRIMARY]       
      
      
      
SELECT @@SQL = "BULK INSERT #CMS_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 2, LASTROW = 2, KEEPNULLS)"      
EXEC (@@SQL)   
     
SELECT @@SQL = "BULK INSERT #CMS_TABLE_TEST FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 2, KEEPNULLS)"                  
EXEC (@@SQL)        

CREATE TABLE #CMS_PROCESS
(
	[SNO] [INT] NOT NULL IDENTITY(1,1),       
	BANKCODE VARCHAR(10), 
	CLTCODE VARCHAR(10),
	ACCNO VARCHAR(30), 
	DEPOSIT_DATE DATETIME, 
	ENTRY_AMNT MONEY,
	INST_NO VARCHAR(30),
	DRCR CHAR(1),
	VALUE_DATE DATETIME,
	[CROSSREFERENCENO] INT NULL,
	STRSTATUS VARCHAR(10)
)

DECLARE
	@CMS_CODE VARCHAR(20)
	
SELECT @CMS_CODE = CMS_CODE FROM account..COMPANY_MASTER_SETTING M, Owner O
WHERE M.EXCHANGE = O.Exchange AND M.SEGMENT = O.segment	



INSERT INTO #CMS_PROCESS
SELECT 
	@BANKCODE, 
	LEFT(LTRIM(RTRIM(.DBO.PIECE((REPLACE(REPLACE(ENRICHMENT, 'CLIENT ID :- ', ''), 'CLIENT ACCOUNT NO :- ', '')), '.' , 1))), 10),
	LEFT(LTRIM(RTRIM(.DBO.PIECE((REPLACE(REPLACE(ENRICHMENT, 'CLIENT ID :- ', ''), 'CLIENT ACCOUNT NO :- ', '')), '.' , 2))), 30),
	CONVERT(DATETIME, DEPOSIT_DATE, 101),
	ACCT_ENTRY_AMNT,
	.DBO.REMOVE_ZERO1(INSTRUMENT_NMBR,'0'),
	DEBIT_CREDIT_FLAG,
	CONVERT(DATETIME, VALUE_DATE, 101),
	0,
	'MISMATCH'
FROM #CMS_TABLE_TEST
WHERE CLIENT_CODE = @CMS_CODE



/*      
INSERT INTO V2_UPLOADED_FILES       
SELECT       
 @FNAME,       
 @FNAME,       
 COUNT(1),       
 'B',       
 GETDATE(),       
 @UNAME,       
 'CMS AUTO-RECONCILIATION'       
*/      
      

 
 
      
SELECT @@FROMDATE = DATEADD ( DD , -90, getdate())       

CREATE TABLE #FIRST_HASH_LEDGER
(
	VNO VARCHAR(12),
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	LNO INT,
	CLTCODE VARCHAR(10)
)


INSERT INTO       
 #FIRST_HASH_LEDGER             
SELECT       
 VNO,       
 VTYP,      
 BOOKTYPE,       
 LNO,
 CLTCODE
FROM       
 LEDGER L WITH (NOLOCK)
WHERE       
 VTYP IN (2, 3, 5, 19, 20, 17)       
 AND EXISTS(SELECT VNO FROM LEDGER L1 WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND CLTCODE = @BANKCODE AND VDT >= @@FROMDATE)
 
      
      
SELECT       
 L1.VNO,       
 L1.VTYP,       
 L1.BOOKTYPE,       
 L1.RELAMT,       
 .dbo.REMOVE_ZERO1(L1.ddno, '0')as ddno,
 L1.DRCR,       
 STATUS = 'MISMATCH',       
 SNO = 0,
 REFNO = L1.REFNO,
 CLTCODE,
 RELDT
INTO       
 #FIRST_HASH_LEDGER1       
FROM       
 LEDGER1 L1 WITH (NOLOCK),       
 #FIRST_HASH_LEDGER F WITH (NOLOCK)       
WHERE       
 F.VNO = L1.VNO       
 AND F.VTYP = L1.VTYP       
 AND F.BOOKTYPE = L1.BOOKTYPE       
 AND F.LNO = L1.LNO       
 AND L1.RELDT = ''       
 AND L1.DDNO <> ''       
 AND L1.DDNO <> '0'       
      
DROP TABLE #FIRST_HASH_LEDGER 

DECLARE
	@@CROSS_NO INT
	
SELECT @@CROSS_NO = MAX(CROSSREFERENCENO) FROM BANKRECO

UPDATE #CMS_PROCESS SET CROSSREFERENCENO = @@CROSS_NO + SNO
      
UPDATE       
 L1       
SET       
 STATUS = 'CORRECT',       
 SNO = C.SNO,
 L1.REFNO = CROSSREFERENCENO,
 RELDT = VALUE_DATE      
FROM    
 #FIRST_HASH_LEDGER1 L1,       
 #CMS_PROCESS C WITH (NOLOCK),
 MULTIBANKID M       
WHERE       
 L1.RELAMT = C.ENTRY_AMNT       
 AND L1.DDNO = C.INST_NO
 AND L1.DRCR = C.DRCR
 AND L1.CLTCODE = C.CLTCODE
 AND L1.CLTCODE = M.CLTCODE
 AND M.ACCNO = C.ACCNO
 AND L1.VNO IN      
 (SELECT MIN(VNO) FROM #FIRST_HASH_LEDGER1 L2      
   WHERE L2.RELAMT = C.ENTRY_AMNT       
   AND L2.DDNO = C.INST_NO       
   AND L2.DRCR = C.DRCR)       
      
UPDATE       
 C      
SET       
 STRSTATUS = 'CORRECT'       
FROM       
 #CMS_PROCESS C,       
 #FIRST_HASH_LEDGER1 L1 WITH (NOLOCK)       
WHERE       
 C.SNO = L1.SNO
 
 
 
DELETE       
FROM       
 #FIRST_HASH_LEDGER1       
WHERE       
 STATUS <> 'CORRECT'       
      
SELECT       
 @@ERROR_COUNT = COUNT(1)       
FROM       
 #CMS_PROCESS      
WHERE       
 STRSTATUS <> 'CORRECT'
 AND DRCR = 'C'       
      
SELECT       
 @@MICRNO = MICRNO       
FROM       
 ACMAST       
WHERE       
 CLTCODE = @BANKCODE 
 
 
BEGIN TRAN             
      
/*DELETE FROM CMSRECO WHERE BANK_CODE = @BANKCODEAND FILEHEADER_DATE = @@FILEHEADERDATE       
DELETE FROM CMSRECODETAILS WHERE BANK_CODE = @BANKCODEAND FILEHEADER_DATE = @@FILEHEADERDATE  */      
      
      
/*-----------------------INSERTING INTO CMSRECO, CMSRECODETAILS AND UPDATING LEDGER1 WHEN ALL ARE MATCHED---------*/       
/*
 INSERT        
 INTO CMSRECO        
 (       
  FILEHEADER_DATE,        
  BANK_CODE,        
  MICR_NO,        
  ENTRY_AMOUNT,        
  DEPOSIT_AMOUNT,        
  INST_AMOUNT,        
  STATUS_ID,        
  STATUS_NAME,        
  UPLOAD_BY,        
  UPLOAD_DATE,        
  AMOUNTMISMATCH,        
  MANUALUPDATE,        
  LEDGERAMOUNT       
 )        
 SELECT        
  @@FILEHEADERDATE,        
  BANK_CODE = @BANKCODE,        
  @@MICRNO,        
  ENTRY_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END,        
  DEPOSIT_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRDEPOSITAMOUNT)  ELSE SUM(STRDEPOSITAMOUNT)  END,        
  INST_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRINSTAMOUNT)  ELSE SUM(STRINSTAMOUNT)  END,        
  STATUS_ID = @UNAME,        
  STATUS_NAME = @UNAME,        
  UPLOAD_BY = @UNAME,        
  UPLOAD_DATE = GETDATE(),        
  AMOUNTMISMATCH = 'NO',        
  MANUALUPDATE = 'NO',        
  LEDGERAMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END        
 FROM       
  #CMS_TABLE WITH(NOLOCK)  
  WHERE STRDC = 'C'    
 GROUP BY       
  STRDC        
       
*/       
       
 UPDATE        
  LEDGER1        
 SET       
  RELDT = L1.RELDT,    
  REFNO = L1.REFNO        
 FROM       
  #FIRST_HASH_LEDGER1 L1        
 WHERE       
  LEDGER1.VNO = L1.VNO        
  AND LEDGER1.VTYP = L1.VTYP        
  AND LEDGER1.BOOKTYPE = L1.BOOKTYPE        
  AND LEDGER1.RELAMT = L1.RELAMT        
  AND LEDGER1.DRCR = L1.DRCR        
  AND LEDGER1.RELDT = ''        
  AND STATUS = 'CORRECT'      
       
/*        
      
INSERT        
INTO CMSRECODETAILS        
(        
 FILEHEADER_DATE,        
 ROW_TYPE,        
 ENTRY_ID,        
 ENTRY_TYPE,        
 DEBIT_CREDIT,        
 ENTRY_AMOUNT,        
 VALUE_DATE,        
 POST_DATE,        
 PROD_CODE,        
 PICKUP_LOCATION,        
 PICKUP_DISC,        
 PICKUP_DATE,        
 DEPOSIT_SLIP,      
 DEPOSIT_DATE,        
 DEPOSIT_AMOUNT,        
 NO_OF_INST,        
 DEPOSIT_REMARK,        
 INST_NO,        
 DRAWEE_BANK,        
 CLEAR_LOC,        
 INST_AMOUNT,        
 INST_DATE,        
 DRAWER_NAME,        
 ENRICHMENT_NO,        
 ENRICHMENT_DATE,        
 ENRICHMENT_REMARKS,        
 FILLER,        
 BANK_CODE,        
 MICR_NO,        
 STATUS_ID,        
 STATUS_NAME,        
 UPLOAD_BY,        
 UPLOAD_DATE,        
 STATUS,        
LEDGERAMOUNT        
)        
SELECT        
 @@FILEHEADERDATE,        
 STRROWTYPE,        
 STRENTRYID,        
 STRENTRYTYPE,        
 STRDC,        
 STRENTRYAMOUNT,        
 STRVALUEDATE,        
 STRPOSTDATE,        
 STRPRDCODE,        
 STRPKLOCATION,        
 STRPKDESCRIPTION,        
 STRPKDATE,        
 STRDEPOSITSLIP,        
 STRDEPOSITDATE,        
 STRDEPOSITAMOUNT,        
 STRNOOFINST,        
 STRDEPOSITREMARK,        
 STRINSTNO,        
 STRDRAWEEBANK,        
 STRCLEARLOCATION,        
 STRINSTAMOUNT,        
 STRINSTDATE,        
 STRDRAWERNAME,        
 STRENRICHMENTNO,        
 STRENRICHMENTDATE,        
 STRENRICHMENTREMARK,        
 STRFILLER,        
 STRBANKCODE,        
 @@MICRNO,        
 STATUS_ID = @UNAME,        
 STATUS_NAME = @UNAME,        
 UPLOAD_BY = @UNAME,        
 UPLOAD_DATE = GETDATE(),        
 STRSTATUS,        
 LEDGERAMOUNT = 0       
FROM       
 #CMS_TABLE WITH(NOLOCK) 
 WHERE STRDC = 'C'   
 
 UPDATE BANKRECO SET STATUS = 'MATCHED' WHERE CLTCODE = @BANKCODE AND DESCRIPTION LIKE '%CMS%' AND DRCR = 'C' AND BOOKDATE = @@FILEHEADERDATE        
*/
/*
DECLARE
	@@CROSS_NO INT
	
SELECT @@CROSS_NO = MAX(@@CROSS_NO) FROM BANKRECO*/

--DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND BOOKDATE = @@FILEHEADERDATE AND DESCRIPTION LIKE '%CMS%'

INSERT INTO BANKRECO(Cltcode,BookDate,Description,Amount,DrCr,ValueDate,ReferenceNo,StatusId,StatusName,LoginName,CrossReferenceNo,Status,MicrNo,Dummy1,Dummy2,CMS_SrNo)
SELECT @BANKCODE, VALUE_DATE, CLTCODE + ' ' + ACCNO + 'CMS ', ENTRY_AMNT, DRCR, VALUE_DATE, INST_NO, 'broker', 'broker', @UNAME, CROSSREFERENCENO, CASE WHEN STRSTATUS = 'CORRECT' THEN 'MATCHED' ELSE 'UNMATCHED' END, '999999999', '0', '0', ''
FROM #CMS_PROCESS
--WHERE STRENTRYTYPE = 'T'

/*SELECT @@CROSS_NO = MAX(CROSSREFERENCENO) FROM BANKRECO


INSERT INTO BANKRECO(Cltcode,BookDate,Description,Amount,DrCr,ValueDate,ReferenceNo,StatusId,StatusName,LoginName,CrossReferenceNo,Status,MicrNo,Dummy1,Dummy2,CMS_SrNo)
SELECT @BANKCODE, @@FILEHEADERDATE, 'CMS CHARGES', SUM(STRENTRYAMOUNT), STRDC, STRVALUEDATE, '0', 'broker', 'broker', @UNAME, @@CROSS_NO + 1, 'UNMATCHED', '999999999', '0', '0', ''
FROM #CMS_PROCESS
--WHERE STRENTRYTYPE = 'C'
GROUP BY STRDC, STRVALUEDATE
*/

IF @@ERROR_COUNT = 0       
BEGIN       
    
 SELECT 'DATA UPLOADED SUCCESSFULLY' AS RESULT  
    
END       
ELSE       
BEGIN       
 SELECT 'FILE UPLOADED SUCCESSFULLY WITH FOLLOWING MISMATCHES'       
 UNION ALL       
 select 'INST_NO, INST_AMT, INST_DATE, VALUE_DATE, STATUS '
 UNION ALL       
 SELECT       
  INST_NO + ', ' + CONVERT(VARCHAR, ENTRY_AMNT) + ', ' + CONVERT(VARCHAR(10), VALUE_DATE, 103) + ', AMOUNTMISMATCH' AS RESULT       
 FROM       
  #CMS_PROCESS       
 WHERE       
  STRSTATUS <> 'CORRECT'      
END        
DROP TABLE #CMS_TABLE        
DROP TABLE #CMS_TABLE_TMP       
DROP TABLE #FIRST_HASH_LEDGER1       

COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.companyname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.companyname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.companyname    Script Date: 02/04/2002 9:59:38 PM ******/
/****** Object:  Stored Procedure dbo.companyname    Script Date: 01/18/2002 1:38:04 PM ******/
/****** Object:  Stored Procedure dbo.companyname    Script Date: 12/26/2001 1:26:51 PM ******/
/****** Object:  Stored Procedure dbo.companyname    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE companyname
AS
select company from ncdx.dbo.owner

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMPUTE_DPC_CHARGES
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[COMPUTE_DPC_CHARGES]                  
(                  
 @FROM_DATE VARCHAR(11),                  
 @TO_DATE VARCHAR(11),                  
 @FROM_PARTY VARCHAR(10),                  
 @TO_PARTY VARCHAR(10)                  
)                  
AS          
          
/*          
EXEC COMPUTE_DPC_CHARGES 'SEP  1 2012', 'SEP 15 2012', 'k26447', 'k26447'          
EXEC COMPUTE_DPC_CHARGES 'SEP  1 2012', 'SEP 15 2012', 's5643', 's5643'          
          
SELECT * FROM LEDGER WHERE CLTCODE = 's5643' AND VDT < 'APR  1 2012' AND EDT >= 'APR  1 2012'          
          
SELECT * FROM DPC_CHARGES_VERIFIED_CASH WHERE ENTITY = 'NSE - CAPITAL'          
select * from ledger where vno = '201200000134' and vtyp = 15 and cltcode = 'k26447'          
*/          
          
CREATE TABLE #DPC_CHARGES                  
(                  
 DPC_DATE DATETIME,                  
 CLTCODE VARCHAR(10),                  
 LONG_NAME VARCHAR(100),                  
 BRANCH_CD VARCHAR(10),                  
 SUB_BROKER VARCHAR(25),                  
 TRADER VARCHAR(25),                  
 REGION VARCHAR(20),                  
 AREA VARCHAR(20),                  
 CL_TYPE VARCHAR(10),                  
 DPC_BALANCE MONEY,                  
 LEDGER_BALANCE MONEY,                  
 CASH_COLLATREAL MONEY,                  
 NONCASH_COLLATREAL MONEY,                  
 MARGIN_REQ MONEY,                  
 AMOUNT_REV MONEY,                  
 DPC_PERCENTE MONEY                  
)            
          
CREATE TABLE #GET_DPC_CLIENTS          
(          
 PARTY_CODE VARCHAR(10),           
 LONG_NAME VARCHAR(100),          
 BRANCH_CD VARCHAR(20),           
 SUB_BROKER VARCHAR(25),           
 TRADER VARCHAR(25),          
 AREA VARCHAR(25),          
 REGION VARCHAR(25),          
 CL_TYPE VARCHAR(10),          
 CREDIT_INT MONEY,           
 DEBIT_INT MONEY,           
 FROMDATE DATETIME,           
 TODATE DATETIME,           
 EXEMPT_NOOFDAYS TINYINT,           
 EXEMPT_NOOFDAYS_CR TINYINT,           
 MIN_INTEREST MONEY,           
 MIN_BALANCE MONEY          
)                
          
INSERT INTO #GET_DPC_CLIENTS          
SELECT * FROM .DBO.GET_DPC_CLIENTS(@FROM_PARTY, @TO_PARTY, @FROM_DATE)          
                  
/*                  
CREATE TABLE #DPC_CHARGES_FINAL                  
(                  
 DPC_DATE DATETIME,                  
 CLTCODE VARCHAR(10),                  
 LONG_NAME VARCHAR(100),                  
 BRANCH_CD VARCHAR(10),                  
 SUB_BROKER VARCHAR(25),                  
 TRADER VARCHAR(25),                  
 REGION VARCHAR(20),                  
 AREA VARCHAR(20),                  
 CL_TYPE VARCHAR(10),                  
 DPC_BALANCE MONEY,                  
 LEDGER_BALANCE MONEY,                  
 CASH_COLLATREAL MONEY,                  
 NONCASH_COLLATREAL MONEY,                  
 MARGIN_REQ MONEY,                  
 DPC_CHARGE MONEY,                  
 DPC_PERCENTE MONEY,                  
 AMOUNT_REV MONEY                  
)                  
*/                  
DECLARE                  
 @@OPEN_DATE VARCHAR(11)                  
                   
SELECT                   
 @@OPEN_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)                  
FROM                   
 PARAMETER                  
WHERE                  
 @FROM_DATE BETWEEN SDTCUR AND LDTCUR                  
       
  
                  
/* TABLE TO MAINTAIN THE T + 2 AND T + 4 LBALANCES TO APPLY THE T + 4 DEBIT BALANCE LOGIC */                  
CREATE TABLE #DEBIT_DEPC_BILLS                  
(                  
 CLTCODE VARCHAR(10),               
 T_DATE DATETIME,               
 T_2_DATE DATETIME,                  
 T_4_DATE DATETIME,                  
 BILL_AMOUNT MONEY,                  
 VDT DATETIME                  
)                  
                  
--, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE,                   
                  
                  
INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, DPC_PERCENTE, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE, AMOUNT_REV)                  
SELECT                   
 BALDATE,                   
 CLTCODE,                   
 LONG_NAME,                  
 SUM(DPC_BALANCE),                   
 LEDGER_BALANCE = SUM(DPC_BALANCE),                  
 SUM(CASH_COLLATREAL),                   
 SUM(NONCASH_COLLATREAL),                  
 SUM(MARGIN_REQ),                  
 MAX(DPC_PERCENTE),                  
 BRANCH_CD,                   
 SUB_BROKER,                   
 TRADER,                   
 REGION,                   
 AREA,                   
 CL_TYPE,                  
 AMOUNT_REV = 0                  
FROM                  
(                  
 SELECT                   
  BALDATE = @FROM_DATE,                  
  CLTCODE,                  
  LONG_NAME,                  
  DPC_BALANCE = SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END),                  
  CASH_COLLATREAL = 0,                  
  NONCASH_COLLATREAL = 0,                  
  MARGIN_REQ = 0,                  
  DPC_PERCENTE = MAX(DEBIT_INT),                  
 BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 FROM                  
  LEDGER L, #GET_DPC_CLIENTS C                  
 WHERE                  
  L.CLTCODE = PARTY_CODE                  
  AND VDT >= @@OPEN_DATE                  
  AND VDT < @FROM_DATE                  
 GROUP BY                  
  --CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),                  
  CLTCODE,                  
  LONG_NAME,                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,            
  REGION,                   
  AREA,                   
  CL_TYPE                  
 HAVING                  
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0                  
                    
 UNION ALL                  
                  
 SELECT                   
  BALDATE = @FROM_DATE,                  
  CLTCODE,                  
  LONG_NAME,                  
  DPC_BALANCE = SUM(VAMT),                  
  CASH_COLLATREAL = 0,                  
  NONCASH_COLLATREAL = 0,                  
  MARGIN_REQ = 0,                  
  DPC_PERCENTE = MAX(DEBIT_INT),                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 FROM                  
  LEDGER L, #GET_DPC_CLIENTS C,          
  GET_SETT_CALENDER(@@OPEN_DATE, @FROM_DATE, 2) S                  
 WHERE                  
  L.CLTCODE = PARTY_CODE                  
  AND S.END_DATE >= @@OPEN_DATE                  
  AND S.END_DATE < @FROM_DATE                  
  AND VDT = START_DATE          
  AND VTYP = 15 AND DRCR = 'D'                  
 GROUP BY                  
  --CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),                  
  CLTCODE,                  
  LONG_NAME,                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 /*HAVING                  
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0      */            
                    
 UNION ALL                  
                   
 SELECT                   
  BALDATE = @FROM_DATE,                  
  CLTCODE,                  
  LONG_NAME,                  
  DPC_BALANCE = SUM(-VAMT),                  
  CASH_COLLATREAL = 0,                  
  NONCASH_COLLATREAL = 0,                  
  MARGIN_REQ = 0,                  
  DPC_PERCENTE = MAX(DEBIT_INT),                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 FROM                  
  LEDGER L, #GET_DPC_CLIENTS C,         
  GET_SETT_CALENDER(@@OPEN_DATE, @FROM_DATE, 2) S                          
 WHERE                  
  L.CLTCODE = PARTY_CODE                  
  AND S.END_DATE >= @@OPEN_DATE                  
  AND VDT < @@OPEN_DATE                  
  AND VTYP = 15 AND DRCR = 'D'                  
  AND VDT = START_DATE          
 GROUP BY                  
  --CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),                  
  CLTCODE,        
  LONG_NAME,                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 /*HAVING                  
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0      */            
                    
 UNION ALL                    
                    
 SELECT                   
  BALDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),                  
  CLTCODE,                  
  LONG_NAME,                  
  DPC_BALANCE = SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END),                  
  CASH_COLLATREAL = 0,                  
  NONCASH_COLLATREAL = 0,                  
  MARGIN_REQ = 0,                  
  DPC_PERCENTE = MAX(DEBIT_INT),                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 FROM                  
  LEDGER L, #GET_DPC_CLIENTS C                  
 WHERE                  
  L.CLTCODE = PARTY_CODE                  
  AND VDT >= @FROM_DATE                  
  AND VDT <= @TO_DATE + ' 23:59'                  
 GROUP BY                  
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),                  
  CLTCODE,                  
  LONG_NAME,                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
) A                  
GROUP BY                  
 BALDATE,                   
 CLTCODE,                  
 LONG_NAME,                  
 BRANCH_CD,                   
 SUB_BROKER,                   
 TRADER,                   
 REGION,                   
 AREA,                   
 CL_TYPE            
           
           
 DECLARE                  
 @EXCHANGE VARCHAR(10),                  
 @SEGMENT VARCHAR(10),                  
 @SHAREDB VARCHAR(10),                  
 @GROUPID VARCHAR(10),                  
 @@SQL VARCHAR(1000)                  
                   
SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT, @SHAREDB = SHAREDB, @GROUPID = GROUPID                   
FROM dpc_MASTER_SETTING D                   
WHERE EXISTS(SELECT EXCHANGE FROM OWNER O WHERE D.EXCHANGE = O.EXCHANGE AND D.SEGMENT = O.SEGMENT)          
             
                 
                   
INSERT INTO #DEBIT_DEPC_BILLS(CLTCODE, T_DATE, T_2_DATE, T_4_DATE, BILL_AMOUNT)                  
SELECT                   
 CLTCODE, [START_DATE], PAYIN_DATE, END_DATE , SUM(VAMT)                  
FROM                  
 LEDGER L, #GET_DPC_CLIENTS C, GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 2)                  
WHERE                   
 L.CLTCODE = PARTY_CODE                  
 AND CONVERT(VARCHAR(11), VDT, 109) = CONVERT(VARCHAR(11), START_DATE, 109)                  
 AND END_DATE >= @FROM_DATE                  
 AND END_DATE <= @TO_DATE + ' 23:59'            
 AND VTYP = 15 AND DRCR = 'D'                  
GROUP BY                  
 CLTCODE, [START_DATE], PAYIN_DATE, END_DATE             
            
          
                  
DECLARE                  
      @DAYS INT                  
      SELECT @DAYS = DATEDIFF(DD,@FROM_DATE,@TO_DATE) +1                  
                  
SELECT                   
 DPC_DATE = DT.DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE, DPC_PERCENTE                  
INTO #ALL_DATES                   
FROM                   
 #DPC_CHARGES D,                 
 (SELECT                  
           DPC_DATE = DATEADD(DD,NUMBER-1,@FROM_DATE)                   
      FROM                  
            DBO.F_TABLE_NUMBER_RANGE( 1, @DAYS )                  
  ) DT                  
            
INSERT INTO #DPC_CHARGES                   
SELECT DISTINCT                  
 DPC_DATE,                  
 CLTCODE,                  
 LONG_NAME,                  
 BRANCH_CD,                  
 SUB_BROKER,                  
 TRADER,                  
 REGION,                  
 AREA,                  
 CL_TYPE,                  
 DPC_BALANCE = 0,                  
 LEDGER_BALANCE = 0,                  
 CASH_COLLATREAL = 0,                  
 NONCASH_COLLATREAL = 0,                  
 MARGIN_REQ = 0,                  
 AMOUNT_REV = 0,                  
 DPC_PERCENTE                  
FROM #ALL_DATES A WHERE NOT EXISTS (SELECT DPC_DATE FROM #DPC_CHARGES TEMP WHERE A.CLTCODE = TEMP.CLTCODE AND A.DPC_DATE = TEMP.DPC_DATE)                   
          
          
--IF @FROM_DATE = @TO_DATE AND @SEGMENT = 'FUTURES'                  
IF @SEGMENT = 'FUTURES'                  
BEGIN                  
 CREATE TABLE #GET_T_4_MIN_MARGIN          
 (          
  SNO INT IDENTITY(1, 1),          
  PARTY_CODE VARCHAR(10),          
  VDT DATETIME,          
  AMOUNT MONEY,          
  MIN_AMT MONEY          
 )          
           
 CREATE TABLE #GET_T_4_MIN_MARGIN_F          
 (          
  SNO INT IDENTITY(1, 1),          
  PARTY_CODE VARCHAR(10),          
  VDT DATETIME,          
  AMOUNT MONEY,          
  MIN_AMT MONEY          
 )          
          
 SET @@SQL = " INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT) "          
 SET @@SQL = @@SQL + "SELECT "                
 SET @@SQL = @@SQL + "M.PARTY_CODE, "          
 SET @@SQL = @@SQL + "VDT = CONVERT(DATETIME, CONVERT(VARCHAR(11), MDATE, 109)), "          
 SET @@SQL = @@SQL + "AMOUNT = TOTALMARGIN + MTOM + ADDMARGIN "          
 SET @@SQL = @@SQL + "FROM "                
 SET @@SQL = @@SQL + @SHAREDB + ".DBO.FOMARGINNEW M "                
 SET @@SQL = @@SQL + "WHERE MDATE >= DATEADD(D, -10, '" + @FROM_DATE + "') AND MDATE <= '" + @TO_DATE + "'"          
 SET @@SQL = @@SQL + " AND M.PARTY_CODE >= '" + @FROM_PARTY + "' AND M.PARTY_CODE <= '" + @TO_PARTY + "'"                
 SET @@SQL = @@SQL + " ORDER BY M.PARTY_CODE, MDATE"          
           
 EXEC (@@SQL)       
       
  UPDATE G SET MIN_AMT = (SELECT MIN(AMOUNT) FROM #GET_T_4_MIN_MARGIN G1 WHERE  G1.SNO + 4 >= G.SNO AND G1.SNO <= G.SNO)          
  FROM #GET_T_4_MIN_MARGIN G      
        
 CREATE TABLE #ALL_DATES1          
 (          
  DPC_DATE DATETIME,          
  DPC_CONSIDER DATETIME,          
  ISMARGIN CHAR(1),          
  NUMBER INT,          
  SNO INT IDENTITY(1, 1)          
 )          
           
  INSERT INTO #ALL_DATES1(DPC_DATE, ISMARGIN, NUMBER)           
  SELECT DPC_DATE, ISMARGIN, NUMBER FROM          
  (          
  SELECT                  
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'Y', NUMBER                   
     FROM                  
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )            
     WHERE EXISTS(SELECT START_DATE FROM GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 2) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))          
     UNION ALL          
     SELECT                  
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'N', NUMBER                   
     FROM                  
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )            
     WHERE NOT EXISTS(SELECT START_DATE FROM GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 2) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))          
               
     )A          
     ORDER BY NUMBER          
               
  UPDATE A SET DPC_CONSIDER = (SELECT MAX(DPC_DATE) FROM #ALL_DATES1 A1 WHERE A1.SNO <= A.SNO AND A1.ISMARGIN = 'Y')          
  FROM #ALL_DATES1 A           
            
  INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT, MIN_AMT)          
  SELECT G.PARTY_CODE, DPC_DATE, AMOUNT, MIN_AMT FROM #GET_T_4_MIN_MARGIN G, #ALL_DATES1 A          
  WHERE VDT = DPC_CONSIDER          
  AND NOT EXISTS(SELECT VDT FROM #GET_T_4_MIN_MARGIN G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)          
            
  INSERT INTO #GET_T_4_MIN_MARGIN_F(PARTY_CODE, VDT, AMOUNT, MIN_AMT)          
  SELECT PARTY_CODE, VDT, AMOUNT, MIN_AMT          
  FROM #GET_T_4_MIN_MARGIN          
  ORDER BY PARTY_CODE, VDT          
             
            
      
            
 INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)           
 SELECT             
  BALDATE = VDT,           
  M.PARTY_CODE,           
  LONG_NAME,               
  DPC_BALANCE = 0,           
  LEDGER_BALANCE = 0,           
  CASH_COLLATREAL = 0,           
  NONCASH_COLLATREAL = 0,           
  MARGIN_REQ = MIN_AMT,             
  BRANCH_CD,           
  SUB_BROKER,           
  TRADER,              
  REGION,           
  AREA,                
  C.CL_TYPE           
 FROM           
 #GET_T_4_MIN_MARGIN_F M,           
 #GET_DPC_CLIENTS C           
 WHERE M.PARTY_CODE = C.PARTY_CODE          
 AND VDT >= @FROM_DATE AND VDT <= @TO_DATE          
       
 /*TRUNCATE TABLE #ALL_DATES1          
 INSERT INTO #ALL_DATES1(DPC_DATE, ISMARGIN, NUMBER)           
  SELECT DPC_DATE, ISMARGIN, NUMBER FROM          
  (          
  SELECT                  
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'Y', NUMBER                   
     FROM                  
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )            
     WHERE EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))          
     UNION ALL          
     SELECT                  
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'N', NUMBER                   
     FROM                  
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )            
     WHERE NOT EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))          
               
     )A          
     ORDER BY NUMBER          
               
     UPDATE A SET DPC_CONSIDER = (SELECT MAX(DPC_DATE) FROM #ALL_DATES1 A1 WHERE A1.SNO <= A.SNO AND A1.ISMARGIN = 'Y')          
  FROM #ALL_DATES1 A           
            
  INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT)          
  SELECT G.PARTY_CODE, DPC_DATE, AMOUNT FROM #GET_T_4_MIN_MARGIN G, #ALL_DATES1 A          
  WHERE VDT = DPC_CONSIDER          
  AND NOT EXISTS(SELECT VDT FROM #GET_T_4_MIN_MARGIN G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)*/          
            
          
 CREATE TABLE #COLL_DETAILS          
 (          
 BALDATE DATETIME,          
 CLTCODE VARCHAR(10),          
 LONG_NAME VARCHAR(100),          
 CASH_COLL MONEY,          
 NONCASH_COLL MONEY,          
 BRANCH_CD VARCHAR(10),                  
 SUB_BROKER VARCHAR(25),                  
 TRADER VARCHAR(25),                  
 REGION VARCHAR(20),                  
 AREA VARCHAR(20),                  
 CL_TYPE VARCHAR(10)          
 )          
           
 INSERT INTO #COLL_DETAILS(BALDATE, CLTCODE, LONG_NAME, CASH_COLL, NONCASH_COLL, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)                  
 SELECT                  
  BALDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), TRANS_DATE, 109)),                  
  CO.PARTY_CODE,                  
  LONG_NAME,                  
  CASH_COLL = CASH,                  
  NONCASH_COLL = NONCASH,                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 FROM                  
  MSAJAG.DBO.COLLATERAL CO, #GET_DPC_CLIENTS C                  
 WHERE                   
  CO.PARTY_CODE = C.PARTY_CODE                  
  AND TRANS_DATE >= DATEADD(D, -5, @FROM_DATE) AND TRANS_DATE <= @TO_DATE                  
  AND EXCHANGE = @EXCHANGE            AND SEGMENT = @SEGMENT                  
  AND CO.PARTY_CODE >= @FROM_PARTY AND CO.PARTY_CODE <= @TO_PARTY          
            
            
 INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)                  
 SELECT                  
  BALDATE = A.DPC_DATE,                  
  CLTCODE,                  
  LONG_NAME,                  
  DPC_BALANCE = 0,                  
  LEDGER_BALANCE = 0,                  
  CASH_COLL,                  
  NONCASH_COLL,                  
  MARGIN_REQ = 0,                  
  BRANCH_CD,                   
  SUB_BROKER,                   
  TRADER,                   
  REGION,                   
  AREA,                   
  CL_TYPE                  
 FROM                  
  #COLL_DETAILS CO, #ALL_DATES1 A                  
 WHERE CO.BALDATE = DPC_CONSIDER       
 AND A.DPC_DATE >= @FROM_DATE        
-- AND NOT EXISTS(SELECT VDT FROM #COLL_DETAILS G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)          
            
            
            
END          
          
UPDATE D SET DPC_BALANCE = (SELECT SUM(DPC_BALANCE) FROM #DPC_CHARGES D1 WHERE D.CLTCODE = D1.CLTCODE AND D1.DPC_DATE <= D.DPC_DATE)                  
FROM #DPC_CHARGES D            
WHERE ISNULL(DPC_PERCENTE, 0) <> 0          
          
UPDATE D SET VDT = CASE WHEN DPC_BALANCE + BILL_AMOUNT > 0 THEN T_4_DATE ELSE T_4_DATE END                  
FROM                  
 #DEBIT_DEPC_BILLS D, #DPC_CHARGES C                  
WHERE                   
 CONVERT(DATETIME, CONVERT(VARCHAR(11), DPC_DATE, 109)) = CONVERT(DATETIME, CONVERT(VARCHAR(11), T_4_DATE, 109))                  
 AND D.CLTCODE = C.CLTCODE            
           
             
INSERT INTO #DEBIT_DEPC_BILLS(CLTCODE, BILL_AMOUNT, VDT)            
SELECT DISTINCT CLTCODE, 0, DPC_DATE            
FROM #ALL_DATES A WHERE NOT EXISTS (SELECT VDT FROM #DEBIT_DEPC_BILLS TEMP WHERE A.CLTCODE = TEMP.CLTCODE AND A.DPC_DATE = TEMP.VDT)            
            
UPDATE D SET BILL_AMOUNT = (SELECT SUM(BILL_AMOUNT) FROM #DEBIT_DEPC_BILLS D1 WHERE D.CLTCODE = D1.CLTCODE AND D1.VDT <= D.VDT AND D1.VDT >= @FROM_DATE)                  
FROM #DEBIT_DEPC_BILLS D           
          
            
          
          
                 
SELECT                  
 C.DPC_DATE,                  
 C.CLTCODE,                  
 C.LONG_NAME,                  
 C.BRANCH_CD,                  
 C.SUB_BROKER,                  
 C.TRADER,                  
 C.REGION,                  
 C.AREA,                  
 C.CL_TYPE,                  
 DPC_BALANCE = C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END,               
 /*C.DPC_BALANCE,      
 BILL_AMOUNT = ISNULL(BILL_AMOUNT, 0),*/      
 C.LEDGER_BALANCE,                  
 CASH_COLLATREAL,                  
 NONCASH_COLLATREAL,                  
 MARGIN_REQ,                  
 DPC_CHARGE = ((CASE WHEN (C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END) > 0 THEN C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE 
  
     
      
 WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END ELSE 0 END) * DEBIT_INT)/ 100/ 365,      
 DPC_PERCENTE = DEBIT_INT,                  
 AMOUNT_REV                  
FROM                  
 (SELECT                   
  DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE,                  
  DPC_BALANCE = SUM(DPC_BALANCE),                  
  LEDGER_BALANCE = SUM(LEDGER_BALANCE),                  
  CASH_COLLATREAL = SUM(CASH_COLLATREAL), NONCASH_COLLATREAL = SUM(NONCASH_COLLATREAL),                  
  MARGIN_REQ = SUM(MARGIN_REQ), AMOUNT_REV = SUM(AMOUNT_REV)                  
 FROM                  
  #DPC_CHARGES                   
 GROUP BY DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE                  
 ) C LEFT OUTER JOIN (SELECT CLTCODE, VDT, BILL_AMOUNT = SUM(BILL_AMOUNT) FROM #DEBIT_DEPC_BILLS GROUP BY CLTCODE, VDT) D                  
 ON                  
  CONVERT(DATETIME, CONVERT(VARCHAR(11), DPC_DATE, 109)) = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))                  
  AND D.CLTCODE = C.CLTCODE                  
 , #GET_DPC_CLIENTS C1                  
WHERE                   
 C.CLTCODE = C1.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMPUTE_DPC_CHARGES_15112012
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[COMPUTE_DPC_CHARGES_15112012]             
(              
 @FROM_DATE VARCHAR(11),              
 @TO_DATE VARCHAR(11),              
 @FROM_PARTY VARCHAR(10),              
 @TO_PARTY VARCHAR(10)              
)              
AS      
      
/*      
EXEC COMPUTE_DPC_CHARGES 'SEP  1 2012', 'SEP 15 2012', 'k26447', 'k26447'      
EXEC COMPUTE_DPC_CHARGES 'SEP  1 2012', 'SEP 15 2012', 's5643', 's5643'      
      
SELECT * FROM LEDGER WHERE CLTCODE = 's5643' AND VDT < 'APR  1 2012' AND EDT >= 'APR  1 2012'      
      
SELECT * FROM DPC_CHARGES_VERIFIED_CASH WHERE ENTITY = 'NSE - CAPITAL'      
select * from ledger where vno = '201200000134' and vtyp = 15 and cltcode = 'k26447'      
*/      
      
CREATE TABLE #DPC_CHARGES              
(              
 DPC_DATE DATETIME,              
 CLTCODE VARCHAR(10),              
 LONG_NAME VARCHAR(100),              
 BRANCH_CD VARCHAR(10),              
 SUB_BROKER VARCHAR(25),              
 TRADER VARCHAR(25),              
 REGION VARCHAR(20),              
 AREA VARCHAR(20),              
 CL_TYPE VARCHAR(10),              
 DPC_BALANCE MONEY,              
 LEDGER_BALANCE MONEY,              
 CASH_COLLATREAL MONEY,              
 NONCASH_COLLATREAL MONEY,              
 MARGIN_REQ MONEY,              
 AMOUNT_REV MONEY,              
 DPC_PERCENTE MONEY              
)        
      
CREATE TABLE #GET_DPC_CLIENTS      
(      
 PARTY_CODE VARCHAR(10),       
 LONG_NAME VARCHAR(100),      
 BRANCH_CD VARCHAR(20),       
 SUB_BROKER VARCHAR(25),       
 TRADER VARCHAR(25),      
 AREA VARCHAR(25),      
 REGION VARCHAR(25),      
 CL_TYPE VARCHAR(10),      
 CREDIT_INT MONEY,       
 DEBIT_INT MONEY,       
 FROMDATE DATETIME,       
 TODATE DATETIME,       
 EXEMPT_NOOFDAYS TINYINT,       
 EXEMPT_NOOFDAYS_CR TINYINT,       
 MIN_INTEREST MONEY,       
 MIN_BALANCE MONEY      
)            
      
INSERT INTO #GET_DPC_CLIENTS      
SELECT * FROM .DBO.GET_DPC_CLIENTS(@FROM_PARTY, @TO_PARTY, @FROM_DATE)      
              
/*              
CREATE TABLE #DPC_CHARGES_FINAL              
(              
 DPC_DATE DATETIME,              
 CLTCODE VARCHAR(10),              
 LONG_NAME VARCHAR(100),              
 BRANCH_CD VARCHAR(10),              
 SUB_BROKER VARCHAR(25),              
 TRADER VARCHAR(25),              
 REGION VARCHAR(20),              
 AREA VARCHAR(20),              
 CL_TYPE VARCHAR(10),              
 DPC_BALANCE MONEY,              
 LEDGER_BALANCE MONEY,              
 CASH_COLLATREAL MONEY,              
 NONCASH_COLLATREAL MONEY,              
 MARGIN_REQ MONEY,              
 DPC_CHARGE MONEY,              
 DPC_PERCENTE MONEY,              
 AMOUNT_REV MONEY              
)              
*/              
DECLARE              
 @@OPEN_DATE VARCHAR(11)              
               
SELECT               
 @@OPEN_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)              
FROM               
 PARAMETER              
WHERE              
 @FROM_DATE BETWEEN SDTCUR AND LDTCUR              
              
/* TABLE TO MAINTAIN THE T + 2 AND T + 4 LBALANCES TO APPLY THE T + 4 DEBIT BALANCE LOGIC */              
CREATE TABLE #DEBIT_DEPC_BILLS              
(              
 CLTCODE VARCHAR(10),           
 T_DATE DATETIME,           
 T_2_DATE DATETIME,              
 T_4_DATE DATETIME,              
 BILL_AMOUNT MONEY,              
 VDT DATETIME              
)              
              
--, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE,               
              
              
INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, DPC_PERCENTE, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE, AMOUNT_REV)              
SELECT               
 BALDATE,               
 CLTCODE,               
 LONG_NAME,              
 SUM(DPC_BALANCE),               
 LEDGER_BALANCE = SUM(DPC_BALANCE),              
 SUM(CASH_COLLATREAL),               
 SUM(NONCASH_COLLATREAL),              
 SUM(MARGIN_REQ),              
 MAX(DPC_PERCENTE),              
 BRANCH_CD,               
 SUB_BROKER,               
 TRADER,               
 REGION,               
 AREA,               
 CL_TYPE,              
 AMOUNT_REV = 0              
FROM              
(              
 SELECT               
  BALDATE = @FROM_DATE,              
  CLTCODE,              
  LONG_NAME,              
  DPC_BALANCE = SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END),              
  CASH_COLLATREAL = 0,              
  NONCASH_COLLATREAL = 0,              
  MARGIN_REQ = 0,              
  DPC_PERCENTE = MAX(DEBIT_INT),              
 BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 FROM              
  LEDGER L, #GET_DPC_CLIENTS C              
 WHERE              
  L.CLTCODE = PARTY_CODE              
  AND VDT >= @@OPEN_DATE              
  AND VDT < @FROM_DATE              
 GROUP BY              
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),              
  CLTCODE,              
  LONG_NAME,              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,        
  REGION,               
  AREA,               
  CL_TYPE              
 HAVING              
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0              
                
 UNION ALL              
              
 SELECT               
  BALDATE = @FROM_DATE,              
  CLTCODE,              
  LONG_NAME,              
  DPC_BALANCE = SUM(VAMT),              
  CASH_COLLATREAL = 0,              
  NONCASH_COLLATREAL = 0,              
  MARGIN_REQ = 0,              
  DPC_PERCENTE = MAX(DEBIT_INT),              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 FROM              
  LEDGER L, #GET_DPC_CLIENTS C,      
  MSAJAG.DBO.GET_SETT_CALENDER(@@OPEN_DATE, @FROM_DATE, 3) S              
 WHERE              
  L.CLTCODE = PARTY_CODE              
  AND S.END_DATE >= @@OPEN_DATE              
  AND S.END_DATE < @FROM_DATE              
  AND VDT = START_DATE      
  AND VTYP = 15 AND DRCR = 'D'              
 GROUP BY              
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),              
  CLTCODE,              
  LONG_NAME,              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 /*HAVING              
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0      */        
                
 UNION ALL              
               
 SELECT               
  BALDATE = @FROM_DATE,              
  CLTCODE,              
  LONG_NAME,              
  DPC_BALANCE = SUM(-VAMT),              
  CASH_COLLATREAL = 0,              
  NONCASH_COLLATREAL = 0,              
  MARGIN_REQ = 0,              
  DPC_PERCENTE = MAX(DEBIT_INT),              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 FROM              
  LEDGER L, #GET_DPC_CLIENTS C,      
  MSAJAG.DBO.GET_SETT_CALENDER(@@OPEN_DATE, @FROM_DATE, 3) S                      
 WHERE              
  L.CLTCODE = PARTY_CODE              
  AND S.END_DATE >= @@OPEN_DATE              
  AND VDT < @@OPEN_DATE              
  AND VTYP = 15 AND DRCR = 'D'              
  AND VDT = START_DATE      
 GROUP BY              
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),              
  CLTCODE,              
  LONG_NAME,              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 /*HAVING              
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0      */        
                
 UNION ALL                
                
 SELECT               
  BALDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),              
  CLTCODE,              
  LONG_NAME,              
  DPC_BALANCE = SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END),              
  CASH_COLLATREAL = 0,              
  NONCASH_COLLATREAL = 0,              
  MARGIN_REQ = 0,              
  DPC_PERCENTE = MAX(DEBIT_INT),              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 FROM              
  LEDGER L, #GET_DPC_CLIENTS C              
 WHERE              
  L.CLTCODE = PARTY_CODE              
  AND VDT >= @FROM_DATE              
  AND VDT <= @TO_DATE + ' 23:59'              
 GROUP BY              
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),              
  CLTCODE,              
  LONG_NAME,              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
) A              
GROUP BY              
 BALDATE,               
 CLTCODE,              
 LONG_NAME,              
 BRANCH_CD,               
 SUB_BROKER,               
 TRADER,               
 REGION,               
 AREA,               
 CL_TYPE        
       
       
 DECLARE              
 @EXCHANGE VARCHAR(10),              
 @SEGMENT VARCHAR(10),              
 @SHAREDB VARCHAR(10),              
 @GROUPID VARCHAR(10),              
 @@SQL VARCHAR(1000)              
               
SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT, @SHAREDB = SHAREDB, @GROUPID = GROUPID               
FROM dpc_MASTER_SETTING D               
WHERE EXISTS(SELECT EXCHANGE FROM OWNER O WHERE D.EXCHANGE = O.EXCHANGE AND D.SEGMENT = O.SEGMENT)      
         
             
               
INSERT INTO #DEBIT_DEPC_BILLS(CLTCODE, T_DATE, T_2_DATE, T_4_DATE, BILL_AMOUNT)              
SELECT               
 CLTCODE, [START_DATE], PAYIN_DATE, END_DATE , SUM(VAMT)              
FROM              
 LEDGER L, #GET_DPC_CLIENTS C, MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3)              
WHERE               
 L.CLTCODE = PARTY_CODE              
 AND CONVERT(VARCHAR(11), VDT, 109) = CONVERT(VARCHAR(11), START_DATE, 109)              
 AND END_DATE >= @FROM_DATE              
 AND END_DATE <= @TO_DATE + ' 23:59'        
 AND VTYP = 15 AND DRCR = 'D'              
GROUP BY              
 CLTCODE, [START_DATE], PAYIN_DATE, END_DATE         
        
      
              
DECLARE              
      @DAYS INT              
      SELECT @DAYS = DATEDIFF(DD,@FROM_DATE,@TO_DATE) +1              
              
SELECT               
 DPC_DATE = DT.DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE, DPC_PERCENTE              
INTO #ALL_DATES               
FROM               
 #DPC_CHARGES D,               
 (SELECT              
           DPC_DATE = DATEADD(DD,NUMBER-1,@FROM_DATE)               
      FROM              
            DBO.F_TABLE_NUMBER_RANGE( 1, @DAYS )              
  ) DT              
        
INSERT INTO #DPC_CHARGES               
SELECT DISTINCT              
 DPC_DATE,              
 CLTCODE,              
 LONG_NAME,              
 BRANCH_CD,              
 SUB_BROKER,              
 TRADER,              
 REGION,              
 AREA,              
 CL_TYPE,              
 DPC_BALANCE = 0,              
 LEDGER_BALANCE = 0,              
 CASH_COLLATREAL = 0,              
 NONCASH_COLLATREAL = 0,              
 MARGIN_REQ = 0,              
 AMOUNT_REV = 0,              
 DPC_PERCENTE              
FROM #ALL_DATES A WHERE NOT EXISTS (SELECT DPC_DATE FROM #DPC_CHARGES TEMP WHERE A.CLTCODE = TEMP.CLTCODE AND A.DPC_DATE = TEMP.DPC_DATE)               
      
      
--IF @FROM_DATE = @TO_DATE AND @SEGMENT = 'FUTURES'              
IF @SEGMENT = 'FUTURES'              
BEGIN              
 CREATE TABLE #GET_T_4_MIN_MARGIN      
 (      
  SNO INT IDENTITY(1, 1),      
  PARTY_CODE VARCHAR(10),      
  VDT DATETIME,      
  AMOUNT MONEY,      
  MIN_AMT MONEY      
 )      
       
 CREATE TABLE #GET_T_4_MIN_MARGIN_F      
 (      
  SNO INT IDENTITY(1, 1),      
  PARTY_CODE VARCHAR(10),      
  VDT DATETIME,      
  AMOUNT MONEY,      
  MIN_AMT MONEY      
 )      
      
 SET @@SQL = " INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT) "      
 SET @@SQL = @@SQL + "SELECT "            
 SET @@SQL = @@SQL + "M.PARTY_CODE, "      
 SET @@SQL = @@SQL + "VDT = CONVERT(DATETIME, CONVERT(VARCHAR(11), MDATE, 109)), "      
 SET @@SQL = @@SQL + "AMOUNT = TOTALMARGIN + MTOM + ADDMARGIN "      
 SET @@SQL = @@SQL + "FROM "            
 SET @@SQL = @@SQL + @SHAREDB + ".DBO.FOMARGINNEW M "            
 SET @@SQL = @@SQL + "WHERE MDATE >= DATEADD(D, -10, '" + @FROM_DATE + "') AND MDATE <= '" + @TO_DATE + "'"      
 SET @@SQL = @@SQL + " AND M.PARTY_CODE >= '" + @FROM_PARTY + "' AND M.PARTY_CODE <= '" + @TO_PARTY + "'"            
 SET @@SQL = @@SQL + " ORDER BY M.PARTY_CODE, MDATE"      
       
 EXEC (@@SQL)   
   
  UPDATE G SET MIN_AMT = (SELECT MIN(AMOUNT) FROM #GET_T_4_MIN_MARGIN G1 WHERE  G1.SNO + 4 > G.SNO AND G1.SNO <= G.SNO)      
  FROM #GET_T_4_MIN_MARGIN G  
    
 CREATE TABLE #ALL_DATES1      
 (      
  DPC_DATE DATETIME,      
  DPC_CONSIDER DATETIME,      
  ISMARGIN CHAR(1),      
  NUMBER INT,      
  SNO INT IDENTITY(1, 1)      
 )      
       
  INSERT INTO #ALL_DATES1(DPC_DATE, ISMARGIN, NUMBER)       
  SELECT DPC_DATE, ISMARGIN, NUMBER FROM      
  (      
  SELECT              
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'Y', NUMBER               
     FROM              
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )        
     WHERE EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))      
     UNION ALL      
     SELECT              
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'N', NUMBER               
     FROM              
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )        
     WHERE NOT EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))      
           
     )A      
     ORDER BY NUMBER      
           
  UPDATE A SET DPC_CONSIDER = (SELECT MAX(DPC_DATE) FROM #ALL_DATES1 A1 WHERE A1.SNO <= A.SNO AND A1.ISMARGIN = 'Y')      
  FROM #ALL_DATES1 A       
        
  INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT, MIN_AMT)      
  SELECT G.PARTY_CODE, DPC_DATE, AMOUNT, MIN_AMT FROM #GET_T_4_MIN_MARGIN G, #ALL_DATES1 A      
  WHERE VDT = DPC_CONSIDER      
  AND NOT EXISTS(SELECT VDT FROM #GET_T_4_MIN_MARGIN G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)      
        
  INSERT INTO #GET_T_4_MIN_MARGIN_F(PARTY_CODE, VDT, AMOUNT, MIN_AMT)      
  SELECT PARTY_CODE, VDT, AMOUNT, MIN_AMT      
  FROM #GET_T_4_MIN_MARGIN      
  ORDER BY PARTY_CODE, VDT      
         
        
  
        
 INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)       
 SELECT         
  BALDATE = VDT,       
  M.PARTY_CODE,       
  LONG_NAME,           
  DPC_BALANCE = 0,       
  LEDGER_BALANCE = 0,       
  CASH_COLLATREAL = 0,       
  NONCASH_COLLATREAL = 0,       
  MARGIN_REQ = MIN_AMT,         
  BRANCH_CD,       
  SUB_BROKER,       
  TRADER,          
  REGION,       
  AREA,            
  C.CL_TYPE       
 FROM       
 #GET_T_4_MIN_MARGIN_F M,       
 #GET_DPC_CLIENTS C       
 WHERE M.PARTY_CODE = C.PARTY_CODE      
 AND VDT >= @FROM_DATE AND VDT <= @TO_DATE      
   
 /*TRUNCATE TABLE #ALL_DATES1      
 INSERT INTO #ALL_DATES1(DPC_DATE, ISMARGIN, NUMBER)       
  SELECT DPC_DATE, ISMARGIN, NUMBER FROM      
  (      
  SELECT              
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'Y', NUMBER               
     FROM              
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )        
     WHERE EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))      
     UNION ALL     
     SELECT              
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'N', NUMBER               
     FROM              
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )        
     WHERE NOT EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))      
           
     )A      
     ORDER BY NUMBER      
           
     UPDATE A SET DPC_CONSIDER = (SELECT MAX(DPC_DATE) FROM #ALL_DATES1 A1 WHERE A1.SNO <= A.SNO AND A1.ISMARGIN = 'Y')      
  FROM #ALL_DATES1 A       
        
  INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT)      
  SELECT G.PARTY_CODE, DPC_DATE, AMOUNT FROM #GET_T_4_MIN_MARGIN G, #ALL_DATES1 A      
  WHERE VDT = DPC_CONSIDER      
  AND NOT EXISTS(SELECT VDT FROM #GET_T_4_MIN_MARGIN G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)*/      
        
      
 CREATE TABLE #COLL_DETAILS      
 (      
 BALDATE DATETIME,      
 CLTCODE VARCHAR(10),      
 LONG_NAME VARCHAR(100),      
 CASH_COLL MONEY,      
 NONCASH_COLL MONEY,      
 BRANCH_CD VARCHAR(10),              
 SUB_BROKER VARCHAR(25),              
 TRADER VARCHAR(25),              
 REGION VARCHAR(20),              
 AREA VARCHAR(20),              
 CL_TYPE VARCHAR(10)      
 )      
       
 INSERT INTO #COLL_DETAILS(BALDATE, CLTCODE, LONG_NAME, CASH_COLL, NONCASH_COLL, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)              
 SELECT              
  BALDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), TRANS_DATE, 109)),              
  CO.PARTY_CODE,              
  LONG_NAME,              
  CASH_COLL = CASH,              
  NONCASH_COLL = NONCASH,              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 FROM              
  MSAJAG.DBO.COLLATERAL CO, #GET_DPC_CLIENTS C              
 WHERE               
  CO.PARTY_CODE = C.PARTY_CODE              
  AND TRANS_DATE >= DATEADD(D, -5, @FROM_DATE) AND TRANS_DATE <= @TO_DATE              
  AND EXCHANGE = @EXCHANGE            AND SEGMENT = @SEGMENT              
  AND CO.PARTY_CODE >= @FROM_PARTY AND CO.PARTY_CODE <= @TO_PARTY      
        
        
 INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)              
 SELECT              
  BALDATE = A.DPC_DATE,              
  CLTCODE,              
  LONG_NAME,              
  DPC_BALANCE = 0,              
  LEDGER_BALANCE = 0,              
  CASH_COLL,              
  NONCASH_COLL,              
  MARGIN_REQ = 0,              
  BRANCH_CD,               
  SUB_BROKER,               
  TRADER,               
  REGION,               
  AREA,               
  CL_TYPE              
 FROM              
  #COLL_DETAILS CO, #ALL_DATES1 A              
 WHERE CO.BALDATE = DPC_CONSIDER   
 AND A.DPC_DATE >= @FROM_DATE     
-- AND NOT EXISTS(SELECT VDT FROM #COLL_DETAILS G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)      
        
        
        
END      
      
UPDATE D SET DPC_BALANCE = (SELECT SUM(DPC_BALANCE) FROM #DPC_CHARGES D1 WHERE D.CLTCODE = D1.CLTCODE AND D1.DPC_DATE <= D.DPC_DATE)              
FROM #DPC_CHARGES D        
WHERE ISNULL(DPC_PERCENTE, 0) <> 0      
      
UPDATE D SET VDT = CASE WHEN DPC_BALANCE + BILL_AMOUNT > 0 THEN T_4_DATE ELSE T_4_DATE END              
FROM              
 #DEBIT_DEPC_BILLS D, #DPC_CHARGES C              
WHERE               
 CONVERT(DATETIME, CONVERT(VARCHAR(11), DPC_DATE, 109)) = CONVERT(DATETIME, CONVERT(VARCHAR(11), T_4_DATE, 109))              
 AND D.CLTCODE = C.CLTCODE        
       
         
INSERT INTO #DEBIT_DEPC_BILLS(CLTCODE, BILL_AMOUNT, VDT)        
SELECT DISTINCT CLTCODE, 0, DPC_DATE        
FROM #ALL_DATES A WHERE NOT EXISTS (SELECT VDT FROM #DEBIT_DEPC_BILLS TEMP WHERE A.CLTCODE = TEMP.CLTCODE AND A.DPC_DATE = TEMP.VDT)        
        
UPDATE D SET BILL_AMOUNT = (SELECT SUM(BILL_AMOUNT) FROM #DEBIT_DEPC_BILLS D1 WHERE D.CLTCODE = D1.CLTCODE AND D1.VDT <= D.VDT AND D1.VDT >= @FROM_DATE)              
FROM #DEBIT_DEPC_BILLS D       
      
        
      
      
             
SELECT              
 C.DPC_DATE,              
 C.CLTCODE,              
 C.LONG_NAME,              
 C.BRANCH_CD,              
 C.SUB_BROKER,              
 C.TRADER,              
 C.REGION,              
 C.AREA,              
 C.CL_TYPE,              
 DPC_BALANCE = C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END,           
 /*C.DPC_BALANCE,  
 BILL_AMOUNT = ISNULL(BILL_AMOUNT, 0),*/  
 C.LEDGER_BALANCE,              
 CASH_COLLATREAL,              
 NONCASH_COLLATREAL,              
 MARGIN_REQ,              
 DPC_CHARGE = ((CASE WHEN (C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END) > 0 THEN C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE 
   
 WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END ELSE 0 END) * DEBIT_INT)/ 100/ 365,  
 DPC_PERCENTE = DEBIT_INT,              
 AMOUNT_REV              
FROM              
 (SELECT               
  DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE,              
  DPC_BALANCE = SUM(DPC_BALANCE),              
  LEDGER_BALANCE = SUM(LEDGER_BALANCE),              
  CASH_COLLATREAL = SUM(CASH_COLLATREAL), NONCASH_COLLATREAL = SUM(NONCASH_COLLATREAL),              
  MARGIN_REQ = SUM(MARGIN_REQ), AMOUNT_REV = SUM(AMOUNT_REV)              
 FROM              
  #DPC_CHARGES               
 GROUP BY DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE              
 ) C LEFT OUTER JOIN (SELECT CLTCODE, VDT, BILL_AMOUNT = SUM(BILL_AMOUNT) FROM #DEBIT_DEPC_BILLS GROUP BY CLTCODE, VDT) D              
 ON              
  CONVERT(DATETIME, CONVERT(VARCHAR(11), DPC_DATE, 109)) = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))              
  AND D.CLTCODE = C.CLTCODE              
 , #GET_DPC_CLIENTS C1              
WHERE               
 C.CLTCODE = C1.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ConsolidatedSP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ConsolidatedSP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.ConsolidatedSP    Script Date: 02/22/2002 5:06:47 PM ******/
/****** Object:  Stored Procedure dbo.ConsolidatedSP    Script Date: 01/24/2002 12:11:36 PM ******/
CREATE Proc ConsolidatedSP
As
select grpname,grpcode,acname,cltcode ,
openentry=isnull(sum(openentry),0),
dramt = isnull(sum(dramt),0),
cramt = isnull(sum(cramt),0)
from ConsolidatedTable
group by  grpname,grpcode,acname,cltcode
order by grpcode,cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CorrentLedger1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.CorrentLedger1    Script Date: 20-Mar-01 11:43:33 PM ******/
/* this is used to keep the consistency of the records in the ledger1 table with  respect to the related entries in ledger table (in case of bank entries)*/
CREATE PROCEDURE   CorrentLedger1
 AS
insert into ledger1 (dd ,dddt ,reldt ,refno )
select 'c', vdt ,'1900-01-01 00:00:00.000' , refno
from ledger where vtyp=2  and refno like '%c%'
and refno not in
(select refno from ledger1 )
insert into ledger1 (dd ,dddt ,reldt ,refno )
select 'c', vdt ,'1900-01-01 00:00:00.000' , refno
from ledger where vtyp= 3   and refno like '%d%'
and refno not in
(select refno from ledger1 )
insert into ledger1 (dd ,dddt ,reldt ,refno )
select 'c', vdt ,'1900-01-01 00:00:00.000' , refno
from ledger where vtyp= 5 
and refno not in
(select refno from ledger1 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumbal    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumbal    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumbal    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE cumbal
@clcode varchar(6),
@todt datetime
AS
SELECT  dramt=isnull((case drcr when 
'd' then SUM(vamt)end),0), cramt=isnull((case drcr when 
'c' then SUM(vamt)end),0) from ledger, ncdx.dbo.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM ncdx.dbo.CLIENT2 
WHERE CL_CODE=@clcode and cltcode=party_code
and vdt<= @todt  +  "11:59pm")
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumbal1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 8/8/01 1:37:29 PM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumbal1    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE cumbal1
@clcode varchar(6)
AS
SELECT  dramt=isnull((case drcr when 
'd' then SUM(vamt)end),0), cramt=isnull((case drcr when 
'c' then SUM(vamt)end),0) from ledger, ncdx.dbo.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM ncdx.dbo.CLIENT2 
WHERE CL_CODE=@clcode ) and cltcode=party_code 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumbaldetailledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 11/28/2001 12:23:42 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldetailledger    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE cumbaldetailledger
@partycode varchar(10)
 AS
select convert(varchar,VDT,103), refno, vtyp,dramt=isnull((case drcr when 'd' then vamt end),0),
cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc,
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(ledger.refno,7)),'') 
from ledger , vmast WHERE VDT <= getdate()+ "11:59PM" and 
CLTCODE=@partycode and ledger.vtyp=vmast.vtype order by vdt, drcr,vtyp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumbaldrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumbaldrcr    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE cumbaldrcr
@partycode varchar(10)
AS
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= getdate() + "11:59PM" and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumbalparty
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumbalparty    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE cumbalparty
@partycode varchar(10)
AS
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
 from ledger WHERE VDT <= getdate() +  "11:59PM" and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumledger    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumledger    Script Date: 01/04/1980 1:40:36 AM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumledger    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE cumledger
@cltcode varchar(10)
as
select distinct acname from ledger where cltcode=@cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cumparty
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.cumparty    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.cumparty    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.cumparty    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE  cumparty
@clcode varchar(10)
AS
select distinct party_code from ncdx.dbo.client2, ledger 
where cl_code=@clcode and party_code=cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblHistorySpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblHistorySpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblHistorySpP 
 AS
select 'TOTAL QUANTITY' = sum(tradeqty),sell_buy,
'TOTAL AMOUNT' = sum(tradeqty*marketrate) 
from  ncdx.dbo.history 
 group by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblInSettDySpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblInSettDySpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblInSettDySpP
@setttype varchar(3),
@settno varchar(7),
@saudadate varchar(11)
 AS
 select  isnull(sum(tradeqty),0),sell_buy,  isnull(sum(tradeqty*marketrate),0)
 from settlement
  where sett_no =@settno and sett_type = @setttype and 
convert(varchar,sauda_date,101)= @saudadate
 group by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblLastSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 1/17/2004 11:39:07 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblLastSpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblLastSpP
@settno varchar(7),
@settno1 varchar(7),
@setttype varchar(3),
@saudadate as varchar(12)
AS
select isnull(sum(tradeqty),0),sell_buy, 
  isnull(sum(tradeqty*marketrate),0) 
from ncdx.dbo.settlement  
where sett_no <> @settno and 
sett_no <> @settno1 and
 sett_type like @setttype and 
convert(varchar,sauda_date,101) = @saudadate 
 group by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblnotSettSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblnotSettSpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblnotSettSpP
@settno varchar(7),
@setttype varchar(3)
 AS
select  isnull(sum(tradeqty),0),sell_buy,  isnull(sum(tradeqty*marketrate),0) 
from ncdx.dbo.settlement 
 where sett_no not like @settno  and sett_type like @setttype
group by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblSettHistorySpp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettHistorySpp    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblSettHistorySpp 
@settno varchar(7)
 AS
select distinct sett_type from ncdx.dbo.settlement 
 union  SELECT DISTINCT SETT_TYPE FROM ncdx.dbo.HISTORY 
 where sett_no like @settno 
 order by sett_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblSettSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblSettSpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblSettSpP
@settno varchar(7),
@setttype varchar(3)
 AS
select  isnull(sum(tradeqty),0),sell_buy,  isnull(sum(tradeqty*marketrate),0) 
from ncdx.dbo.settlement 
 where sett_no like @settno  and sett_type like @setttype
group by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DailyOblTotalsettSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.DailyOblTotalsettSpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE DailyOblTotalsettSpP 
 AS
select 'SETTLEMENT NO' = sett_no,
 'SETTLEMENT TYPE' = sett_type,
'TOTAL QUANTITY' = sum(tradeqty),
sell_buy, 'TOTAL AMOUNT' = sum(tradeqty*marketrate) 
from ncdx.dbo.settlement
 group by sett_no, sett_type,sell_buy 
ORDER BY SETT_NO,sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Data4BillPosted
-- --------------------------------------------------





CREATE PROC Data4BillPosted

AS

DECLARE @@COUNTER AS NUMERIC
SELECT @@COUNTER = COUNT(*) FROM BILLPOSTED

IF @@COUNTER = 0
	BEGIN
		BEGIN TRAN
			INSERT 
			INTO BILLPOSTED 
				(
					VNO, 
					VTYP, 
					BOOKTYPE, 
					VDT, 
					BILLDATE, 
					SETT_NO, 
					SETT_TYPE, 
					NARRATION, 
					USERNAME, 
					POSTDATE, 
					EDTDR, 
					EDTCR
				) 
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				CONVERT(VARCHAR(11), VDT, 109), 
				0, 
				'F', 
				--SUBSTRING(NARRATION, 8, 7), 
				--SUBSTRING(NARRATION, 20, 1), 
				--CASE WHEN SUBSTRING(NARRATION, 20, 1) = 'A' THEN SUBSTRING(NARRATION, 20, 2) ELSE SUBSTRING(NARRATION, 20, 1) END, 
				NARRATION, 
				'FROM SYSTEM', 
				GETDATE(), 
				CONVERT(VARCHAR(11), MIN(EDT), 109), 
				CONVERT(VARCHAR(11), MAX(EDT), 109) 
			FROM LEDGER 
			WHERE VDT >= 'APR  1 2005' 
				AND VTYP IN (15, 21) 
			GROUP BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				CASE 
					WHEN SUBSTRING(NARRATION, 20, 1) = 'A' 
					THEN SUBSTRING(NARRATION, 20, 2) 
					ELSE SUBSTRING(NARRATION, 20, 1) 
				END
				, 
				NARRATION 
			ORDER BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109) 
		COMMIT
	END
ELSE
	BEGIN
		PRINT 'Data Already Found in Table BillPosted. Cannot Continue...'
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.detailledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.detailledger    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.detailledger    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 29-Sep-01 8:12:03 PM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.detailledger    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE detailledger
@fromdt datetime,
@todt datetime,
@partycode varchar(10)
AS
select convert(varchar,VDT,103), refno, vtyp,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(ledger.refno,7)),'') 
from ledger , vmast WHERE VDT >=@fromdt  and vdt<=@todt +  " 11:59PM"  and 
CLTCODE=@partycode and ledger.vtyp=vmast.vtype
order by vdt, drcr,vtyp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.disp_ledger
-- --------------------------------------------------
create proc disp_ledger
(
@cltcode varchar(25)
)
as
declare @acyearfrom as datetime,@acyearto as datetime
select @acyearfrom=sdtcur,@acyearto=ldtcur from parameter (nolock) 
where sdtcur <=getdate() and ldtcur >=getdate()

select * from ledger a (nolock) 
where vdt >=@acyearfrom and vdt<=getdate()
and a.cltcode = @cltcode

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.drcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.drcr    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.drcr    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 2/17/01 3:34:14 PM ******/
/****** Object:  Stored Procedure dbo.drcr    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE drcr
@todt datetime,
@partycode varchar(10)
AS
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= @todt +  " 11:59PM"
and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.drcrtot
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.drcrtot    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE drcrtot
@cname varchar(35),
@fromdt datetime,
@todt datetime
AS
select  dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0)  
from ledger l , vmast,  ncdx.dbo.client2 c2 , 
ncdx.dbo.client1 c1 where 
l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode 
and l.acname = @cname and vtyp=vtype and vdt >=@fromdt and
vdt<=@todt +  "11:59pm"
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.dt_verstamp003
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 8/7/01 6:03:48 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 7/8/01 3:22:48 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 20-Mar-01 11:43:33 PM ******/
/****** Object:  Stored Procedure dbo.dt_verstamp003    Script Date: 12/18/99 8:23:21 AM ******/
/*
** This proc exists only to version distribution of data package storage format
*/
create procedure dt_verstamp003
as
 return (0)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EditReconcile
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.EditReconcile    Script Date: 12/21/2001 12:40:04 PM ******/
/*** Modified by VNS on 28/12/2001 to add book type ***/
/* Created By VNS & Sandeep From Store Procedure Reconcile */
CREATE PROCEDURE EditReconcile  
@code varchar(10),
@frmdate varchar(11),
@gdate varchar(11),
@gdrcr  varchar(1),
@flag varchar(1),
@tVamt numeric(17,2)
AS
	if @flag=1 
	begin
		select  isnull(sum(vamt) ,0) ,drcr from ledger 
		where cltcode =    @code    and   vdt <= @gdate   
		group by drcr
		order  by drcr
	end
	
	if @flag=2
	begin
		if @tvamt =  0  
		begin
			select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),
			vno=l.vno, drcr=l.drcr ,lno=l.lno, vtyp=l.vtyp,chequeno=isnull(ddno,''), /*refno= l.refno ,*/amt= l.vamt,reldt=convert(varchar,ll1.reldt,103),booktype=l.booktype
			From ledger l  ,LEDGER1 ll1 
			WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code
			/*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */
			and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.booktype= l.booktype and ll1.lno = l.lno and ll1.drcr=l.drcr and
			l.vno in
				(select vno from ledger l1 where cltcode =@code   and l.vtyp=l1.vtyp and booktype=l1.booktype)
				and ll1.reldt <>'1900-01-01 00:00:00.000' and vdt >= @frmdate and vdt < =  @gdate    and   l.drcr like  @gdrcr
			order by  convert(varchar,l.vdt,101) ,l.vtyp,l.vno,l.drcr
		end
		if  @tvamt <>0
		begin
			select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),
			vno=l.vno, drcr=l.drcr ,lno=l.lno,vtyp=l.vtyp, chequeno=isnull(ddno,''),/* refno= l.refno ,*/amt= l.vamt,reldt=convert(varchar,ll1.reldt,103)
			From ledger l  ,LEDGER1 LL1 
			WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code
			and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno = l.lno and ll1.drcr=l.drcr and
			/*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */
			l.vno in
				(select vno from ledger l1 where cltcode =@code   and l.vtyp=l1.vtyp)
				and ll1.reldt <>'1900-01-01 00:00:00.000'  and vdt >= @frmdate and vdt < =  @gdate    and   l.drcr like  @gdrcr
				and  vamt = @tVamt
				order by   convert(varchar,l.vdt,101)  ,l.vtyp,l.vno,l.drcr
		end
	end
	if @flag = 3
	begin
		select L.drcr, sum(vamt) from ledger L, ledger1 l1 where l.vtyp = l1.vtyp and l.booktype=l1.booktype and l.vno = l1.vno
		and l1.reldt = '1900-01-01 00:00:00.000' AND CLTCODE =@CODE
		GROUP BY L.DRCR 
	end
/*SUBSTRING(LL1.REFNO,1, 12)=SUBSTRING(L.REFNO,1, 12) */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Edtyearend
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 03/27/2003 11:33:03 AM ******/
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 02/18/2003 10:26:56 AM ******/
CREATE Procedure Edtyearend
@sdtcur datetime,
@ldtcur datetime,
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime,
@msg1   varchar(234)
AS
declare
@@netdiff as money
truncate table edtclbal
insert into edtclbal
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)
from ledger l left outer join acmast a on l.cltcode = a.cltcode
where l.edt > = @sdtcur and l.edt <= @ldtcur
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> '99999'
group by l.cltcode,l.acname
order by l.cltcode,l.acname
update ledger set balamt = e.balance from edtclbal e
where ledger.vtyp = @vtyp and ledger.booktype = @booktype and ledger.vno = @vno and ledger.cltcode = e.cltcode
select @@netdiff = ( select sum(balance) from edtclbal )
update ledger set balamt = isnull( case when @@netdiff > = 0 then -(@@netdiff) else abs(@@netdiff) end,0)
where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '99999'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FETCH_GST_INVOICE_ACCOUNT
-- --------------------------------------------------


CREATE PROC [dbo].[FETCH_GST_INVOICE_ACCOUNT]
(
	@FORTHEDAY	VARCHAR(11),
	@EXCHANGE	VARCHAR(3),
	@SEGMENT	VARCHAR(7)
)
AS


SELECT DISTINCT VNO, VTYP, BOOKTYPE, VDT=CONVERT(DATETIME,LEFT(VDT,11)), FLAG = (CASE WHEN DRCR = 'C' THEN 'DEBIT' ELSE 'CREDIT' END)
INTO #GSTLED FROM LEDGER L 
WHERE VDT BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
AND CLTCODE IN (SELECT ACCODE FROM MSAJAG..VALANACCOUNT WHERE ACNAME LIKE '%GST%')
AND VNO IN (SELECT VNO FROM LEDGER G
			WHERE VDT BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
			AND L.VNO = G.VNO 
			AND L.Vtyp = G.Vtyp
			AND L.Booktype = G.Booktype
			AND EXISTS (SELECT CLTCODE FROM ACMAST A WHERE A.CLTCODE = G.CLTCODE AND ACCAT = 4) )
AND VTYP NOT IN ('15', '21')

SELECT G.VNO, G.VTYP, G.BOOKTYPE, G.VDT, G.FLAG, L.CLTCODE, VAMT, L.NARRATION, ACTYPE=0
INTO #GSTLED_TEMP
FROM LEDGER L, #GSTLED G
WHERE L.VDT BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
		AND L.VNO = G.VNO 
		AND L.Vtyp = G.Vtyp
		AND L.Booktype = G.Booktype

UPDATE #GSTLED_TEMP SET ACTYPE = 2
WHERE EXISTS  (SELECT CLTCODE FROM ACMAST A WHERE A.CLTCODE = #GSTLED_TEMP.CLTCODE AND ACCAT = 4)

UPDATE #GSTLED_TEMP SET ACTYPE = 1
WHERE EXISTS  (SELECT ACCODE FROM MSAJAG..VALANACCOUNT WHERE ACCODE = CLTCODE AND ACNAME LIKE '%GST%')

SELECT G.VNO, G.VTYP, G.BOOKTYPE, G.VDT, G.FLAG, 
CLTCODE = MAX(CASE WHEN ACTYPE = 2 THEN CLTCODE ELSE '' END),
GLCODE = MAX(CASE WHEN ACTYPE = 0 THEN CLTCODE ELSE '' END),
TAXABLE_AMT = SUM(CASE WHEN ACTYPE = 0 THEN VAMT ELSE 0 END),
TAX_AMT = SUM(CASE WHEN ACTYPE = 1 THEN VAMT ELSE 0 END),
Narration = CONVERT(VARCHAR(500),'')
INTO #GSTACCFINAL
FROM #GSTLED_TEMP G
GROUP BY G.VNO, G.VTYP, G.BOOKTYPE, G.VDT, G.FLAG

SELECT      DISTINCT
         G.VNO, G.VTYP, G.BOOKTYPE, G.VDT,

         STUFF(
               (SELECT      ',' + G1.Narration
               FROM      #GSTLED_TEMP AS G1
               WHERE      G1.VNO = G.VNO
			   AND        G1.VTYP = G.VTYP
			   AND        G1.BOOKTYPE = G.BOOKTYPE
			   AND ACTYPE = 2
               FOR XML PATH('')), 1, 1, '') AS Narration
INTO #NARR
FROM      #GSTLED_TEMP G WHERE ACTYPE = 2
ORDER BY   G.VNO, G.VTYP, G.BOOKTYPE, G.VDT 

UPDATE #GSTACCFINAL SET Narration = G.Narration
FROM #NARR G
WHERE #GSTACCFINAL.VNO = G.VNO
AND        #GSTACCFINAL.VTYP = G.VTYP
AND        #GSTACCFINAL.BOOKTYPE = G.BOOKTYPE

SELECT INVOICE_DATE = VDT, EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT, RECORDFOR = 'LEDGER',
SUBRECORDFOR=GLCODE, INV_DESC=NARRATION, SETT_NO = '', SETT_TYPE = '',
PARTY_CODE = CLTCODE, CONTRACTNO = '', INT_REF_NO = @EXCHANGE + '_' + @SEGMENT + '_' + VNO + '_' + CONVERT(VARCHAR,VTYP) + '_' + CONVERT(VARCHAR,BOOKTYPE), 
TAXABLE_AMT, TAX_AMT, INVOICE_TYPE = FLAG, INVOICE_SUBTYPE = '', INVOICE_CATEGORY = '', REV_INT_REF_NO = '',
LOCATION_CODE = '', SOURCESTATE = '', TARGETSTATE = '', STATE_CODE = '', INV_NO = '', SACCODE = '', SAC_DESC = '',
BRANCH_CODE = CONVERT(VARCHAR(10),''),
IGST_RATE = CONVERT(NUMERIC(18,4),0),
IGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
CGST_RATE = CONVERT(NUMERIC(18,4),0),
CGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
SGST_RATE = CONVERT(NUMERIC(18,4),0),
SGST_AMOUNT = CONVERT(NUMERIC(18,4),0)
FROM #GSTACCFINAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FILL_MULTIBANKID
-- --------------------------------------------------

CREATE PROC FILL_MULTIBANKID

AS

DECLARE @@CUR AS CURSOR, @@CLTCODE AS VARCHAR(10), @@ERRCOUNT AS INT

SELECT @@ERRCOUNT = COUNT(1) FROM MULTIBANKID
IF @@ERRCOUNT > 0
	BEGIN
		SELECT ERROR = 'PLEASE TRUNCATE THE TABLE MULTIBANKID AND THEN EXECUTE THIS SP'
		RETURN
	END

SET @@CUR = CURSOR FOR SELECT DISTINCT PARTY_CODE FROM NCDX.DBO.CLIENT4 WHERE DEPOSITORY NOT IN ('NSDL', 'CDSL')
OPEN @@CUR 
FETCH NEXT FROM @@CUR INTO @@CLTCODE
WHILE @@FETCH_STATUS = 0
	BEGIN
		INSERT INTO MULTIBANKID (Cltcode, Bankid, Accno, Acctype, Chequename, Defaultbank) 
		SELECT TOP 1 
			C4.PARTY_CODE,  
			C4.BANKID, 
			C4.CLTDPID, 
			ACTYPE = (CASE WHEN DEPOSITORY = 'CURRENT' THEN 'CA' WHEN DEPOSITORY = 'SAVING' THEN 'SB' WHEN DEPOSITORY = 'OD' THEN 'OD' WHEN DEPOSITORY = 'CA' THEN 'CA' ELSE 'CA' END),
			A.LONGNAME,
			DEFAULTBANK = 1
		FROM 
			NCDX.DBO.CLIENT4 C4,
			ACMAST A
		WHERE 
			C4.PARTY_CODE = A.CLTCODE
			AND C4.PARTY_CODE = @@CLTCODE
			AND DEPOSITORY NOT IN ('NSDL', 'CDSL')
		FETCH NEXT FROM @@CUR INTO @@CLTCODE
	END

SELECT * FROM MULTIBANKID ORDER BY CLTCODE
SELECT CLTCODE, COUNT(1) FROM MULTIBANKID GROUP BY CLTCODE HAVING COUNT(1) > 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.foaccbilldrcrproc1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 02/04/2002 9:59:39 PM ******/
/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 01/18/2002 1:38:05 PM ******/
/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 12/26/2001 1:26:51 PM ******/
/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 5/7/01 5:53:30 PM ******/
/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 4/5/01 6:44:51 PM ******/
/****** Object:  Stored Procedure dbo.foaccbilldrcrproc1    Script Date: 20-Mar-01 11:43:33 PM ******/
/*Final sql - 07 feb 2001 */
/*Ranjeet Choudhary*/
/*used in nsefo segment*/
/* this view stores the total debit  and credit amount for each settlement no and settlement type 
used in transferbill project*/
CREATE proc foaccbilldrcrproc1
(@settno varchar(10),@setttype varchar(2),@bdate as varchar(11)) as 
select sett_no ,sett_type,sell_buy,totalamount=sum(abs(amount))  from ncdx.dbo.foaccbill 
where sett_no =@settno
and sett_type =@setttype 
and left(convert(varchar,billdate,109),11)=@bdate 
group by sett_no ,sett_type,sell_buy 
order by sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.fodailyaccrealised
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.fodailyaccrealised    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.fodailyaccrealised    Script Date: 02/15/2002 12:12:53 PM ******/
/****** Object:  Stored Procedure dbo.fodailyaccrealised    Script Date: 02/01/2002 6:41:59 PM ******/
/****** Object:  Stored Procedure dbo.fodailyaccrealised    Script Date: 2/1/02 4:19:32 PM ******/
/****** Object:  Stored Procedure dbo.fodailyaccrealised    Script Date: 1/31/02 5:45:48 PM ******/
CREATE  proc fodailyaccrealised
@sdate Varchar(11),
@party Varchar(10)
AS
SELECT left(convert(varchar,vdt,109),11)as vdt,convert(varchar,edt,105)as cdt,CLTCODE,vno,
NARR=isnull((case when (select narr from ledger3 l3
     where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
     then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
     else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno ) end ),''),
VTYPE=ShortDesc,CHQNO=0,VAMT,DRCR
FROM LEDGER L, VMAST V   WHERE CLTCODE = @party AND L.VTYP <> 15 
AND VDT LIKE @sdate + '%' AND L.VTYP = V.VTYPE 
AND EDT like  @sdate + ' %'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.fodailyaccUnrealised
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.fodailyaccUnrealised    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.fodailyaccUnrealised    Script Date: 02/15/2002 12:12:54 PM ******/
/****** Object:  Stored Procedure dbo.fodailyaccUnrealised    Script Date: 02/01/2002 6:41:59 PM ******/
/****** Object:  Stored Procedure dbo.fodailyaccUnrealised    Script Date: 2/1/02 4:19:32 PM ******/
/****** Object:  Stored Procedure dbo.fodailyaccUnrealised    Script Date: 1/31/02 5:45:48 PM ******/
CREATE proc fodailyaccUnrealised
@sdate Varchar(11),
@party Varchar(10)
AS
SELECT left(convert(varchar,vdt,109),11)as vdt,left(convert(varchar,edt,109),11)as cdt,CLTCODE,Vno,
NARR=isnull((case when (select narr from ledger3 l3
     where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
     then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
     else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno ) end ),''),
VTYPE=ShortDesc,CHQNO=0,VAMT,DRCR
FROM LEDGER L, VMAST V   WHERE CLTCODE = @party  AND L.VTYP <> 15 
AND VDT LIKE @sdate + '%'  AND L.VTYP = V.VTYPE 
AND left(convert(varchar,edt,109),20) > @sdate + '23:59:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.foGetCumulativeBalBill
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 9/7/2001 6:05:53 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 8/29/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 7/25/01 10:08:13 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 7/1/01 2:19:42 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 6/30/01 12:21:09 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 5/5/01 2:55:30 PM ******/
/****** Object:  Stored Procedure dbo.foGetCumulativeBalBill    Script Date: 20-Mar-01 11:43:33 PM ******/
/*Final sql - 07 feb 2001 */
/*Ranjeet Choudhary*/
/*used in nsefo segment*/
CREATE PROCEDURE  foGetCumulativeBalBill   @tsettno  varchar(7) ,
@tsetttype as varchar(2),@bdate as varchar(11)
AS
 select  distinct clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.foaccbill s 
 			   where  sett_type=  @tsetttype   and left(convert(varchar,billdate,109),11)=@bdate    and sell_buy =1  
		   	   and  party_code not in ('99890' , '99885' ,'99888','200')) - 
			  (select sum(amount) from ncdx.dbo.foaccbill s 
			  where  sett_type= @tsetttype   and left(convert(varchar,billdate,109),11)=@bdate  and sell_buy =2
			  and  party_code not in ( '99890' ,'99885', '99888','200')),0), 
	 tenddate  = (select distinct billdate from ncdx.dbo.foaccbill s 
		     where sett_type= @tsetttype and left(convert(varchar,billdate,109),11)=@bdate   ),  
	 tpayout  =  (select  max(payout_date) from ncdx.dbo.foaccbill sm 
		     where sett_type=    @tsetttype and left(convert(varchar,billdate,109),11)=@bdate  and sell_buy = 1   ), 
	 tstartdate = (select distinct max(start_date) from ncdx.dbo.fosett_mst s
		     where sett_type=    @tsetttype  and left(convert(varchar,billdate,109),11)=@bdate      ),
	 tpayoutCr  =  (select  max(payout_date) from ncdx.dbo.foaccbill sm 
		     where sett_type=    @tsetttype and left(convert(varchar,billdate,109),11)=@bdate  and sell_buy = 2  )
  from ncdx.dbo.foaccbill s1  where s1.sett_type=  @tsetttype and left(convert(varchar,billdate,109),11)=@bdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_PENALTY_POST
-- --------------------------------------------------
CREATE PROC [dbo].[FOMARGIN_PENALTY_POST]  
(            
	 @UNAME VARCHAR(25),              
	 @VTYP SMALLINT,              
	 @BOOKTYPE VARCHAR(2),            
	 @TRADEDATE VARCHAR(11),            
	 @GLCODE VARCHAR(10),            
     @LEDGERVNO VARCHAR(12),
	 @LEDGERDATE VARCHAR(11)
)
AS              
             
 SET NOCOUNT ON              
        
        
 DECLARE              
  @@ERROR_COUNT AS INT            
    
     
 CREATE TABLE [#RECPAY_TABLE]              
 (              
	  SRNO INT,              
	  VVDT VARCHAR(10),              
	  EEDT VARCHAR(10),              
	  CLTCODE VARCHAR(10),              
	  DRCR VARCHAR(1),              
	  AMOUNT MONEY,              
	  NARRATION VARCHAR(500),              
	  SNO INT IDENTITY (1, 1) NOT NULL ,              
	  VDT DATETIME NULL ,              
	  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),              
	  EDT DATETIME NULL ,              
	  VNO VARCHAR (12)  NULL ,              
	  ACNAME VARCHAR (100)  NULL ,              
	  FYSTART DATETIME NULL,              
	  FYEND DATETIME NULL,              
	  COSTCODE SMALLINT NULL,              
	  LNO SMALLINT NOT NULL DEFAULT(0)              
 ) ON [PRIMARY]              
              
 CREATE TABLE [#RECPAY_TABLE_LNO]              
 (              
  SNO INT ,              
  LNO INT IDENTITY (1, 1) NOT NULL              
 ) ON [PRIMARY]              
              
    
 DECLARE          
  @TRDATE  VARCHAR(10),        
  @EDATE VARCHAR(10) 
  
SELECT @TRDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)        
SELECT @EDATE =  CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)        
           
/*======================== MARGIN PENALTY PLUG IN  ============================================*/
   
CREATE TABLE #TMPDATA 
(	
	PCODE	VARCHAR(10)
)
 
if convert(datetime,@tradedate) >= convert(datetime,'jun 16 2017')
begin
	alter table #TMPDATA
	add RECNO	INT	IDENTITY(1,1)

INSERT INTO #TMPDATA
SELECT PARTY_CODE FROM NCDX.DBO.FOMARGIN_PENALTY(NOLOCK)   
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND PENALTY_AMT + SERVICE_TAX > 0  
end
else
begin
	alter table #TMPDATA
	add RECNO	INT 

INSERT INTO #TMPDATA
SELECT PARTY_CODE, 1 FROM NCDX.DBO.FOMARGIN_PENALTY(NOLOCK)   
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND PENALTY_AMT + SERVICE_TAX > 0  
end


INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,PARTY_CODE ,    
	@TRDATE, @EDATE,'D',    
	AMT = PENALTY_AMT + SERVICE_TAX,      
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE   
FROM     
	NCDX.DBO.FOMARGIN_PENALTY(NOLOCK), #TMPDATA  
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND PENALTY_AMT + SERVICE_TAX > 0
	AND PARTY_CODE = PCODE 
	       
INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,@GLCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(PENALTY_AMT),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NCDX.DBO.FOMARGIN_PENALTY(NOLOCK), #TMPDATA    
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99 AND PCODE = PARTY_CODE 
GROUP BY RECNO

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,ACCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(SERVICE_TAX),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NCDX.DBO.FOMARGIN_PENALTY(NOLOCK), NCDX.DBO.VALANACCOUNT, #TMPDATA    
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND ACNAME = 'SPLIT TAX'
	AND SERVICE_TAX > 0 AND PCODE = PARTY_CODE 
GROUP BY ACCODE, RECNO

/* 
INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,ACCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(CGST_PER),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NSEFO.DBO.FOMARGIN_PENALTY(NOLOCK), NSEFO.DBO.VALANACCOUNT, #TMPDATA    
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND ACNAME = STATE_CODE + '_CGST'
	AND CGST_PER > 0 AND PCODE = PARTY_CODE 
GROUP BY ACCODE, RECNO

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,ACCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(SGST_PER),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NSEFO.DBO.FOMARGIN_PENALTY(NOLOCK), NSEFO.DBO.VALANACCOUNT, #TMPDATA    
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND ACNAME = STATE_CODE + '_SGST'
	AND SGST_PER > 0 AND PCODE = PARTY_CODE 
GROUP BY ACCODE, RECNO

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,ACCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(IGST_PER),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NSEFO.DBO.FOMARGIN_PENALTY(NOLOCK), NSEFO.DBO.VALANACCOUNT, #TMPDATA    
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND ACNAME = STATE_CODE + '_IGST'
	AND IGST_PER > 0
	AND PCODE = PARTY_CODE 
GROUP BY ACCODE, RECNO

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	RECNO,ACCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(UGST_PER),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NSEFO.DBO.FOMARGIN_PENALTY(NOLOCK), NSEFO.DBO.VALANACCOUNT,  #TMPDATA    
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	AND ACNAME = STATE_CODE + '_UGST'
	AND UGST_PER > 0 AND PCODE = PARTY_CODE 
GROUP BY ACCODE,RECNO
*/

/*=============================================================================================*/        
          
  UPDATE              
   #RECPAY_TABLE              
	SET 
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
    FYSTART = P.SDTCUR,              
    FYEND = P.LDTCUR,              
    UPDFLAG = 'Y',              
    ACNAME = LONGNAME,              
    COSTCODE = 0        
    FROM ACMAST A, PARAMETER P        
 --, COSTMAST C              
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
    AND P.CURYEAR = 1              
    AND A.ACCAT IN ('3','4','104')              
    --AND A.BRANCHCODE = C.COSTNAME              
    AND A.BRANCHCODE <> 'ALL'        
              
    UPDATE              
   #RECPAY_TABLE              
   SET              
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
    FYSTART = P.SDTCUR,              
    FYEND = P.LDTCUR,              
    UPDFLAG = 'Y',              
    ACNAME = LONGNAME,              
    COSTCODE = 0        
    FROM ACMAST A, PARAMETER P              
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
    AND P.CURYEAR = 1              
    AND A.ACCAT IN ('3','4','104')     
    AND A.BRANCHCODE = 'ALL'              
             
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/              
              
 DECLARE              
  @@STD_DATE VARCHAR(11),              
  @@LST_DATE VARCHAR(11),              
  @@VNOMETHOD INT,              
  @@ACNAME CHAR(100),              
  @@MICRNO VARCHAR(10),              
  @@DRCR VARCHAR(1)              
              
              
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND              
  
 IF @@ERROR_COUNT > 0              
  BEGIN
   RAISERROR('DATE MISMATCH', 16, 1)    
   DROP TABLE #RECPAY_TABLE              
                 
   RETURN              
  END              
              
           
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)              
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1              
 IF @@ERROR_COUNT > 0              
  BEGIN     
     RAISERROR('SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 16, 1)    
   DROP TABLE #RECPAY_TABLE              
                 
   RETURN              
  END              
              
           
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/             
              
 --SELECT @@ERROR_COUNT = COUNT(1) FROM              
 -- (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)              
 -- FROM #RECPAY_TABLE              
 -- GROUP BY SRNO              
 -- HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A              
 --IF @@ERROR_COUNT > 0              
 -- BEGIN        
 --   RAISERROR('DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS', 16, 1)          
 --  DROP TABLE #RECPAY_TABLE              
           
 --  RETURN              
 -- END              
              
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
 ( 
  SELECT DISTINCT              
   CLTCODE              
  FROM #RECPAY_TABLE           
  WHERE UPDFLAG = 'N'              
 ) A              
       
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL              
   SELECT DISTINCT              
    CLTCODE              
   FROM #RECPAY_TABLE              
   WHERE UPDFLAG = 'N'              
   DROP TABLE #RECPAY_TABLE              
                 
   RETURN              
  END              
              
 DECLARE              
  @@NEWVNO AS VARCHAR(12),              
  @@VDT AS VARCHAR(11),              
  @@LNOCUR AS CURSOR,              
  @@LNOVNO AS INT,       
  @@NOREC AS INT              

 CREATE TABLE #VNO
 (
	LASTVNO VARCHAR(12)
 )           

 DECLARE              
  @@MAXVNO AS VARCHAR(12),              
  @@VNO AS VARCHAR(12),              
  @@RCOUNT AS INT              
 SELECT TOP 1              
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)              
 FROM              
  #RECPAY_TABLE              
              
 SELECT TOP 1              
  @@VNOMETHOD = VNOFLAG,              
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),              
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)              
 FROM              
  PARAMETER              
 WHERE              
  @@VDT BETWEEN SDTCUR AND LDTCUR     
              
IF @LEDGERVNO = ''
BEGIN
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/              
         
              
               
SELECT              
  @@NOREC = COUNT(DISTINCT SRNO)              
 FROM              
  #RECPAY_TABLE              
              

 INSERT INTO #VNO
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

 SELECT @@VNO = LASTVNO FROM #VNO
     
 UPDATE              
  #RECPAY_TABLE              
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)  
END
ELSE
BEGIN  
 SELECT @@VNO = @LEDGERVNO  

 SELECT TOP 1                
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                
 FROM                
  #RECPAY_TABLE                

 UPDATE                
 #RECPAY_TABLE   
 SET VNO = LEDGER_VNO
 FROM  NCDX.DBO.FOMARGIN_PENALTY_POST_STAT_DETAIL
WHERE MARGIN_DATE = @TRADEDATE
AND PARTY_CODE = CLTCODE 

UPDATE #RECPAY_TABLE SET VNO = L.VNO
FROM (SELECT SRNO, VNO FROM #RECPAY_TABLE 
	  WHERE CLTCODE IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4)
	  AND ISNULL(VNO,'') <> ''
	  GROUP BY SRNO, VNO) L
WHERE #RECPAY_TABLE.SRNO = L.SRNO 

create table #recno
(
	sno	int identity(1,1),
	CLTCODE varchar(10),
	vno		varchar(12)
)
insert into #recno
SELECT CLTCODE, vno FROM #RECPAY_TABLE
WHERE CLTCODE IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4)
and isnull(vno,'') = ''
 
SELECT              
  @@NOREC = COUNT(DISTINCT SNO)              
 FROM              
  #recno              
              
 INSERT INTO #VNO
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

 SELECT @@VNO = LASTVNO FROM #VNO
     
 UPDATE              
  #recno              
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SNO - 1) 

update #RECPAY_TABLE set vno = l.vno 
from #recno l
where l.CLTCODE = #RECPAY_TABLE.cltcode

UPDATE #RECPAY_TABLE SET VNO = L.VNO
FROM (SELECT SRNO, VNO FROM #RECPAY_TABLE 
	  WHERE CLTCODE IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4)
	  AND ISNULL(VNO,'') <> ''
	  GROUP BY SRNO, VNO) L
WHERE #RECPAY_TABLE.SRNO = L.SRNO

SELECT @@VNO = @LEDGERVNO  
END                    

DELETE FROM NCDX.DBO.FOMARGIN_PENALTY_POST_STAT_DETAIL
WHERE MARGIN_DATE = @TRADEDATE

INSERT INTO NCDX.DBO.FOMARGIN_PENALTY_POST_STAT_DETAIL
SELECT DISTINCT @TRADEDATE, 1, VNO, @LEDGERDATE, CLTCODE
FROM #RECPAY_TABLE
WHERE CLTCODE IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4)
    
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/              
              
 SET @@LNOCUR = CURSOR FOR              
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE              
 OPEN @@LNOCUR              
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
 WHILE @@FETCH_STATUS = 0              
  BEGIN              
   INSERT INTO #RECPAY_TABLE_LNO              
    (SNO)              
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO              
   UPDATE RP              
    SET LNO = RL.LNO              
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL              
   WHERE RP.SNO = RL.SNO              
   TRUNCATE TABLE #RECPAY_TABLE_LNO 
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
  END             
 CLOSE @@LNOCUR              
 DEALLOCATE @@LNOCUR              
 DROP TABLE #RECPAY_TABLE_LNO              
              
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/              
/*==============================          LEDGER RECORD              
==============================*/              
 INSERT              
 INTO LEDGER              
 SELECT      
  VTYP = @VTYP,              
  VNO,              
  EDT,              
  LNO,              
  ACNAME,              
  DRCR,              
  VAMT = AMOUNT,              
  VDT,              
  VNO1 = VNO,              
  REFNO = 0,              
  BALAMT = AMOUNT,              
  NODAYS = 0,              
  CDT = GETDATE(),              
  CLTCODE,              
  BOOKTYPE = @BOOKTYPE,              
  ENTEREDBY = @UNAME,              
  PDT = GETDATE(),              
  CHECKEDBY = @UNAME,              
  ACTNODAYS = 0,              
  NARRATION              
 FROM              
  #RECPAY_TABLE              
              
/*==============================              
 LEDGER3 RECORD              
==============================*/              
 INSERT              
 INTO LEDGER3              
 SELECT              
  NARATNO = LNO,              
  NARRATION,              
  REFNO = 0,              
  VTYP = @VTYP,              
  VNO,              
  BOOKTYPE = @BOOKTYPE              
  FROM  
  #RECPAY_TABLE   
  
	DELETE FROM TEMPLEDGER2	WHERE SESSIONID = '9999999999'
	
	INSERT INTO TEMPLEDGER2
	SELECT
		'BRANCH',
		C.COSTNAME,
		AMOUNT,
		VTYP = @VTYP,
		VNO,
		LNO,
		DRCR,
		'0',
		BOOKTYPE = @BOOKTYPE,
		SESSIONID = '9999999999',
		CLIENT_CODE = CLTCODE,
		'A',
		'0'
	FROM
		#RECPAY_TABLE RP,
		COSTMAST C
	WHERE
		RP.COSTCODE = C.COSTCODE

	DECLARE @@L2CUR AS CURSOR,
		@@L2VNO AS VARCHAR(12)
		
	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0
	BEGIN
		EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END
	DELETE FROM TEMPLEDGER2	WHERE SESSIONID = '9999999999'
	
	CLOSE @@L2CUR
	DEALLOCATE @@L2CUR
        
/*=========================  MARGIN SHORTAGE PENALTY PLUG IN ==========================*/        
UPDATE NCDX.DBO.FOMARGIN_PENALTY
SET LEDGER_POST_FLAG = 1
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	--AND LEDGER_POST_FLAG = 99
	
UPDATE NCDX.DBO.FOMARGIN_PENALTY_POST_STAT
SET POST_FLAG = 1,LEDGER_VNO=@@VNO, LEDGER_VDT = @@VDT
WHERE 
	MARGIN_DATE =  @TRADEDATE   
/*============================== MARGIN SHORTAGE PENALTY PLUG IN  =====================*/            
         
 DROP TABLE #RECPAY_TABLE
 
 exec GST_SERVICE_TAX_SPLIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_PENALTY_POST_BAKDEC212015
-- --------------------------------------------------



CREATE PROC [DBO].[FOMARGIN_PENALTY_POST]  
(            
	 @UNAME VARCHAR(25),              
	 @VTYP SMALLINT,              
	 @BOOKTYPE VARCHAR(2),            
	 @TRADEDATE VARCHAR(11),            
	 @GLCODE VARCHAR(10),            
     @LEDGERVNO VARCHAR(12),
	 @LEDGERDATE VARCHAR(11)
)
AS              
             
 SET NOCOUNT ON              
        
        
 DECLARE              
  @@ERROR_COUNT AS INT,  
  @SERTAX_GLCODE AS VARCHAR(20)          
    
     
 CREATE TABLE [#RECPAY_TABLE]              
 (              
	  SRNO INT,              
	  VVDT VARCHAR(10),              
	  EEDT VARCHAR(10),              
	  CLTCODE VARCHAR(10),              
	  DRCR VARCHAR(1),              
	  AMOUNT MONEY,              
	  NARRATION VARCHAR(500),              
	  SNO INT IDENTITY (1, 1) NOT NULL ,              
	  VDT DATETIME NULL ,              
	  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),              
	  EDT DATETIME NULL ,              
	  VNO VARCHAR (12)  NULL ,              
	  ACNAME VARCHAR (100)  NULL ,              
	  FYSTART DATETIME NULL,              
	  FYEND DATETIME NULL,              
	  COSTCODE SMALLINT NULL,              
	  LNO SMALLINT NOT NULL DEFAULT(0)              
 ) ON [PRIMARY]              
              
 CREATE TABLE [#RECPAY_TABLE_LNO]              
 (              
  SNO INT ,              
  LNO INT IDENTITY (1, 1) NOT NULL              
 ) ON [PRIMARY]              
              
    
 DECLARE          
  @TRDATE  VARCHAR(10),        
  @EDATE VARCHAR(10) 
  
SELECT @TRDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)        
SELECT @EDATE =  CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)

SELECT @SERTAX_GLCODE = ISNULL(ACCODE,'')
FROM NCDX.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SERVICE TAX'  
           
/*======================== MARGIN PENALTY PLUG IN  ============================================*/
   
  
INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	1,PARTY_CODE ,    
	@TRDATE, @EDATE,'D',    
	AMT = PENALTY_AMT + ISNULL(SERVICE_TAX, 0),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE   
FROM     
	NCDX.DBO.FOMARGIN_PENALTY(NOLOCK)   
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	       
INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	1,@GLCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(ISNULL(PENALTY_AMT, 0)),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NCDX.DBO.FOMARGIN_PENALTY(NOLOCK)   
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)        
SELECT     
	1,@SERTAX_GLCODE ,    
	@TRDATE, @EDATE,'C',    
	AMT = SUM(ISNULL(SERVICE_TAX, 0)),    
	NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE
FROM     
	NCDX.DBO.FOMARGIN_PENALTY(NOLOCK)   
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
		        
DELETE FROM #RECPAY_TABLE WHERE ISNULL(AMOUNT, 0) = 0
/*=============================================================================================*/        

  UPDATE              
   #RECPAY_TABLE              
	SET 
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
    FYSTART = P.SDTCUR,              
    FYEND = P.LDTCUR,              
    UPDFLAG = 'Y',              
    ACNAME = LONGNAME,              
    COSTCODE = 0
    FROM ACMAST A, PARAMETER P  , COSTMAST C              
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
    AND P.CURYEAR = 1              
    AND A.ACCAT IN ('3','4','104')              
    AND A.BRANCHCODE = C.COSTNAME              
    AND A.BRANCHCODE <> 'ALL' 
              
   UPDATE              
   #RECPAY_TABLE              
   SET              
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
    FYSTART = P.SDTCUR,              
    FYEND = P.LDTCUR,              
    UPDFLAG = 'Y',              
    ACNAME = LONGNAME,              
    COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
    FROM ACMAST A, PARAMETER P              
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
    AND P.CURYEAR = 1              
    AND A.ACCAT IN ('3','4','104')     
    AND A.BRANCHCODE = 'ALL'              
             
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/              
              
 DECLARE              
  @@STD_DATE VARCHAR(11),              
  @@LST_DATE VARCHAR(11),              
  @@VNOMETHOD INT,              
  @@ACNAME CHAR(100),              
  @@MICRNO VARCHAR(10),              
  @@DRCR VARCHAR(1)              
              
              
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/              

 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND              
 IF @@ERROR_COUNT > 0              
  BEGIN
   RAISERROR('DATE MISMATCH', 16, 1)    
   DROP TABLE #RECPAY_TABLE              
                 
   RETURN              
  END              
              
           
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)              
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1              
 IF @@ERROR_COUNT > 0              
  BEGIN     
     RAISERROR('SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 16, 1)    
   DROP TABLE #RECPAY_TABLE              
                 
   RETURN              
  END              
              
        
        
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/             
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM #RECPAY_TABLE              
  GROUP BY SRNO              
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A              
 IF @@ERROR_COUNT > 0              
  BEGIN        
    RAISERROR('DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS', 16, 1)          
   DROP TABLE #RECPAY_TABLE              
           
   RETURN              
  END              
              
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
 ( 
  SELECT DISTINCT              
   CLTCODE              
  FROM #RECPAY_TABLE           
  WHERE UPDFLAG = 'N'              
 ) A              
       
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL              
   SELECT DISTINCT              
    CLTCODE              
   FROM #RECPAY_TABLE              
   WHERE UPDFLAG = 'N'              
   DROP TABLE #RECPAY_TABLE              
                 
   RETURN              
  END              
              
 DECLARE              
  @@NEWVNO AS VARCHAR(12),              
  @@VDT AS VARCHAR(11),              
  @@LNOCUR AS CURSOR,              
  @@LNOVNO AS INT,       
  @@NOREC AS INT              
              
IF @LEDGERVNO = ''
BEGIN
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/              
 DECLARE              
  @@MAXVNO AS VARCHAR(12),              
  @@VNO AS VARCHAR(12),              
  @@RCOUNT AS INT              
 SELECT TOP 1              
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)              
 FROM              
  #RECPAY_TABLE              
              
 SELECT TOP 1              
  @@VNOMETHOD = VNOFLAG,              
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),              
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)              
 FROM              
  PARAMETER           
 WHERE              
  @@VDT BETWEEN SDTCUR AND LDTCUR              
              
               
SELECT              
  @@NOREC = COUNT(DISTINCT SRNO)              
 FROM              
  #RECPAY_TABLE              
              
 CREATE TABLE #VNO
 (
	LASTVNO VARCHAR(12)
 )           

 INSERT INTO #VNO
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC

 SELECT @@VNO = LASTVNO FROM #VNO
     
 UPDATE              
  #RECPAY_TABLE              
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)  
END
ELSE
BEGIN  
 SELECT @@VNO = @LEDGERVNO  

 SELECT TOP 1                
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                
 FROM                
  #RECPAY_TABLE                

 UPDATE                
 #RECPAY_TABLE                
 SET VNO = @LEDGERVNO  
END                    
              
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/              
              
 SET @@LNOCUR = CURSOR FOR              
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE              
 OPEN @@LNOCUR              
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
 WHILE @@FETCH_STATUS = 0              
  BEGIN              
   INSERT INTO #RECPAY_TABLE_LNO              
    (SNO)              
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO              
   UPDATE RP              
    SET LNO = RL.LNO              
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL              
   WHERE RP.SNO = RL.SNO              
   TRUNCATE TABLE #RECPAY_TABLE_LNO 
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
  END             
 CLOSE @@LNOCUR              
 DEALLOCATE @@LNOCUR              
 DROP TABLE #RECPAY_TABLE_LNO              
              
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/              
/*==============================          LEDGER RECORD              
==============================*/              
 INSERT              
 INTO LEDGER              
 SELECT      
  VTYP = @VTYP,              
  VNO,              
  EDT,              
  LNO,              
  ACNAME,              
  DRCR,              
  VAMT = AMOUNT,              
  VDT,              
  VNO1 = VNO,              
  REFNO = 0,              
  BALAMT = AMOUNT,              
  NODAYS = 0,              
  CDT = GETDATE(),              
  CLTCODE,              
  BOOKTYPE = @BOOKTYPE,              
  ENTEREDBY = @UNAME,              
  PDT = GETDATE(),              
  CHECKEDBY = @UNAME,              
  ACTNODAYS = 0,              
  NARRATION              
 FROM              
  #RECPAY_TABLE    
  
              
/*==============================              
 LEDGER3 RECORD              
==============================*/              
 INSERT              
 INTO LEDGER3              
 SELECT              
  NARATNO = LNO,              
  NARRATION,              
  REFNO = 0,              
  VTYP = @VTYP,              
  VNO,              
  BOOKTYPE = @BOOKTYPE              
  FROM  
  #RECPAY_TABLE   
  
	DELETE FROM TEMPLEDGER2	WHERE SESSIONID = '9999999999'
	
	INSERT INTO TEMPLEDGER2
	SELECT
		'BRANCH',
		C.COSTNAME,
		AMOUNT,
		VTYP = @VTYP,
		VNO,
		LNO,
		DRCR,
		'0',
		BOOKTYPE = @BOOKTYPE,
		SESSIONID = '9999999999',
		CLIENT_CODE = CLTCODE,
		'A',
		'0'
	FROM
		#RECPAY_TABLE RP,
		COSTMAST C
	WHERE
		RP.COSTCODE = C.COSTCODE

	DECLARE @@L2CUR AS CURSOR,
		@@L2VNO AS VARCHAR(12)
		
	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0
	BEGIN
		EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END
	DELETE FROM TEMPLEDGER2	WHERE SESSIONID = '9999999999'
	
	CLOSE @@L2CUR
	DEALLOCATE @@L2CUR
        
/*=========================  MARGIN SHORTAGE PENALTY PLUG IN ==========================*/        
UPDATE NCDX.DBO.FOMARGIN_PENALTY
SET LEDGER_POST_FLAG = 1
WHERE 
	MARGIN_DATE =  @TRADEDATE   
	AND LEDGER_POST_FLAG = 99
	
UPDATE NCDX.DBO.FOMARGIN_PENALTY_POST_STAT
SET POST_FLAG = 1,LEDGER_VNO=@@VNO, LEDGER_VDT = @@VDT
WHERE 
	MARGIN_DATE =  @TRADEDATE   
/*============================== MARGIN SHORTAGE PENALTY PLUG IN  =====================*/            
         
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoSerTaxSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.FoSerTaxSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.FoSerTaxSp    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.FoSerTaxSp    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.FoSerTaxSp    Script Date: 29-Sep-01 8:12:04 PM ******/
/* Created By vaishali on 26/06/2001 This proc is used in the control FoDateSerTax Control*/
CREATE proc FoSerTaxSp 
@StartDt varchar(12),
@EndDate varchar(12)
as
select convert(varchar,vdt,103), sum(ser) SerTax, sum(brok) Brok  from FoSerTaxView where 
vdt >= @StartDt + ' 00:00:00' and vdt <= @EndDate + ' 23:59:59' 
group by vdt
having sum(ser) <> 0 and sum(brok) <> 0
order by vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GenDateVno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GenDateVno    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GenDateVno    Script Date: 02/04/2002 9:59:39 PM ******/
/****** Object:  Stored Procedure dbo.GenDateVno    Script Date: 01/18/2002 1:38:06 PM ******/
/****** Object:  Stored Procedure dbo.GenDateVno    Script Date: 12/26/2001 1:26:51 PM ******/
/****** Object:  Stored Procedure dbo.GenDateVno    Script Date: 6/20/01 9:42:43 AM ******/
CREATE PROCEDURE GenDateVno AS 
declare @@vno numeric (12,0),
	@@serialno integer,
	@@newserialno varchar(12),
	@@vtyp integer,
	@@vdt varchar(11),
	@@tvdt varchar(11),
	@@tyear varchar (4),
	@@tmonth varchar (2),
	@@tday varchar (2), 
	@@tvno varchar(12),
	@@tvtyp integer,
	@@vtypcur cursor,
	@@datevno cursor
 set @@vtypcur = cursor for
 select distinct vtyp,left(convert(varchar,VDT,109),11), VNO FROM LEDGER 
 ORDER BY Vtyp,left(convert(varchar,VDT,109),11), VNO ASC
 open @@vtypcur
 fetch next  from @@vtypcur into  @@vtyp,@@vdt,@@vno
/*
 while 	@@fetch_status 	= 0 
 begin
	select @@serialno = 1		
	set @@datevno = cursor for 
	select distinct left(convert(varchar,VDT,109),11), VNO FROM aLEDGER 
	WHERE VTYP = @@VTYP order by left(convert(varchar,VDT,109),11),vno
                   open @@datevno
 	fetch next  from @@datevno into  @@vdt,@@vno
*/	
while @@fetch_status = 0
begin
	select @@tvtyp = @@Vtyp
	select @@tvdt = @@vdt
	select @@serialno = 1
	while @@fetch_status = 0 and @@Vtyp = @@TVtyp
	begin
		select @@tvdt = @@vdt
		select @@serialno = 1
		while @@fetch_status = 0 and @@tvdt = @@vdt  and @@Vtyp = @@TVtyp
		begin
			select @@tyear = year(@@vdt)
			select @@tmonth = month(@@vdt)
		
			select @@tmonth = (case when @@tmonth <10 
					then  "0"  + @@tmonth
					else @@tmonth
					end)
			select @@tday = day(@@vdt)
			select @@tday = (case when @@tday <10 
					then  "0"  + @@tday
					else @@tday	
					end)
			select @@newserialno = (case when @@serialno < 10 
					then "000" + convert(varchar,@@serialno)
			    			 else (case when @@serialno < 100 
						then "00" + convert(varchar,@@serialno)
			     	 	  		else (case when @@serialno < 1000	
					 		 then "0" + convert(varchar,@@serialno)
			     		 			else (case when @@serialno < 10000
								then convert(varchar,@@serialno)	 	
				   	     			       end)
							        end)
				   	 	     end)
			     		 end )
        			select 	@@tvno = @@tyear + @@tmonth + @@tday + @@newserialno
			
			update ledger set vno = @@tvno
			where vtyp = @@vtyp and vdt = @@vdt and vno = @@vno
			
			update ledger1 set vno = @@tvno
			where vtyp = @@vtyp and vno = @@vno
			
			update ledger3 set vno = @@tvno
			where vtyp = @@vtyp and vno = @@vno
			select @@serialno = @@serialno + 1	
			
			 fetch next  from @@vtypcur into  @@vtyp,@@vdt,@@vno
		end
	end
 end 	
close @@vtypcur
deallocate @@vtypcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_FT_GL_DETAILS
-- --------------------------------------------------

        
CREATE PROCEDURE [dbo].[GET_FT_GL_DETAILS]        
 @EXCH VARCHAR(10),        
 @FROM_DATE VARCHAR(11),        
 @TO_DATE VARCHAR(11),
 @CTRLCODE_FROM VARCHAR(10) = '00',
 @CTRLCODE_TO VARCHAR(10) = '99'
AS        
        
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
 IF LEN(@FROM_DATE) = 10        
 BEGIN        
  SELECT @FROM_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROM_DATE, 103), 109)        
  SELECT @TO_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TO_DATE, 103), 109)        
 END        
        
 CREATE TABLE #FT_GL_DETAILS        
 (        
  JV_CODE VARCHAR(10)        
  --JV_NAME VARCHAR(100) 
 )
        
 INSERT INTO #FT_GL_DETAILS        
 SELECT         
  JV_CODE         
  --JV_NAME         
 FROM         
  FT_GL         
 WHERE         
  EXCH_FR = @EXCH
  AND JV_CODE BETWEEN @CTRLCODE_FROM AND @CTRLCODE_TO
         
 UNION       
         
 SELECT         
  JV_CODE         
  --JV_NAME         
 FROM         
  FT_GL         
 WHERE         
  EXCH_TO = @EXCH
  AND JV_CODE BETWEEN @CTRLCODE_FROM AND @CTRLCODE_TO       
        
-- SELECT * FROM #FT_GL_DETAILS      
        
 SELECT         
  CTRL_CODE = JV_CODE,         
  --CTRL_NAME = JV_NAME,        
  EXCHANGE = @EXCH,        
  AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)        
 FROM        
  LEDGER L WITH (NOLOCK),         
  #FT_GL_DETAILS F        
 WHERE         
  CLTCODE = JV_CODE        
  AND VDT BETWEEN @FROM_DATE AND @TO_DATE        
  AND VTYP = 88        
 GROUP BY        
  JV_CODE        
  --JV_NAME        
 ORDER BY        
  1        
        
           
 DROP TABLE #FT_GL_DETAILS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA
-- --------------------------------------------------





--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_BKUP_14FEB2019
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_BKUP_14FEB2019]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (/*RELDT = '' OR */RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (/*RELDT = '' OR */RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetAccNameCodeSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 01/28/2002 3:46:44 PM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 01/24/2002 12:11:40 PM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 09/13/2001 6:54:12 AM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 08/13/2001 6:16:40 AM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 7/1/01 2:19:42 PM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 06/28/2001 5:44:43 PM ******/
/****** Object:  Stored Procedure dbo.GetAccNameCodeSp    Script Date: 20-Mar-01 11:43:33 PM ******/
/*This procedure is used to get the cltcode and account name from acmast */
CREATE proc GetAccNameCodeSp 
@accat as char(10),
@Cltcode as varchar(10),
@flag as tinyint
as
if @flag = 1 
begin
	select distinct l.cltcode,l.acname from acmast a,ledger l 
	where accat= @accat 
	and l.cltcode = a.cltcode
	and l.vtyp <> 18
	order by l.acname ,l.cltcode 
end 
if @flag =2
begin
	select distinct l.cltcode,l.acname from acmast  a,ledger l
	where l.cltcode = a.cltcode
	and accat= @accat 
	and l.cltcode = @Cltcode
end 
if @flag =3
begin
	select distinct l.cltcode,l.acname from ledger l,acmast a 
	where l.cltcode = a.cltcode 
	and a.accat = @accat
	and l.vtyp <> 18
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getacname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.getacname    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.getacname    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.getacname    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE proc getacname 
@flag smallint,
@temp varchar(20)
As
If @Flag = 5  or @flag = 1
 BEGIN
  select distinct Acname,cltcode 
   from acmast
 END
Else
If @Flag = 2
 BEGIN
  select distinct cltcode 
  from acmast  
  order by cltcode
 END
Else
If @Flag = 3
 BEGIN
  select acname from acmast 
  where  cltcode like ltrim(@temp) 
 END
Else
If @Flag = 4
 BEGIN
  select cltcode from acmast 
  where  acname = ltrim(@temp)
 End
Else 
 If @Flag = 6 
  BEGIN
   select distinct Acname,cltcode 
   from acmast where accat='2' 
   or accat='1' 
   order by cltcode
     
  END
Else 
 If @Flag = 7
  BEGIN
   select isnull(max(receiptno),0)+1 from ledger1
  END
Else 
 If @Flag = 8
  BEGIN
   select acname,bnkname,brnname,vamt,ddno from ledger l, ledger1 l1 
   where l.drcr='c' and /*l1.refno=l.refno */ l1.vtyp=l.vtyp and l1.vno=l.vno and l1.lno=l.vno and l1.drcr=l.drcr
   and ddno like '%X'  and len(ddno)>1
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetAcNameBS
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 11/28/2001 12:23:43 PM ******/
/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 7/1/01 2:19:42 PM ******/
/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 06/28/2001 5:44:43 PM ******/
/****** Object:  Stored Procedure dbo.GetAcNameBS    Script Date: 20-Mar-01 11:43:33 PM ******/
/*
control name  : BankSlipPrintCtl
Use : To get all acname and cltcode  from acmast in order to print slip receipt
Written by : Kalpana
Date : 15/02/2001
*/
CREATE PROCEDURE GetAcNameBS
AS
select cltcode, acname from acmast where accat = '2' order by acname ,cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetAcnameCq
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.GetAcnameCq    Script Date: 20-Mar-01 11:43:33 PM ******/
/*
control name  : ChqAckPrintCtl
Use : To get all acname from ledger1 in order to print receipt
Written by : Kalpana
Date : 14/02/2001
*/
CREATE PROCEDURE GetAcnameCq
@ReceiptNo integer
AS
 select acname from ledger l, ledger1 l1  where  receiptno = @ReceiptNo
 and l.vno = l1.vno  and l.vtyp = l1.vtyp and l.lno = l1.lno and l.drcr = 'd'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getageing
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.getageing    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.getageing    Script Date: 04/24/2003 5:37:46 PM ******/
/****** Object:  Stored Procedure dbo.getageing    Script Date: 02/18/2003 10:37:37 AM ******/
/* 
Report Name : New Ageing
Changes on - 07/01/2003
In order to change days slabs
*/
CREATE proc getageing
@sessionid varchar(30)
as
/* DELETE FROM ageinglist */
insert into ageinglist
select cltcode, balance=sum(balamt), agedays = 6, drcr, sessionid 
from fintempageing
where agedays >= 0 and agedays <= 6 and sessionid = @sessionid
group by cltcode, drcr, sessionid 
order by cltcode, drcr, sessionid 
insert into ageinglist
select cltcode, balance=sum(balamt), agedays = 29, drcr, sessionid
from fintempageing
where agedays >= 7 and agedays <= 29 and sessionid = @sessionid
group by cltcode, drcr, sessionid 
order by cltcode, drcr, sessionid 
insert into ageinglist
select cltcode, balance=sum(balamt), agedays = 90, drcr, sessionid
from fintempageing
where agedays >= 30 and agedays <= 90 and sessionid = @sessionid
group by cltcode, drcr, sessionid 
order by cltcode, drcr, sessionid 
insert into ageinglist
select cltcode, balance=sum(balamt), agedays = 180, drcr, sessionid
from fintempageing
where agedays >= 91 and sessionid = @sessionid
group by cltcode, drcr, sessionid 
order by cltcode, drcr, sessionid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetBillDataSum
-- --------------------------------------------------



CREATE Proc GetBillDataSum
	@BillDate As Varchar(11), 
	@ShareDb As Varchar(15), 
	@DispOpt As Varchar(7) = 'Summary'

--Exec GetBillDataSum '2004042', 'N', 'MSAJAG', 'Details'
--Exec GetBillDataSum '2004059', 'A ', 'MSAJAG'

As

Declare
@@SQLQry As Varchar(2000)

Set @@SQLQry = "Select Party_Code, M.Acname, Round(Amount,2) As Amount, Sell_Buy, Bill_No From " + @ShareDb
Set @@SQLQry = @@SQLQry + ".Dbo.FoAccbill a, Acmast m  WITH(NOLOCK)"
Set @@SQLQry = @@SQLQry + " Where BillDate Like '" + @BillDate + "%' "
Set @@SQLQry = @@SQLQry + " And A.party_code = M.Cltcode and branchcd = 'ZZZ' "
--Set @@SQLQry = @@SQLQry + " And Round(Amount,2) <> 0 "
Set @@SQLQry = @@SQLQry + " union all "

If @DispOpt = 'Summary'
	Begin
		Set @@SQLQry = @@SQLQry + " Select 'Party Dr', 'Party Amount Receivables', Round(sum(Amount),2) As Amount, Sell_buy, bill_no = 0 "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.FoAccbill a, "
		Set @@SQLQry = @@SQLQry + " Acmast m  where BillDate Like '" + @BillDate + "%' "
		Set @@SQLQry = @@SQLQry + " And A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
		Set @@SQLQry = @@SQLQry + " group by /*bill_no, */Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
		Set @@SQLQry = @@SQLQry + " union all "
	End
Else
	Begin
		Set @@SQLQry = @@SQLQry + " Select Party_Code ,M.AcName, Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.FoAccbill a, "
		Set @@SQLQry = @@SQLQry + " Acmast M  where BillDate Like '" + @BillDate + "%' "
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
		Set @@SQLQry = @@SQLQry + " group by Party_Code ,M.AcName, bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
		Set @@SQLQry = @@SQLQry + " union all "
	End
If @DispOpt = 'Summary'
	Begin
		Set @@SQLQry = @@SQLQry + " Select 'Party CR', 'Party Amount Payables', Round(sum(Amount),2) As Amount,Sell_buy, bill_no = 0 "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.FoAccbill a, acmast m "
		Set @@SQLQry = @@SQLQry + " where BillDate Like '" + @BillDate + "%' "
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
		Set @@SQLQry = @@SQLQry + " group by /*bill_no, */Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
	End
Else
	Begin
		Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
		Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.FoAccbill a, acmast m "
		Set @@SQLQry = @@SQLQry + " where BillDate Like '" + @BillDate + "%' "
		Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
		Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "
--		Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
	End

Print @@SQLQry
Exec(@@SQLQry)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetCumulativeBalBill
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBill    Script Date: 20-Mar-01 11:43:33 PM ******/
/*change done by sheetal on 06 feb 2001*/
/*  gets the cumulative balance amount of all the parties of the selected settlement  .  used in transferbill project     22/03/2000  */
CREATE PROCEDURE  GetCumulativeBalBill   @tsettno  varchar(7) ,
@tsetttype as varchar(2)
AS
/*removd  the hard coding done for the service tax, delivery,brokerage charge and clearing house codes*/
 select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.accbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ( select cltcode from acmast where accat <> 4 ) ) - 			
     (select isnull(sum(amount),0) from ncdx.dbo.accbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( select cltcode from acmast where accat <> 4 ) ),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.accbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.accbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )
/* select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.accbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ('99990' ,'61310', '99985' ,'99988','100')) - 
     (select sum(amount) from ncdx.dbo.accbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( '99990' , '61310','99985', '99988','100')),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.accbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.accbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )*/
/*  from ncdx.dbo.accbill s1  where s1.sett_no=     @tsettno  and s1.sett_type=  @tsetttype*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetCumulativeBalBillins
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.GetCumulativeBalBillins    Script Date: 20-Mar-01 11:43:33 PM ******/
/*created by sheetal on  22/10/2000 
 gets the cumulative balance amount of all the parties of the selected settlement  .  used in transferbill project      
used for the institutional Bill posting */
CREATE PROCEDURE  GetCumulativeBalBillins   @tsettno  varchar(7) ,
@tsetttype as varchar(2)
AS
select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.iaccbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in (select cltcode from acmast where accat <> 4)) - 
     (select sum(amount) from ncdx.dbo.iaccbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in (select cltcode from acmast where accat <> 4)),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.iaccbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.iaccbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )
 /*select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.iaccbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ('99990' ,'61310', '99985' ,'99988','100')) - 
     (select sum(amount) from ncdx.dbo.iaccbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( '99990' , '61310','99985', '99988','100')),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.iaccbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.iaccbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.sett_mst s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )*/
/*  from ncdx.dbo.iaccbill s1  where s1.sett_no=     @tsettno  and s1.sett_type=  @tsetttype*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETDATA_EDIT_All
-- --------------------------------------------------
CREATE PROC [dbo].[GETDATA_EDIT_All]          
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */                  
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */              
@VTYP INT,          
@BANKCODE VARCHAR(10),      
@VNO_FR VARCHAR(12),          
@VNO_TO VARCHAR(12),          
@VDT VARCHAR(11) = '',          
@VAMT MONEY = 0,            
@BOOKTYPE VARCHAR(3),          
@CLTCODE VARCHAR(10) = '',          
@PageSize varchar(3) = '25'          
AS          
          
CREATE TABLE #GETDATA_EDIT          
(          
 VNO VARCHAR(12),           
 CLTCODE VARCHAR(10),           
 ACNAME VARCHAR(100),           
 VAMT MONEY,           
 NARRATION VARCHAR(250),           
 DDNO VARCHAR(20),           
 RELDT VARCHAR(10),          
 BNKNAME VARCHAR(50),      
 VDT VARCHAR(10),  
 LNO INT          
)          
          
DECLARE          
@@SQL VARCHAR(1000)          
          
SET @@SQL = " INSERT INTO #GETDATA_EDIT "          
SET @@SQL = @@SQL + " SELECT TOP " + @PageSize        
SET @@SQL = @@SQL + " L.VNO, CLTCODE, ACNAME, VAMT = CASE L.DRCR WHEN 'D' THEN -VAMT ELSE VAMT END, NARRATION, DDNO, RELDT = CONVERT(VARCHAR(10), RELDT, 103), BNKNAME, CONVERT(VARCHAR(10), VDT, 103), L.LNO "          
SET @@SQL = @@SQL + " FROM "          
SET @@SQL = @@SQL + " LEDGER L, LEDGER1 L1 "          
SET @@SQL = @@SQL + " WHERE "          
SET @@SQL = @@SQL + " L.VNO = L1.VNO "          
SET @@SQL = @@SQL + " AND L.VTYP = L1.VTYP "          
SET @@SQL = @@SQL + " AND L.BOOKTYPE = L1.BOOKTYPE "          
IF @VTYP = 5   
BEGIN  
SET @@SQL = @@SQL + " AND L.LNO = L1.LNO "          
END  
IF @VTYP <> 5   
BEGIN  
 SET @@SQL = @@SQL + " AND L.LNO =1 "          
END  
--SET @@SQL = @@SQL + " AND L.VNO = L2.VNO "          
--SET @@SQL = @@SQL + " AND L.VTYP = L2.VTYP "          
--SET @@SQL = @@SQL + " AND L.BOOKTYPE = L2.BOOKTYPE "          
SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @BANKCODE + "'"       
IF @VDT = ''           
 BEGIN           
 SET @@SQL = @@SQL + " AND VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "      
END      
ELSE      
BEGIN      
 SET @@SQL = @@SQL + " AND VDT LIKE '" + @VDT + "%' "      
END      
SET @@SQL = @@SQL + " AND L.VTYP = " + CONVERT(VARCHAR, @VTYP)          
SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @VNO_FR + "' AND '" + @VNO_TO +"' "          
SET @@SQL = @@SQL + " AND L.BOOKTYPE = '" + @BOOKTYPE + "' "        
        
IF @VAMT <> 0          
 BEGIN          
 SET @@SQL = @@SQL + " AND L.VAMT = " + CONVERT(VARCHAR,@VAMT) + " "          
 END          
          
IF @CLTCODE <> ''          
 BEGIN          
 SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @CLTCODE + "' "          
 END          
          
/*IF @VDT = ''           
 BEGIN           
  SET @@SQL = @@SQL + " AND L.VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "          
 END           
ELSE           
 BEGIN           
  SET @@SQL = @@SQL + " AND L.VDT LIKE '" + @VDT + "%' "          
 END     */      
  SET @@SQL = @@SQL + " ORDER BY L.VNO "          
        
print @@SQL      
EXEC (@@SQL)          
          
/*DELETE FROM #GETDATA_EDIT          
WHERE           
EXISTS           
 (      
  SELECT VNO FROM LEDGER L WHERE L.VNO = #GETDATA_EDIT.VNO AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE          
  GROUP BY VNO, VTYP, BOOKTYPE HAVING COUNT(1) > 2         
 )*/          
  
IF @VTYP = 5  
BEGIN  
 UPDATE G SET RELDT = L1.RELDT FROM #GETDATA_EDIT G, LEDGER1 L1  
 WHERE L1.VNO = G.VNO AND L1.VTYP = @VTYP AND L1.RELDT <> ''  
END  
          
SELECT * FROM #GETDATA_EDIT  

SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getgroupdata
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.getgroupdata    Script Date: 20-Mar-01 11:43:33 PM ******/
create proc getgroupdata
as
select grpname,grpcode from grpmast where 
         grpcode like 'A0000000000' or grpcode like 'N0000000000' 
         or grpcode like 'X0000000000' or  grpcode like 'L0000000000' 
         order by grpname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getLedgerAmount
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmount    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE getLedgerAmount(@partycode varchar(10)) AS
select l.cltcode , Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode and vdt <= GETDATE())- 
(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= GETDATE()) 
From Ledger l 
where vdt <= GETDATE()
and cltcode = @partycode
group by l.Cltcode, l.acname 
/* This procedure is written to get the ledger amount which is used for MTOM report */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getLedgerAmt
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.getLedgerAmt    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE  getLedgerAmt   @partycode  varchar(10) ,@getdate  varchar(20)
AS
  select l.cltcode ,Amount  = ( select isnull(sum(vamt),0) from ledger 
 where drcr = 'D' and cltcode = l.cltcode and vdt <= @getdate)
 - (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
 cltcode = l.cltcode and vdt <= @getdate) From Ledger l 
 where vdt <= @getdate  and l.cltcode = @partycode  group by l.Cltcode, l.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetledgerSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.GetledgerSpP    Script Date: 20-Mar-01 11:43:33 PM ******/
/*Returns the details for the specified voucher type*/
/*used in Journal Entery printing*/
CREATE Proc GetledgerSpP
@vtyp smallint,
@strtdt datetime,
@enddt datetime
AS
select acname,l.vno,l.drcr,l.vamt,l.refno,l.cltcode,l.balamt,l.vdt from ledger l 
where l.vtyp = @vtyp
and VDT >= @strtdt 
and  vdt<= @enddt
order by l.refno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetManualBankReco
-- --------------------------------------------------

create  Proc GetManualBankReco
	@BankCode Varchar(10),
	@FDate Varchar(11),
	@TDate Varchar(11),
	@Edit SmallInt,
	@SVtyp Varchar(5),
	@OrderBy Varchar(15),
      @DDno Varchar(15),
	@SelectRl Varchar(20) = ''
As
Declare @@SelectQury As Varchar(2000)
	Select @@SelectQury = "Select L.AcName, L1.DrCr, L.CltCode, L1.DDNO, Convert(Varchar(10), dddt, 103) as Dddt, CONVERT(VARCHAR(10),reldt,103) AS  reldt1, "
	Select @@SelectQury = @@SelectQury + "L.Vamt as RelAmt, Convert(Varchar(10), L.Vdt, 103) As Vdt, "
	Select @@SelectQury = @@SelectQury + "CONVERT(VARCHAR(10),vdt,101) AS   vdt1,l1.vno,l1.vtyp,l1.booktype,l1.lno,reldt ,ShortDesc "
	Select @@SelectQury = @@SelectQury + "From Ledger L, Ledger1 L1, VMast V, (Select Vno, Vtyp, BookType From Ledger Where CltCode = '" + @BankCode + "' "
	If @SVtyp = 'All'
		Begin
			Select @@SelectQury = @@SelectQury + "And Vtyp In (2,3,5,19,20,17) "
		End
	Else
		Begin
			If @SVtyp = '2'
				Begin
					Select @@SelectQury = @@SelectQury + "And Vtyp = 2 "
				End
			Else
				Begin
					If @SVtyp = '3'
						Begin
							Select @@SelectQury = @@SelectQury + "And Vtyp = 3 "
						End
				End
		End
      If @FDate <> ''
        Begin
	    Select @@SelectQury = @@SelectQury + "And Vdt Between '" + @FDate + "' And '" + @TDate + " 23:59:59') L2 "
        End
      Else
        Begin
            Select @@SelectQury = @@SelectQury + ") L2 "
        End
	Select @@SelectQury = @@SelectQury + "Where L.Vno = L2.Vno and L.Vtyp = L2.Vtyp And L.BookType = L2.Booktype And L.CLtcode <> '" + @BankCode + "' "
	Select @@SelectQury = @@SelectQury + "And L.Vno = L1.Vno and L.Vtyp = L1.Vtyp ANd L.BookType = L1.Booktype ANd L.Lno = L1.Lno "
      If @Ddno <> ''
        Begin
	     Select @@SelectQury = @@SelectQury + "And L1.Ddno = '" + @Ddno + "'"
        End
/*
	If @SelectRl = 'chkRelDt'
		Begin
			Select @@SelectQury = @@SelectQury + "And L1.RelDt Between '" + @FDate + "' And '" + @TDate + " 23:59:59' "
		End
	Else
		Begin
			Select @@SelectQury = @@SelectQury + "And L.Vdt Between '" + @FDate + "' And '" + @TDate + " 23:59:59' "
		End
*/
	If @Edit = 1
		Begin
			Select @@SelectQury = @@SelectQury + "And reldt Not Like 'Jan  1 1900%' "
		End
	Else
		Begin
			Select @@SelectQury = @@SelectQury + "And reldt Like 'Jan  1 1900%' "
		End
	Select @@SelectQury = @@SelectQury + "And v.Vtype = l.vtyp and (upper(clear_mode) <> 'C') "
	If @OrderBy = 'relamt'
		Begin
			Select @@SelectQury = @@SelectQury + "Order By relamt ,vdt1 ,l1.vtyp,l1.vno "
		End
	Else
		Begin
			If @OrderBy = 'vdt'
				Begin
					Select @@SelectQury = @@SelectQury + "Order By vdt1, relamt, l1.vtyp, l1.vno "
				End
			Else
				Begin
					If @OrderBy = 'ddno'
						Begin
							Select @@SelectQury = @@SelectQury + "Order By ddno, relamt, l1.vtyp, l1.vno "
						End
					Else
						Begin
							If @OrderBy = 'reldt'
								Begin
									Select @@SelectQury = @@SelectQury + "Order By reldt, relamt, l1.vtyp, l1.vno "
								End
						End
				End
		End
Print @@SelectQury
Exec (@@SelectQury)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetMarginparty
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetMarginparty    Script Date: 1/17/2004 11:39:08 PM ******/

/* Changed by Kalpana on 31/08/2002
Previous where condition is commented. */
CREATE PROCEDURE GetMarginparty
@branch varchar(10),
@fromdate varchar(11),
@todate varchar(11)
AS
if @branch = 'ALL' 
begin
	select distinct  acname, cltcode from acmast a, marginledger m
	where a.cltcode = m.party_code and vdt >= @fromdate and vdt <= @todate+' 23:59:59'
end
else
begin
	select distinct  acname, cltcode from acmast a, marginledger m, msajag.dbo.clientmaster c
	where a.cltcode = m.party_code and m.party_code = c.party_code and branch_cd like @branch + '%'
/* 	where a.cltcode = m.party_code and m.party_code = c.party_code and branch_cd = branch */
	and vdt >= @fromdate and vdt <= @todate+' 23:59:59'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetReceiptNo
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.GetReceiptNo    Script Date: 20-Mar-01 11:43:33 PM ******/
/*
control name  : ChqAckPrintCtl
Use : To get all receipt numbers from ledger1 in order to print receipt
Written by : Kalpana
Date : 14/02/2001
*/
CREATE PROCEDURE GetReceiptNo AS
select distinct isnull(receiptno, '') from ledger1 where vtyp = '2'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetSlipNo
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetSlipNo    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetSlipNo    Script Date: 04/11/2002 7:26:31 PM ******/
/*
control name  : BankSlipPrintCtl
Use : To get all slip Numbers  from slipreceipt in order to print slip receipt
Written by : Kalpana
Date : 15/02/2001
*/
CREATE PROCEDURE  GetSlipNo
@booktype varchar(10),
@flag integer
AS
/*
select distinct convert(integer,slipno) slipno from slipreceipt order by slipno 
*/
if @flag = 1
begin
	select distinct slipno from ledger1 l
	where l.vtyp in (2,19) and l.booktype =@booktype and slipno <> 0
	order by slipno
end
else
begin
	select distinct convert(varchar,slipdate,103)  slipdate from ledger1 l
	where l.vtyp in (2,19) and l.booktype =@booktype  and slipno <> 0
	order by convert(varchar,slipdate,103)
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetStartEndDateSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 02/22/2002 1:56:05 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 01/24/2002 12:11:43 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.GetStartEndDateSp    Script Date: 20-Mar-01 11:43:33 PM ******/
/*This procedure is used to get the start and end date of the current financial year from parameter table
The record with curyear = 1 is the current year record
The date is retrieved in dd/mm/yyyy format*/
create proc GetStartEndDateSp as
select convert(varchar,sdtcur,103)sdtcur,convert(varchar,ldtcur,103)ldtcur from parameter where curyear = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GST_SERVICE_TAX_SPLIT
-- --------------------------------------------------
CREATE  PROC [dbo].[GST_SERVICE_TAX_SPLIT]
AS

DECLARE @SPLITCODE VARCHAR(10)

DECLARE @GSTDATE DATETIME

SET  @GSTDATE = 'JUl  1 2017'

SELECT @SPLITCODE = ACCODE FROM NSEFO.DBO.VALANACCOUNT
WHERE ACNAME = 'SPLIT TAX'

SELECT VNO, VTYP, BOOKTYPE, VDT, LNO=MAX(LNO) 
INTO #STAXVNO FROM LEDGER
WHERE VDT >= @GSTDATE
AND CLTCODE = @SPLITCODE
GROUP BY VNO, VTYP, BOOKTYPE, VDT

SELECT L.Vtyp, L.Vno, L.Edt, L.Lno, L.Acname, L.Drcr, L.Vamt, L.Vdt, L.Vno1, L.Refno, L.Balamt, 
	   L.Nodays, L.Cdt, L.Cltcode, L.Booktype, L.Enteredby, L.Pdt, L.Checkedby, L.Actnodays, L.Narration 
INTO #LEDGER 
FROM LEDGER L, #STAXVNO V
WHERE L.VDT >= @GSTDATE 
AND L.VDT = V.VDT
AND L.VNO = V.VNO
AND L.VTYP = V.VTYP
AND L.BOOKTYPE = V.BOOKTYPE

SELECT VNO,VTYP,BOOKTYPE,RECCNT = COUNT(1) INTO #WRONGDATA FROM (
SELECT CLTCODE, VNO,VTYP,BOOKTYPE 
FROM #LEDGER
WHERE CLTCODE IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4)
GROUP BY CLTCODE,VNO,VTYP,BOOKTYPE ) A
GROUP BY VNO,VTYP,BOOKTYPEOWNER
HAVING COUNT(1) > 1

DELETE FROM #LEDGER
WHERE EXISTS (SELECT VNO FROM #WRONGDATA
			  WHERE #WRONGDATA.VNO = #LEDGER.VNO
			  AND	#WRONGDATA.VTYP = #LEDGER.VTYP
			  AND   #WRONGDATA.BOOKTYPE = #LEDGER.BOOKTYPE) 

 
SELECT DISTINCT PARTY_CODE, SOURCESTATE = G.STATE, 
				TARGETSTATE = L_STATE, VDT, VNO, VTYP, BOOKTYPE,
GST_PER = CONVERT(NUMERIC(18,2),0),
CGST_PER = CONVERT(NUMERIC(18,2),0),
SGST_PER = CONVERT(NUMERIC(18,2),0),
IGST_PER = CONVERT(NUMERIC(18,2),0),
UGST_PER = CONVERT(NUMERIC(18,2),0),
STATE_CODE = CONVERT(VARCHAR(2),'')
INTO #FINDATA
FROM #LEDGER L, NSEFO.DBO.TBL_CLIENT_GST_DATA C, NSEFO.DBO.TBL_GST_LOCATION G
WHERE L.CLTCODE = C.PARTY_CODE
AND C.GST_LOCATION = G.LOC_CODE
AND VDT BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

INSERT INTO #FINDATA
SELECT DISTINCT CL_CODE,SOURCESTATE=OWNER.STATE, 
TARGETSTATE=L_STATE,  VDT, VNO, VTYP, BOOKTYPE,
GST_PER = CONVERT(NUMERIC(18,2),0),
CGST_PER = CONVERT(NUMERIC(18,2),0),
SGST_PER = CONVERT(NUMERIC(18,2),0),
IGST_PER = CONVERT(NUMERIC(18,2),0),
UGST_PER = CONVERT(NUMERIC(18,2),0),
STATE_CODE = CONVERT(VARCHAR(2),'')
FROM #LEDGER N, NSEFO.DBO.FOOWNER OWNER,
NSEFO.DBO.TBL_STATE_GST_DATA T, NSEFO.DBO.CLIENT1 G
WHERE  OWNER.State = STATE_NAME
AND VDT BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE   
AND G.CL_CODE NOT IN (SELECT PARTY_CODE FROM #FINDATA WHERE G.CL_CODE = #FINDATA.Party_Code)
AND G.CL_CODE = N.CLTCODE 

-- ADDED NEW --
DELETE FROM #LEDGER
WHERE EXISTS (SELECT VNO FROM #FINDATA
			  WHERE #FINDATA.VNO = #LEDGER.VNO
			  AND	#FINDATA.VTYP = #LEDGER.VTYP
			  AND   #FINDATA.BOOKTYPE = #LEDGER.BOOKTYPE) 
-- ADDED NEW --

UPDATE #FINDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM NSEFO.DBO.STATE_MASTER WHERE STATE <> 'OTHER')

UPDATE #FINDATA SET
	GST_PER  = (CASE WHEN TARGETSTATE = SOURCESTATE THEN S.GST_PER ELSE 0 END),
	CGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE THEN S.CGST_PER ELSE 0 END),
	SGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE AND UTI_FLAG = 0 THEN S.SGST_PER ELSE 0 END),
	IGST_PER = (CASE WHEN TARGETSTATE <> SOURCESTATE THEN S.IGST_PER ELSE 0 END),
	UGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE AND UTI_FLAG = 1 THEN S.UGST_PER ELSE 0 END),
	STATE_CODE = S.STATE_CODE 
FROM NSEFO.DBO.TBL_STATE_GST_DATA S
WHERE STATE_NAME = SOURCESTATE
AND VDT BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

SELECT L.* INTO #SGSTLED FROM #LEDGER L, #FINDATA F 
WHERE L.VDT = F.VDT 
  AND L.VNO = F.VNO
  AND L.VTYP = F.VTYP
  AND L.BOOKTYPE = L.BOOKTYPE
  AND L.CLTCODE = @SPLITCODE
  AND (SGST_PER + UGST_PER) > 0 

UPDATE #SGSTLED SET CLTCODE = ACCODE, VAMT = ROUND(VAMT * SGST_PER / GST_PER,4), 
LNO = #SGSTLED.LNO + 1
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #SGSTLED.VDT = F.VDT 
  AND #SGSTLED.VNO = F.VNO
  AND #SGSTLED.VTYP = F.VTYP
  AND #SGSTLED.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_SGST'
  AND SGST_PER > 0 

UPDATE #SGSTLED SET CLTCODE = ACCODE, VAMT = ROUND(VAMT * UGST_PER / GST_PER,4), 
LNO = #SGSTLED.LNO + 1
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #SGSTLED.VDT = F.VDT 
  AND #SGSTLED.VNO = F.VNO
  AND #SGSTLED.VTYP = F.VTYP
  AND #SGSTLED.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_UGST'
  AND UGST_PER > 0
  
UPDATE #LEDGER SET VAMT = #LEDGER.VAMT - F.VAMT
FROM #SGSTLED F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND #LEDGER.CLTCODE = @SPLITCODE

UPDATE #LEDGER SET CLTCODE = ACCODE
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_CGST'
  AND CGST_PER > 0 
  AND #LEDGER.CLTCODE = @SPLITCODE

UPDATE #LEDGER SET CLTCODE = ACCODE
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_IGST'
  AND IGST_PER > 0 
  AND #LEDGER.CLTCODE = @SPLITCODE

INSERT INTO #LEDGER 
SELECT * FROM #SGSTLED

UPDATE #LEDGER SET ACNAME = A.ACNAME
FROM ACMAST A 
WHERE A.CLTCODE = #LEDGER.CLTCODE

DECLARE @CRVAMT MONEY
DECLARE @DRVAMT MONEY
DECLARE @CRVAMT_NEW MONEY
DECLARE @DRVAMT_NEW MONEY

SET @CRVAMT = 0 
SET @DRVAMT = 0 
SET @CRVAMT_NEW = 0 
SET @DRVAMT_NEW = 0 

SELECT @CRVAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
	   @DRVAMT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END)
FROM LEDGER
WHERE VDT >= @GSTDATE
AND EXISTS (SELECT VNO FROM #LEDGER
			  WHERE LEDGER.VNO = #LEDGER.VNO
			  AND	LEDGER.VTYP = #LEDGER.VTYP
			  AND   LEDGER.BOOKTYPE = #LEDGER.BOOKTYPE)

SELECT @CRVAMT_NEW = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
	   @DRVAMT_NEW = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END)
FROM #LEDGER 

IF @CRVAMT = @CRVAMT_NEW AND @DRVAMT = @DRVAMT_NEW
BEGIN
	DELETE FROM LEDGER
	WHERE VDT >= @GSTDATE
	AND EXISTS (SELECT VNO FROM #LEDGER
				  WHERE LEDGER.VNO = #LEDGER.VNO
				  AND	LEDGER.VTYP = #LEDGER.VTYP
				  AND   LEDGER.BOOKTYPE = #LEDGER.BOOKTYPE)

	INSERT INTO LEDGER
	SELECT Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration 
	FROM #LEDGER 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.insertdefaultaccounts
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 01/04/1980 1:40:37 AM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.insertdefaultaccounts    Script Date: 20-Mar-01 11:43:33 PM ******/
/*WRITTEN BY vns ON 03-fEB-2001*/
/*To insert default accounts in account master */
CREATE PROCEDURE insertdefaultaccounts AS
/* for NSE CM */
insert into defaacmast values('CLEARING HOUSE','CLEARING HOUSE','LIABILITY','3','','99985','','L0101000000')
insert into defaacmast values('BROKERAGE REALISED','BROKERAGE REALISED','INCOME','3','','99990','','N0101000000')
insert into defaacmast values('SERVICE TAX','SERVICE TAX','LIABILITY','3','','99988','','L0101000000')
insert into defaacmast values('DELIVERY CHARGES','DELIVERY CHARGES','INCOME','3','','61310','','N0101000000')
insert into defaacmast values('ROUNDING OFF','ROUNDING OFF','INCOME','3','','100','','N0101000000')
insert into defaacmast values('MARGIN','MARGIN','LIABILITY','3','','99984','','N0101000000')
insert into defaacmast values('SERVICE TAX PAYABLE','SERVICE TAX PAYABLE','LIABILITY','3','','99987','','L0101000000')
insert into defaacmast values('SEBI TURNOVER TAX','SEBI TURNOVER TAX','LIABILITY','3','','99970','','L0101000000')
insert into defaacmast values('TURNOVER TAX','TURNOVER TAX','LIABILITY','3','','99971','','L0101000000')
insert into defaacmast values('INSURANCE CHARGES','INSURANCE CHARGES','LIABILITY','3','','99972','','L0101000000')
insert into defaacmast values('BROKER NOTE STAMP CHARGES','BROKER NOTE STAMP CHARGES','LIABILITY','3','','99973','','L0101000000')
insert into defaacmast values('OTHER CHARGES','OTHER CHARGES','LIABILITY','3','','99974','','L0101000000')
/* for NSE FO */
insert into defaacmast values('CLEARING HOUSE','CLEARING HOUSE','LIABILITY','3','','99885','','L0101000000')
insert into defaacmast values('BROKERAGE REALISED','BROKERAGE REALISED','INCOME','3','','99890','','N0101000000')
insert into defaacmast values('SERVICE TAX','SERVICE TAX','LIABILITY','3','','99888','','L0101000000')
insert into defaacmast values('ROUNDING OFF','ROUNDING OFF','INCOME','3','','200','','N0101000000')
insert into defaacmast values('MARGIN','MARGIN','LIABILITY','3','','99891','','N0101000000')
insert into defaacmast values('SERVICE TAX PAYABLE','SERVICE TAX PAYABLE','LIABILITY','3','','99887','','L0101000000')
insert into defaacmast values('SEBI TURNOVER TAX','SEBI TURNOVER TAX','LIABILITY','3','','99870','','L0101000000')
insert into defaacmast values('TURNOVER TAX','TURNOVER TAX','LIABILITY','3','','99871','','L0101000000')
insert into defaacmast values('INSURANCE CHARGES','INSURANCE CHARGES','LIABILITY','3','','99872','','L0101000000')
insert into defaacmast values('BROKER NOTE STAMP CHARGES','BROKER NOTE STAMP CHARGES','LIABILITY','3','','99873','','L0101000000')
insert into defaacmast values('OTHER CHARGES','OTHER CHARGES','LIABILITY','3','','99874','','L0101000000')
/*for BSE CM */
insert into defaacmast values('CLEARING HOUSE','CLEARING HOUSE','LIABILITY','3','','99785','','L0101000000')
insert into defaacmast values('BROKERAGE REALISED','BROKERAGE REALISED','INCOME','3','','99790','','N0101000000')
insert into defaacmast values('SERVICE TAX','SERVICE TAX','LIABILITY','3','','99788','','L0101000000')
insert into defaacmast values('DELIVERY CHARGES','DELIVERY CHARGES','INCOME','3','','61410','','N0101000000')
insert into defaacmast values('ROUNDING OFF','ROUNDING OFF','INCOME','3','','300','','N0101000000')
insert into defaacmast values('MARGIN','MARGIN','LIABILITY','3','','99791','','N0101000000')
insert into defaacmast values('SERVICE TAX PAYABLE','SERVICE TAX PAYABLE','LIABILITY','3','','99787','','L0101000000')
insert into defaacmast values('SEBI TURNOVER TAX','SEBI TURNOVER TAX','LIABILITY','3','','99770','','L0101000000')
insert into defaacmast values('TURNOVER TAX','TURNOVER TAX','LIABILITY','3','','99771','','L0101000000')
insert into defaacmast values('INSURANCE CHARGES','INSURANCE CHARGES','LIABILITY','3','','99772','','L0101000000')
insert into defaacmast values('BROKER NOTE STAMP CHARGES','BROKER NOTE STAMP CHARGES','LIABILITY','3','','99773','','L0101000000')
insert into defaacmast values('OTHER CHARGES','OTHER CHARGES','LIABILITY','3','','99774','','L0101000000')
/* for BSE FO */
insert into defaacmast values('CLEARING HOUSE','CLEARING HOUSE','LIABILITY','3','','99685','','L0101000000')
insert into defaacmast values('BROKERAGE REALISED','BROKERAGE REALISED','INCOME','3','','99690','','N0101000000')
insert into defaacmast values('SERVICE TAX','SERVICE TAX','LIABILITY','3','','99688','','L0101000000')
insert into defaacmast values('ROUNDING OFF','ROUNDING OFF','INCOME','3','','400','','N0101000000')
insert into defaacmast values('MARGIN','MARGIN','LIABILITY','3','','99691','','N0101000000')
insert into defaacmast values('SERVICE TAX PAYABLE','SERVICE TAX PAYABLE','LIABILITY','3','','99687','','L0101000000')
insert into defaacmast values('SEBI TURNOVER TAX','SEBI TURNOVER TAX','LIABILITY','3','','99970','','L0101000000')
insert into defaacmast values('TURNOVER TAX','TURNOVER TAX','LIABILITY','3','','99971','','L0101000000')
insert into defaacmast values('INSURANCE CHARGES','INSURANCE CHARGES','LIABILITY','3','','99972','','L0101000000')
insert into defaacmast values('BROKER NOTE STAMP CHARGES','BROKER NOTE STAMP CHARGES','LIABILITY','3','','99973','','L0101000000')
insert into defaacmast values('OTHER CHARGES','OTHER CHARGES','LIABILITY','3','','99974','','L0101000000')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2
-- --------------------------------------------------
CREATE PROC [dbo].[InsertToLedger2]     
(  
      @sessionid varchar(15),    
      @vno varchar(12),    
      @branchflag tinyint,    
      @costcenterflag tinyint,    
      @costenable char(1),    
      @statusid as varchar(30),    
      @statusname as varchar(30)    
)   
  
As    
  
set nocount on  
  
declare    
      @@onlyall tinyint,    
      @@onebranch tinyint,    
      @@multibranch tinyint,    
      @@oneBranchAll tinyint,    
      @@MultiBranchall tinyint,    
      @@Allcount smallint,    
      @@Branchcount smallint,    
      @@OldBranch varchar(10),    
      @@vtype varchar(2),    
      @@party2 varchar(10),    
      @@costbreakup tinyint,    
      @@costcode1 int,    
    
/*=======================================================================================  
      Fields retrived from templedger2   
=======================================================================================*/  
      @@category varchar(20),    
      @@branch varchar(25),    
      @@amt    money,    
      @@vtyp varchar(2),    
      @@vno  varchar(12),    
      @@lno  int,    
      @@drcr char(1),    
      @@costcode smallint,    
      @@booktype varchar(2),    
      @@sessionid varchar(25),    
      @@party_code varchar(10),    
      @@mainbr as varchar(10),       
      @@rcursor as cursor    
    
if @branchflag = 1 and @costcenterflag  = 1    
begin    
/*=======================================================================================  
      0 = True   1 = False      
=======================================================================================*/  
      select @@onlyall = 0               /* True */    
      select @@onebranch = 1             /* True */    
      select @@multibranch = 1           /* False */    
      select @@onebranchall = 1          /* False */    
      select @@Multibranchall = 1        /* False */    
          
      select @@allcount = 0    
      select @@Branchcount = 0    
      select @@OldBranch = ''    
    
      SELECT @@mainbr =   
                  (  
                        SELECT   
                              BranchName   
                        FROM branchaccounts   
                        WHERE DefaultAc = 1  
                  )   
    
      SELECT @@vtype =   
                  (  
                        SELECT DISTINCT   
                              vtype   
                        FROM templedger2   
                        WHERE rtrim(sessionid) = rtrim(@sessionid)   
                              AND vno = @vno  
                  )   
       
      SELECT @@costbreakup =   
                  (  
                        SELECT   
                              count(*)   
                        FROM templedger2   
                        WHERE rtrim(sessionid) = rtrim(@sessionid)   
                              AND category = 'BRANCH'   
                              AND vno = @vno   
                              AND costflag = 'C'  
                  )   
    
      /*=======================================================================================  
            if @@vtype = 8 and @@costbreakup > 0    
      =======================================================================================*/  
      if @@costbreakup > 0    
      begin    
            DELETE t2  
            FROM templedger2 t2  
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND upper(rtrim(branch)) = 'ALL'   
                  AND vno = @vno   
                  AND costflag = 'A'   
                  AND exists   
                        (   
                              SELECT   
                                    party_code   
                              FROM templedger2 t1  
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'C'  
                        )   
  
            DELETE t2  
            FROM templedger2 t2  
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno = @vno   
                  AND costflag = 'C'   
       AND exists   
                        (   
                              SELECT   
                                    party_code   
                              FROM templedger2 t1  
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'A' and upper(rtrim(t1.branch)) <> 'ALL'  
                        )   
  
  end
  
            UPDATE   
                  templedger2   
                  SET costflag = 'A'   
        
            if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24    
            begin    
                  UPDATE   
                    templedger2   
                        SET branch = 'HO'   
                  WHERE upper(rtrim(branch)) = 'ALL'   
                        AND costflag = 'A'   
                
      end    
    
      set @@rcursor = cursor for    
            SELECT   
                  category,  
                  branch,  
                  paidamt,  
                  vtype,  
                  vno,  
                  lno,  
                  drcr,  
                  costcode,  
                  booktype,  
                  sessionid,  
                  party_code   
            FROM templedger2   
            WHERE category = 'BRANCH'   
                  AND rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno =@vno   
                  AND costflag = 'A'   
      open @@rcursor    
      fetch next from @@rcursor     
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code     
    
      while @@fetch_status = 0    
      begin    
            if rtrim(@@branch) = 'ALL'    
            begin    
                  select @@Allcount = @@Allcount + 1    
            end    
            else     
            if rtrim(@@branch) = @@OldBranch    
            begin    
                  select @@OnlyAll = 1    
            end    
            else    
            if @@OldBranch = ''    
            begin    
                  select @@OnlyAll = 1    
                  select @@OldBranch = rtrim(@@branch)    
                  select @@Branchcount = @@Branchcount + 1    
            end    
            else     
            begin    
                  select @@OnlyAll = 1    
                  select @@Branchcount = @@Branchcount + 1    
                  select @@Multibranch = 0    
                  select @@OneBranch = 1               
            end    
              
            fetch next from @@rcursor     
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code     
      end    
      close @@rcursor    
      deallocate @@rcursor    
    
/*      select "AllCount = " + convert(varchar,@@Allcount)    
      select "BranchCount = " + convert(varchar,@@BranchCount)  */  
    
      if @@onlyall = 1    
      begin    
            if @@Allcount = 0    
            begin    
                  if @@branchcount = 1    
                  begin    
                        select @@onebranch = 0    
                        select @@multibranch = 1    
                        select @@oneBranchAll = 1    
                        select @@MultiBranchall = 1    
                  end    
                  else    
                  begin    
                        select @@Multibranch = 0    
                        select @@onebranch = 1    
                        select @@oneBranchAll = 1    
                        select @@MultiBranchall = 1    
                  end    
            end    
            else    
            begin    
                  if @@branchcount = 1    
                  begin    
                        select @@onebranchAll = 0    
                        select @@onebranch = 1    
                        select @@multibranch = 1    
                        select @@MultiBranchall = 1    
                  end    
                  else    
                  begin    
                        select @@MultibranchAll = 0    
          select @@onebranch = 1    
                        select @@multibranch = 1    
                        select @@onebranchAll = 1    
                  end    
            end    
      end    
    
      if @@Onlyall = 0     
      begin    
            SELECT   
                  @@vtype =   
                        (  
                              SELECT DISTINCT   
                                    vtype   
                              FROM templedger2   
                              WHERE rtrim(sessionid) = rtrim(@sessionid)   
                                    AND vno = @vno  
        )   
                  SELECT   
                  @@party2 =   
                        (  
                              SELECT DISTINCT   
                                    party_code   
                              FROM templedger2   
                              WHERE rtrim(sessionid) = rtrim(@sessionid)   
                                    AND upper(rtrim(branch)) = 'ALL'   
                                    AND vno = @vno   
                                    AND costflag = 'A'   
                                    AND lno = 1  
                        )   
            SELECT   
                  @@costbreakup =   
                        (  
                              SELECT   
                                    count(*)   
                              FROM templedger2   
                              WHERE rtrim(sessionid) = rtrim(@sessionid)   
                                    AND category = 'BRANCH'   
                                    AND vno = @vno   
                                    AND costflag = 'C'  
                        )   
        
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')     
            begin    
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND upper(branch) = 'ALL'   
                        AND vno = @vno   
                        AND costflag = 'A'   
        
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND upper(drcr) = 'C'   
                        AND vno = @vno   
                        AND costflag = 'C'   
        
                  INSERT   
                  INTO templedger2   
                  SELECT   
                        category,   
                        branch,   
                        paidamt,   
                        vtype,   
                        vno,   
                        1,   
                        (   
                              CASE   
                                    WHEN drcr = 'D'   
                                    THEN 'C'   
                                    ELSE 'D'   
                              END  
                        ),   
                        costcode,   
                        booktype,   
                        sessionid,   
                        @@party2,   
                        costflag,   
                        1   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND vno = @vno   
            end    
            if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )    
            begin    
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND upper(branch) = 'ALL'   
                        AND vno = @vno   
                        AND costflag = 'A'   
        
                  DELETE   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
        AND upper(drcr) = 'D'   
                        AND vno = @vno   
                        AND costflag = 'C'   
        
                  INSERT   
                  INTO templedger2   
                  SELECT   
                        category,   
                        branch,   
                        paidamt,   
                        vtype,   
                        vno,   
                        1,   
                        (   
                              CASE   
                                    WHEN drcr = 'D'   
                                    THEN 'C'   
                           ELSE 'D'   
                              END  
                        ),   
                        costcode,   
                        booktype,   
                        sessionid,   
                        @@party2,   
                        costflag,   
                        1   
                  FROM templedger2   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND category = 'BRANCH'   
                        AND vno = @vno   
            end    
      end    
    
    
      if @@Onlyall = 0     
      begin     
            if @statusid = 'BRANCH'     
            begin    
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        c.costcode,   
                        BookType,  
                        upper(party_code)   
                  FROM templedger2 t,   
                        costmast c   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND rtrim(costname) = rtrim(@statusname)   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
            end    
            else    
            begin    
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        c.costcode,   
                        BookType,  
                        upper(party_code)   
                  FROM templedger2 t,   
                        Branchaccounts b,   
                        costmast c   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND DefaultAc = 1   
                        AND rtrim(BranchName) = rtrim(costname)   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
            end    
      end    
      else    
      if @@OneBranch = 0    
      begin    
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  c.costcode,   
                  BookType,   
                  upper(party_code )   
            FROM templedger2 t,   
                  costmast c   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(costname)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
      end    
      else    
      if @@MultiBranch = 0    
      Begin    
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  c.costcode,   
                  BookType,   
                  upper(party_code)   
            FROM templedger2 t,   
                  costmast c   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(costname)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
        
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  costcode=   
                        (   
                              SELECT   
                                    costcode   
                              FROM costmast c,   
 branchaccounts b   
                              WHERE DefaultAc = 1   
                                    AND rtrim(branchname) = rtrim(costname)  
                        ),   
                  BookType,   
                  upper(BrControlAc)   
            FROM templedger2 t,   
                  branchaccounts b   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(branchname)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
                  AND rtrim(branch) <> rtrim(@@mainbr)   
        
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  vno,   
                  lno,   
                  (   
                        CASE   
                              WHEN drcr= 'd'   
                              OR drcr = 'D'   
                              THEN 'C'   
                              ELSE 'D'   
                        END  
                  ),   
                  paidamt,   
                  c.costcode,   
                  BookType,   
                  upper(MainControlAc)   
            FROM templedger2 t,   
                  costmast c,   
                  branchaccounts b   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND rtrim(branch) = rtrim(costname)   
                  AND rtrim(BranchName) = rtrim(branch)   
                  AND category = 'BRANCH'   
                  AND vno =@vno   
                  AND costflag = 'A'   
                  AND rtrim(branch) <> rtrim(@@mainbr)   
      end    
      else    
      if @@OneBranchAll = 0     
      begin    
      set @@rcursor = cursor for    
            SELECT   
                  branch   
            FROM templedger2   
            WHERE category = 'BRANCH'   
                  AND rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno = @vno   
                  AND branch <> 'ALL'   
                  AND costflag = 'A'   
            ORDER BY branch   
            open @@rcursor    
            fetch next from @@rcursor into @@branch     
            while @@fetch_status = 0    
            begin    
            SELECT @@costcode1 =   
                        (   
                              SELECT   
                                    costcode   
                              FROM costmast   
                              WHERE rtrim(@@branch) = rtrim(costname)  
                        )   
                  fetch next from @@rcursor into @@branch     
                  end    
                  close @@rcursor    
                  deallocate @@rcursor    
              
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        c.costcode,   
                        BookType,   
                        upper(party_code)   
                  FROM templedger2 t,   
                        costmast c   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND rtrim(branch) = rtrim(costname)   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
              
                  INSERT   
                  INTO ledger2   
                  SELECT   
                        vtype,   
                        vno,   
                        lno,   
                        drcr,   
                        paidamt,   
                        @@costcode1,   
                        BookType,   
                        upper(party_code)   
                  FROM templedger2 t   
                  WHERE rtrim(sessionid) = rtrim(@sessionid)   
                        AND rtrim(branch) = 'ALL'   
                        AND category = 'BRANCH'   
                        AND vno =@vno   
                        AND costflag = 'A'   
            end    
      end    
    
      if @costcenterflag  = 1    
      begin    
            INSERT   
            INTO ledger2   
            SELECT   
                  vtype,   
                  @vno,   
                  lno,   
                  drcr,   
                  paidamt,   
                  costcode,   
                  BookType,  
                  upper(party_code )   
            FROM templedger2 t   
            WHERE rtrim(sessionid) = rtrim(@sessionid)   
                  AND vno = @vno   
                  AND costflag = 'C'   
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.inserttoledger2_bAKUP
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 1/17/2004 11:39:09 PM ******/    
    
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 02/27/2003 11:46:46 AM ******/    
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 01/27/2003 9:52:25 PM ******/    
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 01/24/2003 8:56:09 PM ******/    
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 12/27/2002 4:39:13 PM ******/    
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 12/04/2002 1:48:26 PM ******/    
/****** Object:  Stored Procedure dbo.inserttoledger2    Script Date: 10/12/2002 6:11:04 PM ******/    
CREATE proc inserttoledger2_bAKUP     
@sessionid varchar(15),    
@vno varchar(12),    
@branchflag tinyint,    
@costcenterflag tinyint,    
@costenable char(1),    
@statusid as varchar(30),    
@statusname as varchar(30)    
as    
declare    
@@onlyall tinyint,    
@@onebranch tinyint,    
@@multibranch tinyint,    
@@oneBranchAll tinyint,    
@@MultiBranchall tinyint,    
@@Allcount smallint,    
@@Branchcount smallint,    
@@OldBranch varchar(10),    
@@vtype varchar(2),    
@@party2 varchar(10),    
@@costbreakup tinyint,    
@@costcode1 tinyint,    
/* Fields retrived from templedger2 */    
@@category varchar(20),    
@@branch varchar(25),    
@@amt    money,    
@@vtyp varchar(2),    
@@vno  varchar(12),    
@@lno  int,    
@@drcr char(1),    
@@costcode smallint,    
@@booktype varchar(2),    
@@sessionid varchar(25),    
@@party_code varchar(10),    
@@mainbr as varchar(10),       
@@rcursor as cursor    
/*    
if @costcenterflag  = 1    
begin    
insert into ledger2    
select vtype, @vno, lno, drcr, paidamt, costcode, BookType,upper(party_code )    
from templedger2 t    
where rtrim(sessionid) = rtrim(@sessionid) and vno = @vno and costflag = 'C'    
end     
*/    
if @branchflag = 1 and @costcenterflag  = 1    
begin    
/* 0 = True     
   1 = False    
*/    
select @@onlyall = 0               /* True */    
select @@onebranch = 1             /* True */    
select @@multibranch = 1           /* False */    
select @@onebranchall = 1          /* False */    
select @@Multibranchall = 1        /* False */    
select @@allcount = 0    
select @@Branchcount = 0    
select @@OldBranch = ''    
select @@mainbr = (select BranchName from branchaccounts where DefaultAc = 1)    
select @@vtype = (select distinct vtype from templedger2     
                  where rtrim(sessionid) = rtrim(@sessionid) and vno = @vno)    
       
select @@costbreakup = (select count(*) from templedger2     
        where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH'     
        and vno = @vno and costflag = 'C')    
/* if @@vtype = 8 and @@costbreakup > 0  */    
if @@costbreakup > 0    
begin    
    delete from templedger2 where rtrim(sessionid) = rtrim(@sessionid) and upper(rtrim(branch)) = 'ALL'    
    and vno = @vno and costflag = 'A'     
    and party_code in ( select distinct party_code from templedger2 where costflag = 'C' )    
/*    delete from templedger2     
    where rtrim(sessionid) = rtrim(@sessionid) and vno = @vno     
    and party_code in ( select distinct MainControlAc from branchaccounts )    
*/    
    update templedger2 set costflag = 'A'    
    if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24    
    begin    
     update templedger2 set branch = 'HO' where upper(rtrim(branch)) = 'ALL' and costflag = 'A'    
    end    
end    
/*    
if @@vtype = 8 and @@costbreakup > 0     
begin    
    delete from templedger2 where rtrim(sessionid) = rtrim(@sessionid) and upper(rtrim(branch)) = 'ALL'    
    and vno = @vno and costflag = 'A'     
    and party_code in ( select distinct party_code from templedger2 where costflag = 'C' )    
    insert into templedger4    
    select category, branch, paidamt, vtype, vno, lno, drcr=(case when drcr='D' then 'C' else 'D' end), costcode,    
    booktype, sessionid, party_code, costflag, rowid, BrControlAc    
 from templedger2 left outer join branchaccounts b on upper(b.MainControlAc) = upper(party_code) and upper(b.branchname) = upper(branch)    
    where sessionid = rtrim(@sessionid) and vno = @vno    
   and party_code in ( select distinct MainControlAc from branchaccounts )    
    update templedger4 set branch = b.branchname from branchaccounts b     
    where upper(b.BrControlAc) = upper(party_code)     
    update templedger4 set costcode = b.costcode from costmast b     
    where rtrim(upper(costname)) = rtrim(upper(branch))     
    insert into templedger2     
    select category, branch, paidamt, vtype, vno, lno, drcr, costcode,    
    booktype, sessionid, BrControlAc, costflag, rowid from templedger4    
    truncate table templedger4    
end    
*/    
set @@rcursor = cursor for    
select category,branch,paidamt,vtype,vno,lno,drcr,costcode,booktype,sessionid,party_code     
from templedger2 where category = 'BRANCH' and rtrim(sessionid) = rtrim(@sessionid) and vno =@vno and costflag = 'A'    
open @@rcursor    
fetch next from @@rcursor     
into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code     
while @@fetch_status = 0    
begin    
   if rtrim(@@branch) = 'ALL'    
      begin    
         select @@Allcount = @@Allcount + 1    
      end    
   else     
      if rtrim(@@branch) = @@OldBranch    
         begin    
            select @@OnlyAll = 1    
         end    
      else    
         if @@OldBranch = ''    
            begin    
               select @@OnlyAll = 1    
               select @@OldBranch = rtrim(@@branch)    
               select @@Branchcount = @@Branchcount + 1    
            end    
         else     
            begin    
               select @@OnlyAll = 1    
               select @@Branchcount = @@Branchcount + 1    
               select @@Multibranch = 0    
               select @@OneBranch = 1    
            end    
   fetch next from @@rcursor     
   into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code     
end    
close @@rcursor    
deallocate @@rcursor    
select 'AllCount = ' + convert(varchar,@@Allcount)    
select 'BranchCount = ' + convert(varchar,@@BranchCount)    
if @@onlyall = 1    
begin    
   if @@Allcount = 0    
      begin    
         if @@branchcount = 1    
            begin    
               select @@onebranch = 0    
               select @@multibranch = 1    
               select @@oneBranchAll = 1    
               select @@MultiBranchall = 1    
            end    
         else    
            begin    
               select @@Multibranch = 0    
               select @@onebranch = 1    
               select @@oneBranchAll = 1    
               select @@MultiBranchall = 1    
         end    
      end    
   else    
      begin    
         if @@branchcount = 1    
            begin    
               select @@onebranchAll = 0    
               select @@onebranch = 1    
               select @@multibranch = 1    
               select @@MultiBranchall = 1    
            end    
         else    
            begin    
               select @@MultibranchAll = 0    
               select @@onebranch = 1    
               select @@multibranch = 1    
   select @@onebranchAll = 1    
            end    
      end    
end    
/*    
select "Onlyall = " + convert(varchar,@@onlyall)    
select "OneBranch = " + convert(varchar,@@onebranch)    
select "MultiBranch = " + convert(varchar,@@multibranch)    
select "OneBranchall = " + convert(varchar,@@onebranchall)    
select "MultiBranchall = " + convert(varchar,@@Multibranchall)    
*/    
if @@Onlyall = 0     
begin    
   select @@vtype = (select distinct vtype from templedger2     
                  where rtrim(sessionid) = rtrim(@sessionid) and vno = @vno)    
       
   select @@party2 = (select distinct party_code from templedger2     
             where rtrim(sessionid) = rtrim(@sessionid) and upper(rtrim(branch)) = 'ALL'    
             and vno = @vno and costflag = 'A' and lno = 1)    
   select @@costbreakup = (select count(*) from templedger2     
        where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH'     
        and vno = @vno and costflag = 'C')    
/* print "costbreakup= " + str(@@costbreakup,2)  */    
   if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')     
      begin    
        delete from templedger2     
        where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH' and upper(branch) = 'ALL'    
        and vno = @vno and costflag = 'A'    
        delete from templedger2     
  where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH' and upper(drcr) = 'C'    
        and vno = @vno and costflag = 'C'    
        insert into templedger2    
         select category, branch, paidamt, vtype, vno, 1, ( case when drcr = 'D' then 'C' else 'D' end), costcode,    
             booktype, sessionid, @@party2, costflag, 1 from templedger2    
             where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH'     
             and vno = @vno    
      end    
   if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )    
      begin    
        delete from templedger2     
        where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH' and upper(branch) = 'ALL'    
        and vno = @vno and costflag = 'A'    
        delete from templedger2     
        where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH' and upper(drcr) = 'D'    
        and vno = @vno and costflag = 'C'    
        insert into templedger2    
        select category, branch, paidamt, vtype, vno, 1, ( case when drcr = 'D' then 'C' else 'D' end), costcode,    
             booktype, sessionid, @@party2, costflag, 1 from templedger2    
             where rtrim(sessionid) = rtrim(@sessionid) and category = 'BRANCH'     
             and vno = @vno    
      end    
end    
if @@Onlyall = 0     
   begin    
     if @statusid = 'BRANCH'     
        begin    
         insert into ledger2    
         select vtype, vno, lno, drcr, paidamt, c.costcode, BookType,upper(party_code)    
         from templedger2 t, costmast c    
         where rtrim(sessionid) = rtrim(@sessionid) and rtrim(costname) = rtrim(@statusname)    
         and category = 'BRANCH' and vno =@vno and costflag = 'A'    
        end    
     else    
        begin    
         insert into ledger2    
         select vtype, vno, lno, drcr, paidamt, c.costcode, BookType,upper(party_code)    
         from templedger2 t, Branchaccounts b, costmast c    
         where rtrim(sessionid) = rtrim(@sessionid) and DefaultAc = 1 and rtrim(BranchName) = rtrim(costname)    
         and category = 'BRANCH' and vno =@vno and costflag = 'A'    
        end    
   end    
else    
   if @@OneBranch = 0    
      begin    
         insert into ledger2    
         select vtype, vno, lno, drcr, paidamt, c.costcode, BookType, upper(party_code )    
         from templedger2 t, costmast c    
         where rtrim(sessionid) = rtrim(@sessionid) and rtrim(branch) = rtrim(costname)    
        and category = 'BRANCH' and vno =@vno and costflag = 'A'    
      end    
   else    
      if @@MultiBranch = 0    
         Begin    
            insert into ledger2    
            select vtype, vno, lno, drcr, paidamt, c.costcode, BookType, upper(party_code)    
            from templedger2 t, costmast c    
            where rtrim(sessionid) = rtrim(@sessionid) and rtrim(branch) = rtrim(costname)    
            and category = 'BRANCH' and vno =@vno and costflag = 'A'    
            insert into ledger2    
            select vtype, vno, lno, drcr, paidamt,     
            costcode= ( select costcode from costmast c, branchaccounts b where DefaultAc = 1 and rtrim(branchname) = rtrim(costname)),    
            BookType, upper(BrControlAc)    
            from templedger2 t, branchaccounts b    
            where rtrim(sessionid) = rtrim(@sessionid) and rtrim(branch) = rtrim(branchname)    
            and category = 'BRANCH' and vno =@vno and costflag = 'A' and rtrim(branch) <> rtrim(@@mainbr)    
            insert into ledger2    
            select vtype, vno, lno, ( case when drcr= 'd' or drcr = 'D' then 'C' else 'D' end),    
                   paidamt, c.costcode, BookType, upper(MainControlAc)    
            from templedger2 t, costmast c, branchaccounts b    
            where rtrim(sessionid) = rtrim(@sessionid) and rtrim(branch) = rtrim(costname)    
            and rtrim(BranchName) = rtrim(branch) and category = 'BRANCH' and vno =@vno and costflag = 'A'    
            and rtrim(branch) <> rtrim(@@mainbr)    
       end    
      else    
         if @@OneBranchAll = 0     
            begin    
               set @@rcursor = cursor for    
    select branch from templedger2 where category = 'BRANCH' and rtrim(sessionid) = rtrim(@sessionid)    
               and vno = @vno and branch <> 'ALL' and costflag = 'A' order by branch    
               open @@rcursor    
               fetch next from @@rcursor into @@branch     
               while @@fetch_status = 0    
                  begin    
                     select @@costcode1 = ( select costcode from costmast where rtrim(@@branch) = rtrim(costname))    
                     fetch next from @@rcursor into @@branch     
                  end    
               close @@rcursor    
               deallocate @@rcursor    
               insert into ledger2    
               select vtype, vno, lno, drcr, paidamt, c.costcode, BookType, upper(party_code)    
               from templedger2 t, costmast c    
               where rtrim(sessionid) = rtrim(@sessionid) and rtrim(branch) = rtrim(costname)    
              and category = 'BRANCH' and vno =@vno and costflag = 'A'    
               insert into ledger2    
               select vtype, vno, lno, drcr, paidamt, @@costcode1, BookType, upper(party_code)    
               from templedger2 t    
               where rtrim(sessionid) = rtrim(@sessionid) and rtrim(branch) = 'ALL'    
               and category = 'BRANCH' and vno =@vno and costflag = 'A'    
            end    
end    
if @costcenterflag  = 1    
begin    
insert into ledger2    
select vtype, @vno, lno, drcr, paidamt, costcode, BookType,upper(party_code )    
from templedger2 t    
where rtrim(sessionid) = rtrim(@sessionid) and /* category <> 'BRANCH' and */ vno = @vno and costflag = 'C'    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lbillparproc
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.lbillparproc    Script Date: 20-Mar-01 11:43:33 PM ******/
/*This procedure gets bnkname field from which sett no, sett type , billno can be extracted */
create procedure lbillparproc @reno varchar(12), @vtype smallint , @code varchar(10) as
SELECT BNKNAME, L.REFNO, L.CLTCODE FROM LEDGER L, LEDGER1 L1 WHERE
l1.REFNO=@reno and l.vtyp=@vtype and cltcode=@code and 
left(l.refno,7)=left(l1.refno,7) 
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ledbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ledbal    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.ledbal    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.ledbal    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE ledbal
@vdt smalldatetime,
@partycode varchar(10)
 AS
select l.cltcode,amount=isnull(((select sum(l1.vamt) from ledger l1 where l1.drcr='d' and l.cltcode=l1.cltcode 
and l1.vdt <= @vdt + ' 23:59:59' 
group by l1.cltcode ,l1.drcr ) -
(select sum(l1.vamt) from ledger l1 where l1.drcr='c' and l.cltcode=l1.cltcode and l1.vdt <= @vdt + ' 23:59:59'
 group by l1.cltcode, l1.drcr)),0) from ledger l where l.vdt <= @vdt + '23:59:59' 
and l.cltcode=@partycode
group by l.cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LedgerDetailAcmastSsP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailAcmastSsP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE LedgerDetailAcmastSsP
 AS
select distinct acname 
from acmast 
 order by acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LedgerDetailFinalSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.LedgerDetailFinalSpP    Script Date: 20-Mar-01 11:43:33 PM ******/
CREATE PROCEDURE LedgerDetailFinalSpP
@cltcode varchar(10),
@startdate varchar(12),
@enddate varchar(12)
 AS
select convert(varchar,l.vdt,103), vtyp, dramt=isnull((case drcr when 'd' then vamt end),0),  
cramt=isnull((case drcr when 'c' then vamt end),0), vno1, nar=isnull((select l3.narr from ledger3 l3 
where l3.refno=left(l.refno,7)), '') from ledger l,vmast where l.cltcode like @cltcode
And vtyp = vtype and l.vdt>=@startdate and  l.vdt<=@enddate
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LedgerEntCl1UpdateSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntCl1UpdateSp    Script Date: 20-Mar-01 11:43:34 PM ******/
/* Created by vaishali on 26/12/2000
  Used in the control LedgerEntry to update the credit limit
*/
CREATE PROCEDURE LedgerEntCl1UpdateSp
@crlimit as money,
@party_cd as varchar(10)
 AS
Update ncdx.dbo.client1 set credit_limit = credit_limit + @crlimit
where cl_code in(select cl_code from ncdx.dbo.client2
    where party_code = @party_cd)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LedgerEntSelectSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 11/28/2001 12:23:44 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 29-Sep-01 8:12:04 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.LedgerEntSelectSp    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE LedgerEntSelectSp
@party_cd as varchar(10)
 AS
select credit_limit from ncdx.dbo.client1 c1,ncdx.dbo.client2 c2
where c1.cl_code = c2.cl_code and c2.party_code = @party_cd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LedgerExtract
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.LedgerExtract    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.LedgerExtract    Script Date: 01/11/2003 3:42:03 PM ******/
/****** Object:  Stored Procedure dbo.LedgerExtract    Script Date: 01/28/2002 3:26:56 PM ******/
/**************************************************************************************************************************************************************************************************
THIS SP  IS USED IN THE LEDGER DISPLAY REPORT 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Modification Done By Sheetal On 25/01/2002
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added two new parameters viz: @flag and @costcode. 
These are used to display the client's transactions either for all the branches or for a particular branch 
Depending on the @flag value 
If @flag = 0  then show client's transaction for all the branches
If @flag = 1 then show client's transaction for a selected branch (i.e for the passed costcode )
Modification Done By Sheetal On 11/09/2001
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added the vdt, edt option 
This procedure gets all the ledger details   between the start and end dates specified for a particular party 
Modification Done By Sheetal On 20/03/2001
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added the condition Voucher date >= Start Date Passed as parameter 
***************************************************************************************************************************************************************************************************/
CREATE PROCEDURE LedgerExtract    
@tstrtDate   datetime,
@tEndDate   datetime,
@tCode  varchar(10),
@vdtedtflag tinyint,
@flag integer,
@costcode smallint
AS
if @vdtedtflag = 0 
begin
	if @flag = 0 
	begin
		select convert(varchar,VDT,103),vno, vtyp,drcr,
		dramt=isnull((case drcr when 'd' then vamt end),0),
		cramt=isnull((case drcr when 'c' then vamt end),0),balamt,Vdesc, 
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
			    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    		    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0) end ),'')
		from ledger l , vmast 
		WHERE   vdt<=  @tEndDate and vdt >= @tstrtDate and CLTCODE=  @tcode
		and vmast.vtype = l.vtyp and l.vtyp <> 18
		order by   vdt  ,vtyp, vno 
	end
	Else if @flag = 1 
	begin
		select convert(varchar,VDT,103),l.vno, vtyp,l.drcr,
		dramt=isnull((case l2.drcr when 'd' then camt end),0),
		cramt=isnull((case l2.drcr when 'c' then camt end),0),balamt,Vdesc, 
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
			    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    		    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0) end ),'')
		from ledger l , vmast ,ledger2 l2
		WHERE   l.vtyp = l2.vtype and l.vno = l2.vno and l.booktype = l2.booktype  and l.lno = l2.lno
		and  vdt<=  @tEndDate and vdt >= @tstrtDate and l.CLTCODE=  @tcode and costcode = @costcode
		and vmast.vtype = l.vtyp and l.vtyp <> 18
		order by   vdt  ,vtyp, l.vno 
	end
end 
if @vdtedtflag = 1
begin
	if @flag = 0 
	begin
		select convert(varchar,EDT,103),vno, vtyp,drcr,
		dramt=isnull((case drcr when 'd' then vamt end),0),
		cramt=isnull((case drcr when 'c' then vamt end),0),balamt,Vdesc, 
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
			    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    		    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0) end ),'')
		from ledger l , vmast 
		WHERE   edt<=  @tEndDate and edt >= @tstrtDate and CLTCODE=  @tcode
		and vmast.vtype = l.vtyp and l.vtyp <> 18
		order by   edt  ,vtyp, vno 
	end
	Else if @flag = 1 
	begin
		select convert(varchar,EDT,103),l.vno, vtyp,l.drcr,
		dramt=isnull((case l2.drcr when 'd' then camt end),0),
		cramt=isnull((case l2.drcr when 'c' then camt end),0),balamt,Vdesc, 
		narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
			    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    		    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0) end ),'')
		from ledger l , vmast ,ledger2 l2
		WHERE  l.vtyp = l2.vtype and l.vno = l2.vno and l.booktype = l2.booktype  and l.lno = l2.lno
		and  edt<=  @tEndDate and edt >= @tstrtDate and l.CLTCODE=  @tcode and costcode = @costcode
		and vmast.vtype = l.vtyp and l.vtyp <> 18
		order by   edt  ,vtyp, l.vno 
	end 
end 
/*
if @vdtedtflag = 0 
begin
	select convert(varchar,VDT,103),vno, vtyp,
	dramt=isnull((case drcr when 'd' then vamt end),0),
	cramt=isnull((case drcr when 'c' then vamt end),0),balamt,Vdesc, 
	narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno ) end ),'')
	,drcr 
	from ledger l , vmast 
	WHERE   vdt<=  @tEndDate and vdt >= @tstrtDate
	and CLTCODE=  @tcode
	and l.vtyp=vmast.vtype 
	and l.vtyp <> 18
	order by   vdt  ,vtyp, vno 
end 
if @vdtedtflag = 1
begin
	select convert(varchar,EDT,103),vno, vtyp,
	dramt=isnull((case drcr when 'd' then vamt end),0),
	cramt=isnull((case drcr when 'c' then vcamt end),0),balamt,Vdesc, 
	narr= isnull((case when (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno) is not null 
		    then (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno)
	    	    else (select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno ) end ),'')
	,drcr 
	from ledger l , vmast 
	WHERE   edt<=  @tEndDate and edt >= @tstrtDate
	and CLTCODE=  @tcode
	and l.vtyp=vmast.vtype 
	and l.vtyp <> 18
	order by   edt  ,vtyp, vno 
end 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LedgerRefno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.LedgerRefno    Script Date: 20-Mar-01 11:43:34 PM ******/
/* THIS PROCEDURE UPDATES THE LEDGERTEMP TABLE WITH THE MAX OF THE VNO AND VNO1 FOR A PARTICULAR VOUCHER TYPE*/
CREATE proc LedgerRefno 
@inpgvptype smallint
/*@refno varchar(12)  OUTPUT*/
as
declare @@tempvno int,
@@tempvno1 int
select vno,vno1 from ledgertemp  where vtype = @inpgvptype
update ledgertemp set vno = vno + 1,vno1 = vno1 + 1 where vtype = @inpgvptype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ledgerview
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.ledgerview    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE ledgerview 
@fromdt datetime,
@todt datetime,
@partycode varchar(10)
AS
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE (VDT >=@fromdt AND
 VDT <=@todt +  "11:59 pm"  )and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lpdtlproc
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.lpdtlproc    Script Date: 20-Mar-01 11:43:34 PM ******/
/*this procedure gets  phone nos, short_name and tran_cat of client */
CREATE procedure lpdtlproc @clcode varchar(6)
 as 
select c1.Res_Phone1,Off_Phone1, c1.short_name,c2.tran_cat from 
ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 where c1.cl_code=@clcode
and c2.cl_code=@clcode
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Marginopbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Marginopbal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Marginopbal    Script Date: 04/15/2002 2:04:01 PM ******/
/****** Object:  Stored Procedure dbo.Marginopbal    Script Date: 01/04/1980 12:51:03 AM ******/
/****** Object:  Stored Procedure dbo.brOpeningBalance    Script Date: 01/28/2002 3:46:43 PM ******/
/****** Object:  Stored Procedure dbo.brOpeningBalance    Script Date: 01/24/2002 12:11:47 PM ******/
/**************************************************************************************************************************************************************************************************
THIS SP  IS USED TO FIND THE OPENING BALANCE OF A PARTICULAR A/C CODE 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Modification Done By Sheetal On 28/01/2002
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Added two new parameters viz: @flag and @costcode. 
These are used to display the bank transactions either for all the branches or for a particular branch 
Depending on the @flag value 
If @flag = 0  then show bank transaction for all the branches
If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )
***************************************************************************************************************************************************************************************************/
CREATE Procedure Marginopbal
@party_code 	varchar(10),
@sdtcur		varchar(11),
@fromdate	varchar(11),
@vdtedtflag	tinyint,
@flag 		smallint,
@costcode 	smallint
AS
Declare
@@openbaldt 	 varchar(11),
@@openentry 	 money,
@@openingbal 	 money,
@@dramt 	 money,
@@cramt 	 money,
@@opendt 	  cursor,
@@openbalcursor cursor
If @vdtedtflag = 0
begin
	/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */
	if @flag = 0 
	begin
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger l
		where vtyp = 18 and party_code = @party_code
		and vdt < = @sdtcur  
		open @@opendt
 		fetch next from @@opendt into  @@openbaldt
	
		while @@fetch_status = 0
		begin
			
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			set @@openbalcursor = cursor  for 
			select dramt = isnull((case when drcr = 'd' then sum(amount) else 0 end),0),
			cramt = isnull((case when drcr = 'c' then sum(amount) else 0 end),0)
			from marginledger where vtyp = 18 and vdt like @@openbaldt + '%'
    			and party_code = @party_code group by drcr
    			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
  
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end			
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
			
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			
			
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case drcr when 'd' then sum(amount) end),0), 
			crtotal=isnull((case drcr when 'c' then sum(amount) end),0) 
			from marginledger where vdt > = @@openbaldt 
    			and vdt < @fromdate  and vtyp <> 18 and party_code = @party_code
    			group by drcr 
			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openingbal = @@openingbal - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end
	/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/
	else if @flag = 1  
	begin	
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from marginledger l , ledger2 l2 
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno  and vtyp = 18
		 and party_code = @party_code and vdt < = @sdtcur   and costcode = @costcode
		open @@opendt
 		fetch next from @@opendt into  @@openbaldt
	
		while @@fetch_status = 0
		begin
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			set @@openbalcursor = cursor  for 
			select dramt = isnull((case when l.drcr = 'd' then sum(amount) else 0 end),0),
			cramt = isnull((case when l.drcr = 'c' then sum(amount) else 0 end),0)
			from marginledger  l , ledger2 l2
			where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno  and vtyp = 18 
			and vdt like @@openbaldt + '%'  and party_code = @party_code  and costcode = @costcode
			group by l.drcr
    			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
  
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end			
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case l.drcr when 'd' then sum(amount) end),0), 
			crtotal=isnull((case l.drcr when 'c' then sum(amount) end),0) 
			from marginledger l,ledger2 l2
			where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and vtyp <> 18 
			and vdt > = @@openbaldt   and vdt < @fromdate  and party_code = @party_code and costcode = @costcode
    			group by l.drcr 
			open @@openbalcursor
 			fetch next from @@openbalcursor into @@dramt,@@cramt
  			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openingbal = @@openingbal - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end
end
else if @vdtedtflag = 1
begin
	/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */
	if @flag = 0 
	begin
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(l.vdt),0),109),11) from marginledger l, ledger m
		where l.vtyp = 18 and l.vtyp = m.vtyp and party_code = @party_code and edt < = @sdtcur  
		open @@opendt
	 	fetch next from @@opendt into  @@openbaldt
		
		while @@fetch_status = 0
		begin
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			
			set @@openbalcursor = cursor  for 
			select 	dramt = isnull((case when l.drcr = 'd' then sum(amount) else 0 end),0),
			cramt = isnull((case when l.drcr = 'c' then sum(amount) else 0 end),0)
			from marginledger l, ledger m where l.vtyp = 18 and l.vtyp = m.vtyp and edt like @@openbaldt + '%' and l.vno = m.vno and l.lno = m.lno
	    		and party_code = @party_code group by l.drcr
	    		open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
		
			close @@openbalcursor
			deallocate @@openbalcursor
	
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case l.drcr when 'd' then sum(amount) end),0), 
			crtotal=isnull((case l.drcr when 'c' then sum(amount) end),0) 
			from marginledger l, ledger m where edt > = @@openbaldt  and edt < @fromdate  
			and l.vtyp <> 18 and l.vtyp = m.vtyp and party_code = @party_code and l.vno = m.vno and l.lno = m.lno group by l.drcr 
			open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
	  		while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin	
					select @@openingbal = @@openingbal - @@cramt
				end
				
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt 
	end 
	/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/
	else if @flag = 1  
	begin	
		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(l.vdt),0),109),11) from marginledger l ,ledger2 l2, ledger m
		where l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and l.vtyp = 18  and l.vtyp = m.vtyp
		and party_code = @party_code and edt < = @sdtcur  and costcode = @costcode
		open @@opendt
	 	fetch next from @@opendt into  @@openbaldt
		
		while @@fetch_status = 0
		begin
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0
			
			set @@openbalcursor = cursor  for 
			select dramt = isnull((case when l.drcr = 'd' then sum(amount) else 0 end),0),
			             cramt  = isnull((case when l.drcr = 'c' then sum(amount) else 0 end),0)
			from marginledger l ,ledger2 l2, ledger m
			 where l.vtyp = l2.vtype and l.vtyp = m.vtyp and l.vno = l2.vno and l.lno = l2.lno and l.vtyp = 18  
			and l.vno = m.vno and l.lno = m.lno and edt like @@openbaldt + '%' and party_code = @party_code and costcode = @costcode
			group by l.drcr
	    		open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = 0 - @@cramt
				end
			
				fetch next from @@openbalcursor into @@dramt,@@cramt	
			end
		
			close @@openbalcursor
			deallocate @@openbalcursor
	
			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			set @@openbalcursor = cursor for 
			select drtotal=isnull((case l.drcr when 'd' then sum(amount) end),0), 
			             crtotal=isnull((case l.drcr when 'c' then sum(amount) end),0) 
			from marginledger l,ledger2 l2, ledger m
			where  l.vtyp = l2.vtype and l.vno = l2.vno and l.lno = l2.lno and l.vtyp <> 18
			and  l.vno = m.vno and l.lno = m.lno and edt > = @@openbaldt  and edt < @fromdate and party_code = @party_code and costcode = @costcode
			group by l.drcr 
			open @@openbalcursor
	 		fetch next from @@openbalcursor into @@dramt,@@cramt
	  		while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal + @@dramt
				end
				if @@cramt <> 0 
				begin	
					select @@openingbal = @@openingbal - @@cramt
				end
				
				fetch next from @@openbalcursor into @@dramt,@@cramt					
			end
			select @@openingbal = @@openingbal + @@openentry
			close @@openbalcursor
			deallocate @@openbalcursor
			select @@openingbal
			fetch next from @@opendt into  @@openbaldt
		end	
		close @@opendt
		deallocate @@opendt
	end 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Marginyearend
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 03/28/2003 4:34:58 PM ******/
CREATE Procedure Marginyearend
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime
as
declare
@@cltcode  as varchar(10),
@@lno      as int,
@@rcursor  as cursor
if len(rtrim(@sdtcur)) = 10
begin
   select @sdtcur = left(@sdtcur,3) + ' ' + substring(@sdtcur,4,7)
end
if len(rtrim(@ldtcur)) = 10
begin
   select @ldtcur = left(@ldtcur,3) + ' ' + substring(@ldtcur,4,7)
end
insert into marginledger
select @vtyp, @vno, 0, (case when t.bal >= 0 then 'D' else 'C' end), @vdt, abs(t.bal), t.party_code,
t.exchange, rtrim(t.segment), 0, '', @booktype, t.mcltcode
from
(select mcltcode, exchange, segment, party_code, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)
from marginledger where vdt >= @sdtcur + ' 00:00:00' and vdt <= @ldtcur + ' 23:59:59'
group by mcltcode, exchange, segment, party_code) t
set @@rcursor = cursor for
select cltcode, lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno
order by cltcode
open @@rcursor
fetch next from @@rcursor 
into @@cltcode, @@lno
while @@fetch_status = 0
begin
   update marginledger set lno = @@lno where vtyp = @vtyp and booktype = @booktype and vno = @vno and mcltcode = @@cltcode
   fetch next from @@rcursor 
   into @@cltcode, @@lno
end
close @@rcursor
deallocate @@rcursor
/* For effective datewise Margin O/p Balances */
update marginledger set sett_no = t.bal
from
(
select mcltcode, exchange, segment, party_code, bal=sum( case when upper(m.drcr) = 'D' then amount else -amount end)
from marginledger m, ledger l
where m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno
and l.edt >= @sdtcur + ' 00:00:00' and l.edt <= @ldtcur + ' 23:59:59'
group by mcltcode, exchange, segment, party_code) t
where marginledger.mcltcode = t.mcltcode and marginledger.exchange = t.exchange and marginledger.segment=t.segment
and marginledger.party_code = t.party_code and marginledger.vtyp = 18

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mReconcile
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.mReconcile    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE  mReconcile  
@code varchar(10)
, @gmonth varchar(11)
,@gdrcr  varchar(1)
,@flag varchar(1)
,@gyear integer
,@tVamt    numeric(17,2)
AS
if @flag=1 
begin
select  isnull(sum(vamt) ,0) ,drcr from ledger 
where cltcode =    @code    and   datepart(month,vdt)   <= @gmonth   and     datepart(year ,vdt)   <= @gyear
group by drcr
order  by drcr
end
if @flag=2
begin
if @tvamt =  0  
begin
select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),
vno=l.vno, drcr=l.drcr , chequeno=isnull(ddno,''), /*refno= l.refno ,*/ amt= l.vamt 
From ledger l  ,LEDGER1 LL1 
WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code
and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno=l.lno and ll1.drcr =l.drcr
/*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)*/  and 
l.vno in
(select vno from ledger l1 where cltcode =@code   and l.vtyp=l1.vtyp)
and reldt ='1900-01-01 00:00:00.000'  and datepart(month,vdt) < =  @gmonth    and   l.drcr like  @gdrcr
and     datepart(year ,vdt)   <=@gyear
order by    convert(varchar,l.vdt,101) ,l.vtyp,l.vno,l.drcr
end
if  @tvamt <>0
begin
select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),
vno=l.vno, drcr=l.drcr , chequeno=isnull(ddno,''), /*refno= l.refno ,*/amt= l.vamt 
From ledger l  ,LEDGER1 LL1 
WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code
and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno=l.lno and ll1.drcr =l.drcr
/*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12) */ and 
l.vno in
(select vno from ledger l1 where cltcode =@code   and l.vtyp=l1.vtyp)
and reldt ='1900-01-01 00:00:00.000'  and datepart(month,vdt) < =  @gmonth    and   l.drcr like  @gdrcr
and     datepart(year ,vdt)   <=@gyear  and  vamt = @tVamt
order by   convert(varchar,l.vdt,101)  ,l.vtyp,l.vno,l.drcr
end
end
/*SUBSTRING(LL1.REFNO,1, 12)=SUBSTRING(L.REFNO,1, 12) */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MuGetCumulativeBalBill
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 8/8/01 1:37:30 PM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.MuGetCumulativeBalBill    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE  MuGetCumulativeBalBill   @tsettno  varchar(7) ,
@tsetttype as varchar(2)
AS
 select  clientdrcr  =isnull((select isnull(sum(amount),0) from ncdx.dbo.muaccbill s 
       where s.sett_no=     @tsettno      and sett_type=  @tsetttype       and sell_buy =1  
         and  party_code not in ('99990' ,'61310', '99985' ,'99988','100')) - 
     (select sum(amount) from ncdx.dbo.muaccbill s 
     where s.sett_no=      @tsettno       and sett_type= @tsetttype   and sell_buy =2
     and  party_code not in ( '99990' , '61310','99985', '99988','100')),0), 
  tenddate  = (select distinct max(end_date) from ncdx.dbo.muaccbill s 
       where s.sett_no=      @tsettno    and sett_type= @tsetttype ),  
  tpayout  =  (select max(payout_date) from ncdx.dbo.muaccbill sm 
       where sm.sett_no=         @tsettno   and sett_type=    @tsetttype   ), 
  tstartdate = (select distinct max(start_date) from ncdx.dbo.muaccbill s
       where s.sett_no=     @tsettno    and sett_type=    @tsetttype      )
  from ncdx.dbo.muaccbill s1  where s1.sett_no=     @tsettno  and s1.sett_type=  @tsetttype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MULTIBANKDETAILS
-- --------------------------------------------------


CREATE PROC MULTIBANKDETAILS ( @PARTY_CODE VARCHAR(15))
AS 

 --SET @PARTY_CODE ='RP61'

SELECT BANK_NAME,BRANCH_NAME,ACCNO,ID_STATUS,CONVERT(VARCHAR(11),MODIFY_DATE,120) AS MODIFY_DATE,EXCHANGE  FROM 
(
SELECT BANKID,ACCNO,DEFAULTBANK,'' AS ID_STATUS,'' MODIFY_DATE,'NSE' AS EXCHANGE FROM MULTIBANKID WHERE CLTCODE = @PARTY_CODE
UNION ALL
SELECT BANKID,ACCNO,DEFAULTBANK,Action,Action_ModifiedDate,'NSE' AS EXCHANGE FROM MULTIBANKID_AUDIT WHERE CLTCODE = @PARTY_CODE
)A
LEFT OUTER JOIN 
MSAJAG.DBO.POBANK AS B
ON A.BANKID =B.BANKID
ORDER BY ID_STATUS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newacc_trialbalance
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.newacc_trialbalance    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.newacc_trialbalance    Script Date: 02/18/2003 10:24:12 AM ******/
/****** Object:  Stored Procedure dbo.newacc_trialbalance    Script Date: 12/04/2002 2:00:20 PM ******/
CREATE PROCEDURE  newacc_trialbalance
/* report : trial balance        
Prints trial balance */
@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3),         /* Whether report is based on VDT or EDT */
@Fromamt    money,              /* From amount entered by user */
@Toamt      money,              /* To amount entered by user */
@Fromac     varchar(35),        /* From Account/Name entered by user */
@Toac       varchar(35)         /* To Account/Name entered by user */
AS
declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@addwhere    as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3),
@@whereac     as varchar(500)
if @statusid = 'Broker'
begin
	select @@Groupby    = " group by l.Cltcode , l.acname, branchcode"
end
else
begin
	select @@Groupby    = " group by l2.Cltcode , a.acname, branchcode"
end
if @statusid = 'Broker'
begin
   if @flag = 'codewise'
      begin
	   select @@sortby = " order by  l.Cltcode , l.acname, branchcode"
      end
   else
      begin
	   select @@sortby = " order by  l.acname, l.Cltcode, branchcode"
   end
end
else
begin
   if @flag = 'codewise'
      begin
	   select @@sortby = " order by  l2.Cltcode , a.acname, branchcode"
      end
   else
      begin
	   select @@sortby = " order by  a.acname, l2.Cltcode, branchcode"
   end
end
if @viewoption = 'Partywise'  /* Only Party accounts to be displayed */
begin
   select @@addwhere  = " and a.accat = 4 " 
end
else if @viewoption = 'GL'  /* Only Party accounts to be displayed */
     begin
        select @@addwhere  = " and a.accat <> 4 " 
     end
     else
     begin
        select @@addwhere  = " " 
     end
if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
else if @statusid = 'branch'
begin
   select @@costcode = (select costcode from costmast c, category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
    select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
if len(rtrim(@Fromac)) <> 0 
begin
   if len(rtrim(@Toac)) <> 0  
       begin
          if @flag = 'codewise' 
             select @@addwhere = @@addwhere + " and l.cltcode >= '" + @Fromac + "' and l.cltcode <= '" + @Toac + "' "
          else
             select @@addwhere = @@addwhere + " and l.acname >= '" + @Fromac + "' and l.acname <= '" + @Toac + "' "
       end
    else
       begin
          if @flag = 'codewise' 
             select @@addwhere = @@addwhere + " and l.cltcode >= '" + @Fromac + "' "
          else
             select @@addwhere = @@addwhere + " and l.acname >= '" + @Fromac + "' "
       end
end
else
begin
   if len(rtrim(@Toac)) <> 0  
       begin
          if @flag = 'codewise' 
             select @@addwhere = @@addwhere + " and l.cltcode <= '" + @Toac + "' "
          else
             select @@addwhere = @@addwhere + " and l.acname <= '" + @Toac + "' "
       end
end
/*  -- FOR BROKER --  */
/* ------------------ */
if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = insull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
/*--- If user wants to see Trial balance With Opening Balances ---*/
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = isnull(sum(case when upper(drcr) = 'D' then vamt else 0 end),0), crtot = sum(case when upper(drcr) = 'C' then vamt else 0 end),opbal = 0 "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
       select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when drcr = 'd' then vamt else -vamt end) else 0 end) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end    /* End og Statusid = 'Broker'  */
/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */
if @statusid = 'Branch'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = " select l2.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(l2.drcr) = 'D' then camt else -camt end)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = " select l2.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(l2.drcr) = 'D' then camt else -camt end)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = " select l2.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(l2.drcr) = 'D' then camt else -camt end)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when upper(l2.drcr) = 'D' then camt else 0 end), crtot = sum(case when upper(l2.drcr) = 'C' then camt else 0 end),opbal = 0 "
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vtyp = 18 then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end)"
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end) "
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end /* End of Branch login or Branch selection from Broker login */
print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby  
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newacc_trialbalancepartytotal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.newacc_trialbalancepartytotal    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.newacc_trialbalancepartytotal    Script Date: 02/18/2003 10:24:12 AM ******/
/****** Object:  Stored Procedure dbo.newacc_trialbalancepartytotal    Script Date: 12/04/2002 2:00:20 PM ******/
CREATE PROCEDURE  newacc_trialbalancepartytotal
/* report : trial balance        
Prints trial balance */
@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3),         /* Whether report is based on VDT or EDT */
@Fromamt    money,              /* From amount entered by user */
@Toamt      money,              /* To amount entered by user */
@Fromac     varchar(35),        /* From Account/Name entered by user */
@Toac       varchar(35)         /* To Account/Name entered by user */
AS
declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@addwhere    as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3),
@@whereac     as varchar(500)
select @@Groupby = " "
select @@sortby  = " "
select @@addwhere  = " and a.accat = 4 " 
if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
else if @statusid = 'branch'
begin
   select @@costcode = (select costcode from costmast c, category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
    select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
if len(rtrim(@Fromac)) <> 0 
begin
   if len(rtrim(@Toac)) <> 0  
       begin
          if @flag = 'codewise' 
             select @@addwhere = @@addwhere + " and l.cltcode >= '" + @Fromac + "' and l.cltcode <= '" + @Toac + "' "
          else
             select @@addwhere = @@addwhere + " and l.acname >= '" + @Fromac + "' and l.acname <= '" + @Toac + "' "
       end
    else
       begin
          if @flag = 'codewise' 
             select @@addwhere = @@addwhere + " and l.cltcode >= '" + @Fromac + "' "
          else
             select @@addwhere = @@addwhere + " and l.acname >= '" + @Fromac + "' "
       end
end
else
begin
   if len(rtrim(@Toac)) <> 0  
       begin
          if @flag = 'codewise' 
             select @@addwhere = @@addwhere + " and l.cltcode <= '" + @Toac + "' "
          else
             select @@addwhere = @@addwhere + " and l.acname <= '" + @Toac + "' "
       end
end
/*  -- FOR BROKER --  */
/* ------------------ */
if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select Amount = sum(case when drcr = 'd' then vamt else -vamt end)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = "select Amount = sum(case when drcr = 'd' then vamt else -vamt end)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select Amount = sum(case when drcr = 'd' then vamt else -vamt end)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
/*--- If user wants to see Trial balance With Opening Balances ---*/
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = sum(case when drcr = 'd' then vamt else 0 end), crtot = sum(case when drcr = 'c' then vamt else 0 end),opbal = 0 "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when drcr = 'd' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and
 vdt >= '" + @stdate + "' then ( case when drcr = 'c' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when drcr = 'd' then vamt else -vamt end) else 0 end) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when drcr = 'd' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and
 vdt >= '" + @stdate + "' then ( case when drcr = 'c' then vamt else 0 end) else 0 end), opbal = sum(case when vtyp = 18 then ( case when drcr = 'd' then vamt else -vamt end) else 0 end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when drcr = 'd' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and 
vdt >= '" + @stdate + "' then ( case when drcr = 'c' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when drcr = 'd' then vamt else -vamt end) else 0 end) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when drcr = 'd' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >
= '" + @stdate + "' then ( case when drcr = 'c' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when drcr = 'd' then vamt else -vamt end) else 0 end) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end    /* End og Statusid = 'Broker'  */
/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */
if @statusid = 'Branch'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = " select Amount = sum(case when l2.drcr = 'd' then camt else -camt end)"
      select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = " select Amount = sum(case when l2.drcr = 'd' then camt else -camt end)"
      select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = " select Amount = sum(case when l2.drcr = 'd' then camt else -camt end)"
      select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = sum(case when l2.drcr = 'd' then camt else 0 end), crtot = sum(case when l2.drcr = 'c' then camt else 0 end),opbal = 0 "
            select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <
> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'c' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else -camt end) else 0 end) "
           select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp
 <> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'c' then camt else 0 end) else 0 end), opbal = sum(case when l.vtyp = 18 then ( case when l2.drcr = 'd' then camt else -camt end) else 0 end)"
            select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <
> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'c' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else -camt end) else 0 end) "
           select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 
and l.vdt >= '" + @stdate + "' then ( case when drcr = 'c' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when l2.drcr = 'd' then camt else -camt end) else 0 end) "
      select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end /* End of Branch login or Branch selection from Broker login */
print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby  
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NewAcMultiInsert
-- --------------------------------------------------
CREATE Procedure [dbo].[Newacmultiinsert]          
@Vtyp Smallint,               
@Booktype Char(2),               
@Vno Varchar(12),               
@Lno Int,               
@Vdt Varchar(11),               
@Edt Varchar(11),               
@Cltcode Varchar(10),               
@Drcr Char(1),                
@Vamt Money,               
@Enteredby Varchar(25),               
@Cdt Datetime, /*varchar(30), */              
@Checkedby Varchar(25),               
@Pdt Datetime, /*varchar(30), */              
@Acname Varchar(50),               
@Narration Varchar(234),               
@Chequeinname Varchar(50),               
@Chqprinted Tinyint,               
@Accat Int,               
@Bnkname Varchar(50),               
@Brnname Varchar(30),               
@Dd Char(1),               
@Ddno Varchar(15),               
@Dddt Datetime,               
@Reldt Datetime,               
@Relamt Money,               
@Micrno Int,               
@Sessionid Int,               
@Branchname Char(10),               
@Costflag Varchar(1),               
@Costrowid Int,               
@Clearingmode Char(1),               
@Emode Char(1)              
/*slipno, , Chequeinname, Chqprinted*/              
As              
Declare              
@@Vno1 As Varchar(12),               
@@Refno Char(12),               
@@Nodays Int,               
@@Actnodays Int,               
@@Balamt Money,               
@@Slipno Smallint,               
@@Slipdate Datetime,               
@@Clearingmode Char(2),               
@@Receiptno Int,               
@@Branch As Char(15),               
@@Exchange As Varchar(3),               
@@Segment As Varchar(10),               
@@Sett_no As Varchar(7),               
@@Sett_type As Varchar(3),               
@@Party_code As Varchar(10),               
@@Vdt1 As Datetime,               
@@Edt1 As Datetime,               
@@Dddt1 As Datetime,               
@@Reldt1 As Datetime,               
@@Recordcount As Int              
Select @@Vdt1 = Convert(Datetime, @Vdt+' '+convert(Varchar, Getdate(), 114))              
Select @@Edt1 = Convert(Datetime, @Edt+' '+convert(Varchar, Getdate(), 114))              
Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))              
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */              
Select @@Reldt1 = @Reldt              
Select @@Vno1 = @Vno              
Select @@Refno = ''              
Select @@Nodays = 0              
Select @@Actnodays  = 0              
Select @@Balamt = 0              
Select @@Slipno = 0              
Select @@Slipdate = ''              
/*select @@Clearingmode = ' ' */              
Select @@Receiptno = 0              
Select @@Branch =  'Branch'              
/* Inserting Record In Ledger */              
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,               
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)               
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, @@Refno, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,               
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger3 */              
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
/* Inserting Common Narration In Ledger3 */              
If @Lno = 2               
Begin              
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values              
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)              
End               
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/              
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20               
Begin            
  
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)              
      Begin              
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2              
      Begin    
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
     End               
      End               
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)              
        Begin              
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2              
               
   Begin              
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
                  End               
     End              
    Else If @Vtyp = 5              
        Begin              
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)              
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)              
   If @Accat = 2 And @Drcr = 'C'              
   Begin              
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)              
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)              
   End              
        End              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* Inserting Records In Matchdetails And Updating Billmatch */              
If @Lno = 2               
Begin              
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)              
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T              
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)               
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype               
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno              
        Insert Into Matchdetails              
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype              
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)               
End              
/* Insertting Records In Margin Ledger */              
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)              
Begin              
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)              
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))              
End              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'                
Begin              
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)                 
 Declare Cur_ledger_insert Cursor For                 
        Select Count(Party_code), Party_code From Templedger2 Where                 
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And               
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code              
                
        Open Cur_ledger_insert                
                
        Fetch Next From Cur_ledger_insert               
        Into @Recordcounter, @Partycode              
While @@Fetch_status = 0                
Begin               
--if  @Partycode <> @Cltcode              
If @Recordcounter = 1              
 Begin              
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                
End              
/* Else              
 Begin              
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid               
 End*/              
Fetch Next From Cur_ledger_insert                 
                 
End                
                
Close Cur_ledger_insert                
Deallocate Cur_ledger_insert                
End               
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/              
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'              
/*select @@Recordcount = Count(Party_code) From Templedger2 Where               
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt              
If @@Recordcount = 0              
Begin*/              
Begin              
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )              
End              
--end              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NewAcMultiInsert_01112011
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 12/16/2003 12:45:40 PM ******/          
          
          
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 02/18/2003 10:25:06 AM ******/          
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 01/27/2003 9:52:25 PM ******/          
          
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 01/24/2003 8:55:03 PM ******/          
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 12/27/2002 4:39:13 PM ******/          
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 12/04/2002 1:48:26 PM ******/          
CREATE PROCEDURE NewAcMultiInsert_01112011          
@vtyp smallint,          
@BookType char(2),          
@vno varchar(12),          
@lno int,          
@vdt varchar(11),          
@edt varchar(11),          
@cltcode varchar(10),          
@drcr char(1),            
@vamt money,          
@EnteredBy varchar(25),           
@cdt datetime, /*varchar(30), */          
@CheckedBy varchar(25),          
@pdt datetime, /*varchar(30),*/          
@acname varchar(50),          
@Narration varchar(234),          
@ChequeInName varchar(50),          
@ChqPrinted tinyint,          
@accat int,          
@bnkname varchar(50),          
@brnname varchar(30),          
@dd char(1),          
@ddno varchar(15),          
@dddt datetime,          
@reldt datetime,          
@relamt money,          
@micrno int,          
@sessionid int,          
@branchname char(10),          
@costflag varchar(1),          
@costrowid int,           
@clearingmode char(1),          
@emode char(1)          
          
          
/*SlipNo,,ChequeInName,ChqPrinted*/          
AS          
          
set transaction isolation level read uncommitted      
      
declare          
@@vno1 as varchar(12),          
@@refno char(12),          
@@NoDays int,          
@@actnodays int,          
@@balamt money,          
@@SlipNo smallint,          
@@Slipdate datetime,          
@@clearingmode char(2),          
@@receiptno int,          
@@branch as char(15),          
@@exchange as varchar(3),          
@@segment as varchar(10),          
@@sett_no as varchar(7),          
@@sett_type as varchar(3),          
@@party_code as varchar(10),          
@@vdt1 as datetime,          
@@edt1 as datetime,          
@@dddt1 as datetime,          
@@reldt1 as datetime          
          
select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))          
select @@edt1 = convert(datetime,@edt+' '+convert(varchar,getdate(),114))          
select @@dddt1 = convert(datetime,substring(convert(varchar,@dddt,109),1,11)+' '+convert(varchar,getdate(),114))          
/* select @@reldt1 = convert(datetime,substring(convert(varchar,@reldt,109),1,11)+' 00:00:00' */          
select @@reldt1 = @reldt          
          
select @@vno1 = @vno          
select @@refno = ''          
select @@nodays = 0          
select @@actnodays  = 0          
select @@balamt = 0          
select @@slipno = 0          
select @@slipdate =''          
/*select @@clearingmode =' ' */          
select @@receiptno = 0          
select @@branch =  'BRANCH'          
          
/* Inserting record in ledger */          
          
Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,EnteredBy,lno,balamt,          
Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)           
values (@vtyp,@vno,@drcr,@vamt,@@vdt1,@@refno,upper(@cltcode),@EnteredBy,@lno,@@balamt,          
@@Vno1,@booktype,@@edt1,@cdt,@pdt,@@NoDays,@@actnodays,@CheckedBy,@acname,@narration)          
          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
          
/* Inserting record in ledger3 */          
          
Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType) values          
(@lno,@narration,@@refno,@vtyp,@vno,@BookType)          
          
/* Inserting Common Narration in Ledger3 */          
if @lno =2           
begin          
       Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType) values          
       (0,@narration,@@refno,@vtyp,@vno,@BookType)       
end           
          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
          
/* Inserting record in ledger1 in case of Bank related vouchers*/          
          
if @vtyp= 2 or @vtyp= 3 or @vtyp=5 or @vtyp= 16 or @vtyp=17  or @vtyp= 19 or @vtyp=20           
begin          
   if (@vtyp = 2 or @vtyp = 19 or @vtyp=16)          
      begin          
 if   ( @drcr = 'c' or @drcr = 'C' ) and @lno = 2          
      begin             
             insert into  ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)          
     values (@lno,@bnkname,substring(@brnname,1,20),@dd,rtrim(@ddno),@@dddt1,@relamt,@vtyp,@vno,@BookType,@@refno,@reldt,@micrno, @@slipno,@@slipdate,@clearingmode,@ChequeInName,@ChqPrinted,@@receiptno,@drcr)          
     end           
      end           
    else if (@vtyp = 3 or @vtyp = 20 or @vtyp = 17)          
        begin          
   if  ( @drcr = 'd' or @drcr = 'D' ) and @lno = 2          
           
   begin          
        insert into ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)          
            values (@lno,@bnkname,substring(@brnname,1,20),@dd,rtrim(@ddno),@@dddt1,@relamt,@vtyp,@vno,@BookType,@@refno,@reldt,@micrno, @@slipno,@@slipdate,@clearingmode,@ChequeInName,@ChqPrinted,@@receiptno,@drcr)          
      insert into payadv(cltcode,acname,vdt,Amt,ChequeNo,ChequeInName,Narration,PrintedFlag,actamt,shortage,vtyp,vno,booktype)          
            values (upper(@cltcode),@acname,@@vdt1,@relamt,rtrim(@ddno),@ChequeInName,@narration,0,@vamt,0,@vtyp,@vno,@BookType)          
                  end           
     end          
          
    else if @vtyp = 5          
        begin          
             insert into  ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)          
         values (@lno,@bnkname,substring(@brnname,1,20),@dd,rtrim(@ddno),@@dddt1,@relamt,@vtyp,@vno,@BookType,@@refno,@@reldt1,@micrno, @@slipno,@@slipdate,@clearingmode,@ChequeInName,@ChqPrinted,@@receiptno,@drcr)          
   if @accat = 2 and @drcr = 'c'          
   begin          
           insert into payadv(cltcode,acname,vdt,Amt,ChequeNo,ChequeInName,Narration,PrintedFlag,actamt,shortage,vtyp,vno,booktype)          
            values (upper(@cltcode),@acname,@@vdt1,@relamt,rtrim(@ddno),@ChequeInName,@narration,0,@vamt,0,@vtyp,@vno,@BookType)          
   end          
        end          
          
end          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
          
/* Inserting records in Matchdetails and Updating Billmatch */          
          
if @lno =2           
begin          
      delete  from tempbilldetails where payamount = 0 and rtrim(sessionid) = rtrim(@sessionid)          
          
       update billmatch set billmatch.balamt = billmatch.balamt - payamount from tempbilldetails t          
        where  rtrim(t.sessionid) = rtrim(@sessionid)           
        and t.party_code = billmatch.party_code and t.billvtype = billmatch.vtype and t.billbooktype=billmatch.booktype           
        and t.billvno = billmatch.vno and t.billlno = billmatch.lno          
          
        insert into matchdetails          
        select description, upper(Party_code), billvtype, billvno, billlno, billbooktype, drcr, payamount, vtype, @vno, @lno, booktype          
        from tempbilldetails where  rtrim(sessionid) = rtrim(@sessionid)           
end          
          
/* Insertting records in Margin ledger */          
if @accat = 14 and (@vtyp= 19 or @vtyp= 20 or @vtyp= 22 or @vtyp= 23 or @vtyp= 24)          
begin          
   Insert into marginledger(vtyp,vno,lno,drcr,vdt,Amount,Party_code,Exchange,Segment,Sett_no,Sett_type,BookType,MCltcode)          
   values (@vtyp,@vno,@lno,@drcr,@@vdt1,@vamt,upper(@@party_code),@@exchange,@@segment,0,@@sett_type,@booktype,upper(@cltcode))          
end          
          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
          
if @vtyp='8' and upper(@emode) = 'M'            
begin          
DECLARE @RecordCounter smallint             
DECLARE @PartyCode varchar(50)             
          
 DECLARE CUR_LEDGER_INSERT CURSOR FOR             
        select count(party_code), party_code from templedger2 where             
        vtype = @vtyp and vno = @vno and lno = @lno and drcr = @drcr and           
 booktype = @booktype and sessionid = @sessionid and party_code = @cltcode and costflag = 'A'  group by party_code          
            
        OPEN CUR_LEDGER_INSERT            
            
        FETCH NEXT FROM CUR_LEDGER_INSERT           
        INTO @RecordCounter, @partyCode          
          
WHILE @@FETCH_STATUS = 0            
BEGIN           
          
--if  @partyCode <> @cltcode          
if @RecordCounter = 1          
 begin          delete from templedger2 where vtype = @vtyp and vno = @vno and lno = @lno and drcr = @drcr and booktype = @booktype and sessionid = @sessionid           
 --       insert into templedger2 values (@@branch,@branchname,@vamt,@vtyp,@vno,@lno,@drcr,'0',@booktype,@sessionid,upper(@cltcode),'A',0 )            
 end          
/* else          
 begin          
  update templedger2 set paidamt=@vamt where vtype = @vtyp and vno = @vno and lno = @lno and drcr = @drcr and booktype = @booktype and sessionid = @sessionid           
 end*/          
          
          
FETCH NEXT FROM CUR_LEDGER_INSERT             
             
END            
            
CLOSE CUR_LEDGER_INSERT            
DEALLOCATE CUR_LEDGER_INSERT            
          
end           
/*else          
begin*/          
          
          
if upper(@emode) = 'A' or upper(@emode) = 'M'          
begin           
 insert into templedger2 values ( @@branch,@branchname,@vamt,@vtyp,@vno,@lno,@drcr,'0',@booktype,@sessionid,upper(@cltcode),'A',0 )          
end          
          
--end          
          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NewAcMultiInsert_OLD
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 1/17/2004 11:39:08 PM ******/      
      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 03/29/2003 1:01:58 PM ******/      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 03/05/2003 4:52:51 PM ******/      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 02/18/2003 10:37:39 AM ******/      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 01/27/2003 9:52:25 PM ******/      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 01/24/2003 8:55:03 PM ******/      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 12/27/2002 4:39:13 PM ******/      
/****** Object:  Stored Procedure dbo.NewAcMultiInsert    Script Date: 12/04/2002 1:48:26 PM ******/      
CREATE    PROCEDURE NewAcMultiInsert_OLD
@vtyp smallint,      
@BookType char(2),      
@vno varchar(12),      
@lno int,      
@vdt varchar(11),      
@edt varchar(11),      
@cltcode varchar(10),      
@drcr char(1),        
@vamt money,      
@EnteredBy varchar(25),       
@cdt datetime, /*varchar(30), */      
@CheckedBy varchar(25),      
@pdt datetime, /*varchar(30),*/      
@acname varchar(50),      
@Narration varchar(234),      
@ChequeInName varchar(50),      
@ChqPrinted tinyint,      
@accat int,      
@bnkname varchar(50),      
@brnname varchar(30),      
@dd char(1),      
@ddno int,      
@dddt datetime,      
@reldt datetime,      
@relamt money,      
@micrno int,      
@sessionid int,      
@branchname char(10),      
@costflag varchar(1),      
@costrowid int,       
@clearingmode char(1),      
@emode char(1)      
/*SlipNo,,ChequeInName,ChqPrinted*/      
AS      
declare      
@@vno1 as varchar(12),      
@@refno char(12),      
@@NoDays int,      
@@actnodays int,      
@@balamt money,      
@@SlipNo smallint,      
@@Slipdate datetime,      
@@clearingmode char(2),      
@@receiptno int,      
@@branch as char(15),      
@@exchange as varchar(3),      
@@segment as varchar(10),      
@@sett_no as varchar(10),      
@@sett_type as varchar(3),      
@@party_code as varchar(10),      
@@vdt1 as datetime,      
@@edt1 as datetime,      
@@dddt1 as datetime,      
@@reldt1 as datetime      
select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))      
select @@edt1 = convert(datetime,@edt+' '+convert(varchar,getdate(),114))      
select @@dddt1 = convert(datetime,substring(convert(varchar,@dddt,109),1,11)+' '+convert(varchar,getdate(),114))      
/* select @@reldt1 = convert(datetime,substring(convert(varchar,@reldt,109),1,11)+' 00:00:00' */      
select @@reldt1 = @reldt      
select @@vno1 = @vno      
select @@refno = ''      
select @@nodays = 0      
select @@actnodays  = 0      
select @@balamt = 0      
select @@slipno = 0      
select @@slipdate =''      
/*select @@clearingmode =' ' */      
select @@receiptno = 0      
select @@branch =  'BRANCH'      
/* Inserting record in ledger */      
Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,EnteredBy,lno,balamt,      
Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)       
values (@vtyp,@vno,@drcr,@vamt,@@vdt1,@@refno,upper(@cltcode),@EnteredBy,@lno,@@balamt,      
@@Vno1,@booktype,@@edt1,@cdt,@pdt,@@NoDays,@@actnodays,@CheckedBy,@acname,@narration)      
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */      
/* Inserting record in ledger3 */      
Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType) values      
(@lno,@narration,@@refno,@vtyp,@vno,@BookType)      
/* Inserting Common Narration in Ledger3 */      
if @lno =2       
begin      
       Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType) values      
       (0,@narration,@@refno,@vtyp,@vno,@BookType)      
end       
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */      
/* Inserting record in ledger1 in case of Bank related vouchers*/      
if @vtyp= 2 or @vtyp= 3 or @vtyp=5 or @vtyp= 16 or @vtyp=17  or @vtyp= 19 or @vtyp=20       
begin      
   if (@vtyp = 2 or @vtyp = 19 or @vtyp=16)      
      begin      
 if   ( @drcr = 'c' or @drcr = 'C' ) and @lno = 2      
      begin      
        
             insert into  ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)      
            values (@lno,@bnkname,substring(@brnname,1,20),@dd,rtrim(@ddno),@@dddt1,@relamt,@vtyp,@vno,@BookType,@@refno,@reldt,@micrno, @@slipno,@@slipdate,@clearingmode,@ChequeInName,@ChqPrinted,@@receiptno,@drcr)      
     end       
      end       
    else if (@vtyp = 3 or @vtyp = 20 or @vtyp = 17)      
        begin      
   if  ( @drcr = 'd' or @drcr = 'D' ) and @lno = 2      
       
   begin      
        insert into ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)      
            values (@lno,@bnkname,substring(@brnname,1,20),@dd,rtrim(@ddno),@@dddt1,@relamt,@vtyp,@vno,@BookType,@@refno,@reldt,@micrno, @@slipno,@@slipdate,@clearingmode,@ChequeInName,@ChqPrinted,@@receiptno,@drcr)      
      insert into payadv(cltcode,acname,vdt,Amt,ChequeNo,ChequeInName,Narration,PrintedFlag,actamt,shortage,vtyp,vno,booktype)      
            values (upper(@cltcode),@acname,@@vdt1,@relamt,rtrim(@ddno),@ChequeInName,@narration,0,@vamt,0,@vtyp,@vno,@BookType)      
                  end       
     end      
    else if @vtyp = 5      
        begin      
             insert into  ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)      
         values (@lno,@bnkname,substring(@brnname,1,20),@dd,rtrim(@ddno),@@dddt1,@relamt,@vtyp,@vno,@BookType,@@refno,@@reldt1,@micrno, @@slipno,@@slipdate,@clearingmode,@ChequeInName,@ChqPrinted,@@receiptno,@drcr)      
   if @accat = 2 and @drcr = 'c'      
   begin      
           insert into payadv(cltcode,acname,vdt,Amt,ChequeNo,ChequeInName,Narration,PrintedFlag,actamt,shortage,vtyp,vno,booktype)      
            values (upper(@cltcode),@acname,@@vdt1,@relamt,rtrim(@ddno),@ChequeInName,@narration,0,@vamt,0,@vtyp,@vno,@BookType)      
   end      
        end      
end      
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */      
/* Inserting records in Matchdetails and Updating Billmatch */      
if @lno =2       
begin      
      delete  from tempbilldetails where payamount = 0 and rtrim(sessionid) = rtrim(@sessionid)      
       update billmatch set billmatch.balamt = billmatch.balamt - payamount from tempbilldetails t      
        where  rtrim(t.sessionid) = rtrim(@sessionid)       
        and t.party_code = billmatch.party_code and t.billvtype = billmatch.vtype and t.billbooktype=billmatch.booktype       
        and t.billvno = billmatch.vno and t.billlno = billmatch.lno      
        insert into matchdetails      
        select description, upper(Party_code), billvtype, billvno, billlno, billbooktype, drcr, payamount, vtype, @vno, @lno, booktype      
        from tempbilldetails where  rtrim(sessionid) = rtrim(@sessionid)       
end      
/* Insertting records in Margin ledger */      
if @accat = 14 and (@vtyp= 19 or @vtyp= 20 or @vtyp= 22 or @vtyp= 23 or @vtyp= 24)      
begin      
   Insert into marginledger(vtyp,vno,lno,drcr,vdt,Amount,Party_code,Exchange,Segment,Sett_no,Sett_type,BookType,MCltcode)      
   values (@vtyp,@vno,@lno,@drcr,@@vdt1,@vamt,upper(@@party_code),@@exchange,@@segment,0,@@sett_type,@booktype,upper(@cltcode))      
end      
    
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */      
/* Inserting record in templedger2 for Branch wise breakup when Brnachflag = 1 and Match_ctoc = 1 in parameter for selected year*/      
if upper(@emode) = 'A'  or upper(@emode) = 'M'  
begin       
 insert into templedger2 values ( @@branch,@branchname,@vamt,@vtyp,@vno,@lno,@drcr,'0',@booktype,@sessionid,upper(@cltcode),'A',0 )      
end      
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newasp_trialbalance
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.newasp_trialbalance    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.newasp_trialbalance    Script Date: 04/07/2003 7:10:42 PM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalance    Script Date: 02/18/2003 10:24:12 AM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalance    Script Date: 12/04/2002 2:04:36 PM ******/
CREATE PROCEDURE  newasp_trialbalance
@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3)          /* Whether report is based on VDT or EDT */
AS
declare
@@selectqury  as varchar(2000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@addwhere    as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3)
if upper(@statusid) = 'BROKER'
begin
	select @@Groupby    = " group by l.Cltcode , l.acname, branchcode"
end
else
begin
	select @@Groupby    = " group by l2.Cltcode , a.acname, branchcode"
end
if upper(@statusid) = 'BROKER'
begin
	if @flag = 'codewise'
	begin
	   select @@sortby = " order by  l.Cltcode, l.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  l.acname, l.Cltcode, branchcode"
	end
end
else
begin
	if @flag = 'codewise'
	begin
	   select @@sortby = " order by  l2.Cltcode, a.acname, branchcode"
	end
	else	
	begin	
	   select @@sortby = " order by  a.acname, l2.Cltcode, branchcode"
	end
end
if @viewoption = 'Partywise'  /* Only Party accounts to be displayed */
begin
   select @@addwhere  = " and a.accat = 4 " 
end
else if @viewoption = 'GL'  /* Only Party accounts to be displayed */
     begin
        select @@addwhere  = " and a.accat <> 4 " 
     end
     else
     begin
        select @@addwhere  = " " 
     end
if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
else if @statusid = 'branch'
begin
   select @@costcode = (select costcode from costmast c, category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
/*  -- FOR BROKER --  */
/* ------------------ */
if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
/*            select @@selectqury = " select cltcode, acname, branchcode, amount=sum(amount) from "
            select @@selectqury = @@selectqury + "(select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + " and l.vtyp = 18 " + @@groupby
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2  + @@addwhere + " AND l.vtyp <> 18" + @@groupby  +") l"
            select @@fromtables = " "  
            select @@wherepart  = " "
*/
            select @@selectqury = " select cltcode, acname, branchcode, amount=sum(amount) from "
            select @@selectqury = @@selectqury + "(select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + " and l.vtyp = 18 " + @@groupby
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2  + @@addwhere + " AND l.vtyp <> 18" + @@groupby  +") l"
            select @@fromtables = " "  
            select @@wherepart  = " "
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
         end
      else
         begin
            select @@selectqury = " select cltcode, acname, branchcode, amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart3 + @@addwhere + " and l.vtyp <> 18 " + @@groupby 
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + @@groupby + ") l"
            select @@fromtables = " "
            select @@wherepart  = " "
/*             select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
*/
         end
   end
end
/*--- If user wants to see Trial balance With Opening Balances ---*/
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when upper(drcr) = 'D' then vamt else 0 end), crtot = sum(case when upper(drcr) = 'C' then vamt else 0 end),opbal = 0 "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
          if @sortbydate = 'vdt'
             begin
                select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end)"
                select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                select @@wherepart  = @@wherepart2 + @@addwhere
             end
          else
             begin
/*                select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end)"
                select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                select @@wherepart  = @@wherepart2 + @@addwhere
*/
                select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vtyp = 18 then balamt else 0 end)"
                select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                select @@wherepart  = @@wherepart2 + @@addwhere
             end
         end
      else
         begin
           select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select l.cltcode , acname=isnull(l.acname,''), branchcode, drtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end), crtot = sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end), opbal = sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end) "
      select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end    /* End og Statusid = 'Broker'  */
/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */
if @statusid = 'Branch'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = " select l2.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(l2.drcr) = 'D' then camt else -camt end)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = " select l2.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(l2.drcr) = 'D' then camt else -camt end)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = " select l2.cltcode , acname=isnull(a.acname,''), branchcode, Amount = sum(case when upper(l2.drcr) = 'D' then camt else -camt end)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when upper(l2.drcr) = 'D' then camt else 0 end), crtot = sum(case when upper(l2.drcr) = 'C' then camt else 0 end),opbal = 0 "
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end) "
           select @@fromtables = " from ledger2 l2, ledger l left outer join acmast a on l.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vtyp = 18 then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end)"
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select l2.cltcode , acname=isnull(a.acname,''), branchcode, drtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end), crtot = sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end), opbal = sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end) "
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end /* End of Branch login or Branch selection from Broker login */
print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby 
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newasp_trialbalancepartytotal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/07/2003 7:10:42 PM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 04/07/2003 6:37:53 PM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 02/18/2003 10:24:12 AM ******/
/****** Object:  Stored Procedure dbo.newasp_trialbalancepartytotal    Script Date: 12/04/2002 2:04:37 PM ******/
CREATE PROCEDURE  newasp_trialbalancepartytotal 
/* report : consolidated trial balance        
file : trialbal.asp
displays consolidated trial balance */
@vdt varchar(11),               /* As on date entered by user */
@flag varchar(15),              /* sort order for report - Codewise or Namewise */
@viewoption varchar(10),        /* options for accounts selection - ALL, GL, PARTY */
@balance varchar(10),           /* Normal or Withopbal */
@stdate varchar(11),            /* Start date entered by user */
@curryrstdate varchar(11),	/* start date of financial year */
@openentryflag int,
@openingentrydate varchar(11),  /* O/p entry date ( vtyp = 18 ) fround from ledger for vdt <= last date entered by user */
@statusid varchar(20),          /* As Broker/Branch/Client etc. */
@statusname varchar(20),        /* In case of Branch login branchcode */
@sortbydate varchar(3)          /* Whether report is based on VDT or EDT */
AS
declare
@@selectqury  as varchar(8000),
@@fromtables  as varchar(2000),
@@wherepart   as varchar(1000),
@@wherepart1  as varchar(500),
@@wherepart2  as varchar(500),
@@wherepart3  as varchar(500),
@@addwhere    as varchar(200),
@@Groupby     as varchar(200),
@@sortby      as varchar(200),
@@costcode    as varchar(3)
/*
select @@Groupby = " group by l.drcr "
select @@sortby  = " order by  l.drcr "
*/
select @@Groupby = " "
select @@sortby  = " "
select @@addwhere  = " and a.accat = 4 " 
if @statusid = 'Broker'
begin
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
else if @statusid = 'branch'
begin
   select @@costcode = (select costcode from .costmast c, .category c2 where c2.category = 'BRANCH' and c.catcode = c2.catcode and costname = @statusname )
   if @sortbydate = 'vdt'
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @curryrstdate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
      select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and vdt >= '" + @openingentrydate + " 00:00:00' and vdt <= '" + @vdt + " 23:59:59'" 
   end
   else
   begin
      select @@wherepart1 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt <= '" + @vdt + " 23:59:59' " 
      select @@wherepart2 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @curryrstdate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
    select @@wherepart3 = " where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno and costcode = '" + @@costcode + "' and edt >= '" + @openingentrydate + " 00:00:00' and edt <= '" + @vdt + " 23:59:59'" 
   end
end
/*  -- FOR BROKER --  */
/* ------------------ */
if @statusid = 'Broker'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
      select @@fromtables = " from ledger l left outer join .acmast a on l.cltcode=  a.cltcode " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
            select @@fromtables = " from ledger l left outer join .acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
	 end
      else
         begin
            select @@selectqury = " select Amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + " and l.vtyp <> 18 "
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + " AND L.VTYP = 18 ) t"
            select @@fromtables = " "
            select @@wherepart  = " "
/*            select @@selectqury = "select Amount = isnull(sum(balamt),0)"
            select @@fromtables = " from ledger l left outer join .acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart2 + @@addwhere
*/
	 end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select Amount = isnull(sum(case when upper(drcr) = 'D' then vamt else -vamt end),0)"
            select @@fromtables = " from ledger l left outer join .acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
	 end
      else
         begin
            select @@selectqury = " select Amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + ") t"
            select @@fromtables = " "
            select @@wherepart  = " "
	 end
   end
end
/*--- If user wants to see Trial balance With Opening Balances ---*/
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = isnull(sum(case when upper(drcr) = 'D' then vamt else 0 end),0), crtot = isnull(sum(case when upper(drcr) = 'C' then vamt else 0 end),0),opbal = 0 "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and  vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            if @sortbydate = 'vdt'
               begin
                  select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vtyp = 18 then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0)"
                  select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                  select @@wherepart  = @@wherepart2 + @@addwhere
               end
	    else
	       begin
                  select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vtyp = 18 then balamt else 0 end),0)"
                  select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
                  select @@wherepart  = @@wherepart2 + @@addwhere
	       end
         end
      else
         begin
           select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0) "
           select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      if @sortbydate = 'vdt'
         begin
            select @@selectqury = "select drtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else 0 end) else 0 end),0), crtot = isnull(sum(case when vtyp <> 18 and vdt >= '" + @stdate + "' then ( case when upper(drcr) = 'C' then vamt else 0 end) else 0 end),0), opbal = isnull(sum(case when vdt < '" + @stdate + "' then ( case when upper(drcr) = 'D' then vamt else -vamt end) else 0 end),0) "
            select @@fromtables = " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@wherepart  = @@wherepart3 + @@addwhere
	 end
      else
	 begin
            select @@selectqury = " select Amount=sum(amount) from "
            select @@selectqury = @@selectqury + " (select Amount = sum(case when upper(drcr) = 'D' then vamt else -vamt end)"            
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart3 + @@addwhere + " and l.vtyp <> 18 "
            select @@selectqury = @@selectqury + " Union all "
            select @@selectqury = @@selectqury + "select Amount = sum(balamt)"
            select @@selectqury = @@selectqury + " from ledger l left outer join acmast a on l.cltcode=  a.cltcode " 
            select @@selectqury = @@selectqury + @@wherepart2 + @@addwhere + ") t"
            select @@fromtables = " "
    select @@wherepart  = " "
	 end
   end
end
end    /* End og Statusid = 'Broker'  */
/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */
if @statusid = 'Branch'
begin
/*---- If user wants to see NORMAL trial balance ---*/
if @balance='normal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(l2.drcr) = 'D' then camt else -camt end),0)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart1 + @@addwhere
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(l2.drcr) = 'D' then camt else -camt end),0)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart2 + @@addwhere
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = " select Amount = isnull(sum(case when upper(l2.drcr) = 'D' then camt else -camt end),0)"
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
else if @balance='withopbal'
begin
   if @openentryflag = 0   /* Opening entry ( vtyp = 18 ) not found in Ledger */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = isnull(sum(case when upper(l2.drcr) = 'D' then camt else 0 end),0), crtot = isnull(sum(case when upper(l2.drcr) = 'C' then camt else 0 end),0),opbal = 0 "
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart1 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = isunll(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart1 + @@addwhere
         end
   end
   else if @openentryflag = 1  /* Opening entry ( vtyp = 18 ) found in Ledger for selected year */
   begin
      if @curryrstdate = @stdate 
         begin
            select @@selectqury = "select drtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vtyp = 18 then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0)"
            select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
            select @@wherepart  = @@wherepart2 + @@addwhere
         end
      else
         begin
           select @@selectqury = "select drtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0) "
           select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
           select @@wherepart  = @@wherepart2 + @@addwhere
         end
   end
   else if @openentryflag = 2  /* Opening entry ( vtyp = 18 ) found in Ledger for earlier year */
   begin
      select @@selectqury = "select drtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else 0 end) else 0 end),0), crtot = isnull(sum(case when l.vtyp <> 18 and l.vdt >= '" + @stdate + "' then ( case when upper(l2.drcr) = 'C' then camt else 0 end) else 0 end),0), opbal = isnull(sum(case when l.vdt < '" + @stdate + "' then ( case when upper(l2.drcr) = 'D' then camt else -camt end) else 0 end),0) "
      select @@fromtables = " from ledger l, ledger2 l2 left outer join acmast a on l2.cltcode=  a.cltcode  " 
      select @@wherepart  = @@wherepart3 + @@addwhere
   end
end
end /* End of Branch login or Branch selection from Broker login */
print @@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby  
exec (@@selectqury + @@fromtables + @@wherepart + @@groupby + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newpartybalances1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Newpartybalances1    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Newpartybalances1    Script Date: 04/07/2003 11:55:55 AM ******/
/****** Object:  Stored Procedure dbo.Newpartybalances1    Script Date: 02/18/2003 10:37:39 AM ******/
CREATE Procedure Newpartybalances1
@fromparty varchar(10),
@toparty varchar(10),	
@opendate varchar(11),
@fromdt varchar(11),
@todate varchar(11),
@reporttype varchar(30),
@sessionid varchar(30),
@branchcode varchar(10)
as
declare 
@@balcur as cursor,
@@baldate as datetime,
@@enddate as datetime
delete from temppartybalances1 where rtrim(sessionid) = rtrim(@sessionid)
select @@baldate = @fromdt + ' 23:59:59'
select @@enddate = @todate + ' 23:59:59'
if upper(rtrim(@reporttype)) = "PARTY"
begin
print 'I am in PARTY'
   while @@baldate <= @@enddate
   begin
	select @@baldate
	insert into temppartybalances1
	select l.cltcode,@@baldate,sum( case when upper(drcr) = 'D' then vamt else -vamt end), @sessionid
	from ledger l, acmast a where edt >= @opendate + ' 00:00:00' and edt <= @@baldate 
	and l.cltcode = a.cltcode and a.accat = 4 and a.cltcode >= @fromparty and a.cltcode <= @toparty
	and a.branchcode like rtrim(@branchcode) + '%'
	group by l.cltcode
	order by l.cltcode
        select @@baldate = dateadd(day,1,@@baldate)
   end
end
else if upper(rtrim(@reporttype)) = "FAMILY"
begin
print 'I am in FAMILY'
   while @@baldate <= @@enddate
   begin
	select @@baldate
	insert into temppartybalances1
	select c.family, @@baldate,sum( case when upper(drcr) = 'D' then vamt else -vamt end), @sessionid
	from ledger l, msajag.dbo.clientmaster c where edt >= @opendate + ' 00:00:00' and edt <= @@baldate 
	and l.cltcode = c.party_code and c.family >= @fromparty and c.family <= @toparty
	and c.Branch_cd like rtrim(@branchcode) + '%'
	group by c.family
	order by c.family
        select @@baldate = dateadd(day,1,@@baldate)
   end
end
else if upper(rtrim(@reporttype)) = "FAMILYPARTY"
begin
print 'I am in FAMILYPARTY'
   while @@baldate <= @@enddate
   begin
	select @@baldate
	insert into temppartybalances1
	select l.cltcode,@@baldate,sum( case when upper(drcr)  = 'D' then vamt else -vamt end), @sessionid
	from ledger l, msajag.dbo.clientmaster c  where edt >= @opendate + ' 00:00:00' and edt <= @@baldate 
	and l.cltcode = c.party_code and c.family >= @fromparty and c.family <= @toparty
	and c.Branch_cd like rtrim(@branchcode) + '%'
	group by l.cltcode
	order by l.cltcode
        select @@baldate = dateadd(day,1,@@baldate)
   end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL
-- --------------------------------------------------
CREATE PROCEDURE NEWPOSTBILL    
(  
 @VTYP SMALLINT,    
 @BOOKTYPE VARCHAR(2),    
 @VNO VARCHAR(12),    
 @VDT VARCHAR(11),    
 @EDTDR VARCHAR(11),    
 @EDTCR VARCHAR(11),    
 @CDT VARCHAR(11),    
 @PDT VARCHAR(11),    
 @ENTEREDBY VARCHAR(25),    
 @CHECKEDBY VARCHAR(25),    
 @SETT_NO VARCHAR(7),    
 @SETT_TYPE VARCHAR(3),    
 @UNAME VARCHAR(25),     
 @EXCHANGE VARCHAR(10),   
 @BILLDATE VARCHAR(11),   
 @OVNO VARCHAR(12) = ''   
)  
  
AS    
    
/*=================================================================================================  
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'    
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'    
=================================================================================================*/  
  
SET NOCOUNT ON    
  
DECLARE    
 @@OBJID AS INT,    
 @@EDTDR AS VARCHAR(11),    
 @@EDTCR AS VARCHAR(11),    
 @@LEDCNT AS INT  
    
BEGIN TRANSACTION  
  
 SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)  
  
/*=================================================================================================  
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE  
=================================================================================================*/  
 IF @OVNO <> ''  
  BEGIN  
   SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
   IF @@LEDCNT > 0   
    BEGIN   
     DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
--     DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
--     DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     IF @@OBJID <> 0    
      BEGIN    
       DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
      END    
    END  
  END  
  
 TRUNCATE TABLE POSTBILLLEDGER    
 TRUNCATE TABLE POSTBILLLEDGER2  
  
  
/*=========================================================================================================  
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING  
=========================================================================================================*/  
 INSERT   
 INTO POSTBILLLEDGER   
  (   
   VTYP,   
   VNO,   
   EDT,   
   ACNAME,   
   DRCR,   
   VAMT,   
   VDT,   
   VNO1,   
   REFNO,   
   BALAMT,   
   NODAYS,   
   CDT,   
   CLTCODE,   
   BOOKTYPE,   
   ENTEREDBY,   
   PDT,   
   CHECKEDBY,   
   ACTNODAYS,   
   NARRATION,   
   SETT_NO,   
   SETT_TYPE,   
   BILL_NO,   
   ACCAT,   
   BRANCHCODE  
  )   
  SELECT   
   @VTYP,   
   @VNO,   
   (  
    CASE   
    WHEN SELL_BUY = 1   
    THEN @EDTDR   
    ELSE @EDTCR   
    END  
   ),   
   ACNAME,   
   (  
    CASE   
    WHEN SELL_BUY = 1   
    THEN 'D'   
    ELSE 'C'   
    END  
   ),   
   AMOUNT,   
   @VDT,   
   @VNO,   
   '',   
   0,   
   0,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   PARTY_CODE,   
   @BOOKTYPE,   
   @ENTEREDBY,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   @CHECKEDBY,   
   0,   
   'NCX' + RTRIM(LTRIM(@BILLDATE)) + '  Bill Posted',   
   @SETT_NO,   
   @SETT_TYPE,   
   BILL_NO,   
   A.ACCAT,   
   A.BRANCHCODE    
  FROM NCDX.DBO.FOACCBILL B WITH(NOLOCK),   
   ACMAST A WITH(NOLOCK)   
  WHERE B.PARTY_CODE = A.CLTCODE   
   AND B.BILLDATE LIKE @BILLDATE + '%'  
   AND B.AMOUNT <> 0  
   AND   
   (  
    A.ACCAT = 4   
    OR B.BRANCHCD = 'ZZZ'  
   )   
         
  
 INSERT   
 INTO POSTBILLLEDGER2   
  SELECT   
   (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),    
   AMOUNT,   
   BRANCHCD,   
   PARTY_CODE  
  FROM   
   NCDX.DBO.FOACCBILL  
  WHERE  
   BILLDATE LIKE @BILLDATE + '%'  
   AND BRANCHCD <> 'ZZZ'  
   AND AMOUNT <> 0  
    
  
/*=================================================================================================  
      POST DATA INTO LEDGER  
=================================================================================================*/  
 INSERT   
 INTO LEDGER   
 (  
  VTYP,   
  VNO,   
  EDT,   
  LNO,   
  ACNAME,   
  DRCR,   
  VAMT,   
  VDT,   
  VNO1,   
  REFNO,   
  BALAMT,   
  NODAYS,   
  CDT,   
  CLTCODE,   
  BOOKTYPE,   
  ENTEREDBY,   
  PDT,   
  CHECKEDBY,   
  ACTNODAYS,   
  NARRATION  
 )   
  SELECT   
   VTYP,   
   VNO,   
   EDT,   
   LNO,   
   ACNAME,   
   DRCR,   
   VAMT,   
   VDT,   
   VNO1,   
   REFNO,   
   BALAMT,   
   NODAYS,   
   CDT,   
   CLTCODE,   
   BOOKTYPE,   
   ENTEREDBY,   
   PDT,   
   CHECKEDBY,   
   ACTNODAYS,   
   NARRATION   
  FROM POSTBILLLEDGER WITH(NOLOCK)   
  
     
/*=================================================================================================  
      POST DATA INTO LEDGER1  
=================================================================================================*/  
 /*INSERT   
 INTO LEDGER1   
 (  
  BNKNAME,   
  BRNNAME,   
  DD,   
  DDNO,   
  DDDT,   
  RELDT,   
  RELAMT,   
  REFNO,   
  RECEIPTNO,   
  VTYP,   
  VNO,   
  LNO,   
  DRCR,   
  BOOKTYPE,   
  MICRNO,   
  SLIPNO,   
  SLIPDATE,   
  CHEQUEINNAME,   
  CHQPRINTED,   
  CLEAR_MODE  
 )   
  SELECT   
   @EXCHANGE + @BILLDATE,  
   '',   
   'B',   
   '0',   
   '',   
   '',   
   VAMT,   
   '0',   
   '',   
   VTYP,   
   VNO,   
   LNO,   
   DRCR,   
   BOOKTYPE,   
   '0',   
   '',   
   '',   
   '',   
   1,   
   'C'   
  FROM POSTBILLLEDGER WITH(NOLOCK)  */
  
    
/*=================================================================================================  
      POST DATA INTO LEDGER2  
=================================================================================================*/  
 INSERT   
 INTO LEDGER2   
 (  
  VTYPE,   
  VNO,   
  LNO,   
  DRCR,   
  CAMT,   
  COSTCODE,   
  BOOKTYPE,   
  CLTCODE  
 )   
  SELECT   
   B.VTYP,   
   B.VNO,   
   B.LNO,   
   B2.DRCR,   
   B2.AMOUNT,   
   C.COSTCODE,   
   B.BOOKTYPE,   
   B.CLTCODE   
  FROM POSTBILLLEDGER B WITH(NOLOCK),   
   COSTMAST C WITH(NOLOCK),  
   POSTBILLLEDGER2 B2   
  WHERE   
   B.CLTCODE = B2.CLTCODE  
   AND B2.BRANCHCODE = C.COSTNAME   
    
  
/*=================================================================================================  
      POST DATA INTO LEDGER3  
=================================================================================================*/  
/* INSERT   
 INTO LEDGER3   
 (  
  NARATNO,  
  NARR,  
  REFNO,  
  VTYP,  
  VNO,  
  BOOKTYPE  
 )   
  SELECT   
   LNO,   
   NARRATION,   
   '',   
   VTYP,   
   VNO,   
   BOOKTYPE   
  FROM POSTBILLLEDGER   */
    
  
/*=================================================================================================  
      POST DATA INTO BILLMATCH  
=================================================================================================*/  
 INSERT   
 INTO BILLMATCH   
 (  
  EXCHANGE,   
  SEGMENT,   
  SETT_TYPE,   
  SETT_NO,   
  BILLNO,   
  DATE,   
  PARTY_CODE,   
  AMOUNT,   
  DRCR,   
  BALAMT,   
  VTYPE,   
  VNO,   
  LNO,   
  BRANCH,   
  BOOKTYPE  
 )   
  SELECT   
   LEFT(@EXCHANGE, 3),   
   'FUTURES',   
   SETT_TYPE,   
   SETT_NO,   
   BILL_NO,   
   VDT,   
   CLTCODE,   
   VAMT,   
   DRCR,   
   0,   
   VTYP,   
   VNO,   
   LNO,   
   BRANCHCODE,   
   BOOKTYPE   
  FROM POSTBILLLEDGER WITH(NOLOCK)    
  WHERE ACCAT = '4'   
    
/*=================================================================================================  
      POST DATA INTO BFBILLMATCH  
=================================================================================================*/  
 IF @@OBJID <> 0    
  BEGIN    
   INSERT   
   INTO BFBILLMATCH   
   (  
    EXCHANGE,   
    SEGMENT,   
    SETT_TYPE,   
    SETT_NO,   
    BILLNO,   
    DATE,   
    PARTY_CODE,   
    AMOUNT,   
    DRCR,       BALAMT,   
    VTYPE,   
    VNO,   
    LNO,   
    BRANCH,   
    BOOKTYPE,   
    BANKPOSTDATE,   
    BANKPOSTAMOUNT,   
    BANKSTATUS,   
    BANKREASON  
   )   
    SELECT   
     LEFT(@EXCHANGE, 3),   
     'FUTURES',   
     SETT_TYPE,   
     SETT_NO,   
     BILL_NO,   
     VDT,   
     CLTCODE,   
     VAMT,   
     DRCR,   
     0,   
     VTYP,   
     VNO,   
     LNO,   
     BRANCHCODE,   
     BOOKTYPE,   
     '',   
     0,   
     '',   
     ''   
    FROM POSTBILLLEDGER WITH(NOLOCK)   
    WHERE ACCAT = '4'   
  END    
     
/*=================================================================================================  
      POST DATA INTO BILLPOSTED  
=================================================================================================*/  
 SELECT   
  @@EDTDR = MIN(EDT),   
  @@EDTCR = MAX(EDT)   
 FROM POSTBILLLEDGER   
  
 INSERT   
 INTO BILLPOSTED   
 (  
  VNO,   
  VTYP,   
  BOOKTYPE,   
  VDT,   
  BILLDATE,   
  SETT_NO,   
  SETT_TYPE,   
  NARRATION,   
  USERNAME,   
  POSTDATE,   
  EDTDR,   
  EDTCR  
 )   
  SELECT   
   TOP 1 VNO,   
   VTYP,   
   BOOKTYPE,   
   CONVERT(VARCHAR(11), VDT, 109),   
   CONVERT(VARCHAR(11), VDT, 109),   
   SETT_NO,   
   SETT_TYPE,   
   NARRATION,   
   @UNAME,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   @@EDTDR,   
   @@EDTCR   
  FROM POSTBILLLEDGER WITH(NOLOCK)   
  
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newtraderpos
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.newtraderpos    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE newtraderpos
@br varchar(3)
 AS
select  l.Cltcode,c1.cl_code, C1.TRADER ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by  C1.TRADER,c1.cl_code,l.Cltcode
ORDER BY C1.TRADER,c1.cl_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NewTrialBal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.NewTrialBal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.NewTrialBal    Script Date: 01/04/1980 1:40:38 AM ******/
CREATE Proc NewTrialBal 
@startdt varchar(11),
@enddt varchar(11)
As
select grpname,a.grpcode,l.acname,l.cltcode ,
openentry=isnull(( select sum(case when drcr ='c' then vamt*-1 else vamt end )from ledger 
		   where cltcode = l.cltcode and vtyp = 18 
		   and vdt >= @startdt and vdt < = @enddt),0),
dramt = isnull((select sum(vamt) from ledger  where drcr = 'd' and cltcode = l.cltcode and vtyp <> 18
	 and vdt >= @startdt and vdt < = @enddt ),0),
cramt = isnull((select sum(vamt) from ledger  where drcr = 'c' and cltcode = l.cltcode and vtyp <> 18
	and vdt >= @startdt and vdt < = @enddt),0)
from acmast a,ledger l,grpmast g
where l.cltcode = a.cltcode and  a.grpcode = g.grpcode
group by  g.grpname,a.grpcode,l.acname,l.cltcode
order by a.grpcode,l.cltcode
/*
select grpname,a.grpcode,l.acname,l.cltcode ,
openentry=round(isnull(( select sum(case when drcr ='c' then vamt*-1 else vamt end )from ledger 
		   where cltcode = l.cltcode and vtyp = 18 
		   and vdt >= @startdt and vdt < = @enddt),0),2),
dramt = round(isnull((select sum(vamt) from ledger  where drcr = 'd' and cltcode = l.cltcode and vtyp <> 18
	 and vdt >= @startdt and vdt < = @enddt ),0),2),
cramt = round(isnull((select sum(vamt) from ledger  where drcr = 'c' and cltcode = l.cltcode and vtyp <> 18
	and vdt >= @startdt and vdt < = @enddt),0),2)
from acmast a,ledger l,grpmast g
where l.cltcode = a.cltcode and  a.grpcode = g.grpcode
group by  g.grpname,a.grpcode,l.acname,l.cltcode
order by a.grpcode,l.cltcode
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_POST_LEDGER
-- --------------------------------------------------




CREATE PROC [dbo].[OFFLINE_POST_LEDGER]          
(          
           @UNAME     VARCHAR(25),                              
           @USERCAT   INT,                              
           @EXCHANGE  VARCHAR(3),                              
           @SEGMENT   VARCHAR(10), 
		   @VOUCHERNO VARCHAR(20),  
		   @RECOFLAG  CHAR(1) = 'N'
		                                
)          
          
AS          
          
          
          
DECLARE @@LEDVDT VARCHAR(11)          
DECLARE @@VTYP SMALLINT      
      
DECLARE LEDPOST CURSOR FOR          
 --SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
 SELECT DISTINCT LEFT(VDATE,11) AS VDT, VOUCHERTYPE       
 FROM ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES          
 WHERE EXCHANGE = @EXCHANGE          
 AND SEGMENT = @SEGMENT          
 AND ROWSTATE = 0          
 AND VDATE NOT LIKE 'JAN  1 1900%'
 AND VOUCHERNO = CASE WHEN @VOUCHERNO <> '' THEN @VOUCHERNO ELSE VOUCHERNO END          
          
OPEN LEDPOST          
          
-- Perform the first fetch.          
FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP           
          
-- Check @@FETCH_STATUS to see if there are any more rows to fetch.          
WHILE @@FETCH_STATUS = 0          
BEGIN 
IF @@VTYP = 8             
 BEGIN            
   EXEC V2_OFFLINE_JVDRCRUPLOAD_RND @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG,@@VTYP,@VOUCHERNO                
 END 
          
IF @@VTYP = 3       
 BEGIN      
   EXEC V2_OFFLINE_PAYMENTUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG,@VOUCHERNO          
 END     
 IF @@VTYP = 2       
 BEGIN      
   EXEC V2_OFFLINE_RECPAYUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG,@VOUCHERNO          
 END      
          
-- This is executed as long as the previous fetch succeeds.          
   FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP           
END          
          
CLOSE LEDPOST          
DEALLOCATE LEDPOST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OldClientDrCrSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 8/7/01 6:03:49 PM ******/
/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.OldClientDrCrSp    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.oldClientDrCrSp    Script Date: 20-Mar-01 11:43:32 PM ******/
/*Created by vaishali on 28/02/2001
Calculated the debit and credit amount for client
*/
CREATE PROCEDURE OldClientDrCrSp
@tdate as varchar(21),
@fromparty varchar(10),
@toparty varchar(10),
@fromamt money,
@toamt money,
@flag tinyint
AS
/*For all parties and  for no range of amount*/
if @flag = 1
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal = round(Sum(debit),2) - round(Sum(credit),2) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1' 
group by p.cltcode,p.acname 
order by p.acname
end
 /*For specified parties and  for no range of amount*/
if @flag = 2
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal = round(Sum(debit),2) - round(Sum(credit),2) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1' 
and p.cltcode >= @fromparty and p.cltcode <= @toparty
group by p.cltcode,p.acname 
order by p.acname
end 
/*For all parties and  for specified from amount*/
if @flag = 3
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit),2) - round(Sum(credit),2)) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1' 
group by p.cltcode,p.acname  Having Abs(Sum(debit) - Sum(credit)) >= @fromamt
order by p.acname
end
 /*For specified parties and  for specified from amount*/
if @flag = 4
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit),2) - round(Sum(credit),2)) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1' 
and p.cltcode >= @fromparty and p.cltcode <= @toparty
group by p.cltcode,p.acname  
Having Abs(Sum(debit) - Sum(credit)) >= @fromamt
order by p.acname
end
/*For all parties and  for specified from amount*/
if @flag = 5
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit),2) - round(Sum(credit),2)) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
group by p.cltcode,p.acname 
Having Abs(Sum(debit) - Sum(credit)) <= @toamt 
order by p.acname
end
if @flag = 6
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit),2) - round(Sum(credit),2)) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
and p.cltcode >= @fromparty and p.cltcode <= @toparty
group by p.cltcode,p.acname 
Having Abs(Sum(debit) - Sum(credit)) <= @toamt 
order by p.acname
end
if @flag = 7
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit),2) - round(Sum(credit),2)) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
group by p.cltcode,p.acname 
Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
order by p.acname
end
if @flag = 8
begin
select isnull(p.cltcode,''),isnull(p.acname,''),bal =(round(Sum(debit),2) - round(Sum(credit),2)) 
from partydrcrview p,parameter,acmast a  
where vdt >= sdtcur and p.vdt <= @tdate
and p.cltcode = a.cltcode and a.accat = '4' and curyear = '1'
and p.cltcode >= @fromparty and p.cltcode <= @toparty
group by p.cltcode,p.acname 
Having  Abs(Sum(debit) - Sum(credit)) >= @fromamt and Abs(Sum(debit) - Sum(credit)) <= @toamt 
order by p.acname
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.openbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.openbal    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.openbal    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.openbal    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE openbal
@fromdt datetime,
@partycode varchar(10)
AS
select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <  @fromdt and CLTCODE=@partycode
group by  drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OpeningBalance
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.OpeningBalance    Script Date: 08/29/2001 6:51:54 AM ******/
CREATE Procedure OpeningBalance
@cltcode varchar(10),
@sdtcur varchar(11),
@fromdate varchar(11),
@vdtedtflag tinyint
AS
Declare
	@@openbaldt varchar(11),
	@@openentry money,
	@@openingbal money,
	@@dramt money,
	@@cramt money,
	@@opendt cursor,
	@@openbalcursor cursor
If @vdtedtflag = 0
begin
	set @@opendt = cursor for
	select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger
	where vtyp = 18 and cltcode = @cltcode
	and vdt < = @sdtcur  
	open @@opendt
 	fetch next from @@opendt into  @@openbaldt
	while @@fetch_status = 0
	begin
		
		/*Find the amount of the opening entry for the client if present else set to 0 */
		select @@dramt = 0
		select @@cramt = 0
		select @@openentry =0
		set @@openbalcursor = cursor  for 
		select 	dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
		cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
		from ledger where vtyp = 18 and vdt like @@openbaldt + '%'
    		and cltcode = @cltcode group by drcr
    		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  
		while @@fetch_status = 0
		begin
			
			if @@dramt <> 0  
			begin
				select @@openentry = @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openentry = 0 - @@cramt
			end
			
			
			fetch next from @@openbalcursor into @@dramt,@@cramt	
		end
		
		close @@openbalcursor
		deallocate @@openbalcursor
		
		select @@dramt = 0
		select @@cramt = 0	
		select @@openingbal = 0
		set @@openbalcursor = cursor for 
		select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
		crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
		from ledger where vdt > = @@openbaldt 
    		and vdt < @fromdate  and vtyp <> 18 and cltcode = @cltcode
    		group by drcr 
		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  		while @@fetch_status = 0
		begin
			if @@dramt <> 0  
			begin
				select @@openingbal = @@openingbal + @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openingbal = @@openingbal - @@cramt
			end
			
			fetch next from @@openbalcursor into @@dramt,@@cramt					
		end
		select @@openingbal = @@openingbal + @@openentry
		close @@openbalcursor
		deallocate @@openbalcursor
		/*select @@openbaldt
		select @@openentry*/
		select @@openingbal
		fetch next from @@opendt into  @@openbaldt
	end	
	close @@opendt
	deallocate @@opendt
end
else if @vdtedtflag = 1
begin
	set @@opendt = cursor for
	select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger
	where vtyp = 18 and cltcode = @cltcode and edt < = @sdtcur  
	open @@opendt
 	fetch next from @@opendt into  @@openbaldt
	
	while @@fetch_status = 0
	begin
		
		/*Find the amount of the opening entry for the client if present else set to 0 */
		select @@dramt = 0
		select @@cramt = 0
		select @@openentry =0
		
		set @@openbalcursor = cursor  for 
		select 	dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
		cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
		from ledger where vtyp = 18 and edt like @@openbaldt + '%'
    		and cltcode = @cltcode group by drcr
    		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  
		
		while @@fetch_status = 0
		begin
			if @@dramt <> 0  
			begin
				select @@openentry = @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openentry = 0 - @@cramt
			end
			
			
			fetch next from @@openbalcursor into @@dramt,@@cramt	
		end
		
		close @@openbalcursor
		deallocate @@openbalcursor
		
		select @@dramt = 0
		select @@cramt = 0
		select @@openingbal = 0
		set @@openbalcursor = cursor for 
		select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
		crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
		from ledger where edt > = @@openbaldt  and edt < @fromdate  
		and vtyp <> 18 and cltcode = @cltcode group by drcr 
		open @@openbalcursor
 		fetch next from @@openbalcursor into @@dramt,@@cramt
  		while @@fetch_status = 0
		begin
			if @@dramt <> 0  
			begin
				select @@openingbal = @@openingbal + @@dramt
			end
			if @@cramt <> 0 
			begin
				select @@openingbal = @@openingbal - @@cramt
			end
			
			fetch next from @@openbalcursor into @@dramt,@@cramt					
		end
		select @@openingbal = @@openingbal + @@openentry
		
		close @@openbalcursor
		deallocate @@openbalcursor
		/*select @@openbaldt
		select @@openentry*/
		select @@openingbal
		fetch next from @@opendt into  @@openbaldt
	end	
	close @@opendt
	deallocate @@opendt
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.partycode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.partycode    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.partycode    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 2/17/01 3:34:15 PM ******/
/****** Object:  Stored Procedure dbo.partycode    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE partycode
@clcode varchar(6)
AS
select distinct party_code from ncdx.dbo.client2, ledger 
where cl_code=@clcode and party_code=cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.partydrdispsp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.partydrdispsp    Script Date: 07/24/2001 11:35:22 AM ******/
CREATE proc partydrdispsp (@stdate datetime, @endate datetime,@amtlimit money,@flag int)
as 
if @flag = 1
begin
select l1.cltcode, l1.acname,
bal=(select isnull(sum(vamt),0) from ledger l  where drcr='d' and l.cltcode=l1.cltcode and vdt >= @stdate and vdt <= @endate )
    -(select isnull(sum(vamt),0) from ledger l  where drcr='c' and l.cltcode=l1.cltcode and vdt >= @stdate and vdt <= @endate ) 
from ledger l1 where vdt >= @stdate and vdt <= @endate  
and abs((select isnull(sum(vamt),0) from ledger l  where drcr='d' and l.cltcode=l1.cltcode and vdt >= @stdate and vdt <= @endate )
    -(select isnull(sum(vamt),0) from ledger l  where drcr='c' and l.cltcode=l1.cltcode and vdt >= @stdate and vdt <= @endate ) ) > @amtlimit
and l1.cltcode in ( select cltcode from acmast where accat = 4 )
group by  l1.cltcode ,l1.acname 
order by  l1.acname,l1.cltcode 
end
if @flag=2
begin
select l1.cltcode, l1.acname,
bal=(select isnull(sum(vamt),0) from ledger l  where drcr='d' and l.cltcode=l1.cltcode and Edt >= @stdate and Edt <= @endate )
    -(select isnull(sum(vamt),0) from ledger l  where drcr='c' and l.cltcode=l1.cltcode and Edt >= @stdate and edt <= @endate ) 
from ledger l1 where Edt >= @stdate and Edt <= @endate  and abs((select isnull(sum(vamt),0) from ledger l  where drcr='d' and l.cltcode=l1.cltcode and edt >= @stdate and Edt <= @endate )
    -(select isnull(sum(vamt),0) from ledger l  where drcr='c' and l.cltcode=l1.cltcode and Edt >= @stdate and Edt <= @endate ) ) > @amtlimit
and l1.cltcode in ( select cltcode from acmast where accat = 4 )
group by  l1.cltcode ,l1.acname 
order by  l1.acname,l1.cltcode 
end
return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PayAdvOwnerSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.PayAdvOwnerSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.PayAdvOwnerSp    Script Date: 02/04/2002 9:59:40 PM ******/
/****** Object:  Stored Procedure dbo.PayAdvOwnerSp    Script Date: 01/18/2002 1:38:07 PM ******/
/****** Object:  Stored Procedure dbo.PayAdvOwnerSp    Script Date: 12/26/2001 1:26:52 PM ******/
/****** Object:  Stored Procedure dbo.PayAdvOwnerSp    Script Date: 20-Mar-01 11:43:34 PM ******/
/*
Created by vaishali on 26/12/2000
Used inthe PaymentAdvice control
*/
CREATE PROCEDURE PayAdvOwnerSp
 AS
Select preprintchq from ncdx.dbo.owner

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PopulateLastVno
-- --------------------------------------------------


CREATE PROC PopulateLastVno

AS

DECLARE
	@@PARA AS SMALLINT,
	@@STD_DATE AS VARCHAR(11),
	@@LST_DATE AS VARCHAR(11)

BEGIN TRAN

SELECT @@PARA = VNOFLAG, @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109), @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109) FROM PARAMETER WHERE CURYEAR = 1
IF @@PARA = 0		--FOR YEARLY SERIES
	BEGIN
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
	END
ELSE
	IF @@PARA = 2
		BEGIN
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
		END
	ELSE
		IF @@PARA = 1
			BEGIN
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
			END
COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PostNcdxFutValan
-- --------------------------------------------------
CREATE PROCEDURE PostNcdxFutValan
@vtyp smallint,
@BookType char(2),
@vno varchar(12),
@vdt varchar(11),
@edtdr varchar(11),
@edtcr varchar(11),
@cdt datetime,
@pdt datetime,
@EnteredBy varchar(25), 
@CheckedBy varchar(25),
@sett_no  varchar(7),
@sett_type varchar(3),
@sessionid int

/*SlipNo,,ChequeInName,ChqPrinted*/
AS

declare
@@lno  as int,
@@vno1 as varchar(12),
@@refno char(12),
@@NoDays int,
@@actnodays int,
@@balamt money,
@@SlipNo smallint,
@@Slipdate datetime,
@@clearingmode char(2),
@@receiptno int,
@@ddno       as int,
@@vdt1 as datetime,
@@edt1 as datetime,
@@edt2 as datetime,
@@dddt1 as datetime,
@@reldt1     as datetime,
@@party_code as varchar(10), 
@@bill_no    as int, 
@@sell_buy    as char(1), 
@@sett_no    as varchar(7), 
@@sett_type  as varchar(3), 
@@amount     as money,  
@@branchcd   as varchar(10), 
@@vnarr      as varchar(234),
@@vnarr1     as varchar(234),
@@accat      as tinyint,
@@acname     as varchar(100),
@@bnkname    as varchar(20),
@@brnname    as varchar(20),
@@rcursor    as cursor

select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))
select @@edt1 = convert(datetime,@edtdr+' '+convert(varchar,getdate(),114))
select @@edt2 = convert(datetime,@edtcr+' '+convert(varchar,getdate(),114))

select @@vno1 = @vno
select @@reldt1 = ''
select @@dddt1 = @vdt
select @@refno = ''
select @@nodays = 0
select @@actnodays  = 0
select @@balamt = 0
select @@slipno = 0
select @@slipdate =''
select @@ddno = 0
/*select @@clearingmode =' ' */
select @@receiptno = 0

select * into #ledger from ledger where 1=2

select * into #ledger1 from ledger1 where 1=2

set @@rcursor = cursor for
select Party_Code, Bill_No, Sell_Buy, Sett_No, Sett_Type, Amount, BranchCd, Narration, accat, acname=longname
from ncdx.dbo.accbill b left outer join acmast a on b.party_code = a.cltcode
where sett_no = @sett_no and sett_type = @sett_type
open @@rcursor
fetch next from @@rcursor 
into @@party_code, @@bill_no, @@sell_buy, @@sett_no, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname

select @@lno = 0
select @@vnarr1 = 'Settno=' + rtrim(@Sett_No) + 'NCX' + rtrim(@Sett_type) + rtrim(@@vnarr)

while @@fetch_status = 0
begin

   if @@accat = 4 or @@branchcd = 'ZZZ'
   begin
      select @@bnkname = rtrim(@Sett_No) + 'NCX' + rtrim(@Sett_type) + convert(varchar,@@bill_no,10)
      select @@brnname = ''
      select @@lno = @@lno + 1
   
      Insert into #ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,EnteredBy,lno,balamt,
                           Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration) 
              values (@vtyp,@vno,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@@vdt1,@@refno,upper(@@party_code),@EnteredBy,@@lno,@@balamt,
                           @@Vno1,@booktype,(case when @@sell_buy = 1 then @@edt1 else @@edt2 end),@cdt,@pdt,@@NoDays,@@actnodays,@CheckedBy,@@acname,@@vnarr1)

      insert into  #ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)
                values (@@lno,@@bnkname,substring(@@brnname,1,20),'B',rtrim(@@ddno),@@dddt1,@@amount,@vtyp,@vno,@BookType,@@refno,@@reldt1,0,@@slipno,@@slipdate,'','',1,@@receiptno,(case when @@sell_buy = 1 then 'D' else 'C' end))

   end

   if @@accat = 4
   begin
	insert into billmatch(Exchange,Segment,Sett_type,Sett_No,BillNo,Date,Party_Code,Amount,DrCr,balamt,vtype,vno,lno,Branch,BookType)
                       values('NCX','FUTURES',@@sett_type,@@sett_no,@@bill_no,@vdt,@@party_code,@@amount,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@vtyp,@vno,@@lno,@@branchcd,@booktype)
   end

   fetch next from @@rcursor 
   into @@party_code, @@bill_no, @@sell_buy, @@sett_no, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname

end



insert into ledger select * from #ledger

insert into ledger1 select bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode from #ledger1


Insert into ledger3
select lno,narration,refno,vtyp,vno,BookType 
from #ledger 
where vtyp = @vtyp and booktype = @booktype and vno = @vno

Insert into ledger3
select 0,narration,refno,vtyp,vno,BookType 
from #ledger 
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1

insert into ledger2
select vtyp, vno, lno, (case when sell_buy = 1 then 'D' else 'C' end), amount, costcode, BookType, cltcode 
from #ledger l, ncdx.dbo.accbill b, costmast c
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and b.sett_no = @sett_no and b.sett_type = @sett_type
and l.cltcode = b.party_code and b.branchcd = c.costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PostNCXValan
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.PostNCXValan    Script Date: 1/17/2004 11:39:08 PM ******/

CREATE PROCEDURE PostNCXValan
@vtyp smallint,
@BookType char(2),
@vno varchar(12),
@vdt varchar(11),
@edtdr varchar(11),
@edtcr varchar(11),
@cdt datetime,
@pdt datetime,
@EnteredBy varchar(25), 
@CheckedBy varchar(25),
@billdate  varchar(11),
@sett_type varchar(3),
@sessionid int
/*SlipNo,,ChequeInName,ChqPrinted*/
AS
declare
@@lno  as int,
@@vno1 as varchar(12),
@@refno char(12),
@@NoDays int,
@@actnodays int,
@@balamt money,
@@SlipNo smallint,
@@Slipdate datetime,
@@clearingmode char(2),
@@receiptno int,
@@ddno       as int,
@@vdt1 as datetime,
@@edt1 as datetime,
@@edt2 as datetime,
@@dddt1 as datetime,
@@reldt1     as datetime,
@@party_code as varchar(10), 
@@bill_no    as int, 
@@sell_buy    as char(1), 
@@billdate    as varchar(11), 
@@sett_type  as varchar(3), 
@@amount     as money,  
@@branchcd   as varchar(10), 
@@vnarr      as varchar(234),
@@vnarr1     as varchar(234),
@@accat      as tinyint,
@@acname     as varchar(35),
@@bnkname    as varchar(20),
@@brnname    as varchar(20),
@@rcursor    as cursor
select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))
select @@edt1 = convert(datetime,@edtdr+' '+convert(varchar,getdate(),114))
select @@edt2 = convert(datetime,@edtcr+' '+convert(varchar,getdate(),114))
select @@vno1 = @vno
select @@reldt1 = ''
select @@dddt1 = @vdt
select @@refno = ''
select @@nodays = 0
select @@actnodays  = 0
select @@balamt = 0
select @@slipno = 0
select @@slipdate =''
select @@ddno = 0
/*select @@clearingmode =' ' */
select @@receiptno = 0
/* --------------- Posting of Normal Valan ------------------ */
set @@rcursor = cursor for
select Party_Code, Bill_No, Sell_Buy, billdate, Sett_Type, Amount, BranchCd, Narration, accat, acname
from ncdx.dbo.foaccbill b left outer join acmast a on b.party_code = a.cltcode
where billdate like @billdate + '%'
open @@rcursor
fetch next from @@rcursor 
into @@party_code, @@bill_no, @@sell_buy, @@billdate, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname
select @@lno = 0
select @@vnarr1 = 'NCX' + rtrim(@billdate) + '  ' + rtrim(@@vnarr)
while @@fetch_status = 0
begin
   if @@accat = 4 or @@branchcd = 'ZZZ'
   begin
      select @@bnkname = 'NCX' + rtrim(@billdate) + convert(varchar,@@bill_no,10)
      select @@brnname = ''
      select @@lno = @@lno + 1
   
      Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,EnteredBy,lno,balamt,
                           Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration) 
              values (@vtyp,@vno,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@@vdt1,@@refno,upper(@@party_code),@EnteredBy,@@lno,@@balamt,
                           @@Vno1,@booktype,(case when @@sell_buy = 1 then @@edt1 else @@edt2 end),@cdt,@pdt,@@NoDays,@@actnodays,@CheckedBy,@@acname,@@vnarr1)
      insert into  ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)
                values (@@lno,@@bnkname,substring(@@brnname,1,20),'B',rtrim(@@ddno),@@dddt1,@@amount,@vtyp,@vno,@BookType,@@refno,@@reldt1,0,@@slipno,@@slipdate,'','',1,@@receiptno,(case when @@sell_buy = 1 then 'D' else 'C' end))
   end
   if @@accat = 4
   begin
	insert into billmatch(Exchange,Segment,Sett_type,Sett_No,BillNo,Date,Party_Code,Amount,DrCr,balamt,vtype,vno,lno,Branch,BookType)
                       values('NCX','FUTURES',@@sett_type,0,@@bill_no,@vdt,@@party_code,@@amount,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@vtyp,@vno,@@lno,@@branchcd,@booktype)
   end
   fetch next from @@rcursor 
   into @@party_code, @@bill_no, @@sell_buy, @@billdate, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname
end
Insert into ledger3
select lno,narration,refno,vtyp,vno,BookType 
from ledger 
where vtyp = @vtyp and booktype = @booktype and vno = @vno
Insert into ledger3
select 0,narration,refno,vtyp,vno,BookType 
from ledger 
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1
insert into ledger2
select vtyp, vno, lno, (case when sell_buy = 1 then 'D' else 'C' end), amount, costcode, BookType, cltcode 
from ledger l, ncdx.dbo.foaccbill b, costmast c
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and b.billdate like @billdate + '%'
and l.cltcode = b.party_code and b.branchcd = c.costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PostNseFOValan
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.PostNseFOValan    Script Date: 1/17/2004 11:39:08 PM ******/

create PROCEDURE PostNseFOValan
@vtyp smallint,
@BookType char(2),
@vno varchar(12),
@vdt varchar(11),
@edtdr varchar(11),
@edtcr varchar(11),
@cdt datetime,
@pdt datetime,
@EnteredBy varchar(25), 
@CheckedBy varchar(25),
@billdate  varchar(11),
@sett_type varchar(3),
@sessionid int
/*SlipNo,,ChequeInName,ChqPrinted*/
AS
declare
@@lno  as int,
@@vno1 as varchar(12),
@@refno char(12),
@@NoDays int,
@@actnodays int,
@@balamt money,
@@SlipNo smallint,
@@Slipdate datetime,
@@clearingmode char(2),
@@receiptno int,
@@ddno       as int,
@@vdt1 as datetime,
@@edt1 as datetime,
@@edt2 as datetime,
@@dddt1 as datetime,
@@reldt1     as datetime,
@@party_code as varchar(10), 
@@bill_no    as int, 
@@sell_buy    as char(1), 
@@billdate    as varchar(11), 
@@sett_type  as varchar(3), 
@@amount     as money,  
@@branchcd   as varchar(10), 
@@vnarr      as varchar(234),
@@vnarr1     as varchar(234),
@@accat      as tinyint,
@@acname     as varchar(35),
@@bnkname    as varchar(20),
@@brnname    as varchar(20),
@@rcursor    as cursor
select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))
select @@edt1 = convert(datetime,@edtdr+' '+convert(varchar,getdate(),114))
select @@edt2 = convert(datetime,@edtcr+' '+convert(varchar,getdate(),114))
select @@vno1 = @vno
select @@reldt1 = ''
select @@dddt1 = @vdt
select @@refno = ''
select @@nodays = 0
select @@actnodays  = 0
select @@balamt = 0
select @@slipno = 0
select @@slipdate =''
select @@ddno = 0
/*select @@clearingmode =' ' */
select @@receiptno = 0
/* --------------- Posting of Normal Valan ------------------ */
set @@rcursor = cursor for
select Party_Code, Bill_No, Sell_Buy, billdate, Sett_Type, Amount, BranchCd, Narration, accat, acname
from ncdx.dbo.foaccbill b left outer join acmast a on b.party_code = a.cltcode
where billdate like @billdate + '%'
open @@rcursor
fetch next from @@rcursor 
into @@party_code, @@bill_no, @@sell_buy, @@billdate, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname
select @@lno = 0
select @@vnarr1 = 'NSEFO' + rtrim(@billdate) + '  ' + rtrim(@@vnarr)
while @@fetch_status = 0
begin
   if @@accat = 4 or @@branchcd = 'ZZZ'
   begin
      select @@bnkname = 'NSEFO' + rtrim(@billdate) + convert(varchar,@@bill_no,10)
      select @@brnname = ''
      select @@lno = @@lno + 1
   
      Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,EnteredBy,lno,balamt,
                           Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration) 
              values (@vtyp,@vno,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@@vdt1,@@refno,upper(@@party_code),@EnteredBy,@@lno,@@balamt,
                           @@Vno1,@booktype,(case when @@sell_buy = 1 then @@edt1 else @@edt2 end),@cdt,@pdt,@@NoDays,@@actnodays,@CheckedBy,@@acname,@@vnarr1)
      insert into  ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)
                values (@@lno,@@bnkname,substring(@@brnname,1,20),'B',rtrim(@@ddno),@@dddt1,@@amount,@vtyp,@vno,@BookType,@@refno,@@reldt1,0,@@slipno,@@slipdate,'','',1,@@receiptno,(case when @@sell_buy = 1 then 'D' else 'C' end))
   end
   if @@accat = 4
   begin
	insert into billmatch(Exchange,Segment,Sett_type,Sett_No,BillNo,Date,Party_Code,Amount,DrCr,balamt,vtype,vno,lno,Branch,BookType)
                       values('NSE','FUTURES',@@sett_type,0,@@bill_no,@vdt,@@party_code,@@amount,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@vtyp,@vno,@@lno,@@branchcd,@booktype)
   end
   fetch next from @@rcursor 
   into @@party_code, @@bill_no, @@sell_buy, @@billdate, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname
end
Insert into ledger3
select lno,narration,refno,vtyp,vno,BookType 
from ledger 
where vtyp = @vtyp and booktype = @booktype and vno = @vno
Insert into ledger3
select 0,narration,refno,vtyp,vno,BookType 
from ledger 
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1
insert into ledger2
select vtyp, vno, lno, (case when sell_buy = 1 then 'D' else 'C' end), amount, costcode, BookType, cltcode 
from ledger l, ncdx.dbo.foaccbill b, costmast c
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and b.billdate = @billdate 
and l.cltcode = b.party_code and b.branchcd = c.costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_LEDBAL_COMBINE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_GET_LEDBAL_COMBINE]     
(    
 @MARGINDATE VARCHAR(11) 
) 

AS

-- EXEC PR_GET_LEDBAL_COMBINE 'DEC 12 2019'
DECLARE 
		@SDTCUR			DATETIME,
		@LDTCUR			DATETIME 

DECLARE @T5DAY VARCHAR(11)

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER    
WHERE CONVERT(DATETIME,@MARGINDATE) BETWEEN SDTCUR AND LDTCUR
 
SELECT @T5DAY = LEFT(ISNULL(MAX(SEC_PAYIN),@MARGINDATE),11) FROM    
(SELECT DISTINCT TOP 5 SEC_PAYIN = CONVERT(DATETIME,LEFT(SEC_PAYIN,11)) FROM MSAJAG.DBO.SETT_MST (NOLOCK)     
WHERE SEC_PAYIN >= @MARGINDATE     
AND SETT_TYPE = 'N') S    

SELECT CLTCODE, VAMT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) 
INTO #CASH_LED_BAL FROM LEDGER L (NOLOCK)
WHERE VDT <= @MARGINDATE + ' 23:59:59'
AND VDT >= @SDTCUR AND VDT<= @LDTCUR
AND CONVERT(DATETIME,@MARGINDATE) BETWEEN @SDTCUR AND @LDTCUR 
GROUP BY CLTCODE

INSERT INTO #CASH_LED_BAL 
SELECT CLTCODE, VAMT=SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) 
FROM ACCOUNT.DBO.LEDGER L (NOLOCK)
WHERE VDT <= @MARGINDATE + ' 23:59:59' and EDT > @MARGINDATE + ' 23:59:59'
AND VDT >=CONVERT(DATETIME,@MARGINDATE,120)-7
AND VTYP IN (15,35) 
GROUP BY CLTCODE

/* NEW LOGIC ADDED TO REVERSE THE T DAY PAYMENT AND DEBIT JV */
INSERT INTO #CASH_LED_BAL 
SELECT CLTCODE, VAMT=SUM(VAMT) 
FROM ACCOUNT.DBO.LEDGER L (NOLOCK)
WHERE VDT BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59:59'
AND VDT >=CONVERT(DATETIME,@MARGINDATE,120)-7
AND VTYP IN (3, 8) AND DRCR = 'D'
GROUP BY CLTCODE
/* NEW LOGIC ADDED TO REVERSE THE T DAY PAYMENT AND DEBIT JV */

INSERT INTO #CASH_LED_BAL
SELECT       
CLTCODE, /*CHEQUE CANCELED TILL T+5 OF VDT TILL T+1*/      
SUM( CASE WHEN A.DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT    
FROM LEDGER A (NOLOCK), LEDGER1 B (NOLOCK)       
WHERE       
A.VTYP = '17'      
AND A.VTYP = B.VTYP AND A.VNO = B.VNO       
AND A.BOOKTYPE = B.BOOKTYPE AND A.LNO = B.LNO                    
AND A.VDT BETWEEN DATEADD(D, 1, @MARGINDATE) AND @T5DAY + ' 23:59:58'      
AND EXISTS (SELECT L1.CLTCODE,L1.VAMT,L2.DDNO       
    FROM LEDGER L1 (NOLOCK), LEDGER1 L2 (NOLOCK)        
    WHERE L1.VTYP = '2' /*RECEIPTS VDT TILL T+1*/      
    AND L1.VTYP = L2.VTYP AND L1.VNO = L2.VNO       
    AND L1.BOOKTYPE = L2.BOOKTYPE      
    AND L1.LNO = L2.LNO       
    AND L1.VDT >= @SDTCUR AND L1.VDT <= @MARGINDATE + ' 23:59:58'      
    AND A.CLTCODE = L1.CLTCODE      
    AND A.VAMT = L1.VAMT      
    AND B.DDNO = L2.DDNO      
    AND L2.CLEAR_MODE = 'R')      
GROUP BY CLTCODE      
           		    
DELETE FOMARGINNEW_LEDGERBAL WHERE MARGINDATE < DATEADD(M,-1,@MARGINDATE)    
DELETE FOMARGINNEW_LEDGERBAL WHERE MARGINDATE = @MARGINDATE  

INSERT INTO FOMARGINNEW_LEDGERBAL    
 SELECT     
  @MARGINDATE,    
  CLTCODE,    
  SUM(VAMT) VAMT,    
  GETDATE()    
  FROM #CASH_LED_BAL
  GROUP BY CLTCODE

DROP TABLE #CASH_LED_BAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PrintReconcile
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 08/24/2001 6:53:38 PM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 08/09/2001 2:03:16 AM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 7/1/01 2:19:43 PM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 06/28/2001 5:44:45 PM ******/
/****** Object:  Stored Procedure dbo.PrintReconcile    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE  PrintReconcile  
@code varchar(10)
, @flag  varchar(1)
,@tdate  datetime
AS
if @flag=1 
begin
	select  isnull(sum(vamt) ,0) ,drcr from ledger 
	where cltcode =    @code    and vdt  <= @tdate
	group by drcr
	order  by drcr
end
if @flag=2
begin
	select   tdate=convert(varchar,l.vdt,103),   isnull(ddno,'') ddno   ,   isnull(cltcode ,'') cltcode , isnull( acname ,'') acname, l.drcr,
	Dramt=(case l.drcr when 'd' then vamt  else 0 end ),
	Cramt= (case l.drcr when  'c' then vamt else 0 end ) , 
	treldt=isnull( (select   convert(varchar, reldt , 103) from ledger1 l   where /*l.refno = ll1.refno*/
			l.vtyp =ll1.vtyp and l.vno=ll1.vno and l.booktype = ll1.booktype and l.lno=ll1.lno and l.drcr=ll1.drcr and datepart(year,reldt) <>1900  ) ,'')
	From ledger l  ,LEDGER1 LL1 
	WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <> @code and l.booktype = ( select booktype from acmast where cltcode = @code )
	/*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */
	and l.vtyp =ll1.vtyp and l.vno=ll1.vno and l.booktype = ll1.booktype and l.lno=ll1.lno and l.drcr=ll1.drcr and 
	l.vno in (select vno from ledger l1 where cltcode =  @code  and l.vtyp=l1.vtyp and l.booktype = l1.booktype)
	and  ( reldt ='1900-01-01 00:00:00.000'   or   reldt > @tdate )
	and vdt <=@tdate
	order by   l.drcr  ,  vdt  ,l.vtyp, l.vno 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_acc_getcompanyname
-- --------------------------------------------------
--Use Accountncdx
    Create Procedure Proc_acc_getcompanyname    
      @Accounddbname Varchar (50)    
  
As    
  
Select   
      *   
From    
      Pradnya.Dbo.Multicompany    
Where    
      Accountdb = @Accounddbname And    
      Primaryserver = 1    
Order By    
      Companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_FNO_JV
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MARGIN_FNO_JV]      
(      
 @TRANSDATE VARCHAR(11),      
 @EXCHANGE VARCHAR(3),      
 @SEGMENT VARCHAR(7),      
 @BATCHNO INT      
)      
AS      
      
DECLARE             
--  @PREVDATE_1 VARCHAR(11),            
  @PREVDATE VARCHAR(11),            
  @SDTCUR VARCHAR(11),            
  @LDTCUR VARCHAR(11),            
  @CUTOFFDATE DATETIME,      
  @RefNo Varchar(4),      
  @filebrokercode varchar(1)      
        
DECLARE @STARTDATE VARCHAR(11)        
    
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER            
WHERE @TRANSDATE BETWEEN SDTCUR AND LDTCUR        
    
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=FROM_EXCHANGE, FROM_SEGMENT = FROM_SEGMENT,      
TO_EXCHANGE, TO_SEGMENT,        
BANKNAME = CONVERT(VARCHAR(4),''),      
BANK_GL = CONVERT(VARCHAR(10),''),      
JV_GL = CONVERT(VARCHAR(10),''),      
NARR = CONVERT(VARCHAR(100),''),      
INTNO = CONVERT(VARCHAR(15),'')      
INTO #FINALLEDGER_CR        
FROM ANGELCOMMODITY.MCDX.DBO.Tbl_ALL_MarginProcess_Fund            
WHERE TRANSDATE = @TRANSDATE       
AND POSTEDFLAG = 0      
AND AMOUNT > 0       
AND FROM_EXCHANGE = @EXCHANGE      
AND FROM_SEGMENT = @SEGMENT       
      
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=TO_EXCHANGE, FROM_SEGMENT = TO_SEGMENT,       
TO_EXCHANGE=FROM_EXCHANGE, TO_SEGMENT=FROM_SEGMENT,       
BANKNAME = CONVERT(VARCHAR(4),''),      
BANK_GL = CONVERT(VARCHAR(10),''),      
JV_GL = CONVERT(VARCHAR(10),''),      
NARR = CONVERT(VARCHAR(100),''),      
INTNO = CONVERT(VARCHAR(15),'')      
INTO #FINALLEDGER_DR        
FROM ANGELCOMMODITY.MCDX.DBO.Tbl_ALL_MarginProcess_Fund            
WHERE TRANSDATE = @TRANSDATE       
AND POSTEDFLAG = 0      
AND AMOUNT > 0       
AND TO_EXCHANGE = @EXCHANGE      
AND TO_SEGMENT = @SEGMENT       
      
UPDATE #FINALLEDGER_DR SET JV_GL = JV_GLCODE      
FROM mcdx.DBO.Tbl_OTHERGLCODE N      
WHERE #FINALLEDGER_DR.FROM_EXCHANGE = N.FROM_EXCHANGE      
AND #FINALLEDGER_DR.FROM_SEGMENT = N.FROM_SEGMENT      
AND #FINALLEDGER_DR.TO_EXCHANGE = N.TO_EXCHANGE      
AND #FINALLEDGER_DR.TO_SEGMENT = N.TO_SEGMENT      
      
UPDATE #FINALLEDGER_CR SET JV_GL = JV_GLCODE      
FROM mcdx.DBO.Tbl_OTHERGLCODE N      
WHERE #FINALLEDGER_CR.FROM_EXCHANGE = N.FROM_EXCHANGE      
AND #FINALLEDGER_CR.FROM_SEGMENT = N.FROM_SEGMENT      
AND #FINALLEDGER_CR.TO_EXCHANGE = N.TO_EXCHANGE      
AND #FINALLEDGER_CR.TO_SEGMENT = N.TO_SEGMENT      
      
SELECT *,      
BANK_GL = CONVERT(VARCHAR(10),''),      
JV_GL = CONVERT(VARCHAR(10),''),      
INTNO = CONVERT(VARCHAR(15),'')       
INTO #LEDGER_CR FROM LEDGER            
WHERE VTYP = 2 AND 1 =2            
            
SELECT *,      
BANK_GL = CONVERT(VARCHAR(10),''),      
JV_GL = CONVERT(VARCHAR(10),''),      
INTNO = CONVERT(VARCHAR(15),'')       
INTO #LEDGER_DR FROM LEDGER            
WHERE VTYP = 3 AND 1 =2            
            
ALTER TABLE #LEDGER_CR            
ADD SNO INT IDENTITY(1,1)            
            
ALTER TABLE #LEDGER_DR            
ADD SNO INT IDENTITY(1,1)            
            
DECLARE @VNO BIGINT            
            
ALTER TABLE #FINALLEDGER_CR            
ADD SNO INT IDENTITY(1,1)            
            
ALTER TABLE #FINALLEDGER_DR            
ADD SNO INT IDENTITY(1,1)            
      
TRUNCATE TABLE #LEDGER_CR      
TRUNCATE TABLE #LEDGER_DR      
      
SET @VNO = 0             
      
TRUNCATE TABLE #LEDGER_CR      
TRUNCATE TABLE #LEDGER_DR      
      
SET @VNO = 0             
INSERT INTO #LEDGER_CR            
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='C', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,          
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),           
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGMENT JV FROM ' + TO_EXCHANGE+TO_SEGMENT,     
BANK_GL,      
JV_GL,      
INTNO=''               
FROM #FINALLEDGER_DR        
WHERE BANK_GL = ''          
ORDER BY SNO            
          
INSERT INTO #LEDGER_DR            
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='D', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,          
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),           
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGMENT JV TO ' + TO_EXCHANGE+TO_SEGMENT,      
BANK_GL,      
JV_GL,      
INTNO=''             
FROM #FINALLEDGER_CR            
WHERE BANK_GL = ''      
ORDER BY SNO            
  
DECLARE @REC INT  
SELECT @REC = 0  
SELECT @REC = COUNT(1) FROM #LEDGER_CR  
  
CREATE TABLE #VNO  
(  
 LASTVNO BIGINT  
)  
  
IF @REC > 0   
BEGIN  
 INSERT INTO #VNO  
 EXEC ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACC_GENVNO_NEW  
   @TRANSDATE,  
   '8',  
   '01',  
   @SDTCUR ,  
   @LDTCUR,  
   @REC  
     
   SELECT @VNO = LASTVNO - 1   
   FROM   #VNO  

	INSERT INTO LEDGER            
	SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE='01',ENTEREDBY='ANIMESH',            
	   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION           
	FROM #LEDGER_CR             
	          
	INSERT INTO LEDGER            
	SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='D',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE=JV_GL,BOOKTYPE='01',ENTEREDBY='ANIMESH',            
	   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION           
	FROM #LEDGER_CR             
END
            
TRUNCATE TABLE #LEDGER_CR          
      
SET @VNO = 0        
  
SELECT @REC = 0  
SELECT @REC = COUNT(1) FROM #LEDGER_DR  
  
TRUNCATE TABLE #VNO  
  
IF @REC > 0   
BEGIN  
 INSERT INTO #VNO  
 EXEC ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACC_GENVNO_NEW  
   @TRANSDATE,  
   '8',  
   '01',  
   @SDTCUR ,  
   @LDTCUR,  
   @REC  
     
   SELECT @VNO = LASTVNO - 1
   FROM   #VNO  
	  
	INSERT INTO LEDGER            
	SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,          
	BOOKTYPE='01',ENTEREDBY='ANIMESH',            
	   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR             
	            
	INSERT INTO LEDGER            
	SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='C',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,          
	CLTCODE=JV_GL,BOOKTYPE='01',ENTEREDBY='ANIMESH',            
	   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR             
END
	            
TRUNCATE TABLE #LEDGER_DR          
      
UPDATE LEDGER SET ACNAME = LONGNAME       
FROM ACMAST A            
WHERE VDT = @TRANSDATE AND A.CLTCODE = LEDGER.CLTCODE            
AND LEDGER.ACNAME <> LONGNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_NBFC_FNO_JV
-- --------------------------------------------------
create PROC [dbo].[PROC_NBFC_FNO_JV]
(
	@TRANSDATE	VARCHAR(11),
	@EXCHANGE	VARCHAR(3),
	@SEGMENT	VARCHAR(7),
	@BATCHNO	INT
)
AS

DECLARE       
--  @PREVDATE_1 VARCHAR(11),      
  @PREVDATE VARCHAR(11),      
  @SDTCUR VARCHAR(11),      
  @CUTOFFDATE DATETIME,
  @RefNo	Varchar(4),
  @filebrokercode	varchar(1)
  
DECLARE @STARTDATE VARCHAR(11)  

SELECT @REFNO = MAX(REFNO) FROM [172.31.16.57].NBFC.DBO.NBFC_REF_NO
WHERE TRANSDATE = @TRANSDATE AND BATCHNO = @BATCHNO 

SELECT @REFNO = RIGHT('0000'+ @RefNo,4)

SELECT @FILEBROKERCODE= MAX(FILEBROKERCODE) FROM [172.31.16.57].NBFC.DBO.NBFC_OTHERGLCODE
WHERE FROM_EXCHANGE = @EXCHANGE
AND FROM_SEGMENT = @SEGMENT
AND BANK_NAME = 'INDU'

SELECT @SDTCUR = SDTCUR FROM PARAMETER      
WHERE @TRANSDATE BETWEEN SDTCUR AND LDTCUR  
  
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=FROM_EXCHANGE, FROM_SEGMENT = FROM_SEGMENT,
TO_EXCHANGE, TO_SEGMENT,  
BANKNAME = CONVERT(VARCHAR(4),''),
BANK_GL = CONVERT(VARCHAR(10),''),
JV_GL = CONVERT(VARCHAR(10),''),
NARR = CONVERT(VARCHAR(100),''),
INTNO = CONVERT(VARCHAR(15),'')
INTO #FINALLEDGER_CR  
FROM angelcommodity.mcdx.dbo.Tbl_ALL_MarginProcess_Fund     
WHERE TRANSDATE = @TRANSDATE 
AND POSTEDFLAG = 0
AND FROM_EXCHANGE <> 'NBF'
AND AMOUNT > 0 
AND FROM_EXCHANGE = @EXCHANGE
AND FROM_SEGMENT = @SEGMENT 

SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=TO_EXCHANGE, FROM_SEGMENT = TO_SEGMENT, 
TO_EXCHANGE=FROM_EXCHANGE, TO_SEGMENT=FROM_SEGMENT, 
BANKNAME = CONVERT(VARCHAR(4),''),
BANK_GL = CONVERT(VARCHAR(10),''),
JV_GL = CONVERT(VARCHAR(10),''),
NARR = CONVERT(VARCHAR(100),''),
INTNO = CONVERT(VARCHAR(15),'')
INTO #FINALLEDGER_DR  
FROM angelcommodity.mcdx.dbo.Tbl_ALL_MarginProcess_Fund     
WHERE TRANSDATE = @TRANSDATE 
AND POSTEDFLAG = 0
AND TO_EXCHANGE <> 'NBF'
AND AMOUNT > 0 
AND TO_EXCHANGE = @EXCHANGE
AND TO_SEGMENT = @SEGMENT 

SELECT CLTCODE, BNAME = LEFT(BANK_NAME,4), BANK_NAME, CLT_ACCNO = ACCNO 
INTO #BNK
	FROM [172.31.16.57].ACCOUNTNBFC.DBO.MULTIBANKID M, [172.31.16.57].NBFC.DBO.POBANK P
	WHERE P.BANKID = M.BANKID AND DEFAULTBANK = 1

UPDATE #FINALLEDGER_CR SET BANKNAME = BNAME, NARR = 'AMOUNT PAID_' + CLT_ACCNO,
INTNO = @filebrokercode+@RefNo+LTRIM(RTRIM(#bnk.CLTCODE))
FROM #BNK 
WHERE #FINALLEDGER_CR.CLTCODE = #BNK.CLTCODE	

UPDATE #FINALLEDGER_DR SET BANKNAME = BNAME, NARR = 'AMOUNT RECEIVED AGAINST_' + CLT_ACCNO
FROM #BNK 
WHERE #FINALLEDGER_DR.CLTCODE = #BNK.CLTCODE	

UPDATE #FINALLEDGER_DR SET BANK_GL = BANK_GLCODE
FROM [172.31.16.57].NBFC.DBO.NBFC_OTHERGLCODE N
WHERE #FINALLEDGER_DR.FROM_EXCHANGE = N.FROM_EXCHANGE
AND #FINALLEDGER_DR.FROM_SEGMENT = N.FROM_SEGMENT
AND #FINALLEDGER_DR.BANKNAME = N.BANK_NAME 
AND #FINALLEDGER_DR.TO_EXCHANGE = 'NBF'

UPDATE #FINALLEDGER_CR SET BANK_GL = BANK_GLCODE
FROM [172.31.16.57].NBFC.DBO.NBFC_OTHERGLCODE N
WHERE #FINALLEDGER_CR.FROM_EXCHANGE = N.FROM_EXCHANGE
AND #FINALLEDGER_CR.FROM_SEGMENT = N.FROM_SEGMENT
AND #FINALLEDGER_CR.BANKNAME = N.BANK_NAME
AND #FINALLEDGER_CR.TO_EXCHANGE = 'NBF'

UPDATE #FINALLEDGER_DR SET JV_GL = JV_GLCODE
FROM [172.31.16.57].NBFC.DBO.NBFC_OTHERGLCODE N
WHERE #FINALLEDGER_DR.FROM_EXCHANGE = N.FROM_EXCHANGE
AND #FINALLEDGER_DR.FROM_SEGMENT = N.FROM_SEGMENT
AND #FINALLEDGER_DR.TO_EXCHANGE = N.TO_EXCHANGE
AND #FINALLEDGER_DR.TO_SEGMENT = N.TO_SEGMENT
AND #FINALLEDGER_DR.BANKNAME = N.BANK_NAME
AND #FINALLEDGER_DR.TO_EXCHANGE <> 'NBF'

UPDATE #FINALLEDGER_CR SET JV_GL = JV_GLCODE
FROM [172.31.16.57].NBFC.DBO.NBFC_OTHERGLCODE N
WHERE #FINALLEDGER_CR.FROM_EXCHANGE = N.FROM_EXCHANGE
AND #FINALLEDGER_CR.FROM_SEGMENT = N.FROM_SEGMENT
AND #FINALLEDGER_CR.TO_EXCHANGE = N.TO_EXCHANGE
AND #FINALLEDGER_CR.TO_SEGMENT = N.TO_SEGMENT
AND #FINALLEDGER_CR.BANKNAME = N.BANK_NAME
AND #FINALLEDGER_CR.TO_EXCHANGE <> 'NBF'

SELECT *,
BANK_GL = CONVERT(VARCHAR(10),''),
JV_GL = CONVERT(VARCHAR(10),''),
INTNO = CONVERT(VARCHAR(15),'') 
INTO #LEDGER_CR FROM LEDGER      
WHERE VTYP = 2 AND 1 =2      
      
SELECT *,
BANK_GL = CONVERT(VARCHAR(10),''),
JV_GL = CONVERT(VARCHAR(10),''),
INTNO = CONVERT(VARCHAR(15),'') 
INTO #LEDGER_DR FROM LEDGER      
WHERE VTYP = 3 AND 1 =2      
      
ALTER TABLE #LEDGER_CR      
ADD SNO INT IDENTITY(1,1)      
      
ALTER TABLE #LEDGER_DR      
ADD SNO INT IDENTITY(1,1)      
      
DECLARE @VNO BIGINT      
      
ALTER TABLE #FINALLEDGER_CR      
ADD SNO INT IDENTITY(1,1)      
      
ALTER TABLE #FINALLEDGER_DR      
ADD SNO INT IDENTITY(1,1)      

TRUNCATE TABLE #LEDGER_CR
TRUNCATE TABLE #LEDGER_DR

SET @VNO = 0       
INSERT INTO #LEDGER_CR      
SELECT VTYP = 2, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='C', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,    
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),     
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = NARR,
BANK_GL,
JV_GL,
INTNO    
FROM #FINALLEDGER_DR  
WHERE BANK_GL <> ''    
ORDER BY SNO      
    
INSERT INTO #LEDGER_DR      
SELECT VTYP = 3, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='D', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,    
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),     
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = NARR,
BANK_GL,
JV_GL,
INTNO          
FROM #FINALLEDGER_CR      
WHERE BANK_GL <> ''
ORDER BY SNO      

SELECT @VNO = ISNULL(MAX(LASTVNO),0) FROM lastvno L      
WHERE VTYP = 2 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR      
IF @VNO = 0    
BEGIN     
 SELECT @VNO = CONVERT(VARCHAR,RIGHT(@SDTCUR,4)) + '00000000'    
 INSERT INTO lastvno VALUES (2, 'E8', @SDTCUR, @VNO)    
END      
    
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION     
FROM #LEDGER_CR       
    
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='D',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE=BANK_GL,BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION     
FROM #LEDGER_CR       
    
INSERT INTO LEDGER1       
SELECT       
 BNKNAME = '',       
 BRNNAME = 'MUMBAI',       
 DD = 'Q',       
 DDNO = (CASE WHEN INTNO <> '' THEN INTNO ELSE '100214' END),       
 DDDT = VDT,       
 RELDT = '',      
 RELAMT = VAMT,      
 REFNO = '',      
 RECEIPTNO = 0,      
 VTYP,      
 VNO=@VNO+SNO,      
 LNO+1,      
 DRCR,      
 BOOKTYPE='E8',      
 MICRNO = '',      
 SLIPNO = '',      
 SLIPDATE = '',      
 CHEQUEINNAME = '',      
 CHQPRINTED = 0,      
 CLEAR_MODE = ''      
FROM #LEDGER_CR      
    
SELECT @VNO = @VNO + MAX(SNO) FROM #LEDGER_CR      
      
TRUNCATE TABLE #LEDGER_CR    
      
UPDATE lastvno SET LASTVNO = @VNO      
WHERE VTYP = 2 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR AND ISNULL(@VNO,0) <> 0       

SET @VNO = 0  
      
SELECT @VNO = ISNULL(MAX(LASTVNO),0) FROM lastvno L      
WHERE VTYP = 3 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR      
    
IF @VNO = 0    
BEGIN     
 SELECT @VNO = CONVERT(VARCHAR,RIGHT(@SDTCUR,4)) + '00000000'    
 INSERT INTO lastvno VALUES (3, 'E8', @SDTCUR, @VNO)    
END      
      
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,    
BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR       
      
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='C',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,    
CLTCODE=BANK_GL,BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR       


INSERT INTO LEDGER1       
SELECT       
 BNKNAME = '',       
 BRNNAME = 'MUMBAI',       
 DD = 'Q',       
 DDNO = (CASE WHEN INTNO <> '' THEN INTNO ELSE '100214' END),       
 DDDT = VDT,       
 RELDT = '',      
 RELAMT = VAMT,      
 REFNO = '',      
 RECEIPTNO = 0,      
 VTYP,      
 VNO=@VNO+SNO,      
 LNO+1,      
 DRCR,      
 BOOKTYPE='E8',      
 MICRNO = '',      
 SLIPNO = '',      
 SLIPDATE = '',      
 CHEQUEINNAME = '',      
 CHQPRINTED = 0,      
 CLEAR_MODE = ''      
FROM #LEDGER_DR      
     
SELECT @VNO = @VNO + MAX(SNO) FROM #LEDGER_DR      
      
TRUNCATE TABLE #LEDGER_DR    
     
UPDATE lastvno SET LASTVNO = @VNO      
WHERE VTYP = 3 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR AND ISNULL(@VNO,0) <> 0   



TRUNCATE TABLE #LEDGER_CR
TRUNCATE TABLE #LEDGER_DR

SET @VNO = 0       
INSERT INTO #LEDGER_CR      
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='C', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,    
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),     
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGNENT JV FROM ' + FROM_EXCHANGE+FROM_SEGMENT,
BANK_GL,
JV_GL,
INTNO=''         
FROM #FINALLEDGER_DR  
WHERE BANK_GL = ''    
ORDER BY SNO      
    
INSERT INTO #LEDGER_DR      
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='D', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,    
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),     
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGNENT JV TO ' + FROM_EXCHANGE+FROM_SEGMENT,
BANK_GL,
JV_GL,
INTNO=''       
FROM #FINALLEDGER_CR      
WHERE BANK_GL = ''
ORDER BY SNO      
    
SELECT @VNO = ISNULL(MAX(LASTVNO),0) FROM lastvno L      
WHERE VTYP = 8 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR      
IF @VNO = 0    
BEGIN     
 SELECT @VNO = CONVERT(VARCHAR,RIGHT(@SDTCUR,4)) + '00000000'    
 INSERT INTO lastvno VALUES (8, 'E8', @SDTCUR, @VNO)    
END      
    
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION     
FROM #LEDGER_CR       
    
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='D',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE=JV_GL,BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION     
FROM #LEDGER_CR       
    
SELECT @VNO = @VNO + MAX(SNO) FROM #LEDGER_CR      
      
TRUNCATE TABLE #LEDGER_CR    
      
UPDATE lastvno SET LASTVNO = @VNO      
WHERE VTYP = 8 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR AND ISNULL(@VNO,0) <> 0       

SET @VNO = 0  
      
SELECT @VNO = ISNULL(MAX(LASTVNO),0) FROM lastvno L      
WHERE VTYP = 8 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR      
    
IF @VNO = 0    
BEGIN     
 SELECT @VNO = CONVERT(VARCHAR,RIGHT(@SDTCUR,4)) + '00000000'    
 INSERT INTO lastvno VALUES (8, 'E8', @SDTCUR, @VNO)    
END      
      
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,    
BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR       
      
INSERT INTO LEDGER      
SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='C',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,    
CLTCODE=JV_GL,BOOKTYPE='E8',ENTEREDBY='ANIMESH',      
   PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR       
     
SELECT @VNO = @VNO + MAX(SNO) FROM #LEDGER_DR      
      
TRUNCATE TABLE #LEDGER_DR    
     
UPDATE lastvno SET LASTVNO = @VNO      
WHERE VTYP = 8 AND BOOKTYPE = 'E8'       
AND VDT = @SDTCUR AND ISNULL(@VNO,0) <> 0   

UPDATE LEDGER SET ACNAME = LONGNAME 
FROM ACMAST A      
WHERE VDT = @TRANSDATE AND A.CLTCODE = LEDGER.CLTCODE      
AND LEDGER.ACNAME <> LONGNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROCS
-- --------------------------------------------------
CREATE PROCEDURE PROCS     
(@NAME VARCHAR(40))    
AS      
SELECT * FROM SYS.PROCEDURES WHERE NAME LIKE '%' + @NAME + '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.recalbalances
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.recalbalances    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.recalbalances    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.recalbalances    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.recalbalances    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.recalbalances    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.recalbalances    Script Date: 8/7/01 6:03:50 PM ******/
CREATE PROCEDURE recalbalances
 AS
execute bbgadjbalcursor2000
execute bbgadjbalcursor2001

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECEIPT_BANK_POSTING
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RECEIPT_BANK_POSTING]
(
	@TRANSACTION_ID VARCHAR(20), -- UNIQUE TRANSACTION NUMBER RECEIVED IN API
	@EFFECTIVE_DATE VARCHAR(20), -- RECEIPT EFFECTIVE DATE IN DD/MM/YYYY FORMAT
	@VOUCHER_DATE VARCHAR(20), -- RECEIPT VOUCHER DATE IN DD/MM/YYYY FORMAT
	@CLIENT_CODE VARCHAR(50), -- CLIENT OR GL ACCOUNT
	@AMOUNT MONEY, -- RECEIPT AMOUNT
	@NARRATION VARCHAR(234), -- RECEIPT NARRATION
	@BANK_CODE VARCHAR(10), -- BROKER BANK ACCOUNT
	@BANK_NAME VARCHAR(100), -- RECEIPT BANK NAME
	@REFERENCE_NO VARCHAR(15), -- RECEIPT REFERENCE NO
	@BRANCHCODE VARCHAR(20), -- CLIENT OR GL BRANCH CODE SPECIFIED IN BROKERS SYSTEM
	@BRANCH_NAME VARCHAR(50), -- RECEIPT BRANCH NAME
	@CHQ_MODE VARCHAR(1), -- RECEIPT CHEQUE MODE (C - CHEQUE , D - DD, I - INTERSEGMENT, N -NEFT/RTGS'
	@CHQ_DATE VARCHAR(20), -- RECEIPT CHEQUE DATE
	@CHQ_NAME VARCHAR(100), -- NAME OF CLIENT IN CASE THE RECEIVED FROM CLIENT
	@CL_MODE VARCHAR(1), -- CHEQUE CLEARING MODE
	@EXCHANGE VARCHAR(10), -- EXCHANGE FOR WHICH THE RECEIPT HAS BEEN ENTERED
	@SEGMENT VARCHAR(10),-- SEGMENT FOR WHICH THE RECEIPT HAS BEEN ENTERED
	@UNAME VARCHAR(25), -- LOGIN USER NAME
	@APIACCOUNT VARCHAR(25) -- API DETAILS SERVER
--	@APITABLE VARCHAR(25) -- APIDETAILS TABLE NAME
)
AS

DECLARE
	@@STD_DATE VARCHAR(11),
	@@LST_DATE VARCHAR(11),
	@@BRANCHFLAG AS TINYINT,
	@@VNOFLAG AS TINYINT,
	@@VNOMETHOD INT,
	@@ACNAME CHAR(100),
	@@BOOKTYPE CHAR(2),
	@@MICRNO VARCHAR(10),
	@@DRCR VARCHAR(1),
	@@VTYP SMALLINT,
	@@BANK_CODE VARCHAR(100),
	@@BACKDAYS INT,
	@@BACKDATE VARCHAR(11),
	@@SERIAL_NO INT,
	@@NEWVNO AS VARCHAR(12),
	@@MAXCOUNT AS INT,
	@@VDT AS VARCHAR(11),
	@@ERROR_COUNT AS INT,
	@@SQL AS VARCHAR(2000),
	@@MAXVNO AS INT,
	@USERCAT SMALLINT,
	@DRCR CHAR(1)
	
SET @DRCR = 'C'	

/*INSERT INTO APIDETAILS..API_PAYMENT_DETAILS
	(TRANSACTION_ID, EFFECTIVE_DATE, VOUCHER_DATE, CLIENT_CODE, AMOUNT, DRCR, NARRATION, BANK_CODE, BANK_NAME, REFERENCE_NO, BRANCHCODE, BRANCH_NAME, CHQ_MODE, CHQ_DATE, CHQ_NAME, CL_MODE, EXCHANGE, SEGMENT, UNAME, POST_DATE, ACTION_FLAG)
VALUES
(
	@TRANSACTION_ID,
	@EFFECTIVE_DATE,
	@VOUCHER_DATE,
	@CLIENT_CODE,
	@AMOUNT,
	@DRCR,
	@NARRATION,
	@BANK_CODE,
	@BANK_NAME,
	@REFERENCE_NO,
	@BRANCHCODE,
	@BRANCH_NAME,
	@CHQ_MODE,
	@CHQ_DATE,
	@CHQ_NAME,
	@CL_MODE,
	@EXCHANGE,
	@SEGMENT,
	@UNAME,
	GETDATE(),
	'I'
)*/

SELECT @USERCAT = FLDCATEGORY FROM MSAJAG.DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = @UNAME

--BEGIN TRAN
	
CREATE TABLE #RECPAY_TABLE_TMP
(
	TRANSACTION_ID VARCHAR(20),
	SERIAL_NO INT,
	EDATE VARCHAR(20),
	VOUCHER_DATE VARCHAR(20),
	CLIENT_CODE VARCHAR(50),
	AMOUNT MONEY,
	DRCR VARCHAR(1),
	NARRATION VARCHAR(234),
	BANK_CODE VARCHAR(10),
	BANK_NAME VARCHAR(100),
	REF_NO VARCHAR(15),
	BRANCHCODE VARCHAR(20),
	BRANCH_NAME VARCHAR(50),
	CHQ_MODE VARCHAR(1),
	CHQ_DATE VARCHAR(20),
	CHQ_NAME VARCHAR(100),
	CL_MODE VARCHAR(1)
)

SELECT @@ERROR_COUNT = COUNT(1) FROM OWNER WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT


IF @@ERROR_COUNT = 0
BEGIN
	--UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'INVALID EXCHANGE SEGMENT POSTING' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'INVALID EXCHANGE SEGMENT POSTING', '" + @UNAME + "'"
	exec(@@SQL)
	RETURN
END

INSERT INTO #RECPAY_TABLE_TMP VALUES
(
	@TRANSACTION_ID,
	1,
	@EFFECTIVE_DATE,
	@VOUCHER_DATE,
	@CLIENT_CODE,
	@AMOUNT,
	@DRCR,
	@NARRATION,
	@BANK_CODE,
	@BANK_NAME,
	@REFERENCE_NO,
	@BRANCHCODE,
	@BRANCH_NAME,
	@CHQ_MODE,
	@CHQ_DATE,
	@CHQ_NAME,
	@CL_MODE
)

CREATE TABLE [#RECPAY_TABLE]
(
	TRANSACTION_ID VARCHAR(20),
	SERIAL_NO INT,
	EDATE VARCHAR(20),
	VOUCHER_DATE VARCHAR(20),
	CLIENT_CODE VARCHAR(50),
	AMOUNT MONEY,
	DRCR VARCHAR(1),
	NARRATION VARCHAR(234),
	BANK_CODE VARCHAR(10),
	BANK_NAME VARCHAR(100),
	REF_NO VARCHAR(15),
	BRANCHCODE VARCHAR(20),
	BRANCH_NAME VARCHAR(50),
	CHQ_MODE VARCHAR(1),
	CHQ_DATE VARCHAR(20),
	CHQ_NAME VARCHAR(100),
	CL_MODE VARCHAR(1),
	SNO INT IDENTITY (1, 1) NOT NULL ,
	VDT DATETIME NULL ,
	FYSTART DATETIME NULL ,
	FYEND DATETIME NULL ,
	UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),
	EDT DATETIME NULL ,
	DDDT DATETIME NULL ,
	VNO VARCHAR (12) NULL ,
	VTYP SMALLINT NULL ,
	ACNAME VARCHAR (100) NULL ,
	COSTCODE SMALLINT NULL,
	BANKCOST SMALLINT NULL,
	LNO SMALLINT NOT NULL DEFAULT(0),
	BANKNAME VARCHAR(100) NULL,
	MICRNO INT NULL,
	BOOKTYPE VARCHAR(2) NULL,
) ON [PRIMARY]

INSERT INTO
 #RECPAY_TABLE
 (
  TRANSACTION_ID,
  SERIAL_NO,
  EDATE,
  VOUCHER_DATE,
  CLIENT_CODE,
  AMOUNT,
  DRCR,
  NARRATION,
  BANK_CODE,
  BANK_NAME,
  REF_NO,
  BRANCHCODE,
  BRANCH_NAME,
  CHQ_MODE,
  CHQ_DATE,
  CHQ_NAME,
  CL_MODE
 )
SELECT
 TRANSACTION_ID,
 SERIAL_NO,
 EDATE,
 VOUCHER_DATE,
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),
 AMOUNT,
 UPPER(LTRIM(RTRIM(DRCR))),
 NARRATION,
 UPPER(LTRIM(RTRIM(BANK_CODE))),
 UPPER(LTRIM(RTRIM(BANK_NAME))),
 REF_NO,
 UPPER(LTRIM(RTRIM(BRANCHCODE))),
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),
 UPPER(LTRIM(RTRIM(CHQ_MODE))),
 CHQ_DATE,
 CHQ_NAME,
 CL_MODE
FROM
 #RECPAY_TABLE_TMP

UPDATE
 #RECPAY_TABLE
SET
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))


SELECT TOP 1
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)
FROM
 #RECPAY_TABLE


SELECT
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
 @@BRANCHFLAG = BRANCHFLAG,
 @@VNOFLAG = VNOFLAG
FROM
 PARAMETER
WHERE
 @@VDT BETWEEN SDTCUR AND LDTCUR

 IF @@BRANCHFLAG = 1
 BEGIN
  UPDATE
   #RECPAY_TABLE
  SET
   BRANCHCODE = A.BRANCHCODE,
   FYSTART = P.SDTCUR,
   FYEND = P.LDTCUR,
   UPDFLAG = 'Y',
   ACNAME = A.LONGNAME,
   COSTCODE = C.COSTCODE,
   BANKNAME = B.LONGNAME,
   BOOKTYPE = B.BOOKTYPE,
   MICRNO = ISNULL(B.MICRNO, 0)
  FROM
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B
  WHERE
   A.CLTCODE = CLIENT_CODE
AND B.CLTCODE = BANK_CODE
   AND P.CURYEAR = 1
   AND A.ACCAT IN ('3','4','18')
   AND B.ACCAT = '2'
   AND A.BRANCHCODE = COSTNAME

  UPDATE
   #RECPAY_TABLE
  SET
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
   FYSTART = P.SDTCUR,
   FYEND = P.LDTCUR,
   UPDFLAG = 'Y',
   ACNAME = A.LONGNAME,
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,
   BANKNAME = B.LONGNAME,
   BOOKTYPE = B.BOOKTYPE,
   MICRNO = ISNULL(B.MICRNO, 0)
  FROM
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B
  WHERE
   A.CLTCODE = CLIENT_CODE
   AND B.CLTCODE = BANK_CODE
   AND P.CURYEAR = 1
   AND A.ACCAT IN ('3','4','18')
   AND B.ACCAT = '2'
   AND A.BRANCHCODE = 'ALL'
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'

  UPDATE
   #RECPAY_TABLE
  SET
   BRANCHCODE = 'HO',
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
   FYSTART = P.SDTCUR,
   FYEND = P.LDTCUR,
   UPDFLAG = 'Y',
   ACNAME = A.LONGNAME,
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,
   BANKNAME = B.LONGNAME,
   BOOKTYPE = B.BOOKTYPE,
   MICRNO = ISNULL(B.MICRNO, 0)
  FROM
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B
  WHERE
   A.CLTCODE = CLIENT_CODE
   AND B.CLTCODE = BANK_CODE
   AND P.CURYEAR = 1
   AND A.ACCAT IN ('3','4','18')
   AND B.ACCAT = '2'
   AND A.BRANCHCODE = 'ALL'
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'
 END
ELSE
 BEGIN
  UPDATE
   #RECPAY_TABLE
  SET
   FYSTART = @@STD_DATE,
   FYEND = @@LST_DATE + ' 23:59:59',
   UPDFLAG = 'Y',
   ACNAME = A.LONGNAME,
   BANKNAME = B.LONGNAME,
   BOOKTYPE = B.BOOKTYPE,
   MICRNO = ISNULL(B.MICRNO, 0)
  FROM
   ACMAST A, ACMAST B
  WHERE
   A.CLTCODE = CLIENT_CODE
   AND B.CLTCODE = BANK_CODE
   AND A.ACCAT IN ('3','4','18')
   AND B.ACCAT = '2'
 END


 UPDATE R
  SET VTYP =
 CASE WHEN AMOUNT1 > 0 THEN 3 ELSE 2 END
 FROM (SELECT AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), SERIAL_NO FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1, #RECPAY_TABLE R
 WHERE R.SERIAL_NO = R1.SERIAL_NO
 
 SELECT @@VTYP = VTYP FROM #RECPAY_TABLE


/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/
SELECT
	@@ERROR_COUNT = COUNT(1)
FROM
	#RECPAY_TABLE
WHERE
	VDT > EDT

IF @@ERROR_COUNT > 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END

/*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/
IF @AMOUNT <= 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END

/*--------------------------VALIDATION FOR DUPLICATE CHEQUE NUMBER ------------------------*/
SELECT
@@ERROR_COUNT = COUNT(1)
FROM
(
	SELECT DISTINCT
		DDNO  = RP.REF_NO
	FROM
		#RECPAY_TABLE RP,
		LEDGER1 L1  WITH(NOLOCK)
	WHERE
		L1.DDNO = RP.REF_NO
		AND L1.DD = RP.CHQ_MODE
		AND L1.DRCR = @DRCR
		AND L1.VTYP = @@VTYP
		AND RP.REF_NO <> '0'
		AND ISNUMERIC(RP.REF_NO) = 1
) A


IF @@ERROR_COUNT > 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CHEQUE NUMBER ALREADY EXISTS', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CHEQUE NUMBER ALREADY EXISTS' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END

/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/
SELECT
 @@ERROR_COUNT = COUNT(1)
FROM
 (
  SELECT DISTINCT
   CLIENT_CODE
  FROM
   #RECPAY_TABLE
  WHERE
   UPDFLAG = 'N'
 ) A
IF @@ERROR_COUNT > 0
 BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS DO NOT EXIST', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS DO NOT EXIST' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
 END


---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------
	UPDATE
		#RECPAY_TABLE
		SET UPDFLAG = 'N'
	FROM ( SELECT
		PARTY_CODE,
		INACTIVEFROM
	FROM MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK),
		MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)
	WHERE C2.CL_CODE = C5.CL_CODE
		AND C2.PARTY_CODE IN (SELECT CLIENT_CODE FROM #RECPAY_TABLE)
		AND INACTIVEFROM <= GETDATE()) C
	WHERE CLIENT_CODE = C.PARTY_CODE


SELECT
 @@ERROR_COUNT = COUNT(1)
FROM
 (
  SELECT DISTINCT
   CLIENT_CODE
  FROM
   #RECPAY_TABLE
  WHERE
   UPDFLAG = 'N'
 ) A
IF @@ERROR_COUNT > 0
 BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS IS INACTIVE', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS IS INACTIVE' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
 END

 SELECT @@BOOKTYPE = BOOKTYPE FROM ACMAST WHERE CLTCODE = @BANK_CODE


SELECT
	@@BACKDAYS = ISNULL(MAX(NODAYS), 0)
FROM
	USERWRITESTABLE
WHERE
	USERCATEGORY = @USERCAT
	AND VTYP = @@VTYP
	AND BOOKTYPE = @@BOOKTYPE

SELECT
	@@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS

SELECT
	@@ERROR_COUNT = ISNULL(COUNT(VDT), 0)
FROM
	#RECPAY_TABLE
WHERE
	VDT < @@BACKDATE

IF @@ERROR_COUNT > 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END


CREATE TABLE #BANK_VNO
(
	SRNO INT,
	NEWSRNO INT IDENTITY (1, 1)
)

INSERT INTO
	#BANK_VNO
SELECT
	DISTINCT SERIAL_NO
FROM
	#RECPAY_TABLE

SELECT
	@@MAXCOUNT = COUNT(DISTINCT SNO)
FROM
	#RECPAY_TABLE

SELECT TOP 1
	@@VDT = VDT
FROM
	#RECPAY_TABLE

SELECT
	LASTVNO
INTO
	#VNO
FROM
	LASTVNO
WHERE
	1 = 2

SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO

INSERT
	INTO #VNO
EXEC ACC_GENVNO_NEW
	@@VDT,
	@@VTYP,
	@@BOOKTYPE,
	@@STD_DATE,
	@@LST_DATE,
	@@MAXVNO

SELECT
	@@NEWVNO = LASTVNO
FROM
	#VNO

UPDATE
	RP
SET
	VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))
FROM
	#RECPAY_TABLE RP,
	#BANK_VNO BV
WHERE
	RP.SERIAL_NO = BV.SRNO

DROP TABLE #VNO
DROP TABLE #BANK_VNO

/*   --------------------------AUTO GENERATION OF LNO ------------------------ */
UPDATE
	#RECPAY_TABLE
SET
	LNO = 2
WHERE
	VNO IN
	(
		SELECT
		VNO
		FROM
		#RECPAY_TABLE
		WITH(NOLOCK)
		GROUP BY
		VNO
		HAVING
		COUNT(*) = 1
	)


INSERT INTO
 LEDGER1
  (
   BNKNAME,
   BRNNAME,
   DD,
   DDNO,
   DDDT,
   RELDT,
   RELAMT,
   REFNO,
   RECEIPTNO,
   VTYP,
   VNO,
   LNO,
   DRCR,
   BOOKTYPE,
   MICRNO,
   SLIPNO,
   SLIPDATE,
   CHEQUEINNAME,
   CHQPRINTED,
   CLEAR_MODE
  )
SELECT
 BNKNAME = MAX(BANK_NAME),
 BRNNAME = MAX(BRANCH_NAME),
 DD = MAX(CHQ_MODE),
 DDNO = MAX(REF_NO),
 DDDT = MAX(DDDT),
 RELDT = '',
 RELAMT = ABS(SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)),
 REFNO = 0,
 RECEIPTNO = 0,
 VTYP,
 VNO,
 LNO = 2,
 @DRCR,
 BOOKTYPE = BOOKTYPE,
 MICRNO = MICRNO,
 SLIPNO = 0,
 SLIPDATE = '',
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),
 CHQPRINTED = 0,
 CLEAR_MODE = MAX(CL_MODE)
FROM
 #RECPAY_TABLE
GROUP BY
 VTYP,
 VNO,
 BOOKTYPE,
 MICRNO


 CREATE TABLE #LEDGER
(
 VTYP SMALLINT,
 VNO VARCHAR(12),
 EDT DATETIME,
 LNO SMALLINT,
 ACNAME VARCHAR(100),
 DRCR VARCHAR(1),
 VAMT MONEY,
 VDT DATETIME,
 VNO1 VARCHAR(12),
 REFNO CHAR(12),
 BALAMT MONEY,
 NODAYS INT,
 CDT DATETIME,
 CLTCODE VARCHAR(10),
 BOOKTYPE VARCHAR(2),
 ENTEREDBY VARCHAR(25),
 PDT DATETIME,
 CHECKEDBY VARCHAR(25),
 ACTNODAYS INT,
 NARRATION VARCHAR(234)
)    --SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0
CREATE TABLE #LEDGER3
(
 NARATNO INT,
 NARR VARCHAR(234),
 REFNO CHAR(12),
 VTYP SMALLINT,
 VNO VARCHAR(12),
 BOOKTYPE VARCHAR(2)
)
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0
/*==============================
CLIENT SIDE RECORD
==============================*/
INSERT INTO
 #LEDGER
 (
  VTYP,
  VNO,
  EDT,
  LNO,
  ACNAME,
  DRCR,
  VAMT,
  VDT,
  VNO1,
  REFNO,
  BALAMT,
  NODAYS,
  CDT,
  CLTCODE,
  BOOKTYPE,
  ENTEREDBY,
  PDT,
  CHECKEDBY,
  ACTNODAYS,
  NARRATION
 )
SELECT
 VTYP,
 VNO,
 EDT = edt,--(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),
 LNO,
 ACNAME,
 DRCR,
 VAMT = AMOUNT,
 VDT,
 VNO1 = VNO,
 REFNO = 0,
 BALAMT = AMOUNT,
 NODAYS = 0,
 CDT = GETDATE(),
 CLTCODE = CLIENT_CODE,
 BOOKTYPE = BOOKTYPE,
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),
 PDT = GETDATE(),
 CHECKEDBY = @UNAME,
 ACTNODAYS = 0,
 NARRATION
FROM
 #RECPAY_TABLE
/*==============================
BANK SIDE RECORD
==============================*/
INSERT INTO
 #LEDGER
SELECT  DISTINCT
 VTYP,
 VNO,
 EDT = edt, --(CASE WHEN VTYP = 2 THEN 'DEC 31 2049' ELSE EDT END),
 LNO = 1,
 BANKNAME,
 MAX(DRCR1),
 VAMT = ABS(MAX(AMOUNT1)),
 VDT,
 VNO1 = VNO,
 REFNO = 0,
 BALAMT = ABS(MAX(AMOUNT1)),
 NODAYS = 0,
 CDT = GETDATE(),
 CLTCODE = BANK_CODE,
 BOOKTYPE = BOOKTYPE,
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),
 PDT = GETDATE(),
 CHECKEDBY = @UNAME,
 ACTNODAYS = 0,
 NARRATION = NARRATION_FIN
FROM
 #RECPAY_TABLE R, (SELECT SERIAL_NO, AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), DRCR1 = CASE WHEN SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 'C' ELSE 'D' END, NARRATION_FIN = MAX(NARRATION) FROM #RECPAY_TABLE GROUP 
BY SERIAL_NO) R1
WHERE R.SERIAL_NO = R1.SERIAL_NO
GROUP BY
 VTYP,
 VNO,
 EDT,
 VDT,
 BANK_CODE,
 BOOKTYPE,
 BANKNAME,
 LNO,
 NARRATION_FIN
/*==============================
INSERTING ALL LEDGER RECORDS AT ONE TIME
==============================*/

INSERT INTO LEDGER  SELECT
 Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration
FROM
 #LEDGER
ORDER BY
 BOOKTYPE,
 VTYP,
 VNO,
 LNO


           INSERT INTO
 #LEDGER3
SELECT
 NARATNO = 1,
 NARRATION = MAX(NARRATION),
 REFNO = 0,
 VTYP,
 VNO,
 BOOKTYPE
FROM
 #RECPAY_TABLE
GROUP BY
 VTYP,
 VNO,
 BOOKTYPE
/*==============================
CLIENT SIDE RECORD
==============================*/
INSERT INTO
 #LEDGER3
SELECT
 NARATNO = LNO,
 NARR = NARRATION,
 REFNO = 0,
 VTYP,
 VNO,
 BOOKTYPE
FROM
 #RECPAY_TABLE

 /*==============================
INSERTING ALL LEDGER3 RECORDS AT ONE TIME
==============================*/
INSERT INTO LEDGER3
SELECT
 *
FROM
 #LEDGER3
ORDER BY
 BOOKTYPE,
 VTYP,
 VNO,
 NARATNO
 
SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
SET @@SQL = @@SQL + " SELECT POST_STATUS = 'SUCCESS', EXECUTION_REMARK = VNO + '|' + CONVERT(VARCHAR, " + CONVERT(VARCHAR, @@VTYP) + ") + '|' + BOOKTYPE + '|' + CLIENT_CODE + '|' + BANK_CODE + '|' + CONVERT(VARCHAR, AMOUNT), '" + @UNAME + "' FROM #RECPAY_TABLE"
EXEC(@@SQL)

/*UPDATE RD SET POST_STATUS = 'SUCCESS', EXECUTION_REMARK = VNO 
FROM APIDETAILS..API_PAYMENT_DETAILS RD, #RECPAY_TABLE R
WHERE RD.TRANSACTION_ID = R.TRANSACTION_ID
AND RD.TRANSACTION_ID = @TRANSACTION_ID
AND  ISNULL(POST_STATUS, '') = ''*/

DROP TABLE #RECPAY_TABLE_TMP
DROP TABLE #RECPAY_TABLE
--COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECEIPT_DATA
-- --------------------------------------------------
CREATE PROC [DBO].[RECEIPT_DATA]                
(                
  @FROMDATE VARCHAR(11),                
  @TODATE VARCHAR(11)             
 )                         
 AS                
 BEGIN                
 SELECT DISTINCT                
 [CLTCODE] = A.CLTCODE,                
 [SHORT_NAME]= B.SHORT_NAME,                
 [REGION] = B.REGION,                
 [BRANCH] = B.BRANCH_CD,                
 [SUBBROKER] = B.SUB_BROKER,                
 [VDATE] = A.VDT,                
 [V_NO] = A.VNO,                
 [NARRATION] = A.NARRATION,                
 [VAMT] = A.VAMT,                
 [DDNO] = C.DDNO,                
 [VTYP] = A.VTYP,                
 [BANKNAME] = B.BANK_NAME,                
 [ACNUM] = B.AC_NUM,                
 [RELDT] = C.RELDT,          
 [BOOKTYPE] = A.BOOKTYPE                 
INTO  #TEMP2                  
 FROM                
 [196.1.115.204].ACCOUNTNCDX.DBO.LEDGER A,                
 [196.1.115.196].MSAJAG.DBO.CLIENT_DETAILS B,                
 [196.1.115.204].ACCOUNTNCDX.DBO.LEDGER1 C                
 WHERE A.VTYP='2' AND A.VDT >= @FROMDATE AND A.VDT < =@TODATE + ' 23:59:59'                  
 AND ISNUMERIC(A.CLTCODE)  ='0' AND A.CLTCODE = B.CL_CODE AND  A.VTYP = C.VTYP AND A.VNO = C.VNO                
 AND A.CLTCODE IN (SELECT CLTCODE FROM [196.1.115.204].ACCOUNTNCDX.DBO.ACMAST WHERE ACCAT=4) AND A.BOOKTYPE=C.BOOKTYPE           
 ORDER BY A.CLTCODE                
                
 SELECT                
 [CLTCODE] = CLTCODE,                
 [ACNAME]= ACNAME,                
 [VNO] = VNO,                
 [DRCR] = DRCR,BOOKTYPE                  
 INTO #TEMP3                
 FROM LEDGER(NOLOCK) D                
 WHERE                 
 D.VTYP='2' AND D.VDT >= @FROMDATE AND D.VDT <=@TODATE + ' 23:59:59'                
 AND D.VNO IN (SELECT V_NO FROM #TEMP2(NOLOCK))                
                
 SELECT B.CLTCODE,B.ACNAME,A.REGION,A.BRANCH,A.SUBBROKER,A.VDATE,A.V_NO,A.VAMT,B.DRCR,A.DDNO,A.NARRATION,A.RELDT,A.BANKNAME,A.ACNUM,A.BOOKTYPE,                
 'NCDX' AS EXCHANGE                
 FROM #TEMP2(NOLOCK) A INNER JOIN #TEMP3(NOLOCK) B ON A.V_NO=B.VNO   AND A.BOOKTYPE=B.BOOKTYPE  AND A.VTYP =2         
 ORDER BY A.V_NO               
                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECEIPT_DATA_REVISED
-- --------------------------------------------------
CREATE PROC RECEIPT_DATA_REVISED             
(            
@FROMDATE datetime ,            
@TODATE   datetime       
          
)            
AS             
BEGIN             
SELECT  * INTO #TEMP FROM (            
SELECT            
           
[CLTCODE]=CLTCODE,            
[VDT]    =L.VDT,            
[VNO]    =L.VNO,  
[NARRATION]=L.NARRATION,            
[VAMT]   =L.VAMT,            
[DRCR]   =L.DRCR,            
[DDNO]   =L1.DDNO,            
[VTYP]   =L.VTYP,            
[RELDT]  =L1.RELDT,            
[BOOKTYPE]=L.BOOKTYPE            
    
FROM LEDGER L (NOLOCK) , LEDGER1 L1 (NOLOCK)            
WHERE L.VNO=L1.VNO AND L.VTYP=L1.VTYP AND L.BOOKTYPE=L1.BOOKTYPE     
AND L.DRCR ='D' AND L.VTYP =2 AND L.VDT >= @FROMDATE AND L.VDT < =@TODATE + ' 23:59:59.999'     
    
UNION ALL            
            
SELECT CLTCODE,L.VDT,L.VNO,L.NARRATION,L.VAMT,L.DRCR,L1.DDNO,            
 L.VTYP,L1.RELDT,L.BOOKTYPE            
 FROM LEDGER L(NOLOCK), LEDGER1 L1 (NOLOCK)            
WHERE L.VNO=L1.VNO AND L.VTYP=L1.VTYP AND L.BOOKTYPE=L1.BOOKTYPE            
AND L.DRCR ='C' AND L.VTYP =2  AND L.VDT >=@FROMDATE AND L.VDT < =@TODATE + ' 23:59:59.999'       
  )A            
            
SELECT            
A.*,            
[SHORT_NAME]=B.SHORT_NAME,            
[REGION]=B.REGION,            
[BRANCH_CD]=B.BRANCH_CD,            
[SUB_BROKER]=B.SUB_BROKER,            
[BANK_NAME]=B.BANK_NAME,            
[AC_NUM]=B.AC_NUM ,  
[EXCHANGE]='NCDX'           
            
            
FROM   #TEMP A LEFT OUTER JOIN            
MSAJAG.DBO.CLIENT_DETAILS B ON A.CLTCODE = B.CL_CODE             
 END            
             
             
 ---EXEC RECEIPT_DATA_REVISED 'MAY 10 2015','MAY 21 2015'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecMsett
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.RecMsett    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE RecMsett 
@stdate varchar(12),
@eddate varchar(12)
AS
SELECT DISTINCT convert(varchar,s.sauda_date,103), 
BOKERAGE = isnull(SUM(s.TRADEQTY*s.BROKAPPLIED),0), 
DELCHRG =  isnull(SUM(s.TRADEQTY*(s.NBROKAPP - s.BROKAPPLIED)),0), 
SERVICE_TAX = isnull(SUM(s.NSERTAX),0)  
FROM ncdx.dbo.SETTLEMENT s, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 Where  c2.Party_Code = s.Party_Code And 
c1.cl_code = c2.cl_code and  s. Sauda_date  >=@stdate  and s.sauda_date < @eddate    and s.sett_type ='M'
group by convert(varchar,s.sauda_date,103) 
Union  
SELECT DISTINCT convert(varchar,h.sauda_date,103),  
BOKERAGE = isnull(SUM(TRADEQTY*BROKAPPLIED),0),  
DELCHRG =  isnull(SUM(TRADEQTY*(NBROKAPP - BROKAPPLIED)),0),  
SERVICE_TAX = isnull(SUM(NSERTAX),0)  FROM ncdx.dbo.history h, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
Where  c2.Party_Code = h.Party_Code And c1.cl_code = c2.cl_code and  h. Sauda_date  >= @stdate
and h.sauda_date < @eddate    and h.sett_type ='M'
group by convert(varchar,h.sauda_date,103)  
order by convert(varchar,sauda_date,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecMsettED
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.RecMsettED    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE RecMsettED
@stdate varchar(12),
@eddate varchar(12)
AS
SELECT DISTINCT convert(varchar,s.sauda_date,103), 
BOKERAGE = isnull(SUM(s.TRADEQTY*s.BROKAPPLIED),0), 
DELCHRG =  isnull(SUM(s.TRADEQTY*(s.NBROKAPP - s.BROKAPPLIED)),0), 
SERVICE_TAX = isnull(SUM(s.NSERTAX),0)  
FROM ncdx.dbo.SETTLEMENT s, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 Where  c2.Party_Code = s.Party_Code And 
c1.cl_code = c2.cl_code and  s. Sauda_date  >=@stdate  and s.sauda_date <=  @eddate    and s.sett_type ='M'
group by convert(varchar,s.sauda_date,103) 
Union  
SELECT DISTINCT convert(varchar,h.sauda_date,103),  
BOKERAGE = isnull(SUM(TRADEQTY*BROKAPPLIED),0),  
DELCHRG =  isnull(SUM(TRADEQTY*(NBROKAPP - BROKAPPLIED)),0),  
SERVICE_TAX = isnull(SUM(NSERTAX),0)  FROM ncdx.dbo.history h, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
Where  c2.Party_Code = h.Party_Code And c1.cl_code = c2.cl_code and  h. Sauda_date  >= @stdate
and h.sauda_date <= @eddate    and h.sett_type ='M'
group by convert(varchar,h.sauda_date,103)  
order by convert(varchar,sauda_date,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecNsett
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.RecNsett    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE RecNsett 
@stdate varchar(12),
@eddate varchar(12)
AS
SELECT DISTINCT convert(varchar,s.sauda_date,103), 
BOKERAGE = isnull(SUM(s.TRADEQTY*s.BROKAPPLIED),0), 
DELCHRG =  isnull(SUM(s.TRADEQTY*(s.NBROKAPP - s.BROKAPPLIED)),0), 
SERVICE_TAX = isnull(SUM(s.NSERTAX),0)  
FROM ncdx.dbo.SETTLEMENT s, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 Where  c2.Party_Code = s.Party_Code And 
c1.cl_code = c2.cl_code and  s. Sauda_date  >=@stdate  and s.sauda_date < @eddate    and s.sett_type ='N'
group by convert(varchar,s.sauda_date,103) 
Union  
SELECT DISTINCT convert(varchar,h.sauda_date,103),  
BOKERAGE = isnull(SUM(TRADEQTY*BROKAPPLIED),0),  
DELCHRG =  isnull(SUM(TRADEQTY*(NBROKAPP - BROKAPPLIED)),0),  
SERVICE_TAX = isnull(SUM(NSERTAX),0)  FROM ncdx.dbo.history h, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
Where  c2.Party_Code = h.Party_Code And c1.cl_code = c2.cl_code and  h. Sauda_date  >= @stdate
and h.sauda_date < @eddate    and h.sett_type ='N'
group by convert(varchar,h.sauda_date,103)  
order by convert(varchar,sauda_date,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecNsettED
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.RecNsettED    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE RecNsettED 
@stdate varchar(12),
@eddate varchar(12)
AS
SELECT DISTINCT convert(varchar,s.sauda_date,103), 
BOKERAGE = isnull(SUM(s.TRADEQTY*s.BROKAPPLIED),0), 
DELCHRG =  isnull(SUM(s.TRADEQTY*(s.NBROKAPP - s.BROKAPPLIED)),0), 
SERVICE_TAX = isnull(SUM(s.NSERTAX),0)  
FROM ncdx.dbo.SETTLEMENT s, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 Where  c2.Party_Code = s.Party_Code And 
c1.cl_code = c2.cl_code and  s. Sauda_date  >=@stdate  and s.sauda_date <= @eddate    and s.sett_type ='M'
group by convert(varchar,s.sauda_date,103) 
Union  
SELECT DISTINCT convert(varchar,h.sauda_date,103),  
BOKERAGE = isnull(SUM(TRADEQTY*BROKAPPLIED),0),  
DELCHRG =  isnull(SUM(TRADEQTY*(NBROKAPP - BROKAPPLIED)),0),  
SERVICE_TAX = isnull(SUM(NSERTAX),0)  FROM ncdx.dbo.history h, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
Where  c2.Party_Code = h.Party_Code And c1.cl_code = c2.cl_code and  h. Sauda_date  >= @stdate
and h.sauda_date <= @eddate    and h.sett_type ='M'
group by convert(varchar,h.sauda_date,103)  
order by convert(varchar,sauda_date,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Reconcile
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 09/20/2002 12:04:51 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 07/18/2002 2:09:04 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 04/17/2002 11:47:39 AM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 12/13/2001 1:36:49 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 08/24/2001 6:53:38 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.Reconcile    Script Date: 20-Mar-01 11:43:34 PM ******/
/* Modified by VNS on 19-07-2001 for adding condition on vdt as ( vdt >= sdtcur ). sdtcur is the start date of current financial year from parameter */
/* Modified by VNS on 18-07-2002 for adding booktype condition for l.vno in condition.  seprate condition for booktype removed. */
CREATE  PROCEDURE  Reconcile  
@code varchar(10)
,@gdate varchar(11)
,@gdrcr  varchar(1)
,@flag varchar(1)
,@tVamt    numeric(17,2)
AS
	if @flag=1 
	begin
		select  isnull(sum(vamt) ,0) ,drcr from ledger, parameter
		where cltcode =    @code    and   vdt >= sdtcur and vdt <= @gdate  + ' 23:59:59' and curyear = 1
		group by drcr
		order  by drcr
	end
	
	if @flag=2
	begin
		if @tvamt =  0  
		begin
			select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),
			vno=l.vno, drcr=l.drcr ,lno=l.lno, vtyp=l.vtyp,booktype = l.booktype,chequeno=isnull(ddno,''), amt= ll1.relamt 
			From ledger l  ,LEDGER1 ll1
			WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code
			and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno = l.lno and ll1.drcr=l.drcr and  ll1.booktype = l.booktype 
			and l.vno in  (select vno from ledger l1 where cltcode =@code   and l.vtyp=l1.vtyp and l.booktype = l1.booktype)
			and  ( reldt ='1900-01-01 00:00:00.000'   or   reldt > @gdate + ' 23:59:59') and  vdt < =  @gdate + ' 23:59:59'   and   l.drcr like  @gdrcr  
/*			and l.booktype = (select booktype from acmast where cltcode = @code) */
			order by  convert(varchar,l.vdt,101) ,l.vtyp,l.vno,l.drcr
		end
		if  @tvamt <>0
		begin
			select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , acname=isnull( acname ,''),
			vno=l.vno, drcr=l.drcr ,lno=l.lno,vtyp=l.vtyp,booktype = l.booktype, chequeno=isnull(ddno,''), amt= ll1.relamt 
			From ledger l  ,LEDGER1 LL1
			WHERE   l.vtyp in ('2','3','5','16','17','19','20' ) and cltcode <>@code
			and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.lno = l.lno and ll1.drcr=l.drcr and   ll1.booktype = l.booktype
			and l.vno in (select vno from ledger l1 where cltcode =@code   and l.vtyp=l1.vtyp and l.booktype = l1.booktype ) 
			and ( reldt ='1900-01-01 00:00:00.000'   or   reldt > @gdate + ' 23:59:59') and vdt < =  @gdate + ' 23:59:59'   and   l.drcr like  @gdrcr 
/*			and l.booktype = (select booktype from acmast where cltcode = @code)  */
			and  vamt = @tVamt  
			order by   convert(varchar,l.vdt,101)  ,l.vtyp,l.vno,l.drcr
		end
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecOsett
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.RecOsett    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE RecOsett 
@stdate varchar(12),
@eddate varchar(12)
AS
SELECT DISTINCT convert(varchar,s.sauda_date,103), 
BOKERAGE = isnull(SUM(s.TRADEQTY*s.BROKAPPLIED),0), 
DELCHRG =  isnull(SUM(s.TRADEQTY*(s.NBROKAPP - s.BROKAPPLIED)),0), 
SERVICE_TAX = isnull(SUM(s.NSERTAX),0)  
FROM ncdx.dbo.SETTLEMENT s, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 Where  c2.Party_Code = s.Party_Code And 
c1.cl_code = c2.cl_code and  s. Sauda_date  >=@stdate  and s.sauda_date < @eddate    and s.sett_type ='O'
group by convert(varchar,s.sauda_date,103) 
Union  
SELECT DISTINCT convert(varchar,h.sauda_date,103),  
BOKERAGE = isnull(SUM(TRADEQTY*BROKAPPLIED),0),  
DELCHRG =  isnull(SUM(TRADEQTY*(NBROKAPP - BROKAPPLIED)),0),  
SERVICE_TAX = isnull(SUM(NSERTAX),0)  FROM ncdx.dbo.history h, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
Where  c2.Party_Code = h.Party_Code And c1.cl_code = c2.cl_code and  h. Sauda_date  >= @stdate
and h.sauda_date < @eddate    and h.sett_type ='O'
group by convert(varchar,h.sauda_date,103)  
order by convert(varchar,sauda_date,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecOsettED
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 01/04/1980 1:40:38 AM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 11/28/2001 12:23:45 PM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 7/8/01 3:22:49 PM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.RecOsettED    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE RecOsettED
@stdate varchar(12),
@eddate varchar(12)
AS
SELECT DISTINCT convert(varchar,s.sauda_date,103), 
BOKERAGE = isnull(SUM(s.TRADEQTY*s.BROKAPPLIED),0), 
DELCHRG =  isnull(SUM(s.TRADEQTY*(s.NBROKAPP - s.BROKAPPLIED)),0), 
SERVICE_TAX = isnull(SUM(s.NSERTAX),0)  
FROM ncdx.dbo.SETTLEMENT s, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 Where  c2.Party_Code = s.Party_Code And 
c1.cl_code = c2.cl_code and  s. Sauda_date  >=@stdate  and s.sauda_date <= @eddate    and s.sett_type ='M'
group by convert(varchar,s.sauda_date,103) 
Union  
SELECT DISTINCT convert(varchar,h.sauda_date,103),  
BOKERAGE = isnull(SUM(TRADEQTY*BROKAPPLIED),0),  
DELCHRG =  isnull(SUM(TRADEQTY*(NBROKAPP - BROKAPPLIED)),0),  
SERVICE_TAX = isnull(SUM(NSERTAX),0)  FROM ncdx.dbo.history h, ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
Where  c2.Party_Code = h.Party_Code And c1.cl_code = c2.cl_code and  h. Sauda_date  >= @stdate
and h.sauda_date <= @eddate    and h.sett_type ='M'
group by convert(varchar,h.sauda_date,103)  
order by convert(varchar,sauda_date,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK]      
 @FNAME VARCHAR(100),      
 @UNAME VARCHAR(25),      
 @USERCAT SMALLINT      
      
AS      
/*      
begin tran      
SP_HELPTRIGGER LEDGER      
LEDGER_TRG_BILL      
LEDGER_TRG      
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388      
SELECT TOP 1 * FROM LEDGER3      
SELECT TOP 1 * FROM LEDGER_TRG      
ROLLBACK      
*/      
SET NOCOUNT ON      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@STD_DATE VARCHAR(11),      
 @@LST_DATE VARCHAR(11),      
 @@BRANCHFLAG AS TINYINT,      
 @@VNOFLAG AS TINYINT,      
 @@VNOMETHOD INT,      
 @@ACNAME CHAR(100),      
 @@BOOKTYPE CHAR(2),      
 @@MICRNO VARCHAR(10),      
 @@DRCR VARCHAR(1),      
 @@VTYP SMALLINT,      
 @@BANK_CODE VARCHAR(100),      
 @@BACKDAYS INT,      
 @@BACKDATE VARCHAR(11),      
 @@BRNCOUNT   TINYINT,      
 @@MonthlyVdt VARCHAR(11),      
 @@SERIAL_NO INT,      
 @@COSTCODECOUNT TINYINT,      
 @@COSTCODEUPDATES CURSOR,      
 @@NEWVNO AS VARCHAR(12),      
 @@MAXCOUNT AS INT,      
 @@VDT AS VARCHAR(11),      
 @@BANKBRANCH AS VARCHAR(10),      
 @@BANKCOST AS NUMERIC,      
 @@LNOCUR AS CURSOR,      
 @@VNOCUR AS CURSOR,      
 @@LNOVNO AS VARCHAR(12),      
 @@MAXVNO AS INT,      
 @@L2CUR AS CURSOR,      
 @@L2VNO AS VARCHAR(12),      
 @@ERROR_COUNT AS INT,      
 @@FILEEXISTS AS INT,      
 @@SQL AS VARCHAR(2000)      
      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'      
  RETURN      
 END      
CREATE TABLE #FEXIST      
(      
 F1 SMALLINT,      
 F2 SMALLINT,      
 F3 SMALLINT      
)      
SELECT @@SQL = "INSERT INTO "      
SELECT @@SQL = @@SQL + " #FEXIST "      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "      
      
EXEC(@@SQL)      
      
SELECT      
 @@FILEEXISTS = F1      
FROM      
 #FEXIST      
      
IF @@FILEEXISTS = 0      
 BEGIN      
  DROP TABLE #FEXIST      
  SELECT      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'      
  RETURN      
 END      
DROP TABLE #FEXIST      
      
BEGIN TRAN      
CREATE TABLE #RECPAY_TABLE_TMP      
(      
 SERIAL_NO INT,      
 EDATE VARCHAR(20),      
 VOUCHER_DATE VARCHAR(20),      
 CLIENT_CODE VARCHAR(50),      
 AMOUNT MONEY,      
 DRCR VARCHAR(1),      
 NARRATION VARCHAR(234),      
 BANK_CODE VARCHAR(10),      
 BANK_NAME VARCHAR(100),      
 REF_NO VARCHAR(15),      
 BRANCHCODE VARCHAR(20),      
 BRANCH_NAME VARCHAR(50),      
 CHQ_MODE VARCHAR(1),      
 CHQ_DATE VARCHAR(20),      
 CHQ_NAME VARCHAR(100),      
 CL_MODE VARCHAR(1)      
)      
CREATE TABLE [#RECPAY_TABLE]      
 (      
  SERIAL_NO INT,      
  EDATE VARCHAR(20),      
  VOUCHER_DATE VARCHAR(20),      
  CLIENT_CODE VARCHAR(50),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  NARRATION VARCHAR(234),      
  BANK_CODE VARCHAR(10),      
  BANK_NAME VARCHAR(100),      
  REF_NO VARCHAR(15),      
  BRANCHCODE VARCHAR(20),      
  BRANCH_NAME VARCHAR(50),      
  CHQ_MODE VARCHAR(1),      
  CHQ_DATE VARCHAR(20),      
  CHQ_NAME VARCHAR(100),      
  CL_MODE VARCHAR(1),      
  SNO INT IDENTITY (1, 1) NOT NULL ,      
  VDT DATETIME NULL ,      
  FYSTART DATETIME NULL ,      
  FYEND DATETIME NULL ,      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),      
  EDT DATETIME NULL ,      
  DDDT DATETIME NULL ,      
  VNO VARCHAR (12) NULL ,      
  VTYP SMALLINT NULL ,      
  ACNAME VARCHAR (100) NULL ,      
  COSTCODE SMALLINT NULL,      
  BANKCOST SMALLINT NULL,      
  LNO SMALLINT NOT NULL DEFAULT(0),      
  BANKNAME VARCHAR(100) NULL,      
  MICRNO INT NULL,      
  BOOKTYPE VARCHAR(2) NULL,      
 ) ON [PRIMARY]      
  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "      
EXEC (@@SQL)      
      
IF @@ERROR <> 0      
 BEGIN      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRANSACTION      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'      
  RETURN      
 END      
INSERT INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FNAME,      
 @FNAME,      
 CNT = COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'RECEIPT/PAYMENT UPLOAD'      
      
INSERT INTO      
 #RECPAY_TABLE      
 (      
  SERIAL_NO,      
  EDATE,      
  VOUCHER_DATE,      
  CLIENT_CODE,      
  AMOUNT,      
  DRCR,      
  NARRATION,      
  BANK_CODE,      
  BANK_NAME,      
  REF_NO,      
  BRANCHCODE,      
  BRANCH_NAME,      
  CHQ_MODE,      
  CHQ_DATE,      
  CHQ_NAME,      
  CL_MODE      
 )      
SELECT      
 SERIAL_NO,      
 EDATE,      
 VOUCHER_DATE,      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),      
 AMOUNT,      
 UPPER(LTRIM(RTRIM(DRCR))),      
 NARRATION,      
 UPPER(LTRIM(RTRIM(BANK_CODE))),      
 UPPER(LTRIM(RTRIM(BANK_NAME))),      
 REF_NO,      
 UPPER(LTRIM(RTRIM(BRANCHCODE))),      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),      
 CHQ_DATE,      
 CHQ_NAME,      
 CL_MODE      
FROM      
 #RECPAY_TABLE_TMP      
      
UPDATE      
 #RECPAY_TABLE      
SET      
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))      
      
      
SELECT      
 @@ERROR_COUNT = COUNT(DISTINCT VDT)      
FROM      
 #RECPAY_TABLE      
      
IF @@ERROR_COUNT > 1      
 BEGIN      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRANSACTION      
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'      
  RETURN      
 END      
      
SELECT TOP 1      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)      
FROM      
 #RECPAY_TABLE      
      
SELECT      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),      
 @@BRANCHFLAG = BRANCHFLAG,      
 @@VNOFLAG = VNOFLAG      
FROM      
 PARAMETER      
WHERE      
 @@VDT BETWEEN SDTCUR AND LDTCUR      
      
IF @@BRANCHFLAG = 1      
 BEGIN      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   BRANCHCODE = A.BRANCHCODE,      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = C.COSTCODE,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = COSTNAME      
        
  UPDATE      
   #RECPAY_TABLE      
  SET      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = 'ALL'      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'      
      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   BRANCHCODE = 'HO',      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,     
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = 'ALL'      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'      
 END      
ELSE      
 BEGIN      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   FYSTART = @@STD_DATE,      
   FYEND = @@LST_DATE + ' 23:59:59',      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
 END      
     

  /*---------------------------------------change by suresh to stop future dated upload --------  */     
    
    
 SELECT            
  @@ERROR_COUNT = COUNT(DISTINCT VDT)            
 FROM    
     
  #RECPAY_TABLE where vdt > getdate()+2 
IF @@ERROR_COUNT >= 1            
  BEGIN            
   SELECT            
    'VOUCHER DATE SHOULD BE CURRENT DATE', 'NA', 'NA'            
   DROP TABLE #RECPAY_TABLE_TMP            
   DROP TABLE #RECPAY_TABLE            
   ROLLBACK TRAN            
   DELETE            
   FROM            
    V2_UPLOADED_FILES            
   WHERE            
    U_FILENAME = @FNAME            
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   RETURN            
  END            
    
    
          
           
   /* ---------------------------------------change by suresh to stop future dated upload -------- */        
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */      
      
 SELECT      
  @@ERROR_COUNT = COUNT(DISTINCT VDT)      
 FROM      
  #RECPAY_TABLE      
 IF @@ERROR_COUNT > 1      
  BEGIN      
   SELECT      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      
 SELECT @@ERROR_COUNT = 0      
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/      
/*      
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)      
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1      
 IF @@ERROR_COUNT > 0      
  BEGIN      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'      
   DROP TABLE #RecPay_Table_Tmp      
   DROP TABLE #RecPay_Table      
   ROLLBACK TRAN      
   DELETE FROM V2_Uploaded_Files      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END*/      
      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */      
 SELECT      
  @@ERROR_COUNT = COUNT(1)      
 FROM      
  (      
   SELECT      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),      
    SERIAL_NO      
   FROM      
    #RECPAY_TABLE      
   GROUP BY      
    SERIAL_NO      
   HAVING      
    COUNT(DISTINCT BANK_CODE) > 1      
  ) A      
 IF @@ERROR_COUNT > 0      
  BEGIN      
   SELECT      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'      
   UNION ALL      
   SELECT      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))      
   FROM      
    #RECPAY_TABLE      
   GROUP BY      
    SERIAL_NO      
   HAVING      
    COUNT(DISTINCT BANK_CODE) > 1      
      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
 SELECT DISTINCT      
  DRCR      
 FROM      
  #RECPAY_TABLE      
 ) A      
IF @@ERROR_COUNT > 1      
 BEGIN      
  SELECT      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
ELSE      
 BEGIN      
  SELECT TOP 1      
   @@DRCR = DRCR,      
   @@VTYP =      
    (      
    CASE      
     WHEN DRCR = 'D'      
     THEN 3      
     ELSE 2      
    END      
    )      
  FROM      
   #RECPAY_TABLE      
  UPDATE      
   #RECPAY_TABLE      
  SET VTYP =      
 (      
    CASE      
     WHEN DRCR = 'D'      
     THEN 3      
     ELSE 2      
    END      
   )      
 END      
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/      
 SELECT @@ERROR_COUNT = COUNT(1)      
 FROM #RECPAY_TABLE      
 WHERE VDT > EDT      
            IF @@ERROR_COUNT > 0      
             BEGIN      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'      
     DROP TABLE #RECPAY_TABLE_TMP      
     DROP TABLE #RECPAY_TABLE      
     ROLLBACK TRAN      
     DELETE FROM      
      V2_UPLOADED_FILES      
     WHERE      
      U_FILENAME = @FNAME      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
     RETURN      
             END      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/      
 SELECT @@ERROR_COUNT = COUNT(1)      
 FROM #RECPAY_TABLE      
 WHERE AMOUNT <= 0      
 IF @@ERROR_COUNT > 0      
  BEGIN      
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'      
     DROP TABLE #RECPAY_TABLE_TMP      
     DROP TABLE #RECPAY_TABLE      
     ROLLBACK TRAN      
     DELETE FROM      
      V2_UPLOADED_FILES      
     WHERE      
      U_FILENAME = @FNAME      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
     RETURN      
  END      
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   DDNO  = RP.REF_NO      
  FROM      
   #RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.BNKNAME = RP.BANK_NAME    
   AND L1.DD = RP.CHQ_MODE      
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.REF_NO <> '0'  
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'      
  UNION ALL      
  SELECT DISTINCT      
   RP.REF_NO, 'NA','NA'      
  FROM      
   #RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.BNKNAME = RP.BANK_NAME    
   AND L1.DD = RP.CHQ_MODE      
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.CHQ_MODE <> 'N'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   CLIENT_CODE      
  FROM      
   #RECPAY_TABLE      
  WHERE      
   UPDFLAG = 'N'      
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'      
  UNION ALL      
  SELECT DISTINCT      
   CLIENT_CODE, 'NA','NA'      
  FROM      
   #RECPAY_TABLE      
  WHERE      
   UPDFLAG = 'N'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */      
  SET @@VNOCUR = CURSOR FOR      
   SELECT DISTINCT      
    BANK_CODE,      
    BOOKTYPE      
   FROM      
    #RECPAY_TABLE WITH(NOLOCK)      
  OPEN @@VNOCUR      
  FETCH NEXT      
   FROM      
    @@VNOCUR      
   INTO      
    @@BANK_CODE,      
    @@BOOKTYPE      
  WHILE @@FETCH_STATUS = 0      
   BEGIN      
  /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/      
    SELECT      
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)      
    FROM      
     USERWRITESTABLE      
    WHERE      
     USERCATEGORY = @USERCAT      
     AND VTYP = @@VTYP      
     AND BOOKTYPE = @@BOOKTYPE      
    SELECT      
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS      
    SELECT      
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)      
    FROM      
     #RECPAY_TABLE      
    WHERE      
     VDT < @@BACKDATE      
    
    IF @@ERROR_COUNT > 0      
     BEGIN      
      SELECT      
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'      
      DROP TABLE #RECPAY_TABLE_TMP      
      DROP TABLE #RECPAY_TABLE      
      ROLLBACK TRAN      
      DELETE FROM V2_UPLOADED_FILES      
      WHERE      
       U_FILENAME = @FNAME      
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
      RETURN      
     END    
      
    IF @@BRANCHFLAG = 1      
     BEGIN      
      SELECT      
       @@BANKBRANCH = BRANCHCODE,      
       @@BANKCOST = ISNULL(C.COSTCODE, -1)      
      FROM      
       ACMAST A      
        LEFT OUTER JOIN      
        COSTMAST C      
        ON      
         (      
          A.BRANCHCODE = C.COSTNAME      
         )      
      WHERE      
       A.CLTCODE = @@BANK_CODE      
      IF @@BANKBRANCH <> 'ALL'      
       BEGIN      
        UPDATE      
         RP      
          SET COSTCODE = @@BANKCOST      
        FROM      
         #RECPAY_TABLE RP,      
         ACMAST A      
        WHERE      
         A.CLTCODE = RP.CLIENT_CODE      
         AND A.BRANCHCODE = 'ALL'      
        UPDATE      
         #RECPAY_TABLE      
          SET BANKCOST = @@BANKCOST      
        WHERE      
         BANK_CODE = @@BANK_CODE      
       END      
      ELSE      
       BEGIN      
        UPDATE      
         #RECPAY_TABLE      
          SET COSTCODE =      
           (      
            SELECT TOP 1      
             COSTCODE      
            FROM      
             COSTMAST      
            WHERE      
             COSTNAME = 'HO'      
           )      
        WHERE      
         COSTCODE = ''      
         AND BANK_CODE = @@BANK_CODE      
                            SET @@COSTCODEUPDATES = CURSOR FOR      
                                       SELECT      
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)      
                                       FROM      
                                             #RECPAY_TABLE WITH(NOLOCK)      
                                       WHERE      
          BANK_CODE = @@BANK_CODE      
                                       GROUP BY      
                                             SERIAL_NO      
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1      
                            OPEN @@COSTCODEUPDATES      
                            FETCH NEXT      
                             FROM      
                              @@COSTCODEUPDATES      
                             INTO      
                              @@SERIAL_NO,      
                              @@COSTCODECOUNT      
                            WHILE @@FETCH_STATUS = 0      
                             BEGIN      
          UPDATE      
           #RECPAY_TABLE      
            SET BANKCOST =      
             (      
              SELECT TOP 1      
               COSTCODE      
              FROM      
               COSTMAST      
              WHERE      
               COSTNAME = 'HO'      
             )      
          WHERE      
           (BANKCOST = ''   OR BANKCOST IS NULL)      
           AND BANK_CODE = @@BANK_CODE      
                                           AND SERIAL_NO = @@SERIAL_NO      
                              FETCH NEXT      
                               FROM      
                                @@COSTCODEUPDATES      
                               INTO      
                                @@SERIAL_NO,      
                                @@COSTCODECOUNT      
                             END      
                            CLOSE @@COSTCODEUPDATES      
                            DEALLOCATE @@COSTCODEUPDATES      
                  UPDATE      
                   #RECPAY_TABLE      
                    SET BANKCOST = COSTCODE      
                  WHERE      
                   BANK_CODE = @@BANK_CODE      
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)      
       END      
     END      
    CREATE TABLE      
     #BANK_VNO      
     (      
      SRNO INT,      
      NEWSRNO INT IDENTITY (1, 1)      
     )      
    INSERT INTO      
     #BANK_VNO      
    SELECT      
     DISTINCT SERIAL_NO      
    FROM      
     #RECPAY_TABLE      
    WHERE      
     BANK_CODE = @@BANK_CODE      
     AND BOOKTYPE = @@BOOKTYPE      
      
    SELECT      
     @@MAXCOUNT = COUNT(DISTINCT SNO)      
    FROM      
     #RECPAY_TABLE      
      
    SELECT TOP 1      
     @@VDT = VDT      
    FROM      
     #RECPAY_TABLE      
    SELECT      
     LASTVNO      
    INTO #VNO      
    FROM      
     LASTVNO      
    WHERE      
     1 = 2      
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO      
    INSERT      
    INTO #VNO      
     EXEC ACC_GENVNO_NEW      
      @@VDT,      
      @@VTYP,      
      @@BOOKTYPE,      
      @@STD_DATE,      
      @@LST_DATE,      
      @@MAXVNO      
    SELECT      
     @@NEWVNO = LASTVNO      
    FROM      
     #VNO      
    UPDATE      
     RP      
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))      
    FROM      
     #RECPAY_TABLE RP,      
     #BANK_VNO BV      
    WHERE      
     RP.SERIAL_NO = BV.SRNO      
   DROP TABLE #VNO      
   DROP TABLE #BANK_VNO      
  FETCH NEXT      
   FROM @@VNOCUR      
   INTO      
    @@BANK_CODE,      
    @@BOOKTYPE      
 END      
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */      
UPDATE      
 #RECPAY_TABLE      
  SET LNO = 2      
WHERE      
 VNO IN      
  (      
   SELECT      
    VNO      
   FROM      
    #RECPAY_TABLE      
     WITH(NOLOCK)      
   GROUP BY      
    VNO      
   HAVING      
    COUNT(*) = 1      
  )      
SET @@LNOCUR = CURSOR FOR      
 SELECT      
  VNO      
 FROM      
  #RECPAY_TABLE      
   WITH(NOLOCK)      
 GROUP BY      
  VNO      
 HAVING      
  COUNT(*) > 1      
OPEN @@LNOCUR      
FETCH NEXT      
 FROM      
  @@LNOCUR      
 INTO      
  @@LNOVNO      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  CREATE TABLE      
   [#LNOGEN]      
    (      
     VNO VARCHAR(12),      
     SNO INT,      
     LNO INT IDENTITY(1,1)      
    )      
  INSERT INTO      
   #LNOGEN      
    SELECT      
     VNO,      
     SNO      
    FROM      
     #RECPAY_TABLE      
      WITH(NOLOCK)      
    WHERE      
     VNO = @@LNOVNO      
    ORDER BY      
     SNO      
  UPDATE      
   #RECPAY_TABLE      
    SET LNO = L.LNO + 1      
  FROM      
   #LNOGEN L      
  WHERE      
   #RECPAY_TABLE.VNO = L.VNO      
   AND #RECPAY_TABLE.SNO = L.SNO      
   AND #RECPAY_TABLE.LNO = 0      
  DROP TABLE #LNOGEN      
  FETCH NEXT      
   FROM      
    @@LNOCUR      
   INTO      
    @@LNOVNO      
 END      
CLOSE @@LNOCUR      
DEALLOCATE @@LNOCUR      
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */      
INSERT INTO      
 LEDGER1      
  (      
   BNKNAME,      
   BRNNAME,      
   DD,      
   DDNO,      
   DDDT,      
   RELDT,      
   RELAMT,      
   REFNO,      
   RECEIPTNO,      
   VTYP,      
   VNO,      
   LNO,      
   DRCR,      
   BOOKTYPE,      
   MICRNO,      
   SLIPNO,      
   SLIPDATE,      
   CHEQUEINNAME,      
   CHQPRINTED,      
   CLEAR_MODE      
  )      
SELECT      
 BNKNAME = MAX(BANK_NAME),      
 BRNNAME = MAX(BRANCH_NAME),      
 DD = MAX(CHQ_MODE),      
 DDNO = MAX(REF_NO),      
 DDDT = MAX(DDDT),      
 RELDT = '',      
 RELAMT = SUM(AMOUNT),      
 REFNO = 0,      
 RECEIPTNO = 0,      
 VTYP,      
 VNO,      
 LNO = 2,      
 DRCR,      
 BOOKTYPE = BOOKTYPE,      
 MICRNO = MAX(MICRNO),      
 SLIPNO = 0,      
 SLIPDATE = '',      
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),      
 CHQPRINTED = 0,      
 CLEAR_MODE = MAX(CL_MODE)      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 DRCR,      
 BOOKTYPE      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
      
/*================================      
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK      
=================================*/      
CREATE TABLE #LEDGER      
(      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 EDT DATETIME,      
 LNO SMALLINT,      
 ACNAME VARCHAR(100),      
 DRCR VARCHAR(1),      
 VAMT MONEY,      
 VDT DATETIME,      
 VNO1 VARCHAR(12),      
 REFNO CHAR(12),      
 BALAMT MONEY,      
 NODAYS INT,      
 CDT DATETIME,      
 CLTCODE VARCHAR(10),      
 BOOKTYPE VARCHAR(2),      
 ENTEREDBY VARCHAR(25),      
 PDT DATETIME,      
 CHECKEDBY VARCHAR(25),      
 ACTNODAYS INT,      
 NARRATION VARCHAR(234)      
)      
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0      
CREATE TABLE #LEDGER3      
(      
 NARATNO INT,      
 NARR VARCHAR(234),      
 REFNO CHAR(12),      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 BOOKTYPE VARCHAR(2)      
)      
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER      
 (      
  VTYP,      
  VNO,      
  EDT,      
  LNO,      
  ACNAME,      
  DRCR,      
  VAMT,      
  VDT,      
  VNO1,      
  REFNO,      
  BALAMT,      
  NODAYS,      
  CDT,      
  CLTCODE,      
  BOOKTYPE,      
  ENTEREDBY,      
  PDT,      
  CHECKEDBY,      
  ACTNODAYS,      
  NARRATION      
 )      
SELECT      
 VTYP,      
 VNO,      
 EDT = EDT,      
 LNO,      
 ACNAME,      
 DRCR,      
 VAMT = AMOUNT,      
 VDT,      
 VNO1 = VNO,      
 REFNO = 0,      
 BALAMT = AMOUNT,      
 NODAYS = 0,      
 CDT = GETDATE(),      
 CLTCODE = CLIENT_CODE,      
 BOOKTYPE = BOOKTYPE,      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),      
 PDT = GETDATE(),      
 CHECKEDBY = @UNAME,      
 ACTNODAYS = 0,      
 NARRATION      
FROM      
 #RECPAY_TABLE      
/*==============================      
BANK SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER      
SELECT      
 VTYP,      
 VNO,      
 EDT = EDT,      
 LNO = 1,      
 BANKNAME,      
 DRCR =      
  (      
   CASE      
    WHEN DRCR = 'D'      
    THEN 'C'      
    ELSE 'D'      
   END      
  ),      
 VAMT = SUM(AMOUNT),      
 VDT,      
 VNO1 = VNO,      
 REFNO = 0,      
 BALAMT = SUM(AMOUNT),      
 NODAYS = 0,      
 CDT = GETDATE(),      
 CLTCODE = BANK_CODE,      
 BOOKTYPE = BOOKTYPE,      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),      
 PDT = GETDATE(),      
 CHECKEDBY = @UNAME,      
 ACTNODAYS = 0,      
 NARRATION = MAX(NARRATION)      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 EDT,      
 DRCR,      
 VDT,      
 BANK_CODE,      
 BOOKTYPE,      
 BANKNAME      
/*==============================      
INSERTING ALL LEDGER RECORDS AT ONE TIME      
==============================*/      
INSERT INTO LEDGER      
SELECT      
 *      
FROM      
 #LEDGER      
ORDER BY      
 BOOKTYPE,      
 VTYP,      
 VNO,      
 LNO      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  DROP TABLE #LEDGER      
  DROP TABLE #LEDGER3      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
DROP TABLE #LEDGER      
/*==============================      
BANK SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER3      
SELECT      
 NARATNO = 1,      
 NARRATION = MAX(NARRATION),      
 REFNO = 0,      
 VTYP,      
 VNO,      
 BOOKTYPE      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 BOOKTYPE      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER3      
SELECT      
 NARATNO = LNO,      
 NARR = NARRATION,      
 REFNO = 0,      
 VTYP,      
 VNO,      
 BOOKTYPE      
FROM      
 #RECPAY_TABLE      
      
      
/*==============================      
INSERTING ALL LEDGER3 RECORDS AT ONE TIME      
==============================*/      
INSERT INTO LEDGER3      
SELECT      
 *      
FROM      
 #LEDGER3      
ORDER BY      
 BOOKTYPE,      
 VTYP,      
 VNO,      
 NARATNO      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  DROP TABLE #LEDGER3      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
DROP TABLE #LEDGER3      
      
      
IF @@BRANCHFLAG = 1      
 BEGIN      
  SET @@L2CUR = CURSOR FOR      
   SELECT DISTINCT      
    VNO      
   FROM      
    #RECPAY_TABLE      
   ORDER BY      
    VNO      
  OPEN @@L2CUR      
   FETCH NEXT      
   FROM      
  @@L2CUR      
   INTO      
    @@L2VNO      
  WHILE @@FETCH_STATUS = 0      
   BEGIN      
    DELETE FROM      
     TEMPLEDGER2      
    WHERE      
     SESSIONID = '9999999999'      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
    INSERT INTO      
     TEMPLEDGER2      
    SELECT      
     'BRANCH',      
     C.COSTNAME,      
     AMOUNT,      
     VTYP,      
     VNO,      
     LNO,      
     DRCR,      
     '0',      
     BOOKTYPE,      
     '9999999999',      
     CLIENT_CODE,      
     'A',      
     '0'      
    FROM      
     #RECPAY_TABLE RP,      
     COSTMAST C      
    WHERE      
     RP.COSTCODE = C.COSTCODE      
     AND VNO = @@L2VNO      
/*==============================      
BANK SIDE RECORD      
==============================*/      
    INSERT INTO      
     TEMPLEDGER2      
    SELECT      
     'BRANCH',      
     C.COSTNAME,      
     SUM(AMOUNT),      
     VTYP,      
     VNO,      
     LNO = 1,      
     DRCR =      
      (      
       CASE      
       WHEN DRCR = 'D'      
       THEN 'C'      
       ELSE 'D'      
       END      
      ),      
     '0',      
     BOOKTYPE,      
     '9999999999',      
     BANK_CODE,      
     'A',      
     '0'      
    FROM      
     #RECPAY_TABLE RP,      
     COSTMAST C      
    WHERE      
     RP.BANKCOST = C.COSTCODE      
     AND VNO = @@L2VNO      
    GROUP BY      
     C.COSTNAME,      
     VTYP,      
     VNO,      
      (      
       CASE      
       WHEN DRCR = 'D'      
       THEN 'C'      
       ELSE 'D'      
       END      
      ),      
     BANK_CODE,      
     BOOKTYPE      
    EXEC INSERTTOLEDGER2   
     '9999999999',      
     @@L2VNO,      
     '1',      
     '1',      
     '1',      
     'BROKER',      
     'BROKER'      
    FETCH NEXT      
     FROM      
      @@L2CUR      
     INTO      
      @@L2VNO      
   END      
  DELETE FROM      
   TEMPLEDGER2      
  WHERE      
   SESSIONID = '9999999999'      
  COMMIT TRAN      
 END      
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL      
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE      
DROP TABLE #RECPAY_TABLE_TMP      
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RENUM_BILL
-- --------------------------------------------------


CREATE PROC RENUM_BILL
	@BILLDT VARCHAR(11),
	@NEWVDT VARCHAR(11),
	@NEWEDT VARCHAR(11),
	@VTYP INT

AS

/*
	EXEC RENUM_BILL
		'MAR 30 2008',
		'APR  3 2008',
		'APR  3 2008',
		15
*/

DECLARE
	@@OLDVNO VARCHAR(12),
	@@NEWVNO VARCHAR(12),
	@@SDTCUR DATETIME,
	@@LDTCUR DATETIME,
	@@RECCOUNT INT

SET @@OLDVNO = ''
SET @@SDTCUR = ''

SELECT 
	@@SDTCUR = ISNULL(SDTCUR, ''), 
	@@LDTCUR = ISNULL(LDTCUR, '') 
FROM 
	PARAMETER 
WHERE 
	@NEWVDT BETWEEN SDTCUR AND LDTCUR

IF @@SDTCUR = ''
BEGIN
	SELECT 'THE NEW FINANCIAL YEAR IN WHICH YOU ARE TRYING TO SHIFT THE BILL DOSE NOT EXIST!'
	RETURN
END

SELECT TOP 1 @@OLDVNO = VNO FROM LEDGER WHERE VTYP = @VTYP AND VDT LIKE @BILLDT + '%' AND BOOKTYPE = '01'

IF @@OLDVNO = ''
BEGIN
	SELECT 'THE BILL WHICH YOU ARE TRYING TO SHIFT DOSE NOT EXIST!'
	RETURN
END

BEGIN TRANSACTION

IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_LEDGER]') AND XTYPE = 'U')
	SELECT * INTO BAK_LEDGER FROM LEDGER WHERE 1 = 2

IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_LEDGER1]') AND XTYPE = 'U')
	SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE INTO BAK_LEDGER1 FROM LEDGER1 WHERE 1 = 2

IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_LEDGER2]') AND XTYPE = 'U')
	SELECT * INTO BAK_LEDGER2 FROM LEDGER2 WHERE 1 = 2

IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_LEDGER3]') AND XTYPE = 'U')
	SELECT * INTO BAK_LEDGER3 FROM LEDGER3 WHERE 1 = 2

IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BILLPOSTED]') AND XTYPE = 'U')
	IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_BILLPOSTED]') AND XTYPE = 'U')
		SELECT * INTO BAK_BILLPOSTED FROM BILLPOSTED WHERE 1 = 2

IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_BILLMATCH]') AND XTYPE = 'U')
	SELECT * INTO BAK_BILLMATCH FROM BILLMATCH WHERE 1 = 2

IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BFBILLMATCH]') AND XTYPE = 'U')
	IF NOT EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BAK_BFBILLMATCH]') AND XTYPE = 'U')
		SELECT * INTO BAK_BFBILLMATCH FROM BFBILLMATCH WHERE 1 = 2	

INSERT INTO BAK_LEDGER 
	SELECT * FROM LEDGER WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

INSERT INTO BAK_LEDGER1 
	SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

INSERT INTO BAK_LEDGER2 
	SELECT * FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

INSERT INTO BAK_LEDGER3 
	SELECT * FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BILLPOSTED]') AND XTYPE = 'U')
	INSERT INTO BAK_BILLPOSTED 
		SELECT * FROM BILLPOSTED WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

INSERT INTO BAK_BILLMATCH 
	SELECT * FROM BILLMATCH WHERE VTYPE = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BFBILLMATCH]') AND XTYPE = 'U')
	INSERT INTO BAK_BFBILLMATCH 
		SELECT * FROM BFBILLMATCH WHERE VTYPE = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

CREATE TABLE #VNO
(LASTVNO VARCHAR(12))

INSERT INTO #VNO
EXEC ACC_GENVNO_NEW @NEWVDT, @VTYP, '01', @@SDTCUR, @@LDTCUR

SELECT @@NEWVNO = LASTVNO FROM #VNO

UPDATE LEDGER 
	SET VNO = @@NEWVNO, VDT = @NEWVDT, EDT = @NEWEDT WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

UPDATE LEDGER1 
	SET VNO = @@NEWVNO WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

UPDATE LEDGER2 
	SET VNO = @@NEWVNO WHERE VTYPE = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

UPDATE LEDGER3 
	SET VNO = @@NEWVNO WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BILLPOSTED]') AND XTYPE = 'U')
	UPDATE BILLPOSTED 
		SET VNO = @@NEWVNO, VDT = @NEWVDT WHERE VTYP = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

UPDATE BILLMATCH 
	SET VNO = @@NEWVNO WHERE VTYPE = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[BFBILLMATCH]') AND XTYPE = 'U')
	UPDATE BFBILLMATCH 
		SET VNO = @@NEWVNO WHERE VTYPE = @VTYP AND VNO = @@OLDVNO AND BOOKTYPE = '01'

SELECT 
	VNO, VTYP, BOOKTYPE, RECCOUNT = COUNT(1)
INTO
	#LEDGER
FROM 
	LEDGER
WHERE 
	LNO = 2
GROUP BY 
	VNO, VTYP, BOOKTYPE
HAVING 
	COUNT(1) > 1

SELECT @@RECCOUNT = COUNT(1) FROM #LEDGER

IF @@RECCOUNT = 0 
BEGIN
	COMMIT TRANSACTION
	SELECT 'BILL SHIFTING COMPLETED SUCCESSFULLY<BR>OLDVNO = ' + @@OLDVNO + ', NEWVNO = ' + @@NEWVNO
END
ELSE
BEGIN
	ROLLBACK TRANSACTION
	SELECT 'BILL SHIFTING ABORTED DUE TO VOUCHER DUPLICATION'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RENUMVCH_DAILY
-- --------------------------------------------------
CREATE PROC RENUMVCH_DAILY
--BEGIN TRAN
--RENUMVCH_DAILY 2, '01'
--COMMIT TRAN
--ROLLBACK TRAN
@VTYP SMALLINT,
@BOOKTYPE VARCHAR(2)
AS
DECLARE
@@OVNO AS VARCHAR(12),
@@EXIST AS NUMERIC(10),
@@LEXIST AS VARCHAR(12),
@@VNO AS VARCHAR(12),
@@VTYPE AS SMALLINT,
@@BTYPE AS VARCHAR(2),
@@VDT AS VARCHAR(11),
@@VDT1 AS DATETIME,
@@LASTVNOEXIST VARCHAR(12),
@@MAINREC AS CURSOR
SET NOCOUNT ON

DELETE FROM LASTVNO WHERE VDT BETWEEN 'APR  1 2006' AND 'MAR 31 2007 23:59' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE


SET @@MAINREC = CURSOR FOR
	SELECT VNO, VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109) AS VDT FROM LEDGER
	WHERE VDT BETWEEN 'APR  1 2006' AND 'MAR 31 2007 23:59'
	AND VTYP = @VTYP
	AND BOOKTYPE = @BOOKTYPE
	GROUP BY VNO, VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
	ORDER BY VNO

OPEN @@MAINREC
	FETCH NEXT FROM @@MAINREC INTO @@VNO, @@VTYPE, @@BTYPE, @@VDT
WHILE @@FETCH_STATUS = 0
	BEGIN
                  SELECT @@LASTVNOEXIST = ISNULL(COUNT(LASTVNO), 0) FROM LASTVNO WHERE VDT LIKE @@VDT + '%' AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
                  IF @@LASTVNOEXIST = 0 
                  BEGIN
                        SELECT @@OVNO = (SELECT CONVERT(VARCHAR(4),YEAR(@@VDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VDT))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@VDT))),2)+'0001')
                        INSERT INTO LASTVNO VALUES(@@VTYPE, @@BTYPE, @@VDT, @@OVNO)
                  END 
                  ELSE
                  BEGIN
                        SELECT @@OVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1) FROM LASTVNO WHERE VDT LIKE @@VDT + '%' AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
                        UPDATE LASTVNO SET LASTVNO = @@OVNO WHERE VDT LIKE @@VDT + '%' AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
                  END

                  INSERT INTO LEDGERRENUM_LOG VALUES(@@VNO, @@VTYPE, @@BTYPE, @@OVNO)

		PRINT 'UPDATING ' + @@VNO + ', VTYPE ' + CONVERT(VARCHAR, @@VTYPE) + ', BOOKTYPE ' + @@BTYPE + ' TO ' + @@OVNO + ' DAITED ' +@@VDT
		UPDATE LEDGER SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
		UPDATE LEDGER1 SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
		UPDATE LEDGER2 SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYPE = @@VTYPE AND BOOKTYPE = @@BTYPE
		UPDATE LEDGER3 SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
		UPDATE MARGINLEDGER SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE
		UPDATE MATCHDETAILS SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYPE = @@VTYPE AND BOOKTYPE = @@BTYPE
		UPDATE PAYADV SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE

		FETCH NEXT FROM @@MAINREC INTO @@VNO, @@VTYPE, @@BTYPE, @@VDT
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RenumVch_JV
-- --------------------------------------------------
CREATE Proc RenumVch_JV        
As        
Declare        
 @@Vno As Varchar(12),        
 @@Vtyp As Int,        
 @@BookType As Varchar(2),        
 @@NewVno As Varchar(12),        
 @@Vamt As Money,        
 @@Nar As Varchar(2000),        
 @@vdt as varchar(11),
 @@vdtchk as varchar(11),
 @@Cur As Cursor        
Set @@Cur = Cursor For        
select distinct l1.vno, l1.vtyp, l1.booktype, l.vamt, convert(varchar(11),l.vdt,109) from ledger l, bak_ledger_jv_dup l1 where   
l.vno = l1.vno and l.vtyp = l1.vtyp and l.booktype = l1.booktype  
and l.vdt between' apr  1 2011' and 'mar 31 2012 23:59' --and l.vno = '201100000124' 
and convert(varchar(11),l.vdt,109) not in (select min(vdt) from bak_ledger_jv_dup l2 where l1.vno = l2.vno)

Select @@NewVno = '201100002358'  
     
Open @@Cur      
 Fetch Next From @@Cur Into @@Vno, @@VTyp, @@BookType, @@Vamt, @@vdt    
--DELETE FROM LASTVNO WHERE VDT >= 'apr  1 2011' AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE      
While @@Fetch_Status = 0        
 Begin        
  Print 'In Loop Now'        
--  Begin Tran        
  Select Top 1 @@Nar = Narration From Ledger Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType AND VAMT = @@VAMT and vdt like @@vdt +'%'
  Select Top 1 @@vdtchk = convert(varchar(11),vdt,109) From Ledger Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType

  --Update     
  --Select @@NewVno = CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(VNO)) + 1) FROM LEDGER WHERE VDT < 'apr  1 2011' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO LIKE '2005%'      
  Select @@NewVno = Convert(Varchar(12), Convert(Numeric(12), @@NewVno) + 1)    
  --select Vno = @@NewVno from ledger Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And VAmt = @@Vamt and vdt like @@vdt +'%'
  Update Ledger Set Vno = @@NewVno Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And VAmt = @@Vamt and vdt like @@vdt +'%'   
  
  
Print @@Vno + ' ---------- ' + @@NewVno  
insert into vno_log values(@@Vno,@@NewVno)
  -- Commit Tran        
  Fetch Next From @@Cur Into @@Vno, @@VTyp, @@BookType, @@Vamt, @@vdt
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RePost_JV_L2
-- --------------------------------------------------
CREATE Proc RePost_JV_L2        
As  

/*  

Begin Tran        
Exec RePost_JV_L2  
--Commit      
RollBack  

*/              
Declare        
 @@Vno As Varchar(12),        
 @@Vtyp As Int,        
 @@BookType As Varchar(2),        
 @@NewVno As Varchar(12),        
 @@Vamt As Money,        
 @@Nar As Varchar(2000),        
 @@vdt as varchar(11),
 @@vdtchk as varchar(11),
 @@Cur As Cursor        



Set @@Cur = Cursor For        
select distinct l1.vno_new, l.vtyp, l.booktype from ledger l, vno_log l1 where   
l.vno = l1.vno_new and l.vtyp = 8 and l.booktype = '01' 
and l.vdt between' apr  1 2011' and 'mar 31 2012 23:59' --and l.vno = '201100000001' 
--and convert(varchar(11),l.vdt,109) not in (select min(vdt) from bak_ledger_jv_dup l2 where l1.vno = l2.vno)

    
Open @@Cur      
 Fetch Next From @@Cur Into @@Vno, @@VTyp, @@BookType
--DELETE FROM LASTVNO WHERE VDT >= 'apr  1 2011' AND VTYP = @@VTYP AND BOOKTYPE = @@BOOKTYPE      
While @@Fetch_Status = 0        
 Begin        
  Print 'In Loop Now'        
--  Begin Tran        
  Select Top 1 @@Nar = Narration From Ledger Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType AND VAMT = @@VAMT and vdt like @@vdt +'%'
  
  --Select @@NewVno = CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(VNO)) + 1) FROM LEDGER WHERE VDT < 'apr  1 2011' AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO LIKE '2005%'      
  Select @@NewVno = Convert(Varchar(12), Convert(Numeric(12), @@NewVno) + 1)    
  --select Vno = @@NewVno from ledger Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And VAmt = @@Vamt and vdt like @@vdt +'%'
 -- Update Ledger Set Vno = @@NewVno Where Vno = @@Vno And Vtyp = @@Vtyp And BookType = @@BookType And VAmt = @@Vamt and vdt like @@vdt +'%'   
	delete templedger2 where sessionid = '9999999999'
	insert into templedger2
	select 'BRANCH', case when a.branchcode = 'ALL' then 'HO' else a.branchcode  end, vamt, vtyp, vno, lno, drcr, 0, l.booktype, '9999999999', l.cltcode, 'A', 0 from ledger l, acmast a 
	where a.cltcode = l.cltcode and Vno = @@Vno And Vtyp = @@Vtyp And l.BookType = @@BookType 

	--select * from templedger2 where sessionid = '9999999999'

	exec InsertToLedger2 '9999999999',@@Vno,1,1,'','Broker','Broker' 
  
	Print @@Vno + ' ---------- ' + @@NewVno  

  -- Commit Tran        
  Fetch Next From @@Cur Into @@Vno, @@VTyp, @@BookType
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RepostLedger2
-- --------------------------------------------------
CREATE Proc RepostLedger2          
@vtyp smallint          
          
As          
Declare          
 @@Vno As Varchar(12),          
 @@Data As Cursor          
          
Set @@Data = Cursor For          
select distinct vno from ledger where vno not in(select vno from ledger2 where vtype = @vtyp)        
and vtyp = @vtyp        
        
Open @@Data          
Fetch Next From @@Data Into @@VNO          
Set NoCount ON          
While @@Fetch_Status = 0          
 Begin          
  Delete From TempLedger2 Where SessionId = '9999999999'          
  Insert Into TempLedger2          
  Select 'BRANCH', Case When A.BranchCode <> 'ALL' Then A.BranchCode Else 'HO' End,          
    L.VAmt, L.Vtyp, L.Vno, L.Lno, L.DrCr, '0', L.BookType, '9999999999',          
    L.CltCode, 'A', 0          
   From          
    Ledger L, AcMast A          
   Where          
    L.Cltcode = A.CltCode          
    And L.Vno = @@Vno And L.Vtyp = @vtyp And L.BookType = '01'          
        
  Exec InsertToLedger2 '9999999999', @@VNO, 1, 1, '', 'BROKER', 'BROKER'          
        
  Print 'Updated Voucher No. ' + @@VNO          
  Fetch Next From @@Data Into @@VNO          
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RepostLedger2_vin
-- --------------------------------------------------
/*BEGIN TRAN    
exec RepostLedger2_vin 8  
COMMIT    
ROLLBACK    
*/    
        
/*set transaction isolation level read uncommitted            
select distinct vno from ledger where vno not in(select vno from ledger2 where vtype = 8)                   
and vtyp = 8 and vdt like 'aug 16 2008%' and vno between '208081613153' and '208081617117'*/            
CREATE Proc [dbo].[RepostLedger2_vin]        
@vtyp smallint,  
@vdt varchar(11)                      
                      
As        
Declare                      
 @@Vno As Varchar(12),                      
 @@Data As Cursor                      
                      
Set @@Data = Cursor For                      
SELECT DISTINCT VNO      
      
FROM LEDGER L WHERE VTYP NOT IN(15, 21, 18) AND NOT EXISTS(      
      
SELECT VNO FROM LEDGER2 L2 WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE)      
AND VTYP = @vtyp     
and vdt >= @vdt  
                    
Open @@Data                      
Fetch Next From @@Data Into @@VNO                      
Set NoCount ON                      
While @@Fetch_Status = 0                      
 Begin                      
  Delete From TempLedger2 Where SessionId = '9999999999'                      
  Insert Into TempLedger2                      
  Select 'BRANCH', Case When A.BranchCode <> 'ALL' Then A.BranchCode Else 'HO' End,                      
    L.VAmt, L.Vtyp, L.Vno, L.Lno, L.DrCr, '0', L.BookType, '9999999999',                      
    L.CltCode, 'A', 0                      
   From                      
    Ledger L, AcMast A                      
   Where                      
    L.Cltcode = A.CltCode                      
    And L.Vno = @@Vno And L.Vtyp = @vtyp And L.BookType = '01'                      
                    
  Exec InsertToLedger2 '9999999999', @@VNO, 1, 1, '', 'BROKER', 'BROKER'                      
                    
  Print 'Updated Voucher No. ' + @@VNO                      
  Fetch Next From @@Data Into @@VNO                      
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.REPROCESS_RECO
-- --------------------------------------------------

CREATE PROC [dbo].[REPROCESS_RECO]      
 @BANKCODE VARCHAR(10),      
 @PROCESS_DATE VARCHAR(10)      
      
AS      
      
DECLARE       
 @@MICRNO VARCHAR(20),      
 @@TABLE_EXIST VARCHAR(20),            
 @@RECORD_COUNT SMALLINT,            
 @@RECO_STATUS CHAR(1),            
 @@CLTCODE_EXIST INT,      
 @@PROC_DATE VARCHAR(11)      
      
      
CREATE TABLE #BANKRECOSAVE      
(      
 Cltcode VARCHAR(10),      
 Bookdate DATETIME,      
 [Description] VARCHAR(200),      
 Amount MONEY,      
 Drcr CHAR(1),      
 Valuedate DATETIME,      
 Referenceno VARCHAR(30),      
 Crossreferenceno BIGINT,      
 STATUS VARCHAR(15),      
 BR_SNo BIGINT,      
 MICRNO VARCHAR(10),      
 AMOUNTLEDGR1 MONEY      
)      
      
SET @@TABLE_EXIST = ''            
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'            
            
IF @@TABLE_EXIST = ''            
BEGIN            
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))            
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')            
END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS            
            
IF @@RECORD_COUNT = 0            
BEGIN            
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')            
END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS            
            
IF @@RECO_STATUS = 'N'            
BEGIN            
 BEGIN TRAN            
 UPDATE RECOPROCESS SET INPROCESS = 'Y'            
END            
ELSE            
BEGIN            
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'            
 RETURN            
END            
            
SET @@TABLE_EXIST = ''            
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'            
IF @@TABLE_EXIST <> ''            
BEGIN            
 DROP TABLE LEDGER_UPDATES            
END            
            
SET @@TABLE_EXIST = ''            
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'            
IF @@TABLE_EXIST <> ''            
BEGIN            
 DROP TABLE BANKRECOCOMP            
END            
            
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)            
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2            
            
IF @@CLTCODE_EXIST = 0            
 BEGIN            
  SELECT 'BANK CODE DOSE NOT EXIST.'        
  ROLLBACK TRAN        
  RETURN            
 END            
      
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2            
      
      
SELECT @@PROC_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @PROCESS_DATE, 103), 109)      
    
    
SELECT     
 @@RECORD_COUNT = COUNT(1)     
FROM     
 BANKRECO     
WHERE      
 CLTCODE = @BANKCODE      
 AND BOOKDATE LIKE @@PROC_DATE + '%'    
    
IF @@RECORD_COUNT = 0    
BEGIN    
 SELECT 'THE STATEMENT FOR SELECTED DATE ' + @@PROC_DATE + ' FOR ' + @BANKCODE + ' IS NOT UPLOADED.'    
 ROLLBACK TRAN    
 RETURN    
END    
    
SELECT     
 @@RECORD_COUNT = COUNT(1)     
FROM     
 BANKRECO     
WHERE      
 CLTCODE = @BANKCODE      
 AND BOOKDATE LIKE @@PROC_DATE + '%'    
 AND STATUS = 'UNMATCHED'    
    
IF @@RECORD_COUNT = 0    
BEGIN    
 PRINT 'ALL THE RECORDS FOR SELECTED DATE ' + @@PROC_DATE + ' FOR ' + @BANKCODE + ' IS ALREADY MATCHED.'    
 ROLLBACK TRAN    
 RETURN    
END    
      
INSERT INTO #BANKRECOSAVE      
SELECT      
 Cltcode,      
 Bookdate,      
 [Description],      
 Amount,      
 Drcr,      
 Valuedate,      
 Referenceno,      
 Crossreferenceno,      
 STATUS,      
 BR_SNo,      
 MICRNO,      
 0      
FROM      
 BANKRECO      
WHERE      
 CLTCODE = @BANKCODE      
 AND BOOKDATE LIKE @@PROC_DATE + '%'      
 AND STATUS = 'UNMATCHED'      
      
      
UPDATE            
 #BANKRECOSAVE            
SET            
 STATUS ='MATCHED'            
FROM            
 LEDGER1            
WHERE            
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)            
 AND CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101) >= CONVERT(VARCHAR(11), VDT, 101))        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND   REFERENCENO  <> '0'            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO            
 LEDGER_UPDATES            
SELECT           
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE            
FROM            
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' or LEDGER1.VTYP = '17' )            
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE            
 AND LEDGER1.VNO = LEDGER.VNO            
 AND LEDGER1.VTYP = LEDGER.VTYP            
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND DDNO =  REFERENCENO            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), L2.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101))            
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101) >= CONVERT(VARCHAR(11), LEDGER.VDT, 101)    
 AND   REFERENCENO  <> '0'            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
UPDATE            
 LEDGER1            
SET            
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO            
FROM            
 #BANKRECOSAVE, LEDGER (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' or LEDGER1.VTYP = '17')            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND DDNO =  REFERENCENO            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), L2.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101))      
 AND REFERENCENO  <> '0'            
 AND LEDGER.VNO = LEDGER1.VNO            
 AND LEDGER.VTYP = LEDGER1.VTYP            
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE            
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE   
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101)             
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
SELECT            
 SUM(RELAMT) AS AMOUNT,            
 SLIPNO AS SLIPNO,            
 UPPER(DRCR) AS DRCR,            
 MICRNO            
INTO            
 BANKRECOCOMP            
FROM            
 LEDGER1            
WHERE            
 MICRNO = @@MICRNO            
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )            
 AND SLIPNO <>''            
GROUP BY            
 SLIPNO,            
 DRCR,            
 MICRNO            
            
            
UPDATE            
 #BANKRECOSAVE            
SET            
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'            
FROM            
 BANKRECOCOMP            
WHERE            
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)            
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)            
  AND #BANKRECOSAVE.MICRNO = @@MICRNO            
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT            
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO            
  AND REFERENCENO  <> '0'            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO LEDGER_UPDATES            
SELECT            
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE            
FROM            
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE            
 AND LEDGER1.VNO = LEDGER.VNO            
 AND LEDGER1.VTYP = LEDGER.VTYP            
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.REFERENCENO  <> '0'            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
UPDATE            
 LEDGER1            
SET            
 RELDT = VALUEDATE ,            
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO            
FROM            
 #BANKRECOSAVE, LEDGER  (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.REFERENCENO  <> '0'            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)            
 AND LEDGER.VNO = LEDGER1.VNO            
 AND LEDGER.VTYP = LEDGER1.VTYP            
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE            
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
UPDATE            
 L            
SET            
 EDT = VALUEDATE            
FROM            
 LEDGER L, LEDGER_UPDATES LU            
WHERE            
 LU.VNO=L.VNO            
 AND LU.VTYP=L.VTYP            
 AND LU.BOOKTYPE=L.BOOKTYPE            
 AND EDT LIKE 'DEC 31 2049%'            
            
IF @@ERROR <> 0            
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'            
 ROLLBACK TRAN            
 RETURN            
END            
            
UPDATE            
 L            
SET            
 EDT = VDT            
FROM            
 LEDGER L, LEDGER_UPDATES LU            
WHERE            
 LU.VNO=L.VNO            
 AND LU.VTYP=L.VTYP            
 AND LU.BOOKTYPE=L.BOOKTYPE            
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
DROP TABLE BANKRECOCOMP            
DROP TABLE LEDGER_UPDATES            
      
UPDATE BR       
SET STATUS = 'MATCHED'      
FROM BANKRECO BR, #BANKRECOSAVE BR1      
WHERE BR.BR_SNo = BR1.BR_SNo AND BR1.STATUS = 'MATCHED'      
      
        
UPDATE RECOPROCESS SET INPROCESS = 'N'            
            
COMMIT TRAN            
            
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK
-- --------------------------------------------------


CREATE PROC [dbo].[RETURNCANCEL_BULK] @VTYPE   SMALLINT, 
                                     @FNAME   VARCHAR(100), 
                                     @UNAME   VARCHAR(25), 
                                     @USERCAT SMALLINT 
AS 
    /*                                               
    BEGIN TRAN                                               
    SP_HELPTRIGGER LEDGER                                               
    LEDGER_TRG_BILL                                               
    LEDGER_TRG                                               
    EXEC RECPAYUPLOAD_BULK 'D:\BACKOFFICE\RECPAYFILES\SAMPLE1.CSV', 'JAYDEEP', 388                                               
    SELECT TOP 1 * FROM LEDGER3                                               
    SELECT TOP 1 * FROM LEDGER_TRG                                               
    ROLLBACK                                               
    */ 
    SET NOCOUNT ON 

    /*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE B ASED ON DRCR ------------------------*/ 
    DECLARE @@STD_DATE        VARCHAR(11), 
            @@LST_DATE        VARCHAR(11), 
            @@BRANCHFLAG      AS TINYINT, 
            @@VNOFLAG         AS TINYINT, 
            @@VNOMETHOD       INT, 
            @@ACNAME          CHAR(100), 
            @@BOOKTYPE        CHAR(2), 
            @@MICRNO          VARCHAR(10), 
            @@DRCR            VARCHAR(1), 
            @@VTYP            SMALLINT, 
            @@BANK_CODE       VARCHAR(100), 
            @@BACKDAYS        INT, 
            @@BACKDATE        VARCHAR(11), 
            @@BRNCOUNT        TINYINT, 
            @@MONTHLYVDT      VARCHAR(11), 
            @@SERIAL_NO       INT, 
            @@COSTCODECOUNT   TINYINT, 
            @@COSTCODEUPDATES CURSOR, 
            @@NEWVNO          AS VARCHAR(12), 
            @@MAXCOUNT        AS INT, 
            @@VDT             AS VARCHAR(11), 
            @@BANKBRANCH      AS VARCHAR(10), 
            @@BANKCOST        AS NUMERIC, 
            @@LNOCUR          AS CURSOR, 
            @@VNOCUR          AS CURSOR, 
            @@LNOVNO          AS VARCHAR(12), 
            @@MAXVNO          AS INT, 
            @@L2CUR           AS CURSOR, 
            @@L2VNO           AS VARCHAR(12), 
            @@ERROR_COUNT     AS INT, 
            @@FILEEXISTS      AS INT, 
            @@SQL             AS VARCHAR(2000) 

    CREATE TABLE #FEXIST 
      ( 
         F1 SMALLINT, 
         F2 SMALLINT, 
         F3 SMALLINT 
      ) 

    SELECT @@SQL = "INSERT INTO" 

    SELECT @@SQL = @@SQL + " #FEXIST " 

    SELECT @@SQL = @@SQL + " (F1, F2, F3) " 

    SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" 
                   + @FNAME + "'" 

    EXEC(@@SQL) 

    SELECT @@FILEEXISTS = F1 
    FROM   #FEXIST 

    IF @@FILEEXISTS = 0 
      BEGIN 
          DROP TABLE #FEXIST 

          SELECT 
'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.' 

    RETURN 
END 

    DROP TABLE #FEXIST 

    BEGIN TRAN 

    CREATE TABLE #RECPAY_TABLE_TMP 
      ( 
         PRODUCT_CO        VARCHAR(10), 
         INST_NMBR         VARCHAR(15), 
         INST_DATE         VARCHAR(10), 
         BENEF_DESCRIPTION VARCHAR(200), 
         INSTRUMENT_AMNT   VARCHAR(50), 
         LOC_DESCRIPTION   VARCHAR(100), 
         I_STAT            VARCHAR(10), 
         ENRICH_VALUE      VARCHAR(10), 
         NARRATION         VARCHAR(250),
	 DEPOSIT_FLG CHAR(1)
      ) 

    CREATE TABLE [#RECPAY_TABLE] 
      ( 
         SRNO              INT IDENTITY(1, 1), 
         PRODUCT_CO        VARCHAR(10), 
         INST_NMBR         VARCHAR(15), 
         INST_DATE         DATETIME, 
         BENEF_DESCRIPTION VARCHAR(200), 
         INSTRUMENT_AMNT   MONEY, 
         LOC_DESCRIPTION   VARCHAR(100), 
         I_STAT            VARCHAR(10), 
         ENRICH_VALUE      VARCHAR(10), 
         NARRATION         VARCHAR(250), 
	 DEPOSIT_FLG CHAR(1),
         VNO               VARCHAR(12), 
         VTYP              INT, 
         BOOKTYPE          VARCHAR(2), 
         VNO_REV           VARCHAR(12), 
         VTYP_REV          VARCHAR(12) 
      ) 
    ON [PRIMARY] 

    SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" 
                   + @FNAME 
                   + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS)" 

    EXEC (@@SQL) 
	print (@@SQL) 

    IF @@ERROR <> 0 
      BEGIN 
          DROP TABLE #RECPAY_TABLE_TMP 

          DROP TABLE #RECPAY_TABLE 

          ROLLBACK TRANSACTION 

          SELECT 
      'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...' 

          RETURN 
      END 

    CREATE TABLE #BANK 
      ( 
         CLTCODE VARCHAR(10) 
      ) 

    INSERT INTO #BANK 
    SELECT DISTINCT LOC_DESCRIPTION 
    FROM   #RECPAY_TABLE_TMP 

    IF @VTYPE = 2 
      BEGIN 
          INSERT INTO #RECPAY_TABLE 
                      (PRODUCT_CO, 
                       INST_NMBR, 
                       INST_DATE, 
                       BENEF_DESCRIPTION, 
                       INSTRUMENT_AMNT, 
                       LOC_DESCRIPTION, 
                       I_STAT, 
                       ENRICH_VALUE, 
                       NARRATION,
		       DEPOSIT_FLG, 
                       VNO, 
                       VTYP, 
                       BOOKTYPE) 
          SELECT DISTINCT PRODUCT_CO, 
                          INST_NMBR, 
                          CONVERT(DATETIME, INST_DATE, 103), 
                          BENEF_DESCRIPTION, 
                          CONVERT(MONEY, INSTRUMENT_AMNT), 
                          LOC_DESCRIPTION, 
                          I_STAT, 
                          ENRICH_VALUE, 
                          NARRATION, 
			  DEPOSIT_FLG,
                          VNO, 
                          VTYP, 
                          BOOKTYPE 
          FROM   #RECPAY_TABLE_TMP R 
                 LEFT OUTER JOIN (SELECT CLTCODE = L.CLTCODE, 
                                         BANK_CODE = L11.CLTCODE, 
                                         DDNO, 
                                         RELAMT, 
                                         VNO = MAX(L.VNO), 
                                         VTYP = MAX(L.VTYP), 
                                         BOOKTYPE = MAX(L.BOOKTYPE) 
                                  FROM   LEDGER L, 
                                         LEDGER1 L1, 
                                         (SELECT VNO, 
                                                 VTYP, 
                                                 BOOKTYPE, 
                                                 CLTCODE 
                                          FROM   LEDGER L12 
                                          WHERE  VTYP = 2 
                                                 AND LNO = 1 
                                                 AND EXISTS(SELECT CLTCODE 
                                                            FROM   #BANK B 
                                                            WHERE  L12.CLTCODE = 
                                                           B.CLTCODE)) L11 
                                  WHERE  L.VNO = L1.VNO 
                                         AND L.VTYP = L1.VTYP 
                                         AND L.BOOKTYPE = L1.BOOKTYPE 
                                         AND L.LNO = L1.LNO 
                                         AND L.VNO = L11.VNO 
                                         AND L.VTYP = L11.VTYP 
                                         AND L.BOOKTYPE = L11.BOOKTYPE 
                                         AND L1.CLEAR_MODE <> 'R' 
                                         AND L.VTYP = 2 
                                  GROUP  BY L.CLTCODE, 
                                            L11.CLTCODE, 
                                            DDNO, 
                                            RELAMT 
                                  HAVING COUNT(1) = 1) R1 
                              ON CLTCODE = ENRICH_VALUE 
                                 AND INST_NMBR = DDNO 
                                 AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT 
                                 AND BANK_CODE = LOC_DESCRIPTION 

          UPDATE #RECPAY_TABLE 
          SET    VTYP_REV = 17 
      END 
    ELSE 
      BEGIN 
          INSERT INTO #RECPAY_TABLE 
                      (PRODUCT_CO, 
                       INST_NMBR, 
                       INST_DATE, 
                       BENEF_DESCRIPTION, 
                       INSTRUMENT_AMNT, 
                       LOC_DESCRIPTION, 
                       I_STAT, 
                       ENRICH_VALUE, 
                       NARRATION, 
		       DEPOSIT_FLG,
                       VNO, 
                       VTYP, 
                       BOOKTYPE) 
          SELECT DISTINCT PRODUCT_CO, 
                          INST_NMBR, 
                          CONVERT(DATETIME, INST_DATE, 103), 
                          BENEF_DESCRIPTION, 
                          CONVERT(MONEY, INSTRUMENT_AMNT), 
                          LOC_DESCRIPTION, 
                          I_STAT, 
                          ENRICH_VALUE, 
                          NARRATION, 
			  DEPOSIT_FLG,
                          VNO, 
                          VTYP, 
                          BOOKTYPE 
          FROM   #RECPAY_TABLE_TMP R 
                 LEFT OUTER JOIN (SELECT CLTCODE, 
                                         DDNO, 
                                         RELAMT, 
                                         VNO = MAX(L.VNO), 
                                         VTYP = MAX(L.VTYP), 
                                         BOOKTYPE = MAX(L.BOOKTYPE) 
                                  FROM   LEDGER L, 
                                         LEDGER1 L1 
                                  WHERE  L.VNO = L1.VNO 
                                         AND L.VTYP = L1.VTYP 
                                         AND L.BOOKTYPE = L1.BOOKTYPE 
                                         AND L.LNO = L1.LNO 
                                         AND L1.CLEAR_MODE <> 'C' 
                                         AND L.VTYP = 3 
                                         AND L1.RELDT = '' 
                                  GROUP  BY CLTCODE, 
                                            DDNO, 
                                            RELAMT 
                                  HAVING COUNT(1) = 1) R1 
                              ON CLTCODE = ENRICH_VALUE 
                                 AND INST_NMBR = DDNO 
                                 AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT 

          UPDATE #RECPAY_TABLE 
          SET    VTYP_REV = 16 
      END 
--select * from #RECPAY_TABLE
---return
    /* SELECT                                               
      @@ERROR_COUNT = COUNT(1)                                               
     FROM                                               
      #RECPAY_TABLE           
     WHERE INST_DATE < CONVERT(VARCHAR(11), GETDATE()- 2, 109)         
                                                    
     IF @@ERROR_COUNT > 1                                               
      BEGIN                                               
       DROP TABLE #RECPAY_TABLE_TMP                                               
       DROP TABLE #RECPAY_TABLE                                               
       ROLLBACK TRANSACTION                                               
       SELECT 'FILE CANNOT BE UPLOADED WITH BACKDATED VDTS.'                            
       RETURN                                               
      END  */ 
    SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109), 
                 @@VTYP = VTYP_REV, 
                 @@BOOKTYPE = BOOKTYPE 
    FROM   #RECPAY_TABLE 

    /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/ 
    SELECT @@BACKDAYS = MAX(NODAYS) 
    FROM   USERWRITESTABLE 
    WHERE  USERCATEGORY = @USERCAT 
           AND VTYP = @@VTYP 
           AND BOOKTYPE = @@BOOKTYPE 

    SELECT @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) 
                               - @@BACKDAYS 

    SELECT @@ERROR_COUNT = ISNULL(COUNT(INST_DATE), 0) 
    FROM   #RECPAY_TABLE 
    WHERE  INST_DATE < @@BACKDATE 

    IF @@ERROR_COUNT > 0 
      BEGIN 
          SELECT 
'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET' 
, 
'NA', 
'NA' 

    DROP TABLE #RECPAY_TABLE_TMP 

    DROP TABLE #RECPAY_TABLE 

    ROLLBACK TRAN 

    DELETE FROM V2_UPLOADED_FILES 
    WHERE  U_FILENAME = @FNAME 
           AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD' 

    RETURN 
END 

    SELECT @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109), 
           @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109), 
           @@BRANCHFLAG = BRANCHFLAG, 
           @@VNOFLAG = VNOFLAG 
    FROM   PARAMETER 
    WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR 

    IF @@VNOFLAG <> 0 
      BEGIN 
          SELECT @@ERROR_COUNT = COUNT(DISTINCT INST_DATE) 
          FROM   #RECPAY_TABLE 

          IF @@ERROR_COUNT > 1 
            BEGIN 
                DROP TABLE #RECPAY_TABLE_TMP 

                DROP TABLE #RECPAY_TABLE 

                ROLLBACK TRANSACTION 

                SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTS.' 

                RETURN 
            END 
      END 

    SELECT @@ERROR_COUNT = COUNT(1) 
    FROM   #RECPAY_TABLE 
    WHERE  VNO IS NULL 

    IF @@ERROR_COUNT > 0 
      BEGIN 
          SELECT 
      'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.' 
          UNION ALL 
          SELECT 'CLTCODE , DDNO , AMOUNT, BANK_CODE ' 
          UNION ALL 
          SELECT ENRICH_VALUE + ' , ' + INST_NMBR + ' , ' 
                 + CONVERT(VARCHAR, INSTRUMENT_AMNT) + ' , ' 
                 + LOC_DESCRIPTION AS RESULT 
          FROM   #RECPAY_TABLE 
          WHERE  VNO IS NULL 

          DROP TABLE #RECPAY_TABLE_TMP 

          DROP TABLE #RECPAY_TABLE 

          ROLLBACK TRANSACTION 

          RETURN 
      END 

    CREATE TABLE #VNO 
      ( 
         LASTVNO VARCHAR(12), 
      ) 

    SELECT @@MAXVNO = MAX(SRNO) 
    FROM   #RECPAY_TABLE 

    INSERT INTO #VNO 
    EXEC ACC_GENVNO_NEW 
      @@VDT, 
      @@VTYP, 
      @@BOOKTYPE, 
      @@STD_DATE, 
      @@LST_DATE, 
      @@MAXVNO 

    SELECT @@NEWVNO = LASTVNO 
    FROM   #VNO 

    UPDATE #RECPAY_TABLE 
    SET    VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1 

	--SELECT * INTO INDRAJIT FROM #RECPAY_TABLE
    INSERT INTO LEDGER 
                (VTYP, 
                 VNO, 
                 EDT, 
                 LNO, 
                 ACNAME, 
                 DRCR, 
                 VAMT, 
                 VDT, 
                 VNO1, 
                 REFNO, 
                 BALAMT, 
                 NODAYS, 
                 CDT, 
                 CLTCODE, 
                 BOOKTYPE, 
                 ENTEREDBY, 
                 PDT, 
                 CHECKEDBY, 
                 ACTNODAYS, 
                 NARRATION) 
    SELECT VTYP_REV, 
           VNO_REV, 
           INST_DATE, 
           LNO, 
           ACNAME, 
           CASE 
             WHEN DRCR = 'D' THEN 'C' 
             ELSE 'D' 
           END, 
           VAMT, 
           INST_DATE, 
           VNO1, 
           REFNO, 
           BALAMT, 
           NODAYS, 
           GETDATE(), 
           CLTCODE, 
           L.BOOKTYPE, 
           @UNAME, 
           GETDATE(), 
           @UNAME, 
           ACTNODAYS, 
           CASE WHEN DEPOSIT_FLG = 'N' THEN 'CHEQUE REVERSE ' END + R.NARRATION 
    FROM   LEDGER L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    INSERT INTO LEDGER1 
                (BNKNAME, 
                 BRNNAME, 
                 DD, 
                 DDNO, 
                 DDDT, 
                 RELDT, 
                 RELAMT, 
                 REFNO, 
                 RECEIPTNO, 
                 VTYP, 
                 VNO, 
                 LNO, 
                 DRCR, 
                 BOOKTYPE, 
                 MICRNO, 
                 SLIPNO, 
                 SLIPDATE, 
                 CHEQUEINNAME, 
                 CHQPRINTED, 
                 CLEAR_MODE) 
    SELECT BNKNAME, 
           BRNNAME, 
           DD, 
           DDNO, 
           DDDT, 
           RELDT = CASE WHEN DEPOSIT_FLG = 'N' AND @VTYPE = 2 THEN INST_DATE ELSE '' END,
           RELAMT, 
           '',
           RECEIPTNO, 
           VTYP_REV, 
           VNO_REV, 
           LNO, 
           CASE 
             WHEN DRCR = 'D' THEN 'C' 
             ELSE 'D' 
           END, 
           L.BOOKTYPE, 
           MICRNO, 
           SLIPNO, 
           SLIPDATE, 
           CHEQUEINNAME, 
           CHQPRINTED, 
           CLEAR_MODE 
    FROM   LEDGER1 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    INSERT INTO LEDGER2 
                (VTYPE, 
                 VNO, 
                 LNO, 
                 DRCR, 
                 CAMT, 
                 COSTCODE, 
                 BOOKTYPE, 
                 CLTCODE) 
    SELECT VTYP_REV, 
           VNO_REV, 
           LNO, 
           CASE 
             WHEN DRCR = 'D' THEN 'C' 
             ELSE 'D' 
           END, 
           CAMT, 
           COSTCODE, 
           L.BOOKTYPE, 
           CLTCODE 
    FROM   LEDGER2 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYPE = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    INSERT INTO LEDGER3 
                (NARATNO, 
                 NARR, 
                 REFNO, 
                 VTYP, 
                 VNO, 
                 BOOKTYPE) 
    SELECT NARATNO, 
           R.NARRATION, 
           REFNO, 
           VTYP_REV, 
           VNO_REV, 
           L.BOOKTYPE 
    FROM   LEDGER3 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    UPDATE L 
    SET    CLEAR_MODE = CASE 
                          WHEN @VTYPE = 2 THEN 'R' 
                          ELSE 'C' 
                        END, 
RELDT = CASE WHEN DEPOSIT_FLG = 'N' AND @VTYPE = 2 THEN INST_DATE ELSE '' END 
 
    FROM   LEDGER1 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    SELECT 'FILE UPLOADED SUCCESSFULLY' 
    UNION ALL 
    SELECT 'VNO, VTYP, RECEIPT_VNO' 
    UNION ALL 
    SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT 
    FROM   #RECPAY_TABLE 

    COMMIT 
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK_08122010
-- --------------------------------------------------
CREATE PROC [dbo].[RETURNCANCEL_BULK_08122010]            
 @FNAME VARCHAR(100),          
 @UNAME VARCHAR(25),          
 @USERCAT SMALLINT          
                              
AS                              
/*                              
begin tran                              
SP_HELPTRIGGER LEDGER                              
LEDGER_TRG_BILL                              
LEDGER_TRG                              
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388                              
SELECT TOP 1 * FROM LEDGER3                              
SELECT TOP 1 * FROM LEDGER_TRG                              
ROLLBACK                              
*/                              
SET NOCOUNT ON                              
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                              
DECLARE                              
 @@STD_DATE VARCHAR(11),                              
 @@LST_DATE VARCHAR(11),                              
 @@BRANCHFLAG AS TINYINT,                              
 @@VNOFLAG AS TINYINT,                              
 @@VNOMETHOD INT,                              
 @@ACNAME CHAR(100),                              
 @@BOOKTYPE CHAR(2),                              
 @@MICRNO VARCHAR(10),                              
 @@DRCR VARCHAR(1),                              
 @@VTYP SMALLINT,                              
 @@BANK_CODE VARCHAR(100),                              
 @@BACKDAYS INT,                              
 @@BACKDATE VARCHAR(11),                              
 @@BRNCOUNT   TINYINT,                              
 @@MonthlyVdt VARCHAR(11),                              
 @@SERIAL_NO INT,                              
 @@COSTCODECOUNT TINYINT,                              
 @@COSTCODEUPDATES CURSOR,                              
 @@NEWVNO AS VARCHAR(12),                              
 @@MAXCOUNT AS INT,                              
 @@VDT AS VARCHAR(11),                              
 @@BANKBRANCH AS VARCHAR(10),                              
 @@BANKCOST AS NUMERIC,                              
 @@LNOCUR AS CURSOR,                              
 @@VNOCUR AS CURSOR,                              
 @@LNOVNO AS VARCHAR(12),                              
 @@MAXVNO AS INT,                              
 @@L2CUR AS CURSOR,                              
 @@L2VNO AS VARCHAR(12),                              
 @@ERROR_COUNT AS INT,                              
 @@FILEEXISTS AS INT,                              
 @@SQL AS VARCHAR(2000)                              
                              
                    
CREATE TABLE #FEXIST                              
(                              
 F1 SMALLINT,                              
 F2 SMALLINT,                              
 F3 SMALLINT                              
)                              
SELECT @@SQL = "INSERT INTO "                              
SELECT @@SQL = @@SQL + " #FEXIST "                              
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                              
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                              
                              
EXEC(@@SQL)                              
                              
SELECT                              
 @@FILEEXISTS = F1                              
FROM                              
 #FEXIST                              
                              
IF @@FILEEXISTS = 0                              
 BEGIN                              
  DROP TABLE #FEXIST                              
  SELECT                              
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                              
  RETURN                              
 END                              
DROP TABLE #FEXIST                              
                              
BEGIN TRAN                              
CREATE TABLE #RECPAY_TABLE_TMP                              
(                
 PRODUCT_CO VARCHAR(10),          
 INST_NMBR VARCHAR(10),          
 INST_DATE VARCHAR(10),          
 BENEF_DESCRIPTION  VARCHAR(200),          
 INSTRUMENT_AMNT  VARCHAR(50),          
 LOC_DESCRIPTION VARCHAR(100),          
 I_STAT VARCHAR(10),          
 ENRICH_VALUE VARCHAR(10),          
 NARRATION VARCHAR(250)          
)                 
      
CREATE TABLE [#RECPAY_TABLE]                              
(          
 SRNO INT IDENTITY(1,1),          
 PRODUCT_CO VARCHAR(10),          
 INST_NMBR VARCHAR(10),          
 INST_DATE DATETIME,          
 BENEF_DESCRIPTION  VARCHAR(200),          
 INSTRUMENT_AMNT  MONEY,          
 LOC_DESCRIPTION VARCHAR(100),          
 I_STAT VARCHAR(10),          
 ENRICH_VALUE VARCHAR(10),          
 NARRATION VARCHAR(250),          
 VNO VARCHAR(12),          
 VTYP INT,          
 BOOKTYPE VARCHAR(2),   VNO_REV VARCHAR(12),          
 VTYP_REV VARCHAR(12)          
) ON [PRIMARY]          
                              
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                              
EXEC (@@SQL)                              
                              
IF @@ERROR <> 0                              
 BEGIN                              
  DROP TABLE #RECPAY_TABLE_TMP                              
  DROP TABLE #RECPAY_TABLE                              
  ROLLBACK TRANSACTION                              
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                              
  RETURN                              
 END                              
          
          
INSERT INTO #RECPAY_TABLE          
(          
 PRODUCT_CO,          
 INST_NMBR,          
 INST_DATE,          
 BENEF_DESCRIPTION,          
 INSTRUMENT_AMNT,          
 LOC_DESCRIPTION,          
 I_STAT,          
 ENRICH_VALUE,          
 NARRATION,          
 VNO,          
 VTYP,          
 BOOKTYPE          
)          
SELECT          
 PRODUCT_CO,          
 INST_NMBR,          
 CONVERT(DATETIME, INST_DATE, 103),          
 BENEF_DESCRIPTION,          
 CONVERT(MONEY, INSTRUMENT_AMNT),          
 LOC_DESCRIPTION,          
 I_STAT,          
 ENRICH_VALUE,          
 NARRATION,          
 VNO,          
 VTYP,          
 BOOKTYPE          
FROM          
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN          
 (          
  SELECT           
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)          
  FROM           
   LEDGER L,           
   LEDGER1 L1          
  WHERE           
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO          
   AND L1.CLEAR_MODE <> 'R' AND L.VTYP = 2          
  GROUP BY CLTCODE, DDNO, RELAMT          
  HAVING COUNT(1) = 1          
 ) R1          
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT          
          
          
UPDATE #RECPAY_TABLE SET VTYP_REV = 17          
          
SELECT TOP 1                              
 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109),          
 @@VTYP = VTYP_REV,          
 @@BOOKTYPE = BOOKTYPE                          
FROM                              
 #RECPAY_TABLE                              
                        
                        
SELECT                              
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                              
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                              
 @@BRANCHFLAG = BRANCHFLAG,                              
 @@VNOFLAG = VNOFLAG                              
FROM                              
 PARAMETER                              
WHERE                              
 @@VDT BETWEEN SDTCUR AND LDTCUR                           
                              
IF @@VNOFLAG <> 0                         
BEGIN                             
 SELECT                              
  @@ERROR_COUNT = COUNT(DISTINCT INST_DATE)                              
 FROM                              
  #RECPAY_TABLE                        
                               
 IF @@ERROR_COUNT > 1                              
  BEGIN                              
   DROP TABLE #RECPAY_TABLE_TMP                              
   DROP TABLE #RECPAY_TABLE                              
   ROLLBACK TRANSACTION                              
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                              
   RETURN                              
  END                            
END             
          
          
          
SELECT                              
  @@ERROR_COUNT = COUNT(1)                              
 FROM                              
  #RECPAY_TABLE             
WHERE           
 VNO IS NULL          
          
IF @@ERROR_COUNT > 0                         
BEGIN           
 SELECT 'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.'          
 UNION ALL          
 SELECT 'CLTCODE , DDNO , AMOUNT '          
 UNION ALL          
 SELECT ENRICH_VALUE + ' , ' +  INST_NMBR + ' , ' + CONVERT(VARCHAR, INSTRUMENT_AMNT) AS RESULT          
 FROM                 
  #RECPAY_TABLE          
 WHERE           
  VNO IS NULL          
          
 DROP TABLE #RECPAY_TABLE_TMP          
 DROP TABLE #RECPAY_TABLE          
 ROLLBACK TRANSACTION          
           
   RETURN          
END          
          
CREATE TABLE #VNO          
(          
 LASTVNO VARCHAR(12),          
)          
              
SELECT @@MAXVNO = MAX(SRNO) FROM #RECPAY_TABLE                              
          
INSERT                              
INTO #VNO                              
 EXEC ACC_GENVNO_NEW                              
  @@VDT,                              
  @@VTYP,                              
  @@BOOKTYPE,                              
  @@STD_DATE,                              
  @@LST_DATE,                              
  @@MAXVNO                  
                      
SELECT                              
 @@NEWVNO = LASTVNO          
FROM                              
 #VNO              
 select * from #RECPAY_TABLE        
UPDATE #RECPAY_TABLE SET VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1          
          
INSERT INTO LEDGER(VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION)          
SELECT VTYP_REV,VNO_REV,INST_DATE,LNO,ACNAME,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,VAMT,INST_DATE,VNO1,REFNO,BALAMT,NODAYS,GETDATE(),CLTCODE,L.BOOKTYPE,@UNAME,GETDATE(),@UNAME,ACTNODAYS,R.NARRATION           
FROM LEDGER L, #RECPAY_TABLE R          
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE    
          
INSERT INTO LEDGER1(BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE)          
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,'JAN 01 1900',RELAMT,'',RECEIPTNO,VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,L.BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE          
FROM LEDGER1 L, #RECPAY_TABLE R          
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE          
          
INSERT INTO LEDGER2(VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE)          
SELECT VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,CAMT,COSTCODE,L.BOOKTYPE,CLTCODE          
FROM LEDGER2 L, #RECPAY_TABLE R          
WHERE L.VNO = R.VNO AND L.VTYPE = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE          
          
          
INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)          
SELECT NARATNO,R.NARRATION,REFNO,VTYP_REV,VNO_REV,L.BOOKTYPE          
FROM LEDGER3 L, #RECPAY_TABLE R          
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE          
          
UPDATE L SET CLEAR_MODE = 'R'          
FROM LEDGER1 L, #RECPAY_TABLE R          
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE           
          
SELECT 'FILE UPLOADED SUCCESSFULLY'          
UNION ALL          
SELECT 'VNO, VTYP, RECEIPT_VNO'          
UNION ALL          
SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT          
FROM                 
 #RECPAY_TABLE          
          
COMMIT        
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK_08122010_1
-- --------------------------------------------------

CREATE PROC [dbo].[RETURNCANCEL_BULK_08122010_1]              
 @VTYPE TINYINT,  
 @FNAME VARCHAR(100),            
 @UNAME VARCHAR(25),            
 @USERCAT SMALLINT            
                                
AS                                
/*                                
begin tran                                
SP_HELPTRIGGER LEDGER                                
LEDGER_TRG_BILL                                
LEDGER_TRG                                
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388                                
SELECT TOP 1 * FROM LEDGER3                                
SELECT TOP 1 * FROM LEDGER_TRG                                
ROLLBACK                                
*/                                
SET NOCOUNT ON                                
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                                
DECLARE                                
 @@STD_DATE VARCHAR(11),                                
 @@LST_DATE VARCHAR(11),                                
 @@BRANCHFLAG AS TINYINT,                                
 @@VNOFLAG AS TINYINT,                                
 @@VNOMETHOD INT,                                
 @@ACNAME CHAR(100),                                
 @@BOOKTYPE CHAR(2),                                
 @@MICRNO VARCHAR(10),                                
 @@DRCR VARCHAR(1),                                
 @@VTYP SMALLINT,                                
 @@BANK_CODE VARCHAR(100),                                
 @@BACKDAYS INT,                                
 @@BACKDATE VARCHAR(11),                                
 @@BRNCOUNT   TINYINT,                                
 @@MonthlyVdt VARCHAR(11),                                
 @@SERIAL_NO INT,                                
 @@COSTCODECOUNT TINYINT,                                
 @@COSTCODEUPDATES CURSOR,                                
 @@NEWVNO AS VARCHAR(12),                                
 @@MAXCOUNT AS INT,                                
 @@VDT AS VARCHAR(11),                                
 @@BANKBRANCH AS VARCHAR(10),                                
 @@BANKCOST AS NUMERIC,                                
 @@LNOCUR AS CURSOR,                                
 @@VNOCUR AS CURSOR,                                
 @@LNOVNO AS VARCHAR(12),                                
 @@MAXVNO AS INT,                                
 @@L2CUR AS CURSOR,                                
 @@L2VNO AS VARCHAR(12),                                
 @@ERROR_COUNT AS INT,                                
 @@FILEEXISTS AS INT,                                
 @@SQL AS VARCHAR(2000)                                
                                
                      
CREATE TABLE #FEXIST                                
(                                
 F1 SMALLINT,                                
 F2 SMALLINT,                                
 F3 SMALLINT                                
)                                
SELECT @@SQL = "INSERT INTO "                                
SELECT @@SQL = @@SQL + " #FEXIST "                                
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                                
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                                
                                
EXEC(@@SQL)                                
                                
SELECT                                
 @@FILEEXISTS = F1                                
FROM                                
 #FEXIST                                
                                
IF @@FILEEXISTS = 0                                
 BEGIN                                
  DROP TABLE #FEXIST                                
  SELECT                                
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                                
  RETURN                                
 END                                
DROP TABLE #FEXIST                               
                                
BEGIN TRAN                                
CREATE TABLE #RECPAY_TABLE_TMP                                
(                  
 PRODUCT_CO VARCHAR(10),            
 INST_NMBR VARCHAR(10),            
 INST_DATE VARCHAR(10),            
 BENEF_DESCRIPTION  VARCHAR(200),            
 INSTRUMENT_AMNT  VARCHAR(50),            
 LOC_DESCRIPTION VARCHAR(100),            
 I_STAT VARCHAR(10),            
 ENRICH_VALUE VARCHAR(10),            
 NARRATION VARCHAR(250)            
)                   
        
CREATE TABLE [#RECPAY_TABLE]                                
(            
 SRNO INT IDENTITY(1,1),            
 PRODUCT_CO VARCHAR(10),            
 INST_NMBR VARCHAR(10),            
 INST_DATE DATETIME,            
 BENEF_DESCRIPTION  VARCHAR(200),            
 INSTRUMENT_AMNT  MONEY,            
 LOC_DESCRIPTION VARCHAR(100),            
 I_STAT VARCHAR(10),            
 ENRICH_VALUE VARCHAR(10),            
 NARRATION VARCHAR(250),            
 VNO VARCHAR(12),            
 VTYP INT,            
 BOOKTYPE VARCHAR(2),   VNO_REV VARCHAR(12),            
 VTYP_REV VARCHAR(12)            
) ON [PRIMARY]            
                                
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                                
EXEC (@@SQL)                                
                                
IF @@ERROR <> 0                                
 BEGIN                                
  DROP TABLE #RECPAY_TABLE_TMP                                
  DROP TABLE #RECPAY_TABLE                                
  ROLLBACK TRANSACTION                                
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                                
  RETURN                                
 END                                
            
IF @VTYPE = 2  
BEGIN            
INSERT INTO #RECPAY_TABLE            
(            
 PRODUCT_CO,            
 INST_NMBR,            
 INST_DATE,            
 BENEF_DESCRIPTION,            
 INSTRUMENT_AMNT,            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
)            
SELECT            
 PRODUCT_CO,            
 INST_NMBR,            
 CONVERT(DATETIME, INST_DATE, 103),            
 BENEF_DESCRIPTION,            
 CONVERT(MONEY, INSTRUMENT_AMNT),            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
FROM            
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN            
 (            
  SELECT             
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)            
  FROM             
   LEDGER L,             
   LEDGER1 L1            
  WHERE             
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO            
   AND L1.CLEAR_MODE <> 'R' AND L.VTYP = 2            
  GROUP BY CLTCODE, DDNO, RELAMT            
  HAVING COUNT(1) = 1            
 ) R1            
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT            
  
 UPDATE #RECPAY_TABLE SET VTYP_REV = 17   
END  
ELSE  
BEGIN  
INSERT INTO #RECPAY_TABLE            
(            
 PRODUCT_CO,            
 INST_NMBR,            
 INST_DATE,            
 BENEF_DESCRIPTION,            
 INSTRUMENT_AMNT,            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
)            
SELECT            
 PRODUCT_CO,            
 INST_NMBR,            
 CONVERT(DATETIME, INST_DATE, 103),            
 BENEF_DESCRIPTION,            
 CONVERT(MONEY, INSTRUMENT_AMNT),            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
FROM         
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN            
 (            
  SELECT             
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)            
  FROM             
   LEDGER L,             
   LEDGER1 L1            
  WHERE             
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO            
   AND L1.CLEAR_MODE <> 'C' AND L.VTYP = 3  
  GROUP BY CLTCODE, DDNO, RELAMT            
  HAVING COUNT(1) = 1            
 ) R1            
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT   
  
 UPDATE #RECPAY_TABLE SET VTYP_REV = 16  
END  
            
            
SELECT TOP 1                                
 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109),            
 @@VTYP = VTYP_REV,            
 @@BOOKTYPE = BOOKTYPE                            
FROM                                
 #RECPAY_TABLE                                
                          
                          
SELECT                                
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                                
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                                
 @@BRANCHFLAG = BRANCHFLAG,                                
 @@VNOFLAG = VNOFLAG                                
FROM                                
 PARAMETER                                
WHERE                                
 @@VDT BETWEEN SDTCUR AND LDTCUR                             
                                
IF @@VNOFLAG <> 0                           
BEGIN                               
 SELECT                                
  @@ERROR_COUNT = COUNT(DISTINCT INST_DATE)                                
 FROM                                
  #RECPAY_TABLE                          
                                 
 IF @@ERROR_COUNT > 1                                
  BEGIN                                
   DROP TABLE #RECPAY_TABLE_TMP                                
   DROP TABLE #RECPAY_TABLE                                
   ROLLBACK TRANSACTION                                
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                
   RETURN                                
  END                              
END               
            
            
            
SELECT                                
  @@ERROR_COUNT = COUNT(1)                                
 FROM                                
  #RECPAY_TABLE               
WHERE             
 VNO IS NULL            
            
IF @@ERROR_COUNT > 0                           
BEGIN             
 SELECT 'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.'            
 UNION ALL            
 SELECT 'CLTCODE , DDNO , AMOUNT '            
 UNION ALL            
 SELECT ENRICH_VALUE + ' , ' +  INST_NMBR + ' , ' + CONVERT(VARCHAR, INSTRUMENT_AMNT) AS RESULT            
 FROM                   
  #RECPAY_TABLE            
 WHERE             
  VNO IS NULL            
            
 DROP TABLE #RECPAY_TABLE_TMP            
 DROP TABLE #RECPAY_TABLE            
 ROLLBACK TRANSACTION            
             
   RETURN            
END            
            
CREATE TABLE #VNO            
(            
 LASTVNO VARCHAR(12),            
)            
                
SELECT @@MAXVNO = MAX(SRNO) FROM #RECPAY_TABLE                                
            
INSERT                                
INTO #VNO                                
 EXEC ACC_GENVNO_NEW                                
  @@VDT,                                
  @@VTYP,                                
  @@BOOKTYPE,                                
  @@STD_DATE,                                
  @@LST_DATE,                                
  @@MAXVNO                    
                        
SELECT                                
 @@NEWVNO = LASTVNO            
FROM                                
 #VNO                
         
UPDATE #RECPAY_TABLE SET VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1            
            
INSERT INTO LEDGER(VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION)            
SELECT VTYP_REV,VNO_REV,INST_DATE,LNO,ACNAME,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,VAMT,INST_DATE,VNO1,REFNO,BALAMT,NODAYS,GETDATE(),CLTCODE,L.BOOKTYPE,@UNAME,GETDATE(),@UNAME,ACTNODAYS,R.NARRATION             
FROM LEDGER L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE      
            
INSERT INTO LEDGER1(BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE)            
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,CASE WHEN @VTYPE = 2 THEN 'JAN 01 1900' ELSE INST_DATE END,RELAMT,'',RECEIPTNO,VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,L.BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE       
     
FROM LEDGER1 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE            
            
INSERT INTO LEDGER2(VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE)            
SELECT VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,CAMT,COSTCODE,L.BOOKTYPE,CLTCODE            
FROM LEDGER2 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYPE = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE            
            
            
INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)            
SELECT NARATNO,R.NARRATION,REFNO,VTYP_REV,VNO_REV,L.BOOKTYPE            
FROM LEDGER3 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE            
            
UPDATE L SET CLEAR_MODE = CASE WHEN @VTYPE = 2 THEN 'R' ELSE 'C' END  
FROM LEDGER1 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE             
            
SELECT 'FILE UPLOADED SUCCESSFULLY'            
UNION ALL            
SELECT 'VNO, VTYP, RECEIPT_VNO'            
UNION ALL            
SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT            
FROM                   
 #RECPAY_TABLE            
            
COMMIT          
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK_27032012
-- --------------------------------------------------
CREATE PROC [dbo].[RETURNCANCEL_BULK_27032012]                      
 @VTYPE SMALLINT,        
 @FNAME VARCHAR(100),                    
 @UNAME VARCHAR(25),                    
 @USERCAT SMALLINT                    
                                        
AS                                        
/*                                        
BEGIN TRAN                                        
SP_HELPTRIGGER LEDGER                                        
LEDGER_TRG_BILL                                        
LEDGER_TRG                                        
EXEC RECPAYUPLOAD_BULK 'D:\BACKOFFICE\RECPAYFILES\SAMPLE1.CSV', 'JAYDEEP', 388                                        
SELECT TOP 1 * FROM LEDGER3                                        
SELECT TOP 1 * FROM LEDGER_TRG                                        
ROLLBACK                                        
*/                                        
SET NOCOUNT ON                                        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE B ASED ON DRCR ------------------------*/                                        
DECLARE                                        
 @@STD_DATE VARCHAR(11),                                        
 @@LST_DATE VARCHAR(11),                                        
 @@BRANCHFLAG AS TINYINT,                                        
 @@VNOFLAG AS TINYINT,                                        
 @@VNOMETHOD INT,                                        
 @@ACNAME CHAR(100),                                        
 @@BOOKTYPE CHAR(2),                                        
 @@MICRNO VARCHAR(10),                                        
 @@DRCR VARCHAR(1),                                        
 @@VTYP SMALLINT,                                        
 @@BANK_CODE VARCHAR(100),                                        
 @@BACKDAYS INT,                                        
 @@BACKDATE VARCHAR(11),                                        
 @@BRNCOUNT   TINYINT,                                        
 @@MONTHLYVDT VARCHAR(11),                                        
 @@SERIAL_NO INT,                                        
 @@COSTCODECOUNT TINYINT,                                        
 @@COSTCODEUPDATES CURSOR,                                        
 @@NEWVNO AS VARCHAR(12),                                        
 @@MAXCOUNT AS INT,                                        
 @@VDT AS VARCHAR(11),                                        
 @@BANKBRANCH AS VARCHAR(10),                                        
 @@BANKCOST AS NUMERIC,                                        
 @@LNOCUR AS CURSOR,                                        
 @@VNOCUR AS CURSOR,                                        
 @@LNOVNO AS VARCHAR(12),                                        
 @@MAXVNO AS INT,                                        
 @@L2CUR AS CURSOR,                                        
 @@L2VNO AS VARCHAR(12),                                        
 @@ERROR_COUNT AS INT,                                        
 @@FILEEXISTS AS INT,                                        
 @@SQL AS VARCHAR(2000)                                        
                                        
                              
CREATE TABLE #FEXIST                                        
(                                        
 F1 SMALLINT,                                        
 F2 SMALLINT,                                        
 F3 SMALLINT                                        
)                                        
SELECT @@SQL = "INSERT INTO "                                        
SELECT @@SQL = @@SQL + " #FEXIST "                                        
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                                        
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                                        
                                        
EXEC(@@SQL)                                        
                                        
SELECT                                        
 @@FILEEXISTS = F1                                        
FROM                                        
 #FEXIST        
                                        
IF @@FILEEXISTS = 0                                        
 BEGIN                                        
  DROP TABLE #FEXIST                                        
  SELECT                                        
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                                        
  RETURN                                        
 END                                        
DROP TABLE #FEXIST                                       
                                        
BEGIN TRAN                                        
CREATE TABLE #RECPAY_TABLE_TMP                                        
(                          
 PRODUCT_CO VARCHAR(10),                    
 INST_NMBR VARCHAR(15),                    
 INST_DATE VARCHAR(10),                    
 BENEF_DESCRIPTION  VARCHAR(200),                    
 INSTRUMENT_AMNT  VARCHAR(50),                    
 LOC_DESCRIPTION VARCHAR(100),                    
 I_STAT VARCHAR(10),                    
 ENRICH_VALUE VARCHAR(10),                    
 NARRATION VARCHAR(250)                    
)                           
                
CREATE TABLE [#RECPAY_TABLE]                                        
(                    
 SRNO INT IDENTITY(1,1),                    
 PRODUCT_CO VARCHAR(10),                    
 INST_NMBR VARCHAR(15),                    
 INST_DATE DATETIME,                    
 BENEF_DESCRIPTION  VARCHAR(200),                    
 INSTRUMENT_AMNT  MONEY,                    
 LOC_DESCRIPTION VARCHAR(100),                    
 I_STAT VARCHAR(10),                    
 ENRICH_VALUE VARCHAR(10),                    
 NARRATION VARCHAR(250),                    
 VNO VARCHAR(12),                    
 VTYP INT,                    
 BOOKTYPE VARCHAR(2),   VNO_REV VARCHAR(12),                    
 VTYP_REV VARCHAR(12)                    
) ON [PRIMARY]                    
                                        
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                                        
EXEC (@@SQL)                                        
                                        
IF @@ERROR <> 0                                        
 BEGIN                                        
  DROP TABLE #RECPAY_TABLE_TMP                                        
  DROP TABLE #RECPAY_TABLE                                        
  ROLLBACK TRANSACTION                                        
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                                        
  RETURN                                        
 END                                        
                    
IF @VTYPE = 2          
BEGIN                    
INSERT INTO #RECPAY_TABLE                    
(                    
 PRODUCT_CO,                    
 INST_NMBR,                    
 INST_DATE,                    
 BENEF_DESCRIPTION,                    
 INSTRUMENT_AMNT,                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
)                    
SELECT    
 DISTINCT PRODUCT_CO,                    
 INST_NMBR,                    
 CONVERT(DATETIME, INST_DATE, 103),                    
 BENEF_DESCRIPTION,                    
 CONVERT(MONEY, INSTRUMENT_AMNT),                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
FROM                    
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN                    
 (                    
  SELECT                     
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)                    
  FROM                     
   LEDGER L,                     
   LEDGER1 L1                    
  WHERE                     
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO                    
   AND L1.CLEAR_MODE <> 'R' AND L.VTYP = 2    
  GROUP BY CLTCODE, DDNO, RELAMT                    
  HAVING COUNT(1) = 1                    
 ) R1                    
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT                    
          
 UPDATE #RECPAY_TABLE SET VTYP_REV = 17           
END          
ELSE          
BEGIN         
INSERT INTO #RECPAY_TABLE    
(                    
 PRODUCT_CO,                    
 INST_NMBR,                    
 INST_DATE,                    
 BENEF_DESCRIPTION,                    
 INSTRUMENT_AMNT,                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
)                    
SELECT                    
 DISTINCT PRODUCT_CO,                    
 INST_NMBR,                    
 CONVERT(DATETIME, INST_DATE, 103),                    
 BENEF_DESCRIPTION,                    
 CONVERT(MONEY, INSTRUMENT_AMNT),                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
FROM                 
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN                    
 (                    
  SELECT                     
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)                    
  FROM                     
   LEDGER L,                     
   LEDGER1 L1                    
  WHERE                     
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO                    
   AND L1.CLEAR_MODE <> 'C' AND L.VTYP = 3 AND L1.RELDT = ''         
  GROUP BY CLTCODE, DDNO, RELAMT                    
  HAVING COUNT(1) = 1                    
 ) R1                    
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT           
          
 UPDATE #RECPAY_TABLE SET VTYP_REV = 16          
END    
    
 SELECT                                        
  @@ERROR_COUNT = COUNT(1)                                        
 FROM                                        
  #RECPAY_TABLE    
 WHERE INST_DATE < CONVERT(VARCHAR(11), GETDATE()- 2, 109)  
                                         
 IF @@ERROR_COUNT > 1                                        
  BEGIN                                        
   DROP TABLE #RECPAY_TABLE_TMP                                        
   DROP TABLE #RECPAY_TABLE                                        
   ROLLBACK TRANSACTION                                        
   SELECT 'FILE CANNOT BE UPLOADED WITH BACKDATED VDTS.'                                        
   RETURN                                        
  END           
                    
                    
SELECT TOP 1                                        
 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109),                    
 @@VTYP = VTYP_REV,                    
 @@BOOKTYPE = BOOKTYPE                                    
FROM                                        
 #RECPAY_TABLE                                        
                                  
                                  
SELECT                                        
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                                        
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                                        
 @@BRANCHFLAG = BRANCHFLAG,                                        
 @@VNOFLAG = VNOFLAG                                        
FROM                                        
 PARAMETER                                        
WHERE                                   
 @@VDT BETWEEN SDTCUR AND LDTCUR                                     
                                        
IF @@VNOFLAG <> 0                                   
BEGIN                                       
 SELECT                                        
  @@ERROR_COUNT = COUNT(DISTINCT INST_DATE)                                        
 FROM                                        
  #RECPAY_TABLE                                  
               
 IF @@ERROR_COUNT > 1                                        
  BEGIN                                        
   DROP TABLE #RECPAY_TABLE_TMP                                        
   DROP TABLE #RECPAY_TABLE                                        
   ROLLBACK TRANSACTION                                        
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTS.'                                        
   RETURN                                        
  END                                      
END                       
                    
                    
                    
SELECT                                        
  @@ERROR_COUNT = COUNT(1)                                        
 FROM                                        
  #RECPAY_TABLE                       
WHERE                     
 VNO IS NULL                    
                    
IF @@ERROR_COUNT > 0                                   
BEGIN                     
 SELECT 'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.'                    
 UNION ALL                    
 SELECT 'CLTCODE , DDNO , AMOUNT '                    
 UNION ALL                    
 SELECT ENRICH_VALUE + ' , ' +  INST_NMBR + ' , ' + CONVERT(VARCHAR, INSTRUMENT_AMNT) AS RESULT                    
 FROM       
  #RECPAY_TABLE                    
 WHERE                     
  VNO IS NULL                    
                    
 DROP TABLE #RECPAY_TABLE_TMP                    
 DROP TABLE #RECPAY_TABLE                    
 ROLLBACK TRANSACTION                    
                     
   RETURN                    
END                    
                    
CREATE TABLE #VNO                    
(                    
 LASTVNO VARCHAR(12),                    
)                    
                        
SELECT @@MAXVNO = MAX(SRNO) FROM #RECPAY_TABLE                                        
                    
INSERT                                        
INTO #VNO                           
 EXEC ACC_GENVNO_NEW                                        
  @@VDT,                                        
  @@VTYP,                                        
  @@BOOKTYPE,                                        
  @@STD_DATE,                                        
  @@LST_DATE,                                        
  @@MAXVNO                            
                                
SELECT                                        
 @@NEWVNO = LASTVNO                    
FROM                                        
 #VNO                        
                 
UPDATE #RECPAY_TABLE SET VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1                    
                    
INSERT INTO LEDGER(VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION)                    
SELECT VTYP_REV,VNO_REV,INST_DATE,LNO,ACNAME,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,VAMT,INST_DATE,VNO1,REFNO,BALAMT,NODAYS,GETDATE(),CLTCODE,L.BOOKTYPE,@UNAME,GETDATE(),@UNAME,ACTNODAYS,R.NARRATION                     
FROM LEDGER L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE              
                    
INSERT INTO LEDGER1(BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE)                    
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,CASE WHEN @VTYPE = 2 THEN 'JAN 01 1900' ELSE INST_DATE END,RELAMT,'',RECEIPTNO,VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,L.BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE       
  
    
      
        
             
FROM LEDGER1 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                    
                    
INSERT INTO LEDGER2(VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE)                    
SELECT VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,CAMT,COSTCODE,L.BOOKTYPE,CLTCODE                    
FROM LEDGER2 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYPE = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE     
                    
                    
INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)                    
SELECT NARATNO,R.NARRATION,REFNO,VTYP_REV,VNO_REV,L.BOOKTYPE                    
FROM LEDGER3 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                    
                    
UPDATE L SET CLEAR_MODE = CASE WHEN @VTYPE = 2 THEN 'R' ELSE 'C' END, RELDT = CASE WHEN @VTYPE = 2 THEN RELDT ELSE INST_DATE END      
FROM LEDGER1 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                     
                    
SELECT 'FILE UPLOADED SUCCESSFULLY'                    
UNION ALL                    
SELECT 'VNO, VTYP, RECEIPT_VNO'                    
UNION ALL                    
SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT                    
FROM                           
 #RECPAY_TABLE                    
                    
COMMIT                  
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW
-- --------------------------------------------------
  
/*  
EDIFF = DATEDIFF(D, L.EDT, GETDATE()),             
EXEC RPT_ACC_BANKBOOK_NEW 'DEC  1 2010', 'DEC 22 2010', '01/04/2010', 'BANK01', 'BROKER', 'BROKER', '%', 'VDT'  
*/  
  
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'        
CREATE PROC [dbo].[RPT_ACC_BANKBOOK_NEW]        
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @FCODE VARCHAR(10),                            
      @STATUSID VARCHAR(30),                            
      @STATUSNAME VARCHAR(30),                            
      @BRANCH VARCHAR(10),        
      @SELECTIONBY VARCHAR(3) = 'VDT'                             
                            
AS                            
                            
DECLARE                            
 @@OPENDATE AS VARCHAR(11),                            
 @@REPDATE AS VARCHAR(8),                            
 @@STARTDATE AS VARCHAR(11),         
 @@COSTCODE AS SMALLINT        
        
        
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
                          
CREATE TABLE [DBO].[#TBL_GLREPORT] (                          
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                          
 [BOOKTYPE] [CHAR] (2) NULL ,                          
 [VOUDT] [VARCHAR] (10) NULL ,                          
 [EFFDT] [VARCHAR] (10) NULL ,                          
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                          
 [DRAMT] [MONEY] NULL ,                          
 [CRAMT] [MONEY] NULL ,                          
 [VNO] [VARCHAR] (12) NULL ,                          
 [NARRATION] [VARCHAR] (500) NULL ,                          
 [DDNO] [VARCHAR] (15) NULL ,                          
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                          
 [LONGNAME] [VARCHAR] (100) NULL ,                          
 [VDT] [DATETIME] NULL ,                          
 [VTYP] [SMALLINT] NOT NULL ,                          
 [ACCAT] [CHAR] (2) NULL ,                          
 [OPBAL] [MONEY] NOT NULL ,                          
 [CROSAC] [VARCHAR] (10) NOT NULL ,                          
 [ACNAME] [VARCHAR] (100) NULL ,                          
 [BRANCHCODE] [VARCHAR] (35) NULL ,                          
 [LNO] [INT] NULL,      
 [PROCID] [BIGINT] NULL ,                          
 [REPDATE] [VARCHAR] (8) NULL ,                          
 [MAINCODE] [VARCHAR] (10) NULL ,                          
 [VCHDT] [DATETIME] NULL,  
 [EDIFF] INT NULL  
)                          
                          
                            
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                          
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID        
        
SELECT @@COSTCODE = -1        
        
IF @STATUSID <> 'BROKER'        
 BEGIN        
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME         
 END        
ELSE IF @STATUSID = 'BROKER'        
 BEGIN        
  IF @BRANCH <> '' OR @BRANCH <> '%'        
   BEGIN        
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH         
   END        
 END        
      
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                            
        
IF @SELECTIONBY = 'VDT'         
BEGIN        
 IF @STATUSID = 'BROKER'        
  BEGIN                            
   IF @BRANCH = '' OR @BRANCH = '%'        
    BEGIN        
     PRINT 'CAME HERE - I'        
     INSERT INTO TBL_OPPBALANCE         
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
      FROM         
       LEDGER                                
      WHERE         
       CLTCODE = @FCODE         
       AND VTYP = 18         
       AND VDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       CLTCODE        
      UNION ALL                            
      SELECT         
  CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER                                  
      WHERE         
       CLTCODE = @FCODE         
       AND VDT >= @@STARTDATE         
       AND VDT <  @FDATE                            
       AND VTYP <> 18                            
      GROUP BY         
       CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE        
         
                             
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,      
      L.LNO,        
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                          
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A                          
     WHERE         
      L.VNO = L1.VNO                          
      AND L.VTYP = L1.VTYP                          
      AND L.BOOKTYPE = L1.BOOKTYPE                          
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L.VTYP <> 18                          
    END        
   ELSE        
    BEGIN        
     PRINT 'CAME HERE - II'        
     INSERT INTO TBL_OPPBALANCE                                  
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.VTYP = 18         
       AND L.VDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       L2.CLTCODE         
           
      UNION ALL        
           
      SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.VDT >= @@STARTDATE         
       AND L.VDT <  @FDATE         
       AND L2.VTYPE <> 18                            
      GROUP BY         
       L2.CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L2.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,      
      L.LNO,        
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                          
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L1.VNO                          
      AND L.VTYP = L1.VTYP                          
      AND L.BOOKTYPE = L1.BOOKTYPE                          
      AND L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
 --     AND L.DRCR = L2.DRCR        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L2.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
         
    END        
  END        
 ELSE        
  BEGIN        
   INSERT INTO TBL_OPPBALANCE                                  
   SELECT         
    CLTCODE,         
    SUM(OPBAL) AS OPBAL,        
    SPID ,         
    CURDATE         
   FROM                            
    (SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
    AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP = 18         
     AND L.VDT LIKE @@STARTDATE + '%'        
    GROUP BY         
     L2.CLTCODE         
         
    UNION ALL        
         
    SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
    FROM         
     LEDGER L, LEDGER2 L2        
   WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VDT >= @@STARTDATE         
     AND L.VDT <  @FDATE         
     AND L2.VTYPE <> 18                            
    GROUP BY         
     L2.CLTCODE) A        
   GROUP BY         
    CLTCODE,         
    SPID,         
    CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),           
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,      
      L.LNO,        
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                         
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L1.VNO                          
      AND L.VTYP = L1.VTYP                          
      AND L.BOOKTYPE = L1.BOOKTYPE                          
      AND L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
 --     AND L.DRCR = L2.DRCR        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
  END        
END        
ELSE        
BEGIN        
 IF @STATUSID = 'BROKER'        
  BEGIN                            
   IF @BRANCH = '' OR @BRANCH = '%'        
    BEGIN        
     PRINT 'CAME HERE - I'        
     INSERT INTO TBL_OPPBALANCE                                  
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
      FROM         
       LEDGER                                
      WHERE         
       CLTCODE = @FCODE         
       AND VTYP = 18         
       AND EDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       CLTCODE        
      UNION ALL                            
      SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER                                  
   WHERE         
       CLTCODE = @FCODE         
       AND EDT >= @@STARTDATE         
       AND EDT <  @FDATE                            
       AND VTYP <> 18                            
      GROUP BY         
       CLTCODE        
      UNION ALL                            
      SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER                                  
      WHERE         
       CLTCODE = @FCODE         
       AND VDT < @@STARTDATE         
       AND EDT >= @@STARTDATE         
       AND VTYP <> 18                            
      GROUP BY         
       CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE         
         
                             
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,       
      L.LNO,       
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                            
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A                          
     WHERE         
      L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L.VTYP <> 18                          
    END        
   ELSE        
    BEGIN        
     PRINT 'CAME HERE - II'        
     INSERT INTO TBL_OPPBALANCE                                  
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.VTYP = 18         
       AND L.EDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       L2.CLTCODE         
           
      UNION ALL        
            
      SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.EDT >= @@STARTDATE         
       AND L.EDT <  @FDATE         
       AND L2.VTYPE <> 18                            
      GROUP BY         
       L2.CLTCODE        
        
      UNION ALL        
           
      SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.EDT >= @@STARTDATE         
       AND L.VDT <  @@STARTDATE         
       AND L2.VTYPE <> 18                            
      GROUP BY         
       L2.CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,       
      L.LNO,       
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                            
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
         
    END        
  END        
 ELSE        
  BEGIN        
   INSERT INTO TBL_OPPBALANCE                                  
   SELECT         
    CLTCODE,         
    SUM(OPBAL) AS OPBAL,        
    SPID ,         
    CURDATE         
   FROM                            
    (SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP = 18         
     AND L.EDT LIKE @@STARTDATE + '%'        
    GROUP BY         
     L2.CLTCODE         
         
    UNION ALL        
         
    SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.EDT >= @@STARTDATE         
     AND L.EDT <  @FDATE                            
     AND L2.VTYPE <> 18                            
    GROUP BY         
     L2.CLTCODE        
         
    UNION ALL        
         
    SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.EDT >= @@STARTDATE         
     AND L.VDT <  @@STARTDATE                 
     AND L2.VTYPE <> 18                            
    GROUP BY         
     L2.CLTCODE) A        
   GROUP BY         
    CLTCODE,         
    SPID,         
    CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),           
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,        
      L.LNO,      
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                            
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
  END        
END        
        
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                          
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                          
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                          
                      
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', '', 0                          
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                              
                  
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                  
      
UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C      
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE      
AND L2.COSTCODE = C.COSTCODE      
                          
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                          
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                          
SELECT         
      BOOKTYPE,        
      VOUDT VDT ,        
      EFFDT EDT ,        
      SHORTDESC,        
      DRAMT DEBIT,        
      CRAMT CREDIT,        
      VNO,        
      NARRATION,        
      DDNO,        
      CLTCODE,         
      LONGNAME,        
      VTYP,        
      ACCAT,        
      OPBAL,        
      CROSAC,        
      ACNAME,        
      BRANCHCODE,      
   VCHDT,  
   EDIFF  
FROM        
      #TBL_GLREPORT          
WHERE         
      PROCID = @@SPID                          
ORDER BY         
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_CASHBOOK_NEW
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[RPT_ACC_CASHBOOK_NEW]          
  @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
  @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
  @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
  @FCODE VARCHAR(10),                              
  @STATUSID VARCHAR(30),                              
  @STATUSNAME VARCHAR(30),                              
  @BRANCH VARCHAR(10)                              
                              
AS                              
                              
DECLARE                              
 @@OPENDATE AS VARCHAR(11),                              
 @@REPDATE AS VARCHAR(8),                              
 @@STARTDATE AS VARCHAR(11),           
 @@COSTCODE AS SMALLINT          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                            
CREATE TABLE [DBO].[#TBL_GLREPORT] (                            
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                            
 [BOOKTYPE] [CHAR] (2) NULL ,                            
 [VOUDT] [VARCHAR] (10) NULL ,                            
 [EFFDT] [VARCHAR] (10) NULL ,                            
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                            
 [DRAMT] [MONEY] NULL ,                            
 [CRAMT] [MONEY] NULL ,                            
 [VNO] [VARCHAR] (12) NULL ,                            
 [NARRATION] [VARCHAR] (500) NULL ,                            
 [DDNO] [VARCHAR] (15) NULL ,                            
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                            
 [LONGNAME] [VARCHAR] (100) NULL ,                            
 [VDT] [DATETIME] NULL ,                            
 [VTYP] [SMALLINT] NOT NULL ,                            
 [ACCAT] [CHAR] (2) NULL ,                            
 [OPBAL] [MONEY] NOT NULL ,                            
 [CROSAC] [VARCHAR] (10) NOT NULL ,                            
 [ACNAME] [VARCHAR] (100) NULL ,                            
 [BRANCHCODE] [VARCHAR] (10) NULL ,                            
 [PROCID] [BIGINT] NULL ,                            
 [REPDATE] [VARCHAR] (8) NULL ,                            
 [MAINCODE] [VARCHAR] (10) NULL ,                            
 [VCHDT] [DATETIME] NULL                            
)                            
                            
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID          
          
SELECT @@COSTCODE = -1          
          
IF @STATUSID <> 'BROKER'          
 BEGIN          
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME           
 END          
ELSE IF @STATUSID = 'BROKER'          
 BEGIN          
  IF @BRANCH <> '' OR @BRANCH <> '%'          
   BEGIN          
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH           
   END          
 END          
          
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                              
          
IF @STATUSID = 'BROKER'          
 BEGIN                              
  IF @BRANCH = '' OR @BRANCH = '%'          
   BEGIN          
    INSERT INTO TBL_OPPBALANCE                                    
    SELECT           
     CLTCODE,           
     SUM(OPBAL) AS OPBAL,          
     SPID ,           
     CURDATE           
    FROM                           
     (SELECT           
      CLTCODE,          
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,          
      @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                   
     FROM           
      LEDGER                                  
     WHERE           
      CLTCODE = @FCODE           
      AND VTYP = 18           
      AND VDT LIKE @@STARTDATE + '%'          
     GROUP BY           
      CLTCODE          
     UNION ALL                              
     SELECT           
      CLTCODE,          
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,          
  @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                              
     FROM           
      LEDGER                                    
     WHERE           
      CLTCODE = @FCODE           
      AND VDT >= @@STARTDATE           
      AND VDT <  @FDATE                              
      AND VTYP <> 18                              
     GROUP BY           
      CLTCODE) A          
    GROUP BY           
     CLTCODE,           
     SPID,           
     CURDATE          
          
                              
    INSERT INTO #TBL_GLREPORT                            
    SELECT           
     L.BOOKTYPE,                               
     VOUDT=CONVERT(VARCHAR,L.VDT,103),           
     EFFDT=CONVERT(VARCHAR,L.EDT,103),           
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                       
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                        
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                      
     L.VNO,           
     REPLACE( L.NARRATION,'"','') NARRATION,                                                         
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                             
     L.CLTCODE ,          
     A.LONGNAME,          
     VDT,           
     L.VTYP,                                                                        
     ACCAT,           
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     @@SPID,           
     CONVERT(VARCHAR,GETDATE(),112), '',           
     L.VDT                            
    FROM           
     LEDGER L             
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                              
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                            
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                            
     VMAST V, ACMAST A                            
    WHERE           
     L.VNO = LL.VNO                            
     AND L.VTYP = LL.VTYP                            
     AND L.BOOKTYPE = LL.BOOKTYPE                            
     AND L.CLTCODE = A.CLTCODE                            
     AND L.VTYP = V.VTYPE                            
     AND L.CLTCODE <> @FCODE                            
     AND L.VTYP <> 18                            
   END          
  ELSE          
   BEGIN          
    INSERT INTO TBL_OPPBALANCE                                    
    SELECT           
     CLTCODE,           
     SUM(OPBAL) AS OPBAL,          
     SPID ,           
     CURDATE           
    FROM                              
     (SELECT           
      L2.CLTCODE,          
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
      @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE          
     FROM           
      LEDGER L, LEDGER2 L2          
     WHERE           
      L.VNO = L2.VNO          
      AND L.VTYP = L2.VTYPE          
      AND L.BOOKTYPE = L2.BOOKTYPE          
      AND L.DRCR = L2.DRCR          
      AND L.CLTCODE = L2.CLTCODE          
      AND L2.CLTCODE = @FCODE           
      AND L2.COSTCODE = @@COSTCODE          
      AND L.VTYP = 18           
      AND L.VDT LIKE @@STARTDATE + '%'          
     GROUP BY           
      L2.CLTCODE           
            
     UNION ALL          
      
     SELECT           
      L2.CLTCODE,          
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
      @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                              
     FROM           
      LEDGER L, LEDGER2 L2          
 WHERE           
      L.VNO = L2.VNO          
      AND L.VTYP = L2.VTYPE          
      AND L.BOOKTYPE = L2.BOOKTYPE          
      AND L.DRCR = L2.DRCR          
      AND L.CLTCODE = L2.CLTCODE          
      AND L2.CLTCODE = @FCODE           
      AND L2.COSTCODE = @@COSTCODE          
      AND L.VDT >= @@STARTDATE           
      AND L.VDT <  @FDATE           
      AND L2.VTYPE <> 18                              
 GROUP BY           
      L2.CLTCODE) A          
    GROUP BY           
     CLTCODE,           
     SPID,           
     CURDATE          
      
    INSERT INTO #TBL_GLREPORT                            
    SELECT           
     L.BOOKTYPE,                               
     VOUDT=CONVERT(VARCHAR,L.VDT,103),           
     EFFDT=CONVERT(VARCHAR,L.EDT,103),           
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                       
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                        
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                      
     L.VNO,           
     REPLACE( L.NARRATION,'"','') NARRATION,                                                         
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                             
     L.CLTCODE ,          
     A.LONGNAME,          
     VDT,           
     L.VTYP,                                                                        
     ACCAT,           
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     @@SPID,           
     CONVERT(VARCHAR,GETDATE(),112), '',           
     L.VDT                            
    FROM           
     LEDGER L             
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                              
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                            
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                            
     VMAST V, ACMAST A, LEDGER2 L2                            
    WHERE           
      L.VNO = L2.VNO          
     AND L.VTYP = L2.VTYPE           
     AND L.BOOKTYPE = L2.BOOKTYPE          
     AND L.LNO = L2.LNO          
     AND L.DRCR = L2.DRCR          
     AND L.VNO = LL.VNO                            
     AND L.VTYP = LL.VTYP                            
     AND L.BOOKTYPE = LL.BOOKTYPE                            
     AND L.CLTCODE = A.CLTCODE                            
     AND L.VTYP = V.VTYPE                            
     AND L.CLTCODE <> @FCODE                            
     AND L2.COSTCODE = @@COSTCODE          
     AND L.VTYP <> 18          
          
   END          
 END          
ELSE          
 BEGIN          
  INSERT INTO TBL_OPPBALANCE                                    
  SELECT           
   CLTCODE,           
   SUM(OPBAL) AS OPBAL,          
   SPID ,           
   CURDATE           
  FROM                              
   (SELECT           
    L2.CLTCODE,          
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
    @@SPID AS SPID,           
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE          
   FROM           
    LEDGER L, LEDGER2 L2          
   WHERE           
    L.VNO = L2.VNO          
    AND L.VTYP = L2.VTYPE          
    AND L.BOOKTYPE = L2.BOOKTYPE          
    AND L.DRCR = L2.DRCR          
    AND L.CLTCODE = L2.CLTCODE          
    AND L2.CLTCODE = @FCODE           
    AND L2.COSTCODE = @@COSTCODE          
    AND L.VTYP = 18           
    AND L.VDT LIKE @@STARTDATE + '%'          
   GROUP BY           
    L2.CLTCODE           
          
   UNION ALL          
          
   SELECT           
    L2.CLTCODE,          
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
    @@SPID AS SPID,           
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                              
   FROM           
    LEDGER L, LEDGER2 L2          
   WHERE           
    L.VNO = L2.VNO          
    AND L.VTYP = L2.VTYPE          
    AND L.BOOKTYPE = L2.BOOKTYPE          
    AND L.DRCR = L2.DRCR          
    AND L.CLTCODE = L2.CLTCODE          
    AND L2.CLTCODE = @FCODE           
    AND L2.COSTCODE = @@COSTCODE          
    AND L.VDT >= @@STARTDATE           
    AND L.VDT <  @FDATE                              
    AND L2.VTYPE <> 18                              
   GROUP BY           
    L2.CLTCODE) A          
  GROUP BY           
   CLTCODE,           
   SPID,           
   CURDATE          
          
    INSERT INTO #TBL_GLREPORT                            
    SELECT           
     L.BOOKTYPE,                               
     VOUDT=CONVERT(VARCHAR,L.VDT,103),           
     EFFDT=CONVERT(VARCHAR,L.EDT,103),        ISNULL(SHORTDESC,'') SHORTDESC,                                                                       
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                        
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                      
     L.VNO,           
     REPLACE( L.NARRATION,'"','') NARRATION,                                                         
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                             
     L.CLTCODE ,          
     A.LONGNAME,          
     VDT,           
     L.VTYP,                                                                        
     ACCAT,           
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     @@SPID,           
     CONVERT(VARCHAR,GETDATE(),112), '',           
     L.VDT                            
    FROM           
     LEDGER L             
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                              
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                            
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                            
     VMAST V, ACMAST A, LEDGER2 L2                            
    WHERE           
     L.VNO = L2.VNO          
     AND L.VTYP = L2.VTYPE           
     AND L.BOOKTYPE = L2.BOOKTYPE          
     AND L.LNO = L2.LNO          
     AND L.DRCR = L2.DRCR          
     AND L.VNO = LL.VNO                            
     AND L.VTYP = LL.VTYP                            
     AND L.BOOKTYPE = LL.BOOKTYPE                            
     AND L.CLTCODE = A.CLTCODE                            
     AND L.VTYP = V.VTYPE                            
     AND L.CLTCODE <> @FCODE                            
     AND L2.COSTCODE = @@COSTCODE          
     AND L.VTYP <> 18            
 END          
          
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                            
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                            
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                            
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                            
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                            
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                            
                        
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','',PROCID,REPDATE, '', ''                            
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                                
                    
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                    
                            
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                            
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                            
SELECT           
      BOOKTYPE,          
      VOUDT VDT ,          
      EFFDT EDT ,          
      SHORTDESC,          
      DRAMT DEBIT,          
      CRAMT CREDIT,          
      VNO,          
      NARRATION,          
      DDNO,          
      CLTCODE,           
      LONGNAME,          
      VTYP,          
      ACCAT,          
      OPBAL,          
    CROSAC,          
      ACNAME,          
      BRANCHCODE  
FROM           
      #TBL_GLREPORT            
WHERE           
      PROCID = @@SPID                            
ORDER BY           
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GLREPORT
-- --------------------------------------------------

    
      
/*      
RPT_ACC_GLREPORT '01/04/2011', '31/03/2012', 'Apr  1 2011', 'May 10 2011', '99988', '99988', 'region', 'ahmedabad', 'ahmedabad','vdt', 'Segment', 'codewise', 'GL',''      
      
*/      
CREATE PROC [dbo].[rpt_Acc_GLREPORT]                      
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE VARCHAR(10),                      
 @TCODE VARCHAR(10),                      
 @STATUSID VARCHAR(30),                      
 @STATUSNAME VARCHAR(30),                      
 @BRANCH VARCHAR(10),                      
 @SELECTIONBY VARCHAR(3),                      
 @GROUPBY VARCHAR(10),                      
 @SORTBY VARCHAR(50),                      
 @REPORTNAME VARCHAR(30),                      
 @REPORTOPT VARCHAR(10) = ''                     
                      
AS        
DECLARE                      
 @@OPENDATE AS VARCHAR(11),        
 @@COSTCODE AS SMALLINT,        
 @SHAREDB AS VARCHAR(25),        
 @@SQL AS VARCHAR(1000)        
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                      
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                   
                      
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM LEDGER  WHERE 1 =2                      
                
CREATE TABLE [DBO].[#TEMPTABLE_GL] (                    
  [BOOKTYPE] [CHAR] (2)  NULL ,                    
  [VOUDT1] [VARCHAR] (20) NULL ,                    
  [EFFDT1] [VARCHAR] (20) NULL ,                    
  [SHORTDESC] [CHAR] (6) NULL ,                    
  [DRAMT] [MONEY] NULL ,                    
  [CRAMT] [MONEY] NULL ,                    
  [VNO] [VARCHAR] (12) NULL ,                    
  [NARRATION] [VARCHAR] (234) NULL ,                
  [DDNO] [VARCHAR] (15) NULL ,                    
  [CLTCODE] [VARCHAR] (10) NOT NULL ,                
  [LONGNAME] [VARCHAR] (100) NULL ,                
  [VDT] [DATETIME] NULL ,                      
  [VTYP] [SMALLINT] NULL ,                    
  [ACCAT] [VARCHAR] (30) NULL ,                    
  [OPBAL] [MONEY] NULL ,                    
  [CROSAC] [VARCHAR] (10) NULL ,                    
  [ACNAME] [VARCHAR] (150) NULL ,                 
  [BRANCHCODE] [VARCHAR] (20) NULL ,                
  [LNO][INT] NULL,                
 )            
 SET @SHAREDB = 'MSAJAG'      
 CREATE TABLE #COSTMAST      
 (      
  COSTCODE INT,      
  COSTNAME VARCHAR(50)      
 )      
      
 IF @STATUSID = 'REGION'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE, COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.REGION R WHERE REGIONCODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'      
 END      
      
 IF @STATUSID = 'AREA'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE ,COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.AREA A WHERE AREACODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'      
 END      
      
 IF @STATUSID = 'BRANCH'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('+@STATUSNAME+')'      
 END      
 PRINT(@@SQL)        
 EXEC(@@SQL)      
      
      
--select @@costcode=costcode from costmast where costname=@BRANCH        
        
IF @SELECTIONBY = 'VDT'                      
 BEGIN                      
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                      
   BEGIN               
  INSERT INTO #OPBAL          
  SELECT CLTCODE, SUM(OPBAL) FROM                     
  (          
   SELECT                      
   CLTCODE,                      
   OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                      
   FROM                      
   LEDGER                      
 WHERE                      
    CLTCODE BETWEEN @FCODE AND @TCODE                      
    AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                  
   GROUP BY           
    CLTCODE         
           
   UNION ALL          
   SELECT                      
    CLTCODE,                      
    OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)           
   FROM                      
    LEDGER                      
   WHERE                      
    CLTCODE BETWEEN @FCODE AND @TCODE                      
    AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18                  
   GROUP BY CLTCODE           
   ) A          
   GROUP BY          
    CLTCODE          
   ORDER BY           
    CLTCODE              
                   
                      
  INSERT INTO #TEMPTABLE_GL                      
  SELECT                      
   L.BOOKTYPE,                      
   VOUDT1=L.VDT,                      
   EFFDT1=L.EDT,                      
   ISNULL(SHORTDESC,'') SHORTDESC,                      
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                      
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                      
   L.VNO,                      
   REPLACE( L.NARRATION,'"','') NARRATION,                      
   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
   L.CLTCODE,                      
   A.LONGNAME,                      
   VDT,                      
   L.VTYP,                      
   ACCAT,                      
   OPBAL=0,                      
   CROSAC='',                      
   A.ACNAME,                
   A.BRANCHCODE,                      
   L.LNO                      
  FROM                      
   LEDGER L,                      
   ACMAST A,                      
   VMAST V                      
  WHERE                      
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
   AND VTYP = VTYPE                      
   AND L.CLTCODE = A.CLTCODE                      
   AND L.CLTCODE BETWEEN @FCODE AND @TCODE                      
   AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                      
  ORDER BY                      
   L.CLTCODE,                      
   VOUDT1,                      
   L.VTYP DESC,                      
   L.VNO                      
    END                      
   ELSE                      
    BEGIN             
     INSERT INTO #OPBAL                      
  SELECT                      
   CLTCODE,                      
   SUM(OPBAL) FROM         
   (        
   SELECT L2.CLTCODE ,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
  FROM                      
   LEDGER2 L2,                      
   LEDGER L      
  WHERE                      
   L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
   AND L.VTYP=L2.VTYPE                      
   AND L.BOOKTYPE=L2.BOOKTYPE                      
   AND L.VNO=L2.VNO                      
   AND L.LNO=L2.LNO             
   --AND L2.COSTCODE = @@costcode                       
   --AND C.COSTNAME = @BRANCH                   
   AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
   AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18              
  GROUP BY L2.CLTCODE                      
        
    UNION ALL        
             
    SELECT                      
     L2.CLTCODE,                      
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
    FROM                      
     LEDGER2 L2,                      
     LEDGER L      
    WHERE                      
     L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND L.VTYP=L2.VTYPE                      
     AND L.BOOKTYPE=L2.BOOKTYPE                      
     AND L.VNO=L2.VNO                      
     AND L.LNO=L2.LNO           
 --AND L2.COSTCODE = @@costcode                      
 --AND C.COSTNAME = @BRANCH     
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)                 
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18                      
    GROUP BY L2.CLTCODE                      
    ) T1           
    GROUP BY CLTCODE                      
 ORDER BY CLTCODE               
        
                      
    INSERT INTO #TEMPTABLE_GL       
    SELECT                      
     L.BOOKTYPE,                      
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE( L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
     L2.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                      
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     LEDGER L,                      
     VMAST V,                      
     LEDGER2 L2,                      
     ACMAST A/*,                      
     COSTMAST C*/       
    WHERE                      
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
     AND L.VTYP = L2.VTYPE                      
     AND  L.VNO = L2.VNO                      
     AND L.LNO = L2.LNO                      
     AND L.BOOKTYPE = L2.BOOKTYPE                      
     AND L2.CLTCODE=A.CLTCODE                      
     AND L.VTYP = V.VTYPE                      
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE                      
     AND A.ACCAT <> '4'                      
     --AND COSTNAME = RTRIM(@BRANCH)                      
     --AND L2.COSTCODE = C.COSTCODE         
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
     AND  L2.VTYPE <> 18                      
    ORDER BY                      
     L2.CLTCODE,                      
     VOUDT1,              
     L.VTYP DESC,                      
     L.VNO                      
   END                      
 END                      
ELSE                      
 BEGIN                      
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                      
   BEGIN                      
    INSERT INTO #OPBAL                      
    SELECT                      
     CLTCODE,                      
     SUM(OPBAL) OPBAL                      
    FROM                      
     (                      
      SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       LEDGER                      
      WHERE                      
       CLTCODE BETWEEN @FCODE AND @TCODE                      
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18           
                  
      GROUP BY                      
       CLTCODE                      
  UNION ALL              
  SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       LEDGER                      
      WHERE                      
       CLTCODE BETWEEN @FCODE AND @TCODE                      
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18                      
      GROUP BY                      
       CLTCODE                 
     UNION ALL                      
      SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       LEDGER                      
      WHERE                      
       CLTCODE BETWEEN  @FCODE AND  @TCODE                      
       AND VDT < @@OPENDATE                      
       AND EDT >= @@OPENDATE                      
       GROUP BY CLTCODE                      
     ) T                      
    GROUP BY CLTCODE                      
    ORDER BY CLTCODE                      
                      
    INSERT INTO #TEMPTABLE_GL                      
    SELECT            
     L.BOOKTYPE,                      
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE( L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                   
     L.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                      
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     LEDGER L,                      
     ACMAST A,                      
     VMAST V                      
    WHERE                      
     VTYP = VTYPE                      
     AND A.CLTCODE = L.CLTCODE                      
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
     AND L.VTYP <> 18                      
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                      
    ORDER BY                      
     L.CLTCODE,                      
     VOUDT1,                      
     L.VTYP DESC,                      
     L.VNO                      
   END                      
  ELSE                      
   BEGIN             
print 'nse'                 
    INSERT INTO #OPBAL                      
    SELECT                      
     CLTCODE,                      
     SUM(OPBAL) OPBAL                      
    FROM                      
     (                      
      SELECT                      
       L2.CLTCODE,                      
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
      FROM                      
       LEDGER2 L2,                      
       LEDGER L --, COSTMAST C                    
      WHERE                      
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18              
       AND L.VNO=L2.VNO                      
       AND L.VTYP=L2.VTYPE                      
       AND L.BOOKTYPE=L2.BOOKTYPE                      
       AND L.LNO=L2.LNO           
  --AND L2.COSTCODE = @@costcode                      
        --AND C.COSTNAME = @BRANCH                    
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
      GROUP BY                      
       L2.CLTCODE                      
      UNION ALL                      
   SELECT                      
       L2.CLTCODE,                      
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
      FROM                      
       LEDGER2 L2,                      
       LEDGER L    --, COSTMAST C                               
      WHERE                      
       EDT >= @@OPENDATE AND EDT < @FDATE AND VTYPE <> 18              
       AND L.VNO=L2.VNO                      
       AND L.VTYP=L2.VTYPE                      
       AND L.BOOKTYPE=L2.BOOKTYPE                      
       AND L.LNO=L2.LNO                
       --AND L2.COSTCODE = @@costcode                    
       --AND C.COSTNAME = @BRANCH                    
       AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
      GROUP BY                      
       L2.CLTCODE                      
      UNION ALL              
       SELECT                      
        L2.CLTCODE,                      
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL                      
       FROM                      
        LEDGER2 L2,                      
        LEDGER L , COSTMAST C        
       WHERE                      
        L.VNO=L2.VNO                      
        AND L.VTYP=L2.VTYPE                      
        AND L.BOOKTYPE=L2.BOOKTYPE                      
        AND L.LNO=L2.LNO                      
        AND VDT < @@OPENDATE                      
        AND EDT >= @@OPENDATE           
  AND L2.COSTCODE = @@costcode                       
  AND C.COSTNAME = @BRANCH                    
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
       GROUP BY                      
        L2.CLTCODE                      
     ) T                      
    GROUP BY                      
     CLTCODE                      
    ORDER BY                      
    CLTCODE                      
    INSERT INTO #TEMPTABLE_GL                      
    SELECT                      
     L.BOOKTYPE,              
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE(L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
     L2.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                   
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     LEDGER L,                      
     VMAST V,                      
     LEDGER2 L2,                      
     ACMAST A/*,                      
     COSTMAST C */                     
    WHERE                      
     L.VNO = L2.VNO                      
     AND L.VTYP = L2.VTYPE                      
     AND L.BOOKTYPE = L2.BOOKTYPE                      
     AND L.LNO = L2.LNO                      
     AND A.CLTCODE = L2.CLTCODE                      
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND L.VTYP = V.VTYPE                      
     AND A.ACCAT <> '4'                      
     AND L2.CLTCODE=A.CLTCODE                      
     --AND COSTNAME = RTRIM(@BRANCH)                      
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)         
     AND L2.VTYPE <> 18                      
     AND L2.COSTCODE = C.COSTCODE                      
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
    ORDER BY                      
     L2.CLTCODE,                      
     VOUDT1,                      
     L.VTYP DESC,                      
     L.VNO                      
   END                      
 END                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 OPBAL = L.OPBAL                      
FROM                      
 #OPBAL L                
WHERE                      
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE               
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 CROSAC = L.CLTCODE                      
FROM                      
 LEDGER L                      
WHERE                      
 L.VTYP IN('2','3')                      
 AND #TEMPTABLE_GL.VTYP = L.VTYP                      
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE                      
 AND #TEMPTABLE_GL.VNO = L.VNO                      
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 BRANCHCODE = COSTNAME                      
FROM                      
 LEDGER2 L2,                      
 #COSTMAST C                      
WHERE                      
 #TEMPTABLE_GL.VNO = L2.VNO                      
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE                      
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE                   
 AND #TEMPTABLE_GL.LNO = L2.LNO                      
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE                      
 AND L2.COSTCODE = C.COSTCODE                  
            
DELETE #TEMPTABLE_GL WHERE  VTYP=18            
            
INSERT INTO #TEMPTABLE_GL            
SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''                        
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)                 
                   
SELECT                      
 BOOKTYPE,                      
 VOUDT = CONVERT(VARCHAR(11),CONVERT(DATETIME, CONVERT(VARCHAR(11), VOUDT1, 109)), 103),            
 EFFDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, CONVERT(VARCHAR(11), EFFDT1, 109)), 103),            
 SHORTDESC,                      
 DRAMT,                      
 CRAMT,                      
 VNO,                      
 NARRATION=REPLACE (NARRATION,'Prepaid','Subscription Based'),                      
 DDNO,                      
 CLTCODE,                      
 LONGNAME,                      
 VDT,              
 VTYP,                      
 ACCAT,                      
 OPBAL,                      
 CROSAC,                      
 ACNAME,                      
 BRANCHCODE,                      
 LNO                      
FROM                      
 #TEMPTABLE_GL                      
ORDER BY                      
 CLTCODE,    
VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GLREPORT_03102011
-- --------------------------------------------------
    
    
--Exec acc_opbal 'Apr  1 2006', 'Mar 31 2007', 'Apr  1 2006', 'Mar 31 2007', '03000002', '03000002', 'broker', 'broker', 'ACM','vdt', 'Account', 'VoucherType, VoucherDate', 'GL', '', '', '', ''    
--Exec rpt_Acc_GlReport '01/04/2006', '31/03/2007', 'Apr  1 2006', 'Mar 31 2007', '03000002', '03000002', 'broker', 'broker', '','vdt', 'Account', 'VDT', 'GL',''    
    
    
CREATE Proc [dbo].[rpt_Acc_GLREPORT_03102011]    
 @sdate varchar(11),            /* As mmm dd yyyy */    
 @edate varchar(11),            /* As mmm dd yyyy */    
 @fdate varchar(11),            /* As mmm dd yyyy */    
 @tdate varchar(11),            /* As mmm dd yyyy */    
 @fcode varchar(10),    
 @tcode varchar(10),    
 @statusId varchar(30),    
 @statusname varchar(30),    
 @branch varchar(10),    
 @selectionby varchar(3),    
 @GroupBy varchar(10),    
 @Sortby varchar(50),    
 @reportname varchar(30),    
 @reportopt varchar(10)    
    
AS    
    
declare    
 @@opendate as varchar(11)    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18' and vdt <= @fdate    
    
    
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2    
    
    
CREATE TABLE [dbo].[#temptable_gl] (        
  [booktype] [char] (2)  NULL ,        
  [voudt1] datetime NULL ,        
  [effdt1] datetime NULL ,        
  [shortdesc] [char] (6) NULL ,        
  [dramt] [money] NULL ,        
  [cramt] [money] NULL ,        
  [vno] [varchar] (12) NULL ,        
  [Narration] [varchar] (234) NULL ,    
  [ddno] [varchar] (15) NULL ,        
  [cltcode] [varchar] (10) NOT NULL ,    
  [Longname] [varchar] (100) NULL ,    
  [vdt] [datetime] NULL ,          
  [vtyp] [smallint] NULL ,        
  [accat] [varchar] (30) NULL ,        
  [opbal] [money] NULL ,        
  [crosac] [varchar] (10) NULL ,        
  [Acname] [varchar] (150) NULL ,     
  [Branchcode] [varchar] (20) NULL ,    
  [LNO][smallint] NULL,    
      
    
 ) ON [PRIMARY]      
    
--Select    
-- l.booktype,--    
-- voudt1=l.vdt,--    
-- effdt1=l.edt,--    
-- isnull(shortdesc,'') shortdesc,--    
-- dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),--    
-- cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),--    
-- l.vno,--    
-- Replace( l.narration,'"','') narration,--    
-- ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),--    
-- l.cltcode,--    
-- a.longname,--    
-- vdt,--    
-- l.vtyp,--    
-- accat,--    
-- Vamt as opbal,--    
-- crosac=l.cltcode,--    
-- isnull(a.acname,'') acname,--    
-- isnull(a.branchcode,'') branchcode,    
-- lno    
--into    
-- #temptable_gl    
--From    
-- Ledger l,    
-- Acmast a,    
-- Vmast v    
--where    
-- 1 = 2    
    
    
if @selectionby = 'vdt'    
 BEGIN    
  if rtrim(@branch) = '' or rtrim(@branch) = '%'    
   BEGIN    
    If @@opendate = @fdate     
    begin    
     Insert into #opbal    
     Select    
      cltcode,    
      sum(case drcr when 'D' then vamt else -vamt end) as opbal    
     from    
      ledger    
     where    
      cltcode between @fcode and @tcode    
      and vdt like @@opendate + '%' and vtyp = 18    
     Group by cltcode    
     Order by cltcode    
    end    
    else    
    begin    
     Insert into #opbal    
     Select    
      cltcode,    
      sum(case drcr when 'D' then vamt else -vamt end) as opbal    
     from    
      ledger    
     where    
      cltcode between @fcode and @tcode    
      and vdt >= @@opendate and vdt < @fdate    
     Group by cltcode    
     Order by cltcode    
    end    
    
    Insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=convert(datetime, l.vdt,101),    
     effdt1=convert(datetime, l.edt,101),    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),    
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),    
     l.vno,    
     Replace( l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     Ledger l,    
     Acmast a,    
     Vmast v    
    Where    
     l.vdt between @fdate and @tdate + ' 23:59:59'    
     And vtyp = vtype    
     and l.cltcode = a.cltcode    
     and l.cltcode between @fcode and @tcode    
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')    
    Order by    
     l.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
  ELSE    
   BEGIN    
    If @@opendate = @fdate    
    begin    
     insert into #opbal    
     Select    
      l2.cltcode,    
      sum(case l2.drcr when 'D' then camt else -camt end) as opbal    
     from    
      ledger2 l2,    
      ledger l,    
      costmast c    
     where    
      l2.cltcode between @fcode and @tcode    
      and l.vtyp=l2.vtype    
      and l.booktype=l2.booktype    
      and l.vno=l2.vno    
      and l.lno=l2.lno    
      and vdt like @@opendate + '%' and vtype = 18    
      and costname = rtrim(@branch)    
      and l2.costcode = c.costcode    
     Group by l2.cltcode    
     Order by l2.cltcode    
    end    
    else    
    begin    
     insert into #opbal    
     Select    
      l2.cltcode,    
      sum(case l2.drcr when 'D' then camt else -camt end) as opbal    
     from    
      ledger2 l2,    
      ledger l,    
      costmast c    
     where    
      l2.cltcode between @fcode and @tcode    
      and l.vtyp=l2.vtype    
      and l.booktype=l2.booktype    
      and l.vno=l2.vno    
      and l.lno=l2.lno    
      and vdt >= @@opendate and vdt < @fdate    
      and costname = rtrim(@branch)    
      and l2.costcode = c.costcode    
     Group by l2.cltcode    
     Order by l2.cltcode    
    end    
    
    insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=convert(datetime, l.vdt),    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),    
     l.vno,    
     Replace( l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l2.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     ledger l,    
     vmast v,    
     ledger2 l2,    
     acmast a,    
     costmast c    
    Where    
     l.vdt between @fdate and @tdate + ' 23:59:59'    
     and l.vtyp = l2.vtype    
     and  l.vno = l2.vno    
     and l.lno = l2.lno    
     and l.booktype = l2.booktype    
     and l2.cltcode=a.cltcode    
     and l.vtyp = v.vtype    
     and l2.cltcode between @fcode and  @tcode    
     and a.accat <> '4'    
     and costname = rtrim(@branch)    
     and l2.costcode = c.costcode    
     and  l2.vtype <> 18    
    order by    
     l2.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
 END    
ELSE    
 BEGIN    
  if rtrim(@branch) = '' or rtrim(@branch) = '%'    
   BEGIN    
    insert into #opbal    
    Select    
     cltcode,    
     sum(opbal) opbal    
    from    
     (    
      Select    
       Cltcode,    
       sum(case drcr when 'D' then vamt else -vamt end) as opbal    
      from    
       ledger    
      where    
       Cltcode between @fcode and @tcode    
       and vdt between @@opendate and @fdate    
      Group by    
       Cltcode    
     union ALL    
      Select    
       cltcode,    
       sum(case drcr when 'C' then vamt else -vamt end) as opbal    
      from    
       ledger    
      Where    
       cltcode between  @fcode and  @tcode    
       and vdt < @@opendate    
       and edt >= @@opendate    
       Group by cltcode    
     ) t    
    Group by cltcode    
    Order by cltcode    
    
    insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=convert(datetime, l.vdt),    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),    
     cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end),    
     l.vno,    
     Replace( l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     Ledger l,    
     acmast a,    
     vmast v    
    Where    
     vtyp = vtype    
     and a.cltcode = l.cltcode    
     and l.cltcode between @fcode and @tcode    
     and  l.edt between @fdate and @tdate + ' 23:59:59'    
     and l.vtyp <> 18    
     and (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')    
    order by    
     l.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
  ELSE    
   BEGIN    
    If @@opendate = @fdate    
    begin    
     insert into #opbal    
     Select    
      cltcode,    
      sum(opbal) opbal    
      from    
      (    
       Select    
        l2.cltcode,    
        sum(case l2.drcr when 'D' then camt else -camt end) as opbal    
       from    
        ledger2 l2,    
        ledger l,    
        costmast c    
       where    
        vdt like @@opendate + '%'    
        and l.vno=l2.vno    
        and l.vtyp=l2.vtype    
        and l.booktype=l2.booktype    
        and l.lno=l2.lno    
        and l2.cltcode between @fcode and @tcode    
        and vtype = 18    
        and l2.costcode = c.costcode    
        and costname = rtrim(@branch)    
       Group by    
        l2.cltcode    
       union ALL    
        Select    
         l2.cltcode,    
         sum(case l2.drcr when 'C' then camt else -camt end) as opbal    
        from    
         ledger2 l2,    
         ledger l,    
         costmast c    
        where    
         l.vno=l2.vno    
         and l.vtyp=l2.vtype    
         and l.booktype=l2.booktype    
         and l.lno=l2.lno    
         and vdt < @@opendate    
         and edt >= @@opendate    
         and l2.cltcode between @fcode and @tcode    
         and l2.costcode = c.costcode    
         and costname = rtrim(@branch)    
        Group by    
         l2.cltcode    
      ) t    
     Group by    
      cltcode    
     Order by    
      cltcode    
    end    
    else    
    begin    
     insert into #opbal    
     Select    
      cltcode,    
      sum(opbal) opbal    
      from    
      (    
       Select    
        l2.cltcode,    
        sum(case l2.drcr when 'D' then camt else -camt end) as opbal    
       from    
        ledger2 l2,    
        ledger l,    
        costmast c    
       where    
        edt >= @@opendate and edt < @fdate    
        and l.vno=l2.vno    
        and l.vtyp=l2.vtype    
        and l.booktype=l2.booktype    
        and l.lno=l2.lno    
        and l2.cltcode between @fcode and @tcode    
        and l2.costcode = c.costcode    
        and costname = rtrim(@branch)    
       Group by    
        l2.cltcode    
       union ALL    
        Select    
         l2.cltcode,    
         sum(case l2.drcr when 'C' then camt else -camt end) as opbal    
        from    
         ledger2 l2,    
         ledger l,    
         costmast c    
        where    
         l.vno=l2.vno    
         and l.vtyp=l2.vtype    
         and l.booktype=l2.booktype    
         and l.lno=l2.lno    
         and vdt < @@opendate    
         and edt >= @@opendate    
         and l2.cltcode between @fcode and @tcode    
         and l2.costcode = c.costcode    
         and costname = rtrim(@branch)    
        Group by    
         l2.cltcode    
      ) t    
     Group by    
      cltcode    
     Order by    
      cltcode    
    end    
    
    insert into #temptable_gl    
    Select    
     l.booktype,    
     voudt1=convert(datetime, l.vdt),    
     effdt1=l.edt,    
     isnull(shortdesc,'') shortdesc,    
     dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),    
     cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),    
     l.vno,    
     Replace(l.narration,'"','') narration,    
     ddno=isnull((select top 1 ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype and lno = l.lno),''),    
     l2.cltcode,    
     a.longname,    
     vdt,    
     l.vtyp,    
     accat,    
     opbal=0,    
     crosac='',    
     a.acname,    
     a.branchcode,    
     l.lno    
    from    
     ledger l,    
     vmast v,    
     ledger2 l2,    
     acmast a,    
     costmast c    
    Where    
     l.vno = l2.vno    
     and l.vtyp = l2.vtype    
     and l.booktype = l2.booktype    
     and l.lno = l2.lno    
     and a.cltcode = l2.cltcode    
     and l2.cltcode between @fcode and @tcode    
     And l.vtyp = v.vtype    
     and a.accat <> '4'    
     and l2.cltcode=a.cltcode    
     and costname = rtrim(@branch)    
     and l2.vtype <> 18    
     and l2.costcode = c.costcode    
     and  l.edt between @fdate and @tdate + ' 23:59:59'    
    order by    
     l2.cltcode,    
     voudt1,    
     l.vtyp desc,    
     l.vno    
   END    
 END    
    
insert into #temptable_gl     
select '', '', '', '', 0, 0, '', '', '', cltcode, '', '', 18, '', opbal, '', '', '', 0    
from #opbal    
    
Update    
 #temptable_gl    
set    
 opbal = l.opbal    
from    
 #opbal l    
where    
 #temptable_gl.cltcode = l.cltcode    
    
print 'test 1'    
Update    
 #temptable_gl    
set    
 crosac = l.cltcode    
from    
 ledger l    
where    
 l.vtyp not in('15','21')    
 and #temptable_gl.vtyp = l.vtyp    
 and #temptable_gl.booktype = l.booktype    
 and #temptable_gl.vno = l.vno    
 and #temptable_gl.cltcode <> l.cltcode    
print 'test 2'    
update    
 #temptable_gl    
set    
 branchcode = costname    
from    
 ledger2 l2,    
 costmast c    
where    
 #temptable_gl.vno = l2.vno    
 and #temptable_gl.vtyp = l2.vtype    
 and #temptable_gl.booktype = l2.booktype    
 and #temptable_gl.lno = l2.lno    
 and #temptable_gl.cltcode = l2.cltcode    
 and l2.costcode = c.costcode    
    
Select    
 booktype,    
 voudt = convert(varchar(11), voudt1, 103),    
 effdt = convert(varchar(11), effdt1, 103),    
 shortdesc,    
 dramt,    
 cramt,    
 vno,    
 narration,    
 ddno,    
 cltcode,    
 longname,    
 vdt,    
 vtyp,    
 accat,    
 opbal,    
 crosac,    
 acname,    
 branchcode,    
 lno    
from    
 #temptable_gl    
Order By    
 CltCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_ListClient
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 02/18/2003 10:22:36 AM ******/
---------------------------------------------------------------------------------------------------------
--		PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------
--WRITTEN BY				:			SGK
--DATE					:			Feb 05 2003
---------------------------------------------------------------------------------------------------------
--				MODIFICATION HISTORY
---------------------------------------------------------------------------------------------------------
--	.1	BY	:	SGK			ON	:	Feb 05 2003
---------------------------------------------------------------------------------------------------------
CREATE PROCEDURE rpt_Acc_ListClient
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT varchar(3)		--	Account Category
AS
DECLARE
@strSQL VarChar(2500),
@@Inaccat varchar(3)
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))
--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */
--BROKER LOGIN
If  @STATUSID="BROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%')" 
--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS	
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End
--BRANCH LOGIN
IF @STATUSID="BRANCH"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	(branchcode LIKE '" + @STATUSNAME + "' OR branchcode = 'ALL') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%')" 
--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End
--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2, "
	Set @strSQL = @strSQL + "	msajag.dbo.subbrokers s "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.sub_broker = s.sub_broker AND "
	Set @strSQL = @strSQL + "	c1.sub_broker LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "
--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
End
--TRADER LOGIN
If @STATUSID="TRADER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.trader "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2, "
	Set @strSQL = @strSQL + "	msajag.dbo.branches s "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.trader = s.branch_cd AND "
	Set @strSQL = @strSQL + "	c1.trader LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "
--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.trader "
End
--FAMILY LOGIN
If @STATUSID="FAMILY"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.family "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2 "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.family LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "
--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.family "
End
If @STATUSID="CLIENT"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2 "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @STATUSNAME + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode "
End
	Set @strSQL = @strSQL + "	OPTION  (FAST 10)"
Print @strSQL
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_ListClient_Report
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[rpt_Acc_ListClient_Report]                
 @STATUSID VARCHAR(15),                      
 @STATUSNAME VARCHAR(25),                      
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH                      
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.                      
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.                      
 @ACCAT VARCHAR(3)   -- Account Category                      
                      
AS          
DECLARE                      
@strSQL VarChar(2500),                      
@@Inaccat varchar(3)                      
                      
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))                      
                      
--SET DEFAULT VALUES                      
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"                      
/* SET @BOOKTYPE = @BOOKTYPE + "%" */                      
                      
--BROKER LOGIN                      
If  @STATUSID="BROKER"                      
Begin                      
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " cltcode, "                      
 Set @strSQL = @strSQL + " acname, "                      
 Set @strSQL = @strSQL + " branchcode "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' AND "                      
 Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%' "                        
        if rtrim(@accat) = '3'                      
           begin                      
  select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))"                       
           end                      
        else                      
           begin                      
  select @strSQL = @strSQL + " )"                       
           end                      
                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " cltcode, "                      
 Set @strSQL = @strSQL + " branchcode "                      
End                      
                      
--BRANCH LOGIN                      
IF @STATUSID="BRANCH"                      
Begin                      
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " cltcode, "                      
 Set @strSQL = @strSQL + " acname, "                      
 Set @strSQL = @strSQL + " branchcode "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast "                      
 Set @strSQL = @strSQL + "WHERE "                      
                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " (branchcode = '" + @STATUSNAME + "' OR branchcode = 'ALL') AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' AND "                      
 Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%' "                      
        if rtrim(@accat) = '3'                      
           begin                      
  select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))"                       
           end                      
        else                      
           begin                      
  select @strSQL = @strSQL + " )"                       
           end                      
                      
                      
 Set @strSQL = @strSQL + "ORDER BY "                 
 Set @strSQL = @strSQL + " cltcode, "                      
 Set @strSQL = @strSQL + " branchcode "                      
End          
                      
--SUB-BROKER LOGIN                      
IF @STATUSID="SUBBROKER"                      
Begin                      
 Set @strSQL = "SELECT "                   
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname, "                
 Set @strSQL = @strSQL + " c1.sub_broker "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client1 c1, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client2 c2, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.subbrokers s "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "                      
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "                      
 Set @strSQL = @strSQL + " c1.sub_broker = s.sub_broker AND "                      
 Set @strSQL = @strSQL + " c1.sub_broker LIKE '" + @STATUSNAME + "' AND "                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " c1.sub_broker "                      
End                      
                      
--TRADER LOGIN                      
If @STATUSID="TRADER"                      
Begin                      
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname, "                      
 Set @strSQL = @strSQL + " c1.trader "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client1 c1, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client2 c2, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.branches s "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "                      
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "                      
 Set @strSQL = @strSQL + " c1.trader = s.branch_cd AND "                      
 Set @strSQL = @strSQL + " c1.trader LIKE '" + @STATUSNAME + "' AND "                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " c1.trader "                      
End                      
                      
--FAMILY LOGIN                      
If @STATUSID="FAMILY"                      
Begin                      
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname, "                      
 Set @strSQL = @strSQL + " c1.family "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client1 c1, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client2 c2 "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "                       Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "                      
 Set @strSQL = @strSQL + " c1.family LIKE '" + @STATUSNAME + "' AND "                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " c1.family "                      
End                      
                      
If @STATUSID="CLIENT"                      
Begin                      
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client1 c1, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client2 c2 "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "                      
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "                      
 Set @strSQL = @strSQL + " cltcode LIKE '" + @STATUSNAME + "' AND "                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode "                      
End                      
                      
IF @STATUSID="REGION"                      
Begin              
            
If @ACCAT = 3             
begin            
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "            
 Set @strSQL = @strSQL + " NCDX.dbo.region c1 "            
 Set @strSQL = @strSQL + " where (a.branchcode = c1.branch_code OR a.branchcode = 'ALL') AND"            
 Set @strSQL = @strSQL + " c1.regioncode LIKE '" + @STATUSNAME + "' AND "             
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' and accat in(3, 14, 18)"                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode "                      
            
end             
else                    
BEGIN            
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client1 c1, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client2 c2 "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "                      
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "                      
 Set @strSQL = @strSQL + " c1.region LIKE '" + @STATUSNAME + "' AND "                      
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode "               
end             
End                      
print @strSQL      
                 
                    
If @STATUSID="AREA"                      
Begin                      
 Set @strSQL = "SELECT "                      
 Set @strSQL = @strSQL + "DISTINCT "                      
 Set @strSQL = @strSQL + " a.cltcode, "                      
 Set @strSQL = @strSQL + " a.acname "                      
 Set @strSQL = @strSQL + "FROM "                      
 Set @strSQL = @strSQL + " acmast a, "                   
 Set @strSQL = @strSQL + " NCDX.dbo.client1 c1, "                      
 Set @strSQL = @strSQL + " NCDX.dbo.client2 c2 "                      
 Set @strSQL = @strSQL + "WHERE "                      
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "                      
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "                      
 Set @strSQL = @strSQL + " c1.area LIKE '" + @STATUSNAME + "' AND "       
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "                      
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "                      
 Set @strSQL = @strSQL + "ORDER BY "                      
 Set @strSQL = @strSQL + " a.cltcode "                      
End                      
                    
                    
                  
                  
                  
 Set @strSQL ='set transaction isolation level read uncommitted '+ @strSQL + " OPTION  (FAST 10)"                      
                      
Print @strSQL                      
Exec (@strSQL)           
          
SET ANSI_NULLS ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_ListClient_Report_17032011
-- --------------------------------------------------
CREATE PROCEDURE rpt_Acc_ListClient_Report_17032011 
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH  
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.  
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.  
 @ACCAT VARCHAR(3)   -- Account Category  
AS  
DECLARE  
@strSQL VarChar(2500),  
@@Inaccat varchar(3)  
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))  
--SET DEFAULT VALUES  
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"  
/* SET @BOOKTYPE = @BOOKTYPE + "%" */  
--BROKER LOGIN  
If  @STATUSID="BROKER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " acname, "  
 Set @strSQL = @strSQL + " branchcode "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' AND "  
 Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%')"    
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " branchcode "  
End  
--BRANCH LOGIN  
IF @STATUSID="BRANCH"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " acname, "  
 Set @strSQL = @strSQL + " branchcode "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " (branchcode = '" + @STATUSNAME + "' OR branchcode = 'ALL') AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' AND "  
 Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%')"  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " branchcode "  
End  
--SUB-BROKER LOGIN  
IF @STATUSID="SUBBROKER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.sub_broker "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1  
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2, " -- msajag.dbo.client2  
 Set @strSQL = @strSQL + " ncdx.dbo.subbrokers s " -- msajag.dbo.subbrokers  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.sub_broker = s.sub_broker AND "  
 Set @strSQL = @strSQL + " c1.sub_broker LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.sub_broker "  
End  
--TRADER LOGIN  
If @STATUSID="TRADER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.trader "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1  
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2, " -- msajag.dbo.client2  
 Set @strSQL = @strSQL + " ncdx.dbo.branches s " -- msajag.dbo.branches  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.trader = s.branch_cd AND "  
 Set @strSQL = @strSQL + " c1.trader LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.trader "  
End  
--FAMILY LOGIN  
If @STATUSID="FAMILY"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.family "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1  
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2 " -- msajag.dbo.client2  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.family LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.family "  
End  
  
If @STATUSID="REGION"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.region "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1  
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2 " -- msajag.dbo.client2  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.region LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.region "  
End  
  
If @STATUSID="CLIENT"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1  
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2 " -- msajag.dbo.client2  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @STATUSNAME + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode "  
End  
 Set @strSQL = @strSQL + " OPTION  (FAST 10)"  
Print @strSQL  
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_ListClient_Report_new
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient_Report_new    Script Date: 1/17/2004 11:39:09 PM ******/  
  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

   
/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient_Report    Script Date: 02/18/2003 10:22:36 AM ******/  
---------------------------------------------------------------------------------------------------------  
--  PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT  
---------------------------------------------------------------------------------------------------------  
--WRITTEN BY    :   SGK  
--DATE     :   Feb 05 2003  
---------------------------------------------------------------------------------------------------------  
--    MODIFICATION HISTORY  
---------------------------------------------------------------------------------------------------------  
-- .1 BY : SGK   ON : Feb 05 2003  
---------------------------------------------------------------------------------------------------------  
CREATE PROCEDURE rpt_Acc_ListClient_Report_new  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH  
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.  
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.  
 @ACCAT VARCHAR(3)  , -- Account Category  
 @RPTORDER varchar(6)  -- Account Category  
AS  
DECLARE  
@strSQL VarChar(2500),  
@@Inaccat varchar(3)  
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))  
--SET DEFAULT VALUES  
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"  
/* SET @BOOKTYPE = @BOOKTYPE + "%" */  
--BROKER LOGIN  
If  @STATUSID="BROKER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " acname, "  
 Set @strSQL = @strSQL + " branchcode "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' AND "  
 Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%')"    
            IF @RPTORDER =  "ACCODE"  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " cltcode, "  
  Set @strSQL = @strSQL + " branchcode "  
              end  
           else  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " ACNAME, "  
  Set @strSQL = @strSQL + " branchcode "  
              end   
End  
--BRANCH LOGIN  
IF @STATUSID="BRANCH"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " acname, "  
 Set @strSQL = @strSQL + " branchcode "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast "  
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " (branchcode = '" + @STATUSNAME + "' OR branchcode = 'ALL') AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' AND "  
 Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%')"  
 /*Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " cltcode, "  
 Set @strSQL = @strSQL + " branchcode "*/  
   IF @RPTORDER =  "ACCODE"  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " cltcode, "  
  Set @strSQL = @strSQL + " branchcode "  
              end  
           else  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " ACNAME, "  
  Set @strSQL = @strSQL + " branchcode "  
              end   
End  
--SUB-BROKER LOGIN  
IF @STATUSID="SUBBROKER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.sub_broker "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2, " -- msajag.dbo.client12
 Set @strSQL = @strSQL + " ncdx.dbo.subbrokers s " -- msajag.dbo.subbrokers
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.sub_broker = s.sub_broker AND "  
 Set @strSQL = @strSQL + " c1.sub_broker LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 /*Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.sub_broker "*/  
   IF @RPTORDER =  "ACCODE"  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.cltcode, "  
  Set @strSQL = @strSQL + " c1.sub_broker "  
              end  
           else  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.ACNAME, "  
  Set @strSQL = @strSQL + " c1.sub_broker "  
              end   
End  
--TRADER LOGIN  
If @STATUSID="TRADER"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.trader "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2, " -- msajag.dbo.client2
 Set @strSQL = @strSQL + " ncdx.dbo.branches s " -- msajag.dbo.branches
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.Branch_cd = s.branch_cd AND "  
 Set @strSQL = @strSQL + " c1.trader LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
            
 /*Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.trader "*/  
   IF @RPTORDER =  "ACCODE"  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.cltcode, "  
  Set @strSQL = @strSQL + " c1.trader "  
              end  
           else  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.ACNAME, "  
  Set @strSQL = @strSQL + " c1.trader  "  
              end   
               
End  
--FAMILY LOGIN  
If @STATUSID="FAMILY"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.family "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2 " -- msajag.dbo.client2
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.family LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 /*Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.family "*/  
  IF @RPTORDER =  "ACCODE"  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.cltcode, "  
  Set @strSQL = @strSQL + " c1.family   "  
              end  
           else  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.ACNAME, "  
  Set @strSQL = @strSQL + " c1.family   "  
              end   
End  

--Added By Bharat For Region
If @STATUSID="REGION"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname, "  
 Set @strSQL = @strSQL + " c1.region "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2 " -- msajag.dbo.client2
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " c1.region LIKE '" + @STATUSNAME + "' AND "  
 Set @strSQL = @strSQL + " cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
 Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "  
 /*Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " c1.family "*/  
  IF @RPTORDER =  "ACCODE"  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.cltcode, "  
  Set @strSQL = @strSQL + " c1.region   "  
              end  
           else  
              begin  
  Set @strSQL = @strSQL + "ORDER BY "  
  Set @strSQL = @strSQL + " a.ACNAME, "  
  Set @strSQL = @strSQL + " c1.region   "  
              end   
End  
--Ended

If @STATUSID="CLIENT"  
Begin  
 Set @strSQL = "SELECT "  
 Set @strSQL = @strSQL + "DISTINCT "  
 Set @strSQL = @strSQL + " a.cltcode, "  
 Set @strSQL = @strSQL + " a.acname "  
 Set @strSQL = @strSQL + "FROM "  
 Set @strSQL = @strSQL + " acmast a, "  
 Set @strSQL = @strSQL + " ncdx.dbo.client1 c1, " -- msajag.dbo.client1
 Set @strSQL = @strSQL + " ncdx.dbo.client2 c2 " -- msajag.dbo.client2
 Set @strSQL = @strSQL + "WHERE "  
 Set @strSQL = @strSQL + " c1.cl_code = c2.cl_code AND "  
 Set @strSQL = @strSQL + " a.cltcode = c2.party_code AND "  
 Set @strSQL = @strSQL + " cltcode LIKE '" + @STATUSNAME + "' "  
 Set @strSQL = @strSQL + "ORDER BY "  
 Set @strSQL = @strSQL + " a.cltcode "  
End  
 Set @strSQL = @strSQL + " OPTION  (FAST 10)"  
Print @strSQL  
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_ListClient_Report_temp
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient_Report    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient_Report    Script Date: 02/18/2003 10:22:36 AM ******/
---------------------------------------------------------------------------------------------------------
--		PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------
--WRITTEN BY				:			SGK
--DATE					:			Feb 05 2003
---------------------------------------------------------------------------------------------------------
--				MODIFICATION HISTORY
---------------------------------------------------------------------------------------------------------
--	.1	BY	:	SGK			ON	:	Feb 05 2003
---------------------------------------------------------------------------------------------------------
CREATE PROCEDURE [dbo].[rpt_Acc_ListClient_Report_temp]
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT VARCHAR(3)			--	Account Category
AS
DECLARE
@strSQL VarChar(2500),
@@Inaccat varchar(3)
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))
--SET DEFAULT VALUES
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */
--BROKER LOGIN
If  @STATUSID="BROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode >= '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' AND "
	Set @strSQL = @strSQL + "	(accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%')"  
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End
--BRANCH LOGIN
IF @STATUSID="BRANCH"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode >= '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	(branchcode = '" + @STATUSNAME + "' OR branchcode = 'ALL') AND "
	Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' AND "
	Set @strSQL = @strSQL + "	(accat LIKE '" + @ACCAT  + "%' or accat LIKE '" + @@Inaccat + "%')"
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End
--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2, " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "	ncdx.dbo.subbrokers s " -- msajag.dbo.subbrokers
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.sub_broker = s.sub_broker AND "
	Set @strSQL = @strSQL + "	c1.sub_broker LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode >= '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
End
--TRADER LOGIN
If @STATUSID="TRADER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.trader "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2, " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "	ncdx.dbo.branches s " -- msajag.dbo.branches
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.trader = s.branch_cd AND "
	Set @strSQL = @strSQL + "	c1.trader LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode >= '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.trader "
End
--FAMILY LOGIN
If @STATUSID="FAMILY"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.family "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2 " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.family LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode >= '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.family "
End

If @STATUSID="REGION"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.region "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2 " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.region LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode >= '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.region "
End

If @STATUSID="CLIENT"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2 " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @STATUSNAME + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode "
End
	Set @strSQL = @strSQL + "	OPTION  (FAST 10)"
Print @strSQL
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_Marginledger
-- --------------------------------------------------
  
/*USE ACCOUNT          
EXEC RPT_ACC_PARTYLEDGER_ALL 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'          
EXEC RPT_ACC_MARGINLEDGER 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'*/          
 --EXEC RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''                
                
--EXEC RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''                  
 /*                                
 PROC NAME RPT_ACC_PARTYLEDGER                                
 PARAMETERS FDATE - FROM DATE                                
            TDATE - DATE TO                                
            FCODE - AC CODE FROM                                
            TCODE - AC CODE TO                                
            STRORDER - PRINTING ORDER, POSSIBLE VAUES  ACCODE , ACNAME                                
            SELECTBY - REPORT SELECTION BY , POSSIBLE VALUES VDT, EDT                                
            STATUSID - POSSIBLEVALUES 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'                                
*/                                
                     
CREATE PROCEDURE [dbo].[rpt_acc_Marginledger]                                
                                 
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@FCODE VARCHAR(10),                                
@TCODE VARCHAR(10),                                
@STRORDER VARCHAR(6),                                
@SELECTBY VARCHAR(3),                                
@STATUSID VARCHAR(15),                                
@STATUSNAME VARCHAR(15),                                
@STRBRANCH VARCHAR(10)                                
AS                                
                                
DECLARE @@OPENDATE   AS VARCHAR(11)                                
                          
CREATE TABLE [DBO].[#MARGINLEDGERDATA] (                                  
  [BOOKTYPE] [CHAR] (2) NULL ,                                  
  [VOUDT] [DATETIME] NULL ,                                  
  [EFFDT] [DATETIME] NULL ,                                  
  [ACNAME] [VARCHAR] (100) NULL ,                        
  [SHORTDESC] [CHAR] (6) NULL ,                                    
  [DRCR] [CHAR] (1) NULL ,                                  
  [AMOUNT] [MONEY] NULL ,                                  
  [VNO] [VARCHAR] (12) NULL ,                                  
  [DDNO] [VARCHAR] (12) NULL ,                                  
  [NARRATION] [VARCHAR] (234) NULL ,                                  
  [PARTY_CODE] [VARCHAR] (10) NOT NULL ,                                  
  [VTYP] [SMALLINT] NULL ,                                  
  [VDT] [VARCHAR] (30) NULL ,                                  
  [EDT] [VARCHAR] (30) NULL ,                                              
  [LNO] [DECIMAL](5, 0) NULL,              
  [PDT] [DATETIME] NULL              
 ) ON [PRIMARY]                                  
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
                        
              
                        
                        
                        
SELECT @@OPENDATE = SDTCUR FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                
                                
/*GETTING LAST OPENING DATE */                                
/*IF UPPER(@SELECTBY) = 'VDT'                                
 BEGIN                                
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                                
 END                                
ELSE                                
 BEGIN                                
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                                
 END                */                
                                
/*CREATING BLANK TABLE FOR OPENING BALANCE*/                                
SELECT CLTCODE=PARTY_CODE,OPPBAL=AMOUNT INTO #OPPBALANCE FROM MARGINLEDGER WHERE 1=2                                
                                
/*GETTING OPENING BALANCE*/                                
IF @SELECTBY = 'VDT'                                
BEGIN                                
 IF @@OPENDATE = @FDATE            
 BEGIN                                
  INSERT INTO  #OPPBALANCE                                 
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                                
  FROM MARGINLEDGER                                 
  WHERE PARTY_CODE >= @FCODE AND PARTY_CODE <=@TCODE AND  VDT LIKE @FDATE + '%' AND VTYP = 18                                 
  GROUP BY PARTY_CODE                                
 END                                
 ELSE                                
 BEGIN                                
  INSERT INTO  #OPPBALANCE                                 
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                                  
  FROM MARGINLEDGER                                 
  WHERE PARTY_CODE >=@FCODE AND PARTY_CODE <= @TCODE  AND  VDT >=  @@OPENDATE + ' 00:00:00' AND VDT < @FDATE                                 
  GROUP BY PARTY_CODE                                
 END                                
END                                 
ELSE                                
BEGIN                                 
 IF @@OPENDATE = @FDATE                                 
 BEGIN        INSERT INTO  #OPPBALANCE                              
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                            
  FROM MARGINLEDGER                             
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                            
  GROUP BY PARTY_CODE                            
 END                              
 ELSE                              
 BEGIN                              
  INSERT INTO  #OPPBALANCE                                 
  SELECT CLTCODE, OPBAL=SUM(OPBAL)                            
  FROM                            
  (                           
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                            
  FROM MARGINLEDGER                             
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                            
  GROUP BY PARTY_CODE                            
  UNION ALL                            
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)                            
  FROM MARGINLEDGER                             
  WHERE PARTY_CODE = @FCODE AND VDT >= @@OPENDATE + ' 00:00:00' AND VDT < @FDATE AND VTYP <> 18                            
  GROUP BY PARTY_CODE) T                            
  GROUP BY CLTCODE                            
 END                              
END                                
                          
                
                          
IF @SELECTBY = 'VDT'                          
BEGIN                          
 INSERT INTO #MARGINLEDGERDATA                          
/*  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                           
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                           
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO             
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                           
  WHERE L.VDT >= @FDATE + ' 00:00:00' AND L.VDT <= @TDATE + ' 23:59:59'                          
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE*/  
    
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, A.LONGNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                           
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                           
  FROM (SELECT CLTCODE, LONGNAME, ACCAT FROM ACMAST WHERE CLTCODE  >= @FCODE AND CLTCODE <= @TCODE) A, MARGINLEDGER M   
  ,(SELECT VNO, VTYP, BOOKTYPE, LNO, VDT, EDT, NARRATION FROM LEDGER WHERE VDT >= @FDATE + ' 00:00:00' AND VDT <= @TDATE + ' 23:59:59') L, VMAST V  
  WHERE   
  M.PARTY_CODE = A.CLTCODE  
  and M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO  
  AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                            
END                          
ELSE                          
BEGIN                          
  INSERT INTO #MARGINLEDGERDATA                          
  /*SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                         
 L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT              
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                         
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                           
  WHERE L.EDT >= @FDATE + ' 00:00:00' AND L.EDT <= @TDATE + ' 23:59:59'                          
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE  */  
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, A.LONGNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                           
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                           
  FROM (SELECT CLTCODE, LONGNAME, ACCAT FROM ACMAST WHERE CLTCODE  >= @FCODE AND CLTCODE <= @TCODE) A, MARGINLEDGER M   
  ,(SELECT VNO, VTYP, BOOKTYPE, LNO, VDT, EDT, NARRATION FROM LEDGER WHERE EDT >= @FDATE + ' 00:00:00' AND EDT <= @TDATE + ' 23:59:59') L, VMAST V  
  WHERE   
  M.PARTY_CODE = A.CLTCODE  
  and M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO  
  AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                          
END                          
                          
                                
/*GETTING CLIENT LIST*/                                
SELECT C2.PARTY_CODE,BANK_NAME =ISNULL(C4.BANKID,''),                                
L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,C1.BRANCH_CD,                        
FAMILY,C1.SUB_BROKER,TRADER,CL_TYPE,CLTDPID =ISNULL(CLTDPID,'')                                
INTO #LEDGERCLIENTS                                
FROM NCDX.DBO.CLIENT1 C1 ,NCDX.DBO.CLIENT2 C2 LEFT OUTER JOIN NCDX.DBO.CLIENT4  C4 ON                                
(C2.PARTY_CODE=C4.PARTY_CODE  AND  DEPOSITORY NOT IN ('NSDL','CDSL')  AND  DEFDP=1)                                
WHERE C1.CL_CODE=C2.CL_CODE                                
AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)                                
AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUB_BROKER' THEN @STATUSNAME ELSE  '%' END)                                
AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)                                
AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE  '%' END)                                
AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE  '%' END)                                
AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                                
AND C2.PARTY_CODE >= @FCODE AND C2.PARTY_CODE <= @TCODE                     
                           
                                                              
/*GETTING LDDGER ENTRIES*/    

ALTER TABLE #LEDGERCLIENTS
ALTER COLUMN BANK_NAME VARCHAR(50)
                  
SELECT M.BOOKTYPE, M.VOUDT, M.EFFDT, M.SHORTDESC,                                 
DRAMT=(CASE WHEN UPPER(M.DRCR) = 'D' THEN M.AMOUNT ELSE 0 END),                                  
CRAMT=(CASE WHEN UPPER(M.DRCR) = 'C' THEN M.AMOUNT ELSE 0 END),                                
M.VNO, M.DDNO, M.NARRATION, C.PARTY_CODE CLTCODE,VTYP = ISNULL(M.VTYP, 18), M.VDT,                                 
M.EDT, M.ACNAME , OPBAL = AMOUNT,                                 
C.L_ADDRESS1,C.L_ADDRESS2,C.L_ADDRESS3,C.L_CITY,C.L_ZIP,C.RES_PHONE1,C.BRANCH_CD, M.PARTY_CODE CROSAC ,                             
EDIFF=DATEDIFF(D,M.EFFDT,GETDATE()), C.FAMILY,C.SUB_BROKER,C.TRADER,C.CL_TYPE,                                
C.BANK_NAME,C.CLTDPID, M.LNO, M.PDT                                       
INTO  #TMPMLEDGER                                       
FROM  #MARGINLEDGERDATA M RIGHT OUTER JOIN #LEDGERCLIENTS C ON (M.PARTY_CODE=C.PARTY_CODE)                                
                  
/*UPDATING OPENING BLANACE*/                                
UPDATE #TMPMLEDGER SET OPBAL = 0                                
UPDATE #TMPMLEDGER SET OPBAL = T.OPPBAL FROM #TMPMLEDGER M,#OPPBALANCE T WHERE M.CLTCODE = T.CLTCODE                                
                          
                                
/*UPDATING BANK NAME*/                               

UPDATE  #TMPMLEDGER SET #TMPMLEDGER.BANK_NAME= B.BANK_NAME  FROM                                
NCDX.DBO.POBANK  B 
--WHERE LTRIM(RTRIM(CAST(B.BANKID  AS CHAR))) = LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                                
WHERE CONVERT(varchar,b.bankid)= LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                                


                            
UPDATE  #TMPMLEDGER SET #TMPMLEDGER.ACNAME= A.ACNAME  FROM                                
ACMAST A WHERE LTRIM(RTRIM(A.CLTCODE)) = LTRIM(RTRIM(#TMPMLEDGER.CLTCODE))                                
                  
                
                            
IF @STRORDER = 'ACCODE'                                
 BEGIN                                
  IF @SELECTBY = 'VDT'                                
   BEGIN                                 
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE      
    L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
    ORDER BY L.CLTCODE,VOUDT                                
   END                                
  ELSE                                
   BEGIN                                
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A       
    WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
 ORDER BY L.CLTCODE,EFFDT                                
   END                                
 END           
ELSE                                
  BEGIN                                
   IF @SELECTBY = 'VDT'                                
    BEGIN                                 
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A       
 WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
 ORDER BY L.ACNAME,VOUDT                                
    END                                
   ELSE                                
    BEGIN                                
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A       WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
 ORDER BY L.ACNAME,EFFDT                                
    END                                
  END                                
                                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_partyledger
-- --------------------------------------------------
--exec rpt_acc_partyledger_test 'Aug  1 2005','Aug  9 2005','000499','test804','ACCODE','vdt','broker','broker',''  
--Exec rpt_acc_partyledger 'Apr  1 2004','Sep 17 2004','KOLK41737','KOLK41737','edt','edt','branch','retailkolh',''            
            
            
/*              
 proc name rpt_acc_partyledger              
 parameters fdate - from date              
            tdate - date to              
            fcode - ac code from              
            tcode - ac code to              
            strorder - printing order, possible vaues  ACCODE , ACNAME              
            selectby - report selection by , possible values vdt, edt              
            statusid - possiblevalues 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'              
              
 last modified : Sep 28 2004 eff wise opbal               
*/              
        
CREATE  procedure rpt_acc_partyledger  
               
@fdate varchar(11),            /* As mmm dd yyyy */              
@tdate varchar(11),            /* As mmm dd yyyy */              
@fcode varchar(10),              
@tcode varchar(10),              
@strorder varchar(6),              
@selectby varchar(3),              
@statusid varchar(15),              
@statusname varchar(15),              
@strbranch varchar(10)              
 as              
              
Declare @@opendate   as varchar(11)              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
              
              
/*Getting last opening date */              
if upper(@selectby) = 'VDT'              
 begin              
  Select @@opendate = ( Select left(convert(varchar,isnull(max(vdt),0),109),11) from ledger where vtyp = 18 and vdt <= @fdate )              
 end              
else              
 begin              
  Select @@opendate = ( Select left(convert(varchar,isnull(max(edt),0),109),11) from ledger where vtyp = 18 and edt <= @fdate )              
 end              
              
/*Creating blank table for opening balance*/              
Select CltCode,oppbal=Vamt into #OppBalance From Ledger where 1=2              
              
/*Getting opening balance*/              
if @selectby = 'vdt'              
 begin              
  if @@opendate = @fdate               
   begin              
    Insert into  #OppBalance               
    select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'D' then b.vamt else -b.vamt end),0)              
    from ledger b              
    where b.cltcode >= @FCode And B.CltCode <=@TCode and  b.vdt like @fdate + '%' and vtyp = 18               
    Group By CltCode              
   end              
  else              
   begin              
    Insert into  #OppBalance               
    select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'D' then b.vamt else -b.vamt end),0)                
    from ledger b               
    where b.cltcode >=@FCode And B.CltCode <= @TCode  and  b.vdt >=  @@opendate + ' 00:00:00' and vdt < @fdate               
    Group By CltCode              
   end              
 end               
else              
 begin               
         if @@opendate = @fdate               
            begin            
      Insert into  #OppBalance            
               select cltcode, opbal=sum(opbal)            
               from            
      (            
                 Select cltcode, opbal = IsNull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)                
                 from ledger             
                 where  cltcode >=@FCode And CltCode <= @TCode and edt like @@opendate + '%' and vtyp = 18            
                 group by cltcode            
            
                 union all            
            
       Select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'C' then b.vamt else -b.vamt end),0)                
         from ledger b               
         where b.cltcode >=@FCode And B.CltCode <= @TCode  and  b.edt >=  @@opendate + ' 00:00:00' and vdt < @@opendate     
    group By CltCode             
            
      ) t            
      Group By CltCode              
            end            
         else            
            begin            
      Insert into  #OppBalance               
               select cltcode, opbal=sum(opbal)        
               from            
               (             
       Select cltcode, opbal = IsNull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)                
                 from ledger             
                 where  cltcode >=@FCode And CltCode <= @TCode and edt like @@opendate + '%' and vtyp = 18            
                 group by cltcode            
            
                 union all            
            
                 Select cltcode, opbal = sum( case when upper(drcr) = 'D' then vamt else -vamt end)            
                 from ledger             
                 where  cltcode >=@FCode And CltCode <= @TCode and edt >= @@opendate + ' 00:00:00' and edt < @fdate and vtyp <> 18            
                 group by cltcode             
                
      union all            
            
      Select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'C' then b.vamt else -b.vamt end),0)                
        from ledger b               
        where b.cltcode >=@FCode And B.CltCode <= @TCode  and  b.edt >=  @@opendate + ' 00:00:00' and vdt < @@opendate and vtyp <> 18  
        group By CltCode             
      ) t            
               group by cltcode            
            end            
 end              
              
/*Generating blank structure for filtered Ledger */              
Select l.*,shortdesc=space(35) into #LedgerData from Ledger l where 1 = 2              
              
/*Getting fiiltered ledger*/              
if @selectby = 'vdt'              
 begin              
  Insert into #LedgerData Select l.*,  isnull(v.shortdesc,'') shortdesc from Ledger l, vMast v where vdt >= @fdate + ' 00:00:00'              
  and l.vtyp = v.vtype  and              
  vdt <= @tdate +' 23:59:59' and CltCode >= @fcode And CltCode <= @tcode               
              
 end               
else              
 begin              
  Insert into #LedgerData Select  l.*, isnull(v.shortdesc,'') shortdesc from Ledger l, vMast v where edt >= @fdate + ' 00:00:00'               
  and l.vtyp = v.vtype  and              
  edt <= @tdate +' 23:59:59' and CltCode >= @fcode And CltCode <= @tcode               
 end              
              
/*Getting client list*/              
Select c2.Party_code,Bank_Name =Convert(Varchar(50), isnull(c4.bankid,Space(50))),              
L_Address1 = Convert(Varchar(100), isnull(L_Address1,Space(100))),L_Address2 = Convert(Varchar(100), isnull(L_Address2,Space(100))),L_Address3 = Convert(Varchar(100), isnull(L_Address3,Space(100))),L_city,L_zip,Res_Phone1,c1.Branch_cd,              
Family,c1.Sub_Broker,trader,Cl_type,Cltdpid =isnull(Cltdpid,'')              
              
into #LedgerClients              
              
 from              
  mcdx.dbo.client1 c1 ,mcdx.dbo.client2 c2 left outer join mcdx.dbo.client4  c4 on              
 (c2.party_code=c4.party_code  and  Depository NOT IN ('NSDL','CDSL')  and  DefDp=1)              
Where c1.cl_code=c2.cl_code              
And c1.Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)              
And sub_broker Like (Case When @statusid = 'subbroker' then @statusname else  '%' end)              
And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)              
And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)              
And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)              
and c1.Branch_Cd like @strbranch +'%'              
and c2.Party_code >= @fcode And c2.Party_code <= @tcode               
      
if @statusid='broker'      
 begin      
      
  /*including remissor also at report*/      
  Insert into #LedgerClients      
        
  Select Sub_Broker Party_code,' ' Bank_Name ,              
  Address1 L_Address1,Address2 L_Address2,' ' L_Address3,City L_city,Zip L_zip,      
  Phone1 Res_Phone1,Branch_Code Branch_cd,' ' Family,' 'Sub_Broker,' ' trader,' ' Cl_type,' ' Cltdpid      
  From mcdx.dbo.SubBrokers      
  Where Sub_Broker not in (Select Party_Code From #LedgerClients )      
      
 end      
              
/*Getting lddger entries*/              
Select l.booktype, voudt=l.vdt, effdt=l.edt, l.shortdesc,               
 dramt=(case when upper(l.drcr) = 'D' then l.vamt else 0 end),                
 cramt=(case when upper(l.drcr) = 'C' then l.vamt else 0 end),              
 l.vno, ddno= space(15), l.Narration, c.Party_code CltCode,l.vtyp, convert(varchar,l.vdt,103) vdt,               
 convert(varchar,l.edt,103) edt, l.Acname , opbal = vamt,               
 c.L_Address1,c.L_Address2,c.L_Address3,c.L_city,c.L_zip,c.Res_Phone1,c.Branch_cd, l.cltcode crosac ,              
 ediff=datediff(d,l.edt,getdate()), c.Family,c.Sub_Broker,c.trader,c.Cl_type,              
 c.Bank_Name, c.Cltdpid, L.LNo               
              
into  #tmpLedger               
              
from  #LedgerData l Right outer join #LedgerClients c on (l.cltcode=c.party_code)              
              
/*Updating opening blanace*/              
Update #tmpLedger set OpBal = 0              
Update #tmpLedger set OpBal = t.oppbal from #tmpLedger l,#OppBalance t where l.cltcode = t.cltcode              
              
/*Updating cheque number*/              
Update #TmpLedger Set ddno = l1.ddno From Ledger1 L1              
Where l1.vno=#TmpLedger.vno and l1.vtyp=#TmpLedger.vtyp and l1.booktype=#TmpLedger.booktype and l1.lno = #TmpLedger.lno               
              
/*Updating cross account code*/              
update #tmpLedger set #tmpLedger.crosac=b.cltcode from              
ledger b, acmast v                 
Where b.cltcode = v.cltcode and v.accat=2 And #tmpLedger.booktype=b.booktype               
and #tmpLedger.vno=b.vno and #tmpLedger.vtyp=b.vtyp               
And ltrim(rtrim(#tmpLedger.vtyp)) in ('01','1','02','2','03','3','04','4','05','5','16','17','19','20','22','23')               
              
/*Updating bank name*/                             
update  #tmpLedger set #tmpLedger.bank_name= b.bank_name  from              
mcdx.dbo.pobank  b where ltrim(rtrim(cast(b.bankid  as char))) = ltrim(rtrim(#tmpLedger.bank_name))              
if @strorder = 'ACCODE'                
 begin                
  if @selectby = 'vdt'                
   begin                 
    select l.*,a.longname Acname from #tmpLedger l, acmast a  where a.cltcode =l.cltcode  and ( l.dramt <>0   or l.cramt <>0  or round(opbal,0) <> 0) order by l.cltcode,voudt                
   end                
  else                
   begin                
    select l.*,a.longname Acname from #tmpLedger l, acmast a  where a.cltcode =l.cltcode  and ( l.dramt <>0   or l.cramt <>0  or round(opbal,0) <> 0) order by l.cltcode,effdt                
   end                
  end                
 else                
  begin                
   if @selectby = 'vdt'                
    begin                 
     select l.*,a.longname Acname from #tmpLedger l, acmast a  where a.cltcode =l.cltcode and ( l.dramt <>0   or l.cramt <>0  or round(opbal,0) <> 0) order by l.Acname,voudt                
    end                
   else                
    begin                
     select l.*,a.longname Acname from #tmpLedger l, acmast a  where a.cltcode =l.cltcode and ( l.dramt <>0   or l.cramt <>0  or round(opbal,0) <> 0) order by l.Acname,effdt                
    end                
   end                
/*  ------------------------------   End Of the Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_partyledger_All
-- --------------------------------------------------

--exec rpt_acc_partyledger_all 'Aug  1 2005','Aug  9 2005','000499','test804','ACCODE','vdt','broker','broker',''  
--exec rpt_acc_partyledger 'Aug  1 2005','Aug  9 2005','000499','test804','ACCODE','vdt','broker','broker',''  
--Exec rpt_acc_partyledger_all 'Mar 1 2005','Mar 17 2005','1','1','ACCODE','vdt','broker','broker',''    
CREATE PROCEDURE rpt_acc_partyledger_All             
@fdate varchar(11),            /* As mmm dd yyyy */              
@tdate varchar(11),            /* As mmm dd yyyy */              
@fcode varchar(10),              
@tcode varchar(10),              
@strorder varchar(6),              
@selectby varchar(3),              
@statusid varchar(15),              
@statusname varchar(15),              
@strbranch varchar(10)            
            
AS            
            
BEGIN            
            
CREATE TABLE [dbo].[#tmpLedgerNew] (              
  [booktype] [char] (2) NULL ,              
  [voudt] [datetime] NULL ,              
  [effdt] [datetime] NULL ,              
  [shortdesc] [char] (6) NULL ,              
  [dramt] [money] NULL ,              
  [cramt] [money] NULL ,              
  [vno] [varchar] (12) NULL ,              
  [ddno] [varchar] (30) NULL ,              
  [Narration] [varchar] (1000) NULL ,              
  [cltcode] [varchar] (10) NOT NULL ,              
  [vtyp] [smallint] NULL ,              
  [vdt] [varchar] (30) NULL ,              
  [edt] [varchar] (30) NULL ,              
  [Acname] [varchar] (100) NULL ,              
  [opbal] [money] NULL ,              
  [L_Address1] [varchar] (40) NULL ,              
  [L_Address2] [varchar] (40) NULL ,              
  [L_Address3] [varchar] (40) NULL ,              
  [L_city] [varchar] (40) NULL ,              
  [L_zip] [varchar] (10) NULL ,              
  [Res_Phone1] [varchar] (15) NULL ,              
  [Branch_cd] [varchar] (10) NULL ,              
  [crosac] [varchar] (10) NULL ,              
  [ediff] [int] NULL ,              
  [Family] [varchar] (10) NULL ,              
  [Sub_Broker] [varchar] (10) NULL ,              
  [trader] [varchar] (20) NULL ,              
  [Cl_type] [varchar] (3) NULL ,              
  [Bank_Name] [varchar] (100) NULL ,              
  [Cltdpid] [varchar] (16) NULL ,              
  [LNo] [decimal](5, 0) NULL ,              
  [LongName] [Varchar] (100) NULL,    
  [Segment] [varchar] (4) NULL,        
  [Entity] [varchar] (50) NULL          
 ) ON [PRIMARY]              
          
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,ddno,Narration,cltcode,          
vtyp,vdt,edt,Acname,opbal,L_Address1,L_Address2,L_Address3,L_city,L_zip,Res_Phone1,Branch_cd,          
crosac,ediff,Family,Sub_Broker,trader,Cl_type,Bank_Name,Cltdpid,LNo, LongName)           
Exec accountmcdx.dbo.rpt_acc_partyledger @fdate,@tdate,@fcode,@tcode,@strorder ,@selectby,@statusid,@statusname,@strbranch          
    
UPDATE #tmpLedgerNew set Segment='1MCX',Entity='COMMODITIES - MCX' where Segment is NULL  
          
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,ddno,Narration,cltcode,          
vtyp,vdt,edt,Acname,opbal,L_Address1,L_Address2,L_Address3,L_city,L_zip,Res_Phone1,Branch_cd,          
crosac,ediff,Family,Sub_Broker,trader,Cl_type,Bank_Name,Cltdpid,LNo, LongName)           
Exec accountncdx.dbo.rpt_acc_partyledger @fdate,@tdate,@fcode,@tcode,@strorder ,@selectby,@statusid,@statusname,@strbranch          
          
UPDATE #tmpLedgerNew set Segment='2NCX',Entity='COMMODITIES - NCDEX' where Segment is NULL          
          
    
      
      
--Margin      
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,ddno,Narration,cltcode,          
vtyp,vdt,edt,Acname,opbal,L_Address1,L_Address2,L_Address3,L_city,L_zip,Res_Phone1,Branch_cd,          
crosac,ediff,Family,Sub_Broker,trader,Cl_type,Bank_Name,Cltdpid,LNo)           
Exec accountmcdx.dbo.rpt_acc_Marginledger @fdate,@tdate,@fcode,@tcode,@strorder ,@selectby,@statusid,@statusname,@strbranch          
          
UPDATE #tmpLedgerNew set Segment='4MCX',Entity='PARTY MARGIN - MCX' where Segment is NULL            
    
    
INSERT INTO #tmpLedgerNew(booktype,voudt,effdt,shortdesc,dramt,cramt,vno,ddno,Narration,cltcode,          
vtyp,vdt,edt,Acname,opbal,L_Address1,L_Address2,L_Address3,L_city,L_zip,Res_Phone1,Branch_cd,          
crosac,ediff,Family,Sub_Broker,trader,Cl_type,Bank_Name,Cltdpid,LNo)           
Exec accountncdx.dbo.rpt_acc_Marginledger @fdate,@tdate,@fcode,@tcode,@strorder ,@selectby,@statusid,@statusname,@strbranch          
          
UPDATE #tmpLedgerNew set Segment='5NCX',Entity='PARTY MARGIN - NCDEX' where Segment is NULL            
    
         
if @strorder = 'ACCODE'              
begin              
 if @selectby = 'vdt'              
 begin               
 select * from #tmpLedgerNew order by cltcode,segment,voudt              
 end              
 else              
 begin              
  select * from #tmpLedgerNew order by cltcode,segment,effdt              
 end              
end              
else              
begin                
 if @selectby = 'vdt'              
 begin               
  select * from #tmpLedgerNew order by Acname,segment,voudt              
 end              
 else              
 begin              
  select * from #tmpLedgerNew order by Acname,segment,effdt              
 end              
end            
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_COMM
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_ACC_PARTYLEDGER_COMM]                              
(                                
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                                      
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                                      
 @FCODE VARCHAR(10),                                      
 @TCODE VARCHAR(10),                                      
 @STRORDER VARCHAR(6),                                      
 @SELECTBY VARCHAR(3),                                      
 @STATUSID VARCHAR(15),                                      
 @STATUSNAME VARCHAR(15),                                      
 @STRBRANCH VARCHAR(10)                                      
)                                
                                
AS                                      
                                      
/*========================================================================                                
      EXEC Rpt_acc_partyledger_Comm_ALL                                 
            'NOV  1 2005',                                
            'DEC 31 2005',                                
            'A',                                
            'ZZZ',                                
            'ACCODE',                                
            'VDT',                                
            'BROKER',                                
            'UNDEFINED',                                
            ''                                
========================================================================*/                                
                                
DECLARE                                 
 @@OPENDATE   AS VARCHAR(11)                                      
-------------------------------------------------                
-- CREATING TEMPORARY TABLE                
-------------------------------------------------                
CREATE TABLE #OPPBALANCE                
(                
 CLTCODE VARCHAR(10),                
 OPPBAL MONEY                
)                
                
CREATE TABLE #LEDGERCLIENTS(                
 [PARTY_CODE] [CHAR](10) NOT NULL,                
 [LONG_NAME] [VARCHAR](100) NULL,                
 [BANK_NAME] [VARCHAR](50) NOT NULL,                
 [L_ADDRESS1] [VARCHAR](40) NOT NULL,                
 [L_ADDRESS2] [VARCHAR](40) NULL,                
 [L_ADDRESS3] [VARCHAR](40) NULL,                
 [L_CITY] [VARCHAR](40) NULL,                
 [L_ZIP] [VARCHAR](10) NULL,                
 [RES_PHONE1] [VARCHAR](15) NULL,                
 [BRANCH_CD] [VARCHAR](10) NULL,                
 [FAMILY] [VARCHAR](10) NOT NULL,                
 [SUB_BROKER] [VARCHAR](10) NOT NULL,                
 [TRADER] [VARCHAR](20) NULL,                
 [CL_TYPE] [VARCHAR](3) NOT NULL,                
 [CLTDPID] [VARCHAR](20) NOT NULL                
)                
                
CREATE TABLE #LEDGERDATA (                
 [VTYP] [SMALLINT] NOT NULL,                
 [VNO] [VARCHAR](12) NOT NULL,                
 [EDT] [DATETIME] NULL,                
 [LNO] [INT] NOT NULL,                
 [ACNAME] [VARCHAR](100) NOT NULL,                
 [DRCR] [CHAR](1) NULL,                
 [VAMT] [MONEY] NULL,                
 [VDT] [DATETIME] NULL,                
 [VNO1] [VARCHAR](12) NULL,                
 [REFNO] [CHAR](12) NULL,                
 [BALAMT] [MONEY] NOT NULL,                
 [NODAYS] [INT] NULL,                
 [CDT] [DATETIME] NULL,                
 [CLTCODE] [VARCHAR](10) NOT NULL,                
 [BOOKTYPE] [CHAR](2) NOT NULL,                
 [ENTEREDBY] [VARCHAR](25) NULL,                
 [PDT] [DATETIME] NULL,                
 [CHECKEDBY] [VARCHAR](25) NULL,                
 [ACTNODAYS] [INT] NULL,                
 [NARRATION] [VARCHAR](234) NULL,                
 [SHORTDESC] [VARCHAR](35) NULL                
)                
-------------------------------------------------                
-- CREATING TEMPORARY TABLES                
-------------------------------------------------                
                                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                      
                   
/*GETTING LAST OPENING DATE */                                      
      IF UPPER(@SELECTBY) = 'VDT'                                      
      BEGIN                           SELECT                                 
                  @@OPENDATE =                                 
                  (                                 
                    SELECT                  
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11)                                 
                        FROM LEDGER WITH(NOLOCK)                                 
         WHERE VTYP = 18                                 
                              AND VDT < = @FDATE                                 
                  )                                 
      END                                      
      ELSE                                      
      BEGIN                                      
            SELECT                                 
                  @@OPENDATE =                                 
                  (                                 
                        SELECT                                 
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)                                 
                        FROM LEDGER WITH(NOLOCK)                                 
                        WHERE VTYP = 18                                 
                              AND EDT < = @FDATE                                 
                  )                                 
      END                                      
                                            
                                   
      /*GETTING OPENING BALANCE*/                                      
      IF @SELECTBY = 'VDT'                                      
      BEGIN                                      
            IF @@OPENDATE = @FDATE                                       
            BEGIN                                      
                  INSERT                                 
                  INTO #OPPBALANCE                                 
                  SELECT                                 
                        CLTCODE,                                 
                        OPPBAL = ISNULL(SUM(                                 
                        CASE                                 
                              WHEN UPPER(B.DRCR) = 'D'                                 
                              THEN B.VAMT                                 
                             ELSE -B.VAMT                                 
                        END                                
                        ), 0)                                 
                  FROM LEDGER B WITH(NOLOCK)                                 
                  WHERE B.CLTCODE > = @FCODE                                 
                        AND B.CLTCODE < = @TCODE                                 
                        AND B.VDT LIKE @FDATE + '%'                                 
                        AND VTYP = 18                                 
                  GROUP BY CLTCODE                                 
            END                                      
            ELSE                                      
            BEGIN                                      
                  INSERT                                 
                  INTO #OPPBALANCE                                 
                  SELECT                            
                        CLTCODE,                                 
                        OPPBAL = ISNULL(SUM(                                 
                        CASE                                 
                              WHEN UPPER(B.DRCR) = 'D'                                 
                       THEN B.VAMT                                 
                              ELSE -B.VAMT                                 
                        END                                
                        ), 0)                                 
                  FROM LEDGER B WITH(NOLOCK)                               
      WHERE B.CLTCODE > = @FCODE                 
                        AND B.CLTCODE < = @TCODE                                 
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'                                 
                        AND VDT < @FDATE                
               GROUP BY CLTCODE                                 
            END                                  END                                       
      ELSE                                      
      BEGIN                                       
            IF @@OPENDATE = @FDATE                                   
            BEGIN                                    
                  INSERT                                 
                  INTO #OPPBALANCE                                 
     SELECT                                 
                        CLTCODE,                                 
      OPBAL = SUM(OPBAL)                                 
            FROM                                 
                        (                                 
                              SELECT                                 
                                    CLTCODE,                                 
                                    OPBAL = ISNULL(SUM(                                 
                                    CASE                                 
                                          WHEN UPPER(DRCR) = 'D'                                 
                                          THEN VAMT                                 
                                          ELSE -VAMT                                 
                                    END                                
                                    ), 0)                                 
                              FROM LEDGER WITH(NOLOCK)                                 
                              WHERE CLTCODE = @FCODE                                 
                                    AND EDT LIKE @@OPENDATE + '%'                                 
                                    AND VTYP = 18                                 
                              GROUP BY CLTCODE                                 
                              UNION ALL                                 
                              SELECT                                 
                                    CLTCODE,                                 
                                    OPPBAL = ISNULL(SUM(                                 
                                    CASE                                 
                                          WHEN UPPER(B.DRCR) = 'C'                                 
                                          THEN B.VAMT                                 
                                          ELSE -B.VAMT                                 
                                    END                                
                                    ), 0)                                 
                              FROM LEDGER B WITH(NOLOCK)                                 
                              WHERE B.CLTCODE > = @FCODE                                 
                                    AND B.CLTCODE < = @TCODE                                 
                                    AND B.VDT < @@OPENDATE                                
                                    AND EDT >= @@OPENDATE                                 
                         GROUP BY CLTCODE                                 
                        )                                 
                        T                                 
                  GROUP BY CLTCODE           
            END                                    
            ELSE                                    
            BEGIN                                    
                  INSERT                           
                  INTO #OPPBALANCE                                 
                  SELECT                                 
                        CLTCODE,                    
                        OPBAL = SUM(OPBAL)                                 
                  FROM                                 
                        (                                 
                              SELECT                                 
                CLTCODE,                                 
                                    OPBAL = ISNULL(SUM(                                 
                       CASE                                 
                                          WHEN UPPER(DRCR) = 'D'                                 
                                          THEN VAMT                                 
                                          ELSE -VAMT                           
                                    END                                
    ), 0)                                
               FROM LEDGER WITH(NOLOCK)                               
                              WHERE CLTCODE = @FCODE                                 
                                    AND EDT LIKE @@OPENDATE + '%'                                 
                                    AND VTYP = 18                                 
                              GROUP BY CLTCODE                                 
                              UNION ALL                                 
                   SELECT                                 
               CLTCODE,                                 
                                    OPBAL = SUM(                                 
                                    CASE                                 
                                          WHEN UPPER(DRCR) = 'D'                                 
                                          THEN VAMT                                 
                                          ELSE -VAMT                               
                                    END                                
                                    )                                 
                              FROM LEDGER WITH(NOLOCK)                                 
                              WHERE CLTCODE = @FCODE                                 
                                    AND EDT > = @@OPENDATE + ' 00:00:00'                                 
                                    AND EDT < @FDATE                                 
                                    AND VTYP <> 18                                 
                              GROUP BY CLTCODE                                 
                              UNION ALL                                 
                              SELECT                                 
                                    CLTCODE,                                 
                                    OPPBAL = ISNULL(SUM(                                 
                                    CASE                                 
                                          WHEN UPPER(B.DRCR) = 'C'                                 
                                          THEN B.VAMT                                 
            ELSE -B.VAMT                                 
                                    END                                
                                    ), 0)                                 
                              FROM LEDGER B WITH(NOLOCK)                                 
                              WHERE B.CLTCODE > = @FCODE                                 
                                    AND B.CLTCODE < = @TCODE                                 
                                    AND B.VDT < @@OPENDATE                                 
                                    AND EDT >= @@OPENDATE                                 
                              GROUP BY CLTCODE                                 
                        )                                 
                        T                                 
                  GROUP BY CLTCODE                                 
            END                                    
      END        
                                            
                                      
                                      
                                      
      /*GETTING FIILTERED LEDGER*/                                      
      IF @SELECTBY = 'VDT'                           
      BEGIN                                      
            INSERT                                 
            INTO #LEDGERDATA                                 
            SELECT                                 
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                                 
                  ISNULL(V.SHORTDESC, '') SHORTDESC                                     FROM LEDGER L WITH(NOLOCK),                                 
                  VMAST V WITH(NOLOCK)                               
            WHERE VDT > = @FDATE + ' 00:00:00'                                 
                  AND L.VTYP = V.VTYPE                                 
                AND VDT < = @TDATE +' 23:59:59'                                 
                  AND CLTCODE > = @FCODE                                 
                  AND CLTCODE < = @TCODE                                 
      END                                       
      ELSE                                      
      BEGIN                                      
            INSERT                                 
            INTO #LEDGERDATA                                 
            SELECT                                 
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,                                 
                  ISNULL(V.SHORTDESC, '') SHORTDESC                                 
            FROM LEDGER L WITH(NOLOCK),                                 
                  VMAST V WITH(NOLOCK)                                 
            WHERE EDT > = @FDATE + ' 00:00:00'                   
                  AND L.VTYP = V.VTYPE                                 
                  AND EDT < = @TDATE +' 23:59:59'                                 
                  AND CLTCODE > = @FCODE                                 
                  AND CLTCODE < = @TCODE                                 
      END                                      
                                      
                                
                                
/*GETTING CLIENT LIST*/                 
 INSERT INTO #LEDGERCLIENTS                                     
      SELECT                                 
            C2.PARTY_CODE,                                
            C1.LONG_NAME,                                
            BANK_NAME = '',                                 
            L_ADDRESS1,                                 
            L_ADDRESS2,                                 
            L_ADDRESS3,                                 
            L_CITY,                                 
            L_ZIP,                                 
            RES_PHONE1,                                 
            C1.BRANCH_CD,                                 
            FAMILY,                                 
            C1.SUB_BROKER,                                 
            TRADER,                                 
            CL_TYPE = '',                                 
            CLTDPID = ''      
      FROM NCDX.DBO.CLIENT1 C1 WITH(NOLOCK),                                 
        NCDX.DBO.CLIENT2 C2 WITH(NOLOCK)                                 
      WHERE C1.CL_CODE = C2.CL_CODE                                 
            AND C1.BRANCH_CD LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'BRANCH'                                 
                  THEN @STATUSNAME                                 
                  ELSE '%'                                 
            END                                
            )                                 
            AND SUB_BROKER LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'SUB_BROKER'                                 
                  THEN @STATUSNAME                         
                  ELSE '%'                                 
            END                                
            )                                 
     AND SUB_BROKER LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'SUBBROKER'                                 
                  THEN @STATUSNAME                
                  ELSE '%'                                 
 END                                
            )                                 
            AND TRADER LIKE (                               
            CASE                                 
                  WHEN @STATUSID = 'TRADER'                                 
                  THEN @STATUSNAME                                 
                  ELSE '%'                                 
            END                                
            )                                 
            AND AREA LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'AREA'                                 
                  THEN @STATUSNAME                                 
                  ELSE '%'                    
            END                                
            )                           
            AND REGION LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'REGION'                                 
                  THEN @STATUSNAME                                 
                  ELSE '%'                                 
            END                                
            )                                
            AND C1.FAMILY LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'FAMILY'                                 
                  THEN @STATUSNAME                                 
                  ELSE '%'                                 
            END                                
  )                                 
            AND C2.PARTY_CODE LIKE (                                
            CASE                                 
                  WHEN @STATUSID = 'CLIENT'                                 
                  THEN @STATUSNAME                                 
                  ELSE '%'                                 
            END                                
         )                                 
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                                 
            AND C2.PARTY_CODE > = @FCODE                                 
            AND C2.PARTY_CODE < = @TCODE                                 
                                
                                
      CREATE TABLE [#TMPLEDGER] (                                
       [BOOKTYPE] [CHAR] (2)  NULL ,                                
       [VOUDT] [DATETIME] NULL ,                                
       [EFFDT] [DATETIME] NULL ,                                
       [SHORTDESC] [VARCHAR] (35)  NULL ,                                
       [DRAMT] [MONEY] NULL ,                     
       [CRAMT] [MONEY] NULL ,                                
       [VNO] [VARCHAR] (12)  NULL ,                                
       [DDNO] [VARCHAR] (20)  NULL ,                                
       [NARRATION] [VARCHAR] (234)  NULL ,                                
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,                                
       [VTYP] [SMALLINT] NULL ,                                
       [VDT] [VARCHAR] (30)  NULL ,                                
       [EDT] [VARCHAR] (30)  NULL ,                                
       [ACNAME] [VARCHAR] (100)  NULL ,                                
       [OPBAL] [MONEY] NULL ,                                
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,                                
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,                                
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,                                
       [L_CITY] [VARCHAR] (40)  NULL ,                                
       [L_ZIP] [VARCHAR] (10)  NULL ,                                
       [RES_PHONE1] [VARCHAR] (15)  NULL ,                                
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,                                
       [CROSAC] [VARCHAR] (10)  NULL ,                                
       [EDIFF] [INT] NULL ,                                
       [FAMILY] [VARCHAR] (10)  NOT NULL ,                                
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,                                
       [TRADER] [VARCHAR] (20)  NOT NULL ,                                
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,                                
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,                                
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,                               
     [LNO] [INT] NULL,                              
       [PDT] [DATETIME] NULL                              
      ) ON [PRIMARY]                                
                                
                                      
/*GETTING LDDGER ENTRIES*/                                      
      INSERT                                 
            INTO #TMPLEDGER                                 
      SELECT                                 
            L.BOOKTYPE,                                 
 VOUDT = L.VDT,                                 
            EFFDT = L.EDT,                                 
            L.SHORTDESC,                                 
            DRAMT = (                                
            CASE                                 
                  WHEN UPPER(L.DRCR) = 'D'                                 
                  THEN L.VAMT                                 
                  ELSE 0                                 
            END                                
       ),                                 
            CRAMT = (                                
            CASE                                 
                  WHEN UPPER(L.DRCR) = 'C'                                 
                  THEN L.VAMT                                 
                  ELSE 0                                 
            END                                
            ),                                 
            L.VNO,                                 
            DDNO = SPACE(15),                                 
            L.NARRATION,                                 
            C.PARTY_CODE CLTCODE,                                 
            L.VTYP,                                 
            CONVERT(VARCHAR, L.VDT, 103) VDT,                                 
            CONVERT(VARCHAR, L.EDT, 103) EDT,                                 
--            L.ACNAME ,                                 
            C.LONG_NAME,                                
            OPBAL = VAMT,                              
  C.L_ADDRESS1,                                 
            C.L_ADDRESS2,                                 
            C.L_ADDRESS3,        
            C.L_CITY,                                 
            C.L_ZIP,                                 
            C.RES_PHONE1,                                 
            C.BRANCH_CD,                                 
            L.CLTCODE CROSAC ,                                 
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),                                 
            C.FAMILY,                                 
            C.SUB_BROKER,                                 
            C.TRADER,                          
            C.CL_TYPE,                                 
            C.BANK_NAME,                                 
            C.CLTDPID,                                 
            L.LNO,                              
  L.PDT                                 
      FROM #LEDGERDATA L WITH(NOLOCK)                                 
 RIGHT OUTER JOIN                                 
            #LEDGERCLIENTS C WITH(NOLOCK)                                 
            ON                                 
            (                                
                  L.CLTCODE = C.PARTY_CODE                                
            )                                 
                                
                                
                                      
/*UPDATING OPENING BLANACE*/                                      
      UPDATE                                 
            #TMPLEDGER                                 
            SET OPBAL = 0                                 
                                
      UPDATE                                 
            #TMPLEDGER                                 
            SET OPBAL = T.OPPBAL                                 
      FROM #TMPLEDGER L WITH(NOLOCK),                                 
            #OPPBALANCE T WITH(NOLOCK)                             
      WHERE L.CLTCODE = T.CLTCODE                                 
                                      
                                
                                
/*UPDATING CHEQUE NUMBER*/                                      
      UPDATE                                 
            #TMPLEDGER                                 
            SET DDNO = L1.DDNO                                 
      FROM LEDGER1 L1 WITH(NOLOCK)                                 
      WHERE L1.VNO = #TMPLEDGER.VNO                                 
            AND L1.VTYP = #TMPLEDGER.VTYP                               
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE                                 
            AND L1.LNO = #TMPLEDGER.LNO                                 
                                      
                                
                                
/*UPDATING CROSS ACCOUNT CODE*/                                      
      UPDATE                                 
       #TMPLEDGER                                 
            SET #TMPLEDGER.CROSAC = B.CLTCODE                                 
      FROM LEDGER B WITH(NOLOCK),                                 
            ACMAST V WITH(NOLOCK)                                 
      WHERE B.CLTCODE = V.CLTCODE                                 
            AND V.ACCAT = 2                                 
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE                                 
            AND #TMPLEDGER.VNO = B.VNO                                 
            AND #TMPLEDGER.VTYP = B.VTYP                                 
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')                                 
                               
                     
                                
/*UPDATING BANK NAME*/                                                     
      UPDATE                                 
            #TMPLEDGER                                 
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME                                 
      FROM NCDX.DBO.POBANK B WITH(NOLOCK)                              
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))                                 
                                
                                      
      IF @STRORDER = 'ACCODE'                                      
      BEGIN                                      
            IF @SELECTBY = 'VDT'                                      
            BEGIN                                       
                  SELECT                                 
                        L.*                                 
                  FROM #TMPLEDGER L WITH(NOLOCK),                                 
                        ACMAST A WITH(NOLOCK)                                 
                  WHERE L.CLTCODE = A.CLTCODE                                 
                        AND ACCAT IN ('4', '104')                                 
          AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                                
   ORDER BY L.CLTCODE,                              
                        VOUDT, PDT                              
            END                                      
            ELSE                                      
            BEGIN                                      
                  SELECT                                 
                        L.*                                 
                  FROM #TMPLEDGER L WITH(NOLOCK),                                 
                        ACMAST A WITH(NOLOCK)                                 
                  WHERE L.CLTCODE = A.CLTCODE                                 
                        AND ACCAT IN ('4', '104')                                 
                        AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,                                
                        EFFDT, PDT                              
            END                                      
      END                                      
      ELSE                                      
      BEGIN                              
            IF @SELECTBY = 'VDT'                                      
            BEGIN                                       
                  SELECT                                 
                        L.*                                 
                  FROM #TMPLEDGER L WITH(NOLOCK),                                 
                        ACMAST A WITH(NOLOCK)                                 
                  WHERE L.CLTCODE = A.CLTCODE                                 
                        AND ACCAT IN ('4', '104')                   
         AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                            
                  ORDER BY L.ACNAME,                               
                        VOUDT, PDT                                 
            END                                      
            ELSE              
            BEGIN                                      
                  SELECT                                 
                        L.*                                 
                  FROM #TMPLEDGER L WITH(NOLOCK),                                 
                        ACMAST A WITH(NOLOCK)                                 
                  WHERE L.CLTCODE = A.CLTCODE                                 
                        AND ACCAT IN ('4', '104')                  
                        AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                                 
                  ORDER BY L.ACNAME,                                
                        EFFDT, PDT                              
            END                                      
      END                                      
                                      
/*  ------------------------------   END OF THE PROC  -------------------------------------*/                                      
                                      
-------------------------------------------------                
-- DESTROYING TEMPORARY TABLE                
-------------------------------------------------                
TRUNCATE TABLE #OPPBALANCE                                      
TRUNCATE TABLE #LEDGERCLIENTS                
TRUNCATE TABLE #LEDGERDATA                
                
DROP TABLE #OPPBALANCE                
DROP TABLE #LEDGERCLIENTS                                  
DROP TABLE #LEDGERDATA                                
-------------------------------------------------                
-- DESTROYING TEMPORARY TABLE                
-------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE
-- --------------------------------------------------
 CREATE PROCEDURE RPT_ACC_TRIALBALANCE      
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */      
      
AS      
  
DECLARE    
@@COSTCODE AS VARCHAR(3)  
  
      
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2      
    
    
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN  
  IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
         GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
         GROUP BY L.CLTCODE  
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'      
         AND EDT < @CURRYRSTDATE        
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
        GROUP BY L.CLTCODE      
       END      
      ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
        GROUP BY L.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
   
  
/*  -- FOR BRANCH SELECTION --  */    
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN  
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )    
 IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
   AND COSTCODE = @@COSTCODE  
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
     GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE  
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'  
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
       END      
     ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
/* ---------------------------- */    
  
  
IF @FLAG = 'CODEWISE'      
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE    
 END    
ELSE    
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE_SB
-- --------------------------------------------------
 CREATE PROCEDURE RPT_ACC_TRIALBALANCE_SB        
    
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */        
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */        
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */        
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */        
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */        
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */        
@OPENENTRYFLAG INT,        
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */        
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */        
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */        
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */        
        
AS        
    
DECLARE      
@@COSTCODE AS VARCHAR(3)    
    
        
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2        
      
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2        
      
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2        
      
      
IF UPPER(@STATUSID) = 'BROKER'        
BEGIN    
  IF @BALANCE='NORMAL'        
    IF @SORTBYDATE = 'VDT'        
     BEGIN           
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,      
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)        
      FROM LEDGER_SB1 L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'          
      GROUP BY L.CLTCODE        
     END        
    ELSE       
      BEGIN        
       INSERT INTO #TEMPLEDGER        
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0         
       FROM          
        (           
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)      
         FROM LEDGER_SB1 L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18          
         GROUP BY L.CLTCODE          
      
         UNION ALL          
      
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)       
         FROM LEDGER_SB1  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18          
         GROUP BY L.CLTCODE    
      
         UNION ALL          
      
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)      
         FROM LEDGER_SB1 L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'        
         AND EDT < @CURRYRSTDATE          
         GROUP BY L.CLTCODE           
        ) T          
        GROUP BY CLTCODE           
      END        
   ELSE      
      IF @SORTBYDATE = 'VDT'        
       BEGIN        
        INSERT INTO #TEMPLEDGER        
        SELECT L.CLTCODE ,        
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),         
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),         
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)        
        FROM LEDGER_SB1 L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'         
        GROUP BY L.CLTCODE        
       END        
      ELSE        
       BEGIN        
        INSERT INTO #TEMPLEDGER        
        SELECT L.CLTCODE ,        
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),         
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),         
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)        
        FROM LEDGER_SB1 L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'         
        GROUP BY L.CLTCODE        
      END         
      
IF  @VIEWOPTION = 'PARTYWISE'         
 BEGIN        
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT       
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)      
 END        
ELSE        
 IF @VIEWOPTION = 'GL'        
  BEGIN        
     INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT       
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)      
       
  END        
 ELSE        
  BEGIN        
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT       
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)      
  END       
      
IF @VIEWOPTION = 'GL'        
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL      
     
   SELECT D,SUM(DRTOT) DRTOT,SUM(CRTOT)CRTOT,SUM(AMOUNT)AMOUNT,'CLIENT BALANCES',' ' ,4  FROM   
    (SELECT 'ZZZZZZZZZZ' D,SUM(DRTOT) DRTOT,SUM(CRTOT) CRTOT,SUM(AMOUNT)AMOUNT  
     FROM #TEMPLEDGER L, ACMAST A   
    WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4       
    UNION ALL  
      
    SELECT 'ZZZZZZZZZZ' D,SUM(DRTOT) DRTOT,SUM(CRTOT) CRTOT,SUM(AMOUNT)AMOUNT  
     FROM #TEMPLEDGER L      
    WHERE L.CLTCODE ='SDrCrBal')A  
    GROUP BY D  
 END      
END     
     
  
    
    
IF @FLAG = 'CODEWISE'        
 BEGIN      
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE      
 END      
ELSE      
 BEGIN      
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accallpartyledvoucherdisp
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 01/19/2002 12:15:11 ******/  
/****** Object:  Stored Procedure dbo.rpt_accallpartyledvoucherdisp    Script Date: 01/04/1980 5:06:24 AM ******/  
/* report : Allpartyledger   
    filename :  voucherdisp.asp  
*/  
/* displays details of a voucher for a party for a date */  
  
CREATE Procedure rpt_accallpartyledvoucherdisp  
@vtyp smallint ,  
@vno varchar (12),  
@vdt varchar(12) ,  
@booktype varchar(2),  
@branch varchar(10),  
@cltcode varchar(10)  
  
as  
if @branch = 'full' or @branch= '' or @branch = '%'  
begin  
 select  vamt ,l.vtyp , l.vno , l.vdt , l.drcr , cltcode,acname,  l.lno ,drcrflag = (case when upper(l.drcr)='D' then 'Dr' else 'Cr' end) ,   
 nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,   
 dddt  =  convert(varchar,dddt,103)    
 from ledger l left outer join ledger1 l1 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno  
 where l.vtyp=@vtyp  
and l.vno= @vno    
 and l.vdt like  ltrim(vdt) + '%'  
 and l.BookType = @booktype  
 order by l.drcr desc , l.lno   
end  
else  
begin  
 select  vamt=l2.camt ,l.vtyp , l2.vno , vdt , l2.drcr , l2.cltcode, a.acname, l2.lno ,   
 drcrflag = (case when upper(l2.drcr)='D' then 'Dr' else 'Cr' end),   
 nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,   
 dddt  =  convert(varchar,dddt,103)    
 from ledger l left outer join ledger1 l1 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno,  
 ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode  
 where l.vtyp=@vtyp  
 and l.vno= @vno    
 and l.vdt like  ltrim(vdt) + '%'  
 and l.BookType = @booktype  
 and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno  
        and costcode = (select costcode from costmast where costname = rtrim(@branch))  
 order by l2.drcr desc , l2.lno   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_accchkpathsegbalsign
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 01/11/2003 3:46:55 PM ******/
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_accchkpathsegbalsign    Script Date: 11/28/2001 12:23:46 PM ******/
CREATE procedure rpt_accchkpathsegbalsign
@sharedb varchar(15)
as
select conpath ,segment ,balsign from accountncdx.dbo.owner 
where sharedb = @sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acccostsummary
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_acccostsummary    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_acccostsummary    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_acccostsummary    Script Date: 11/28/2001 12:23:46 PM ******/
/*inserts catcodewise,coscenterwise total debit and credit and balance till a particular date */
CREATE PROCEDURE rpt_acccostsummary
@vdt datetime
AS
select catcode,costcode,costname , Amount = Sum(DrAmt)-Sum(CrAmt),
dramt = Sum(DrAmt),  Cramt = Sum(CrAmt),category,grpcode
From rpt_acccostwisedrcr   l where  vdt <= @vdt + ' 23:59:59'  
group by catcode,category,l.costcode,l.costname,grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acccostsumnextcostdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_acccostsumnextcostdrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_acccostsumnextcostdrcr    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_acccostsumnextcostdrcr    Script Date: 11/28/2001 12:23:46 PM ******/
/* cost center summary report  */
/*finds debit and credit of a cost centers below a particular level */
CREATE PROCEDURE rpt_acccostsumnextcostdrcr
@catcode smallint ,
@grpcode varchar(20),
@vdt datetime
 AS
select costname,catcode,grpcode , dramt=isnull(sum(dramt),0),cramt=isnull(sum(cramt),0)
from rpt_acccostwisedrcr 
where catcode= @catcode 
and grpcode like ltrim(@grpcode) 
and vdt <= @vdt + ' 23:59:59'
group by catcode, grpcode , costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acccostsumnextcostdrcr1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_acccostsumnextcostdrcr1    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_acccostsumnextcostdrcr1    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_acccostsumnextcostdrcr1    Script Date: 11/28/2001 12:23:46 PM ******/
/* cost center summary report  */
/*finds debit and credit of all cost centers below a particular level */
CREATE PROCEDURE rpt_acccostsumnextcostdrcr1
@catcode smallint ,
@grpcode varchar(20),
@vdt datetime
 AS
select catcode, dramt=isnull(sum(dramt),0),cramt=isnull(sum(cramt),0)
from rpt_acccostwisedrcr 
where catcode= @catcode 
and grpcode like ltrim(@grpcode)  + '%'
and vdt <= @vdt + ' 23:59:59'
group by catcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_AccodeList
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 04/13/2003 12:09:05 PM ******/
---------------------------------------------------------------------------------------------------------
--		PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------

CREATE PROCEDURE rpt_AccodeList
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT varchar(3),		--	Account Category
	@LOOKFORNAME VARCHAR(25)	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
AS

DECLARE
@strSQL VarChar(2500),
@@Inaccat varchar(3)

select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))

--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */

--BROKER LOGIN
If  (@STATUSID="BROKER" or @STATUSID='')
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT cltcode, acname, branchcode "
	Set @strSQL = @strSQL + "FROM acmast "
	Set @strSQL = @strSQL + "WHERE "
        if len(rtrim(@WHATTOLOOKFOR)) <> 0 and len(rtrim(@LOOKFORNAME)) <> 0 
           begin
	  	Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' and acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
	   end
        else
           if len(rtrim(@LOOKFORNAME)) <> 0 
               begin
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
               end
           else
               begin
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @WHATTOLOOKFOR + "') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
               end
        if rtrim(@accat) = '3'
           begin
		select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))" 
           end
        else
           begin
		select @strSQL = @strSQL + " )" 
           end

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS	
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + " AND "
		Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + " AND "
			Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End

	Set @strSQL = @strSQL + "ORDER BY cltcode, branchcode "
End

--BRANCH LOGIN
IF @STATUSID="BRANCH"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	(branchcode LIKE '" + @STATUSNAME + "' OR branchcode = 'ALL') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
        if rtrim(@accat) = '3'
           begin
		select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))" 
           end
        else
           begin
		select @strSQL = @strSQL + " )" 
           end

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End

--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, " 
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2, " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "	ncdx.dbo.subbrokers s " -- msajag.dbo.subbrokers
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.sub_broker = s.sub_broker AND "
	Set @strSQL = @strSQL + "	c1.sub_broker LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
End

--TRADER LOGIN
If @STATUSID="TRADER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.trader "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2, " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "	ncdx.dbo.branches s " -- msajag.dbo.branches
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.trader = s.branch_cd AND "
	Set @strSQL = @strSQL + "	c1.trader LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.trader "
End

--FAMILY LOGIN
If @STATUSID="FAMILY"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.family "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2 " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.family LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.family "
End

If @STATUSID="CLIENT"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	ncdx.dbo.client1 c1, " -- msajag.dbo.client1
	Set @strSQL = @strSQL + "	ncdx.dbo.client2 c2 " -- msajag.dbo.client2
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @STATUSNAME + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode "
End

	Set @strSQL = @strSQL + "	OPTION  (FAST 10)"

Print @strSQL
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_acname    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_acname    Script Date: 02/04/2002 9:59:42 PM ******/
/****** Object:  Stored Procedure dbo.rpt_acname    Script Date: 01/18/2002 1:38:09 PM ******/
/****** Object:  Stored Procedure dbo.rpt_acname    Script Date: 12/26/2001 1:26:52 PM ******/
/****** Object:  Stored Procedure dbo.rpt_acname    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : singlparty.asp
   report : allpartyledger 
   file : cumledger.asp
*/
/* displays name of a client from ledger */
CREATE PROCEDURE rpt_acname 
@cltcode varchar(10)
as
select acname from ledger where cltcode=@cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ageing
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_ageing    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_ageing    Script Date: 02/04/2002 9:59:42 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ageing    Script Date: 01/18/2002 1:38:09 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ageing    Script Date: 12/26/2001 1:26:53 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ageing    Script Date: 20-Mar-01 11:43:34 PM ******/
/*Changes made by sheetal on 24/01/2001 to refno and use vtyp,vno,lno,drcr instead */
/* report : ageing report 
   file : ageingreport.asp
*/
/* shows last balances of a client  as on a particular date */
CREATE PROCEDURE rpt_ageing
@statusid varchar(15),
@statusname varchar(25),
@vdt varchar(12)
AS
	if @statusid='broker'
	begin
		select vdt=convert(varchar,vdt,101), c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		order by l1.acname,vdt,vtyp,vno,vno1,lno,drcr
		
		/*select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		order by l1.acname,vdt,vtyp,vno1,refno */
	end
	if @statusid='branch'
	begin
		select vdt=convert(varchar,vdt,101), c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 , ncdx.dbo.branches b
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode and
		b.branch_cd=@statusname and b.short_name=c1.trader
		order by l1.acname,vdt,vtyp,vno,vno1,lno,drcr
		/*select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 , ncdx.dbo.branches b
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode and
		b.branch_cd=@statusname and b.short_name=c1.trader
		order by l1.acname,vdt,vtyp,vno1,refno */
	end
	if @statusid='subbroker'
	begin
		select vdt=convert(varchar,vdt,101), c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 , ncdx.dbo.subbrokers sb
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		and sb.sub_broker=c1.sub_broker
		and sb.sub_broker=@statusname
		order by l1.acname,vdt,vtyp,vno,vno1,lno,drcr
		/*select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 , ncdx.dbo.subbrokers sb
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		and sb.sub_broker=c1.sub_broker
		and sb.sub_broker=@statusname
		order by l1.acname,vdt,vtyp,vno1,refno*/ 
	end
	if @statusid='trader'
	begin
		select vdt=convert(varchar,vdt,101), c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt + ' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		and c1.trader=@statusname
		order by l1.acname,vdt,vtyp,vno,vno1,lno,drcr
		/*select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt + ' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		and c1.trader=@statusname
		order by l1.acname,vdt,vtyp,vno1,refno */
	end
	if @statusid='client'
	begin
		select vdt=convert(varchar,vdt,101), c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		and l1.cltcode=@statusname
		order by l1.acname,vdt,vtyp,vno,vno1,lno,drcr
		/*select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
		from ledger l1, acmast a , ncdx.dbo.client1 c1, ncdx.dbo.client2 c2 
		where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
		and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
		and l1.cltcode=@statusname
		order by l1.acname,vdt,vtyp,vno1,refno */
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_balsign
-- --------------------------------------------------
CREATE PROCEDURE  rpt_balsign

--@conpath varchar(50)

AS

select distinct balsign from ACCOUNTNCDX.dbo.owner
--where conpath=@conpath

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bankbookprinting
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 01/11/2003 3:46:56 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 01/18/2002 1:38:09 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 11/28/2001 12:23:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 08/29/2001 6:51:58 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bankbookprinting    Script Date: 08/13/2001 6:16:47 AM ******/
/***************************************************************************************************
This is stored procedure used to get bankbook printing for perticular branches
-------------------------------------------------------------------------------
CHANGED BY MANISH RUNWAL ON 29/1/2002 
Depending on the @AllFlag value 
If @Allflag = 0  then show bank transaction for all the branches
If @Allflag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )
***************************************************************************************************/
CREATE PROCEDURE rpt_bankbookprinting
@cltcode as varchar(10),
@fromdate as datetime,
@todate as datetime,
@vdtedtflag as integer,
@AllFlag as integer,
@Costcode as integer
AS
IF @vdtedtflag = 0
BEGIN
	/*If any one select to show all records */
	if @allFlag = 0
	begin
	 	SELECT Vdt = convert(varchar,l.vdt,103), cltcode = isnull(a.cltcode,''), longname = isnull(a.longname,''),L.VNO,l.vtyp,voudt=l.vdt,
			ddno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno) is not null
				then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno)
				else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype )
				end),''),
	         	Debit = (Case When l.DRCR = 'C' Then  Vamt  Else  0 End),
	           	Credit = (Case When l.DRCR='D' Then  Vamt   Else  0 End), 
			balamt= (select sum(balamt) from ledger l1 where cltcode= @cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND l3.naratno=0),''),
			LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND  l3.naratno = l.lno ) ,'') /*,Year(L.VDT),Month(L.VDT),Day(L.VDt)	*/
		FROM LEDGER L,acmast a
	           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO) 
	           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode )
	           	and l.vdt >= @fromdate + ' 00:00:00'
		 	and l.vdt <= @todate + ' 23:59:59'
	           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
	           	ORDER BY VOUDT /*,L.VTYP,L.VNO*/
	end 
	/*If branch = perticular branch */
	IF @allflag = 1
	begin
		SELECT Vdt = convert(varchar,l.vdt,103), l.cltcode /* = isnull(a.cltcode,'')*/ , longname = isnull(a.longname,''),L.VNO,l.vtyp,voudt=l.vdt,
			ddno= isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno) is not null
				then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno)
				else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype )
				end),''),
	         	Debit = (Case When l.DRCR = 'C' Then  Vamt  Else  0 End),
	           	Credit = (Case When l.DRCR='D' Then  Vamt   Else  0 End), 
			balamt= (select sum(balamt) from ledger l1 where cltcode= @cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND l3.naratno=0),''),
			LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND  l3.naratno = l.lno ) ,'') /*,Year(L.VDT),Month(L.VDT),Day(L.VDt)	*/
		FROM LEDGER L,acmast a
	           	WHERE L.vno IN (SELECT distinct ledger.Vno FROM  LEDGER, ledger2 l2 WHERE l2.CLTCODE = '02057' AND ledger.VNO = L2.VNO and ledger.vtyp = l2.vtype and ledger.booktype = l2.booktype and costcode = @costcode)
			and L.VTYP IN ( SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO 
			and vtyp in (select distinct vtype from ledger2 where costcode = @costcode ))
	           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode 
			and booktype in (select distinct booktype from ledger2 where costcode = @costcode) ) 
	           	and l.vdt >= @fromdate + ' 00:00:00'
		 	and l.vdt <= @todate + ' 23:59:59'
	           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
	           	ORDER BY VOUDT /*,L.VTYP,L.VNO*/
	end 
END   	
ELSE IF @vdtedtflag = 1
BEGIN
	/*If any one select to show all records */
	if @allflag = 0 
	begin 
		SELECT Vdt = convert(varchar,l.vdt,103), Edt = convert(varchar,l.edt,103), cltcode = isnull(a.cltcode,''), longname = isnull(a.longname,''),L.VNO,l.vtyp,effdt=l.edt,
			ddno = isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno) is not null
				then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno)
				else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype )
				end),''),
			Debit = (Case When l.DRCR = 'C' Then  Vamt  Else  0 End),
			Credit = (Case When l.DRCR='D' Then  Vamt   Else  0 End), 
			balamt= (select sum(balamt) from ledger l1 where cltcode= @cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
			CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND l3.naratno=0),''),
			LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND  l3.naratno = l.lno ) ,'')/*,Year(L.VDT),Month(L.VDT),Day(L.VDt)	*/
		FROM LEDGER L,acmast a
			WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
			AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode ) 
			and l.edt >= @fromdate + ' 00:00:00'
			and l.edt <= @todate + ' 23:59:59'
			AND l.VTYP <> 18 and a.cltcode=l.cltcode 
			ORDER BY  EFFDT/*,L.VTYP,L.VNO*/
	end 
	/*If branch = perticular branch */
	else if @allflag = 1
	begin
		SELECT Vdt = convert(varchar,l.vdt,103), Edt = convert(varchar,l.edt,103), l.cltcode /* = isnull(a.cltcode,'')*/ , longname = isnull(a.longname,''),L.VNO,l.vtyp,effdt=l.edt,
			ddno = isnull((case when (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno) is not null
				then (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype and l1.lno = l.lno)
				else (select ddno from ledger1 l1 where l1.vno=l.vno and l1.vtyp=l.vtyp and l1.booktype=l.booktype )
				end),''),
			Debit = (Case When l.DRCR = 'C' Then  Vamt  Else  0 End),
			Credit = (Case When l.DRCR='D' Then  Vamt   Else  0 End), 
			balamt= (select sum(balamt) from ledger l1 where cltcode= @cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp ),
			CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND l3.naratno=0),''),
			LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype=l3.booktype AND  l3.naratno = l.lno ) ,'')/*,Year(L.VDT),Month(L.VDT),Day(L.VDt)	*/
		FROM LEDGER L,acmast a
			WHERE L.vno IN (SELECT distinct ledger.Vno FROM  LEDGER, ledger2 l2 WHERE l2.CLTCODE = '02057' AND ledger.VNO = L2.VNO and ledger.vtyp = l2.vtype and ledger.booktype = l2.booktype and costcode = @costcode)
			and L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO 
			and vtyp in (select distinct vtyp from ledger2 where costcode = @costcode))
			AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode 
			and booktype in (select distinct booktype from ledger2 where costcode = @costcode)) 
			and l.edt >= @fromdate + ' 00:00:00'
			and l.edt <= @todate + ' 23:59:59'
			AND l.VTYP <> 18 and a.cltcode=l.cltcode 
			ORDER BY  EFFDT/*,L.VTYP,L.VNO*/
	end 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bdrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bdrcr    Script Date: 02/04/2002 9:59:42 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bdrcr    Script Date: 01/18/2002 1:38:09 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bdrcr    Script Date: 12/26/2001 1:26:53 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bdrcr    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : branchacc
   file : branchturn.asp
*/
CREATE PROCEDURE rpt_bdrcr
@statusid  varchar(15),
@statusname varchar(25)
AS 
	if @statusid='broker' 
	begin
		select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
		- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.branches b
		where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
		group by  b.branch_cd,l.Cltcode
		ORDER BY b.branch_cd
	end 
	
	if @statusid='branch' 
	begin
		select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
		- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.branches b
		where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@statusname
		group by  b.branch_cd,l.Cltcode
		ORDER BY b.branch_cd
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_billreport
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 04/16/2002 11:19:33 AM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 01/29/2002 10:53:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 12/26/2001 1:23:15 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 04/27/2001 4:32:33 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 3/17/01 9:55:55 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 3/21/01 12:50:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 20-Mar-01 11:38:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billreport    Script Date: 12/27/00 8:58:53 PM ******/
/* report : bills report
   file : billreport.asp */
/* displays bill for a particular  settlement  type and number for a client or clients*/
/* changed by  mousami on 10/02/2001 added family login */
/* changed by mousami on 12/02/2001 added service_chrg column in select */
/*changed by mosami on 07/03/2001 added  h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax columns */
CREATE PROCEDURE rpt_billreport
@statusid varchar(15),
@statusname varchar(25),
@partycode varchar(10),
@partyname varchar(21),
@settno varchar(7),
@settype varchar(3),
@billno varchar(10)
AS
if @statusid = 'broker' 
begin
if ( select Count(sett_no) from settlement where sett_no =@settno and sett_type =@settype ) > 0 
begin
select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
from Settlement h,client1 c1,client2 c2,sett_mst st 
where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
and tradeqty > 0 
order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
else
begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
 h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from history h,client1 c1,client2 c2,sett_mst st 
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
end
if @statusid = 'branch' 
begin
if ( select Count(sett_no) from settlement where sett_no =@settno and sett_type =@settype ) > 0 
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from Settlement h,client1 c1,client2 c2,sett_mst st , branches b
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
  and b.short_name=c1.trader and b.branch_cd=@statusname and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
 end
else
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
 h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from history h,client1 c1,client2 c2,sett_mst st , branches b
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
  and b.short_name=c1.trader and b.branch_cd=@statusname and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
end
if @statusid = 'trader' 
begin
if ( select Count(sett_no) from settlement where sett_no =@settno and sett_type =@settype ) > 0 
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from Settlement h,client1 c1,client2 c2,sett_mst st 
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%'  and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
 end
else
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
 h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from history h,client1 c1,client2 c2,sett_mst st 
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%'  and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
end 
if @statusid = 'subbroker' 
begin
if ( select Count(sett_no) from settlement where sett_no =@settno and sett_type =@settype ) > 0 
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from Settlement h,client1 c1,client2 c2,sett_mst st , subbrokers sb
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
 and sb.sub_broker=@statusname and sb.sub_broker=c1.sub_broker and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
 end
else
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax 
 from history h,client1 c1,client2 c2,sett_mst st  , subbrokers sb
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
 and sb.sub_broker=@statusname and sb.sub_broker=c1.sub_broker and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
end 
if @statusid = 'client'
begin
if ( select Count(sett_no) from settlement where sett_no =@settno and sett_type =@settype ) > 0 
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from Settlement h,client1 c1,client2 c2,sett_mst st 
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code =@statusname and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%'  and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
 end
else
 begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from history h,client1 c1,client2 c2,sett_mst st 
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code =@statusname and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%'  and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
end 
if @statusid = 'family' 
begin
if ( select Count(sett_no) from settlement where sett_no =@settno and sett_type =@settype ) > 0 
begin
select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
from Settlement h,client1 c1,client2 c2,sett_mst st 
where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
and c1.family=@statusname and tradeqty > 0 
order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
else
begin
 select h.BillNo,h.Party_Code,c1.long_name,h.Scrip_Cd ,h.Tradeqty,h.Sauda_date,h.Sell_buy ,
 h.Brokapplied,h.sett_no,h.NBrokApp , h. NetRate,h.sett_type, c1.L_Address1,c1.L_Address2,c1.L_Address3 ,
 c1.L_city,c1.L_Zip,c1.Res_Phone1,c1.Off_Phone1,h.NSerTax,st.start_date,st.end_date,service_chrg,
h.sebi_tax, h.other_chrg , h.Broker_chrg,h. Ins_chrg ,h. turn_tax
 from history h,client1 c1,client2 c2,sett_mst st 
 where h.sett_no = st.sett_no and h.sett_type = st.sett_type and c1.cl_code=c2.cl_code and
 c2.party_code=h.party_code and h.party_code like ltrim(@partycode)+'%' and c1.short_name like  ltrim(@partyname)+'%' and
 h.sett_no like  ltrim(@settno)+'%' and h.sett_type like  ltrim(@settype)+'%' and h.BillNo like  ltrim(@billno)+'%' 
and c1.family=@statusname and tradeqty > 0 
 order by h.sett_no,h.sett_type,h.Party_Code,c1.short_name,h.Scrip_Cd,h.sell_buy 
end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_billwisesertax
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_billwisesertax    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_billwisesertax    Script Date: 02/04/2002 9:59:42 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billwisesertax    Script Date: 01/18/2002 1:38:09 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billwisesertax    Script Date: 12/26/2001 1:26:53 PM ******/
/****** Object:  Stored Procedure dbo.rpt_billwisesertax    Script Date: 20-Mar-01 11:43:34 PM ******/
/* PRINTING CONTROL > BILL WISE SERVISE TAX */ 
CREATE PROCEDURE 
rpt_billwisesertax
@startdateday varchar(2),
@startdatemon varchar(2),
@enddateday varchar(2),
@enddatemon varchar(2),
@settype varchar(3)
AS
select settno=(substring(l3.narr,8,8)),l.vamt ,
tstart_date =(select start_date
from ncdx.dbo.sett_mst
where Sett_No= (substring(l3.narr,8,7)) and sett_type=right(substring(narr,8,8),1)), 
 tend_date = l.VDT , L.CLTCODE 
 from ledger l, ledger3 l3
 where  substring(l.refno, 1, 7) = substring(l3.refno, 1, 7)  and
 cltcode in('99988' ,'99990','61310') and l.vtyp='15'  AND
DATEPART(day,VDT)>=@startdateday And 
 DATEPART(month,VDT) >=@startdatemon And 
DATEPART(day,VDT)<=@enddateday And 
 DATEPART(MONTH,VDT)<=@enddatemon and
(substring(l3.narr,15,1)) = @settype  
 order by tstart_date,VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_branchdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_branchdrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_branchdrcr    Script Date: 02/04/2002 9:59:42 PM ******/
/****** Object:  Stored Procedure dbo.rpt_branchdrcr    Script Date: 01/18/2002 1:38:10 PM ******/
/****** Object:  Stored Procedure dbo.rpt_branchdrcr    Script Date: 12/26/2001 1:26:53 PM ******/
/****** Object:  Stored Procedure dbo.rpt_branchdrcr    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : banchacc 
   file : branchturn.asp
*/
/*displays debit and credit  and total balances of all branches */
CREATE PROCEDURE  rpt_branchdrcr
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid='broker' 
begin
select b.branch_cd,amt=sum(vamt),drcr from ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name
group by b.branch_cd,drcr
order by b.branch_cd,drcr
end
if @statusid='branch'
begin
select b.branch_cd,amt=sum(vamt),drcr from ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name
and b.branch_cd=@statusname
group by b.branch_cd,drcr
order by b.branch_cd,drcr
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseacname2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseacname2    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : allparty.asp
*/
/* displays name of a client from ledger */
CREATE PROCEDURE rpt_bseacname2 
@cltcode varchar(10)
as
select distinct acname 
from ledger, bsedb.dbo.client1 
where cl_code=@cltcode 
and acname=short_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseageing
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseageing    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : ageing report 
   file : ageingreport.asp
*/
/* shows last balances of a client  as on a particular date */
CREATE PROCEDURE rpt_bseageing
@statusid varchar(15),
@statusname varchar(25),
@vdt varchar(12)
AS
if @statusid='broker'
begin
select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
from ledger l1, acmast a , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 
where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
order by l1.acname,vdt,vtyp,vno1,refno 
end
if @statusid='branch'
begin
select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
from ledger l1, acmast a ,bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 , bsedb.dbo.branches b
where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode and
b.branch_cd=@statusname and b.short_name=c1.trader
order by l1.acname,vdt,vtyp,vno1,refno 
end
if @statusid='subbroker'
begin
select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
from ledger l1, acmast a , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 ,bsedb.dbo.subbrokers sb
where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
and sb.sub_broker=c1.sub_broker
and sb.sub_broker=@statusname
order by l1.acname,vdt,vtyp,vno1,refno 
end
if @statusid='trader'
begin
select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
from ledger l1, acmast a , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 
where vdt = (select max(vdt) from ledger l where vdt <=@vdt + ' 23:59:59' and l.cltcode =l1.cltcode) 
and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
and c1.trader=@statusname
order by l1.acname,vdt,vtyp,vno1,refno 
end
if @statusid='client'
begin
select vdt, c1.cl_code,balamt ,l1.cltcode, l1.acname 
from ledger l1, acmast a , bsedb.dbo.client1 c1,bsedb.dbo.client2 c2 
where vdt = (select max(vdt) from ledger l where vdt <=@vdt +' 23:59:59' and l.cltcode =l1.cltcode) 
and a.cltcode=l1.cltcode and a.accat=4 and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode 
and l1.cltcode=@statusname
order by l1.acname,vdt,vtyp,vno1,refno 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsealldebtors
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsealldebtors    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : debtors
   file : drlist.asp
*/
/* calculates balances of all client accounts of a ledger for a particular date */
CREATE PROCEDURE rpt_bsealldebtors 
@vdt varchar(10),
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid='broker'
begin
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 c2
where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm') 
From Ledger l , acmast a , bsedb.dbo.client2 c2 
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code 
group by l.Cltcode,l.acname 
end 
if @statusid='branch'
begin
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 
c2 where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm') 
From Ledger l , acmast a , 
bsedb.dbo.client2 c2,  bsedb.dbo.client1 c1, bsedb.dbo.branches b 
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code 
and b.branch_cd=@statusname and b.short_name=c1.trader and c2.cl_code=c1.cl_code
group by l.Cltcode,l.acname 
end
if @statusid='trader'
begin
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 
c2 where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm') 
From Ledger l , acmast a , bsedb.dbo.client2 c2 ,
bsedb.dbo.client1 c1 
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code 
and c1.cl_code=c2.cl_code 
and c1.trader=@statusname
group by l.Cltcode,l.acname 
end
if @statusid='subbroker'
begin
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 
c2 where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm') 
From Ledger l , acmast a , bsedb.dbo.client2 c2 ,
bsedb.dbo.client1 c1, bsedb.dbo.subbrokers sb
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code 
and sb.sub_broker=c1.sub_broker and sb.sub_broker=@statusname
and c1.cl_code=c2.cl_code 
group by l.Cltcode,l.acname 
end
if @statusid='client'
begin
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 
c2 where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt + ' 11:59pm') 
From Ledger l , acmast a , bsedb.dbo.client2 c2 ,
bsedb.dbo.client1 c1 
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code 
and l.cltcode=@statusname
and c1.cl_code=c2.cl_code
group by l.Cltcode,l.acname 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseallparty
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallparty    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger 
   file :allparty.asp
*/
/*displays detail ledger  for  all parties for a particular cl code */
CREATE PROCEDURE rpt_bseallparty
@acname varchar(35),
@fromdt varchar(10),
@todt varchar(10)
AS
select convert(varchar,l.vdt,103), c2.party_code, vdesc,
dramt=isnull((case drcr when 'd' then vamt end),0),
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, l.refno, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l.refno,7)), '') 
from ledger l, vmast, bsedb.dbo.client2 c2, bsedb.dbo.client1 c1
 where l.acname = c1.short_Name and c1.cl_code = c2.cl_code
 and c2.party_code=l.cltcode and vtyp=vtype and l.acname =@acname
and vdt>=@fromdt and vdt<=@todt+ ' 11:59pm' /* put space before 11:59*/ 
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseallpartyclbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 01/04/1980 1:40:39 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 29-Sep-01 8:12:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyclbal    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : allpartyclbal
*/
/* calculates debit  and credit  totals  of  all accounts of a client code*/
CREATE PROCEDURE rpt_bseallpartyclbal
@acname varchar(35),
@fromdt varchar(10),
@todt varchar(10)
AS
select dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger l , vmast, bsedb.dbo.client2 c2 , bsedb.dbo.client1 c1 
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code 
and c2.party_code=l.cltcode and l.acname = @acname 
and vtyp=vtype and vdt >= @fromdt and vdt<=@todt + ' 11:59pm'  /* put space before 11:59 */
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseallpartyshortname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseallpartyshortname    Script Date: 20-Mar-01 11:43:34 PM ******/
CREATE PROCEDURE rpt_bseallpartyshortname
@clcode varchar(6)
 AS
select distinct short_name from  bsedb.dbo.client1 where cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclcode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcode    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : datewise.asp
   report: allpartyledger
   file : cumledger.asp
*/
/* selects client code of a partycode */
CREATE PROCEDURE rpt_bseclcode
@partycode varchar(10)
AS
select cl_code 
from bsedb.dbo.client2 
where party_code=@partycode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclcodedetailledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedetailledger    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report :allpartyledger report
   file : cumledger.asp 
*/
/*displays detail ledger of all parties of a client code*/
CREATE PROCEDURE rpt_bseclcodedetailledger
@clcode varchar(7),
@vdt varchar(10)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0), 
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) 
from ledger, bsedb.DBO.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM bsedb.DBO.CLIENT2 
WHERE CL_CODE=@clcode)and cltcode=party_code and vdt<=@vdt + ' 11:59pm' /* put blank before 11:59 */
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclcodedrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : traderledger
   file : cumbal1.asp
*/
/* calculates debit and credit  balances of all accounts of a client */
CREATE PROCEDURE rpt_bseclcodedrcr
@clcode varchar(6)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0),
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) 
from ledger, bsedb.DBO.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM bsedb.DBO.CLIENT2 WHERE CL_CODE=@clcode)
and cltcode=party_code 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclcodedrcr2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodedrcr2    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report :allpartyledger report
   file : allparty.asp 
*/
/*displays debit and credit of  totals of all accounts of a client code*/
CREATE PROCEDURE rpt_bseclcodedrcr2
@acname varchar(35),
@vdt varchar(10)
AS
select dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0)
from ledger l, bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 
where l.acname = c1.short_Name and c2.party_code=l.cltcode
and l.acname =@acname and vdt < @vdt
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclcodeparties
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 8/7/01 6:03:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclcodeparties    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : traderledger
   file : cumbal1.asp
*/
/* shows party codes  of all accounts of a client */
CREATE PROCEDURE rpt_bseclcodeparties
@clcode varchar(6)
AS
select distinct party_code 
from bsedb.dbo.client2, ledger 
where cl_code=@clcode
 and party_code=cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclientdetails
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : cumledger.asp
*/
/* displays details of a client */
CREATE PROCEDURE rpt_bseclientdetails
@clcode varchar(6)
AS
select c1.Res_Phone1,Off_Phone1, c2.tran_cat,c1.short_name 
from bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 
where c1.cl_code=@clcode and c2.cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseclientdetails1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseclientdetails1    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : cumledger.asp
*/
/* displays details of a client */
CREATE PROCEDURE rpt_bseclientdetails1
@clcode varchar(6)
AS
select c1.Res_Phone1,Off_Phone1, c2.tran_cat,c1.short_name 
from bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 
where c1.cl_code=@clcode and c2.cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsecltcodelist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsecltcodelist    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : allpartyledger
   file : clientlist.asp
*/
/* calculates list of all clients from ledger*/
CREATE PROCEDURE rpt_bsecltcodelist
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid = 'broker' 
begin
select distinct cltcode from ledger 
order by cltcode
end
if @statusid = 'branch' 
begin
select distinct cltcode 
from ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2, bsedb.dbo.branches b
where b.branch_cd=@statusname and b.short_name=c1.trader and l.cltcode=c2.party_code and
c1.cl_code=c2.cl_code
order by cltcode
end
if @statusid = 'trader' 
begin
select distinct cltcode 
from ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where c1.trader=@statusname  and c1.cl_code=c2.cl_code and l.cltcode=c2.party_code
order by cltcode
end 
if @statusid = 'subbroker' 
begin
select distinct cltcode 
from ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where sb.sub_broker=@statusname and sb.sub_broker=c1.sub_broker and
c1.cl_code=c2.cl_code and l.cltcode=c2.party_code
order by cltcode
end 
if @statusid = 'client' 
begin
select distinct cltcode 
from ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where l.cltcode=@statusname and  c1.cl_code=c2.cl_code and l.cltcode=c2.party_code
order by cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsefoclamt
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsefoclamt    Script Date: 20-Mar-01 11:43:34 PM ******/
/*Modified by Amolika on 7th feb'2001 : Added condition for sdate
Modified by Amolika on 12th feb'2001 
*/
CREATE PROCEDURE rpt_bsefoclamt
@code varchar(10),
@sdate varchar(12)
AS
/*select isnull(sum(cvamt),0) as cvamt, isnull(sum(dvamt),0) as dvamt 
from rpt_fopartybalamt 
where cltcode = @code
and left(convert(varchar,vdt,109),11) = @sdate
*/
select isnull(balamt,0)  as balamt
from ledger t
where cltcode = @code
and left(convert(varchar,vdt,109),11) = @sdate
and vno = (select max(vno) from ledger  where t.cltcode = cltcode and t.vdt = vdt)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseissuedcheques
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseissuedcheques    Script Date: 20-Mar-01 11:43:34 PM ******/
/* report : cheques
   file : todayscheq.asp
*/
/* displays list of cheques  issued as on particular date on a particular bank */
CREATE PROCEDURE rpt_bseissuedcheques 
@bankcode varchar(6),
@tdate varchar(10),
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid = 'broker' 
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''), 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'') 
from ledger l1 
where left(l1.refno,7) in ( select left(refno,7) from ledger l 
where convert(varchar,l.vdt,103) like ltrim(@tdate)+'%' and l.vtyp=3 and 
l.cltcode=@bankcode)and l1.cltcode <> @bankcode
order by l1.acname 
end
if @statusid = 'branch' 
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''), 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'') 
from ledger l1, bsedb.dbo.branches b, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where left(l1.refno,7) in ( select left(refno,7) from ledger l 
where convert(varchar,l.vdt,103) like ltrim(@tdate)+'%' and l.vtyp=3 and 
l.cltcode=@bankcode)and l1.cltcode <> @bankcode
and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode
and b.branch_cd=@statusname and b.short_name=c1.trader
order by l1.acname 
end
if @statusid = 'trader'
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''), 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'') 
from ledger l1 , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where left(l1.refno,7) in ( select left(refno,7) from ledger l 
where convert(varchar,l.vdt,103) like ltrim(@tdate)+'%' and l.vtyp=3 and 
l.cltcode=@bankcode)and l1.cltcode <> @bankcode
and c1.trader=@statusname and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode
order by l1.acname 
end
if @statusid = 'subbroker'
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''), 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'') 
from ledger l1, bsedb.dbo.subbrokers  sb, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where left(l1.refno,7) in ( select left(refno,7) from ledger l 
where convert(varchar,l.vdt,103) like ltrim(@tdate)+'%' and l.vtyp=3 and 
l.cltcode=@bankcode)and l1.cltcode <> @bankcode
and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode
and sb.sub_broker=@statusname and sb.sub_broker=c1.sub_broker
order by l1.acname 
end
if @statusid = 'client'
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''), 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'') 
from ledger l1,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where left(l1.refno,7) in ( select left(refno,7) from ledger l 
where convert(varchar,l.vdt,103) like ltrim(@tdate)+'%' and l.vtyp=3 and 
l.cltcode=@bankcode)and l1.cltcode <> @bankcode
and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode
and l1.cltcode=@statusname
order by l1.acname 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 11/28/2001 12:23:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger1    Script Date: 20-Mar-01 11:43:34 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the dramt, cramt for a particular client
*/
CREATE PROCEDURE rpt_bseledger1
@clcode varchar(6)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0),
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) from ledger,
ncdx.dbo.client2 where cltcode in (SELECT DISTINCT PARTY_CODE 
FROM ncdx.dbo.CLIENT2 
WHERE CL_CODE=@clcode)and cltcode=party_code group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger2    Script Date: 20-Mar-01 11:43:34 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the dramt, cramt for a particular client
*/
CREATE PROCEDURE rpt_bseledger2
@acname varchar(35)
AS
select convert(varchar,l.vdt,103), c2.party_code, 
vdesc,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, 
l.refno, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l.refno,7)), '') from ledger l, 
vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@acname
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger3
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger3    Script Date: 20-Mar-01 11:43:34 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the bankname,refno, cltcode for a particular client
*/
CREATE PROCEDURE rpt_bseledger3
@refno varchar(12),
@cltcode varchar(10)
AS
SELECT BNKNAME, L.REFNO, L.CLTCODE FROM LEDGER L, LEDGER1 L1 
WHERE l1.REFNO=@refno  and l.vtyp='15' and cltcode=@cltcode
and left(l.refno,7)=left(l1.refno,7)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger4
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 2/17/01 3:34:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger4    Script Date: 20-Mar-01 11:43:35 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the dramt, cramt for a particular client
*/
CREATE PROCEDURE  rpt_bseledger4
@acname varchar(35)
AS
select  dramt=isnull((case drcr when 'd' then sum(vamt) end),0),
cramt=isnull((case drcr when 'c' then sum(vamt) end),0)  
from ledger l , vmast,  ncdx.dbo.client2 c2 , 
ncdx.dbo.client1 c1 where 
l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode 
and l.acname = @acname and vtyp=vtype group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger5
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger5    Script Date: 20-Mar-01 11:43:35 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the details for a particular client
*/
CREATE PROCEDURE rpt_bseledger5
@clcode varchar(6)
AS
select c1.Res_Phone1,Off_Phone1, c2.tran_cat,c1.short_name 
from ncdx.dbo.client1 c1,ncdx.dbo.client2 c2 
where c1.cl_code=@clcode and c2.cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger6
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger6    Script Date: 20-Mar-01 11:43:35 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the dramt, cramt for a particular client
Modified : neelambari 16 Feb 2001
Mod : it gave an erroe if string   '" & "11:59PM" & "'  was joined to getdate
so added '23: 59' which is not in string format
*/
CREATE PROCEDURE rpt_bseledger6
@code varchar(10)
AS
/*
select convert(varchar,VDT,103), refno, vtyp,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(ledger.refno,7)),'')
from ledger , vmast WHERE VDT <= getdate()+ '" & "11:59PM" & "' and 
CLTCODE=@code and ledger.vtyp=vmast.vtype order by vdt, drcr,vtyp 
*/
select convert(varchar,VDT,103), refno, vtyp,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(ledger.refno,7)),'')
from ledger , vmast WHERE VDT <= getdate()+'23:59' and 
CLTCODE=@code and ledger.vtyp=vmast.vtype order by vdt, drcr,vtyp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger7
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger7    Script Date: 20-Mar-01 11:43:35 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the bankname, refno, cltcode for a particular client
*/
CREATE PROCEDURE rpt_bseledger7
@ourrefno varchar(12),
@partycode varchar(10)
AS
SELECT BNKNAME, L.REFNO, L.CLTCODE FROM LEDGER L, LEDGER1 L1 
WHERE l1.REFNO=@ourrefno
and l.vtyp='15' and cltcode=@partycode
and left(l.refno,7)=left(l1.refno,7)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseledger8
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseledger8    Script Date: 20-Mar-01 11:43:35 PM ******/
/* Report : Confirmation Report
   File : Tconfirmationreport.asp
   Displays the drtot, crtot for a particular client
Modified : neelambari 16 Feb 2001
Mod : it gave an erroe if string   '" & "11:59PM" & "'  was joined to getdate
so added '23: 59' which is not in string format
*/
CREATE PROCEDURE rpt_bseledger8
@partycode varchar(10)
AS
/*
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0),
crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= getdate() + '" & "11:59PM" & "' and CLTCODE=@partycode
group by drcr
*/
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0),
crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= getdate() +'23:59' and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsenewbdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 8/8/01 1:37:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsenewbdrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/*  report : branchaccounts
    file : branchturn.asp   
*/
/* calculates balances of branchwise all client's accounts */      
/*
old query
rpt_bdrcr
if @statusid='broker' 
begin
select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
group by  b.branch_cd,l.Cltcode
ORDER BY b.branch_cd
end 
if @statusid='branch' 
begin
select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@statusname
group by  b.branch_cd,l.Cltcode
ORDER BY b.branch_cd
end 
*/
CREATE PROCEDURE rpt_bsenewbdrcr 
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid='broker'
begin
select b.branch_cd,Cltcode,Amount=Sum(DAmt)-Sum(CAmt) 
from LedgerDrCrView l, bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.branches b
where C2.Party_Code = l.CltCode and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
Group By b.branch_cd,CltCode
ORDER BY B.Branch_Cd,cltcode
end
if @statusid='branch'
begin
select b.branch_cd,Cltcode,Amount=Sum(DAmt)-Sum(CAmt) 
from LedgerDrCrView l, bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.branches b
where C2.Party_Code = l.CltCode and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
and b.branch_cd=@statusname
Group By b.branch_cd,CltCode
ORDER BY B.Branch_Cd,cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsereccheques
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsereccheques    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : cheques
   file : todayscheq.asp
*/
/* displays list of cheques  received as on particular date on a particular bank */
CREATE PROCEDURE rpt_bsereccheques 
@bankcode varchar(6),
@tdate varchar(10),
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid = 'broker' 
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''), 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''),
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'')
from ledger l1 where left(l1.refno,7) in ( select left(refno,7) from ledger l where convert(varchar,l.vdt,103) 
like ltrim(@tdate)+'%' and l.vtyp=2 and l.cltcode=@bankcode)
and l1.cltcode <> @bankcode
order by l1.acname 
end
if @statusid = 'branch' 
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''), 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''),
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'')
from ledger l1, bsedb.dbo.branches b, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 
where left(l1.refno,7) in ( select left(refno,7) from ledger l where convert(varchar,l.vdt,103) 
like ltrim(@tdate)+'%' and l.vtyp=2 and l.cltcode=@bankcode)
and l1.cltcode <> @bankcode  and l1.cltcode=c2.party_code and 
b.branch_cd=@statusname and b.short_name=c1.trader 
and c1.cl_code=c2.cl_code
order by l1.acname 
end
if @statusid = 'trader'
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''), 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''),
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'')
from ledger l1 , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where left(l1.refno,7) in ( select left(refno,7) from ledger l where convert(varchar,l.vdt,103) 
like ltrim(@tdate)+'%' and l.vtyp=2 and l.cltcode=@bankcode)
and l1.cltcode <> @bankcode and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode
and c1.trader=@statusname
order by l1.acname 
end
if @statusid = 'subbroker'
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''), 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''),
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'')
from ledger l1 , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where left(l1.refno,7) in ( select left(refno,7) from ledger l where convert(varchar,l.vdt,103) 
like ltrim(@tdate)+'%' and l.vtyp=2 and l.cltcode=@bankcode)
and l1.cltcode <> @bankcode and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode
and sb.sub_broker=@statusname and sb.sub_broker=c1.sub_broker 
order by l1.acname 
end
if @statusid = 'client'
begin
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''), 
ddno=isnull((select ddno from ledger1 le1 where le1.refno=l1.refno),''),
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l1.refno,7)),'')
from ledger l1 , bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where left(l1.refno,7) in ( select left(refno,7) from ledger l where convert(varchar,l.vdt,103) 
like ltrim(@tdate)+'%' and l.vtyp=2 and l.cltcode=@bankcode)
and l1.cltcode <> @bankcode and c1.cl_code=c2.cl_code and c2.party_code=l1.cltcode and
l1.cltcode=@statusname 
order by l1.acname 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsesbclientlist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbclientlist    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : subbrokacc
   file : clients.asp
*/
/* displays list of clients and their balances */
CREATE PROCEDURE rpt_bsesbclientlist
@statusid varchar(15),
@statusname varchar(25),
@subbroker varchar(50)
AS
if @statusid='broker'
begin
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) 
From Ledger l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.sub_broker=sb.sub_broker and sb.sub_broker=@subbroker
group by  c1.cl_code,l.Cltcode
end
if @statusid='subbroker'
begin
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) 
From Ledger l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.sub_broker=sb.sub_broker and sb.sub_broker=@statusname
group by  c1.cl_code,l.Cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsesbnewdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsesbnewdrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report: subbrokacc 
   file : sbturn.asp
*/
CREATE PROCEDURE rpt_bsesbnewdrcr
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid='broker'
begin
select  sb.sub_broker,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) 
From Ledger l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker
group by  sb.sub_broker,l.Cltcode
ORDER BY sb.sub_broker
end 
if @statusid='subbroker'
begin
select  sb.sub_broker,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) 
From Ledger l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker
and sb.sub_broker=@statusname
group by  sb.sub_broker,l.Cltcode
ORDER BY sb.sub_broker
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bseshortnamelist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bseshortnamelist    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : allpartyledger
   file : namelist.asp
*/
/*shows list of names of clients from ledger corresponding to an alphabet*/
CREATE PROCEDURE rpt_bseshortnamelist
@statusid varchar(15),
@statusname varchar(25),
@shortname varchar(21)
AS
if @statusid = 'broker' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE c1.short_name like ltrim(@shortname)+'%' and C1.CL_CODE=C2.CL_CODE
and c2.party_code=l.cltcode 
order by c1.short_name 
end
if @statusid = 'branch' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l, bsedb.dbo.branches b
WHERE c1.short_name like ltrim(@shortname)+'%' and C1.CL_CODE=C2.CL_CODE
and c2.party_code=l.cltcode 
and b.short_name=c1.trader and b.branch_cd=@statusname
order by c1.short_name 
end
if @statusid = 'trader' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE c1.short_name like ltrim(@shortname)+'%' and C1.CL_CODE=C2.CL_CODE
and c2.party_code=l.cltcode 
and c1.trader=@statusname
order by c1.short_name 
end 
if @statusid = 'subbroker' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l , bsedb.dbo.subbrokers sb
WHERE c1.short_name like ltrim(@shortname)+'%' and C1.CL_CODE=C2.CL_CODE
and c2.party_code=l.cltcode 
and sb.sub_broker=c1.sub_broker and sb.sub_broker=@statusname
order by c1.short_name 
end 
if @statusid = 'client' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE c1.short_name like ltrim(@shortname)+'%' and C1.CL_CODE=C2.CL_CODE
and c2.party_code=l.cltcode and l.cltcode=@statusname
order by c1.short_name 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetraderallpartyled
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderallpartyled    Script Date: 20-Mar-01 11:43:35 PM ******/
CREATE PROCEDURE rpt_bsetraderallpartyled
@cname varchar(35)
AS
select convert(varchar,l.vdt,103), c2.party_code, 
vdesc,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, 
l.refno, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l.refno,7)), '') from ledger l,
vmast, bsedb.dbo.client2 c2, bsedb.dbo.client1 c1
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@cname
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetraderpos
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderpos    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : branchacc 
   file :   trader.asp
   displays list of traders under a particular branch  
*/
   
CREATE PROCEDURE rpt_bsetraderpos
@br varchar(15)
AS
/*
select  l.Cltcode,c1.cl_code, C1.TRADER ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by  C1.TRADER,c1.cl_code,l.Cltcode
ORDER BY C1.TRADER,c1.cl_code
*/
select  l.Cltcode,c1.cl_code, C1.TRADER ,Amount=Sum(DAmt)-Sum(CAmt) 
from LedgerDrCrView l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by  C1.TRADER,c1.cl_code,l.Cltcode
ORDER BY C1.TRADER,c1.cl_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetraderwise
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : traderwise ledger
    file : traderwise.asp
 */
/* displays list of party  short names as per the selection made by user */
CREATE PROCEDURE rpt_bsetraderwise
@statusid varchar(15),
@statusname varchar(25),
@trader varchar(15)
AS
if @statusid = 'broker' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE C1.TRADER=@trader
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C1.SHORT_NAME  
end
if @statusid = 'branch' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l,  bsedb.DBO.branches b 
WHERE C1.TRADER=@trader
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
and b.branch_cd=@statusname and b.short_name=c1.trader
ORDER BY C1.SHORT_NAME  
end
if @statusid = 'trader' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE C1.TRADER=@trader
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C1.SHORT_NAME  
end 
if @statusid = 'subbroker' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l,  bsedb.DBO.subbrokers sb
WHERE C1.TRADER=@trader
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
and sb.sub_broker=c1.sub_broker and sb.sub_broker=@statusname
ORDER BY C1.SHORT_NAME  
end 
if @statusid = 'client' 
begin
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE C1.TRADER=@trader and l.cltcode=@statusname
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C1.SHORT_NAME  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetraderwise2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwise2    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : traderwise ledger
    file : traderwise.asp
 */
/* displays list of short names as per the selection made by user */
CREATE PROCEDURE rpt_bsetraderwise2
@statusid varchar(15),
@statusname varchar(25),
@trader varchar(15)
AS
if @statusid = 'broker' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C2.party_code
end
if @statusid = 'branch' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l, bsedb.DBO.branches b
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode and
b.branch_cd=@statusname and b.short_name=c1.trader
ORDER BY C2.party_code
end
if @statusid = 'trader' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C2.party_code
end 
if @statusid = 'subbroker' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l,  bsedb.DBO.subbrokers sb
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
and sb.sub_broker=c1.sub_broker 
and sb.sub_broker=@statusname
ORDER BY C2.party_code
end 
if @statusid = 'client' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM bsedb.DBO.CLIENT1 C1, bsedb.DBO.CLIENT2 C2, ledger l
WHERE C1.TRADER=@trader and l.cltcode=@statusname
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C2.party_code
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetraderwiseclient
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetraderwiseclient    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : branchacc 
   file :  traderwiseclient.asp*/
/* displays balances of all accounts of a trader */
CREATE PROCEDURE rpt_bsetraderwiseclient 
@statusid varchar(15),
@statusname varchar(25),
@trader varchar(15),
@branch varchar(7)
AS
if @statusid='branch'
begin
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) 
From Ledger l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@statusname
and c1.trader=@trader
group by  c1.cl_code,l.Cltcode
order by l.cltcode
end 
if @statusid='broker'
begin
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) 
From Ledger l , bsedb.dbo.client1 c1,
bsedb.dbo.client2 c2, bsedb.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@branch
and c1.trader=@trader
group by  c1.cl_code,l.Cltcode
order by l.cltcode
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetradledallpartybal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetradledallpartybal    Script Date: 20-Mar-01 11:43:35 PM ******/
CREATE PROCEDURE rpt_bsetradledallpartybal
@cname varchar(35)
 AS
select  dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger l , vmast,  bsedb.dbo.client2 c2 , bsedb.dbo.client1 c1 where 
l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode 
and l.acname = @cname and vtyp=vtype group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_bsetrialbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 8/8/01 1:37:32 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 8/7/01 6:03:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 7/8/01 3:22:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 2/17/01 3:34:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_bsetrialbal    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : trial balance
   file : trialbal.asp
*/
/* displays trial balance */
     
CREATE PROCEDURE rpt_bsetrialbal 
@statusid varchar(15),
@statusname varchar(25),
@vdt varchar(10)
AS
if @statusid = 'broker'
begin
select l.cltcode , clcode=(select cl_code from bsedb.dbo.client2 c2 
where c2.party_code=l.cltcode),l.acname, 
Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
and vdt <= @vdt + ' 23:59:59') - 
(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
From Ledger l where vdt <= @vdt + ' 23:59:59' 
group by l.Cltcode, l.acname 
end 
if @statusid = 'branch'
begin
select l.cltcode , clcode=(select cl_code from bsedb.dbo.client2 c2 
where c2.party_code=l.cltcode),l.acname, 
Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
and vdt <= @vdt + ' 23:59:59')- 
(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
From Ledger l, bsedb.dbo.branches b, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where vdt <= @vdt + ' 23:59:59' 
and b.branch_cd=@statusname
and b.short_name=c1.trader
and c1.cl_code=c2.cl_code
and c2.party_code=l.cltcode
group by l.Cltcode, l.acname 
end 
if @statusid = 'trader'
begin
select l.cltcode , clcode=(select cl_code from bsedb.dbo.client2 c2 
where c2.party_code=l.cltcode),l.acname, 
Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
and vdt <= @vdt + ' 23:59:59')- 
(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
From Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2
where vdt <= @vdt + ' 23:59:59' 
and c1.trader=@statusname
and c1.cl_code=c2.cl_code
and c2.party_code=l.cltcode
group by l.Cltcode, l.acname 
end 
if @statusid='subbroker'
begin
select l.cltcode , clcode=(select cl_code from bsedb.dbo.client2 c2 
where c2.party_code=l.cltcode),l.acname, 
Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
and vdt <= @vdt + ' 23:59:59')- 
(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
From Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2, bsedb.dbo.subbrokers sb
where vdt <= @vdt + ' 23:59:59' 
and sb.sub_broker=@statusname
and sb.sub_broker=c1.sub_broker
and c1.cl_code=c2.cl_code
and c2.party_code=l.cltcode
group by l.Cltcode, l.acname 
end
if @statusid='client'
begin
select l.cltcode , clcode=(select cl_code from bsedb.dbo.client2 c2 
where c2.party_code=l.cltcode),l.acname, 
Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
and vdt <= @vdt + ' 23:59:59')- 
(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
From Ledger l , bsedb.dbo.client1 C1, bsedb.dbo.client2 C2
where vdt <= @vdt + ' 23:59:59' and
c1.cl_code=c2.cl_code
and c2.party_code=l.cltcode
and l.cltcode=@statusname
group by l.Cltcode, l.acname 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_cashbookprinting
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 01/11/2003 3:46:56 PM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 01/04/1980 1:40:40 AM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 11/28/2001 12:23:48 PM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 29-Sep-01 8:12:06 PM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 09/21/2001 2:39:21 AM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 08/24/2001 7:43:56 AM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 08/13/2001 6:16:53 AM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 04/FEB/2002 1:40:40 AM ******/
/********************************************************************************
Some changes are made By Manish Runwal on 30/1/2002
Added Two parameter for Branch wise selection and one flag is used to get all or not
Depending on the @flag value 
If @flag = 0  then Cash book transaction for all the branches
If @flag = 1 then show Cash book transaction for a selected branch (i.e for the passed costcode )
**********************************************************************************/
CREATE PROCEDURE rpt_cashbookprinting
@cltcode  as varchar(10),
@fromdate as datetime,
@todate as datetime, 
@vdtedtflag as integer,
@flag as integer,
@Costcode as varchar(12)
AS
IF @vdtedtflag = 0 
BEGIN
	if @flag = 0
	/*If All Branches then show all */
	BEGIN
          		SELECT vdt = convert(varchar,l.vdt,103),cltcode = isnull(l.cltcode,''), Acname = isnull(a.longname,''),L.VNO1,L.VNO,voudt=l.vdt,
	           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
	           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
		balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND  l3.naratno = l.lno ) ,'') 
	           	FROM LEDGER L,acmast a 
	           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
	           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode ) 
	           	and l.vdt >= @fromdate + ' 00:00:00'
	           	and l.vdt <= @todate  + ' 23:59:59'
	           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
	           	ORDER BY VOUDT
	END	
	/*If selected Branch then shows perticular */
	ELSE IF @flag = 1
	BEGIN 
		SELECT vdt = convert(varchar,l.vdt,103),cltcode = isnull(l.cltcode,''), Acname = isnull(a.longname,''),L.VNO1,L.VNO,voudt=l.vdt,
           		Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
	           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
		balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND  l3.naratno = l.lno ) ,'') 
	           	FROM LEDGER L,acmast a 
	           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO 
		and vtyp in (select distinct vtype from ledger2 where costcode = @costcode) )
	           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode 
		and booktype in ( select distinct booktype from ledger2 where costcode = @costcode ) ) 
	           	and l.vdt >= @fromdate + ' 00:00:00'
           		and l.vdt <= @todate  + ' 23:59:59'
	           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
           		ORDER BY VOUDT
	END 
END
ELSE IF @vdtedtflag = 1
BEGIN
	if @flag = 0
	BEGIN
    	            SELECT vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103), cltcode = isnull(l.cltcode,''),Acname=isnull(a.longname,''),L.VNO1,L.VNO,effdt = l.edt,
	           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
	           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
		balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND  l3.naratno = l.lno ) ,'') 
	         	FROM LEDGER L,acmast a 
	           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
	           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode ) 
	           	and l.edt >= @fromdate  + ' 00:00:00'
	           	and l.edt <= @todate   + ' 23:59:59'
	           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
	           	ORDER BY EFFDT
	END
	if @flag = 1
	BEGIN
	            SELECT vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103), cltcode = isnull(l.cltcode,''),Acname=isnull(a.longname,''),L.VNO1,L.VNO,effdt = l.edt,
	           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
	           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
		balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
	           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND  l3.naratno = l.lno ) ,'') 
	         	FROM LEDGER L,acmast a 
           		WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO 
		and vtyp in (select distinct vtype from ledger2 where costcode = @costcode) )
	           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode 
		and booktype in ( select distinct booktype from ledger2 where costcode = @costcode ) ) 
	           	and l.edt >= @fromdate  + ' 00:00:00'
	           	and l.edt <= @todate   + ' 23:59:59'
           		AND l.VTYP <> 18 and a.cltcode=l.cltcode 
	           	ORDER BY EFFDT
	END
END
/* IF @vdtedtflag = 0 
BEGIN
          	SELECT vdt = convert(varchar,l.vdt,103),cltcode = isnull(l.cltcode,''), Acname = isnull(a.longname,''),L.VNO1,L.VNO,
           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
		balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=0),''),
		LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND  l3.naratno = l.lno ) ,'') 
           	FROM LEDGER L,acmast a 
           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode ) 
           	and l.vdt >= @fromdate + ' 00:00:00'
           	and l.vdt <= @todate  + ' 23:59:59'
           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
           	ORDER BY VDT
		
END
ELSE IF @vdtedtflag = 1
BEGIN
            SELECT vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103), cltcode = isnull(l.cltcode,''),Acname=isnull(a.longname,''),L.VNO1,L.VNO,
           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
	balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
           	CNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=0),''),
	LNarration =isnull((select l3.narr from ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND  l3.naratno = l.lno ) ,'') 
           	FROM LEDGER L,acmast a 
           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
           	AND L.CLTCODE <> @cltcode and l.booktype = ( select booktype from acmast a where a.cltcode =  @cltcode ) 
           	and l.edt >= @fromdate  + ' 00:00:00'
           	and l.edt <= @todate   + ' 23:59:59'
           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
           	ORDER BY l.VDT
END
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_clcodedrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_clcodedrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_clcodedrcr    Script Date: 02/04/2002 9:59:44 PM ******/
/****** Object:  Stored Procedure dbo.rpt_clcodedrcr    Script Date: 01/18/2002 1:38:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_clcodedrcr    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_clcodedrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : traderledger
   file : cumbal1.asp
*/
/* calculates debit and credit  balances of all accounts of a client */
CREATE PROCEDURE rpt_clcodedrcr
@clcode varchar(6)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0),
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) 
from ledger, ncdx.dbo.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM ncdx.dbo.CLIENT2 WHERE CL_CODE=@clcode)
and cltcode=party_code 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_clientdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_clientdrcr    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_clientdrcr    Script Date: 02/04/2002 9:59:44 PM ******/
/****** Object:  Stored Procedure dbo.rpt_clientdrcr    Script Date: 01/18/2002 1:38:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_clientdrcr    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_clientdrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : confirmation 
   file : tconfirmationreport.asp
*/
/* calculates debit and credit  balances of all accounts of a client */
CREATE PROCEDURE rpt_clientdrcr
@acname varchar(35)
AS
select dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger l , vmast, ncdx.dbo.client2 c2 , ncdx.dbo.client1 c1 
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code 
and c2.party_code=l.cltcode and l.acname = @acname
and vtyp=vtype 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_cltcodelist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 01/14/2002 20:39:21 ******/

/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 01/04/1980 1:40:41 AM ******/



/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 11/28/2001 12:23:49 PM ******/




/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 2/17/01 5:19:41 PM ******/


/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 3/21/01 12:50:13 PM ******/

/****** Object:  Stored Procedure dbo.rpt_cltcodelist    Script Date: 20-Mar-01 11:38:55 PM ******/



/* report : allpartyledger
   file : clientlist.asp
*/
/* calculates list of all clients from ledger*/
/*changed by mousami on 05/09/2001
    now list of clients will contain clients of type 4 only .This is told by sheetal
*/

/* changed by mousami on 01/03/2001
     added account database hardcoding to accounts tables
     and removed hardcoding for sharedatabse for sharedatabase tables */

CREATE PROCEDURE rpt_cltcodelist
@statusid varchar(15),
@statusname varchar(25)
AS
 if @statusid = 'broker' 
 begin
  select distinct l.cltcode from account.dbo.ledger l ,account.dbo. acmast a 
  where a.cltcode=l.cltcode and a.accat=4
  order by l.cltcode
 end
 if @statusid = 'branch' 
 begin
  select distinct l.cltcode from account.dbo.ledger l, client1 c1,client2 c2, branches b, account.dbo.acmast a
  where b.branch_cd=@statusname and b.short_name=c1.trader and l.cltcode=c2.party_code and
  c1.cl_code=c2.cl_code
  and a.cltcode=l.cltcode and a.accat=4
  order by l.cltcode
 end
 if @statusid = 'trader' 
 begin
  select distinct l.cltcode from account.dbo.ledger l, client1 c1, client2 c2, account.dbo.acmast a
  where c1.trader=@statusname  and c1.cl_code=c2.cl_code and l.cltcode=c2.party_code
 and  a.cltcode=l.cltcode and a.accat=4	
  order by l.cltcode
 end 
 
 if @statusid = 'subbroker' 
 begin
  select distinct l.cltcode from account.dbo.ledger l,client1 c1, client2 c2, subbrokers sb, account.dbo.acmast a
  where sb.sub_broker=@statusname and sb.sub_broker=c1.sub_broker and
  c1.cl_code=c2.cl_code and l.cltcode=c2.party_code
  and a.cltcode=l.cltcode and a.accat=4
  order by l.cltcode
 end 
 if @statusid = 'client' 
 begin
  select distinct l.cltcode from account.dbo.ledger l, client1 c1, client2 c2, account.dbo.acmast a
  where l.cltcode=@statusname and  c1.cl_code=c2.cl_code and l.cltcode=c2.party_code
  and a.cltcode=l.cltcode and a.accat=4
  order by l.cltcode
 end
 if @statusid = 'family' 
 begin
  select distinct l.cltcode from account.dbo.ledger l ,accountncdx.dbo. acmast a , client1 c1, client2 c2
  where a.cltcode=l.cltcode and a.accat=4
  and c1.cl_code=c2.cl_code 
  and c2.party_code=l.cltcode
  and c1.family=@statusname
  order by l.cltcode
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_conpath
-- --------------------------------------------------

/****** Object:  Stored Procedure Dbo.rpt_conpath    Script Date: 01/15/2005 1:33:40 Pm ******/

/****** Object:  Stored Procedure Dbo.rpt_conpath    Script Date: 12/16/2003 2:31:48 Pm ******/



/****** Object:  Stored Procedure Dbo.rpt_conpath    Script Date: 05/08/2002 12:35:11 Pm ******/




/*report :  Allparty Ledger 
    File : Allparty.asp
    File : Ledgerview.asp
*/

/* Selects Conpath From Owner For A Exchange And Segment */

Create Procedure Rpt_conpath

@exch Varchar(3),
@segment Varchar(20)

As

Select Conpath From owner Where Exchange=@exch And Segment Like Ltrim(@segment)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_converteddate
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_converteddate    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_converteddate    Script Date: 02/04/2002 9:59:44 PM ******/
/****** Object:  Stored Procedure dbo.rpt_converteddate    Script Date: 01/18/2002 1:38:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_converteddate    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 2/17/01 5:19:55 PM ******/
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 3/21/01 12:50:24 PM ******/
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 20-Mar-01 11:39:03 PM ******/
CREATE PROCEDURE rpt_converteddate
AS
select  substring(convert(varchar,getdate(),103),4,2)+ "/" + substring(convert(varchar,getdate(),103),1,2)+ "/" + substring(convert(varchar,getdate(),103),7,4)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_currentopentry
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_currentopentry    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_currentopentry    Script Date: 01/14/2002 20:39:21 ******/
/****** Object:  Stored Procedure dbo.rpt_currentopentry    Script Date: 01/04/1980 1:40:41 AM ******/
/****** Object:  Stored Procedure dbo.rpt_currentopentry    Script Date: 11/28/2001 12:23:49 PM ******/
/*
This gives us the open entry date for supplied yr
*/
CREATE procedure rpt_currentopentry
@sdtcur datetime ,
@ldtcur datetime
as
/*
select distinct isnull(convert(varchar,vdt,109),'')  from account.dbo.ledger where vtyp='18' and
vdt >= ltrim(@sdtcur) and vdt <= ltrim(@ldtcur) + ' 23:59:59'  
*/
select distinct isnull(left(convert(varchar,vdt,109),11),'')  from accountncdx.dbo.ledger where vtyp='18' and
vdt >= @sdtcur and vdt <= @ldtcur  + ' 23:59:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_datediff
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_datediff    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_datediff    Script Date: 02/04/2002 9:59:44 PM ******/
/****** Object:  Stored Procedure dbo.rpt_datediff    Script Date: 01/18/2002 1:38:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_datediff    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_datediff    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : ageing report
   file : ageingreport.asp
*/
/* calculates difference between last balance date and date typed by user */
CREATE PROCEDURE rpt_datediff 
@vdt varchar(20),
@date1 varchar(10)
AS
select datediff=datediff(d, @vdt , @date1)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_daymarginledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_daymarginledger    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_daymarginledger    Script Date: 02/04/2002 9:59:44 PM ******/
create procedure rpt_daymarginledger
@sdt as varchar(11),
@tdt as varchar(11),
@partycode as varchar(20)
as
if @partycode = '%' 
begin
select left(convert(varchar,c.mdt,109),11) as mdt,
camt = (select sum(a.cramt) from daymarginledger a where convert(datetime,a.mdt,109) <= c.mdt) ,
damt = (select sum(b.dramt) from daymarginledger b where convert(datetime,b.mdt,109) <= c.mdt) ,
c.yy,c.mm,c.dd
from daymarginledger c
where convert(datetime,c.mdt,109) >= @sdt
and convert(datetime,c.mdt,109) <= @tdt
group by c.mdt,c.yy,c.mm,c.dd
order by c.yy ,c.mm,c.dd
end 
if @partycode <> '%' 
begin
select left(convert(varchar,c.mdt,109),11) as mdt,
camt = (select sum(a.cramt) from daymarginledger a where convert(datetime,a.mdt,109) <= c.mdt and a.party_code = c.party_code) ,
damt = (select sum(b.dramt) from daymarginledger b where convert(datetime,b.mdt,109) <= c.mdt and b.party_code = c.party_code) ,
c.yy,c.mm,c.dd
from daymarginledger c
where convert(datetime,c.mdt,109) >= @sdt
and convert(datetime,c.mdt,109) <= @tdt
and c.party_code = @partycode
group by c.mdt,c.yy,c.mm,c.dd,c.party_code
order by c.yy ,c.mm,c.dd
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_daymarginledger_party
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_daymarginledger_party    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_daymarginledger_party    Script Date: 02/04/2002 9:59:44 PM ******/
create procedure rpt_daymarginledger_party
@tdt as varchar(11),
@partycode as varchar(20)
as
if @partycode = ''
begin
select c.mdt,c.party_code,camt=sum(C.cramt),damt=sum(c.dramt),
/*camt = (select sum(a.cramt) from daymarginledger a where convert(datetime,a.mdt,109) <= c.mdt and a.party_code=c.party_code),
damt = (select sum(b.dramt) from daymarginledger b where convert(datetime,b.mdt,109) <= c.mdt and b.party_code=c.party_code), */
c.yy,c.mm,c.dd,c1.short_name
from daymarginledger c,ncdx.dbo.client2 c2,ncdx.dbo.client1 c1
where convert(datetime,c.mdt,109) <= @tdt
and c2.party_code = c.party_code
and c1.cl_code = c2.cl_code
group by c.mdt,c.party_code,c.yy,c.mm,c.dd,c1.short_name
order by c.party_code,c.yy,c.mm,c.dd
end
if @partycode <> ''
begin
select c.mdt,c.party_code,camt=sum(C.cramt),damt=sum(c.dramt),
/*camt = (select sum(a.cramt) from daymarginledger a where convert(datetime,a.mdt,109) <= c.mdt and a.party_code=c.party_code),
damt = (select sum(b.dramt) from daymarginledger b where convert(datetime,b.mdt,109) <= c.mdt and b.party_code=c.party_code), */
c.yy,c.mm,c.dd,c1.short_name
from daymarginledger c,ncdx.dbo.client2 c2,ncdx.dbo.client1 c1
where convert(datetime,c.mdt,109) <= @tdt
and c2.party_code = c.party_code
and c1.cl_code = c2.cl_code
and c.party_code = @partycode
group by c.mdt,c.party_code,c.yy,c.mm,c.dd,c1.short_name
order by c.party_code,c.yy,c.mm,c.dd
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_detailledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_detailledger    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_detailledger    Script Date: 02/04/2002 9:59:44 PM ******/
/****** Object:  Stored Procedure dbo.rpt_detailledger    Script Date: 01/18/2002 1:38:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_detailledger    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_detailledger    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report :confirmation report
   file : tconfirmation.asp
   report :  traderledger
   file : allparty.asp
*/
/*displays detail ledger */
CREATE PROCEDURE rpt_detailledger
@acname varchar(35)
AS
select convert(varchar,l.vdt,103), c2.party_code, vdesc,
dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0),
l.vamt, balamt,vtyp, vno,lno,drcr,
nar=isnull((select l3.narr from ledger3 l3 where l3.vtyp=l.vtyp  and l3.vno = l.vno and naratno = l.lno), '') 
from ledger l, vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and 
c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@acname
order by l.vdt
/*select convert(varchar,l.vdt,103), c2.party_code, vdesc,
dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, l.refno, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l.refno,7)), '') 
from ledger l, vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and 
c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@acname
order by l.vdt*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foclientdetail1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_foclientdetail1    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclientdetail1    Script Date: 01/04/1980 1:40:41 AM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetail1    Script Date: 11/28/2001 12:23:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetail1    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetail1    Script Date: 9/7/2001 6:05:58 PM ******/
CREATE PROCEDURE rpt_foclientdetail1
@code varchar(10),
@sdate varchar(12),
@tdate varchar(12)
AS
select dramt =  sum(dramt), cramt = sum(cramt), cltcode
from rpt_focldetail
where vdt <= @tdate + ' 23:59:59' and vtyp not Like ( Case When Convert(varchar,Vdt,106) = @Tdate Then '15' else '' end )
and cltcode = @code
group by  cltcode
order by cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foclientdetailbill1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_foclientdetailbill1    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclientdetailbill1    Script Date: 01/04/1980 1:40:41 AM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetailbill1    Script Date: 11/28/2001 12:23:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetailbill1    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetailbill1    Script Date: 9/7/2001 6:05:58 PM ******/
/****** Object:  Stored Procedure dbo.rpt_foclientdetailbill1    Script Date: 10/26/00 2:46:52 PM ******/
CREATE PROCEDURE rpt_foclientdetailbill1
@statusid varchar(15),
@statusname varchar(25),
@code varchar(10),
@sdate varchar(15),
@tdate varchar(15)
AS
if @statusid = 'broker'
begin
	select  party_code ,billdate =left(convert(varchar,billdate,106),11),
	credit = (case when sell_buy = 2 then amount else 0 end ),
	debit  = (case when sell_buy = 1 then amount else 0 end),Year(billdate),month(billdate),day(billdate)
	from foaccbill
	where party_code like ltrim(@code)
	and billdate >= ltrim(@sdate )
                and billdate <= ltrim(@tdate) + ' 23:59:00'
	and amount <> 0
/*	order by party_code,Year(billdate),month(billdate),day(billdate)*/
	union 
	select  party_code ,billdate =left(convert(varchar,billdate,106),11),
	credit = 0,
	debit  = 0,Year(billdate),month(billdate),day(billdate)
	from Rpt_FoColl
	where party_code like ltrim(@code)
	and billdate >= @sdate 
                and billdate <= ltrim(@tdate) + ' 23:59:00'
	order by party_code,Year(billdate),month(billdate),day(billdate)
end 
if @statusid = 'branch'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = (case when sell_buy = 2 then amount else 0 end ),
	debit  = (case when sell_buy = 1 then amount else 0 end),Year(billdate),month(billdate),day(billdate)
	from foaccbill fo,client2 c2, client1 c1, branches b
	where fo.Party_Code = c2.party_code and 
	 b.short_name = c1.trader and
	 c1.cl_code = c2.cl_code and
	 b.branch_cd = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate 
                and billdate <= ltrim(@tdate) + '23:59:00'
	and amount <> 0
	order by fo.party_code,Year(billdate),month(billdate),day(billdate)
end 
if @statusid = 'subbroker'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = (case when sell_buy = 2 then amount else 0 end ),
	debit  = (case when sell_buy = 1 then amount else 0 end),Year(billdate),month(billdate),day(billdate)
	from foaccbill fo,client2 c2, client1 c1, subbrokers sb
	where fo.Party_Code = c2.party_code and 
	sb.sub_broker = @statusname and
	sb.sub_broker = c1.sub_broker and
	c1.cl_code = c2.cl_code and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate 
                and billdate <= ltrim(@tdate) + '23:59:00'
	and amount <> 0
	order by fo.party_code,Year(billdate),month(billdate),day(billdate)
end 
if @statusid = 'trader'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = (case when sell_buy = 2 then amount else 0 end ),
	debit  = (case when sell_buy = 1 then amount else 0 end),Year(billdate),month(billdate),day(billdate)
	from foaccbill fo,client2 c2, client1 c1
	where fo.Party_Code = c2.party_code and 
	c1.cl_code = c2.cl_code and
	c1.trader  = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate 
                and billdate <=  ltrim(@tdate) + '23:59:00'
	and amount <> 0
	order by fo.party_code,Year(billdate),month(billdate),day(billdate)
end 
if @statusid = 'client'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = (case when sell_buy = 2 then amount else 0 end ),
	debit  = (case when sell_buy = 1 then amount else 0 end),Year(billdate),month(billdate),day(billdate)
	from foaccbill fo,client2 c2, client1 c1
	where fo.Party_Code = c2.party_code and 
	c1.cl_code = c2.cl_code and
	fo.party_code = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate 
                and billdate <= ltrim(@tdate) + '23:59:00'
	and amount <> 0
	order by fo.party_code,Year(billdate),month(billdate),day(billdate)
end 
if @statusid = 'family'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = (case when sell_buy = 2 then amount else 0 end ),
	debit  = (case when sell_buy = 1 then amount else 0 end),Year(billdate),month(billdate),day(billdate)
	from foaccbill fo,client2 c2, client1 c1
	where fo.Party_Code = c2.party_code and 
	c1.cl_code = c2.cl_code and
	c1.family  = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate 
                and billdate <= ltrim(@tdate) + '23:59:00'
	and amount <> 0
	order by fo.party_code,Year(billdate),month(billdate),day(billdate)
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_focolmargin
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 01/04/1980 1:40:41 AM ******/
/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 11/28/2001 12:23:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 9/7/2001 6:05:58 PM ******/
/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 08/10/2001 5:05:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_focolmargin    Script Date: 7/18/2001 6:24:05 PM ******/
CREATE PROCEDURE rpt_focolmargin
@code varchar(10),
@sdate varchar(12)
AS
select party_code,amount=sum(amount),drcr
from marginledger
where party_code = @code
and exchange = 'NSE'  
and segment like 'FUT%'
and vdt <= @sdate + ' 23:59'
group by  party_code, drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foconfirmlistpcm
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_foconfirmlistpcm    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foconfirmlistpcm    Script Date: 1/24/02 3:41:34 PM ******/
CREATE PROCEDURE rpt_foconfirmlistpcm
@statusid varchar(15),
@statusname varchar(25),
@fpartycode varchar(10),
@tpartycode varchar(10),
@sdate varchar(12)
AS
if @statusid='broker'
begin
select distinct s.branch_id as party_code ,c1.short_name from fosettlement s,client1 c1 ,client2 c2
where c1.cl_code=c2.cl_code
and s.party_code=c2.party_code
and s.branch_id between @fpartycode and @tpartycode /*like  @partycode+'%'*/
and convert(varchar,s.sauda_date,106) = @sdate  
order by s.branch_id
end 
if @statusid='branch'
begin
select distinct s.branch_id as party_code ,c1.short_name from fosettlement s,client1 c1 ,client2 c2,branches b
where c1.cl_code=c2.cl_code
and s.party_code=c2.party_code
and b.short_name=c1.trader
and b.branch_cd = @statusname
and s.branch_id between @fpartycode and @tpartycode /*like  @partycode+'%'*/
and convert(varchar,sauda_date,106) = @sdate  
order by s.branch_id
end 
if @statusid='subbroker'
begin
select distinct s.branch_id as party_code,c1.short_name from fosettlement s,client1 c1 ,client2 c2,subbrokers sb
where c1.cl_code=c2.cl_code
and s.party_code=c2.party_code
and sb.sub_broker=@statusname 
and sb.sub_broker=c1.sub_broker
and s.branch_id between @fpartycode and @tpartycode /*like  @partycode+'%'*/
and convert(varchar,sauda_date,106) = @sdate  
order by s.branch_id
end 
if @statusid='trader'
begin
select distinct s.branch_id as party_code ,c1.short_name from fosettlement s,client1 c1 ,client2 c2
where c1.cl_code=c2.cl_code
and s.party_code=c2.party_code
and c1.trader=@statusname
and s.branch_id between @fpartycode and @tpartycode /*like  @partycode+'%'*/
and convert(varchar,sauda_date,106) = @sdate  
order by s.branch_id
end 
if @statusid='client'
begin
select distinct s.branch_id as party_code,c1.short_name from fosettlement s,client1 c1 ,client2 c2
where c1.cl_code=c2.cl_code
and s.party_code=c2.party_code
and c2.party_code=@statusname
and s.branch_id between @fpartycode and @tpartycode /*like  @partycode+'%'*/
and convert(varchar,sauda_date,106) = @sdate  
order by s.branch_id
end 
if @statusid='family'
begin
select distinct s.branch_id as party_code ,c1.short_name from fosettlement s,client1 c1 ,client2 c2
where c1.cl_code=c2.cl_code
and s.party_code=c2.party_code
and c1.family=@statusname
and s.branch_id between @fpartycode and @tpartycode /*like  @partycode+'%'*/
and convert(varchar,sauda_date,106) = @sdate  
order by s.branch_id
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foconfirmsettpcm
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_foconfirmsettpcm    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foconfirmsettpcm    Script Date: 1/24/02 3:41:34 PM ******/
CREATE PROCEDURE rpt_foconfirmsettpcm
@statusid varchar(15),
@statusname varchar(25),
@fparty varchar(10),
@tparty varchar(10),
@sdate varchar(12)
AS
if @statusid='broker'
begin
	SELECT s.branch_id as party_code, tm=convert(varchar,sauda_date,108),s.user_id,
	tdate=convert(varchar,sauda_date,103),  s.trade_no,convert(varchar,s.sauda_date,103) as sauda_date, 
	sdt = convert(VARchar,sauda_date,103),
	s.sell_buy, service_tax = isnull(s.service_tax,0),
	pqty=isnull((case sell_buy when 1 then s.tradeqty end),0),
	sqty=isnull((case sell_buy when 2 then s.tradeqty end),0),
	prate=isnull((case sell_buy when 1 then s.price end),0),
	srate=isnull((case sell_buy when 2 then s.price end),0),
	pbrok=isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	sbrok=abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	pnetrate=s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	snetrate=s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0))), 
	pamt=s.tradeqty * (s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	samt=s.tradeqty * (s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)))), 
	Brokerage=isnull(tradeqty*convert(numeric(9,2),brokapplied),0) ,
	NewBrokerage =isnull(tradeqty*convert(numeric(9,2),nbrokapp),0), 
	c1.short_name, c1.trader, c1.Res_Phone1, c2.service_chrg, c1.cl_code, c1.off_phone1,
	s.inst_type, s.symbol, expirydate = convert(varchar,s.expirydate,106), s.strike_price, s.option_type ,
	turn = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Turnover_tax = 1 then sum(s.turn_tax) else 0 end)else 0 end),
	sebi = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Sebi_Turn_tax = 1 then sum(s.sebi_tax) else 0 end)else 0 end),
	insc = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Insurance_Chrg = 1 then sum(s.Ins_chrg) else 0 end)else 0 end),
	other = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Other_chrg = 1 then sum(s.other_chrg) else 0 end)else 0 end),
	Brokertax = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.BrokerNote = 1 then sum(s.Broker_chrg) else 0 end)else 0 end),
	c1.trader,s.reserved1
	from fosettlement s , client1 c1, client2 c2
	where s.party_code = c2.party_code
	and c1.cl_code = c2.cl_code
	and s.branch_id between @fparty and @tparty   /*ltrim(@code)+'%'*/
	and convert(varchar,s.sauda_date,106) = @sdate
	AND s.TRADEQTY <> '0'  
	group by s.branch_id, billno, trade_no, sauda_date,s.sell_buy,  c1.short_name, c1.trader,s.user_id, 
	c1.Res_Phone1 , s.service_tax, s.price, s.tradeqty, s.brokapplied, c2.service_chrg, s.nbrokapp, 
	c1.cl_code ,c1.off_phone1,s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price, 
	s.option_type, c2.Turnover_tax,c2.Sebi_Turn_tax ,c2.Insurance_Chrg,c2.Other_chrg, c2.BrokerNote, c1.trader,s.reserved1
	order by s.branch_id, s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price,
	s.option_type
end
if @statusid='branch'
begin
	SELECT s.branch_id as party_code, tm=convert(varchar,sauda_date,108),s.user_id,
	tdate=convert(varchar,sauda_date,103),  s.trade_no,convert(varchar,s.sauda_date,103) as sauda_date, 
	sdt = convert(VARchar,sauda_date,103),
	s.sell_buy, service_tax = isnull(s.service_tax,0),
	pqty=isnull((case sell_buy when 1 then s.tradeqty end),0),
	sqty=isnull((case sell_buy when 2 then s.tradeqty end),0),
	prate=isnull((case sell_buy when 1 then s.price end),0),
	srate=isnull((case sell_buy when 2 then s.price end),0),
	pbrok=isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	sbrok=abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	pnetrate=s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	snetrate=s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0))), 
	pamt=s.tradeqty * (s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	samt=s.tradeqty * (s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)))), 
	Brokerage=isnull(tradeqty*convert(numeric(9,2),brokapplied),0) ,
	NewBrokerage =isnull(tradeqty*convert(numeric(9,2),nbrokapp),0), 
	c1.short_name, c1.trader, c1.Res_Phone1, c2.service_chrg, c1.cl_code, c1.off_phone1,
	s.inst_type, s.symbol, expirydate = convert(varchar,s.expirydate,106), s.strike_price, s.option_type 	,
	turn = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Turnover_tax = 1 then sum(s.turn_tax) else 0 end)else 0 end),
	sebi = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Sebi_Turn_tax = 1 then sum(s.sebi_tax) else 0 end)else 0 end),
	insc = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Insurance_Chrg = 1 then sum(s.Ins_chrg) else 0 end)else 0 end),
	other = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Other_chrg = 1 then sum(s.other_chrg) else 0 end)else 0 end),
	Brokertax = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.BrokerNote = 1 then sum(s.Broker_chrg) else 0 end)else 0 end),
	c1.trader,s.reserved1
	from fosettlement s , client1 c1, client2 c2, branches b
	where s.party_code = c2.party_code
	and c1.cl_code = c2.cl_code
	and b.branch_cd=@statusname
	and b.short_name=c1.trader
	and s.branch_id  between @fparty and @tparty /*like ltrim(@code)+'%'*/
	and convert(varchar,s.sauda_date,106) = @sdate
	AND s.TRADEQTY <> '0'  
	group by s.branch_id, billno, trade_no, sauda_date,s.sell_buy,  c1.short_name, c1.trader, s.user_id,
	c1.Res_Phone1 , s.service_tax, s.price, s.tradeqty, s.brokapplied, c2.service_chrg, s.nbrokapp, 
	c1.cl_code ,c1.off_phone1,s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price, 
	s.option_type, c2.Turnover_tax,c2.Sebi_Turn_tax ,c2.Insurance_Chrg,c2.Other_chrg, c2.BrokerNote, c1.trader,s.reserved1
	order by s.branch_id, s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price,
	s.option_type
end
if @statusid='subbroker'
begin
	SELECT s.branch_id as party_code, tm=convert(varchar,sauda_date,108),s.user_id,
	tdate=convert(varchar,sauda_date,103),  s.trade_no,convert(varchar,s.sauda_date,103) as sauda_date, 
	sdt = convert(VARchar,sauda_date,103),
	s.sell_buy, service_tax = isnull(s.service_tax,0),
	pqty=isnull((case sell_buy when 1 then s.tradeqty end),0),
	sqty=isnull((case sell_buy when 2 then s.tradeqty end),0),
	prate=isnull((case sell_buy when 1 then s.price end),0),
	srate=isnull((case sell_buy when 2 then s.price end),0),
	pbrok=isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	sbrok=abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	pnetrate=s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	snetrate=s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0))), 
	pamt=s.tradeqty * (s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	samt=s.tradeqty * (s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)))), 
	Brokerage=isnull(tradeqty*convert(numeric(9,2),brokapplied),0) ,
	NewBrokerage =isnull(tradeqty*convert(numeric(9,2),nbrokapp),0), 
	c1.short_name, c1.trader, c1.Res_Phone1, c2.service_chrg, c1.cl_code, c1.off_phone1,
	s.inst_type, s.symbol, expirydate = convert(varchar,s.expirydate,106), s.strike_price, s.option_type 	,
	turn = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Turnover_tax = 1 then sum(s.turn_tax) else 0 end)else 0 end),
	sebi = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Sebi_Turn_tax = 1 then sum(s.sebi_tax) else 0 end)else 0 end),
	insc = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Insurance_Chrg = 1 then sum(s.Ins_chrg) else 0 end)else 0 end),
	other = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Other_chrg = 1 then sum(s.other_chrg) else 0 end)else 0 end),
	Brokertax = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.BrokerNote = 1 then sum(s.Broker_chrg) else 0 end)else 0 end),
	c1.trader,s.reserved1
	from fosettlement s , client1 c1, client2 c2, subbrokers sb
	where s.party_code = c2.party_code
	and c1.cl_code = c2.cl_code
	and sb.sub_broker=c1.sub_broker
	and sb.sub_broker=@statusname
	and s.branch_id  between @fparty and @tparty  /* like ltrim(@code)+'%'*/
	and convert(varchar,s.sauda_date,106) = @sdate
	AND s.TRADEQTY <> '0'  
	group by s.branch_id, billno, trade_no, sauda_date,s.sell_buy,  c1.short_name, c1.trader, s.user_id,
	c1.Res_Phone1 , s.service_tax, s.price, s.tradeqty, s.brokapplied, c2.service_chrg, s.nbrokapp, 
	c1.cl_code ,c1.off_phone1,s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price, 
	s.option_type, c2.Turnover_tax,c2.Sebi_Turn_tax ,c2.Insurance_Chrg,c2.Other_chrg, c2.BrokerNote, c1.trader,s.reserved1
	order by s.branch_id, s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price,
	s.option_type
end
if @statusid='trader'
begin
	SELECT s.branch_id as party_code, tm=convert(varchar,sauda_date,108),s.user_id,
	tdate=convert(varchar,sauda_date,103),  s.trade_no,convert(varchar,s.sauda_date,103) as sauda_date, 
	sdt = convert(VARchar,sauda_date,103),
	s.sell_buy, service_tax = isnull(s.service_tax,0),
	pqty=isnull((case sell_buy when 1 then s.tradeqty end),0),
	sqty=isnull((case sell_buy when 2 then s.tradeqty end),0),
	prate=isnull((case sell_buy when 1 then s.price end),0),
	srate=isnull((case sell_buy when 2 then s.price end),0),
	pbrok=isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	sbrok=abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	pnetrate=s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	snetrate=s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0))), 
	pamt=s.tradeqty * (s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	samt=s.tradeqty * (s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)))), 
	Brokerage=isnull(tradeqty*convert(numeric(9,2),brokapplied),0) ,
	NewBrokerage =isnull(tradeqty*convert(numeric(9,2),nbrokapp),0), 
	c1.short_name, c1.trader, c1.Res_Phone1, c2.service_chrg, c1.cl_code, c1.off_phone1,
	s.inst_type, s.symbol, expirydate = convert(varchar,s.expirydate,106), s.strike_price, s.option_type 	,
	turn = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Turnover_tax = 1 then sum(s.turn_tax) else 0 end)else 0 end),
	sebi = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Sebi_Turn_tax = 1 then sum(s.sebi_tax) else 0 end)else 0 end),
	insc = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Insurance_Chrg = 1 then sum(s.Ins_chrg) else 0 end)else 0 end),
	other = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Other_chrg = 1 then sum(s.other_chrg) else 0 end)else 0 end),
	Brokertax = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.BrokerNote = 1 then sum(s.Broker_chrg) else 0 end)else 0 end)	from fosettlement s , client1 c1, client2 c2,
	c1.trader,s.reserved1
	where s.party_code = c2.party_code
	and c1.cl_code = c2.cl_code
	and c1.trader=@statusname  
	and s.branch_id  between @fparty and @tparty /*like ltrim(@code)+'%'*/
	and convert(varchar,s.sauda_date,106) = @sdate
	AND s.TRADEQTY <> '0'  
	group by s.branch_id, billno, trade_no, sauda_date,s.sell_buy,  c1.short_name, c1.trader, s.user_id,
	c1.Res_Phone1 , s.service_tax, s.price, s.tradeqty, s.brokapplied, c2.service_chrg, s.nbrokapp, 
	c1.cl_code ,c1.off_phone1,s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price, 
	s.option_type, c2.Turnover_tax,c2.Sebi_Turn_tax ,c2.Insurance_Chrg,c2.Other_chrg, c2.BrokerNote, c1.trader,s.reserved1
	order by s.branch_id, s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price,
	s.option_type
end
if @statusid='client'
begin
	SELECT s.branch_id as party_code, tm=convert(varchar,sauda_date,108),s.user_id,
	tdate=convert(varchar,sauda_date,103),  s.trade_no,convert(varchar,s.sauda_date,103) as sauda_date, 
	sdt = convert(VARchar,sauda_date,103),
	s.sell_buy, service_tax = isnull(s.service_tax,0),
	pqty=isnull((case sell_buy when 1 then s.tradeqty end),0),
	sqty=isnull((case sell_buy when 2 then s.tradeqty end),0),
	prate=isnull((case sell_buy when 1 then s.price end),0),
	srate=isnull((case sell_buy when 2 then s.price end),0),
	pbrok=isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	sbrok=abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	pnetrate=s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	snetrate=s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0))), 
	pamt=s.tradeqty * (s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	samt=s.tradeqty * (s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)))), 
	Brokerage=isnull(tradeqty*convert(numeric(9,2),brokapplied),0) ,
	NewBrokerage =isnull(tradeqty*convert(numeric(9,2),nbrokapp),0), 
	c1.short_name, c1.trader, c1.Res_Phone1, c2.service_chrg, c1.cl_code, c1.off_phone1,
	s.inst_type, s.symbol, expirydate = convert(varchar,s.expirydate,106), s.strike_price, s.option_type 	,
	turn = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Turnover_tax = 1 then sum(s.turn_tax) else 0 end)else 0 end),
	sebi = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Sebi_Turn_tax = 1 then sum(s.sebi_tax) else 0 end)else 0 end),
	insc = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Insurance_Chrg = 1 then sum(s.Ins_chrg) else 0 end)else 0 end),
	other = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Other_chrg = 1 then sum(s.other_chrg) else 0 end)else 0 end),
	Brokertax = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.BrokerNote = 1 then sum(s.Broker_chrg) else 0 end)else 0 end)	from fosettlement s , client1 c1, client2 c2,
	c1.trader,s.reserved1
	where s.party_code = c2.party_code
	and c1.cl_code = c2.cl_code
	and c2.party_code= @statusname
	and s.branch_id  between @fparty and @tparty  /*like ltrim(@code)+'%'*/
	and convert(varchar,s.sauda_date,106) = @sdate
	AND s.TRADEQTY <> '0'  
	group by s.branch_id, billno, trade_no, sauda_date,s.sell_buy,  c1.short_name, c1.trader, s.user_id,
	c1.Res_Phone1 , s.service_tax, s.price, s.tradeqty, s.brokapplied, c2.service_chrg, s.nbrokapp, 
	c1.cl_code ,c1.off_phone1,s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price, 
	s.option_type, c2.Turnover_tax,c2.Sebi_Turn_tax ,c2.Insurance_Chrg,c2.Other_chrg, c2.BrokerNote, c1.trader,s.reserved1
	order by s.branch_id, s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price,
	s.option_type
end
if @statusid='family'
begin
	SELECT s.branch_id as party_code, tm=convert(varchar,sauda_date,108),s.user_id,
	tdate=convert(varchar,sauda_date,103),  s.trade_no,convert(varchar,s.sauda_date,103) as sauda_date, 
	sdt = convert(VARchar,sauda_date,103),
	s.sell_buy, service_tax = isnull(s.service_tax,0),
	pqty=isnull((case sell_buy when 1 then s.tradeqty end),0),
	sqty=isnull((case sell_buy when 2 then s.tradeqty end),0),
	prate=isnull((case sell_buy when 1 then s.price end),0),
	srate=isnull((case sell_buy when 2 then s.price end),0),
	pbrok=isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	sbrok=abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	pnetrate=s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0), 
	snetrate=s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0))), 
	pamt=s.tradeqty * (s.price+isnull((case sell_buy when 1 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)), 
	samt=s.tradeqty * (s.price-(abs(isnull((case sell_buy when 2 then round(s.brokapplied + (case when c2.service_chrg=1 then (s.service_tax/s.tradeqty) else 0 end),2) end),0)))), 
	Brokerage=isnull(tradeqty*convert(numeric(9,2),brokapplied),0) ,
	NewBrokerage =isnull(tradeqty*convert(numeric(9,2),nbrokapp),0), 
	c1.short_name, c1.trader, c1.Res_Phone1, c2.service_chrg, c1.cl_code, c1.off_phone1,
	s.inst_type, s.symbol, expirydate = convert(varchar,s.expirydate,106), s.strike_price, s.option_type 	,
	turn = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Turnover_tax = 1 then sum(s.turn_tax) else 0 end)else 0 end),
	sebi = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Sebi_Turn_tax = 1 then sum(s.sebi_tax) else 0 end)else 0 end),
	insc = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Insurance_Chrg = 1 then sum(s.Ins_chrg) else 0 end)else 0 end),
	other = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.Other_chrg = 1 then sum(s.other_chrg) else 0 end)else 0 end),
	Brokertax = (case when (select dispcharge from foowner where dispcharge = 1) = 1 then (case when c2.BrokerNote = 1 then sum(s.Broker_chrg) else 0 end)else 0 end)	from fosettlement s , client1 c1, client2 c2,
	c1.trader,s.reserved1
	where s.party_code = c2.party_code
	and c1.cl_code = c2.cl_code
	and c1.family=@statusname
	and s.branch_id  between @fparty and @tparty /* like ltrim(@code)+'%'*/
	and convert(varchar,s.sauda_date,106) = @sdate
	AND s.TRADEQTY <> '0'  
	group by s.branch_id, billno, trade_no, sauda_date,s.sell_buy,  c1.short_name, c1.trader, s.user_id,
	c1.Res_Phone1 , s.service_tax, s.price, s.tradeqty, s.brokapplied, c2.service_chrg, s.nbrokapp, 
	c1.cl_code ,c1.off_phone1,s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price, 
	s.option_type, c2.Turnover_tax,c2.Sebi_Turn_tax ,c2.Insurance_Chrg,c2.Other_chrg, c2.BrokerNote, c1.trader,s.reserved1
	order by s.branch_id, s.inst_type, s.symbol, convert(varchar,s.expirydate,106), s.strike_price,
	s.option_type
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_folistclientpcm
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_folistclientpcm    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_folistclientpcm    Script Date: 1/24/02 3:41:34 PM ******/
CREATE PROCEDURE rpt_folistclientpcm
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid='broker'
  begin
    select distinct "<option value="+rtrim(branch_id)+">"+rtrim(branch_id)+"</option>" , branch_id
    from fosettlement  
    order by branch_id
  end
if @statusid='branch'
  begin
    select distinct "<option value="+rtrim(fo.branch_id)+">"+rtrim(fo.branch_id)+"</option>" , fo.branch_id
    from fosettlement fo,client2 c2, client1 c1, branches b
    where ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader)) and
	  ltrim(rtrim(b.branch_cd)) = ltrim(rtrim(@statusname))
    order by fo.branch_id
  end 	
if @statusid='subbroker'
  begin
    select distinct "<option value="+rtrim(fo.branch_id)+">"+rtrim(fo.branch_id)+"</option>" , fo.branch_id
    from fosettlement fo,client2 c2,client1 c1,subbrokers sb
    where ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(@statusname)) and
	  ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker))
	  order by fo.branch_id
  end 
if @statusid='trader'
  begin
    select distinct "<option value="+rtrim(fo.branch_id)+">"+rtrim(fo.branch_id)+"</option>" , fo.branch_id
    from fosettlement fo,client2 c2, client1 c1
    where ltrim(rtrim(c1.trader))  = ltrim(rtrim(@statusname))  
    order by fo.branch_id
  end	
if @statusid='client'
  begin
    select distinct "<option value="+rtrim(fo.branch_id)+">"+rtrim(fo.branch_id)+"</option>" , fo.branch_id
    from fosettlement fo
	order by fo.branch_id
  end
if @statusid='family'
  begin
    select distinct "<option value="+rtrim(fo.branch_id)+">"+rtrim(fo.branch_id)+"</option>" , fo.branch_id
    from fosettlement fo,client2 c2, client1 c1
    where ltrim(rtrim(c1.family))  = ltrim(rtrim(@statusname))
    order by fo.branch_id
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fosettno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 01/04/1980 1:40:41 AM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 11/28/2001 12:23:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 9/7/2001 6:05:58 PM ******/
CREATE PROCEDURE rpt_fosettno
/*@settno varchar(7),*/
@code varchar(10),
@sdate varchar(12),
@tdate varchar(12)
AS
/*select distinct left(convert(varchar,l.vdt,109),11) as vdt,l3.narr 
from ledger3 l3 ,ledger l
where l.vtyp = l3.vtyp
and l.vno = l3.vno
and narr like '%' + ltrim(@settno)+'%'
*/
/*select distinct left(convert(varchar,l.vdt,109),11) as vdt,l3.narr 
from ledger3 l3 ,ledger l
where l.vtyp = l3.vtyp
and l.vno = l3.vno
and narr like '%' + ltrim(@settno)+'%'
and cltcode = @code
and left(convert(varchar,vdt,109),11) = @sdate
*/
select distinct convert(varchar,l.vdt,106) as vdt,l3.narr 
from ledger3 l3 ,ledger l
where l.vtyp = l3.vtyp
and l.vno = l3.vno
and narr like '%NSEFO%'
and l3.vtyp = 15
and cltcode = @code
and convert(varchar,vdt,106) >= @sdate
and convert(varchar,vdt,106) <= @tdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_lastopentry
-- --------------------------------------------------




/****** Object:  Stored Procedure dbo.rpt_lastopentry    Script Date: 01/14/2002 20:39:22 ******/

/****** Object:  Stored Procedure dbo.rpt_lastopentry    Script Date: 01/04/1980 1:40:41 AM ******/



/****** Object:  Stored Procedure dbo.rpt_lastopentry    Script Date: 11/28/2001 12:23:50 PM ******/



/*
This query is used if opening entry for current yr is not found
this query gives us the latest opeing entry date
*/
CREATE procedure rpt_lastopentry
@sdtcur datetime
as
select   isnull(left((convert(varchar,max(vdt),109)),11),'') from  ledger where vtyp='18' and
vdt < @sdtcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ledbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_ledbal    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_ledbal    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledbal    Script Date: 01/18/2002 1:38:13 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledbal    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledbal    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : cheques
    file: todayscheques.asp
*/
/* displays ledger balance of a client till a particular date */
CREATE PROCEDURE rpt_ledbal
@vdt smalldatetime,
@partycode varchar(10)
 AS
select l.cltcode,amount=isnull(((select sum(l1.vamt) from ledger l1 where l1.drcr='d' and l.cltcode=l1.cltcode 
and l1.vdt <= @vdt + ' 23:59:59' 
group by l1.cltcode ,l1.drcr ) -
(select sum(l1.vamt) from ledger l1 where l1.drcr='c' and l.cltcode=l1.cltcode and l1.vdt <= @vdt + ' 23:59:59'
 group by l1.cltcode, l1.drcr)),0) from ledger l where l.vdt <= @vdt + ' 23:59:59'  /* put spaces before 23:59:59 */
and l.cltcode=@partycode
group by l.cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ledgerbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_ledgerbal    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_ledgerbal    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledgerbal    Script Date: 01/18/2002 1:38:13 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledgerbal    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledgerbal    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : confirmation report
   file : tconfirmationreport.asp
 */
/* displays ledger balances of all accounts of a particular client till today */
CREATE PROCEDURE rpt_ledgerbal
@clcode varchar(6)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0), 
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) from ledger, ncdx.dbo.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM ncdx.dbo.CLIENT2 
WHERE CL_CODE=@clcode)and cltcode=party_code 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ledgerclientdet
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_ledgerclientdet    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_ledgerclientdet    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledgerclientdet    Script Date: 01/18/2002 1:38:13 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledgerclientdet    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_ledgerclientdet    Script Date: 20-Mar-01 11:43:35 PM ******/
/*Changed by sheetal on 24 jan 2001*/
/*Removed refno and used voucher type , no line no, drcr*/
/* report : confirmation report 
   file : tconfirmationreport.asp
*/
/* finds ledger detalied ledger of a partycode till date */
CREATE PROCEDURE rpt_ledgerclientdet
@cltcode varchar(10)
AS
select convert(varchar,VDT,103), vtyp,vno,lno,drcr,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc, 
nar=isnull((select l3.narr from ledger3 l3 where l3.vtyp = ledger.vtyp and l3.vno = ledger.vno ),'') 
from ledger ,vmast
WHERE VDT <= getdate()+ '11:59PM'and CLTCODE=@cltcode and ledger.vtyp=vmast.vtype 
order by vdt, drcr,vtyp 
/*select convert(varchar,VDT,103), refno, vtyp,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc, 
nar=isnull((select l3.narr from ledger3 l3 
where l3.refno=left(ledger.refno,7)),'') from ledger ,vmast
WHERE VDT <= getdate()+ '11:59PM'and CLTCODE=@cltcode and ledger.vtyp=vmast.vtype 
order by vdt, drcr,vtyp */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_marginledger1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_marginledger1    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_marginledger1    Script Date: 02/04/2002 9:59:45 PM ******/
CREATE PROCEDURE rpt_marginledger1
AS
select distinct party_code 
from marginledger
order by party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_marginledger2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 09/10/2001 6:29:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 09/07/2001 10:46:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 9/7/2001 6:05:58 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 08/10/2001 5:05:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger2    Script Date: 7/18/2001 6:24:05 PM ******/
create PROCEDURE rpt_marginledger2
@partycode varchar(10),
@fdate varchar(12),
@tdate varchar(12)
AS
select amount , drcr, left(convert(varchar,vdt,109),11) as vdt, party_code, v.vdesc, v.vtype,YEAR(VDT),MONTH(VDT),DAY(VDT)
from marginledger m, vmast v
where m.vtyp  = v.vtype
and party_code like ltrim(@partycode)
and m.exchange = 'NSE'
and segment like 'F%'
and vdt >= ltrim(@fdate)
and vdt <= ltrim(@tdate) + ' 23:59'
order by party_code, YEAR(VDT),MONTH(VDT),DAY(VDT)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_marginledger3
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 09/10/2001 6:29:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 09/07/2001 10:46:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 9/7/2001 6:05:59 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 08/10/2001 5:05:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 7/18/2001 6:24:05 PM ******/
CREATE PROCEDURE rpt_marginledger3
AS
select distinct left(convert(varchar,vdt,109),11) ,year(vdt),month(vdt),day(vdt) 
from marginledger
order by 2,3,4

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_marginledger3_desc
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_marginledger3_desc    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_marginledger3_desc    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 09/10/2001 6:29:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 09/07/2001 10:46:12 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 9/7/2001 6:05:59 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 08/10/2001 5:05:20 PM ******/
/****** Object:  Stored Procedure dbo.rpt_marginledger3    Script Date: 7/18/2001 6:24:05 PM ******/
CREATE PROCEDURE rpt_marginledger3_desc
AS
select distinct left(convert(varchar,vdt,109),11) ,year(vdt),month(vdt),day(vdt) 
from marginledger
order by 2 desc,3 desc,4 desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_mtomacc
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_mtomacc    Script Date: 1/17/2004 11:39:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_mtomacc    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtomacc    Script Date: 01/18/2002 1:38:13 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtomacc    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtomacc    Script Date: 20-Mar-01 11:43:35 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtomacc    Script Date: 3/6/01 2:39:07 PM ******/
CREATE PROCEDURE rpt_mtomacc
@clcode varchar(6)
AS
SELECT  dramt=isnull((case drcr when 
'd' then SUM(vamt)end),0), cramt=isnull((case drcr when 
'c' then SUM(vamt)end),0) 
from ledger, ncdx.dbo.client2 
where cltcode in (SELECT DISTINCT PARTY_CODE FROM ncdx.dbo.CLIENT2 
WHERE CL_CODE = @clcode)and cltcode=party_code 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_mtombal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_mtombal    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_mtombal    Script Date: 02/04/2002 9:59:45 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtombal    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtombal    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_mtombal    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : newmtom report  
   file : mtomtablefill.asp 
*/
/* calculates debit and credit amounts for a particular client code */
CREATE PROCEDURE rpt_mtombal
@clcode varchar(6)
AS
select dramt=isnull((case drcr when 'd' then SUM(vamt)end),0),
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0)  
from ledger where cltcode in 
(SELECT PARTY_CODE FROM ncdx.dbo.CLIENT2 WHERE CL_CODE = @clcode)
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_newbdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_newbdrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_newbdrcr    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_newbdrcr    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_newbdrcr    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_newbdrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/*  report : branchaccounts
    file : branchturn.asp   
*/
/* calculates balances of branchwise all client's accounts */      
/*
old query
rpt_bdrcr
if @statusid='broker' 
begin
select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
group by  b.branch_cd,l.Cltcode
ORDER BY b.branch_cd
end 
if @statusid='branch' 
begin
select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@statusname
group by  b.branch_cd,l.Cltcode
ORDER BY b.branch_cd
end 
*/
CREATE PROCEDURE rpt_newbdrcr 
@statusid varchar(15),
@statusname varchar(25)
AS
	if @statusid='broker'
	begin
		select b.branch_cd,Cltcode,Amount=Sum(DAmt)-Sum(CAmt) from LedgerDrCrView l,ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.branches b
		where C2.Party_Code = l.CltCode and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
		Group By b.branch_cd,CltCode
		ORDER BY B.Branch_Cd,cltcode
	end
	if @statusid='branch'
	begin
		select b.branch_cd,Cltcode,Amount=Sum(DAmt)-Sum(CAmt) from LedgerDrCrView l,ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.branches b
		where C2.Party_Code = l.CltCode and c1.cl_code=c2.cl_code and c1.trader=b.short_name 
		and b.branch_cd=@statusname
		Group By b.branch_cd,CltCode
		ORDER BY B.Branch_Cd,cltcode
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Newcashbookprinting
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_Newcashbookprinting    Script Date: 1/17/2004 11:39:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_Newcashbookprinting    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.rpt_Newcashbookprinting    Script Date: 11/28/2001 12:23:50 PM ******/
/****** Object:  Stored Procedure dbo.rpt_Newcashbookprinting    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 08/24/2001 7:43:56 AM ******/
/****** Object:  Stored Procedure dbo.rpt_cashbookprinting    Script Date: 08/13/2001 6:16:53 AM ******/
CREATE PROCEDURE rpt_Newcashbookprinting
@cltcode  as varchar(10),
@fromdate as datetime,
@todate as datetime, 
@vdtedtflag as integer
AS
IF @vdtedtflag = 0 
BEGIN
          	SELECT convert(varchar,l.vdt,103),isnull(a.longname,''),L.VNO1,L.VNO,
           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
	balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
           	/*Narration = isnull((select l3.narr from ledger3 l3 where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.lno = l3.naratno),'')*/
	Narration = (case when (select l3.narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno= l.lno ) is not null 
		      then (select l3.narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno= l.lno)
		      else (select l3.narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno )
		     end )
           	FROM LEDGER L,acmast a 
           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
           	AND L.CLTCODE <> @cltcode
           	and l.vdt >= @fromdate 
           	and l.vdt <= @todate  
           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
           	ORDER BY L.VDT,L.VTYP,L.VNO
END
ELSE IF @vdtedtflag = 1
BEGIN
            SELECT convert(varchar,l.edt,103),isnull(a.longname,''),L.VNO1,L.VNO,
           	Debit = (Case When l.DRCR = 'c' Then  Vamt  Else  0 End),
           	Credit = (Case When l.DRCR='d' Then  Vamt   Else  0 End),
	balamt = (Select sum(balamt) from ledger l1 where cltcode=@cltcode and l.vno=l1.vno and l.vtyp=l1.vtyp),
           	/*Narration = isnull((select l3.narr from ledger3 l3 where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.lno = l3.naratno),'')*/
	Narration = (case when (select l3.narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno= l.lno ) is not null 
		      then (select l3.narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno= l.lno)
		      else (select l3.narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno )
		     end )
           	FROM LEDGER L,acmast a 
           	WHERE L.VTYP IN (SELECT VTYP FROM LEDGER WHERE CLTCODE = @cltcode AND VNO = L.VNO )
           	AND L.CLTCODE <> @cltcode
           	and l.edt >= @fromdate 
           	and l.edt <= @todate  
           	AND l.VTYP <> 18 and a.cltcode=l.cltcode 
           	ORDER BY L.EDT,L.VTYP,L.VNO	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_payindetails
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_payindetails    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_payindetails    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_payindetails    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_payindetails    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_payindetails    Script Date: 12/25/2001 3:04:05 PM ******/
/****** Object:  Stored Procedure dbo.rpt_payindetails    Script Date: 12/11/01 9:43:45 PM ******/
CREATE procedure rpt_payindetails
@dt varchar(12),
@branchcd varchar(10)
as
if @branchcd = ''
begin
select ledger.cltcode,ledger.acname,ledger.drcr,vamt = (case when drcr = 'c' then vamt * -1 else vamt end),edt,left(convert(varchar,edt,109),11),
a.accat,c2.cl_code,c1.branch_cd,b.branch,ledger.vdt
from ledger,acmast a,ncdx.dbo.client1 c1,ncdx.dbo.client2 c2,ncdx.dbo.branch b
where /*ledger.vtyp = 15 
and*/ edt >= left(convert(varchar,@dt,109),11) 
and vdt <= @dt + ' 23:59:59'
and ltrim(ledger.cltcode) = ltrim(a.cltcode)
and ltrim(ledger.cltcode) = ltrim(c2.party_code)
and ltrim(c2.cl_code) = ltrim(c1.cl_code)
and ltrim(c1.branch_cd) = ltrim(b.branch_code)
order by b.branch_code,ledger.cltcode,ledger.edt
end 
if @branchcd <>''
begin
select ledger.cltcode,ledger.acname,ledger.drcr,vamt = (case when drcr = 'c' then vamt * -1 else vamt end),edt,left(convert(varchar,edt,109),11),
a.accat,c2.cl_code,c1.branch_cd,b.branch,ledger.vdt
from ledger,acmast a,ncdx.dbo.client1 c1,ncdx.dbo.client2 c2,ncdx.dbo.branch b
where /*ledger.vtyp = 15 
and*/ edt >= left(convert(varchar,@dt,109),11) 
and vdt <= @dt + ' 23:59:59'
and ltrim(ledger.cltcode) = ltrim(a.cltcode)
and ltrim(ledger.cltcode) = ltrim(c2.party_code)
and ltrim(c2.cl_code) = ltrim(c1.cl_code)
and ltrim(c1.branch_cd) = ltrim(b.branch_code)
and ltrim(c1.branch_cd) like @branchcd
order by b.branch_code,ledger.cltcode,ledger.edt
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_sbclientlist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_sbclientlist    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_sbclientlist    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_sbclientlist    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_sbclientlist    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_sbclientlist    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : subbrokacc
   file : clients.asp
*/
/* displays list of clients and their balances */
CREATE PROCEDURE rpt_sbclientlist
@statusid varchar(15),
@statusname varchar(25),
@subbroker varchar(50)
AS
	if @statusid='broker'
	begin
		select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
		- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
		where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.sub_broker=sb.sub_broker and sb.sub_broker=@subbroker
		group by  c1.cl_code,l.Cltcode
	end
	if @statusid='subbroker'
	begin
		select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
		- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
		where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.sub_broker=sb.sub_broker and sb.sub_broker=@statusname
		group by  c1.cl_code,l.Cltcode
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_sbnewdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_sbnewdrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_sbnewdrcr    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_sbnewdrcr    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_sbnewdrcr    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_sbnewdrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report: subbrokacc 
   file : sbturn.asp
*/
CREATE PROCEDURE rpt_sbnewdrcr
@statusid varchar(15),
@statusname varchar(25)
AS
	if @statusid='broker'
	begin
		select  sb.sub_broker,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
		- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
		where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker
		group by  sb.sub_broker,l.Cltcode
		ORDER BY sb.sub_broker
	end 
	if @statusid='subbroker'
	begin
		select  sb.sub_broker,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
		- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
		ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
		where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker
		and sb.sub_broker=@statusname
		group by  sb.sub_broker,l.Cltcode
		ORDER BY sb.sub_broker
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_shortname
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_shortname    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_shortname    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_shortname    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_shortname    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_shortname    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : traderledger
   file : allparty.asp
*/
/* displays short name of a particular party code*/
CREATE PROCEDURE rpt_shortname
@clcode varchar(7)
AS
select distinct short_name from ncdx.dbo.client1 where cl_code=@clcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_singleclientdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_singleclientdrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_singleclientdrcr    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_singleclientdrcr    Script Date: 01/18/2002 1:38:14 PM ******/
/****** Object:  Stored Procedure dbo.rpt_singleclientdrcr    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_singleclientdrcr    Script Date: 20-Mar-01 11:43:35 PM ******/
/* report : confirmation report
   file : tconfirmation.asp
   report : traderledger
   file :  singleparty.asp
*/
/* calculates debit and credit of a partycode from ledger till today*/
CREATE PROCEDURE rpt_singleclientdrcr
@cltcode varchar(10)
AS
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), 
crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= getdate() + '11:59PM' and 
CLTCODE=@cltcode 
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_traderpos
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_traderpos    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_traderpos    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderpos    Script Date: 01/18/2002 1:38:15 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderpos    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderpos    Script Date: 20-Mar-01 11:43:36 PM ******/
/* report : branchacc 
   file :   trader.asp
   displays list of traders under a particular branch  
*/
   
CREATE PROCEDURE rpt_traderpos
@br varchar(15)
 AS
/*
select  l.Cltcode,c1.cl_code, C1.TRADER ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by  C1.TRADER,c1.cl_code,l.Cltcode
ORDER BY C1.TRADER,c1.cl_code
*/
select  l.Cltcode,c1.cl_code, C1.TRADER ,Amount=Sum(DAmt)-Sum(CAmt) from LedgerDrCrView l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by  C1.TRADER,c1.cl_code,l.Cltcode
ORDER BY C1.TRADER,c1.cl_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_traderwise2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_traderwise2    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_traderwise2    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwise2    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwise2    Script Date: 2/17/01 5:19:55 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwise2    Script Date: 3/21/01 12:50:24 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwise2    Script Date: 20-Mar-01 11:39:04 PM ******/
/*Modified by amolika on 1st march'2001 : removed ncdx.dbo. & added accountncdx.dbo. to all account tables*/
/* report : traderwise ledger
    file : traderwise.asp
 */
/* displays list of short names as per the selection made by user */
CREATE PROCEDURE rpt_traderwise2
@statusid varchar(15),
@statusname varchar(25),
@trader varchar(15)
AS
if @statusid = 'broker' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM CLIENT1 C1, CLIENT2 C2, accountncdx.dbo.ledger l
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C2.party_code
end
if @statusid = 'branch' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM CLIENT1 C1,  CLIENT2 C2, accountncdx.dbo.ledger l, branches b
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode and
b.branch_cd=@statusname and b.short_name=c1.trader
ORDER BY C2.party_code
end
if @statusid = 'trader' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM CLIENT1 C1,  CLIENT2 C2, accountncdx.dbo.ledger l
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C2.party_code
end 
if @statusid = 'subbroker' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM  CLIENT1 C1,  CLIENT2 C2, accountncdx.dbo.ledger l,   subbrokers sb
WHERE C1.TRADER=@trader 
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
and sb.sub_broker=c1.sub_broker 
and sb.sub_broker=@statusname
ORDER BY C2.party_code
end 
if @statusid = 'client' 
begin
SELECT DISTINCT C1.CL_CODE, C2.PARTY_CODE
FROM CLIENT1 C1, CLIENT2 C2, accountncdx.dbo.ledger l
WHERE C1.TRADER=@trader and l.cltcode=@statusname
AND C1.CL_CODE=C2.CL_CODE and c2.party_code=l.cltcode 
ORDER BY C2.party_code
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_traderwiseclient
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_traderwiseclient    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_traderwiseclient    Script Date: 02/04/2002 9:59:46 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwiseclient    Script Date: 01/18/2002 1:38:15 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwiseclient    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_traderwiseclient    Script Date: 20-Mar-01 11:43:36 PM ******/
/* report : branchacc 
   file :  traderwiseclient.asp*/
/* displays balances of all accounts of a trader */
CREATE PROCEDURE rpt_traderwiseclient 
@statusid varchar(15),
@statusname varchar(25),
@trader varchar(15),
@branch varchar(7)
 AS
/*
if @statusid='branch'
begin
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@statusname
and c1.trader=@trader
group by  c1.cl_code,l.Cltcode
order by l.cltcode
end 
if @statusid='broker'
begin
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@branch
and c1.trader=@trader
group by  c1.cl_code,l.Cltcode
order by l.cltcode
end
*/
	if @statusid='broker'
	begin
		select CltCode,Cl_Code,Amount = sum(Pamt) - sum(Samt) from Rpt_TrdLedger
		where branch_cd = @branch  and trader = @trader
		group by CltCode,Cl_Code
		order by cltcode
	end
	if @statusid='branch'
	begin
		select CltCode,Cl_Code,Amount = sum(Pamt) - sum(Samt) from Rpt_TrdLedger
		where branch_cd = @statusname  and trader = @trader
		group by CltCode,Cl_Code
		order by cltcode
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_trialbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_trialbal    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_trialbal    Script Date: 02/04/2002 9:59:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbal    Script Date: 01/18/2002 1:38:15 PM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbal    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbal    Script Date: 20-Mar-01 11:43:36 PM ******/
/* report : trial balance
   file : trialbal.asp
*/
/* displays trial balance */
     
CREATE PROCEDURE rpt_trialbal 
@statusid varchar(15),
@statusname varchar(25),
@vdt varchar(10)
AS
	if @statusid = 'broker'
	begin
		select l.cltcode , clcode=isnull((select cl_code from ncdx.dbo.client2 c2 
		where c2.party_code=l.cltcode),''),l.acname, 
		Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
		and vdt <= @vdt + ' 23:59:59') - 
		(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
		From Ledger l where vdt <= @vdt + ' 23:59:59' 
		group by l.Cltcode, l.acname order by l.cltcode
	end 
	
	if @statusid = 'branch'
	begin
		select l.cltcode , clcode=isnull((select cl_code from ncdx.dbo.client2 c2 
		where c2.party_code=l.cltcode),''),l.acname, 
		Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
		and vdt <= @vdt + ' 23:59:59') - 
		(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
		From Ledger l, ncdx.dbo.branches b, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2
		where vdt <= @vdt + ' 23:59:59' 
		and b.branch_cd=@statusname
		and b.short_name=c1.trader
		and c1.cl_code=c2.cl_code
		and c2.party_code=l.cltcode
		group by l.Cltcode, l.acname 
	end 
	
	if @statusid = 'trader'
	begin
		select l.cltcode , clcode=isnull((select cl_code from ncdx.dbo.client2 c2 
		where c2.party_code=l.cltcode),''),l.acname, 
		Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
		and vdt <= @vdt + ' 23:59:59')- 
		(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
		From Ledger l,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2
		where vdt <= @vdt + ' 23:59:59' 
		and c1.trader=@statusname
		and c1.cl_code=c2.cl_code
		and c2.party_code=l.cltcode
		group by l.Cltcode, l.acname 
	end 
	if @statusid='subbroker'
	begin
		select l.cltcode , clcode=isnull((select cl_code from ncdx.dbo.client2 c2 
		where c2.party_code=l.cltcode),''),l.acname, 
		Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
		and vdt <= @vdt + ' 23:59:59')- 
		(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
		From Ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
		where vdt <= @vdt + ' 23:59:59' 
		and sb.sub_broker=@statusname
		and sb.sub_broker=c1.sub_broker
		and c1.cl_code=c2.cl_code
		and c2.party_code=l.cltcode
		group by l.Cltcode, l.acname 
	end
	if @statusid='client'
	begin
		select l.cltcode , clcode=isnull((select cl_code from ncdx.dbo.client2 c2 
		where c2.party_code=l.cltcode),''),l.acname, 
		Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode 
		and vdt <= @vdt + ' 23:59:59')- 
		(select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode and vdt <= @vdt + ' 23:59:59') 
		From Ledger l , ncdx.dbo.client1 C1, ncdx.dbo.client2 C2
		where vdt <= @vdt + ' 23:59:59' and
		c1.cl_code=c2.cl_code
		and c2.party_code=l.cltcode
		and l.cltcode=@statusname
		group by l.Cltcode, l.acname 
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_trialbaledt
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_trialbaledt    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_trialbaledt    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbaledt    Script Date: 11/28/2001 12:23:51 PM ******/
/* report : trial balance        file : trialbal.asp
 displays trial balance according to effective date */
/*removed rounding 
    changed by mousami on 26 sept 2001 
*/
/*
this query is executed only if opening entry date is not found
and sort by = effective date
*/
 
     
CREATE PROCEDURE rpt_trialbaledt 
@date datetime,
@flag varchar(15),
@viewoption varchar(10),
@balance varchar(10)
AS
if @flag='codewise' 
begin
	if @balance='normal'
	begin
		if @viewoption='all'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalalledt l
			 where edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='partywise'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBaledt l
			 where edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='gl'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgledt l
			 where edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
else if @balance='withopbal' 
		begin
			if @viewoption='all'
			begin
				select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
				Amount = Sum(DrAmt)-Sum(CrAmt),
				drtot = Sum(DrAmt),  			
				Crtot = Sum(CrAmt) 
	  			From Rpt_AccTrialBalalledt l
				 where edt <= @date + ' 23:59:59'  
	  			group by l.Cltcode , l.acname 
				order by  l.Cltcode , l.acname 
			end 
		if @viewoption='partywise'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBaledt l
			 where edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='gl'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalgledt l
			 where edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
	end
end
end
if @flag='namewise' 
begin
	if @balance='normal'
	begin
		if @viewoption='all'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalalledt l
			 where   edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 		end
		if @viewoption='partywise'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBaledt l
			where   edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 		end
		if @viewoption='gl'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgledt l
			  where   edt <= @date + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 		end
	end /* this end for query order by namewise */
	if @balance='withopbal'
	begin
		if @viewoption='all'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalalledt l
			 where   edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 		end
		if @viewoption='partywise'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBaledt l
			where   edt <= @date + ' 23:59:59'  
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 		end
		if @viewoption='gl'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalgledt l
			  where   edt <= @date + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 		end
	end /* this end for query order by namewise */
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_trialbaledt1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_trialbaledt1    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_trialbaledt1    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbaledt1    Script Date: 11/28/2001 12:23:51 PM ******/
/* report : trial balance        file : trialbal.asp
 displays trial balance according to effective date */
/*
this query is executed only if opening entry date is  found
and sort by = effective date
*/
/* changed by mousami on 29 sept 2001
     removed roudning */
 
     
CREATE PROCEDURE rpt_trialbaledt1 
@date datetime,
@openentrydate datetime,
@flag varchar(15),
@viewoption varchar(10),
@balance varchar(10)
AS
if @flag='codewise' 
begin
	if @balance ='normal'
	begin
		if @viewoption='all'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalalledt l
			 where edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='partywise'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBaledt l
			where edt <= @date + ' 23:59:59'  and edt>=@openentrydate
			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='gl'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgledt l
			where edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
	end
	else if @balance ='withopbal'
	begin
		if @viewoption='all'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalalledt l
			 where edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='partywise'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBaledt l
			where edt <= @date + ' 23:59:59'  and edt>=@openentrydate
			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
		if @viewoption='gl'
		begin
	 		select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalgledt l
			where edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
	end
end /* this end for query order by  codewise*/
if @flag='namewise' 
begin
	if @balance='normal'
	begin		
		if @viewoption='all'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalalledt l
			 where   edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
		end
			if @viewoption='partywise'
			begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBaledt l
			 where   edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
			end
			if @viewoption='gl'
			begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgledt l
			 where   edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
			end
 	end 
 	else if @balance='withopbal'
	begin		
		if @viewoption='all'
		begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalalledt l
			 where   edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
		end
			if @viewoption='partywise'
			begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBaledt l
			 where   edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
			end
			if @viewoption='gl'
			begin
			select l.cltcode , clcode=isnull((select cl_code from client2 c2 
 			where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalgledt l
			 where   edt <= @date + ' 23:59:59'  and edt>=@openentrydate
  			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
			end
		end
end /* this end for query order by namewise */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_trialbalvdt
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_trialbalvdt    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_trialbalvdt    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbalvdt    Script Date: 11/28/2001 12:23:51 PM ******/
/* report : trial balance        file : trialbal.asp
 displays trial balance */
/* changed by mousami on 18 oct 2001
     added option for user to see report either for party accounts or for general ledger or all accounts 
 */
/* changed by mousami on 29 sept 2001
     removed rounding
*/
/*
This procedure is executed when user selects sort by date = vdt and openig entry date does not exist
for the selected year
*/
  
CREATE PROCEDURE rpt_trialbalvdt
@vdt datetime,
@flag varchar(15),
@viewoption varchar(10),
@balance varchar(10)	
AS
/*-----------------------------------------------------------------------------If user wants to see trial balance codewise  ------------------------------------------------------------------------------------*/
if @flag='codewise' 
begin
/*-----------------------------------------------------------------------------If user wants to see trial balance with opening balance  ------------------------------------------------------------------------------------*/
	if @balance='withopbal'
	begin
/*-----------------------------------------------------------------------------If user wants to see trial balance for all accounts ------------------------------------------------------------------------------------*/
		if @viewoption = 'All' 
		begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
  	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
	  		drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalall l where  
			vdt <= @vdt + ' 23:59:59'  
	  		group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
/*-----------------------------------------------------------------------------If user wants to see trial balance for only party accounts ------------------------------------------------------------------------------------*/		
		else if @viewoption='Partywise' 
                                      begin		 
			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
  	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
	  		drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBal l where  
			vdt <= @vdt + ' 23:59:59'  
	  		group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 	                  end
/*-----------------------------------------------------------------------------If user wants to see trial balance for only general ledger  accounts ------------------------------------------------------------------------------------*/		
	           else if @viewoption = 'gl'
                              begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
  	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
	  		drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalgl l where  
			vdt <= @vdt + ' 23:59:59'  
	  		group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
 
	          end 		
/*-----------------------------------------------------------------------------If user wants to see trial balance without opening balance ------------------------------------------------------------------------------------*/		
	else if @balance='normal'
	begin
			if @viewoption = 'All' 
			begin
 				 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
  	 			 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  				Amount = Sum(DrAmt)-Sum(CrAmt)
	  			From Rpt_AccTrialBalall l where  
				vdt <= @vdt + ' 23:59:59'  
		  		group by l.Cltcode , l.acname 
				order by  l.Cltcode , l.acname 
			end 
/*-----------------------------------------------------------------------------If user wants to see trial balance for only party accounts ------------------------------------------------------------------------------------*/		
		else if @viewoption='Partywise' 
                                      begin		 
				 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
  		 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  				Amount = Sum(DrAmt)-Sum(CrAmt)
		  		From Rpt_AccTrialBal l where  
				vdt <= @vdt + ' 23:59:59'  
	  			group by l.Cltcode , l.acname 
				order by  l.Cltcode , l.acname 	                  end
/*-----------------------------------------------------------------------------If user wants to see trial balance for only general ledger  accounts ------------------------------------------------------------------------------------*/		
	           else if @viewoption = 'gl'
                              begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
  	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgl l where  
			vdt <= @vdt + ' 23:59:59'  
	  		group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
 
	          end 		
	end
	end /*of normal = balance */
end 
/*-----------------------------------------------------------------------------If user wants to see trial balance namewise ------------------------------------------------------------------------------------*/		
if @flag='namewise' 
begin
/*-----------------------------------------------------------------------------If user wants to see trial balance with opening balance  ------------------------------------------------------------------------------------*/
if @balance='withopbal'
begin
/*-----------------------------------------------------------------------------If user wants to see trial balance for all accounts ------------------------------------------------------------------------------------*/
	if @viewoption = 'all'
	begin 
	 		 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
		  	From Rpt_AccTrialBalall  l where vdt <= @vdt + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
	end
/*-----------------------------------------------------------------------------If user wants to see trial balance for only party accounts ------------------------------------------------------------------------------------*/
	else if @viewoption = 'partywise'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
		  	From Rpt_AccTrialBal  l where vdt <= @vdt + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 	end 
/*-----------------------------------------------------------------------------If user wants to see trial balance for general ledger ------------------------------------------------------------------------------------*/
	else if  @viewoption='gl'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
		  	From Rpt_AccTrialBalgl  l where vdt <= @vdt + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
	end
	else if  @balance='normal'
	begin
		if @viewoption = 'all'
		begin 
	 		 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt)
		  	From Rpt_AccTrialBalall  l where vdt <= @vdt + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
		end
/*-----------------------------------------------------------------------------If user wants to see trial balance for only party accounts ------------------------------------------------------------------------------------*/
	else if @viewoption = 'partywise'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt)
		  	From Rpt_AccTrialBal  l where vdt <= @vdt + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 	end 
/*-----------------------------------------------------------------------------If user wants to see trial balance for general ledger ------------------------------------------------------------------------------------*/
	else if  @viewoption='gl'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt)
			From Rpt_AccTrialBalgl  l where vdt <= @vdt + ' 23:59:59'  
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
	end
	end
              end  /* of normal balance */  		
	
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_trialbalvdt1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_trialbalvdt1    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_trialbalvdt1    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.rpt_trialbalvdt1    Script Date: 11/28/2001 12:23:51 PM ******/
/* report : trial balance        file : trialbal.asp
 displays trial balance */
/* changed by mousami on 29 sept 2001 removed rounding */
/*
This procedure is executed when user selects sort by date = vdt 
and opening entry date exists for selected year
*/
  
CREATE PROCEDURE rpt_trialbalvdt1
@vdt datetime,
@openentrydate datetime,
@flag varchar(15),
@viewoption varchar(10),
@balance varchar(10)
AS
if @flag='codewise' 
begin
/*--------------------------------------------------------------------------------if user wants to see trial balance without opening balance -------------------------------------------------------------------*/
if @balance='normal'
begin
/*--------------------------------------------------------------------------------if user wants to see trial balance for all accounts-------------------------------------------------------------------*/
	if @viewoption='All'	
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalall l
			where  vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
	end 
/*--------------------------------------------------------------------------------if user wants to see trial balance for parties only  -------------------------------------------------------------------*/
	else if @viewoption='partywise'
	begin 
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBal l
			where  vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
 	end 
 
/*--------------------------------------------------------------------------------if user wants to see report for general ledger---------------------------------------------------------------------------------------*/
	else if @viewoption='gl'
	begin 
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgl  l
			where  vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
	end /* this end for query order by  codewise*/
end /*of balance = 'normal'  */
else if @balance='withopbal' 
begin
		if @viewoption='All'	
		begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalall l
			where  vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end 
/*--------------------------------------------------------------------------------if user wants to see trial balance for parties only  -------------------------------------------------------------------*/
	else if @viewoption='partywise'
		begin 
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBal l
			where  vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
	 	end 
 
/*--------------------------------------------------------------------------------if user wants to see report for general ledger---------------------------------------------------------------------------------------*/
	else if @viewoption='gl'
		begin 
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
	  		Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt) 
	  		From Rpt_AccTrialBalgl  l
			where  vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
  			group by l.Cltcode , l.acname 
			order by  l.Cltcode , l.acname 
		end /* this end for query order by  codewise*/
end 
end
/*--------------------------------------------------------------------------------if user wants to see report namewise---------------------------------------------------------------------------------------*/
if @flag='namewise' 
begin
/*--------------------------------------------------------------------------------if user wants to see report without opening balance --------------------------------------------------------------------------------------*/
if @balance='normal'
begin
/*--------------------------------------------------------------------------------if user wants to see report for all accounts---------------------------------------------------------------------------------------*/
	if @viewoption='all'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalall l  where vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
	  		group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 
	end	
/*--------------------------------------------------------------------------------if user wants to see report for all accounts---------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------if user wants to see report for all party accounts---------------------------------------------------------------------------------------*/
	if @viewoption='partywise'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBal l
			where vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 	end 
/*--------------------------------------------------------------------------------if user wants to see report for all party accounts---------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------if user wants to see report for all general ledger accounts---------------------------------------------------------------------------------------*/
	if @viewoption='gl'
		begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt)
	  		From Rpt_AccTrialBalgl l
			where vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
	 	end 
end
else if @balance='withopbal'
begin
/*--------------------------------------------------------------------------------if user wants to see report for all accounts---------------------------------------------------------------------------------------*/
	if @viewoption='all'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt)
			From Rpt_AccTrialBalall l  where vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
	  		group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 
	end	
/*--------------------------------------------------------------------------------if user wants to see report for all accounts---------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------if user wants to see report for all party accounts---------------------------------------------------------------------------------------*/
	if @viewoption='partywise'
	begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt)
	  		From Rpt_AccTrialBal l
			where vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
 	end 
/*--------------------------------------------------------------------------------if user wants to see report for all party accounts---------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------if user wants to see report for all general ledger accounts---------------------------------------------------------------------------------------*/
	if @viewoption='gl'
		begin
 			 select l.cltcode , clcode=isnull((select cl_code from client2 c2 
	 		 where c2.party_code=l.cltcode),''),acname=isnull(l.acname,''), 
  			Amount = Sum(DrAmt)-Sum(CrAmt),
			drtot = Sum(DrAmt),  			
			Crtot = Sum(CrAmt)
	  		From Rpt_AccTrialBalgl l
			where vdt <= @vdt + ' 23:59:59'  and vdt >= @openentrydate 
			group by l.Cltcode , l.acname 
			order by  l.acname , l.Cltcode
	 	end 
end	
/*--------------------------------------------------------------------------------if user wants to see report for all general ledger accounts---------------------------------------------------------------------------------------*/
end /* this end for query order by namewise */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_voucherprinting
-- --------------------------------------------------


CREATE Proc [dbo].[Rpt_voucherprinting]
@Vtyp    Varchar(2), 
@Booktype    Varchar(2), 
@Fromdate   Varchar(11), 
@Todate   Varchar(11), 
@Vnofrom   Varchar(12), 
@Vnoto   Varchar(12)
As
Declare
 @@Selectqury   As Varchar(8000), 
 @@Fromtables   As Varchar(2000), 
 @@Wherepart    As Varchar(8000), 
 @@Sortby       As Varchar(200)
   If @Vnofrom <> '' And @Vnoto <> '' 
    Begin 
      -- Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  And L.Booktype = '" + @Booktype + "'
     Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  
      And L.Vno > = '" + @Vnofrom + "'  And L.Vno < = '" + @Vnoto + "'  
       And  L.Vdt > = '" + @Fromdate + " 00:00:00' And L.Vdt < = '" + @Todate +" 23:59:59' "
      
    End
   Else
    Begin
      -- Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  And L.Booktype = '" + @Booktype + "'
     Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "' 
       And  L.Vdt > = '" + @Fromdate + " 00:00:00' And L.Vdt < = '" + @Todate +" 23:59:59' "
    End       
   If @Vtyp = '2'  Or @Vtyp = '3' Or @Vtyp = '5'  Or @Vtyp = '16'  Or @Vtyp = '17'  Or @Vtyp =  '20'  Or @Vtyp = '19' Or  @Vtyp = '1' Or  @Vtyp = '4' Or  @Vtyp = '22' Or  @Vtyp = '23'  
   Begin
    Select @@Wherepart = @@Wherepart + "  And   Cltcode <> '" + @Booktype + "'" 
   End
   Else
   Begin
    Select @@Wherepart = @@Wherepart + "  And L.Booktype = '" + @Booktype + "'"
   End 
   Select @@Selectqury = " Select Distinct L.Vno, Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno, Vamt = Isnull(L.Vamt, 0), L.Drcr, 
   Cltcode,  Acname , 
   Isnull(L.Vamt, 0) Vamt,  L.Drcr,  L.Vtyp, L.Vno, L.Lno , L.Booktype, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, 
     Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno, Dddt  =  Convert(Varchar, Dddt, 103)  , 
     L.Narration, Cltcode2 = Cltcode, Acname2 = Acname "
   Select @@Fromtables = " From Ledger L Left Outer Join Ledger1 L1 On  L.Vtyp = L1.Vtyp And L.Booktype = L1.Booktype And L.Vno = L1.Vno And L.Lno = L1.Lno "
--   Select @@Sortby = " Order By L.Vdt, L.Vtyp, L.Booktype, L.Vno, L.Drcr Desc, L.Lno Desc "
    
 Print  (@@Selectqury + @@Fromtables + @@Wherepart + @@Sortby )
Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_voucherprinting_13072011
-- --------------------------------------------------


CREATE  Proc [dbo].[Rpt_voucherprinting_13072011]
@Vtyp    Varchar(2), 
@Booktype    Varchar(2), 
@Fromdate   Varchar(11), 
@Todate   Varchar(11), 
@Vnofrom   Varchar(12), 
@Vnoto   Varchar(12)
As
Declare
 @@Selectqury   As Varchar(8000), 
 @@Fromtables   As Varchar(2000), 
 @@Wherepart    As Varchar(8000), 
 @@Sortby       As Varchar(200)
   If @Vnofrom <> '' And @Vnoto <> '' 
    Begin 
      -- Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  And L.Booktype = '" + @Booktype + "'
     Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  
      And L.Vno > = '" + @Vnofrom + "'  And L.Vno < = '" + @Vnoto + "'  
       And  L.Vdt > = '" + @Fromdate + " 00:00:00' And L.Vdt < = '" + @Todate +" 23:59:59' "
      
    End
   Else
    Begin
      -- Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  And L.Booktype = '" + @Booktype + "'
     Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "' 
       And  L.Vdt > = '" + @Fromdate + " 00:00:00' And L.Vdt < = '" + @Todate +" 23:59:59' "
    End       
   If @Vtyp = '2'  Or @Vtyp = '3' Or @Vtyp = '5'  Or @Vtyp = '16'  Or @Vtyp = '17'  Or @Vtyp =  '20'  Or @Vtyp = '19' Or  @Vtyp = '1' Or  @Vtyp = '4' Or  @Vtyp = '22' Or  @Vtyp = '23'  
   Begin
    Select @@Wherepart = @@Wherepart + "  And   Cltcode <> '" + @Booktype + "'" 
   End
   Else
   Begin
    Select @@Wherepart = @@Wherepart + "  And L.Booktype = '" + @Booktype + "'"
   End 
   Select @@Selectqury = " Select Distinct L.Vno, Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno, Vamt = Isnull(L.Vamt, 0), L.Drcr, 
   Cltcode,  Acname , 
   Isnull(L.Vamt, 0) Vamt,  L.Drcr,  L.Vtyp, L.Vno, L.Lno , L.Booktype, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, 
     Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno, Dddt  =  Convert(Varchar, Dddt, 103)  , 
     L.Narration, Cltcode2 = Cltcode, Acname2 = Acname "
   Select @@Fromtables = " From Ledger L Left Outer Join Ledger1 L1 On  L.Vtyp = L1.Vtyp And L.Booktype = L1.Booktype And L.Vno = L1.Vno And L.Lno = L1.Lno "
   Select @@Sortby = " Order By L.Vdt, L.Vtyp, L.Booktype, L.Vno, L.Drcr Desc, L.Lno Desc "
    
 Print  (@@Selectqury + @@Fromtables + @@Wherepart + @@Sortby )
Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_voucherreport
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.rpt_voucherreport    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_voucherreport    Script Date: 02/04/2002 9:59:47 PM ******/
/****** Object:  Stored Procedure dbo.rpt_voucherreport    Script Date: 01/18/2002 1:38:15 PM ******/
/****** Object:  Stored Procedure dbo.rpt_voucherreport    Script Date: 12/26/2001 1:26:54 PM ******/
/****** Object:  Stored Procedure dbo.rpt_voucherreport    Script Date: 10/11/2001 12:34:54 PM ******/
CREATE PROCEDURE rpt_voucherreport
@fromdt varchar(15),
@todt varchar(15),
@typ int,
@vno varchar(15)
as
if @vno = '%'
begin
if @typ in ('2','3','5','6','7','15','16','17','19','20','21') 
begin
select distinct l.cltcode,ltrim(rtrim(l.acname)) as acname ,l.vno,l.vtyp,
left(convert(varchar,l.vdt,109),11) as vdt ,l1.ddno,
cramt=case when l.drcr='C' then vamt else 0 end,
dramt=case when l.drcr='D' then vamt else 0 end,
left(convert(varchar,l.edt,109),11) as edt,l.lno
from ledger l,ledger1 l1
where l.vdt >= @fromdt 
and l.vdt <= @todt+' 23:59:59' 
and l.vtyp=@typ 
and l1.vtyp=l.vtyp 
and l.vno=l1.vno
order by l.vtyp,l.vno
end
if @typ not in ('2','3','5','6','7','15','16','17','19','20','21') 
begin
select distinct l.cltcode,ltrim(rtrim(l.acname)) as acname ,l.vno,l.vtyp,
left(convert(varchar,l.vdt,109),11) as vdt ,ddno=0,
cramt=case when l.drcr='C' then vamt else 0 end,
dramt=case when l.drcr='D' then vamt else 0 end,
left(convert(varchar,l.edt,109),11) as edt,l.lno
from ledger l
where l.vdt >= @fromdt 
and l.vdt <= @todt+' 23:59:59' 
and l.vtyp=@typ 
order by l.vtyp,l.vno
end
end
if @vno <> '%'
begin
if @typ in ('2','3','5','6','7','15','16','17','19','20','21') 
begin
select distinct l.cltcode,ltrim(rtrim(l.acname)) as acname ,l.vno,l.vtyp,
left(convert(varchar,l.vdt,109),11) as vdt ,l1.ddno,
cramt=case when l.drcr='C' then vamt else 0 end,
dramt=case when l.drcr='D' then vamt else 0 end,
left(convert(varchar,l.edt,109),11) as edt,l.lno
from ledger l,ledger1 l1
where l.vdt >= @fromdt 
and l.vdt <= @todt+' 23:59:59' 
and l.vtyp=@typ 
and l.vno=@vno 
and l1.vtyp=l.vtyp 
and l.vno=l1.vno
order by l.vtyp,l.vno
end
if @typ not in ('2','3','5','6','7','15','16','17','19','20','21') 
begin
select distinct l.cltcode,ltrim(rtrim(l.acname)) as acname ,l.vno,l.vtyp,
left(convert(varchar,l.vdt,109),11) as vdt ,ddno=0,
cramt=case when l.drcr='C' then vamt else 0 end,
dramt=case when l.drcr='D' then vamt else 0 end,
left(convert(varchar,l.edt,109),11) as edt,l.lno
from ledger l
where l.vdt >= @fromdt 
and l.vdt <= @todt+' 23:59:59' 
and l.vtyp=@typ 
and l.vno=@vno 
order by l.vtyp,l.vno
end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbcheq1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq1    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbcheq1
@cltcode varchar(10),
@vdt varchar(10),
@broker varchar(15)
AS
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''),
ddno=isnull((select ddno from ledger1 le1 where 
le1.refno=l1.refno),''), nar=isnull((select l3.narr from ledger3 l3 where 
l3.refno=left(l1.refno,7)),'') from ledger l1,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb 
where  left(l1.refno,7) in ( 
select left(refno,7) from ledger l where convert(varchar,l.vdt,103) = @vdt
and l.vtyp=3 and l.cltcode=@cltcode) 
and l1.cltcode <> @cltcode 
and c2.party_code=l1.cltcode and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker and sb.sub_broker=@broker
order by l1.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbcheq2
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbcheq2    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbcheq2
@cltcode varchar(10),
@vdt varchar(10),
@broker varchar(15)
AS
select l1.acname,l1.vamt,l1.refno,l1.cltcode,l1.vtyp, 
bank=isnull((select bnkname from ledger1 le1 where le1.refno=l1.refno),''),
ddno=isnull((select ddno from ledger1 le1 where 
le1.refno=l1.refno),''), nar=isnull((select l3.narr from ledger3 l3 where 
l3.refno=left(l1.refno,7)),'') from ledger l1,  ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb 
where  left(l1.refno,7) in ( 
select left(refno,7) from ledger l where convert(varchar,l.vdt,103) = @vdt
and l.vtyp=2 and l.cltcode=@cltcode) 
and l1.cltcode <> @cltcode 
and c2.party_code=l1.cltcode and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker and sb.sub_broker=@broker
order by l1.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbclientlist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbclientlist    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbclientlist
@subbroker varchar(15)
 AS
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.sub_broker=sb.sub_broker and sb.sub_broker=@subbroker
group by  c1.cl_code,l.Cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbconfdrcrtot
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbconfdrcrtot    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbconfdrcrtot
@cname varchar(35)
AS
select  dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0)  
from ledger l , vmast,  ncdx.dbo.client2 c2 , 
ncdx.dbo.client1 c1 where 
l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode 
and l.acname = @cname and vtyp=vtype group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbconfledger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbconfledger    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbconfledger
@cname varchar(35)
as
select convert(varchar,l.vdt,103), c2.party_code, 
vdesc,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, 
l.refno, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l.refno,7)), '') from ledger l, 
vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1 
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@cname
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbconfopenbal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 01/04/1980 1:40:42 AM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbconfopenbal    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbconfopenbal
@clcode varchar(6)
AS
SELECT dramt=isnull((case drcr when 'd' then SUM(vamt)end),0), 
cramt=isnull((case drcr when 'c' then SUM(vamt)end),0) from ledger, 
ncdx.dbo.client2 where cltcode in (SELECT DISTINCT PARTY_CODE 
FROM ncdx.dbo.CLIENT2 
WHERE CL_CODE=ltrim(@clcode))and cltcode=party_code group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 11/28/2001 12:23:51 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcr    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbdrcr
@subbroker varchar(15)
AS
select amt=sum(vamt),drcr from ledger l, ncdx.dbo.client1 c1, ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.sub_broker=sb.sub_broker
and sb.sub_broker=@subbroker
group by sb.sub_broker,l.drcr
order by sb.sub_broker,l.drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbdrcrtot
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbdrcrtot    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbdrcrtot
@partycode varchar(10)
AS
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= getdate() + '11:59PM'
and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbdrlist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbdrlist    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbdrlist
@vdt smalldatetime ,
@subbroker varchar(15)
AS
select l.cltcode , l.acname, clcode=(select cl_code from ncdx.dbo.client2 
c2 where c2.party_code=l.cltcode),Amount = ( select isnull(sum(vamt),0) from ledger 
where drcr = 'D' and cltcode = l.cltcode and vdt <= @vdt +  '11:59pm')
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and 
cltcode = l.cltcode and vdt <= @vdt  + '11:59pm') From Ledger l , acmast a , ncdx.dbo.client2 c2 , 
ncdx.dbo.client1 c1, ncdx.dbo.subbrokers sb
where a.accat=4 and a.cltcode=l.cltcode and l.cltcode=c2.party_code and sb.sub_broker=@subbroker and 
sb.sub_broker=c1.sub_broker and  c1.cl_code=c2.cl_code
group by l.Cltcode,l.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbnamelist
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbnamelist    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbnamelist
@alpha varchar(21),
@subbroker varchar(15)
 AS
SELECT DISTINCT C1.CL_CODE, C1.SHORT_NAME 
FROM ncdx.dbo.CLIENT1 C1, ncdx.dbo.CLIENT2 C2, ledger l ,ncdx.dbo.subbrokers sb
WHERE c1.short_name like ltrim(@alpha)+'%' and C1.CL_CODE=C2.CL_CODE 
and c2.party_code=l.cltcode and sb.sub_broker=c1.sub_broker and sb.sub_broker=@subbroker
order by c1.short_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbnewdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbnewdrcr    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbnewdrcr
@subbroker varchar(15)
AS
select  sb.sub_broker,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.subbrokers sb
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker
and sb.sub_broker=@subbroker
group by  sb.sub_broker,l.Cltcode
ORDER BY sb.sub_broker

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbnseSETTNO
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbnseSETTNO    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE
sbnseSETTNO
@subbroker varchar(15)
AS
select distinct s.sett_no from settlement s,client1 c1,client2 c2,subbrokers sb
WHERE 
s.party_code=c2.party_code and
c1.cl_code=c2.cl_code and sb.sub_broker=c1.sub_broker and sb.sub_broker=@subbroker

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbonlinetoday1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbonlinetoday1    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE 
sbonlinetoday1
@id varchar(10),
@subbroker varchar(15)
AS
select c1.short_name,o.order_no,
o.party_code ,o.scrip_cd,o.series,
o.sell_buy,(o.qty-o.tradeqty),o.user_id,
o.EffRate,o.OrderRate,qty,tradeqty,OrderTime
from orders o,client1 c1,client2 c2 ,subbrokers sb 
 where c2.party_code = o.party_code and 
 c1.cl_code = c2.cl_code
 and o.party_code = @id and sb.sub_broker=@subbroker and c1.sub_broker=sb.sub_broker
 order by c1.short_name,o.scrip_cd,o.sell_buy,OrderTime

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbposmainsettno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbposmainsettno    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE  sbposmainsettno
@subbroker varchar(15)
 AS
 select distinct sett_no from settlement s ,client1 c1,client2 c2,subbrokers sb
 where
c1.cl_code=c2.cl_code and c2.party_code=s.party_code and c1.sub_broker=sb.sub_broker and sb.sub_broker=@subbroker
order by  sett_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sbshortsettno
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.sbshortsettno    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE sbshortsettno 
@subbroker varchar(15)
as
select distinct d.sett_no  from deliveryclt d ,subbrokers sb,client1 c1,client2 c2
where sb.sub_broker =@subbroker and sb.sub_broker=c1.sub_broker and d.party_code=c2.party_code and 
c1.cl_code=c2.cl_code
order by sett_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_BANK_BOOK_WEEKLY_BALANCES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[SEBI_BANK_BOOK_WEEKLY_BALANCES]
	@DATE_FROM VARCHAR(11),
	@REPORT_DATE VARCHAR(11),
	@REPORT_TYPE VARCHAR(3) = 'VDT'
AS

--SEBI_BANK_BOOK_WEEKLY_BALANCES_WRAPPER 'MAY 29 2020'


CREATE TABLE #BANK_BOOK_BAL
(
	BANK_CODE VARCHAR(30),
	BANK_IFSC VARCHAR(30),
	BANK_TYPE VARCHAR(10),
	REPORT_DATE DATETIME,
	AMOUNT MONEY,
	BANK_BALANCE MONEY,
	SNO INT IDENTITY(1, 1)
)

DECLARE
	@SDTCUR VARCHAR(11)

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @DATE_FROM BETWEEN SDTCUR AND LDTCUR
	
	
--SELECT * FROM #BANK_BOOK_BALANCES
IF @REPORT_TYPE = 'VDT'
BEGIN
	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),BANK_BALANCE =  0
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND VDT BETWEEN @SDTCUR AND @DATE_FROM + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE

	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),BANK_BALANCE =  0
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND VDT BETWEEN DATEADD(D, 1, @DATE_FROM) AND @REPORT_DATE + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))
	ORDER BY B.ACCOUNTNO, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))
END
ELSE
BEGIN
	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE, BANK_IFSC, BANK_TYPE, REPORT_DATE, AMOUNT = SUM(AMOUNT),BANK_BALANCE =  0
	FROM(
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND EDT BETWEEN @SDTCUR AND @DATE_FROM + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE
	UNION ALL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(cASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND EDT >= @SDTCUR AND VDT < @SDTCUR
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE ) A
	GROUP BY BANK_CODE, BANK_IFSC, BANK_TYPE, REPORT_DATE

	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109)), AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),BANK_BALANCE =  0
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND EDT BETWEEN DATEADD(D, 1, @DATE_FROM) AND @REPORT_DATE + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE, CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109))
	ORDER BY B.ACCOUNTNO, CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109))
END

INSERT INTO #BANK_BOOK_BAL
SELECT BANK_CODE, BANK_IFSC, BANK_TYPE, CAL_DATES, AMOUNT = 0, BANK_BALANCE = 0 FROM
(
SELECT * FROM
(SELECT DISTINCT BANK_CODE, BANK_IFSC, BANK_TYPE FROM #BANK_BOOK_BAL) B , CAL_DATES C
) A
WHERE NOT EXISTS(SELECT BANK_CODE FROM #BANK_BOOK_BAL B1 WHERE A.BANK_CODE = B1.BANK_CODE AND A.CAL_DATES = B1.REPORT_DATE)


--UPDATE B SET B.BANK_BALANCE = B1.BANK_BALANCE FROM #BANK_BOOK_BAL B,
--(SELECT BANK_CODE,BANK_IFSC, BANK_TYPE, REPORT_DATE, AMOUNT,
--SUM (AMOUNT) OVER (ORDER BY BANK_CODE, REPORT_DATE) AS BANK_BALANCE
--FROM #BANK_BOOK_BAL) B1
--WHERE B.BANK_CODE = B1.BANK_CODE AND B.REPORT_DATE = B1.

UPDATE B SET BANK_BALANCE = (SELECT SUM(AMOUNT) FROM #BANK_BOOK_BAL B1 WHERE B.BANK_CODE = B1.BANK_CODE AND B1.SNO <= B.SNO) FROM #BANK_BOOK_BAL B

SELECT * FROM #BANK_BOOK_BAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBIPOFILEGEN
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[SEBIPOFILEGEN]
(
	@VTYP VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12),	
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@FILETYPE VARCHAR(4),
	@PRINTFLAG CHAR(2),
	@ACCESS_FR CHAR(2) = 'SO'
)

AS
	
	DECLARE
		@@SQL VARCHAR(MAX)
		
	SET @@SQL = ''
	
	SELECT @@SQL = @@SQL + "	SELECT "
	SELECT @@SQL = @@SQL + "		L1.DDDT, "
	SELECT @@SQL = @@SQL + "		L.VNO, "
	SELECT @@SQL = @@SQL + "		ISNULL(DD,0) DD, "
	SELECT @@SQL = @@SQL + "		ISNULL(DDNO,'') DDNO, "
	SELECT @@SQL = @@SQL + "		VAMT = ISNULL(L.VAMT,0), "
	SELECT @@SQL = @@SQL + "		L.DRCR, "
	SELECT @@SQL = @@SQL + "		L.CLTCODE, "
	SELECT @@SQL = @@SQL + "		L.ACNAME, "
	SELECT @@SQL = @@SQL + "		CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), "
	SELECT @@SQL = @@SQL + "		L.NARRATION, "
	SELECT @@SQL = @@SQL + "		PRINTEDFLAG = ISNULL(CHQPRINTED,0), "
	SELECT @@SQL = @@SQL + "		L1.MICRNO, "
	SELECT @@SQL = @@SQL + "		L.BOOKTYPE, "
	SELECT @@SQL = @@SQL + "		HOPAYMODE = PAYMODE, "			
	SELECT @@SQL = @@SQL + "		M.ACCNO "
	SELECT @@SQL = @@SQL + "	FROM "	
	SELECT @@SQL = @@SQL + "		ACCOUNT.DBO.SEBIPAYOUT_ALL S (NOLOCK) "
	SELECT @@SQL = @@SQL + "		LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.PARTYCODE = M.CLTCODE AND M.DEFAULTBANK = 1, "	
	SELECT @@SQL = @@SQL + "		LEDGER L (NOLOCK), "
	SELECT @@SQL = @@SQL + "		LEDGER1 L1 (NOLOCK), "
	SELECT @@SQL = @@SQL + "		( "
	SELECT @@SQL = @@SQL + "		SELECT "
	SELECT @@SQL = @@SQL + "			VNO, "
	SELECT @@SQL = @@SQL + "			VTYP, "
	SELECT @@SQL = @@SQL + "			BOOKTYPE "
	SELECT @@SQL = @@SQL + "		FROM "
	SELECT @@SQL = @@SQL + "			LEDGER (NOLOCK) "
	SELECT @@SQL = @@SQL + "		WHERE "
	SELECT @@SQL = @@SQL + "			CLTCODE = '" + @BANKCODE + "' "
	SELECT @@SQL = @@SQL + "			AND VTYP = " + @VTYP + " "
	SELECT @@SQL = @@SQL + "			AND VNO BETWEEN '" + @VNOFROM + "' AND '" + @VNOTO + "' "
	SELECT @@SQL = @@SQL + "			AND VDT BETWEEN '" + @FROMDATE + "' AND '" + @TODATE + " 23:59:59' "
	SELECT @@SQL = @@SQL + "		) B "
	SELECT @@SQL = @@SQL + "	WHERE "
	SELECT @@SQL = @@SQL + "		L.VTYP = " + @VTYP + " "
	SELECT @@SQL = @@SQL + "		AND L.VTYP = L1.VTYP "
	SELECT @@SQL = @@SQL + "		AND L.BOOKTYPE = L1.BOOKTYPE "
	SELECT @@SQL = @@SQL + "		AND L.VNO = L1.VNO "
	SELECT @@SQL = @@SQL + "		AND L.LNO = L1.LNO "		
	SELECT @@SQL = @@SQL + "		AND L.VTYP = B.VTYP "
	SELECT @@SQL = @@SQL + "		AND L.BOOKTYPE = B.BOOKTYPE "
	SELECT @@SQL = @@SQL + "		AND L.VNO = B.VNO "
	SELECT @@SQL = @@SQL + "		AND L.VNO BETWEEN '" + @VNOFROM + "' AND '" + @VNOTO + "' "
	SELECT @@SQL = @@SQL + "		AND L.VDT BETWEEN '" + @FROMDATE + "' AND '" + @TODATE + " 23:59:59' "	
	SELECT @@SQL = @@SQL + "		AND S.PARTYCODE = L.CLTCODE "	
	SELECT @@SQL = @@SQL + "		AND L.CLTCODE <> '" + @BANKCODE + "' "
	SELECT @@SQL = @@SQL + "		AND S.VNO = L.VNO "	
	SELECT @@SQL = @@SQL + "		AND S.PAYMODE = '" + @FILETYPE + "' "
	
	IF @PRINTFLAG = 'FP'
		SELECT @@SQL = @@SQL + "		AND CHQPRINTED = 0 "
	ELSE
		SELECT @@SQL = @@SQL + "		AND CHQPRINTED > 0 "

	SELECT @@SQL = @@SQL + "		AND EXCHANGE = '" + @EXCHANGE + "' "
	SELECT @@SQL = @@SQL + "		AND SEGMENT = '" + @SEGMENT + "' "
	SELECT @@SQL = @@SQL + "	ORDER BY "
	SELECT @@SQL = @@SQL + "		L.VNO "
	
	PRINT (@@SQL)
	EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sel_CltCodeSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Sel_CltCodeSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Sel_CltCodeSp    Script Date: 02/22/2002 1:56:05 PM ******/
/****** Object:  Stored Procedure dbo.Sel_CltCodeSp    Script Date: 01/24/2002 12:12:14 PM ******/
/****** Object:  Stored Procedure dbo.Sel_CltCodeSp    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.Sel_CltCodeSp    Script Date: 29-Sep-01 8:12:07 PM ******/
/*Created by vaishali on 26/02/2001*/
CREATE PROCEDURE Sel_CltCodeSp
@flag as tinyint,
@FromParty varchar(10),
@ToParty varchar(10)
AS
if @flag = 1  
begin
	select distinct isnull(l.cltcode,'') cltcode, isnull(l.acname,' ') acname
	from ledger l,acmast a
	where accat <> 4 and l.cltcode = a.cltcode
	order by cltcode  
end 
if @flag = 2
begin
	select distinct isnull(l.cltcode,'') cltcode, isnull(l.acname,' ') acname
	from ledger l,acmast a
	where accat = 4 and l.cltcode = a.cltcode  
	order by cltcode 
end
if @flag = 3
begin
	select distinct isnull(l.cltcode,' ') cltcode , isnull(l.acname,' ') acname
	from ledger l,acmast a 
	where accat <> 4 and l.cltcode = a.cltcode 
	and l.cltcode >= @FromParty and l.cltcode <= @ToParty
	order by cltcode               
end
if @flag = 4
begin
	select distinct isnull(l.cltcode,' ') cltcode , isnull(l.acname,' ') acname
	from ledger l,acmast a 
	where accat = 4 and l.cltcode = a.cltcode 
	and l.cltcode >= @FromParty and l.cltcode <= @ToParty 
	order by cltcode              
end
if @flag = 5
begin
	select distinct isnull(acname,' ') acname 
	from ledger where cltcode =  @FromParty
	order by acname 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 18/04/2006 13:14:48 ******/


/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc SelectVoucherDetails

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) 

as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "' and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' 	and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  cltcode <> '" + @BankCode + "'" 
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

select @@wherepart = @@wherepart 

select @@selectqury = " select distinct l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype and party_code = cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_New_FP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_FP    Script Date: 18/04/2006 12:56:47 ******/


/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
Create Proc SelectVoucherDetails_New_FP

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@Vtype1 	varchar(2),
@BranchCode varchar(12)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "' and l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno /*and l1.ddno='0' */and l1.chqprinted=0 and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " /*and l1.ddno='0' */and l1.chqprinted=0 and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_New_RP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_New_RP    Script Date: 18/04/2006 13:11:02 ******/



/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
Create Proc SelectVoucherDetails_New_RP

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@vtype1	varchar(2),
@BranchCode varchar(12)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "' and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l1.ddno<>'0' and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " and l1.ddno<>'0' and l1.chqprinted > 0 and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails_Upd
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SelectVoucherDetails_Upd    Script Date: 18/04/2006 13:11:11 ******/


/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
Create Proc SelectVoucherDetails_Upd

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) ,
@BankName      varchar(50),
@vtype1	varchar(2),
@BranchCode varchar(12),
@newprintflag varchar(2)


as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "'   and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "'  
	and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l1.ddno>'0' and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	if @newprintflag = 'FP'
		select @@wherepart = @@wherepart + " and l1.chqprinted = 0 "
	if @newprintflag = 'RP'
		select @@wherepart = @@wherepart + " and l1.chqprinted > 0 "
	select @@wherepart = @@wherepart + " and l1.ddno>'0' and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  l.cltcode <> '" + @BankCode + "' " 
--	select @@wherepart = @@wherepart + "  and l1.ddno=0 "
--	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno and l1.ddno>'0' "
   end 

if @vtype1 = '98'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Settno%'  "
end
else if @vtype1 = '90'
begin
  select @@wherepart = @@wherepart + " and l.narration like 'Adhoc Payout%'  "
end
else
begin
  select @@wherepart = @@wherepart
end

select @@selectqury = " select distinct l1.dddt,l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype 
and party_code = l.cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SerTaxCalSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.SerTaxCalSp    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE SerTaxCalSp
@tomonth as varchar(2),
@frommonth as varchar(2),
@yearpart varchar(4),
@typecount varchar(3)
 AS
 select settno=(substring(l3.narr,8,8)),l.vamt ,
 tstart_date =(select start_date
   from ncdx.dbo.sett_mst
  where Sett_No= (substring(l3.narr,8,7)) and sett_type=right(substring(narr,8,8),1)), 
 tend_date = l.VDT , L.CLTCODE 
 from ledger l, ledger3 l3
 where  /*substring(l.refno, 1, 7) = substring(l3.refno, 1, 7)*/
l.vtyp=l3.vtyp and l.vno =l3.vno
 and
 cltcode in('99988' ,'99990','61310') and l.vtyp='15'  AND
 DATEPART(MONTH,VDT)>=@tomonth And 
(substring(l3.narr,15,1)) = @typecount and 
 DATEPART(MONTH,VDT)<=@frommonth AND
 DATEPART(YEAR,VDT)=@yearpart
 order by tstart_date,VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.settlementnospp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 2/17/01 3:34:18 PM ******/
/****** Object:  Stored Procedure dbo.settlementnospp    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE settlementnospp
 AS
SELECT DISTINCT SETT_NO FROM ncdx.dbo.SETTLEMENT  
UNION 
SELECT DISTINCT SETT_NO FROM ncdx.dbo.HISTORY 
ORDER BY SETT_NO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.settlementtypespp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.settlementtypespp    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE settlementtypespp 
@settno varchar(3)
 AS
select distinct sett_type from ncdx.dbo.settlement  
union 
 select distinct sett_type from ncdx.dbo.history  
where sett_no like @settno
 order by sett_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.singlebdrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.singlebdrcr    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE singlebdrcr
@br varchar(3)
AS 
select  b.branch_cd,l.Cltcode ,Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by  b.branch_cd,l.Cltcode
ORDER BY b.branch_cd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.singlepartydrcr
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.singlepartydrcr    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE singlepartydrcr
@partycode varchar(10)
as
select drtot=isnull((case drcr when 'd' then sum(vamt) end),0), crtot=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger WHERE VDT <= getdate() + "11:59PM" and CLTCODE=@partycode
group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------

CREATE PROC SP @spName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddBranch_Execute
-- --------------------------------------------------
CREATE PROC sp_AddBranch_Execute  
@strSQL VarChar(8000)  
AS  
 Print @strSQL  
 Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddClient_Execute
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.sp_AddClient_Execute    Script Date: 1/17/2004 11:39:11 PM ******/

CREATE PROC sp_AddClient_Execute
@strSQL VarChar(8000)
AS
	Print @strSQL
	Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_LEDGER_SB_PRN1
-- --------------------------------------------------
CREATE PROCEDURE SP_LEDGER_SB_PRN1(@fdate as varchar(11),@Tdate as varchar(11),@sbcode as varchar(11),@with_opnbal as varchar(1))                   
AS                  
                  
SET NOCOUNT ON                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
                  
/*              
Exec SP_LEDGER_SB_PRN1 'Apr  1 2006','Jan 19 2007','ZC','Y'           
declare @fdate as varchar(11),@Tdate as varchar(11),@sbcode as varchar(11),@with_opnbal as varchar(1)                  
set @fdate='Apr  1 2006'                  
set @tdate='Dec 31 2006'                  
set @sbcode='ZC'                  
set @with_opnbal = 'Y'                  
*/              
/*              
declare @fdate as varchar(11),@Tdate as varchar(11),@fcode as varchar(11),@Tcode as varchar(11),@MVNO AS VARCHAR(15),@with_opnbal as varchar(1)                  
set @fdate='Dec  1 2004'                  
set @tdate='Nov 30 2005'                  
set @fcode='28000001'                  
set @tcode='28999999'                  
set @with_opnbal = 'N'                  
*/              
      
select *,flag=' ' into #ledgera  from Intranet.risk.dbo.ledger_format                     
                  
if @with_opnbal='Y'                   
begin                  
 insert into #ledgera                  
 select coname='MCX',cltcode,acname=space(200),vdt=@fdate,vtyp='18',shortdesc='OPENEN',      
 vno=replace(convert(varchar(10),convert(datetime,@fdate),102),'.','')+'0000',      
 narration='Opening Balance',                  
 Debit=case when       
 sum(case when drcr='D' then vamt else -vamt end) > 0 then sum(case when drcr='D' then vamt else -vamt end) else 0 end,                  
 Credit=case when       
 sum(case when drcr='C' then vamt else -vamt end) > 0 then sum(case when drcr='C' then vamt else -vamt end) else 0 end,Flag='Y'        
 from ledger a (nolock)      
 where vdt >= (select sdtcur from parameter where sdtcur<= @fdate and ldtcur >= @fdate+' 23:59:59')      
 and vdt < @fdate+' 00:00:00'                  
 and cltcode in (select code from Intranet.risk.dbo.Ledger010909)--select pcode from Intranet.risk.dbo.pcode_temp--(select pcode from Temp_CLI_BSE)         
 group by cltcode      
  
end      
      
 insert into #ledgera                  
 select coname='MCX',cltcode,substring(acname,1,200),vdt,vtyp,shortdesc,vno,substring(a.narration,1,200),                 
 Debit=(case when drcr='D' then vamt else 0 end),                  
 Credit=(case when drcr='C' then vamt else 0 end),Flag='Y'from ledger a (nolock),                 
 (select vtype,shortdesc from dbo.vmast ) b                   
 where a.vtyp=b.vtype and vdt >=@fdate+' 00:00:00' and vdt < @tdate+' 23:59:59'                  
 and cltcode in (select code from Intranet.risk.dbo.Ledger010909)--select pcode from Intranet.risk.dbo.pcode_temp---(select pcode from Temp_CLI_BSE)         
        
 update #ledgera set flag='N' where vdt < @fdate           
       
 delete from #ledgera where flag='N'        
 update #ledgera set acname = b.acname from acmast b (nolock) where #ledgera.cltcode=b.cltcode      
              
--update #ledgera set acname = b.long_name from client_Details b                   
--where b.party_Code=#ledgera.cltcode               
              
update #ledgera set cltcode=ltrim(rtrim(cltcode))              
update #ledgera set acname=ltrim(rtrim(acname))              
--update #ledgera set acname=substring(acname,1,40)+replicate(char(255),(40-len(Acname)))              
update #ledgera set acname=substring(acname,1,40)+replicate(' ',(40-len(Acname)))              
          
          
              
select *,tdt=convert(varchar(11),vdt,103) from #ledgera where debit+credit <> 0               
order by cltcode,coname,vno                  
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_SOURCE_LEDGER_TRF_SEGMENT
-- --------------------------------------------------
--USE ACCOUNTNCDX


CREATE PROC SP_SOURCE_LEDGER_TRF_SEGMENT
 @START_DATE VARCHAR(11),  
 @START_DATENEW VARCHAR(11),
 @FROMCLIENT VARCHAR(20),
 @TOCLIENT VARCHAR(20),
 @MIN_AMT MONEY

--DECLARE @START_DATE VARCHAR(11),  
--@START_DATENEW VARCHAR(11),
--@FROMCLIENT VARCHAR(20),
--@TOCLIENT VARCHAR(20),
-- @MIN_AMT MONEY

--SET @START_DATE = 'APR  1 2025'
--SET @START_DATENEW = 'MAY 27 2025'
--SET @FROMCLIENT = '000'
--SET @TOCLIENT = 'ZZZ'
--SET @MIN_AMT = '1'
AS
BEGIN

TRUNCATE TABLE LEDGERTRANSFER_SEGMENTWISE

-- SOURCE LEDGER
 INSERT INTO LEDGERTRANSFER_SEGMENTWISE         
 SELECT BRANCHCODE, CLTCODE, ACNAME, LEDGERBALANCE = SUM(LEDGERBALANCE), AMOUNT = 0         
 FROM   (
		SELECT A.BRANCHCODE, A.CLTCODE, A.ACNAME, LEDGERBALANCE = SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END)         
         FROM   LEDGER L (NOLOCK)
                INNER JOIN FUND_TRF_CLIENT A         
				ON L.CLTCODE = A.CLTCODE         
         WHERE L.EDT >= @START_DATE      
                AND L.EDT <= @START_DATENEW + ' 23:59:59'  
				AND L.CLTCODE BETWEEN @FROMCLIENT AND @TOCLIENT
         GROUP  BY A.CLTCODE, A.ACNAME, A.BRANCHCODE         
              
         UNION ALL         
         SELECT A.BRANCHCODE, A.CLTCODE, A.ACNAME, LEDGERBALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END)         
         FROM   LEDGER L (NOLOCK) 
				INNER JOIN FUND_TRF_CLIENT A         
				ON L.CLTCODE = A.CLTCODE            
          WHERE L.EDT >= @START_DATE           
                AND L.VDT < @START_DATE  
				AND L.CLTCODE BETWEEN @FROMCLIENT AND @TOCLIENT
          GROUP  BY A.CLTCODE, A.ACNAME, A.BRANCHCODE        
              
         UNION ALL         
         SELECT A.BRANCHCODE, A.CLTCODE, A.ACNAME, LEDGERBALANCE = -SUM(CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE 0 END)     
         FROM  LEDGER L (NOLOCK)
				INNER JOIN FUND_TRF_CLIENT A         
				ON L.CLTCODE = A.CLTCODE           
                INNER JOIN  .DBO.LEDGER1 L1 (NOLOCK)  
				ON L.VNO = L1.VNO    
					AND L.VTYP = L1.VTYP         
					AND L.BOOKTYPE = L1.BOOKTYPE         
					AND L.LNO = L1.LNO   
         WHERE L.VDT >=   @START_DATE    
                AND L.VDT <=  @START_DATENEW + ' 23:59:59'         
                AND L.VTYP = 2       
                AND L1.RELDT = ''   
				AND L.CLTCODE BETWEEN @FROMCLIENT AND @TOCLIENT
         GROUP  BY A.CLTCODE, A.ACNAME, A.BRANCHCODE         
              
         UNION ALL         
         SELECT A.BRANCHCODE, A.CLTCODE, A.ACNAME, LEDGERBALANCE = SUM(CASE WHEN L.DRCR = 'C' THEN 0 ELSE -L.VAMT END)                                        
         FROM LEDGER L (NOLOCK)
				INNER JOIN FUND_TRF_CLIENT A         
				ON L.CLTCODE = A.CLTCODE          
         WHERE L.EDT >=   @START_DATE + ' 00:00:00'         
                AND L.VDT <=   @START_DATENEW  + ' 23:59:59'         
                AND L.EDT >= CONVERT(DATETIME,  @START_DATENEW) + 1   
				AND L.CLTCODE BETWEEN @FROMCLIENT AND @TOCLIENT
           GROUP  BY A.CLTCODE, A.ACNAME, A.BRANCHCODE        
        ) F         
 GROUP  BY CLTCODE, ACNAME, BRANCHCODE         
 HAVING SUM(LEDGERBALANCE) > @MIN_AMT
            

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spa_InsVouchertemp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 02/18/2003 10:25:07 AM ******/
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 01/27/2003 9:57:08 PM ******/
CREATE PROCEDURE Spa_InsVouchertemp
 @vno varchar(20),
 @vtype varchar(2),
 @booktype varchar(2),
 @billflag char(1),
 @costflag char(1),
 @sid varchar(20)
 AS
declare @@tmpcat varchar(50),
@@tmplno varchar(3),
@@tmpcost varchar(50),
@@tmpcostname varchar(50),
@@tmpexists integer,
@@tmpcltcode varchar(16),
@@CNo Cursor
if @billflag=1
begin
insert into tempbilldetails 
/*
	select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,
	b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno 
	from matchdetails m left outer join billmatch b on m.vno=b.vno and m.vtype=b.vtype and m.booktype= b.booktype and 
	m.lno=b.lno and b.vtype=15 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype  
	and m.description not like 'Advances%' */
	select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,
	b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno 
	from billmatch b left outer join matchdetails m on b.vno=m.vno and b.vtype=m.vtype and b.booktype= m.booktype and 
	b.lno=m.lno and b.party_code = m.party_code and b.vtype=15
	where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype  and m.description not like 'Advances%'
end
If @costflag=1
begin
	insert into templedger2 (vtype,vno,lno,drcr,paidamt,costcode,BookType,sessionid,party_code)
	select distinct vtype,vno,lno,drcr,camt,costcode,BookType,sessionid=@sid,cltcode
	from ledger2  where vno= @vno and vtype=@vtype and booktype= @booktype
	Set @@Cno = Cursor For 
	select distinct lno,costcode,cltcode
	from ledger2  where vno= @vno  and vtype=@vtype and booktype= @booktype
	Open @@CNo 
	Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode
	While @@Fetch_Status = 0 
	Begin
		select @@tmpexists = (select count(*) as cnt from branchaccounts where BrControlAc =  @@tmpcltcode)
		if @@tmpexists = 0
		begin
			select @@tmpcat = (select distinct c.category from category c, costmast m 
			where c.catcode = m.catcode and m.costcode=@@tmpcost)
			update templedger2   set category= @@tmpcat where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and  party_code =@@tmpcltcode
		end	
		else	
		begin
			select @@tmpcat = 'BRANCH'
			update templedger2   set category= 'BRANCH' where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code =@@tmpcltcode
		end
	print @@tmpcost 
	select @@tmpcostname = (select distinct m.COSTNAME from category c, costmast m where c.catcode = m.catcode and m.costcode= @@tmpcost)
	update templedger2 set branch = @@tmpcostname  where sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code = @@tmpcltcode and costcode=@@tmpcost
	select @@tmpcat= ""
	select @@tmpcostname =""
	select @@tmpcltcode = ""
	select @@tmpcost=""
	Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode
	end
	Close @@CNo
	DeAllocate @@CNo
	delete from templedger2 where party_code in ( select BrControlAc from branchaccounts)
	update templedger2 set costflag = 'A', rowid = lno
        where upper(category) = 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno
	update templedger2 set costflag = 'A', rowid = lno
        where upper(category) <> 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAdjBalCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 20-Mar-01 11:43:36 PM ******/
/* 22/03/2000   this procedure is used to adjust the balance amount of  all the parties according to the dates*/
CREATE PROCEDURE     spAdjBalCursor    @code varchar(12)
 AS
declare    @@tbalamt numeric(17,2)   ,
@@tdrcr varchar(1),
/*@@trefno varchar(12) ,*/
@@vtyp smallint,
@@vno numeric(12,0),
@@tvdt datetime  ,
@@tvamt numeric(17,2),
@@tcur cursor    
                 select @@tbalamt=0
                 set @@tcur = cursor for 
                 select drcr,vamt , /*refno,*/ vtyp,vno,vdt  from ledger 
                 where cltcode= @code   and vdt >= '04/01/2001 00:00:00' 
                 order by vdt,vtyp,  vno/*refno*/
                 open @@tcur
fetch next  from @@tcur into   @@tdrcr ,@@tvamt  , /*@@trefno   ,*/ @@vtyp,@@vno, @@tvdt
               
while   @@fetch_status =0
begin
                 
                  if  @@tdrcr='c' 
                  begin
                             select  @@tvamt  = 0  -   @@tvamt
                  end
                  Select   @@tbalamt =   @@tbalamt   +   @@tvamt 
           
                 update ledger set balamt =   @@tbalamt                 
                 where  vtyp = @@vtyp and vno = @@vno and drcr = @@tdrcr and vdt = @@tvdt  and cltcode = @code  /*current of  @@tcur*/
                 fetch next  from @@tcur into   @@tdrcr ,@@tvamt   , /*@@trefno   ,*/ @@vtyp,@@vno, @@tvdt
end
close @@tcur
deallocate @@tcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAdjBalCursor2000
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.spAdjBalCursor2000    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.spAdjBalCursor2000    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2000    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2000    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2000    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2000    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 20-Mar-01 11:43:36 PM ******/
/* 22/03/2000   this procedure is used to adjust the balance amount of  all the parties according to the dates*/
CREATE PROCEDURE     spAdjBalCursor2000    @code varchar(12)
 AS
declare    @@tbalamt numeric(17,2)   ,
@@tdrcr varchar(1),
/*@@trefno varchar(12) ,*/
@@vtyp smallint,
@@vno int,
@@tvdt datetime  ,
@@tvamt numeric(17,2),
@@tcur cursor    
                 select @@tbalamt=0
                 set @@tcur = cursor for 
                 select drcr,vamt , /*refno,*/ vtyp,vno,vdt  from ledger 
                 where cltcode= @code   and vdt <= '03/31/2000 23:59:59' 
                 order by vdt,vtyp,  vno/*refno*/
                 open @@tcur
fetch next  from @@tcur into   @@tdrcr ,@@tvamt  , /*@@trefno   ,*/ @@vtyp,@@vno, @@tvdt
               
while   @@fetch_status =0
begin
                 
                  if  @@tdrcr='c' 
                  begin
                             select  @@tvamt  = 0  -   @@tvamt
                  end
                  Select   @@tbalamt =   @@tbalamt   +   @@tvamt 
           
                 update ledger set balamt =   @@tbalamt                 
                 where  vtyp = @@vtyp and vno = @@vno and drcr = @@tdrcr and vdt = @@tvdt  and cltcode = @code  /*current of  @@tcur*/
                 fetch next  from @@tcur into   @@tdrcr ,@@tvamt   , /*@@trefno   ,*/ @@vtyp,@@vno, @@tvdt
end
close @@tcur
deallocate @@tcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAdjBalCursor2001
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.spAdjBalCursor2001    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.spAdjBalCursor2001    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2001    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2001    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2001    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor2001    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.spAdjBalCursor    Script Date: 20-Mar-01 11:43:36 PM ******/
/* 22/03/2000   this procedure is used to adjust the balance amount of  all the parties according to the dates*/
CREATE PROCEDURE     spAdjBalCursor2001    @code varchar(12)
 AS
declare    @@tbalamt numeric(17,2)   ,
@@tdrcr varchar(1),
/*@@trefno varchar(12) ,*/
@@vtyp smallint,
@@vno int,
@@tvdt datetime  ,
@@tvamt numeric(17,2),
@@tcur cursor    
                 select @@tbalamt=0
                 set @@tcur = cursor for 
                 select drcr,vamt , /*refno,*/ vtyp,vno,vdt  from ledger 
                 where cltcode= @code   and vdt >= '04/01/2000 00:00:00' and vdt <= '03/31/2001 23:59:59'
                 order by vdt,vtyp,  vno/*refno*/
                 open @@tcur
fetch next  from @@tcur into   @@tdrcr ,@@tvamt  , /*@@trefno   ,*/ @@vtyp,@@vno, @@tvdt
               
while   @@fetch_status =0
begin
                 
                  if  @@tdrcr='c' 
                  begin
                             select  @@tvamt  = 0  -   @@tvamt
                  end
                  Select   @@tbalamt =   @@tbalamt   +   @@tvamt 
           
                 update ledger set balamt =   @@tbalamt                 
                 where  vtyp = @@vtyp and vno = @@vno and drcr = @@tdrcr and vdt = @@tvdt  and cltcode = @code  /*current of  @@tcur*/
                 fetch next  from @@tcur into   @@tdrcr ,@@tvamt   , /*@@trefno   ,*/ @@vtyp,@@vno, @@tvdt
end
close @@tcur
deallocate @@tcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAdjDaysCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.spAdjDaysCursor    Script Date: 20-Mar-01 11:43:36 PM ******/
/* 22/03/2000   this procedure is used to adjust the balance amount of  all the parties according to the dates*/
CREATE PROCEDURE     spAdjDaysCursor    @code varchar(12)
 AS
declare   @@trefno varchar(12) ,
@@tcur cursor    ,
@@tnodays integer,
 @@Prevdays  integer,
@@tvdt  datetime  ,
@@PrevVdt  datetime
                 set @@tcur = cursor for 
                 select  refno ,nodays ,vdt   from ledger 
                 where cltcode= @code
                 order by vdt,vtyp,  vno1,refno 
                 open @@tcur
  
fetch next  from @@tcur into   @@trefno , @@tnodays ,@@tvdt
 
 select @@PrevVdt  = @@tvdt
                       
while   @@fetch_status =0
begin
  fetch next  from @@tcur into    @@trefno   ,  @@tnodays  , @@tvdt
  update ledger set   nodays = abs(datediff(day, @@PrevVdt  ,@@tvdt))
                 where   current  of  @@tcur
 select @@PrevVdt  = @@tvdt   
end
close @@tcur
deallocate @@tcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spAdjTimeCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.spAdjTimeCursor    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE     spAdjTimeCursor    @ttime varchar(20) 
 AS
declare   @@trefno varchar(12) ,
@@tvdt datetime  ,
@@tvtyp varchar(2),
@@tvno1 varchar(2),
@@tdate datetime,
@@tsec   varchar(2),
@@tcnt  integer,
@@code varchar(12),
@@tcur cursor    
                 set @@tcur = cursor for 
 select      cltcode,vdt,vtyp,vno1,refno     from ledger 
                order by cltcode,vdt,vtyp,vno1,refno  
                open @@tcur
while   @@fetch_status =0
begin
               fetch next  from @@tcur into   @@code,  @@tvdt   ,  @@tvtyp,   @@tvno1,   @@trefno
         
 select  @@tdate = @@tvdt
        
        
                  If    @@tcnt = 59 
                 begin
                        select    @@tcnt = 0
                  End
 select  @@tcnt=@@tcnt+1
        
                   If    @@tcnt < 9
 begin
                             select   @@tsec = "0"  +   @@tcnt
                  End   
                    If Len( @@tvdt) > 21 
                   begin
                           select   @@tdate = Left(@@tdate, 17)
          select  @@tdate = @@tdate  +  @@tsec
                   end
 if Len( @@tvdt  ) = 21
                   begin
          select   @@tdate = Left( @@tdate, 16)
          select  @@tdate = @@tdate  +  @@tsec
                   end
 if Len( @@tvdt  ) <   21
 begin
          select  @@tdate = Left(@@tdate, 10)  +   " "  + @tTime
  End
                update ledger set vdt= @@tdate  
                 where   current of  @@tcur
              
end
close @@tcur
deallocate @@tcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SpAdjustBal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 11/28/2001 12:23:52 PM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 29-Sep-01 8:12:07 PM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.SpAdjustBal    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE  SpAdjustBal   @trefno varchar(12) 
,@tvamt   numeric(12,2 )
,@drcr varchar(1)
AS
if @drcr='d'
 update ledger set balamt = @tvamt  +  vamt    where refno=@trefno
else
 update ledger set balamt = @tvamt   -    vamt    where refno=@trefno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spbilldrcrtotal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Spbilldrcrtotal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Spbilldrcrtotal    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.Spbilldrcrtotal    Script Date: 12/12/2001 6:42:36 PM ******/
/* it gets the total dr and total cr for a particular voucher entry  ,used in transferbills*/
CREATE PROCEDURE  Spbilldrcrtotal  
@vtyp  smallint,
@vno  varchar(12),
@booktype varchar(2)
AS
select crtotal= isnull(sum(vamt),0), 
drtotal=isnull((select  sum(vamt) from ledger where drcr='d' and vtyp = @vtyp and vno = @vno and booktype = @booktype ) ,0)
from ledger 
where drcr='c' and  vtyp = @vtyp and vno = @vno and booktype = @booktype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SpBillTransfer
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SpBillTransfer    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.SpBillTransfer    Script Date: 12/26/2002 12:12:27 PM ******/
/****** Object:  Stored Procedure dbo.SpBillTransfer    Script Date: 04/11/2002 7:26:34 PM ******/
/****** Object:  Stored Procedure dbo.SpBillTransfer    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.SpBillTransfer    Script Date: 12/12/2001 6:42:36 PM ******/
/* This procedure is used BillPosting control   */
CREATE PROCEDURE  SpBillTransfer  
@tvtyp     varchar(2),
@tvno  	   varchar(12),
@booktype  varchar(2),
@tcode     varchar(10),
@tdrcr     varchar(1),
@tlno      integer,
@tedt  	   datetime,
@tvdt  	   datetime,
@tvamt     money,
@tempno    varchar(15),
@tnarr 	   varchar(234),
@enteredby varchar(35),
@checkedby varchar(35),
@pdt	   datetime	
AS
            
declare   
@@tname    varchar(35),  
@@tbalamt  money,
@@tNodays  numeric(4,0)
   
select @@tname = acname from acmast where cltcode = @tcode
select @@tbalamt = @tvamt 
select @@tnodays=0
           
/* Update the ledger record i.e set the no of days of the previous record */
/*
update ledger set nodays=abs(datediff(day,vdt , @tvdt))
where vdt= (select distinct max(vdt) from ledger  where cltcode=  @tcode  and  vdt<= @tvdt )
and cltcode= @tcode
*/
               
/*Calculate the balance amt of the client */
/*
select @@tbalamt= balamt + @tvamt from ledger   
where  vdt = (select distinct max(vdt) from ledger  where cltcode=  @tcode  and  vdt<=@tvdt )
and cltcode= @tcode
*/
  
/*Calculate the nodays  amt of the client */
/*
select   @@tNodays= abs(datediff(day,vdt , @tvdt))  from ledger   
where  vdt = (select distinct min(vdt) from ledger  where cltcode=  @tcode  and  vdt>@tvdt )
and cltcode= @tcode
*/
                      
/*vtyp   vno edt lno acname drcr vamt vdt vno1  refno balamt NoDays cdt  cltcode  BookType EnteredBy  pdt  CheckedBy  actnodays   */ 
/* 'insert into ledger */
insert into ledger values (@tvtyp,@tvno,@tedt,@tlno,@@tname,@tdrcr,abs(@tvamt),@tvdt , '','', @@tbalamt , @@tNodays ,getdate() ,@tcode,@booktype,@enteredby,@pdt,@checkedby,@@tNodays,@tnarr)
 
/*updating the balamt of the records which are successive to the record just inserted */
update ledger set balamt=balamt + @tvamt
where  vdt >  @tvdt   and cltcode = @tcode
/* inserting record in ledger1*/               
/*bnkname  brnname   dd   ddno  dddt  reldt  relamt refno  receiptno  vtyp   vno lno  drcr BookType MicrNo      */
insert into ledger1 values ( @tempno,'','b','',@tvdt, @tvdt ,abs(@tvamt) ,'','0',@tvtyp,@tvno,@tlno,@tdrcr,@booktype,0,0,'','',0,'') 
/* inserting record in ledger3 */
/*naratno     narr    refno vtyp   vno BookType */
insert into ledger3 values (@tlno,@tnarr,'', @tvtyp,@tvno,@booktype) 
if @tlno = 1 
begin
insert into ledger3 values (0,@tnarr,'', @tvtyp,@tvno,@booktype) 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SpDeleteValan
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SpDeleteValan    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.SpDeleteValan    Script Date: 3/1/03 1:30:55 PM ******/
/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 02/18/2003 10:37:42 AM ******/
/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 06/05/2002 12:03:48 PM ******/
/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 12/12/2001 6:42:36 PM ******/
/*deletes a voucher entry from ledger,ledger1,ledger3 table  depending on the vtyp passed */
CREATE PROCEDURE SpDeleteValan
@vtyp  smallint,
@vno varchar(12),
@booktype varchar(2)
AS
delete from ledger    where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from ledger1  where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from ledger2  where vtype = @vtyp and vno = @vno and booktype = @booktype
delete from ledger3  where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from billmatch where vtype = @vtyp and vno = @vno and booktype = @booktype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SpDeleteVoucher
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.SpDeleteVoucher    Script Date: 12/12/2001 6:42:36 PM ******/
/*deletes a voucher entry from ledger,ledger1,ledger3 table  depending on the vtyp passed */
CREATE PROCEDURE SpDeleteVoucher
@vtyp  smallint,
@vno varchar(12),
@booktype varchar(2)
AS
delete from ledger    where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from ledger1  where vtyp = @vtyp and vno = @vno and booktype = @booktype
delete from ledger2  where vtype = @vtyp and vno = @vno and booktype = @booktype
delete from ledger3  where vtyp = @vtyp and vno = @vno and booktype = @booktype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SpLedger2Total
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.SpLedger2Total    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.SpLedger2Total    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.SpLedger2Total    Script Date: 12/12/2001 6:42:36 PM ******/
CREATE Procedure  SpLedger2Total
@vtyp  smallint,
@vno  varchar(12),
@booktype varchar(2)
AS
select crtotal=isnull((select  sum(camt) from ledger2 where drcr='c' and vtype = @vtyp and vno = @vno and booktype = @booktype ) ,0), 
drtotal=isnull((select  sum(camt) from ledger2 where drcr='d' and vtype = @vtyp and vno = @vno and booktype = @booktype ) ,0)
from ledger2 
/* where drcr='c' and  vtype = @vtyp and vno = @vno and booktype = @booktype */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPTestPrepaid
-- --------------------------------------------------
CREATE proc SPTestPrepaid                             
( @fvdt as datetime,@tvdt as datetime, @code as varchar(10))                                   
                                  
as                                  
      
set nocount on                                
      
--declare  @code1 as varchar(10), @code2 as varchar(10)      
--set @code1 = '4100' + right(@code, 2)      
--set @code2= '4200' + right(@code, 2)                    
--declare @fvdt as datetime,@tvdt as datetime,@code as varchar(10)                      
--set @fvdt = '2008-04-01'                      
--set @tvdt = '2009-03-31'  
--set @code ='250001'           
--left(convert(varchar,vdt,121),11)  --convert(varchar(11),convert(datetime,vdt),103)                 
                             
select * into #t from ledger nolock where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                                  
                      
                          
select drcr= case                           
when drcr = 'D' then 'C'                           
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                          
select convert(varchar(11),vdt,103) as [Date],VNO,cltcode,acname, segment='NCDX',vamt,narration as [Narration],DRCR,vtyp  into #file1 from                          
(                          
select * from #t                        
union                         
select x.* from                          
(                          
select l.*                  
from ledger l (nolock), #t t                   
where l.vtyp = t.vtyp and l.vtyp <> '18' and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' or l.cltcode not like '2%' and l.cltcode  like '5%')                 
          
) x          
inner join                          
(select * from #l1)y                          
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                          
) x where cltcode not like '27%'  and cltcode not like '26%' --and cltcode  like '5%'        



--select t.vtyp,t.vno,t.vdt,t.drcr,t.vamt,t.cltcode,t.acname
--from #t t

--declare @fvdt as datetime,@tvdt as datetime,@code as varchar(10)                      
--set @fvdt = '2008-04-01'                      
--set @tvdt = '2009-03-31'  
--set @code ='250001'           

select * into #P from ledger nolock where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt     


select l.vtyp,l.vno,l.acname,l.drcr,l.vamt,l.cltcode  into #prepaid1               
from ledger l (nolock), #p p                   
where l.vtyp = p.vtyp and l.vtyp <> '18' and l.vno = p.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' and l.cltcode not like '2%')


select t.vdt,t.VTYP,t.vno,t.cltcode,t.acname,t.drcr,t.vamt,t.narration,p.cltcode,p.acname,p.drcr,p.vamt
from #t t left join #prepaid1 p
on t.vtyp=p.vtyp and t.vno=p.vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.subgrpcode
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 20-Mar-01 11:43:36 PM ******/
/****** Object:  Stored Procedure dbo.subgrpcode    Script Date: 12/18/99 8:23:21 AM ******/
CREATE PROCEDURE subgrpcode 
@tempgrpcode  varchar(13)
AS
select grpname , grpcode from grpmast where grpcode like @tempgrpcode
order by grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TABLES
-- --------------------------------------------------

CREATE PROCEDURE TABLES    
(@NAME VARCHAR(40))    
AS      
SELECT * FROM SYS.TABLES WHERE NAME LIKE '%' + @NAME + '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------
  

  
CREATE PROC Tbl @TblName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.traderallpartyled
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 7/8/01 3:22:51 PM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.traderallpartyled    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE traderallpartyled
@cname varchar(35)
AS
select convert(varchar,l.vdt,103), c2.party_code, 
vdesc,dramt=isnull((case drcr when 'd' then vamt end),0), 
cramt=isnull((case drcr when 'c' then vamt end),0), l.vamt, 
l.refno, balamt,vtyp, 
nar=isnull((select l3.narr from ledger3 l3 where l3.refno=left(l.refno,7)), '') from ledger l,
vmast, ncdx.dbo.client2 c2, ncdx.dbo.client1 c1
where l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode and vtyp=vtype 
and l.acname =@cname
order by l.vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TraderBillSummaryPrint
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TraderBillSummaryPrint    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE TraderBillSummaryPrint 
@tradername varchar(15),
@settnosetttype varchar(12)
AS
select distinct l.cltcode, l.acname, 
DEBIT =(select isnull(sum(vamt),0) from ledger  where drcr='d' AND LEDGER.CLTCODE = L.CLTCODE   
and cltcode not in ('99990' ,'61310', '99985' ,'99988','100') 
and substring(refno,1,7) = (l3.refno + ' ' )), 
CREDIT = (select isnull(sum(vamt),0) from ledger  where drcr='c' AND LEDGER.CLTCODE = L.CLTCODE 
and cltcode not in ('99990' ,'61310', '99985' ,'99988','100')  
and substring(refno,1,7) = (l3.refno + ' ' ))   
from ledger l,ledger l1,ledger3 l3 , ncdx.dbo.client1 c1 , ncdx.dbo.client2 c2 
where  c1.cl_Code = c2.cl_Code and c2.party_code = l.cltcode  and c1.trader like @tradername 
and substring(l.refno,1,11) = substring(l1.refno,1,11) 
and substring(l.refno,1,7) = (l3.refno + ' ' )and l.vtyp='15' 
and l.vtyp=l1.vtyp and l3.narr like @settnosetttype
and l.cltcode not in ('99990' ,'61310', '99985' ,'99988','100') 
order by l.cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.traderpos
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.traderpos    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.traderpos    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 8/7/01 6:03:53 PM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.traderpos    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE traderpos
@br varchar(3)
 AS
select amt=sum(vamt),drcr, c1.trader from ledger l, ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where  l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@br
group by trader,drcr
order by trader,drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.traderwiseclient
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.traderwiseclient    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE traderwiseclient 
@branchcd varchar(3),
@trader varchar(15)
 AS
select l.cltcode , c1.cl_code, Amount = ( select isnull(sum(vamt),0) from ledger where drcr = 'D' and cltcode = l.cltcode) 
- (select isnull(sum(vamt),0) from ledger where drcr = 'C' and cltcode = l.cltcode) From Ledger l , ncdx.dbo.client1 c1,
ncdx.dbo.client2 c2, ncdx.dbo.branches b
where l.cltcode=c2.party_code and c1.cl_code=c2.cl_code and c1.trader=b.short_name and b.branch_cd=@branchcd
and c1.trader=@trader
group by  c1.cl_code,l.Cltcode
order by l.cltcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TradeSumPrintDataSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintDataSpP    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE TradeSumPrintDataSpP
@tradername varchar(20),
@genddate varchar(11),
@minamount varchar(15),
@maxamount  varchar(15)
 AS
select distinct l1.cltcode,l1.acname ,  
Debit = (select isnull(sum(vamt),0) from ledger l where l.drcr='d' and  l1.cltcode =  l.cltcode ), 
Credit = (select isnull(sum(vamt),0) from ledger l where l.drcr='c' and  l1.cltcode = l.cltcode ), amount = ((select isnull(sum(vamt),0) 
from ledger l where l.drcr='d' and  l1.cltcode =  l.cltcode ) - (select isnull(sum(vamt),0)
from ledger l where l.drcr='c' and  l1.cltcode = l.cltcode ))  
from ledger l1  , ncdx.dbo.client1 c1 , ncdx.dbo.client2 c2  where c1.cl_Code = c2.cl_Code 
and c2.party_code = l1.cltcode and c1.trader=@tradername  and l1.vdt <=@genddate
group by l1.cltcode,l1.acname  
having  ABS((select isnull(sum(vamt),0) from ledger l 
where l.drcr='d' and  l1.cltcode =  l.cltcode  and l.vdt <=@genddate )-  
(select isnull(sum(vamt),0) from ledger l where l.drcr='c' and  l1.cltcode = l.cltcode  
and l.vdt <=@genddate )) > convert(money,@minamount)  and ABS((select isnull(sum(vamt),0) 
from ledger l where l.drcr='d' and  l1.cltcode =  l.cltcode  
and l.vdt <=@genddate )- (select isnull(sum(vamt),0) from ledger l where l.drcr='c' 
and  l1.cltcode = l.cltcode  and l.vdt <=@genddate ))  <   convert(money,@maxamount)
order by l1.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TradeSumPrintViewSpP
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TradeSumPrintViewSpP    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE TradeSumPrintViewSpP 
@tradername varchar(30),
@genddate varchar(11),
@debitamount  varchar(15)
AS
 select distinct l1.cltcode,l1.acname , 
 Debit = (select isnull(sum(vamt),0) 
from ledger l 
where l.drcr='d' and  l1.cltcode =  l.cltcode ), 
 Credit = (select isnull(sum(vamt),0)
 from ledger l where l.drcr='c' and  l1.cltcode = l.cltcode ), 
 amount = ((select isnull(sum(vamt),0) 
from ledger l where l.drcr='d' and
  l1.cltcode =  l.cltcode )-  (select isnull(sum(vamt),0) 
from ledger l where l.drcr='c' and  l1.cltcode = l.cltcode ))  
from ledger l1  , ncdx.dbo.client1 c1 , ncdx.dbo.client2 c2  
where c1.cl_Code = c2.cl_Code and c2.party_code = l1.cltcode and
 c1.trader=@tradername  and l1.vdt <=@genddate
group by l1.cltcode,l1.acname  
having  ABS((select isnull(sum(vamt),0) from ledger l 
where l.drcr='d' and  l1.cltcode =  l.cltcode  and 
l.vdt <=@genddate )-  (select isnull(sum(vamt),0) from ledger l 
where l.drcr='c' and  l1.cltcode = l.cltcode  and l.vdt <=@genddate )) > 50 
 order by l1.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.tradledallpartybal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 1/17/2004 11:39:11 PM ******/

/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.tradledallpartybal    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE tradledallpartybal
@cname varchar(35)
 AS
select  dramt=isnull((case drcr when 'd' then sum(vamt) end),0), 
cramt=isnull((case drcr when 'c' then sum(vamt) end),0) 
from ledger l , vmast,  ncdx.dbo.client2 c2 , 
ncdx.dbo.client1 c1 where 
l.acname = c1.short_Name and c1.cl_code = c2.cl_code and c2.party_code=l.cltcode 
and l.acname = @cname and vtyp=vtype group by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRBAL_TEST
-- --------------------------------------------------
CREATE PROCEDURE TRBAL_TEST 
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */      
      
AS      
  
DECLARE    
@@COSTCODE AS VARCHAR(3)  
  
      
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2      
    
    
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN  
  IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59' and L.CLTCODE LIKE '21%'       
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18 AND L.CLTCODE LIKE '21%'       
         GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18 AND L.CLTCODE LIKE '21%'       
         GROUP BY L.CLTCODE  
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'      
         AND EDT < @CURRYRSTDATE AND L.CLTCODE LIKE '21%'              
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59' AND L.CLTCODE LIKE '21%'             
        GROUP BY L.CLTCODE      
       END      
      ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'  AND L.CLTCODE LIKE '21%'            
        GROUP BY L.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
   
  
/*  -- FOR BRANCH SELECTION --  */    
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN  
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )    
 IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
   AND COSTCODE = @@COSTCODE  AND L.CLTCODE LIKE '21%'       
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  AND L.CLTCODE LIKE '21%'       
     GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  AND L.CLTCODE LIKE '21%'       
         GROUP BY L.CLTCODE         
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE  
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE AND L.CLTCODE LIKE '21%'        
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'  
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  AND L.CLTCODE LIKE '21%'       
        GROUP BY L2.CLTCODE      
       END      
     ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE AND L.CLTCODE LIKE '21%'        
        GROUP BY L2.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
/* ---------------------------- */    
  
  
IF @FLAG = 'CODEWISE'      
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE    
 END    
ELSE    
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TrBillBillNossp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TrBillBillNossp    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE TrBillBillNossp 
@settno varchar(7),
@setttype varchar(3),
@partycode varchar(10)
AS
select distinct billno from ncdx.dbo.settlement
 where sett_no like @settno  and sett_type like @setttype  and party_code like @partycode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TrBillsummaryDatessp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 01/04/1980 1:40:43 AM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TrBillsummaryDatessp    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE  TrBillsummaryDatessp 
@settlementno varchar(7),
@settlementype varchar(3)
AS
select start_date,end_date from ncdx.dbo.sett_mst
where sett_no = @settlementno and sett_Type = @settlementype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TrBillSummaryTotal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 01/04/1980 1:40:44 AM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TrBillSummaryTotal    Script Date: 20-Mar-01 11:43:36 PM ******/
CREATE PROCEDURE  TrBillSummaryTotal 
@sett_nosett_type varchar(12)
AS
select distinct   
DEBIT =(select sum(vamt) from ledger  where drcr='d'  and 
cltcode not in ('99990' ,'61310', '99985' ,'99988','100')  
and substring(refno,1,7) = (l3.refno + ' ' )),  
CREDIT = (select sum(vamt) from ledger  where drcr='c'  and 
cltcode not in ('99990' ,'61310', '99985' ,'99988','100')  and 
substring(refno,1,7) = (l3.refno + ' ' ))  
from ledger l,ledger l1,ledger3 l3 , ncdx.dbo.client1 c1 , ncdx.dbo.client2 c2  
Where c1.cl_Code = c2.cl_Code And c2.party_code = l.cltcode 
and c1.trader like '%%' and substring(l.refno,1,11) = substring(l1.refno,1,11)  
and substring(l.refno,1,7) = (l3.refno + ' ' )and l.vtyp='15' and l.vtyp=l1.vtyp  
and l3.narr like @sett_nosett_type 
and l.cltcode not in ('99990' ,'61310', '99985' ,'99988','100')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TrBillTraderssp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 01/04/1980 1:40:44 AM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.TrBillTraderssp    Script Date: 20-Mar-01 11:43:37 PM ******/
CREATE PROCEDURE TrBillTraderssp AS
SELECT DISTINCT ISNULL(TRADER,'') 
FROM ncdx.dbo.CLIENT1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TrialBalanceAcc
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TrialBalanceAcc    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TrialBalanceAcc    Script Date: 01/04/1980 1:40:44 AM ******/
CREATE proc TrialBalanceAcc
@startdt varchar(11),
@enddt varchar(11),
@grpcode varchar(11)
As
select a.grpcode,a.cltcode,a.acname,
openamt=isnull(( select sum(case when drcr ='c' then vamt*-1 else vamt end )from ledger l 
     	 Where l.cltcode = a.cltcode and l.vdt >= @startdt and l.vtyp = 18
      	and l.vdt <= @enddt + ' 23:59:59' ),0) ,
amt=isnull(( select sum(case when drcr ='c' then vamt*-1 else vamt end )from ledger l 
     	 Where l.cltcode = a.cltcode and l.vdt >= @startdt and l.vtyp <> 18
      	and l.vdt <= @enddt + ' 23:59:59' ),0) 
from acmast a
where a.grpcode like @grpcode
group by a.grpcode,a.cltcode,a.acname
order by a.grpcode,a.cltcode,a.acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TrialBalTotalSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 01/04/1980 1:40:44 AM ******/
/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 8/8/01 1:37:33 PM ******/
/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.TrialBalTotalSp    Script Date: 07/24/2001 11:35:22 AM ******/
Create Proc TrialBalTotalSp
@startdate as datetime,
@enddate as datetime  
AS
select g1.grpname,g1.grpcode, 
vamt=isnull(( select sum(case when drcr ='c' then vamt*-1 else vamt end )
from ledger l ,acmast a ,grpmast g 
 Where l.cltcode = a.cltcode and g.grpcode =g1.grpcode and l.vdt >= @startdate  and l.vdt <= @enddate
and substring(a.grpcode,1,1) = substring(g.grpcode,1,1)),0) ,
totaldebit=isnull(( select sum(case when drcr ='d' then vamt else 0 end )
from ledger l ,acmast a ,grpmast g 
 Where l.cltcode = a.cltcode and g.grpcode =g1.grpcode and l.vdt >= @startdate and l.vdt <= @enddate
and substring(a.grpcode,1,1) = substring(g.grpcode,1,1)),0) ,
totalcredit=isnull(( select sum(case when drcr ='c' then vamt else 0 end )
from ledger l ,acmast a ,grpmast g 
 Where l.cltcode = a.cltcode and g.grpcode =g1.grpcode and l.vdt >= @startdate and l.vdt <= @enddate
and substring(a.grpcode,1,1) = substring(g.grpcode,1,1)),0) 
from grpmast g1 where g1.grpcode='N0000000000' or  g1.grpcode='X0000000000' or g1.grpcode='A0000000000' 
or g1.grpcode='L0000000000'  
order by grpname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATEACMAST
-- --------------------------------------------------

CREATE PROC UPDATEACMAST  
 @EXCHANGE VARCHAR(20),  
 @SEGMENT VARCHAR(20),  
 @COMPANY VARCHAR(100)  
AS  
DECLARE  
 @@SHAREDB AS VARCHAR(50),  
 @@GRPCODE AS VARCHAR(50),  
 @@SQL AS VARCHAR(2000)  
/*  
 EXEC UPDATEACMAST 'NSE', 'CAPITAL', 'MOTILAL OSWAL SECURITIES LTD'  
*/  
SELECT @@SHAREDB = ''  
SELECT TOP 1  
 @@SHAREDB = SHAREDB  
FROM  
 PRADNYA.DBO.MULTICOMPANY  
WHERE  
 EXCHANGE = @EXCHANGE  
 AND SEGMENT = @SEGMENT  
 AND COMPANYNAME = @COMPANY  
 AND PRIMARYSERVER = 1  
  
SELECT @@GRPCODE = ''  
SELECT  
 @@GRPCODE = ISNULL(GRPCODE, '')  
FROM  
 OWNER O,  
 GRPMAST G  
WHERE  
 O.CLIENTGROUP = G.GRPNAME  
IF @@SHAREDB = ''  
 BEGIN  
  SELECT ERR = 1, DESCRIPTION = 'SHARE DATABASE NOT FOUND.CANNOT CONTINUE...'  
  RETURN  
 END  
--BEGIN TRANSACTION  
SELECT @@SQL = "INSERT INTO ACMAST SELECT LONG_NAME, LONG_NAME , 'ASSET', '4', '', PARTY_CODE , '', "  
SELECT @@SQL = @@SQL + "'" + @@GRPCODE + "', '', 0, BRANCH_CD, '0', 'C', 'HDFC BANK', 'MUMBAI', 'GB019' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), " + LTRIM(RTRIM(@@SHAREDB))  
SELECT @@SQL = @@SQL + ".DBO.CLIENT2 C2 (NOLOCK) WHERE C1.CL_CODE=C2.CL_CODE "  
SELECT @@SQL = @@SQL + "AND PARTY_CODE NOT IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4) "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONG_NAME, LONGNAME = LONG_NAME, "  
SELECT @@SQL = @@SQL + "BRANCHCODE = BRANCH_CD, GRPCODE = '" + @@GRPCODE + "' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), "  
SELECT @@SQL = @@SQL + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT2 C2 (NOLOCK) "  
SELECT @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = ACMAST.CLTCODE "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONGNAME WHERE ACNAME <> LONGNAME "  
SELECT @@SQL = @@SQL + "UPDATE LEDGER SET ACNAME = A.LONGNAME "  
SELECT @@SQL = @@SQL + "FROM ACMAST A (NOLOCK) WHERE LEDGER.CLTCODE = A.CLTCODE "  
SELECT @@SQL = @@SQL + "AND LEDGER.ACNAME <> A.LONGNAME "  
  
--PRINT @@SQL  
EXEC (@@SQL)  
--COMMIT TRANSACTION  
SELECT ERR = 0, DESCRIPTION = 'ACMAST UPDATED SUCCESSFULLY...'  
  
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UpdateCost_Full
-- --------------------------------------------------
CREATE Proc UpdateCost_Full
As
Declare
@@Branch_Code As Varchar(10),
@@CostCode As Varchar(10),
@@BrCnt As Int,
@@BrCurs As Cursor

Set @@BrCurs = Cursor For
	select Distinct Branch_Code from MCDX.Dbo.Branch where branch_code not in (select distinct costname from AccountMCDX.Dbo.Costmast)
Open @@BrCurs
Fetch Next From @@BrCurs Into @@Branch_Code
While @@Fetch_Status = 0
	Begin
		Select @@CostCode = Convert(Varchar(10), IsNull(Max(CostCode)+1, 1)) From AccountMcdx.DBO.CostMast
		Insert Into AccountMCDX.Dbo.CostMast Values (@@Branch_Code, @@CostCode, 1, '10000000000')
		Fetch Next From @@BrCurs Into @@Branch_Code
	End
Close @@BrCurs
Set @@BrCurs = Cursor For
	select Distinct CostName from AccountMCDX.Dbo.CostMast where CostName not in (select distinct Branchname from AccountMCDX.Dbo.BranchAccounts)
Open @@BrCurs
Fetch Next From @@BrCurs Into @@Branch_Code
	While @@Fetch_Status = 0
		Begin
			Insert Into AccountMCDX.Dbo.BranchAccounts Values (@@Branch_Code, @@Branch_Code, 'HOCTRL', 0)
			Fetch Next From @@BrCurs Into @@Branch_Code
		End
Close @@BrCurs
Insert Into AccountMcdx.Dbo.AcMast
Select LTrim(RTrim(BranchName)) + ' Control A/c', LTrim(RTrim(BranchName)) + ' Control A/c',
	'ASSET', '4', '', LTrim(RTrim(BrControlAc)), '', 'A0000000000', '', '0', LTrim(RTrim(BranchName)),
	'0', 'C', '', '', ''
From AccountMCDX.Dbo.BranchAccounts Where BrControlAc Not In (Select Distinct CltCode From AccountMCDX.Dbo.AcMast)


Set @@BrCurs = Cursor For
	select Distinct Branch_Code from NCDX.Dbo.Branch where branch_code not in (select distinct costname from AccountNCDX.Dbo.Costmast)
Open @@BrCurs
Fetch Next From @@BrCurs Into @@Branch_Code
While @@Fetch_Status = 0
	Begin
		Select @@CostCode = Convert(Varchar(10), IsNull(Max(CostCode)+1, 1)) From AccountNcdx.DBO.CostMast
		Insert Into AccountNCDX.Dbo.CostMast Values (@@Branch_Code, @@CostCode, 1, '10000000000')
		Fetch Next From @@BrCurs Into @@Branch_Code
	End
Close @@BrCurs
Set @@BrCurs = Cursor For
	select Distinct CostName from AccountNCDX.Dbo.CostMast where CostName not in (select distinct Branchname from AccountNCDX.Dbo.BranchAccounts)
Open @@BrCurs
Fetch Next From @@BrCurs Into @@Branch_Code
	While @@Fetch_Status = 0
		Begin
			Insert Into AccountNCDX.Dbo.BranchAccounts Values (@@Branch_Code, @@Branch_Code, 'HOCTRL', 0)
			Fetch Next From @@BrCurs Into @@Branch_Code
		End
Close @@BrCurs
Insert Into AccountNcdx.Dbo.AcMast
Select LTrim(RTrim(BranchName)) + ' Control A/c', LTrim(RTrim(BranchName)) + ' Control A/c',
	'ASSET', '4', '', LTrim(RTrim(BrControlAc)), '', 'A0000000000', '', '0', LTrim(RTrim(BranchName)),
	'0', 'C', '', '', ''
From AccountNCDX.Dbo.BranchAccounts Where BrControlAc Not In (Select Distinct CltCode From AccountNCDX.Dbo.AcMast)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_angel_STREG
-- --------------------------------------------------
--sp_helptext usp_angel_STREG     
      
--sp_helptext usp_angel_STREG2          
          
--exec usp_angel_STREG2 '2009-03-01','2009-03-28'        
--exec usp_angel_STREG '2008-09-01','2008-09-30'           
CREATE proc [dbo].[usp_angel_STREG]                          
( @fvdt as datetime,@tvdt as datetime)                           
                          
as                          
set nocount on                        
              
              
--declare @fvdt as datetime,@tvdt as datetime              
--set @fvdt = '2008-09-01'              
--set @tvdt = '2008-09-01'     
--left(convert(varchar,vdt,121),11)  --convert(varchar(11),convert(datetime,vdt),103)         
                     
select * into #t from ledger nolock where  cltcode='400002' and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                          
              
                  
select drcr= case                   
when drcr = 'D' then 'C'                   
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                  
                  
select left(vdt,11) as [Date],VNO,cltcode,acname, segment='NCDX',vamt,space(10) as [Expense Code],space(100) as [Expense Code Name],space(20) as [Expense Amount], space(20) as [400002],space(20) as [410002],space(20) as [420002],space(20) as [Total],space(20) as [Rate],space(30) as [PAN No.],space(50) as [Service Tax No.],space(500) as [Address],narration as [Narration],DRCR,vtyp  into #file1 from                  
(                  
select * from #t                
union                 
select x.* from                  
(                  
select l.*          
from ledger l (nolock), #t t           
where l.vtyp = t.vtyp and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' or l.cltcode not like '5%')                   
) x  
inner join                  
(select * from #l1)y                  
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                  
) x where cltcode not like '26%'                  
                          
  update #file1 set vamt = 0 where vamt = ''            
update #file1 set [Expense Amount] = 0 where [Expense Amount] = ''              
  update #file1 set [400002] = 0 where [400002] = ''            
update #file1 set [410002] = 0 where [410002] = ''           
update #file1 set [420002] = 0 where [420002] = ''     
    
--select * from #file1              
                          
update #file1 set [Expense Code]=b.cltcode,[Expense Amount]=b.vamt from                          
(select cltcode,vno,vamt,vtyp from ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a    
 where a.vno=b.vno  and a.vtyp=b.vtyp       
    
update #file1 set [Expense Code Name]=b.acname from                          
(select cltcode,vno,vamt,acname from ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a    
 where a.vno=b.vno       
                  
----------------    cltcode like '5%' and                      
update #file1 set [Service Tax No.]=v.st_no, [PAN No.]= v.pan_no, [Address]=v.add1+' '+v.add2+' '+v.add3+' '+v.city+' '+v.pin+' '+v.state  from                          
(select cltcode,vno from ledger  where  vno in ( select vno from #t))b, #file1 a, [172.19.2.98].account123.dbo.vendormaster v    
 where a.vno=b.vno and v.segment= 'NCDEX' and convert(varchar,v.cltcode)=b.cltcode    
-----------------    
                          
update #file1 set [400002]=b.vamt from                          
(select cltcode,vno,vamt from ledger  where cltcode ='400002' and vno in ( select vno from #t))b,#file1 a       where a.vno=b.vno                            
                          
                          
update #file1 set [410002]=b.vamt from                          
(select cltcode,vno,vamt from ledger  where cltcode ='410002' and vno in ( select vno from #t))b,#file1 a                    
 where a.vno=b.vno                            
                          
                          
update #file1 set [420002]=b.vamt from                          
(select cltcode,vno,vamt from ledger  where cltcode ='420002' and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno            
      
update #File1 set [Total] = convert(money,[400002])+convert(money,[410002])+convert(money,[420002])                          
        
update #File1 set [Rate] = case when convert(money,[Expense Amount]) <> 0 then convert(money,[Total])/convert(money,[Expense Amount])*100         
else 0 end --from                
--(select cltcode,vno,vamt from ledger  where cltcode ='420002' and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno          
          
select * from #file1 where cltcode <> '400002'              
              
              
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_angel_STREG1
-- --------------------------------------------------
--sp_helptext usp_angel_STREG2                      
                      
--exec usp_angel_STREG2 '2009-03-01','2009-03-28'                    
--exec usp_angel_STREG1 '2008-09-01','2008-09-30' ,'400002'                      
CREATE proc [dbo].[usp_angel_STREG1]                                      
( @fvdt as datetime,@tvdt as datetime, @code as varchar(10))                                       
                                      
as                                      
          
set nocount on                                    
          
declare  @code1 as varchar(10), @code2 as varchar(10)          
set @code1 = '4100' + right(@code, 2)          
set @code2= '4200' + right(@code, 2)                        
--declare @fvdt as datetime,@tvdt as datetime                          
--set @fvdt = '2008-09-01'                          
--set @tvdt = '2008-09-01'                 
--left(convert(varchar,vdt,121),11)  --convert(varchar(11),convert(datetime,vdt),103)                     
                                 
select * into #t from ledger nolock where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                                      
                          
                              
select drcr= case                               
when drcr = 'D' then 'C'                               
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                              
select convert(varchar(11),vdt,103) as [Date],VNO,cltcode,acname, segment='NCDX',vamt,space(10) as [Expense Code],space(100) as [Expense Code Name],space(20) as [Expense Amount],space(20) as [ST],space(20) as [EC],space(20) as [SHEC],space(20) as [Total],
  
    
space        
          
(20) as [Rate],space(30) as [PAN No.],space(50) as [Service Tax No.],space(500) as [Address],narration as [Narration],DRCR,vtyp  into #file1 from                              
(                              
select * from #t                            
union                             
select x.* from                              
(                              
select l.*                      
from ledger l (nolock), #t t                       
where l.vtyp = t.vtyp and l.vtyp <> '18' and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' or l.cltcode not like '5%')                 
  
    
              
) x              
inner join                              
(select * from #l1)y                              
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                              
) x where cltcode not like '26%'                              
                                      
  update #file1 set vamt = 0 where vamt = ''                        
update #file1 set [Expense Amount] = 0 where [Expense Amount] = ''                          
    update #file1 set [ST] = 0 where [ST] = ''                        
update #file1 set [EC] = 0 where [EC] = ''                       
update #file1 set [SHEC] = 0 where [SHEC] = ''               
                
--select * from #file1                          
                                      
update #file1 set [Expense Code]=b.cltcode,[Expense Amount]=b.vamt from                                      
(select cltcode,vno,vamt,vtyp from ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a                
 where a.vno=b.vno  and a.vtyp=b.vtyp                   
                
update #file1 set [Expense Code Name]=b.acname from                                      
(select cltcode,vno,vamt,acname from ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a                
 where a.vno=b.vno                   
                              
----------------    cltcode like '5%' and                                  
update #file1 set [Service Tax No.]=v.st_no, [PAN No.]= v.pan_no, [Address]=v.add1+' '+v.add2+' '+v.add3+' '+v.city+' '+v.pin+' '+v.state  from                                      
(select cltcode,vno from ledger  where  vno in ( select vno from #t))b, #file1 a, Intranet.angelvms.dbo.vendormaster v             where a.vno=b.vno and v.segment= 'NCDEX' and convert(varchar,v.cltcode)=b.cltcode                
-----------------                
                           
                                      
update #file1 set [ST]=b.vamt from                                      
(select cltcode,vno,vamt from ledger  where cltcode =@code and vno in ( select vno from #t))b,#file1 a   where a.vno=b.vno                                        
                                      
                                      
update #file1 set [EC]=b.vamt from                                   
(select cltcode,vno,vamt from ledger  where cltcode =@code1 and vno in ( select vno from #t))b,#file1 a                                
 where a.vno=b.vno                                        
                                      
                                      
update #file1 set [SHEC]=b.vamt from                                      
(select cltcode,vno,vamt from ledger  where cltcode =@code2 and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno                        
                  
update #File1 set [Total] = convert(money,[ST])+convert(money,[EC])+convert(money,[SHEC])                                        
update #File1 set [Rate] = case when convert(money,[Expense Amount]) <> 0 then convert(money,[Total])/convert(money,[Expense Amount])*100                     
else 0 end --from                            
--(select cltcode,vno,vamt from ledger  where cltcode ='420002' and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno                      
                      
select * from #file1 where cltcode <> @code                        
                          
                          
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_angel_STREG2
-- --------------------------------------------------
--sp_helptext usp_angel_STREG2                
                
--exec usp_angel_STREG2 '2009-03-01','2009-03-28'              
--exec usp_angel_STREG2 '2008-04-01','2008-04-30','400002' 'ncdx'                 
CREATE proc [dbo].[usp_angel_STREG2]                                
( @fvdt as datetime,@tvdt as datetime, @code as varchar(10))                                 
                                
as                                
    
set nocount on                              
    
declare  @code1 as varchar(10), @code2 as varchar(10)    
set @code1 = '4100' + right(@code, 2)    
set @code2= '4200' + right(@code, 2)                  
--declare @fvdt as datetime,@tvdt as datetime                    
--set @fvdt = '2008-09-01'                    
--set @tvdt = '2008-09-01'           
--left(convert(varchar,vdt,121),11)  --convert(varchar(11),convert(datetime,vdt),103)               
                           
select * into #t from ledger nolock where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                                
                    
                        
select drcr= case                         
when drcr = 'D' then 'C'                         
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                        
                        
select left(vdt,11) as [Date],VNO,cltcode,acname, segment='NCDX',vamt,space(10) as [Expense Code],space(100) as [Expense Code Name],space(20) as [Expense Amount],space(20) as [ST],space(20) as [EC],space(20) as [SHEC],space(20) as [Total],space   
(20) as [Rate],space(30) as [PAN No.],space(50) as [Service Tax No.],space(500) as [Address],narration as [Narration],DRCR,vtyp  into #file1 from                        
(                        
select * from #t                      
union                       
select x.* from                        
(                        
select l.*                
from ledger l (nolock), #t t                 
where l.vtyp = t.vtyp and l.vtyp <> '18' and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' or l.cltcode not like '5%')                         
) x        
inner join                        
(select * from #l1)y                        
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                        
) x where cltcode not like '26%'                      
                                
  update #file1 set vamt = 0 where vamt = ''                  
update #file1 set [Expense Amount] = 0 where [Expense Amount] = ''                    
    update #file1 set [ST] = 0 where [ST] = ''                  
update #file1 set [EC] = 0 where [EC] = ''                 
update #file1 set [SHEC] = 0 where [SHEC] = ''         
          
--select * from #file1                    
                                
update #file1 set [Expense Code]=b.cltcode,[Expense Amount]=b.vamt from                                
(select cltcode,vno,vamt,vtyp from ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a          
 where a.vno=b.vno  and a.vtyp=b.vtyp             
          
update #file1 set [Expense Code Name]=b.acname from                                
(select cltcode,vno,vamt,acname from ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a          
 where a.vno=b.vno             
                        
----------------    cltcode like '5%' and                            
update #file1 set [Service Tax No.]=v.st_no, [PAN No.]= v.pan_no, [Address]=v.add1+' '+v.add2+' '+v.add3+' '+v.city+' '+v.pin+' '+v.state  from                                
(select cltcode,vno from ledger  where  vno in ( select vno from #t))b, #file1 a, [172.19.2.98].account123.dbo.vendormaster v          
 where a.vno=b.vno and v.segment= 'NCDEX' and convert(varchar,v.cltcode)=b.cltcode          
-----------------          
                     
                                
update #file1 set [ST]=b.vamt from                                
(select cltcode,vno,vamt from ledger  where cltcode =@code and vno in ( select vno from #t))b,#file1 a   where a.vno=b.vno                                  
                                
                                
update #file1 set [EC]=b.vamt from                             
(select cltcode,vno,vamt from ledger  where cltcode =@code1 and vno in ( select vno from #t))b,#file1 a                          
 where a.vno=b.vno                                  
                                
                                
update #file1 set [SHEC]=b.vamt from                                
(select cltcode,vno,vamt from ledger  where cltcode =@code2 and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno                  
            
update #File1 set [Total] = convert(money,[ST])+convert(money,[EC])+convert(money,[SHEC])                                  
update #File1 set [Rate] = case when convert(money,[Expense Amount]) <> 0 then convert(money,[Total])/convert(money,[Expense Amount])*100               
else 0 end --from                      
--(select cltcode,vno,vamt from ledger  where cltcode ='420002' and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno                
                
select * from #file1 where cltcode <> @code                  
                    
                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FETCH_Ledger1
-- --------------------------------------------------
CREATE Proc USP_FETCH_Ledger1(@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(25),@Code as varchar(20))                                    
as        
        
/*declare @segment as varchar(25)                                    
declare @fdate as varchar(25)                                    
declare @tdate as varchar(25)          
declare @Code as varchar(10)          
*/        
declare @str as varchar(5000)                    
declare @table as varchar(25)                    
declare @condition as varchar(1000)                    
declare @file as varchar(100)                                    
declare @s as varchar(1000)                                    
declare @s1 as varchar(1000)                       
                                    
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))              
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))           
        
        
/*set @fdate = 'May 01 2009'                                    
set @tdate = 'May 01 2009'                                    
set @segment = 'NSE'          
set @Code = 'ALL'         
*/        
If @Code = 'ALL'          
Begin          
 SET @condition =                      
 CASE                       
 WHEN @segment = 'AFAPL' THEN 'left(cltcode,3) in (''310'',''380'',''270'')'                      
 WHEN @segment = 'NBFC' THEN 'left(cltcode,3) in (''310'',''380'',''270'')' ELSE 'left(cltcode,3) = ''270'''  END           
End           
Else          
Begin          
 SET @condition = 'left(cltcode,3) = '''+@Code+''''          
End           
        
create table #Temp          
(          
 SrNo int identity(1,1) not null,          
 VNo varchar(20)          
)        
        
set @str = 'insert into #Temp select distinct vno from ledger x (nolock)  where vdt > = '''+@fdate+'''   
and vdt < = '''+@tdate+'''+'' 23:59:59''                    
and  vtyp = ''8'' and exists                     
(Select vno from ledger b where x.vno = b.vno and '+@condition+'                     
and vtyp = ''8'' and vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59'' )'          
exec(@str)          
        
delete from  mis.upload.dbo.Ledger_txt       

insert into mis.upload.dbo.Ledger_txt                              
select 'SrNo'+'|'+'vtyp'+'|'+'vno'+'|'+'vdt'+'|'+'cltcode'+'|'+'LONGNAME'+'|'+'drcr'+'|'+'vamt'+'|'+'narration'+'|'+'Branch Code'  
        
set @str = 'insert into mis.upload.dbo.Ledger_txt select ltrim(rtrim(Convert(Varchar,b.srno)))+''|''+  
ltrim(rtrim(Convert(Varchar,vtyp)))+''|''+ltrim(rtrim(Convert(Varchar,x.vno)))+''|''+  
ltrim(rtrim(Convert(Varchar(12),vdt,107)))+''|''+ltrim(rtrim(X.cltcode))+''|''+
ltrim(rtrim(LONGNAME))+''|''+ltrim(rtrim(x.drcr))+''|''+ltrim(rtrim(convert(varchar,vamt)))+''|''+  
ltrim(rtrim(narration))+''|''+ltrim(rtrim(isnull(costname,'''')))    
from            
(Select * from ledger x (nolock)  where vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59''         and  vtyp = ''8'' and exists                     
(Select vno from ledger b (nolock)  where x.vno = b.vno and '+@condition+'                     
and vtyp = ''8'' and vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59'' ))x                    
left outer join                    
(select * from ACMAST (nolock))y                    
on x.cltcode=y.CLTCODE                    
left outer join                    
(select * from ledger2  (nolock))z                    
on x.vno = z.vno and x.lno = z.lno and x.cltcode = z.cltcode and x.vtyp = z.vtype                    
left outer join (select * from costmast (nolock))a on z.costcode = a.costcode          
left outer join (select * from #Temp)b on x.vno = b.vno'        
exec(@str)        
        
      
/*      
set @file = '196.1.115.136\D$\upload1\Account\'+ltrim(rtrim(@segment))+''+convert(varchar,getdate(),112)+'.txt'                                 
                              
set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT txt FROM Ledger_txt" queryout '+@file+' -c -Sintranet -Uinhouse -Pinh6014'                                          
set @s1= @s+''''                                          
exec(@s1)             
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ncdx_reco1
-- --------------------------------------------------
    
CREATE PROCEDURE usp_ncdx_reco1                 
 as                   
set nocount on                   
set transaction isolation level read uncommitted         
    
/*RECO - check reconsiled suspense a/c with unrecosiled client ledger */      
      
select * into #ncdx_cr from ledger (nolock) where vdt >=getdate()-60 and vtyp=2 and drcr='C' and  cltcode='5100000001'      
      
select * into #ncdx_dr from ledger (nolock) where vdt >=getdate()-60 and vtyp=3 and drcr='D' and  cltcode='5100000001'      
      
select ddno,vno,lno,reldt into #chqnodr from ledger1 (nolock) where vtyp=3 and vno >='200801010000'        
          
select ddno,vno,lno,reldt into #chqno from ledger1 (nolock) where vtyp=2 and vno >='200801010000'            
      
select a.*,b.ddno,b.reldt into #ncdx1dr from #ncdx_dr a, #chqnodr b where a.vno=b.vno and a.lno=b.lno            
      
select a.*,b.ddno,b.reldt into #ncdx1 from #ncdx_cr a, #chqno b where a.vno=b.vno and a.lno=b.lno            
      
delete from #ncdx1 where cltcode+'|'+convert(varchar(25),ddno) in (select cltcode+'|'+convert(varchar(25),ddno)  from #ncdx1dr)        
      
delete from mis.bse.dbo.ncdx_reco1       
      
select  a.vtyp,a.vno,a.vdt,a.drcr,a.vamt,a.ddno,b.cltcode,b.ddno as ddno1,b.cramt,a.reldt ,a.edt, a.narration into #temp    
      
from      
      
(select * from #ncdx1  where cltcode='5100000001'  and reldt <> 'Jan  1 1900') a,      
      
angel_client_deposit_recno b where a.ddno=b.ddno and a.vamt=b.cramt      
      
insert into mis.bse.dbo.ncdx_reco1       
select  a.*,b.cltcode,b.acname from #temp a inner join ledger b on a.vno=b.vno where b.drcr='d'and b.vtyp='2'         
  
----------------- check for unreconsiled suspense account      
      
--select * from #ncdx1  where cltcode='5100000001' and reldt ='Jan  1 1900'      
      
      
delete mis.bse.dbo.ncdx_noreco       
select vtyp,vno,edt,acname,drcr,vamt,balamt,cltcode,ddno,vdt,narration into #temp1 from #ncdx1  where cltcode='5100000001' and reldt ='Jan  1 1900'      
insert into  mis.bse.dbo.ncdx_noreco       
select a.*,b.cltcode,b.acname from #temp1 a inner join ledger b on a.vno=b.vno where b.drcr='d' and b.vtyp='2'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BANKPOFILEGEN
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BANKPOFILEGEN]
(
	@VTYP VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12),	
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@FILETYPE VARCHAR(4),
	@PRINTFLAG CHAR(2)
)

AS
	
	IF @PRINTFLAG = 'FP'
	BEGIN
		SELECT 
			L1.DDDT,
			L.VNO,
			ISNULL(DD,0) DD,
			ISNULL(DDNO,'') DDNO,
			VAMT = ISNULL(L.VAMT,0), 
			L.DRCR,
			L.CLTCODE, 
			L.ACNAME,
			CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), 
			L.NARRATION,
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			L1.MICRNO,
			L.BOOKTYPE, 
			HOPAYMODE,
			M.ACCNO
		FROM 
			ACCOUNT.DBO.V2_SETTPAYOUT_ALL S (NOLOCK)
			LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.CLTCODE = M.CLTCODE AND M.DEFAULTBANK = 1, 
			LEDGER L (NOLOCK), 	
			LEDGER1 L1 (NOLOCK),
			(
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE 
			FROM 
				LEDGER (NOLOCK)
			WHERE 
				CLTCODE = @BANKCODE 
				AND VTYP = @VTYP
				AND VNO BETWEEN @VNOFROM AND @VNOTO 
				AND VDT BETWEEN @FROMDATE AND @TODATE
			) B
		WHERE 
			L.VTYP = @VTYP 
			AND L.VTYP = L1.VTYP 
			AND L.BOOKTYPE = L1.BOOKTYPE 
			AND L.VNO = L1.VNO 
			AND L.LNO = L1.LNO			
			AND L.VTYP = B.VTYP 
			AND L.BOOKTYPE = B.BOOKTYPE 
			AND L.VNO = B.VNO
			AND L.VNO BETWEEN @VNOFROM AND @VNOTO 
			AND L.VDT BETWEEN @FROMDATE AND @TODATE 
			AND S.CLTCODE = L.CLTCODE
			AND L.CLTCODE <> @BANKCODE
			AND S.VNO = L.VNO 
			AND S.HOPAYMODE = @FILETYPE 
			AND CHQPRINTED = 0
			AND EXCHANGE = @EXCHANGE 
			AND SEGMENT = @SEGMENT
		ORDER BY 
			L.VNO 
	END
	
	ELSE
	BEGIN
		SELECT 
			L1.DDDT,
			L.VNO,
			ISNULL(DD,0) DD,
			ISNULL(DDNO,'') DDNO,
			VAMT = ISNULL(L.VAMT,0), 
			L.DRCR,
			L.CLTCODE, 
			L.ACNAME,
			CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), 
			L.NARRATION,
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			L1.MICRNO,
			L.BOOKTYPE, 
			HOPAYMODE,
			M.ACCNO
		FROM 
			ACCOUNT.DBO.V2_SETTPAYOUT_ALL S (NOLOCK)
			LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.CLTCODE = M.CLTCODE AND M.DEFAULTBANK = 1,  
			LEDGER L (NOLOCK), 	
			LEDGER1 L1 (NOLOCK),
			(
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE 
			FROM 
				LEDGER (NOLOCK)
			WHERE 
				CLTCODE = @BANKCODE 
				AND VTYP = @VTYP
				AND VNO BETWEEN @VNOFROM AND @VNOTO 
				AND VDT BETWEEN @FROMDATE AND @TODATE
			) B
		WHERE 
			L.VTYP = @VTYP 
			AND L.VTYP = L1.VTYP 
			AND L.BOOKTYPE = L1.BOOKTYPE 
			AND L.VNO = L1.VNO 
			AND L.LNO = L1.LNO			
			AND L.VTYP = B.VTYP 
			AND L.BOOKTYPE = B.BOOKTYPE 
			AND L.VNO = B.VNO
			AND L.VNO BETWEEN @VNOFROM AND @VNOTO 
			AND L.VDT BETWEEN @FROMDATE AND @TODATE 
			AND S.CLTCODE = L.CLTCODE
			AND L.CLTCODE <> @BANKCODE
			AND S.VNO = L.VNO 
			AND S.HOPAYMODE = @FILETYPE 
			AND CHQPRINTED > 0
			AND EXCHANGE = @EXCHANGE 
			AND SEGMENT = @SEGMENT			
		ORDER BY 
			L.VNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_ALL
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BULKPAYOUTPOSTING_ALL]
(
	@SESSIONID VARCHAR(50),
	@UNAME VARCHAR(50),
	@S_SESSIONID VARCHAR(50),
	@GENFLAG VARCHAR(1),
	@SEGMENT VARCHAR(6),
	@CLIENT VARCHAR(10) = ''
)

AS

	-- EXEC ACCOUNT.DBO.V2_BULKPAYOUTPOSTING_ALL '84449309411212008', 'DEMO', '844493094', 'A', 'NSECM' 

	SET NOCOUNT ON

	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@MAXCOUNT AS INT,
		@@VDT AS VARCHAR(11),
		@@BANKBRANCH AS VARCHAR(10),
		@@BANKCOST AS NUMERIC,
		@@VNOCUR AS CURSOR,
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS VARCHAR(12),
		@@ERROR_COUNT INT,
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@BOOKTYPE CHAR(2),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@VTYP SMALLINT,
		@@BNKCODE VARCHAR(100),
		@@MAXVNO INT,
		@@SQL VARCHAR(2500),
		@@EXCH CHAR(3),
		@@SEG CHAR(7)

	IF @SEGMENT = 'NSECM'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'BSECM'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'NSEFUT'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'BSEFUT'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'NSXFUT'
	BEGIN
		SET @@EXCH = 'NSX'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'MCDFUT'
	BEGIN
		SET @@EXCH = 'MCD'
		SET @@SEG = 'FUTURES'
	END
	-------------------------- UPDATE BANK CODE DETAILS ------------------------
	UPDATE
		P
	SET 
		BNKNAME = A.ACNAME,
		BRANCHCODE = A.BRANCHCODE,
		MICRNO = A.MICRNO,
		BOOKTYPE = A.BOOKTYPE,
		ACCDTLS = A.ACCDTLS,
		UPDFLAG = 'Y'
	FROM 
		V2_PAYOUT_TEMP P,
		ACMAST A
	WHERE 
		P.BNKCODE = A.CLTCODE
		AND ACCAT = 2
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		COSTCODE = C.COSTCODE,
		ACNAME = A.LONGNAME
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_PAYOUT_TEMP P
	WHERE 
		A.CLTCODE = ACCODE
		AND ACCAT IN ('4')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		BANKCOST = C.COSTCODE
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_PAYOUT_TEMP P
	WHERE 
		A.CLTCODE = BNKCODE
		AND ACCAT IN ('2')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		V2_PAYOUT_TEMP
	SET 
		BANKCOST = COSTCODE
	WHERE 
		BANKCOST = ''
		AND SESSIONID = @SESSIONID

	-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
	) A

	IF @@ERROR_COUNT > 0
	BEGIN
		SELECT 
			'FOLLOWING CLIENTS DO NOT EXIST<BR>'
		UNION ALL
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
		DELETE FROM 
			V2_PAYOUT_TEMP 
		WHERE 
			SESSIONID = @SESSIONID
		RETURN
	END

	--------------------------AUTO GENERATION OF VNO ------------------------
	SELECT
		@@STD_DATE = LEFT(SDTCUR, 11),
		@@LST_DATE = LEFT(LDTCUR, 11),
		@@VNOMETHOD = VNOFLAG
	FROM 
		PARAMETER
	WHERE 
		CURYEAR = 1     

	SET @@VNOCUR = CURSOR FOR
	SELECT DISTINCT
		BNKCODE,
		BOOKTYPE,
		VTYP
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	OPEN @@VNOCUR
	FETCH NEXT
	FROM
		@@VNOCUR
	INTO
		@@BNKCODE,
		@@BOOKTYPE,
		@@VTYP
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE
		#BANK_VNO
		(
			SRNO INT,
			NEWSRNO INT IDENTITY (1, 1)
		)

	INSERT INTO
		#BANK_VNO
	SELECT DISTINCT 
		SRNO
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		BNKCODE = @@BNKCODE
		AND BOOKTYPE = @@BOOKTYPE
		AND SESSIONID = @SESSIONID

	SELECT
		@@MAXCOUNT = COUNT(DISTINCT SRNO)
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT TOP 1
		@@VDT = VDT
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT  
		LASTVNO  
	INTO 
		#VNO  
	FROM  
		LASTVNO  
	WHERE  
		1 = 2

	SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

	INSERT INTO 
		#VNO
	EXEC 
		ACC_GENVNO_NEW
		@@VDT,
		@@VTYP,
		@@BOOKTYPE,
		@@STD_DATE,
		@@LST_DATE,  
		@@MAXVNO  

	SELECT  
		@@NEWVNO = LASTVNO  
	FROM  
		#VNO

	UPDATE
		P
	SET 
		VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
	FROM
		V2_PAYOUT_TEMP P WITH(NOLOCK),
		#BANK_VNO BV
	WHERE
		P.SRNO = BV.SRNO 
		AND SESSIONID = @SESSIONID

	DROP TABLE #VNO  
	DROP TABLE #BANK_VNO

	FETCH NEXT  
	FROM @@VNOCUR  
	INTO  
		@@BNKCODE,  
		@@BOOKTYPE,
		@@VTYP  
	END  

	DEALLOCATE @@VNOCUR

	--------------------------AUTO GENERATION OF LNO ------------------------
	UPDATE
		V2_PAYOUT_TEMP
	SET 
		LNO = 2
	WHERE 
		VNO IN
	(
		SELECT
			VNO
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			SESSIONID = @SESSIONID
		GROUP BY 
			VNO
		HAVING 
			COUNT(*) = 1
	)

	SET @@LNOCUR = CURSOR FOR
	SELECT
		VNO
	FROM 
		V2_PAYOUT_TEMP WITH(NOLOCK) 
	WHERE 
		SESSIONID = @SESSIONID
	GROUP BY 
		VNO
	HAVING 
		COUNT(*) > 1

	OPEN @@LNOCUR
	FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE [#LNOGEN] 
		(
			VNO VARCHAR(12),
			SNO INT,
			LNO INT IDENTITY(1,1)
		)

		INSERT INTO 
			#LNOGEN
		SELECT
			VNO,
			SRNO
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			VNO = @@LNOVNO 
			AND SESSIONID = @SESSIONID
		ORDER BY 
			SRNO

		UPDATE
			V2_PAYOUT_TEMP
		SET 
			LNO = L.LNO + 1
		FROM 
			#LNOGEN L
		WHERE 
			V2_PAYOUT_TEMP.VNO = L.VNO
			AND V2_PAYOUT_TEMP.SRNO = L.SNO
			AND V2_PAYOUT_TEMP.LNO = 0 
			AND SESSIONID = @SESSIONID

		DROP TABLE #LNOGEN
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	END

	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR

	BEGIN TRANSACTION

	--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
	INSERT INTO 
		LEDGER1
	SELECT
		BNKNAME,
		BRNNAME = BRCODE,
		DD = LEFT(PAYMODE, 1),
		DDNO,
		DDDT = VDT,
		RELDT = '',
		RELAMT = AMT,
		REFNO = 0,
		RECEIPTNO = 0,
		VTYP,
		VNO,
		LNO = 2,
		DRCR,
		BOOKTYPE,
		MICRNO,
		SLIPNO = 0,
		SLIPDATE = '',
		CHEQUEINNAME = ISNULL(ACNAME,''),
		CHQPRINTED = 0,
		CLEAR_MODE = ''
	FROM
		V2_PAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = ACCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO,
		DRCR,
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = ACCODE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO = 1,
		BNKNAME,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = BNKCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO = 1,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = BNKCODE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	UPDATE 
		V2_PAYOUT_TEMP 
	SET 
		LEDGER2_UPD = 'Y' 
	WHERE 
		SESSIONID = @SESSIONID 
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = 1,
		NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = LNO,
		NARR = NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	DECLARE @@L2CUR AS CURSOR,
	@@L2VNO AS VARCHAR(12)

	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		DELETE FROM 
			TEMPLEDGER2
		WHERE 
			SESSIONID =  @S_SESSIONID

		/*==============================
		CLIENT SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			C.COSTNAME,
			AMT,
			VTYP,
			VNO,
			LNO,
			DRCR,
			'0',
			BOOKTYPE,
			@S_SESSIONID ,
			ACCODE,
			'A',
			'0'
		FROM
			V2_PAYOUT_TEMP RP,
			COSTMAST C
		WHERE
			RP.COSTCODE = C.COSTCODE
			AND VNO = @@L2VNO
			AND SESSIONID = @SESSIONID

		/*==============================
		BANK SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			BRANCHCODE,
			SUM(AMT),
			VTYP,
			VNO,
			LNO = 1,
			DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
			'0',
			BOOKTYPE,
			@S_SESSIONID,
			BNKCODE,
			'A',
			'0'
		FROM
			V2_PAYOUT_TEMP
		WHERE
			VNO = @@L2VNO
			AND SESSIONID = @SESSIONID
		GROUP BY 
			BRANCHCODE, 
			VTYP, 
			VNO, 
			(CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE

		EXEC INSERTTOLEDGER2 
				@S_SESSIONID, 
				@@L2VNO, 
				'1', 
				'1', 
				'1', 
				'BROKER', 
				'BROKER'

		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END

	DELETE FROM 
		TEMPLEDGER2
	WHERE 
		SESSIONID =  @S_SESSIONID

	SELECT @@SQL = ""
	SELECT @@SQL = @@SQL + "UPDATE S "
	SELECT @@SQL = @@SQL + "SET "
	SELECT @@SQL = @@SQL + "	STATUS = 'A', "
	SELECT @@SQL = @@SQL + "	APPROVEDDT = GETDATE(), "
	SELECT @@SQL = @@SQL + "	HOPAYMODE = P.PAYMODE, "
	SELECT @@SQL = @@SQL + "	BANKCODE = P.BNKCODE, "
	SELECT @@SQL = @@SQL + "	VNO = P.VNO, "
	SELECT @@SQL = @@SQL + "	VDT = P.VDT, "
	SELECT @@SQL = @@SQL + "	EDT = P.EDT, "
	SELECT @@SQL = @@SQL + "	AMOUNTTOBEPAID = P.AMT, "
	SELECT @@SQL = @@SQL + "	REMARK = P.REMARK "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_SETTPAYOUT_ALL S, "
	SELECT @@SQL = @@SQL + "	V2_PAYOUT_TEMP P "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	CLTCODE = ACCODE "
	SELECT @@SQL = @@SQL + "	AND S.BRANCHCODE = BRCODE "
	SELECT @@SQL = @@SQL + "	AND GENFLAG = '" + @GENFLAG + "' "
	SELECT @@SQL = @@SQL + "	AND STATUS IN ('P', 'I') "
	SELECT @@SQL = @@SQL + "	AND P.SESSIONID = '" + @SESSIONID + "' "
	SELECT @@SQL = @@SQL + "	AND S.EXCHANGE = '" + @@EXCH + "' "
	SELECT @@SQL = @@SQL + "	AND S.SEGMENT = '" + @@SEG + "' "
	SELECT @@SQL = @@SQL + "	AND S.CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "INSERT INTO ACCOUNT.DBO.V2_PAYOUTCLIENT "
	SELECT @@SQL = @@SQL + "SELECT ACCODE FROM V2_PAYOUT_TEMP WHERE UPDFLAG = 'Y' AND SESSIONID = '" + @SESSIONID + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_LEDGERBALANCE_ALL "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTYCODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "
	SELECT @@SQL = @@SQL + "	AND CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_LEDGERBALANCE_NET "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTY_CODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "
	SELECT @@SQL = @@SQL + "	AND CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_FOLEDBAL "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	CLTCODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "

	SELECT @@SQL = @@SQL + "DELETE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT "

	EXEC (@@SQL)

	SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
	UNION ALL
	SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
	UNION ALL
	SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT '<HR>'
	UNION ALL
	SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '<BR><BR>~'
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

	DELETE FROM 
		V2_PAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_SEBI
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BULKPAYOUTPOSTING_SEBI]
(
	@SESSIONID VARCHAR(50),
	@UNAME VARCHAR(50),
	@S_SESSIONID VARCHAR(50),
	@GENFLAG VARCHAR(1),
	@SEGMENT VARCHAR(6)
)

AS

	-- EXEC ACCOUNT.DBO.V2_BULKPAYOUTPOSTING_SEBI '84449309411212008', 'DEMO', '844493094', 'A', 'NSECM' 

	SET NOCOUNT ON

	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@MAXCOUNT AS INT,
		@@VDT AS VARCHAR(11),
		@@BANKBRANCH AS VARCHAR(10),
		@@BANKCOST AS NUMERIC,
		@@VNOCUR AS CURSOR,
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS VARCHAR(12),
		@@ERROR_COUNT INT,
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@BOOKTYPE CHAR(2),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@VTYP SMALLINT,
		@@BNKCODE VARCHAR(100),
		@@MAXVNO INT,
		@@SQL VARCHAR(MAX),
		@@EXCH CHAR(3),
		@@SEG CHAR(7)

	IF @SEGMENT = 'NSECM'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'BSECM'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'NSEFUT'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'BSEFUT'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'NSXFUT'
	BEGIN
		SET @@EXCH = 'NSX'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'MCDFUT'
	BEGIN
		SET @@EXCH = 'MCD'
		SET @@SEG = 'FUTURES'
	END
	-------------------------- UPDATE BANK CODE DETAILS ------------------------
	UPDATE
		P
	SET 
		BNKNAME = A.ACNAME,
		BRANCHCODE = A.BRANCHCODE,
		MICRNO = A.MICRNO,
		BOOKTYPE = A.BOOKTYPE,
		ACCDTLS = A.ACCDTLS,
		UPDFLAG = 'Y'
	FROM 
		V2_SEBIPAYOUT_TEMP P,
		ACMAST A
	WHERE 
		P.BNKCODE = A.CLTCODE
		AND ACCAT = 2
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		COSTCODE = C.COSTCODE,
		ACNAME = A.LONGNAME
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_SEBIPAYOUT_TEMP P
	WHERE 
		A.CLTCODE = ACCODE
		AND ACCAT IN ('4')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		BANKCOST = C.COSTCODE
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_SEBIPAYOUT_TEMP P
	WHERE 
		A.CLTCODE = BNKCODE
		AND ACCAT IN ('2')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		V2_SEBIPAYOUT_TEMP
	SET 
		BANKCOST = COSTCODE
	WHERE 
		BANKCOST = ''
		AND SESSIONID = @SESSIONID

	-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
	) A

	IF @@ERROR_COUNT > 0
	BEGIN
		SELECT 
			'FOLLOWING CLIENTS DO NOT EXIST<BR>'
		UNION ALL
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
		DELETE FROM 
			V2_SEBIPAYOUT_TEMP 
		WHERE 
			SESSIONID = @SESSIONID
		RETURN
	END

	--------------------------AUTO GENERATION OF VNO ------------------------
	SELECT
		@@STD_DATE = LEFT(SDTCUR, 11),
		@@LST_DATE = LEFT(LDTCUR, 11),
		@@VNOMETHOD = VNOFLAG
	FROM 
		PARAMETER
	WHERE 
		CURYEAR = 1     

	SET @@VNOCUR = CURSOR FOR
	SELECT DISTINCT
		BNKCODE,
		BOOKTYPE,
		VTYP
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	OPEN @@VNOCUR
	FETCH NEXT
	FROM
		@@VNOCUR
	INTO
		@@BNKCODE,
		@@BOOKTYPE,
		@@VTYP
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE
		#BANK_VNO
		(
			SRNO INT,
			NEWSRNO INT IDENTITY (1, 1)
		)

	INSERT INTO
		#BANK_VNO
	SELECT DISTINCT 
		SRNO
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		BNKCODE = @@BNKCODE
		AND BOOKTYPE = @@BOOKTYPE
		AND SESSIONID = @SESSIONID

	SELECT
		@@MAXCOUNT = COUNT(DISTINCT SRNO)
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT TOP 1
		@@VDT = VDT
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT  
		LASTVNO  
	INTO 
		#VNO  
	FROM  
		LASTVNO  
	WHERE  
		1 = 2

	SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

	INSERT INTO 
		#VNO
	EXEC 
		ACC_GENVNO_NEW
		@@VDT,
		@@VTYP,
		@@BOOKTYPE,
		@@STD_DATE,
		@@LST_DATE,  
		@@MAXVNO  

	SELECT  
		@@NEWVNO = LASTVNO  
	FROM  
		#VNO

	UPDATE
		P
	SET 
		VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
	FROM
		V2_SEBIPAYOUT_TEMP P WITH(NOLOCK),
		#BANK_VNO BV
	WHERE
		P.SRNO = BV.SRNO 
		AND SESSIONID = @SESSIONID

	DROP TABLE #VNO  
	DROP TABLE #BANK_VNO

	FETCH NEXT  
	FROM @@VNOCUR  
	INTO  
		@@BNKCODE,  
		@@BOOKTYPE,
		@@VTYP  
	END  

	DEALLOCATE @@VNOCUR

	--------------------------AUTO GENERATION OF LNO ------------------------
	UPDATE
		V2_SEBIPAYOUT_TEMP
	SET 
		LNO = 2
	WHERE 
		VNO IN
	(
		SELECT
			VNO
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			SESSIONID = @SESSIONID
		GROUP BY 
			VNO
		HAVING 
			COUNT(*) = 1
	)

	SET @@LNOCUR = CURSOR FOR
	SELECT
		VNO
	FROM 
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK) 
	WHERE 
		SESSIONID = @SESSIONID
	GROUP BY 
		VNO
	HAVING 
		COUNT(*) > 1

	OPEN @@LNOCUR
	FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE [#LNOGEN] 
		(
			VNO VARCHAR(12),
			SNO INT,
			LNO INT IDENTITY(1,1)
		)

		INSERT INTO 
			#LNOGEN
		SELECT
			VNO,
			SRNO
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			VNO = @@LNOVNO 
			AND SESSIONID = @SESSIONID
		ORDER BY 
			SRNO

		UPDATE
			V2_SEBIPAYOUT_TEMP
		SET 
			LNO = L.LNO + 1
		FROM 
			#LNOGEN L
		WHERE 
			V2_SEBIPAYOUT_TEMP.VNO = L.VNO
			AND V2_SEBIPAYOUT_TEMP.SRNO = L.SNO
			AND V2_SEBIPAYOUT_TEMP.LNO = 0 
			AND SESSIONID = @SESSIONID

		DROP TABLE #LNOGEN
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	END

	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR

	BEGIN TRANSACTION

	--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
	INSERT INTO 
		LEDGER1
	SELECT
		BNKNAME,
		BRNNAME = BRCODE,
		DD = LEFT(PAYMODE, 1),
		DDNO,
		DDDT = VDT,
		RELDT = '',
		RELAMT = AMT,
		REFNO = 0,
		RECEIPTNO = 0,
		VTYP,
		VNO,
		LNO = 2,
		DRCR,
		BOOKTYPE,
		MICRNO,
		SLIPNO = 0,
		SLIPDATE = '',
		CHEQUEINNAME = ISNULL(ACNAME,''),
		CHQPRINTED = 0,
		CLEAR_MODE = ''
	FROM
		V2_SEBIPAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = ACCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO,
		DRCR,
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = ACCODE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO = 1,
		BNKNAME,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = BNKCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO = 1,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = BNKCODE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	UPDATE 
		V2_SEBIPAYOUT_TEMP 
	SET 
		LEDGER2_UPD = 'Y' 
	WHERE 
		SESSIONID = @SESSIONID 
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = 1,
		NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = LNO,
		NARR = NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	DECLARE @@L2CUR AS CURSOR,
	@@L2VNO AS VARCHAR(12)

	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		DELETE FROM 
			TEMPLEDGER2
		WHERE 
			SESSIONID =  @S_SESSIONID

		/*==============================
		CLIENT SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			C.COSTNAME,
			AMT,
			VTYP,
			VNO,
			LNO,
			DRCR,
			'0',
			BOOKTYPE,
			@S_SESSIONID ,
			ACCODE,
			'A',
			'0'
		FROM
			V2_SEBIPAYOUT_TEMP RP,
			COSTMAST C
		WHERE
			RP.COSTCODE = C.COSTCODE
			AND VNO = @@L2VNO
			AND SESSIONID = @SESSIONID

		/*==============================
		BANK SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			BRANCHCODE,
			SUM(AMT),
			VTYP,
			VNO,
			LNO = 1,
			DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
			'0',
			BOOKTYPE,
			@S_SESSIONID,
			BNKCODE,
			'A',
			'0'
		FROM
			V2_SEBIPAYOUT_TEMP
		WHERE
			VNO = @@L2VNO
			AND SESSIONID = @SESSIONID
		GROUP BY 
			BRANCHCODE, 
			VTYP, 
			VNO, 
			(CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE

		EXEC INSERTTOLEDGER2 
				@S_SESSIONID, 
				@@L2VNO, 
				'1', 
				'1', 
				'1', 
				'BROKER', 
				'BROKER'

		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END

	DELETE FROM 
		TEMPLEDGER2
	WHERE 
		SESSIONID =  @S_SESSIONID

	SELECT @@SQL = ""
	SELECT @@SQL = @@SQL + "UPDATE S "
	SELECT @@SQL = @@SQL + "SET "
	SELECT @@SQL = @@SQL + "	STATUS = 'A', "
	SELECT @@SQL = @@SQL + "	PROCESS_DT = GETDATE(), "
	SELECT @@SQL = @@SQL + "	PAYMODE = P.PAYMODE, "
	SELECT @@SQL = @@SQL + "	BANKCODE = P.BNKCODE, "
	SELECT @@SQL = @@SQL + "	VNO = P.VNO, "
	SELECT @@SQL = @@SQL + "	VCH_DT = P.VDT, "	
	SELECT @@SQL = @@SQL + "	SEBIPOAMT = P.AMT, "
	SELECT @@SQL = @@SQL + "	REMARK = P.REMARK, "
	SELECT @@SQL = @@SQL + "	ACCNO = P.ACCNO "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.SEBIPAYOUT_ALL S, "
	SELECT @@SQL = @@SQL + "	V2_SEBIPAYOUT_TEMP P "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTYCODE = ACCODE "	
	SELECT @@SQL = @@SQL + "	AND STATUS = 'P' "
	SELECT @@SQL = @@SQL + "	AND P.SESSIONID = '" + @SESSIONID + "' "
	SELECT @@SQL = @@SQL + "	AND S.EXCHANGE = '" + @@EXCH + "' "
	SELECT @@SQL = @@SQL + "	AND S.SEGMENT = '" + @@SEG + "' "
		
	EXEC (@@SQL)

	SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
	UNION ALL
	SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
	UNION ALL
	SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
	FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT '<HR>'
	UNION ALL
	SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
	FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '<BR><BR>~'
	FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

	DELETE FROM 
		V2_SEBIPAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_LedgerBalance
-- --------------------------------------------------
CREATE Proc V2_LedgerBalance
(
	@fromcltCode varchar(15),
	@tocltCode varchar(15)
--	@currDate varchar(11)
)

as
set nocount on
declare @currDate  as varchar(11)
set @currDate = convert(varchar(11),getdate())

/*
V2_LedgerBalance '0000000000','zzzzzzzzzz','Feb  2 2006'
*/

Declare @StartDate varchar(11)

set transaction isolation level read uncommitted
select 
	@StartDate = left(sdtcur,11) 
from 
	parameter (nolock)
where 
	@currDate between sdtcur and ldtcur


Set Transaction Isolation level Read Uncommitted
Select 
	CltCode, 
	AcName 
into 
	#AcMast
from 
	AcMast (nolock)
where 
	cltcode >= @fromcltcode
	and cltcode <= @tocltcode
	and accat = '4'

Create Clustered Index TempIDx on #Acmast(CltCode)

set transaction isolation level read uncommitted

truncate table Angel_TB

insert into Angel_TB
Select CltCode, AcName, BalAmt = sum(Case when Drcr = 'C' then -Vamt else Vamt end)
--into angel_tb
From
(
	select a.CltCode, a.AcName, l.DrCr, Vamt = sum(l.vamt)
	from Ledger l (nolock), #AcMast a with(index(tempidx),nolock)
	where l.cltcode = a.CltCode
	and l.Vdt >= @StartDate
	and l.Vdt <= @currDate + ' 23:59:00'
	Group by a.CltCode, A.AcName, L.drcr
) x
group by CltCode, AcName 

drop table #AcMast

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_NEWASP_MARGINTRIALBALANCE
-- --------------------------------------------------


--NEWASP_MARGINTRIALBALANCE 'Mar 31 2006', 'codewise','partywise','normal','Apr 1 2005', 'Apr 1 2005', 1,'Apr 1 2005', 'BRANCH', 'TEST', 'vdt', '11212','','BSE','',''

CREATE PROCEDURE  [dbo].[V2_NEWASP_MARGINTRIALBALANCE]  
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */  
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */  
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */  
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */  
@OPENENTRYFLAG INT,  
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */  
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */  
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
@SHOWZEROBAL VARCHAR(1) = 'N',  /* SHOW ZERO BAL   */ 
@GRPCODE VARCHAR(20),
@SHAREDB VARCHAR(20),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(9)  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(2000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(1000),  
@@SQL		  AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),  
@@WHEREPART2  AS VARCHAR(500),  
@@WHEREPART3  AS VARCHAR(500),  
@@ADDWHERE    AS VARCHAR(200),  
@@GROUPBY     AS VARCHAR(200),  
@@SORTBY      AS VARCHAR(200),  
@@HAVING      AS VARCHAR(200),
@@COSTCODE    AS VARCHAR(3)  
 

CREATE TABLE #COSTMAST
(
	COSTNAME VARCHAR(100)
)

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTNAME FROM COSTMAST C, "+ @SHAREDB +".DBO.REGION R WHERE REGIONCODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTNAME FROM COSTMAST C, "+ @SHAREDB +".DBO.AREA A WHERE AREACODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('"+@STATUSNAME+"') "
END
PRINT(@@SQL)  
EXEC(@@SQL) 

IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY L.PARTY_CODE , A.ACNAME, BRANCHCODE, ACCAT, GRPCODE, GRPNAME"  
END  
ELSE  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY ML.PARTY_CODE , A.ACNAME, BRANCHCODE, ACCAT, GRPCODE, GRPNAME"
END  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  L.PARTY_CODE, A.ACNAME, BRANCHCODE"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, L.PARTY_CODE, BRANCHCODE"  
 END  
END  
ELSE  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  ML.PARTY_CODE, A.ACNAME"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, ML.PARTY_CODE"  
 END  
END  
  
IF @VIEWOPTION = 'PARTYWISE'  
BEGIN  
   SELECT @@ADDWHERE  = " AND A.ACCAT = 4 "   
END  
ELSE IF @VIEWOPTION = 'GL'  
BEGIN  
	SELECT @@ADDWHERE  = " AND A.ACCAT <> 4 "   
END  
ELSE  
BEGIN  
	SELECT @@ADDWHERE  = " "   
END  
  
IF @STATUSID = 'BROKER'  
BEGIN  
      	SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
END  
ELSE
BEGIN  
		SELECT @@WHEREPART1 = " WHERE EXISTS(SELECT COSTNAME FROM #COSTMAST C WHERE BRANCHCODE = C.COSTNAME) AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE EXISTS(SELECT COSTNAME FROM #COSTMAST C WHERE BRANCHCODE = C.COSTNAME) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE EXISTS(SELECT COSTNAME FROM #COSTMAST C WHERE BRANCHCODE = C.COSTNAME) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=  A.CLTCODE"   

      	/*SELECT @@WHEREPART1 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   */
END  

IF @STATUSID = 'BROKER'  
BEGIN  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   
   BEGIN  
      SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
        SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
        SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
ELSE IF @BALANCE='WITHOPBAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0 
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
            SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END),OPBAL = 0 "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 1 
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
                SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END)"  
                SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
                SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
      	SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'     THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
      	SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END    
  
  
IF @STATUSID = 'BRANCH'  
BEGIN  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -ML.AMOUNT ELSE ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      	SELECT @@FROMTABLES = " FROM (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -ML.AMOUNT ELSE ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      	SELECT @@FROMTABLES = " FROM (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -ML.AMOUNT ELSE ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      	SELECT @@FROMTABLES = " FROM (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END 

IF @STATUSID = 'BRANCH'  
BEGIN  
	SELECT @@HAVING = " HAVING	CASE WHEN '" + @SHOWZEROBAL + "' <> 'Y' THEN SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END) ELSE 1 END <> 0  "
END
ELSE
BEGIN
	SELECT @@HAVING = " HAVING	CASE WHEN '" + @SHOWZEROBAL + "' <> 'Y' THEN SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END) ELSE 1 END <> 0  "
END
  
PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@HAVING + @@SORTBY   
  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY +  @@HAVING + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_NEWASP_TRIALBALANCE
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[V2_NEWASP_TRIALBALANCE] @VDT VARCHAR(11)  
 ,/* AS ON DATE ENTERED BY USER */  
 @FLAG VARCHAR(15)  
 ,/* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
 @VIEWOPTION VARCHAR(10)  
 ,/* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
 @BALANCE VARCHAR(10)  
 ,/* NORMAL OR WITHOPBAL */  
 @STDATE VARCHAR(11)  
 ,/* START DATE ENTERED BY USER */  
 @CURRYRSTDATE VARCHAR(11)  
 ,/* START DATE OF FINANCIAL YEAR */  
 @OPENENTRYFLAG INT  
 ,@OPENINGENTRYDATE VARCHAR(11)  
 ,/* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
 @STATUSID VARCHAR(20)  
 ,/* AS BROKER/BRANCH/CLIENT ETC. */  
 @STATUSNAME VARCHAR(20)  
 ,/* IN CASE OF BRANCH LOGIN BRANCHCODE */  
 @SORTBYDATE VARCHAR(3)  
 ,/* WHETHER REPORT IS BASED ON VDT OR EDT */  
 @SHOWZEROBAL VARCHAR(1) = 'N'  
 ,/* SHOW ZERO BAL   */  
 @GRPCODE VARCHAR(20)  
 ,@SHAREDB VARCHAR(20)  
 ,@EXCHANGE VARCHAR(10)  
 ,@SEGMENT VARCHAR(9)  
AS  
DECLARE @@COSTCODE AS INT  
 ,@@SQL AS VARCHAR(1000)  
  
CREATE TABLE #COSTMAST (COSTCODE INT)  
  
IF @STATUSID = 'REGION'  
BEGIN  
 SET @@SQL = " INSERT INTO #COSTMAST "  
 SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "  
END  
  
IF @STATUSID = 'AREA'  
BEGIN  
 SET @@SQL = " INSERT INTO #COSTMAST "  
 SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "  
END  
  
IF @STATUSID = 'BRANCH'  
BEGIN  
 SET @@SQL = " INSERT INTO #COSTMAST "  
 SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "  
END  
  
PRINT (@@SQL)  
  
EXEC (@@SQL)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 IF UPPER(@VIEWOPTION) = 'GL'  
 BEGIN  
  IF UPPER(@SORTBYDATE) = 'VDT'  
  BEGIN  
   SELECT L.CLTCODE  
    ,ACNAME = ISNULL(A.ACNAME, '')  
    ,BRANCHCODE  
    ,AMOUNT = ISNULL(SUM(CASE   
       WHEN UPPER(DRCR) = 'D'  
        THEN - VAMT  
       ELSE VAMT  
       END), 0)  
    ,ACCAT  
    ,@EXCHANGE  
    ,@EXCHANGE + ' - ' + @SEGMENT  
    ,A.GRPCODE  
    ,A.GRPNAME  
   FROM LEDGER L WITH (NOLOCK)  
    ,(  
     SELECT CLTCODE  
      ,ACNAME = LONGNAME  
      ,ACCAT  
      ,BRANCHCODE  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM ACMAST A WITH (NOLOCK)  
      ,#ABC FN  
     WHERE A.GRPCODE = FN.GRPCODE  
     ) A  
   WHERE L.CLTCODE = A.CLTCODE  
    AND VDT >= @CURRYRSTDATE  
    AND VDT <= @VDT + ' 23:59'  
    AND A.ACCAT <> 4  
   GROUP BY L.CLTCODE  
    ,A.ACNAME  
    ,BRANCHCODE  
    ,ACCAT  
    ,A.GRPCODE  
    ,A.GRPNAME  
   HAVING CASE   
     WHEN @SHOWZEROBAL <> 'Y'  
      THEN SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END)  
     ELSE 1  
     END <> 0  
  END  
  ELSE  
   IF UPPER(@SORTBYDATE) = 'EDT'  
   BEGIN  
    SELECT CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,GRPCODE  
     ,GRPNAME  
    FROM (  
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN - VAMT  
        ELSE VAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND EDT LIKE @CURRYRSTDATE + '%'  
      AND A.ACCAT <> 4  
      AND L.VTYP = 18  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
       
     UNION ALL  
       
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN VAMT  
        ELSE - VAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND EDT >= @CURRYRSTDATE  
      AND VDT < @CURRYRSTDATE  
      AND A.ACCAT <> 4  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
       
     UNION ALL  
       
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN - VAMT  
        ELSE VAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND EDT >= @CURRYRSTDATE  
      AND EDT <= @VDT + ' 23:59'  
      AND A.ACCAT <> 4  
      AND L.VTYP <> 18  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     ) L  
    GROUP BY L.CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,GRPCODE  
     ,GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(AMOUNT)  
      ELSE 1  
      END <> 0  
   END  
 END  
 ELSE  
  IF UPPER(@VIEWOPTION) = 'PARTYWISE'  
  BEGIN  
   IF UPPER(@SORTBYDATE) = 'VDT'  
   BEGIN  
    PRINT ';here'  
  
    SELECT L.CLTCODE  
     ,ACNAME = ISNULL(A.ACNAME, '')  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN - VAMT  
        ELSE VAMT  
        END), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,GRPCODE  
     ,GRPNAME  
    FROM LEDGER L WITH (NOLOCK)  
     ,(  
      SELECT CLTCODE  
       ,ACNAME = LONGNAME  
       ,ACCAT  
       ,BRANCHCODE  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM ACMAST A WITH (NOLOCK)  
       ,#ABC FN  
      WHERE A.GRPCODE = FN.GRPCODE  
      ) A  
    WHERE L.CLTCODE = A.CLTCODE  
     AND VDT >= @CURRYRSTDATE  
     AND VDT <= @VDT + ' 23:59'  
     AND A.ACCAT = 4  
    GROUP BY L.CLTCODE  
     ,A.ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,GRPCODE  
     ,GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN - VAMT  
          ELSE VAMT  
          END)  
      ELSE 1  
      END <> 0  
   END  
   ELSE  
    IF UPPER(@SORTBYDATE) = 'EDT'  
    BEGIN  
     SELECT CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,GRPCODE  
      ,GRPNAME  
     FROM (  
      SELECT L.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,A.GRPCODE  
         ,GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L.CLTCODE = A.CLTCODE  
       AND EDT LIKE @CURRYRSTDATE + '%'  
       AND A.ACCAT = 4  
       AND L.VTYP = 18  
      GROUP BY L.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
        
      UNION ALL  
        
      SELECT L.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN VAMT  
         ELSE - VAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,A.GRPCODE  
         ,GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L.CLTCODE = A.CLTCODE  
       AND EDT >= @CURRYRSTDATE  
       AND VDT < @CURRYRSTDATE  
       AND A.ACCAT = 4  
      GROUP BY L.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
        
      UNION ALL  
        
      SELECT L.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,A.GRPCODE  
         ,GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L.CLTCODE = A.CLTCODE  
       AND EDT >= @CURRYRSTDATE  
       AND EDT <= @VDT + ' 23:59'  
       AND A.ACCAT = 4  
       AND L.VTYP <> 18  
      GROUP BY L.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      ) L  
     GROUP BY L.CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(AMOUNT)  
       ELSE 1  
       END <> 0  
    END  
  END  
  ELSE  
   IF UPPER(@VIEWOPTION) = 'ALL'  
   BEGIN  
    IF UPPER(@SORTBYDATE) = 'VDT'  
    BEGIN  
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND VDT >= @CURRYRSTDATE  
      AND VDT <= @VDT + ' 23:59'  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(CASE   
           WHEN UPPER(DRCR) = 'D'  
            THEN - VAMT  
           ELSE VAMT  
           END)  
       ELSE 1  
       END <> 0  
    END  
    ELSE  
     IF UPPER(@SORTBYDATE) = 'EDT'  
     BEGIN  
      SELECT CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
       ,ACCAT  
       ,@EXCHANGE  
       ,@EXCHANGE + ' - ' + @SEGMENT  
       ,GRPCODE  
       ,GRPNAME  
      FROM (  
       SELECT L.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN - VAMT  
          ELSE VAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,A.GRPCODE  
          ,GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L.CLTCODE = A.CLTCODE  
        AND EDT >= @CURRYRSTDATE  
        AND EDT <= @VDT + ' 23:59'  
        AND L.VTYP = 18  
       GROUP BY L.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
         
       UNION ALL  
         
       SELECT L.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN VAMT  
          ELSE - VAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,A.GRPCODE  
          ,GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L.CLTCODE = A.CLTCODE  
        AND EDT >= @CURRYRSTDATE  
        AND VDT < @CURRYRSTDATE  
       GROUP BY L.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
         
       UNION ALL  
         
       SELECT L.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN - VAMT  
          ELSE VAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,A.GRPCODE  
          ,GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L.CLTCODE = A.CLTCODE  
        AND EDT >= @CURRYRSTDATE  
        AND EDT <= @VDT + ' 23:59'  
        AND L.VTYP <> 18  
       GROUP BY L.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       ) L  
      GROUP BY L.CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,GRPCODE  
       ,GRPNAME  
      HAVING CASE   
        WHEN @SHOWZEROBAL <> 'Y'  
         THEN SUM(AMOUNT)  
        ELSE 1  
        END <> 0  
     END  
   END  
END  
  
IF UPPER(@STATUSID) = 'BRANCH'  
BEGIN  
 IF UPPER(@VIEWOPTION) = 'GL'  
 BEGIN  
  IF UPPER(@SORTBYDATE) = 'VDT'  
  BEGIN  
   SELECT L2.CLTCODE  
    ,ACNAME = ISNULL(A.ACNAME, '')  
    ,BRANCHCODE  
    ,AMOUNT = ISNULL(SUM(CASE   
       WHEN UPPER(L2.DRCR) = 'D'  
        THEN - CAMT  
       ELSE CAMT  
       END), 0)  
    ,ACCAT  
    ,@EXCHANGE  
    ,@EXCHANGE + ' - ' + @SEGMENT  
    ,A.GRPCODE  
    ,GRPNAME  
   FROM LEDGER L WITH (NOLOCK)  
    ,LEDGER2 L2 WITH (NOLOCK)  
    ,(  
     SELECT CLTCODE  
      ,ACNAME = LONGNAME  
      ,ACCAT  
      ,BRANCHCODE  
      ,FN.GRPCODE  
      ,GRPNAME  
     FROM ACMAST A WITH (NOLOCK)  
      ,#ABC FN  
     WHERE A.GRPCODE = FN.GRPCODE  
     ) A  
   WHERE L2.CLTCODE = A.CLTCODE  
    AND L2.VTYPE = L.VTYP  
    AND L2.BOOKTYPE = L.BOOKTYPE  
    AND L2.VNO = L.VNO  
    AND L2.LNO = L.LNO  
    AND EXISTS (  
     SELECT COSTCODE  
     FROM #COSTMAST C  
     WHERE L2.COSTCODE = C.COSTCODE  
     )  
    AND VDT >= @CURRYRSTDATE  
    AND VDT <= @VDT + ' 23:59'  
    AND A.ACCAT <> 4  
   GROUP BY L2.CLTCODE  
    ,A.ACNAME  
    ,BRANCHCODE  
    ,ACCAT  
    ,A.GRPCODE  
    ,GRPNAME  
   HAVING CASE   
     WHEN @SHOWZEROBAL <> 'Y'  
      THEN SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN - CAMT  
         ELSE CAMT  
         END)  
     ELSE 1  
     END <> 0  
  END  
  ELSE  
   IF UPPER(@SORTBYDATE) = 'EDT'  
   BEGIN  
    SELECT CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,GRPCODE  
     ,GRPNAME  
    FROM (  
     SELECT L2.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(L2.DRCR) = 'D'  
         THEN CAMT  
        ELSE - CAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,LEDGER2 L2 WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,FN.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L2.CLTCODE = A.CLTCODE  
      AND L2.VTYPE = L.VTYP  
      AND L2.BOOKTYPE = L.BOOKTYPE  
      AND L2.VNO = L.VNO  
      AND L2.LNO = L.LNO  
      AND EXISTS (  
       SELECT COSTCODE  
       FROM #COSTMAST C  
       WHERE L2.COSTCODE = C.COSTCODE  
       )  
      AND EDT >= @CURRYRSTDATE  
      AND VDT < @CURRYRSTDATE  
      AND A.ACCAT <> 4  
     GROUP BY L2.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
       
     UNION ALL  
       
     SELECT L2.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(L2.DRCR) = 'D'  
         THEN - CAMT  
        ELSE CAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,LEDGER2 L2 WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,FN.GRPCODE  
        ,GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L2.CLTCODE = A.CLTCODE  
      AND L2.VTYPE = L.VTYP  
      AND L2.BOOKTYPE = L.BOOKTYPE  
      AND L2.VNO = L.VNO  
      AND L2.LNO = L.LNO  
      AND EXISTS (  
       SELECT COSTCODE  
       FROM #COSTMAST C  
       WHERE L2.COSTCODE = C.COSTCODE  
       )  
      AND EDT >= @CURRYRSTDATE  
      AND EDT <= @VDT + ' 23:59'  
      AND A.ACCAT <> 4  
     GROUP BY L2.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     ) L  
    GROUP BY L.CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,GRPCODE  
     ,GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(AMOUNT)  
      ELSE 1  
      END <> 0  
   END  
 END  
 ELSE  
  IF UPPER(@VIEWOPTION) = 'PARTYWISE'  
  BEGIN  
   IF UPPER(@SORTBYDATE) = 'VDT'  
   BEGIN  
    PRINT 'here1'  
  
    SELECT L2.CLTCODE  
     ,ACNAME = ISNULL(A.ACNAME, '')  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(CASE   
        WHEN UPPER(L2.DRCR) = 'D'  
         THEN - CAMT  
        ELSE CAMT  
        END), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,A.GRPCODE  
     ,A.GRPNAME  
    FROM LEDGER L WITH (NOLOCK)  
     ,LEDGER2 L2 WITH (NOLOCK)  
     ,(  
      SELECT CLTCODE  
       ,ACNAME = LONGNAME  
       ,ACCAT  
       ,BRANCHCODE  
       ,FN.GRPCODE  
       ,GRPNAME  
      FROM ACMAST A WITH (NOLOCK)  
       ,#ABC FN  
      WHERE A.GRPCODE = FN.GRPCODE  
      ) A  
    WHERE L2.CLTCODE = A.CLTCODE  
     AND L2.VTYPE = L.VTYP  
     AND L2.BOOKTYPE = L.BOOKTYPE  
     AND L2.VNO = L.VNO  
     AND L2.LNO = L.LNO  
     AND EXISTS (  
      SELECT COSTCODE  
      FROM #COSTMAST C  
      WHERE L2.COSTCODE = C.COSTCODE  
      )  
     AND VDT >= @CURRYRSTDATE  
     AND VDT <= @VDT + ' 23:59'  
     AND A.ACCAT = 4  
    GROUP BY L2.CLTCODE  
     ,A.ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,A.GRPCODE  
     ,A.GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(CASE   
          WHEN UPPER(L2.DRCR) = 'D'  
           THEN - CAMT  
          ELSE CAMT  
          END)  
      ELSE 1  
      END <> 0  
   END  
   ELSE  
    IF UPPER(@SORTBYDATE) = 'EDT'  
    BEGIN  
     PRINT 'BHRT'  
  
     SELECT CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,GRPCODE  
      ,GRPNAME  
     FROM (  
      SELECT L2.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN CAMT  
         ELSE - CAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,A.GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,LEDGER2 L2 WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,FN.GRPCODE  
         ,FN.GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L2.CLTCODE = A.CLTCODE  
       AND L2.VTYPE = L.VTYP  
       AND L2.BOOKTYPE = L.BOOKTYPE  
       AND L2.VNO = L.VNO  
       AND L2.LNO = L.LNO  
       AND EXISTS (  
        SELECT COSTCODE  
        FROM #COSTMAST C  
        WHERE L2.COSTCODE = C.COSTCODE  
        )  
       AND EDT >= @CURRYRSTDATE  
       AND VDT < @CURRYRSTDATE  
       AND A.ACCAT = 4  
      GROUP BY L2.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,A.GRPNAME  
        
      UNION ALL  
        
      SELECT L2.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN - CAMT  
         ELSE CAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,LEDGER2 L2 WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,FN.GRPCODE  
         ,FN.GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L2.CLTCODE = A.CLTCODE  
       AND L2.VTYPE = L.VTYP  
       AND L2.BOOKTYPE = L.BOOKTYPE  
       AND L2.VNO = L.VNO  
       AND L2.LNO = L.LNO  
       AND EXISTS (  
        SELECT COSTCODE  
        FROM #COSTMAST C  
        WHERE L2.COSTCODE = C.COSTCODE  
        )  
       AND EDT >= @CURRYRSTDATE  
       AND EDT <= @VDT + ' 23:59'  
       AND A.ACCAT = 4  
      GROUP BY L2.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,A.GRPNAME  
      ) L  
     GROUP BY L.CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(AMOUNT)  
       ELSE 1  
       END <> 0  
    END  
  END  
  ELSE  
   IF UPPER(@VIEWOPTION) = 'ALL'  
   BEGIN  
    IF UPPER(@SORTBYDATE) = 'VDT'  
    BEGIN  
     SELECT L2.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN - CAMT  
         ELSE CAMT  
         END), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,LEDGER2 L2 WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,FN.GRPCODE  
        ,GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L2.CLTCODE = A.CLTCODE  
      AND L2.VTYPE = L.VTYP  
      AND L2.BOOKTYPE = L.BOOKTYPE  
      AND L2.VNO = L.VNO  
      AND L2.LNO = L.LNO  
      AND EXISTS (  
       SELECT COSTCODE  
       FROM #COSTMAST C  
       WHERE L2.COSTCODE = C.COSTCODE  
       )  
      AND VDT >= @CURRYRSTDATE  
      AND VDT <= @VDT + ' 23:59'  
     GROUP BY L2.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(CASE   
           WHEN UPPER(L2.DRCR) = 'D'  
            THEN - CAMT  
           ELSE CAMT  
           END)  
       ELSE 1  
       END <> 0  
    END  
    ELSE  
     IF UPPER(@SORTBYDATE) = 'EDT'  
     BEGIN  
      SELECT CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
       ,ACCAT  
       ,@EXCHANGE  
       ,@EXCHANGE + ' - ' + @SEGMENT  
       ,GRPCODE  
       ,GRPNAME  
      FROM (  
       SELECT L2.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(L2.DRCR) = 'D'  
           THEN CAMT  
          ELSE - CAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,LEDGER2 L2 WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,FN.GRPCODE  
          ,FN.GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L2.CLTCODE = A.CLTCODE  
        AND L2.VTYPE = L.VTYP  
        AND L2.BOOKTYPE = L.BOOKTYPE  
        AND L2.VNO = L.VNO  
        AND L2.LNO = L.LNO  
        AND EXISTS (  
         SELECT COSTCODE  
         FROM #COSTMAST C  
         WHERE L2.COSTCODE = C.COSTCODE  
         )  
        AND EDT >= @CURRYRSTDATE  
        AND VDT < @CURRYRSTDATE  
       GROUP BY L2.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
         
       UNION ALL  
         
       SELECT L2.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(L2.DRCR) = 'D'  
           THEN - CAMT  
          ELSE CAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,LEDGER2 L2 WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,FN.GRPCODE  
          ,FN.GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L2.CLTCODE = A.CLTCODE  
        AND L2.VTYPE = L.VTYP  
        AND L2.BOOKTYPE = L.BOOKTYPE  
        AND L2.VNO = L.VNO  
        AND L2.LNO = L.LNO  
        AND EXISTS (  
         SELECT COSTCODE  
         FROM #COSTMAST C  
         WHERE L2.COSTCODE = C.COSTCODE  
         )  
        AND EDT >= @CURRYRSTDATE  
        AND EDT <= @VDT + ' 23:59'  
       GROUP BY L2.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
       ) L  
      GROUP BY L.CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,GRPCODE  
       ,GRPNAME  
      HAVING CASE   
        WHEN @SHOWZEROBAL <> 'Y'  
         THEN SUM(AMOUNT)  
        ELSE 1  
        END <> 0  
     END  
   END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_COSTCENTER_REPORT
-- --------------------------------------------------

CREATE Procedure [dbo].[V2_OFFLINE_COSTCENTER_REPORT]  
as  
  
select  /*a.FldAuto as [S No],  */
 a.VoucherNo as [Ref No],  
 a.LedgerVNo as [V No],  
 a.VoucherType as [V Type],    
 a.BookType as [Book Type],    
 a.SNo  as [L No],    
 a.VDate as [V Dt],    
 a.Edate as [E Dt],    
 a.CltCode  as [Clt Code],    
 a.OppCode  as [GL Code],    
 [Credit Amt] = (Case when b.CreditAmt <> 0 then b.CreditAmt else a.CreditAmt end),  
 [Debit Amt] = (case when b.DebitAmt <> 0 then b.DebitAmt else a.DebitAmt end),  
 isnull(b.BranchCode, a.BranchCode) as [Branch Cd],  
 isnull(b.CatCode, a.BranchCode) as [Cat Cd],  
 isnull(b.CostCode, a.BranchCode) as [Cost Cd]/*,  
 a.addby  as [Add By],    
 a.adddt  as [Add Dt] */
from   
 anand.account_ab_dbo.v2_offline_cc_entries b  
inner  join   
 anand.account_ab_dbo.v2_offline_ledger_entries a  
 on (b.VOLE_RefNo = a.FldAuto)  
Where  
 a.RowState = 0  
Order by A.FldAuto

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_ENTRIES_FROMLEDGER
-- --------------------------------------------------

CREATE Proc [dbo].[V2_OFFLINE_ENTRIES_FROMLEDGER]    
(@EXCHANGE VARCHAR(3), @SEGMENT VARCHAR(10))  
  
as    
  
--INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
Select z.*  from     
(    
Select l.Vtyp, l.BookTYpe,  
Lno =(case when L.vtyp not in ('6','7','8') then    
 CAST(L.LNO AS INT) - 1   
else  
 l.lno  
   end    
 ),  
vdt =cast(left(l.Vdt,11) as datetime), evdt =cast(left(l.edt,11) as datetime), l.CltCode,CreditAmt= Case when L.drcr = 'C' then l.Vamt else 0 end ,    
DebitAmt = Case when L.drcr = 'D' then l.Vamt else 0 end,     
l.Narration,     
OppCode = (case when L.vtyp not in (6,7,8) then    
  case when L.lno = 1 then l.CltCode     
   else    
    (Select top 1 CltCode from Ledger x where x.vno = l.vno and x.vtyp = l.vtyp and x.booktype = l.booktype and x.lno = 1)    
   end    
    else '' end),    
MARGINCODE = '',  
BankName= l1.BNKNAME,    
BankBranch = L1.BRNNAME, a.BranchCode,     
DDNo = L1.DDNO,     
ChqMode =  L1.DD,  
ChqDt = L1.DDDT,     
ChqName = L1.CHEQUEINNAME,    
ClearMode = L1.CLEAR_MODE,     
TPACNum = (CASE WHEN A.ACNAME = L1.CHEQUEINNAME THEN 1 ELSE 0 END),   
Exchange='NSE',    
Segment='CAPITAL',    
TPFlag = '0',    
AddDt = l.pdt,     
AddBy = l.EnteredBy,    
StatusId= 'STATUSID',    
StatusName = 'STATUSNAME',    
RowState = 1,    
ApprovalFlag = 1,    
ApprovedDt = l.pdt,     
ApprovedBy = l.CheckedBy,     
VoucherNo = l.Vno,     
UploadDt = l.Pdt,     
LedgerVno = l.vno,     
ClientName = a.AcName,     
OppCodeName = a.AcName,     
MarginCodeName = '',    
SettNo = '',    
SettType = '',    
ProductType = '',    
RevAmt = 0,    
RevCode = '',    
MICR = L1.MICRNO
From Ledger l    
join acmast a    
on (a.cltcode = l.cltcode)    
LEFT OUTER JOIN LEDGER1 L1  
ON (L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE AND L1.LNO = L.LNO)  
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE = L.BOOKTYPE AND L2.LNO = L.LNO)  
Where l.Vtyp < '10'    
) z     
where z.cltcode <> z.oppcode    
Order by VTyp    
    
--INSERT INTO V2_OFFLINE_CC_ENTRIES  
SELECT V.FLDAUTO, 
CCCREDIT = CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END,
CCDEBIT = CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END,
V.CLTCODE, 
V.OPPCODE,
V.BRANCHCODE,
C.CATEGORY,
CM.COSTNAME,
V.ADDBY,
V.STATUSID,
V.STATUSNAME,
V.ADDDT
FROM ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES V
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = V.VOUCHERTYPE AND L2.VNO = V.LEDGERVNO AND L2.BOOKTYPE = V.BOOKTYPE AND L2.LNO = V.SNO)  
WHERE ISNULL(C.CATEGORY,'') <> ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCR_UPLOAD
-- --------------------------------------------------


create PROC [dbo].[V2_OFFLINE_JVDRCR_UPLOAD]
	@FNAME VARCHAR(100),
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@EXCHANGE VARCHAR(3),
    @SEGMENT  VARCHAR(10),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(15)
 

AS
/*
	Exec V2_OFFLINE_JVDRCR_UPLOAD 'D:\BackOffice\DrCrNotes\TEST.Csv', 'BHRATA', 6, '01' 
	EXEC V2_OFFLINE_JVDRCR_UPLOAD 'D:\BACKOFFICE\DRCRNOTES\TEST.CSV', 'DEMO', 8, '01', 'NSE', 'CAPITAL','BROKER','BROKER' 
	
	SP CREATED BY		-	BHARAT
	SP CREATED ON		-	JAN, 22 2009
	ROLLBACK
*/
	SET NOCOUNT ON
	SELECT @UNAME = 'B_' + LTRIM(RTRIM(@UNAME))
	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000),
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT,
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT,
		@@L2CUR AS CURSOR,
		@@BRANCHFLAG AS SMALLINT,
		@@L2VNO AS VARCHAR(12),
		@@MyTempVno AS VARCHAR(12)
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)
	
	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE SPECIFIED FILE DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN
	IF @VTYP = 8
		BEGIN
			SELECT 
				@@ERROR_COUNT = COUNT(1) 
			FROM
				(SELECT 
					U_FILENAME 
				FROM 
					V2_UPLOADED_FILES
				WHERE 
					U_FILENAME = @FNAME 
					AND U_MODULE = 'JV UPLOAD') A
		END
	ELSE
		BEGIN
			SELECT 
				@@ERROR_COUNT = COUNT(1) 
			FROM
				(SELECT 
					U_FILENAME 
				FROM 
					V2_UPLOADED_FILES
				WHERE 
					U_FILENAME = @FNAME 
					AND U_MODULE = 'DRCR NOTE UPLOAD') A
		END

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END


	CREATE TABLE #RECPAY_TABLE_TMP
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500)
	)

	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		COSTCODE SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]

	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO INT ,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
	EXEC(@@SQL)

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SOME ERROR IN BULK UPLOAD, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

	IF @VTYP = 8
		BEGIN
		      INSERT INTO V2_UPLOADED_FILES
		      SELECT
				@FNAME,
				@FNAME,
				COUNT(1),
				'B',
				GETDATE(),
				@UNAME,
				'JV UPLOAD'
		END
	ELSE
		BEGIN
		      INSERT INTO V2_UPLOADED_FILES
		      SELECT
				@FNAME,
				@FNAME,
				COUNT(1),
				'B',
				GETDATE(),
				@UNAME,
				'DRCR NOTE UPLOAD'
		END

	INSERT INTO #RECPAY_TABLE
		(SRNO,
		VVDT,
		EEDT,
		CLTCODE,
		DRCR,
		AMOUNT,
		NARRATION)
	SELECT
		SRNO,
		VVDT,
		EEDT,
		UPPER(CLTCODE),
		DRCR,
		AMOUNT,
		LEFT(NARRATION, 234)
	FROM #RECPAY_TABLE_TMP

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SYSTEM ERROR, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

	UPDATE
		#RECPAY_TABLE
	SET
		VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
		EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2))

	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
		@@BRANCHFLAG = BRANCHFLAG
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME,
					COSTCODE = C.COSTCODE
		      FROM ACMAST A, PARAMETER P, COSTMAST C
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		      AND A.BRANCHCODE = C.COSTNAME
		      AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME,
					COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
		      FROM ACMAST A, PARAMETER P
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		      AND A.BRANCHCODE = 'ALL'
		END
	ELSE
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME
		      FROM ACMAST A, PARAMETER P
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		END

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE NOT FALLING IN THE RESPECTIVE FINANCIAL YEAR.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/
	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE #RECPAY_TABLE
				SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE COSTCODE IS NULL
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/
	SELECT @@ERROR_COUNT = 0
	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL
			SELECT DISTINCT
				CLTCODE
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

	UPDATE #RECPAY_TABLE 
	SET ACNAME = A.LONGNAME 
	FROM ACMAST A (NOLOCK) 
	WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE 

	SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6) 

	INSERT INTO ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES
			(VOUCHERTYPE,
			BOOKTYPE,
			SNO,
			VDATE,
			EDATE,
			CLTCODE,
			CREDITAMT,
			DEBITAMT,
			NARRATION,
			EXCHANGE,
			SEGMENT,
			TPFLAG,
			ADDDT,
			ADDBY,
			STATUSID,
			STATUSNAME,
			ROWSTATE,
			APPROVALFLAG,
			APPROVALDATE,
			APPROVEDBY,
			VOUCHERNO,
			UPLOADDT,
			CLIENTNAME)

	SELECT 
		@VTYP,'01',SRNO, VDT, EDT, CLTCODE, 
		CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, NARRATION, 
		@EXCHANGE, @SEGMENT,0,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,
		GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME
	FROM 
		#RECPAY_TABLE

	COMMIT TRANSACTION
	SELECT RESULT = 'Data Uploaded Successfully'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCRUPLOAD
-- --------------------------------------------------
--EXEC V2_OFFLINE_JVDRCRUPLOAD 'OFFLINE',1,'BSE','CAPITAL','SEP  3 2010','N','8' 
--ROLLBACK

CREATE PROC [dbo].[V2_OFFLINE_JVDRCRUPLOAD](

  @UNAME     VARCHAR(25),
  @USERCAT   INT,
  @EXCHANGE  VARCHAR(3),
  @SEGMENT   VARCHAR(10),
  @IP_VDATE  VARCHAR(11),
  @RECOFLAG  CHAR(1) = 'N',
  @VTYP		 SMALLINT
)
AS

  SET NOCOUNT ON

  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/
  DECLARE  @@STD_DATE        VARCHAR(11),
           @@LST_DATE        VARCHAR(11),
           @@BRANCHFLAG       AS TINYINT,
           @@VNOFLAG          AS TINYINT,
           @@VNOMETHOD       INT,
           @@ACNAME          CHAR(100),
           @@BOOKTYPE        CHAR(2),
           @@MICRNO          VARCHAR(10),
           @@DRCR            VARCHAR(1),
           @@VTYP            SMALLINT,
           @@BANK_CODE       VARCHAR(100),
           @@BACKDAYS        INT,
           @@BACKDATE        VARCHAR(11),
           @@BRNCOUNT        TINYINT,
           @@MonthlyVdt      VARCHAR(11),
           @@SERIAL_NO       INT,
           @@COSTCODECOUNT   TINYINT,
           @@COSTCODEUPDATES CURSOR,
           @@NEWVNO           AS VARCHAR(12),
           @@MAXCOUNT         AS INT,
           @@VDT              AS VARCHAR(11),
           @@BANKBRANCH       AS VARCHAR(10),
           @@BANKCOST         AS NUMERIC,
           @@LNOCUR           AS CURSOR,
           @@VNOCUR           AS CURSOR,
           @@LNOVNO           AS VARCHAR(12),
		   @@FLD_AUTO		  AS INT,
           @@MAXVNO           AS INT,
           @@L2CUR            AS CURSOR,
           @@L2VNO            AS VARCHAR(12),
           @@ERROR_COUNT      AS BIGINT,
           @@FILEEXISTS       AS INT,
           @@SQL              AS VARCHAR(2000),
           @ERRORCODE         AS INT,
           @MESSAGE           AS VARCHAR(200), 
		   @@VOUCHERNO		  AS VARCHAR(12),
		   @@SQLPARA		  AS VARCHAR(5000),	  	
		   @@RECPAYTBLCOUNT BIGINT,
		   @@ACCOUNTDB VARCHAR(20),
		   @@SHAREDB VARCHAR(20),	  
		   @@ACCOUNTSVR VARCHAR(20)



 SET @@VTYP = @VTYP
 SET @@BOOKTYPE = '01' 

	SELECT  @@ACCOUNTSVR = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY (NOLOCK) WHERE PRIMARYSERVER = 1 AND EXCHANGE = @EXCHANGE 
	AND SEGMENT = @SEGMENT ORDER BY EXCHANGE 

  BEGIN TRAN
  CREATE TABLE [#RECPAY_TABLE] (
    SERIAL_NO    INT   IDENTITY ( 1,1 ),
    EDATE        VARCHAR(20),
    VOUCHER_DATE VARCHAR(20),
    CLIENT_CODE  VARCHAR(50),
    AMOUNT       MONEY,
    DRCR         VARCHAR(1),
    NARRATION    VARCHAR(234),
    BANK_CODE    VARCHAR(10),
    BANK_NAME    VARCHAR(100),
    REF_NO       VARCHAR(15),
    BRANCHCODE   VARCHAR(20),
    BRANCH_NAME  VARCHAR(50),
    CHQ_MODE     VARCHAR(1),
    CHQ_DATE     VARCHAR(20),
    CHQ_NAME     VARCHAR(100),
    CL_MODE      VARCHAR(1),
    FLD_AUTO     BIGINT,
    ENTEREDBY    VARCHAR(25),
    VDT          DATETIME   NULL,
    FYSTART      DATETIME   NULL,
    FYEND        DATETIME   NULL,
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),
    EDT          DATETIME   NULL,
    DDDT         DATETIME   NULL,
    VNO          VARCHAR(12)   NULL,
    VTYP         SMALLINT   NULL,
    ACNAME       VARCHAR(100)   NULL,
    COSTCODE     SMALLINT   NULL,
    BANKCOST     SMALLINT   NULL,                  LNO          SMALLINT   NOT NULL   DEFAULT (0),
    BANKNAME     VARCHAR(100)   NULL,
    MICRNO       INT   NULL,
    BOOKTYPE     VARCHAR(2)   NULL,
    ACC_NO       VARCHAR(16),
	VOUCHERNO    VARCHAR(12)   NULL)
  ON [PRIMARY]

  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */


SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "
SET @@SQLPARA = @@SQLPARA + "              (EDATE, "
SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "
SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "
SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "
SET @@SQLPARA = @@SQLPARA + "              DRCR, "
SET @@SQLPARA = @@SQLPARA + "              NARRATION, "
SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "
SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "
SET @@SQLPARA = @@SQLPARA + "              REF_NO, "
SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "
SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "
SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "
SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "
SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "
SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "
SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "
SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "
SET @@SQLPARA = @@SQLPARA + "              VDT, "
SET @@SQLPARA = @@SQLPARA + "              EDT, "
SET @@SQLPARA = @@SQLPARA + "              DDDT, "
SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO) "
SET @@SQLPARA = @@SQLPARA + "  SELECT CONVERT(VARCHAR,EDATE,103), "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE,103), "
SET @@SQLPARA = @@SQLPARA + "         O.CLTCODE, "
SET @@SQLPARA = @@SQLPARA + "         AMOUNT = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN O.DEBITAMT ELSE O.CREDITAMT END ELSE CASE WHEN CC.CREDITAMT = '' THEN CC.DEBITAMT ELSE CC.CREDITAMT END END) , "
SET @@SQLPARA = @@SQLPARA + "         DRCR = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN 'D' ELSE 'C' END ELSE CASE WHEN CC.CREDITAMT = '' THEN 'D' ELSE 'C' END END), "
SET @@SQLPARA = @@SQLPARA + "         NARRATION, "
SET @@SQLPARA = @@SQLPARA + "         OPPCODE, "
SET @@SQLPARA = @@SQLPARA + "         OPPCODENAME, "
SET @@SQLPARA = @@SQLPARA + "         DDNO, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CASE WHEN CC.COSTCODE IS NOT NULL THEN CC.COSTCODE ELSE 'ALL' END), "
SET @@SQLPARA = @@SQLPARA + "         'ALL', "
SET @@SQLPARA = @@SQLPARA + "        CHEQUEMODE, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CHEQUEDATE,103), "
SET @@SQLPARA = @@SQLPARA + "         CHEQUENAME, "
SET @@SQLPARA = @@SQLPARA + "         CLEAR_MODE, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,O.FLDAUTO), " 
SET @@SQLPARA = @@SQLPARA + "         O.ADDBY, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE), "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,EDATE), "
SET @@SQLPARA = @@SQLPARA + "         CHEQUEDATE, "
SET @@SQLPARA = @@SQLPARA + "        TPACCOUNTNUMBER, CONVERT(VARCHAR,VOUCHERTYPE),VOUCHERNO "
IF @@ACCOUNTSVR <> @@SERVERNAME
 BEGIN 
SET @@SQLPARA = @@SQLPARA + "  FROM   " + @@ACCOUNTSVR + ".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "
SET @@SQLPARA = @@SQLPARA + "			LEFT OUTER JOIN "+ @@ACCOUNTSVR +".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_CC_ENTRIES CC "
SET @@SQLPARA = @@SQLPARA + "			ON "
SET @@SQLPARA = @@SQLPARA + "				O.FLDAUTO = CC.VOLE_REFNO "
END
ELSE
 BEGIN
SET @@SQLPARA = @@SQLPARA + "	FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "
SET @@SQLPARA = @@SQLPARA + "			LEFT OUTER JOIN ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_CC_ENTRIES CC "
SET @@SQLPARA = @@SQLPARA + "			ON "
SET @@SQLPARA = @@SQLPARA + "				 O.FLDAUTO = CC.VOLE_REFNO "
END
SET @@SQLPARA = @@SQLPARA + "  WHERE  CONVERT(VARCHAR,VOUCHERTYPE) = '"+CONVERT(VARCHAR,@@VTYP)+"' " 
SET @@SQLPARA = @@SQLPARA + "         AND EXCHANGE = '"+@EXCHANGE+"' "
SET @@SQLPARA = @@SQLPARA + "         AND SEGMENT = '"+@SEGMENT+"' "
SET @@SQLPARA = @@SQLPARA + "         AND CONVERT(VARCHAR,ISNULL(ROWSTATE,0)) = '0' "
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,VDATE) LIKE '"+@IP_VDATE+"' + '%' "
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,APPROVALFLAG) = '1' "

EXEC(@@SQLPARA)
 
SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE

 IF @@RECPAYTBLCOUNT = 0
 BEGIN
  COMMIT
  RETURN
 END

IF @@ACCOUNTSVR <> @@SERVERNAME
 BEGIN
 SET @@SQLPARA = "   UPDATE " + @@ACCOUNTSVR + ".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK) "
 END
ELSE
 BEGIN
 SET @@SQLPARA = "   UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK) "
END 
SET @@SQLPARA = @@SQLPARA + "   SET    ROWSTATE = 9 "
SET @@SQLPARA = @@SQLPARA + "   FROM   #RECPAY_TABLE "
SET @@SQLPARA = @@SQLPARA + "   WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO "
EXEC(@@SQLPARA) 



  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)
  FROM   #RECPAY_TABLE

  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),
         @@BRANCHFLAG = BRANCHFLAG,
         @@VNOFLAG = VNOFLAG
  FROM   PARAMETER WITH(NOLOCK)
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR

  IF @@VNOFLAG <> 0
    BEGIN
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)
      FROM   #RECPAY_TABLE

      IF @@ERROR_COUNT > 1
        BEGIN
     DROP TABLE #RECPAY_TABLE
     ROLLBACK TRANSACTION
     SET @ERRORCODE = 1
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
     RETURN
        END
    END

  IF @@BRANCHFLAG = 1
    BEGIN
	  UPDATE #RECPAY_TABLE
      SET    BRANCHCODE = A.BRANCHCODE,
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = C.COSTCODE,
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = '0'
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK),
             COSTMAST C WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND P.CURYEAR = 1
             AND A.ACCAT IN ('3','4','18')
             AND A.BRANCHCODE = COSTNAME

	  UPDATE #RECPAY_TABLE
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = (SELECT TOP 1 COSTCODE
                         FROM   COSTMAST
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = '0'
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND P.CURYEAR = 1
             AND A.ACCAT IN ('3','4','18')
             AND A.BRANCHCODE = 'ALL'
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'

      UPDATE #RECPAY_TABLE
      SET    BRANCHCODE = 'HO',
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = (SELECT TOP 1 COSTCODE
                         FROM   COSTMAST
             WHERE  COSTNAME = 'HO'),
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = ''
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND P.CURYEAR = 1
             AND A.ACCAT IN ('3','4','18')
             AND A.BRANCHCODE = 'ALL'
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'
    END
 ELSE
    BEGIN
      UPDATE #RECPAY_TABLE
      SET    FYSTART = @@STD_DATE,
             FYEND = @@LST_DATE + ' 23:59:59',
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = ''
      FROM   ACMAST A WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND A.ACCAT IN ('3','4','18')

    END

  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */
  SELECT @@ERROR_COUNT = COUNT(SERIAL_NO)
  FROM   #RECPAY_TABLE
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  SET @@ERROR_COUNT = 0

  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   #RECPAY_TABLE
  WHERE  VDT > EDT

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

/*-----------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ----*/	
  	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
	FROM #RECPAY_TABLE
	HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A

	IF @@ERROR_COUNT > 0
	  BEGIN
	  DROP TABLE #RECPAY_TABLE
	  ROLLBACK TRAN
	  SET @ERRORCODE = 1
	  SET @MESSAGE ='DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
      EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
      RETURN
      END

  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   (SELECT DISTINCT CLIENT_CODE
          FROM   #RECPAY_TABLE
          WHERE  UPDFLAG = 'N') A

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  /*    ----------AUTO GENERATION OF VNO -------- */
	CREATE TABLE  
    #BANK_VNO  
    (  
     VOUCHERNO VARCHAR(12),  
     NEWSRNO INT IDENTITY (1, 1)  
    )  
  
   INSERT INTO  
    #BANK_VNO  
   SELECT  
    DISTINCT VOUCHERNO  
   FROM  
    #RECPAY_TABLE  
     
   SELECT TOP 1  
    @@VDT = VDT  
   FROM  
    #RECPAY_TABLE  
  
   SELECT  
    @@STD_DATE = LEFT(SDTCUR, 11),  
    @@LST_DATE = LEFT(LDTCUR, 11),  
    @@VNOMETHOD = VNOFLAG  
   FROM  
    PARAMETER  
   WHERE  
    @@VDT BETWEEN SDTCUR AND LDTCUR  
  
   SELECT  
    @@MAXCOUNT = COUNT(DISTINCT VOUCHERNO)  
   FROM  
    #RECPAY_TABLE  
  
   SELECT  
    LASTVNO  
   INTO #VNO  
   FROM  
    LASTVNO  
   WHERE  
    1 = 2  
  
   SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  
  
   INSERT INTO  
    #VNO  
   EXEC   
    ACC_GENVNO_NEW  
     @@VDT,  
     @@VTYP,  
     @@BOOKTYPE,  
     @@STD_DATE,  
     @@LST_DATE,  
     @@MAXVNO  
  
   SELECT  
    @@NEWVNO = LASTVNO  
   FROM  
    #VNO  
        
   UPDATE  
    RP  
   SET   
    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))  
   FROM  
    #RECPAY_TABLE RP,  
    #BANK_VNO BV  
   WHERE  
      RP.VOUCHERNO = BV.VOUCHERNO
  
   DROP TABLE #VNO  
   DROP TABLE #BANK_VNO     
 
/* '-----------AUTO GENERATION OF LNO --------------*/
--bhrt
 	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO VARCHAR(12) ,
		FLD_AUTO INT,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	SET @@LNOCUR = CURSOR FOR
		SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE
	OPEN @@LNOCUR
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO
	WHILE @@FETCH_STATUS = 0
		BEGIN

			INSERT INTO #RECPAY_TABLE_LNO
				(SNO, FLD_AUTO)
			SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE WHERE VOUCHERNO = @@LNOVNO
			UPDATE RP
				SET LNO = RL.LNO
			FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
			WHERE RP.VOUCHERNO = RL.SNO AND RP.FLD_AUTO = RL.FLD_AUTO
			TRUNCATE TABLE #RECPAY_TABLE_LNO
			FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO
		END
	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR
	DROP TABLE #RECPAY_TABLE_LNO


/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/
  CREATE TABLE #LEDGER (
    VTYP      SMALLINT,
    VNO       VARCHAR(12),
    EDT       DATETIME,
    LNO       SMALLINT,
    ACNAME    VARCHAR(100),
    DRCR      VARCHAR(1),
    VAMT      MONEY,
    VDT       DATETIME,
    VNO1      VARCHAR(12),
    REFNO     CHAR(12),
    BALAMT    MONEY,
    NODAYS    INT,
    CDT       DATETIME,
    CLTCODE   VARCHAR(10),
    BOOKTYPE  VARCHAR(2),
    ENTEREDBY VARCHAR(25),
    PDT       DATETIME,
    CHECKEDBY VARCHAR(25),
    ACTNODAYS INT,
    NARRATION VARCHAR(234))

/*======CLIENT SIDE RECORD======*/
  INSERT INTO #LEDGER
             (VTYP,
              VNO,
              EDT,
              LNO,
              ACNAME,
              DRCR,
              VAMT,
              VDT,
              VNO1,
              REFNO,
              BALAMT,
              NODAYS,
              CDT,
              CLTCODE,
              BOOKTYPE,
              ENTEREDBY,
              PDT,
              CHECKEDBY,
              ACTNODAYS,
              NARRATION)
  SELECT VTYP,
         VNO,
         EDT = (CASE
                  WHEN VTYP = @@VTYP
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/
                  ELSE EDT
                END),
         LNO,
         ACNAME,
         DRCR,
         VAMT = SUM(AMOUNT),
         VDT,
         VNO1 = VNO,
         REFNO = 0,
         BALAMT = SUM(AMOUNT),
         NODAYS = 0,
         CDT = GETDATE(),
         CLTCODE = CLIENT_CODE,
         BOOKTYPE = BOOKTYPE,
         ENTEREDBY = ENTEREDBY,
         PDT = GETDATE(),
         CHECKEDBY = @UNAME,
         ACTNODAYS = 0,
         NARRATION
  FROM   #RECPAY_TABLE
  GROUP BY
		 VTYP,
	     VNO,
         (CASE
                  WHEN VTYP = @@VTYP
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/
                  ELSE EDT
                END),
         LNO,
         ACNAME,
         DRCR,
         VDT,
         CLIENT_CODE,
         BOOKTYPE,
         ENTEREDBY,
         NARRATION



/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/
  INSERT INTO LEDGER
 (VTYP,
              VNO,
              EDT,
              LNO,
              ACNAME,
              DRCR,
              VAMT,
              VDT,
              VNO1,
              REFNO,
              BALAMT,
              NODAYS,
              CDT,
              CLTCODE,
              BOOKTYPE,
              ENTEREDBY,
              PDT,
              CHECKEDBY,
              ACTNODAYS,
              NARRATION)
  SELECT   VTYP,
           VNO,
		   EDT,
           LNO,
           ACNAME,
           DRCR,
           VAMT,
           VDT,
           VNO1,
           REFNO,
           BALAMT,
           NODAYS,
           CDT,
           CLTCODE,
           BOOKTYPE,
           ENTEREDBY,
           PDT,
           CHECKEDBY,
           ACTNODAYS,
           NARRATION
  FROM     #LEDGER
  ORDER BY BOOKTYPE,
           VTYP,
           VNO,
           LNO

  IF @@ERROR <> 0
    BEGIN
    DROP TABLE #LEDGER
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  DROP TABLE #LEDGER


IF @@BRANCHFLAG = 1  
    BEGIN  

      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO  
                               FROM     #RECPAY_TABLE  
                               ORDER BY VNO  
      OPEN @@L2CUR  
  
      FETCH NEXT FROM @@L2CUR  
      INTO @@L2VNO  
  
      WHILE @@FETCH_STATUS = 0  
        BEGIN  
          DELETE FROM TEMPLEDGER2  
          WHERE       SESSIONID = '9999999999'  

		/*======CLIENT SIDE RECORD======*/  
          INSERT INTO TEMPLEDGER2  
          SELECT 'BRANCH',  
                 C.COSTNAME,  
                 AMOUNT,  
                 VTYP,  
                 VNO,  
                 LNO,  
                 DRCR,  
                 '0',  
                 BOOKTYPE,  
                 '9999999999',  
                 CLIENT_CODE,  
                 'A',  
                 '0'  
		  FROM   #RECPAY_TABLE RP,  
                 COSTMAST C WITH(NOLOCK)  
          WHERE  RP.COSTCODE = C.COSTCODE  
                 AND VNO = @@L2VNO  
  
          EXEC INSERTTOLEDGER2  
            '9999999999' ,  
            @@L2VNO ,  
            '1' ,  
            '1' ,  
            '1' ,  
            'BROKER' ,  
            'BROKER'  
  
		FETCH NEXT FROM @@L2CUR  
          INTO @@L2VNO  
        END  

      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)  
      WHERE       SESSIONID = '9999999999'  
 END  

IF @@ACCOUNTSVR <> @@SERVERNAME
 BEGIN 
	SET @@SQLPARA = " UPDATE "+ @@ACCOUNTSVR +".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK) " 
 END
ELSE
 BEGIN
	SET @@SQLPARA = " UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK) " 
END  
SET @@SQLPARA = @@SQLPARA + " SET "
SET @@SQLPARA = @@SQLPARA + "  ROWSTATE = 1, "
SET @@SQLPARA = @@SQLPARA + "  APPROVALFLAG = 1, "
SET @@SQLPARA = @@SQLPARA + "  APPROVALDATE = GETDATE(), "
SET @@SQLPARA = @@SQLPARA + "  LEDGERVNO = VNO "
SET @@SQLPARA = @@SQLPARA + " FROM   #RECPAY_TABLE "
SET @@SQLPARA = @@SQLPARA + " WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO "
EXEC(@@SQLPARA)
COMMIT TRAN 

DROP TABLE #RECPAY_TABLE
SET @ERRORCODE = 0
SET @MESSAGE = 'POSTED SUCCESSFULLY'
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME

--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCRUPLOAD_RND
-- --------------------------------------------------
CREATE PROC [dbo].[V2_OFFLINE_JVDRCRUPLOAD_RND](                      
                      
  @UNAME     VARCHAR(25),                      
  @USERCAT   INT,                      
  @EXCHANGE  VARCHAR(3),                      
  @SEGMENT   VARCHAR(10),                      
  @IP_VDATE  VARCHAR(11),                      
  @RECOFLAG  CHAR(1) = 'N',                      
  @VTYP   SMALLINT,
  @VOUCHERNO VARCHAR(20) = ''                      
)                      
AS                      
set XACT_ABORT          on                
  SET NOCOUNT ON                     
/*                  
begin tran                  
exec V2_OFFLINE_JVDRCRUPLOAD_RND 'OFFLINE',1,'NSE','CAPITAL','oct 20 2010','N',8                  
rollback                  
SELECT TOP 1* FROM LEDGER2              
*/                   
                      
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                      
  DECLARE  @@STD_DATE        VARCHAR(11),                      
           @@LST_DATE        VARCHAR(11),                      
           @@BRANCHFLAG       AS TINYINT,                      
           @@VNOFLAG          AS TINYINT,                      
           @@VNOMETHOD       INT,                      
           @@ACNAME          CHAR(100),                      
           @@BOOKTYPE        CHAR(2),                      
           @@MICRNO          VARCHAR(10),                      
           @@DRCR            VARCHAR(1),                      
           @@VTYP            SMALLINT,                      
           @@BANK_CODE       VARCHAR(100),                      
           @@BACKDAYS        INT,                      
           @@BACKDATE        VARCHAR(11),                      
           @@BRNCOUNT        TINYINT,                      
           @@MonthlyVdt      VARCHAR(11),                      
           @@SERIAL_NO       INT,                      
           @@COSTCODECOUNT   TINYINT,                      
           @@COSTCODEUPDATES CURSOR,                      
           @@NEWVNO           AS VARCHAR(12),                      
           @@MAXCOUNT         AS INT,                      
           @@VDT              AS VARCHAR(11),                      
           @@BANKBRANCH       AS VARCHAR(10),                      
           @@BANKCOST         AS NUMERIC,                      
           @@LNOCUR           AS CURSOR,                      
           @@VNOCUR           AS CURSOR,                      
           @@LNOVNO           AS VARCHAR(12),                      
     @@FLD_AUTO    AS INT,                      
           @@MAXVNO           AS INT,                      
           @@L2CUR            AS CURSOR,                      
           @@L2VNO            AS VARCHAR(12),                      
           @@ERROR_COUNT      AS BIGINT,                      
           @@FILEEXISTS       AS INT,                      
           @@SQL              AS VARCHAR(2000),                      
           @ERRORCODE         AS INT,                      
           @MESSAGE           AS VARCHAR(200),                       
     @@VOUCHERNO    AS VARCHAR(12),                      
     @@SQLPARA    AS VARCHAR(5000),                          
     @@RECPAYTBLCOUNT BIGINT,                      
     @@ACCOUNTDB VARCHAR(20),                      
     @@SHAREDB VARCHAR(20),                         
     @@ACCOUNTSVR VARCHAR(20)                      
                      
                      
                      
 SET @@VTYP = @VTYP                      
 SET @@BOOKTYPE = '01'                       
            
                      
 SELECT  @@ACCOUNTSVR = ACCOUNTSERVER                      
 FROM ANAND1.PRADNYA.DBO.MULTICOMPANY  WHERE PRIMARYSERVER = 1 AND EXCHANGE = @EXCHANGE                       
 AND SEGMENT = @SEGMENT ORDER BY EXCHANGE                       
                      
  BEGIN TRAN                      
  CREATE TABLE [#RECPAY_TABLE] (                      
    SERIAL_NO    INT   IDENTITY ( 1,1 ),                      
    SNO INT,                    
    EDATE  VARCHAR(20),                      
    VOUCHER_DATE VARCHAR(20),                      
    CLIENT_CODE  VARCHAR(50),                      
    AMOUNT       MONEY,                      
    DRCR         VARCHAR(1),                      
    NARRATION    VARCHAR(234),                      
    BANK_CODE    VARCHAR(10),                      
   BANK_NAME    VARCHAR(100),                      
    REF_NO       VARCHAR(15),                      
    BRANCHCODE   VARCHAR(20),                      
    BRANCH_NAME  VARCHAR(50),                    
    CHQ_MODE     VARCHAR(1),                      
    CHQ_DATE     VARCHAR(20),                      
    CHQ_NAME     VARCHAR(100),                      
    CL_MODE      VARCHAR(1),                 
    FLD_AUTO     BIGINT,                      
    ENTEREDBY    VARCHAR(25),                      
    VDT          DATETIME   NULL,                      
    FYSTART      DATETIME   NULL,                      
    FYEND        DATETIME   NULL,                      
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                      
    EDT          DATETIME   NULL,                      
    DDDT         DATETIME   NULL,                      
    VNO          VARCHAR(12)   NULL,                      
    VTYP         SMALLINT   NULL,                      
    ACNAME       VARCHAR(100)   NULL,                      
    COSTCODE     SMALLINT   NULL,                      
    BANKCOST     SMALLINT   NULL,                  LNO          SMALLINT   NOT NULL   DEFAULT (0),                      
    BANKNAME     VARCHAR(100)   NULL,                      
    MICRNO       INT   NULL,                      
    BOOKTYPE     VARCHAR(2)   NULL,                      
    ACC_NO       VARCHAR(16),                      
 VOUCHERNO    VARCHAR(12)   NULL,              
 SRNO TINYINT )                    
  ON [PRIMARY]                      
                      
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                      
                      
                      
/*SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "                      
SET @@SQLPARA = @@SQLPARA + "              (SNO,EDATE, "                      
SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "                      
SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "                      
SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "                      
SET @@SQLPARA = @@SQLPARA + "          DRCR, "                      
SET @@SQLPARA = @@SQLPARA + "              NARRATION, "                      
SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "                      
SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "                      
SET @@SQLPARA = @@SQLPARA + "              REF_NO, "                      
SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "                      
SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "                      
SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "                      
SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "                      
SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "                      
SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "                      
SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "                      
SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "                      
SET @@SQLPARA = @@SQLPARA + "              VDT, "                      
SET @@SQLPARA = @@SQLPARA + "              EDT, "                      
SET @@SQLPARA = @@SQLPARA + "              DDDT, "                      
SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO) "                      
SET @@SQLPARA = @@SQLPARA + "  SELECT o.SNO,CONVERT(VARCHAR,EDATE,103), "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE,103), "                      
SET @@SQLPARA = @@SQLPARA + "         O.CLTCODE, "                      
SET @@SQLPARA = @@SQLPARA + "         AMOUNT = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN O.DEBITAMT ELSE O.CREDITAMT END ELSE CASE WHEN CC.CREDITAMT = '' THEN CC.DEBITAMT ELSE CC.CREDITAMT END END) , "           
   
    
     
        
           
SET @@SQLPARA = @@SQLPARA + "         DRCR = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN 'D' ELSE 'C' END ELSE CASE WHEN CC.CREDITAMT = '' THEN 'D' ELSE 'C' END END), "                      
SET @@SQLPARA = @@SQLPARA + "         NARRATION, "                      
SET @@SQLPARA = @@SQLPARA + "         OPPCODE, "                      
SET @@SQLPARA = @@SQLPARA + "         OPPCODENAME, "                      
SET @@SQLPARA = @@SQLPARA + "         DDNO, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CASE WHEN CC.COSTCODE IS NOT NULL THEN CC.COSTCODE ELSE 'ALL' END), "                      
SET @@SQLPARA = @@SQLPARA + "         'ALL', "                      
SET @@SQLPARA = @@SQLPARA + "        CHEQUEMODE, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CHEQUEDATE,103), "                      
SET @@SQLPARA = @@SQLPARA + "         CHEQUENAME, "              SET @@SQLPARA = @@SQLPARA + "         CLEAR_MODE, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,O.FLDAUTO), "                       
SET @@SQLPARA = @@SQLPARA + "         O.ADDBY, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE), "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,EDATE), "                      
SET @@SQLPARA = @@SQLPARA + "         CHEQUEDATE, "                      
SET @@SQLPARA = @@SQLPARA + "        TPACCOUNTNUMBER, CONVERT(VARCHAR,VOUCHERTYPE),VOUCHERNO "                      
IF @@ACCOUNTSVR <> @@SERVERNAME                      
 BEGIN                       
SET @@SQLPARA = @@SQLPARA + "  FROM   " + @@ACCOUNTSVR + ".ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "                      
SET @@SQLPARA = @@SQLPARA + "   LEFT OUTER JOIN "+ @@ACCOUNTSVR +".ACCOUNT.DBO.V2_OFFLINE_CC_ENTRIES CC "                      
SET @@SQLPARA = @@SQLPARA + "   ON "                      
SET @@SQLPARA = @@SQLPARA + "    O.FLDAUTO = CC.VOLE_REFNO "                      
END                      
ELSE                      
 BEGIN                      
SET @@SQLPARA = @@SQLPARA + " FROM   ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "                      
SET @@SQLPARA = @@SQLPARA + "   LEFT OUTER JOIN ACCOUNT.DBO.V2_OFFLINE_CC_ENTRIES CC "                      
SET @@SQLPARA = @@SQLPARA + "   ON "                      
SET @@SQLPARA = @@SQLPARA + "     O.FLDAUTO = CC.VOLE_REFNO "                      
END                      
SET @@SQLPARA = @@SQLPARA + "  WHERE  CONVERT(VARCHAR,VOUCHERTYPE) = '"+CONVERT(VARCHAR,@@VTYP)+"' "                       
SET @@SQLPARA = @@SQLPARA + "         AND EXCHANGE = '"+@EXCHANGE+"' "                      
SET @@SQLPARA = @@SQLPARA + "         AND SEGMENT = '"+@SEGMENT+"' "                      
SET @@SQLPARA = @@SQLPARA + "         AND CONVERT(VARCHAR,ISNULL(ROWSTATE,0)) = '0' "                      
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,VDATE) LIKE '"+@IP_VDATE+"' + '%' "                      
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,APPROVALFLAG) = '1' "                      
                      
EXEC(@@SQLPARA)   */              
              
 SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "                      
 SET @@SQLPARA = @@SQLPARA + "              (SNO,EDATE, "                      
 SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "                      
 SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "                      
 SET @@SQLPARA = @@SQLPARA + "      DRCR, "                      
 SET @@SQLPARA = @@SQLPARA + "              NARRATION, "                      
 SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "                      
 SET @@SQLPARA = @@SQLPARA + "              REF_NO, "                      
 SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "                      
 SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "                      
 SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "                      
 SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "                      
 SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "                      
 SET @@SQLPARA = @@SQLPARA + "              VDT, "                      
 SET @@SQLPARA = @@SQLPARA + "              EDT, "                      
 SET @@SQLPARA = @@SQLPARA + "              DDDT, "                      
 SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO,SRNO) "               
 IF @@ACCOUNTSVR <> 'ABCSOMKTUATSVR1'                      
  BEGIN                       
  SET @@SQLPARA = @@SQLPARA + "  EXEC ACCOUNT_AB.DBO.V2_OFFLINE_FILL_REC "+CONVERT(VARCHAR,@@VTYP)+",'"+@EXCHANGE+"', '"+@SEGMENT+"', '"+@IP_VDATE+"', '" + @VOUCHERNO + "'"                  
  END                      
 ELSE                      
  BEGIN                      
  SET @@SQLPARA = @@SQLPARA + " EXEC V2_OFFLINE_FILL_REC "+CONVERT(VARCHAR,@@VTYP)+",'"+@EXCHANGE+"', '"+@SEGMENT+"', '"+@IP_VDATE+"', '" + @VOUCHERNO + "'"            
  END              
 PRINT @@SQLPARA              
 EXEC(@@SQLPARA)               
             
 SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                      
                      
 IF @@RECPAYTBLCOUNT = 0                      
 BEGIN                      
  COMMIT                      
  RETURN                      
 END                      
                
                      
                      
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                      
  FROM   #RECPAY_TABLE                      
                      
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                      
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                      
         @@BRANCHFLAG = BRANCHFLAG,                      
         @@VNOFLAG = VNOFLAG                      
  FROM   PARAMETER WITH(NOLOCK)                      
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                      
                      
  IF @@VNOFLAG <> 0                      
    BEGIN                      
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
      FROM   #RECPAY_TABLE                      
                      
      IF @@ERROR_COUNT > 1                      
        BEGIN                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRANSACTION                      
     SET @ERRORCODE = 1                      
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                      
     EXEC ACCOUNTNCDX.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
     RETURN                      
        END                      
    END                      
                      
  IF @@BRANCHFLAG = 1                      
    BEGIN                      
   UPDATE #RECPAY_TABLE                      
      SET    BRANCHCODE = A.BRANCHCODE,                      
             FYSTART = P.SDTCUR,                      
             FYEND = P.LDTCUR,                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             COSTCODE = C.COSTCODE,                      
             BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = '0'                      
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK),                      
             COSTMAST C WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND P.CURYEAR = 1                      
             AND A.ACCAT IN ('3','4','18')                      
             AND A.BRANCHCODE = COSTNAME                      
                      
   UPDATE #RECPAY_TABLE                      
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
          DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
             FYSTART = P.SDTCUR,                      
             FYEND = P.LDTCUR,                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             COSTCODE = (SELECT TOP 1 COSTCODE                      
                         FROM   COSTMAST                     
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                      
       BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = '0'                      
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND P.CURYEAR = 1                      
             AND A.ACCAT IN ('3','4','18')                      
             AND A.BRANCHCODE = 'ALL'                      
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                      
                      
      UPDATE #RECPAY_TABLE                      
      SET    BRANCHCODE = 'HO',                      
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
             FYSTART = P.SDTCUR,                      
 FYEND = P.LDTCUR,                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             COSTCODE = (SELECT TOP 1 COSTCODE                      
                         FROM   COSTMAST                      
             WHERE  COSTNAME = 'HO'),                      
             BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = ''                      
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND P.CURYEAR = 1                      
             AND A.ACCAT IN ('3','4','18')                      
             AND A.BRANCHCODE = 'ALL'                      
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                      
    END                      
 ELSE                      
    BEGIN                      
      UPDATE #RECPAY_TABLE                      
      SET    FYSTART = @@STD_DATE,                      
             FYEND = @@LST_DATE + ' 23:59:59',                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = ''                      
      FROM   ACMAST A WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                   
             AND A.ACCAT IN ('3','4','18')                      
                      
    END                
              
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                      
 SELECT @@ERROR_COUNT = COUNT(SERIAL_NO)                      
  FROM   #RECPAY_TABLE                      
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                      
                      
  IF @@ERROR_COUNT > 0                      
    BEGIN                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                      
    EXEC ACCOUNTNCDX.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                     
                      
  SET @@ERROR_COUNT = 0                      
                      
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                      
  SELECT @@ERROR_COUNT = COUNT(1)                      
  FROM   #RECPAY_TABLE                      
  WHERE  VDT > EDT                      
                      
  IF @@ERROR_COUNT > 0                      
    BEGIN                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                      
    EXEC ACCOUNTNCDX.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
/*-----------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ----*/                       
   SELECT @@ERROR_COUNT = COUNT(1) FROM                      
 (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)                      
 FROM #RECPAY_TABLE                      
 HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A                      
                      
 IF @@ERROR_COUNT > 0                      
   BEGIN                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   SET @ERRORCODE = 1                      
   SET @MESSAGE ='DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'                      
      EXEC ACCOUNTNCDX.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
      RETURN                      
      END                              
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                      
  SELECT @@ERROR_COUNT = COUNT(1)                      
  FROM   (SELECT DISTINCT CLIENT_CODE                      
          FROM   #RECPAY_TABLE                      
          WHERE  UPDFLAG = 'N') A                      
                      
  IF @@ERROR_COUNT > 0                      
    BEGIN                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
   SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                      
    EXEC ACCOUNTNCDX.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
  /*----------AUTO GENERATION OF VNO -------- */                      
 CREATE TABLE                        
    #BANK_VNO                        
    (                        
     VOUCHERNO VARCHAR(12),                    
  SNO INT,                        
     NEWSRNO INT IDENTITY (1, 1)                        
    )                        
                        
   INSERT INTO                        
    #BANK_VNO                        
   SELECT                        
    DISTINCT VOUCHERNO,SNO                        
   FROM                        
    #RECPAY_TABLE     
 order by VOUCHERNO,SNO                      
                           
   SELECT TOP 1                        
    @@VDT = VDT                        
   FROM             
    #RECPAY_TABLE                        
                        
   SELECT                        
    @@STD_DATE = LEFT(SDTCUR, 11),                        
    @@LST_DATE = LEFT(LDTCUR, 11),                        
    @@VNOMETHOD = VNOFLAG                        
   FROM                        
    PARAMETER                        
   WHERE                        
    @@VDT BETWEEN SDTCUR AND LDTCUR                        
                        
   SELECT                        
    @@MAXCOUNT = COUNT(DISTINCT VOUCHERNO)                        
   FROM                        
    #RECPAY_TABLE                        
                        
   SELECT                        
    LASTVNO         
   INTO #VNO                        
   FROM                        
    LASTVNO                        
   WHERE                        
    1 = 2                        
                        
   SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                        
                        
   INSERT INTO                        
    #VNO                        
   EXEC                         
    ACC_GENVNO_NEW                        
     @@VDT,                       
     @@VTYP,                        
     @@BOOKTYPE,                        
     @@STD_DATE,                        
     @@LST_DATE,                        
     @@MAXVNO                        
                        
   SELECT                        
    @@NEWVNO = LASTVNO                        
   FROM                        
    #VNO                        
                              
   UPDATE                        
    RP                        
   SET                         
    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))               
   FROM                        
    #RECPAY_TABLE RP,                        
    #BANK_VNO BV                        
   WHERE                        
      RP.VOUCHERNO = BV.VOUCHERNO                     
   AND RP.SNO = BV.SNO               
            
            
              
                   
   DROP TABLE #VNO                        
   DROP TABLE #BANK_VNO                           
                       
/* '-----------AUTO GENERATION OF LNO --------------*/                      
--bhrt                 
              
UPDATE #RECPAY_TABLE SET LNO = LNO + (SELECT SUM(SRNO) FROM #RECPAY_TABLE L1             
WHERE #RECPAY_TABLE.VNO = L1.VNO AND #RECPAY_TABLE.SERIAL_NO <= L1.SERIAL_NO)             
            
               
                  
  /*CREATE TABLE [#RECPAY_TABLE_LNO]                      
 (                      
  SNO VARCHAR(12) ,                      
  FLD_AUTO INT,                      
  LNO INT IDENTITY (1, 1) NOT NULL                      
 ) ON [PRIMARY]                      
                      
 SET @@LNOCUR = CURSOR FOR           
  SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE                      
 OPEN @@LNOCUR                      
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO                      
 WHILE @@FETCH_STATUS = 0                      
  BEGIN                      
                      
   INSERT INTO #RECPAY_TABLE_LNO                      
    (SNO, FLD_AUTO)                      
   SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE WHERE VOUCHERNO = @@LNOVNO                      
   UPDATE RP                      
    SET LNO = RL.LNO                      
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL                      
   WHERE RP.VOUCHERNO = RL.SNO AND RP.FLD_AUTO = RL.FLD_AUTO                      
   TRUNCATE TABLE #RECPAY_TABLE_LNO                      
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO                      
  END                      
 CLOSE @@LNOCUR                      
 DEALLOCATE @@LNOCUR                      
 DROP TABLE #RECPAY_TABLE_LNO     */                 
                      
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                      
  CREATE TABLE #LEDGER (                      
    VTYP      SMALLINT,                      
    VNO       VARCHAR(12),                      
    EDT       DATETIME,                      
    LNO       SMALLINT,                      
    ACNAME    VARCHAR(100),                      
    DRCR      VARCHAR(1),                      
    VAMT      MONEY,                      
    VDT       DATETIME,                      
    VNO1      VARCHAR(12),                      
    REFNO     CHAR(12),                      
    BALAMT    MONEY,                      
    NODAYS    INT,                      
    CDT       DATETIME,                      
    CLTCODE   VARCHAR(10),                      
    BOOKTYPE  VARCHAR(2),                      
    ENTEREDBY VARCHAR(25),                      
    PDT       DATETIME,                      
    CHECKEDBY VARCHAR(25),                      
    ACTNODAYS INT,                      
    NARRATION VARCHAR(234))                      
                      
/*======CLIENT SIDE RECORD======*/              
            
                    
  INSERT INTO #LEDGER                      
             (VTYP,                      
              VNO,                      
              EDT,                      
              LNO,                      
              ACNAME,                      
              DRCR,                      
   VAMT,                  
              VDT,                      
              VNO1,                      
              REFNO,                      
              BALAMT,                      
              NODAYS,                      
              CDT,                      
              CLTCODE,                      
              BOOKTYPE,                      
              ENTEREDBY,                      
              PDT,                      
              CHECKEDBY,                      
              ACTNODAYS,                      
              NARRATION)                      
  SELECT VTYP,                      
         VNO,                      
         EDT = (CASE                      
                  WHEN VTYP = @@VTYP                      
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/        
                 ELSE EDT                      
                END),                      
         LNO,                      
         ACNAME,                      
         DRCR,                      
         VAMT = SUM(AMOUNT),                      
         VDT,                      
         VNO1 = VNO,                      
         REFNO = 0,                      
         BALAMT = SUM(AMOUNT),                      
         NODAYS = 0,                      
         CDT = GETDATE(),                      
         CLTCODE = CLIENT_CODE,                      
      BOOKTYPE = BOOKTYPE,                      
         ENTEREDBY = ENTEREDBY,                      
         PDT = GETDATE(),                      
         CHECKEDBY = @UNAME,                      
         ACTNODAYS = 0,                      
         NARRATION                      
  FROM   #RECPAY_TABLE                      
  GROUP BY                      
   VTYP,                      
      VNO,                      
         (CASE                      
                  WHEN VTYP = @@VTYP                      
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                      
                  ELSE EDT                      
                END),                      
         LNO,         
         ACNAME,                      
         DRCR,                      
         VDT,                      
         CLIENT_CODE,                      
         BOOKTYPE,                      
         ENTEREDBY,                      
         NARRATION                      
                      
                      
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                      
  INSERT INTO LEDGER                      
 (VTYP,   
              VNO,                      
              EDT,                      
              LNO,                      
              ACNAME,                      
              DRCR,                      
              VAMT,                      
              VDT,                      
              VNO1,                      
              REFNO,                      
              BALAMT,                      
              NODAYS,                      
              CDT,                      
              CLTCODE,                      
              BOOKTYPE,                      
              ENTEREDBY,                      
              PDT,                      
              CHECKEDBY,                      
              ACTNODAYS,                      
              NARRATION)                      
  SELECT   VTYP,                      
           VNO,                      
     EDT,                      
           LNO,                      
           ACNAME,                 
           DRCR,                      
           VAMT,                      
           VDT,                      
           VNO1,                      
           REFNO,                      
           BALAMT,                      
           NODAYS,                      
        CDT,                      
           CLTCODE,                      
           BOOKTYPE,                      
           ENTEREDBY,                      
           PDT,                      
           CHECKEDBY,                      
           ACTNODAYS,                      
           NARRATION                      
  FROM     #LEDGER                      
  ORDER BY BOOKTYPE,                      
           VTYP,                      
           VNO,                      
           LNO                      
                      
  IF @@ERROR <> 0                      
    BEGIN                      
    DROP TABLE #LEDGER                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                      
    EXEC ACCOUNTNCDX.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
                      
IF @@BRANCHFLAG = 1                        
    BEGIN                 
                
 SELECT * INTO #LEDGER2 FROM LEDGER2 WHERE 1 = 2                
                
 INSERT INTO #LEDGER2                
 SELECT VTYP, VNO, LNO, DRCR, VAMT, COSTCODE, L.BOOKTYPE, L.CLTCODE                
FROM #LEDGER L, COSTMAST C, ACMAST A WHERE                 
 L.CLTCODE = A.CLTCODE AND C.COSTNAME = CASE WHEN UPPER(A.BRANCHCODE) = 'ALL' THEN 'HO' ELSE A.BRANCHCODE END                
                
 INSERT INTO #LEDGER2                
 SELECT VTYPE, VNO, LNO, CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END, CAMT, COSTCODE, BOOKTYPE, 'HOCTRL'                
 FROM #LEDGER2 WHERE COSTCODE IN(SELECT COSTCODE FROM COSTMAST WHERE COSTNAME <> 'HO')                
                
 DECLARE @@COSTCODE INT                
                
 SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'                
                
 INSERT INTO #LEDGER2                
 SELECT VTYPE, VNO, LNO, DRCR, CAMT, @@COSTCODE, BOOKTYPE, BRCONTROLAC                
 FROM #LEDGER2 L2, BRANCHACCOUNTS B, COSTMAST C                
 WHERE L2.COSTCODE = C.COSTCODE AND COSTNAME <> 'HO' AND CLTCODE <> 'HOCTRL'                
 AND COSTNAME = BRANCHNAME                 
                
 INSERT INTO LEDGER2 (VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE )                     
 SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE FROM #LEDGER2                
                      
      /*SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                        
                               FROM     #RECPAY_TABLE                        
                     ORDER BY VNO                        
      OPEN @@L2CUR                        
                        
      FETCH NEXT FROM @@L2CUR                        
      INTO @@L2VNO                                    
      WHILE @@FETCH_STATUS = 0                        
        BEGIN                        
          DELETE FROM TEMPLEDGER2                        
          WHERE       SESSIONID = '9999999999'                        
                      
  /*======CLIENT SIDE RECORD======*/                        
          INSERT INTO TEMPLEDGER2                        
          SELECT 'BRANCH',                        
                 C.COSTNAME,                        
                 AMOUNT,                        
                 VTYP,                        
                 VNO,                        
                 LNO,                        
                 DRCR,                        
                 '0',                        
                 BOOKTYPE,                        
                 '9999999999',                        
                 CLIENT_CODE,                        
                 'A',                        
                 '0'                        
    FROM   #RECPAY_TABLE RP,                        
                 COSTMAST C WITH(NOLOCK)                        
          WHERE  RP.COSTCODE = C.COSTCODE                        
                 AND VNO = @@L2VNO                        
                        
          EXEC INSERTTOLEDGER2                        
            '9999999999' ,                        
            @@L2VNO ,                        
            '1' ,                        
            '1' ,                        
            '1' ,                        
            'BROKER' ,                        
         'BROKER'                        
                        
  FETCH NEXT FROM @@L2CUR                        
          INTO @@L2VNO                        
        END                        
                      
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                        
      WHERE       SESSIONID = '9999999999'    */                    
 END                        
                
              
DROP TABLE #LEDGER                
                      
              
IF @@ACCOUNTSVR <> 'ABCSOMKTUATSVR1'            
 BEGIN                       
 SET @@SQLPARA = " EXEC ACCOUNT_AB.DBO.V2_OFFLINE_REV_UPDATE '" + @@NEWVNO + "','" + @EXCHANGE + "','" + @SEGMENT + "' "              
 END                      
ELSE                      
 BEGIN                      
 SET @@SQLPARA = " EXEC V2_OFFLINE_REV_UPDATE '" + @@NEWVNO + "','" + @EXCHANGE + "','" + @SEGMENT + "' "              
END                 
print @@SQLPARA                   
EXEC(@@SQLPARA)                 
                 
COMMIT TRAN                           
                          
DROP TABLE #RECPAY_TABLE                          
SET @ERRORCODE = 0                          
SET @MESSAGE = 'POSTED SUCCESSFULLY'                          
EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME                          
                          
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_LEDGER_REPORT
-- --------------------------------------------------

 
CREATE PROC [dbo].[V2_OFFLINE_LEDGER_REPORT]            
(            
@startDate varchar(11),            
@endDate varchar(11),          
@fromParty varchar(10),          
@toParty varchar(10),      
@Selectionby VARCHAR(3),
@SortBy varchar(6),
@EXCSEGMENT VARCHAR(11)         
)            
AS          
    
/*    
EXEC V2_OFFLINE_LEDGER_REPORT 'SEP  1 2007','SEP 17 2007','0a141','0a141','VDT'    
*/    
    
DECLARE @@QRY AS VARCHAR(8000)    
DECLARE @@CLOSEBALQRY as VARCHAR(8000)
DECLARE @@OPENDATE AS VARCHAR(11)    
DECLARE @@FINSTART AS DATETIME    
DECLARE @@FINSTARTCHAR AS VARCHAR(11)    
    
SELECT @@QRY = "  "
SELECT @@CLOSEBALQRY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "    
    
SELECT @@FINSTART = SDTCUR, @@FINSTARTCHAR = LEFT(SDTCUR,11) FROM PARAMETER (NOLOCK) WHERE CONVERT(DATETIME,@startDate,109) BETWEEN SDTCUR AND LDTCUR      
    
IF UPPER(@SELECTIONBY) = 'VDT'    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND VDATE <= @@FINSTART)    
    
    
END    
ELSE    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND EDATE <= @@FINSTART)    
END    
    

BEGIN DISTRIBUTED TRANSACTION    

IF Upper(@Selectionby) = 'VDT'      
  BEGIN      
  IF @startDate = @@FINSTART     
        Begin      
   If @@Opendate = @@FINSTARTCHAR       
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "   
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "   
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
   Else      
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "      
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
        End      
  Else      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
END       
ELSE     
  BEGIN      
  If @StartDate = @@FINSTARTCHAR And @@Opendate = @@FINSTARTCHAR      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
  Else      
        Begin      
    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) <= 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) > 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "     
      SELECT @@QRY = @@QRY + " FROM "     
      SELECT @@QRY = @@QRY + " (Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE  "    
      SELECT @@QRY = @@QRY + " UNION ALL  "    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And EDATE < '" + @@FINSTARTCHAR + "' AND VOUCHERTYPE <> 18"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE ) T"     
      SELECT @@QRY = @@QRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE "    
        End      
  End      
    
    
 SELECT @@QRY = @@QRY + " UNION ALL "    
 SELECT @@QRY = @@QRY + " select A.Exchange, A.Segment, "     
 SELECT @@QRY = @@QRY + " UPPER(ISNULL(V.SHORTDESC,'')) AS VNAME, "       
 SELECT @@QRY = @@QRY + " A.VOUCHERTYPE AS VTYP, "    
 SELECT @@QRY = @@QRY + " A.BOOKTYPE AS BOOKTYPE, "      
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Vdate,105) as VDt, "            
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Edate,105) as Edt, "            
 SELECT @@QRY = @@QRY + " a.OppCode as GLCode, "    
 SELECT @@QRY = @@QRY + " a.CltCode,"    
 SELECT @@QRY = @@QRY + " a.BranchCode,"    
 SELECT @@QRY = @@QRY + " a.CreditAmt, "          
 SELECT @@QRY = @@QRY + " a.DebitAmt,"           
 SELECT @@QRY = @@QRY + " a.Narration, "                   
 SELECT @@QRY = @@QRY + " a.VoucherNo as VNO, "        
 SELECT @@QRY = @@QRY + " a.Vdate, "     
 SELECT @@QRY = @@QRY + " a.BankName, "   
 SELECT @@QRY = @@QRY + " a.BranchName "   
 SELECT @@QRY = @@QRY + " from "        
 SELECT @@QRY = @@QRY + " v2_offline_ledger_entries a (NOLOCK) "    
 SELECT @@QRY = @@QRY + " LEFT OUTER JOIN "    
 SELECT @@QRY = @@QRY + " VMAST V ON (V.VTYPE = A.VOUCHERTYPE) "       
 SELECT @@QRY = @@QRY + " Where 1=1 "        
 IF Upper(@Selectionby) = 'VDT'    
 BEGIN      
 SELECT @@QRY = @@QRY + " And a.vDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.vDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "           
 END    
 ELSE    
 BEGIN    
 SELECT @@QRY = @@QRY + " And a.EDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.EDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "    
 END    
 SELECT @@QRY = @@QRY + " and a.CltCode >= '" + @FromParty + "' "         
 SELECT @@QRY = @@QRY + " and a.CltCode <= '" + @ToParty + "'"         
 SELECT @@QRY = @@QRY + " AND A.VOUCHERTYPE <> '18'"      
 	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END 


      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSEBAL' AS VNAME, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VTYP, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BOOKTYPE, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as VDt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as Edt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as GLCode, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " CltCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " BranchCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) > 0 THEN SUM(CREDITAMT) - SUM(DEBITAMT) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) <= 0 THEN SUM(DEBITAMT) - SUM(CREDITAMT) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSING BALANCE' AS Narration, "                   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VNO, "        
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '31-DEC-2049' AS Vdate, "     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BankName, "   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BranchName "  
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " FROM "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ( "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ) X " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " UNION ALL " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	if @SORTBY = 'DTASC'
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate asc" 
	end
	else
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate desc" 
	end
EXEC (@@CLOSEBALQRY)

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_PAYMENTUPLOAD
-- --------------------------------------------------

CREATE PROC [dbo].[V2_OFFLINE_PAYMENTUPLOAD](                          
                          
           @UNAME     VARCHAR(25),                          
           @USERCAT   INT,                          
           @EXCHANGE  VARCHAR(3),                          
           @SEGMENT   VARCHAR(10),                          
	     @IP_VDATE varchar(11),        
           @RECOFLAG  CHAR(1) = 'N')                          
                          
AS                          
  
                        
                        
  SET NOCOUNT ON                          
                            
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                          
  DECLARE  @@STD_DATE        VARCHAR(11),                          
           @@LST_DATE        VARCHAR(11),                          
           @@BRANCHFLAG       AS TINYINT,                          
           @@VNOFLAG          AS TINYINT,                          
           @@VNOMETHOD       INT,                          
           @@ACNAME          CHAR(100),                          
           @@BOOKTYPE        CHAR(2),                          
           @@MICRNO          VARCHAR(10),                          
           @@DRCR            VARCHAR(1),                          
           @@VTYP            SMALLINT,                          
           @@BANK_CODE       VARCHAR(100),                          
           @@BACKDAYS        INT,                          
           @@BACKDATE        VARCHAR(11),                          
           @@BRNCOUNT        TINYINT,                          
           @@MonthlyVdt      VARCHAR(11),                          
           @@SERIAL_NO       INT,                          
           @@COSTCODECOUNT   TINYINT,                          
           @@COSTCODEUPDATES CURSOR,                          
           @@NEWVNO           AS VARCHAR(12),                          
           @@MAXCOUNT         AS INT,                          
           @@VDT              AS VARCHAR(11),                          
           @@BANKBRANCH       AS VARCHAR(10),                          
           @@BANKCOST         AS NUMERIC,                          
           @@LNOCUR           AS CURSOR,                          
           @@VNOCUR           AS CURSOR,                          
           @@LNOVNO           AS VARCHAR(12),                          
           @@MAXVNO           AS INT,                          
           @@L2CUR            AS CURSOR,                          
           @@L2VNO            AS VARCHAR(12),                          
           @@ERROR_COUNT      AS BIGINT,                          
           @@FILEEXISTS       AS INT,                          
           @@SQL              AS VARCHAR(2000),                          
           @ERRORCODE         AS INT,                          
           @MESSAGE           AS VARCHAR(200) ,                  
   @@RECPAYTBLCOUNT BIGINT                  
                                               
                          
 SET @@VTYP = 3                       
                        
       BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                          
                          
  CREATE TABLE [#RECPAY_TABLE] (                          
    SNO    INT   IDENTITY ( 1,1 ),                          
    EDATE        VARCHAR(20),                          
    VOUCHER_DATE VARCHAR(20),                          
    CLIENT_CODE  VARCHAR(50),                          
    AMOUNT       MONEY,                          
    DRCR         VARCHAR(1),                          
    NARRATION    VARCHAR(234),                          
    BANK_CODE    VARCHAR(10),                          
    BANK_NAME    VARCHAR(100),             
    REF_NO       VARCHAR(15),                          
    BRANCHCODE   VARCHAR(20),                          
    BRANCH_NAME  VARCHAR(50),                          
    CHQ_MODE     VARCHAR(1),                          
    CHQ_DATE     VARCHAR(20),                     
    CHQ_NAME     VARCHAR(100),                          
    CL_MODE      VARCHAR(1),                          
    FLD_AUTO     BIGINT,                   
    ENTEREDBY    VARCHAR(25),                          
    VDT          DATETIME   NULL,                          
    FYSTART      DATETIME   NULL,                    
    FYEND        DATETIME   NULL,                          
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                          
    EDT          DATETIME   NULL,                          
    DDDT         DATETIME   NULL,                          
    VNO          VARCHAR(12)   NULL,                          
    VTYP         SMALLINT   NULL,                          
    ACNAME       VARCHAR(100)   NULL,                          
    COSTCODE     SMALLINT   NULL,                          
    BANKCOST     SMALLINT   NULL,                          
    LNO          SMALLINT   NOT NULL DEFAULT (0),                          
    BANKNAME     VARCHAR(100)   NULL,                          
    MICRNO       INT   NULL,                          
    BOOKTYPE     VARCHAR(2)   NULL,                          
    ACC_NO       VARCHAR(16))                          
  ON [PRIMARY]                          
                            
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                          
  INSERT INTO #RECPAY_TABLE                          
             (EDATE,                          
              VOUCHER_DATE,                          
              CLIENT_CODE,                          
              AMOUNT,                          
              DRCR,                          
              NARRATION,                          
              BANK_CODE,                          
              BANK_NAME,                          
              REF_NO,                          
              BRANCHCODE,                          
              BRANCH_NAME,                          
              CHQ_MODE,                          
              CHQ_DATE,                          
              CHQ_NAME,                          
              CL_MODE,                          
              FLD_AUTO,                          
              ENTEREDBY,                          
              VDT,                           
              EDT,                           
              DDDT,                          
              ACC_NO,VTYP)                          
  SELECT CONVERT(VARCHAR,EDATE,103),                          
         CONVERT(VARCHAR,VDATE,103),                          
         CLTCODE,                          
         DEBITAMT,                          
         'C',                          
         NARRATION,                          
         OPPCODE,                          
         BANKNAME,                          
         DDNO,                          
         'ALL',                          
         BRANCHNAME,                          
         CHEQUEMODE,                          
         CONVERT(VARCHAR,CHEQUEDATE,103),                          
         CHEQUENAME,                          
         CLEAR_MODE,                          
         FLDAUTO,                          
         ADDBY,                           
         VDATE,                           
         EDATE,                           
         CHEQUEDATE,                           
         TPAccountNumber, VOUCHERTYPE                          
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                           
  WHERE  VOUCHERTYPE = 3                        
         AND EXCHANGE = @EXCHANGE                          
         AND SEGMENT = @SEGMENT                          
         AND ISNULL(ROWSTATE,0) = 0     
   AND ISNULL(APPROVALFLAG,0) = 1                    
   AND VDATE LIKE @IP_VDATE + '%'         
               
                      
                    
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                  
                  
 IF @@RECPAYTBLCOUNT = 0                  
 BEGIN                  
  COMMIT                  
  RETURN                  
 END                  
           
            
            
--TRUNCATE table #RECPAY_TABLE            
--return                  
            
               
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK)                           
  SET    ROWSTATE = 9                          
  FROM   #RECPAY_TABLE                          
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                          
  FROM   #RECPAY_TABLE                          
                                   
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                          
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                          
         @@BRANCHFLAG = BRANCHFLAG,                          
         @@VNOFLAG = VNOFLAG                          
  FROM   PARAMETER WITH(NOLOCK)                           
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                          
                                                            
  IF @@VNOFLAG <> 0                          
    BEGIN                          
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                          
      FROM   #RECPAY_TABLE                          
                                       
      IF @@ERROR_COUNT > 1                          
        BEGIN                          
     DROP TABLE #RECPAY_TABLE                                      
     ROLLBACK TRANSACTION                          
     SET @ERRORCODE = 1                                    
     SET @MESSAGE = 'PAYMENT FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                          
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                   
     RETURN                          
        END                          
    END                          
                          
  IF @@BRANCHFLAG = 1                          
    BEGIN                          
      UPDATE #RECPAY_TABLE                          
      SET    BRANCHCODE = A.BRANCHCODE,                          
             FYSTART = P.SDTCUR,                          
           FYEND = P.LDTCUR,                          
             UPDFLAG = 'Y',                          
             ACNAME = A.LONGNAME,                          
             COSTCODE = C.COSTCODE,                          
             BANKNAME = B.LONGNAME,                          
             BOOKTYPE = B.BOOKTYPE,                          
             MICRNO = ISNULL(B.MICRNO,0)                          
      FROM   ACMAST A WITH(NOLOCK),                          
             PARAMETER P WITH(NOLOCK),                          
            COSTMAST C WITH(NOLOCK),                          
             ACMAST B WITH(NOLOCK)                          
      WHERE  A.CLTCODE = CLIENT_CODE                          
             AND B.CLTCODE = BANK_CODE                          
             --AND P.CURYEAR = 1 
			 AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                         
             AND A.ACCAT IN ('3','4','18')                          
             AND B.ACCAT = '2'                          
             AND A.BRANCHCODE = COSTNAME                          
            
      UPDATE #RECPAY_TABLE                          
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),   
             FYSTART = P.SDTCUR,                          
             FYEND = P.LDTCUR,                          
             UPDFLAG = 'Y',                          
             ACNAME = A.LONGNAME,                          
             COSTCODE = (SELECT TOP 1 COSTCODE                          
                         FROM   COSTMAST                          
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                          
             BANKNAME = B.LONGNAME,                          
             BOOKTYPE = B.BOOKTYPE,                          
             MICRNO = ISNULL(B.MICRNO,0)                          
      FROM   ACMAST A WITH(NOLOCK),                          
             PARAMETER P WITH(NOLOCK),                          
             COSTMAST C WITH(NOLOCK),                          
             ACMAST B WITH(NOLOCK)                          
      WHERE  A.CLTCODE = CLIENT_CODE                
             AND B.CLTCODE = BANK_CODE                          
             --AND P.CURYEAR = 1 
			 AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                         
             AND A.ACCAT IN ('3','4','18')                          
             AND B.ACCAT = '2'                          
             AND A.BRANCHCODE = 'ALL'                          
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                          
                                                                       
      UPDATE #RECPAY_TABLE           
      SET    BRANCHCODE = 'HO',                          
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                          
             FYSTART = P.SDTCUR,                          
             FYEND = P.LDTCUR,                          
             UPDFLAG = 'Y',                          
             ACNAME = A.LONGNAME,                          
             COSTCODE = (SELECT TOP 1 COSTCODE                          
                         FROM   COSTMAST                          
             WHERE  COSTNAME = 'HO'),                          
             BANKNAME = B.LONGNAME,                          
             BOOKTYPE = B.BOOKTYPE,                          
             MICRNO = ISNULL(B.MICRNO,0)                          
      FROM   ACMAST A WITH(NOLOCK),                          
       PARAMETER P WITH(NOLOCK),                          
             COSTMAST C WITH(NOLOCK),                          
             ACMAST B WITH(NOLOCK)                          
      WHERE  A.CLTCODE = CLIENT_CODE                          
             AND B.CLTCODE = BANK_CODE                          
             --AND P.CURYEAR = 1 
			 AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                         
             AND A.ACCAT IN ('3','4','18')                          
             AND B.ACCAT = '2'                          
             AND A.BRANCHCODE = 'ALL'                          
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                          
    END                          
  ELSE                     
    BEGIN                          
      UPDATE #RECPAY_TABLE                          
      SET    FYSTART = @@STD_DATE,                          
             FYEND = @@LST_DATE + ' 23:59:59',                          
             UPDFLAG = 'Y',                          
             ACNAME = A.LONGNAME,                          
             BANKNAME = B.LONGNAME,                          
             BOOKTYPE = B.BOOKTYPE,                          
             MICRNO = ISNULL(B.MICRNO,0)                          
      FROM   ACMAST A WITH(NOLOCK),                          
             ACMAST B WITH(NOLOCK)                          
      WHERE  A.CLTCODE = CLIENT_CODE                          
             AND B.CLTCODE = BANK_CODE                          
             AND A.ACCAT IN ('3','4','18')                          
             AND B.ACCAT = '2'                          
    END                          
                              
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                          
  SELECT @@ERROR_COUNT = COUNT(SNO)                          
  FROM   #RECPAY_TABLE                          
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                          
                          
  IF @@ERROR_COUNT > 0                    
    BEGIN                       
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                       
    SET @ERRORCODE = 1                                   
    SET @MESSAGE = 'PAYMENT SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                          
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                          
    END                          
                              
  SET @@ERROR_COUNT = 0                          
                            
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                          
  SELECT @@ERROR_COUNT = COUNT(1)                          
  FROM   #RECPAY_TABLE                          
  WHERE  VDT > EDT                          
                            
  IF @@ERROR_COUNT > 0                          
    BEGIN                        
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                   
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                 
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                          
    END                          
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                          
  SELECT @@ERROR_COUNT = COUNT(1)                          
  FROM   #RECPAY_TABLE                          
  WHERE  AMOUNT <= 0                          
                            
  IF @@ERROR_COUNT > 0                          
    BEGIN                           
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                  
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                 
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                 
    END                          
                            
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                          
  SELECT @@ERROR_COUNT = COUNT(1)                          
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                          
                          CLTCODE = RP.CLIENT_CODE                          
   FROM   #RECPAY_TABLE RP,                          
                 LEDGER L WITH(NOLOCK),                          
               LEDGER1 L1 WITH(NOLOCK)                          
          WHERE  L1.DDNO = RP.REF_NO                          
                 AND L1.DD = RP.CHQ_MODE                          
                 AND L1.DRCR = @@DRCR                
                 AND L1.VTYP = @@VTYP                          
                 AND RP.REF_NO <> 0                          
                 AND L.VTYP = @@VTYP                          
                 AND L.VNO = L1.VNO                          
                 AND L.BOOKTYPE = L1.BOOKTYPE                          
                 AND L.DRCR = @@DRCR                          
                 AND L.CLTCODE = RP.CLIENT_CODE) A                          
                            
  IF @@ERROR_COUNT > 0                          
    BEGIN                          
 DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                  
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                 
    END                          
                            
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                          
  SELECT @@ERROR_COUNT = COUNT(1)                          
  FROM   (SELECT DISTINCT CLIENT_CODE                          
          FROM   #RECPAY_TABLE                          
          WHERE  UPDFLAG = 'N') A                          
                            
  IF @@ERROR_COUNT > 0                          
    BEGIN                          
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                  
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                 
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                     
    END                          
                      
  /*    ----------AUTO GENERATION OF VNO -------- */                          
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                          
         BOOKTYPE                          
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                          
                            
  OPEN @@VNOCUR                          
                            
  FETCH NEXT FROM @@VNOCUR                          
  INTO @@BANK_CODE,                          
       @@BOOKTYPE                          
                            
  WHILE @@FETCH_STATUS = 0                          
    BEGIN                          
      IF @@BRANCHFLAG = 1                          
        BEGIN                          
          SELECT @@BANKBRANCH = BRANCHCODE,                          
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                          
          FROM   ACMAST A WITH(NOLOCK)                          
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                          
                   ON (A.BRANCHCODE = C.COSTNAME)                          
          WHERE  A.CLTCODE = @@BANK_CODE                          
                                    
          IF @@BANKBRANCH <> 'ALL'                          
            BEGIN                          
              UPDATE RP                          
              SET    COSTCODE = @@BANKCOST                          
              FROM   #RECPAY_TABLE RP,                          
                     ACMAST A WITH(NOLOCK)                          
              WHERE  A.CLTCODE = RP.CLIENT_CODE                          
                     AND A.BRANCHCODE = 'ALL'                          
                                 
              UPDATE #RECPAY_TABLE                          
              SET    BANKCOST = @@BANKCOST                          
              WHERE  BANK_CODE = @@BANK_CODE                          
            END                          
          ELSE                          
            BEGIN                          
              UPDATE #RECPAY_TABLE                          
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                          
                                 FROM   COSTMAST WITH(NOLOCK)                          
                                 WHERE  COSTNAME = 'HO')                          
              WHERE  COSTCODE = ''                          
                     AND BANK_CODE = @@BANK_CODE                          
                                        
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                          
                                    COUNT(DISTINCT COSTCODE)                          
                                                 FROM     #RECPAY_TABLE                           
                                                 WHERE    BANK_CODE = @@BANK_CODE                          
                                                 GROUP BY SNO                          
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                          
                                        
              OPEN @@COSTCODEUPDATES                          
                                        
              FETCH NEXT FROM @@COSTCODEUPDATES                          
              INTO @@SERIAL_NO,                          
                   @@COSTCODECOUNT                          
                          
              WHILE @@FETCH_STATUS = 0                          
                BEGIN                          
                  UPDATE #RECPAY_TABLE                          
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                          
                                  FROM   COSTMAST WITH(NOLOCK)                          
                                     WHERE  COSTNAME = 'HO')                          
                  WHERE  (BANKCOST = ''                          
                           OR BANKCOST IS NULL)                          
                         AND BANK_CODE = @@BANK_CODE                          
                         AND SNO = @@SERIAL_NO                          
                                            
                  FETCH NEXT FROM @@COSTCODEUPDATES                          
                  INTO @@SERIAL_NO,                          
         @@COSTCODECOUNT                          
                END                          
                                        
              CLOSE @@COSTCODEUPDATES                          
                                        
              DEALLOCATE @@COSTCODEUPDATES                          
                                        
              UPDATE #RECPAY_TABLE                          
              SET    BANKCOST = COSTCODE                          
              WHERE  BANK_CODE = @@BANK_CODE                          
                     AND (BANKCOST = ''                          
                           OR BANKCOST IS NULL)                         
END                          
        END                          
                                
      CREATE TABLE #BANK_VNO (                          
        SRNO    INT,                          
        NEWSRNO INT   IDENTITY ( 1,1 ))                          
                                
      INSERT INTO #BANK_VNO                          
      SELECT DISTINCT SNO                          
      FROM   #RECPAY_TABLE                          
      WHERE  BANK_CODE = @@BANK_CODE                          
          AND BOOKTYPE = @@BOOKTYPE                          
                                                      
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                          
      FROM   #RECPAY_TABLE                          
                                       
      SELECT TOP 1 @@VDT = VDT                          
      FROM   #RECPAY_TABLE                          
                                
      SELECT LASTVNO                          
      INTO   #VNO                          
      FROM   LASTVNO WITH(NOLOCK)                          
      WHERE  1 = 2                          
                                
      SELECT @@MAXVNO = MAX(NEWSRNO)                          
      FROM   #BANK_VNO                          
                         
                        
            
            
      INSERT INTO #VNO                          
      EXEC ACC_GENVNO_NEW                          
        @@VDT ,                          
    @@VTYP ,                          
        @@BOOKTYPE ,                          
   @@STD_DATE ,                          
        @@LST_DATE ,                          
        @@MAXVNO                          
                                
      SELECT @@NEWVNO = LASTVNO                          
      FROM   #VNO                          
                                
      UPDATE RP                          
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                          
      FROM   #RECPAY_TABLE RP,                          
             #BANK_VNO BV                          
      WHERE  RP.SNO = BV.SRNO                          
                                
             
            
      DROP TABLE #VNO                          
                                
      DROP TABLE #BANK_VNO                          
                                
      FETCH NEXT FROM @@VNOCUR                          
      INTO @@BANK_CODE,                          
           @@BOOKTYPE                          
    END                     
                            
  /*   ----------AUTO GENERATION OF LNO -------- */                          
  UPDATE #RECPAY_TABLE                          
 SET    LNO = 2                          
  WHERE  VNO IN (SELECT   VNO                          
                 FROM     #RECPAY_TABLE                           
                 GROUP BY VNO                          
                 HAVING   COUNT(*) = 1)                          
              
            
            
                          
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                          
                            FROM     #RECPAY_TABLE                           
                            GROUP BY VNO                          
                            HAVING   COUNT(*) > 1                          
                            
  OPEN @@LNOCUR                          
                            
  FETCH NEXT FROM @@LNOCUR                          
  INTO @@LNOVNO                          
                            
  WHILE @@FETCH_STATUS = 0                          
    BEGIN                          
      CREATE TABLE [#LNOGEN] (                          
        VNO VARCHAR(12),                          
        SNO INT,                          
        LNO INT   IDENTITY ( 1,1 ))                          
                                
      INSERT INTO #LNOGEN                          
      SELECT   VNO, SNO                          
      FROM     #RECPAY_TABLE WITH (NOLOCK)                          
      WHERE    VNO = @@LNOVNO                          
      ORDER BY SNO                          
                                
      UPDATE #RECPAY_TABLE                          
      SET    LNO = L.LNO + 1                          
      FROM   #LNOGEN L  
      WHERE  #RECPAY_TABLE.VNO = L.VNO                          
             AND #RECPAY_TABLE.SNO = L.SNO                          
             AND #RECPAY_TABLE.LNO = 0                          
                                
      DROP TABLE #LNOGEN                          
                                
      FETCH NEXT FROM @@LNOCUR                          
      INTO @@LNOVNO                          
    END                          
                            
  CLOSE @@LNOCUR                          
                            
  DEALLOCATE @@LNOCUR                          
                            
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                          
  INSERT INTO LEDGER1                          
             (BNKNAME,                          
              BRNNAME,                          
              DD,                          
     DDNO,                          
              DDDT,                          
              RELDT,                          
              RELAMT,                          
              REFNO,                          
              RECEIPTNO,                          
              VTYP,                          
     VNO,                          
              LNO,                          
     DRCR,                          
              BOOKTYPE,                          
              MICRNO,                          
              SLIPNO,                          
              SLIPDATE,                          
              CHEQUEINNAME,                          
              CHQPRINTED,                          
              CLEAR_MODE)                          
  SELECT   BNKNAME = MAX(BANK_NAME),                          
           BRNNAME = MAX(BRANCH_NAME),                          
           DD = MAX(CHQ_MODE),                          
           DDNO = MAX(REF_NO),                          
           DDDT = MAX(DDDT),                        
           RELDT = '',                          
           RELAMT = SUM(AMOUNT),                          
           REFNO = 0,                          
           RECEIPTNO = 0,                          
           VTYP,                          
           VNO,                          
           LNO = 2,                          
           DRCR,                          
           BOOKTYPE = BOOKTYPE,                         
           MICRNO = MICRNO,                          
           SLIPNO = 0,                          
           SLIPDATE = '',                          
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                          
           CHQPRINTED = 0,                          
           CLEAR_MODE = MAX(CL_MODE)                          
  FROM     #RECPAY_TABLE                          
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                          
           MICRNO                          
                             
  IF @@ERROR <> 0                          
    BEGIN                            
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                  
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                 
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                  
    END                          
                              
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                          
  CREATE TABLE #LEDGER (                          
    VTYP      SMALLINT,                          
    VNO       VARCHAR(12),                          
    EDT       DATETIME,                          
    LNO       SMALLINT,                          
    ACNAME    VARCHAR(100),           
    DRCR      VARCHAR(1),                          
    VAMT      MONEY,                          
    VDT       DATETIME,                          
    VNO1      VARCHAR(12),                          
    REFNO     CHAR(12),                          
    BALAMT    MONEY,                          
    NODAYS    INT,                          
    CDT       DATETIME,                          
    CLTCODE   VARCHAR(10),                          
    BOOKTYPE  VARCHAR(2),                          
    ENTEREDBY VARCHAR(25),                          
    PDT       DATETIME,                          
    CHECKEDBY VARCHAR(25),                          
    ACTNODAYS INT,                          
    NARRATION VARCHAR(234))                              
                            
  CREATE TABLE #LEDGER3 (                          
    NARATNO  INT,                          
    NARR     VARCHAR(234),                          
    REFNO    CHAR(12),                          
    VTYP     SMALLINT,                          
    VNO      VARCHAR(12),                          
    BOOKTYPE VARCHAR(2))                          
                            
/*======CLIENT SIDE RECORD======*/                          
  INSERT INTO #LEDGER                    
             (VTYP,                          
              VNO,                          
              EDT,                          
              LNO,                          
              ACNAME,                          
              DRCR,                         
      VAMT,                          
              VDT,                          
              VNO1,                          
              REFNO,                          
              BALAMT,                          
              NODAYS,                          
              CDT,                          
              CLTCODE,                          
              BOOKTYPE,                          
              ENTEREDBY,                          
              PDT,                          
              CHECKEDBY,                          
              ACTNODAYS,                          
              NARRATION)                          
  SELECT VTYP,                          
         VNO,                          
         EDT = (CASE                           
                  WHEN VTYP = 3                          
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                          
                  ELSE EDT                          
                END),                      
         LNO,                          
         ACNAME,                          
         DRCR,                          
         VAMT = AMOUNT,                          
         VDT,                          
         VNO1 = VNO,                          
         REFNO = 0,                          
         BALAMT = AMOUNT,                          
         NODAYS = 0,                          
         CDT = GETDATE(),                          
         CLTCODE = CLIENT_CODE,                          
         BOOKTYPE = BOOKTYPE,                          
         ENTEREDBY = ENTEREDBY,                          
         PDT = GETDATE(),                          
         CHECKEDBY = @UNAME,                          
         ACTNODAYS = 0,                          
         NARRATION                          
  FROM   #RECPAY_TABLE                          
                            
/*======BANK SIDE RECORD======*/                          
  INSERT INTO #LEDGER                          
  SELECT   VTYP,                          
           VNO,                          
           EDT = (CASE                           
                    WHEN VTYP = 3                          
                         AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                          
         ELSE EDT                          
                  END),                          
           LNO = 1,                          
           BANKNAME,                          
           DRCR = (CASE                           
                     WHEN DRCR = 'D' THEN 'C'                          
                     ELSE 'D'              
                   END),                          
           VAMT = SUM(AMOUNT),                          
           VDT,                          
           VNO1 = VNO,                          
           REFNO = 0,                          
           BALAMT = SUM(AMOUNT),                          
           NODAYS = 0,                          
CDT = GETDATE(),                          
           CLTCODE = BANK_CODE,                          
           BOOKTYPE = BOOKTYPE,                          
           ENTEREDBY = ENTEREDBY,                          
           PDT = GETDATE(),                          
           CHECKEDBY = @UNAME,                          
           ACTNODAYS = 0,                          
           NARRATION = MAX(NARRATION)                          
  FROM     #RECPAY_TABLE                          
  GROUP BY VTYP,VNO,EDT,DRCR,                          
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                          
           ENTEREDBY                          
                            
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                          
  INSERT INTO LEDGER                          
 (VTYP,                          
              VNO,                          
              EDT,                          
              LNO,                          
              ACNAME,                          
              DRCR,                          
              VAMT,                          
              VDT,                          
              VNO1,                          
              REFNO,                         
              BALAMT,                          
              NODAYS,                          
              CDT,                          
              CLTCODE,                          
              BOOKTYPE,                          
              ENTEREDBY,                          
              PDT,                          
              CHECKEDBY,                          
              ACTNODAYS,                          
              NARRATION)                          
  SELECT   VTYP,                          
           VNO,                          
       EDT,                          
           LNO,                          
           ACNAME,                          
           DRCR,                          
           VAMT,                          
           VDT,                          
           VNO1,                          
           REFNO,                          
           BALAMT,                          
           NODAYS,                          
           CDT,                          
           CLTCODE,         
           BOOKTYPE,                          
           ENTEREDBY,                          
           PDT,                          
           CHECKEDBY,                          
           ACTNODAYS,                          
           NARRATION                          
  FROM     #LEDGER                          
  ORDER BY BOOKTYPE,                          
           VTYP,                          
           VNO,                          
           LNO                          
                                     
  IF @@ERROR <> 0                          
    BEGIN                          
    DROP TABLE #LEDGER                          
    DROP TABLE #LEDGER3                              
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                  
    SET @ERRORCODE = 1        
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                 
    END                          
                            
  DROP TABLE #LEDGER                          
                            
/*======BANK SIDE RECORD======*/                          
  INSERT INTO #LEDGER3                          
  SELECT   NARATNO = 1,                          
           NARRATION = MAX(NARRATION),                          
           REFNO = 0,                          
           VTYP,                          
           VNO,                          
           BOOKTYPE                          
  FROM     #RECPAY_TABLE            
  GROUP BY VTYP,VNO,BOOKTYPE                   
                            
/*======CLIENT SIDE RECORD======*/                          
  INSERT INTO #LEDGER3                          
  SELECT NARATNO = LNO,                          
         NARR = NARRATION,                          
         REFNO = 0,                          
         VTYP,                          
         VNO,                          
         BOOKTYPE                          
  FROM   #RECPAY_TABLE                          
                                   
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                          
  INSERT INTO LEDGER3                          
  SELECT   *                          
  FROM     #LEDGER3                          
  ORDER BY BOOKTYPE,                          
           VTYP,                          
   VNO,                          
           NARATNO                          
                                     
  IF @@ERROR <> 0                          
    BEGIN                          
    DROP TABLE #LEDGER3                              
    DROP TABLE #RECPAY_TABLE                          
    ROLLBACK TRAN                  
    SET @ERRORCODE = 1                                   
    SET @MESSAGE = 'PAYMENT DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                 
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                 
    END                          
                            
  DROP TABLE #LEDGER3                          
                            
  IF @@BRANCHFLAG = 1                          
    BEGIN                          
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                          
              FROM     #RECPAY_TABLE                          
                               ORDER BY VNO                          
                                
      OPEN @@L2CUR                          
                                
      FETCH NEXT FROM @@L2CUR                          
      INTO @@L2VNO                          
                                
      WHILE @@FETCH_STATUS = 0                          
        BEGIN                          
          DELETE FROM TEMPLEDGER2                          
          WHERE       SESSIONID = '9999999999'                          
                                    
/*======CLIENT SIDE RECORD======*/                          
          INSERT INTO TEMPLEDGER2                          
          SELECT 'BRANCH',                          
                 C.COSTNAME,                          
                 AMOUNT,                          
                 VTYP,                          
                 VNO,                          
                 LNO,                          
                 DRCR,                          
                 '0',                          
                 BOOKTYPE,                          
                 '9999999999',                  
                 CLIENT_CODE,                          
'A',                          
                 '0'                          
          FROM   #RECPAY_TABLE RP,                          
                 COSTMAST C WITH(NOLOCK)                           
          WHERE  RP.COSTCODE = C.COSTCODE                          
                 AND VNO = @@L2VNO                          
                                    
/*======BANK SIDE RECORD======*/                          
          INSERT INTO TEMPLEDGER2                          
          SELECT   'BRANCH',                          
                   C.COSTNAME,                          
                   SUM(AMOUNT),                          
                   VTYP,                          
                   VNO,                      
                   LNO = 1,                          
                   DRCR = (CASE                           
                             WHEN DRCR = 'D' THEN 'C'                          
                             ELSE 'D'                          
                           END),                          
                   '0',                          
                   BOOKTYPE,                          
                   '9999999999',                          
                   BANK_CODE,                          
                   'A',                          
                   '0'                          
          FROM     #RECPAY_TABLE RP,                          
                   COSTMAST C WITH(NOLOCK)                          
          WHERE    RP.BANKCOST = C.COSTCODE                          
                   AND VNO = @@L2VNO                          
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                           
                      WHEN DRCR = 'D' THEN 'C'                          
                      ELSE 'D'                          
                    END),                          
                   BANK_CODE,BOOKTYPE                          
                                    
          EXEC INSERTTOLEDGER2                          
            '9999999999' ,                          
            @@L2VNO ,                          
            '1' ,                          
            '1' ,                          
            '1' ,                          
            'BROKER' ,                          
            'BROKER'                          
                                    
 FETCH NEXT FROM @@L2CUR                          
          INTO @@L2VNO                          
        END                          
                                
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                          
      WHERE       SESSIONID = '9999999999'                          
                          
      IF EXISTS (SELECT *                          
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                           
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                          
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                           
         AND @@VTYP = 3                          
        BEGIN                          
          INSERT INTO THIRDPARTY_COLLECTION                          
(VNO,                          
                      VTYP,                          
                      BOOKTYPE,                          
                      CLTCODE,                          
                      AMOUNT,                          
                      VDT,                          
                      DDNO,                          
 ACCOUNT_NO,                          
                      TPR_FLAG)                          
          SELECT   VNO,                          
                   VTYP,                          
                   BOOKTYPE,                          
                CLIENT_CODE,                          
                   AMOUNT,                          
                   VDT,                          
                   MAX(REF_NO),                          
                   ACC_NO,                          
                   TPR_FLAG = 'S'                          
          FROM     #RECPAY_TABLE                          
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                          
                   AMOUNT,VDT,ACC_NO                          
                                             
          UPDATE T                          
          SET    TPR_FLAG = 'C'                          
          FROM                   
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                          
                 MULTIBANKID M WITH(NOLOCK),                          
                 #RECPAY_TABLE R                          
          WHERE  T.CLTCODE = M.CLTCODE                          
                 AND M.ACCNO = T.ACCOUNT_NO                          
                 AND T.VNO = R.VNO                          
                 AND T.VTYP = R.VTYP                          
                 AND T.BOOKTYPE = R.BOOKTYPE                          
        END                          
                            
   COMMIT TRANSACTION                          
 END                          
                              
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK)                           
SET                    
 ROWSTATE = 1,                        
 APPROVALFLAG = 1,                        
 APPROVALDATE = GETDATE(),                        
 APPROVEDBY = 'SYSTEM',                        
 LEDGERVNO = VNO,
 UPLOADDT = GETDATE()                          
FROM   #RECPAY_TABLE          
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                          
                                
                            
DROP TABLE #RECPAY_TABLE                          
SET @ERRORCODE = 0               
SET @MESSAGE = 'PAYMENT POSTED SUCCESSFULLY'                  
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD
-- --------------------------------------------------
          
CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD](                                                              
                                                              
           @UNAME     VARCHAR(25),                                                              
           @USERCAT   INT,                                                              
           @EXCHANGE  VARCHAR(3),                                                              
           @SEGMENT   VARCHAR(10),                                                              
           @IP_VDATE varchar(11),                                            
           @RECOFLAG  CHAR(1) = 'N')                                                              
                                                              
AS                                                              
                                      
SET XACT_ABORT ON                                                              
/*                                                            
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                                           
*/                                                            
                                                            
                                                            
  SET NOCOUNT ON                                                              
                                                                
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                              
  DECLARE  @@STD_DATE        VARCHAR(11),                                                              
           @@LST_DATE        VARCHAR(11),                                                              
           @@BRANCHFLAG       AS TINYINT,                                                              
           @@VNOFLAG          AS TINYINT,                                                              
           @@VNOMETHOD       INT,                                                              
           @@ACNAME          CHAR(100),                                                              
           @@BOOKTYPE        CHAR(2),                                                              
           @@MICRNO          VARCHAR(10),                                                              
           @@DRCR            VARCHAR(1),                                                              
           @@VTYP            SMALLINT,                                                              
           @@BANK_CODE       VARCHAR(100),                                                              
           @@BACKDAYS        INT,                                                              
           @@BACKDATE        VARCHAR(11),                                                              
           @@BRNCOUNT        TINYINT,                                                              
           @@MonthlyVdt      VARCHAR(11),                                                              
           @@SERIAL_NO       INT,                                                              
           @@COSTCODECOUNT   TINYINT,                                                              
           @@COSTCODEUPDATES CURSOR,                                                              
           @@NEWVNO           AS VARCHAR(12),                                                              
           @@MAXCOUNT         AS INT,                                                              
           @@VDT              AS VARCHAR(11),                                                              
           @@BANKBRANCH       AS VARCHAR(10),                                                              
           @@BANKCOST         AS NUMERIC,                                                              
           @@LNOCUR           AS CURSOR,                                       
           @@VNOCUR           AS CURSOR,                                                   
           @@LNOVNO           AS VARCHAR(12),                                                              
           @@MAXVNO           AS INT,                                                           
           @@L2CUR            AS CURSOR,                                                      
           @@L2VNO            AS VARCHAR(12),                                                            
           @@ERROR_COUNT      AS BIGINT,                                              
           @@FILEEXISTS       AS INT,                                         
           @@SQL              AS VARCHAR(2000),                                           
           @ERRORCODE         AS INT,                                                              
     @MESSAGE           AS VARCHAR(200) ,                                                      
   @@RECPAYTBLCOUNT BIGINT                                                  
                                                                                   
                                          
 SET @@VTYP = 2                                                            
                                                            
BEGIN DISTRIBUTED TRANSACTION                                                              
                                                              
  CREATE TABLE [#RECPAY_TABLE] (                                                           
    SNO    INT   IDENTITY ( 1,1 ),                                                              
    EDATE        VARCHAR(20),                                                              
    VOUCHER_DATE VARCHAR(20),                                                              
    CLIENT_CODE  VARCHAR(50),                                                              
    AMOUNT       MONEY,                                                              
    DRCR         VARCHAR(1),                                             
    NARRATION    VARCHAR(234),                                                              
    BANK_CODE    VARCHAR(10),                                                              
    BANK_NAME    VARCHAR(100),                                                              
    REF_NO       VARCHAR(15),                                                              
    BRANCHCODE   VARCHAR(20),                                                              
    BRANCH_NAME  VARCHAR(50),                                                              
    CHQ_MODE     VARCHAR(1),                                                              
    CHQ_DATE     VARCHAR(20),                                                         
    CHQ_NAME     VARCHAR(100),                                                              
    CL_MODE      VARCHAR(1),                                                              
    FLD_AUTO     BIGINT,                                                       
    ENTEREDBY    VARCHAR(25),                                                              
    VDT          DATETIME   NULL,                                                              
    FYSTART      DATETIME   NULL,                                                        
    FYEND        DATETIME   NULL,                                                              
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                              
    EDT          DATETIME   NULL,                                                              
    DDDT         DATETIME   NULL,                                                              
    VNO          VARCHAR(12)   NULL,                                                              
    VTYP         SMALLINT   NULL,                                                              
    ACNAME       VARCHAR(100)   NULL,                                         
    COSTCODE     SMALLINT   NULL,                                                              
    BANKCOST     SMALLINT   NULL,                                                            
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                              
    BANKNAME     VARCHAR(100)   NULL,                                                              
    MICRNO       INT   NULL,                                                              
    BOOKTYPE     VARCHAR(2)   NULL,                                                              
    ACC_NO       VARCHAR(20))                                                              
  ON [PRIMARY]                                 
                                                        
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                                
  INSERT INTO #RECPAY_TABLE                                                              
             (EDATE,               
              VOUCHER_DATE,                                     
              CLIENT_CODE,                                                              
              AMOUNT,                                 
              DRCR,                                                              
              NARRATION,                                                              
              BANK_CODE,                                                            
              BANK_NAME,                                                              
              REF_NO,                                                              
              BRANCHCODE,                                               
              BRANCH_NAME,                                                              
              CHQ_MODE,                                                              
              CHQ_DATE,                               
              CHQ_NAME,                                                              
              CL_MODE,                                                              
              FLD_AUTO,                                                              
              ENTEREDBY,                                                              
              VDT,                                                               
              EDT,                                                               
              DDDT,                                                              
              ACC_NO,VTYP)                                                              
  SELECT CONVERT(VARCHAR,EDATE,103),                                                              
         CONVERT(VARCHAR,VDATE,103),                                                              
         CLTCODE,                                                 
         CREDITAMT,                                                              
         'C',                                                              
         NARRATION,                                                              
         OPPCODE,                                                              
         BANKNAME,                                                           
         DDNO,                                                              
         'ALL',                                                              
         BRANCHNAME,                                                              
         CHEQUEMODE,                                                              
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                              
         CHEQUENAME,                                                              
         CLEAR_MODE,                                                              
         FLDAUTO,     
         ADDBY,                                                               
         VDATE,                                                               
         EDATE,                                                               
         CHEQUEDATE,                                                     
         TPAccountNumber, VOUCHERTYPE                                                              
  FROM   ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                                   
  WHERE  VOUCHERTYPE = 2                                                              
         AND EXCHANGE = @EXCHANGE                                                              
         AND SEGMENT = @SEGMENT                                                              
         AND ISNULL(ROWSTATE,0) = 0          
   AND ISNULL(APPROVALFLAG,0) = 1                                                        
   AND VDATE LIKE @IP_VDATE + '%'                                             
                                                              
             
                                                        
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                                      
                                                      
 IF @@RECPAYTBLCOUNT = 0                                                      
 BEGIN                                     
  COMMIT                                                      
  RETURN                                                      
 END                                                      
                                               
                               
                                                
--TRUNCATE table #RECPAY_TABLE                                                
--return                                                      
                                                
                                                   
  UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES-- WITH (ROWLOCK)                                                               
  SET    ROWSTATE = 9                                                              
  FROM   #RECPAY_TABLE                                                              
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                     
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                              
  FROM   #RECPAY_TABLE                                                              
                                                                       
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                                                              
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                              
         @@BRANCHFLAG = BRANCHFLAG,                                                              
         @@VNOFLAG = VNOFLAG                                                              
  FROM   PARAMETER WITH(NOLOCK)                                                               
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                              
                                                                                                
  IF @@VNOFLAG <> 0                                                              
    BEGIN                                                              
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                                     
      FROM   #RECPAY_TABLE                                                              
                                                                           
      IF @@ERROR_COUNT > 1                                                              
        BEGIN                                                              
     DROP TABLE #RECPAY_TABLE                                                                          
     ROLLBACK TRANSACTION                                                    
     SET @ERRORCODE = 1                                                                        
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                              
     EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                       
     RETURN                                             
        END                                                              
    END                                                              
                                                              
  IF @@BRANCHFLAG = 1                            
    BEGIN                                                              
      UPDATE #RECPAY_TABLE                                                              
      SET    BRANCHCODE = A.BRANCHCODE,                                                              
             FYSTART = P.SDTCUR,                                                              
           FYEND = P.LDTCUR,                                                              
             UPDFLAG = 'Y',                                                              
             ACNAME = A.LONGNAME,                                                              
             COSTCODE = C.COSTCODE,                                                              
             BANKNAME = B.LONGNAME,                     
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                                                              
             PARAMETER P WITH(NOLOCK),                                                              
            COSTMAST C WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                    
             AND B.CLTCODE = BANK_CODE                                                              
             --AND P.CURYEAR = 1                                     
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                             
             AND A.ACCAT IN ('3','4','18')                                                              
             AND B.ACCAT = '2'                              
             AND A.BRANCHCODE = COSTNAME                                          
                                                                                              
      UPDATE #RECPAY_TABLE                                                              
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                              
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                              
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                              
             FYSTART = P.SDTCUR,                           
             FYEND = P.LDTCUR,                                                              
             UPDFLAG = 'Y',                                                              
             ACNAME = A.LONGNAME,                                                              
             COSTCODE = (SELECT TOP 1 COSTCODE                                                              
                         FROM   COSTMAST                                                              
    WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                              
             BANKNAME = B.LONGNAME,                                                              
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK),                                                              
             COSTMAST C WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                                                    
             AND B.CLTCODE = BANK_CODE                                                 
             --AND P.CURYEAR = 1                                     
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                      
             AND A.ACCAT IN ('3','4','18')                                                              
             AND B.ACCAT = '2'                                                              
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                              
                                                                                                           
      UPDATE #RECPAY_TABLE                                  
      SET    BRANCHCODE = 'HO',                                                              
           VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                              
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                              
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                                                              
             FYEND = P.LDTCUR,                                                              
             UPDFLAG = 'Y',                                                              
             ACNAME = A.LONGNAME,                                                              
             COSTCODE = (SELECT TOP 1 COSTCODE                                                              
                         FROM   COSTMAST                                                              
             WHERE  COSTNAME = 'HO'),                                                              
             BANKNAME = B.LONGNAME,                                                              
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                                                              
       PARAMETER P WITH(NOLOCK),                                                              
             COSTMAST C WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND B.CLTCODE = BANK_CODE                                                              
             --AND P.CURYEAR = 1                                     
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                             
             AND A.ACCAT IN ('3','4','18')                                                              
            AND B.ACCAT = '2'                                                              
             AND A.BRANCHCODE = 'ALL'                                                              
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                              
    END                                                              
  ELSE                                                         
    BEGIN              
      UPDATE #RECPAY_TABLE                                                              
      SET    FYSTART = @@STD_DATE,                                                              
             FYEND = @@LST_DATE + ' 23:59:59',                                                              
             UPDFLAG = 'Y',                                                    
             ACNAME = A.LONGNAME,                                                              
             BANKNAME = B.LONGNAME,                                              
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                                                          
             AND B.CLTCODE = BANK_CODE                                                              
             AND A.ACCAT IN ('3','4','18')                                                              
             AND B.ACCAT = '2'                                                              
    END                                                              
                                                                  
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                              
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                              
  FROM   #RECPAY_TABLE                                                              
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                              
                                                              
  IF @@ERROR_COUNT > 0                                                        
    BEGIN                                                           
    DROP TABLE #RECPAY_TABLE                                             
    ROLLBACK TRAN                                                           
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                                 
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                                                              
    END                                                              
                                              
  SET @@ERROR_COUNT = 0                                                              
                                                                
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   #RECPAY_TABLE                         
  WHERE  VDT > EDT                                                              
                                                                
  IF @@ERROR_COUNT > 0                                                              
    BEGIN                                                            
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                       
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                     
    END                                                              
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   #RECPAY_TABLE                                                              
  WHERE  AMOUNT <= 0                                                              
                                                       
  IF @@ERROR_COUNT > 0                     
    BEGIN                                                               
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
 RETURN                                         
    END                                                              
                                                       
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                              
                          CLTCODE = RP.CLIENT_CODE                                                              
   FROM   #RECPAY_TABLE RP,                                      
                 LEDGER L WITH(NOLOCK),                                                              
                 LEDGER1 L1 WITH(NOLOCK)                                                              
          WHERE  L1.DDNO = RP.REF_NO                                                              
                 AND L1.DD = RP.CHQ_MODE                                                              
                 AND L1.DRCR = @@DRCR                                                    
                 AND L1.VTYP = @@VTYP                                                              
                 AND RP.REF_NO <> '0'                                                              
                 AND L.VTYP = @@VTYP                                                              
                 AND L.VNO = L1.VNO                                                              
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                              
                 AND L.DRCR = @@DRCR                                                              
                 AND L.CLTCODE = RP.CLIENT_CODE) A                     
                                                                
  IF @@ERROR_COUNT > 0                                          
    BEGIN                                                              
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                                    
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                  
    RETURN                                                     
    END                                                              
                                                                
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   (SELECT DISTINCT CLIENT_CODE                                                              
          FROM   #RECPAY_TABLE                                                              
          WHERE  UPDFLAG = 'N') A                                                              
                                       
  IF @@ERROR_COUNT > 0                                                              
    BEGIN                                                              
    DROP TABLE #RECPAY_TABLE                                                              
   ROLLBACK TRAN                                                     
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                                         
    END
    
      /*   ----------VALIDATION FOR INACTIVE CLIENT CODES -------- */     

           
    SELECT @@ERROR_COUNT = COUNT(1)
             
    FROM   (SELECT DISTINCT RP.CLIENT_CODE         
            FROM   #RECPAY_TABLE RP,         
                   CLIENT5 C WITH(NOLOCK)         
            WHERE C.INACTIVEFROM < GETDATE()     
                   AND C.CL_CODE = RP.CLIENT_CODE) A         
        
    IF @@ERROR_COUNT > 0         
      BEGIN         
          DROP TABLE #RECPAY_TABLE         
        
          ROLLBACK TRAN         
        
          SET @ERRORCODE = 1         
          SET @MESSAGE =         
          'DATA CANNOT BE UPLOADED AS THE SOME CLIENTS ARE INACTIVE'         
        
          EXEC V2_OFFLINE_UPLOAD_PUTLOG         
            @EXCHANGE,         
            @SEGMENT,         
            2,         
            @ERRORCODE,         
            @MESSAGE,         
            @UNAME         
        
          RETURN         
  END                                      
                                                          
  /*    ----------AUTO GENERATION OF VNO -------- */                                                              
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                              
         BOOKTYPE                                                              
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                           
                                                                
  OPEN @@VNOCUR                                                              
                                                                
  FETCH NEXT FROM @@VNOCUR                                                              
  INTO @@BANK_CODE,                                                              
       @@BOOKTYPE                                         
                                                                
  WHILE @@FETCH_STATUS = 0                                                              
    BEGIN                                                              
      IF @@BRANCHFLAG = 1                                                              
        BEGIN                                                              
          SELECT @@BANKBRANCH = BRANCHCODE,                                                              
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                                                              
          FROM   ACMAST A WITH(NOLOCK)                                       
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                     
                   ON (A.BRANCHCODE = C.COSTNAME)                                                              
  WHERE  A.CLTCODE = @@BANK_CODE                                                              
                                                                        
          IF @@BANKBRANCH <> 'ALL'                                                              
            BEGIN                                                              
              UPDATE RP                                                              
              SET    COSTCODE = @@BANKCOST                                  
              FROM   #RECPAY_TABLE RP,                                                              
                     ACMAST A WITH(NOLOCK)                                                              
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                              
                     AND A.BRANCHCODE = 'ALL'                                                              
                                                                            
              UPDATE #RECPAY_TABLE               
              SET    BANKCOST = @@BANKCOST                                                              
              WHERE  BANK_CODE = @@BANK_CODE                                                              
        END                                                              
          ELSE                                                              
            BEGIN                                                              
              UPDATE #RECPAY_TABLE                                                              
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                              
                                 FROM   COSTMAST WITH(NOLOCK)                               
                                 WHERE  COSTNAME = 'HO')                                                              
              WHERE  COSTCODE = ''                                        
                     AND BANK_CODE = @@BANK_CODE                                            
                                                                            
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                                          
                                                          COUNT(DISTINCT COSTCODE)                                                              
                                                 FROM     #RECPAY_TABLE                                                               
         WHERE    BANK_CODE = @@BANK_CODE                                                              
                                                 GROUP BY SNO                                                              
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                             
                                           
              OPEN @@COSTCODEUPDATES                                                              
                                                                            
              FETCH NEXT FROM @@COSTCODEUPDATES                                                              
              INTO @@SERIAL_NO,                                                              
                @@COSTCODECOUNT                                                              
                                                 
              WHILE @@FETCH_STATUS = 0                                                              
                BEGIN                                                              
                  UPDATE #RECPAY_TABLE                                                              
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                                                              
                            FROM   COSTMAST WITH(NOLOCK)                                                              
                                     WHERE  COSTNAME = 'HO')                                                              
                WHERE  (BANKCOST = ''                                       
                           OR BANKCOST IS NULL)                                                              
                         AND BANK_CODE = @@BANK_CODE                                               
                         AND SNO = @@SERIAL_NO                                                              
                                                                                
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                              
                  INTO @@SERIAL_NO,                                                              
         @@COSTCODECOUNT                                        
               END                                                              
                                                                            
              CLOSE @@COSTCODEUPDATES                    
                                       
              DEALLOCATE @@COSTCODEUPDATES                                                                                                          
              UPDATE #RECPAY_TABLE                                                              
              SET    BANKCOST = COSTCODE                                                              
              WHERE  BANK_CODE = @@BANK_CODE                                                              
                     AND (BANKCOST = ''                                                              
           OR BANKCOST IS NULL)                                                             
END                                                              
        END           
                          
      CREATE TABLE #BANK_VNO (                                                              
        SRNO    INT,                                                              
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                              
                                                                    
      INSERT INTO #BANK_VNO                                                              
      SELECT DISTINCT SNO                                                              
      FROM   #RECPAY_TABLE                                         
      WHERE  BANK_CODE = @@BANK_CODE                                                              
             AND BOOKTYPE = @@BOOKTYPE                                                              
                  
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                              
      FROM   #RECPAY_TABLE                                                              
                                                                           
      SELECT TOP 1 @@VDT = VDT                                                 
      FROM   #RECPAY_TABLE                                                              
                                                                    
      SELECT LASTVNO                                                              
      INTO   #VNO                                                              
      FROM   LASTVNO WITH(NOLOCK)                                                              
      WHERE  1 = 2                                                              
                                    SELECT @@MAXVNO = MAX(NEWSRNO)           
      FROM   #BANK_VNO                                                              
                                                             
                                                            
                                           
                                                
      INSERT INTO #VNO                                                              
      EXEC ACC_GENVNO_NEW                                                              
        @@VDT ,                                                              
    @@VTYP ,                                                              
 @@BOOKTYPE ,                                                              
       @@STD_DATE ,        
        @@LST_DATE ,                                                              
        @@MAXVNO                                                              
                                                                    
      SELECT @@NEWVNO = LASTVNO                                                              
      FROM   #VNO                                                          
                                                                    
      UPDATE RP                                                              
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                              
      FROM   #RECPAY_TABLE RP,                                                              
             #BANK_VNO BV      
      WHERE  RP.SNO = BV.SRNO                                                              
                                                                    
                                                 
                                                
      DROP TABLE #VNO                  
                                                                    
      DROP TABLE #BANK_VNO                                                              
                                                                    
      FETCH NEXT FROM @@VNOCUR                                         
      INTO @@BANK_CODE,                                                              
           @@BOOKTYPE                             
    END          
        
                                                     
                                                                
  /*   ----------AUTO GENERATION OF LNO -------- */                                                              
  UPDATE #RECPAY_TABLE                                                              
 SET    LNO = 2                                                              
  WHERE  VNO IN (SELECT   VNO                                                              
                 FROM     #RECPAY_TABLE                                                               
                 GROUP BY VNO                                                              
                 HAVING   COUNT(*) = 1)                                                              
                                                  
                                                
                                                
                                                              
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                   
                            FROM     #RECPAY_TABLE                                                               
                            GROUP BY VNO                                                              
                            HAVING   COUNT(*) > 1                                                       
                                                     
  OPEN @@LNOCUR                                                              
                                                                
  FETCH NEXT FROM @@LNOCUR                                                              
  INTO @@LNOVNO                                                              
                                                                
  WHILE @@FETCH_STATUS = 0                                                              
    BEGIN                                                              
      CREATE TABLE [#LNOGEN] (                                                              
        VNO VARCHAR(12),                                   
        SNO INT,                                                              
        LNO INT   IDENTITY ( 1,1 ))                                                              
                                                                    
      INSERT INTO #LNOGEN                      
      SELECT   VNO, SNO                                                              
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                          
      WHERE    VNO = @@LNOVNO                                                              
  ORDER BY SNO                                                              
                                                                    
      UPDATE #RECPAY_TABLE                                                              
      SET    LNO = L.LNO + 1                                                          
      FROM   #LNOGEN L                                                     
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                              
             AND #RECPAY_TABLE.SNO = L.SNO                                                              
             AND #RECPAY_TABLE.LNO = 0                                                            
                                                                    
      DROP TABLE #LNOGEN                                                              
                                                                    
      FETCH NEXT FROM @@LNOCUR                                                              
      INTO @@LNOVNO                                                              
    END                 
                        
  CLOSE @@LNOCUR                                                              
                                                                
  DEALLOCATE @@LNOCUR                                                              
                                                                
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                        
  INSERT INTO LEDGER1                                                              
        (BNKNAME,                                                              
              BRNNAME,                                                              
              DD,                                                              
     DDNO,                                                              
              DDDT,                                                              
              RELDT,                                                              
              RELAMT,                                                              
              REFNO,                                                              
              RECEIPTNO,                                   
   VTYP,                                                              
              VNO,                                                              
              LNO,                                             
     DRCR,                                                              
              BOOKTYPE,                                                              
              MICRNO,                                                              
              SLIPNO,                                                              
              SLIPDATE,                                                              
              CHEQUEINNAME,                                                              
              CHQPRINTED,                                                              
              CLEAR_MODE)                                                              
  SELECT   BNKNAME = MAX(BANK_NAME),                                                              
           BRNNAME = MAX(BRANCH_NAME),                                                              
           DD = MAX(CHQ_MODE),                                                              
           DDNO = MAX(REF_NO),                                                              
           DDDT = MAX(DDDT),                                                            
           RELDT = '',                                                 
           RELAMT = SUM(AMOUNT),                                                     
           REFNO = 0,                                                              
           RECEIPTNO = 0,                                                              
    VTYP,                                                              
           VNO,                                                              
           LNO = 2,                                                              
           DRCR,                                                              
           BOOKTYPE = BOOKTYPE,                                                             
           MICRNO = MICRNO,                                                              
           SLIPNO = 0,                                                              
           SLIPDATE = '',                                                              
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                         
           CHQPRINTED = 0,                                               CLEAR_MODE = MAX(CL_MODE)                                                              
  FROM     #RECPAY_TABLE                                                              
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                              
           MICRNO                                                              
                                                                 
  IF @@ERROR <> 0                                                              
    BEGIN                                                                
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                                     
   EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                                      
    END                                                              
                                                                
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                                
  CREATE TABLE #LEDGER (                                                              
    VTYP      SMALLINT,                                                              
    VNO       VARCHAR(12),                                                              
    EDT       DATETIME,                                                              
    LNO       SMALLINT,                                                            
    ACNAME    VARCHAR(100),                                                              
    DRCR      VARCHAR(1),                                                              
    VAMT      MONEY,                                                              
    VDT       DATETIME,                               
    VNO1      VARCHAR(12),                                                              
    REFNO     CHAR(12),                                                              
    BALAMT    MONEY,                                                 
    NODAYS    INT,                                                              
    CDT       DATETIME,                                                              
    CLTCODE   VARCHAR(10),                                                              
    BOOKTYPE  VARCHAR(2),                                                              
    ENTEREDBY VARCHAR(25),                                                              
    PDT       DATETIME,                             
    CHECKEDBY VARCHAR(25),                                                              
    ACTNODAYS INT,                                                              
    NARRATION VARCHAR(234))                                                                  
            
  CREATE TABLE #LEDGER3 (                                                              
    NARATNO  INT,                                                              
    NARR     VARCHAR(234),                                                              
    REFNO    CHAR(12),                                       
    VTYP     SMALLINT,                                                              
    VNO      VARCHAR(12),                                                              
    BOOKTYPE VARCHAR(2))            
            
                                                         
    --PRINT 'SURESH'                                                            
/*======CLIENT SIDE RECORD======*/                                                              
  INSERT INTO #LEDGER                                        
             (VTYP,                                                              
              VNO,                                                             
              EDT,                                    
              LNO,                                                              
              ACNAME,                                                              
              DRCR,                                                             
      VAMT,                        
              VDT,                                             
              VNO1,                                                              
              REFNO,                                                              
              BALAMT,                                                              
              NODAYS,                                                              
              CDT,                                                              
      CLTCODE,                                                              
              BOOKTYPE,                                                              
              ENTEREDBY,                                                  
              PDT,                                                              
              CHECKEDBY,                                                              
              ACTNODAYS,                                                              
              NARRATION)                                                   
  SELECT VTYP,                                                              
         VNO,                                                              
         EDT = (CASE                                                               
                  WHEN VTYP = 2                                                              
   AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                              
                  ELSE EDT                                                              
                END),                                           
         LNO,                                                              
         ACNAME,                                                              
     DRCR,                                                              
         VAMT = AMOUNT,                                                        
         VDT,                                                              
         VNO1 = VNO,                                                              
         REFNO = 0,                                                              
         BALAMT = AMOUNT,                                                              
         NODAYS = 0,                                                              
         CDT = GETDATE(),                                      
         CLTCODE = CLIENT_CODE,                                                              
         BOOKTYPE = BOOKTYPE,                                                              
         ENTEREDBY = ENTEREDBY,                                                              
         PDT = GETDATE(),                                                              
         CHECKEDBY = @UNAME,                                                              
         ACTNODAYS = 0,                                                              
         NARRATION                                                              
  FROM   #RECPAY_TABLE              
            
        
        
        
        
                                                                
/*======BANK SIDE RECORD======*/                                                              
  INSERT INTO #LEDGER                                                              
  SELECT   VTYP,                                                              
           VNO,                                                              
           EDT = (CASE        
                    WHEN VTYP = 2                                                              
       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                              
                    ELSE EDT                                                          
                  END),                                                              
           LNO = 1,                                                              
           BANKNAME,                                                              
           DRCR = (CASE                                                               
                     WHEN DRCR = 'D' THEN 'C'                                                              
                     ELSE 'D'                                                  
                   END),             
           VAMT = SUM(AMOUNT),                                                              
           VDT,                                                              
           VNO1 = VNO,                                                              
           REFNO = 0,                                                              
           BALAMT = SUM(AMOUNT),                                                              
NODAYS = 0,                                                              
CDT = GETDATE(),                                                              
           CLTCODE = BANK_CODE,                                                              
           BOOKTYPE = BOOKTYPE,                                                              
           ENTEREDBY = ENTEREDBY,                                                              
           PDT = GETDATE(),                                                              
CHECKEDBY = @UNAME,                                              
           ACTNODAYS = 0,                                                              
 NARRATION = MAX(NARRATION)                                        
  FROM     #RECPAY_TABLE                                                              
  GROUP BY VTYP,VNO,EDT,DRCR,                                                              
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                              
           ENTEREDBY               
--PRINT 'NIKHIL'            
                              
                                                                
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                              
  INSERT INTO LEDGER                                         
             (VTYP,                                                              
              VNO,                                                              
              EDT,                                             
              LNO,                                                              
              ACNAME,                                                              
              DRCR,                                                              
              VAMT,                                                              
              VDT,                                                              
              VNO1,                                                              
              REFNO,                                                             
              BALAMT,                                                            
          NODAYS,                                                              
              CDT,                                                              
              CLTCODE,                                                              
              BOOKTYPE,                     
              ENTEREDBY,                                                              
              PDT,                                                              
              CHECKEDBY,                   
              ACTNODAYS,                
 NARRATION)                                                              
  SELECT   VTYP,                                                              
           VNO,                                                              
       EDT,                                                              
           LNO,                                                              
           ACNAME,                                                              
           DRCR,                                                              
           VAMT,                                                              
           VDT,                                                              
           VNO1,                                                              
           REFNO,                                                              
           BALAMT,                        
           NODAYS,                                                              
           CDT,                                                              
           CLTCODE,                                             
           BOOKTYPE,                          
           ENTEREDBY,                                                              
           PDT,                                                              
           CHECKEDBY,          
           ACTNODAYS,                                                              
           NARRATION                                                              
  FROM     #LEDGER                                                              
  ORDER BY BOOKTYPE,                                 
           VTYP,                                                              
           VNO,                                                              
           LNO              
            
PRINT 'ANI'                                                            
                                                                         
  IF @@ERROR <> 0                                                              
    BEGIN                                                              
    DROP TABLE #LEDGER                                                              
    DROP TABLE #LEDGER3                                                                  
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                             
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                                 
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                               
    RETURN                                               
    END                                                              
                                                                
  DROP TABLE #LEDGER                                                              
                                      
/*======BANK SIDE RECORD======*/                                                              
  INSERT INTO #LEDGER3                                                              
  SELECT   NARATNO = 1,                                                              
           NARRATION = MAX(NARRATION),                                                              
           REFNO = 0,                                                              
           VTYP,                                                              
           VNO,                                                              
           BOOKTYPE                                                              
  FROM     #RECPAY_TABLE                                                
  GROUP BY VTYP,VNO,BOOKTYPE                                                       
                                                                
/*======CLIENT SIDE RECORD======*/                                              
  INSERT INTO #LEDGER3                                                              
  SELECT NARATNO = LNO,                                                              
         NARR = NARRATION,                                                    
         REFNO = 0,                                                              
         VTYP,                                                              
VNO,                                                              
         BOOKTYPE                                                              
  FROM   #RECPAY_TABLE                                                              
                                                                       
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                              
  INSERT INTO LEDGER3                                                              
  SELECT   *                                                              
  FROM     #LEDGER3                                                              
  ORDER BY BOOKTYPE,                                                              
    VTYP,                                                              
           VNO,                                                              
           NARATNO                                                              
                                                                         
  IF @@ERROR <> 0                                                          
    BEGIN                 
    DROP TABLE #LEDGER3                                                                  
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                                     
    END                                                                                                        
  DROP TABLE #LEDGER3                                                              
                                                                
  IF @@BRANCHFLAG = 1                                                              
    BEGIN                                                              
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                              
              FROM     #RECPAY_TABLE                                                              
         ORDER BY VNO                                                              
                                               
      OPEN @@L2CUR                                                              
                                                                    
      FETCH NEXT FROM @@L2CUR                                                              
      INTO @@L2VNO                 
                                                                  
      WHILE @@FETCH_STATUS = 0                                                    BEGIN                                                              
          DELETE FROM TEMPLEDGER2                                                              
          WHERE       SESSIONID = '9999999999'                                                              
                                                                        
/*======CLIENT SIDE RECORD======*/                                                              
          INSERT INTO TEMPLEDGER2                                                              
          SELECT 'BRANCH',                                                              
                 C.COSTNAME,                                           
                 AMOUNT,                                                              
                 VTYP,                                                              
                 VNO,                                           
                 LNO,                                                              
                 DRCR,                                                              
                 '0',                           
    BOOKTYPE,                                                              
                 '9999999999',                                                              
                 CLIENT_CODE,                                                              
'A',                                                              
                 '0'                                                              
          FROM   #RECPAY_TABLE RP,                                                              
                 COSTMAST C WITH(NOLOCK)                                                               
          WHERE  RP.COSTCODE = C.COSTCODE                                                              
                 AND VNO = @@L2VNO                                                              
                                                     
/*======BANK SIDE RECORD======*/                                                              
          INSERT INTO TEMPLEDGER2                                                              
          SELECT   'BRANCH',                                                              
                   C.COSTNAME,                                                              
                   SUM(AMOUNT),                                                              
                   VTYP,                                                              
           VNO,                                                          
                   LNO = 1,                                                              
                   DRCR = (CASE                                                               
                             WHEN DRCR = 'D' THEN 'C'                                                              
                       ELSE 'D'                                                              
                           END),                                                              
                   '0',                                                              
                   BOOKTYPE,                                  
                   '9999999999',                                                              
                   BANK_CODE,                                                              
                   'A',                                                              
                   '0'                                                              
          FROM     #RECPAY_TABLE RP,                                                              
                   COSTMAST C WITH(NOLOCK)                                
          WHERE    RP.BANKCOST = C.COSTCODE                                                              
    AND VNO = @@L2VNO                                            
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                                                               
                   WHEN DRCR = 'D' THEN 'C'                                                              
                      ELSE 'D'                                                              
                    END),                                                              
      BANK_CODE,BOOKTYPE                                                              
                                                                        
          EXEC INSERTTOLEDGER2                                                              
            '9999999999' ,                                                              
            @@L2VNO ,                                              
            '1' ,                                                              
       '1' ,                                                              
            '1' ,                                                              
            'BROKER' ,                                                              
            'BROKER'                                                              
                            
 FETCH NEXT FROM @@L2CUR                                                              
          INTO @@L2VNO                                                              
        END                                    
                                                                    
     DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                              
      WHERE       SESSIONID = '9999999999'                                                              
                                
      IF EXISTS (SELECT *                                                              
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                               
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                              
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                         
         AND @@VTYP = 2                                                              
        BEGIN                                                              
          INSERT INTO THIRDPARTY_COLLECTION                                        
(VNO,                                                              
                      VTYP,                                                              
                      BOOKTYPE,                                                              
                      CLTCODE,                                                              
                      AMOUNT,                                                              
                      VDT,                           
                      DDNO,                               
 ACCOUNT_NO,                                                              
                      TPR_FLAG)                                                              
          SELECT   VNO,                                                              
                   VTYP,                          
                   BOOKTYPE,                                                              
                   CLIENT_CODE,                                                              
                   AMOUNT,                                                              
                   VDT,                                 
                   MAX(REF_NO),                                                              
                   ACC_NO,                                                              
                   TPR_FLAG = 'S'                                 
          FROM     #RECPAY_TABLE                                                              
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,         
                   AMOUNT,VDT,ACC_NO                                                              
                                                                                 
          UPDATE T                                                              
          SET    TPR_FLAG = 'C'                                                              
          FROM                                         
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                              
                 MULTIBANKID M WITH(NOLOCK),                                                              
                 #RECPAY_TABLE R                                                              
          WHERE  T.CLTCODE = M.CLTCODE                                                              
                 AND M.ACCNO = T.ACCOUNT_NO                                                              
                 AND T.VNO = R.VNO                                                   
                 AND T.VTYP = R.VTYP                                                              
                 AND T.BOOKTYPE = R.BOOKTYPE                                                              
        END                                                              
                                                                
   COMMIT TRANSACTION                                                              
 END                                                              
                                             
UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES --WITH(ROWLOCK)                            
SET                                                        
 ROWSTATE = 1,                                                            
 APPROVALFLAG = 1,                           
 APPROVALDATE = GETDATE(),                                                            
-- APPROVEDBY = 'SYSTEM',                                                            
 LEDGERVNO = VNO                                                              
FROM   #RECPAY_TABLE                                              
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                              
                                                                    
                                             
DROP TABLE #RECPAY_TABLE                                         
SET @ERRORCODE = 0                                                                       
SET @MESSAGE = 'POSTED SUCCESSFULLY'            
EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                       
                                      
                                      
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_25052011
-- --------------------------------------------------
            
CREATE PROC [DBO].[V2_OFFLINE_RECPAYUPLOAD_25052011](                                                      
                                                      
           @UNAME     VARCHAR(25),                                                      
           @USERCAT   INT,                                                      
           @EXCHANGE  VARCHAR(3),                                                      
           @SEGMENT   VARCHAR(10),                                                      
     @IP_VDATE varchar(11),                                    
           @RECOFLAG  CHAR(1) = 'N')                                                      
                                                      
AS                                                      
                              
SET XACT_ABORT ON                                                      
/*                                                    
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                                   
*/                                                    
                                                    
                                                    
  SET NOCOUNT ON                                                      
                                                        
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                      
  DECLARE  @@STD_DATE        VARCHAR(11),                                                      
           @@LST_DATE        VARCHAR(11),                                                      
           @@BRANCHFLAG       AS TINYINT,                                                      
           @@VNOFLAG          AS TINYINT,                                                      
           @@VNOMETHOD       INT,                                                      
           @@ACNAME          CHAR(100),                                                      
           @@BOOKTYPE        CHAR(2),                                                      
           @@MICRNO          VARCHAR(10),                                                      
           @@DRCR            VARCHAR(1),                                                      
           @@VTYP            SMALLINT,                                                      
           @@BANK_CODE       VARCHAR(100),                                                      
           @@BACKDAYS        INT,                                                      
           @@BACKDATE        VARCHAR(11),                                                      
           @@BRNCOUNT        TINYINT,                                                      
           @@MonthlyVdt      VARCHAR(11),                                                      
           @@SERIAL_NO       INT,                                                      
           @@COSTCODECOUNT   TINYINT,                                                      
           @@COSTCODEUPDATES CURSOR,                                                      
           @@NEWVNO           AS VARCHAR(12),                                                      
           @@MAXCOUNT         AS INT,                                                      
           @@VDT              AS VARCHAR(11),                                                      
           @@BANKBRANCH       AS VARCHAR(10),                                                      
           @@BANKCOST         AS NUMERIC,                                                      
           @@LNOCUR           AS CURSOR,                                                      
           @@VNOCUR           AS CURSOR,                                                      
           @@LNOVNO           AS VARCHAR(12),                                                      
           @@MAXVNO           AS INT,                                                      
           @@L2CUR            AS CURSOR,                                                      
           @@L2VNO            AS VARCHAR(12),                                                      
           @@ERROR_COUNT      AS BIGINT,                                                      
           @@FILEEXISTS       AS INT,                                           
           @@SQL              AS VARCHAR(2000),                                  
           @ERRORCODE         AS INT,                                                      
           @MESSAGE           AS VARCHAR(200) ,                                              
   @@RECPAYTBLCOUNT BIGINT                                              
                                                                           
                                    
 SET @@VTYP = 2                                                    
                                                    
BEGIN TRAN                                                      
                                                      
  CREATE TABLE [#RECPAY_TABLE] (                                                   
    SNO    INT   IDENTITY ( 1,1 ),                                                      
    EDATE        VARCHAR(20),                                                      
    VOUCHER_DATE VARCHAR(20),                                                      
    CLIENT_CODE  VARCHAR(50),                                                      
    AMOUNT       MONEY,                                                      
    DRCR         VARCHAR(1),                                     
    NARRATION    VARCHAR(234),                                                      
    BANK_CODE    VARCHAR(10),                                                      
  BANK_NAME    VARCHAR(100),                                                      
    REF_NO       VARCHAR(15),                                                      
    BRANCHCODE   VARCHAR(20),                                                      
    BRANCH_NAME  VARCHAR(50),                                                      
    CHQ_MODE     VARCHAR(1),                                                      
    CHQ_DATE     VARCHAR(20),                                                 
    CHQ_NAME     VARCHAR(100),                                                      
    CL_MODE      VARCHAR(1),                                                      
    FLD_AUTO     BIGINT,                                               
    ENTEREDBY    VARCHAR(25),                                                      
    VDT          DATETIME   NULL,                                                      
    FYSTART      DATETIME   NULL,                                                
    FYEND        DATETIME   NULL,                                                      
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                      
    EDT          DATETIME   NULL,                                                      
    DDDT         DATETIME   NULL,                                                      
    VNO          VARCHAR(12)   NULL,                                                      
    VTYP         SMALLINT   NULL,                                                      
    ACNAME       VARCHAR(100)   NULL,                                                      
    COSTCODE     SMALLINT   NULL,                                                      
    BANKCOST     SMALLINT   NULL,                                                      
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                      
    BANKNAME     VARCHAR(100)   NULL,                                                      
    MICRNO       INT   NULL,                                                      
    BOOKTYPE     VARCHAR(2)   NULL,                                                      
    ACC_NO       VARCHAR(16))                                                      
  ON [PRIMARY]                                                      
                                                        
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                                      
  INSERT INTO #RECPAY_TABLE                                                      
             (EDATE,                   
              VOUCHER_DATE,                                                      
              CLIENT_CODE,                                                      
              AMOUNT,                                              
              DRCR,                                                      
              NARRATION,                                                      
              BANK_CODE,                                                      
              BANK_NAME,                                                      
              REF_NO,                                                      
              BRANCHCODE,                                                   
              BRANCH_NAME,                                                      
              CHQ_MODE,                                                      
              CHQ_DATE,                             
              CHQ_NAME,                                                      
              CL_MODE,                                                      
              FLD_AUTO,                                                      
        ENTEREDBY,                                                      
              VDT,                                                       
              EDT,                                                       
              DDDT,                                                      
              ACC_NO,VTYP)                                                      
  SELECT CONVERT(VARCHAR,EDATE,103),                                                      
         CONVERT(VARCHAR,VDATE,103),                                                      
         CLTCODE,                                         
         CREDITAMT,                                                      
         'C',                                                      
         NARRATION,                                                      
         OPPCODE,                                                      
         BANKNAME,                                                   
         DDNO,                                                      
         'ALL',                                                      
         BRANCHNAME,                                                      
         CHEQUEMODE,                                                      
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                      
         CHEQUENAME,                                                      
         CLEAR_MODE,                                                      
         FLDAUTO,                                                      
         ADDBY,                                                       
         VDATE,                                                       
         EDATE,                                                       
         CHEQUEDATE,                                                       
         TPAccountNumber, VOUCHERTYPE                                                      
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                           
  WHERE  VOUCHERTYPE = 2                                                      
         AND EXCHANGE = @EXCHANGE                                                      
         AND SEGMENT = @SEGMENT                                                      
         AND ISNULL(ROWSTATE,0) = 0                                 
   AND ISNULL(APPROVALFLAG,0) = 1                                                
   AND VDATE LIKE @IP_VDATE + '%'                          
                                                      
                                                  
                                                
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                              
                
 IF @@RECPAYTBLCOUNT = 0                                              
 BEGIN                                              
  COMMIT                                              
  RETURN                                              
 END        
                                       
                                        
                                     
--TRUNCATE table #RECPAY_TABLE                                        
--return                                              
                                        
                                           
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES  --WITH (ROWLOCK)                                                       
  SET    ROWSTATE = 9                                                      
  FROM   #RECPAY_TABLE                                                      
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                             
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                      
  FROM   #RECPAY_TABLE                                                      
                                                               
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                      
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                      
         @@BRANCHFLAG = BRANCHFLAG,                                                      
         @@VNOFLAG = VNOFLAG                                                      
  FROM   PARAMETER WITH(NOLOCK)                
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                      
                                                                                        
  IF @@VNOFLAG <> 0                                                      
    BEGIN                                                      
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                                  
      FROM   #RECPAY_TABLE                                                      
                                                                   
      IF @@ERROR_COUNT > 1                                                      
        BEGIN                                                      
     DROP TABLE #RECPAY_TABLE                                                                  
     ROLLBACK TRANSACTION                                             
     SET @ERRORCODE = 1                                                                
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                      
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                               
     RETURN                                       
        END                                                      
    END                                                      
                                                      
  IF @@BRANCHFLAG = 1                                                      
    BEGIN                                                      
      UPDATE #RECPAY_TABLE                                                      
      SET    BRANCHCODE = A.BRANCHCODE,                                                      
             FYSTART = P.SDTCUR,                                                      
           FYEND = P.LDTCUR,                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             COSTCODE = C.COSTCODE,                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                                                      
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                               
             PARAMETER P WITH(NOLOCK),                                                      
            COSTMAST C WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE  A.CLTCODE = CLIENT_CODE                                     
             AND B.CLTCODE = BANK_CODE                               
             --AND P.CURYEAR = 1                             
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                     
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                       
             AND A.BRANCHCODE = COSTNAME                                  
                                                                                      
      UPDATE #RECPAY_TABLE                                                      
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                      
             FYSTART = P.SDTCUR,                                                      
             FYEND = P.LDTCUR,                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             COSTCODE = (SELECT TOP 1 COSTCODE                                                      
                         FROM   COSTMAST                                                      
                       WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                                                      
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                                                      
       PARAMETER P WITH(NOLOCK),                                                      
             COSTMAST C WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE  A.CLTCODE = CLIENT_CODE                                            
             AND B.CLTCODE = BANK_CODE                                                      
             --AND P.CURYEAR = 1                             
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                 
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                                      
             AND A.BRANCHCODE = 'ALL'                                                      
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                      
                                                                                                   
      UPDATE #RECPAY_TABLE    
      SET    BRANCHCODE = 'HO',                                                      
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                          
             FYSTART = P.SDTCUR,                                                      
             FYEND = P.LDTCUR,                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             COSTCODE = (SELECT TOP 1 COSTCODE                                                      
                         FROM   COSTMAST                                                      
             WHERE  COSTNAME = 'HO'),                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                       
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                                                      
       PARAMETER P WITH(NOLOCK),                                                      
             COSTMAST C WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE  A.CLTCODE = CLIENT_CODE                                  
             AND B.CLTCODE = BANK_CODE                                                      
             --AND P.CURYEAR = 1                             
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                     
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                                      
             AND A.BRANCHCODE = 'ALL'                                                      
         AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                      
    END                                                      
  ELSE                                                 
    BEGIN                                                      
      UPDATE #RECPAY_TABLE                                                      
      SET    FYSTART = @@STD_DATE,                                                      
             FYEND = @@LST_DATE + ' 23:59:59',                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                                                      
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE A.CLTCODE = CLIENT_CODE                                                  
             AND B.CLTCODE = BANK_CODE                                                      
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                                      
    END                                                      
                                 
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                      
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                      
  FROM   #RECPAY_TABLE                                                      
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                      
                                                      
  IF @@ERROR_COUNT > 0                                                
  BEGIN                                                   
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                                   
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                           
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                                      
    END                                                      
                                                          
  SET @@ERROR_COUNT = 0                                                      
                                                        
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                          
  FROM   #RECPAY_TABLE                                        
  WHERE  VDT > EDT                                                      
                                                        
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                    
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                               
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                             
    END                                                      
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                                      
  FROM   #RECPAY_TABLE                                                      
  WHERE  AMOUNT <= 0                       
                                                        
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                       
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                             
    RETURN                                             
    END                                                      
                                                        
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                                      
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                  
                          CLTCODE = RP.CLIENT_CODE                                                      
   FROM   #RECPAY_TABLE RP,                              
                 LEDGER L WITH(NOLOCK),                                                      
     LEDGER1 L1 WITH(NOLOCK)                                                      
          WHERE  L1.DDNO = RP.REF_NO                                                      
                 AND L1.DD = RP.CHQ_MODE                                                      
                 AND L1.DRCR = @@DRCR        
                 AND L1.VTYP = @@VTYP                                                      
                 AND RP.REF_NO <> 0                                                      
                 AND L.VTYP = @@VTYP                                                      
                 AND L.VNO = L1.VNO                                                      
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                      
    AND L.DRCR = @@DRCR                                                      
                 AND L.CLTCODE = RP.CLIENT_CODE) A                                         
                                                        
  IF @@ERROR_COUNT > 0                                  
    BEGIN                                                      
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                            
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                             
    END                                                      
                                                        
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                                      
  FROM   (SELECT DISTINCT CLIENT_CODE                                                      
          FROM   #RECPAY_TABLE                                                      
          WHERE  UPDFLAG = 'N') A                                                      
                                                        
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                      
    DROP TABLE #RECPAY_TABLE                           
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                                 
    END                                                      
                      
  /*    ----------AUTO GENERATION OF VNO -------- */                                                      
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                      
         BOOKTYPE                                                      
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                      
                                                        
  OPEN @@VNOCUR                                                      
                                                        
  FETCH NEXT FROM @@VNOCUR                                               
  INTO @@BANK_CODE,                                                      
       @@BOOKTYPE                              
                                                        
  WHILE @@FETCH_STATUS = 0                                                      
    BEGIN                                                      
      IF @@BRANCHFLAG = 1                                                      
        BEGIN                                                      
          SELECT @@BANKBRANCH = BRANCHCODE,                                                      
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)     
          FROM   ACMAST A WITH(NOLOCK)                               
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                                      
                   ON (A.BRANCHCODE = C.COSTNAME)                                                      
          WHERE  A.CLTCODE = @@BANK_CODE                                                      
                                                                
          IF @@BANKBRANCH <> 'ALL'                                                      
            BEGIN                                                      
              UPDATE RP                                                      
              SET    COSTCODE = @@BANKCOST                                                      
              FROM   #RECPAY_TABLE RP,                                                      
                     ACMAST A WITH(NOLOCK)                                                      
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                      
                     AND A.BRANCHCODE = 'ALL'                                                      
                                                                    
              UPDATE #RECPAY_TABLE                                                      
              SET    BANKCOST = @@BANKCOST                                                      
              WHERE  BANK_CODE = @@BANK_CODE                         
            END                                                      
          ELSE                                                      
            BEGIN                                                      
              UPDATE #RECPAY_TABLE                                                      
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                      
                                 FROM   COSTMAST WITH(NOLOCK)                                                      
                                 WHERE  COSTNAME = 'HO')                                                      
              WHERE  COSTCODE = ''                                                      
                    AND BANK_CODE = @@BANK_CODE                                                      
                                                             
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                                  
                                                          COUNT(DISTINCT COSTCODE)                                                      
                                                 FROM     #RECPAY_TABLE                                                       
                                                 WHERE    BANK_CODE = @@BANK_CODE                                                      
                                                 GROUP BY SNO                                                      
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                                                                         
              OPEN @@COSTCODEUPDATES                                                      
                                                                    
              FETCH NEXT FROM @@COSTCODEUPDATES                                                      
              INTO @@SERIAL_NO,                                                      
                   @@COSTCODECOUNT                                                      
                                                      
              WHILE @@FETCH_STATUS = 0                                                      
                BEGIN                                                      
                  UPDATE #RECPAY_TABLE                                                      
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                           
                                  FROM   COSTMAST WITH(NOLOCK)                      
                                     WHERE  COSTNAME = 'HO')                            
                  WHERE  (BANKCOST = ''                                                      
                           OR BANKCOST IS NULL)                                                      
                         AND BANK_CODE = @@BANK_CODE                                                      
                         AND SNO = @@SERIAL_NO                                                      
                                                                        
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                      
                  INTO @@SERIAL_NO,                                                      
         @@COSTCODECOUNT                                                      
           END                    
                                                                    
              CLOSE @@COSTCODEUPDATES                                                      
                                                                    
              DEALLOCATE @@COSTCODEUPDATES                                                                                                  
              UPDATE #RECPAY_TABLE                                                      
              SET    BANKCOST = COSTCODE                                                      
              WHERE  BANK_CODE = @@BANK_CODE                                                      
                     AND (BANKCOST = ''                   
                           OR BANKCOST IS NULL)                                                     
END                                                      
        END                                                      
                   
      CREATE TABLE #BANK_VNO (                                                      
        SRNO    INT,                                                      
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                      
                                                            
      INSERT INTO #BANK_VNO                                                      
      SELECT DISTINCT SNO                                                      
      FROM   #RECPAY_TABLE                                 
      WHERE  BANK_CODE = @@BANK_CODE                                                      
             AND BOOKTYPE = @@BOOKTYPE                
                                                                                  
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                      
      FROM   #RECPAY_TABLE                                                      
                                                                   
      SELECT TOP 1 @@VDT = VDT                                                      
FROM   #RECPAY_TABLE                                                      
                                                            
      SELECT LASTVNO                                                      
      INTO   #VNO                                                      
      FROM   LASTVNO WITH(NOLOCK)                                                            WHERE  1 = 2                                                      
                                                            
      SELECT @@MAXVNO = MAX(NEWSRNO)                                    
      FROM   #BANK_VNO                                                      
                                                     
                                                    
                                        
                                        
      INSERT INTO #VNO                                                      
      EXEC ACC_GENVNO_NEW                                                      
        @@VDT ,                                                      
    @@VTYP ,                                                      
 @@BOOKTYPE ,                                                      
    @@STD_DATE ,                                   
        @@LST_DATE ,                                                      
        @@MAXVNO                                                      
                                                            
      SELECT @@NEWVNO = LASTVNO                                                      
      FROM   #VNO                                    
                                                            
      UPDATE RP                                                      
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                      
      FROM   #RECPAY_TABLE RP,                                                      
             #BANK_VNO BV                                                      
      WHERE  RP.SNO = BV.SRNO                             
                                                            
                                         
                         
      DROP TABLE #VNO                                                      
                                                            
      DROP TABLE #BANK_VNO                                                      
                                                            
      FETCH NEXT FROM @@VNOCUR                                        
      INTO @@BANK_CODE,                                                      
           @@BOOKTYPE                  
    END                                                 
                                                        
  /*   ----------AUTO GENERATION OF LNO -------- */                                                      
  UPDATE #RECPAY_TABLE                                                      
 SET    LNO = 2                          
  WHERE  VNO IN (SELECT   VNO                                                      
                 FROM     #RECPAY_TABLE                                                       
                 GROUP BY VNO                                                      
                 HAVING   COUNT(*) = 1)                                                      
                                          
                                        
                                        
                                                      
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                      
                            FROM     #RECPAY_TABLE                                                       
                            GROUP BY VNO                                                      
                            HAVING   COUNT(*) > 1                                               
                                                        
  OPEN @@LNOCUR                 
                                                        
  FETCH NEXT FROM @@LNOCUR                                                      
  INTO @@LNOVNO                                                      
                                                        
  WHILE @@FETCH_STATUS = 0                                                      
    BEGIN                                 
      CREATE TABLE [#LNOGEN] (                                                      
        VNO VARCHAR(12),                                                      
        SNO INT,                                                      
        LNO INT   IDENTITY ( 1,1 ))                                                      
                                                            
      INSERT INTO #LNOGEN                                                      
      SELECT   VNO, SNO                                                      
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                                      
      WHERE    VNO = @@LNOVNO                           
      ORDER BY SNO                                  
                                                            
      UPDATE #RECPAY_TABLE                                                      
      SET    LNO = L.LNO + 1                                                  
      FROM   #LNOGEN L                                                      
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                      
             AND #RECPAY_TABLE.SNO = L.SNO                                                      
             AND #RECPAY_TABLE.LNO = 0                                                      
                                                            
      DROP TABLE #LNOGEN                                                      
                                                            
      FETCH NEXT FROM @@LNOCUR                                                      
      INTO @@LNOVNO                                                      
    END                                                      
                                                        
  CLOSE @@LNOCUR                                                 
                                      
  DEALLOCATE @@LNOCUR                                                      
           
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                      
  INSERT INTO LEDGER1                                                      
             (BNKNAME,                                                      
              BRNNAME,                                                      
              DD,                                                      
     DDNO,                                                      
              DDDT,                                                      
              RELDT,                                                      
              RELAMT,                                                      
              REFNO,                                                      
              RECEIPTNO,                                                      
   VTYP,                             
              VNO,                                                      
              LNO,                  
     DRCR,                                                      
              BOOKTYPE,                                                      
              MICRNO,                                                      
              SLIPNO,                                                      
              SLIPDATE,                                                      
              CHEQUEINNAME,                                                      
              CHQPRINTED,                                                      
              CLEAR_MODE)                                                      
  SELECT   BNKNAME = MAX(BANK_NAME),                                                      
           BRNNAME = MAX(BRANCH_NAME),                                                      
           DD = MAX(CHQ_MODE),                                                      
           DDNO = MAX(REF_NO),                                                      
           DDDT = MAX(DDDT),                      
           RELDT = '',                                                      
           RELAMT = SUM(AMOUNT),                                                      
           REFNO = 0,                                                      
           RECEIPTNO = 0,                                                      
           VTYP,                                                 
           VNO,                                                      
           LNO = 2,                                                      
           DRCR,                                                      
           BOOKTYPE = BOOKTYPE,                                                     
           MICRNO = MICRNO,                                                      
           SLIPNO = 0,                                                      
           SLIPDATE = '',                                                      
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                      
           CHQPRINTED = 0,                                                      
   CLEAR_MODE = MAX(CL_MODE)                                                      
  FROM     #RECPAY_TABLE                                                      
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                      
           MICRNO                                                      
                                                         
  IF @@ERROR <> 0                                                      
    BEGIN                                                        
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                              
    END                     
                                                          
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                                      
  CREATE TABLE #LEDGER (                                   
    VTYP      SMALLINT,                                                      
    VNO       VARCHAR(12),                                                      
    EDT       DATETIME,                                                      
    LNO       SMALLINT,                                                    
    ACNAME    VARCHAR(100),                                                      
    DRCR      VARCHAR(1),                                                      
    VAMT      MONEY,                                                      
    VDT       DATETIME,                                                      
    VNO1      VARCHAR(12),                                                      
    REFNO     CHAR(12),                                               
    BALAMT    MONEY,                                  
    NODAYS    INT,                                                      
    CDT       DATETIME,                                                      
    CLTCODE   VARCHAR(10),                                                      
    BOOKTYPE  VARCHAR(2),                                                      
    ENTEREDBY VARCHAR(25),                                                      
    PDT       DATETIME,                                                      
    CHECKEDBY VARCHAR(25),                                   
    ACTNODAYS INT,                                                      
    NARRATION VARCHAR(234))                                                          
    
  CREATE TABLE #LEDGER3 (                                                      
    NARATNO  INT,                                                      
    NARR     VARCHAR(234),                                                      
    REFNO    CHAR(12),                                                      
    VTYP     SMALLINT,                                                      
    VNO      VARCHAR(12),                                                   
    BOOKTYPE VARCHAR(2))                                                      
                                                        
/*======CLIENT SIDE RECORD======*/                                                      
  INSERT INTO #LEDGER                                                
             (VTYP,                                                      
              VNO,                                                     
              EDT,                                   
              LNO,                                                      
              ACNAME,                                                      
              DRCR,         
      VAMT,                                                      
              VDT,                                                      
              VNO1,                                                   
              REFNO,                                                      
              BALAMT,                                                      
              NODAYS,                                                      
              CDT,                                                      
              CLTCODE,                                                      
              BOOKTYPE,                                                     
              ENTEREDBY,                                                      
              PDT,                                                      
              CHECKEDBY,                                                      
              ACTNODAYS,                                                      
              NARRATION)                                                      
  SELECT VTYP,                       
         VNO,                                                      
         EDT = (CASE                                                       
                  WHEN VTYP = 2                                                      
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                      
                  ELSE EDT                                                      
                END),                                   
         LNO,                                                      
         ACNAME,                                                      
         DRCR,                              
         VAMT = AMOUNT,                                                      
         VDT,                                                      
         VNO1 = VNO,                                                      
         REFNO = 0,                                                      
         BALAMT = AMOUNT,                                                      
         NODAYS = 0,                                                      
         CDT = GETDATE(),                                                      
         CLTCODE = CLIENT_CODE,                                 
         BOOKTYPE = BOOKTYPE,                                                      
         ENTEREDBY = ENTEREDBY,                                                      
         PDT = GETDATE(),                                                      
         CHECKEDBY = @UNAME,                                                      
         ACTNODAYS = 0,                                                      
         NARRATION                                                      
  FROM   #RECPAY_TABLE          
                                                        
/*======BANK SIDE RECORD======*/                                                      
  INSERT INTO #LEDGER                                                      
  SELECT   VTYP,                                                      
           VNO,                                                      
           EDT = (CASE                                                       
                    WHEN VTYP = 2                                                      
        AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                      
                    ELSE EDT                                                      
                  END),                                                      
           LNO = 1,                                                      
           BANKNAME,                                                      
           DRCR = (CASE                                                       
                     WHEN DRCR = 'D' THEN 'C'                                                      
                     ELSE 'D'                                          
                   END),                                           
           VAMT = SUM(AMOUNT),                                                      
           VDT,                                                      
           VNO1 = VNO,                                                      
           REFNO = 0,                                                      
           BALAMT = SUM(AMOUNT),                                                      
           NODAYS = 0,                                                      
CDT = GETDATE(),                                                      
           CLTCODE = BANK_CODE,                                                      
           BOOKTYPE = BOOKTYPE,                                                      
           ENTEREDBY = ENTEREDBY,                                                      
           PDT = GETDATE(),                                                      
           CHECKEDBY = @UNAME,                                                      
           ACTNODAYS = 0,                         
           NARRATION = MAX(NARRATION)                                       
  FROM     #RECPAY_TABLE                                 
  GROUP BY VTYP,VNO,EDT,DRCR,                                                      
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                      
         ENTEREDBY                                                      
                                                        
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                      
  INSERT INTO LEDGER                                                      
             (VTYP,                                                      
              VNO,                                                      
              EDT,                                                      
              LNO,                                                      
              ACNAME,                                                      
              DRCR,                                                      
              VAMT,                                                      
              VDT,                                                      
              VNO1,                                                      
              REFNO,                                                     
              BALAMT,                                                      
              NODAYS,                         CDT,                                                      
              CLTCODE,                                                      
              BOOKTYPE,                                  
              ENTEREDBY,          
              PDT,                                                      
              CHECKEDBY,                                                      
              ACTNODAYS,                                                      
 NARRATION)                                                      
  SELECT   VTYP,                                                      
           VNO,                                                      
       EDT,                                                      
           LNO,                                                      
           ACNAME,                                                      
           DRCR,                                                      
           VAMT,                                                      
           VDT,                                                      
           VNO1,                                                      
           REFNO,                                                      
           BALAMT,                                                      
           NODAYS,                                                      
           CDT,                                                      
           CLTCODE,                               
           BOOKTYPE,         
           ENTEREDBY,                                                      
           PDT,                                                      
           CHECKEDBY,                                                      
           ACTNODAYS,                                                      
           NARRATION                                                      
  FROM     #LEDGER                                                      
  ORDER BY BOOKTYPE,                                
           VTYP,                                                      
           VNO,                                                      
           LNO                                                      
                                                                 
  IF @@ERROR <> 0                                                      
    BEGIN                                                      
    DROP TABLE #LEDGER                                                      
    DROP TABLE #LEDGER3                                                          
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                       
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                                            
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                             
    END                                                      
                                                        
                                                    
                                                        
/*======BANK SIDE RECORD======*/                                
  INSERT INTO #LEDGER3                                                      
  SELECT   NARATNO = 1,                                                      
           NARRATION = MAX(NARRATION),                                                      
           REFNO = 0,                                                      
           VTYP,                                                      
           VNO,                                                      
           BOOKTYPE                                                      
  FROM     #RECPAY_TABLE                           
  GROUP BY VTYP,VNO,BOOKTYPE                                               
                                                        
/*======CLIENT SIDE RECORD======*/                                                      
  INSERT INTO #LEDGER3                                          
  SELECT NARATNO = LNO,                                                      
         NARR = NARRATION,                                                      
         REFNO = 0,                                                      
         VTYP,                                                      
         VNO,                  
         BOOKTYPE                                                      
  FROM   #RECPAY_TABLE                                                      
                                                               
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                      
  INSERT INTO LEDGER3                                                      
  SELECT   *                                                      
  FROM     #LEDGER3                                                      
  ORDER BY BOOKTYPE,                                                      
    VTYP,                                               VNO,                                                      
           NARATNO                                                      
                                                                 
  IF @@ERROR <> 0                                                      
    BEGIN                                                      
    DROP TABLE #LEDGER3                                                          
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                             
    END                                                      
                                                        
  DROP TABLE #LEDGER3                                                 
   
  
                                                              
  IF @@BRANCHFLAG = 1                                                            
    BEGIN     
  
        
  SELECT * INTO #LEDGER2 FROM LEDGER2 WHERE 1 = 2      
  
  INSERT INTO #LEDGER2      
  SELECT VTYP, VNO, LNO, DRCR, VAMT, COSTCODE, L.BOOKTYPE, L.CLTCODE      
  FROM #LEDGER L, COSTMAST C, ACMAST A WHERE       
  L.CLTCODE = A.CLTCODE AND C.COSTNAME = CASE WHEN UPPER(A.BRANCHCODE) = 'ALL' THEN 'HO' ELSE A.BRANCHCODE END      
  
  INSERT INTO #LEDGER2      
  SELECT VTYPE, VNO, LNO, CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END, CAMT, COSTCODE, BOOKTYPE, 'HOCTRL'      
  FROM #LEDGER2 WHERE COSTCODE IN(SELECT COSTCODE FROM COSTMAST WHERE COSTNAME <> 'HO')      
  
  DECLARE @@COSTCODE INT      
  
  SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'      
  
  INSERT INTO #LEDGER2      
  SELECT VTYPE, VNO, LNO, DRCR, CAMT, @@COSTCODE, BOOKTYPE, BRCONTROLAC      
  FROM #LEDGER2 L2, BRANCHACCOUNTS B, COSTMAST C      
  WHERE L2.COSTCODE = C.COSTCODE AND COSTNAME <> 'HO' AND CLTCODE <> 'HOCTRL'      
  AND COSTNAME = BRANCHNAME       
  
  INSERT INTO LEDGER2 (VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE )           
  SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE FROM #LEDGER2                                                         
 /* IF @@BRANCHFLAG = 1                                                      
    BEGIN                                                      
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                      
              FROM     #RECPAY_TABLE                                                      
                               ORDER BY VNO                                                      
           
      OPEN @@L2CUR                                                      
                                                            
      FETCH NEXT FROM @@L2CUR                                                      
      INTO @@L2VNO                                                      
                                                    
      WHILE @@FETCH_STATUS = 0                                                      
        BEGIN                                                      
          DELETE FROM TEMPLEDGER2                                                      
          WHERE  SESSIONID = '9999999999'                                                      
                                                                
/*======CLIENT SIDE RECORD======*/                                                      
          INSERT INTO TEMPLEDGER2                                                      
          SELECT 'BRANCH',                                                      
                 C.COSTNAME,                                                      
                 AMOUNT,                                                      
                 VTYP,                                                      
                 VNO,                                                      
                 LNO,                                                      
    DRCR,                                                      
                 '0',                                                      
    BOOKTYPE,                     
                 '9999999999',                                                      
                 CLIENT_CODE,                                                      
'A',                                                      
                 '0'                                                      
          FROM   #RECPAY_TABLE RP,                                                      
                 COSTMAST C WITH(NOLOCK)                                                       
          WHERE  RP.COSTCODE = C.COSTCODE                                                      
                 AND VNO = @@L2VNO                                                      
                                                                
/*======BANK SIDE RECORD======*/                                                      
          INSERT INTO TEMPLEDGER2                                                      
     SELECT   'BRANCH',                                                      
                   C.COSTNAME,                                                      
                   SUM(AMOUNT),                                                      
                   VTYP,                                 
                   VNO,                                                  
                   LNO = 1,                                                      
                   DRCR = (CASE                                                       
                             WHEN DRCR = 'D' THEN 'C'                                                      
                             ELSE 'D'                                                      
                           END),                                  
                   '0',                                                      
          BOOKTYPE,                                                      
                   '9999999999',                                                      
                   BANK_CODE,                                                      
                   'A',                                                      
                   '0'                                                      
          FROM     #RECPAY_TABLE RP,                                                      
                   COSTMAST C WITH(NOLOCK)                                                      
          WHERE    RP.BANKCOST = C.COSTCODE                         
                   AND VNO = @@L2VNO                                                      
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                                    
                   WHEN DRCR = 'D' THEN 'C'                                                      
                      ELSE 'D'                                                      
                    END),                       
                   BANK_CODE,BOOKTYPE                                                      
                                                                
          EXEC INSERTTOLEDGER2                                                      
            '9999999999' ,                                                      
            @@L2VNO ,                                                      
            '1' ,                                                      
            '1' ,                                                      
            '1' ,                                                      
            'BROKER' ,                                                 
            'BROKER'                                                      
                                                                
 FETCH NEXT FROM @@L2CUR                                                      
          INTO @@L2VNO                                                      
        END                                                      
                                                        
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                      
      WHERE       SESSIONID = '9999999999' */                                                     
                                                      
      IF EXISTS (SELECT *                              
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                       
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                      
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                       
         AND @@VTYP = 2                            
        BEGIN                                                      
          INSERT INTO THIRDPARTY_COLLECTION                                                      
(VNO,                                                      
                      VTYP,                                                      
                      BOOKTYPE,                                                      
                      CLTCODE,                                                      
                      AMOUNT,                                                      
                      VDT,                                                      
                 DDNO,                            
 ACCOUNT_NO,                                                      
                      TPR_FLAG)                                                      
          SELECT   VNO,                                                      
                   VTYP,                                             
                   BOOKTYPE,                                                      
                   CLIENT_CODE,                                                      
                   AMOUNT,                                                      
                   VDT,                                                      
                   MAX(REF_NO),                                                      
                   ACC_NO,                                              
                   TPR_FLAG = 'S'                                
          FROM     #RECPAY_TABLE                                                      
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                                                      
                   AMOUNT,VDT,ACC_NO       
                                                                         
          UPDATE T                                                      
          SET    TPR_FLAG = 'C'                                                      
          FROM                                               
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                     
                 MULTIBANKID M WITH(NOLOCK),                                                      
                 #RECPAY_TABLE R                                                      
          WHERE  T.CLTCODE = M.CLTCODE                                                      
                 AND M.ACCNO = T.ACCOUNT_NO                                                      
                 AND T.VNO = R.VNO                                                      
                 AND T.VTYP = R.VTYP                                            
                 AND T.BOOKTYPE = R.BOOKTYPE                                                      
        END                                                      
                                                        
   COMMIT TRAN                                                      
 END   
  
  DROP TABLE #LEDGER                                                       
                                                          
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES -- WITH(ROWLOCK)                                                       
SET                                                
 ROWSTATE = 1,                                                    
 APPROVALFLAG = 1,                                                   
 APPROVALDATE = GETDATE(),                                                    
 APPROVEDBY = 'SYSTEM',                                                    
 LEDGERVNO = VNO                                                      
FROM   #RECPAY_TABLE                                      
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                      
                                                            
                        
DROP TABLE #RECPAY_TABLE                                 
SET @ERRORCODE = 0                                                               
SET @MESSAGE = 'POSTED SUCCESSFULLY'                                              
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                               
                              
                              
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK
-- --------------------------------------------------

CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK]                      
 @FNAME VARCHAR(100),                      
 @UNAME VARCHAR(25),                      
 @USERCAT SMALLINT,                  
 @EXCHANGE VARCHAR(3),                    
 @SEGMENT  VARCHAR(10),                    
 @STATUSID VARCHAR(15),                    
 @STATUSNAME VARCHAR(15)                      
                      
AS                      
/*                      
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                      
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'                 
ROLLBACK                      
*/                      
set xact_abort on            
            
            
SET NOCOUNT ON                      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                      
DECLARE                      
 @@STD_DATE VARCHAR(11),                      
 @@LST_DATE VARCHAR(11),                      
 @@BRANCHFLAG AS TINYINT,                      
 @@VNOFLAG AS TINYINT,                      
 @@VNOMETHOD INT,                      
 @@ACNAME CHAR(100),                      
 @@BOOKTYPE CHAR(2),                      
 @@MICRNO VARCHAR(10),                      
 @@DRCR VARCHAR(1),                      
 @@VTYP SMALLINT,                      
 @@BANK_CODE VARCHAR(100),                      
 @@BACKDAYS INT,                      
 @@BACKDATE VARCHAR(11),                      
 @@BRNCOUNT   TINYINT,                      
 @@MonthlyVdt VARCHAR(11),                      
 @@SERIAL_NO INT,                      
 @@COSTCODECOUNT TINYINT,                      
 @@COSTCODEUPDATES CURSOR,                      
 @@NEWVNO AS VARCHAR(12),                      
 @@MAXCOUNT AS INT,                      
 @@VDT AS VARCHAR(11),                      
 @@BANKBRANCH AS VARCHAR(10),                      
 @@BANKCOST AS NUMERIC,                      
 @@LNOCUR AS CURSOR,                      
 @@VNOCUR AS CURSOR,                      
 @@LNOVNO AS VARCHAR(12),                      
 @@MAXVNO AS INT,                      
 @@L2CUR AS CURSOR,                      
 @@L2VNO AS VARCHAR(12),                      
 @@ERROR_COUNT AS INT,                      
 @@FILEEXISTS AS INT,                      
 @@SQL AS VARCHAR(2000),                  
 @@MyTempVno AS VARCHAR(12)                        
                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT                      
   U_FILENAME                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                      
  RETURN                      
 END                      
CREATE TABLE #FEXIST                      
(                      
 F1 SMALLINT,                      
 F2 SMALLINT,                      
 F3 SMALLINT                      
)                      
SELECT @@SQL = "INSERT INTO "                      
SELECT @@SQL = @@SQL + " #FEXIST "                      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                      
                      
EXEC(@@SQL)                      
                      
SELECT                      
 @@FILEEXISTS = F1                      
FROM                      
 #FEXIST                      
                      
IF @@FILEEXISTS = 0                      
 BEGIN                      
  DROP TABLE #FEXIST                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                      
  RETURN                      
 END                      
DROP TABLE #FEXIST                      
                      
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                 
CREATE TABLE #RECPAY_TABLE_TMP                      
(                      
 SERIAL_NO INT,                      
 EDATE VARCHAR(20),                      
 VOUCHER_DATE VARCHAR(20),                      
 CLIENT_CODE VARCHAR(50),                      
 AMOUNT MONEY,                      
 DRCR VARCHAR(1),                      
 NARRATION VARCHAR(234),                      
 BANK_CODE VARCHAR(10),                      
 BANK_NAME VARCHAR(100),                  
 REF_NO VARCHAR(30),                      
 BRANCHCODE VARCHAR(20),                      
 BRANCH_NAME VARCHAR(50),                      
 CHQ_MODE VARCHAR(1),                      
 CHQ_DATE VARCHAR(20),                      
 CHQ_NAME VARCHAR(100),                      
 CL_MODE VARCHAR(1),                          
 ACCOUNTNO VARCHAR(25)                  
)                   
                    
CREATE TABLE [#RECPAY_TABLE]                      
 (                      
  SERIAL_NO INT,                      
  EDATE VARCHAR(20),                      
  VOUCHER_DATE VARCHAR(20),                      
  CLIENT_CODE VARCHAR(50),                      
  AMOUNT MONEY,                      
  DRCR VARCHAR(1),                      
  NARRATION VARCHAR(234),                      
  BANK_CODE VARCHAR(10),                      
  BANK_NAME VARCHAR(100),                      
  REF_NO VARCHAR(30),                      
  BRANCHCODE VARCHAR(20),                      
  BRANCH_NAME VARCHAR(50),                      
  CHQ_MODE VARCHAR(1),                      
  CHQ_DATE VARCHAR(20),                      
  CHQ_NAME VARCHAR(100),                      
  CL_MODE VARCHAR(1),                      
  SNO INT IDENTITY (1, 1) NOT NULL ,                      
  VDT DATETIME NULL ,                      
  FYSTART DATETIME NULL ,                      
  FYEND DATETIME NULL ,                      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                      
  EDT DATETIME NULL ,                      
  DDDT DATETIME NULL ,                      
  VNO VARCHAR (12) NULL ,                      
  VTYP SMALLINT NULL ,                      
  ACNAME VARCHAR (100) NULL ,                      
  COSTCODE SMALLINT NULL,                      
  BANKCOST SMALLINT NULL,                      
  LNO SMALLINT NOT NULL DEFAULT(0),                      
  BANKNAME VARCHAR(100) NULL,                    
  MICRNO INT NULL,                      
  BOOKTYPE VARCHAR(2) NULL,                   
  ACCOUNTNO VARCHAR(25),                
  TPFLAG INT                   
 ) ON [PRIMARY]                    
                  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                      
EXEC (@@SQL)                      
                      
IF @@ERROR <> 0                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                      
  RETURN                      
 END                      
INSERT INTO                      
 V2_UPLOADED_FILES                      
SELECT                      
 @FNAME,                      
 @FNAME,                      
 CNT = COUNT(1),                      
 'B',                      
 GETDATE(),                      
 @UNAME,                      
 'RECEIPT/PAYMENT UPLOAD'                      
                      
INSERT INTO                      
 #RECPAY_TABLE                      
 (                      
  SERIAL_NO,                      
  EDATE,                      
  VOUCHER_DATE,                      
  CLIENT_CODE,                      
  AMOUNT,                      
  DRCR,                      
  NARRATION,                      
  BANK_CODE,                 
  BANK_NAME,                      
  REF_NO,                      
  BRANCHCODE,                      
  BRANCH_NAME,                      
  CHQ_MODE,                      
  CHQ_DATE,                      
  CHQ_NAME,                      
  CL_MODE,                  
  ACCOUNTNO,                
  TPFLAG                      
 )                      
SELECT                      
 SERIAL_NO,                      
 EDATE,                      
 VOUCHER_DATE,                      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                      
 AMOUNT,                      
 UPPER(LTRIM(RTRIM(DRCR))),                      
 NARRATION,                      
 UPPER(LTRIM(RTRIM(BANK_CODE))),                      
 UPPER(LTRIM(RTRIM(BANK_NAME))),                      
 REF_NO,                      
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                      
 CHQ_DATE,                      
 CHQ_NAME,                      
 CL_MODE,                  
 ACCOUNTNO,                
 TPFLAG = 1                  
FROM                      
 #RECPAY_TABLE_TMP                      
                      
UPDATE                      
 #RECPAY_TABLE                      
SET                      
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                      
                      
                     
SELECT                      
 @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
FROM                      
 #RECPAY_TABLE                      
                      
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                      
  RETURN                      
 END                      
                      
SELECT TOP 1                      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                      
FROM                      
 #RECPAY_TABLE                      
                      
SELECT                      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                      
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG                      
FROM                      
 PARAMETER                      
WHERE                      
 @@VDT BETWEEN SDTCUR AND LDTCUR                      
                  
DECLARE @@VDTNEW VARCHAR(11)
SELECT TOP 1 @@VDTNEW = CONVERT(VARCHAR(11),CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),109)  
FROM #RECPAY_TABLE

                      
IF @@BRANCHFLAG = 1                      
 BEGIN                     
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = A.BRANCHCODE,                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = C.COSTCODE,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
-- AND P.CURYEAR = 1                      
   AND @@VDTNEW BETWEEN P.SDTCUR AND P.LDTCUR
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = COSTNAME                      
                        
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
-- AND P.CURYEAR = 1                      
   AND @@VDTNEW BETWEEN P.SDTCUR AND P.LDTCUR
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                      
                    
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = 'HO',                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
-- AND P.CURYEAR = 1                      
   AND @@VDTNEW BETWEEN P.SDTCUR AND P.LDTCUR
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                      
 END                      
ELSE                
 BEGIN                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   FYSTART = @@STD_DATE,                      
   FYEND = @@LST_DATE + ' 23:59:59',                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
 END 
 
  
 UPDATE R SET UPDFLAG = 'B'     
 FROM #RECPAY_TABLE R    
 WHERE BANK_CODE  IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N') 
 
 /* VALIDATION OF DUPLICATE CHEQUE ENTRY WITHIN FILE */
 
 SET @@ERROR_COUNT = 0

 SELECT @@ERROR_COUNT = COUNT(1) FROM
 (SELECT CLTCODE, REF_NO, AMOUNT, DRCR FROM #RECPAY_TABLE GROUP BY CLTCODE, REF_NO, AMOUNT, DRCR HAVING COUNT(1) > 1) A

 IF @@ERROR_COUNT > 0
 BEGIN                      
   SELECT                      
    RESULT = 'SOME OF THE CHEQUE ENTRIES ARE DUPLICATE IN FILE'                      
   UNION ALL                      
   SELECT                      
    RESULT = 'DUPLICATE CHQ:' + LTRIM(RTRIM(CONVERT(VARCHAR, REF_NO))) + ', CLTCODE:' + CONVERT(VARCHAR, CLTCODE)                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY CLTCODE, REF_NO, AMOUNT, DRCR HAVING COUNT(1) > 1                    
                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
 END 
 /* VALIDATION OF DUPLICATE CHEQUE ENTRY WITHIN FILE */
                      
                      
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                      
                      
 SELECT                      
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
 FROM                      
  #RECPAY_TABLE                      
 IF @@ERROR_COUNT > 1                      
  BEGIN                      
   SELECT                      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END                      
                  
                  
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/                      
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE                   
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1                  
 IF @@ERROR_COUNT > 1                     
  BEGIN                      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'                      
   DROP TABLE #RecPay_Table_Tmp                      
   DROP TABLE #RecPay_Table                      
   ROLLBACK TRAN                      
   DELETE FROM V2_Uploaded_Files                      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END        */          
                      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                      
 SELECT                      
  @@ERROR_COUNT = COUNT(1)                      
 FROM                      
  (                      
   SELECT                      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),                      
    SERIAL_NO                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                    
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
  ) A                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT                      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                      
   UNION ALL                      
   SELECT                      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                      
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
 END                      
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
 SELECT DISTINCT                      
  DRCR                      
 FROM                      
  #RECPAY_TABLE                      
 ) A                      
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  SELECT                      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
ELSE                      
 BEGIN                      
  SELECT TOP 1                      
   @@DRCR = DRCR,                      
   @@VTYP =                      
    (                      
    CASE                      
     WHEN DRCR = 'D'                      
     THEN 3                      
     ELSE 2                      
    END                      
    )                      
  FROM                      
   #RECPAY_TABLE                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET VTYP =                      
   (                      
   CASE                      
     WHEN DRCR = 'D'                      
     THEN 3                      
     ELSE 2                      
    END                 
   )                      
 END                      
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE VDT > EDT                      
            IF @@ERROR_COUNT > 0                      
             BEGIN                      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
             END                      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE AMOUNT <= 0                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
  END        
            
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                            
   SELECT                                  
     @@BACKDAYS = ISNULL(MIN(NODAYS), 0)                                  
    FROM                                  
     USERWRITESTABLE            
    WHERE                                  
     USERCATEGORY = @USERCAT                                  
     AND VTYP = @@VTYP                                  
     AND BOOKTYPE = '01'            
                               
    SELECT                                  
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                                  
    SELECT                                  
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                                  
    FROM                                  
     #RECPAY_TABLE                                  
    WHERE                                  
     VDT < @@BACKDATE    
                                 
    IF @@ERROR_COUNT > 0                                  
     BEGIN                                  
  SELECT 'FEW OF THE VOUCHRS ARE BACKDATED WHICH IS NOT ALLOWED.'                  
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  IF @@VTYP = 2     
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  ELSE            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  RETURN                          
     END               
        
/*--------VALIDATION OF FUTURE DATE WITH HARDCODE 2 DAYS -----*/  
        
 SELECT                
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                
 FROM        
  #RECPAY_TABLE where vdt > getdate()+2     
  
IF @@ERROR_COUNT > 0                                  
   BEGIN                                  
  SELECT 'FEW OF THE VOUCHRS ARE FUTURE DATED WHICH IS NOT ALLOWED.'                  
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  IF @@VTYP = 2            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  ELSE            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  RETURN                          
 END                 
           
/*------------ */          
  
             
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */   
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
   SELECT DISTINCT              
   DDNO  = RP.REF_NO             
  FROM              
   #RECPAY_TABLE RP,              
   LEDGER1 L1 WITH (NOLOCK),LEDGER L              
    WITH(NOLOCK)              
  WHERE              
   L1.DDNO = RP.REF_NO    
   AND L.VNO=L1.VNO
   AND L.VTYP=L1.VTYP
   AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L.VDT>= CONVERT(VARCHAR(11),GETDATE()-45,120)    
    AND  L.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   AND L1.DRCR = @@DRCR              
   AND L1.VTYP = @@VTYP              
   AND RP.REF_NO <> '0'   
   
   UNION 

   SELECT DISTINCT              
   DDNO  = RP.REF_NO             
  FROM              
   #RECPAY_TABLE RP,              
   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES L1    WITH(NOLOCK)          
                  
  WHERE              
   L1.DDNO = RP.REF_NO    
   --AND L.VTYP=L1.VTYP
   ---AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L1.vdate>= CONVERT(VARCHAR(11),GETDATE()-45,120)    
    AND  L1.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   --AND L1.DRCR = @@DRCR              
   --AND L1.VTYP = @@VTYP              
   AND RP.REF_NO <> '0'   
          
 ) A              
IF @@ERROR_COUNT > 0              
 BEGIN              
  SELECT              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'              
  UNION ALL              
  SELECT DISTINCT              
   RP.REF_NO, 'NA','NA'              
  FROM              
   #RECPAY_TABLE RP,              
    LEDGER1 L1 WITH (NOLOCK),LEDGER L              
    WITH(NOLOCK)              
  WHERE              
   L1.DDNO = RP.REF_NO    
   AND L.VNO=L1.VNO
   AND L.VTYP=L1.VTYP
   AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L.VDT>= CONVERT(VARCHAR(11),GETDATE()-45,120)   
   AND  L.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   AND L1.DRCR = @@DRCR              
   AND L1.VTYP = @@VTYP                
   AND RP.CHQ_MODE <> 'N'  
   
   
   
    UNION 

   SELECT DISTINCT              
   DDNO  = RP.REF_NO , 'NA','NA'                    
  FROM              
   #RECPAY_TABLE RP,              
   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES L1    WITH(NOLOCK)          
                
  WHERE              
   L1.DDNO = RP.REF_NO    
   --AND L.VTYP=L1.VTYP
   ---AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L1.Vdate>= CONVERT(VARCHAR(11),GETDATE()-45,120)    
    AND  L1.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   --AND L1.DRCR = @@DRCR              
   --AND L1.VTYP = @@VTYP   
   
                          
  DROP TABLE #RECPAY_TABLE_TMP                   
   DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                 
                
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */                      
/*SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   RP.ACCOUNTNO                    
  FROM                      
   #RECPAY_TABLE RP,                      
   MULTIBANKID M                      
    WITH(NOLOCK)                     
  WHERE                      
   M.ACCNO = RP.ACCOUNTNO                      
 ) A                      
IF @@ERROR_COUNT <= 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   RP.ACCOUNTNO, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE RP,                      
   MULTIBANKID M                      
    WITH(NOLOCK)                      
  WHERE                      
   M.ACCNO <> RP.ACCOUNTNO                   
                      
  DROP TABLE #RECPAY_TABLE_TMP                     
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
*/    

/*--------------------------FINAL VALIDATION BASED ON BLOCKING ------------------------*/                            
SELECT                            
 @@ERROR_COUNT = COUNT(1)                            
FROM                            
 (                            
  SELECT DISTINCT                            
   BANK_CODE                            
  FROM                            
   #RECPAY_TABLE                            
  WHERE                            
   UPDFLAG = 'B'                            
 ) A                            
IF @@ERROR_COUNT > 0                            
 BEGIN                            
  SELECT                            
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE BLOCKED', 'NA','NA'                            
  UNION ALL                            
  SELECT DISTINCT                            
   BANK_CODE, 'NA','NA'                            
  FROM                            
   #RECPAY_TABLE                            
  WHERE                            
   UPDFLAG = 'B'                            
  DROP TABLE #RECPAY_TABLE_TMP                            
DROP TABLE #RECPAY_TABLE                            
  ROLLBACK TRAN                            
  DELETE FROM                            
   V2_UPLOADED_FILES                          WHERE                     
   U_FILENAME = @FNAME                            
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                            
  RETURN                            
 END                              
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   CLIENT_CODE                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   CLIENT_CODE, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE               
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
                 
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)                     
                
                 
UPDATE                      
 R                
SET                 
TPFLAG = 0                
FROM                
 #RECPAY_TABLE R,                
 MULTIBANKID M                
WHERE                 
 R.CLIENT_CODE = M.CLTCODE                
 AND M.ACCNO = R.ACCOUNTNO                
                 
                
INSERT INTO ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES                      
   (VOUCHERTYPE,                      
   BOOKTYPE,                      
   SNO,                      
   VDATE,                      
   EDATE,                      
   CLTCODE,                      
   CREDITAMT,                      
   DEBITAMT,                      
   NARRATION,                    
   OPPCODE,                    
   BANKNAME,                    
   DDNO,                    
   BRANCHCODE,                    
   BRANCHNAME,                    
   CHEQUEMODE,                    
   CHEQUEDATE,                    
   CHEQUENAME,                    
   CLEAR_MODE,                    
   EXCHANGE,                      
   SEGMENT,                      
   TPFLAG,                      
   ADDDT,                      
   ADDBY,                      
   STATUSID,                      
   STATUSNAME,                      
   ROWSTATE,                      
   APPROVALFLAG,                      
   APPROVALDATE,                      
   APPROVEDBY,                      
   VOUCHERNO,              
   UPLOADDT,                      
   CLIENTNAME,                
   TPACCOUNTNUMBER)                      
                     
 SELECT                       
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,                       
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,                    
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                         
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,                      
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO                      
 FROM                       
  #RECPAY_TABLE                      
                    
COMMIT TRANSACTION                    
                      
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                        
                    
DROP TABLE #RECPAY_TABLE_TMP                        
DROP TABLE #RECPAY_TABLE             
            
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK_BKUP_07DEC2018
-- --------------------------------------------------
 Create PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK_BKUP_07DEC2018]                          
 @FNAME VARCHAR(100),                          
 @UNAME VARCHAR(25),                          
 @USERCAT SMALLINT,                      
 @EXCHANGE VARCHAR(3),                        
 @SEGMENT  VARCHAR(10),                        
 @STATUSID VARCHAR(15),                        
 @STATUSNAME VARCHAR(15)                          
                          
AS                          
/*                          
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                          
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'                     
ROLLBACK                          
*/                          
set xact_abort on                
                
                
SET NOCOUNT ON                          
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                          
DECLARE                          
 @@STD_DATE VARCHAR(11),                          
 @@LST_DATE VARCHAR(11),                          
 @@BRANCHFLAG AS TINYINT,                          
 @@VNOFLAG AS TINYINT,                          
 @@VNOMETHOD INT,                          
 @@ACNAME CHAR(100),                          
 @@BOOKTYPE CHAR(2),                          
 @@MICRNO VARCHAR(10),                          
 @@DRCR VARCHAR(1),                          
 @@VTYP SMALLINT,                          
 @@BANK_CODE VARCHAR(100),                          
 @@BACKDAYS INT,                          
 @@BACKDATE VARCHAR(11),                          
 @@BRNCOUNT   TINYINT,                          
 @@MonthlyVdt VARCHAR(11),                          
 @@SERIAL_NO INT,                          
 @@COSTCODECOUNT TINYINT,                          
 @@COSTCODEUPDATES CURSOR,                          
 @@NEWVNO AS VARCHAR(12),                          
 @@MAXCOUNT AS INT,                          
 @@VDT AS VARCHAR(11),                          
 @@BANKBRANCH AS VARCHAR(10),                          
 @@BANKCOST AS NUMERIC,                          
 @@LNOCUR AS CURSOR,                          
 @@VNOCUR AS CURSOR,                          
 @@LNOVNO AS VARCHAR(12),                          
 @@MAXVNO AS INT,                          
 @@L2CUR AS CURSOR,                          
 @@L2VNO AS VARCHAR(12),                          
 @@ERROR_COUNT AS INT,                          
 @@FILEEXISTS AS INT,                          
 @@SQL AS VARCHAR(2000),                      
 @@MyTempVno AS VARCHAR(12)                            
                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT                          
   U_FILENAME                          
  FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                          
  RETURN                          
 END                          
CREATE TABLE #FEXIST                          
(                          
 F1 SMALLINT,                          
 F2 SMALLINT,                          
 F3 SMALLINT                          
)                          
SELECT @@SQL = "INSERT INTO "                          
SELECT @@SQL = @@SQL + " #FEXIST "                          
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                          
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                          
                          
EXEC(@@SQL)                          
                          
SELECT          
 @@FILEEXISTS = F1                          
FROM                          
 #FEXIST                          
                          
IF @@FILEEXISTS = 0       
 BEGIN                          
  DROP TABLE #FEXIST                          
  SELECT                          
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                          
  RETURN                          
 END                          
DROP TABLE #FEXIST                          
                          
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                     
CREATE TABLE #RECPAY_TABLE_TMP                          
(                          
 SERIAL_NO INT,                          
 EDATE VARCHAR(20),                          
 VOUCHER_DATE VARCHAR(20),                          
 CLIENT_CODE VARCHAR(50),                          
 AMOUNT MONEY,                          
 DRCR VARCHAR(1),                          
 NARRATION VARCHAR(234),                          
 BANK_CODE VARCHAR(10),                          
 BANK_NAME VARCHAR(100),                      
 REF_NO VARCHAR(15),                          
 BRANCHCODE VARCHAR(20),                          
 BRANCH_NAME VARCHAR(50),                          
 CHQ_MODE VARCHAR(1),                          
 CHQ_DATE VARCHAR(20),                          
 CHQ_NAME VARCHAR(100),                          
 CL_MODE VARCHAR(1),                              
 ACCOUNTNO VARCHAR(25)                      
)                       
                        
CREATE TABLE [#RECPAY_TABLE]                          
 (                          
  SERIAL_NO INT,                          
  EDATE VARCHAR(20),                          
  VOUCHER_DATE VARCHAR(20),                          
  CLIENT_CODE VARCHAR(50),                          
  AMOUNT MONEY,                          
  DRCR VARCHAR(1),                          
  NARRATION VARCHAR(234),                          
  BANK_CODE VARCHAR(10),                          
  BANK_NAME VARCHAR(100),                          
  REF_NO VARCHAR(15),                          
  BRANCHCODE VARCHAR(20),                          
  BRANCH_NAME VARCHAR(50),                          
  CHQ_MODE VARCHAR(1),                          
  CHQ_DATE VARCHAR(20),                          
  CHQ_NAME VARCHAR(100),                          
  CL_MODE VARCHAR(1),                          
  SNO INT IDENTITY (1, 1) NOT NULL ,                          
  VDT DATETIME NULL ,                          
  FYSTART DATETIME NULL ,                          
  FYEND DATETIME NULL ,                          
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                          
  EDT DATETIME NULL ,                          
  DDDT DATETIME NULL ,                          
  VNO VARCHAR (12) NULL ,                          
  VTYP SMALLINT NULL ,                          
  ACNAME VARCHAR (100) NULL ,                          
  COSTCODE SMALLINT NULL,                          
  BANKCOST SMALLINT NULL,                          
  LNO SMALLINT NOT NULL DEFAULT(0),                          
  BANKNAME VARCHAR(100) NULL,                        
  MICRNO INT NULL,                          
  BOOKTYPE VARCHAR(2) NULL,                       
  ACCOUNTNO VARCHAR(25),                    
  TPFLAG INT                       
 ) ON [PRIMARY]                        
                      
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                          
EXEC (@@SQL)                          
                          
IF @@ERROR <> 0                          
 BEGIN                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRANSACTION                          
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                          
  RETURN                          
 END                          
INSERT INTO   
 V2_UPLOADED_FILES                          
SELECT                          
 @FNAME,                          
 @FNAME,                          
 CNT = COUNT(1),                          
 'B',                          
 GETDATE(),                          
 @UNAME,                          
 'RECEIPT/PAYMENT UPLOAD'                          
                        
INSERT INTO                          
 #RECPAY_TABLE                          
 (                          
  SERIAL_NO,                          
  EDATE,                          
  VOUCHER_DATE,                          
  CLIENT_CODE,                          
  AMOUNT,                          
  DRCR,                          
  NARRATION,                          
  BANK_CODE,                     
  BANK_NAME,                          
  REF_NO,                          
  BRANCHCODE,                          
  BRANCH_NAME,                          
  CHQ_MODE,                          
  CHQ_DATE,                          
  CHQ_NAME,                          
  CL_MODE,                      
  ACCOUNTNO,                    
  TPFLAG                          
 )                          
SELECT                          
 SERIAL_NO,                          
 EDATE,                          
 VOUCHER_DATE,                          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                          
 AMOUNT,                          
 UPPER(LTRIM(RTRIM(DRCR))),                          
 NARRATION,                          
 UPPER(LTRIM(RTRIM(BANK_CODE))),                          
 UPPER(LTRIM(RTRIM(BANK_NAME))),                          
 REF_NO,                          
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                          
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                          
 CHQ_DATE,                          
 CHQ_NAME,                          
 CL_MODE,                      
 ACCOUNTNO,                    
 TPFLAG = 1                      
FROM                          
 #RECPAY_TABLE_TMP                          
                          
UPDATE                          
 #RECPAY_TABLE                          
SET                          
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                          
                          
                         
SELECT                          
 @@ERROR_COUNT = COUNT(DISTINCT VDT)                          
FROM                          
 #RECPAY_TABLE                          
                          
IF @@ERROR_COUNT > 1                          
 BEGIN                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRANSACTION                          
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                          
  RETURN                          
 END                          
                          
SELECT TOP 1                          
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                          
FROM                          
 #RECPAY_TABLE                          
                          
SELECT                          
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                          
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                          
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG                          
FROM                          
 PARAMETER                          
WHERE                          
 @@VDT BETWEEN SDTCUR AND LDTCUR                          
                      
                          
IF @@BRANCHFLAG = 1                          
 BEGIN                         
  UPDATE                          
   #RECPAY_TABLE                    
  SET                          
   BRANCHCODE = A.BRANCHCODE,                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = C.COSTCODE,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
 ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')     
  -- AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')                         
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = COSTNAME                          
                            
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')    
   --AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')                          
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = 'ALL'                          
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                          
                        
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   BRANCHCODE = 'HO',                          
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')                          
   --AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')    
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = 'ALL'                          
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                          
 END                          
ELSE                    
 BEGIN                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   FYSTART = @@STD_DATE,                          
   FYEND = @@LST_DATE + ' 23:59:59',                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND A.ACCAT IN ('3','4','18')                          
  -- AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')    
   AND B.ACCAT = '2'                          
 END   
   
 UPDATE R SET UPDFLAG = 'B'   
 FROM #RECPAY_TABLE R  
 WHERE BANK_CODE  IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')  
                          
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                          
                          
 SELECT                          
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                          
 FROM                          
  #RECPAY_TABLE                          
 IF @@ERROR_COUNT > 1                          
  BEGIN                          
   SELECT                          
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE                          
   FROM                          
    V2_UPLOADED_FILES                          
   WHERE                          
    U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
   RETURN                          
  END                          
                      
                      
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/                          
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE                       
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1                      
 IF @@ERROR_COUNT > 1                         
  BEGIN                          
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'                          
   DROP TABLE #RecPay_Table_Tmp                          
   DROP TABLE #RecPay_Table                          
   ROLLBACK TRAN                          
   DELETE FROM V2_Uploaded_Files                          
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
   RETURN                          
  END        */              
                          
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                          
 SELECT                          
  @@ERROR_COUNT = COUNT(1)                          
 FROM                          
  (                          
   SELECT                          
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),                          
    SERIAL_NO                          
   FROM                          
    #RECPAY_TABLE                          
   GROUP BY                        
    SERIAL_NO                          
   HAVING                          
    COUNT(DISTINCT BANK_CODE) > 1                          
  ) A                          
 IF @@ERROR_COUNT > 0                          
  BEGIN                          
   SELECT                          
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                          
   UNION ALL                          
   SELECT                          
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                          
   FROM                          
    #RECPAY_TABLE                          
   GROUP BY                          
    SERIAL_NO                          
   HAVING                          
    COUNT(DISTINCT BANK_CODE) > 1                          
                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE                          
   FROM                         
    V2_UPLOADED_FILES                          
   WHERE                          
    U_FILENAME = @FNAME                          
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
   RETURN                          
 END                          
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
 SELECT DISTINCT                          
  DRCR                          
 FROM                          
  #RECPAY_TABLE                          
 ) A                          
IF @@ERROR_COUNT > 1                          
 BEGIN                          
  SELECT                          
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE                          
  FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                          
ELSE                          
 BEGIN                          
  SELECT TOP 1                          
   @@DRCR = DRCR,                          
   @@VTYP =                          
    (                          
    CASE                          
     WHEN DRCR = 'D'                          
     THEN 3                          
     ELSE 2                          
    END                          
    )                          
  FROM                          
   #RECPAY_TABLE                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET VTYP =                          
   (                          
   CASE                          
     WHEN DRCR = 'D'                          
     THEN 3                          
     ELSE 2                          
    END                     
   )                          
 END                          
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                          
 SELECT @@ERROR_COUNT = COUNT(1)                          
 FROM #RECPAY_TABLE                          
 WHERE VDT > EDT                          
            IF @@ERROR_COUNT > 0                          
             BEGIN                          
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                          
     DROP TABLE #RECPAY_TABLE_TMP                          
     DROP TABLE #RECPAY_TABLE                          
     ROLLBACK TRAN                          
     DELETE FROM        
      V2_UPLOADED_FILES                          
     WHERE                          
      U_FILENAME = @FNAME                          
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
     RETURN                          
             END                          
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                          
 SELECT @@ERROR_COUNT = COUNT(1)                          
 FROM #RECPAY_TABLE                          
 WHERE AMOUNT <= 0                          
 IF @@ERROR_COUNT > 0                          
  BEGIN                          
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                          
     DROP TABLE #RECPAY_TABLE_TMP                          
     DROP TABLE #RECPAY_TABLE                          
     ROLLBACK TRAN                          
     DELETE FROM                          
      V2_UPLOADED_FILES                          
     WHERE                          
      U_FILENAME = @FNAME                          
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
     RETURN                          
  END            
                
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                                
   SELECT                                      
     @@BACKDAYS = ISNULL(MIN(NODAYS), 0)                                      
    FROM                                      
     USERWRITESTABLE                
    WHERE                                      
     USERCATEGORY = @USERCAT                                      
     AND VTYP = @@VTYP                                      
     AND BOOKTYPE = '01'                
                                   
    SELECT                                      
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                                      
    SELECT                                      
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                                      
    FROM                                      
     #RECPAY_TABLE                                      
    WHERE                                      
     VDT < @@BACKDATE        
                                     
    IF @@ERROR_COUNT > 0                                      
     BEGIN                                      
  SELECT 'FEW OF THE VOUCHRS ARE BACKDATED WHICH IS NOT ALLOWED.'                      
  DROP TABLE #RECPAY_TABLE_TMP                
  DROP TABLE #RECPAY_TABLE                
  ROLLBACK TRAN                
  IF @@VTYP = 2         
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  ELSE                
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  RETURN                              
     END                   
            
/*--------VALIDATION OF FUTURE DATE WITH HARDCODE 2 DAYS -----*/      
            
 SELECT                    
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                    
 FROM            
  #RECPAY_TABLE where vdt > getdate()+2         
      
IF @@ERROR_COUNT > 0                                      
   BEGIN                                      
  SELECT 'FEW OF THE VOUCHRS ARE FUTURE DATED WHICH IS NOT ALLOWED.'                      
  DROP TABLE #RECPAY_TABLE_TMP                
  DROP TABLE #RECPAY_TABLE                
  ROLLBACK TRAN                
  IF @@VTYP = 2                
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  ELSE                
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  RETURN                              
 END                     
               
/*------------ */              
      
                 
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */                              
/*SELECT                              
 @@ERROR_COUNT = COUNT(1)                              
FROM                              
 (                              
  SELECT DISTINCT                              
   DDNO  = RP.REF_NO                              
  FROM                              
   #RECPAY_TABLE RP,                              
   LEDGER1 L1                              
    WITH(NOLOCK)                              
  WHERE                              
   L1.DDNO = RP.REF_NO                              
  AND L1.BNKNAME = RP.BANK_NAME                              
  AND L1.DD = RP.CHQ_MODE         
  AND L1.DRCR = @@DRCR                              
  AND L1.VTYP = @@VTYP                              
  AND RP.REF_NO <> '0'                              
  AND ISNUMERIC(RP.REF_NO) = 1                             
 ) A                              
IF @@ERROR_COUNT > 0                              
 BEGIN                              
  SELECT                              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                              
  UNION ALL                              
  SELECT DISTINCT                              
   RP.REF_NO, 'NA','NA'                              
  FROM                              
   #RECPAY_TABLE RP,                              
   LEDGER1 L1                              
    WITH(NOLOCK)                              
  WHERE                              
   L1.DDNO = RP.REF_NO                              
   AND L1.DD = RP.CHQ_MODE                              
   AND L1.DRCR = @@DRCR                              
   AND L1.VTYP = @@VTYP                              
   AND RP.CHQ_MODE <> 'N'                              
  DROP TABLE #RECPAY_TABLE_TMP                    DROP TABLE #RECPAY_TABLE                              
  ROLLBACK TRAN                              
  DELETE FROM                              
   V2_UPLOADED_FILES                              
  WHERE                              
   U_FILENAME = @FNAME                              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                              
  RETURN                              
 END                     
*/                         
                      
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */                          
/*SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   RP.ACCOUNTNO                        
  FROM                          
   #RECPAY_TABLE RP,                          
   MULTIBANKID M                          
    WITH(NOLOCK)                         
  WHERE                          
   M.ACCNO = RP.ACCOUNTNO                          
 ) A                          
IF @@ERROR_COUNT <= 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   RP.ACCOUNTNO, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE RP,                          
   MULTIBANKID M                          
    WITH(NOLOCK)                          
  WHERE                          
   M.ACCNO <> RP.ACCOUNTNO                       
                          
  DROP TABLE #RECPAY_TABLE_TMP                         
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES              
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                          
*/     
  
  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   BANK_CODE                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'B'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE BLOCKED', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   BANK_CODE, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'B'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          WHERE                   
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                              
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   CLIENT_CODE                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'N'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   CLIENT_CODE, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'N'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          WHERE                   
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                          
                     
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)                         
                    
                     
UPDATE                          
 R                    
SET                     
TPFLAG = 0                    
FROM                    
 #RECPAY_TABLE R,                    
 MULTIBANKID M                    
WHERE                     
 R.CLIENT_CODE = M.CLTCODE                    
 AND M.ACCNO = R.ACCOUNTNO                    
                     
                    
INSERT INTO ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES                          
   (VOUCHERTYPE,                          
   BOOKTYPE,                          
   SNO,                          
   VDATE,                          
   EDATE,                          
   CLTCODE,                          
   CREDITAMT,                       
   DEBITAMT,                          
   NARRATION,                        
   OPPCODE,                        
   BANKNAME,                        
   DDNO,                        
   BRANCHCODE,                        
   BRANCHNAME,                        
   CHEQUEMODE,                        
   CHEQUEDATE,                        
   CHEQUENAME,                        
   CLEAR_MODE,                        
   EXCHANGE,                          
   SEGMENT,                          
   TPFLAG,                          
   ADDDT,                          
   ADDBY,                          
   STATUSID,                          
   STATUSNAME,                          
   ROWSTATE,                          
   APPROVALFLAG,                          
   APPROVALDATE,                          
   APPROVEDBY,                          
   VOUCHERNO,                  
   UPLOADDT,                          
   CLIENTNAME,                    
   TPACCOUNTNUMBER)                          
                         
 SELECT                           
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,                           
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,                        
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                             
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,                          
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO                          
 FROM                           
  #RECPAY_TABLE                          
                        
COMMIT TRANSACTION                        
                          
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                            
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                            
                        
DROP TABLE #RECPAY_TABLE_TMP                            
DROP TABLE #RECPAY_TABLE                 
                
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_UPLOAD_PUTLOG
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[V2_OFFLINE_UPLOAD_PUTLOG]  
(  
 @P_EXCHANGE VARCHAR(3),  
 @P_SEGMENT VARCHAR(10),  
 @P_VOUCHERTYPE SMALLINT,  
 @P_ERRORCODE INT,  
 @P_ERRORMSG VARCHAR(255),  
 @P_UPDATEBY VARCHAR(25)  
)  
AS  

BEGIN DISTRIBUTED TRANSACTION 

INSERT INTO ANAND.ACCOUNT_AB.DBO.OFFLINE_UPLOAD_LOG  
(  
 OUL_EXCHANGE,  
 OUL_SEGMENT,  
 OUL_VOUCHERTYPE,  
 OUL_ERRORCODE,  
 OUL_ERRORMSG ,  
 OUL_UPDATEBY,  
 OUL_UPDATEDT  
)  
VALUES  
(  
 @P_EXCHANGE,  
 @P_SEGMENT,  
 @P_VOUCHERTYPE,  
 @P_ERRORCODE,  
 @P_ERRORMSG,  
 @P_UPDATEBY,  
 GETDATE()  
)

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Rpt_Acc_PartyLedger_All
-- --------------------------------------------------



--Exec RPT_ACC_PARTYLEDGER_ALL 'Apr  2 2010','Jun 15 2010','0a141','0a146','ACCODE','vdt','broker','broker','','Y'
CREATE PROCEDURE [dbo].[V2_Rpt_Acc_PartyLedger_All]
                @fdate      VARCHAR(11),            /* As mmm dd yyyy */
                @tdate      VARCHAR(11),            /* As mmm dd yyyy */
                @fcode      VARCHAR(10),
                @tcode      VARCHAR(10),
                @strorder   VARCHAR(6),
                @selectby   VARCHAR(3), 
                @statusid   VARCHAR(15),
                @statusname VARCHAR(15),
                @strbranch  VARCHAR(10),
                @orderflg   VARCHAR(1)  = 'N',
                @EXCSEGMENT VARCHAR(1000) = '',
                @ENTITY_TYPE VARCHAR(20) = 'ENTITY',
                @Single     VARCHAR(1)  = 'N',
                @FORPDF  VARCHAR(1) = 'N'
                

AS
/*
select * from COMPANY_MASTER_SETTING
 Exec [V2_Rpt_Acc_PartyLedger_All] 'Apr 1 2008','Mar 2 2009','0','0a143','ACCODE','vdt','broker','broker','','','','','ACCOUNT~ACCOUNTBSE~ACCOUNTFO'
commit
Exec rpt_acc_partyledger_all 'APR  1 2008','Mar  2 2009','0','0a143','ACCODE','vdt','broker','broker','',''
commit
*/

SET NOCOUNT ON

  BEGIN
 IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
  BEGIN
   SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
  END
 IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
  BEGIN
   SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
  END
    CREATE TABLE [DBO].[#TMPLEDGERNEW] (
		[BOOKTYPE]   [CHAR](2)   NULL,
		[VOUDT]      [DATETIME]   NULL,
		[EFFDT]      [DATETIME]   NULL,
		[SHORTDESC]  [CHAR](6)   NULL,
		[DRAMT]      [MONEY]   NULL,
		[CRAMT]      [MONEY]   NULL,
		[VNO]        [VARCHAR](12)   NULL,
		[DDNO]       [VARCHAR](15)   NULL,
		[NARRATION]  [VARCHAR](234)   NULL,
		[CLTCODE]    [VARCHAR](10)   NOT NULL,
		[VTYP]       [SMALLINT]   NULL,
		[VDT]        [VARCHAR](30)   NULL,
		[EDT]        [VARCHAR](30)   NULL,
		[ACNAME]     [VARCHAR](100)   NULL,
		[OPBAL]      [MONEY]   NULL,
		[L_ADDRESS1] [VARCHAR](40)   NULL,
		[L_ADDRESS2] [VARCHAR](40)   NULL,
		[L_ADDRESS3] [VARCHAR](40)   NULL,
		[L_CITY]     [VARCHAR](40)   NULL,
		[L_ZIP]      [VARCHAR](10)   NULL,
		[RES_PHONE1] [VARCHAR](15)   NULL,
		[BRANCH_CD]  [VARCHAR](10)   NULL,
		[CROSAC]     [VARCHAR](10)   NULL,
		[EDIFF]      [INT]   NULL,
		[FAMILY]     [VARCHAR](10)   NULL,
		[SUB_BROKER] [VARCHAR](10)   NULL,
		[TRADER]     [VARCHAR](20)   NULL,
		[CL_TYPE]    [VARCHAR](3)   NULL,
		[BANK_NAME]  [VARCHAR](50)   NULL,
		[CLTDPID]    [VARCHAR](16)   NULL,
		[LNO]        [INT]    NULL,
		[PDT]        [DATETIME]   NULL,
		[EXCHANGE] [VARCHAR] (15) NULL,
		[SEGMENT]    [VARCHAR](10)   NULL,
		[ENTITY]     [VARCHAR](50)   NULL,
		[ORDERSEG]   [BIGINT]   NULL,
		[ACTIVE_SEG] [VARCHAR] (MAX),
		[PARTYROWCOUNT] [INT] NULL,
		[TOTALPAGES] [INT] NULL
      )
    ON [PRIMARY]

 CREATE TABLE [DBO].[#DBNAME]    
 (    
  ACCOUNTDB VARCHAR(20),     
  EXCHANGE VARCHAR(6),     
  SEGMENT VARCHAR(10),    
  ACCOUNTSERVER VARCHAR(20),  
  SHAREDB VARCHAR(20),
  GROUPID VARCHAR(20),
  ORDER_SEGMENT INT  
 ) ON [PRIMARY]  
DECLARE  @@DB VARCHAR(1000)

IF @EXCSEGMENT = ''
	SELECT @EXCSEGMENT = EXCHANGE + '~' + SEGMENT FROM OWNER

IF @ENTITY_TYPE = 'ENTITY'	
	SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING (NOLOCK) WHERE EXCHANGE + '~' + SEGMENT IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY EXCHANGE "    
ELSE
	SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING (NOLOCK) WHERE GROUPID IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY GROUPID "    

PRINT @@DB
EXEC(@@DB)  




DECLARE @@MAINREC AS CURSOR,
		@@ACCOUNTDB VARCHAR(20),  
		@@SHAREDB VARCHAR(20),     
		@@ACCOUNTSVR VARCHAR(20),    
		@@EXCHANGE VARCHAR(15),    
		@@SEGMENT VARCHAR(15),
		@@GROUPID VARCHAR(20),
		@@ORDERSEG VARCHAR(3),
		@@ORDERSECOUNT INT
SET @@ORDERSECOUNT = (SELECT COUNT(1) FROM COMPANY_MASTER_SETTING) 

DECLARE @@SQL VARCHAR(MAX)
--SET @@SQL = ""
SET @@MAINREC = CURSOR FOR    
				 SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB,GROUPID,ORDER_SEGMENT FROM #DBNAME   
				 
OPEN @@MAINREC    
	FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB,@@GROUPID,@@ORDERSEG    
		WHILE @@FETCH_STATUS = 0    
		BEGIN			
		PRINT @@ACCOUNTDB 
	SET @@SQL = " INSERT INTO #TMPLEDGERNEW "
	SET @@SQL = @@SQL + " (BOOKTYPE, "
	SET @@SQL = @@SQL +" VOUDT, "
	SET @@SQL = @@SQL +" EFFDT, "
	SET @@SQL = @@SQL +" SHORTDESC, "
	SET @@SQL = @@SQL +" DRAMT, "
	SET @@SQL = @@SQL +" CRAMT, "
	SET @@SQL = @@SQL +" VNO, "
	SET @@SQL = @@SQL +" DDNO, "
	SET @@SQL = @@SQL +" NARRATION, "
	SET @@SQL = @@SQL +" CLTCODE, "
	SET @@SQL = @@SQL +" VTYP, "
	SET @@SQL = @@SQL +" VDT, "
	SET @@SQL = @@SQL +" EDT, "
	SET @@SQL = @@SQL +" ACNAME, "
	SET @@SQL = @@SQL +" OPBAL, "
	SET @@SQL = @@SQL +" L_ADDRESS1, "
	SET @@SQL = @@SQL +" L_ADDRESS2, "
	SET @@SQL = @@SQL +" L_ADDRESS3, "
	SET @@SQL = @@SQL +" L_CITY, "
	SET @@SQL = @@SQL +" L_ZIP, "
	SET @@SQL = @@SQL +" RES_PHONE1, "
	SET @@SQL = @@SQL +" BRANCH_CD, "
	SET @@SQL = @@SQL +" CROSAC, "
	SET @@SQL = @@SQL +" EDIFF, "
	SET @@SQL = @@SQL +" FAMILY, "
	SET @@SQL = @@SQL +" SUB_BROKER, "
	SET @@SQL = @@SQL +" TRADER, "
	SET @@SQL = @@SQL +" CL_TYPE, "
	SET @@SQL = @@SQL +" BANK_NAME, "
	SET @@SQL = @@SQL +" CLTDPID, "
	SET @@SQL = @@SQL +" LNO, "
	SET @@SQL = @@SQL +" PDT) "
	SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTDB+"..RPT_ACC_PARTYLEDGER "
	SET @@SQL = @@SQL +"'" +@fdate +"', "
	SET @@SQL = @@SQL +"'" +@tdate +"', "
	SET @@SQL = @@SQL +"'" +@fcode +"', "
	SET @@SQL = @@SQL +"'" +@tcode +"', "
	SET @@SQL = @@SQL +"'" +@strorder +"', "
	SET @@SQL = @@SQL +"'" +@selectby +"', "
	SET @@SQL = @@SQL +"'" +@statusid +"', "
	SET @@SQL = @@SQL +"'" +@statusname+"', "
	SET @@SQL = @@SQL +"'" +@strbranch +"'" 
		  --return


EXEC (@@SQL)

		IF @ORDERFLG = 'N'
		  BEGIN
			 UPDATE #TMPLEDGERNEW 
				SET EXCHANGE = @@EXCHANGE, 
					SEGMENT = @@SEGMENT,
	 				ENTITY = 'SETTLEMENT LEDGER',
					ORDERSEG = 1 
			 WHERE  SEGMENT IS NULL 
		END 
		ELSE 
			BEGIN
				UPDATE #TMPLEDGERNEW 
	 				SET		EXCHANGE = @@EXCHANGE,
							SEGMENT =@@SEGMENT,
							ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY'	THEN @@SEGMENT +"-"+ @@EXCHANGE ELSE @@GROUPID + ' - SETTLEMENT LEDGER' END,
	--IF @@ACCOUNTDB = 'ACCOUNT'
	--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 1"
	--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'
	--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 2"
	--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'
	--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 3"
							ORDERSEG = @@ORDERSEG 
				WHERE  SEGMENT IS NULL 
	END 

SET @@SQL = " 	INSERT INTO #TMPLEDGERNEW "
SET @@SQL = @@SQL +	" (BOOKTYPE, "
SET @@SQL = @@SQL +	"  VOUDT, "
SET @@SQL = @@SQL +	"  EFFDT, "
SET @@SQL = @@SQL +	"  SHORTDESC, "
SET @@SQL = @@SQL +	"  DRAMT, "
SET @@SQL = @@SQL +	"  CRAMT, "
SET @@SQL = @@SQL +	"  VNO, "
SET @@SQL = @@SQL +	"  DDNO, "
SET @@SQL = @@SQL +	"  NARRATION, "
SET @@SQL = @@SQL +	"  CLTCODE, "
SET @@SQL = @@SQL +	"  VTYP, "
SET @@SQL = @@SQL +	"  VDT, "
SET @@SQL = @@SQL +	"  EDT, "
SET @@SQL = @@SQL +	"  ACNAME, "
SET @@SQL = @@SQL +	"  OPBAL, "
SET @@SQL = @@SQL +	"  L_ADDRESS1, "
SET @@SQL = @@SQL +	"  L_ADDRESS2, "
SET @@SQL = @@SQL +	"  L_ADDRESS3, "
SET @@SQL = @@SQL +	"  L_CITY, "
SET @@SQL = @@SQL +	"  L_ZIP, "
SET @@SQL = @@SQL +	"  RES_PHONE1, "
SET @@SQL = @@SQL +	"  BRANCH_CD, "
SET @@SQL = @@SQL +	"  CROSAC, "
SET @@SQL = @@SQL +	"  EDIFF, "
SET @@SQL = @@SQL +	"  FAMILY, "
SET @@SQL = @@SQL +	"  SUB_BROKER, "
SET @@SQL = @@SQL +	"  TRADER, "
SET @@SQL = @@SQL +	"  CL_TYPE, "
SET @@SQL = @@SQL +	"  BANK_NAME, "
SET @@SQL = @@SQL +	"  CLTDPID, "
SET @@SQL = @@SQL +	"  LNO, "
SET @@SQL = @@SQL +	"  PDT) "
SET @@SQL = @@SQL +	"    EXEC "+@@ACCOUNTDB+"..RPT_ACC_MARGINLEDGER "
SET @@SQL = @@SQL +"'" +	@fdate +"', "
SET @@SQL = @@SQL +"'" +	@tdate +"', "
SET @@SQL = @@SQL +"'" +	@fcode +"', "
SET @@SQL = @@SQL +"'" +	@tcode +"', "
SET @@SQL = @@SQL +"'" +	@strorder +"', "
SET @@SQL = @@SQL +"'" +	@selectby +"', "
SET @@SQL = @@SQL +"'" +	@statusid +"', "
SET @@SQL = @@SQL +"'" +	@statusname +"', "
SET @@SQL = @@SQL +"'" +@strbranch+"'"  

EXEC (@@SQL)
    IF @orderflg = 'N'
      BEGIN
		UPDATE #TMPLEDGERNEW 
			SET   EXCHANGE =@@EXCHANGE,
			SEGMENT = @@SEGMENT ,
			ENTITY = 'MARGIN  LEDGER', 
			ORDERSEG = 2 
		WHERE SEGMENT IS NULL 
      END
    ELSE
      BEGIN
		UPDATE #TMPLEDGERNEW 
			SET    EXCHANGE = @@EXCHANGE,
			SEGMENT = @@SEGMENT,
			ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY'	THEN 'MARGIN-' + @@EXCHANGE ELSE @@GROUPID + ' - MARGIN LEDGER' END,
			--IF @@ACCOUNTDB = 'ACCOUNT'
			--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 4"
			--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'
			--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 5"
			--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'
			--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 6"
				
			ORDERSEG = @@ORDERSEG+ @@ORDERSECOUNT
		WHERE  SEGMENT IS NULL 
	END
	

FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB ,@@GROUPID, @@ORDERSEG   
END
CLOSE @@MAINREC
DEALLOCATE @@MAINREC

--IF ((SELECT COUNT(1) FROM [#DBNAME] WHERE ACCOUNTDB = 'ACCOUNTFO') = 1)
--BEGIN
--    INSERT INTO #TMPLEDGERNEW
--              (VOUDT,
--               EFFDT,
--               SHORTDESC,
--               DRAMT,
--               CRAMT,
--               VNO,
--               DDNO,
--               NARRATION,
--               CLTCODE,
--               VTYP,
--               VDT,
--               EDT)
--    EXEC NSEFO.DBO.V2_GETMARGINREQ
--      @TDATE ,
--      @FCODE ,
--      @TCODE ,
--		@STATUSID ,
--      @STATUSNAME ,
--      @STRBRANCH
 
      
--        UPDATE #TMPLEDGERNEW
--        SET    EXCHANGE = 'NSE',
--          SEGMENT = 'FUTURES',
--               ENTITY = 'MARGIN REQ - NFO',
--               ORDERSEG = (@@ORDERSECOUNT * 2)+ 1
--        WHERE  SEGMENT IS NULL
      
--END

    IF @orderflg = 'N'
      BEGIN
        SELECT   CLTCODE,
         EXCHANGE,
                 SEGMENT,
                 ORDERSEG,
                 OPBAL = MAX(OPBAL)
        INTO     #OPBAL
        FROM     #TMPLEDGERNEW
        GROUP BY CLTCODE,EXCHANGE,SEGMENT,ORDERSEG


        SELECT   CLTCODE,
                 ORDERSEG,
                 OPBAL = SUM(OPBAL)
        INTO     #FINOPBAL
        FROM     #OPBAL
        GROUP BY CLTCODE,ORDERSEG

        UPDATE #TMPLEDGERNEW
        SET    OPBAL = 0

        UPDATE #TMPLEDGERNEW
        SET    OPBAL = ISNULL(T.OPBAL,0)
        FROM   #TMPLEDGERNEW L WITH (NoLock),
               #FINOPBAL T WITH (NoLock)
        WHERE  
			L.CLTCODE = T.CLTCODE                     
			AND L.ORDERSEG = T.ORDERSEG
      END
      UPDATE #TMPLEDGERNEW SET ACTIVE_SEG = 'NSE,BSE,FNO,COMMODITY'

	DELETE FROM #TMPLEDGERNEW WHERE VTYP = 18 AND VNO IS NOT NULL
    IF @FORPDF = 'Y'
  BEGIN
   ALTER TABLE #TMPLEDGERNEW ADD PDFLINES INT
   UPDATE #TMPLEDGERNEW SET PDFLINES = LEN(LTRIM(RTRIM(ISNULL(NARRATION, '')))) / 35 + 1 WHERE VTYP <> '18'
   UPDATE #TMPLEDGERNEW SET PDFLINES = (I.LNO + 1) FROM (SELECT CLTCODE, LNO = SUM(PDFLINES) FROM #TMPLEDGERNEW GROUP BY CLTCODE) I
     WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE


   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = CEILING(CONVERT(NUMERIC(10,2), LEN(ISNULL(NARRATION, ''))) / 35)
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = 1 WHERE LEN(ISNULL(NARRATION, '')) = 0
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = (SELECT SUM(PARTYROWCOUNT) /*+ COUNT(DISTINCT ORDERSEG)*/ FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = PARTYROWCOUNT + (SELECT (COUNT(DISTINCT ORDERSEG) * 1) + 1 FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)
   UPDATE #TMPLEDGERNEW SET TOTALPAGES = .dbo.PARTYLEDGERPAGES(PARTYROWCOUNT)


  END
    IF @strorder = 'ACCODE'
      BEGIN
        IF @selectby = 'vdt'
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
				
                ORDER BY CLTCODE,
                         ORDERSEG,
                         VOUDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY CLTCODE,
                         ORDERSEG,
                         VOUDT
              END
          END
        ELSE
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY CLTCODE,
                         ORDERSEG,
                         EFFDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY CLTCODE,
                         ORDERSEG,
                         EFFDT
              END
          END
      END
  ELSE
	BEGIN
	IF @selectby = 'vdt'
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW T
                ORDER BY ACNAME,
                         ORDERSEG,
                         VOUDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY ACNAME,
                         ORDERSEG,
                         VOUDT
              END
          END
        ELSE
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY ACNAME,
                         ORDERSEG,
                         EFFDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY ACNAME,
                         ORDERSEG,
                         EFFDT
              END
          END
      END
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V3_LedgerBalance
-- --------------------------------------------------
CREATE Proc V3_LedgerBalance  
(  
 @fromcltCode varchar(15),  
 @tocltCode varchar(15)  
-- @currDate varchar(11)  
)  
  
as  
set nocount on  
declare @currDate  as varchar(11)  
set @currDate = convert(varchar(11),getdate())  
  
/*  
V2_LedgerBalance '0000000000','zzzzzzzzzz','Feb  2 2006'  
*/  
  
Declare @StartDate varchar(11)  
  
set transaction isolation level read uncommitted  
select   
 @StartDate = left(sdtcur,11)   
from   
 parameter (nolock)  
where   
 @currDate between sdtcur and ldtcur  
  
  
Set Transaction Isolation level Read Uncommitted  
Select   
 CltCode,   
 AcName   
into   
 #AcMast  
from   
 AcMast (nolock)  
where   
 cltcode >= @fromcltcode  
 and cltcode <= @tocltcode  
 and accat = '4'  
  
Create Clustered Index TempIDx on #Acmast(CltCode)  
  
set transaction isolation level read uncommitted  
  
truncate table Angel_TB  
  
insert into Angel_TB  
Select CltCode, AcName, BalAmt = sum(Case when Drcr = 'C' then -Vamt else Vamt end)  
--into angel_tb  
From  
(  
 select a.CltCode, a.AcName, l.DrCr, Vamt = sum(l.vamt)  
 from Ledger l (nolock), #AcMast a with(index(tempidx),nolock)  
 where l.cltcode = a.CltCode  
 and l.edt >= @StartDate  
 and l.edt <= @currDate + ' 23:59:00'  
 Group by a.CltCode, A.AcName, L.drcr  
) x  
group by CltCode, AcName   
  
drop table #AcMast  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ValanSumLedger
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 01/04/1980 1:40:44 AM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 29-Sep-01 8:12:08 PM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 8/8/01 1:37:34 PM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 8/7/01 6:03:54 PM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 7/8/01 3:22:52 PM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 2/17/01 3:34:19 PM ******/
/****** Object:  Stored Procedure dbo.ValanSumLedger    Script Date: 20-Mar-01 11:43:37 PM ******/
CREATE PROCEDURE ValanSumLedger  
@settnotype varchar(12)
AS
select isnull(sum(vamt),0), drcr
 from ledger l , ledger3 l3 
where l.cltcode not in('99990' ,'61310', '99985' ,'99988','100')and
 l3.narr like @settnotype  and
 l3.refno = substring(l.refno, 1, 7) 
group by drcr
 order by drcr

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vdtyearend
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Vdtyearend    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.Vdtyearend    Script Date: 03/27/2003 11:33:03 AM ******/
/****** Object:  Stored Procedure dbo.Vdtyearend    Script Date: 02/18/2003 10:26:56 AM ******/
CREATE Procedure Vdtyearend
@sdtcur varchar(11),
@ldtcur varchar(11),
@vtyp   smallint,
@vno varchar(12),
@BookType char(2),
@vdt    datetime,
@msg1   varchar(234)
AS
declare
@@cltcode as varchar(10),
@@acname  as varchar(35),
@@vdtbal  as money,
@@lno     as int,
@@cdt     as datetime,
@@netdiff as money,
@@plcount as int,
@@plbal   as money,
@@rcursor as cursor
select @@cdt = ( select getdate() )
set @@rcursor = cursor for
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)
from ledger l left outer join acmast a on l.cltcode = a.cltcode
where l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> '99999'
group by l.cltcode,l.acname
order by l.cltcode,l.acname
open @@rcursor
fetch next from @@rcursor 
into @@cltcode, @@acname, @@vdtbal
select @@lno = 0
select @@netdiff = 0
while @@fetch_status = 0
begin
   select @@lno = @@lno + 1
   select @@netdiff = @@netdiff + @@vdtbal
   Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,
                      EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration) 
               values (@vtyp,@vno,(case when @@vdtbal >= 0 then 'D' else 'C' end),isnull(abs(@@vdtbal),0),@vdt,'',upper(@@cltcode),
                       'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)
   Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType) 
                values(@@lno,@msg1,'',@vtyp,@vno,@BookType)
   fetch next from @@rcursor 
   into @@cltcode, @@acname, @@vdtbal
end
close @@rcursor
deallocate @@rcursor
select @@lno = @@lno + 1
select @@acname = ( select acname from acmast where cltcode = '99999')
Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,
                   EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration) 
            values (@vtyp,@vno,(case when @@netdiff >= 0 then 'C' else 'D' end),abs(@@netdiff),@vdt,'','99999',
                    'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)
Insert into ledger3
select lno, narration, refno, vtyp, vno, BookType
from ledger
where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode='99999'
Insert into ledger3
select 0, narration, refno, vtyp, vno, BookType
from ledger
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherPrintingSp
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 12/16/2003 12:59:32 PM ******/  
  
/* comm. narr replaced line narration  by amit requirment in mosl on 18/10/2002*/  
  
CREATE  Proc VoucherPrintingSp   
@Vtyp varchar(2),  
@BookTypeFrom varchar(2),  
@BookTypeTo varchar(2),  
@StartDate Varchar(11),  
@EndDate Varchar(11),  
@VnoFrom Varchar(12),  
@VnoTo Varchar(12),  
@VnoVdtFlag int,  
@Flag int  
as  
  
If @Flag = 0  
Begin  
   if @startdate = ''   
      begin  
/* Conditions of VNO only */  
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24   
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                     ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24   
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                        ELSE L.acname END ),0),    
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
     cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
    from ledger l ,LEDGER1 L1  
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype    
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
  order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
      end  
   else  
   if @Vnofrom = ''   
      begin  
         /* Conditions on Vdt only */  
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24    
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                    ELSE L.CLTCODE END ),0),   
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24   
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                       ELSE L.acname END ),0),    
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
    narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */  
  cnar = isnull(l.narration,'') ,  
  cltcode2 = cltcode, acname2 = acname  
    from ledger l ,LEDGER1 L1  
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'  
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype   
    and vdt <=@EndDate + ' 23:59:59'  
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno  
  
      end  
   else  
      begin  
         /* Conditions on Vdt and VNo */  
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24   
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                     ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24   
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                        ELSE L.acname END ),0),    
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
    from ledger l ,LEDGER1 L1  
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype    
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
/* Foll condition added by Kalpana on 19/09/2002 */  
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'  
    else 'Jan  1 1900' + ' 00:00:00'  
    end)   
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'  
    else getdate()  
    end)   
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
      end  
end  
Else If @Flag = 1  
Begin  
  if @startdate = ''   
     begin  
  /* Conditions of VNO only */  
  select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24   
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                     ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24   
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                       ELSE L.acname END ),0),    
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
     from ledger l   
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
  order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
     end  
 else  
 if @Vnofrom = ''   
     begin  
                /* Conditions on Vdt only */  
    
   select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24   
                     THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                      ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24   
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                         ELSE L.acname END ),0),    
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') , */  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
    from ledger l   
    where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'   
    and vdt <=@EndDate + ' 23:59:59'  
    order by l.vdt, l.vtyp, l.booktype, l.vno  
     End  
   Else   
          /* Conditions on Vdt and VNo */  
      Begin   
    select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24   
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                     ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24   
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                       ELSE L.acname END ),0),    
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
     from ledger l   
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
/* Foll condition added by Kalpana on 19/09/2002 */  
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'  
    else 'Jan  1 1900' + ' 00:00:00'  
    end)   
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'  
    else getdate()  
    end)   
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
      End    
End  
Else If @flag = 2  
Begin  
 if @startdate = ''   
  Begin  
  /* Conditions of VNO only */  
  select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
          ELSE L.CLTCODE END ),0),  
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)   
          ELSE L.acname END ),0),  
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),  
     narr = isnull(l.narration,'') ,  
     /* cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
                        cnar = isnull(l.narration,'') ,  
   cltcode2 = l.cltcode, acname2 = l.acname  
    from ledger l, acmast a  
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
  End   
    else  
 if @Vnofrom = ''   
     begin  
                /* Conditions on Vdt only */    
    select   CltCode = ISNULL((CASE WHEN a.accat = 14 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                    ELSE L.CLTCODE END ),0),  
     acname = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)   
           ELSE L.acname END ),0),  
    l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),  
    narr = isnull(l.narration,'') ,  
    /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
  cnar = isnull(l.narration,'') ,  
  cltcode2 = l.cltcode, acname2 = l.acname  
    from ledger l, acmast a  
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'   
    and vdt <=@EndDate + ' 23:59:59'  
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno  
  
      
  End   
  Else   
          /* Conditions on Vdt and VNo */  
  Begin  
    select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
          ELSE L.CLTCODE END ),0),  
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)   
          ELSE L.acname END ),0),  
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = l.cltcode, acname2 = l.acname  
    from ledger l, acmast a  
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
/* Foll condition added by Kalpana on 19/09/2002 */  
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'  
    else 'Jan  1 1900' + ' 00:00:00'  
    end)   
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'  
    else getdate()  
    end)   
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno  
  End   
  
End  
else if @flag = 3  
Begin  
   if @startdate = ''   
      begin  
/* Conditions of VNO only */  
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24   
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                     ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24   
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                        ELSE L.acname END ),0),    
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
    from ledger l ,LEDGER1 L1  
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype and l.lno = l1.lno  
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
  order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
      end  
   else  
   if @Vnofrom = ''   
      begin  
         /* Conditions on Vdt only */  
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24    
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                    ELSE L.CLTCODE END ),0),   
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24   
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                       ELSE L.acname END ),0),    
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
    narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */  
  cnar = isnull(l.narration,'') ,  
  cltcode2 = cltcode, acname2 = acname  
    from ledger l ,LEDGER1 L1  
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'  
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype  and l.lno = l1.lno  
    and vdt <=@EndDate + ' 23:59:59'  
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno  
  
      end  
   else  
      begin  
         /* Conditions on Vdt and VNo */  
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24   
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)   
                     ELSE L.CLTCODE END ),0),   
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24   
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)   
                        ELSE L.acname END ),0),    
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,  
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,  
     narr = isnull(l.narration,'') ,  
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/  
   cnar = isnull(l.narration,'') ,  
   cltcode2 = cltcode, acname2 = acname  
    from ledger l ,LEDGER1 L1  
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype   and l.lno = l1.lno  
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo   
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo   
/* Foll condition added by Kalpana on 19/09/2002 */  
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'  
    else 'Jan  1 1900' + ' 00:00:00'  
    end)   
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'  
    else getdate()  
    end)   
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.drcr desc, l.lno desc  
      end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherRePrintSp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.VoucherRePrintSp    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.VoucherRePrintSp    Script Date: 01/04/1980 1:40:44 AM ******/
CREATE PROCEDURE VoucherRePrintSp
@Vtyp varchar(2),
@BookTypeFrom varchar(2),
@BookTypeTo varchar(2),
@StartDate Varchar(11),
@EndDate Varchar(11),
@VnoFrom Varchar(12),
@VnoTo Varchar(12),
@VnoVdtFlag int
AS
If @VnoVdtFlag = 0 /* if voucher date */
Begin	
	select vtyp,vno,booktype,drcr,acname, cltcode,vamt,convert(varchar,vdt,103) vdt,
	narr = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno),'') ,
	cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0),'') 
	From Ledger l
	where Vtyp = @Vtyp and Booktype >= @BookTypeFrom and BookType <= @BookTypeTo
	and vdt >= @StartDate + ' 00:00:00' and vdt <= @EndDate + ' 23:59:59'
	order by vtyp,booktype,vno,lno
End
	
If @VnoVdtFlag = 1 /* if voucher number */
Begin
	
	select vtyp,vno,booktype,drcr,acname, cltcode,vamt,convert(varchar,vdt,103) vdt,
	narr = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = l.lno),'') ,
	cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0),'') 
	From Ledger l
	where Vtyp = @Vtyp and Booktype >= @BookTypeFrom and BookType <= @BookTypeTo	
	and Vno >= @VnoFrom + ' 00:00:00'  and Vno <= @VnoTo + ' 23:59:59'
	order by vtyp,vno,booktype,lno
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherTypeSelect
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.VoucherTypeSelect    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.VoucherTypeSelect    Script Date: 01/04/1980 1:40:44 AM ******/
/****** Object:  Stored Procedure dbo.VoucherTypeSelect    Script Date: 11/28/2001 12:23:53 PM ******/
/****** Object:  Stored Procedure dbo.VoucherTypeSelect    Script Date: 11/24/2001 10:30:11 AM ******/
Create Procedure VoucherTypeSelect 
As
Select vdesc,vtype  from vmast 
where dispflag not in ('X','M')
and  vtype not in ('16','17') 
order by vdesc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------
    
CREATE PROC Vw @VwName VARCHAR(25)AS                   
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND
-- --------------------------------------------------

CREATE PROC [dbo].[YEAREND]  
 @SDTCUR VARCHAR(11),  
 @LDTCUR VARCHAR(11),  
 @VTYP SMALLINT,  
 @VNO VARCHAR(12),  
 @BOOKTYPE VARCHAR(2),  
 @VDT VARCHAR(11),  
 @MSG1 VARCHAR(234),
 @PNL_CODE VARCHAR(10) = '99999'
AS  
/*  
select * from parameter
begin tran
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'  
 EXEC YEAREND 'APR  1 2009','MAR 31 2010', 18, '201004010001', '01', 'APR  1 2010', 'OPENING BALANCE'  
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'  
rollback
select top 10 * from ledger where vdt like 'apr  1 2009%'    and vtyp=18
*/  

 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
  
 CREATE TABLE #VDT  
 (  
  CLTCODE VARCHAR(10),  
  ACNAME VARCHAR(100),  
  DRCR VARCHAR(1),  
  BALANCE MONEY  
 )  
  
 INSERT INTO #VDT  
  (CLTCODE, ACNAME, DRCR, BALANCE)  
 SELECT  
  A.CLTCODE,  
  ACNAME = ISNULL(A.LONGNAME, ''),  
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,  
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))  
 FROM  
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
 WHERE  
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'  
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
  AND L.CLTCODE <> @PNL_CODE  
 GROUP BY  
  A.CLTCODE,  
  A.LONGNAME  
  
  
 CREATE TABLE #EDT  
 (  
  CLTCODE VARCHAR(10),  
  BALANCE MONEY  
 )  
  
 INSERT INTO #EDT  
  (CLTCODE, BALANCE)  
 SELECT  
  A.CLTCODE,  
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)  
 FROM  
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
 WHERE  
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')  
  AND L.CLTCODE <> @PNL_CODE  
 GROUP BY  
  A.CLTCODE  
  
  
 CREATE TABLE #LEDGER  
 (  
  VTYP SMALLINT,  
  VNO VARCHAR(12),  
  EDT DATETIME,  
  LNO INT IDENTITY(1,1),  
  ACNAME VARCHAR(100),  
  DRCR CHAR(1),  
  VAMT MONEY,  
  VDT DATETIME,  
  VNO1 VARCHAR(12),  
  REFNO CHAR(12),  
  BALAMT MONEY,  
  NODAYS INT,  
  CDT DATETIME,  
  CLTCODE VARCHAR(10),  
  BOOKTYPE VARCHAR(2),  
  ENTEREDBY VARCHAR(25),  
  PDT DATETIME,  
  CHECKEDBY VARCHAR(25),  
  ACTNODAYS INT,  
  NARRATION VARCHAR(234)  
 )  
  
INSERT INTO #LEDGER  
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)  
SELECT  
 VTYP = @VTYP,  
 VNO = @VNO,  
 EDT = @VDT,  
 ACNAME = V.ACNAME,  
 DRCR = V.DRCR,  
 VAMT = V.BALANCE,  
 VDT = @VDT,  
 VNO1 = @VNO,  
 REFNO = '',  
 BALAMT = ISNULL(E.BALANCE, 0),  
 NODAYS = 0,  
 CDT = GETDATE(),  
 V.CLTCODE,  
 BOOKTYPE = @BOOKTYPE,  
 ENTEREDBY = 'SYSTEM',  
 PDT = GETDATE(),  
 CHECKEDBY = 'SYSTEM',  
 ACTNODAYS = 0,  
 NARRATION = @MSG1  
FROM  
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE  
  
  
CREATE TABLE #PANDL  
(  
 VDTBAL MONEY,  
 EDTBAL MONEY  
)  
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER  
  
INSERT INTO #LEDGER  
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)  
SELECT  
 VTYP = @VTYP,  
 VNO = @VNO,  
 EDT = @VDT,  
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),  
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,  
 VAMT = ABS(VDTBAL),  
 VDT = @VDT,  
 VNO1 = @VNO,  
 REFNO = '',  
 BALAMT = EDTBAL,  
 NODAYS = 0,  
 CDT = GETDATE(),  
 A.CLTCODE,  
 BOOKTYPE = @BOOKTYPE,  
 ENTEREDBY = 'SYSTEM',  
 PDT = GETDATE(),  
 CHECKEDBY = 'SYSTEM',  
 ACTNODAYS = 0,  
 NARRATION = @MSG1  
FROM  
 #PANDL,  
 ACMAST A  
WHERE  
 A.CLTCODE = @PNL_CODE  
  
  
  
DROP TABLE #VDT  
DROP TABLE #EDT  
DROP TABLE #PANDL  
  
CREATE TABLE #MVDT  
(  
 PARTY_CODE VARCHAR(10),  
 MCLTCODE VARCHAR(10),  
 EXCHANGE VARCHAR(3),  
 SEGMENT VARCHAR(20),  
 DRCR VARCHAR(1),  
 AMOUNT MONEY  
)  
  
INSERT INTO #MVDT  
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)  
SELECT  
 PARTY_CODE,  
 MCLTCODE,  
 EXCHANGE,  
 SEGMENT,  
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,  
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
FROM  
 MARGINLEDGER  
WHERE  
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
GROUP BY  
 PARTY_CODE,  
 MCLTCODE,  
 EXCHANGE,  
 SEGMENT  
  
CREATE TABLE #MEDT  
(  
 PARTY_CODE VARCHAR(10),  
 MCLTCODE VARCHAR(10),  
 EXCHANGE VARCHAR(3),  
 SEGMENT VARCHAR(20),  
 AMOUNT MONEY  
)  
  
INSERT INTO #MEDT  
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)  
SELECT  
 M.PARTY_CODE,  
 M.MCLTCODE,  
 M.EXCHANGE,  
 M.SEGMENT,  
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)  
FROM  
 MARGINLEDGER M,  
 LEDGER L  
WHERE  
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO  
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
GROUP BY  
 M.PARTY_CODE,  
 M.MCLTCODE,  
 M.EXCHANGE,  
 M.SEGMENT  
  
CREATE TABLE #MARGINLEDGER  
(  
 VTYP SMALLINT,  
 VNO VARCHAR(12),  
 LNO INT,  
 DRCR VARCHAR(1),  
 VDT DATETIME,  
 AMOUNT MONEY,  
 PARTY_CODE VARCHAR(10),  
 EXCHANGE VARCHAR(3),  
 SEGMENT VARCHAR(20),  
 SETT_NO MONEY,  
 SETT_TYPE VARCHAR(3),  
 BOOKTYPE VARCHAR(2),  
 MCLTCODE VARCHAR(10)  
)  
  
INSERT INTO #MARGINLEDGER  
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)  
SELECT  
 VTYP = @VTYP,  
 VNO = @VNO,  
 DRCR = V.DRCR,  
 VDT = @VDT,  
 AMOUNT = ABS(V.AMOUNT),  
 PARTY_CODE = V.PARTY_CODE,  
 EXCHANGE = V.EXCHANGE,  
 SEGMENT = V.SEGMENT,  
 SETT_NO = ISNULL(E.AMOUNT, 0),  
 SETT_TYPE = '',  
 BOOKTYPE = @BOOKTYPE,  
 MCLTCODE = V.MCLTCODE  
FROM  
 #MVDT V LEFT OUTER JOIN #MEDT E ON  
  V.PARTY_CODE = E.PARTY_CODE  
  AND V.MCLTCODE = E.MCLTCODE  
  AND V.EXCHANGE = E.EXCHANGE  
  AND V.SEGMENT = E.SEGMENT  
  
UPDATE  
 H  
SET  
 LNO = L.LNO  
FROM  
 #MARGINLEDGER H,  
 #LEDGER L  
WHERE  
 H.MCLTCODE = L.CLTCODE  
  
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE  
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M  
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE  
DECLARE @ISDIFF INT  
SET @ISDIFF = 0  


SELECT  
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L  
WHERE  
 M.MCLTCODE = L.CLTCODE  
 AND M.BALANCE <> L.BALANCE  
  
IF @ISDIFF <> 0  
 BEGIN  
  DROP TABLE #LEDGER  
  DROP TABLE #MARGINLEDGER  
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'  
 END  
ELSE  
 BEGIN  
  INSERT INTO LEDGER SELECT * FROM #LEDGER  
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER  
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER  
  --EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE  
  DROP TABLE #LEDGER  
  DROP TABLE #MARGINLEDGER  
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_bak_03042010
-- --------------------------------------------------
  
 /*      
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18      
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'    
*/      
CREATE PROC YEAREND_bak_03042010
 @SDTCUR VARCHAR(11),      
 @LDTCUR VARCHAR(11),      
 @VTYP SMALLINT,      
 @VNO VARCHAR(12),      
 @BOOKTYPE VARCHAR(2),      
 @VDT VARCHAR(11),      
 @MSG1 VARCHAR(234),    
 @PNL_CODE VARCHAR(10) = '99999'    
AS      
/*      
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'      
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'      
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'      
       
*/      
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE      
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE      
      
 CREATE TABLE #VDT      
 (      
  CLTCODE VARCHAR(10),      
  ACNAME VARCHAR(100),      
  DRCR VARCHAR(1),      
  BALANCE MONEY      
 )      
      
 INSERT INTO #VDT      
  (CLTCODE, ACNAME, DRCR, BALANCE)      
 SELECT      
  A.CLTCODE,      
  ACNAME = ISNULL(A.LONGNAME, ''),      
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,      
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))      
 FROM      
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE      
 WHERE      
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'      
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE      
 GROUP BY      
  A.CLTCODE,      
  A.LONGNAME      
      
      
 CREATE TABLE #EDT      
 (      
  CLTCODE VARCHAR(10),      
  BALANCE MONEY      
 )      
      
 INSERT INTO #EDT      
  (CLTCODE, BALANCE)      
 SELECT      
  A.CLTCODE,      
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)      
 FROM      
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE      
 WHERE      
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'      
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE      
 GROUP BY      
  A.CLTCODE      
      
      
 CREATE TABLE #LEDGER      
 (      
  VTYP SMALLINT,      
  VNO VARCHAR(12),      
  EDT DATETIME,      
  LNO INT IDENTITY(1,1),      
  ACNAME VARCHAR(100),      
  DRCR CHAR(1),      
  VAMT MONEY,      
  VDT DATETIME,      
  VNO1 VARCHAR(12),      
  REFNO CHAR(12),      
  BALAMT MONEY,      
  NODAYS INT,      
  CDT DATETIME,      
  CLTCODE VARCHAR(10),      
  BOOKTYPE VARCHAR(2),      
  ENTEREDBY VARCHAR(25),      
  PDT DATETIME,      
  CHECKEDBY VARCHAR(25),      
  ACTNODAYS INT,      
  NARRATION VARCHAR(234)      
 )      
      
INSERT INTO #LEDGER      
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)      
SELECT      
 VTYP = @VTYP,      
 VNO = @VNO,      
 EDT = @VDT,      
 ACNAME = V.ACNAME,      
 DRCR = V.DRCR,      
 VAMT = V.BALANCE,      
 VDT = @VDT,      
 VNO1 = @VNO,      
 REFNO = '',      
 BALAMT = ISNULL(E.BALANCE, 0),      
 NODAYS = 0,      
 CDT = GETDATE(),      
 V.CLTCODE,      
 BOOKTYPE = @BOOKTYPE,      
 ENTEREDBY = 'SYSTEM',      
 PDT = GETDATE(),      
 CHECKEDBY = 'SYSTEM',      
 ACTNODAYS = 0,      
 NARRATION = @MSG1      
FROM      
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE      
      
      
CREATE TABLE #PANDL      
(      
 VDTBAL MONEY,      
 EDTBAL MONEY      
)      
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER      
      
INSERT INTO #LEDGER      
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)      
SELECT      
 VTYP = @VTYP,      
 VNO = @VNO,      
 EDT = @VDT,      
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),      
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,      
 VAMT = ABS(VDTBAL),      
 VDT = @VDT,      
 VNO1 = @VNO,      
 REFNO = '',      
 BALAMT = EDTBAL,      
 NODAYS = 0,      
 CDT = GETDATE(),      
 A.CLTCODE,      
 BOOKTYPE = @BOOKTYPE,      
 ENTEREDBY = 'SYSTEM',      
 PDT = GETDATE(),      
 CHECKEDBY = 'SYSTEM',      
 ACTNODAYS = 0,      
 NARRATION = @MSG1      
FROM      
 #PANDL,      
 ACMAST A      
WHERE      
 A.CLTCODE = @PNL_CODE      
      
      
      
DROP TABLE #VDT      
DROP TABLE #EDT      
DROP TABLE #PANDL      
      
CREATE TABLE #MVDT      
(      
 PARTY_CODE VARCHAR(10),      
 MCLTCODE VARCHAR(10),      
 EXCHANGE VARCHAR(3),      
 SEGMENT VARCHAR(20),      
 DRCR VARCHAR(1),      
 AMOUNT MONEY      
)      
      
INSERT INTO #MVDT      
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)      
SELECT      
 PARTY_CODE,      
 MCLTCODE,      
 EXCHANGE,      
 SEGMENT,      
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,      
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)      
FROM      
 MARGINLEDGER      
WHERE      
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'      
GROUP BY      
 PARTY_CODE,      
 MCLTCODE,      
 EXCHANGE,      
 SEGMENT      
      
CREATE TABLE #MEDT      
(      
 PARTY_CODE VARCHAR(10),      
 MCLTCODE VARCHAR(10),      
 EXCHANGE VARCHAR(3),      
 SEGMENT VARCHAR(20),      
 AMOUNT MONEY      
)      
      
INSERT INTO #MEDT      
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)      
SELECT      
 M.PARTY_CODE,      
 M.MCLTCODE,      
 M.EXCHANGE,      
 M.SEGMENT,      
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)      
FROM      
 MARGINLEDGER M,      
 LEDGER L      
WHERE      
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO      
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'      
GROUP BY      
 M.PARTY_CODE,      
 M.MCLTCODE,      
 M.EXCHANGE,      
 M.SEGMENT      
      
CREATE TABLE #MARGINLEDGER      
(      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 LNO INT,      
 DRCR VARCHAR(1),      
 VDT DATETIME,      
 AMOUNT MONEY,      
 PARTY_CODE VARCHAR(10),      
 EXCHANGE VARCHAR(3),      
 SEGMENT VARCHAR(20),      
 SETT_NO MONEY,      
 SETT_TYPE VARCHAR(3),      
 BOOKTYPE VARCHAR(2),      
 MCLTCODE VARCHAR(10)      
)      
      
INSERT INTO #MARGINLEDGER      
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)      
SELECT      
 VTYP = @VTYP,      
 VNO = @VNO,      
 DRCR = V.DRCR,      
 VDT = @VDT,      
 AMOUNT = ABS(V.AMOUNT),      
 PARTY_CODE = V.PARTY_CODE,      
 EXCHANGE = V.EXCHANGE,      
 SEGMENT = V.SEGMENT,      
 SETT_NO = ISNULL(E.AMOUNT, 0),      
 SETT_TYPE = '',      
 BOOKTYPE = @BOOKTYPE,      
 MCLTCODE = V.MCLTCODE      
FROM      
 #MVDT V LEFT OUTER JOIN #MEDT E ON      
  V.PARTY_CODE = E.PARTY_CODE      
  AND V.MCLTCODE = E.MCLTCODE      
  AND V.EXCHANGE = E.EXCHANGE      
  AND V.SEGMENT = E.SEGMENT      
      
UPDATE      
 H      
SET      
 LNO = L.LNO      
FROM      
 #MARGINLEDGER H,      
 #LEDGER L      
WHERE      
 H.MCLTCODE = L.CLTCODE      
      
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE      
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M      
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE      
DECLARE @ISDIFF INT      
SET @ISDIFF = 0      
SELECT      
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L      
WHERE      
 M.MCLTCODE = L.CLTCODE      
 AND M.BALANCE <> L.BALANCE      
      
/*IF @ISDIFF <> 0      
 BEGIN      
  DROP TABLE #LEDGER      
  DROP TABLE #MARGINLEDGER      
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'      
 END      
ELSE      
 BEGIN  */    
  INSERT INTO LEDGER SELECT * FROM #LEDGER      
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER      
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER      
  EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE      
  DROP TABLE #LEDGER      
  DROP TABLE #MARGINLEDGER      
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'      
-- END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_VARIFICATION
-- --------------------------------------------------
 CREATE  PROC YEAREND_VARIFICATION  
 @MSG1 VARCHAR(234)='OPENING BALANCE',    
 @PNL_CODE VARCHAR(10) = '999999'     
AS    
  
DECLARE   
@@VNO  VARCHAR(12),  
@@SDTCURNEW VARCHAR(11),      
@@LDTCURNEW VARCHAR(11),  
@@SDTCUROLD VARCHAR(11),      
@@LDTCUROLD VARCHAR(11),  
@@MAXSDT  VARCHAR(11),  
@@BRFLAG INT   
  
--SELECT DISTINCT @@VNO=VNO FROM LEDGER WHERE  VDT like @VDT +'%' AND VTYP=18  
PRINT  @@VNO  
    
SELECT @@SDTCURNEW=SDTCUR,@@LDTCURNEW=LDTCUR FROM PARAMETER WHERE CURYEAR=1   
  
SELECT @@MAXSDT=MAX(SDTCUR) FROM PARAMETER WHERE CURYEAR<>1  
  
SELECT @@VNO=VNO FROM LEDGER WHERE VDT LIKE @@SDTCURNEW +'%' AND VTYP=18  
  
SELECT @@SDTCUROLD=SDTCUR ,@@LDTCUROLD=LDTCUR FROM PARAMETER WHERE SDTCUR LIKE @@MAXSDT +'%'   
  
SELECT @@BRFLAG=BRANCHFLAG FROM PARAMETER WHERE BRANCHFLAG=1  
  
  
PRINT @@SDTCURNEW  
PRINT @@MAXSDT  
PRINT @@VNO  
PRINT @@SDTCUROLD  
  
  
 SELECT 'LEDGER BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
  
IF @@BRFLAG = 1  
PRINT 'VIN'   
BEGIN     
 SELECT 'BRANCHWISE BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L    
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L     
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
END  
    
 SELECT 'PROFIT AND LOSS MISMATCH', 0    
 UNION ALL    
 SELECT 'AMOUNT_MISMATCH', SUM(AMOUNT) FROM    
 (    
  SELECT AMOUNT = SUM(AMOUNT) FROM    
  (SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND (A.ACTYP LIKE 'INCO%' OR A.ACTYP LIKE 'EXP%')      
   UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND L.CLTCODE = @PNL_CODE    
  ) L1    
  UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND L.CLTCODE = @PNL_CODE    
 ) L    
  
 SELECT 'LEDGER AND LEDGER2 MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE    
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE    
  WHERE L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
    
 SELECT 'COSTCODEWISE AMOUNT MISMATCH', 0    
 UNION ALL    
 SELECT CONVERT(VARCHAR, COSTCODE), SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
 FROM LEDGER2    
 WHERE VNO = @@VNO AND VTYPE = '18' AND BOOKTYPE = '01'    
 GROUP BY CONVERT(VARCHAR, COSTCODE)    
 HAVING SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) <> 0    
  
SELECT 'MARGINLEDGER AMOUNT MISMATCH', 0 ,'',0   
UNION ALL  
SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
FROM MARGINLEDGER M, LEDGER L   
WHERE M.MCLTCODE=L.CLTCODE  
AND AMOUNT<>VAMT  
AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
GROUP BY MCLTCODE,CLTCODE  
  
   
SELECT 'MISMATCH BETWEEN MARGINLEDGER AND LEDGER AMOUNT', 0   
UNION ALL  
 SELECT CLTCODE, SUM(AMOUNT) FROM  (  
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
 GROUP BY MCLTCODE,CLTCODE  
UNION ALL   
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VTYP='18' AND M.VNO LIKE @@VNO + '%'  
 GROUP BY MCLTCODE,CLTCODE  
 )M  
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YearlyAccBal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.YearlyAccBal    Script Date: 1/17/2004 11:39:08 PM ******/

/****** Object:  Stored Procedure dbo.YearlyAccBal    Script Date: 01/04/1980 1:40:44 AM ******/
/****** Object:  Stored Procedure dbo.YearlyAccBal    Script Date: 10/15/2001 7:36:16 AM ******/
CREATE Procedure YearlyAccBal
@sdtcur datetime,
@ldtcur datetime,
@flag int
AS
if @flag = 1 
begin
	select l.cltcode,l.acname ,debit = sum(debit),credit = sum(credit)
	from partydrcrview l,acmast a
	where l.cltcode = a.cltcode and 
	(a.actyp = 'ASSET' or a.actyp = 'LIABILITY')
	and l.vdt > = @sdtcur and l.vdt <= @ldtcur
	group by l.cltcode,l.acname
	order by l.acname,l.cltcode
end
if @flag = 2
begin
	select l.cltcode,l.acname ,debit = sum(debit),credit = sum(credit)
	from partydrcrview l,acmast a
	where l.cltcode = a.cltcode and 
	(a.actyp = 'EXPENSES' )
	and l.vdt > = @sdtcur and l.vdt <= @ldtcur
	group by l.cltcode,l.acname
	order by l.acname,l.cltcode
end
if @flag = 3
begin
	select l.cltcode,l.acname ,debit = sum(debit),credit = sum(credit)
	from partydrcrview l,acmast a
	where l.cltcode = a.cltcode and 
	(a.actyp = 'INCOME' )
	and l.vdt > = @sdtcur and l.vdt <= @ldtcur
	group by l.cltcode,l.acname
	order by l.acname,l.cltcode
end

GO

-- --------------------------------------------------
-- TABLE dbo.abillmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[abillmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [balamt] MONEY NULL,
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Branch] CHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AccBill
-- --------------------------------------------------
CREATE TABLE [dbo].[AccBill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(12) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [BranchCd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.accbilldrcrview
-- --------------------------------------------------
CREATE TABLE [dbo].[accbilldrcrview]
(
    [sett_no] VARCHAR(12) NOT NULL,
    [sett_type] VARCHAR(2) NOT NULL,
    [sell_buy] VARCHAR(2) NOT NULL,
    [totalamount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acctmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Acctmast]
(
    [ACCT_CODE] NVARCHAR(9) NULL,
    [ACCT_NAME] NVARCHAR(30) NULL,
    [PRE_BAL] FLOAT NULL,
    [CUR_BAL] FLOAT NULL,
    [ACCT_TYPE] NVARCHAR(1) NULL,
    [ADDR1] NVARCHAR(30) NULL,
    [ADDR2] NVARCHAR(30) NULL,
    [ADDR3] NVARCHAR(30) NULL,
    [ADDR4] NVARCHAR(30) NULL,
    [TELEPHONE1] NVARCHAR(13) NULL,
    [TELEPHONE2] NVARCHAR(13) NULL,
    [TELEX] NVARCHAR(15) NULL,
    [FAX] NVARCHAR(15) NULL,
    [GROUP_CODE] NVARCHAR(5) NULL,
    [SBROKERAGE] FLOAT NULL,
    [CLASS] NVARCHAR(1) NULL,
    [EXCHANGE] NVARCHAR(3) NULL,
    [SUB_BROKER] NVARCHAR(5) NULL,
    [INTRODUCER] NVARCHAR(5) NULL,
    [INTRO_NAME] NVARCHAR(30) NULL,
    [RBROK_PER] FLOAT NULL,
    [RBROK_MIN] FLOAT NULL,
    [COBROK_PER] FLOAT NULL,
    [COBROK_MIN] FLOAT NULL,
    [PPRM_PER] FLOAT NULL,
    [SPRM_PER] FLOAT NULL,
    [ORD_COVER] FLOAT NULL,
    [ORD_EXPLOT] FLOAT NULL,
    [SCR_MARGIN] NVARCHAR(1) NULL,
    [OUTLET] NVARCHAR(5) NULL,
    [ENT_CLASS] NVARCHAR(1) NULL,
    [FIRST_TRAN] SMALLDATETIME NULL,
    [LAST_TRAN] SMALLDATETIME NULL,
    [BG_STAMP] NVARCHAR(19) NULL,
    [PUR_PRM] FLOAT NULL,
    [SALE_PRM] FLOAT NULL,
    [DOC_CREDIT] FLOAT NULL,
    [RRM] FLOAT NULL,
    [NPL] FLOAT NULL,
    [TRD_MARGIN] FLOAT NULL,
    [BD_INPRM] FLOAT NULL,
    [BD_OUTPRM] FLOAT NULL,
    [SCR_VALUE] FLOAT NULL,
    [BY_PASSER] NVARCHAR(1) NULL,
    [VOLUME] NVARCHAR(2) NULL,
    [ORD_LIMIT] FLOAT NULL,
    [PAY_LIMIT] FLOAT NULL,
    [LENDER] NVARCHAR(1) NULL,
    [CUSTODIAL] NVARCHAR(1) NULL,
    [PRIORITY] NVARCHAR(1) NULL,
    [NET_CLIENT] NVARCHAR(1) NULL,
    [LBROKERAGE] FLOAT NULL,
    [LBROK_MIN] FLOAT NULL,
    [SUB_BROK] FLOAT NULL,
    [MANAGER] NVARCHAR(5) NULL,
    [BROK_STAT] NVARCHAR(1) NULL,
    [GROUP_CAT] NVARCHAR(1) NULL,
    [SET_BAL] FLOAT NULL,
    [TRNPRE_BAL] FLOAT NULL,
    [TRNCUR_BAL] FLOAT NULL,
    [SUB_NAME] NVARCHAR(30) NULL,
    [DELAY_BAL] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast]
(
    [acname] VARCHAR(100) NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] VARCHAR(10) NULL,
    [branchcode] VARCHAR(10) NULL,
    [BtoBPayment] INT NULL,
    [PayMode] CHAR(1) NULL,
    [POBankName] VARCHAR(50) NULL,
    [POBranch] VARCHAR(25) NULL,
    [POBankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_details
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_details]
(
    [CLTCODE] VARCHAR(10) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [INACTIVE_FLAG] CHAR(1) NULL,
    [MAPPING_GL] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMASTCLTCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMASTCLTCODE]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMASTDEFAULT
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMASTDEFAULT]
(
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [branchcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ageinglist
-- --------------------------------------------------
CREATE TABLE [dbo].[ageinglist]
(
    [cltcode] VARCHAR(10) NULL,
    [balance] MONEY NULL,
    [agedays] INT NULL,
    [drcr] VARCHAR(1) NULL,
    [sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angel_BANK_Accno
-- --------------------------------------------------
CREATE TABLE [dbo].[angel_BANK_Accno]
(
    [accno] VARCHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Angel_client_deposit_recno
-- --------------------------------------------------
CREATE TABLE [dbo].[Angel_client_deposit_recno]
(
    [accno] VARCHAR(10) NOT NULL,
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NULL,
    [vno] VARCHAR(12) NULL,
    [vdt] DATETIME NULL,
    [tdate] VARCHAR(30) NULL,
    [ddno] VARCHAR(15) NOT NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NOT NULL,
    [drcr] CHAR(1) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [treldt] VARCHAR(30) NOT NULL,
    [refno] CHAR(12) NULL,
    [last_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Angel_TB
-- --------------------------------------------------
CREATE TABLE [dbo].[Angel_TB]
(
    [CltCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(100) NULL,
    [BalAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angel_temp_mis
-- --------------------------------------------------
CREATE TABLE [dbo].[angel_temp_mis]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [PUNE] MONEY NOT NULL,
    [RAJS] MONEY NOT NULL,
    [XO] MONEY NOT NULL,
    [WRNGL] MONEY NOT NULL,
    [HYD] MONEY NOT NULL,
    [KTPLY] MONEY NOT NULL,
    [ERODE] MONEY NOT NULL,
    [CMBTR] MONEY NOT NULL,
    [SALEM] MONEY NOT NULL,
    [TRPUR] MONEY NOT NULL,
    [MDURI] MONEY NOT NULL,
    [KOLGP] MONEY NOT NULL,
    [KOLK] MONEY NOT NULL,
    [KOLK1] MONEY NOT NULL,
    [KOLNS] MONEY NOT NULL,
    [KOLPA] MONEY NOT NULL,
    [KOLSL] MONEY NOT NULL,
    [JYNG] MONEY NOT NULL,
    [HBLI] MONEY NOT NULL,
    [BNG] MONEY NOT NULL,
    [MYSOR] MONEY NOT NULL,
    [COHIN] MONEY NOT NULL,
    [BHL] MONEY NOT NULL,
    [INDO] MONEY NOT NULL,
    [INDO1] MONEY NOT NULL,
    [INDO2] MONEY NOT NULL,
    [YI] MONEY NOT NULL,
    [XPU] MONEY NOT NULL,
    [XPU1] MONEY NOT NULL,
    [XPU2] MONEY NOT NULL,
    [KLHPR] MONEY NOT NULL,
    [JLG] MONEY NOT NULL,
    [ARBAD] MONEY NOT NULL,
    [AUNDH] MONEY NOT NULL,
    [NAKC] MONEY NOT NULL,
    [NASHIK] MONEY NOT NULL,
    [NASIK] MONEY NOT NULL,
    [NAGPR] MONEY NOT NULL,
    [NERUL] MONEY NOT NULL,
    [NVASHI] MONEY NOT NULL,
    [MUMRO1] MONEY NOT NULL,
    [MUMRO2] MONEY NOT NULL,
    [MALAD] MONEY NOT NULL,
    [MASJID] MONEY NOT NULL,
    [TVLG] MONEY NOT NULL,
    [VASHI] MONEY NOT NULL,
    [TB] MONEY NOT NULL,
    [THN] MONEY NOT NULL,
    [WDLA] MONEY NOT NULL,
    [PTN] MONEY NOT NULL,
    [PLOANS] MONEY NOT NULL,
    [PMOS] MONEY NOT NULL,
    [POWAI] MONEY NOT NULL,
    [RBTRG] MONEY NOT NULL,
    [SION] MONEY NOT NULL,
    [BAN] MONEY NOT NULL,
    [BVI] MONEY NOT NULL,
    [BVIN] MONEY NOT NULL,
    [ACBPL] MONEY NOT NULL,
    [ACM] MONEY NOT NULL,
    [ADHRE] MONEY NOT NULL,
    [AGOLD] MONEY NOT NULL,
    [CALNT] MONEY NOT NULL,
    [CGT] MONEY NOT NULL,
    [CMBUR] MONEY NOT NULL,
    [DISTR] MONEY NOT NULL,
    [HO] MONEY NOT NULL,
    [KAND] MONEY NOT NULL,
    [LKDL] MONEY NOT NULL,
    [INSUR] MONEY NOT NULL,
    [IPO] MONEY NOT NULL,
    [XPU3] MONEY NOT NULL,
    [XR] MONEY NOT NULL,
    [XB] MONEY NOT NULL,
    [XC] MONEY NOT NULL,
    [XD] MONEY NOT NULL,
    [XE] MONEY NOT NULL,
    [XF] MONEY NOT NULL,
    [XG] MONEY NOT NULL,
    [XH] MONEY NOT NULL,
    [XI] MONEY NOT NULL,
    [XJ] MONEY NOT NULL,
    [XM] MONEY NOT NULL,
    [XN] MONEY NOT NULL,
    [YV] MONEY NOT NULL,
    [YZ] MONEY NOT NULL,
    [YB] MONEY NOT NULL,
    [XV] MONEY NOT NULL,
    [YD] MONEY NOT NULL,
    [GRGN] MONEY NOT NULL,
    [FRBAD] MONEY NOT NULL,
    [GJIBD] MONEY NOT NULL,
    [JLNDR] MONEY NOT NULL,
    [DARKA] MONEY NOT NULL,
    [DELCP] MONEY NOT NULL,
    [DELHI] MONEY NOT NULL,
    [DELL] MONEY NOT NULL,
    [DELP] MONEY NOT NULL,
    [DELRSO] MONEY NOT NULL,
    [SPNR] MONEY NOT NULL,
    [SRITA] MONEY NOT NULL,
    [ROHNI] MONEY NOT NULL,
    [PTM] MONEY NOT NULL,
    [NEHRU] MONEY NOT NULL,
    [VSANT] MONEY NOT NULL,
    [MLVYA] MONEY NOT NULL,
    [MYVR] MONEY NOT NULL,
    [NOIDA] MONEY NOT NULL,
    [PALP] MONEY NOT NULL,
    [PATAN] MONEY NOT NULL,
    [NDD] MONEY NOT NULL,
    [MESA] MONEY NOT NULL,
    [XA] MONEY NOT NULL,
    [VD] MONEY NOT NULL,
    [SSH] MONEY NOT NULL,
    [DEESA] MONEY NOT NULL,
    [EBZ] MONEY NOT NULL,
    [CNDN] MONEY NOT NULL,
    [AHD] MONEY NOT NULL,
    [ANAND] MONEY NOT NULL,
    [GDHI] MONEY NOT NULL,
    [HIMT] MONEY NOT NULL,
    [YA] MONEY NOT NULL,
    [YA1] MONEY NOT NULL,
    [YA2] MONEY NOT NULL,
    [YA3] MONEY NOT NULL,
    [YAEBG] MONEY NOT NULL,
    [YAINS] MONEY NOT NULL,
    [YAK6] MONEY NOT NULL,
    [YAM5] MONEY NOT NULL,
    [YAMF] MONEY NOT NULL,
    [YAR4] MONEY NOT NULL,
    [YAS7] MONEY NOT NULL,
    [LUDHN] MONEY NOT NULL,
    [AMRTS] MONEY NOT NULL,
    [CHNDI] MONEY NOT NULL,
    [BKNER] MONEY NOT NULL,
    [AJMER] MONEY NOT NULL,
    [ALWAR] MONEY NOT NULL,
    [BHIL] MONEY NOT NULL,
    [JODH] MONEY NOT NULL,
    [KOTA] MONEY NOT NULL,
    [JAIP] MONEY NOT NULL,
    [UDAY] MONEY NOT NULL,
    [RJPR] MONEY NOT NULL,
    [MNSVR] MONEY NOT NULL,
    [NAGUR] MONEY NOT NULL,
    [PBR] MONEY NOT NULL,
    [PBRG] MONEY NOT NULL,
    [RAJ] MONEY NOT NULL,
    [RAJ1] MONEY NOT NULL,
    [RAJ2] MONEY NOT NULL,
    [RAJ3] MONEY NOT NULL,
    [RAJ4] MONEY NOT NULL,
    [RAJC] MONEY NOT NULL,
    [RAJEB] MONEY NOT NULL,
    [RAJN] MONEY NOT NULL,
    [RAJOB] MONEY NOT NULL,
    [RAJRR] MONEY NOT NULL,
    [SDRN] MONEY NOT NULL,
    [SVB] MONEY NOT NULL,
    [RRO] MONEY NOT NULL,
    [RAJW] MONEY NOT NULL,
    [RAPCG] MONEY NOT NULL,
    [JAM1] MONEY NOT NULL,
    [JAMB] MONEY NOT NULL,
    [JAMC] MONEY NOT NULL,
    [JAMK] MONEY NOT NULL,
    [GRR] MONEY NOT NULL,
    [GDHAM] MONEY NOT NULL,
    [JND] MONEY NOT NULL,
    [KESHD] MONEY NOT NULL,
    [ARL] MONEY NOT NULL,
    [BVN] MONEY NOT NULL,
    [BVNS] MONEY NOT NULL,
    [SEBD] MONEY NOT NULL,
    [VWD] MONEY NOT NULL,
    [MNGLR] MONEY NOT NULL,
    [VLSD] MONEY NOT NULL,
    [VP] MONEY NOT NULL,
    [SVEB] MONEY NOT NULL,
    [ANK] MONEY NOT NULL,
    [XS] MONEY NOT NULL,
    [XS1] MONEY NOT NULL,
    [XS2] MONEY NOT NULL,
    [XS3] MONEY NOT NULL,
    [XS4] MONEY NOT NULL,
    [XSPCG1] MONEY NOT NULL,
    [CHEN] MONEY NOT NULL,
    [AGRA] MONEY NOT NULL,
    [KNPR] MONEY NOT NULL,
    [LUCK] MONEY NOT NULL,
    [VRNS] MONEY NOT NULL,
    [MRT] MONEY NOT NULL,
    [VKPT] MONEY NOT NULL,
    [RJHMY] MONEY NOT NULL,
    [GJWK] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.asset
-- --------------------------------------------------
CREATE TABLE [dbo].[asset]
(
    [grpcode] VARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Audit_ACMAST_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[Audit_ACMAST_TRG]
(
    [AuditID] INT IDENTITY(1,1) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] VARCHAR(10) NULL,
    [branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [UserName] VARCHAR(128) NULL,
    [COMP_NAME] VARCHAR(200) NULL,
    [UpdateDate] DATETIME NULL DEFAULT (getdate()),
    [DBACTION] VARCHAR(15) NULL,
    [APPLICATION] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Audit_LASTVNO_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[Audit_LASTVNO_TRG]
(
    [AuditID] INT IDENTITY(1,1) NOT NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [VDT] DATETIME NULL,
    [LASTVNO] VARCHAR(12) NULL,
    [UserName] VARCHAR(128) NULL,
    [COMP_NAME] VARCHAR(200) NULL,
    [UpdateDate] DATETIME NULL DEFAULT (getdate()),
    [DBACTION] VARCHAR(15) NULL,
    [APPLICATION] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.baddebt
-- --------------------------------------------------
CREATE TABLE [dbo].[baddebt]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKDETAILS_FINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKDETAILS_FINAL]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.banklocat
-- --------------------------------------------------
CREATE TABLE [dbo].[banklocat]
(
    [Cheque] VARCHAR(10) NULL,
    [Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[BankMaster]
(
    [BankName] VARCHAR(35) NULL,
    [BankCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankReco
-- --------------------------------------------------
CREATE TABLE [dbo].[BankReco]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(30) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL,
    [CrossReferenceNo] INT NULL,
    [Status] VARCHAR(9) NULL,
    [MicrNo] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SrNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco_Log]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco_Partial_MAP
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco_Partial_MAP]
(
    [Cltcode] VARCHAR(10) NULL,
    [PARTYCODE] VARCHAR(10) NULL,
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Valuedate] DATETIME NULL,
    [VDT] DATETIME NULL,
    [Amt] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [DDNO] VARCHAR(15) NULL,
    [DDDT] DATETIME NULL,
    [Crossreferenceno] INT NULL,
    [BR_SNo] BIGINT NULL,
    [L1_SrNo] BIGINT NULL,
    [Uname] VARCHAR(25) NULL,
    [Entry_Date] DATETIME NULL,
    [RELDT] DATETIME NULL,
    [MAP_SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankRecoTemp
-- --------------------------------------------------
CREATE TABLE [dbo].[BankRecoTemp]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(30) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL,
    [CrossReferenceNo] VARCHAR(20) NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(15) NULL,
    [Dummy2] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankRef
-- --------------------------------------------------
CREATE TABLE [dbo].[BankRef]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [refno] CHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Billdifftable
-- --------------------------------------------------
CREATE TABLE [dbo].[Billdifftable]
(
    [exchange] VARCHAR(3) NULL,
    [type] VARCHAR(1) NULL,
    [sett_no] VARCHAR(7) NULL,
    [debit] MONEY NULL,
    [credit] MONEY NULL,
    [diff] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLLOG]
(
    [GENNO] VARCHAR(50) NULL,
    [STARTTIME] DATETIME NULL,
    [ENDTIME] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [USERNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillMatch
-- --------------------------------------------------
CREATE TABLE [dbo].[BillMatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(12) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [balamt] MONEY NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Branch] VARCHAR(10) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.billmatchlog
-- --------------------------------------------------
CREATE TABLE [dbo].[billmatchlog]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(12) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [AmountMatched] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [booktype] CHAR(2) NULL,
    [Branch] VARCHAR(10) NULL,
    [lvtype] SMALLINT NULL,
    [lvno] DECIMAL(12, 0) NULL,
    [lbooktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillPosted
-- --------------------------------------------------
CREATE TABLE [dbo].[BillPosted]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPOSTED_030520016
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPOSTED_030520016]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPROCESS]
(
    [IN_PROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.billview
-- --------------------------------------------------
CREATE TABLE [dbo].[billview]
(
    [BillNo] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [shortname] VARCHAR(21) NOT NULL,
    [short_name] VARCHAR(20) NOT NULL,
    [Tradeqty] INT NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Sell_buy] INT NOT NULL,
    [Brokapplied] MONEY NOT NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [NBrokApp] MONEY NOT NULL,
    [NetRate] DECIMAL(15, 7) NOT NULL,
    [sett_type] VARCHAR(3) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [NSerTax] MONEY NOT NULL,
    [start_date] SMALLDATETIME NULL,
    [end_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bledger
-- --------------------------------------------------
CREATE TABLE [dbo].[bledger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(35) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] DECIMAL(18, 0) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BookType
-- --------------------------------------------------
CREATE TABLE [dbo].[BookType]
(
    [vtyp] INT NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.booktypes
-- --------------------------------------------------
CREATE TABLE [dbo].[booktypes]
(
    [Col001] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchAccounts
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchAccounts]
(
    [BranchName] VARCHAR(10) NOT NULL,
    [BrControlAc] VARCHAR(10) NOT NULL,
    [MainControlAc] VARCHAR(10) NOT NULL,
    [DefaultAc] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchBalance]
(
    [acname] VARCHAR(35) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [vdt] DATETIME NULL,
    [debit] MONEY NULL,
    [credit] MONEY NULL,
    [costcode] SMALLINT NULL,
    [costname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchwiseclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[branchwiseclbal]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [costcode] INT NULL,
    [balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bseled
-- --------------------------------------------------
CREATE TABLE [dbo].[bseled]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [Vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CAL_DATES
-- --------------------------------------------------
CREATE TABLE [dbo].[CAL_DATES]
(
    [CAL_DATES] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.canbnkdtls
-- --------------------------------------------------
CREATE TABLE [dbo].[canbnkdtls]
(
    [acname] VARCHAR(35) NULL,
    [refno] CHAR(12) NULL,
    [dacname] VARCHAR(35) NULL,
    [drefno] CHAR(12) NOT NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dddt] DATETIME NULL,
    [relamt] MONEY NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cancelchq
-- --------------------------------------------------
CREATE TABLE [dbo].[cancelchq]
(
    [booktype] CHAR(2) NULL,
    [vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Category
-- --------------------------------------------------
CREATE TABLE [dbo].[Category]
(
    [CATEGORY] CHAR(35) NOT NULL,
    [CATCODE] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.catmast
-- --------------------------------------------------
CREATE TABLE [dbo].[catmast]
(
    [accat] CHAR(10) NOT NULL,
    [catname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ccmast
-- --------------------------------------------------
CREATE TABLE [dbo].[ccmast]
(
    [ccname] CHAR(35) NOT NULL,
    [cccode] CHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CheckDrCrLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[CheckDrCrLedger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [cramt] MONEY NULL,
    [dramt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CheckLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[CheckLedger]
(
    [Pamt] MONEY NULL,
    [Samt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ChequeFlag
-- --------------------------------------------------
CREATE TABLE [dbo].[ChequeFlag]
(
    [Processing] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ChequeFormats
-- --------------------------------------------------
CREATE TABLE [dbo].[ChequeFormats]
(
    [BankStyle] VARCHAR(50) NOT NULL,
    [FormatCode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientsMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientsMargin]
(
    [Acname] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Exchange] VARCHAR(50) NULL,
    [Segment] VARCHAR(50) NULL,
    [MCltcode] VARCHAR(10) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientsMarginView
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientsMarginView]
(
    [mcltcode] VARCHAR(10) NULL,
    [amt] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLOSNSE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLOSNSE]
(
    [Acname] NVARCHAR(255) NULL,
    [Code] NVARCHAR(255) NULL,
    [Debit] FLOAT NULL,
    [Credit] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_BANKRECO_LOG]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT NOT NULL,
    [CMS_SRNO] BIGINT NULL DEFAULT ((0)),
    [UPDATED_BY] VARCHAR(25) NULL,
    [UPDATE_DT] DATETIME NULL,
    [RECO_STATUS] VARCHAR(9) NULL,
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(150) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL,
    [Reset_EDT] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.company
-- --------------------------------------------------
CREATE TABLE [dbo].[company]
(
    [co_code] NVARCHAR(6) NOT NULL,
    [short_name] NVARCHAR(20) NOT NULL,
    [long_name] NVARCHAR(50) NULL,
    [address1] NVARCHAR(40) NULL,
    [address2] NVARCHAR(40) NULL,
    [address3] NVARCHAR(40) NULL,
    [address4] NVARCHAR(40) NULL,
    [city] NVARCHAR(20) NULL,
    [state] NVARCHAR(15) NULL,
    [nation] NVARCHAR(15) NULL,
    [zip] NVARCHAR(15) NULL,
    [phone1] NVARCHAR(15) NULL,
    [phone2] NVARCHAR(15) NULL,
    [fax] NVARCHAR(15) NULL,
    [email] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.comtekmst
-- --------------------------------------------------
CREATE TABLE [dbo].[comtekmst]
(
    [acname] NVARCHAR(35) NOT NULL,
    [longname] NVARCHAR(60) NULL,
    [actyp] NVARCHAR(10) NULL,
    [accat] NVARCHAR(10) NULL,
    [familycd] NVARCHAR(10) NULL,
    [cltcode] NVARCHAR(10) NULL,
    [accdtls] NVARCHAR(35) NULL,
    [grpcode] NVARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ConsolidatedTable
-- --------------------------------------------------
CREATE TABLE [dbo].[ConsolidatedTable]
(
    [grpname] VARCHAR(60) NULL,
    [grpcode] VARCHAR(13) NULL,
    [acname] VARCHAR(35) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [openentry] MONEY NOT NULL,
    [dramt] MONEY NOT NULL,
    [cramt] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costcenterledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[costcenterledger2]
(
    [Vtype] SMALLINT NULL,
    [Vno] DECIMAL(12, 0) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [costdate] DATETIME NULL,
    [sess_id] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costmast
-- --------------------------------------------------
CREATE TABLE [dbo].[costmast]
(
    [COSTNAME] CHAR(35) NOT NULL,
    [COSTCODE] SMALLINT NOT NULL,
    [CATCODE] SMALLINT NOT NULL,
    [GrpCode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cr1
-- --------------------------------------------------
CREATE TABLE [dbo].[cr1]
(
    [vamt] MONEY NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [c] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Creditors
-- --------------------------------------------------
CREATE TABLE [dbo].[Creditors]
(
    [cltcode] NVARCHAR(10) NOT NULL,
    [L_Address1] NVARCHAR(40) NULL,
    [L_Address2] NVARCHAR(40) NULL,
    [L_address3] NVARCHAR(40) NULL,
    [L_City] NVARCHAR(20) NULL,
    [L_State] NVARCHAR(15) NULL,
    [L_Nation] NVARCHAR(15) NULL,
    [L_Zip] NVARCHAR(10) NULL,
    [Fax] NVARCHAR(15) NULL,
    [Off_Phone1] NVARCHAR(15) NULL,
    [Off_Phone2] NVARCHAR(15) NULL,
    [Email] NVARCHAR(50) NULL,
    [Mobile_Pager] NVARCHAR(40) NULL,
    [Regsupplier] TINYINT NULL,
    [CSTNO] NVARCHAR(40) NULL,
    [SSTNO] NVARCHAR(40) NULL,
    [OMSflag] TINYINT NULL,
    [Crlimit] MONEY NULL,
    [Crdays] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.crentry
-- --------------------------------------------------
CREATE TABLE [dbo].[crentry]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.crentry1
-- --------------------------------------------------
CREATE TABLE [dbo].[crentry1]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.daymarginledger
-- --------------------------------------------------
CREATE TABLE [dbo].[daymarginledger]
(
    [mdt] DATETIME NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [yy] INT NULL,
    [mm] INT NULL,
    [dd] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.daymarginledgernew
-- --------------------------------------------------
CREATE TABLE [dbo].[daymarginledgernew]
(
    [mdt] DATETIME NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [yy] INT NULL,
    [mm] INT NULL,
    [dd] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.defaacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[defaacmast]
(
    [acname] NVARCHAR(35) NOT NULL,
    [longname] NVARCHAR(60) NULL,
    [actyp] NVARCHAR(10) NULL,
    [accat] NVARCHAR(10) NULL,
    [familycd] NVARCHAR(10) NULL,
    [cltcode] NVARCHAR(10) NULL,
    [accdtls] NVARCHAR(35) NULL,
    [grpcode] NVARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelPayOut
-- --------------------------------------------------
CREATE TABLE [dbo].[DelPayOut]
(
    [Exchange] VARCHAR(3) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_cd] VARCHAR(12) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [CertNo] VARCHAR(20) NULL,
    [PayQty] INT NULL,
    [ShrtQty] INT NOT NULL,
    [Cl_Rate] DECIMAL(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DIAG_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[DIAG_LOG]
(
    [ACTIONDATE] DATETIME NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [APPLICATION] VARCHAR(100) NULL,
    [USERNAME] VARCHAR(25) NULL,
    [OPTIONS] VARCHAR(100) NULL,
    [PERIOD] VARCHAR(30) NULL,
    [RESULT] VARCHAR(2000) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [PROCID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DIAG_RESULT
-- --------------------------------------------------
CREATE TABLE [dbo].[DIAG_RESULT]
(
    [RESULT] VARCHAR(2000) NULL,
    [PROCID] INT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.drentry
-- --------------------------------------------------
CREATE TABLE [dbo].[drentry]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.drentry1
-- --------------------------------------------------
CREATE TABLE [dbo].[drentry1]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dupparty
-- --------------------------------------------------
CREATE TABLE [dbo].[dupparty]
(
    [acname] CHAR(35) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [branchcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.edtclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[edtclbal]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EdtWiseTraderBillSumView
-- --------------------------------------------------
CREATE TABLE [dbo].[EdtWiseTraderBillSumView]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [edt] DATETIME NULL,
    [Debit] MONEY NULL,
    [Credit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Eqttype
-- --------------------------------------------------
CREATE TABLE [dbo].[Eqttype]
(
    [Eqt_Type] NVARCHAR(3) NOT NULL,
    [Description] NVARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.errvouchers
-- --------------------------------------------------
CREATE TABLE [dbo].[errvouchers]
(
    [cdt] DATETIME NULL,
    [errstr] VARCHAR(300) NULL,
    [statusid] VARCHAR(30) NULL,
    [statusname] VARCHAR(30) NULL,
    [username] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXISTS_RECORDS
-- --------------------------------------------------
CREATE TABLE [dbo].[EXISTS_RECORDS]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [RECORDSTATUS] BIT NULL,
    [UPLOADID] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finalnseledger
-- --------------------------------------------------
CREATE TABLE [dbo].[finalnseledger]
(
    [sdate] NVARCHAR(50) NULL,
    [balance] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finalpl
-- --------------------------------------------------
CREATE TABLE [dbo].[finalpl]
(
    [acname] VARCHAR(35) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fintempageing
-- --------------------------------------------------
CREATE TABLE [dbo].[fintempageing]
(
    [cltcode] VARCHAR(10) NULL,
    [balamt] MONEY NULL,
    [agedays] INT NULL,
    [drcr] VARCHAR(1) NULL,
    [sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESSCODE] VARCHAR(10) NULL,
    [PROCESSNAME] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [FORMULANAME] VARCHAR(MAX) NULL,
    [COMPAREWITH] VARCHAR(20) NULL,
    [COMPARISON] VARCHAR(10) NULL,
    [TR_TYPE] TINYINT NULL,
    [DBTYPE] VARCHAR(30) NULL,
    [ADDITIONAL_PARAMETERS] VARCHAR(1000) NULL,
    [FORMULA_FIELDS] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoSerTaxView
-- --------------------------------------------------
CREATE TABLE [dbo].[FoSerTaxView]
(
    [vdt] DATETIME NULL,
    [Ser] MONEY NOT NULL,
    [Brok] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FT_GL
-- --------------------------------------------------
CREATE TABLE [dbo].[FT_GL]
(
    [SR_NO] SMALLINT IDENTITY(1,1) NOT NULL,
    [EXCH_FR] VARCHAR(10) NULL,
    [EXCH_TO] VARCHAR(10) NULL,
    [JV_CODE] VARCHAR(10) NULL,
    [JV_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ftemppartybalances
-- --------------------------------------------------
CREATE TABLE [dbo].[ftemppartybalances]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [balancedate] DATETIME NULL,
    [balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FUND_TRF_CLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[FUND_TRF_CLIENT]
(
    [CLTCODE] VARCHAR(10) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Grpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Grpmast]
(
    [grpname] VARCHAR(60) NULL,
    [grpmain] VARCHAR(13) NULL,
    [grpcode] VARCHAR(13) NULL,
    [vtyp] FLOAT NULL,
    [dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grptemp
-- --------------------------------------------------
CREATE TABLE [dbo].[grptemp]
(
    [grpname] VARCHAR(60) NULL,
    [grpmain] VARCHAR(13) NULL,
    [grpcode] VARCHAR(13) NULL,
    [vtyp] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HDFC
-- --------------------------------------------------
CREATE TABLE [dbo].[HDFC]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(35) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IAccBill
-- --------------------------------------------------
CREATE TABLE [dbo].[IAccBill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(12) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [BranchCd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.JDTEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[JDTEMP]
(
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [branchcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KIRAN1
-- --------------------------------------------------
CREATE TABLE [dbo].[KIRAN1]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Last_date
-- --------------------------------------------------
CREATE TABLE [dbo].[Last_date]
(
    [CltCode] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LastChequeNo
-- --------------------------------------------------
CREATE TABLE [dbo].[LastChequeNo]
(
    [BankCode] VARCHAR(10) NULL,
    [BookType] CHAR(2) NULL,
    [Micrno] INT NULL,
    [ddno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastvno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastvno]
(
    [vtyp] SMALLINT NULL,
    [booktype] VARCHAR(2) NULL,
    [vdt] SMALLDATETIME NULL,
    [lastvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.led
-- --------------------------------------------------
CREATE TABLE [dbo].[led]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Led_JV_Upload
-- --------------------------------------------------
CREATE TABLE [dbo].[Led_JV_Upload]
(
    [acCode] VARCHAR(50) NULL,
    [amt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [narration] VARCHAR(500) NULL,
    [srno] INT NULL,
    [vdt] DATETIME NULL,
    [edt] DATETIME NULL,
    [branchcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LedAndMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[LedAndMargin]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [amount] MONEY NOT NULL,
    [edt] DATETIME NULL,
    [drcr] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_19012018
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_19012018]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_BRANCHBREAKUP
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_BRANCHBREAKUP]
(
    [VNO] VARCHAR(12) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] CHAR(2) NULL,
    [LNO] INT NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CAMT] MONEY NULL,
    [COSTCODE] SMALLINT NULL,
    [DRCR] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [optcode] CHAR(1) NULL,
    [Editdate] DATETIME NULL,
    [EditName] VARCHAR(15) NULL,
    [Status] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_null
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_null]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_pay
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_pay]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [vdt] DATETIME NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [vtype] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_SB
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_SB]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRIG]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRIG_HIS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRIG_HIS]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_txt
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_txt]
(
    [txt] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_19012018
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_19012018]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(100) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_log]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_MANUALRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_MANUALRECO_LOG]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(100) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_pay
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_pay]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [ddno] VARCHAR(15) NULL,
    [drcr] CHAR(1) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRIG]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRIG_HIS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRIG_HIS]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger2]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] INT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger2_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger2_log]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3_log]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledgerbal
-- --------------------------------------------------
CREATE TABLE [dbo].[ledgerbal]
(
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [edt] DATETIME NULL,
    [acname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGERCLTCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGERCLTCODE]
(
    [CLTCODE] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LedgerDrCrView
-- --------------------------------------------------
CREATE TABLE [dbo].[LedgerDrCrView]
(
    [CltCode] VARCHAR(10) NOT NULL,
    [Damt] MONEY NOT NULL,
    [Camt] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LedgerLog
-- --------------------------------------------------
CREATE TABLE [dbo].[LedgerLog]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [edt] DATETIME NULL,
    [vdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(50) NULL,
    [vamt] MONEY NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(30) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [receiptno] INT NULL,
    [narato] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [ModifiedDate] DATETIME NULL,
    [markedflag] VARCHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [Editedby] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledgermatchcr
-- --------------------------------------------------
CREATE TABLE [dbo].[ledgermatchcr]
(
    [cramt] MONEY NULL,
    [drcr] VARCHAR(1) NOT NULL,
    [vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledgermatchdr
-- --------------------------------------------------
CREATE TABLE [dbo].[ledgermatchdr]
(
    [cramt] MONEY NULL,
    [drcr] VARCHAR(1) NOT NULL,
    [vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGERRENUM_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGERRENUM_LOG]
(
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [NEWVNO] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledgertemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledgertemp]
(
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [vno1] DECIMAL(12, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGERTRANSFER_SEGMENTWISE
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGERTRANSFER_SEGMENTWISE]
(
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [ACNAME] CHAR(100) NOT NULL,
    [LEDGERBALANCE] MONEY NULL,
    [AMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDRA
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDRA]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledsum
-- --------------------------------------------------
CREATE TABLE [dbo].[ledsum]
(
    [party_code] VARCHAR(10) NOT NULL,
    [margin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledtemp
-- --------------------------------------------------
CREATE TABLE [dbo].[ledtemp]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.lptemp1
-- --------------------------------------------------
CREATE TABLE [dbo].[lptemp1]
(
    [acname] VARCHAR(35) NULL,
    [dvamt] MONEY NULL,
    [cvamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [vdt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.macmast
-- --------------------------------------------------
CREATE TABLE [dbo].[macmast]
(
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [branchcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MADDRESS
-- --------------------------------------------------
CREATE TABLE [dbo].[MADDRESS]
(
    [MSDIVCOD] NVARCHAR(2) NULL,
    [MSACCODE] NVARCHAR(6) NULL,
    [MSPREFIX] NVARCHAR(5) NULL,
    [MSPTYNAM] NVARCHAR(40) NULL,
    [MSADDRL1] NVARCHAR(30) NULL,
    [MSADDRL2] NVARCHAR(30) NULL,
    [MSADDRL3] NVARCHAR(30) NULL,
    [MSADDRL4] NVARCHAR(30) NULL,
    [MSADDRL5] NVARCHAR(30) NULL,
    [MSADDRL6] NVARCHAR(30) NULL,
    [MSADDRL7] NVARCHAR(30) NULL,
    [MSITNO] NVARCHAR(30) NULL,
    [MSDPNO] NVARCHAR(30) NULL,
    [MSDPID] NVARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MarginLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[MarginLedger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NULL,
    [MCltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marginledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[marginledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NULL,
    [MCltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marginledsum
-- --------------------------------------------------
CREATE TABLE [dbo].[marginledsum]
(
    [party_code] VARCHAR(10) NOT NULL,
    [margin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.match
-- --------------------------------------------------
CREATE TABLE [dbo].[match]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MatchDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[MatchDetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.matchdetails_log
-- --------------------------------------------------
CREATE TABLE [dbo].[matchdetails_log]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[MMASTER]
(
    [MSDIVCOD] NVARCHAR(2) NULL,
    [MSACCODE] NVARCHAR(6) NULL,
    [MSACNAME] NVARCHAR(30) NULL,
    [MSPLACE] NVARCHAR(15) NULL,
    [MSGLCODE] NVARCHAR(6) NULL,
    [MSSTPCNT] FLOAT NULL,
    [MSOTHCOD] NVARCHAR(6) NULL,
    [MSADJST] NVARCHAR(1) NULL,
    [MSREFSW] NVARCHAR(20) NULL,
    [MSPCHLMT] FLOAT NULL,
    [MSSALLMT] FLOAT NULL,
    [MSACLMT] FLOAT NULL,
    [MSCRDAYS] FLOAT NULL,
    [MSINTRT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mmatchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[mmatchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multibankid
-- --------------------------------------------------
CREATE TABLE [dbo].[Multibankid]
(
    [Srno] INT NOT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NULL,
    [Chequename] VARCHAR(100) NULL,
    [Defaultbank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multibankid_AUDIT
-- --------------------------------------------------
CREATE TABLE [dbo].[Multibankid_AUDIT]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL,
    [Action] VARCHAR(10) NULL,
    [Action_ModifiedDate] SMALLDATETIME NULL,
    [Action_ModifiedBy] NVARCHAR(256) NULL,
    [USER_IP] VARCHAR(25) NULL,
    [APPNAME] VARCHAR(100) NULL,
    [HOSTNAME] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIBANKID_DONOT_DELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIBANKID_DONOT_DELETE]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NULL,
    [Chequename] VARCHAR(100) NULL,
    [Defaultbank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multibankid_N25431
-- --------------------------------------------------
CREATE TABLE [dbo].[multibankid_N25431]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NULL,
    [Chequename] VARCHAR(100) NULL,
    [Defaultbank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multivouchers
-- --------------------------------------------------
CREATE TABLE [dbo].[multivouchers]
(
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NULL,
    [vno] VARCHAR(12) NULL,
    [lcnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newgrpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[newgrpmast]
(
    [grpname] NVARCHAR(60) NULL,
    [grpmain] NVARCHAR(13) NULL,
    [grpcode] NVARCHAR(13) NULL,
    [vtyp] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newnseled
-- --------------------------------------------------
CREATE TABLE [dbo].[newnseled]
(
    [TYPE] VARCHAR(5) NULL,
    [DOC] VARCHAR(11) NULL,
    [TDT] NVARCHAR(12) NULL,
    [X] VARCHAR(3) NULL,
    [NARRATION] VARCHAR(50) NULL,
    [DR] MONEY NULL,
    [XX] CHAR(1) NULL,
    [CR] MONEY NULL,
    [XXX] CHAR(1) NULL,
    [CODE] VARCHAR(10) NULL,
    [NAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NIK2
-- --------------------------------------------------
CREATE TABLE [dbo].[NIK2]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [VDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFLINE_JV_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFLINE_JV_ENTRIES]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VDATE] DATETIME NULL,
    [PARTYCODE] VARCHAR(10) NULL,
    [JVAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [EXCHANGEFR] VARCHAR(20) NULL,
    [EXCHANGETO] VARCHAR(20) NULL,
    [GLCODEFR] VARCHAR(10) NULL,
    [GLCODETO] VARCHAR(10) NULL,
    [VCHNOFR] VARCHAR(12) NULL,
    [VCHNOTO] VARCHAR(12) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [PROCESS_ID] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OpenCltcode
-- --------------------------------------------------
CREATE TABLE [dbo].[OpenCltcode]
(
    [acname] VARCHAR(35) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [drcr] CHAR(1) NULL,
    [amount] MONEY NULL,
    [Branch] VARCHAR(35) NULL,
    [Status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.orgacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[orgacmast]
(
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.owner
-- --------------------------------------------------
CREATE TABLE [dbo].[owner]
(
    [CompanyName] VARCHAR(50) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [ShareDB] VARCHAR(10) NOT NULL,
    [AccountDB] VARCHAR(12) NOT NULL,
    [clientgroup] VARCHAR(35) NULL,
    [balsign] TINYINT NULL,
    [conpath] VARCHAR(50) NULL,
    [segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [RecoFlag] CHAR(1) NOT NULL DEFAULT 'Y',
    [CIN] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[parameter]
(
    [sdtcur] DATETIME NULL,
    [ldtcur] DATETIME NULL,
    [ldtprv] DATETIME NULL,
    [sdtnxt] DATETIME NULL,
    [curyear] TINYINT NULL,
    [vnoflag] SMALLINT NULL,
    [Match_BtoB] SMALLINT NULL,
    [Match_CtoC] SMALLINT NULL,
    [maker_checker] SMALLINT NULL,
    [VoucherPrintFlag] SMALLINT NULL,
    [BranchFlag] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.parameter_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[parameter_NEW]
(
    [sdtcur] DATETIME NULL,
    [ldtcur] DATETIME NULL,
    [ldtprv] DATETIME NULL,
    [sdtnxt] DATETIME NULL,
    [curyear] TINYINT NULL,
    [vnoflag] SMALLINT NULL,
    [Match_BtoB] SMALLINT NULL,
    [Match_CtoC] SMALLINT NULL,
    [maker_checker] SMALLINT NULL,
    [VoucherPrintFlag] SMALLINT NULL,
    [BranchFlag] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartyBalAmt
-- --------------------------------------------------
CREATE TABLE [dbo].[PartyBalAmt]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [CVamt] MONEY NULL,
    [DVamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [vdt] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Partybalamt1
-- --------------------------------------------------
CREATE TABLE [dbo].[Partybalamt1]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [vdt] DATETIME NULL,
    [debit] MONEY NULL,
    [credit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartyDrcrEdtView
-- --------------------------------------------------
CREATE TABLE [dbo].[PartyDrcrEdtView]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [edt] DATETIME NULL,
    [debit] MONEY NULL,
    [credit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartyDrCrView
-- --------------------------------------------------
CREATE TABLE [dbo].[PartyDrCrView]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [vdt] DATETIME NULL,
    [debit] MONEY NULL,
    [credit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PatameterSep
-- --------------------------------------------------
CREATE TABLE [dbo].[PatameterSep]
(
    [sdtcur] DATETIME NULL,
    [ldtcur] DATETIME NULL,
    [ldtprv] DATETIME NULL,
    [sdtnxt] DATETIME NULL,
    [curyear] TINYINT NULL,
    [vnoflag] SMALLINT NULL,
    [Match_BtoB] SMALLINT NULL,
    [Match_CtoC] SMALLINT NULL,
    [maker_checker] SMALLINT NULL,
    [VoucherPrintFlag] SMALLINT NULL,
    [BranchFlag] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pay1
-- --------------------------------------------------
CREATE TABLE [dbo].[pay1]
(
    [cltcode] NVARCHAR(10) NULL,
    [acname] NVARCHAR(35) NULL,
    [vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [ChequeNo] NVARCHAR(15) NULL,
    [ChequeInName] NVARCHAR(50) NULL,
    [Narration] NVARCHAR(150) NULL,
    [PrintedFlag] TINYINT NULL,
    [actamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayAdv
-- --------------------------------------------------
CREATE TABLE [dbo].[PayAdv]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [ChequeNo] VARCHAR(15) NULL,
    [ChequeInName] VARCHAR(50) NULL,
    [Narration] VARCHAR(150) NULL,
    [PrintedFlag] TINYINT NULL,
    [actamt] MONEY NULL,
    [shortage] MONEY NULL,
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PaymentMarking
-- --------------------------------------------------
CREATE TABLE [dbo].[PaymentMarking]
(
    [PaymentDate] DATETIME NULL,
    [BranchCode] VARCHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [DefBtoBPayment] CHAR(1) NULL,
    [DefPaymode] CHAR(1) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [Amounttobepaid] MONEY NULL,
    [ActualAmoutpaid] MONEY NULL,
    [InstrumentNo] INT NULL,
    [PayMarkFlag] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [vno] VARCHAR(12) NULL,
    [Remark] VARCHAR(50) NULL,
    [ChequeInName] VARCHAR(50) NULL,
    [vtyp] VARCHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [ApprovedBy] VARCHAR(15) NULL,
    [HoApproval] INT NULL,
    [ApprovedOn] DATETIME NULL,
    [chequeno] VARCHAR(12) NULL,
    [ChequePrinted] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pltemp
-- --------------------------------------------------
CREATE TABLE [dbo].[pltemp]
(
    [acname] VARCHAR(35) NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [vdt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PostBillLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[PostBillLedger]
(
    [VTYP] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [EDT] DATETIME NULL,
    [LNO] INT IDENTITY(1,1) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] VARCHAR(1) NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SNO] BIGINT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BILL_NO] INT NULL,
    [ACCAT] CHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[POSTBILLLEDGER2]
(
    [DRCR] CHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Printchkack
-- --------------------------------------------------
CREATE TABLE [dbo].[Printchkack]
(
    [Exchange] NVARCHAR(3) NULL,
    [Segment] NVARCHAR(20) NULL,
    [Sett_type] NVARCHAR(3) NULL,
    [sett_no] NVARCHAR(7) NULL,
    [Billno] NVARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Balamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_DELETION_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_DELETION_LOGS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL,
    [ROWTYPE] NVARCHAR(25) NULL,
    [DRCR] NVARCHAR(5) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [AMOUNT] DECIMAL(20, 2) NULL,
    [DRAWER_NAME] NVARCHAR(100) NULL,
    [CLTCODE] NVARCHAR(50) NULL,
    [CLTACCNO] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] NVARCHAR(50) NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MATCHEDFLAG] BIT NOT NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(300) NULL,
    [LEDGERBALANCE] NVARCHAR(100) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(100) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(150) NULL,
    [USERNAME] NVARCHAR(50) NULL,
    [PERFORMDATE] DATETIME NULL,
    [ERROR1] NVARCHAR(MAX) NULL,
    [ERROR2] NVARCHAR(MAX) NULL,
    [ERROR3] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_FILEUPLOAD_LOGS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_UPLOAD_PROCESS_INFO
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_UPLOAD_PROCESS_INFO]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NOT NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Recon_CMS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Recon_CMS_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [RowType] NVARCHAR(50) NULL,
    [Valuedate] DATETIME NULL,
    [DrCr] NVARCHAR(50) NULL,
    [Inst_no_Check] NVARCHAR(50) NULL,
    [Inst_Amt] DECIMAL(20, 2) NULL,
    [Drawer_Name] NVARCHAR(250) NULL,
    [CltCode] NVARCHAR(50) NULL,
    [CltAccNo] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] NVARCHAR(50) NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MatchedFlag] BIT NULL,
    [UploadStatus] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [ModifiedDate] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_ENCRYPTION_DETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_ENCRYPTION_DETAILS]
(
    [ENCRY_SRNO] INT IDENTITY(1,1) NOT NULL,
    [ENCRY_NUMBER] NVARCHAR(50) NULL,
    [REFERENCESNUMBER] NVARCHAR(50) NULL,
    [INCRYPTIONDATE] DATETIME NULL,
    [ENCRY_DESCRIPTION] NVARCHAR(200) NULL,
    [ENCRY_AMOUNT] MONEY NULL,
    [ENCRY_STATUS] NVARCHAR(25) NULL,
    [ENCRY_CHEQUENUMBER] NVARCHAR(25) NULL,
    [UPLOADDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [MATCH_STATUS] INT NULL,
    [UPLOADTYPE] NVARCHAR(20) NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [SEGMENT] NVARCHAR(100) NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [BANKCODE] NVARCHAR(100) NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [FILETYPE] NVARCHAR(100) NULL,
    [CROSS_NO] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_LOGS]
(
    [LOGID] INT IDENTITY(1,1) NOT NULL,
    [SERVERNAME] NVARCHAR(100) NULL,
    [DATABASENAME] NVARCHAR(100) NULL,
    [USERNAME] NVARCHAR(50) NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [LOGDATE] DATETIME NULL,
    [ERRORLOGS] NVARCHAR(250) NULL,
    [SOURCENAME] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Recon_NONCMS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Recon_NONCMS_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [Description] NVARCHAR(150) NULL,
    [LedgerBalance] NVARCHAR(50) NULL,
    [DrCr] NVARCHAR(50) NULL,
    [Amt] DECIMAL(20, 2) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CustomerReference] NVARCHAR(50) NULL,
    [TransaCtionDetail] NVARCHAR(400) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MatchedFlag] BIT NULL,
    [UploadStatus] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [ModifiedDate] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ReconcileCheck
-- --------------------------------------------------
CREATE TABLE [dbo].[ReconcileCheck]
(
    [chequeno] VARCHAR(50) NULL,
    [bankdate] SMALLDATETIME NULL,
    [amount] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [narration] VARCHAR(50) NOT NULL,
    [slipno] INT NULL,
    [sdate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECOPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECOPROCESS]
(
    [INPROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [VDT] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [ORGBRANCH] VARCHAR(10) NULL,
    [LNO] SMALLINT NOT NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table_Lno
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table_Lno]
(
    [SNO] INT NULL,
    [LNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table_Tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table_Tmp]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.refcoaccfo
-- --------------------------------------------------
CREATE TABLE [dbo].[refcoaccfo]
(
    [Name] NVARCHAR(255) NULL,
    [Code] NVARCHAR(255) NULL,
    [Dr] FLOAT NULL,
    [Cr] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.retbnkdtls
-- --------------------------------------------------
CREATE TABLE [dbo].[retbnkdtls]
(
    [acname] VARCHAR(35) NULL,
    [refno] CHAR(12) NULL,
    [dacname] VARCHAR(35) NULL,
    [drefno] CHAR(12) NOT NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dddt] DATETIME NULL,
    [relamt] MONEY NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.return
-- --------------------------------------------------
CREATE TABLE [dbo].[return]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vamt] MONEY NULL,
    [edt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.returnaug
-- --------------------------------------------------
CREATE TABLE [dbo].[returnaug]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vamt] MONEY NULL,
    [acname] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.returnchq
-- --------------------------------------------------
CREATE TABLE [dbo].[returnchq]
(
    [booktype] CHAR(2) NULL,
    [vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rollingbse
-- --------------------------------------------------
CREATE TABLE [dbo].[rollingbse]
(
    [Exchange] NVARCHAR(255) NULL,
    [Segment] NVARCHAR(255) NULL,
    [Type] NVARCHAR(255) NULL,
    [Sett_No] FLOAT NULL,
    [Date] NVARCHAR(255) NULL,
    [Party_code] NVARCHAR(255) NULL,
    [AMT] FLOAT NULL,
    [Dr/Cr] NVARCHAR(255) NULL,
    [BalAmt] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [Description] NVARCHAR(255) NULL,
    [Code] NVARCHAR(255) NULL,
    [V_Type] FLOAT NULL,
    [V_No] FLOAT NULL,
    [L_No] NVARCHAR(255) NULL,
    [Book_Type] NVARCHAR(255) NULL,
    [Lvtype] NVARCHAR(255) NULL,
    [LvNo] NVARCHAR(255) NULL,
    [LlNo] NVARCHAR(255) NULL,
    [Lbooktype] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rpt_acccostwisedrcr
-- --------------------------------------------------
CREATE TABLE [dbo].[rpt_acccostwisedrcr]
(
    [grpcode] VARCHAR(20) NOT NULL,
    [category] CHAR(35) NOT NULL,
    [catcode] SMALLINT NOT NULL,
    [costname] CHAR(35) NOT NULL,
    [costcode] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rpt_acccostwisedrcrview
-- --------------------------------------------------
CREATE TABLE [dbo].[rpt_acccostwisedrcrview]
(
    [grpcode] VARCHAR(20) NOT NULL,
    [category] CHAR(35) NOT NULL,
    [catcode] SMALLINT NOT NULL,
    [costname] CHAR(35) NOT NULL,
    [costcode] SMALLINT NOT NULL,
    [vdt] DATETIME NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_AccTrialBal
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_AccTrialBal]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NOT NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [VDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_AccTrialBalall
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_AccTrialBalall]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NOT NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [VDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_AccTrialBalalledt
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_AccTrialBalalledt]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NOT NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [edt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_AccTrialBaledt
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_AccTrialBaledt]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NOT NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [edt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_AccTrialBalgl
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_AccTrialBalgl]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NOT NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [VDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_AccTrialBalgledt
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_AccTrialBalgledt]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NOT NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [edt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rpt_focldetail
-- --------------------------------------------------
CREATE TABLE [dbo].[rpt_focldetail]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rpt_fopartybalamt
-- --------------------------------------------------
CREATE TABLE [dbo].[rpt_fopartybalamt]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [CVamt] MONEY NULL,
    [DVamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [vdt] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rpt_TrdLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[Rpt_TrdLedger]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [cl_code] VARCHAR(6) NOT NULL,
    [PAmt] MONEY NOT NULL,
    [SAmt] MONEY NOT NULL,
    [branch_cd] CHAR(10) NOT NULL,
    [trader] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sachinpayment
-- --------------------------------------------------
CREATE TABLE [dbo].[sachinpayment]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sachinreceipt
-- --------------------------------------------------
CREATE TABLE [dbo].[sachinreceipt]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip1]
(
    [co_code] NVARCHAR(6) NOT NULL,
    [sc_code] NVARCHAR(2) NOT NULL,
    [short_name] NVARCHAR(20) NOT NULL,
    [long_name] NVARCHAR(50) NULL,
    [market_lot] FLOAT NULL,
    [face_val] FLOAT NULL,
    [book_cl_dt] SMALLDATETIME NULL,
    [ex_div_dt] SMALLDATETIME NULL,
    [ex_bon_dt] SMALLDATETIME NULL,
    [ex_rit_dt] SMALLDATETIME NULL,
    [eqt_type] NVARCHAR(3) NULL,
    [sub_type] NVARCHAR(3) NULL,
    [agent_cd] NVARCHAR(6) NULL,
    [demat_flag] FLOAT NULL,
    [demat_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip2
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip2]
(
    [co_code] VARCHAR(6) NOT NULL,
    [series] VARCHAR(3) NOT NULL,
    [exchange] VARCHAR(3) NOT NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [scrip_cat] VARCHAR(3) NULL,
    [no_del_fr] DATETIME NULL,
    [no_del_to] DATETIME NULL,
    [cl_rate] FLOAT NULL,
    [clos_rate_dt] DATETIME NULL,
    [min_trd_qty] INT NULL,
    [BseCode] VARCHAR(10) NULL,
    [Isin] VARCHAR(20) NULL,
    [delsc_cat] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[Selection_Levels_PartyLedger]
(
    [Level_No] SMALLINT NULL,
    [Level_Name] VARCHAR(20) NULL,
    [Enable_Flg] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.slipreceipt
-- --------------------------------------------------
CREATE TABLE [dbo].[slipreceipt]
(
    [Amt] MONEY NULL,
    [SlipNo] DECIMAL(18, 0) NOT NULL,
    [refno] VARCHAR(12) NULL,
    [Sdate] SMALLDATETIME NULL,
    [Location] CHAR(1) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMULTIBANKID
-- --------------------------------------------------
CREATE TABLE [dbo].[SMULTIBANKID]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NULL,
    [Chequename] VARCHAR(100) NULL,
    [Defaultbank] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stracacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[stracacmast]
(
    [CODE] NVARCHAR(9) NULL,
    [NAME] NVARCHAR(35) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subaccd
-- --------------------------------------------------
CREATE TABLE [dbo].[subaccd]
(
    [subac] CHAR(35) NOT NULL,
    [achead] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subgrpname
-- --------------------------------------------------
CREATE TABLE [dbo].[subgrpname]
(
    [grpname] VARCHAR(60) NULL,
    [grpcode] VARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SUMLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[SUMLEDGER]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BALANCE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SUMMARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[SUMMARGIN]
(
    [MCLTCODE] VARCHAR(10) NULL,
    [BALANCE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.talbil
-- --------------------------------------------------
CREATE TABLE [dbo].[talbil]
(
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(15) NULL,
    [Type] VARCHAR(3) NULL,
    [Sett_No] DECIMAL(18, 0) NULL,
    [Date] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amt] MONEY NULL,
    [Dorc] VARCHAR(1) NULL,
    [BalAmt] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Description] VARCHAR(234) NULL,
    [Code1] VARCHAR(10) NULL,
    [V_Type] VARCHAR(2) NULL,
    [V_No] DECIMAL(12, 0) NULL,
    [L_No] VARCHAR(6) NULL,
    [Book_Type] VARCHAR(2) NULL,
    [Lvtype] VARCHAR(2) NULL,
    [LvNo] VARCHAR(50) NULL,
    [LlNo] VARCHAR(6) NULL,
    [Lbooktype] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TallyBank
-- --------------------------------------------------
CREATE TABLE [dbo].[TallyBank]
(
    [Date] VARCHAR(10) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [Cheqno] DECIMAL(18, 0) NULL,
    [Party_code] VARCHAR(10) NULL,
    [acname] VARCHAR(234) NULL,
    [Vdesc] VARCHAR(3) NULL,
    [vno] DECIMAL(12, 0) NULL,
    [paynarr] VARCHAR(234) NULL,
    [recnarr] VARCHAR(234) NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [Vtyp] VARCHAR(2) NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [Booktype] VARCHAR(2) NULL,
    [Micrno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallybillmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[tallybillmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(12) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [balamt] MONEY NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Branch] CHAR(6) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallybills
-- --------------------------------------------------
CREATE TABLE [dbo].[tallybills]
(
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(15) NULL,
    [Type] VARCHAR(3) NULL,
    [Sett_No] DECIMAL(18, 0) NULL,
    [Date] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amt] MONEY NULL,
    [Dorc] VARCHAR(1) NULL,
    [BalAmt] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Description] VARCHAR(234) NULL,
    [Code1] VARCHAR(10) NULL,
    [V_Type] VARCHAR(2) NULL,
    [V_No] DECIMAL(12, 0) NULL,
    [L_No] VARCHAR(6) NULL,
    [Book_Type] VARCHAR(2) NULL,
    [Lvtype] VARCHAR(2) NULL,
    [LvNo] VARCHAR(50) NULL,
    [LlNo] VARCHAR(6) NULL,
    [Lbooktype] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TallyCash
-- --------------------------------------------------
CREATE TABLE [dbo].[TallyCash]
(
    [Date] VARCHAR(10) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [Cheqno] DECIMAL(18, 0) NULL,
    [Party_code] VARCHAR(10) NULL,
    [acname] VARCHAR(234) NULL,
    [Vdesc] VARCHAR(3) NULL,
    [vno] DECIMAL(12, 0) NULL,
    [paynarr] VARCHAR(234) NULL,
    [recnarr] VARCHAR(234) NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [Vtyp] VARCHAR(2) NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [Booktype] VARCHAR(2) NULL,
    [Micrno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallydrnote
-- --------------------------------------------------
CREATE TABLE [dbo].[tallydrnote]
(
    [Vdt] VARCHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [F3] VARCHAR(50) NULL,
    [Type] VARCHAR(10) NULL,
    [Vno] DECIMAL(12, 0) NULL,
    [DrAmt] MONEY NULL,
    [CrAmt] MONEY NULL,
    [Narration] VARCHAR(234) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Vtyp] VARCHAR(2) NULL,
    [linenum] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TallyJVs
-- --------------------------------------------------
CREATE TABLE [dbo].[TallyJVs]
(
    [Type] VARCHAR(2) NULL,
    [Voucher_No] DECIMAL(18, 0) NULL,
    [edt] VARCHAR(10) NULL,
    [L_No] VARCHAR(6) NULL,
    [acname] VARCHAR(35) NULL,
    [dorc] VARCHAR(1) NULL,
    [amt] MONEY NULL,
    [vdt] VARCHAR(10) NULL,
    [cdt] VARCHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [Branch] VARCHAR(10) NULL,
    [booktype] VARCHAR(2) NULL,
    [entryby] VARCHAR(50) NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] VARCHAR(1) NULL,
    [DDNo] VARCHAR(15) NULL,
    [dddt] VARCHAR(10) NULL,
    [reldt] VARCHAR(10) NULL,
    [relamt] VARCHAR(20) NULL,
    [receiptno] VARCHAR(10) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallyledger
-- --------------------------------------------------
CREATE TABLE [dbo].[tallyledger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(35) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallyledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[tallyledger1]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallyledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[tallyledger2]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallyledger3
-- --------------------------------------------------
CREATE TABLE [dbo].[tallyledger3]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tallymatchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tallymatchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TallyNSE
-- --------------------------------------------------
CREATE TABLE [dbo].[TallyNSE]
(
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(15) NULL,
    [Type] VARCHAR(3) NULL,
    [Sett_No] DECIMAL(18, 0) NULL,
    [Date] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amt] MONEY NULL,
    [Dorc] VARCHAR(1) NULL,
    [BalAmt] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Description] VARCHAR(234) NULL,
    [Code1] VARCHAR(10) NULL,
    [V_Type] VARCHAR(2) NULL,
    [V_No] DECIMAL(12, 0) NULL,
    [L_No] VARCHAR(6) NULL,
    [Book_Type] VARCHAR(2) NULL,
    [Lvtype] VARCHAR(2) NULL,
    [LvNo] VARCHAR(50) NULL,
    [LlNo] VARCHAR(6) NULL,
    [Lbooktype] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TallyNseAuction
-- --------------------------------------------------
CREATE TABLE [dbo].[TallyNseAuction]
(
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(15) NULL,
    [Type] VARCHAR(3) NULL,
    [Sett_no] DECIMAL(18, 0) NULL,
    [Date] VARCHAR(10) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amt] MONEY NULL,
    [Dorc] VARCHAR(1) NULL,
    [BalAmt] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Description] VARCHAR(234) NULL,
    [Code1] VARCHAR(10) NULL,
    [V_Type] VARCHAR(2) NULL,
    [V_No] DECIMAL(12, 0) NULL,
    [L_No] VARCHAR(6) NULL,
    [Book_Type] VARCHAR(2) NULL,
    [Lvtype] VARCHAR(2) NULL,
    [LvNo] VARCHAR(50) NULL,
    [LlNo] VARCHAR(6) NULL,
    [Lbooktype] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tallyoddlotbse
-- --------------------------------------------------
CREATE TABLE [dbo].[Tallyoddlotbse]
(
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(15) NULL,
    [Type] VARCHAR(3) NULL,
    [Sett_No] DECIMAL(18, 0) NULL,
    [Date] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amt] MONEY NULL,
    [Dorc] VARCHAR(1) NULL,
    [BalAmt] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Description] VARCHAR(234) NULL,
    [Party_code1] VARCHAR(10) NULL,
    [V_Type] VARCHAR(2) NULL,
    [V_No] DECIMAL(18, 0) NULL,
    [L_No] VARCHAR(6) NULL,
    [Book_Type] VARCHAR(2) NULL,
    [Lvtype] VARCHAR(2) NULL,
    [LvNo] VARCHAR(12) NULL,
    [LlNo] VARCHAR(6) NULL,
    [Lbooktype] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tallyrollingbse
-- --------------------------------------------------
CREATE TABLE [dbo].[Tallyrollingbse]
(
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(15) NULL,
    [Type] VARCHAR(2) NULL,
    [Sett_No] DECIMAL(18, 0) NULL,
    [Date] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [AMT] MONEY NULL,
    [Dorc] VARCHAR(1) NULL,
    [BalAmt] VARCHAR(20) NULL,
    [Branch] VARCHAR(10) NULL,
    [Description] VARCHAR(234) NULL,
    [Code] VARCHAR(10) NULL,
    [V_Type] VARCHAR(2) NULL,
    [V_No] DECIMAL(18, 0) NULL,
    [L_No] VARCHAR(6) NULL,
    [Book_Type] VARCHAR(2) NULL,
    [Lvtype] VARCHAR(2) NULL,
    [LvNo] VARCHAR(6) NULL,
    [LlNo] VARCHAR(6) NULL,
    [Lbooktype] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tani
-- --------------------------------------------------
CREATE TABLE [dbo].[tani]
(
    [CltCode] VARCHAR(10) NOT NULL,
    [AcName] VARCHAR(35) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbal04
-- --------------------------------------------------
CREATE TABLE [dbo].[tbal04]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [clcode] VARCHAR(10) NULL,
    [acname] VARCHAR(35) NULL,
    [amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_OppBalance]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [cltCode] VARCHAR(10) NULL,
    [OppBal] MONEY NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbr
-- --------------------------------------------------
CREATE TABLE [dbo].[tbr]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(30) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL,
    [CrossReferenceNo] INT NULL,
    [Status] VARCHAR(9) NULL,
    [MicrNo] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_CMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_CMS_DATA]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [ROWTYPE] NVARCHAR(50) NULL,
    [VALUEDATE] DATETIME NULL,
    [DRCR] NVARCHAR(50) NULL,
    [INST_NO_CHECK] NVARCHAR(50) NULL,
    [INST_AMT] DECIMAL(20, 2) NULL,
    [DRAWER_NAME] NVARCHAR(250) NULL,
    [CLTCODE] NVARCHAR(50) NULL,
    [CLTACCNO] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(20) NULL,
    [VTYP] NVARCHAR(20) NULL,
    [BOOKTYPE] NVARCHAR(20) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] NVARCHAR(50) NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_FILE2
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_FILE2]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_ledger_15
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_ledger_15]
(
    [vdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_ncdx
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_ncdx]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_NONCMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_NONCMS_DATA]
(
    [SRNONCMS] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(150) NULL,
    [LEDGERBALANCE] NVARCHAR(50) NULL,
    [DRCR] NVARCHAR(50) NULL,
    [AMT] DECIMAL(20, 2) NULL,
    [VALUEDATE] NVARCHAR(50) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(150) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(200) NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL,
    [CLOSINGBALANCE] DECIMAL(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_notin_multi1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_notin_multi1]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_rashmi_deposit
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_rashmi_deposit]
(
    [segment] VARCHAR(5) NOT NULL,
    [vdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp1]
(
    [cltcode] NVARCHAR(10) NOT NULL,
    [vtyp] SMALLINT NULL,
    [vno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[tempacmast]
(
    [MSDIVCOD] NVARCHAR(2) NULL,
    [MSACCODE] NVARCHAR(6) NULL,
    [MSACNAME] NVARCHAR(30) NULL,
    [MSPLACE] NVARCHAR(15) NULL,
    [MSGLCODE] NVARCHAR(6) NULL,
    [MSSTPCNT] FLOAT NULL,
    [MSOTHCOD] NVARCHAR(6) NULL,
    [MSADJST] NVARCHAR(1) NULL,
    [MSREFSW] NVARCHAR(20) NULL,
    [MSPCHLMT] FLOAT NULL,
    [MSSALLMT] FLOAT NULL,
    [MSACLMT] FLOAT NULL,
    [MSCRDAYS] FLOAT NULL,
    [MSINTRT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempageing
-- --------------------------------------------------
CREATE TABLE [dbo].[tempageing]
(
    [cltcode] VARCHAR(10) NULL,
    [baldate] VARCHAR(11) NULL,
    [closbal] MONEY NULL,
    [agedays] INT NULL,
    [sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempani
-- --------------------------------------------------
CREATE TABLE [dbo].[tempani]
(
    [vtyp] SMALLINT NULL,
    [vno] INT NULL,
    [vno1] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempbankreco
-- --------------------------------------------------
CREATE TABLE [dbo].[tempbankreco]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(10) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempbilldetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tempbilldetails]
(
    [Exchange] CHAR(10) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Sett_no] VARCHAR(25) NULL,
    [Sett_type] CHAR(10) NULL,
    [drcr] CHAR(1) NULL,
    [billamount] MONEY NULL,
    [balamt] MONEY NULL,
    [payamount] MONEY NULL,
    [sessionid] VARCHAR(50) NULL,
    [rowid] DECIMAL(4, 0) NULL,
    [billlno] DECIMAL(4, 0) NULL,
    [date] DATETIME NULL,
    [description] VARCHAR(20) NULL,
    [billbooktype] CHAR(2) NULL,
    [billvtype] SMALLINT NULL,
    [booktype] CHAR(2) NULL,
    [vtype] VARCHAR(50) NULL,
    [billvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempbillmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[tempbillmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [balamt] MONEY NULL,
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Branch] CHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempcal
-- --------------------------------------------------
CREATE TABLE [dbo].[tempcal]
(
    [CltCode] NVARCHAR(10) NOT NULL,
    [credit] MONEY NULL,
    [debit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempcal1
-- --------------------------------------------------
CREATE TABLE [dbo].[tempcal1]
(
    [CltCode] NVARCHAR(10) NOT NULL,
    [credit] MONEY NULL,
    [debit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.templedger2
-- --------------------------------------------------
CREATE TABLE [dbo].[templedger2]
(
    [category] VARCHAR(20) NULL,
    [branch] VARCHAR(25) NULL,
    [paidamt] MONEY NULL,
    [vtype] VARCHAR(2) NULL,
    [vno] VARCHAR(25) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [costcode] INT NULL,
    [booktype] CHAR(2) NULL,
    [sessionid] VARCHAR(15) NULL,
    [party_code] VARCHAR(25) NULL,
    [costflag] CHAR(1) NULL,
    [rowid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempmatchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tempmatchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempowner
-- --------------------------------------------------
CREATE TABLE [dbo].[tempowner]
(
    [CompanyName] NVARCHAR(50) NOT NULL,
    [Exchange] NVARCHAR(3) NOT NULL,
    [ShareDB] NVARCHAR(10) NOT NULL,
    [AccountDB] NVARCHAR(10) NOT NULL,
    [Match_BToB] TINYINT NULL,
    [Match_CtoC] TINYINT NULL,
    [Vnoflag] TINYINT NULL,
    [clientgroup] NVARCHAR(35) NULL,
    [balsign] TINYINT NULL,
    [conpath] NVARCHAR(50) NULL,
    [segment] NVARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temppartybalances
-- --------------------------------------------------
CREATE TABLE [dbo].[temppartybalances]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [balancedate] DATETIME NULL,
    [balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temppartybalances1
-- --------------------------------------------------
CREATE TABLE [dbo].[temppartybalances1]
(
    [Cltcode] VARCHAR(10) NULL,
    [Balancedate] DATETIME NULL,
    [Balance] MONEY NULL,
    [sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temppayadv
-- --------------------------------------------------
CREATE TABLE [dbo].[temppayadv]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [EffCrAmt] MONEY NULL,
    [creditAmt] MONEY NOT NULL,
    [shortage] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempquery
-- --------------------------------------------------
CREATE TABLE [dbo].[tempquery]
(
    [tdate] NVARCHAR(30) NULL,
    [cltcode] NVARCHAR(10) NOT NULL,
    [acname] NVARCHAR(35) NULL,
    [vno] INT NULL,
    [drcr] NVARCHAR(1) NULL,
    [ddno] NVARCHAR(15) NULL,
    [refno] NVARCHAR(12) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempsh
-- --------------------------------------------------
CREATE TABLE [dbo].[tempsh]
(
    [vtyp] SMALLINT NULL,
    [vno] INT NULL,
    [vno1] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMP_VNO
-- --------------------------------------------------
CREATE TABLE [dbo].[TMP_VNO]
(
    [LASTVNO] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TraderBillSumView
-- --------------------------------------------------
CREATE TABLE [dbo].[TraderBillSumView]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [vdt] DATETIME NULL,
    [Debit] MONEY NULL,
    [Credit] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TRIAL04
-- --------------------------------------------------
CREATE TABLE [dbo].[TRIAL04]
(
    [CODE] VARCHAR(10) NULL,
    [NAME] VARCHAR(25) NULL,
    [CLDR] MONEY NULL,
    [CLCR] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Update GLCODES ncdx
-- --------------------------------------------------
CREATE TABLE [dbo].[Update GLCODES ncdx]
(
    [acname] VARCHAR(255) NULL,
    [longname] VARCHAR(255) NULL,
    [actyp] VARCHAR(255) NULL,
    [accat] VARCHAR(255) NULL,
    [familycd] VARCHAR(255) NULL,
    [cltcode] VARCHAR(255) NULL,
    [accdtls] VARCHAR(255) NULL,
    [grpcode] VARCHAR(255) NULL,
    [BookType] VARCHAR(255) NULL,
    [MicrNo] VARCHAR(255) NULL,
    [branchcode] VARCHAR(255) NULL,
    [Btobpayment] VARCHAR(255) NULL,
    [Paymode] VARCHAR(255) NULL,
    [Pobankname] VARCHAR(255) NULL,
    [Pobranch] VARCHAR(255) NULL,
    [Pobankcode] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.userrights_branch
-- --------------------------------------------------
CREATE TABLE [dbo].[userrights_branch]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.userrights_log
-- --------------------------------------------------
CREATE TABLE [dbo].[userrights_log]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL,
    [Activity_date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UserWritesTable
-- --------------------------------------------------
CREATE TABLE [dbo].[UserWritesTable]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.userwritestable_branch
-- --------------------------------------------------
CREATE TABLE [dbo].[userwritestable_branch]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_CC_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_CC_ENTRIES]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [VOLE_REFNO] BIGINT NOT NULL,
    [SNO] INT NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CATCODE] VARCHAR(35) NULL,
    [COSTCODE] VARCHAR(35) NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Offline_Ledger_Entries
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Offline_Ledger_Entries]
(
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [VoucherType] SMALLINT NULL,
    [BookType] VARCHAR(2) NULL,
    [SNo] INT NULL,
    [Vdate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [CltCode] VARCHAR(10) NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [Narration] VARCHAR(255) NULL,
    [OppCode] VARCHAR(10) NULL,
    [MarginCode] VARCHAR(10) NULL,
    [BankName] VARCHAR(35) NULL,
    [BranchName] VARCHAR(20) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [DDNo] VARCHAR(15) NULL,
    [ChequeMode] VARCHAR(1) NULL,
    [ChequeDate] DATETIME NULL,
    [ChequeName] VARCHAR(50) NULL,
    [Clear_Mode] VARCHAR(1) NULL,
    [TPAccountNumber] VARCHAR(16) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [TPFlag] TINYINT NULL,
    [AddDt] DATETIME NULL,
    [AddBy] VARCHAR(25) NULL,
    [StatusID] VARCHAR(25) NULL,
    [StatusName] VARCHAR(25) NULL,
    [RowState] TINYINT NULL,
    [ApprovalFlag] TINYINT NULL,
    [ApprovalDate] DATETIME NULL,
    [ApprovedBy] VARCHAR(25) NULL,
    [VoucherNo] VARCHAR(12) NULL,
    [UploadDt] DATETIME NULL,
    [LedgerVNO] VARCHAR(12) NULL,
    [ClientName] VARCHAR(100) NULL,
    [OppCodeName] VARCHAR(100) NULL,
    [MarginCodeName] VARCHAR(100) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [ProductType] VARCHAR(3) NULL,
    [RevAmt] MONEY NULL,
    [RevCode] VARCHAR(10) NULL,
    [MICR] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PAYOUT_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PAYOUT_TEMP]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [ACCODE] VARCHAR(50) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [AMT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [BNKCODE] VARCHAR(10) NULL,
    [BNKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(15) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [PAYMODE] VARCHAR(4) NULL,
    [SRNO] INT NULL,
    [BRANCHCODE] VARCHAR(25) NULL,
    [MICRNO] INT NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [ACCDTLS] CHAR(35) NULL,
    [LNO] SMALLINT NOT NULL,
    [COSTCODE] SMALLINT NULL,
    [BANKCOST] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [LEDGER2_UPD] CHAR(1) NOT NULL,
    [REMARK] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PAYOUTCLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PAYOUTCLIENT]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_SEBIPAYOUT_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_SEBIPAYOUT_TEMP]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [ACCODE] VARCHAR(50) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [AMT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [BNKCODE] VARCHAR(10) NULL,
    [BNKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(15) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [PAYMODE] VARCHAR(25) NULL,
    [SRNO] INT NULL,
    [BRANCHCODE] VARCHAR(25) NULL,
    [MICRNO] INT NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [ACCDTLS] CHAR(35) NULL,
    [LNO] SMALLINT NOT NULL,
    [COSTCODE] SMALLINT NULL,
    [BANKCOST] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [LEDGER2_UPD] CHAR(1) NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [ACCNO] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_UPLOADED_FILES]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[vacmast]
(
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vais
-- --------------------------------------------------
CREATE TABLE [dbo].[vais]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [bal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ValanAccount
-- --------------------------------------------------
CREATE TABLE [dbo].[ValanAccount]
(
    [AcCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [RevCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vBalanceSheet
-- --------------------------------------------------
CREATE TABLE [dbo].[vBalanceSheet]
(
    [grpname] VARCHAR(60) NULL,
    [grpcode] CHAR(13) NULL,
    [acname] VARCHAR(35) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [openentry] MONEY NOT NULL,
    [dramt] MONEY NOT NULL,
    [cramt] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[vcategory]
(
    [CATEGORY] NVARCHAR(35) NOT NULL,
    [CATCODE] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VCATMAST
-- --------------------------------------------------
CREATE TABLE [dbo].[VCATMAST]
(
    [accat] NVARCHAR(10) NOT NULL,
    [catname] NVARCHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vgrpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[vgrpmast]
(
    [grpname] NVARCHAR(60) NULL,
    [grpmain] NVARCHAR(13) NULL,
    [grpcode] NVARCHAR(13) NULL,
    [vtyp] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.viral
-- --------------------------------------------------
CREATE TABLE [dbo].[viral]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vishal123
-- --------------------------------------------------
CREATE TABLE [dbo].[vishal123]
(
    [vno] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vishwa
-- --------------------------------------------------
CREATE TABLE [dbo].[vishwa]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(35) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vledger
-- --------------------------------------------------
CREATE TABLE [dbo].[vledger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(35) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[vledger1]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmain
-- --------------------------------------------------
CREATE TABLE [dbo].[vmain]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [ShortDesc] CHAR(6) NULL,
    [DispFlag] CHAR(1) NULL,
    [NarratioN] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vno_log
-- --------------------------------------------------
CREATE TABLE [dbo].[vno_log]
(
    [vno_old] VARCHAR(12) NULL,
    [vno_new] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VNSacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[VNSacmast]
(
    [MSDIVCOD] NVARCHAR(2) NULL,
    [MSACCODE] NVARCHAR(6) NULL,
    [MSACNAME] NVARCHAR(30) NULL,
    [MSPLACE] NVARCHAR(15) NULL,
    [MSGLCODE] NVARCHAR(6) NULL,
    [MSSTPCNT] FLOAT NULL,
    [MSOTHCOD] NVARCHAR(15) NULL,
    [MSADJST] NVARCHAR(1) NULL,
    [MSREFCOD] NVARCHAR(2) NULL,
    [MSREFSW] NVARCHAR(20) NULL,
    [MSPCHLMT] FLOAT NULL,
    [MSSALLMT] FLOAT NULL,
    [MSACLMT] FLOAT NULL,
    [MSCRDAYS] FLOAT NULL,
    [MSINTRT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vnsnarr
-- --------------------------------------------------
CREATE TABLE [dbo].[vnsnarr]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vpayadv
-- --------------------------------------------------
CREATE TABLE [dbo].[vpayadv]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] CHAR(35) NULL,
    [vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [ChequeNo] VARCHAR(15) NULL,
    [ChequeInName] VARCHAR(50) NULL,
    [Narration] VARCHAR(150) NULL,
    [PrintedFlag] TINYINT NULL,
    [actamt] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VW_V2_TBL_COLLATERAL_MARGIN_ALL_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[VW_V2_TBL_COLLATERAL_MARGIN_ALL_DATA]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [EFFDATE] DATETIME NULL,
    [CASH_NCASH] VARCHAR(2) NULL,
    [RMS_FINALAMOUNT] MONEY NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.LASTVNO_UP
-- --------------------------------------------------
create TRIGGER [DBO].[LASTVNO_UP] ON [DBO].[LASTVNO] 
FOR UPDATE
AS
DECLARE @OLD VARCHAR(100),
	    @NEW VARCHAR(100)
SELECT @OLD = LASTVNO FROM DELETED
SELECT @NEW = LASTVNO FROM INSERTED

IF @NEW IS NULL OR @NEW = '' 
 BEGIN 
	UPDATE L SET L.LASTVNO = D.LASTVNO FROM LASTVNO L, DELETED D
	WHERE L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE AND L.VDT = D.VDT 
	
	INSERT INTO Audit_LASTVNO_TRG
			(VTYP,BOOKTYPE,VDT,LASTVNO,UserName,COMP_NAME,DBACTION,APPLICATION	)
			SELECT VTYP,BOOKTYPE,VDT,LASTVNO,UserName=SUSER_SNAME(),COMP_NAME = HOST_NAME(),DBACTION = 'DELETED',APPLICATION = APP_NAME()
			FROM deleted
 END

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER1_DEL
-- --------------------------------------------------
CREATE TRIGGER [LEDGER1_DEL] ON [dbo].[ledger1]     
FOR DELETE     
AS    
INSERT INTO LEDGER1_TRIG    
SELECT bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode, HOST_NAME(), GETDATE(), 'DELETED' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER1_MOD
-- --------------------------------------------------
CREATE TRIGGER [LEDGER1_MOD] ON [dbo].[ledger1]     
FOR UPDATE     
AS    
INSERT INTO LEDGER1_TRIG    
SELECT bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode, HOST_NAME(), GETDATE(), 'MODIFIED' FROM DELETED

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_MASTER
-- --------------------------------------------------


CREATE VIEW [dbo].[ACC_LEDGER_MASTER]
AS
SELECT
	EXCHANGE = O.EXCHANGE,
	SEGMENT = O.SEGMENT,
	L.VNO,
	VTYPE = L.VTYP,
	L.BOOKTYPE,
	L.VDT,
	VDT_C = CONVERT(VARCHAR(10), L.VDT, 103),
	P.SDTCUR,
	P.LDTCUR,
	MKCKFLAG = '4',
	VNO_MK = L.VNO,
	MASTERSNO = 0,
	REMARK = '',
	REFSNO = L.REFNO,
	POSTED_ON = L.PDT,
	POSTED_BY = L.ENTEREDBY,
	CHECKED_ON = L.CDT,
	CHECKED_BY = L.CHECKEDBY,
	ENTRY_AMT = 0,
	SOURCE_MODULE = '',
	ENTRY_TYPE = 'N',
	SETT_NO = '',
	SETT_TYPE = '',
	BILL_NO = '',
	SELL_BUY = '',
	LOCK_FLAG = CONVERT(BIT, 0),
	DISPLAY_FLAG = CONVERT(BIT, 1),
	L.EDT,
	EDT_C = CONVERT(VARCHAR(10), L.EDT, 103),
	DRAMOUNT = CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE 0 END,
	L.CLTCODE,
	A.ACNAME,
	A.ACCAT,
	--MAINLEDGER = ISNULL(M.MCLTCODE, L.CLTCODE),
	--MAINLEDGERNAME = ISNULL(M.ACNAME, A.ACNAME),
	--MAINACCAT = ISNULL(M.ACCAT, A.ACCAT),
	L.NARRATION,
	L.BALAMT,
	A.BRANCHCODE,
	REFCODE = A.BRANCHCODE,
	OPPACCOUNT = CASE WHEN L.VTYP IN (1,2,3,4) THEN (SELECT TOP 1 IL.CLTCODE FROM LEDGER IL, ACMAST IA WHERE IL.CLTCODE = IA.CLTCODE AND IA.ACCAT IN (1, 2) AND IL.VNO = L.VNO AND IL.VTYP = L.VTYP AND IL.BOOKTYPE = L.BOOKTYPE) ELSE '' END,
	CURRENCY = '',
	BNKNAME = ISNULL(L1.BNKNAME, ''),
	BRNNAME = ISNULL(L1.BRNNAME, ''),
	CHQDD = ISNULL(L1.DD, ''),
	INSTNO = ISNULL(L1.DDNO, ''),
	INSTDATE = ISNULL(L1.DDDT, ''),
	INSTDATE_C = CONVERT(VARCHAR(10), ISNULL(L1.DDDT, ''), 103),
	DR_RELDT = ISNULL(L1.RELDT, ''),
	CR_RELDT = ISNULL(L1.RELDT, ''),
	DR_RELDT_C = CONVERT(VARCHAR(10), L1.RELDT, 103),
	CR_RELDT_C = CONVERT(VARCHAR(10), L1.RELDT, 103),
	DR_RELAMT = ISNULL(L1.RELAMT, 0),
	CR_RELAMT = ISNULL(L1.RELAMT, 0),
	DR_REFNO = ISNULL(L1.REFNO, 0),
	CR_REFNO = ISNULL(L1.REFNO, 0),
	DR_MICRNO = ISNULL(L1.MICRNO, 0),
	CR_MICRNO = ISNULL(L1.MICRNO, 0),
	RECEIPTNO = ISNULL(L1.RECEIPTNO, 0),
	SLIP_NO = ISNULL(L1.SLIPNO, 0),
	SLIP_DATE = ISNULL(L1.SLIPDATE, ''),
	CHQINNAME = ISNULL(L1.CHEQUEINNAME, ''),
	CHQPRINTED = ISNULL(L1.CHQPRINTED, 0),
	CLEARMODE = ISNULL(L1.CLEAR_MODE, ''),
	V.VDESC,
	V.SHORTDESC
FROM
	LEDGER L
		LEFT JOIN LEDGER1 L1 ON (L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE)
		/*LEFT JOIN (SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.MCLTCODE, MA.ACCAT, MA.ACNAME FROM MARGINLEDGER ML INNER JOIN ACMAST MA ON (ML.MCLTCODE = MA.CLTCODE)) M ON (L.VNO = M.VNO AND L.VTYP = M.VTYP AND L.BOOKTYPE = M.BOOKTYPE)*/
	INNER JOIN VMAST V ON (L.VTYP = V.VTYPE)
	INNER JOIN ACMAST A ON (L.CLTCODE = A.CLTCODE),
	PARAMETER P,
	OWNER O
WHERE
	L.VDT BETWEEN P.SDTCUR AND P.LDTCUR/*
ORDER BY
	L.BOOKTYPE,
	L.VTYP,
	L.VNO
*/

GO

-- --------------------------------------------------
-- VIEW dbo.angel_Franchisee_sharing_balance
-- --------------------------------------------------

create view angel_Franchisee_sharing_balance
as
select costname,Balance=sum(case when a.drcr='C' then vamt else -vamt end)
from 
(select * from ledger (nolock) where cltcode='520012'
and vdt >= (select sdtcur from parameter (nolock) where sdtcur <= getdate() and ldtcur >= getdate())
and vdt <= getdate()) a, 
(select x.* from ledger2 x (nolock), 
(select * from ledger (nolock) where cltcode='520012'
and vdt >= (select sdtcur from parameter (nolock) where sdtcur <= getdate() and ldtcur >= getdate())
and vdt <= getdate()
) y where x.vtype=y.vtyp and x.vno=y.vno and x.lno=y.lno
) b, costmast c (nolock) where 
a.vtyp=b.vtype and a.vno=b.vno and a.lno=b.lno and b.costcode=c.costcode
group by costname

GO

-- --------------------------------------------------
-- VIEW dbo.BVClient1
-- --------------------------------------------------
CREATE view vClient1
AS
SELECT * FROM [NCDX].[dbo].[Client1]

GO

-- --------------------------------------------------
-- VIEW dbo.BVcostmast
-- --------------------------------------------------
create view [dbo].[BVcostmast] as
select * from costmast

GO

-- --------------------------------------------------
-- VIEW dbo.BVledger
-- --------------------------------------------------
CREATE view [dbo].[BVledger] as
select * from ledger where vtyp in('2','3', '17', '5')

GO

-- --------------------------------------------------
-- VIEW dbo.BVledger1
-- --------------------------------------------------
CREATE view [dbo].[BVledger1] as
select * from ledger1 where vtyp in('2','3', '17', '5')

GO

-- --------------------------------------------------
-- VIEW dbo.BVledger2
-- --------------------------------------------------
CREATE view [dbo].[BVledger2] as
select * from ledger2 where vtype in('2','3','17', '5')

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_DETAILS
-- --------------------------------------------------


CREATE VIEW CLIENT_DETAILS
AS

SELECT * FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_MULTIBANKID_RECO_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[CLS_MULTIBANKID_RECO_VW]
AS
SELECT DISTINCT CLTCODE AS 'CLTCODE',ACCNO AS 'ACCNO' FROM ACCOUNT.DBO.CLS_MULTIBANKID_RECO

GO

-- --------------------------------------------------
-- VIEW dbo.COMPANY_MASTER_SETTING
-- --------------------------------------------------

CREATE VIEW [dbo].[COMPANY_MASTER_SETTING] 
AS
 
SELECT 
	A.EXCHANGE, A.SEGMENT, A.EXCHANGE + ' ' + A.SEGMENT AS EXCHSEG FROM PRADNYA.DBO.MULTICOMPANY A , .DBO.OWNER B
WHERE 
	A.SEGMENT = B.SEGMENT 
	AND A.EXCHANGE = B.EXCHANGE

GO

-- --------------------------------------------------
-- VIEW dbo.DPC_MASTER_SETTING
-- --------------------------------------------------
CREATE VIEW DPC_MASTER_SETTING
AS
SELECT * FROM anand1.account.DBO.DPC_MASTER_SETTING

GO

-- --------------------------------------------------
-- VIEW dbo.EXISTS_RECORDS_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[EXISTS_RECORDS_VW] 
AS
SELECT * FROM ACCOUNT..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNT_AB..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTCURFO..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTFO..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTMCDX..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTMCDXCDS..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTNCDX..EXISTS_RECORDS

GO

-- --------------------------------------------------
-- VIEW dbo.FILEDATA_BANKRECO
-- --------------------------------------------------


CREATE VIEW [dbo].[FILEDATA_BANKRECO]
AS 
SELECT * FROM MSAJAG..FILEDATA

GO

-- --------------------------------------------------
-- VIEW dbo.LEDGER_SB1
-- --------------------------------------------------
  
CREATE VIEW LEDGER_SB1  
AS  
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,  
BALAMT,NODAYS,CDT,ISNULL(NEWGRP,CLTCODE)CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION FROM   
(  
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,  
BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION  
FROM LEDGER_SB ) A  
LEFT OUTER JOIN   
(Select * FROM ACCOUNTMCDX.DBO.SBTB WHERE SEGMENT ='NCDEX')B  
ON CLTCODE=CODE

GO

-- --------------------------------------------------
-- VIEW dbo.LedgerDrCr
-- --------------------------------------------------
CREATE VIEW dbo.LedgerDrCr  
AS  
SELECT SUM(vamt) AS totalamount, drcr  
FROM ledger  
GROUP BY drcr

GO

-- --------------------------------------------------
-- VIEW dbo.ledgermismatch
-- --------------------------------------------------
CREATE view  ledgermismatch    
as    
select vtyp, vno, debit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D'),    
credit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C'),    
balance = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D')    
          - ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')    
from ledger l1    
group by vtyp, vno    
having ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D') <> ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_FILEUPLOAD_LOGS_VIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[RECON_BANK_FILEUPLOAD_LOGS_VIEW]
AS
SELECT * FROM ACCOUNT..RECON_BANK_FILEUPLOAD_LOGS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_FILEUPLOAD_LOGS_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[RECON_BANK_FILEUPLOAD_LOGS_VW]
AS
SELECT * FROM ACCOUNT..RECON_BANK_FILEUPLOAD_LOGS 
UNION ALL 
SELECT * FROM ACCOUNT_AB..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTFO..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTCURFO..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTMCDXCDS..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTMCDX..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTNCDX..RECON_BANK_FILEUPLOAD_LOGS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_MASTER_VW
-- --------------------------------------------------


CREATE VIEW [dbo].[RECON_BANK_MASTER_VW] 
AS
SELECT * FROM   ACCOUNT..RECON_BANK_MASTER (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_MASTER_VW_F2
-- --------------------------------------------------

CREATE VIEW [DBO].[RECON_BANK_MASTER_VW_F2] 
AS
SELECT DISTINCT SEGMENT ,BANKNAME,BANKCODE FROM   ACCOUNT..RECON_BANK_MASTER (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_EXCLUDE_MASTER_VW
-- --------------------------------------------------
CREATE VIEW RECON_EXCLUDE_MASTER_VW
AS
SELECT * FROM ACCOUNT..RECON_EXCLUDE_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_REPORT_STATUS_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[RECON_REPORT_STATUS_VW]
AS
SELECT * FROM ACCOUNT..RECON_REPORT_STATUS

GO

-- --------------------------------------------------
-- VIEW dbo.rpt_chequelist
-- --------------------------------------------------
CREATE view rpt_chequelist as  
  
select l.acname,l.cltcode,l.drcr,l1.ddno,l.vamt,vdt= left(convert(varchar,l.vdt,109),11),edt=left(convert(varchar,l.edt,109),11),reldt= Case When  (Reldt = '1900-01-01 00:00:00.000'   or   reldt > GetDate() ) Then 'Unrealized' else left(convert(varchar,RelDt,109),11) end,l1.bnkname,l1.brnname,nar = narration,l.vno,l.vtyp   
 from ledger l,ledger1 l1 where l.vtyp=l1.vtyp and l.vno=l1.vno and l.lno = l1.lno

GO

-- --------------------------------------------------
-- VIEW dbo.V2_CLIENTPROFILES_NEW
-- --------------------------------------------------
CREATE VIEW V2_CLIENTPROFILES_NEW
AS
SELECT * FROM anand1.ACCOUNT.DBO.V2_CLIENTPROFILES_NEW

GO

